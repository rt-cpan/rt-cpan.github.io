Index: SSLeay.xs
===================================================================
--- SSLeay.xs	(revision 419)
+++ SSLeay.xs	(working copy)
@@ -4570,7 +4570,11 @@
      SSL *	ssl
      int        state
   CODE:
+#ifdef OPENSSL_NO_SSL_INTERN
   SSL_set_state(ssl,state);
+#else
+  ssl->state = state;
+#endif
 
 long
 SSL_need_tmp_RSA(ssl)
