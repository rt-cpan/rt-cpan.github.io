# Requires settings of the following environmental variables:
# $TESTINGDIR
#   A directory underneath which you will have directories such as
#   'blead', 'threaded_blead', etc., under which you will have 'bin' and 'lib'
# $SECONDARY_CHECKOUT_DIR
#   A git checkout of perl other than the one you use for everyday development
# $TEST_JOBS
# Requires existence of 'get_cpanm' in PATH

# Don't let me use uninit vars, and any error is a problem
set -u
set -e
# Print expanded commands
set -x

if [ ! -d $TESTINGDIR ]; then
  echo "FAILED:  could not locate TESTINGDIR"
  exit 1
fi

if [ ! -d $SECONDARY_CHECKOUT_DIR ]; then
  echo "FAILED:  could not locate SECONDARY_CHECKOUT_DIR"
  exit 1
fi

command -v get_cpanm > /dev/null || \
    {
        echo "FAILED:  could not locate 'get_cpanm' in PATH"
        exit 1
    }

if [ "$#" -gt 0 ]; then
    BRANCH=$1
else
    BRANCH=blead
fi

echo "Handling branch: $BRANCH"

cd $TESTINGDIR
test -d $BRANCH && rm -rfv $BRANCH
BRANCHDIR=$TESTINGDIR/$BRANCH
mkdir -p $BRANCHDIR
cd $SECONDARY_CHECKOUT_DIR
git clean -dfx
git fetch --prune origin
git checkout $BRANCH
if [ "$BRANCH" = 'blead' ]; then
    git rebase origin/blead
fi
TEST_JOBS=4    # Set to a suitable number for parallelism on your system

./Configure -des -Dusedevel -Uversiononly -Dprefix=${BRANCHDIR} -Dman1dir=none -Dman3dir=none

make -j${TEST_JOBS} install

#cd $BRANCHDIR
#get_cpanm
