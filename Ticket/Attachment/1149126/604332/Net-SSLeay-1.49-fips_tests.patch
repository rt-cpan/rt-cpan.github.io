From a92db2ebfca5b6aff6ee5e6f643665bf73afc19f Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= <ppisar@redhat.com>
Date: Wed, 28 Nov 2012 17:50:01 +0100
Subject: [PATCH 1/8] Store encrypted private key as PKCS#8

Legacy format uses MD5 that is not awailable in FIPS mode.
---
 t/data/key.pem.e | 35 +++++++++++++++++------------------
 1 file changed, 17 insertions(+), 18 deletions(-)

diff --git a/t/data/key.pem.e b/t/data/key.pem.e
index 5656b60..04d8745 100644
--- a/t/data/key.pem.e
+++ b/t/data/key.pem.e
@@ -1,18 +1,17 @@
------BEGIN RSA PRIVATE KEY-----
-Proc-Type: 4,ENCRYPTED
-DEK-Info: DES-CBC,FF5FA63A87ABD584
-
-fl5y1luQTaEXw4Jx1DVk7tUKOwdqcknon/RRdcr14KE86HxxdOjpcqWs1nVBMXMR
-v/gjpfkXIPA+XT5nFXt//YZfwMmAhFWFaojlQv0AOjpXQvhRJJ5EkWYUYq6Y/0uX
-NG0xLpOla4uqGWVZrVmXXqfnfgobBE1/Ffp297M8Z1mgsBNeLlt4P32Cgg8+zyNX
-Ewmcdi5teBc4xsSjNbP2xafzjjP1GlhxCpjsDC2ahxvcoOnOUSkR/lm8Kmzju/tP
-7NzyzgxZGbgDs199GdYAu9kgkMDg74sWxNsJYvl6YKZWuvd4gl31zlG+J0BrY70/
-dloPgF0b9diufTqHrjlVLBvsVtvtc9KRKkRjbtoEszordTWHT0G9LOJbnvxz4iKs
-oPwYyhXltjSb79JuQ3Imk41RRJb7FborNmfsgGbsBSawiSMpHZstmfpfFvHwXM3m
-3QPdpV98LuOtOlQQiAyXkPv4AOtULqBF9AuxugMxM6OEi/xVnIcgQVknJ9DURB7Y
-nk5rqG0UVLurQCWkRogVywVVc2fBYzQrDk3Ra2q4OndSVLBd8RSCsHBpWTNplr6n
-T8NjiF74wpX00I33wqV90FqyVMLNjLb3guRWpXx8ibxXn7wSRwYpxl9hZHBTqezQ
-77PAZ00GJt03zWc0ia7vs6VRUUUPs1LuNjgavmYVeNMHOPd5/B27IsxuvX9yODQ/
-1S5Lmjw8FGLxNX1EUH+rwFpCAkv0c0jVvAOgWeautXkBsVJriZI96CPuayQx1RdA
-om7ykGfpLjGzeNtdEqB4mFYB9tWOiRRNssox7/Wxf5fvq2GImpCFqQ==
------END RSA PRIVATE KEY-----
+-----BEGIN ENCRYPTED PRIVATE KEY-----
+MIICxjBABgkqhkiG9w0BBQ0wMzAbBgkqhkiG9w0BBQwwDgQIFe4I0QEObHsCAggA
+MBQGCCqGSIb3DQMHBAgHBvJrPU9U8wSCAoCkU4ujuUqqzCPpTCWMjdvohENVjF5p
+bEt31lo+IP/eVCdJLd3sbQhmv0JjTAE2CGnYlapF28WS2ZCCZfSEkNyY4yI/1Cqa
+VdHEJ+7QzVkDQJkYmgvXOFJbEXW7uY5TFsI4MFm1bXwAiU7ZXq1kQt3amMGKdUEG
+uGNf1D3OH2RTRfdPZSZYI0WQjLbj4q2v1winMU4Kf0Y0LNNYEsiReFzyKAxwCZ0q
+01aoNxga7cSWTnwzwXvzgev2rjx2t/0cxK/IrUyVAk97po7jYZ09ug8MRS7mXi0x
+t9zsTK9GRKSazlUdJlHOn0QmC5deDBUmOdYWFSSsKGTTOZeBr29UtcdNzMPNVpOs
+pHVUVZRBfLWUDeXSksTVhOAcf06NzkhTJ9mcKUqao++pTQgeKJke4/9QL+mqMDNL
+4KKn0VQbAbaWupTYVLLG8V4WdSQOoCZQbD86Ss8mFX2oRoB9PBe4hbTrHkCdMuHm
+XjfPAU8Z5ys+IQAcRbVAbOGPoFjGMEwFxl8bn1JTSWhbBDATdbyvstpmlTIsGuBH
+7tRU68UFK8pIPCX9MNQkpdAq6Yzl3H05mKyoJqYrYnX9xlqOVhgkHv35RWkxfnyz
+efnOMzAHn22h2hqCuxqLydyMSKlE0x9jDAgEChTKzwZCg0D461G3aj3b9MG7QvKz
++sOI5+28g+wpVuv+6DNFgizOlndyY6Y8+lU4k87UeL1Mc/lcZMB60hj4ZkEYoGyK
+s0UHtqaq82XlZf3OL3aouQojGBw9DGo/1KWISuM1I3ZCxlqh1uEG3rMnaSTjI6Ao
+yClYz274wOXPOhvfcoczs9++IXzltKzuFZeLJ0K+gsKTlk+eGhN0lzav
+-----END ENCRYPTED PRIVATE KEY-----
-- 
1.8.0


From e602628aa470e375de6d94f24878cf875f915a4c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= <ppisar@redhat.com>
Date: Wed, 28 Nov 2012 17:57:27 +0100
Subject: [PATCH 2/8] Compare SHA-1 fingerprint in t/local/07_sslecho.t

MD5 is not available in FIPS mode.
---
 t/local/07_sslecho.t | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/t/local/07_sslecho.t b/t/local/07_sslecho.t
index fb70315..7eb9934 100644
--- a/t/local/07_sslecho.t
+++ b/t/local/07_sslecho.t
@@ -261,12 +261,12 @@ my @results;
 
         my $cn = Net::SSLeay::X509_NAME_get_text_by_NID($subject_name, &Net::SSLeay::NID_commonName);
 
-	my $fingerprint =  Net::SSLeay::X509_get_fingerprint($cert, 'md5');
+	my $fingerprint =  Net::SSLeay::X509_get_fingerprint($cert, 'SHA-1');
 
         push @results, [ $issuer  eq $cert_name, 'cert issuer'  ];
         push @results, [ $subject eq $cert_name, 'cert subject' ];
         push @results, [ substr($cn, length($cn) - 1, 1) ne "\0", 'tailing 0 character is not returned from get_text_by_NID' ];
-        push @results, [ $fingerprint  eq 'AB:56:FB:BD:4E:02:B2:68:AD:F2:C9:6A:2A:7D:DC:BD', 'md5 fingerprint'  ];
+        push @results, [ $fingerprint  eq '96:9F:25:FD:42:A7:FC:4D:8B:FF:14:76:7F:2E:07:AF:F6:A4:10:96', 'SHA-1 fingerprint'  ];
 
         return 1;
     }
-- 
1.8.0


From 6166c27753708f76c18c445ead8e7a4ff9488650 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= <ppisar@redhat.com>
Date: Wed, 28 Nov 2012 18:06:52 +0100
Subject: [PATCH 3/8] Use 2048-bit RSA keys in t/local/31_rsa_generate_key.t

RSA keys shorter than 1024 bits are forbidden in FIPS mode.
---
 t/local/31_rsa_generate_key.t | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/t/local/31_rsa_generate_key.t b/t/local/31_rsa_generate_key.t
index 26591a6..c0f3619 100644
--- a/t/local/31_rsa_generate_key.t
+++ b/t/local/31_rsa_generate_key.t
@@ -16,18 +16,18 @@ Net::SSLeay::ERR_load_crypto_strings();
 Net::SSLeay::SSLeay_add_ssl_algorithms();
 
 lives_ok(sub {
-        Net::SSLeay::RSA_generate_key(512, 0x10001);
+        Net::SSLeay::RSA_generate_key(2048, 0x10001);
 }, 'RSA_generate_key with valid callback');
 
 dies_ok(sub {
-        Net::SSLeay::RSA_generate_key(512, 0x10001, 1);
+        Net::SSLeay::RSA_generate_key(2048, 0x10001, 1);
 }, 'RSA_generate_key with invalid callback');
 
 {
     my $called = 0;
 
     lives_ok(sub {
-            Net::SSLeay::RSA_generate_key(512, 0x10001, \&cb);
+            Net::SSLeay::RSA_generate_key(2048, 0x10001, \&cb);
     }, 'RSA_generate_key with valid callback');
 
     cmp_ok( $called, '>', 0, 'callback has been called' );
@@ -52,7 +52,7 @@ dies_ok(sub {
     my $userdata = 'foo';
 
     lives_ok(sub {
-            Net::SSLeay::RSA_generate_key(512, 0x10001, \&cb_data, $userdata);
+            Net::SSLeay::RSA_generate_key(2048, 0x10001, \&cb_data, $userdata);
     }, 'RSA_generate_key with valid callback and userdata');
 
     cmp_ok( $called, '>', 0, 'callback has been called' );
-- 
1.8.0


From 99b12c69676ad81a55dfe9fa2750267806f9bcce Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= <ppisar@redhat.com>
Date: Thu, 29 Nov 2012 13:15:58 +0100
Subject: [PATCH 4/8] Use 2048-bit keys in t/local/35_ephemeral.t

FIPS requires at least 1024b RSA keys.
---
 t/local/35_ephemeral.t | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/t/local/35_ephemeral.t b/t/local/35_ephemeral.t
index 5ab3724..5ebc309 100644
--- a/t/local/35_ephemeral.t
+++ b/t/local/35_ephemeral.t
@@ -11,5 +11,5 @@ Net::SSLeay::ERR_load_crypto_strings();
 Net::SSLeay::SSLeay_add_ssl_algorithms();
 
 ok( my $ctx = Net::SSLeay::CTX_new(), 'CTX_new' );
-ok( my $rsa = Net::SSLeay::RSA_generate_key(512, Net::SSLeay::RSA_F4()), 'RSA_generate_key' );
+ok( my $rsa = Net::SSLeay::RSA_generate_key(2048, Net::SSLeay::RSA_F4()), 'RSA_generate_key' );
 ok( Net::SSLeay::CTX_set_tmp_rsa($ctx, $rsa), 'CTX_set_tmp_rsa' );
-- 
1.8.0


From 08b1e288e7947b0c9aad0d31773c19fc619c7cf7 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= <ppisar@redhat.com>
Date: Thu, 29 Nov 2012 13:23:49 +0100
Subject: [PATCH 5/8] Store private for t/local/38_priv-key.t as PKCS#8

Legacy format uses MD5 which is unavailable in FIPS.
---
 t/data/test_CA1.encrypted_key.pem | 35 +++++++++++++++++------------------
 1 file changed, 17 insertions(+), 18 deletions(-)

diff --git a/t/data/test_CA1.encrypted_key.pem b/t/data/test_CA1.encrypted_key.pem
index 5a73b3c..28b188d 100644
--- a/t/data/test_CA1.encrypted_key.pem
+++ b/t/data/test_CA1.encrypted_key.pem
@@ -1,18 +1,17 @@
------BEGIN RSA PRIVATE KEY-----
-Proc-Type: 4,ENCRYPTED
-DEK-Info: DES-EDE3-CBC,3BACE3D69BE83336
-
-ar+ndQli7XxsaLYYV6wj6budOowuGLLyBhCgN640ufP2MHDwd5rGkK+UcR/PkP3L
-5WBs3tNdhO9x9U6aQBmIMr5IU5uifiBtydK7cAqtPoVZdT+FNdaH5n0onTsvMkoQ
-eDCGrWUI7dPBceBfWq/L+cap+R7KDAwzeHZjg7fXOcLrSU16Ne+lDYCNX/OFIPWQ
-vv5b018XTiJWYkq4rRuw8sHiPovzuY7tadvegbzJx2TC5Jb0gaXbcu9NQX2gRr53
-nxtkzIHekpU3SIsPH2Sv67MkqHY0L1LGZGLI35oLqaJnCuzWyH2MaELDR43Oh7GY
-F7kWDbHpIwoqEJescck1P2jW7KgC/WeJo7/EzYSRKZ2n3RjvdsrewVfGiOLTOYk7
-lowC6XFtwwAx+QO/+FGipekztw/Zpdu5qrM97LxwciTOTcovxEDpwZMQ5L0FW7DB
-5GyNSdjP4JD+fd7j8FQb9joZzecE65HfLqLj/10tN4VMOlC6i0oNPc+3LquP4w8p
-o5NhzjPEKi0ilWlkJDdwUqt81Q+IoR0b3Fx1FalB8qAW3GiZIVjukov5X6eufBGu
-HaqIBun82IiOuPuv5EFRKB4sC9RCfvv+UgmnkLEyJb8Ev6Hb0Y+ZPJi8E17Un8cQ
-ZE31vbitFYsa4UHKEpsM7zzZrnDkkKhEWAXNONT8sN50Rk4zGw2E+Mg0+scs9wmX
-LvP4ojSa7KTwz0Hyvf1QXRG25XpNTh1MIWMpCQV/dqe1f6R9mxbyxHB1oHy8wl1S
-rUZEfdwWdB0ZxWT3LXSsS07wtxF+Nftt/olpAKcftoF73VuMEnHW3Q==
------END RSA PRIVATE KEY-----
+-----BEGIN ENCRYPTED PRIVATE KEY-----
+MIICxjBABgkqhkiG9w0BBQ0wMzAbBgkqhkiG9w0BBQwwDgQITsuxC3a/3nMCAggA
+MBQGCCqGSIb3DQMHBAhA/86UKBTLSgSCAoCF4ohLfVgalUA/BBo6vxHdVug5jJb7
+VcS8ruRoi4auq+Szdi9pX/4K0r6fvOmxPe5Gr2+c8Qr7NgNM8Ji1g6QAlomWBsV0
+S0cK0RRPAz54J7/OV+7f5mucU2IcpsG79bcWIZAuBXZkfSqb4EUxmtFiMlp2ffwu
+v7IsSIKUqB4zy35pFg5i33lLfEAuen0fCMdfBXMv/Y9N+0BwbD3hYEkAzEOjPvND
+Kc8coLZoTMPe8UqcTU5brA85CSRMJw2Q+7vE7y3QiSVzyd+wv/vJwg6thbSZ/J6K
+5sFH+wrPDqOZ/u0kRq20dvkP31EncBt2/ZYbYfd7yrZkO6o0haJZcOFOaWmDzyJU
+ql0XROVp9JLCliFTX5Vi9/dTcgxf50XZiz7CSSpryTpp+dVvGdn0YpT4R2YM6U3K
+zm88/GDxUYICbtAgNWwbzgDFGboHs8fRh78h9TmBDVEWGA2ArdNwHao5jDHCxbfz
+lhidH8D6LmXBmkBKYZ17GHkE7lwi3xxnu4TwLcMdtlSo0FKm8cisQI2ZYnU13qbY
+0tTl2gdeBgN3bpgmFi8sfk2RJhhMpBcBj3QpZKmmed1A+w4DG0yuQM+Y45fGyVu7
+nkZDr/ZcdqxxXILy5nzD9Q4YnLhPfj9qhJELL4o+zi52Q89zkpYMyIHz0VOk0geL
+lU/N+ASfnlNIZMevIh9lo2EachOJZ4K6EQMf2cauueWNLhIvX5ZMCH2QarDK1Qk6
+nymASwq3tkEHhxIf4lbekDTOdELQcGq1hiVReaxKmJRwJ52LBEA+7fA+iegeTL54
+8dt2qaEC+2y4Y8o3kbJGVFFZ/0FBZEfUEQ8UxkHHnEemYeJSH3R2jBC1
+-----END ENCRYPTED PRIVATE KEY-----
-- 
1.8.0


From ad5632c2507da0bae3b7227fbfbaeb8708194cd7 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= <ppisar@redhat.com>
Date: Thu, 29 Nov 2012 14:42:17 +0100
Subject: [PATCH 6/8] Encrypt PKCS#12 with 3DES for t/local/39_pkcs12.t

FIPS does not allow RC2.
---
 t/data/pkcs12-full.p12      | Bin 2773 -> 2773 bytes
 t/data/pkcs12-no-chain.p12  | Bin 1589 -> 1589 bytes
 t/data/pkcs12-no-passwd.p12 | Bin 1589 -> 1589 bytes
 3 files changed, 0 insertions(+), 0 deletions(-)

diff --git a/t/data/pkcs12-full.p12 b/t/data/pkcs12-full.p12
index 2296dbf055d67034caab4d5a625c849587203c80..4b08fe15f4913111d295da287504bd9511c58df4 100644
GIT binary patch
delta 2595
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
F2mnge_jdpQ

delta 2595
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
F2mlva67T>3

diff --git a/t/data/pkcs12-no-chain.p12 b/t/data/pkcs12-no-chain.p12
index cf1a4614ce85e7c6e33e8895ec9bd894c6ad28cd..9979364f9e6bbac792e9c7094b5b0dc77faa5384 100644
GIT binary patch
delta 1402
zcmV-=1%>*x47Ci9SbqaB4g?5Rt;QJoRpieC0tf(rf&!SO%@NOE_;k7sgeDK2n~`YZ
zI(}-Cy;6_`F*ud~&36jS`3iUye}cLZ-zPcH8eB(84f#jC?j6-kf;BWA%?!lUKYoEL
zwDE{h-%H~9)7WcMA>Xt4zU{hST_M=dL{dARw8fIZOY0d?uYVI~tg2=16i>3;Mm^M%
zMj<j#^em|#l(q}$i_d!7x`(iXK^rbckF!;BAU+bcqW#Ige(QGZp!m8AeCc~GPx`*-
z)TuMYEra?zO1EW)F2!MAVf#^iGTV|^R#7O_^vptH5Ymw}*lSZM2+f;ampO~-X!lrT
z=mosV?x7~);(rtQbqy;q0hI{=YtLJ|nM81^!Pm*;U*lK;&*dN+ZcmA-4LI<pOd)?F
zRj2U#U%uRi*jtR8m8-@(=dxWv;w70-n<t?lT!kG?#YI>GwG^b$jg}Ee9sxyTD|`+_
z@1#FG(^2ks4V1kJQcoO!M-pzVHoC{#($7y$$h$P%mVXDPvCIPEk*3e}vgBml6YtxJ
zsB_aL!I#Jid+4<+j|e=F8E^&FtP|oI)HymKYkfJrg#YD)$$qD>GC;K@d)vC(gW$QG
zNf>E6bmPH{l7$`A?7%|0GbG}8G)R_MKapibDh<TmcMfyx+=PH$^dk=x$QQf?hf%{>
zBGiT%SAX^T<xqy}Bh|lr<0CyKEY*AY>Ev*h_V4*Oo*OKSesuAB#w`!P?xmKDZKP!v
zuMTZ-2#1V$rV5SB=1$>`0HRiX{|yKR{u{VY5c`W-oGofrxZ|HW(EaiBx8J|=@td|#
zC8wRiFsMXZ5FO7aFtDxHDSq2CY9j%AHj2ynBQn(&RT-W5NoPwZXISq)!4-4PFJj0I
z0c?(T^V#nHmckg*JR(W1XBQzhqXDA>@Im0klLZ4tfAHqVo@~+sSpotG00e>pfbsWV
z@GAqa^`tOa%WC+iDJoMocqQKTX{amLfpS?%QCE0!-lQ3p(-%k}s-t8c1f@rKkqR7x
z;bzCj0JUXU*s%|+DV)-{oKg){_1po-St`x@_gsA}**$w<qnxZ}z2Y(QibZ5LGQIKh
zg<Rz}e}<=BkBdGsp#gZWYlonJOsc`IkdLs-diq|8_C!ZkU`Oz~4fdF7>fyo9tU|_p
zRt+Uwko3=_KFrkIOyVhaN};2UvyQ^9G=iUNk(XM<#_F*gP#1ure#<hBXGyPX*E@c~
zVgXimb%h~|0Gt}4<nMW#?yW5=NaTV?441;ne=uDN9K|F>vSGIBdPMABvWZTgrLhis
zP;i)nE5dxGf$-E`sUa(1AKidYVINGNS+CEGOuolKR3c!ZyYRV=@(2l!>F?A(<U84`
zI_E@%gN(W>Bq>3z9?|%Q&8x7M;yIsB(1kko-QCwP<wW6y?z2nbbOu+=jw%Ri-!M2-
zf8-2>1}8IOMR-_SB~lgCTUGV#!?jUk$C8M}i9n%H3J0-3@O#pFZcp-0Xq47Y#n8KU
zZ$avd(SuDrxZaJr_(DUws;68Hr}?5$tTfnOL+7fE)>|ByJd9D&bl%nol`DV*nBzQw
zBMUJIh!qJ)_nF!+W4Z9bz3Nm<ibT(me*ia@{$S8egz6l*GrTFXD$1pGA!eJi_qB%@
zCQOC0=+6rt1C%vJ!W$GyN$ctysxi(Vq0H?f8#P`Vb>II5Px0<RxNui37qC9Epn_zD
zl}a3((>mvv7m4(i;7AGVxFH9)Azh9~7wiQF6+7<Ev$pebl~k!AkLQsX#2N4)6}>oE
znvP;P$;Hj6Q8slsf@HL}yI_;s1vny_EN6;#{3L%~8ft0F<eeLSzhNi@2ptCU)hdaC
IfdT>u0G83Q^8f$<

delta 1402
zcmV-=1%>*x47Ci9SbqjE4g?5M#jdyw^-rY&0tf(rf&!R`z}QiEp*9wUC!%DTonQ#j
zud4|aHuwIv=H{yiO>NCJwi?q@P=z0Og(dx<{!85HJcnI3bv;DW>}ZSxjV92zi!W5L
zkkN{Pzm&oKYUgU~$4Qx4r8=4icTg^j;$^^a{ntuI8*!t^2Y<X8>C2?XIO?NGB0gWU
zJuG0d6putj`v<NFf~YZj8vtY5saQ2&*kvvx#oVVtWqHjMH~t`vF7m$%1&*j8!1Ri5
zQ6-drp6??!@ZdElAGZd!>y{ad+d6n?SMI$;XvbRt-6i{?uPs7tS9^1$0_XOzE-ab>
zstFi^4sFJpFMkusmK@FAqs_=+A9v&B2!@CC@${=Z=Ul{fHcLyFn0~d_q>;qmGW!G*
z_h-!7_^sZ-yx<j-?;D%s^nB8>7wwq~Q(mPhz@-%(72@`E6}JczpGNg^yey>NxQ!q^
zy?JTvkm@fa6~H)!jjOk5XGK6#)7o_0HMd8P1Q2g3(|=vEymmNYQxG@{Wmw`*IUd%T
zdR0P=t~A2(h{f&tse_$0Z3#X!E|Cl@Y2u>Zht7L`>UuPAAb1d4SJE%`NWCA=A(q%l
zl2HN~#kHtG=8y>qvLgwumCQ5Bob<8S<_!gQu_3y;CmmR9Zj_02pIeEs=pdX9ov2E%
zJ3k_PTz_N3Q>Op*hV4{>5Or$Zi~RU{(=7FwrYr?$R6DKo5LP<yJev!qK?p&Sn99uK
zHD>98jzx4Pvf*x5sE{?#Gl{;c^(?H;xa;phrw+Bw@nZ7^l3;D5%&4slXrsWmY}a`_
zT2A~2Z9h=9J|ORQCJHNP*u;}|rL23Op^)jc;xaa!YO=12v}Bq@kE9+?v|V9rEqS?f
z?5AS|4Ga1Pv)krP>Eez(zaNVvcj#onl9qBhlLZ4te{Vni^^2eAi~<4(00e>pfR>iz
zBUbuP^5SNbPTS*+fnqjBJB@5aqo0F8d7NR5zi)xUYqByb-J9yY#J={~ip17Ji<)bx
zA6kFo_*8$Dy~i%!r(@YHjntNC)qMCTyyf&cqENCgG2o44k+RI)k;preGmbRV3s?Mu
z2Ii@te;HEEj5JwU1qnReR9E2zoE1&p*)&xdS$bO|ly824S06S@JwZ+fHR!l~{O&K?
z!MR70cR81YuF&0?O5KG#6o%z$aP|>5kH9PGX}CML%Kt~}xT!uSzPWrOSYfeW#rKKC
z(l7Lv+GoS1@o>q^b&frPhw1o1F!a;bGQKYVe=X865>G~S;%I_55q=JNbRfa?KU$RM
zSdkPJ8(<<h9D-Tn75s@406*B#!5;lLUP#co*!H=y2TzY7JdpImNfLPy>Ie1s<GP;G
z`3Q<Gv)9?Eu67*7u2@g2Gk}3_)Vcj!lS5hJ-mRu2G&yQSAm0|<j(U5R;pn&mw?4EG
ze^&fH>G9**S4=g(v^8C<_O=j7q<lBAeGVV`>Vum+9YemD&7ho1>pdKbcDdX+*osXk
zEFfbbxz4^ZTH3KpbMdTPqR2dwHV}K&y^1#v=ko4K)PqBx?Uc+M6ZdTJ0afA{yN5*v
zFPipmIVGaeN4@>Y^YFV_TUV4_eksE(f7OeC5VYgvrFctk^qAnYnj;*s;Cz=mp)8yF
zW}y8rh9zCXN|LXbj$Y%~Qa80MJ6kFQv`Es9dFO=l67w4d?5m3v^%CZB1SUwvshm;e
z#01%J@jI;poNv@&gvl>|&mB~Y=U$oSQL)HWFLx|PPOt9o8`ft|(~c*^s{=bD6}Sd=
zL9!ju9Mx`KI_s)+hb%IJa+H(X1vnxsZ9XD&gvxsf`QOYpVgDM<D=Ab22nwYjXN}S!
IsR9BB04mnGNdN!<

diff --git a/t/data/pkcs12-no-passwd.p12 b/t/data/pkcs12-no-passwd.p12
index c4d19ee11458371670c606c53594fe6f1a9acbed..b6122d0449cd1336483b7114088b5dd79f277c2d 100644
GIT binary patch
delta 1402
zcmV-=1%>*x47Ci9SbqaB4g?4|S5=$AQJ%m80tf(rf&!QoYQ%<@B)L<#Jt<!d&;Gcr
z>P>dF9fa{>!4c|tKkGyXC2sfvh0>xuz*z}GXwxeWZ7j|dY6RqA2;+)zZzdmBQn;j9
z!Akn#>Sd+!LbBm;jcqyXStY?|S@aofbO#4}6kKPrwd8irHh=YU%WV`!;wV7{dJ<`2
z2@h$aKdjw=sc52aw|a9AS;-^753If;DWC<qseEEkhoE`~sPL+&-upf(0OGx+HblB5
zk#%cF1<yo17;F6XMzmfl3H(LLfAbK?I5n?l3W!1!I#w!sQ?+I_6R%AJ8sRrX1MLys
zRG{1p?A=Bjw|{SYS@ZJ@1EbRv-0MMBMrH_oO_5!r;U?+3dlj@c#W)8NE^axsD`%$@
zJc^zdb*tnJGKfE=tS$)$cA}>W2XwnoNKg|87ln0>LRX7q{g>jHC;Gtc9{JiIM#MpE
z`z_^naLMqCMT#n!4wCoVvNH?pB;`!FpZA`B86EpnNq?<=$v{COGCAoOfx*d`*$hOe
zEi6p0RdyJ<b`n=Xm){v`Zy>EMkhgD?c~d3N!1Ol---HhK-P7<1%;#Xt+i~5ss>$9A
zz6lXUU*8ps3oRbHWsTW;!^%beQ744h?jQdH5QuwHNXUkagNXA2i&ICbH|!ogm^zrg
zX(pX%8GqX|i9;Rbh*Sr4V~bAC{xxK|14(Y{|MB9F1{!AjC7jFp9-B5h&cjIf`nKYS
zU(8PAh(KJZ7<-mLP^G;}7uZ9Yar)=P1>@n{4zK=3gw)#uX(tTa%PN|n)7?i`19mEG
z;&wO3HDO2XShMIcF^J`H_B4`y0H27YY2>Sz88WBJs5-rHA>yJ3xU))$xU9~oZ1ATw
zf<jiG^n5>z$nJpBZo~X!2uNYpT?oEz-0VnZlLZ4tf0&6sV-kxf?g9b`00e>pfPF7q
z$K7VY@l;@1C?*K4{M+d5WkzO}Dd;?{X$UstZl+>H;~pg&^pQU}z0L~J)uTN}v0qAI
zV=?L>-OJPJYj*|}W}__sbgjFt7<)jRG=R}e9?~PI=q1dA4Xd}*)As`#z4G3zh0==e
zwvYEIe^2l}cqV?DamdO;&uf(0C+qxBA*Fj7+n^_7?R$s0I1yHGU6Cj#y$x814Z|!}
zf$r-xbJ=;I$}^t0zma49a*IUTU#e(EFNzlkH4MAGm(KR)Kem=>Xx|f>xgxwi`>Jqb
z(zwo12hHA1h-~k#Y0GafZS^2c(Mn<-LOBr?fB4O@Q&kAV&y!p0m;SJr9b9+Fy{JWx
zVFcN&jYu2iY#So{<iz@9B&3J#C$5}0iM-OtoTuHIF&eOK+ov@7mRO?Hrt`_mL8ci?
z&6(u_IxFfxr&Mk1#hG{S0tx5EpDvt|SB%$4W{Ncty}qQ-&>F1<-n-?Rji+_k0;-+R
zf0Eqv9*WM{_R`gd+uo{bws#uP)+2*ujo(TWC3ZR!o6u!lpA;Z)T&<X@=Q6;&G$27K
zjoD%URe6btDd?u_s|m{;=5G;Ec8fl1RhY6r%iM9N&qkvH@KIGxb>IY@D0^_Tjy|MS
z+2+Wv&%`piG^U6H%eV#0ki9lbpbf``f9!J2D!k?!1&Yk*uRyh?P3_e;`KQ7k+O{kN
zUtKFE9^|(<#^k2Ngx~}Q$*qtMJCg><CztaSlCG8I&^U>OYZ@|tfp%wCjhYp@L1nwc
zG(MIUyAFYW|JM&AnFx!ng<;KRy(%aM)ZrR9YC6Ojc9Jc3r==d|*9X&~HESi273W9c
zOrc^4<MjNUj~`v6>ViAY3Gb8J1vnxNDlA{J+!2_!X5nF-k;kn=I~=V92z-68yaEbu
II06C)0LVqD<NyEw

delta 1402
zcmV-=1%>*x47Ci9SbqjE4g?64OE>+9PYw+N0tf(rf&!Ss!rPB@V?t;<>X1Nfaq&j(
z>8frNNfV0%sfqRbF9&4e4rF5?^|e@e<(qRNOJ~$K6;0Z?#;+c&{bqg6XMM1qtuC~x
z;U&Mm${pY6+D0(%r{q2R`ssA6+n+YQ<RBs`f#<Q$rz+!G=YN7G%KHpWk;mH(sbhoV
z;2b~Ev%%>4GA3b^1eG|v$Y2K)M-jy$?N1wu<=D66F0M9=2P|tK?=aFO4sCFNm2nm0
z$FTvG`UMx|7cvjNakaDc{K@$GEQ0r1vh6{Zh+*;PqS7#&iFM{{xa{j|ZnjCoGGqkq
z{{dC1Yzg*q1Ang*7O#qOUX^(VWWB(kp>YO(<;Yv36FaBvQ~$pOc4+W!7N^84`SIB|
zd;TN$@dV^xjjyr?F)o>?^d~<ZXu~#V0VNJF`?dPE2V58K`%t(JW!kAg*8a0d>?NoS
zjW|FR4}BT$H(6PxM~y4eyU$<p?YXUQgA26UjBV8xWq(@`-tKjv^cLhHikeF@!?Q7Z
znC2iz)Y?gYat1-`bkXQF&@0!{4bZq$zCY3lxsnuztqRvIZ^7(z*)F!H!JBg3L>PP=
z&@`kvo(4(fZ-5~;{#S{!CJqtpp&p2-p~BE?5;Hbd1a71?HgF=KfF!KT4dqG<8x>Da
zQLKZ;IDcddlaagaJ}`=$8(6ouynpv`7$<73QH7fkRjt%*cWVMybV&fddx$K&8>cyG
zU+S(85rAXn*dv4Y5Nj`&gy2r`YlqB>uaX8s?r|2#8=XWbaivy&7-G4nB;PX%1Ar`P
zN_iOw97<%ySEoWKNu$%COOeDu3Wap$a`g#J2{NcJET(H;ZO3OK$&MW{z<P%$k<Y7K
zdE)Eb-|huXu<@dGKg@esaC_CVPWs+XR>k^alLZ4te~_G~99y<s7y<$a00e>pfIXBT
zW{hDQNhdrL1NjU6zLoxo+u4&gulVWXUY_<Dnae8ndRL#C^a`Px{{!NOBxgCpH(p;h
zva)W0MaQXgz+?=S2s+4}u^skbJLeV<IDn&3e<1Lkg(`$N0cXW;M~{p4Itieq3=hRS
zPwd%le?@jb-DxClQ;-zG%5yqYmd?j#ThNBv4-%>|h8c!N_UgRun;J8ka3G?alk_K9
zJS}`6e3ZQ9foN%`A<095s9fO!-;Um`+exeC4xs>&4m|LUz<1+at18-`()4FB%*HI-
zN6&aE8Ob|{uRa6`y4d+gSKJ&ZEZN34-Rp>&f8HFWe>@j|=*FM7kp~BgsQ>~+F3Avu
zv=@6bI13_AOyq|%q&kd{Uy5*_2a((qr&fH(2l#?g>g){Hzy|6hGi$Tc#Zqg7>w*_w
zah&9174^Ynkbp!cVw9Q(Y)*PiW)`+lwQ(cU(G5-FP=u%8ks?8(*p-9gb&Hk_O-ksv
zf1xl1v+%Hz#cz=iosmV6j_=hxz^td?*g)$>YZs>J#j(?sij=eW#f~?>>!x!tf&$jD
z#9y%7^{6N?U@`6+A6e@OECdqTil3_z&~~St-~utMd5txH9CnHd05>(1yxHQ}L;7;*
z`S-)&pLO6TxH0kTJF|V&J=ewyT}v&;f5h%k>HjD2M5*=?SV1Y*GnxYHd=j5;qV(1Y
z)~*xY?vox_>F4aSPZ@4u5{z;7<;@=KS1Hu1YZ0x&<B{TT5e(&WUNz#d0D5VH=GX>~
zUFf-nAky(pgk}c-Nk7(DUi-9D%yHkoL>6x4MWtq$se_(hcRrH@LP-Kx`__F870&C*
zTe(ctP_kz1B)X8-QTdH5_-m8f1vnz%Y@x4p?Ey(vRgGZlk>*J`Ik+DL2q|=z{w+c3
IIsyU+0G>ClSO5S3

-- 
1.8.0


From e974099e9bf97eb27840c310c9ab6c66107319e0 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= <ppisar@redhat.com>
Date: Fri, 30 Nov 2012 10:58:04 +0100
Subject: [PATCH 7/8] Skip disabled digests in t/local/50_digest.t

P_EVP_MD_list_all() does not remove digests disabled in FIPS.
MD2() and similar functions abort or crash depending on OpenSSL version if
the digest is disabled due to FIPS.
---
 t/local/50_digest.t | 47 ++++++++++++++++++++++++++++++++++-------------
 1 file changed, 34 insertions(+), 13 deletions(-)

diff --git a/t/local/50_digest.t b/t/local/50_digest.t
index ebd111b..c181837 100644
--- a/t/local/50_digest.t
+++ b/t/local/50_digest.t
@@ -65,19 +65,24 @@ sub digest_file {
   is(length($data), -s $file, 'got the whole file');
 
   SKIP: {
-    skip "Net::SSLeay::MD2 not available", 1 unless exists &Net::SSLeay::MD2;
+    skip "Net::SSLeay::MD2 not available", 1
+      unless exists &Net::SSLeay::MD2 and exists $available_digests->{md2};
     is( unpack("H*", Net::SSLeay::MD2($data)), $expected_results->{md2}, "MD2 all-in-one-go [$file]");
   }
   SKIP: {
-    skip "Net::SSLeay::MD4 not available", 1 unless exists &Net::SSLeay::MD4;
+    skip "Net::SSLeay::MD4 not available", 1
+      unless exists &Net::SSLeay::MD4 and exists $available_digests->{md4};
     is( unpack("H*", Net::SSLeay::MD4($data)), $expected_results->{md4}, "MD4 all-in-one-go [$file]");
   }
   SKIP: {
-    skip "Net::SSLeay::MD5 not available", 1 unless exists &Net::SSLeay::MD5;
+    skip "Net::SSLeay::MD5 not available", 1
+      unless exists &Net::SSLeay::MD5 and exists $available_digests->{md5};
     is( unpack("H*", Net::SSLeay::MD5($data)), $expected_results->{md5}, "MD5 all-in-one-go [$file]");
   }
   SKIP: {
-    skip "Net::SSLeay::RIPEMD160 not available", 1 unless exists &Net::SSLeay::RIPEMD160;
+    skip "Net::SSLeay::RIPEMD160 not available", 1
+      unless exists &Net::SSLeay::RIPEMD160 and
+        exists $available_digests->{ripemd160};
     is( unpack("H*", Net::SSLeay::RIPEMD160($data)), $expected_results->{ripemd160}, "RIPEMD160 all-in-one-go [$file]");
   }  
 }
@@ -106,32 +111,42 @@ sub digest_strings {
       
   
     SKIP: {
-      skip "Net::SSLeay::MD2 not available", 1 unless exists &Net::SSLeay::MD2;
+      skip "Net::SSLeay::MD2 not available", 1
+        unless exists &Net::SSLeay::MD2 and exists $available_digests->{md2};
       is(unpack('H*', Net::SSLeay::MD2($data)), $fps->{$data}->{md2}, "MD2 hash for '$data'");
     }
     SKIP: {
-      skip "Net::SSLeay::MD4 not available", 1 unless exists &Net::SSLeay::MD4;
+      skip "Net::SSLeay::MD4 not available", 1
+        unless exists &Net::SSLeay::MD4 and exists $available_digests->{md4};
       is(unpack('H*', Net::SSLeay::MD4($data)), $fps->{$data}->{md4}, "MD4 hash for '$data'");
     }
     SKIP: {
-      skip "Net::SSLeay::MD5 not available", 1 unless exists &Net::SSLeay::MD5;
+      skip "Net::SSLeay::MD5 not available", 1
+        unless exists &Net::SSLeay::MD5 and exists $available_digests->{md5};
       is(unpack('H*', Net::SSLeay::MD5($data)), $fps->{$data}->{md5}, "MD5 hash for '$data'");
     }
     SKIP: {
-      skip "Net::SSLeay::RIPEMD160 not available", 1 unless exists &Net::SSLeay::RIPEMD160;
+      skip "Net::SSLeay::RIPEMD160 not available", 1
+        unless exists &Net::SSLeay::RIPEMD160 and
+          exists $available_digests->{ripemd160};
       is(unpack('H*', Net::SSLeay::RIPEMD160($data)), $fps->{$data}->{ripemd160}, "RIPEMD160 hash for '$data'");
     }
 
     SKIP: {
-      skip "Net::SSLeay::SHA1 not available", 1 unless exists &Net::SSLeay::SHA1;
+      skip "Net::SSLeay::SHA1 not available", 1
+        unless exists &Net::SSLeay::SHA1 and exists $available_digests->{sha1};
       is(unpack('H*', Net::SSLeay::SHA1($data)), $fps->{$data}->{sha1}, "SHA1 hash for '$data'");
     }
     SKIP: {
-      skip "Net::SSLeay::SHA256 not available", 1 unless exists &Net::SSLeay::SHA256;
+      skip "Net::SSLeay::SHA256 not available", 1
+        unless exists &Net::SSLeay::SHA256 and
+          exists $available_digests->{sha256};
       is(unpack('H*', Net::SSLeay::SHA256($data)), $fps->{$data}->{sha256}, "SHA256 hash for '$data'");
     }
     SKIP: {
-      skip "Net::SSLeay::SHA512 not available", 1 unless exists &Net::SSLeay::SHA512;
+      skip "Net::SSLeay::SHA512 not available", 1
+        unless exists &Net::SSLeay::SHA512 and
+          exists $available_digests->{sha512};
       is(unpack('H*', Net::SSLeay::SHA512($data)), $fps->{$data}->{sha512}, "SHA512 hash for '$data'");
     }
   }
@@ -143,7 +158,13 @@ eval {
   Net::SSLeay::initialize();
   Net::SSLeay::OpenSSL_add_all_digests();
   if (Net::SSLeay::SSLeay >= 0x1000000f) {
-    %all_digests = map { $_=>1 } @{Net::SSLeay::P_EVP_MD_list_all()};
+	my $ctx = Net::SSLeay::EVP_MD_CTX_create();
+    %all_digests = map { $_=>1 } grep {
+      # P_EVP_MD_list_all() does not remove digests disabled in FIPS 
+      my $md;
+      $md = Net::SSLeay::EVP_get_digestbyname($_) and
+        Net::SSLeay::EVP_DigestInit($ctx, $md)
+    } @{Net::SSLeay::P_EVP_MD_list_all()};
   }
   else {
     %all_digests = ();
@@ -270,7 +291,7 @@ SKIP: {
     skip "pre-0.9.7", 1 unless Net::SSLeay::SSLeay >= 0x0090700f;
     my $md = Net::SSLeay::EVP_get_digestbyname("md5");
     my $ctx = Net::SSLeay::EVP_MD_CTX_create();
-    Net::SSLeay::EVP_DigestInit($ctx, $md);
+    skip "MD5 not available", 1 unless Net::SSLeay::EVP_DigestInit($ctx, $md);
     my $md2 = Net::SSLeay::EVP_MD_CTX_md($ctx);
     is(Net::SSLeay::EVP_MD_size($md2), 16, 'EVP_MD_size via EVP_MD_CTX_md md5');
   }
-- 
1.8.0


From d1f1988d50ffb9635f9c01f15a0866453fe5a64b Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= <ppisar@redhat.com>
Date: Fri, 30 Nov 2012 13:10:18 +0100
Subject: [PATCH 8/8] Expect undef in t/local/32_x509_get_cert_info.t when
 algorithm is not available

MD5 is not available in FIPS mode.
---
 t/local/32_x509_get_cert_info.t | 27 ++++++++++++++++++++++-----
 1 file changed, 22 insertions(+), 5 deletions(-)

diff --git a/t/local/32_x509_get_cert_info.t b/t/local/32_x509_get_cert_info.t
index e1fc186..b04bb0f 100755
--- a/t/local/32_x509_get_cert_info.t
+++ b/t/local/32_x509_get_cert_info.t
@@ -22,6 +22,17 @@ my $dump = {
   "testcert_strange.crt.pem"  => do(File::Spec->catfile('t', 'data', 'testcert_strange.crt.pem_dump')),
 };
 
+my %available_digests = map {$_=>1} qw( md5 sha1 );
+if (Net::SSLeay::SSLeay >= 0x1000000f) {
+  my $ctx = Net::SSLeay::EVP_MD_CTX_create();
+  %available_digests = map { $_=>1 } grep {
+    # P_EVP_MD_list_all() does not remove digests disabled in FIPS 
+    my $md;
+    $md = Net::SSLeay::EVP_get_digestbyname($_) and
+      Net::SSLeay::EVP_DigestInit($ctx, $md)
+  } @{Net::SSLeay::P_EVP_MD_list_all()};
+}
+
 for my $f (keys (%$dump)) {
   my $filename = File::Spec->catfile('t', 'data', $f);
   ok(my $bio = Net::SSLeay::BIO_new_file($filename, 'rb'), "BIO_new_file\t$f");
@@ -80,15 +91,21 @@ for my $f (keys (%$dump)) {
     }
   }
   
-  #BEWARE: values are not the same across different openssl versions, therefore testing just >0
+  #BEWARE: values are not the same across different openssl versions or FIPS mode, therefore testing just >0
   #is(Net::SSLeay::X509_subject_name_hash($x509), $dump->{$f}->{hash}->{subject}->{dec}, 'X509_subject_name_hash dec');
   #is(Net::SSLeay::X509_issuer_name_hash($x509), $dump->{$f}->{hash}->{issuer}->{dec}, 'X509_issuer_name_hash dec');
+  #is(Net::SSLeay::X509_issuer_and_serial_hash($x509), $dump->{$f}->{hash}->{issuer_and_serial}->{dec}, "X509_issuer_and_serial_hash dec\t$f");
   cmp_ok(Net::SSLeay::X509_subject_name_hash($x509), '>', 0, "X509_subject_name_hash dec\t$f");
   cmp_ok(Net::SSLeay::X509_issuer_name_hash($x509), '>', 0, "X509_issuer_name_hash dec\t$f");
-  
-  is(Net::SSLeay::X509_issuer_and_serial_hash($x509), $dump->{$f}->{hash}->{issuer_and_serial}->{dec}, "X509_issuer_and_serial_hash dec\t$f");
-  is(Net::SSLeay::X509_get_fingerprint($x509, "md5"), $dump->{$f}->{fingerprint}->{md5}, "X509_get_fingerprint md5\t$f");
-  is(Net::SSLeay::X509_get_fingerprint($x509, "sha1"), $dump->{$f}->{fingerprint}->{sha1}, "X509_get_fingerprint sha1\t$f");
+  cmp_ok(Net::SSLeay::X509_issuer_and_serial_hash($x509), '>', 0, "X509_issuer_and_serial_hash dec\t$f");
+
+  for my $digest (qw( md5 sha1 )) { 
+    is(Net::SSLeay::X509_get_fingerprint($x509, $digest),
+      (exists $available_digests{$digest} ?
+        $dump->{$f}->{fingerprint}->{$digest} :
+        undef),
+      "X509_get_fingerprint $digest\t$f");
+  }
   
   my $sha1_digest = Net::SSLeay::EVP_get_digestbyname("sha1");
   SKIP: {
-- 
1.8.0

