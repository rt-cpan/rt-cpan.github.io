<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #83378 for DBI: The slice-to-hash-with-rename feature is incomplete</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #83378 for DBI: The slice-to-hash-with-rename feature is incomplete</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBI/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBI/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBI/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBI/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBI">DBI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">83378</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBI/Active/">DBI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ribasushi [...] leporine.io

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10328-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10329-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;16&nbsp;13:40:13&nbsp;2013</span>
    <span class="description">ribasushi [...] leporine.io -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> The slice-to-hash-with-rename feature is incomplete</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Changes in DBIC 0.08240 finally allow me to take advantage of the new
feature that laned in DBI 1.620 &#40;
<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/TIMB/DBI-1.623/DBI.pm#L6437">https://metacpan.org/source/TIMB/DBI-1.623/DBI.pm#L6437</a></span> &#41;. However I
realized that the feature is incomplete - it is only recognized by the
eager fetchall_arrayref. Neither fetchrow_arrayref nor fetchrow_array
recognize a $slice argument. Therefore I can not use it in DBIC where it
is needed the most - in the case of cursor iteration.

Is this a &#34;brainfart&#34; type omission, or are there underlying design
considerations which make column renaming infeasible in the case of
row-based iterators?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;16&nbsp;16:41:14&nbsp;2013</span>
    <span class="description">TIMB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">A small clear test case would be appreciated.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;16&nbsp;16:41:16&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;16&nbsp;17:04:34&nbsp;2013</span>
    <span class="description">TIMB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Feb 16 13:40:13 2013, RIBASUSHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Changes in DBIC 0.08240 finally allow me to take advantage of the new
&gt; feature that laned in DBI 1.620 &#40;
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/TIMB/DBI-1.623/DBI.pm#L6437">https://metacpan.org/source/TIMB/DBI-1.623/DBI.pm#L6437</a></span> &#41;. However I
&gt; realized that the feature is incomplete - it is only recognized by the
&gt; eager fetchall_arrayref. Neither fetchrow_arrayref nor fetchrow_array
&gt; recognize a $slice argument. Therefore I can not use it in DBIC where it
&gt; is needed the most - in the case of cursor iteration.
&gt; 
&gt; Is this a &#34;brainfart&#34; type omission, or are there underlying design
&gt; considerations which make column renaming infeasible in the case of
&gt; row-based iterators?
</div>
It would be very expensive for fetchrow_* to consider such logic. I presume that you&#39;re calling it 
just once, eg for find&#40;&#41;, and not repeatedly on the same handle.

Perhaps what&#39;s needed here is for some kind of bind_columns-like call to setup binding to your 
own hash. Then you&#39;d just call $sth-&gt;fetch;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;16&nbsp;17:23:38&nbsp;2013</span>
    <span class="description">TIMB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From the bind_columns docs:

: For compatibility with old scripts, the first parameter will be
: ignored if it is C&lt;undef&gt; or a hash reference.
:
: Here&#39;s a more fancy example that binds columns to the values I&lt;inside&gt;
: a hash &#40;thanks to H.Merijn Brand&#41;:
: 
:  $sth-&gt;execute;
:  my %row;
:  $sth-&gt;bind_columns&#40; \&#40; @row{ @{$sth-&gt;{NAME_lc} } } &#41;&#41;;
:  while &#40;$sth-&gt;fetch&#41; {
:      print &#34;$row{region}: $row{sales}\n&#34;;
:  }

Perhaps we can make use of that old attribute hash *and* simplify the code in that &#34;fancy 
example&#34;.

Suggestions would be welcome. Patches would be delightful :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;17&nbsp;03:24:19&nbsp;2013</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #83378] The slice-to-hash-with-rename feature is incomplete</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 17 Feb 2013 19:24:00 +1100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Tim_Bunce via RT &lt;bug-DBI [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Rabbitson &lt;ribasushi [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat, Feb 16, 2013 at 05:04:35PM -0500, Tim_Bunce via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=83378">https://rt.cpan.org/Ticket/Display.html?id=83378</a></span> &gt;
&gt; 
&gt; On Sat Feb 16 13:40:13 2013, RIBASUSHI wrote:
<div class="message-stanza open">&gt; &gt; Changes in DBIC 0.08240 finally allow me to take advantage of the new
&gt; &gt; feature that laned in DBI 1.620 &#40;
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/TIMB/DBI-1.623/DBI.pm#L6437">https://metacpan.org/source/TIMB/DBI-1.623/DBI.pm#L6437</a></span> &#41;. However I
&gt; &gt; realized that the feature is incomplete - it is only recognized by the
&gt; &gt; eager fetchall_arrayref. Neither fetchrow_arrayref nor fetchrow_array
&gt; &gt; recognize a $slice argument. Therefore I can not use it in DBIC where it
&gt; &gt; is needed the most - in the case of cursor iteration.
&gt; &gt; 
&gt; &gt; Is this a &#34;brainfart&#34; type omission, or are there underlying design
&gt; &gt; considerations which make column renaming infeasible in the case of
&gt; &gt; row-based iterators?
</div>&gt; 
&gt; It would be very expensive for fetchrow_* to consider such logic. I presume that you&#39;re calling it 
&gt; just once, eg for find&#40;&#41;, and not repeatedly on the same handle.
</div>
Um... no... many many many times on the same handle. That is:

  my $rs_returning_1mil_rows = $schema-&gt;resultset&#40;&#39;Foo&#39;&#41;-&gt;search&#40;...&#41;;
  while &#40;my $r = $rs_returning_1mil_rows-&gt;next&#41; {
    ... do stuff
  }

Yes of course using -&gt;all is more efficient in terms of work done by the
CPU, but it is not always possible to fit everything in memory. The
specific code in DBIC that could be elided is:

<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/dbsrgits/dbix-class/blob/topic/constructor_rewrite/lib/DBIx/Class/ResultSet.pm#L1377">https://github.com/dbsrgits/dbix-class/blob/topic/constructor_rewrite/lib/DBIx/Class/ResultSet.pm#L1377</a></span>

where $rows is a bunch of arrayrefs &#40;obtained either via DBI&#39;s fetchall_X
OR via fetchrow_X&#41; and $infmap is an arrayref of &#34;renames&#34;.

Currently I can modify this code only for the case of $rs-&gt;all, which will
make it very very hairy &#40;the contents of $rows will differe depending on
invocation style&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Perhaps what&#39;s needed here is for some kind of bind_columns-like call to setup binding to your 
&gt; own hash. Then you&#39;d just call $sth-&gt;fetch;
</div>
Right, except I do not want to do that &#40;the binding&#41;, because I need to
guarantee that each hash is independent. And while I can re-bind a fresh
hash created in pure-perl - this will not gain me any performance at all.
The point &#40;as I understood it&#41; of the renaming feature was to allow for
*multiple independent* hashes to be assembled by XS code with the data we
expect.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; From the bind_columns docs:
&gt;
&gt; : For compatibility with old scripts, the first parameter will be
&gt; : ignored if it is C&lt;undef&gt; or a hash reference.
&gt; :
&gt; : Here&#39;s a more fancy example that binds columns to the values I&lt;inside&gt;
&gt; : a hash &#40;thanks to H.Merijn Brand&#41;:
&gt; :
&gt; :  $sth-&gt;execute;
&gt; :  my %row;
&gt; :  $sth-&gt;bind_columns&#40; \&#40; @row{ @{$sth-&gt;{NAME_lc} } } &#41;&#41;;
&gt; :  while &#40;$sth-&gt;fetch&#41; {
&gt; :      print &#34;$row{region}: $row{sales}\n&#34;;
&gt; :  }
&gt;
&gt; Perhaps we can make use of that old attribute hash *and* simplify the code in that &#34;fancy
&gt; example&#34;.
&gt;
&gt; Suggestions would be welcome. Patches would be delightful :&#41;
</div>
I would love to write some tests, but I have to admit I am not sure what
are you suggesting here as a way forward. See the requirement for
independency of the individual hashes above. Let&#39;s keep talking this
over, we can even meet on IRC at some point - just name a time.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;17&nbsp;04:05:44&nbsp;2013</span>
    <span class="description">h.m.brand [...] xs4all.nl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #83378] The slice-to-hash-with-rename feature is incomplete</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 17 Feb 2013 10:05:24 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBI [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;H.Merijn Brand&#34; &lt;h.m.brand [...] xs4all.nl&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat, 16 Feb 2013 17:23:39 -0500, &#34;Tim_Bunce via RT&#34;
&lt;bug-DBI@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: DBI
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=83378">https://rt.cpan.org/Ticket/Display.html?id=83378</a></span> &gt;
&gt; 
&gt; From the bind_columns docs:
&gt; 
&gt; : For compatibility with old scripts, the first parameter will be
&gt; : ignored if it is C&lt;undef&gt; or a hash reference.
&gt; :
&gt; : Here&#39;s a more fancy example that binds columns to the values I&lt;inside&gt;
&gt; : a hash &#40;thanks to H.Merijn Brand&#41;:
&gt; : 
&gt; :  $sth-&gt;execute;
&gt; :  my %row;
&gt; :  $sth-&gt;bind_columns&#40; \&#40; @row{ @{$sth-&gt;{NAME_lc} } } &#41;&#41;;
&gt; :  while &#40;$sth-&gt;fetch&#41; {
&gt; :      print &#34;$row{region}: $row{sales}\n&#34;;
&gt; :  }
&gt; 
&gt; Perhaps we can make use of that old attribute hash *and* simplify the
&gt; code in that &#34;fancy example&#34;.
</div>
I don&#39;t see how that &#34;fancy example&#34; can be simplified without losing
the clarity of its purpose. I still use this code &#40;though styled
differently&#41; on a daily basis in a lot of production code, so if that
could be made simpler or even faster, I&#39;d be very interested.

Other than that I might be missing the point completely, and would like
to hear some more verbose &#34;wish&#34;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Suggestions would be welcome. Patches would be delightful :&#41;
</div>
-- 
H.Merijn Brand  <span class="clickylink"><a target="new" rel="nofollow" href="http://tux.nl">http://tux.nl</a></span>   Perl Monger  <span class="clickylink"><a target="new" rel="nofollow" href="http://amsterdam.pm.org/">http://amsterdam.pm.org/</a></span>
using perl5.00307 .. 5.17   porting perl5 on HP-UX, AIX, and openSUSE
<span class="clickylink"><a target="new" rel="nofollow" href="http://mirrors.develooper.com/hpux/">http://mirrors.develooper.com/hpux/</a></span>        <span class="clickylink"><a target="new" rel="nofollow" href="http://www.test-smoke.org/">http://www.test-smoke.org/</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://qa.perl.org">http://qa.perl.org</a></span>   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.goldmark.org/jeff/stupid-disclaimers/">http://www.goldmark.org/jeff/stupid-disclaimers/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;17&nbsp;05:10:47&nbsp;2013</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> TIMB [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #83378] The slice-to-hash-with-rename feature is incomplete</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 17 Feb 2013 21:10:34 +1100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;h.m.brand [...] xs4all.nl via RT&#34; &lt;bug-DBI [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Rabbitson &lt;ribasushi [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun, Feb 17, 2013 at 04:05:45AM -0500, h.m.brand@xs4all.nl via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Other than that I might be missing the point completely, and would like
&gt; to hear some more verbose &#34;wish&#34;
</div>
Right, good point. I should start from the /achieve. As stated in an
earlier reply - I want to push the code in this loop into the realm
of DBI:

<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/dbsrgits/dbix-class/blob/topic/constructor_rewrite/lib/DBIx/Class/ResultSet.pm#L1377">https://github.com/dbsrgits/dbix-class/blob/topic/constructor_rewrite/lib/DBIx/Class/ResultSet.pm#L1377</a></span>

where $rows is a bunch of arrayrefs &#40;obtained either via DBI&#39;s 
fetchall_X OR via fetchrow_X&#41; and $infmap is an arrayref of &#34;renames&#34;.

Currently given what DBI offers me I can delegate the work only for 
-&gt;all&#40;&#41;-style cases, not for iterating -&gt;next&#40;&#41;-style cases. I am 
soliciting brainstorming towards an API addition which will give me a 
solution for that 2nd case.

Also note that it is ver possible this entire ticket is moot - it is 
possible there are *no* speedups to be had by pushing this functionality 
into DBI &#40;i.e. there is no way to XS-ify the arrayref-&gt;hashref 
transition in the case of an iterating access&#41;. If this is the case - 
just state so and we move on ;&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;17&nbsp;07:51:57&nbsp;2013</span>
    <span class="description">Tim.Bunce [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &#34;h.m.brand [...] xs4all.nl via RT&#34; &lt;bug-DBI [...] rt.cpan.org&gt;, TIMB [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #83378] The slice-to-hash-with-rename feature is incomplete</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 17 Feb 2013 12:51:39 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Peter Rabbitson &lt;ribasushi [...] cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tim Bunce &lt;Tim.Bunce [...] pobox.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">At the core of DBI fetching is the idea of an array of field buffers
&#40;grep for _fbav&#41;. Drivers assign values to SVs via that array.

That&#39;s simple and fast because it reuses the same SVs each time.
Those SVs have been set to the right type &#40;at least after the first row&#41;
and had their buffer grown big enough to fit typical values &#40;at least
after a few rows&#41;.

What bind_col&#40;umns&#41; does is simply change the pointers in the fbav array
to point at different scalars. The driver still uses fbav and we still
get all the benefits of reuse, but now the application gets the benefit
of having the values written into whatever SVs it wants, in whatever
structure it wants.

This already works &#40;and has for years&#41;:

    my $sth = $dbh-&gt;prepare&#40;&#34;select name, size, mode from $table&#34;&#41;;

    my $struct; # bind columns to values in whatever nested structure we want:
    $sth-&gt;bind_columns&#40;undef, \&#40;$struct-&gt;{name}, $struct-&gt;{attr}{size}, $struct-&gt;{attr}{ary}[2]&#41;&#41;&#41;;
    $sth-&gt;execute;

    my @structs;
    push @structs, dclone&#40;$struct&#41; while $csr_a-&gt;fetch;

    $VAR1 = [
          {
            &#39;name&#39; =&gt; &#39;.&#39;,
            &#39;attr&#39; =&gt; {
                        &#39;ary&#39; =&gt; [
                                   undef,
                                   undef,
                                   16872
                                 ],
                        &#39;size&#39; =&gt; 102
                      }
          },
          {
            &#39;name&#39; =&gt; &#39;..&#39;,
            &#39;attr&#39; =&gt; {
                        &#39;ary&#39; =&gt; [
                                   undef,
                                   undef,
                                   16877
                                 ],
                        &#39;size&#39; =&gt; 2414
                      }
          },
          {
            &#39;name&#39; =&gt; &#39;000_just_testing&#39;,
            &#39;attr&#39; =&gt; {
                        &#39;ary&#39; =&gt; [
                                   undef,
                                   undef,
                                   16872
                                 ],
                        &#39;size&#39; =&gt; 68
                      }
          }
    ];

What&#39;s needed beyond that?

Can&#39;t you just ignore what fetch*&#40;&#41; returns and &#39;clone&#39; the structure you bound
the field buffers into?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Also note that it is ver possible this entire ticket is moot - it is 
&gt; possible there are *no* speedups to be had by pushing this functionality 
&gt; into DBI &#40;i.e. there is no way to XS-ify the arrayref-&gt;hashref 
&gt; transition in the case of an iterating access&#41;. If this is the case - 
&gt; just state so and we move on ;&#41;
</div>
The way I see it, there&#39;s no need for an arrayref-&gt;hashref transition.
Just get the DBI to update hash elements for you then clone the hash.

Tim.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;17&nbsp;07:54:55&nbsp;2013</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Feb 17 07:51:57 2013, Tim.Bunce@pobox.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The way I see it, there&#39;s no need for an arrayref-&gt;hashref transition.
&gt; Just get the DBI to update hash elements for you then clone the hash.
</div>
As far as I know cloning &#40;especially dclone&#40;&#41;&#41; is extremely slow. I will
have to benchmark to substantiate this though. Will report back once I
have results.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;17&nbsp;12:00:55&nbsp;2013</span>
    <span class="description">Tim.Bunce [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #83378] The slice-to-hash-with-rename feature is incomplete</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 17 Feb 2013 17:00:38 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Peter Rabbitson via RT &lt;bug-DBI [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tim Bunce &lt;Tim.Bunce [...] pobox.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; As far as I know cloning &#40;especially dclone&#40;&#41;&#41; is extremely slow.
</div>
dclone is too generic. For example, it takes time to construct a
separate pointer table in order to &#34;do the right thing&#34; with reference
loops etc.

Their ought to be a more limited, and therefore faster, clone&#40;&#41;-like
function on CPAN.

It would be interesting to see benchmarks of &#34;simple cloners cloning
small simple structures&#34;, including JSON::XS and Sereal. Both of those
might beat Storable::dclone.

If all else fails, it wouldn&#39;t be too hard to implement such a simple
cloner in XS that would be faster than any perl code.

Tim.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;17&nbsp;13:21:46&nbsp;2013</span>
    <span class="description">TIMB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; JSON::XS and Sereal. Both of those might beat Storable::dclone.
</div>
Well, Sereal should but JSON::XS probably wouldn&#39;t. Still, the basic point stands.

There are also worth a look and comparing:
<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/module/Clone">https://metacpan.org/module/Clone</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/module/Clone::Fast">https://metacpan.org/module/Clone::Fast</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/module/Data::Clone">https://metacpan.org/module/Data::Clone</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;18&nbsp;12:05:19&nbsp;2013</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Feb 17 13:21:46 2013, TIMB wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; JSON::XS and Sereal. Both of those might beat Storable::dclone.
</div>&gt; 
&gt; Well, Sereal should but JSON::XS probably wouldn&#39;t. Still, the basic
&gt; point stands.
</div>
You will be very very surprised then. Attached is the benchmark script
&#40;can take a long time to run - the Dumbbench tolerances are set very low&#41;.

I will do a DBI-based benchmark later. Although given that even a plain
hash construction from perl space already beats all the cloners, an
XS-space construction with rebinding behind the scenes on every
itireation sounds like an uncontested winner.


Here are the results on 5.16.2 compiled with ithreads
-----------------------------------------------------
                       Rate dclone sereal data_clone  clone json_xs newhash
dclone     21.3717+-0.006/s     -- -38.9%     -56.2% -56.5%  -69.6%  -80.5%
sereal       34.953+-0.01/s  63.5%     --     -28.4% -28.8%  -50.3%  -68.2%
data_clone  48.808+-0.014/s 128.4%  39.6%         --  -0.6%  -30.7%  -55.5%
clone       49.083+-0.015/s 129.7%  40.4%       0.6%     --  -30.3%  -55.3%
json_xs     70.397+-0.021/s 229.4% 101.4%      44.2%  43.4%      --  -35.9%
newhash    109.762+-0.032/s 413.6% 214.0%     124.9% 123.6%   55.9%      --


5.16.2 without ithreads
-----------------------------------------------------
                        Rate dclone sereal data_clone  clone json_xs newhash
dclone     24.2437+-0.0047/s     -- -29.6%     -55.5% -55.5%  -69.8%  -80.6%
sereal         34.44+-0.01/s  42.1%     --     -36.8% -36.8%  -57.1%  -72.5%
data_clone   54.455+-0.016/s 124.6%  58.1%         --  -0.1%  -32.1%  -56.4%
clone        54.527+-0.016/s 124.9%  58.3%       0.1%     --  -32.0%  -56.4%
json_xs      80.223+-0.023/s 230.9% 132.9%      47.3%  47.1%      --  -35.8%
newhash      125.03+-0.036/s 415.7% 263.0%     129.6% 129.3%   55.9%      --


5.12.4 with ithreads
-----------------------------------------------------
                         Rate  dclone sereal data_clone  clone json_xs
newhash
dclone     5.98292+-0.00046/s      -- -80.8%     -84.3% -84.4%  -91.1% 
-95.1%
sereal      31.1264+-0.0093/s  420.3%     --     -18.5% -18.6%  -53.5% 
-74.4%
data_clone    38.171+-0.011/s  538.0%  22.6%         --  -0.2%  -42.9% 
-68.6%
clone         38.261+-0.011/s  539.5%  22.9%       0.2%     --  -42.8% 
-68.5%
json_xs         66.88+-0.02/s 1017.8% 114.9%      75.2%  74.8%      -- 
-45.0%
newhash      121.522+-0.036/s 1931.2% 290.4%     218.4% 217.6%   81.7% 
    --


5.8.8 without ithreads
-----------------------------------------------------
                         Rate  dclone sereal  clone data_clone json_xs
newhash
dclone     3.85165+-0.00023/s      -- -89.6% -94.9%     -94.9%  -95.6% 
-96.9%
sereal        36.927+-0.011/s  858.7%     -- -51.1%     -51.3%  -57.3% 
-69.9%
clone         75.543+-0.022/s 1861.3% 104.6%     --      -0.3%  -12.7% 
-38.4%
data_clone    75.768+-0.023/s 1867.2% 105.2%   0.3%         --  -12.5% 
-38.2%
json_xs       86.573+-0.025/s 2147.7% 134.4%  14.6%      14.3%      -- 
-29.4%
newhash      122.608+-0.036/s 3083.2% 232.0%  62.3%      61.8%   41.6% 
    --


All benches were executed after all modules in question were upgraded:

rabbit@Ahasver:~$ cpanm Time::HiRes Data::Clone Storable YAML::XS
JSON::XS Sereal Clone Data::Clone Data::Dumper Dumbbench
Time::HiRes is up to date. &#40;1.9725&#41;
Data::Clone is up to date. &#40;0.003&#41;
Storable is up to date. &#40;2.39&#41;
YAML::XS is up to date. &#40;0.39&#41;
JSON::XS is up to date. &#40;2.33&#41;
Sereal is up to date. &#40;0.310&#41;
Clone is up to date. &#40;0.34&#41;
Data::Dumper is up to date. &#40;2.139&#41;
Dumbbench is up to date. &#40;0.09&#41;

YAML::XS was commented out because it is just too damn slow.

Clone::Fast was *not* tested because it does not compile on perls above
5.10 *AND* it is in fact slower than current Clone.pm
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> bench_hash_clone.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use warnings;
use strict;

use Benchmark::Dumb &#39;cmpthese&#39;;

use Storable &#39;dclone&#39;;
use YAML::XS qw&#40;Dump Load&#41;;
use JSON::XS qw&#40;encode_json decode_json&#41;;
use Sereal qw&#40;encode_sereal decode_sereal&#41;;
use Clone &#39;clone&#39;;
use Data::Clone &#39;data_clone&#39;;
use Data::Dumper;
use Time::HiRes;

# Hack to make Dumbbench use CPU time as opposed to walltime
{
  no warnings &#39;redefine&#39;;
  local *Time::HiRes::time = eval &#34;sub {
    Time::HiRes::clock_gettime&#40; @{[ Time::HiRes::CLOCK_PROCESS_CPUTIME_ID&#40;&#41; ]} &#41;
  }&#34; or die $@;
}

$Data::Dumper::Deparse = 1;
$Data::Dumper::Sortkeys = 1;
$Data::Dumper::Indent = 1;
$Data::Dumper::Terse = 1;

print Dumper { &#39;make sure all benched functions are XSUBs&#39; =&gt; {
  dclone =&gt; \&#38;dclone,
  yaml_dump =&gt; \&#38;Dump,
  yaml_load =&gt; \&#38;Load,
  json_encode =&gt; \&#38;encode_json,
  json_decode =&gt; \&#38;decode_json,
  sereal_encode =&gt; \&#38;encode_sereal,
  sereal_decode =&gt; \&#38;decode_sereal,
  clone =&gt; \&#38;clone,
  data_clone =&gt; \&#38;data_clone,
}};

my $orig = { a =&gt; 1, b =&gt; 2 };
my $new;
my $iter = 5000;

my @dummy = &#40;1, 2&#41;;
sub new_hash {
  return { a =&gt; $dummy[0], b =&gt; $dummy[1] };
}

cmpthese&#40;&#39;200.0003&#39;, {
## YAML just isn&#39;t a viable contender - 3.5 times slower than dclone&#40;&#41;
#  yaml_xs =&gt; sub {
#    $new = Load&#40;Dump&#40;$orig&#41;&#41; for &#40;1..$iter&#41;;
#  },

  newhash =&gt; sub {
    $new = new_hash&#40;&#41; for &#40;1..$iter&#41;;
  },

  dclone =&gt; sub {
    $new = dclone&#40;$orig&#41; for &#40;1..$iter&#41;;
  },
  json_xs =&gt; sub {
    $new = decode_json&#40;encode_json&#40;$orig&#41;&#41; for &#40;1..$iter&#41;;
  },
  sereal =&gt; sub {
    $new = decode_sereal&#40;encode_sereal&#40;$orig&#41;&#41; for &#40;1..$iter&#41;;
  },
  clone =&gt; sub {
    $new = clone&#40;$orig&#41; for &#40;1..$iter&#41;;
  },
  data_clone =&gt; sub {
    $new = clone&#40;$orig&#41; for &#40;1..$iter&#41;;
  },
}&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;18&nbsp;13:21:41&nbsp;2013</span>
    <span class="description">smueller [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Feb 18 12:05:19 2013, RIBASUSHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sun Feb 17 13:21:46 2013, TIMB wrote:
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; JSON::XS and Sereal. Both of those might beat Storable::dclone.
</div>&gt; &gt; 
&gt; &gt; Well, Sereal should but JSON::XS probably wouldn&#39;t. Still, the basic
&gt; &gt; point stands.
</div>&gt; 
&gt; You will be very very surprised then. Attached is the benchmark script
&gt; &#40;can take a long time to run - the Dumbbench tolerances are set very 
</div>low&#41;.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I will do a DBI-based benchmark later. Although given that even a 
</div>plain
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; hash construction from perl space already beats all the cloners, an
&gt; XS-space construction with rebinding behind the scenes on every
&gt; itireation sounds like an uncontested winner.
</div>
Things like Sereal and Storable do a lot more work that you want here. A 
couple of comments on Sereal performance:

a&#41; ALWAYS use the OO interface if you care about performance. This makes 
a big difference, see b&#41;.

b&#41; The larger the structure, the better Sereal will look. It has 
relatively expensive setup compared to JSON::XS.

c&#41; Due to the nature of the data, it seems like you&#39;ll never care about 
repeated hash keys. You get an extra speed improvement by using 
&#34;no_shared_hashkeys =&gt; 1&#34;. If repeated hash keys occur, it&#39;s still 
faster without sharing them, but the intermediate output string will be 
larger.

But in the end, even for the OO interface, the best you can hope out of 
Sereal vs. JSON::XS for is the simplest data structure benchmarks here: 

<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/Sereal/Sereal/wiki/Sereal-Comparison-Graphs">https://github.com/Sereal/Sereal/wiki/Sereal-Comparison-Graphs</a></span>

You can see that JSON::XS beats Sereal on an empty hash here but Sereal 
comes out in &#34;small hash&#34;. Benchmark code lives in the Sereal repo under 
author_tools.

A dedicated &#34;build a copy of this data structure&#34; approach to cloning 
must beat serialization/deserialization by a long shot AND is bound to 
be quite a bit simpler. You could start with either the Sereal or 
JSON::XS encoder implementations as a base for it, too. Just build a 
tree of Perl structures instead of generating output. Extra benefit: If 
you use Sereal::Decoders pass-in-the-output-SV style, you get very 
simple and clean exception handling.

--Steffen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;18&nbsp;14:46:35&nbsp;2013</span>
    <span class="description">smueller [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Feb 18 13:21:41 2013, SMUELLER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Feb 18 12:05:19 2013, RIBASUSHI wrote:
<div class="message-stanza open">&gt; &gt; On Sun Feb 17 13:21:46 2013, TIMB wrote:
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; JSON::XS and Sereal. Both of those might beat Storable::dclone.
</div>&gt; &gt; &gt; 
&gt; &gt; &gt; Well, Sereal should but JSON::XS probably wouldn&#39;t. Still, the 
</div></div></div>basic
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; point stands.
</div>&gt; &gt; 
&gt; &gt; You will be very very surprised then. Attached is the benchmark 
</div></div>script
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; &#40;can take a long time to run - the Dumbbench tolerances are set very 
</div>&gt; low&#41;.
<div class="message-stanza open">&gt; &gt; 
&gt; &gt; I will do a DBI-based benchmark later. Although given that even a 
</div>&gt; plain
<div class="message-stanza open">&gt; &gt; hash construction from perl space already beats all the cloners, an
&gt; &gt; XS-space construction with rebinding behind the scenes on every
&gt; &gt; itireation sounds like an uncontested winner.
</div>&gt; 
&gt; Things like Sereal and Storable do a lot more work that you want here. 
</div>A 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; couple of comments on Sereal performance:
&gt; 
&gt; a&#41; ALWAYS use the OO interface if you care about performance. This 
</div>makes 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; a big difference, see b&#41;.
&gt; 
&gt; b&#41; The larger the structure, the better Sereal will look. It has 
&gt; relatively expensive setup compared to JSON::XS.
&gt; 
&gt; c&#41; Due to the nature of the data, it seems like you&#39;ll never care 
</div>about 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; repeated hash keys. You get an extra speed improvement by using 
&gt; &#34;no_shared_hashkeys =&gt; 1&#34;. If repeated hash keys occur, it&#39;s still 
&gt; faster without sharing them, but the intermediate output string will 
</div>be 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; larger.
&gt; 
&gt; But in the end, even for the OO interface, the best you can hope out 
</div>of 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sereal vs. JSON::XS for is the simplest data structure benchmarks 
</div>here: 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/Sereal/Sereal/wiki/Sereal-Comparison-Graphs">https://github.com/Sereal/Sereal/wiki/Sereal-Comparison-Graphs</a></span>
&gt; 
&gt; You can see that JSON::XS beats Sereal on an empty hash here but 
</div>Sereal 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; comes out in &#34;small hash&#34;. Benchmark code lives in the Sereal repo 
</div>under 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; author_tools.
&gt; 
&gt; A dedicated &#34;build a copy of this data structure&#34; approach to cloning 
&gt; must beat serialization/deserialization by a long shot AND is bound to 
&gt; be quite a bit simpler. You could start with either the Sereal or 
&gt; JSON::XS encoder implementations as a base for it, too. Just build a 
&gt; tree of Perl structures instead of generating output. Extra benefit: 
</div>If 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; you use Sereal::Decoders pass-in-the-output-SV style, you get very 
&gt; simple and clean exception handling.
&gt; 
&gt; --Steffen
</div>
With the above changes &#40;and just running dumbbench slightly less long&#41;, 
I get:

                     Rate        dclone         clone    data_clone       
sereal      json_xs newhash
dclone     52.95+-0.041/s            --        -55.5%        -55.7%       
-63.6%       -71.1%  -83.3%
clone       119.05+-0.1/s 124.83+-0.26%            --         -0.3%       
-18.2%       -35.1%  -62.6%
data_clone  119.4+-0.11/s 125.49+-0.27%   0.29+-0.12%            --       
-18.0%       -34.9%  -62.4%
sereal     145.54+-0.12/s 174.85+-0.32%  22.25+-0.15%  21.89+-0.15%           
--       -20.7%  -54.2%
json_xs    183.53+-0.14/s 246.61+-0.37%  54.16+-0.17%  53.71+-0.18% 
26.11+-0.14%           --  -42.3%
newhash    317.96+-0.34/s  500.5+-0.79% 167.08+-0.36% 166.31+-0.37% 
118.48+-0.3% 73.25+-0.22%      --

That is very much in line of what I&#39;d expect. If you use bigger data 
structures, Sereal will beat JSON::XS &#40;not that it matters much&#41; and if 
you use structures with common subtrees, it will beat the heck out of 
JSON::XS purely because it entirely avoids serializing things multiple 
times.

Nonetheless, my comment about serialization vs. cloning holds. Maybe 
some day, $work will have a need for a very efficient clone function and 
Yves or I get the time to implement one.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
