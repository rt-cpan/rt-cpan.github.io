<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #69931 for AnyEvent-Feed: Patch to _entry_to_hash to wiping HTML from content at digest calculation</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #69931 for AnyEvent-Feed: Patch to _entry_to_hash to wiping HTML from content at digest calculation</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/AnyEvent-Feed/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/AnyEvent-Feed/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/AnyEvent-Feed/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/AnyEvent-Feed/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/AnyEvent-Feed">AnyEvent-Feed CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">69931</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/AnyEvent-Feed/Active/">AnyEvent-Feed</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
MEETTYA [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-228212-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-228213-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




html_ignore.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/962174/500662/html_ignore.patch">
Mon Aug 01 05:03:04 2011 (2.2k) by MEETTYA [...] cpan.org
</a>
</font></li>
</ul>


html_ignore2.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/963709/501504/html_ignore2.patch">
Thu Aug 04 14:54:29 2011 (2.1k) by MEETTYA [...] cpan.org
</a>
</font></li>
</ul>


proof<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/962174/500661/proof">
Mon Aug 01 05:03:04 2011 (8k) by MEETTYA [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;01&nbsp;05:03:04&nbsp;2011</span>
    <span class="description">MEETTYA [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Patch to _entry_to_hash to wiping HTML from content at digest
 calculation</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Robin!

I try out AE-Feed and find its helpful and nice, but one thing must be improved.
I talk about  _entry_to_hash algo, it good, but &#34;naive&#34; for real world.

For example, exist russian geek magazine - overclockers_ru, and RSS - 
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.overclockers.ru/rss/all.rss">http://www.overclockers.ru/rss/all.rss</a></span> . So, this bad guy use HTML, embedded into item 
content, where contained counter or something like it, which generate different link. At the 
end I have some double for one item, because one item have different digest.

I put one item dump, you may see it by yourself. This results gotten by triple _continuously_ 
re-loading feed.

At the patch used HTML::Strip - fast&#38;furious html wiper, writing with XS. It not so smart as 
HTML::Parser and have some bugs, but I suppose it acceptable for digest.

Thanks at advance,
Dmitry.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> proof</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/962174/500661/proof">Download proof</a><br />
<span class="downloadcontenttype">application/octet-stream 8k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> html_ignore.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Feed.pm	2011-07-31 23:38:14.000000000 +0400
+++ Feed.pm	2011-07-31 23:55:45.000000000 +0400
@@ -9,6 +9,7 @@
 use AnyEvent::HTTP;
 use Digest::SHA1 qw/sha1_base64/;
 use Scalar::Util qw/weaken/;
+use HTML::Strip;
 
 our $VERSION = &#39;0.3&#39;;
 
@@ -124,6 +125,12 @@
 which means that an entry hash is removed from the C&lt;entry_ages&gt; hash after it
 has not been seen in the feed for 2 fetches.
 
+=item no_html_in_hash =&gt; $boolean
+
+This setting will enable &#34;smart&#34; mode of C&lt;entry_ages&gt; calculation. All html will
+be ignored. May be useful if item contained dynamic html and it proceed doubles 
+at output. 
+
 =back
 
 =cut
@@ -135,6 +142,11 @@
    bless $self, $class;
 
    $self-&gt;{entry_ages} ||= {};
+   
+   # add strip object if it needed
+   if &#40;defined $self-&gt;{no_html_in_hash}&#41;{
+   		$self-&gt;{__hs} = HTML::Strip-&gt;new&#40;&#41;;
+   }
 
    if &#40;defined $self-&gt;{interval}&#41; {
       unless &#40;defined $self-&gt;{on_fetch}&#41; {
@@ -163,17 +175,30 @@
 }
 
 
-sub _entry_to_hash {
-   my &#40;$entry&#41; = @_;
-   my $x = sha1_base64
+sub _entry_to_hash{  
+ my &#40; $entry, $hs &#41; = &#40; @_ &#41;;
+ # we are wipe all html if it need it, or return &#39;body&#39;
+ my @data = map { 
+ 					$_ &#38;&#38; $_-&gt;body ? 
+  					&#40; $hs ? 
+  							do { 
+  								my $a = $hs-&gt;parse&#40; $_-&gt;body &#41;;
+  								$hs-&gt;eof;
+  								$a;}
+  							: 
+  							$_-&gt;body &#41;
+  					: &#39;&#39;
+  				}  &#40;$entry-&gt;summary, $entry-&gt;content&#41;;
+	
+  my $x = sha1_base64
       encode &#39;utf-8&#39;,
-         &#40;my $a = join &#39;/&#39;,
+         &#40;	join &#39;/&#39;,
             $entry-&gt;title,
-            &#40;$entry-&gt;summary  ? $entry-&gt;summary-&gt;body : &#39;&#39;&#41;,
-            &#40;$entry-&gt;content  ? $entry-&gt;content-&gt;body : &#39;&#39;&#41;,
+            @data,
             $entry-&gt;id,
             $entry-&gt;link&#41;;
-   $x
+   $x;
+
 }
 
 sub _new_entries {
@@ -189,7 +214,7 @@
    $self-&gt;{entry_ages}-&gt;{$_}++ for keys %{$self-&gt;{entry_ages}};
 
    for my $ent &#40;@ents&#41; {
-      my $hash = _entry_to_hash &#40;$ent&#41;;
+      my $hash = _entry_to_hash &#40; $ent, $self-&gt;{__hs} &#41;;
 
       unless &#40;exists $self-&gt;{entry_ages}-&gt;{$hash}&#41; {
          push @new, [$hash, $ent];
@@ -252,7 +277,7 @@
 sub _get_headers {
    my &#40;$self, %hdrs&#41; = @_;
 
-   my %hdrs = %{$self-&gt;{headers} || {}};
+   %hdrs = %{$self-&gt;{headers} || {}};
 
    if &#40;defined $self-&gt;{last_mod}&#41; {
       $hdrs{&#39;If-Modified-Since&#39;} = $self-&gt;{last_mod};
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;04&nbsp;04:03:02&nbsp;2011</span>
    <span class="description">elmex [...] ta-sa.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #69931] Patch to _entry_to_hash to wiping HTML from content at digest  calculation</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 4 Aug 2011 10:05:21 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Карпич Дмитрий via RT &lt;bug-AnyEvent-Feed [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Robin Redeker &lt;elmex [...] ta-sa.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Dmitry!

On Mon, Aug 01, 2011 at 05:03:05AM -0400, Карпич Дмитрий via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Mon Aug 01 05:03:04 2011: Request 69931 was acted upon.
&gt; Transaction: Ticket created by MEETTYA
&gt;        Queue: AnyEvent-Feed
&gt;      Subject: Patch to _entry_to_hash to wiping HTML from content at digest
&gt;  calculation
&gt;    Broken in: &#40;no value&#41;
&gt;     Severity: Important
&gt;        Owner: Nobody
&gt;   Requestors: MEETTYA@cpan.org
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=69931">https://rt.cpan.org/Ticket/Display.html?id=69931</a></span> &gt;
&gt; 
&gt; 
&gt; Hi Robin!
&gt; 
&gt; I try out AE-Feed and find its helpful and nice, but one thing must be improved.
&gt; I talk about  _entry_to_hash algo, it good, but &#34;naive&#34; for real world.
&gt; 
&gt; For example, exist russian geek magazine - overclockers_ru, and RSS - 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.overclockers.ru/rss/all.rss">http://www.overclockers.ru/rss/all.rss</a></span> . So, this bad guy use HTML, embedded into item 
&gt; content, where contained counter or something like it, which generate different link. At the 
&gt; end I have some double for one item, because one item have different digest.
</div>
Oh, that sounds indeed bad :&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; At the patch used HTML::Strip - fast&#38;furious html wiper, writing with XS. It not so smart as 
&gt; HTML::Parser and have some bugs, but I suppose it acceptable for digest.
</div>
I&#39;m a bit reluctant applying the patch right away. It&#39;s only that your patch
comes in a completely different coding/formatting style &#40;tabs instead of
spaces, spaces around the parentheses different from other code&#41;. But it&#39;s
great that it comes with a few lines of documentation!

I&#39;m a bit reluctant to use HTML::Strip, but the module is already using XML::Feed,
which is a dependency beast on it&#39;s own too :&#41; And HTML::Parser doesn&#39;t really
feel like a good alternative too. So I shouldn&#39;t really care. The entry_to_hash
method is quite bold relying so much on the contents of the post anyways.

It would be awesome if you could fix the remaining issues and resubmit the patch!


Greetings,
   Robin

-- 
Robin Redeker                         | Deliantra, the free code+content MORPG
elmex@ta-sa.org / r.redeker@gmail.com | <span class="clickylink"><a target="new" rel="nofollow" href="http://www.deliantra.net">http://www.deliantra.net</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.ta-sa.org/">http://www.ta-sa.org/</a></span>                 |
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;04&nbsp;04:03:03&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;04&nbsp;14:54:29&nbsp;2011</span>
    <span class="description">MEETTYA [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, Robin!

Very glad to see you answer so fast.

On Thu Aug 04 04:03:02 2011, ELMEX wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Dmitry!
&gt; 
&gt; On Mon, Aug 01, 2011 at 05:03:05AM -0400, Карпич Дмитрий via RT wrote:
<div class="message-stanza open">&gt; &gt; Mon Aug 01 05:03:04 2011: Request 69931 was acted upon.
&gt; &gt; Transaction: Ticket created by MEETTYA
&gt; &gt;        Queue: AnyEvent-Feed
&gt; &gt;      Subject: Patch to _entry_to_hash to wiping HTML from content at
</div>&gt; digest
<div class="message-stanza open">&gt; &gt;  calculation
</div></div>&lt;..&gt;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It would be awesome if you could fix the remaining issues and resubmit
&gt; the patch!
&gt; 
&gt; 
</div>Yap, I`m negligent in my life, and my code suffer from that too :&#41;
I fix all and check it twice, now it must be same like other part style.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Greetings,
&gt;    Robin
&gt; 
</div>
Greetings,
Dmitry.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> html_ignore2.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Feed.pm	2011-08-04 22:27:21.000000000 +0400
+++ Feed.pm	2011-08-04 22:40:36.000000000 +0400
@@ -9,6 +9,7 @@
 use AnyEvent::HTTP;
 use Digest::SHA1 qw/sha1_base64/;
 use Scalar::Util qw/weaken/;
+use HTML::Strip;
 
 our $VERSION = &#39;0.3&#39;;
 
@@ -124,6 +125,12 @@
 which means that an entry hash is removed from the C&lt;entry_ages&gt; hash after it
 has not been seen in the feed for 2 fetches.
 
+=item no_html_in_hash =&gt; $boolean
+
+This setting will enable &#34;smart&#34; mode of C&lt;entry_ages&gt; calculation. All html will
+be ignored. May be useful if item contained dynamic html and it proceed doubles 
+at output. 
+
 =back
 
 =cut
@@ -136,6 +143,10 @@
 
    $self-&gt;{entry_ages} ||= {};
 
+   if &#40;defined $self-&gt;{no_html_in_hash}&#41;{
+      $self-&gt;{__hs} = HTML::Strip-&gt;new&#40;&#41;;
+   }
+
    if &#40;defined $self-&gt;{interval}&#41; {
       unless &#40;defined $self-&gt;{on_fetch}&#41; {
          croak &#34;no &#39;on_fetch&#39; callback given!&#34;;
@@ -164,13 +175,25 @@
 
 
 sub _entry_to_hash {
-   my &#40;$entry&#41; = @_;
+   my &#40;$entry, $hs&#41; = @_;
+   # we are wipe all html if it need it, or return &#39;body&#39;
+   my @data = map {
+      $_ &#38;&#38; $_-&gt;body ?
+         &#40;$hs ?
+            do {
+               my $a = $hs-&gt;parse&#40;$_-&gt;body&#41;;
+               $hs-&gt;eof;
+               $a;}
+            :
+            $_-&gt;body&#41;
+         : &#39;&#39;
+   } &#40;$entry-&gt;summary, $entry-&gt;content&#41;;
+
    my $x = sha1_base64
       encode &#39;utf-8&#39;,
-         &#40;my $a = join &#39;/&#39;,
+         &#40;join &#39;/&#39;,
             $entry-&gt;title,
-            &#40;$entry-&gt;summary  ? $entry-&gt;summary-&gt;body : &#39;&#39;&#41;,
-            &#40;$entry-&gt;content  ? $entry-&gt;content-&gt;body : &#39;&#39;&#41;,
+            @data,
             $entry-&gt;id,
             $entry-&gt;link&#41;;
    $x
@@ -189,7 +212,7 @@
    $self-&gt;{entry_ages}-&gt;{$_}++ for keys %{$self-&gt;{entry_ages}};
 
    for my $ent &#40;@ents&#41; {
-      my $hash = _entry_to_hash &#40;$ent&#41;;
+      my $hash = _entry_to_hash &#40;$ent, $self-&gt;{__hs}&#41;;
 
       unless &#40;exists $self-&gt;{entry_ages}-&gt;{$hash}&#41; {
          push @new, [$hash, $ent];
@@ -252,7 +275,7 @@
 sub _get_headers {
    my &#40;$self, %hdrs&#41; = @_;
 
-   my %hdrs = %{$self-&gt;{headers} || {}};
+   %hdrs = %{$self-&gt;{headers} || {}};
 
    if &#40;defined $self-&gt;{last_mod}&#41; {
       $hdrs{&#39;If-Modified-Since&#39;} = $self-&gt;{last_mod};
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
