<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #122630 for Sys-Statistics-Linux: Sys::Statistics::Linux::DiskUsage can&#39;t report on multiple mountpoints on the same &#39;Filesystem&#39;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #122630 for Sys-Statistics-Linux: Sys::Statistics::Linux::DiskUsage can&#39;t report on multiple mountpoints on the same &#39;Filesystem&#39;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Sys-Statistics-Linux/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Sys-Statistics-Linux/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Sys-Statistics-Linux/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Sys-Statistics-Linux/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Sys-Statistics-Linux">Sys-Statistics-Linux CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">122630</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Sys-Statistics-Linux/Active/">Sys-Statistics-Linux</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ACFEREN [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-41782-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.01</li>
<li>
0.02</li>
<li>
0.03</li>
<li>
0.04</li>
<li>
0.05</li>
<li>
0.06</li>
<li>
0.07</li>
<li>
0.09_01</li>
<li>
0.09_02</li>
<li>
0.09_03</li>
<li>
0.09_04</li>
<li>
0.09_05</li>
<li>
0.09_06</li>
<li>
0.09_09</li>
<li>
0.09_10</li>
<li>
0.09_11</li>
<li>
0.09_12</li>
<li>
0.09_13</li>
<li>
0.09_14</li>
<li>
0.09_15</li>
<li>
0.09_16</li>
<li>
0.09_17</li>
<li>
0.10</li>
<li>
0.11</li>
<li>
0.11_01</li>
<li>
0.11_02</li>
<li>
0.11_03</li>
<li>
0.12</li>
<li>
0.13</li>
<li>
0.14</li>
<li>
0.15</li>
<li>
0.16</li>
<li>
0.17</li>
<li>
0.18</li>
<li>
0.18_01</li>
<li>
0.19</li>
<li>
0.20</li>
<li>
0.21</li>
<li>
0.21_01</li>
<li>
0.21_02</li>
<li>
0.22</li>
<li>
0.23</li>
<li>
0.24</li>
<li>
0.25</li>
<li>
0.26</li>
<li>
0.28</li>
<li>
0.32</li>
<li>
0.33</li>
<li>
0.34</li>
<li>
0.36</li>
<li>
0.37</li>
<li>
0.38</li>
<li>
0.39_01</li>
<li>
0.40</li>
<li>
0.41</li>
<li>
0.42</li>
<li>
0.43</li>
<li>
0.44_01</li>
<li>
0.44_02</li>
<li>
0.44_03</li>
<li>
0.45</li>
<li>
0.46</li>
<li>
0.47</li>
<li>
0.48</li>
<li>
0.48_01</li>
<li>
0.48_02</li>
<li>
0.49</li>
<li>
0.50</li>
<li>
0.51_01</li>
<li>
0.52</li>
<li>
0.53_01</li>
<li>
0.54</li>
<li>
0.55_01</li>
<li>
0.55_02</li>
<li>
0.56</li>
<li>
0.57_01</li>
<li>
0.57_02</li>
<li>
0.57_03</li>
<li>
0.57_04</li>
<li>
0.58</li>
<li>
0.59</li>
<li>
0.59_01</li>
<li>
0.59_02</li>
<li>
0.60</li>
<li>
0.61</li>
<li>
0.62</li>
<li>
0.63</li>
<li>
0.64_1</li>
<li>
0.64_2</li>
<li>
0.65</li>
<li>
0.66</li>
</ul>
    </td>
  </tr>
  <tr id="CF-41783-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;28&nbsp;12:01:29&nbsp;2017</span>
    <span class="description">ACFEREN [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Sys::Statistics::Linux::DiskUsage can&#39;t report on multiple
 mountpoints on the same &#39;Filesystem&#39;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The df command used to get DiskUsage details returns 6 columns &#40;Filesystem, 1024-blocks, Used, Available, Capacity, and Mounted on&#41;.  The first column, Filesystem, is used as the key for the hash of statistics returned by Sys::Statistics::Linux::DiskUsage-&gt;get&#40;&#41;.  This generally works fine for actual disks since they all have unique filesystem names.  However, there are situations where the filesystem names are not all unique.  For example if you create more than one tmpfs ram drive you can only get the stats for the last one returned by df since all tmpfs mounts report &#34;tmpfs&#34; as their filesystem.

I&#39;ve attached a patched Sys-Statistics-Linux-0.66/lib/Sys/Statistics/Linux/DiskUsage.pm which fixes this issue.

The patched file also changes to the three argument version of open.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> DiskUsage.pm</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">=head1 NAME

Sys::Statistics::Linux::DiskUsage - Collect linux disk usage.

=head1 SYNOPSIS

    use Sys::Statistics::Linux::DiskUsage;

    my $lxs  = new Sys::Statistics::Linux::DiskUsage;
    my $stat = $lxs-&gt;get;

=head1 DESCRIPTION

Sys::Statistics::Linux::DiskUsage gathers the disk usage with the command C&lt;df&gt;.

For more information read the documentation of the front-end module L&lt;Sys::Statistics::Linux&gt;.

=head1 DISK USAGE INFORMATIONS

Generated by F&lt;/bin/df -kP&gt;.

    total       -  The total size of the disk.
    usage       -  The used disk space in kilobytes.
    free        -  The free disk space in kilobytes.
    usageper    -  The used disk space in percent.
    mountpoint  -  The moint point of the disk.

=head2 GLOBAL VARS

If you want to change the path or arguments for C&lt;df&gt; you can use the following
variables...

    $Sys::Statistics::Linux::DiskUsage::DF_PATH = &#39;/bin&#39;;
    $Sys::Statistics::Linux::DiskUsage::DF_CMD  = &#39;df -akP&#39;;

Example:

    use Sys::Statistics::Linux;
    use Sys::Statistics::Linux::DiskUsage;
    $Sys::Statistics::Linux::DiskUsage::DF_CMD = &#39;df -akP&#39;;

    my $sys  = Sys::Statistics::Linux-&gt;new&#40;diskusage =&gt; 1&#41;;
    my $disk = $sys-&gt;get;

=head1 METHODS

=head2 new&#40;&#41;

Call C&lt;new&#40;&#41;&gt; to create a new object.

    my $lxs = Sys::Statistics::Linux::DiskUsage-&gt;new;

It&#39;s possible to set the path to df.

     Sys::Statistics::Linux::DiskUsage-&gt;new&#40;
        cmd =&gt; {
            # This is the default
            path =&gt; &#39;/bin&#39;,
            df   =&gt; &#39;df -kP 2&gt;/dev/null&#39;,
        }
    &#41;;

=head2 get&#40;&#41;

Call C&lt;get&#40;&#41;&gt; to get the statistics. C&lt;get&#40;&#41;&gt; returns the statistics as a hash reference.

    my $stat = $lxs-&gt;get;

=head1 EXPORTS

No exports.

=head1 SEE ALSO

B&lt;df&#40;1&#41;&gt;

=head1 REPORTING BUGS

Please report all bugs to &lt;jschulz.cpan&#40;at&#41;bloonix.de&gt;.

=head1 AUTHOR

Jonny Schulz &lt;jschulz.cpan&#40;at&#41;bloonix.de&gt;.

=head1 COPYRIGHT

Copyright &#40;c&#41; 2006, 2007 by Jonny Schulz. All rights reserved.

This program is free software; you can redistribute it and/or modify it under the same terms as Perl itself.

=cut

package Sys::Statistics::Linux::DiskUsage;

use strict;
use warnings;
use Carp qw&#40;croak&#41;;

our $VERSION = &#39;0.14&#39;;
our $DF_PATH = undef;
our $DF_CMD  = undef;

sub new {
    my $class = shift;
    my $opts  = ref&#40;$_[0]&#41; ? shift : {@_};

    my %self = &#40;
        cmd =&gt; {
            path =&gt; &#39;/bin&#39;,
            df   =&gt; &#39;df -kP 2&gt;/dev/null&#39;,
        }
    &#41;;

    foreach my $p &#40;keys %{ $opts-&gt;{cmd} }&#41; {
        $self{cmd}{$p} = $opts-&gt;{cmd}-&gt;{$p};
    }

    return bless \%self, $class;
}

sub get {
    my $self   = shift;
    my $class  = ref $self;
    my $cmd    = $self-&gt;{cmd};
    my $df_cmd = $DF_CMD || $cmd-&gt;{df};
    my &#40;%disk_usage&#41;;

    local $ENV{PATH} = $DF_PATH || $cmd-&gt;{path};
    # Changed to the three argument version of open.  Not using the
    # three argument version is a little dangerous when allowing the
    # user to specify the df_cmd.
    open my $fh, &#39;-|&#39;, $df_cmd or croak &#34;$class: unable to execute &#39;$df_cmd&#39; &#40;$!&#41;&#34;;

    # filter the header
    {my $null = &lt;$fh&gt;;}

    # This is the least bad patch I could think of.  Previously the
    # %disk_usage hash was keyed on just the Filesystem name &#40;$1&#41;, but
    # for tmpfs &#40;and others&#41; it is possible to have multiple lines for
    # the same Filesystem.  Using seen we append __$seencnt to the
    # filesystem name for each instance after the first.  This means
    # that any code relying on the current hashkey will continue to
    # work for non-duplicated filesystem names.  Existing code never
    # really worked when filesystem names were duplicated so I don&#39;t
    # feel too badly about any breakage there.  I also added a
    # filesystem hashkey to the stats so we don&#39;t need to rely on
    # parsing off the &#34;__$seencnt&#34; from the new hashkey.
    my %seen;              # How many times have we seen a Filesystem?
    while &#40;my $line = &lt;$fh&gt;&#41; {
        next unless $line =~ /^&#40;.+?&#41;\s+&#40;.+&#41;$/;

        my &#40;$fs, $fs_key&#41; = &#40;$1,$1&#41;;
        $fs_key .= &#34;__$seen{$fs}&#34; if $seen{$fs}++;

        @{$disk_usage{$fs_key}}{qw&#40;
            filesystem
            total
            usage
            free
            usageper
            mountpoint
        &#41;} = &#40; split /\s+/, $line &#41;[0..5];

        $disk_usage{$fs_key}{usageper} =~ s/%$//;
    }

    close&#40;$fh&#41;;
    return \%disk_usage;
}

1;

__END__

# Local Variables: ***
# mode:CPerl ***
# cperl-indent-level:4 ***
# perl-indent-level:4 ***
# tab-width: 4 ***
# indent-tabs-mode: nil ***
# End: ***
#
# vim: ts=4 sw=4 expandtab
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
