<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #8193 for Image-Info: [PATCH] Adds direct access to the determine_file_format logic</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #8193 for Image-Info: [PATCH] Adds direct access to the determine_file_format logic</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Image-Info/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Image-Info/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Image-Info/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Image-Info/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Image-Info">Image-Info CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">8193</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">32 min

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Image-Info/Active/">Image-Info</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">TELS [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cpan [...] ali.as

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-16644-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.16    </td>
  </tr>
  <tr id="CF-16645-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.20    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;31&nbsp;05:32:14&nbsp;2004</span>
    <span class="description">adamk [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] Adds direct access to the determine_file_format logic</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Image::Info &#40;the base module&#41; has the ability to detect the image type without loading a driver and using only the first 32 bytes of a file, yet this ability is not available to the user.

While the determine_file_format function does exist, it is not important, and doesn&#39;t enjoy the same input flexibility as image_info does.

This dramatically slows down processes that _only_ want to know the type of a file, without needing to know all the extra stuff.

This patch adds the &#39;image_type&#39; function, which works in the same way as image_info, but returns a hash with only a single key &#39;file_type&#39; which is the value returned by determine_file_format.

I also abstracted a few bits and pieces out into separate functions to avoid excessive code duplication.

Because I&#39;ve edited directly inside the .tmpl file, I haven&#39;t had the chance to test that it works, but it&#39;s a fairly simple change so I don&#39;t see why it should pass all tests.

You may want to add one more additional quickie test to load each of the test files and make sure it detects properly, but that is more of a formality than anything, since it uses the same code.
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Info.pm.tmpl.old	2004-10-31 21:28:30.000000000 +1100
+++ Info.pm.tmpl	2004-10-31 21:30:17.000000000 +1100
@@ -10,7 +10,7 @@
 
 use vars qw&#40;$VERSION @EXPORT_OK&#41;;
 
-$VERSION = &#39;1.16&#39;;
+$VERSION = &#39;1.17&#39;;
 
 require Exporter;
 *import = \&#38;Exporter::import;
@@ -21,8 +21,56 @@
 
 sub image_info
 {
-    my&#40;$source, %cnf&#41; = @_;
+    my $source = _source&#40;shift&#41;;
+    return $source if ref $source eq &#39;HASH&#39;; # Pass on errors
 
+    # What sort of file is it?
+    my $head = _head&#40;$source&#41;
+        or return _os_err&#40;&#34;Can&#39;t read head&#34;&#41;;
+    my $format = determine_file_format&#40;$head&#41;
+        or return { error =&gt; &#39;Unrecognized file format&#39; };
+
+    no strict &#39;refs&#39;;
+    my $mod = &#34;Image::Info::$format&#34;;
+    my $sub = &#34;$mod\::process_file&#34;;
+    my $info = bless [], &#34;Image::Info::Result&#34;;
+    eval {
+        unless &#40;defined &#38;$sub&#41; {
+            if &#40;my $fail = $mod_failure{$mod}&#41; {
+                die $fail;
+            }
+            eval &#34;require $mod&#34;;
+            if &#40;$@&#41; {
+                $mod_failure{$mod} = $@;
+                die $@;
+            }
+            die &#34;$mod did not define &#38;$sub&#34; unless defined &#38;$sub;
+        }
+
+        my %cnf = @_;
+        &#38;$sub&#40;$info, $source, \%cnf&#41;;
+        $info-&gt;clean_up;
+    };
+    return { error =&gt; $@ } if $@;
+    return wantarray ? @$info : $info-&gt;[0];
+}
+
+sub image_type
+{
+    my $source = _source&#40;shift&#41;;
+    return $source if ref $source eq &#39;HASH&#39;; # Pass on errors
+
+    # What sort of file is it?
+    my $head = _head&#40;$source&#41; or return _os_err&#40;&#34;Can&#39;t read head&#34;&#41;;
+    my $format = determine_file_format&#40;$head&#41;
+        or return { error =&gt; &#34;Unrecognized file format&#34; };
+
+    return { file_type =&gt; $format };
+}
+
+sub _source
+{
+    my $source = shift;
     if &#40;!ref $source&#41; {
         require Symbol;
         my $fh = Symbol::gensym&#40;&#41;;
@@ -45,8 +93,14 @@
 	seek&#40;$source, 0, 0&#41; or return _os_err&#40;&#34;Can&#39;t rewind&#34;&#41;;
     }
 
-    my $head;
-    read&#40;$source, $head, 32&#41; or return _os_err&#40;&#34;Can&#39;t read head&#34;&#41;;
+    return $source;
+}
+
+sub _head
+{
+    my $source = shift;
+    my $head = read&#40;$source, $head, 32&#41;;
+
     if &#40;ref&#40;$source&#41; eq &#34;IO::String&#34;&#41; {
 	# XXX workaround until we can trap seek&#40;&#41; with a tied file handle
 	$source-&gt;setpos&#40;0&#41;;
@@ -55,31 +109,7 @@
 	seek&#40;$source, 0, 0&#41; or _os_err&#40;&#34;Can&#39;t rewind&#34;&#41;;
     }
 
-    if &#40;my $format = determine_file_format&#40;$head&#41;&#41; {
-	no strict &#39;refs&#39;;
-	my $mod = &#34;Image::Info::$format&#34;;
-	my $sub = &#34;$mod\::process_file&#34;;
-	my $info = bless [], &#34;Image::Info::Result&#34;;
-	eval {
-	    unless &#40;defined &#38;$sub&#41; {
-	        if &#40;my $fail = $mod_failure{$mod}&#41; {
-		    die $fail;
-		}
-		eval &#34;require $mod&#34;;
-		if &#40;$@&#41; {
-		    $mod_failure{$mod} = $@;
-		    die $@;
-		}
-		die &#34;$mod did not define &#38;$sub&#34; unless defined &#38;$sub;
-	    }
-
-	    &#38;$sub&#40;$info, $source, \%cnf&#41;;
-	    $info-&gt;clean_up;
-	};
-	return { error =&gt; $@ } if $@;
-	return wantarray ? @$info : $info-&gt;[0];
-    }
-    return { error =&gt; &#34;Unrecognized file format&#34; };
+    return $head;
 }
 
 sub _os_err
@@ -149,7 +179,13 @@
      die &#34;Can&#39;t parse image info: $error\n&#34;;
  }
  my $color = $info-&gt;{color_type};
-
+ 
+ my $type = image_type&#40;&#34;image.jpg&#34;&#41;;
+ if &#40;my $error = $type-&gt;{error}&#41; {
+     die &#34;Can&#39;t determine file type: $error\n&#34;;
+ }
+ die &#34;No gif files allowed!&#34; if $type-&gt;{file_type} eq &#39;GIF&#39;;
+ 
  my&#40;$w, $h&#41; = dim&#40;$info&#41;;
 
 =head1 DESCRIPTION
@@ -183,6 +219,35 @@
 The image_info&#40;&#41; function also take optional key/value style arguments
 that can influence what information is returned.
 
+=item image_type&#40; $file &#41;
+
+=item image_info&#40; \$imgdata &#41;
+
+This function is a dramatically faster alternative to the image_info
+function for situations in which you B&lt;only&gt; need to find the image type.
+
+It uses only the internal file-type detection to do this, and thus does
+not need to load any of the image type-specific driver modules, and does
+not access to entire file. It also only needs access to the first 32
+bytes of the file.
+
+To maintain some level of compatibility with image_info, image_type
+returns in the same format, with the same error message style. That is,
+it returns a HASH reference, with the $type-&gt;{error} key set if there
+was an error.
+
+On success, the HASH reference will contain the single key &#39;file_type&#39;,
+which represents the type of the file, expressed as the type code used for
+the various drivers &#40;&#39;GIF&#39;, &#39;JPEG&#39;, &#39;TIFF&#39; and so on&#41;.
+
+If there are multiple images within the file they will be ignored, as this
+function provides only the type of the overall file, not of the various
+images within it. This function will not return multiple hashes if the file
+contains multiple images.
+
+Of course, in all &#40;or at least effectively all&#41; cases the type of the images
+inside the file is going to be the same as that of the file itself.
+
 =item dim&#40; $info_hash &#41;
 
 Takes an hash as returned from image_info&#40;&#41; and returns the dimensions
@@ -331,6 +396,8 @@
 
 TIFF support by &lt;clarsen@emf.net&gt;.
 
+image_type by Adam Kennedy &lt;cpan@ali.as&gt;
+
 This library is free software; you can redistribute it and/or
 modify it under the same terms as Perl itself.
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;31&nbsp;05:33:38&nbsp;2004</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[ADAMK - Sun Oct 31 05:32:14 2004]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; While the determine_file_format function does exist, it is not
&gt; important, and doesn&#39;t enjoy the same input flexibility as image_info
&gt; does.
</div>
eep, &#34;important&#34;? :/

I meant &#34;it is not documented&#34;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;28&nbsp;05:39:18&nbsp;2006</span>
    <span class="description">TELS [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;28&nbsp;06:58:36&nbsp;2006</span>
    <span class="description">TELS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">2 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">For the 1.17 release I will not add this functionality, I need to clean
up the other stuff first and modernize this package. Sorry!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;28&nbsp;06:58:37&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;10&nbsp;05:45:57&nbsp;2006</span>
    <span class="description">TELS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">20 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I applied the patch, and then fixed it:

* reading my $head = read&#40;$source,$head,32&#41; doesn&#39;t pass use strict;
* need to read only 11 bytes, since tiny.pgm is only 11 bytes long
* error-handling did not work

The patch/functionality will be in the soon-to-be-released v1.20.

Thanx again for the report and your patience,

Tels
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;14&nbsp;12:05:23&nbsp;2006</span>
    <span class="description">TELS [...] cpan.org -  TimeWorked changed from &#39;22&#39; to &#39;32&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;14&nbsp;12:05:23&nbsp;2006</span>
    <span class="description">TELS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;14&nbsp;12:05:24&nbsp;2006</span>
    <span class="description">TELS [...] cpan.org -  Fixed in 1.20 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
