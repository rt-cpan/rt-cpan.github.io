<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #56516 for Test-Database: DSN report failures</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #56516 for Test-Database: DSN report failures</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Test-Database/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Test-Database/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Test-Database/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Test-Database/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Test-Database">Test-Database CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">56516</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Test-Database/Active/">Test-Database</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
BARBIE [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-224118-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.09    </td>
  </tr>
  <tr id="CF-224119-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.10    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;12&nbsp;06:11:50&nbsp;2010</span>
    <span class="description">BARBIE [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> DSN report failures</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi BooK,

Tried the latest version and got the same errors as some of the FAIL
reports on my CentOS box. The attached patch appears to resolve these
for me at least. However, the PrintError fix might be worth more
investigation.

Cheers,
Barbie.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test-database-driver.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Test-Database-1.09/lib/Test/Database/Driver.pm	Tue Mar 16 11:45:45 2010
+++ Test-Database-1.09_01/lib/Test/Database/Driver.pm	Mon Apr 12 11:07:45 2010
@@ -50,7 +50,7 @@
                 = DBI-&gt;parse_dsn&#40; $args{driver_dsn} &#41;;
             $args{dbd} = $driver;
         }
-        croak &#34;dbd or driver_dsn parameter required&#34; if !exists $args{dbd};
+        croak &#34;dbd or driver_dsn parameter required&#34; unless&#40;exists $args{dbd} &#38;&#38; $args{dbd}&#41;;
         eval &#34;require Test::Database::Driver::$args{dbd}&#34;
             or do { $@ =~ s/ at .*?\z//s; croak $@; };
         $class = &#34;Test::Database::Driver::$args{dbd}&#34;;
@@ -69,7 +69,7 @@
 
     # try to connect before returning the object
     if &#40; !$class-&gt;is_filebased&#40;&#41; &#41; {
-        eval { DBI-&gt;connect_cached&#40; $self-&gt;connection_info&#40;&#41; &#41; }
+        eval { DBI-&gt;connect_cached&#40; $self-&gt;connection_info&#40;&#41;, PrintError =&gt; 0 &#41; }
             or return;
     }
 

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;13&nbsp;04:01:00&nbsp;2010</span>
    <span class="description">BARBIE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Example FAIL reports resolved by this patch:

<span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/cpan/report/07024270-b19f-3f77-b713-d32bba55d77f">http://www.cpantesters.org/cpan/report/07024270-b19f-3f77-b713-d32bba55d77f</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/cpan/report/07015334-b19f-3f77-b713-d32bba55d77f">http://www.cpantesters.org/cpan/report/07015334-b19f-3f77-b713-d32bba55d77f</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/cpan/report/06979579-b19f-3f77-b713-d32bba55d77f">http://www.cpantesters.org/cpan/report/06979579-b19f-3f77-b713-d32bba55d77f</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;13&nbsp;04:01:03&nbsp;2010</span>
    <span class="description">BARBIE [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;22&nbsp;04:51:38&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Apr 12 06:11:50 2010, BARBIE wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi BooK,
&gt; 
&gt; Tried the latest version and got the same errors as some of the FAIL
&gt; reports on my CentOS box. The attached patch appears to resolve these
&gt; for me at least. However, the PrintError fix might be worth more
&gt; investigation.
&gt; 
&gt; Cheers,
&gt; Barbie.
</div>
Just to add to this report from Barbie. The first time I run
Test::Database with no ~/.test-database file and no
/tmp/Test-Database-martin I get:

prove -vb t/10-drivers.t 
t/10-drivers.t .. 
1..32
ok 1 - Test::Database::Driver-&gt;new&#40;&#41; failed
ok 2 - Expected error message
ok 3 - Test::Database::Driver has a base_dir&#40;&#41;: /tmp/Test-Database-martin
ok 4 - Test::Database::Driver&#39;s base_dir&#40;&#41; looks like expected
ok 5 - Test::Database::Driver base_dir&#40;&#41; is a directory
ok 6 - use Test::Database::Driver::DBM;
Use of uninitialized value $args{&#34;dbd&#34;} in concatenation &#40;.&#41; or string
at /tmp/Test-Database-1.09/blib/lib/Test/Database/Driver.pm line 55.
ok 7 # skip Failed to create DBM driver with Test::Database::Driver
&#40;Can&#39;t locate Test/Database/Driver/.pm in @INC &#40;@INC contains:
/tmp/Test-Database-1.09/blib/lib /tmp/Test-Database-1.09/blib/arch
/etc/perl /usr/local/lib/perl/5.10.0 /usr/local/share/perl/5.10.0
/usr/lib/perl5 /usr/share/perl5 /usr/lib/perl/5.10 /usr/share/perl/5.10
/usr/local/lib/site_perl .&#41;&#41;

The uninitialized value warning is down to the code Barbie refers to:

sub new {
    my &#40; $class, %args &#41; = @_;

    if &#40; $class eq __PACKAGE__ &#41; {
        if &#40; exists $args{driver_dsn} &#41; {
            my &#40; $scheme, $driver, $attr_string, $attr_hash, $driver_dsn &#41;
                = DBI-&gt;parse_dsn&#40; $args{driver_dsn} &#41;;
            $args{dbd} = $driver;
        }
        croak &#34;dbd or driver_dsn parameter required&#34; if !exists $args{dbd};
        eval &#34;require Test::Database::Driver::$args{dbd}&#34;
            or do { $@ =~ s/ at .*?\z//s; croak $@; };
        $class = &#34;Test::Database::Driver::$args{dbd}&#34;;
        $class-&gt;__init&#40;&#41;;
    }

Where %args contains:

$VAR1 = {
          &#39;password&#39; =&gt; &#39;&#39;,
          &#39;driver_dsn&#39; =&gt; undef,
          &#39;dbd&#39; =&gt; &#39;DBM&#39;,
          &#39;username&#39; =&gt; &#39;&#39;
        };

on entry hence &#34;exists $args{driver_dsn}&#34; is true and DBI&#39;s parse_dsn is
called with an empty $args{driver_dsn} hence $driver is undef and
assigned to $args{dbd} and the eval fails. Barbie&#39;s change fixed that
for me.

Having run once it works but you can make it fail again my deleting
/tmp/Test-Database-martin

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;22&nbsp;05:00:04&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Apr 22 04:51:38 2010, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Apr 12 06:11:50 2010, BARBIE wrote:
<div class="message-stanza open">&gt; &gt; Hi BooK,
&gt; &gt; 
&gt; &gt; Tried the latest version and got the same errors as some of the FAIL
&gt; &gt; reports on my CentOS box. The attached patch appears to resolve these
&gt; &gt; for me at least. However, the PrintError fix might be worth more
&gt; &gt; investigation.
&gt; &gt; 
&gt; &gt; Cheers,
&gt; &gt; Barbie.
</div>&gt; 
&gt; Just to add to this report from Barbie. The first time I run
&gt; Test::Database with no ~/.test-database file and no
&gt; /tmp/Test-Database-martin I get:
&gt; 
&gt; prove -vb t/10-drivers.t 
&gt; t/10-drivers.t .. 
&gt; 1..32
&gt; ok 1 - Test::Database::Driver-&gt;new&#40;&#41; failed
&gt; ok 2 - Expected error message
&gt; ok 3 - Test::Database::Driver has a base_dir&#40;&#41;: /tmp/Test-Database-martin
&gt; ok 4 - Test::Database::Driver&#39;s base_dir&#40;&#41; looks like expected
&gt; ok 5 - Test::Database::Driver base_dir&#40;&#41; is a directory
&gt; ok 6 - use Test::Database::Driver::DBM;
&gt; Use of uninitialized value $args{&#34;dbd&#34;} in concatenation &#40;.&#41; or string
&gt; at /tmp/Test-Database-1.09/blib/lib/Test/Database/Driver.pm line 55.
&gt; ok 7 # skip Failed to create DBM driver with Test::Database::Driver
&gt; &#40;Can&#39;t locate Test/Database/Driver/.pm in @INC &#40;@INC contains:
&gt; /tmp/Test-Database-1.09/blib/lib /tmp/Test-Database-1.09/blib/arch
&gt; /etc/perl /usr/local/lib/perl/5.10.0 /usr/local/share/perl/5.10.0
&gt; /usr/lib/perl5 /usr/share/perl5 /usr/lib/perl/5.10 /usr/share/perl/5.10
&gt; /usr/local/lib/site_perl .&#41;&#41;
&gt; 
&gt; The uninitialized value warning is down to the code Barbie refers to:
&gt; 
&gt; sub new {
&gt;     my &#40; $class, %args &#41; = @_;
&gt; 
&gt;     if &#40; $class eq __PACKAGE__ &#41; {
&gt;         if &#40; exists $args{driver_dsn} &#41; {
&gt;             my &#40; $scheme, $driver, $attr_string, $attr_hash, $driver_dsn &#41;
&gt;                 = DBI-&gt;parse_dsn&#40; $args{driver_dsn} &#41;;
&gt;             $args{dbd} = $driver;
&gt;         }
&gt;         croak &#34;dbd or driver_dsn parameter required&#34; if !exists
</div>$args{dbd};
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         eval &#34;require Test::Database::Driver::$args{dbd}&#34;
&gt;             or do { $@ =~ s/ at .*?\z//s; croak $@; };
&gt;         $class = &#34;Test::Database::Driver::$args{dbd}&#34;;
&gt;         $class-&gt;__init&#40;&#41;;
&gt;     }
&gt; 
&gt; Where %args contains:
&gt; 
&gt; $VAR1 = {
&gt;           &#39;password&#39; =&gt; &#39;&#39;,
&gt;           &#39;driver_dsn&#39; =&gt; undef,
&gt;           &#39;dbd&#39; =&gt; &#39;DBM&#39;,
&gt;           &#39;username&#39; =&gt; &#39;&#39;
&gt;         };
&gt; 
&gt; on entry hence &#34;exists $args{driver_dsn}&#34; is true and DBI&#39;s parse_dsn is
&gt; called with an empty $args{driver_dsn} hence $driver is undef and
&gt; assigned to $args{dbd} and the eval fails. Barbie&#39;s change fixed that
&gt; for me.
&gt; 
&gt; Having run once it works but you can make it fail again my deleting
&gt; /tmp/Test-Database-martin
&gt; 
&gt; Martin
</div>
However, I think it is unwise to call DBI&#39;s parse_dsn with an undefined
value so I think the following is better:

sub new {
    my &#40; $class, %args &#41; = @_;

    if &#40; $class eq __PACKAGE__ &#41; {

        if &#40; exists $args{driver_dsn} &#38;&#38; defined&#40;$args{driver_dsn}&#41;&#41; {
            my &#40; $scheme, $driver, $attr_string, $attr_hash, $driver_dsn &#41;
                = DBI-&gt;parse_dsn&#40; $args{driver_dsn} &#41;;
            $args{dbd} = $driver;
        }
        croak &#34;dbd or driver_dsn parameter required&#34; unless&#40;exists
$args{dbd} &#38;&#38; $args{dbd}&#41;;
        #croak &#34;dbd or driver_dsn parameter required&#34; if !exists $args{dbd};
        eval &#34;require Test::Database::Driver::$args{dbd}&#34;
            or do { $@ =~ s/ at .*?\z//s; croak $@; };
        $class = &#34;Test::Database::Driver::$args{dbd}&#34;;
        $class-&gt;__init&#40;&#41;;
    }
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;22&nbsp;05:02:06&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Apr 22 05:00:04 2010, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Apr 22 04:51:38 2010, MJEVANS wrote:
<div class="message-stanza open">&gt; &gt; On Mon Apr 12 06:11:50 2010, BARBIE wrote:
<div class="message-stanza open">&gt; &gt; &gt; Hi BooK,
&gt; &gt; &gt; 
&gt; &gt; &gt; Tried the latest version and got the same errors as some of the FAIL
&gt; &gt; &gt; reports on my CentOS box. The attached patch appears to resolve these
&gt; &gt; &gt; for me at least. However, the PrintError fix might be worth more
&gt; &gt; &gt; investigation.
&gt; &gt; &gt; 
&gt; &gt; &gt; Cheers,
&gt; &gt; &gt; Barbie.
</div>&gt; &gt; 
&gt; &gt; Just to add to this report from Barbie. The first time I run
&gt; &gt; Test::Database with no ~/.test-database file and no
&gt; &gt; /tmp/Test-Database-martin I get:
&gt; &gt; 
&gt; &gt; prove -vb t/10-drivers.t 
&gt; &gt; t/10-drivers.t .. 
&gt; &gt; 1..32
&gt; &gt; ok 1 - Test::Database::Driver-&gt;new&#40;&#41; failed
&gt; &gt; ok 2 - Expected error message
&gt; &gt; ok 3 - Test::Database::Driver has a base_dir&#40;&#41;:
</div></div>/tmp/Test-Database-martin
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; ok 4 - Test::Database::Driver&#39;s base_dir&#40;&#41; looks like expected
&gt; &gt; ok 5 - Test::Database::Driver base_dir&#40;&#41; is a directory
&gt; &gt; ok 6 - use Test::Database::Driver::DBM;
&gt; &gt; Use of uninitialized value $args{&#34;dbd&#34;} in concatenation &#40;.&#41; or string
&gt; &gt; at /tmp/Test-Database-1.09/blib/lib/Test/Database/Driver.pm line 55.
&gt; &gt; ok 7 # skip Failed to create DBM driver with Test::Database::Driver
&gt; &gt; &#40;Can&#39;t locate Test/Database/Driver/.pm in @INC &#40;@INC contains:
&gt; &gt; /tmp/Test-Database-1.09/blib/lib /tmp/Test-Database-1.09/blib/arch
&gt; &gt; /etc/perl /usr/local/lib/perl/5.10.0 /usr/local/share/perl/5.10.0
&gt; &gt; /usr/lib/perl5 /usr/share/perl5 /usr/lib/perl/5.10 /usr/share/perl/5.10
&gt; &gt; /usr/local/lib/site_perl .&#41;&#41;
&gt; &gt; 
&gt; &gt; The uninitialized value warning is down to the code Barbie refers to:
&gt; &gt; 
&gt; &gt; sub new {
&gt; &gt;     my &#40; $class, %args &#41; = @_;
&gt; &gt; 
&gt; &gt;     if &#40; $class eq __PACKAGE__ &#41; {
&gt; &gt;         if &#40; exists $args{driver_dsn} &#41; {
&gt; &gt;             my &#40; $scheme, $driver, $attr_string, $attr_hash,
</div></div>$driver_dsn &#41;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt;                 = DBI-&gt;parse_dsn&#40; $args{driver_dsn} &#41;;
&gt; &gt;             $args{dbd} = $driver;
&gt; &gt;         }
&gt; &gt;         croak &#34;dbd or driver_dsn parameter required&#34; if !exists
</div>&gt; $args{dbd};
<div class="message-stanza open">&gt; &gt;         eval &#34;require Test::Database::Driver::$args{dbd}&#34;
&gt; &gt;             or do { $@ =~ s/ at .*?\z//s; croak $@; };
&gt; &gt;         $class = &#34;Test::Database::Driver::$args{dbd}&#34;;
&gt; &gt;         $class-&gt;__init&#40;&#41;;
&gt; &gt;     }
&gt; &gt; 
&gt; &gt; Where %args contains:
&gt; &gt; 
&gt; &gt; $VAR1 = {
&gt; &gt;           &#39;password&#39; =&gt; &#39;&#39;,
&gt; &gt;           &#39;driver_dsn&#39; =&gt; undef,
&gt; &gt;           &#39;dbd&#39; =&gt; &#39;DBM&#39;,
&gt; &gt;           &#39;username&#39; =&gt; &#39;&#39;
&gt; &gt;         };
&gt; &gt; 
&gt; &gt; on entry hence &#34;exists $args{driver_dsn}&#34; is true and DBI&#39;s parse_dsn is
&gt; &gt; called with an empty $args{driver_dsn} hence $driver is undef and
&gt; &gt; assigned to $args{dbd} and the eval fails. Barbie&#39;s change fixed that
&gt; &gt; for me.
&gt; &gt; 
&gt; &gt; Having run once it works but you can make it fail again my deleting
&gt; &gt; /tmp/Test-Database-martin
&gt; &gt; 
&gt; &gt; Martin
</div>&gt; 
&gt; However, I think it is unwise to call DBI&#39;s parse_dsn with an undefined
&gt; value so I think the following is better:
&gt; 
&gt; sub new {
&gt;     my &#40; $class, %args &#41; = @_;
&gt; 
&gt;     if &#40; $class eq __PACKAGE__ &#41; {
&gt; 
&gt;         if &#40; exists $args{driver_dsn} &#38;&#38; defined&#40;$args{driver_dsn}&#41;&#41; {
&gt;             my &#40; $scheme, $driver, $attr_string, $attr_hash, $driver_dsn &#41;
&gt;                 = DBI-&gt;parse_dsn&#40; $args{driver_dsn} &#41;;
&gt;             $args{dbd} = $driver;
&gt;         }
&gt;         croak &#34;dbd or driver_dsn parameter required&#34; unless&#40;exists
&gt; $args{dbd} &#38;&#38; $args{dbd}&#41;;
&gt;         #croak &#34;dbd or driver_dsn parameter required&#34; if !exists
</div>$args{dbd};
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         eval &#34;require Test::Database::Driver::$args{dbd}&#34;
&gt;             or do { $@ =~ s/ at .*?\z//s; croak $@; };
&gt;         $class = &#34;Test::Database::Driver::$args{dbd}&#34;;
&gt;         $class-&gt;__init&#40;&#41;;
&gt;     }
</div>
However, I think it is unwise to call DBI&#39;s parse_dsn with an undefined
value and this leads to other warnings later. The following is better
for me:

sub new {
    my &#40; $class, %args &#41; = @_;

    if &#40; $class eq __PACKAGE__ &#41; {
        # added defined in the following:
        if &#40; exists $args{driver_dsn} &#38;&#38; defined&#40;$args{driver_dsn}&#41;&#41; {
            my &#40; $scheme, $driver, $attr_string, $attr_hash, $driver_dsn &#41;
                = DBI-&gt;parse_dsn&#40; $args{driver_dsn} &#41;;
            $args{dbd} = $driver;
        }
        croak &#34;dbd or driver_dsn parameter required&#34; unless&#40;exists
$args{dbd} &#38;&#38; $args{dbd}&#41;;
        #croak &#34;dbd or driver_dsn parameter required&#34; if !exists $args{dbd};
        eval &#34;require Test::Database::Driver::$args{dbd}&#34;
            or do { $@ =~ s/ at .*?\z//s; croak $@; };
        $class = &#34;Test::Database::Driver::$args{dbd}&#34;;
        $class-&gt;__init&#40;&#41;;
    }

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;22&nbsp;06:12:04&nbsp;2010</span>
    <span class="description">book [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Apr 22 05:00:04 2010, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &gt; 
&gt; &gt; Where %args contains:
&gt; &gt; 
&gt; &gt; $VAR1 = {
&gt; &gt;           &#39;password&#39; =&gt; &#39;&#39;,
&gt; &gt;           &#39;driver_dsn&#39; =&gt; undef,
&gt; &gt;           &#39;dbd&#39; =&gt; &#39;DBM&#39;,
&gt; &gt;           &#39;username&#39; =&gt; &#39;&#39;
&gt; &gt;         };
&gt; &gt; 
</div>
This is an error in the test script itself. The proper patch is:

diff --git a/t/10-drivers.t b/t/10-drivers.t
index 94b956f..37845c9 100644
--- a/t/10-drivers.t
+++ b/t/10-drivers.t
@@ -9,7 +9,9 @@ use Test::Database::Driver;
 my @drivers = &#40;
     map {
         my $d = $_;
-        +{ map { $_ =&gt; $d-&gt;{$_} } qw&#40; driver_dsn dbd username password &#41; }
+        +{ map { $_ =&gt; $d-&gt;{$_} }
+                grep { exists $d-&gt;{$_} }
+                qw&#40; driver_dsn dbd username password &#41; }
         } Test::Database-&gt;drivers&#40;&#41;
 &#41;;

This also removes a number of skips from the test.

Removing the warnings is nice, but people putting garbage in should get
garbage out. Even the test author. ;-&#41;

-- BooK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;26&nbsp;18:26:11&nbsp;2010</span>
    <span class="description">book [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #56516] DSN report failures</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 27 Apr 2010 00:25:58 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Barbie via RT &lt;bug-Test-Database [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Philippe Bruhat &#40;BooK&#41;&#34; &lt;book [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, Apr 12, 2010 at 06:11:52AM -0400, Barbie via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; However, the PrintError fix might be worth more investigation.
&gt; 
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;      # try to connect before returning the object
&gt;      if &#40; !$class-&gt;is_filebased&#40;&#41; &#41; {
&gt; -        eval { DBI-&gt;connect_cached&#40; $self-&gt;connection_info&#40;&#41; &#41; }
&gt; +        eval { DBI-&gt;connect_cached&#40; $self-&gt;connection_info&#40;&#41;, PrintError =&gt; 0 &#41; }
&gt;              or return;
&gt;      }
</div>
This fix actually gives this error:

   Can&#39;t use string &#40;&#34;PrintError&#34;&#41; as a HASH ref while &#34;strict refs&#34; in use.

because connect expects a hashref.

However, it&#39;s indeed a good idea to silence errors that are expected, i.e.
add a { PrintError =&gt; 0 } to all connect&#40;&#41; calls that live inside an eval {},
so I did that. :-&#41;

Thanks for your proposed patch!

-- 
 Philippe Bruhat &#40;BooK&#41;

 History is made by the winners and written by those with the loudest voices.
                                    &#40;Moral from Groo The Wanderer #10 &#40;Epic&#41;&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;28&nbsp;03:51:49&nbsp;2010</span>
    <span class="description">book [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;28&nbsp;03:51:49&nbsp;2010</span>
    <span class="description">book [...] cpan.org -  Fixed in 1.10 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
