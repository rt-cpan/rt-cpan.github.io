<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #52325 for File-ChangeNotify: Bug in File::ChangeNotify::Watcher::Inotify  __build__mask </title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #52325 for File-ChangeNotify: Bug in File::ChangeNotify::Watcher::Inotify  __build__mask </h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/File-ChangeNotify/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/File-ChangeNotify/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/File-ChangeNotify/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/File-ChangeNotify/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/File-ChangeNotify">File-ChangeNotify CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">52325</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/File-ChangeNotify/Active/">File-ChangeNotify</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
curtis.fletcher [...] n3k.co.uk

<br />
pjs [...] cpan.org

<br />
steve [...] yewtc.demon.co.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-227330-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-227331-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;01&nbsp;11:42:39&nbsp;2009</span>
    <span class="description">curtis.fletcher [...] n3k.co.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Bug in File::ChangeNotify::Watcher::Inotify  __build__mask </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 1 Dec 2009 16:42:01 -0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-File-ChangeNotify [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Curtis Fletcher&#34; &lt;curtis.fletcher [...] n3k.co.uk&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Package: File-ChangeNotify-0.09
Perl: 5.10.0
os: Linux ubuntu 2.6.27-7-generic

In File::ChangeNotify::Watcher::Inotify sub __build__mask I believe that
IN_MOVED_TO should be included in $mask. Otherwise renaming/moving files
into a watched directory are not picked up.

Curtis Fletcher
Software Developer

tuscany networks Limited
Tuscany House, White Hart Lane, Basingstoke, RG21 4AF 

Tel:  01256 303 726  Fax: 01256 303 701

www.tuscanynetworks.com

Important Notice
The information contained in or attached to this email is intended only for
the use of the correct addressee&#40;s&#41;. If you are not the intended recipient,
or a person responsible for delivering it to the intended recipient, you are
not authorised to and must not disclose, copy, distribute, or retain this
message or any part of it.
It may contain information which is confidential and/or covered by legal
professional or other privilege &#40;or other rules or laws with similar effect
in jurisdictions outside England and Wales&#41;. The views expressed in this
email are those of the author and not necessarily the views of the company,
its directors, officers or employees and we make no representation or accept
any liability for its accuracy or completeness unless expressly stated to
the contrary. The company will not be liable for direct, special, indirect
or consequential damages arising from alteration of the contents of this
message by a third party or as a result of any virus being passed on. The
company has implemented virus detection systems to minimise the risk of
passing on viruses. The company records all e-mail messages sent to and from
this address and reserves the right to monitor and examine content for the
purposes of training, quality control and for investigating or detecting any
unauthorised use of its system and for ensuring its effective operation.
tuscany networks is registered in England, company number 320 3561.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;01&nbsp;13:12:53&nbsp;2009</span>
    <span class="description">autarch [...] urth.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #52325] Bug in File::ChangeNotify::Watcher::Inotify __build__mask  </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 1 Dec 2009 12:12:42 -0600 &#40;CST&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Curtis Fletcher via RT &lt;bug-File-ChangeNotify [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dave Rolsky &lt;autarch [...] urth.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, 1 Dec 2009, Curtis Fletcher via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In File::ChangeNotify::Watcher::Inotify sub __build__mask I believe that
&gt; IN_MOVED_TO should be included in $mask. Otherwise renaming/moving files
&gt; into a watched directory are not picked up.
</div>
Can you come up with a test case? That&#39;d be really helpful.


-dave

/*============================================================
<span class="clickylink"><a target="new" rel="nofollow" href="http://VegGuide.org">http://VegGuide.org</a></span>               <span class="clickylink"><a target="new" rel="nofollow" href="http://blog.urth.org">http://blog.urth.org</a></span>
Your guide to all that&#39;s veg      House Absolute&#40;ly Pointless&#41;
============================================================*/
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;01&nbsp;13:12:54&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;23&nbsp;04:18:37&nbsp;2012</span>
    <span class="description">sjq-perl [...] jadevine.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Dec 01 11:42:39 2009, curtis.fletcher@n3k.co.uk wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Package: File-ChangeNotify-0.09
&gt; Perl: 5.10.0
&gt; os: Linux ubuntu 2.6.27-7-generic
&gt; 
&gt; In File::ChangeNotify::Watcher::Inotify sub __build__mask I believe 
</div>that
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; IN_MOVED_TO should be included in $mask. Otherwise renaming/moving 
</div>files
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; into a watched directory are not picked up.
&gt; 
</div>
I&#39;m seeing something very similar to this when trying to watch a 
directory of files which are maintained by an rsync process. The rsync 
process makes a temporary file elsewhere in the filesystem and then 
renames the file after the download has been completed. 
File::ChangeNotify does not spot any changes to the file contents. When 
I add IN_MOVED_TO into the mask for the Inotify watcher it spots the 
changed files. The event type was reported as &#34;unknown&#34; so I also 
altered the Event class.

Attached is a patch which works for me. I started trying to add some 
tests but I wasn&#39;t clear on the best way to write them so that they 
worked with different event watchers.


Regards,

Stephen Quinney
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> File-ChangeNotify-movedto.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ruNp File-ChangeNotify-0.16/lib/File/ChangeNotify/Event.pm File-ChangeNotify-0.16.new/lib/File/ChangeNotify/Event.pm
--- File-ChangeNotify-0.16/lib/File/ChangeNotify/Event.pm	2010-07-12 17:07:03.000000000 +0100
+++ File-ChangeNotify-0.16.new/lib/File/ChangeNotify/Event.pm	2012-01-23 08:37:32.000000000 +0000
@@ -18,7 +18,7 @@ has path =&gt; &#40;
 
 has type =&gt; &#40;
     is       =&gt; &#39;ro&#39;,
-    isa      =&gt; enum&#40; [qw&#40; create modify delete unknown &#41;] &#41;,
+    isa      =&gt; enum&#40; [qw&#40; create modify delete rename unknown &#41;] &#41;,
     required =&gt; 1,
 &#41;;
 
@@ -66,8 +66,8 @@ The full path to the file or directory t
 
 =item * type =&gt; $type
 
-The type of event. This must be one of &#34;create&#34;, &#34;modify&#34;, &#34;delete&#34;, or
-&#34;unknown&#34;.
+The type of event. This must be one of &#34;create&#34;, &#34;modify&#34;, &#34;delete&#34;,
+&#34;rename&#34; or &#34;unknown&#34;.
 
 =back
 
diff -ruNp File-ChangeNotify-0.16/lib/File/ChangeNotify/Watcher/Inotify.pm File-ChangeNotify-0.16.new/lib/File/ChangeNotify/Watcher/Inotify.pm
--- File-ChangeNotify-0.16/lib/File/ChangeNotify/Watcher/Inotify.pm	2010-07-12 17:07:03.000000000 +0100
+++ File-ChangeNotify-0.16.new/lib/File/ChangeNotify/Watcher/Inotify.pm	2012-01-23 08:30:40.000000000 +0000
@@ -102,7 +102,7 @@ sub _build__mask {
     my $self = shift;
 
     my $mask
-        = IN_MODIFY | IN_CREATE | IN_DELETE | IN_DELETE_SELF | IN_MOVE_SELF;
+        = IN_MODIFY | IN_CREATE | IN_DELETE | IN_DELETE_SELF | IN_MOVE_SELF | IN_MOVED_TO;
     $mask |= IN_DONT_FOLLOW unless $self-&gt;follow_symlinks&#40;&#41;;
 
     return $mask;
@@ -190,6 +190,7 @@ sub _convert_event {
               $event-&gt;IN_CREATE&#40;&#41; ? &#39;create&#39;
             : $event-&gt;IN_MODIFY&#40;&#41; ? &#39;modify&#39;
             : $event-&gt;IN_DELETE&#40;&#41; ? &#39;delete&#39;
+            : $event-&gt;IN_MOVED_TO&#40;&#41; ? &#39;rename&#39;
             : &#39;unknown&#39;
         &#41;,
     &#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;25&nbsp;10:13:11&nbsp;2012</span>
    <span class="description">autarch [...] urth.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #52325] Bug in File::ChangeNotify::Watcher::Inotify __build__mask  </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 25 Jan 2012 09:13:00 -0600 &#40;CST&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Stephen Quinney via RT &lt;bug-File-ChangeNotify [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dave Rolsky &lt;autarch [...] urth.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, 23 Jan 2012, Stephen Quinney via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Attached is a patch which works for me. I started trying to add some
&gt; tests but I wasn&#39;t clear on the best way to write them so that they
&gt; worked with different event watchers.
</div>
I really want the behavior of every watcher to be the same, so I think you 
should just write tests to test the behavior. If some of the watchers 
fail, that&#39;s ok, now we at least have a failing test.


-dave

/*============================================================
<span class="clickylink"><a target="new" rel="nofollow" href="http://VegGuide.org">http://VegGuide.org</a></span>               <span class="clickylink"><a target="new" rel="nofollow" href="http://blog.urth.org">http://blog.urth.org</a></span>
Your guide to all that&#39;s veg      House Absolute&#40;ly Pointless&#41;
============================================================*/
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Create even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;09&nbsp;23:03:02&nbsp;2012</span>
    <span class="description">pjs [...] cpan.org - Ticket #76460:  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Directory renames not tracked</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">As best I can tell, this is inherent to File::ChangeNotify and not Linux::Inotify2.  If I rename a 
directory, subsequent operations on it still have the original name.

Program:

use Data::Dumper;
use File::ChangeNotify;

my $watcher = File::ChangeNotify-&gt;instantiate_watcher&#40; directories =&gt; [ &#39;/tmp&#39; ]&#41;;
while &#40; my @events = $watcher-&gt;wait_for_events &#41;
{
  print &#34;Got events:\n&#34;;
  print Dumper $_ for @events;
}

Actions taken &#40;wd: /tmp&#41;:

mkdir foo
mv foo bar
touch bar/baz

Output:

Got events:
$VAR1 = bless&#40; {
                 &#39;type&#39; =&gt; &#39;create&#39;,
                 &#39;path&#39; =&gt; &#39;/tmp/foo&#39;
               }, &#39;File::ChangeNotify::Event&#39; &#41;;
Got events:
$VAR1 = bless&#40; {
                 &#39;type&#39; =&gt; &#39;unknown&#39;,
                 &#39;path&#39; =&gt; &#39;/tmp/foo&#39;
               }, &#39;File::ChangeNotify::Event&#39; &#41;;
Got events:
$VAR1 = bless&#40; {
                 &#39;type&#39; =&gt; &#39;create&#39;,
                 &#39;path&#39; =&gt; &#39;/tmp/foo/baz&#39;
               }, &#39;File::ChangeNotify::Event&#39; &#41;;


Last event should of course have a path of /tmp/bar/baz.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;09&nbsp;23:12:19&nbsp;2012</span>
    <span class="description">pjs [...] cpan.org - Ticket #76460:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Just realized that 52325 is addressing the same issue - the subject line threw me off.  Close 
this one by all means; it may be useful for the test case.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;09&nbsp;23:12:20&nbsp;2012</span>
    <span class="description">pjs [...] cpan.org - Ticket #76460:  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;09&nbsp;23:48:00&nbsp;2012</span>
    <span class="description">DROLSKY [...] cpan.org - Ticket #76460:  Merged into ticket #52325</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;09&nbsp;23:48:00&nbsp;2012</span>
    <span class="description">DROLSKY [...] cpan.org -  Merged into ticket #52325</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;10&nbsp;00:01:33&nbsp;2012</span>
    <span class="description">pjs [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I found that patch incomplete for tracking moves; it recognized a move but didn&#39;t track the new 
location.  I had to apply the following patch on top of it.  I will see if I can come up with a test.

+++ /usr/local/lib/perl5/site_perl/5.14.2/File/ChangeNotify/Watcher/Inotify.pm~2012-04-09 
20:15:48.000000000 -0700
@@ -85,15 +85,16 @@
         # excluded or when the exclusion excludes a file, not a dir.
         next if $self-&gt;_path_is_excluded&#40; $event-&gt;fullname&#40;&#41; &#41;;
 
-        if &#40; &#40;$event-&gt;IN_CREATE&#40;&#41; || $event-&gt;IN_MOVED_TO&#40;&#41;&#41; &#38;&#38; $event-&gt;IN_ISDIR&#40;&#41; &#41; {
+        if &#40; $event-&gt;IN_CREATE&#40;&#41; &#38;&#38; $event-&gt;IN_ISDIR&#40;&#41; &#41; {
             $self-&gt;_watch_directory&#40; $event-&gt;fullname&#40;&#41; &#41;;
             push @interesting, $event;
             push @interesting,
                 $self-&gt;_fake_events_for_new_dir&#40; $event-&gt;fullname&#40;&#41; &#41;;
         }
-        elsif &#40; $event-&gt;IN_DELETE_SELF&#40;&#41; || $event-&gt;IN_MOVE_SELF&#40;&#41; &#41; {
+        elsif &#40; $event-&gt;IN_DELETE_SELF&#40;&#41; &#41; {
             $self-&gt;_remove_directory&#40; $event-&gt;fullname&#40;&#41; &#41;;
         }
+
         # We just want to check the _file_ name
         elsif &#40; $event-&gt;name&#40;&#41; =~ /$filter/ &#41; {
             push @interesting, $event;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other SystemError even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;10&nbsp;00:01:33&nbsp;2012</span>
    <span class="description">The RT System itself -  System error</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sending the previous mail has failed.  Please contact your admin, they can find more details in the logs.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other SystemError odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;10&nbsp;00:01:34&nbsp;2012</span>
    <span class="description">The RT System itself -  System error</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sending the previous mail has failed.  Please contact your admin, they can find more details in the logs.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;10&nbsp;00:22:30&nbsp;2012</span>
    <span class="description">pjs [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Okay, this will test for correct behavior as provided by the combined patches above.  I do not 
have KQueue, I have no idea how to patch that.

use Test::More tests =&gt; 2;
use File::Temp qw&#40;tempdir&#41;;
use File::ChangeNotify;

my $dir = tempdir&#40; CLEANUP =&gt; 1 &#41;;
my $watcher = File::ChangeNotify-&gt;instantiate_watcher&#40; directories =&gt; [ $dir ] &#41;;
$watcher-&gt;new_events;

mkdir &#34;$dir/foo&#34;;                # Event 1: create
rename &#34;$dir/foo&#34;, &#34;$dir/bar&#34;;   # Event 2: rename
symlink &#34;..&#34;, &#34;$dir/bar/baz&#34;;    # Event 3: create

my @events = $watcher-&gt;new_events;
ok @events == 3, &#39;Saw all events&#39;;
is $events[2]-&gt;{path}, &#34;$dir/bar/baz&#34;, &#39;Saw correct destination path&#39;;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;10&nbsp;12:49:55&nbsp;2012</span>
    <span class="description">pjs [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Oops, got the patch backwards, sorry...
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other SystemError even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;10&nbsp;12:49:56&nbsp;2012</span>
    <span class="description">The RT System itself -  System error</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sending the previous mail has failed.  Please contact your admin, they can find more details in the logs.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other SystemError odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;10&nbsp;12:49:56&nbsp;2012</span>
    <span class="description">The RT System itself -  System error</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sending the previous mail has failed.  Please contact your admin, they can find more details in the logs.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Create even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;19&nbsp;12:26:11&nbsp;2013</span>
    <span class="description">steve [...] yewtc.demon.co.uk - Ticket #84747:  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> File Closed</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 19 Apr 2013 17:25:52 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-File-ChangeNotify [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steve Rogerson &lt;steve [...] yewtc.demon.co.uk&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">hi,

I&#39;ve just read  52325 and this affects me also. I have a specific need to 
check directories that have files added, typically by  an ftp process. When 
files have  finished being downloaded that are then processed in some way. I 
thought File::ChangeNotify would do what I want. In fact I have a working 
process that uses Linux::Inotify2 but I like the fact the File::ChangeNotify 
is os neutral.

I can&#39;t use it for two reasons.
1. Essentially #52325 - it doesn&#39;t detect files moved to the directory, as is 
done sometimes and
2. It doesn&#39;t detect that the file has been closed, in my context the file 
transfer has been completed.

We get the creates and modifies, but that doesn&#39;t tell me when the file has 
been closed and is ready to process.

It seems to me that my usage is not that strange, and that what&#39;s needed is to 
expose the mask to the user [ ok and process the extra events]. In my case I 
don&#39;t care about modified, I just want to know when it&#39;s finished.

I do have a &#34;test&#34; of sorts - but it fails sort of by definition as I know 
that the events I want are not generated. Actually it sits and waits forever, 
which isn&#39;t too good for a test, but I&#39;m working on it.

Steve
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;21&nbsp;11:59:40&nbsp;2013</span>
    <span class="description">DROLSKY [...] cpan.org - Ticket #84747:  Merged into ticket #52325</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;21&nbsp;11:59:40&nbsp;2013</span>
    <span class="description">DROLSKY [...] cpan.org -  Merged into ticket #52325</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;21&nbsp;12:02:15&nbsp;2013</span>
    <span class="description">DROLSKY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Apr 19 12:26:11 2013, steve@yewtc.demon.co.uk wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve just read  52325 and this affects me also. I have a specific need to
&gt; check directories that have files added, typically by  an ftp process. When
&gt; files have  finished being downloaded that are then processed in some way. I
&gt; thought File::ChangeNotify would do what I want. In fact I have a working
&gt; process that uses Linux::Inotify2 but I like the fact the File::ChangeNotify
&gt; is os neutral.
</div>
I&#39;m all for making this more featureful. There are two things that need to happen:

1. There needs to be tests for new features.
2. There needs to be a way to make it work with all implementations.

However, #2 can be a huge PITA since without something like inotify I have no idea how you can watch for close events or renames.

So ... for people who need that, it might be better to just use inotify or kqueue directly rather than trying to use this module.

Alternately, if someone came up with a Win32 implementation that used something Win32-specific to do this, I could consider getting rid of the pure Perl implementation, since that platform is the main reason it exists.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;22&nbsp;06:47:09&nbsp;2013</span>
    <span class="description">steve.bitcard [...] yewtc.demon.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> steve.bitcard [...] yewtc.demon.co.uk</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Apr 21 12:02:15 2013, DROLSKY wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Apr 19 12:26:11 2013, steve@yewtc.demon.co.uk wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; I&#39;ve just read  52325 and this affects me also. I have a specific
</div>&gt;    need to
<div class="message-stanza open">&gt; &gt; check directories that have files added, typically by  an ftp
</div>&gt;    process. When
<div class="message-stanza open">&gt; &gt; files have  finished being downloaded that are then processed in
</div>&gt;    some way. I
<div class="message-stanza open">&gt; &gt; thought File::ChangeNotify would do what I want. In fact I have a
</div>&gt;    working
<div class="message-stanza open">&gt; &gt; process that uses Linux::Inotify2 but I like the fact the
</div>&gt;    File::ChangeNotify
<div class="message-stanza open">&gt; &gt; is os neutral.
</div>&gt; 
&gt; I&#39;m all for making this more featureful. There are two things that
&gt;    need to happen:
&gt; 
&gt; 1. There needs to be tests for new features.
&gt; 2. There needs to be a way to make it work with all implementations.
&gt; 
&gt; However, #2 can be a huge PITA since without something like inotify I
&gt;    have no idea how you can watch for close events or renames.
&gt; 
&gt; So ... for people who need that, it might be better to just use
&gt;    inotify or kqueue directly rather than trying to use this module.
&gt; 
&gt; Alternately, if someone came up with a Win32 implementation that used
&gt;    something Win32-specific to do this, I could consider getting rid
&gt;    of the pure Perl implementation, since that platform is the main
&gt;    reason it exists.
</div>
I agree that probably I&#39;m better off continue using inotify &#40;Linux::Inotify2&#41; directly.

It doesn&#39;t look as though there is a simple Win32 alternative. Having said that, if the mask was exposed, it would allow linux users to check for move/close, though I agree that sort of contradicts the notion of os independence. Though the other choice is &#34;lowest common denominator&#34;.

 
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
