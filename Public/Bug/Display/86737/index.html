<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #86737 for Sys-Statistics-Linux: PATCH To add support for /proc/&lt;pid&gt;/limits data to Sys/Statistics/Linux/Processes.pm</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #86737 for Sys-Statistics-Linux: PATCH To add support for /proc/&lt;pid&gt;/limits data to Sys/Statistics/Linux/Processes.pm</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Sys-Statistics-Linux/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Sys-Statistics-Linux/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Sys-Statistics-Linux/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Sys-Statistics-Linux/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Sys-Statistics-Linux">Sys-Statistics-Linux CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">86737</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Sys-Statistics-Linux/Active/">Sys-Statistics-Linux</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">jschulz.cpan [...] bloonix.de
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
thatsafunnyname [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-41782-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.66    </td>
  </tr>
  <tr id="CF-41783-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;05&nbsp;13:58:11&nbsp;2013</span>
    <span class="description">cpan [...] pjedwards.co.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> PATCH To add support for /proc/&lt;pid&gt;/limits data to
 Sys/Statistics/Linux/Processes.pm</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Johnny and thank you for Sys-Statistics-Linux 0.66,

I found myself needing to read the &#40;u&#41;limits for another process in a pure perl script &#40;without XS&#41;.

I added support for providing a &#39;limits&#39; file to Sys/Statistics/Linux/Processes.pm &#40;to read the limits file&#41;, but as this file is typically &#40;I think&#41; only readable by the self process or root I set the default to the empty string and only make the calls to populate the data if it is set to a true value.

I also know the &#39;io&#39; file has had permissions changed over linux kernels, and on recent RHEL6 can now also only be read by the self process and root, I know there is the option to not collect &#39;processes&#39; data at the Sys::Statistics::Linux level, but I thought it might also be useful to be able to efficiently turn off attempts to read the &#39;io&#39; file at the Sys::Statistics::Linux::Processes level, by setting the file to a false value.

Rather than have the open calls be made to files that non root users can not read I changed _init&#40;&#41; and _load&#40;&#41; to only make the calls to _get_io&#40;&#41; and _get_limits&#40;&#41;
if the $self-&gt;{files}-&gt;{*} are set.  Hopefully this makes sense, the same could be done for the other files/directories, or a different approach could be to skip the open&#40;dir&#41; calls if the $file-&gt;{thing} is false, for example:

sub _get_fd {
    my &#40;$self, $pid&#41; = @_;
    my $file = $self-&gt;{files};
    my %stat = &#40;&#41;;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&gt;  if&#40; $file-&gt;{fd} &#41;{
</div>    if &#40;opendir my $dh, &#34;$file-&gt;{path}/$pid/$file-&gt;{fd}&#34;&#41; {
...
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&gt;  }
</div>
so a consumer could set files =&gt; { fd =&gt; q{} } , and avoid the &#34;opendir&#34; system calls if they were not interested in collecting the fd data, this approach still incurs the cost of the method calls which may be significant if called frequently over many pids.

Many thanks,
Peter &#40;Stig&#41; Edwards

Here is the patch for Sys-Statistics-Linux-0.66/lib/Sys/Statistics/Linux/Processes.pm
 
@@ -82,6 +82,9 @@

 Generated by F&lt;/proc/E&lt;lt&gt;pidE&lt;gt&gt;/io&gt;.

+    Permissions on this file have changed with versions of the kernel, opt out from
+    trying to read the file by setting the file to a false value,  files =&gt; { io =&gt; q{} }
+
     rchar                 -  Bytes read from storage &#40;might have been from pagecache&#41;.
     wchar                 -  Bytes written.
     syscr                 -  Number of read syscalls.
@@ -90,6 +93,19 @@
     write_bytes           -  Bytes sent to the storage layer.
     cancelled_write_bytes -  Refer to docs.

+Generated by F&lt;/proc/E&lt;lt&gt;pidE&lt;gt&gt;/limits&gt;.
+
+    Often only readable by self and root, opt in to trying to read the file by setting
+    the file to &#39;limits&#39;,  files =&gt; { limits =&gt; &#39;limits&#39; }
+
+    An array with &#40; soft_limit , hard_limit , units &#41; is provided for the limits listed.
+    This may vary between kernels.  Some examples are:
+
+    max_address_space     -  The maximum amount of virtual memory available to the shell
+    max_core_file_size    -  The maximum size of core files created
+    max_processes         -  The maximum number of processes available to a single user
+    max_open_files        -  The maximum number of open file descriptors
+
 See Documentation/filesystems/proc.txt for more &#40;from kernel 2.6.20&#41;

 =head1 METHODS
@@ -118,6 +134,7 @@
             wchan   =&gt; &#39;wchan&#39;,
             fd      =&gt; &#39;fd&#39;,
             io      =&gt; &#39;io&#39;,
+            limits  =&gt; &#39;&#39;,
         }
     &#41;;

@@ -195,6 +212,7 @@
             wchan   =&gt; &#39;wchan&#39;,
             fd      =&gt; &#39;fd&#39;,
             io      =&gt; &#39;io&#39;,
+            limits  =&gt; &#39;&#39;,
         },
     &#41;;

@@ -259,6 +277,9 @@

     $stats-&gt;{time} = Time::HiRes::gettimeofday&#40;&#41;;

+    my $collecting_io     = $file-&gt;{&#39;io&#39;};
+    my $collecting_limits = $file-&gt;{&#39;limits&#39;};
+
     foreach my $pid &#40;@$pids&#41; {
         my $stat = $self-&gt;_get_stat&#40;$pid&#41;;

@@ -266,7 +287,13 @@
             foreach my $key &#40;qw/minflt cminflt mayflt cmayflt utime stime cutime cstime sttime/&#41; {
                 $stats-&gt;{$pid}-&gt;{$key} = $stat-&gt;{$key};
             }
-            $stats-&gt;{$pid}-&gt;{io} = $self-&gt;_get_io&#40;$pid&#41;;
+
+           if&#40; $collecting_io &#41;{
+               $stats-&gt;{$pid}-&gt;{io}     = $self-&gt;_get_io&#40;$pid&#41;;
+           }
+           if&#40; $collecting_limits &#41;{
+               $stats-&gt;{$pid}-&gt;{limits} = $self-&gt;_get_limits&#40;$pid&#41;;
+           }
         }
     }

@@ -282,8 +309,17 @@

     $stats-&gt;{time} = Time::HiRes::gettimeofday&#40;&#41;;

+    my @keys = qw/statm stat owner cmdline wchan fd/;
+    if&#40; $file-&gt;{&#39;io&#39;} &#41;{
+       push @keys,&#39;io&#39;;
+    }
+
+    if&#40; $file-&gt;{&#39;limits&#39;} &#41;{
+       push @keys,&#39;limits&#39;;
+    }
+
     PID: foreach my $pid &#40;@$pids&#41; {
-        foreach my $key &#40;qw/statm stat io owner cmdline wchan fd/&#41; {
+        foreach my $key &#40;@keys&#41; {
             my $method = &#34;_get_$key&#34;;
             my $data = $self-&gt;$method&#40;$pid&#41;;

@@ -527,6 +563,29 @@
     return \%stat;
 }

+sub _get_limits {
+    my &#40;$self, $pid&#41; = @_;
+    my $file = $self-&gt;{files};
+    my %stat = &#40;&#41;;
+    my &#40; $line , $limit &#41;;
+
+    if &#40;open my $fh, &#39;&lt;&#39;, &#34;$file-&gt;{path}/$pid/$file-&gt;{limits}&#34;&#41; {
+        while &#40;$line = &lt;$fh&gt;&#41; {
+            if &#40;$line =~ /^&#40;[Ma-z ]+[a-z]&#41; +&#40;\d+|unlimited&#41; +&#40;\d+|unlimited&#41; +&#40;[a-z]*&#41;/&#41; {
+               $limit = $1;
+               $limit =~ tr/M /m_/;
+               #                soft hard units
+                $stat{$limit} = [  $2 , $3 , $4  ];
+            }
+        }
+
+        close&#40;$fh&#41;;
+    }
+
+    return \%stat;
+}
+
+
 sub _get_fd {
     my &#40;$self, $pid&#41; = @_;
     my $file = $self-&gt;{files};

__END__OF__PATCH__

Here is an example strace on the open calls as non root user, the errors when providing io=&gt;q{} are from trying to open /proc/&lt;pid&gt;/fd, while the code could check if the effective user is root or the owner of the PID this *could* break existing behaviour on some &#40;older&#41; kernels, so that was why I was thinking being able provide fd=&gt;q{} might be a nice option, just to note that if you provide fd=&gt;q{} now the errors from permission denied go away but the /proc/&lt;pid&gt;/ directory ends up being read.

strace -e trace=open -c perl -Mblib -e &#39;use Sys::Statistics::Linux;$s=Sys::Statistics::Linux-&gt;new&#40;&#41;;$s-&gt;set&#40; processes =&gt; {} &#41;;my $t=$s-&gt;get&#39; &gt; /dev/null
% time     seconds  usecs/call     calls    errors syscall
100.00    0.000234           0      8465      2300 open
 
strace -e trace=open -c perl -Mblib -e &#39;use Sys::Statistics::Linux;$s=Sys::Statistics::Linux-&gt;new&#40;&#41;;$s-&gt;set&#40; processes =&gt; { files =&gt; { io=&gt;q{} } } &#41;;my $t=$s-&gt;get&#39; &gt; /dev/null
% time     seconds  usecs/call     calls    errors syscall
100.00    0.000129           0      6943       796 open
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;05&nbsp;14:00:52&nbsp;2013</span>
    <span class="description">cpan [...] pjedwards.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry for the mistake in your name.
s/Johnny/Jonny/
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;05&nbsp;14:00:52&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
