<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #121897 for Net-DNS: REQUEST: Make bgbusy&#40;&#41; timeout adjustable?</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #121897 for Net-DNS: REQUEST: Make bgbusy&#40;&#41; timeout adjustable?</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Net-DNS">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Net-DNS">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Net-DNS">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Net-DNS">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-DNS">Net-DNS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">121897</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Net-DNS">Net-DNS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
felipe [...] felipegasper.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22454-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22455-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=121897">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1729696" href="/Public/Bug/Display.html?id=121897#txn-1729696">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;25&nbsp;16:25:42&nbsp;2017</span>
    <span class="description">felipe [...] felipegasper.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> REQUEST: Make bgbusy&#40;&#41; timeout adjustable?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 May 2017 15:55:12 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Felipe Gasper &lt;felipe [...] felipegasper.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1729696/930023/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/930023">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 155b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

        It would be useful to be able to specify a custom timeout for bgbusy&#40;&#41;; could this be added as a 2nd parameter to that function?

        Thank you!

-FG
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1729819" href="/Public/Bug/Display.html?id=121897#txn-1729819">#</a>      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;26&nbsp;09:52:41&nbsp;2017</span>
    <span class="description">FELIPE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1729819/930104/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/930104">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: lib/Net/DNS/Resolver/Base.pm
===================================================================
--- lib/Net/DNS/Resolver/Base.pm        &#40;revision 1567&#41;
+++ lib/Net/DNS/Resolver/Base.pm        &#40;working copy&#41;
@@ -617,7 +617,7 @@
 
 
 sub bgbusy {
-       my &#40; $self, $handle &#41; = @_;
+       my &#40; $self, $handle, $timeout &#41; = @_;
        return unless $handle;
 
        my $appendix = ${*$handle}{net_dns_bg} ||= [time&#40;&#41; + $self-&gt;{udp_timeout}];
@@ -624,7 +624,11 @@
        my &#40; $expire, $query, $read &#41; = @$appendix;
        return if ref&#40;$read&#41;;
 
-       unless &#40; IO::Select-&gt;new&#40;$handle&#41;-&gt;can_read&#40;0.2&#41; &#41; {
+    if &#40;!defined $timeout&#41; {
+        $timeout = 0.2;
+    }
+
+       unless &#40; IO::Select-&gt;new&#40;$handle&#41;-&gt;can_read&#40;$timeout&#41; &#41; {
                return time&#40;&#41; &lt;= $expire;
        }
 
Index: lib/Net/DNS/Resolver.pm
===================================================================
--- lib/Net/DNS/Resolver.pm     &#40;revision 1567&#41;
+++ lib/Net/DNS/Resolver.pm     &#40;working copy&#41;
@@ -383,7 +383,7 @@
 
     $handle = $resolver-&gt;bgsend&#40; &#39;foo.example.com&#39; &#41;;
 
-    while &#40;$resolver-&gt;bgbusy&#40;$handle&#41;&#41; {
+    while &#40;$resolver-&gt;bgbusy&#40;$handle, $optional_timeout&#41;&#41; {
        ...
     }
 
@@ -392,6 +392,9 @@
 Returns true while awaiting the response or for the transaction to time out.
 The argument is the handle returned by C&lt;bgsend&gt;.
 
+&lt;$optional_timeout&gt; gives the timeout length in seconds.
+Its default value is 0.2.
+
 Truncated UDP packets will be retried over TCP transparently while
 continuing to assert busy to the caller.
 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1729820" href="/Public/Bug/Display.html?id=121897#txn-1729820">#</a>      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;26&nbsp;09:52:42&nbsp;2017</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1730350" href="/Public/Bug/Display.html?id=121897#txn-1730350">#</a>      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;30&nbsp;15:15:05&nbsp;2017</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1730350/930369/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/930369">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 568b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu May 25 16:25:42 2017, felipe@felipegasper.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hello,
&gt; 
&gt; It would be useful to be able to specify a custom timeout for
&gt; bgbusy&#40;&#41;; could this be added as a 2nd parameter to that function?
&gt; 
</div>
The timeouts are already configurable in the resolver.

$resolver = new Net::DNS::Resolver&#40; udp_timeout =&gt; 10, tcp_timeout =&gt; 10 &#41;;

$resolver-&gt;bgbusy&#40;&#41; is a Boolean function provided for the user script to determine when the timeout interval has expired.

The 0.2 in the can_read&#40;&#41; is intended to limit the polling rate and must not be changed by end users.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1730353" href="/Public/Bug/Display.html?id=121897#txn-1730353">#</a>      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;30&nbsp;15:19:07&nbsp;2017</span>
    <span class="description">felipe [...] felipegasper.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #121897] REQUEST: Make bgbusy&#40;&#41; timeout adjustable?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 30 May 2017 15:18:54 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Felipe Gasper &lt;felipe [...] felipegasper.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1730353/930372/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/930372">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 30 May 2017, at 3:15 PM, Dick Franks via RT &lt;bug-Net-DNS@rt.cpan.org&gt; wrote:
&gt; 
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=121897">https://rt.cpan.org/Ticket/Display.html?id=121897</a></span> &gt;
&gt; 
&gt; On Thu May 25 16:25:42 2017, felipe@felipegasper.com wrote:
<div class="message-stanza open">&gt;&gt; Hello,
&gt;&gt; 
&gt;&gt; It would be useful to be able to specify a custom timeout for
&gt;&gt; bgbusy&#40;&#41;; could this be added as a 2nd parameter to that function?
&gt;&gt; 
</div>&gt; 
&gt; The timeouts are already configurable in the resolver.
&gt; 
&gt; $resolver = new Net::DNS::Resolver&#40; udp_timeout =&gt; 10, tcp_timeout =&gt; 10 &#41;;
&gt; 
&gt; $resolver-&gt;bgbusy&#40;&#41; is a Boolean function provided for the user script to determine when the timeout interval has expired.
&gt; 
&gt; The 0.2 in the can_read&#40;&#41; is intended to limit the polling rate and must not be changed by end users.
&gt; 
</div>
It should be the application that decides on limits on polling rates. Making the application wait 200ms merely to check to see if there’s been a response seems pretty awkward for performance-sensitive contexts.

For that matter, it would be nice if there were a bgselect&#40;&#41; method or some such mechanism to wait on multiple handles concurrently. &#40;They’re just sockets, of course, so select&#40;&#41; works just fine, except the docs forbid callers to do that, so.&#41;

-F
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1730355" href="/Public/Bug/Display.html?id=121897#txn-1730355">#</a>      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;30&nbsp;18:15:01&nbsp;2017</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1730355/930374/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/930374">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1018b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue May 30 15:19:07 2017, felipe@felipegasper.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; It should be the application that decides on limits on polling rates.
&gt; Making the application wait 200ms merely to check to see if there’s
&gt; been a response seems pretty awkward for performance-sensitive
&gt; contexts.
</div>
You misunderstand how this works.

The 200ms is the maximum time the IO::Select will wait for a reply before traversing the external loop.  If the external loop is empty the wait will be restarted immediately.  bgbusy&#40;&#41; returns false as soon as the reply packet arrives.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; For that matter, it would be nice if there were a bgselect&#40;&#41; method or
&gt; some such mechanism to wait on multiple handles concurrently
</div>
This is not a general purpose socket library, merely a simple mechanism for actioning background queries.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#40;They’re just sockets, of course, so select&#40;&#41; works just fine, except the docs
&gt; forbid callers to do that, so.&#41;
</div>
They are NOT just sockets, they just look like sockets but have other information hidden inside.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1730358" href="/Public/Bug/Display.html?id=121897#txn-1730358">#</a>      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;30&nbsp;18:25:18&nbsp;2017</span>
    <span class="description">felipe [...] felipegasper.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #121897] REQUEST: Make bgbusy&#40;&#41; timeout adjustable?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 30 May 2017 18:24:46 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Felipe Gasper &lt;felipe [...] felipegasper.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1730358/930377/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/930377">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 30 May 2017, at 6:15 PM, Dick Franks via RT &lt;bug-Net-DNS@rt.cpan.org&gt; wrote:
&gt; 
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=121897">https://rt.cpan.org/Ticket/Display.html?id=121897</a></span> &gt;
&gt; 
&gt; On Tue May 30 15:19:07 2017, felipe@felipegasper.com wrote:
<div class="message-stanza open">&gt;&gt; 
&gt;&gt; It should be the application that decides on limits on polling rates.
&gt;&gt; Making the application wait 200ms merely to check to see if there’s
&gt;&gt; been a response seems pretty awkward for performance-sensitive
&gt;&gt; contexts.
</div>&gt; 
&gt; You misunderstand how this works.
&gt; 
&gt; The 200ms is the maximum time the IO::Select will wait for a reply before traversing the external loop.  If the external loop is empty the wait will be restarted immediately.  bgbusy&#40;&#41; returns false as soon as the reply packet arrives.
</div>
… but it will wait up to 200ms until then. So, if the DNS server doesn’t respond, or the UDP packet gets lost, the application freezes for that length. This should be controllable by the application; for example, if the application doesn’t want to wait at all but merely wants to check, 0 could be passed in. Then the application could go off and do other things and check back in later.

Right now Net::DNS “punishes” the application merely for asking whether there’s a response yet.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 
<div class="message-stanza open">&gt;&gt; For that matter, it would be nice if there were a bgselect&#40;&#41; method or
&gt;&gt; some such mechanism to wait on multiple handles concurrently
</div>&gt; 
&gt; This is not a general purpose socket library, merely a simple mechanism for actioning background queries.
&gt; 
</div>
But it only allows checking one background query at a time. bgselect&#40;&#41; would allow checking multiple queries concurrently.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt;&gt; &#40;They’re just sockets, of course, so select&#40;&#41; works just fine, except the docs
&gt;&gt; forbid callers to do that, so.&#41;
</div>&gt; 
&gt; They are NOT just sockets, they just look like sockets but have other information hidden inside.
&gt; 
</div>
Sorry … they’re “at least” sockets. :&#41; select&#40;&#41; works on them, anyhow; unfortunately, that’s the only way right now to use them with this degree of flexibility.

-FG
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1730370" href="/Public/Bug/Display.html?id=121897#txn-1730370">#</a>      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;30&nbsp;20:14:09&nbsp;2017</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1730370/930385/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/930385">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue May 30 18:25:18 2017, felipe@felipegasper.com wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Right now Net::DNS “punishes” the application merely for asking
&gt; whether there’s a response yet.
</div>
The original reason for rate-limiting bgbusy&#40;&#41; loops was to avoid uselessly burning lots of CPU time creating and tearing down IO::Select objects in a tight loop.  There is such a tight loop in bgread&#40;&#41;, allowing a user to avoid coding his own wait loop.

I assume you are really arguing for a zero dwell time on the IO::Select rather than a wish to specify an arbitrary value.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; But it only allows checking one background query at a time. bgselect&#40;&#41;
&gt; would allow checking multiple queries concurrently.
</div>
Sure, but it does not fit easily into the Net::DNS model as presently realised.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt; &#40;They’re just sockets, of course, so select&#40;&#41; works just fine,
&gt; &gt;&gt; except the docs
&gt; &gt;&gt; forbid callers to do that, so.&#41;
</div>&gt; &gt;
&gt; &gt; They are NOT just sockets, they just look like sockets but have other
&gt; &gt; information hidden inside.
&gt; &gt;
</div>&gt; 
&gt; Sorry … they’re “at least” sockets. :&#41; select&#40;&#41; works on them, anyhow;
&gt; unfortunately, that’s the only way right now to use them with this
&gt; degree of flexibility.
</div>
These &#34;sockets&#34; can transform themselves from UDP into TCP if a reply packet is truncated and the query is retried automatically.  A Do-It-Yourself select scheme will get very confused when that happens.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1730463" href="/Public/Bug/Display.html?id=121897#txn-1730463">#</a>      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;31&nbsp;08:42:46&nbsp;2017</span>
    <span class="description">felipe [...] felipegasper.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #121897] REQUEST: Make bgbusy&#40;&#41; timeout adjustable?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 31 May 2017 08:42:35 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Felipe Gasper &lt;felipe [...] felipegasper.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1730463/930435/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/930435">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 30 May 2017, at 8:14 PM, Dick Franks via RT &lt;bug-Net-DNS@rt.cpan.org&gt; wrote:
&gt; 
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=121897">https://rt.cpan.org/Ticket/Display.html?id=121897</a></span> &gt;
&gt; 
&gt; On Tue May 30 18:25:18 2017, felipe@felipegasper.com wrote:
&gt; 
<div class="message-stanza open">&gt;&gt; Right now Net::DNS “punishes” the application merely for asking
&gt;&gt; whether there’s a response yet.
</div>&gt; 
&gt; The original reason for rate-limiting bgbusy&#40;&#41; loops was to avoid uselessly burning lots of CPU time creating and tearing down IO::Select objects in a tight loop.  There is such a tight loop in bgread&#40;&#41;, allowing a user to avoid coding his own wait loop.
</div>
… assuming that that user wants to make only one N::D::R query at a time.

Consider the case of having two concurrent queries. There’s no documented way currently to receive an event when the first of these is available to bgread&#40;&#41;. The only way is to roll one’s own select&#40;&#41; loop--despite the admonishments in the documentation--and hope for the best.

*That* could be solved by accepting multiple handles to bgbusy&#40;&#41;, which would seem pretty simple to implement? But, again, without being able to specify a wait time, N::D::R is assuming that the application has nothing better to do than to wait an arbitrary length of time for that event.

There’s another issue: N::D::R creates an extra IO::Select and select&#40;&#41; system call on every bgread&#40;&#41;. So if I do:

1 while $resolver-&gt;bgbusy&#40;$handle&#41;;
$packet = $resolver-&gt;bgread&#40;$handle&#41;;

… that’s actually doing at two select&#40;&#41;s and creating at least two IO::Select objects.

Why use IO::Select in the first place, btw? Are there portability advantages? Those could be cached within the handle to avoid recreating them.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I assume you are really arguing for a zero dwell time on the IO::Select rather than a wish to specify an arbitrary value.
</div>
I actually hadn’t noticed that bgread&#40;&#41; includes a zero-wait select&#40;&#41;. That seems to contradict the documentation, which speaks of a timeout? That might be useful to document if it’s intended that people can do bgread&#40;&#41; as a zero-wait check on the socket.

Anyhow. My team currently implements an 0.05 wait time; neither the code’s original author nor I are sure of the original rationale.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt;&gt; But it only allows checking one background query at a time. bgselect&#40;&#41;
&gt;&gt; would allow checking multiple queries concurrently.
</div>&gt; 
&gt; Sure, but it does not fit easily into the Net::DNS model as presently realised.
</div>
Is there a git mirror of the repo that can accept pull requests? I’ve forgotten the svn-fu that used to be my daily grind. :&#41;

I’d be willing to take a crack at adding this if you like.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 
<div class="message-stanza open"><div class="message-stanza open"><div class="message-stanza open">&gt;&gt;&gt;&gt; &#40;They’re just sockets, of course, so select&#40;&#41; works just fine,
&gt;&gt;&gt;&gt; except the docs
&gt;&gt;&gt;&gt; forbid callers to do that, so.&#41;
</div>&gt;&gt;&gt; 
&gt;&gt;&gt; They are NOT just sockets, they just look like sockets but have other
&gt;&gt;&gt; information hidden inside.
&gt;&gt;&gt; 
</div>&gt;&gt; 
&gt;&gt; Sorry … they’re “at least” sockets. :&#41; select&#40;&#41; works on them, anyhow;
&gt;&gt; unfortunately, that’s the only way right now to use them with this
&gt;&gt; degree of flexibility.
</div>&gt; 
&gt; These &#34;sockets&#34; can transform themselves from UDP into TCP if a reply packet is truncated and the query is retried automatically.  A Do-It-Yourself select scheme will get very confused when that happens.
&gt; 
</div>
So far we’re safe: we do a manual select&#40;&#41;, then bgbusy&#40;&#41; on the evented handles, then bgread&#40;&#41;. It’s definitely not ideal, but it’s the only way for now, and our application needs a more efficient path than waiting on a single handle at a time. Obviously we’d love to use upstream logic instead.

-FG
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1730602" href="/Public/Bug/Display.html?id=121897#txn-1730602">#</a>      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;31&nbsp;20:44:08&nbsp;2017</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1730602/930522/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/930522">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 5.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed May 31 08:42:46 2017, felipe@felipegasper.com wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; … assuming that that user wants to make only one N::D::R query at a
&gt; time.
</div>
That assumption was baked into Net::DNS long ago.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Consider the case of having two concurrent queries. There’s no
&gt; documented way currently to receive an event when the first of these
&gt; is available to bgread&#40;&#41;. The only way is to roll one’s own select&#40;&#41;
&gt; loop--despite the admonishments in the documentation--and hope for the
&gt; best.
&gt; 
&gt; *That* could be solved by accepting multiple handles to bgbusy&#40;&#41;,
&gt; which would seem pretty simple to implement? But, again, without being
&gt; able to specify a wait time, N::D::R is assuming that the application
&gt; has nothing better to do than to wait an arbitrary length of time for
&gt; that event.
</div>
Out of scope for the present discussion, but willing to consider better ideas.



<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; There’s another issue: N::D::R creates an extra IO::Select and
&gt; select&#40;&#41; system call on every bgread&#40;&#41;. So if I do:
&gt; 
&gt; 1 while $resolver-&gt;bgbusy&#40;$handle&#41;;
&gt; $packet = $resolver-&gt;bgread&#40;$handle&#41;;
&gt; 
&gt; … that’s actually doing at two select&#40;&#41;s and creating at least two
&gt; IO::Select objects.
</div>
See below

 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Why use IO::Select in the first place, btw? Are there portability
&gt; advantages?
</div>
As I pointed out earlier, there is other information added to the object.  Extending IO::Select is easier than writing another package from scratch.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Those could be cached within the handle to avoid
&gt; recreating them.
</div>
Tempting, but that creates indirect self-references which prevents memory from being reclaimed.  That bring in its wake either DESTROY&#40;&#41; methods to disentangle the objects, or using weak references which one needs to be careful not to copy lest they regain their strength.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I assume you are really arguing for a zero dwell time on the
&gt; &gt; IO::Select rather than a wish to specify an arbitrary value.
</div></div>
You did not answer the question:

Would you be happy &#40;happier?&#41; with a zero dwell time in bgbusy&#40;&#41;, assuming the tight loop objection can be overcome?

Yes or No?


 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I actually hadn’t noticed that bgread&#40;&#41; includes a zero-wait select&#40;&#41;.
&gt; That seems to contradict the documentation, which speaks of a timeout?
&gt; That might be useful to document if it’s intended that people can do
&gt; bgread&#40;&#41; as a zero-wait check on the socket.
</div>
Forget about select&#40;&#41; and zero waits, they are implementation detail.
Concentrate on the abstract object model.

The &#40;Resolver&#41; documentation is quite clear that if you have a handle from bgsend&#40;&#41;, then you can use bgread&#40;&#41; to obtain the response. Nowhere does it say that you need to test bgbusy&#40;&#41; first. &#40;FYI Older versions did need to test bgisready&#40;&#41;.&#41;


Look more carefully at the code:

sub bgread {
        while &#40;&#38;bgbusy&#41; { next; }     # side effect: TCP retry
        &#38;_bgread;
}

sub _bgread {
        my &#40; $self, $handle &#41; = @_;
        return unless $handle;

        my $appendix = ${*$handle}{net_dns_bg};
        my &#40; $expire, $query, $read &#41; = @$appendix;
        return shift&#40;@$read&#41; if ref&#40;$read&#41;;

        return unless IO::Select-&gt;new&#40;$handle&#41;-&gt;can_read&#40;0&#41;;

        my $peer = $handle-&gt;peerhost;
        $self-&gt;answerfrom&#40;$peer&#41;;


bgread&#40;&#41; contains a bgbusy&#40;&#41; loop before calling _bgread&#40;&#41;, so it is ok to do bgread&#40;&#41; straight after bgsend&#40;&#41;.

The can_read&#40;0&#41; in _bgread&#40;&#41; is needed to decide if the bgbusy&#40;&#41; loop ended because a packet arrived or the timeout interval expired.


 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Anyhow. My team currently implements an 0.05 wait time; neither the
&gt; code’s original author nor I are sure of the original rationale.
</div>
I guess the author&#39;s rationale was much the same as mine, tight busy loops.

Just for fun, I removed the 200ms dwell in bgbusy&#40;&#41; and measured the speed of the loop running on my laptop.  68000 per second!



<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt; But it only allows checking one background query at a time.
&gt; &gt;&gt; bgselect&#40;&#41;
&gt; &gt;&gt; would allow checking multiple queries concurrently.
</div>&gt; &gt;
&gt; &gt; Sure, but it does not fit easily into the Net::DNS model as presently
&gt; &gt; realised.
</div>&gt; 
&gt; Is there a git mirror of the repo that can accept pull requests? I’ve
&gt; forgotten the svn-fu that used to be my daily grind. :&#41;
&gt; 
&gt; I’d be willing to take a crack at adding this if you like.
</div>
Too many users depend on this distro, so uncontrolled code bashing is not really an option.

If you want to redesign this bit of the resolver, the way to start is to write some outline documentation with example use-cases. The idea is to capture the abstract object model from the user perspective.

Email me directly to discuss further.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt; Sorry … they’re “at least” sockets. :&#41; select&#40;&#41; works on them,
&gt; &gt;&gt; anyhow;
&gt; &gt;&gt; unfortunately, that’s the only way right now to use them with this
&gt; &gt;&gt; degree of flexibility.
</div>&gt; &gt;
&gt; &gt; These &#34;sockets&#34; can transform themselves from UDP into TCP if a reply
&gt; &gt; packet is truncated and the query is retried automatically.  A Do-It-
&gt; &gt; Yourself select scheme will get very confused when that happens.
&gt; &gt;
</div>&gt; 
&gt; So far we’re safe: we do a manual select&#40;&#41;, then bgbusy&#40;&#41; on the
&gt; evented handles, then bgread&#40;&#41;. It’s definitely not ideal, but it’s
&gt; the only way for now, and our application needs a more efficient path
&gt; than waiting on a single handle at a time. Obviously we’d love to use
&gt; upstream logic instead.
</div>
It would be useful for us to know a bit of detail about what your application is trying to do.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1730754" href="/Public/Bug/Display.html?id=121897#txn-1730754">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;01&nbsp;11:31:16&nbsp;2017</span>
    <span class="description">felipe [...] felipegasper.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #121897] REQUEST: Make bgbusy&#40;&#41; timeout adjustable?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 1 Jun 2017 11:31:00 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Felipe Gasper &lt;felipe [...] felipegasper.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1730754/930630/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/930630">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 31 May 2017, at 8:44 PM, Dick Franks via RT &lt;bug-Net-DNS@rt.cpan.org&gt; wrote:
&gt; 
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=121897">https://rt.cpan.org/Ticket/Display.html?id=121897</a></span> &gt;
&gt; 
&gt; On Wed May 31 08:42:46 2017, felipe@felipegasper.com wrote:
&gt; 
<div class="message-stanza open">&gt;&gt; … assuming that that user wants to make only one N::D::R query at a
&gt;&gt; time.
</div>&gt; 
&gt; That assumption was baked into Net::DNS long ago.
</div>
Is that a fundamental, immovable tenet? It would seem relatively straightforward to accommodate concurrent queries, though the “magic” TCP fallback complicates that.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 
<div class="message-stanza open">&gt;&gt; Consider the case of having two concurrent queries. There’s no
&gt;&gt; documented way currently to receive an event when the first of these
&gt;&gt; is available to bgread&#40;&#41;. The only way is to roll one’s own select&#40;&#41;
&gt;&gt; loop--despite the admonishments in the documentation--and hope for the
&gt;&gt; best.
&gt;&gt; 
&gt;&gt; *That* could be solved by accepting multiple handles to bgbusy&#40;&#41;,
&gt;&gt; which would seem pretty simple to implement? But, again, without being
&gt;&gt; able to specify a wait time, N::D::R is assuming that the application
&gt;&gt; has nothing better to do than to wait an arbitrary length of time for
&gt;&gt; that event.
</div>&gt; 
&gt; Out of scope for the present discussion, but willing to consider better ideas.
&gt; 
</div>
This is actually probably *more* useful to us than the adjustable timeout, but yes, it’s not the same issue.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt;&gt; Why use IO::Select in the first place, btw? Are there portability
&gt;&gt; advantages?
</div>&gt; 
&gt; As I pointed out earlier, there is other information added to the object.  Extending IO::Select is easier than writing another package from scratch.
</div>
Oh, I just meant that a raw select&#40;&#41; would be lighter, ISTM without a too-significant maintainability hit.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt;&gt;&gt; I assume you are really arguing for a zero dwell time on the
&gt;&gt;&gt; IO::Select rather than a wish to specify an arbitrary value.
</div>&gt; 
&gt; You did not answer the question:
&gt; 
&gt; Would you be happy &#40;happier?&#41; with a zero dwell time in bgbusy&#40;&#41;, assuming the tight loop objection can be overcome?
&gt; 
&gt; Yes or No?
&gt; 
</div>
It would certainly be an improvement, IMO, though I don’t see the use of allowing zero dwell exclusive of an adjustable dwell.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt;&gt; I actually hadn’t noticed that bgread&#40;&#41; includes a zero-wait select&#40;&#41;.
&gt;&gt; That seems to contradict the documentation, which speaks of a timeout?
&gt;&gt; That might be useful to document if it’s intended that people can do
&gt;&gt; bgread&#40;&#41; as a zero-wait check on the socket.
</div>&gt; 
&gt; Forget about select&#40;&#41; and zero waits, they are implementation detail.
&gt; Concentrate on the abstract object model.
&gt; 
&gt; The &#40;Resolver&#41; documentation is quite clear that if you have a handle from bgsend&#40;&#41;, then you can use bgread&#40;&#41; to obtain the response. Nowhere does it say that you need to test bgbusy&#40;&#41; first. &#40;FYI Older versions did need to test bgisready&#40;&#41;.&#41;
</div>
^^ … which is what I’d expect just going by the normal semantics of non-blocking I/O.

IMO the documentation is misleading when it describes the conditions under which undef is returned; to my sense, “no response was received” is a different state from “no response is currently available”.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 
&gt; The can_read&#40;0&#41; in _bgread&#40;&#41; is needed to decide if the bgbusy&#40;&#41; loop ended because a packet arrived or the timeout interval expired.
&gt; 
</div>
Off-topic, but: consider making the return of bgbusy&#40;&#41; indicate which condition happened?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open"><div class="message-stanza open"><div class="message-stanza open">&gt;&gt;&gt;&gt; Sorry … they’re “at least” sockets. :&#41; select&#40;&#41; works on them,
&gt;&gt;&gt;&gt; anyhow;
&gt;&gt;&gt;&gt; unfortunately, that’s the only way right now to use them with this
&gt;&gt;&gt;&gt; degree of flexibility.
</div>&gt;&gt;&gt; 
&gt;&gt;&gt; These &#34;sockets&#34; can transform themselves from UDP into TCP if a reply
&gt;&gt;&gt; packet is truncated and the query is retried automatically.  A Do-It-
&gt;&gt;&gt; Yourself select scheme will get very confused when that happens.
&gt;&gt;&gt; 
</div>&gt;&gt; 
&gt;&gt; So far we’re safe: we do a manual select&#40;&#41;, then bgbusy&#40;&#41; on the
&gt;&gt; evented handles, then bgread&#40;&#41;. It’s definitely not ideal, but it’s
&gt;&gt; the only way for now, and our application needs a more efficient path
&gt;&gt; than waiting on a single handle at a time. Obviously we’d love to use
&gt;&gt; upstream logic instead.
</div>&gt; 
&gt; It would be useful for us to know a bit of detail about what your application is trying to do.
&gt; 
</div>
The current operation is: given authoritative NSs 1.2.3.4, 2.3.4.5, and 3.4.5.6 for example.com, we want the A record for that domain as fast as it can be delivered. So we send off concurrent queries to all three NSs and wait for the first response.

Incidentally, we just started using Net::DNS::Nameserver for some automated testing, and it works like a charm. Thank you for your time and for maintaining this distribution!

-FG
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1730802" href="/Public/Bug/Display.html?id=121897#txn-1730802">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;01&nbsp;21:33:25&nbsp;2017</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1730802/930656/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/930656">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jun 01 11:31:16 2017, felipe@felipegasper.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
<div class="message-stanza open">&gt; &gt; That assumption was baked into Net::DNS long ago.
</div>&gt; 
&gt; Is that a fundamental, immovable tenet? It would seem relatively
&gt; straightforward to accommodate concurrent queries, though the “magic”
&gt; TCP fallback complicates that.
</div>
There is no problem about concurrent queries.
The problem arises from your unreasonable expectation that they might somehow share a single select&#40;&#41;, which they do not, and can not.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt; Would you be happy &#40;happier?&#41; with a zero dwell time in bgbusy&#40;&#41;,
<div class="message-stanza open">&gt; &gt; assuming the tight loop objection can be overcome?
&gt; &gt;
&gt; &gt; Yes or No?
&gt; &gt;
</div>&gt; 
&gt; It would certainly be an improvement, IMO, though I don’t see the use
&gt; of allowing zero dwell exclusive of an adjustable dwell.
</div>
Equally, I fail to see how the dwell time matters at all.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; IMO the documentation is misleading when it describes the conditions
&gt; under which undef is returned; to my sense, “no response was received”
&gt; is a different state from “no response is currently available”.
</div>
bgbusy&#40;&#41; asserts true whilst waiting for a response: &#34;busy&#34;, or false when it has arrived, or decided it never will: &#34;not busy&#34;.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Off-topic, but: consider making the return of bgbusy&#40;&#41; indicate which
&gt; condition happened?
</div>
bgbusy&#40;&#41; is a predicate, i.e. Boolean, function so there is no way it can indicate.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt;&gt; So far we’re safe: we do a manual select&#40;&#41;, then bgbusy&#40;&#41; on the
&gt; &gt;&gt; evented handles, then bgread&#40;&#41;. It’s definitely not ideal, but it’s
&gt; &gt;&gt; the only way for now, and our application needs a more efficient
&gt; &gt;&gt; path
&gt; &gt;&gt; than waiting on a single handle at a time. Obviously we’d love to
&gt; &gt;&gt; use
&gt; &gt;&gt; upstream logic instead.
</div></div>
That is the only way of servicing multiple queries using a single IO::Select

That usage is unsupported behaviour, so you must accept responsibility for making it work.

The dwell time inside bgbusy&#40;&#41; is irrelevant except in the special case of TCP retry of a truncated packet, when you have little choice except to wait for the reply.  This is so because the handles that your select&#40;&#41; identifies as ready for reading, will be &#34;not busy&#34; and drop straight through bgbusy&#40;&#41; with no delay.
 

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The current operation is: given authoritative NSs 1.2.3.4, 2.3.4.5,
&gt; and 3.4.5.6 for example.com, we want the A record for that domain as
&gt; fast as it can be delivered. So we send off concurrent queries to all
&gt; three NSs and wait for the first response.
</div>
I do not propose to tear the resolver to bits to support this very limited example of concurrence.

What I will do is use a zero dwell time inside bgbusy&#40;&#41; so that it returns immediately.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1730821" href="/Public/Bug/Display.html?id=121897#txn-1730821">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;02&nbsp;00:00:17&nbsp;2017</span>
    <span class="description">felipe [...] felipegasper.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #121897] REQUEST: Make bgbusy&#40;&#41; timeout adjustable?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 1 Jun 2017 23:59:53 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Felipe Gasper &lt;felipe [...] felipegasper.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1730821/930673/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/930673">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 1 Jun 2017, at 9:33 PM, Dick Franks via RT &lt;bug-Net-DNS@rt.cpan.org&gt; wrote:
&gt; 
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=121897">https://rt.cpan.org/Ticket/Display.html?id=121897</a></span> &gt;
&gt; 
&gt; On Thu Jun 01 11:31:16 2017, felipe@felipegasper.com wrote:
<div class="message-stanza open">&gt;&gt; 
<div class="message-stanza open">&gt;&gt;&gt; That assumption was baked into Net::DNS long ago.
</div>&gt;&gt; 
&gt;&gt; Is that a fundamental, immovable tenet? It would seem relatively
&gt;&gt; straightforward to accommodate concurrent queries, though the “magic”
&gt;&gt; TCP fallback complicates that.
</div>&gt; 
&gt; There is no problem about concurrent queries.
&gt; The problem arises from your unreasonable expectation that they might somehow share a single select&#40;&#41;, which they do not, and can not.
</div>
The igntc&#40;&#41; flag would seem to take care of the issue that the TCP auto-fallback presents?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt;&gt; IMO the documentation is misleading when it describes the conditions
&gt;&gt; under which undef is returned; to my sense, “no response was received”
&gt;&gt; is a different state from “no response is currently available”.
</div>&gt; 
&gt; bgbusy&#40;&#41; asserts true whilst waiting for a response: &#34;busy&#34;, or false when it has arrived, or decided it never will: &#34;not busy&#34;.
</div>
Sorry; I was talking about bgread&#40;&#41;. I suppose it’s not actually inaccurate as written; I just misread it.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 
<div class="message-stanza open">&gt;&gt; Off-topic, but: consider making the return of bgbusy&#40;&#41; indicate which
&gt;&gt; condition happened?
</div>&gt; 
&gt; bgbusy&#40;&#41; is a predicate, i.e. Boolean, function so there is no way it can indicate.
&gt; 
</div>
Clarification: for bgbusy&#40;&#41;, yes, but bgisready&#40;&#41; could do:

0 - not ready

1 - ready to read

2 - timeout

etc.

In a green-field context I’d suggest making the timeout an exception, but that would be pretty disruptive.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; What I will do is use a zero dwell time inside bgbusy&#40;&#41; so that it returns immediately.
&gt; 
</div>
Wouldn’t that likely break existing implementations that do:

1 while $dns-&gt;bgbusy&#40;&#41;;
my $packet = $dns-&gt;bgread&#40;&#41;;

?? Or at least make them select&#40;&#41; over and over with no delay?


I think my team’s path forward for now is to set igntc&#40;&#41; and do the TCP fallback manually.

-F
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1730902" href="/Public/Bug/Display.html?id=121897#txn-1730902">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;02&nbsp;10:20:55&nbsp;2017</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1730902/930721/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/930721">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jun 02 00:00:17 2017, felipe@felipegasper.com wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; bgbusy&#40;&#41; is a predicate, i.e. Boolean, function so there is no way it
&gt; &gt; can indicate.
&gt; &gt;
</div>&gt; 
&gt; Clarification: for bgbusy&#40;&#41;, yes, but bgisready&#40;&#41; could do:
&gt; 
&gt; 0 - not ready
&gt; 
&gt; 1 - ready to read
&gt; 
&gt; 2 - timeout
&gt; 
&gt; etc.
</div>
bgisready&#40;&#41; is the logical complement of bgbusy&#40;&#41; so it can not.


 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In a green-field context I’d suggest making the timeout an exception,
&gt; but that would be pretty disruptive.
</div>
This is not a green field, we are 20 years down the line, with thousands of users.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think my team’s path forward for now is to set igntc&#40;&#41; and do the
&gt; TCP fallback manually.
</div>
Why overcomplicate things.

Unless I misunderstood something, and all you are interested in is end-to-end speed, your situation appears to be:

The _same_ query get sent to all nameservers, which will all respond in same way, or not at all.

As the responses are all the same, the only one that matters is the first to arrive.  If the UDP packet is truncated, it can be retried  automatically by the bgbusy&#40;&#41; inside bgread&#40;&#41;.

  my $resolver = new Net::DNS::Resolver&#40; udp_timeout =&gt; 5, tcp_timeout =&gt; 20 &#41;;

  my $query = new Net::DNS::Packet&#40; $name, &#39;A&#39; &#41;;

  my $select = new IO::Select&#40;&#41;;

  foreach &#40;@nameserver&#41; {
      $resolver-&gt;nameserver&#40;$_&#41;;
      my $handle = bgsend&#40;$query&#41;;
      $select-&gt;add&#40;$handle&#41;
  }

  my @done;
  until &#40; scalar&#40; @done = $select-&gt;canread&#40;&#41; &#41; &#41; {
      do something else
  }

  my &#40; $winner, @losers &#41; = @done;
  undef $select;   # no prizes for the losers

  my $packet = $resolver-&gt;bgread&#40;$winner&#41;;    # TCP retry done transparently
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1731021" href="/Public/Bug/Display.html?id=121897#txn-1731021">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;03&nbsp;11:43:47&nbsp;2017</span>
    <span class="description">felipe [...] felipegasper.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #121897] REQUEST: Make bgbusy&#40;&#41; timeout adjustable?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 3 Jun 2017 11:43:37 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Felipe Gasper &lt;felipe [...] felipegasper.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1731021/930790/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/930790">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 2 Jun 2017, at 10:21 AM, Dick Franks via RT &lt;bug-Net-DNS@rt.cpan.org&gt; wrote:
&gt; 
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=121897">https://rt.cpan.org/Ticket/Display.html?id=121897</a></span> &gt;
&gt; 
&gt; On Fri Jun 02 00:00:17 2017, felipe@felipegasper.com wrote:
&gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt;&gt;&gt; bgbusy&#40;&#41; is a predicate, i.e. Boolean, function so there is no way it
&gt;&gt;&gt; can indicate.
&gt;&gt;&gt; 
</div>&gt;&gt; 
&gt;&gt; Clarification: for bgbusy&#40;&#41;, yes, but bgisready&#40;&#41; could do:
&gt;&gt; 
&gt;&gt; 0 - not ready
&gt;&gt; 
&gt;&gt; 1 - ready to read
&gt;&gt; 
&gt;&gt; 2 - timeout
&gt;&gt; 
&gt;&gt; etc.
</div>&gt; 
&gt; bgisready&#40;&#41; is the logical complement of bgbusy&#40;&#41; so it can not.
&gt; 
</div>
bgisready&#40;&#41; could easily handle it, and bgbusy&#40;&#41; would still be its logical complement. It wouldn’t fit the ideal of deprecating bgisready&#40;&#41;, of course, but it would still accord with the status quo documentation.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt;&gt; I think my team’s path forward for now is to set igntc&#40;&#41; and do the
&gt;&gt; TCP fallback manually.
</div>&gt; 
&gt; Why overcomplicate things.
&gt; 
</div>
I’d have to dig to figure out more, but when we used the automatic TCP fallback before an unresponsive DNS server caused our resolver code to hang.

The author of our internal code mentioned that, to his recollection, this particular resolver logic is at least half as old as Net::DNS itself, and possibly older. There’s a lot of strange stuff in there--by no means limited to the interaction with Net::DNS.

I’ve actually been playing around with a rewrite of our code and am trying it now without the bgisready&#40;&#41; as you suggest. Initial testing seems to be fine; we’ll see what comes.

Anyhow, thank you for your responses.

-FG
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1731023" href="/Public/Bug/Display.html?id=121897#txn-1731023">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;03&nbsp;12:27:56&nbsp;2017</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1731023/930792/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/930792">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 933b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Jun 03 11:43:47 2017, felipe@felipegasper.com wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; bgisready&#40;&#41; could easily handle it, and bgbusy&#40;&#41; would still be its
&gt; logical complement.
</div>
Nonsense!  bgisready&#40;&#41; is also a predicate.

bgisready&#40;x&#41; is defined as not&#40;bgbusy&#40;x&#41;&#41;

and is provided for backward compatibility.  Any rewrite should use bgbusy&#40;&#41; which name better captures the semantics.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Why overcomplicate things.
</div>&gt; 
&gt; I’d have to dig to figure out more, but when we used the automatic TCP
&gt; fallback before an unresponsive DNS server caused our resolver code to
&gt; hang.
</div>
$resolver-&gt;tcp_timeout&#40;sensible value&#41;;  # default is too large to be sensible

You will need to set a sensible udp_timeout&#40;&#41; as well.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I’ve actually been playing around with a rewrite of our code and am
&gt; trying it now without the bgisready&#40;&#41; as you suggest. Initial testing
&gt; seems to be fine; we’ll see what comes.
</div>
The delay in bgbusy&#40;&#41; will be gone in next revision.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1731026" href="/Public/Bug/Display.html?id=121897#txn-1731026">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;03&nbsp;12:38:32&nbsp;2017</span>
    <span class="description">felipe [...] felipegasper.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #121897] REQUEST: Make bgbusy&#40;&#41; timeout adjustable?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 3 Jun 2017 12:38:11 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Felipe Gasper &lt;felipe [...] felipegasper.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1731026/930795/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/930795">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 3 Jun 2017, at 12:27 PM, Dick Franks via RT &lt;bug-Net-DNS@rt.cpan.org&gt; wrote:
&gt; 
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=121897">https://rt.cpan.org/Ticket/Display.html?id=121897</a></span> &gt;
&gt; 
&gt; On Sat Jun 03 11:43:47 2017, felipe@felipegasper.com wrote:
&gt; 
<div class="message-stanza open">&gt;&gt; bgisready&#40;&#41; could easily handle it, and bgbusy&#40;&#41; would still be its
&gt;&gt; logical complement.
</div>&gt; 
&gt; Nonsense!  bgisready&#40;&#41; is also a predicate.
&gt; 
&gt; bgisready&#40;x&#41; is defined as not&#40;bgbusy&#40;x&#41;&#41;
&gt; 
&gt; and is provided for backward compatibility.  Any rewrite should use bgbusy&#40;&#41; which name better captures the semantics.
</div>
The definition of bgisready&#40;&#41; == !bgbusy&#40;&#41; seems a suboptimal one since there are more than two states to report:

- current wait timed out
- connection is ready to read
- connection timed out

bgisready&#40;&#41; can be changed without affecting current implementations. You could, I suppose, do the same with bgbusy&#40;&#41;, but multiple falsey returns seems a bit “shakier”.

In other words, you could usefully add reporting granularity by adopting this response pattern for bgisready&#40;&#41;:

undef - current wait timed out
&#39;ready&#39; - connection is ready to read
&#39;timeout&#39; - connection timed out

… or something similar.

I think the semantics of bgisready&#40;&#41; still work: it answers the question, “ready … to do what?”. The trichotomous response pattern above answers that: you either do nothing &#40;undef&#41;, you proceed &#40;&#39;ready&#39;&#41;, or you give up &#40;&#39;timeout&#39;&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt;&gt;&gt; Why overcomplicate things.
</div>&gt;&gt; 
&gt;&gt; I’d have to dig to figure out more, but when we used the automatic TCP
&gt;&gt; fallback before an unresponsive DNS server caused our resolver code to
&gt;&gt; hang.
</div>&gt; 
&gt; $resolver-&gt;tcp_timeout&#40;sensible value&#41;;  # default is too large to be sensible
&gt; 
&gt; You will need to set a sensible udp_timeout&#40;&#41; as well.
</div>
We had both, actually. Ultimately, it’s not what our team was focusing on, and I kind of lost interest in monkey-patching the current resolver code.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt;&gt; I’ve actually been playing around with a rewrite of our code and am
&gt;&gt; trying it now without the bgisready&#40;&#41; as you suggest. Initial testing
&gt;&gt; seems to be fine; we’ll see what comes.
</div>&gt; 
&gt; The delay in bgbusy&#40;&#41; will be gone in next revision.
&gt; 
</div>
Will that apply also to bgread&#40;&#41;? If so, I’d think that a big risky. FWIW.

-FG
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1731082" href="/Public/Bug/Display.html?id=121897#txn-1731082">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;04&nbsp;00:18:54&nbsp;2017</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1731082/930839/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/930839">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 466b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
I have already told you, more than once, that bgbusy&#40;&#41; and bgisready&#40;&#41; are both predicates. A predicate returns either true or false.

Changes to the API require me to be able to provide a rational and coherent argument to other interested parties. There is no point in starting that battle when it cannot be won.

I can see some merit in your complaint about the delay inside bgbusy&#40;&#41;, and will remove it.

That is the _only_ design response there is going to be.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1731949" href="/Public/Bug/Display.html?id=121897#txn-1731949">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;08&nbsp;15:45:48&nbsp;2017</span>
    <span class="description">felipe [...] felipegasper.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #121897] REQUEST: Make bgbusy&#40;&#41; timeout adjustable?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 8 Jun 2017 14:45:11 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Felipe Gasper &lt;felipe [...] felipegasper.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1731949/931300/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/931300">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 4 Jun 2017, at 12:18 AM, Dick Franks via RT &lt;bug-Net-DNS@rt.cpan.org&gt; wrote:
&gt; 
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=121897">https://rt.cpan.org/Ticket/Display.html?id=121897</a></span> &gt;
&gt; 
&gt; I have already told you, more than once, that bgbusy&#40;&#41; and bgisready&#40;&#41; are both predicates. A predicate returns either true or false.
</div>
Nothing is lost by altering the bgisready&#40;&#41;’s API as I suggest. Anything that treats bgisready&#40;&#41; as a predicate will behave the same way.

Newer code, though, can benefit from the more expressive return. It makes good semantic sense because it answers the question, “ready to do what”, which the application has to know in order to distinguish between a timeout and a ready-to-read.

In fact, status quo doesn’t seem to offer a way to distinguish between a timeout and a bad read?

------------------------
Status quo:

_do_other_stuff&#40;&#41; while bgbusy&#40;&#41;;

#Caller has to call an extra function to determine what actually happened.
#This seems suboptimal since N::DNS::R already knows that a timeout happened.
if &#40;my $packet = bgread&#40;&#41;&#41; {
    ...
}
else {
    #...and even then, I still don’t *know* based on a falsey read
    #that it was a timeout.
    die &#39;Timed out, invalid packet, or something!&#39;;
}
------------------------
With proposed change:

my $action;
_do_other_stuff&#40;&#41; until $action = bgisready&#40;&#41;;
    
#Now we can fail right away without the extra bgread&#40;&#41;.
die &#39;Timed out!&#39; if $action eq &#39;timeout&#39;;

#If we get a failure here, then we can also deal with those knowing
#that the failure is NOT a timeout.
my $packet = bgread&#40;&#41; or do &#39;Invalid packet or something!&#39;;
------------------------

One could, of course, check errorstring&#40;&#41; after the bgbusy&#40;&#41; for &#39;timed out&#39;, but the docs don’t seem to describe/guarantee that.

I do see that bgbusy&#40;&#41; does a bgread&#40;&#41; internally and caches the result, so at least it avoids an extra system call, but the apparent ambiguity between a timeout and a bad packet is still there.


-FG
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1732081" href="/Public/Bug/Display.html?id=121897#txn-1732081">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;09&nbsp;17:07:24&nbsp;2017</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1732081/931355/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/931355">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 91b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The conversation is over, design decisions made.
Your feeble argument will not change that.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1732084" href="/Public/Bug/Display.html?id=121897#txn-1732084">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;09&nbsp;17:14:22&nbsp;2017</span>
    <span class="description">felipe [...] felipegasper.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #121897] REQUEST: Make bgbusy&#40;&#41; timeout adjustable?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 9 Jun 2017 16:14:09 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Felipe Gasper &lt;felipe [...] felipegasper.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1732084/931358/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/931358">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 529b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 9 Jun 2017, at 4:07 PM, Dick Franks via RT &lt;bug-Net-DNS@rt.cpan.org&gt; wrote:
&gt; 
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=121897">https://rt.cpan.org/Ticket/Display.html?id=121897</a></span> &gt;
&gt; 
&gt; The conversation is over, design decisions made.
&gt; Your feeble argument will not change that.
</div>
This seems a cop-out; as I illustrated previously, with the code as it stands now, there is no way to distinguish substantially different states based on the responses that the API exposes currently. Casting aspersions at this point will not change it.

Anyway. It’s your code.

-FG
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1735441" href="/Public/Bug/Display.html?id=121897#txn-1735441">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;27&nbsp;05:03:24&nbsp;2017</span>
    <span class="description">NLNETLABS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1735441/933203/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/933203">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 37b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Resolver per agreed upon modification
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1735444" href="/Public/Bug/Display.html?id=121897#txn-1735444">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;27&nbsp;05:03:25&nbsp;2017</span>
    <span class="description">NLNETLABS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.954359</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
