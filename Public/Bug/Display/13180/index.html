<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #13180 for DBIx-SQLEngine: glitches with using binary &#40;bytea&#41; columns in PG driver</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #13180 for DBIx-SQLEngine: glitches with using binary &#40;bytea&#41; columns in PG driver</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBIx-SQLEngine/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBIx-SQLEngine/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBIx-SQLEngine/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBIx-SQLEngine/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBIx-SQLEngine">DBIx-SQLEngine CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">13180</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBIx-SQLEngine/Active/">DBIx-SQLEngine</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
tylerm [...] activestate.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-10710-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.93    </td>
  </tr>
  <tr id="CF-10711-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;09&nbsp;20:13:05&nbsp;2005</span>
    <span class="description">CRAKRJACK [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> glitches with using binary &#40;bytea&#41; columns in PG driver</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">When using PGSQL, SQLEngine fails to handle binary &#40;bytea&#41; columns correctly. The problem is not entirely SQLEngine&#39;s fault; a lot of it has to do with DBD::Pg itself. There has been a bit of a debate as to whether this problem is a bug, feature, or limitation in DBD::Pg; my opinion is that it is a BUG, because it&#39;s really annoying and behaves differently than every other DBD driver out there.

The problem is that binary columns have to specifically be bound as such in each SQL query in order for them to be escaped properly. The query will fail with &#34;DBD::Pg::st execute failed: ERROR:  invalid input syntax for type bytea&#34; if a binary column is changed as part of it.

The patch I have attached builds off of the patch submitted in change 13177 :

     - sql_update is now invoked with a ColumnSet object instead of an array of columns to update.

     - when this information is available, sql_update calls a new method, &#34;set_bind_param&#34; on each bound parameter, using the result of that method as the actual bound parameter.

     - in the PG driver, the set_bind_param method checks to see if we are dealing with a binary column, and if so, sets the appropriate pg_type attribute so that the DBD::Pg driver escapes the data properly.

     There may be a cleaner way of doing this, I&#39;m not sure... I tried 5 or 6 different approaches in SQLEngine and this is the one that seemed to work best with the least amount of extra code.

     Thanks,
              Tyler
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">p4 edit //depot/main/Appliance/src/pmx/cpan-packages/DBIx-SQLEngine/SQLEngine/Driver.pm
Index: SQLEngine/Driver.pm
--- SQLEngine/Driver.pm.~1~	Thu Jun  9 17:05:27 2005
+++ SQLEngine/Driver.pm	Thu Jun  9 17:05:27 2005
@@ -1622,7 +1622,11 @@
       }
     } elsif &#40; ! ref&#40;$v&#41; &#41; {
       push @v_literals, &#39;?&#39;;
-      push @v_params, $v;
+      if&#40;$c&#41; {
+          push @v_params, $self-&gt;set_bind_param&#40;$c, $v&#41;;
+      } else {
+          push @v_params, $v;
+      }
     } elsif &#40; ref&#40;$v&#41; eq &#39;SCALAR&#39; &#41; {
       push @v_literals, $$v;
     } else {
@@ -1643,6 +1647,11 @@
   return&#40; $sql, @params &#41;;
 }  
 
+sub set_bind_param {
+    my&#40;$self, $c, $v&#41; = @_;
+    return $v;
+}
+
 ########################################################################
 
 =pod
@@ -1879,14 +1888,15 @@
     if &#40; ! $columns and UNIVERSAL::isa&#40; $clauses{&#39;values&#39;}, &#39;HASH&#39; &#41; &#41; {
       $columns = $clauses{&#39;values&#39;}
     }
-    my @columns;
+    my&#40;@columns, @columnso&#41;;
     if &#40; ! $columns or $columns eq &#39;*&#39; &#41; {
       croak&#40;&#34;Column names are missing or empty&#34;&#41;;
     } elsif &#40; ! ref&#40; $columns &#41; and length&#40; $columns &#41; &#41; {
       # should be one or more comma-separated column names
       @columns = split /,\s?/, $columns;
-    } elsif &#40; UNIVERSAL::can&#40;$columns, &#39;column_names&#39;&#41; &#41; {
+    } elsif &#40; UNIVERSAL::can&#40;$columns, &#39;columns&#39;&#41; &#41; {
       @columns = $columns-&gt;column_names;
+      @columnso = $columns-&gt;columns;
     } elsif &#40; ref&#40;$columns&#41; eq &#39;HASH&#39; &#41; {
       @columns = sort keys %$columns;
     } elsif &#40; ref&#40;$columns&#41; eq &#39;ARRAY&#39; &#41; {
@@ -1911,12 +1921,19 @@
     &#40; scalar @value_args &#41; or croak&#40;&#34;Values are missing or empty&#34;&#41;;    
     my @values;
     my @v_params;
+    
     foreach my $v &#40; @value_args &#41; {
+      my $c = shift&#40;@columnso&#41;;
+
       if &#40; ! defined&#40;$v&#41; &#41; {
 	push @values, &#39;NULL&#39;;
       } elsif &#40; ! ref&#40;$v&#41; &#41; {
 	push @values, &#39;?&#39;;
-	push @v_params, $v;
+        if&#40;$c&#41; {
+            push @v_params, $self-&gt;set_bind_param&#40;$c, $v&#41;;
+        } else {
+            push @v_params, $v;
+        }
       } elsif &#40; ref&#40;$v&#41; eq &#39;SCALAR&#39; &#41; {
 	push @values, $$v;
       } else {
p4 edit //depot/main/Appliance/src/pmx/cpan-packages/DBIx-SQLEngine/SQLEngine/Driver/Pg.pm
Index: SQLEngine/Driver/Pg.pm
--- SQLEngine/Driver/Pg.pm.~1~	Thu Jun  9 17:05:27 2005
+++ SQLEngine/Driver/Pg.pm	Thu Jun  9 17:05:27 2005
@@ -129,6 +129,22 @@
   &#39;field number \d+ is out of range 0\.\.\-1&#39;,
 }
 
+sub set_bind_param {
+    my&#40;$self, $c, $v&#41; = @_;
+    
+    if&#40;$c-&gt;type eq &#39;binary&#39;&#41; {
+        if&#40;!ref&#40;$v&#41;&#41; {
+            $v = [ $v ];
+        }
+        if&#40;!UNIVERSAL::isa&#40;$v-&gt;[1], &#39;HASH&#39;&#41;&#41; {
+            $v-&gt;[1] = {};
+        }
+        $v-&gt;[1]-&gt;{pg_type} ||= DBD::Pg::PG_BYTEA;
+    }
+    
+    $v;
+}
+
 ########################################################################
 
 =head1 SEE ALSO
p4 edit //depot/main/Appliance/src/pmx/cpan-packages/DBIx-SQLEngine/SQLEngine/Schema/Table.pm
Index: SQLEngine/Schema/Table.pm
--- SQLEngine/Schema/Table.pm.~1~	Thu Jun  9 17:05:27 2005
+++ SQLEngine/Schema/Table.pm	Thu Jun  9 17:05:27 2005
@@ -470,8 +470,22 @@
 sub update_row {
   my&#40;$self, $row&#41; = @_;
   
+  my @columns_in;
+  if&#40;UNIVERSAL::can&#40;$row, &#39;field_columns&#39;&#41;&#41; {
+      @columns_in =
+          map { DBIx::SQLEngine::Schema::Column-&gt;new&#40;name =&gt; $_-&gt;{name}, type =&gt; $_-&gt;{type}&#41; } &#40;$row-&gt;field_columns&#41;;
+  } else {
+      @columns_in = $self-&gt;columns;
+  };
+    
+  my $primary = $self-&gt;column_primary_name;
+  my @columns = grep { $_-&gt;name eq $primary or defined $row-&gt;{$_-&gt;name} }
+      @columns_in;
+  
+  my $columns = DBIx::SQLEngine::Schema::ColumnSet-&gt;new&#40;@columns&#41;;
+  
   $self-&gt;sqlengine_do&#40;&#39;do_update&#39;, 
-    columns =&gt; [ $self-&gt;column_names ],
+    columns =&gt; $columns,
     where =&gt; $self-&gt;primary_criteria&#40; $row &#41;,
     values =&gt; $row,
   &#41;;
End of Patch.
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
