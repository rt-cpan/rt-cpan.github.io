<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #132772 for Net-DNS: .key files not handled correctly in TSIG.pm in version 1.24</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #132772 for Net-DNS: .key files not handled correctly in TSIG.pm in version 1.24</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Net-DNS">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Net-DNS">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Net-DNS">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Net-DNS">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-DNS">Net-DNS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">132772</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Net-DNS">Net-DNS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
wolfgang.walter [...] stwm.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22454-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22455-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.24_01    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=132772">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1901176" href="/Public/Bug/Display.html?id=132772#txn-1901176">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;06&nbsp;08:22:37&nbsp;2020</span>
    <span class="description">wolfgang.walter [...] stwm.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> .key files not handled correctly in TSIG.pm in version 1.24</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 06 Jun 2020 14:16:37 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Wolfgang Walter &lt;wolfgang.walter [...] stwm.de&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1901176/1018955/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1018955">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 833b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

after upgrading in debian from 1.23 to 1.24 I get the following error:

Use of uninitialized value $_[0] in join or string at /usr/share/perl5/Net/DNS/RR/TSIG.pm line 182.

when I call sign_tsig&#40;&#41; with a .key file.

I think the reason is that .key files are now handled as .private file due to the new code in TSIG.pm, line 384:

                 $filename =~ m/^K&#40;[^+]+&#41;\+\d+\+\d+\./;          # BIND dnssec-keygen
                my $key = $1;

                if &#40; $key &#38;&#38; $filename =~ /\.key$/ &#41; { 
  
If it is a .key file, key will usually be undefined and the code path for handling .key files wille therefore not be entered.

If I change the condition to

         if &#40; ! $key || $filename =~ /\.key$/ &#41; { 

 sign_tsig&#40;&#41; works fine again.

Regrads,
-- 
Wolfgang Walter
Studentenwerk MÃ¼nchen
Anstalt des Ã¶ffentlichen Rechts
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1902007" href="/Public/Bug/Display.html?id=132772#txn-1902007">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;12&nbsp;12:33:43&nbsp;2020</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1902007/1019272/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1019272">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Jun 06 08:22:37 2020, wolfgang.walter@stwm.de wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; after upgrading in debian from 1.23 to 1.24 I get the following error:
&gt; 
&gt; Use of uninitialized value $_[0] in join or string at
&gt; /usr/share/perl5/Net/DNS/RR/TSIG.pm line 182.
&gt; 
&gt; when I call sign_tsig&#40;&#41; with a .key file.
</div>
The recommended method of generating TSIG keys changed between 1.23 and 1.24
&#40;see perldoc Net::DNS::RR::TSIG&#41;

[Net::DNS 1.23]

    TSIG keys are symmetric keys generated using dnssec-keygen:

            $ dnssec-keygen -a HMAC-SHA1 -b 160 -n HOST &lt;keyname&gt;

            The key will be stored as a private and public keyfile pair
            K&lt;keyname&gt;+161+&lt;keyid&gt;.private and K&lt;keyname&gt;+161+&lt;keyid&gt;.key


dnssec-keygen generates a pair of files, although the secret key is the same in both.  The file names depend upon the user specified parameters and the generated key material.

The code in 1.23 relies on this convention for private keys but is lax enough to accept any file with .key suffix as a BIND public key.


[Net::DNS 1.24]

    TSIG keys are generated using the tsig-keygen utility distributed with ISC BIND:

        tsig-keygen -a HMAC-SHA256 host1-host2.example.


Observe that tsig-keygen writes the generated key material to STDOUT.

        tsig-keygen -a HMAC-SHA256 host1-host2.example.   &gt;arbitrary.key


The user is free to choose the filename which may use the .key suffix.

A dnssec-keygen public key is accepted for backward compatibility, but now needs to be distinguishable from &#34;arbitrary.key&#34;. Renaming the keyfile breaks ISC BIND&#39;s keyfile naming convention.

If you wish to use a dnssec-keygen public key with 1.24, then it is important to preserve the original filename.

 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If I change the condition to
&gt; 
&gt; if &#40; ! $key || $filename =~ /\.key$/ &#41; {
&gt; 
&gt; sign_tsig&#40;&#41; works fine again.
</div>
This is no solution at all, just moves the point of failure.
tsig-keygen key files with .key suffix now fail to parse as a dnssec-keygen public key.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1902008" href="/Public/Bug/Display.html?id=132772#txn-1902008">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;12&nbsp;12:33:44&nbsp;2020</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1902012" href="/Public/Bug/Display.html?id=132772#txn-1902012">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;12&nbsp;13:21:11&nbsp;2020</span>
    <span class="description">wolfgang.walter [...] stwm.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #132772] .key files not handled correctly in TSIG.pm in version 1.24</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 12 Jun 2020 19:21:01 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Wolfgang Walter &lt;wolfgang.walter [...] stwm.de&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1902012/1019275/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1019275">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Freitag, 12. Juni 2020, 12:33:45 schrieben Sie:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=132772">https://rt.cpan.org/Ticket/Display.html?id=132772</a></span> &gt;
&gt; 
&gt; On Sat Jun 06 08:22:37 2020, wolfgang.walter@stwm.de wrote:
<div class="message-stanza open">&gt; &gt; after upgrading in debian from 1.23 to 1.24 I get the following error:
&gt; &gt; 
&gt; &gt; Use of uninitialized value $_[0] in join or string at
&gt; &gt; /usr/share/perl5/Net/DNS/RR/TSIG.pm line 182.
&gt; &gt; 
&gt; &gt; when I call sign_tsig&#40;&#41; with a .key file.
</div>&gt; 
&gt; The recommended method of generating TSIG keys changed between 1.23 and 1.24
&gt; &#40;see perldoc Net::DNS::RR::TSIG&#41;
&gt; 
&gt; [Net::DNS 1.23]
&gt; 
&gt;     TSIG keys are symmetric keys generated using dnssec-keygen:
&gt; 
&gt;             $ dnssec-keygen -a HMAC-SHA1 -b 160 -n HOST &lt;keyname&gt;
&gt; 
&gt;             The key will be stored as a private and public keyfile pair
&gt;             K&lt;keyname&gt;+161+&lt;keyid&gt;.private and K&lt;keyname&gt;+161+&lt;keyid&gt;.key
&gt; 
&gt; 
&gt; dnssec-keygen generates a pair of files, although the secret key is the same
&gt; in both.  The file names depend upon the user specified parameters and the
&gt; generated key material.
&gt; 
&gt; The code in 1.23 relies on this convention for private keys but is lax
&gt; enough to accept any file with .key suffix as a BIND public key.
&gt; 
&gt; 
&gt; [Net::DNS 1.24]
&gt; 
&gt;     TSIG keys are generated using the tsig-keygen utility distributed with
&gt; ISC BIND:
&gt; 
&gt;         tsig-keygen -a HMAC-SHA256 host1-host2.example.
&gt; 
&gt; 
&gt; Observe that tsig-keygen writes the generated key material to STDOUT.
&gt; 
&gt;         tsig-keygen -a HMAC-SHA256 host1-host2.example.   &gt;arbitrary.key
&gt; 
</div>
I know.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; The user is free to choose the filename which may use the .key suffix.
&gt; 
&gt; A dnssec-keygen public key is accepted for backward compatibility, but now
&gt; needs to be distinguishable from &#34;arbitrary.key&#34;. Renaming the keyfile
&gt; breaks ISC BIND&#39;s keyfile naming convention.
&gt; 
&gt; If you wish to use a dnssec-keygen public key with 1.24, then it is
&gt; important to preserve the original filename.
<div class="message-stanza open">&gt; &gt; If I change the condition to
&gt; &gt; 
&gt; &gt; if &#40; ! $key || $filename =~ /\.key$/ &#41; {
&gt; &gt; 
&gt; &gt; sign_tsig&#40;&#41; works fine again.
</div>&gt; 
&gt; This is no solution at all, just moves the point of failure.
&gt; tsig-keygen key files with .key suffix now fail to parse as a dnssec-keygen
&gt; public key.
</div>
My problem is that this is a regression, that is: 1.23 and earlier behaved differently and wie rely on it.

In 1.23 and earlier a .key file could have an arbitrary name but was always parsed as as  dnssec-keyfile. So there was no need to preserve these names. Actually there is no way for me to simple rename this files because our software which uses Net::DNS relies that  it can choose the name of the file. I could easily use another ending instead of .key, but I can&#39;t go to the K....key scheme.

Another solution to keep compabiltiy coudl be to check if $secret is undef and then try to parse as dnssec-keyfile:

                require File::Spec;                             # &#40; keyfile, options &#41;
                require Net::DNS::ZoneFile;
                my $keyfile = new Net::DNS::ZoneFile&#40;$karg&#41;;
                my &#40; $vol, $dir, $filename &#41; = File::Spec-&gt;splitpath&#40; $keyfile-&gt;name &#41;;

                $filename =~ m/^K&#40;[^+]+&#41;\+\d+\+\d+\./;          # BIND dnssec-keygen
                my $key = $1;

                if &#40; $key &#38;&#38; $filename =~ /\.key$/ &#41; {
                        my $keyrr = $keyfile-&gt;read;             # BIND dnssec public key
                        croak &#39;key file incompatible with TSIG&#39; if $keyrr-&gt;type ne &#39;KEY&#39;;
                        return new Net::DNS::RR&#40;
                                name      =&gt; $keyrr-&gt;name,
                                type      =&gt; &#39;TSIG&#39;,
                                algorithm =&gt; $keyrr-&gt;algorithm,
                                key       =&gt; $keyrr-&gt;key,
                                @_
                                &#41;;
                }

                my &#40; $algorithm, $secret, $junk &#41;;
                while &#40; $keyfile-&gt;_getline &#41; {
                        $key       = $1 if /^key &#34;&#40;[^&#34;]+&#41;&#34;/;    # BIND tsig key
                        $secret    = $1 if /secret &#34;&#40;[^&#34;]+&#41;&#34;;/;
                        $algorithm = $1 if /algorithm &#40;[^;]+&#41;;/;

                        &#40; $junk, $secret &#41;    = split if /^Key:/;         # BIND dnssec private key
                        &#40; $junk, $algorithm &#41; = split if /^Algorithm:/;
                }

                if &#40;!defined&#40;$secret&#41; || !defined&#40;$algorithm&#41;&#41; {
                        my $keyrr = $keyfile-&gt;read;             # BIND dnssec public key
                        croak &#39;key file incompatible with TSIG&#39; if $keyrr-&gt;type ne &#39;KEY&#39;;
                        return new Net::DNS::RR&#40;
                                name      =&gt; $keyrr-&gt;name,
                                type      =&gt; &#39;TSIG&#39;,
                                algorithm =&gt; $keyrr-&gt;algorithm,
                                key       =&gt; $keyrr-&gt;key,
                                @_
                                &#41;;
                }

                return new Net::DNS::RR&#40;
                        name      =&gt; $key,
                        type      =&gt; &#39;TSIG&#39;,
                        algorithm =&gt; $algorithm,
                        key       =&gt; $secret,
                        @_
                        &#41;;
        }



this would probably allow upgrading from 1.23 and earlier to 1.24 and later without breaking code.


Regards,
-- 
Wolfgang Walter
Studentenwerk MÃ¼nchen
Anstalt des Ã¶ffentlichen Rechts
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1902050" href="/Public/Bug/Display.html?id=132772#txn-1902050">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;12&nbsp;20:52:39&nbsp;2020</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1902050/1019299/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1019299">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jun 12 13:21:11 2020, wolfgang.walter@stwm.de wrote:
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; My problem is that this is a regression, that is: 1.23 and earlier
&gt; behaved differently and wie rely on it.
</div>
No! You chose to exploit a laxity in the code when the documentation explicitly tells you the expected filename conventions.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In 1.23 and earlier a .key file could have an arbitrary name but was
&gt; always parsed as as  dnssec-keyfile. So there was no need to preserve
&gt; these names. Actually there is no way for me to simple rename this
&gt; files because our software which uses Net::DNS relies that  it can
&gt; choose the name of the file. I could easily use another ending instead
&gt; of .key, but I can&#39;t go to the K....key scheme.
</div>
Filename of a BIND public key is and never was a free choice.

An obvious solution is to generate your keys using tsig-keygen which allows a free choice of filename and can be read unchanged into your BIND config using $INCLUDE.

The alternative is to use a symbolic link:
   ln -s /path/to/secret/keys/Khmac-sha1.example.+161+39562.key alias.key


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Another solution to keep compabiltiy coudl be to check if $secret is
&gt; undef and then try to parse as dnssec-keyfile:
&gt;
&gt; require File::Spec;                             # &#40; keyfile, options &#41;
&gt; require Net::DNS::ZoneFile;
&gt; my $keyfile = new Net::DNS::ZoneFile&#40;$karg&#41;;
&gt; ...
&gt;8
</div>
                my &#40; $algorithm, $secret, $junk &#41;;
                while &#40; $keyfile-&gt;_getline &#41; {         ### reads entire file ###
                        $key       = $1 if /^key &#34;&#40;[^&#34;]+&#41;&#34;/;    # BIND tsig key
                        $secret    = $1 if /secret &#34;&#40;[^&#34;]+&#41;&#34;;/;
                        $algorithm = $1 if /algorithm &#40;[^;]+&#41;;/;

                        &#40; $junk, $secret &#41;    = split if /^Key:/;         # BIND dnssec private key
                        &#40; $junk, $algorithm &#41; = split if /^Algorithm:/;
                }

                if &#40; !defined&#40;$secret&#41; || !defined&#40;$algorithm&#41; &#41; {
                        my $keyrr = $keyfile-&gt;read;    ### fails here ###


This code does not work because the while loop has already exhausted the file before attempting to read the KEY RR.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; this would probably allow upgrading from 1.23 and earlier to 1.24 and
&gt; later without breaking code.
</div>
Upgrade from 1.23 to 1.24 already breaks code and no amount of rewriting can change that retrospectively.

However, this code does need to be made more robust.

Another useful improvement might be to follow symbolic links:

   ln -s /path/to/secret/keys/Khmac-sha1.example.+161+39562.private private.key
   ln -s /path/to/secret/keys/Khmac-sha1.example.+161+39562.key     public.key

This would allow the keyfiles to be distinguishable whilst also being accessed using a more convenient name.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1902239" href="/Public/Bug/Display.html?id=132772#txn-1902239">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;15&nbsp;06:26:10&nbsp;2020</span>
    <span class="description">wolfgang.walter [...] stwm.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #132772] .key files not handled correctly in TSIG.pm in version 1.24</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 15 Jun 2020 12:25:50 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Wolfgang Walter &lt;wolfgang.walter [...] stwm.de&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1902239/1019393/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1019393">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Freitag, 12. Juni 2020, 20:52:41 schrieben Sie:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=132772">https://rt.cpan.org/Ticket/Display.html?id=132772</a></span> &gt;
&gt; 
&gt; On Fri Jun 12 13:21:11 2020, wolfgang.walter@stwm.de wrote:
<div class="message-stanza open">&gt; &gt; My problem is that this is a regression, that is: 1.23 and earlier
&gt; &gt; behaved differently and wie rely on it.
</div>&gt; 
&gt; No! You chose to exploit a laxity in the code when the documentation
&gt; explicitly tells you the expected filename conventions.
<div class="message-stanza open">&gt; &gt; In 1.23 and earlier a .key file could have an arbitrary name but was
&gt; &gt; always parsed as as  dnssec-keyfile. So there was no need to preserve
&gt; &gt; these names. Actually there is no way for me to simple rename this
&gt; &gt; files because our software which uses Net::DNS relies that  it can
&gt; &gt; choose the name of the file. I could easily use another ending instead
&gt; &gt; of .key, but I can&#39;t go to the K....key scheme.
</div>&gt; 
&gt; Filename of a BIND public key is and never was a free choice.
&gt; 
</div>
dnssec-keygen does give you a certain name, thats true. But actually we do not 
use dnssec-keygen.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; An obvious solution is to generate your keys using tsig-keygen which allows
&gt; a free choice of filename and can be read unchanged into your BIND config
&gt; using $INCLUDE.
</div>
This could be done but will not work with 1.23 an earlier, or I&#39;m  missing 
something?.

What wie really do is indeed use tsig-keygen, parse it and then create a .key 
file because earlier versions of Net::DNS did not parse tsig-keygen generated 
files.

String these keys as a key file &#40;and not as a config-snippet for bind&#41; has 
other advantaged, too. You can use Net::DNS::ZoneFile to parse them, use 
database storage schemes for RRs etc.

A KEY RR is well defined and can basically be parsed by most DNS libs, whereas 
a bind conf snippet usually is 

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; The alternative is to use a symbolic link:
&gt;    ln -s /path/to/secret/keys/Khmac-sha1.example.+161+39562.key alias.key
&gt; 
</div>
This would not solve our problem. See below.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Another solution to keep compabiltiy coudl be to check if $secret is
&gt; &gt; undef and then try to parse as dnssec-keyfile:
&gt; &gt; 
&gt; &gt; require File::Spec;                             # &#40; keyfile, options &#41;
&gt; &gt; require Net::DNS::ZoneFile;
&gt; &gt; my $keyfile = new Net::DNS::ZoneFile&#40;$karg&#41;;
&gt; &gt; ...
&gt; &gt;
&gt; &gt;8
</div>&gt; 
&gt;                 my &#40; $algorithm, $secret, $junk &#41;;
&gt;                 while &#40; $keyfile-&gt;_getline &#41; {         ### reads entire file
&gt; ### $key       = $1 if /^key &#34;&#40;[^&#34;]+&#41;&#34;/;    # BIND tsig key $secret    = $1
&gt; if /secret &#34;&#40;[^&#34;]+&#41;&#34;;/;
&gt;                         $algorithm = $1 if /algorithm &#40;[^;]+&#41;;/;
&gt; 
&gt;                         &#40; $junk, $secret &#41;    = split if /^Key:/;         #
&gt; BIND dnssec private key &#40; $junk, $algorithm &#41; = split if /^Algorithm:/; }
&gt; 
&gt;                 if &#40; !defined&#40;$secret&#41; || !defined&#40;$algorithm&#41; &#41; {
&gt;                         my $keyrr = $keyfile-&gt;read;    ### fails here ###
&gt; 
&gt; 
&gt; This code does not work because the while loop has already exhausted the
&gt; file before attempting to read the KEY RR.
</div>
ok, did not test it. If it is certain to be a file one could use seek&#40;&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; this would probably allow upgrading from 1.23 and earlier to 1.24 and
&gt; &gt; later without breaking code.
</div>&gt; 
&gt; Upgrade from 1.23 to 1.24 already breaks code and no amount of rewriting can
&gt; change that retrospectively.
&gt; 
&gt; However, this code does need to be made more robust.
&gt; 
&gt; Another useful improvement might be to follow symbolic links:
&gt; 
&gt;    ln -s /path/to/secret/keys/Khmac-sha1.example.+161+39562.private
&gt; private.key ln -s /path/to/secret/keys/Khmac-sha1.example.+161+39562.key   
&gt;  public.key
</div>
We have a lot of key files in one directory. Our names consists only of the 
name of the zone this key should be used for updating that zone &#40;and not the 
name of the key itself which also contains the nameserver or algo or anything 
else&#41;, so that we can deduct the name of the file directly from the domain we 
want do update.

I probably just change our code to not call sign_tsig&#40;&#41; with a filename but 
with

        Net::DNS::ZoneFile-&gt;new&#40;&#41;-&gt;read&#40;&#41;

instead.

Regards,
-- 
Wolfgang Walter
Studentenwerk MÃ¼nchen
Anstalt des Ã¶ffentlichen Rechts
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1902274" href="/Public/Bug/Display.html?id=132772#txn-1902274">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;15&nbsp;11:47:16&nbsp;2020</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1902274/1019408/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1019408">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 780b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jun 15 06:26:10 2020, wolfgang.walter@stwm.de wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; An obvious solution is to generate your keys using tsig-keygen
</div></div> 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This could be done but will not work with 1.23 an earlier, or I&#39;m
&gt; missing something?.
</div>
You are missing the rationale for the move to tsig-keygen.
TSIG identifies the algorithm by name.
The HMAC algorithm codes used in KEY RR were assigned unilaterally by ISC for the purpose of stretching dnssec-keygen to generate TSIG keys.
These code assignments were never blessed by IANA or documented anywhere.

Key generation for any new algorithm will only be supported by tsig-keygen, without assigning a corresponding algorithm number to use in a KEY RR.
In the TSIG context, BIND dnssec-keygen has no future and this KEY RR use case will die with it.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1902739" href="/Public/Bug/Display.html?id=132772#txn-1902739">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;19&nbsp;16:16:38&nbsp;2020</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1902739/1019621/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1019621">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 286b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">1.24_01 should accept arbitrary filenames, although with a warning to remind you that the &#34;BIND public key&#34; was not generated by dnssec-keygen.
The name check is performed on the destination of a symbolic link, which will allow you to hide the ugly name from the rest of your software. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1902742" href="/Public/Bug/Display.html?id=132772#txn-1902742">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;19&nbsp;16:16:40&nbsp;2020</span>
    <span class="description">rwfranks [...] acm.org -  Fixed in 1.24_01 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1903859" href="/Public/Bug/Display.html?id=132772#txn-1903859">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;29&nbsp;10:01:49&nbsp;2020</span>
    <span class="description">NLNETLABS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1903859/1020194/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1020194">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 25b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Resolved in Net::DNS 1.25
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1903862" href="/Public/Bug/Display.html?id=132772#txn-1903862">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;29&nbsp;10:01:51&nbsp;2020</span>
    <span class="description">NLNETLABS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.538146</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
