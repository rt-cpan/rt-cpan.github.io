<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #56625 for Perl-Critic: Close filehandles as soon as possible after opening &#40;possibly false positive&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #56625 for Perl-Critic: Close filehandles as soon as possible after opening &#40;possibly false positive&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Perl-Critic/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Perl-Critic/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Perl-Critic/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Perl-Critic/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/Perl-Critic/Perl-Critic/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Perl-Critic">Perl-Critic CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">56625</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Perl-Critic/Active/">Perl-Critic</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
JARIAALTO [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-25198-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-25199-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;15&nbsp;06:55:50&nbsp;2010</span>
    <span class="description">JARIAALTO [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Close filehandles as soon as possible after opening &#40;possibly
 false positive&#41;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">MULTIPLE FALSE POSITIVES

Close filehandles as soon as possible after opening them at line 8, 
column 5. See page 209 of PBP.
3 is not one of the allowed literal values &#40;0, 1, 2&#41;. Use the Readonly 
module or the &#34;constant&#34; pragma instead at line 30, column 16. Unnamed 
numeric literals make code less maintainable.
4 is not one of the allowed literal values &#40;0, 1, 2&#41;. Use the Readonly 
module or the &#34;constant&#34; pragma instead at line 30, column 19. Unnamed 
numeric literals make code less maintainable.
5 is not one of the allowed literal values &#40;0, 1, 2&#41;. Use the Readonly 
module or the &#34;constant&#34; pragma instead at line 30, column 22. Unnamed 
numeric literals make code less maintainable.

[An excerpt, not runnable &#34;as is&#34;]

     1  #!/usr/bin/perl
     2  use strict;
     3  
     4  sub Read &#40;$&#41;
     5  {
     6      my $file = shift;
     7  
     8      open my $FH, &#34;&lt;&#34;, $file     or return;
     9  
    10      my &#40;%tabs, %div&#41;;
    11  
    12      while &#40; &lt;$FH&gt; &#41;
    13      {
    14          chomp;
    15  
    16          if &#40; /^&#40;[[:space:]]+&#41;/ &#41;
    17          {
    18              my $len = length TabToSpaces $1;
    19  
    20              $tabs{$len}++;
    21              $TABS{$len}++;
    22  
    23              if &#40; $len == 2 &#41;
    24              {
    25                  $div{2}++;
    26                  $DIV{2}++;
    27              }
    28              elsif &#40; $len &gt; 2   and   $len &lt;= $INDENT_MAX&#41;
    29              {
    30                  for my $div &#40;3, 4, 5&#41;
    31                  {
    32                      unless &#40; $len % $div &#41;
    33                      {
    34                          $div{$div}++;
    35                          $DIV{$div}++;
    36                          last;
    37                      }
    38                  }
    39              }
    40          }
    41      }
    42  
    43      close $FH  or  warn &#34;Close failure $ERRNO&#34;;
    44  
    45      if &#40; $verb == 1 &#41;
    46      {
    47          print $file, &#34;\n&#34;;
    48      }
    49      elsif &#40; $verb &gt; 1 &#41;
    50      {
    51          Print \%tabs, &#34;$file BY INDENT&#34;;
    52          Print \%div, &#34;$file BY INDENTATION LEVEL &#40;multiples 
of&#41;&#34;;
    53      }
    54  }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Create even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;15&nbsp;07:50:49&nbsp;2010</span>
    <span class="description">JARIAALTO [...] cpan.org - Ticket #56631:  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Close filehandles as soon as possible after opening them  &#40;false
 positive&#41;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">FALSE POSITIVE; close&#40;&#41; is called

Close filehandles as soon as possible after opening them at line 8, 
column 14. See page 209 of PBP.

[An excerpt, not necessarily runnable &#34;as is&#34;]


     1  #!/usr/bin/perl
     2  use strict;
     3  
     4  for my $file &#40; @files &#41;
     5  {
     6      my $FILE;
     7  
     8      unless &#40; open my $FILE, &#34;&lt;&#34;, $file &#41;
     9      {
    10          warn &#34;ERROR: cannot open&#34;;
    11          next;
    12      }
    13      else
    14      {
    15          binmode $FILE;
    16          local $INPUT_RECORD_SEPARATOR = undef;
    17          $ARG = &lt;$FILE&gt;;
    18          close $FILE   or  warn &#34;Close $file error $ERRNO&#34;;
    19      }
    20  }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;15&nbsp;09:06:21&nbsp;2010</span>
    <span class="description">perl [...] galumph.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #56625] Close filehandles as soon as possible after opening &#40;possibly  false positive&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 15 Apr 2010 08:06:05 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Perl-Critic [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Elliot Shank &lt;perl [...] galumph.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">These are all true positives.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;15&nbsp;09:06:22&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;15&nbsp;09:10:19&nbsp;2010</span>
    <span class="description">JARIAALTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Apr 15 09:06:21 2010, clonezone wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; These are all true positives.
</div>
I don&#39;t understand:

   Close filehandles as soon as possible after opening them at line 8,

The file is closed as soon as porocessed after a simple loop.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;20&nbsp;21:01:03&nbsp;2010</span>
    <span class="description">wyant [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Apr 15 09:10:19 2010, JARIAALTO wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Apr 15 09:06:21 2010, clonezone wrote:
<div class="message-stanza open">&gt; &gt; These are all true positives.
</div>&gt; 
&gt; I don&#39;t understand:
&gt; 
&gt;    Close filehandles as soon as possible after opening them at line 8,
&gt; 
&gt; The file is closed as soon as porocessed after a simple loop.
</div>
I suspect the problem is the phrase &#34;as soon as possible.&#34; This is a
Perl Best Practices policy, and I suspect the message emitted by the
policy describes better what Perl Best Practices says than how the
policy is implemented.

If you take &#34;as soon as possible&#34; to mean &#34;as soon as whatever
processing the file needs is done,&#34; the policy does not do this; in
fact, I know of no way to implement that, in any language, without being
able to read the programmer&#39;s mind.

As I think the documentation in
Perl::Critic::Policy::InputOutput::RequireBriefOpen makes clear, the
issue being addressed is potential file handle leaks. The farther the
&#34;close&#34; is away from the &#34;open&#34;, the more likely a leak becomes. You
have quite properly used lexical variables rather than Perl file handles
-- that is, &#34;my $fh; open $fh, &#39;&lt;&#39;, &#39;file&#39;&#34; rather than &#34;open FH, &#39;&lt;&#39;,
&#39;file&#39;&#34;. This helps some, but does not completely eliminate the problem.
Perhaps the violation message could say this better, but I have been
unable to come up with a one-line message I think is an improvement.

So no, the point of this policy is not to allow you 3000 statements
between an open and a close if that is what it &#34;really&#34; takes to process
the file. The point is to flag all instances where the close is more
than a certain distance away from the open. And it does this. If you do
not like what it does, you have a number of options:

* Configure the policy to allow more distance between the open and the
close.

* Annotate the open with a &#39;## no critic &#40;RequireBriefOpen&#41;&#39;, to tell
Perl::Critic to ignore this particular open.

* Hide the open in some way. The documentation gives a couple ways to do
this.

* Disable the policy if it does not do what you want.

Most of these options apply to all Perl::Critic policies. The exception
is the &#34;Configure&#34; option, since not all policies are configurable.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;20&nbsp;21:01:57&nbsp;2010</span>
    <span class="description">wyant [...] cpan.org - Ticket #56631:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">See RT 56625, same subject.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;20&nbsp;21:01:58&nbsp;2010</span>
    <span class="description">The RT System itself - Ticket #56631:  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;21&nbsp;21:05:18&nbsp;2010</span>
    <span class="description">ELLIOTJS [...] cpan.org - Ticket #56631:  Merged into ticket #56625</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;21&nbsp;21:05:18&nbsp;2010</span>
    <span class="description">ELLIOTJS [...] cpan.org -  Merged into ticket #56625</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;25&nbsp;16:48:03&nbsp;2011</span>
    <span class="description">wyant [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This ticket was kept open because of the suspicion that the second
example provided would fail even if the line constraint was met, and
with the intention of working on it at the same time as RT #64437.

Well, it appears that, if the line number constraint is met, the suspect
code is in fact compliant. So I am closing this ticket.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;25&nbsp;16:48:03&nbsp;2011</span>
    <span class="description">wyant [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
