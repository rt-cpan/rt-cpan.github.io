<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #132661 for LWP-Authen-OAuth2: Bug in  LWP::Authen::OAuth2::AccessToken  refresh code</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #132661 for LWP-Authen-OAuth2: Bug in  LWP::Authen::OAuth2::AccessToken  refresh code</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=LWP-Authen-OAuth2">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=LWP-Authen-OAuth2">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=LWP-Authen-OAuth2">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=LWP-Authen-OAuth2">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/LWP-Authen-OAuth2">LWP-Authen-OAuth2 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">132661</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=LWP-Authen-OAuth2">LWP-Authen-OAuth2</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ruud [...] us.ibm.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-250732-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-250733-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=132661">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1898911" href="/Public/Bug/Display.html?id=132661#txn-1898911">#</a>      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;20&nbsp;01:17:21&nbsp;2020</span>
    <span class="description">ruud [...] us.ibm.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Bug in  LWP::Authen::OAuth2::AccessToken  refresh code</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 20 May 2020 00:49:02 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-LWP-Authen-OAuth2&#34; &lt;bug-LWP-Authen-OAuth2 [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Ruud A Haring&#34; &lt;ruud [...] us.ibm.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1898911/1017884/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1017884">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Have been using a Perl script based on LWP::Authen::OAuth2  for a long 
time to run nightly maintenance on data we have at an external service 
provider &#40;Box.com&#41;. 
Works great -- thanks!

Once initial authentication has been set up via web browser &#40;i.e. 
manually&#41;, I use save_tokens to save off the $token_string to a file  &#40; 
oauth2_tokens &#41;. 
From that point onwards  I have been running jobs automatically &#40;cron 
jobs&#41;: each new job picks up the previous job&#39;s  $token_string from the 
file,  refreshes the tokens and saves the new $token_string off again.
With the refresh_token being valid for up to 60 days, this scheme enables 
automated nightly runs  -- but multiple jobs per night need to run 
sequentially: 1 job at a time.

With workload increasing, I  was intrigued to read  in 
<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/LWP::Authen::OAuth2">https://metacpan.org/pod/LWP::Authen::OAuth2</a></span>  about the prerefresh 
handler:
&#34;A handler to be called before attempting to refresh tokens. It is passed 
the $oauth2 object. If it returns a token string, that will be used to 
generate tokens instead of going to the service provider.
The purpose of this hook is so that, even if you have multiple processes 
accessing an API simultaneously, only one of them will try to refresh 
tokens with the service provider. 
&#40;Service providers may dislike having multiple refresh requests arrive at 
once from the same consumer for the same user.&#41;&#34;

This appears to enable token management for parallel operations of 
multiple jobs, sharing tokens as long as they are valid, and refreshing 
tokens only once for all parallel jobs, when the tokens are about to 
expire.
My scenario: 
        some long-running process A is starting with a fresh set of 
tokensA; 
        some process B can run in parallel to A,  re-using tokensA  &#40;if 
enough time before expiration&#41;; 
        some process C  starts later with not enough time before tokensA 
is about to expire. So it  refreshes the tokens to tokensC;  which 
immediately invalidates tokensA;
        process A &#40;if still running&#41; now stalls and needs to pick up the 
newest token set &#40;tokensC&#41;.

Note 1:   The documentation does not describe  that  method 
$oauth2-&gt;refresh_access_token&#40;&#41;           is required to cause a call to 
prerefresh&#40;&#41;  -- if I need that in the program&#39;s initial refresh_tokens 
operation.
         My original call:  $oauth2-&gt;request_tokens&#40; grant_type =&gt; 
&#39;refresh_token&#39;, &#39;refresh_token&#39; =&gt; $refresh_token &#41;      bypassed 
prerefresh&#40;&#41;.

Note 2: The documentation does not describe how &#40;with what parameters&#41; the 
prerefresh&#40;&#41; callback function is called
I found that the following works:
sub prerefresh { 
  my &#40; $oauth2, $token_type, $current_refresh_token &#41; = @_;    # $oauth2 
object; $token_type=&#39;refresh_token&#39;
  ...

Note 3:  If prerefresh&#40;&#41;  returns nothing,  LWP::Authen::OAuth2  executes 
the token refresh with the service provider, and everything works fine.
        However, if  prerefresh&#40;&#41;   &#40;invoked by 
$oauth2-&gt;refresh_access_token&#40;&#41; &#41;   returns the JSON  $token_string 
&#40;straight from the save_tokens file&#41; 
        then OAuth2 crashes with:
                Can&#39;t call method &#34;request&#34; on unblessed reference at 
/usr/local/share/perl5/site_perl/5.26/LWP/Authen/OAuth2.pm line 104.

        Under another scenario  &#40;$oauth2-&gt;get&#40;&#41;  on process A running into 
the above token-invalidation by another process &#41;  I got:
                Can&#39;t call method &#34;expires_in&#34; on unblessed reference at 
/usr/local/share/perl5/site_perl/5.26/LWP/Authen/OAuth2/AccessToken.pm 
line 166.

I&#39;m afraid that I can&#39;t lay my finger on  what causes this unblessed 
reference to pop up,  when  prerefresh  returns a token string.
Any suggestions appreciated.

Environment: 
        Windows 10/Cygwin   -- my debug env&#39;t  &#40;production is on AIX&#41;
        perl 5, version 26, subversion 3 &#40;v5.26.3&#41; built for 
x86_64-cygwin-threads-multi
        LWP::Authen::OAuth2 :  our $VERSION = &#39;0.16&#39;; 
        LWP::Authen::OAuth2::AccessToken:  our $VERSION = &#39;0.02&#39;;
 
Thanks so much,
Ruud.
---------------------------
Ruud A. Haring,
Principal Research Staff Member,
IBM Thomas J. Watson Research Center,
P.O. Box 218, Yorktown Heights, NY 10598, USA.
phone: +1-914-945-2856
e-mail:  ruud@us.ibm.com
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1898911/1017885/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1017885">with headers</a>
<br />
<span class="downloadcontenttype">text/html 7.3k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1899039" href="/Public/Bug/Display.html?id=132661#txn-1899039">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;21&nbsp;04:10:58&nbsp;2020</span>
    <span class="description">ruud [...] us.ibm.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re:  [rt.cpan.org #132661] AutoReply: Bug in  LWP::Authen::OAuth2::AccessToken  refresh code  -- found root cause and patch</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 21 May 2020 03:29:18 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-LWP-Authen-OAuth2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Ruud A Haring&#34; &lt;ruud [...] us.ibm.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1899039/1017947/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1017947">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 8.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,
Further observation:

OAuth2.pm line 104 is the return line of the request subroutine:
  sub request {
    my &#40;$self, $request, @rest&#41; = @_;
    return $self-&gt;access_token-&gt;request&#40;$self, $request, @rest&#41;;
  }
The error message on this line:  &#34;Can&#39;t call method &#34;request&#34; on unblessed 
reference&#34;
suggests that  $self-&gt;access_token  is no longer &#34;blessed&#34;  once an old 
existing access_token has been replaced by a new one in 
refresh_access_token /  _set_tokens.

AccessToken.pm line 166  is 
  if &#40;$self-&gt;expires_in &lt; $oauth2-&gt;access_token-&gt;expires_in&#41; {
In this case, the culprit seems to be that  $oauth2-&gt;access_token  is no 
longer &#34;blessed&#34;  once an old existing access_token has been replaced by a 
new one in  refresh_access_token / _set_tokens.
The two cases therefore come down to the same underlying issue.

Observation:
In OAuth2.pm, when an initial  $token_string is loaded via method 
load_token_string&#40;&#41;,  the critical line is  Oauth2.pm line 320:
$self-&gt;{access_token} = $class-&gt;from_ref&#40;$tokens&#41;;
where the from_ref&#40; &#41;  function &#40;in AccessToken.pm&#41;  actually blesses the 
$tokens hash references as being part of the 
LWP::Authen::OAuth2::AccessToken::Bearer class
Also if  prerefresh does not return anything &#40;i.e. forces a refresh&#41;, 
refresh_access_token  branches to  ServiceProvider-&gt;refreshed_tokens, 
which also &#40;in construct_tokens&#41; does a &#34;from_ref&#34;  &#40;ServiceProvider.pm 
line 290&#41;.
In  the branch at fault,  no such  &#34;from_ref&#34;  blessing occurs.   I 
believe it should be inserted around OAuth2.pm line 221.

More generally, it seems to me that the checks in load_token_string should 
also be applied to the possibly new token_string being returned from the 
prerefresh handler -- as that is a user function.

Thus, my suggestion is to replace Oauth2.pm  lines 219-221 with the 
following:

                if &#40;$data and not $@&#41; {
                    # Assume I got it.
                    # ----- Ruud 2020/05/21 insert &#40;copied from 
load_token_string&#41;  -------
                    my $class = $data-&gt;{_class} or croak&#40;&#34;No _class in 
token_string &#39;$tokens&#39;&#34;&#41;;

                    eval {load&#40;$class&#41;};
                    if &#40;$@&#41; { croak&#40;&#34;Can&#39;t load access token class 
&#39;$class&#39;: $@&#34;&#41;; }

                    # Necessary: $class-&gt;from_ref blesses the new tokens 
as part of a class &#40;e.g. LWP::Authen::OAuth2::AccessToken::Bearer&#41;
                    $tokens = $class-&gt;from_ref&#40;$data&#41;;
                     # ----- Ruud 2020/05/21 end of insert -------

#                  $tokens = $data;       # Ruud 2020/05/21 commented out, 
replaced by above lines

I stepped through this in the debugger and it looks good -- it now also 
passes my testcases.
I thereby look forward to running parallel jobs, using a single set of 
tokens, that is refreshed only as needed, with all the running jobs taking 
on the refreshed tokens.
Respectfully submitting the above as a patch to OAuth2.pm.

Thanks,
Ruud.
---------------------------
Ruud A. Haring,




From:   &#34;Bugs in LWP-Authen-OAuth2 via RT&#34; 
&lt;bug-LWP-Authen-OAuth2@rt.cpan.org&gt;
To:     ruud@us.ibm.com
Date:   05/20/2020 01:17
Subject:        [EXTERNAL] [rt.cpan.org #132661] AutoReply: Bug in 
LWP::Authen::OAuth2::AccessToken  refresh code




Greetings,

This message has been automatically generated in response to the
creation of a trouble ticket regarding:
                 &#34;Bug in  LWP::Authen::OAuth2::AccessToken  refresh code&#34;, 

a summary of which appears below.

There is no need to reply to this message right now.  Your ticket has been
assigned an ID of [rt.cpan.org #132661].  Your ticket is accessible
on the web at:

    
<span class="clickylink"><a target="new" rel="nofollow" href="https://urldefense.proofpoint.com/v2/url?u=https-3A__rt.cpan.org_Ticket_Display.html-3Fid-3D132661&#38;d=DwIDaQ&#38;c=jf_iaSHvJObTbx-siA1ZOg&#38;r=boUvkdeRe-_ytBHkjH2S7g&#38;m=wz5_GQK5Q5pdx-vwFawphOqQZaTFRYXxaON8KAWPdx0&#38;s=dQXX0-DfHnA7Q1GH8JkNOGQ-wYM3bohPJuZYZYUHcks&#38;e=">https://urldefense.proofpoint.com/v2/url?u=https-3A__rt.cpan.org_Ticket_Display.html-3Fid-3D132661&#38;d=DwIDaQ&#38;c=jf_iaSHvJObTbx-siA1ZOg&#38;r=boUvkdeRe-_ytBHkjH2S7g&#38;m=wz5_GQK5Q5pdx-vwFawphOqQZaTFRYXxaON8KAWPdx0&#38;s=dQXX0-DfHnA7Q1GH8JkNOGQ-wYM3bohPJuZYZYUHcks&#38;e=</a></span> 


Please include the string:

         [rt.cpan.org #132661]

in the subject line of all future correspondence about this issue. To do 
so, 
you may reply to this message.

                        Thank you,
                        bug-LWP-Authen-OAuth2@rt.cpan.org

-------------------------------------------------------------------------
Hi,

Have been using a Perl script based on LWP::Authen::OAuth2  for a long 
time to run nightly maintenance on data we have at an external service 
provider &#40;Box.com&#41;. 
Works great -- thanks!

Once initial authentication has been set up via web browser &#40;i.e. 
manually&#41;, I use save_tokens to save off the $token_string to a file  &#40; 
oauth2_tokens &#41;. 
From that point onwards  I have been running jobs automatically &#40;cron 
jobs&#41;: each new job picks up the previous job&#39;s  $token_string from the 
file,  refreshes the tokens and saves the new $token_string off again.
With the refresh_token being valid for up to 60 days, this scheme enables 
automated nightly runs  -- but multiple jobs per night need to run 
sequentially: 1 job at a time.

With workload increasing, I  was intrigued to read  in 
<span class="clickylink"><a target="new" rel="nofollow" href="https://urldefense.proofpoint.com/v2/url?u=https-3A__metacpan.org_pod_LWP-3A-3AAuthen-3A-3AOAuth2&#38;d=DwIDaQ&#38;c=jf_iaSHvJObTbx-siA1ZOg&#38;r=boUvkdeRe-_ytBHkjH2S7g&#38;m=wz5_GQK5Q5pdx-vwFawphOqQZaTFRYXxaON8KAWPdx0&#38;s=xL74G-rDm6KDKVjlomeN7rVyqD3FduC-xVF4DZTmod8&#38;e=">https://urldefense.proofpoint.com/v2/url?u=https-3A__metacpan.org_pod_LWP-3A-3AAuthen-3A-3AOAuth2&#38;d=DwIDaQ&#38;c=jf_iaSHvJObTbx-siA1ZOg&#38;r=boUvkdeRe-_ytBHkjH2S7g&#38;m=wz5_GQK5Q5pdx-vwFawphOqQZaTFRYXxaON8KAWPdx0&#38;s=xL74G-rDm6KDKVjlomeN7rVyqD3FduC-xVF4DZTmod8&#38;e=</a></span> 
  about the prerefresh 
handler:
&#34;A handler to be called before attempting to refresh tokens. It is passed 
the $oauth2 object. If it returns a token string, that will be used to 
generate tokens instead of going to the service provider.
The purpose of this hook is so that, even if you have multiple processes 
accessing an API simultaneously, only one of them will try to refresh 
tokens with the service provider. 
&#40;Service providers may dislike having multiple refresh requests arrive at 
once from the same consumer for the same user.&#41;&#34;

This appears to enable token management for parallel operations of 
multiple jobs, sharing tokens as long as they are valid, and refreshing 
tokens only once for all parallel jobs, when the tokens are about to 
expire.
My scenario: 
        some long-running process A is starting with a fresh set of 
tokensA; 
        some process B can run in parallel to A,  re-using tokensA  &#40;if 
enough time before expiration&#41;; 
        some process C  starts later with not enough time before tokensA 
is about to expire. So it  refreshes the tokens to tokensC;  which 
immediately invalidates tokensA;
        process A &#40;if still running&#41; now stalls and needs to pick up the 
newest token set &#40;tokensC&#41;.

Note 1:   The documentation does not describe  that  method 
$oauth2-&gt;refresh_access_token&#40;&#41;           is required to cause a call to 
prerefresh&#40;&#41;  -- if I need that in the program&#39;s initial refresh_tokens 
operation.
         My original call:  $oauth2-&gt;request_tokens&#40; grant_type =&gt; 
&#39;refresh_token&#39;, &#39;refresh_token&#39; =&gt; $refresh_token &#41;      bypassed 
prerefresh&#40;&#41;.

Note 2: The documentation does not describe how &#40;with what parameters&#41; the 

prerefresh&#40;&#41; callback function is called
I found that the following works:
sub prerefresh { 
  my &#40; $oauth2, $token_type, $current_refresh_token &#41; = @_;    # $oauth2 
object; $token_type=&#39;refresh_token&#39;
  ...

Note 3:  If prerefresh&#40;&#41;  returns nothing,  LWP::Authen::OAuth2  executes 
the token refresh with the service provider, and everything works fine.
        However, if  prerefresh&#40;&#41;   &#40;invoked by 
$oauth2-&gt;refresh_access_token&#40;&#41; &#41;   returns the JSON  $token_string 
&#40;straight from the save_tokens file&#41; 
        then OAuth2 crashes with:
                Can&#39;t call method &#34;request&#34; on unblessed reference at 
/usr/local/share/perl5/site_perl/5.26/LWP/Authen/OAuth2.pm line 104.

        Under another scenario  &#40;$oauth2-&gt;get&#40;&#41;  on process A running into 

the above token-invalidation by another process &#41;  I got:
                Can&#39;t call method &#34;expires_in&#34; on unblessed reference at 
/usr/local/share/perl5/site_perl/5.26/LWP/Authen/OAuth2/AccessToken.pm 
line 166.

I&#39;m afraid that I can&#39;t lay my finger on  what causes this unblessed 
reference to pop up,  when  prerefresh  returns a token string.
Any suggestions appreciated.

Environment: 
        Windows 10/Cygwin   -- my debug env&#39;t  &#40;production is on AIX&#41;
        perl 5, version 26, subversion 3 &#40;v5.26.3&#41; built for 
x86_64-cygwin-threads-multi
        LWP::Authen::OAuth2 :  our $VERSION = &#39;0.16&#39;; 
        LWP::Authen::OAuth2::AccessToken:  our $VERSION = &#39;0.02&#39;;
 
Thanks so much,
Ruud.
---------------------------
Ruud A. Haring,
Principal Research Staff Member,
IBM Thomas J. Watson Research Center,
P.O. Box 218, Yorktown Heights, NY 10598, USA.
phone: +1-914-945-2856
e-mail:  ruud@us.ibm.com
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1899039/1017948/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1017948">with headers</a>
<br />
<span class="downloadcontenttype">text/html 13.3k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1920221" href="/Public/Bug/Display.html?id=132661#txn-1920221">#</a>      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;22&nbsp;11:48:29&nbsp;2020</span>
    <span class="description">domm [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1920221/1028224/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1028224">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 508b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry for the long wait! And thanks for the excellent bug report and the patch!

I have now &#40;after some review&#41; applied your patch. A new version &#40;including a few other minor improvements&#41; is now on it&#39;s way to CPAN as version 0.17.

To be honest, I&#39;m currently not using the module in the way you are using it, so I&#39;m grateful for you also providing a patch - but please be advised that I did not actually tried your changes on a live service provider!

Anyway, thanks for the contribution!

Greetings,
domm
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1920222" href="/Public/Bug/Display.html?id=132661#txn-1920222">#</a>      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;22&nbsp;11:48:29&nbsp;2020</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1920225" href="/Public/Bug/Display.html?id=132661#txn-1920225">#</a>      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;22&nbsp;11:48:30&nbsp;2020</span>
    <span class="description">domm [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1920546" href="/Public/Bug/Display.html?id=132661#txn-1920546">#</a>      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;24&nbsp;12:54:59&nbsp;2020</span>
    <span class="description">ruud [...] us.ibm.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re:  [rt.cpan.org #132661] Bug in  LWP::Authen::OAuth2::AccessToken  refresh code</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 24 Nov 2020 12:29:43 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-LWP-Authen-OAuth2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Ruud A Haring&#34; &lt;ruud [...] us.ibm.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1920546/1028377/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1028377">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 54b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thomas,

Thanks -- v0.17  works fine for me.

Ruud.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1920546/1028378/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1028378">with headers</a>
<br />
<span class="downloadcontenttype">text/html 256b</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.437196</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
