<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #125472 for Tcl: error with coderefs passes as scalar args </title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #125472 for Tcl: error with coderefs passes as scalar args </h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Tcl">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Tcl">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Tcl">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Tcl">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Tcl">Tcl CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">125472</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Tcl">Tcl</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
huck [...] finn.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-30776-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-30777-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




c-set1.06.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1793502/964589/c-set1.06.patch">
Thu Jun 28 18:45:44 2018 (9.8k) by huck [...] finn.com
</a>
</font></li>
</ul>


code-disposal-fix-v1.05.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1791081/963304/code-disposal-fix-v1.05.patch">
Fri Jun 15 00:14:52 2018 (38.5k) by huck [...] finn.com
</a>
</font></li>
</ul>


memloss1.02.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1791081/963305/memloss1.02.patch">
Fri Jun 15 00:14:52 2018 (3.5k) by huck [...] finn.com
</a>
</font></li>
</ul>


Tkx_error_report.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1792538/964058/Tkx_error_report.txt">
Sat Jun 23 22:20:17 2018 (1.4k) by sjaluo [...] gmail.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=125472">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1789142" href="/Public/Bug/Display.html?id=125472#txn-1789142">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;04&nbsp;02:53:31&nbsp;2018</span>
    <span class="description">huck [...] finn.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> error with coderefs passes as scalar args </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 04 Jun 2018 01:47:34 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> huck &lt;huck [...] finn.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1789142/962264/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/962264">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Distribution name and version  Tcl-1.05
Perl version/Os
   perl 5, version 18, subversion 2 &#40;v5.18.2&#41; built for 
i686-linux-gnu-thread-multi-64int
     Linux O170Ltemp 3.13.0-142-generic #191-Ubuntu SMP Fri Feb 2 
12:14:37 UTC 2018 i686 i686 i686 GNU/Linux
     ubuntu 14.04
   perl 5, version 26, subversion 1 &#40;v5.26.1&#41; built for 
i686-linux-gnu-thread-multi-64int
     Linux gx620-gw 4.15.0-20-generic #21-Ubuntu SMP Tue Apr 24 
06:15:38 UTC 2018 i686 i686 i686 GNU/Linux
     ubuntu 18.04
    perl 5, version 22, subversion 1 &#40;v5.22.1&#41; built for 
i686-linux-gnu-thread-multi-64int
     Linux ube520 4.4.0-124-generic #148-Ubuntu SMP Wed May 2 
13:01:51 UTC 2018 i686 i686 i686 GNU/Linux
       ubuntu 16.04



More history at <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perlmonks.org/?node_id=1215721">http://www.perlmonks.org/?node_id=1215721</a></span>

I had a problem where i got an error box in my Tkx program that said
invalid command name &#34;::perl::CODE&#40;0x96f045c&#41;&#34;
and it didnt execute my Tkx::after command

As mentioned in the perlmonks post i tracked it down to how Tcl.pm 
deals with  CODE refs via $anon_refs 
and  CreateCommand/DeleteCommand  in create_tcl_sub. and Tcl::Code::DESTROY

I think i fixed it. Follows is the diff at version 1.05
384a385
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt; use Scalar::Util qw&#40;weaken&#41;;
</div>560a562,567
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt; # this kills the weakened tclname ref leaveng the strong current_r 
</div>ref &#40;like before&#41;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt;
 &gt;     if &#40;exists&#40;$anon_refs{$current_r}&#41;&#41;{
 &gt;       anon_kill&#40;$anon_refs{$current_r}[2]&#41;;
 &gt;       }
 &gt;
</div>594a602,607
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt; # kill an anon_refs name
 &gt; sub anon_kill {
 &gt;   my $anonname=shift;
 &gt;   delete $anon_refs{$anonname};
 &gt;   }
 &gt;
</div>618c631,639
&lt;     $anon_refs{$rname} = bless [\$sub, $interp], &#39;Tcl::Code&#39;;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt; #    $anon_refs{$rname} = bless [\$sub, $interp], &#39;Tcl::Code&#39;;
 &gt;     my $isnew=0;
 &gt;     unless &#40;exists $anon_refs{$tclname}&#41; {
 &gt;       $anon_refs{$tclname} = bless [\$sub, $interp, $tclname], &#39;Tcl::Code&#39;;
 &gt;       $isnew=1;
 &gt;       }
 &gt;     $anon_refs{$rname} = $anon_refs{$tclname};
 &gt;     weaken&#40;$anon_refs{$tclname}&#41; if &#40;$isnew&#41;;
 &gt;
</div>652a674
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt;     my $anonname = $_[0]-&gt;[2];
</div>655a678
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt;     Tcl::anon_kill&#40;$anonname&#41;;
</div>
at the perlmonks link there are two failing Tkx sample programs  one 
at the top, and another near the bottom. Enclosed below is a more 
simple failure

Thank you for all you do for us!

#### Example Tcl failure program : ####

cat tcl-fail.pl
   use strict; use warnings;
   use Tcl;

my $inter=Tcl-&gt;new&#40;&#41;;
my @queue;
for my $ii &#40;1..10&#41; {push @queue,$ii.&#39; &#39;.&#39;-&#39;x10; }
my $sub;

$sub=sub{
   return unless &#40;scalar&#40;@queue&#41;&#41;;
   my $line =shift @queue;
   print $line.&#34;\n&#34;;
   return unless &#40;scalar&#40;@queue&#41;&#41;;
   $inter-&gt;call&#40;&#39;after&#39;,200,$sub&#41;;
};
$inter-&gt;call&#40;&#39;after&#39;,200,$sub&#41;;


$inter-&gt;icall&#40;&#39;after&#39;, 3000, &#39;set var fafafa&#39;&#41;;
$inter-&gt;icall&#40;&#39;vwait&#39;, &#39;var&#39;&#41;; # will wait for 3 seconds
exit;

##### example failing: #####

perl tcl-fail.pl
1 ----------
2 ----------
3 ----------
4 ----------
5 ----------
invalid command name &#34;::perl::CODE&#40;0x12a7c58&#41;&#34;
     while executing
&#34;::perl::CODE&#40;0x12a7c58&#41;&#34;
     &#40;&#34;after&#34; script&#41;

#### example after patch above #####
perl tcl-fail.pl
1 ----------
2 ----------
3 ----------
4 ----------
5 ----------
6 ----------
7 ----------
8 ----------
9 ----------
10 ----------
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1789146" href="/Public/Bug/Display.html?id=125472#txn-1789146">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;04&nbsp;03:37:45&nbsp;2018</span>
    <span class="description">huck [...] finn.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #125472]  error with coderefs passes as scalar args</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 04 Jun 2018 02:37:27 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> huck &lt;huck [...] finn.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1789146/962267/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/962267">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">heh , &#34;Show quoted text &#34;, hope this is better

diff -u1  /usr/local/lib/perl/5.18.2/Tcl.pm.bak 
/usr/local/lib/perl/5.18.2/Tcl.pm
--- /usr/local/lib/perl/5.18.2/Tcl.pm.bak       2016-06-28 
12:02:41.000000000 -0500
+++ /usr/local/lib/perl/5.18.2/Tcl.pm   2018-06-04 01:00:28.974837103 -0500
@@ -384,2 +384,3 @@
  use strict;
+use Scalar::Util qw&#40;weaken&#41;;

@@ -560,2 +561,8 @@
      }
+# this kills the weakened tclname ref leaveng the strong current_r 
ref &#40;like before&#41;
+
+    if &#40;exists&#40;$anon_refs{$current_r}&#41;&#41;{
+      anon_kill&#40;$anon_refs{$current_r}[2]&#41;;
+      }
+

@@ -594,2 +601,8 @@

+# kill an anon_refs name
+sub anon_kill {
+  my $anonname=shift;
+  delete $anon_refs{$anonname};
+  }
+
  # create_tcl_sub will create TCL sub that will invoke perl CODE ref
@@ -617,3 +630,11 @@
      # Tcl::Code::DESTROY
-    $anon_refs{$rname} = bless [\$sub, $interp], &#39;Tcl::Code&#39;;
+#    $anon_refs{$rname} = bless [\$sub, $interp], &#39;Tcl::Code&#39;;
+    my $isnew=0;
+    unless &#40;exists $anon_refs{$tclname}&#41; {
+      $anon_refs{$tclname} = bless [\$sub, $interp, $tclname], &#39;Tcl::Code&#39;;
+      $isnew=1;
+      }
+    $anon_refs{$rname} = $anon_refs{$tclname};
+    weaken&#40;$anon_refs{$tclname}&#41; if &#40;$isnew&#41;;
+

@@ -652,2 +673,3 @@
      my $interp = $_[0]-&gt;[1];
+    my $anonname = $_[0]-&gt;[2];
      my $tclname = &#34;::perl::$$rsub&#34;;
@@ -655,2 +677,3 @@
      $interp-&gt;DeleteCommand&#40;$tclname&#41; if defined $interp;
+    Tcl::anon_kill&#40;$anonname&#41;;
  }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1789179" href="/Public/Bug/Display.html?id=125472#txn-1789179">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;04&nbsp;12:44:33&nbsp;2018</span>
    <span class="description">huck [...] finn.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #125472] error with coderefs passes as scalar args &#40;patch explanation&#41; </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 04 Jun 2018 11:42:05 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> huck &lt;huck [...] finn.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1789179/962282/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/962282">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Since for some reason i felt a ned to describe the mechanisms behind 
my patch on perlmonks  <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perlmonks.org/?node_id=1215859">http://www.perlmonks.org/?node_id=1215859</a></span> i 
thought i would include it here too

This issue is only related to after, and involves code modified in 
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/gisle/tcl.pm/commit/7cb5f5d40ca335a046394de7ef01c528356dc624#diff-ee07373df0b8077358fdb27ea461c8f9">https://github.com/gisle/tcl.pm/commit/7cb5f5d40ca335a046394de7ef01c528356dc624#diff-ee07373df0b8077358fdb27ea461c8f9</a></span> 
&#40;code disposal works, only 1 question remains; perl::Eval now in 
Tcl__new &#41; and added in the version 1.03 release as of 2016-02-20 
<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/changes/release/VKON/Tcl-1.05">https://metacpan.org/changes/release/VKON/Tcl-1.05</a></span> . I suspect 
someone &#40;vadrer?&#41; saw that the commands-table/$anon_refs were filling 
up with address to single use anon-subrefs from the &#34;after 
command&#34;  and wanted to clean them up. His approach while admirable 
hosed calls where the subref passed into after was not a single use 
anon-subref &#40;or of the [$coderef] variety, since those generated a 
single use anon coderef too&#41; because it prematurely discarded them 
from the Commands-table/$anon_refs.

While i have faith in my patch, and think it will solve the 
introduced problem while retaining the needed &#34;code disposal&#34;, 
patching code is never as simple as it looks. What it does is 
introduce a &#34;weakened&#34; version of the coderef in the anon_refs table 
under the $tclname key it used to have pre v1.03 and copies that 
entry into a &#34;strong&#34; newer $current_r style name when needed, so it 
can be used in the &#34;consolidated&#34; $anon_refs that get scheduled for 
deletion. Now further &#34;after&#34;  calls will be able to create their own 
consolidated entries for deletion but since the refcount will be 
greater than one for a &#34;static&#34; coderef since there will be multiple 
copies in multiple &#34;consolidated&#34; $anon_refs,  when _code_disposal is 
called the Tcl::Code::DESTROY that purges that entry from the command 
table wont be invoked until the last consolidated $anon_refs entry 
has been destroyed.

Since code disposal is only invoked on &#34;after&#34; calls, for non-after 
calls i dispose of the weakened $tclname key right away, and those 
coderefs continue to live in the commands-table/$anon_refs &#34;forever&#34;, 
just like they used to pre v1.03 and still currently do.

Again thanks for all you do for us!!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1789958" href="/Public/Bug/Display.html?id=125472#txn-1789958">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;08&nbsp;11:16:24&nbsp;2018</span>
    <span class="description">VKON [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1789958/962681/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/962681">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 321b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">TYVM! 
will apply it today, together with other your addition;
please be aware of 1, tcltk at perl.org is mailing list for the module, where you can discuss all such findings; and 2, <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/gisle/tcl.pm">https://github.com/gisle/tcl.pm</a></span> is a repository, where you preferably send your commits; &#40;not necessarily, I&#39;ll accept your change anyway&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1789959" href="/Public/Bug/Display.html?id=125472#txn-1789959">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;08&nbsp;11:16:24&nbsp;2018</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1789967" href="/Public/Bug/Display.html?id=125472#txn-1789967">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;08&nbsp;12:49:22&nbsp;2018</span>
    <span class="description">huck [...] finn.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #125472] error with coderefs passes as scalar args</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 08 Jun 2018 11:48:53 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> huck &lt;huck [...] finn.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1789967/962693/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/962693">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 696b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">If it is not too late you may want to hold off for a touch. I have 
discovered two more issues that i am currently dealing with as well 
and will get back to the list asap with a resolution.

both involve garbage collection of the coderef and increasing PVSV refcounts.


At 10:16 AM 6/8/2018, you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125472">https://rt.cpan.org/Ticket/Display.html?id=125472</a></span> &gt;
&gt;
&gt;TYVM!
&gt;will apply it today, together with other your addition;
&gt;please be aware of 1, tcltk at perl.org is mailing list for the 
&gt;module, where you can discuss all such findings; and 2, 
&gt;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/gisle/tcl.pm">https://github.com/gisle/tcl.pm</a></span> is a repository, where you 
&gt;preferably send your commits; &#40;not necessarily, I&#39;ll accept your change anyway&#41;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1791081" href="/Public/Bug/Display.html?id=125472#txn-1791081">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;15&nbsp;00:14:52&nbsp;2018</span>
    <span class="description">huck [...] finn.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #125472]  error with coderefs passed as scalar args</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 14 Jun 2018 23:14:34 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> huck &lt;huck [...] finn.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1791081/963303/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/963303">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ok I think im ready to have a go at this.

enclosed is e patch files,
code-disposal-fix-v1.05.patch fixes this issue

it was generated by
git format-patch  --stdout  -1 &gt; 
~/cvs/pmlib-linkpatch/code-disposal-fix-v1.05.patch

and i am able to apply it by
git am ~/cvs/pmlib-linkpatch/code-disposal-fix-v1.05.patch


Like i said im new at git, so the second file 
memloss1.02.patch  &#40;which is for 
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=125577">https://rt.cpan.org/Public/Bug/Display.html?id=125577</a></span> &#41; is enclosed 
so you can see the way i did it, and the pretty lines i added

lets assume those files are in the dir  ~/cvs/pmlib-linkpatch
and  there is a dir at ~/cvs/gits/github

so you run

cd ~/cvs/gits/github
rm -rf  ~/cvs/gits/github/test-tcl
git clone <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/gisle/tcl.pm.git">https://github.com/gisle/tcl.pm.git</a></span> test-tcl -v
cd ~/cvs/gits/github/test-tcl

git checkout master
git tag -a 1.02  3f5eb527e1ba3b883c2ba197e4bdaf28d940f389 -m &#34;Release 1.02&#34;
git tag -a 1.05  333cc79bb194c7007f08060a2e872789d4604217 -m &#34;Release 1.05&#34;
git tag -a last  94ead33b9a30f18954bbb8168343554c1ea3c20c -m &#39;last i know&#39;

git checkout -b memloss1.02 1.02
git am ~/cvs/pmlib-linkpatch/memloss1.02.patch

now if you use gitk you see your at v1.02 with the patch applied and 
you can see that it works at v1.02

perl Makefile.PL
make
make test

notice it didnt run  t/disposal-subs.t, it didnt exist then, so you go on

git checkout master
git merge -m &#39;RT 125577 Tcl.xs memory leak fix&#39; memloss1.02

perl Makefile.PL
make
make test

and you see it works at the current master , and runs 
t/disposal-subs.t, cuz its current NOW , so you go on

git checkout -b code-disposal-fix-v1.05 last
git am ~/cvs/pmlib-linkpatch/code-disposal-fix-v1.05.patch

perl Makefile.PL
make
make test

and see it works patched to my base , notice it doesnt run 
t/memleak-a.t because it didnt exist on this branch yet,  but it ran 
all the disposal* tests, . so you go on

git checkout master
git merge -m &#39;RT 125472 Tcl.pm code disposal updates&#39; code-disposal-fix-v1.05

perl Makefile.PL
make
make test

Notice it ran all the disposal* and memlean* tests, its up to date!!
Now run gitk to see the funny squigly lines in many colors, that 
shows how this all went down

now what surprised me was that if you run

cd ~/cvs/gits/github
rm -rf  ~/cvs/gits/github/strp-tcl
git clone <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/gisle/tcl.pm.git">https://github.com/gisle/tcl.pm.git</a></span> strp-tcl
cd ~/cvs/gits/github/strp-tcl
git tag -a 1.02  3f5eb527e1ba3b883c2ba197e4bdaf28d940f389 -m &#34;Release 1.02&#34;
git tag -a 1.05  333cc79bb194c7007f08060a2e872789d4604217 -m &#34;Release 1.05&#34;
git checkout master
git am ~/cvs/pmlib-linkpatch/memloss1.02.patch
git am ~/cvs/pmlib-linkpatch/code-disposal-fix-v1.05.patch

diff Tcl.pm ~/cvs/gits/github/test-tcl/Tcl.pm
diff Tcl.xs ~/cvs/gits/github/test-tcl/Tcl.xs

notice that the diffs are empty, yet in gitk the branching is much 
cleaner. so probably just running the 2 git am commands is fine, why, 
i-dunno, git has some deep magic to it in those patch files i dont grok yet.

i went a while getting the git-am calls to make the pretty lines i 
wanted to be sure it was doing what i wanted. I got scared when i saw 
it all in one line like that. but i am happy now that both methods 
produce the same result, just less pretty lines.

I also spent too much time chasing whitespace errors, git-am didnt 
like them.  That changed some lines that i didnt even put in, not a lot.

Probably spent too much time on the pod and making things pretty too, eh.

It works how i think it should work,  The code disposal routines seem 
to work ok, see the t/disposal-* tests for some comments about the 
problems i faced.  If you can still bust it id like to know.

A lot of the fix is additions to the pod, i hope that was ok too.

This started when a Tkx program i had didnt work under 1.05,  i made 
a stripped down version of it to get at the issue. Both used a lot of 
after commands for timeouts, keepalives, and sending data with a 
delay. They didnt like 1.05. now with these patches they are working 
again, and even better than before!

I hope this didnt cause new problems, but if it has, let me know and 
ill look into it more.

Again thanks for what you do and for putting up with me.

**Probably spent too much time getting to know git,  but now that i 
know more i think its worth it, its kinda slick. 
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1791081/963304/code-disposal-fix-v1.05.patch">Download code-disposal-fix-v1.05.patch</a><br />
<span class="downloadcontenttype">text/x-diff 38.5k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1791081/963305/memloss1.02.patch">Download memloss1.02.patch</a><br />
<span class="downloadcontenttype">text/x-diff 3.5k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1791231" href="/Public/Bug/Display.html?id=125472#txn-1791231">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;15&nbsp;16:53:51&nbsp;2018</span>
    <span class="description">Vadim.Konovalov [...] dell.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &#34;tcltk [...] perl.org&#34; &lt;tcltk [...] perl.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #125472]  error with coderefs passed as scalar args</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 15 Jun 2018 20:52:04 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Tcl [...] rt.cpan.org&#34; &lt;bug-Tcl [...] rt.cpan.org&gt;, &#34;huck [...] finn.com&#34; &lt;huck [...] finn.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Konovalov, Vadim&#34; &lt;Vadim.Konovalov [...] dell.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1791231/963387/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/963387">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 5.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Huck,
Thank you very much for the patch, I will apply it tomorrow;

Right now I have this error:

konovv@RUENKONOVVL2C /cygdrive/c/vad/perl-dev/tcl.pm
$ git am ../tcl.pm-patches/code-disposal-fix-v1.05.patch
Applying: RT 125472 Tcl.pm code disposal updates
error: Tcl.pm: does not match index
Patch failed at 0001 RT 125472 Tcl.pm code disposal updates
When you have resolved this problem run &#34;git am --resolved&#34;.
If you would prefer to skip this patch, instead run &#34;git am --skip&#34;.
To restore the original branch and stop patching run &#34;git am --abort&#34;.

But I will apply manually and soon after that release

Regards,
Vadim

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: huck via RT [mailto:bug-Tcl@rt.cpan.org] 
Sent: Friday, June 15, 2018 7:15 AM
Subject: Re: [rt.cpan.org #125472] error with coderefs passed as scalar args

       Queue: Tcl
 Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125472">https://rt.cpan.org/Ticket/Display.html?id=125472</a></span> &gt;

Ok I think im ready to have a go at this.

enclosed is e patch files,
code-disposal-fix-v1.05.patch fixes this issue

it was generated by
git format-patch  --stdout  -1 &gt;
~/cvs/pmlib-linkpatch/code-disposal-fix-v1.05.patch

and i am able to apply it by
git am ~/cvs/pmlib-linkpatch/code-disposal-fix-v1.05.patch


Like i said im new at git, so the second file memloss1.02.patch  &#40;which is for
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=125577">https://rt.cpan.org/Public/Bug/Display.html?id=125577</a></span> &#41; is enclosed so you can see the way i did it, and the pretty lines i added

lets assume those files are in the dir  ~/cvs/pmlib-linkpatch and  there is a dir at ~/cvs/gits/github

so you run

cd ~/cvs/gits/github
rm -rf  ~/cvs/gits/github/test-tcl
git clone <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/gisle/tcl.pm.git">https://github.com/gisle/tcl.pm.git</a></span> test-tcl -v cd ~/cvs/gits/github/test-tcl

git checkout master
git tag -a 1.02  3f5eb527e1ba3b883c2ba197e4bdaf28d940f389 -m &#34;Release 1.02&#34;
git tag -a 1.05  333cc79bb194c7007f08060a2e872789d4604217 -m &#34;Release 1.05&#34;
git tag -a last  94ead33b9a30f18954bbb8168343554c1ea3c20c -m &#39;last i know&#39;

git checkout -b memloss1.02 1.02
git am ~/cvs/pmlib-linkpatch/memloss1.02.patch

now if you use gitk you see your at v1.02 with the patch applied and you can see that it works at v1.02

perl Makefile.PL
make
make test

notice it didnt run  t/disposal-subs.t, it didnt exist then, so you go on

git checkout master
git merge -m &#39;RT 125577 Tcl.xs memory leak fix&#39; memloss1.02

perl Makefile.PL
make
make test

and you see it works at the current master , and runs t/disposal-subs.t, cuz its current NOW , so you go on

git checkout -b code-disposal-fix-v1.05 last git am ~/cvs/pmlib-linkpatch/code-disposal-fix-v1.05.patch

perl Makefile.PL
make
make test

and see it works patched to my base , notice it doesnt run t/memleak-a.t because it didnt exist on this branch yet,  but it ran all the disposal* tests, . so you go on

git checkout master
git merge -m &#39;RT 125472 Tcl.pm code disposal updates&#39; code-disposal-fix-v1.05

perl Makefile.PL
make
make test

Notice it ran all the disposal* and memlean* tests, its up to date!!
Now run gitk to see the funny squigly lines in many colors, that shows how this all went down

now what surprised me was that if you run

cd ~/cvs/gits/github
rm -rf  ~/cvs/gits/github/strp-tcl
git clone <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/gisle/tcl.pm.git">https://github.com/gisle/tcl.pm.git</a></span> strp-tcl cd ~/cvs/gits/github/strp-tcl git tag -a 1.02  3f5eb527e1ba3b883c2ba197e4bdaf28d940f389 -m &#34;Release 1.02&#34;
git tag -a 1.05  333cc79bb194c7007f08060a2e872789d4604217 -m &#34;Release 1.05&#34;
git checkout master
git am ~/cvs/pmlib-linkpatch/memloss1.02.patch
git am ~/cvs/pmlib-linkpatch/code-disposal-fix-v1.05.patch

diff Tcl.pm ~/cvs/gits/github/test-tcl/Tcl.pm diff Tcl.xs ~/cvs/gits/github/test-tcl/Tcl.xs

notice that the diffs are empty, yet in gitk the branching is much cleaner. so probably just running the 2 git am commands is fine, why, i-dunno, git has some deep magic to it in those patch files i dont grok yet.

i went a while getting the git-am calls to make the pretty lines i wanted to be sure it was doing what i wanted. I got scared when i saw it all in one line like that. but i am happy now that both methods produce the same result, just less pretty lines.

I also spent too much time chasing whitespace errors, git-am didnt like them.  That changed some lines that i didnt even put in, not a lot.

Probably spent too much time on the pod and making things pretty too, eh.

It works how i think it should work,  The code disposal routines seem to work ok, see the t/disposal-* tests for some comments about the problems i faced.  If you can still bust it id like to know.

A lot of the fix is additions to the pod, i hope that was ok too.

This started when a Tkx program i had didnt work under 1.05,  i made a stripped down version of it to get at the issue. Both used a lot of after commands for timeouts, keepalives, and sending data with a delay. They didnt like 1.05. now with these patches they are working again, and even better than before!

I hope this didnt cause new problems, but if it has, let me know and ill look into it more.

Again thanks for what you do and for putting up with me.

**Probably spent too much time getting to know git,  but now that i know more i think its worth it, its kinda slick. 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1791257" href="/Public/Bug/Display.html?id=125472#txn-1791257">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;15&nbsp;17:55:34&nbsp;2018</span>
    <span class="description">huck [...] finn.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #125472]  error with coderefs passed as scalar args</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 15 Jun 2018 16:53:30 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> huck &lt;huck [...] finn.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1791257/963404/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/963404">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">At 03:53 PM 6/15/2018, you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;Thank you very much for the patch, I will apply it tomorrow;
</div>
Thank you!!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;Right now I have this error:
</div>
these two pages seem to discuss this problem
<span class="clickylink"><a target="new" rel="nofollow" href="https://stackoverflow.com/questions/3575712/what-to-do-if-git-am-fails-with-does-not-match-index">https://stackoverflow.com/questions/3575712/what-to-do-if-git-am-fails-with-does-not-match-index</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://git.661346.n2.nabble.com/quot-git-apply-check-quot-successes-but-git-am-says-quot-does-not-match-index-quot-td6684646.html">http://git.661346.n2.nabble.com/quot-git-apply-check-quot-successes-but-git-am-says-quot-does-not-match-index-quot-td6684646.html</a></span>

It worked for me because i did it on clean clones, as they discuss 
you must have a &#34;dirty index&#34;. One solution discussed would be
git update-index --refresh
git am ../tcl.pm-patches/code-disposal-fix-v1.05.patch

or if you have push rights to github you can patch to a &#34;clean copy&#34; 
like i did

cd /cygdrive/c/vad/perl-dev
rm -rf  /cygdrive/c/vad/perl-dev/cleanam-tcl.pm
git clone <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/gisle/tcl.pm.git">https://github.com/gisle/tcl.pm.git</a></span> cleanam-tcl.pm
cd  /cygdrive/c/vad/perl-dev/cleanam-tcl.pm
git checkout master

# to run both at once
# and also fix <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=125577">https://rt.cpan.org/Public/Bug/Display.html?id=125577</a></span>
#uncomment the below line
#git am ../tcl.pm-patches/memloss1.02.patch

git am ../tcl.pm-patches/code-disposal-fix-v1.05.patch

git push

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;But I will apply manually and soon after that release
</div>
Thanks again!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1791423" href="/Public/Bug/Display.html?id=125472#txn-1791423">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;16&nbsp;09:48:00&nbsp;2018</span>
    <span class="description">Vadim.Konovalov [...] dell.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #125472]  error with coderefs passed as scalar args</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 16 Jun 2018 13:47:17 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Tcl [...] rt.cpan.org&#34; &lt;bug-Tcl [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Konovalov, Vadim&#34; &lt;Vadim.Konovalov [...] dell.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1791423/963510/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/963510">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">It was my stupid error;
TYVM!

Now applied; anything else? :&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: huck via RT [mailto:bug-Tcl@rt.cpan.org] 
Sent: Saturday, June 16, 2018 12:56 AM
Subject: RE: [rt.cpan.org #125472] error with coderefs passed as scalar args

       Queue: Tcl
 Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125472">https://rt.cpan.org/Ticket/Display.html?id=125472</a></span> &gt;

At 03:53 PM 6/15/2018, you wrote:
<div class="message-stanza open">&gt;Thank you very much for the patch, I will apply it tomorrow;
</div>
Thank you!!

<div class="message-stanza open">&gt;Right now I have this error:
</div>
these two pages seem to discuss this problem <span class="clickylink"><a target="new" rel="nofollow" href="https://stackoverflow.com/questions/3575712/what-to-do-if-git-am-fails-with-does-not-match-index">https://stackoverflow.com/questions/3575712/what-to-do-if-git-am-fails-with-does-not-match-index</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://git.661346.n2.nabble.com/quot-git-apply-check-quot-successes-but-git-am-says-quot-does-not-match-index-quot-td6684646.html">http://git.661346.n2.nabble.com/quot-git-apply-check-quot-successes-but-git-am-says-quot-does-not-match-index-quot-td6684646.html</a></span>

It worked for me because i did it on clean clones, as they discuss you must have a &#34;dirty index&#34;. One solution discussed would be git update-index --refresh git am ../tcl.pm-patches/code-disposal-fix-v1.05.patch

or if you have push rights to github you can patch to a &#34;clean copy&#34; 
like i did

cd /cygdrive/c/vad/perl-dev
rm -rf  /cygdrive/c/vad/perl-dev/cleanam-tcl.pm
git clone <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/gisle/tcl.pm.git">https://github.com/gisle/tcl.pm.git</a></span> cleanam-tcl.pm cd  /cygdrive/c/vad/perl-dev/cleanam-tcl.pm
git checkout master

# to run both at once
# and also fix <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=125577">https://rt.cpan.org/Public/Bug/Display.html?id=125577</a></span>
#uncomment the below line
#git am ../tcl.pm-patches/memloss1.02.patch

git am ../tcl.pm-patches/code-disposal-fix-v1.05.patch

git push

<div class="message-stanza open">&gt;But I will apply manually and soon after that release
</div>
Thanks again!
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1791575" href="/Public/Bug/Display.html?id=125472#txn-1791575">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;17&nbsp;18:03:19&nbsp;2018</span>
    <span class="description">huck [...] finn.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #125472]  error with coderefs passed as scalar args</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 17 Jun 2018 17:02:58 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> huck &lt;huck [...] finn.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1791575/963586/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/963586">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 490b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">At 08:48 AM 6/16/2018, you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;Now applied; anything else? :&#41;
</div>
Since are offering :&#41;

as i searched thru gitk i found those yellow cpan release tags very helpful

git tag -a 1.02  3f5eb527e1ba3b883c2ba197e4bdaf28d940f389 -m &#34;Release 1.02&#34;
git tag -a 1.05  333cc79bb194c7007f08060a2e872789d4604217 -m &#34;Release 1.05&#34;
git push origin 1.02
git push origin 1.05

would sortof bring them more up to date. i started referring to them 
so much i added them to my local repository

thanks again
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1791818" href="/Public/Bug/Display.html?id=125472#txn-1791818">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;19&nbsp;04:28:32&nbsp;2018</span>
    <span class="description">Vadim.Konovalov [...] dell.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #125472]  error with coderefs passed as scalar args</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 19 Jun 2018 08:27:32 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Tcl [...] rt.cpan.org&#34; &lt;bug-Tcl [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Konovalov, Vadim&#34; &lt;Vadim.Konovalov [...] dell.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1791818/963715/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/963715">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 813b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ok, done that,
Thanks!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: huck via RT [mailto:bug-Tcl@rt.cpan.org] 
Sent: Monday, June 18, 2018 1:03 AM
Subject: RE: [rt.cpan.org #125472] error with coderefs passed as scalar args

       Queue: Tcl
 Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125472">https://rt.cpan.org/Ticket/Display.html?id=125472</a></span> &gt;

At 08:48 AM 6/16/2018, you wrote:
<div class="message-stanza open">&gt;Now applied; anything else? :&#41;
</div>
Since are offering :&#41;

as i searched thru gitk i found those yellow cpan release tags very helpful

git tag -a 1.02  3f5eb527e1ba3b883c2ba197e4bdaf28d940f389 -m &#34;Release 1.02&#34;
git tag -a 1.05  333cc79bb194c7007f08060a2e872789d4604217 -m &#34;Release 1.05&#34;
git push origin 1.02
git push origin 1.05

would sortof bring them more up to date. i started referring to them so much i added them to my local repository

thanks again
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1792538" href="/Public/Bug/Display.html?id=125472#txn-1792538">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;23&nbsp;22:20:16&nbsp;2018</span>
    <span class="description">sjaluo [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1792538/964057/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/964057">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 278b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

   I have tried and installed the newly released Tcl-1.06, I found there causes an extra &#39;make test&#39; error on Tkx module. Please check attached report. There are two errors. The first error &#40;from t/tcl-callback.t&#41; might be related to the patches from this ticket. FYI.

SJ
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Tkx_error_report.txt</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1792538/964058/Tkx_error_report.txt">Download Tkx_error_report.txt</a><br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">PERL_DL_NONLAZY=1 &#34;/usr/bin/perl.exe&#34; &#34;-MExtUtils::Command::MM&#34; &#34;-MTest::Harness&#34; &#34;-e&#34; &#34;undef *Test::Harness::Switches; test_harness&#40;0, &#39;blib/lib&#39;, &#39;blib/arch&#39;&#41;&#34; t/*.t
t/LabEntry.t ...... ok
t/mega-config.t ... ok
t/mega.t .......... ok
t/nul-char.t ...... ok
Tcl error &#39;invalid command name &#34;::perl::CODE&#40;0x600079240&#41;&#34; at /usr/local/lib/perl5/site_perl/5.26/x86_64-cygwin-threads/Tcl.pm line 765.
&#39; while invoking scalar result call:
	&#34;eval [set foo] a {b c}&#34; at t/tcl-callback.t line 15.
t/tcl-callback.t .. 
Dubious, test returned 2 &#40;wstat 512, 0x200&#41;
Failed 6/7 subtests 
# Test 18 got: &#34;Tcl error &#39;Foo at /usr/local/lib/perl5/site_perl/5.26/x86_64-cygwin-threads/Tcl.pm line 765.\n&#39; while invoking scalar result call:\n\t\&#34;error Foo\&#34; at t/tcl.t line 38.\n&#34; &#40;t/tcl.t at line 39&#41;
#    Expected: &#34;Foo at t/tcl.t line 38.\n&#34;
#  t/tcl.t line 39 is: ok&#40;$@, &#34;Foo at @{[__FILE__]} line @{[__LINE__ - 1]}.\n&#34;&#41;;
t/tcl.t ........... 
All 17 subtests passed 
t/tk.t ............ ok
t/utf8.t .......... ok

Test Summary Report
-------------------
t/tcl-callback.t &#40;Wstat: 512 Tests: 1 Failed: 0&#41;
  Non-zero exit status: 2
  Parse errors: Bad plan.  You planned 7 tests but ran 1.
t/tcl.t         &#40;Wstat: 0 Tests: 18 Failed: 1&#41;
  Failed test:  18
  Parse errors: Bad plan.  You planned 17 tests but ran 18.
Files=8, Tests=48, 19 wallclock secs &#40; 0.14 usr  0.06 sys +  1.81 cusr  2.85 csys =  4.86 CPU&#41;
Result: FAIL
Failed 2/8 test programs. 1/48 subtests failed.
make: *** [Makefile:892: test_dynamic] Error 255
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1792565" href="/Public/Bug/Display.html?id=125472#txn-1792565">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;24&nbsp;01:25:55&nbsp;2018</span>
    <span class="description">huck [...] finn.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #125472] error with coderefs passes as scalar args</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 24 Jun 2018 00:25:37 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> huck &lt;huck [...] finn.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1792565/964064/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/964064">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Yes it is related. I have a fix for it already but i want to research 
farther to make sure it is sufficient. Please be patient!

At 09:20 PM 6/23/2018, you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125472">https://rt.cpan.org/Ticket/Display.html?id=125472</a></span> &gt;
&gt;
&gt;Hi,
&gt;
&gt;    I have tried and installed the newly released Tcl-1.06, I found 
&gt; there causes an extra &#39;make test&#39; error on Tkx module. Please check 
&gt; attached report. There are two errors. The first error &#40;from 
&gt; t/tcl-callback.t&#41; might be related to the patches from this ticket. FYI.
&gt;
&gt;SJ
&gt;
&gt;
&gt;Content-Type: text/plain; charset=&#34;utf-8&#34;; name=&#34;Tkx_error_report.txt&#34;
&gt;Content-Disposition: inline; filename=&#34;Tkx_error_report.txt&#34;
&gt;Content-Transfer-Encoding: 7bit
&gt;RT-Attachment: 125472/1792538/964058
&gt;
&gt;PERL_DL_NONLAZY=1 &#34;/usr/bin/perl.exe&#34; &#34;-MExtUtils::Command::MM&#34; 
&gt;&#34;-MTest::Harness&#34; &#34;-e&#34; &#34;undef *Test::Harness::Switches; 
&gt;test_harness&#40;0, &#39;blib/lib&#39;, &#39;blib/arch&#39;&#41;&#34; t/*.t
&gt;t/LabEntry.t ...... ok
&gt;t/mega-config.t ... ok
&gt;t/mega.t .......... ok
&gt;t/nul-char.t ...... ok
&gt;Tcl error &#39;invalid command name &#34;::perl::CODE&#40;0x600079240&#41;&#34; at 
&gt;/usr/local/lib/perl5/site_perl/5.26/x86_64-cygwin-threads/Tcl.pm line 765.
&gt;&#39; while invoking scalar result call:
&gt;         &#34;eval [set foo] a {b c}&#34; at t/tcl-callback.t line 15.
&gt;t/tcl-callback.t ..
&gt;Dubious, test returned 2 &#40;wstat 512, 0x200&#41;
&gt;Failed 6/7 subtests
&gt;# Test 18 got: &#34;Tcl error &#39;Foo at 
&gt;/usr/local/lib/perl5/site_perl/5.26/x86_64-cygwin-threads/Tcl.pm 
&gt;line 765.\n&#39; while invoking scalar result call:\n\t\&#34;error Foo\&#34; at 
&gt;t/tcl.t line 38.\n&#34; &#40;t/tcl.t at line 39&#41;
&gt;#    Expected: &#34;Foo at t/tcl.t line 38.\n&#34;
&gt;#  t/tcl.t line 39 is: ok&#40;$@, &#34;Foo at @{[__FILE__]} line @{[__LINE__ 
&gt;- 1]}.\n&#34;&#41;;
&gt;t/tcl.t ...........
&gt;All 17 subtests passed
&gt;t/tk.t ............ ok
&gt;t/utf8.t .......... ok
&gt;
&gt;Test Summary Report
&gt;-------------------
&gt;t/tcl-callback.t &#40;Wstat: 512 Tests: 1 Failed: 0&#41;
&gt;   Non-zero exit status: 2
&gt;   Parse errors: Bad plan.  You planned 7 tests but ran 1.
&gt;t/tcl.t         &#40;Wstat: 0 Tests: 18 Failed: 1&#41;
&gt;   Failed test:  18
&gt;   Parse errors: Bad plan.  You planned 17 tests but ran 18.
&gt;Files=8, Tests=48, 19 wallclock secs &#40; 0.14 usr  0.06 sys +  1.81 
&gt;cusr  2.85 csys =  4.86 CPU&#41;
&gt;Result: FAIL
&gt;Failed 2/8 test programs. 1/48 subtests failed.
&gt;make: *** [Makefile:892: test_dynamic] Error 255
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1793502" href="/Public/Bug/Display.html?id=125472#txn-1793502">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;28&nbsp;18:45:44&nbsp;2018</span>
    <span class="description">huck [...] finn.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #125472] error with coderefs passes as scalar args</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 28 Jun 2018 17:45:11 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> huck &lt;huck [...] finn.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1793502/964588/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/964588">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">ok i have the fix ready.  I backed out a portion of what i had added 
to try to keep the $anon_refs hash clean.  I decided i did not know 
enuf about Tcl to insure the patch would only be needed for the set verb.

I also fixed some stuff about &#34;user tracking&#34;,  &#40;which calls are 
using a tclname&#41;
and updated the pod a little

patch is enclosed to allow

git checkout master
git am ../tcl.pm-patches/c-set1.06.patch

i tested it against the most up-to-date today masters from github at
   <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/gisle/tcl.pm.git">https://github.com/gisle/tcl.pm.git</a></span>
   <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/gisle/tkx.git">https://github.com/gisle/tkx.git</a></span>
   <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/eserte/perl-tk.git">https://github.com/eserte/perl-tk.git</a></span>



At 09:20 PM 6/23/2018, you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125472">https://rt.cpan.org/Ticket/Display.html?id=125472</a></span> &gt;
&gt;
&gt;Hi,
&gt;
&gt;    I have tried and installed the newly released Tcl-1.06, I found 
&gt; there causes an extra &#39;make test&#39; error on Tkx module. Please check 
&gt; attached report. There are two errors. The first error &#40;from 
&gt; t/tcl-callback.t&#41; might be related to the patches from this ticket. FYI.
&gt;
&gt;SJ
&gt;
&gt;
&gt;Content-Type: text/plain; charset=&#34;utf-8&#34;; name=&#34;Tkx_error_report.txt&#34;
&gt;Content-Disposition: inline; filename=&#34;Tkx_error_report.txt&#34;
&gt;Content-Transfer-Encoding: 7bit
&gt;RT-Attachment: 125472/1792538/964058
&gt;
&gt;PERL_DL_NONLAZY=1 &#34;/usr/bin/perl.exe&#34; &#34;-MExtUtils::Command::MM&#34; 
&gt;&#34;-MTest::Harness&#34; &#34;-e&#34; &#34;undef *Test::Harness::Switches; 
&gt;test_harness&#40;0, &#39;blib/lib&#39;, &#39;blib/arch&#39;&#41;&#34; t/*.t
&gt;t/LabEntry.t ...... ok
&gt;t/mega-config.t ... ok
&gt;t/mega.t .......... ok
&gt;t/nul-char.t ...... ok
&gt;Tcl error &#39;invalid command name &#34;::perl::CODE&#40;0x600079240&#41;&#34; at 
&gt;/usr/local/lib/perl5/site_perl/5.26/x86_64-cygwin-threads/Tcl.pm line 765.
&gt;&#39; while invoking scalar result call:
&gt;         &#34;eval [set foo] a {b c}&#34; at t/tcl-callback.t line 15.
&gt;t/tcl-callback.t ..
&gt;Dubious, test returned 2 &#40;wstat 512, 0x200&#41;
&gt;Failed 6/7 subtests
&gt;# Test 18 got: &#34;Tcl error &#39;Foo at 
&gt;/usr/local/lib/perl5/site_perl/5.26/x86_64-cygwin-threads/Tcl.pm 
&gt;line 765.\n&#39; while invoking scalar result call:\n\t\&#34;error Foo\&#34; at 
&gt;t/tcl.t line 38.\n&#34; &#40;t/tcl.t at line 39&#41;
&gt;#    Expected: &#34;Foo at t/tcl.t line 38.\n&#34;
&gt;#  t/tcl.t line 39 is: ok&#40;$@, &#34;Foo at @{[__FILE__]} line @{[__LINE__ 
&gt;- 1]}.\n&#34;&#41;;
&gt;t/tcl.t ...........
&gt;All 17 subtests passed
&gt;t/tk.t ............ ok
&gt;t/utf8.t .......... ok
&gt;
&gt;Test Summary Report
&gt;-------------------
&gt;t/tcl-callback.t &#40;Wstat: 512 Tests: 1 Failed: 0&#41;
&gt;   Non-zero exit status: 2
&gt;   Parse errors: Bad plan.  You planned 7 tests but ran 1.
&gt;t/tcl.t         &#40;Wstat: 0 Tests: 18 Failed: 1&#41;
&gt;   Failed test:  18
&gt;   Parse errors: Bad plan.  You planned 17 tests but ran 18.
&gt;Files=8, Tests=48, 19 wallclock secs &#40; 0.14 usr  0.06 sys +  1.81 
&gt;cusr  2.85 csys =  4.86 CPU&#41;
&gt;Result: FAIL
&gt;Failed 2/8 test programs. 1/48 subtests failed.
&gt;make: *** [Makefile:892: test_dynamic] Error 255
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1793502/964589/c-set1.06.patch">Download c-set1.06.patch</a><br />
<span class="downloadcontenttype">text/x-diff 9.8k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1793538" href="/Public/Bug/Display.html?id=125472#txn-1793538">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;29&nbsp;03:48:53&nbsp;2018</span>
    <span class="description">VKON [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1793538/964604/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/964604">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 15b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">thanks, applied
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1793541" href="/Public/Bug/Display.html?id=125472#txn-1793541">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;29&nbsp;04:55:49&nbsp;2018</span>
    <span class="description">VKON [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1793541/964607/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/964607">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 155b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">... forgot to notice, <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/eserte/perl-tk.git">https://github.com/eserte/perl-tk.git</a></span> is completely unrelated to Tcl module, it does not use Tcl module. &#40;I think you also know that&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1793926" href="/Public/Bug/Display.html?id=125472#txn-1793926">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;01&nbsp;21:10:29&nbsp;2018</span>
    <span class="description">sjaluo [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> tcltk [...] perl.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1793926/964812/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/964812">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I am trying to understand the content of the code disposal patches. So far I cannot fully make it out but I think it would be more efficient than the previous one. There are something I&#39;d like to discuss:

1&#41; The new version put document of originally internal function create_tcl_sub&#40;&#41; as a new API. IMHO programmers should always use the form &#34;$interp-&gt;call&#40;...,WRITABLE=&gt;$sub&#41;&#34; if they want code disposal to be handled automatically; otherwise, they could just apply original API CreateCommnd&#40;&#41; - DeleteCommand&#40;&#41; pair to handle code creation and disposal manually. Providing another create_tcl_sub&#40;&#41; - _code_dispose&#40;&#41; pair looks duplicating and confusing. Besides, user may find it difficult to provide DESCRNAME arg value.

2&#41; The newest POD in github HEAD mentioned

    $interp-&gt;call&#40;&#39;fileevent&#39;,&#39;sock9827430&#39;,&#39;writable&#39;&#41;;

won&#39;t dispose the sub created from

    $interp-&gt;call&#40;&#39;fileevent&#39;,&#39;sock9827430&#39;, &#39;writable&#39;=&gt;sub{...}&#41;;

is it still true? Or only &#39;set&#39; command behaves in this way?

3&#41; The POD mentioned two functions _code_destroy&#40;&#41; and destroy_ref&#40;&#41; which cannot be found in Tcl.pm. I guess you mean _code_dispose&#40;&#41; and delete_ref&#40;&#41;. IMO we just need to have delete_ref&#40;&#41; in POD. Disclosing both of them might be confusing too.

Thanks,
SJ
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1793961" href="/Public/Bug/Display.html?id=125472#txn-1793961">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;02&nbsp;02:51:02&nbsp;2018</span>
    <span class="description">VKON [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1793961/964828/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/964828">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 558b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I agree with all points.

yet, I think that too careful track on coderefs could result in even more memory leaks, not only will grow allocated numbers of CODE references, but also grow hash which tracks them.

IMO the best solution to the problem - is documenting it better;

if the problem hurts user - she can elaborate another way in her code, change &#34;-command=&gt;sub{}&#34; to &#34;-command=&gt;&#39;tclsub&#39;&#34;, where &#39;tclsub&#39; will handle all the job;

maybe warn user in case of 100 allocated coderefs;

IDK. we could solve this problem by just ignoring its existence :&#41;:&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1793965" href="/Public/Bug/Display.html?id=125472#txn-1793965">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;02&nbsp;03:28:11&nbsp;2018</span>
    <span class="description">huck [...] finn.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #125472] error with coderefs passes as scalar args</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 02 Jul 2018 02:27:49 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> huck &lt;huck [...] finn.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1793965/964831/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/964831">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">At 08:10 PM 7/1/2018, you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125472">https://rt.cpan.org/Ticket/Display.html?id=125472</a></span> &gt;
&gt;
&gt;Hi,
&gt;
&gt;I am trying to understand the content of the code disposal patches. 
&gt;So far I cannot fully make it out but I think it would be more 
&gt;efficient than the previous one. There are something I&#39;d like to discuss:
</div>

What you need to first remember is that i did not introduce code 
disposal to the module but  instead i was trying to find a way to fix 
problems that the introduction of code disposal had broken in my perl 
programs  that ran fine under v1.02.

my first idea with &#34;weaken&#34; did not address all the problems i 
eventually found as i investigated what code disposal was doing,  so 
i tried to present a more robust solution in my second attempt that 
addressed all the problems i had discovered.

It was never my intent to make my code more efficient that the v1.05 
code disposal process,  i just wanted to fix it so it no longer broke 
my existing working code.

I added comments to the tests i added to t/ to document the problems 
i noticed with the v1.05 process that you may find helpful to read.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;1&#41; The new version put document of originally internal function 
&gt;create_tcl_sub&#40;&#41; as a new API. IMHO programmers should always use 
&gt;the form &#34;$interp-&gt;call&#40;...,WRITABLE=&gt;$sub&#41;&#34; if they want code 
&gt;disposal to be handled automatically; otherwise, they could just 
&gt;apply original API CreateCommnd&#40;&#41; - DeleteCommand&#40;&#41; pair to handle 
&gt;code creation and disposal manually. Providing another 
&gt;create_tcl_sub&#40;&#41; - _code_dispose&#40;&#41; pair looks duplicating and 
&gt;confusing. Besides, user may find it difficult to provide DESCRNAME arg value.
</div>

I found that others were already using the create_tcl_sub&#40;&#41; entry 
even though it was not documented.  And i found that the description 
of CreateCommnd&#40;&#41; to be confusing to me as well.

Since create_tcl_sub&#40;&#41; is what was used in call&#40;&#41;, and that was that 
pair where the code needed to be patched  i thought it made sense to 
document how create_tcl_sub&#40;&#41;  worked and how code disposal worked 
within it.  IMHO it made sense to expose create_tcl_sub&#40;&#41; so that 
programmers could use the automatic recoding of a call&#40;,,$coderef&#41; 
process  as well as being able to control when code disposal took 
place if they wanted to handle it themselves.  This allows them to 
continue to use coderefs if they want and just delete one use by 
using DESCRNAME, or all clear it totally by using TCLNAME.

I think i made it clear that the user supplied DESCRNAME can be 
anything they want it to be,  as long as it does not begin with &#39;=&#39; 
or &#39;@&#39;, or &#39;::perl::&#39;.
&#39;=&#39; now prefaces &#34;normal&#34; entries created by create_tcl_sub&#40;&#41;.
&#39;@&#39; prefaces entries create_tcl_sub&#40;&#41; will use to possibly dispose of 
coderefs &#34;AT&#34; a future time since they were used by an after command.
and &#39;::perl::&#39; prefaces the TCLNAME assigned by create_tcl_sub&#40;&#41; and 
is used in anon_refs{} to determine when no more &#34;users&#34;  exist and 
the coderef can now be safely deleted from the tcl namespace.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;2&#41; The newest POD in github HEAD mentioned
&gt;
&gt;     $interp-&gt;call&#40;&#39;fileevent&#39;,&#39;sock9827430&#39;,&#39;writable&#39;&#41;;
&gt;
&gt;won&#39;t dispose the sub created from
&gt;
&gt;     $interp-&gt;call&#40;&#39;fileevent&#39;,&#39;sock9827430&#39;, &#39;writable&#39;=&gt;sub{...}&#41;;
&gt;
&gt;is it still true? Or only &#39;set&#39; command behaves in this way?
</div>

yes this is still true, it was true in v1.02 and v1.05 and reverted 
back to that behavior in v1.11.  at v1.06 i had tried to make it so 
the first call would cause code disposal of the sub created by the 
second,  but that was what broke your &#34;set foo&#34; tests.  At the time i 
introduced that behavior i thought it made sense to try to initiate 
code disposal in those cases,  to keep the internal table and tcl 
namespace clean,  but after spending some time trying to decide if 
&#34;set foo&#34; was the only place this should be avoided  i decided that 
it was safer to revert to the original processing  where code 
disposal would only be triggered if there was a different coderef in 
the new call.  but not when the coderef was now missing.

I wrapped the place where it occurs with a flag  so it could be 
reinstated if desired when it was determined that only &#34;set foo&#34; 
should be handled in this special manner


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;3&#41; The POD mentioned two functions _code_destroy&#40;&#41; and destroy_ref&#40;&#41; 
&gt;which cannot be found in Tcl.pm. I guess you mean _code_dispose&#40;&#41; 
&gt;and delete_ref&#40;&#41;. IMO we just need to have delete_ref&#40;&#41; in POD. 
&gt;Disclosing both of them might be confusing too.
</div>

yes you are right, i misspoke when i wrote those sections of the pod 
and i will submit corrections to fix that soon.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;Thanks,
&gt;SJ
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1794041" href="/Public/Bug/Display.html?id=125472#txn-1794041">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;02&nbsp;14:59:27&nbsp;2018</span>
    <span class="description">huck [...] finn.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #125472] error with coderefs passes as scalar args</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 02 Jul 2018 13:59:09 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> huck &lt;huck [...] finn.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1794041/964865/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/964865">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 8.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">At 01:51 AM 7/2/2018, you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125472">https://rt.cpan.org/Ticket/Display.html?id=125472</a></span> &gt;
&gt;
&gt;I agree with all points.
&gt;
&gt;yet, I think that too careful track on coderefs could result in even 
&gt;more memory leaks, not only will grow allocated numbers of CODE 
&gt;references, but also grow hash which tracks them.
</div>
I think it would be very hard to have more memory leaks than there 
were before my patch to tcl.xs because up to that point no coderefs 
would ever be released at all. Note that this means nothing 
referenced in a coderefs PAD would get freed either.



<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;IMO the best solution to the problem - is documenting it better;
&gt;
&gt;if the problem hurts user - she can elaborate another way in her 
&gt;code, change &#34;-command=&gt;sub{}&#34; to &#34;-command=&gt;&#39;tclsub&#39;&#34;, where 
&gt;&#39;tclsub&#39; will handle all the job;
&gt;
&gt;maybe warn user in case of 100 allocated coderefs;
&gt;
&gt;IDK. we could solve this problem by just ignoring its existence :&#41;:&#41;
</div>
All this would do is bring us back to the level of v1.02 where there 
was no code disposal at all, or to the level of v1.05 where code 
disposal worked on with dynamic coderefs &#40;-command=&gt;sub{...}&#41;  but 
did not often
work when static coderefs were used &#40;-command=&gt;$coderef&#41;.

When i am trying to patch existing code i go into a mode where i try 
to think like the original programmer thinks. I do not claim to know 
what you folk do with these kind of callbacks but it became clear to 
me that the v1.05 code disposal process existed to keep the anon_refs 
hash cleaner when there were a lot of &#34;after&#34; calls and all the calls 
used dynamically created coderefs &#40;-command=&gt;sub{...}&#41; my first 
intent was to make it so code disposal would also work when the after 
commands were to statically scoped coderefs &#40;-command=&gt;$coderef&#41;. But 
as i dug deeper i realized that the problems with statically scoped 
coderefs went even deeper. So i tried to present a solution that was 
robust enough to handle all the problems i had discovered.

Even though i felt i had mostly succeeded in that quest i feel that 
for the most part the code disposal routines will be rarely invoked. 
In my mind the primary use of callbacks  are in the Tkx menu, button 
and bind arenas.  If i make an element with some buttons and later 
delete that element the buttons go away, but code disposal will not 
get called on those button callbacks and they will continue to exist 
in $anon_refs.

Even if i recreate that element such that  it gets the same tk 
element name and in the same order,  under the v1.05 rules it is very 
likely that code disposal will have destroyed the internal tcl 
linkage to the perl code if it was passed as a static coderef. The 
problem exists because of this line $anon_refs{$rname} = bless 
[\$sub, $interp], &#39;Tcl::Code&#39;; in create_tcl_sub&#40;&#41;.  Since $rname is 
the same as the previous creation Tcl::Code::DESTROY will get called 
on the existing slot and removes the tcl linkage to that static 
coderef even though it is about to assign a new value with the exact 
same static coderef pointer.  The same problem can occur even if the 
order is not the same. Lets say i have 5 buttons all using static 
coderefs, do-something-a, do-something-b, do-something-c, about, 
exit. but then i go and rebuild the element with only 4 buttons, 
b,c,about,exit. when i add the new button for b, it disposes of the 
code for button a, and assigns b, but then when i go and assign the 
new c button, it calls code disposal on the subroutine for b, even 
though b had just been defined to be button 1. the same goes for the 
about button, when exit is assigned to button 4 it calls code 
disposal on the tcl linkage to the subroutine for about because that 
is what used to be button 4. The exit command is protected tho 
because code disposal never gets called on the old button 5 because 
there is no new button 5 overriding it. but the old reference to 
button 5 still exists in $anon_refs too.

The same exists for menus and binds. But under the v1.02 rules since 
there was no code disposal at all this was not a problem.

So my point is that code disposal was only of use when there were a 
lot of &#34;after&#34; calls with dynamically created coderefs. If the 
coderefs were statically  scoped the v1.05 rules busted the tcl 
linkage to the code ref. If the element containing the buttons, menus 
and binds were destroyed in tcl/tk code disposal never got called and 
the entries still existed in $anon_refs. If the element was recreated 
with the same name it was likely that any static coderefs would not 
work under the v1.05 rules. So  v1.05 code disposal was only useful 
in &#34;after&#34; commands that used dynamically created coderefs.

My patches fixed the problems with statically scoped coderefs. They 
also introduced a path where the user could control code disposal 
better. If i called create_tcl_sub&#40;&#41; to &#34;register&#34; my static coderef 
and captured the TCLNAME returned i could later call _code_dispose&#40;&#41; 
or delete_ref&#40;&#41; in that TCLNAME and it would clear the tcl linkage to 
the coderef and clean $anaon_refs of all related entries without 
needing to change the rest of my code that passed statically scoped 
coderefs. if i registered a static coderef to an about or exit 
procedure it would not need to be destroyed and then recreated over 
and over each time it was used in a new element.

There was another problem that existed under v1.05 related to the 
fact that only the last code reference was saved if there was more 
than one code reference in the call&#40;&#41; arguments. Lets assume 
$interp-&gt;call&#40;&#39;if,&#39;1&#39;,$sub1,$sub2&#41;;  It goes and creates a reference 
for $sub1, and saves it in $anon_refs{$rname} and @codes. It then 
goes and creates a reference for $sub2 and assigns it to the same 
place in $anon_refs that held $sub1. but since sub1 is also in @codes 
it is safe for now. It passes to the code execution phase and since 
both still exist in @codes it executes fine. But then @codes is 
DESTROYED and that destroys the internal tcl reference to the perl 
code. Now $interp-&gt;call&#40;&#39;if,&#39;1&#39;,$sub1,$sub2&#41;; is run again. $sub1 no 
longer exists and the tcl reference gets recreated and assigned to 
$anon_refs{$rname}, but this causes the internal tcl reference to 
$sub2 to be destroyed, It then processes $sub2, and again $sub1 is 
protected since it is still in @codes, and it executes fine but then 
when @codes is destroyed the internal tcl reference to $sub1 is 
removed  and only the reference to $sub1 still exists. This 
delete/recreate cycle will keep repeating but this didnt happen under 
v1.02 because that version tested to see if the TCLNAME didnt already 
exist before trying to create it.  It was to prevent this that i 
decided it was best to save all of @codes in $anaon_refs{$rname} for 
each call&#40;&#41;.

So now that you understand my goals for the patches it should be 
clear that i reached them while still retaining the original code 
disposal goal of cleaning up &#34;after&#34; calls that used dynamically 
scoped coderefs.

But i introduced a bug that was exhibited by the &#34;set foo&#34; test in 
tkx. This was the last part i introduced and obviously it wasnt not 
as well thought out as the other goals. I wanted to be able to 
trigger code disposal when a readable or writable callback was 
removed. As i am cleaning up my sockets in preparation for 
disposal  of the socket itself clearing those callbacks was the first 
thing i did, and i figured it would also be done by anyone else using 
those callbacks. It would also clean up bind calls where there was no 
coderef/script supplied which serves to delete the current binding 
for that sequence. just like it does for readable/writable. While i 
still think that only the &#34;set foo&#34; instance should be dealt with i 
backed out that  whole rule just in case, but left it wrapped in a 
flag should we want to bring it back for all but the &#34;set foo&#34; instance.

IMHO the use of CreateCommand&#40;&#41; should be avoided by the user since 
there is little clear guidance as to what the CLIENTDATA, and 
DELETEPROC  arguments do and how they are handled if they are undef. 
it took a lot of digging thru tcl.xs to understand that. But It is 
clear in tcl.pm how create_tcl_sub&#40;&#41; is called and used and that 
serves as a reference to the user about how to call it themselves. 
She runs more of a risk in using CreateCommand&#40;&#41; wrong than using 
create_tcl_sub&#40;&#41;  which does most of the background work for you of 
creating a TCLNAME and DELETEPROC for you, and passes useful 
CLIENTDATA to that DELETEPROC.

And since most of the uses for these kind of callbacks seem to be by 
Tkx programs i was going to suggest that more documentation be added 
to Tkx.pm about them, about how the new code disposal routines affect 
tkx commands and that a route to call create_tcl_sub&#40;&#41;  and 
_code_dispose/delete_ref without needing to first find Tkx::i::interp 
be introduced. IHMO it is in the Tkx arena that the documentation is 
most lacking about this and needs more enhancement.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1794102" href="/Public/Bug/Display.html?id=125472#txn-1794102">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;03&nbsp;04:07:02&nbsp;2018</span>
    <span class="description">VKON [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1794102/964891/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/964891">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 567b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">we very much appreciate the effort;

unclear for me - why $sub1 and $sub2 will have same slot for this statement,
$interp-&gt;call&#40;&#39;if,&#39;1&#39;,$sub1,$sub2&#41;; 

there is:
...
# stringify sub, becomes &#34;CODE&#40;0x######&#41;&#34; in ::perl namespace

so $sub1 and $sub2 will recieve different slots in %anon_refs hash

all in all, if you&#39;ll find a correct solution - nice. if isn&#39;t - also not bad. for mee, we already have too much code for the case, which I would prefer to be simplier.

also, what a need for
sub _anon_refs_cheat { return \%anon_refs;}

?

can we switch to mailing list?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1794135" href="/Public/Bug/Display.html?id=125472#txn-1794135">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;03&nbsp;10:07:46&nbsp;2018</span>
    <span class="description">sjaluo [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> tcltk [...] perl.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1794135/964910/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/964910">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Thank you for the prompt and detailed response.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I added comments to the tests i added to t/ to document the problems
&gt; i noticed with the v1.05 process that you may find helpful to read.
&gt;
&gt; I found that others were already using the create_tcl_sub&#40;&#41; entry
&gt; even though it was not documented. And i found that the description
&gt; of CreateCommnd&#40;&#41; to be confusing to me as well.
</div>
I think someone uses the internal function does not necessary mean that the function has to be exposed by document. The difference is: If a module user uses undocumented internal function, he/she takes the risk of function robustness and compatibility on module revision. On the other hand, if a module document a function as an API, the module shall take response that both interface and behavior should not change in the future.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Since create_tcl_sub&#40;&#41; is what was used in call&#40;&#41;, and that was that
&gt; pair where the code needed to be patched i thought it made sense to
&gt; document how create_tcl_sub&#40;&#41; worked and how code disposal worked
&gt; within it. IMHO it made sense to expose create_tcl_sub&#40;&#41; so that
&gt; programmers could use the automatic recoding of a call&#40;,,$coderef&#41;
&gt; process as well as being able to control when code disposal took
&gt; place if they wanted to handle it themselves. This allows them to
&gt; continue to use coderefs if they want and just delete one use by
&gt; using DESCRNAME, or all clear it totally by using TCLNAME.
</div>
Yes, it makes sense to document how internal mechanism works, but again it does not mean create_tcl_sub&#40;&#41; has to be documented so detail and as a part of API.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think i made it clear that the user supplied DESCRNAME can be
&gt; anything they want it to be, as long as it does not begin with &#39;=&#39;
&gt; or &#39;@&#39;, or &#39;::perl::&#39;.
&gt; &#39;=&#39; now prefaces &#34;normal&#34; entries created by create_tcl_sub&#40;&#41;.
&gt; &#39;@&#39; prefaces entries create_tcl_sub&#40;&#41; will use to possibly dispose of
&gt; coderefs &#34;AT&#34; a future time since they were used by an after command.
&gt; and &#39;::perl::&#39; prefaces the TCLNAME assigned by create_tcl_sub&#40;&#41; and
&gt; is used in anon_refs{} to determine when no more &#34;users&#34; exist and
&gt; the coderef can now be safely deleted from the tcl namespace.
</div>
Okay, I finally get the the point of DESCRNAME usage now. I did not know that DESCRNAME can be passed to _code_dispose&#40;&#41; so I did not get the purpose of DESCRNAME at all. I suggest to have more explicit description that argument of _code_dispose&#40;&#41; is either TCLNAME or DESCRNAME. And the major purpose of DESCRNAME is used to pass to _code_disposal&#40;&#41;.
I get your point more, but I still think we shall properly define the interface to support code disposal instead of just directly expose an internal function out. For example, how about modify call&#40;&#41; to support the form of call&#40;DESCRNAME, cmd, arg ...&#41;, where DESCRNAME is optional and is a string that with &#39;@&#39; prefix. Then we have a good compatibility and user do not have to worry about GENCODE, EVENTS etc.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; 2&#41; The newest POD in github HEAD mentioned
&gt; &gt;
&gt; &gt; $interp-&gt;call&#40;&#39;fileevent&#39;,&#39;sock9827430&#39;,&#39;writable&#39;&#41;;
&gt; &gt;
&gt; &gt; won&#39;t dispose the sub created from
&gt; &gt;
&gt; &gt; $interp-&gt;call&#40;&#39;fileevent&#39;,&#39;sock9827430&#39;, &#39;writable&#39;=&gt;sub{...}&#41;;
&gt; &gt;
&gt; &gt; is it still true? Or only &#39;set&#39; command behaves in this way?
</div>&gt;
&gt; yes this is still true, it was true in v1.02 and v1.05 and reverted
&gt; back to that behavior in v1.11. at v1.06 i had tried to make it so
&gt; the first call would cause code disposal of the sub created by the
&gt; second, but that was what broke your &#34;set foo&#34; tests. At the time i
&gt; introduced that behavior i thought it made sense to try to initiate
&gt; code disposal in those cases, to keep the internal table and tcl
&gt; namespace clean, but after spending some time trying to decide if
&gt; &#34;set foo&#34; was the only place this should be avoided i decided that
&gt; it was safer to revert to the original processing where code
&gt; disposal would only be triggered if there was a different coderef in
&gt; the new call. but not when the coderef was now missing.
&gt;
&gt; I wrapped the place where it occurs with a flag so it could be
&gt; reinstated if desired when it was determined that only &#34;set foo&#34;
&gt; should be handled in this special manner
</div>
Too bad that it is disabled by default. IMO &#39;$interp-&gt;call&#40;&#34;FILEEVENT&#34; ... &#34;WRITABLE=&gt;&#34;&#34;&#41;&#39; shall be a suggested way to dispose the code and well documented. &#39;set&#39; command is an exception and to be documented. Of course there are other exceptions to be found out. The flag SAVENOCODE might be better documented in POD too.

SJ
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1794139" href="/Public/Bug/Display.html?id=125472#txn-1794139">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;03&nbsp;10:23:45&nbsp;2018</span>
    <span class="description">sjaluo [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> tcltk [...] perl.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1794139/964914/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/964914">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 755b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">VKON wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I agree with all points.
&gt; 
&gt; yet, I think that too careful track on coderefs could result in even
&gt; more memory leaks, not only will grow allocated numbers of CODE
&gt; references, but also grow hash which tracks them.
&gt; 
&gt; IMO the best solution to the problem - is documenting it better;
&gt; 
&gt; if the problem hurts user - she can elaborate another way in her code,
&gt; change &#34;-command=&gt;sub{}&#34; to &#34;-command=&gt;&#39;tclsub&#39;&#34;, where &#39;tclsub&#39; will
&gt; handle all the job;
&gt; 
&gt; maybe warn user in case of 100 allocated coderefs;
&gt; 
&gt; IDK. we could solve this problem by just ignoring its existence :&#41;:&#41;
</div>
Yes, I think it&#39;s a good idea to get user warned; but I prefer only on &#39;use warnings;&#39; specified and criterion to be over 1000 allocated coderefs.

SJ
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1794162" href="/Public/Bug/Display.html?id=125472#txn-1794162">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;03&nbsp;13:27:56&nbsp;2018</span>
    <span class="description">huck [...] finn.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> tcltk [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #125472] error with coderefs passes as scalar args</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 03 Jul 2018 12:27:36 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> huck &lt;huck [...] finn.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1794162/964926/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/964926">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">At 03:07 AM 7/3/2018, you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125472">https://rt.cpan.org/Ticket/Display.html?id=125472</a></span> &gt;
&gt;
&gt;we very much appreciate the effort;
&gt;
&gt;unclear for me - why $sub1 and $sub2 will have same slot for this statement,
&gt;$interp-&gt;call&#40;&#39;if,&#39;1&#39;,$sub1,$sub2&#41;;
&gt;
&gt;there is:
&gt;...
&gt;# stringify sub, becomes &#34;CODE&#40;0x######&#41;&#34; in ::perl namespace
&gt;
&gt;so $sub1 and $sub2 will recieve different slots in %anon_refs hash
</div>

in the v1.05 code
$current_r will be set once at the top of the loop by
   my $current_r = join &#39; &#39;, grep {defined} grep {!ref} @args;
so it will be &#39;if 1&#39;
and is passed into create_tcl_sub&#40;&#41; in the 4th parm where it becomes $rname
and $anon_refs gets set with
   $anon_refs{$rname} = bless [\$sub, $interp], &#39;Tcl::Code&#39;;
so both calls get sequentially created into the same $anon_refs slot 
$anon_refs{&#39;if 1&#39;}
And before the second gets assigned Tcl::Code::DESTROY is triggered 
on the first.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;all in all, if you&#39;ll find a correct solution - nice. if isn&#39;t - 
&gt;also not bad. for mee, we already have too much code for the case, 
&gt;which I would prefer to be simplier.
</div>
This kind of reference tracking is never simple, i have tried to keep 
it as simple as it needs to be.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;also, what a need for
&gt;sub _anon_refs_cheat { return \%anon_refs;}
&gt;
&gt;?
</div>
it serves to expose %anon_refs to external programs so they can test what has
been done to it by the process in the module. I often do this to be 
able to test that things are working right without having to add 
other exposing code to the primary module.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;can we switch to mailing list?
</div>
i think i got subscribed, so this is cc&#39;d to the list.

for those first seeing this on the list there is historical background at
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=125472">https://rt.cpan.org/Public/Bug/Display.html?id=125472</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1794171" href="/Public/Bug/Display.html?id=125472#txn-1794171">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;03&nbsp;15:03:06&nbsp;2018</span>
    <span class="description">huck [...] finn.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> tcltk [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #125472] error with coderefs passes as scalar args</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 03 Jul 2018 14:02:42 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> huck &lt;huck [...] finn.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1794171/964933/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/964933">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 9.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Also cc&#39;d  to tcltk@perl.org 
<span class="clickylink"><a target="new" rel="nofollow" href="https://www.nntp.perl.org/group/perl.tcltk/2018/07/msg718.html">https://www.nntp.perl.org/group/perl.tcltk/2018/07/msg718.html</a></span>
per Vadim&#39;s request


At 09:07 AM 7/3/2018, you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125472">https://rt.cpan.org/Ticket/Display.html?id=125472</a></span> &gt;
&gt;
&gt;
&gt;Thank you for the prompt and detailed response.
&gt;
<div class="message-stanza open">&gt; &gt; I added comments to the tests i added to t/ to document the problems
&gt; &gt; i noticed with the v1.05 process that you may find helpful to read.
&gt; &gt;
&gt; &gt; I found that others were already using the create_tcl_sub&#40;&#41; entry
&gt; &gt; even though it was not documented. And i found that the description
&gt; &gt; of CreateCommnd&#40;&#41; to be confusing to me as well.
</div>&gt;
&gt;I think someone uses the internal function does not necessary mean 
&gt;that the function has to be exposed by document. The difference is: 
&gt;If a module user uses undocumented internal function, he/she takes 
&gt;the risk of function robustness and compatibility on module 
&gt;revision. On the other hand, if a module document a function as an 
&gt;API, the module shall take response that both interface and behavior 
&gt;should not change in the future.
</div>

I agree that documented interfaces should continue to work as 
documented, but that does not mean they must stay static, it just 
means they should not bust any pervious uses.

After looking at tcl.pm/.xs it was clear to me that create_tcl_sub&#40;&#41; 
should be the preferred method for introducing code to tcl because 
CreateCommand&#40;&#41; was so vaguely documented and its arguments are very 
specific to the tcl interface and can cause bigger problems is used 
improperly.

create_tcl_sub&#40;&#41; takes care of much of the needed background 
processing needed to properly create a tcl&lt;=&gt;perl subroutine such as 
placeing it into the proper namespace and returing the tcl name in 
that namespace. it also populates the tracking structure such that 
further uses of a static coderef will not repopulate the tcl 
subroutine internal reference &#40;in v1.02- and  v1.06+ at least&#41; if it 
is found a second time by call&#40;&#41;.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Since create_tcl_sub&#40;&#41; is what was used in call&#40;&#41;, and that was that
&gt; &gt; pair where the code needed to be patched i thought it made sense to
&gt; &gt; document how create_tcl_sub&#40;&#41; worked and how code disposal worked
&gt; &gt; within it. IMHO it made sense to expose create_tcl_sub&#40;&#41; so that
&gt; &gt; programmers could use the automatic recoding of a call&#40;,,$coderef&#41;
&gt; &gt; process as well as being able to control when code disposal took
&gt; &gt; place if they wanted to handle it themselves. This allows them to
&gt; &gt; continue to use coderefs if they want and just delete one use by
&gt; &gt; using DESCRNAME, or all clear it totally by using TCLNAME.
</div>&gt;
&gt;Yes, it makes sense to document how internal mechanism works, but 
&gt;again it does not mean create_tcl_sub&#40;&#41; has to be documented so 
&gt;detail and as a part of API.
&gt;
<div class="message-stanza open">&gt; &gt; I think i made it clear that the user supplied DESCRNAME can be
&gt; &gt; anything they want it to be, as long as it does not begin with &#39;=&#39;
&gt; &gt; or &#39;@&#39;, or &#39;::perl::&#39;.
&gt; &gt; &#39;=&#39; now prefaces &#34;normal&#34; entries created by create_tcl_sub&#40;&#41;.
&gt; &gt; &#39;@&#39; prefaces entries create_tcl_sub&#40;&#41; will use to possibly dispose of
&gt; &gt; coderefs &#34;AT&#34; a future time since they were used by an after command.
&gt; &gt; and &#39;::perl::&#39; prefaces the TCLNAME assigned by create_tcl_sub&#40;&#41; and
&gt; &gt; is used in anon_refs{} to determine when no more &#34;users&#34; exist and
&gt; &gt; the coderef can now be safely deleted from the tcl namespace.
</div>&gt;
&gt;Okay, I finally get the the point of DESCRNAME usage now. I did not 
&gt;know that DESCRNAME can be passed to _code_dispose&#40;&#41; so I did not 
&gt;get the purpose of DESCRNAME at all. I suggest to have more explicit 
&gt;description that argument of _code_dispose&#40;&#41; is either TCLNAME or 
&gt;DESCRNAME. And the major purpose of DESCRNAME is used to pass to 
&gt;_code_disposal&#40;&#41;.
&gt;I get your point more, but I still think we shall properly define 
&gt;the interface to support code disposal instead of just directly 
&gt;expose an internal function out. For example, how about modify 
&gt;call&#40;&#41; to support the form of call&#40;DESCRNAME, cmd, arg ...&#41;, where 
&gt;DESCRNAME is optional and is a string that with &#39;@&#39; prefix. Then we 
&gt;have a good compatibility and user do not have to worry about 
&gt;GENCODE, EVENTS etc.
</div>

The main purpose of DESCRNAME is to name the slot used in $anon_refs 
to store information about the tcl&lt;=&gt;perl subroutine linkage and 
track it. Just one of the purposes of tracking is to be able to 
dispose of it later.

I do not understand why you mean to accomplish by modifying call&#40;&#41; 
that way, how would call understand that it is a descrname and not a tcl verb?

The @ prefix was selected to identify a group of coderefs that 
might  be able to be deleted by a call&#40;&#41; generated &#34;after&#34; call to 
_code_dispose once the initiating &#34;after&#34; call has completed.  For 
the most part $anon_refs keys beginning with &#39;@&#34; should be very short 
lived transients. I think adding another use for the &#39;@&#39; prefix would 
be counterproductive. And a call&#40;&#41; can also have more than one 
coderef in its args as call&#40;&#39;if&#39;,&#39;1&#39;,$sub1,$sub2&#41; illustrates.

The documentation for Tcl::_code_destroy&#40;NAME&#41; already states
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt;calling _code_destroy on a TCLNAME retruned from create_tcl_sub 
</div>removes all use instances and purges the command table.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt;calling _code_destroy on a DESCRNAME passed to create_tcl_sub 
</div>removes only that instace
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt;Code used in a DESCRNAME may be used in other places as well,
 &gt;only when the last usage is purged does the entry get purged from 
</div>the command table

I think that is a pretty good description of its modes, but if you 
can suggest a better description you are free to have a go at it.

I can understand why you think that EVENTS should be hidden better, 
and then GENCODE as well, but both of them were well integrated into 
the existing code and i did not want to break that.  I can also see 
cases where a user may want to use the EVENTS parm tho, and in that 
case they would want both the TCLNAME and GENCODE returned, so i 
introduced a change to what was returned to allow for that. Existing 
code expecting a scalar to be returned still gets GENCODE as it did 
before, but new code expecting an array can get both of them.  And 
uless EVENTS was populated both are the same anyway.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; 2&#41; The newest POD in github HEAD mentioned
&gt; &gt; &gt;
&gt; &gt; &gt; $interp-&gt;call&#40;&#39;fileevent&#39;,&#39;sock9827430&#39;,&#39;writable&#39;&#41;;
&gt; &gt; &gt;
&gt; &gt; &gt; won&#39;t dispose the sub created from
&gt; &gt; &gt;
&gt; &gt; &gt; $interp-&gt;call&#40;&#39;fileevent&#39;,&#39;sock9827430&#39;, &#39;writable&#39;=&gt;sub{...}&#41;;
&gt; &gt; &gt;
&gt; &gt; &gt; is it still true? Or only &#39;set&#39; command behaves in this way?
</div>&gt; &gt;
&gt; &gt; yes this is still true, it was true in v1.02 and v1.05 and reverted
&gt; &gt; back to that behavior in v1.11. at v1.06 i had tried to make it so
&gt; &gt; the first call would cause code disposal of the sub created by the
&gt; &gt; second, but that was what broke your &#34;set foo&#34; tests. At the time i
&gt; &gt; introduced that behavior i thought it made sense to try to initiate
&gt; &gt; code disposal in those cases, to keep the internal table and tcl
&gt; &gt; namespace clean, but after spending some time trying to decide if
&gt; &gt; &#34;set foo&#34; was the only place this should be avoided i decided that
&gt; &gt; it was safer to revert to the original processing where code
&gt; &gt; disposal would only be triggered if there was a different coderef in
&gt; &gt; the new call. but not when the coderef was now missing.
&gt; &gt;
&gt; &gt; I wrapped the place where it occurs with a flag so it could be
&gt; &gt; reinstated if desired when it was determined that only &#34;set foo&#34;
&gt; &gt; should be handled in this special manner
</div>&gt;
&gt;Too bad that it is disabled by default. IMO 
&gt;&#39;$interp-&gt;call&#40;&#34;FILEEVENT&#34; ... &#34;WRITABLE=&gt;&#34;&#34;&#41;&#39; shall be a suggested 
&gt;way to dispose the code and well documented. &#39;set&#39; command is an 
&gt;exception and to be documented. Of course there are other exceptions 
&gt;to be found out. The flag SAVENOCODE might be better documented in POD too.
</div>
i did not document SAVENOCODE nor SAVEALLCODES because i feel both to 
be transient flags destined to be deleted when the tcl.pm code is solidified.

both serve to temporarily encapsulate code i felt to be useful but 
might not deserve to be in the final code, and allow the encapsulated 
code to be toggled on/off to see how it works in different 
situations.  If you look at where both are used i think you will find 
that i did document what i was trying to do when i introduced the 
code they encapsulate. Again if you think you can explain it better 
please feel free to do so.

i am not a fan of  &#34;Of course there are other exceptions to be found 
out.&#34; methods. It disgusted me greatly that my introduction of the 
code to deal with &#39;$interp-&gt;call&#40;&#34;FILEEVENT&#34; ... &#34;WRITABLE=&gt;&#34;&#34;&#41;&#39; &#40;or 
its bind cousins&#41; busted the &#34;set  foo&#34;  test in Tkx.pm.  I hate to 
bust existing working code and feel it diminishes my reputation as a 
responsible programmer when i do so.

I would rather shut it off for now, reverting to the existing process 
in v1.02/v1.05 than to play catchup to bug reports stating it busted 
something else. I have been thru much of the tcl/tk documentation 
looking for other cases the newer behavior may also break but so far 
have only identified the &#34;set foo&#34; instance, but that does not mean 
no other cases still exist and would rather revert to the previous 
behavior until i can be assured that the &#34;set foo&#34; instance is the 
only one to be exempted rather than bust someone elses code and 
require them to figure out how to file a bug report about it.   When 
we are assured that the code will do what we want it is a simple 
matter to remove the encapsulation and delete the transient flags.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;SJ
</div>
This new code disposal process is opening a can of worms, but that 
does not mean it cannot be accomplished successfully. As i was 
working on the reference counting i imagined inserting a new code 
disposal method that could clean up after a deleted tk element, 
searching the keys of %anon_refs for  keys prefixed with &#39;=&#39; 
&#40;internally generated&#41;  and tracking button/bind/menu objects related 
to a element name specified as a parameter. It could then dispose of 
them in the normal method, freeing any that are no longer referenced. 
while i did not think i should being this up until the code disposal 
code has stabilized more, i think now is not a bad time to mention it 
as it serves to solidify the direction i think code_disposal should 
proceed in.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1794181" href="/Public/Bug/Display.html?id=125472#txn-1794181">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;03&nbsp;15:21:40&nbsp;2018</span>
    <span class="description">huck [...] finn.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> tcltk [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #125472] error with coderefs passes as scalar args</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 03 Jul 2018 14:21:20 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> huck &lt;huck [...] finn.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1794181/964940/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/964940">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Also cc&#39;d  to tcltk@perl.org 
<span class="clickylink"><a target="new" rel="nofollow" href="https://www.nntp.perl.org/group/perl.tcltk/2018/07/msg718.html">https://www.nntp.perl.org/group/perl.tcltk/2018/07/msg718.html</a></span>
per Vadim&#39;s request

At 09:23 AM 7/3/2018, you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125472">https://rt.cpan.org/Ticket/Display.html?id=125472</a></span> &gt;
&gt;
&gt;VKON wrote:
&gt;
<div class="message-stanza open">&gt; &gt; I agree with all points.
&gt; &gt;
&gt; &gt; yet, I think that too careful track on coderefs could result in even
&gt; &gt; more memory leaks, not only will grow allocated numbers of CODE
&gt; &gt; references, but also grow hash which tracks them.
&gt; &gt;
&gt; &gt; IMO the best solution to the problem - is documenting it better;
&gt; &gt;
&gt; &gt; if the problem hurts user - she can elaborate another way in her code,
&gt; &gt; change &#34;-command=&gt;sub{}&#34; to &#34;-command=&gt;&#39;tclsub&#39;&#34;, where &#39;tclsub&#39; will
&gt; &gt; handle all the job;
&gt; &gt;
&gt; &gt; maybe warn user in case of 100 allocated coderefs;
&gt; &gt;
&gt; &gt; IDK. we could solve this problem by just ignoring its existence :&#41;:&#41;
</div>&gt;
&gt;Yes, I think it&#39;s a good idea to get user warned; but I prefer only 
&gt;on &#39;use warnings;&#39; specified and criterion to be over 1000 allocated coderefs.
&gt;
&gt;SJ
</div>
I think it is important to discriminate between the end user of a 
tck/tk application and the programmer of that application. What would 
an end user think if he started getting flooded with warnings for a 
existing application they use that they cannot control, that only the 
application developer can modify.

I too think that 100 is too small a threshold. I have a tkx 
application that provides me buttons to run programs via a deamon 
running on other boxes. There are 50 buttons for just one of the 
boxes, and that means 50 menu entries as well. There are 6 other 
boxes that can be selected &#40;the buttons panel and menu gets recreated 
when switched&#41; and they too have dozens of buttons and menu items. I 
am working on using code disposal to keep $anon_refs clean in this 
application but under v1.02.v1.05 rules of no disposal i could easily 
generate hundreds of entries to $anon_refs just by cycling thru the 
different boxes. Each time a button/menu is activated it creates a 
new toplevel window where the output results of the command executed 
on the other box gets displayed, and each of these toplevel windows 
has its own menu as well.  I used to keep this application open for 
weeks at a time, but lately only open and close it as needed to 
reclaim desktop and task bar space.

To tell you the truth, under v1.02 i did not see a performance 
penalty to introducing all these entries to $anon_refs and the 
tcl&lt;=&gt;perl command table. This leads me to believe that 100 may be 
way to small and even 1000 might be as well.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1794539" href="/Public/Bug/Display.html?id=125472#txn-1794539">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;06&nbsp;16:41:53&nbsp;2018</span>
    <span class="description">Vadim.Konovalov [...] dell.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &#34;tcltk [...] perl.org&#34; &lt;tcltk [...] perl.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #125472] error with coderefs passes as scalar args</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 6 Jul 2018 20:39:57 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> huck &lt;huck [...] finn.com&gt;, &#34;bug-Tcl [...] rt.cpan.org&#34; &lt;bug-Tcl [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Konovalov, Vadim&#34; &lt;Vadim.Konovalov [...] dell.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1794539/965121/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/965121">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Also cc&#39;d  to
&gt; tcltk@perl.org
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://www.nntp.perl.org/group/perl.tcltk/2018/07/msg718.html">https://www.nntp.perl.org/group/perl.tcltk/2018/07/msg718.html</a></span>
&gt; per Vadim&#39;s request
</div>
Thanks
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think it is important to discriminate between the end user of a tck/tk
&gt; application and the programmer of that application. What would an end user
&gt; think if he started getting flooded with warnings for a existing application
&gt; they use that they cannot control, that only the application developer can
&gt; modify.
</div>
Correct; the only good solution is to have correct implementation of refs disposal;
BTW perl/Tk happen to have this problem solved; Tcl.pm having some difficulties 
due to different approach on the problem. 


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I too think that 100 is too small a threshold. I have a
&gt; ....
&gt; To tell you the
&gt; truth, under v1.02 i did not see a performance penalty to introducing all these
&gt; entries to $anon_refs and the tcl&lt;=&gt;perl command table. This leads me to
&gt; believe that 100 may be way to small and even 1000 might be as well.
</div>
Any number will do! :&#41;

BTW are you aware that, in terms of performance, this:

 sub WIDGET_CLEANUP&#40;&#41; {0}
    if &#40;WIDGET_CLEANUP&#41; {
   ...
is much better than this:

our $SAVEALLCODES;         # ...
...
    if &#40;$SAVEALLCODES&#41; {
...

It&#39;s OK for development, but rather significant for release;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1794594" href="/Public/Bug/Display.html?id=125472#txn-1794594">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;07&nbsp;02:46:20&nbsp;2018</span>
    <span class="description">sjaluo [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> tcltk [...] perl.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1794594/965151/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/965151">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 10.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I think someone uses the internal function does not necessary mean
&gt; &gt; that the function has to be exposed by document. The difference is:
&gt; &gt; If a module user uses undocumented internal function, he/she takes
&gt; &gt; the risk of function robustness and compatibility on module
&gt; &gt; revision. On the other hand, if a module document a function as an
&gt; &gt; API, the module shall take response that both interface and behavior
&gt; &gt; should not change in the future.
</div>&gt;
&gt; I agree that documented interfaces should continue to work as
&gt; documented, but that does not mean they must stay static, it just
&gt; means they should not bust any pervious uses.
</div>
Yes. But any change has possibility to bust previous uses. The more unnecessary internal function exposing, the more compatibility issue have to be considered and the more easily to bust existing use.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; After looking at tcl.pm/.xs it was clear to me that create_tcl_sub&#40;&#41;
&gt; should be the preferred method for introducing code to tcl because
&gt; CreateCommand&#40;&#41; was so vaguely documented and its arguments are very
&gt; specific to the tcl interface and can cause bigger problems is used
&gt; improperly.
&gt;
&gt; create_tcl_sub&#40;&#41; takes care of much of the needed background
&gt; processing needed to properly create a tcl&lt;=&gt;perl subroutine such as
&gt; placeing it into the proper namespace and returing the tcl name in
&gt; that namespace. it also populates the tracking structure such that
&gt; further uses of a static coderef will not repopulate the tcl
&gt; subroutine internal reference &#40;in v1.02- and v1.06+ at least&#41; if it
&gt; is found a second time by call&#40;&#41;.
</div>
Well I don&#39;t think CreateCommand&#40;&#41; document vague: CLIENTDATA is just any user private data to be pass to the callback function. DELETEPROC is served as the destructor function that is to be called when DeleteCommand&#40;&#41; applied to the  created tcl command. They are optional it&#39;s no harm to set them undef if you do not know what it is.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; I think i made it clear that the user supplied DESCRNAME can be
&gt; &gt; &gt; anything they want it to be, as long as it does not begin with &#39;=&#39;
&gt; &gt; &gt; or &#39;@&#39;, or &#39;::perl::&#39;.
&gt; &gt; &gt; &#39;=&#39; now prefaces &#34;normal&#34; entries created by create_tcl_sub&#40;&#41;.
&gt; &gt; &gt; &#39;@&#39; prefaces entries create_tcl_sub&#40;&#41; will use to possibly dispose
&gt; &gt; &gt; of
&gt; &gt; &gt; coderefs &#34;AT&#34; a future time since they were used by an after
&gt; &gt; &gt; command.
&gt; &gt; &gt; and &#39;::perl::&#39; prefaces the TCLNAME assigned by create_tcl_sub&#40;&#41;
&gt; &gt; &gt; and
&gt; &gt; &gt; is used in anon_refs{} to determine when no more &#34;users&#34; exist and
&gt; &gt; &gt; the coderef can now be safely deleted from the tcl namespace.
</div>&gt; &gt;
&gt; &gt; Okay, I finally get the the point of DESCRNAME usage now. I did not
&gt; &gt; know that DESCRNAME can be passed to _code_dispose&#40;&#41; so I did not
&gt; &gt; get the purpose of DESCRNAME at all. I suggest to have more explicit
&gt; &gt; description that argument of _code_dispose&#40;&#41; is either TCLNAME or
&gt; &gt; DESCRNAME. And the major purpose of DESCRNAME is used to pass to
&gt; &gt; _code_disposal&#40;&#41;.
&gt; &gt; I get your point more, but I still think we shall properly define
&gt; &gt; the interface to support code disposal instead of just directly
&gt; &gt; expose an internal function out. For example, how about modify
&gt; &gt; call&#40;&#41; to support the form of call&#40;DESCRNAME, cmd, arg ...&#41;, where
&gt; &gt; DESCRNAME is optional and is a string that with &#39;@&#39; prefix. Then we
&gt; &gt; have a good compatibility and user do not have to worry about
&gt; &gt; GENCODE, EVENTS etc.
</div>&gt;
&gt;
&gt; The main purpose of DESCRNAME is to name the slot used in $anon_refs
&gt; to store information about the tcl&lt;=&gt;perl subroutine linkage and
&gt; track it. Just one of the purposes of tracking is to be able to
&gt; dispose of it later.
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I do not understand why you mean to accomplish by modifying call&#40;&#41;
&gt; that way, how would call understand that it is a descrname and not a
&gt; tcl verb?
&gt;
&gt; The @ prefix was selected to identify a group of coderefs that
&gt; might be able to be deleted by a call&#40;&#41; generated &#34;after&#34; call to
&gt; _code_dispose once the initiating &#34;after&#34; call has completed. For
&gt; the most part $anon_refs keys beginning with &#39;@&#34; should be very short
&gt; lived transients. I think adding another use for the &#39;@&#39; prefix would
&gt; be counterproductive. And a call&#40;&#41; can also have more than one
&gt; coderef in its args as call&#40;&#39;if&#39;,&#39;1&#39;,$sub1,$sub2&#41; illustrates.
</div>
My idea is to apply a prefix to identify if first argument of call&#40;&#41; is a DESCRNAME. If the first arg call&#40;&#41; is &#39;%&#39; , then it is a DESCRNAME. &#40;Let&#39;s forget previous AT sign &#39;@&#39; example, which might confuse you&#41;. Otherwise the first arg is a tcl verb. For example the following code:

call&#40;&#39;%button1&#39;, ..., $sub1, sub{}&#41;
call&#40;&#39;%button1&#39;, ..., $sub2, $sub3&#41;
call&#40;&#39;if&#39;, &#39;1&#39;, $sub3&#41;
:
code_dispose&#40;&#39;button1&#39;&#41;;

Then inline sub{}, $sub1 and $sub2 would get disposed while #sub3 is kept. The code looks much cleaner compared to annoying TCLNAME/GENCODE/EVENT dealing and storing. Here one DESCRNAME maps to multiple $subs, which is not allowed in current implementation. Just share an idea for a better disposal interface.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The documentation for Tcl::_code_destroy&#40;NAME&#41; already states
<div class="message-stanza open">&gt; &gt; calling _code_destroy on a TCLNAME retruned from create_tcl_sub
</div>&gt; removes all use instances and purges the command table.
<div class="message-stanza open">&gt; &gt; calling _code_destroy on a DESCRNAME passed to create_tcl_sub
</div>&gt; removes only that instace
<div class="message-stanza open">&gt; &gt; Code used in a DESCRNAME may be used in other places as well,
&gt; &gt; only when the last usage is purged does the entry get purged from
</div>&gt; the command table
&gt;
&gt; I think that is a pretty good description of its modes, but if you
&gt; can suggest a better description you are free to have a go at it.
&gt;
&gt; I can understand why you think that EVENTS should be hidden better,
&gt; and then GENCODE as well, but both of them were well integrated into
&gt; the existing code and i did not want to break that. I can also see
&gt; cases where a user may want to use the EVENTS parm tho, and in that
&gt; case they would want both the TCLNAME and GENCODE returned, so i
&gt; introduced a change to what was returned to allow for that. Existing
&gt; code expecting a scalar to be returned still gets GENCODE as it did
&gt; before, but new code expecting an array can get both of them. And
&gt; uless EVENTS was populated both are the same anyway.
&gt;
</div>
Yes, I think it is weird to return twin variable TCLNAME/GENCODE. They are mostly the same thing and I need two variables to store them. As a user, I&#39;d like such function just return one thing/object that can be pass to both call&#40;&#41; and _code_dispose&#40;&#41;. EVENT is also a stuff that should not be worried by user: we are already familiar with Tk::Ev&#40;&#41; and it is also weird to provide yet another variable/argument serving the same purpose.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; 2&#41; The newest POD in github HEAD mentioned
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; $interp-&gt;call&#40;&#39;fileevent&#39;,&#39;sock9827430&#39;,&#39;writable&#39;&#41;;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; won&#39;t dispose the sub created from
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; $interp-&gt;call&#40;&#39;fileevent&#39;,&#39;sock9827430&#39;, &#39;writable&#39;=&gt;sub{...}&#41;;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; is it still true? Or only &#39;set&#39; command behaves in this way?
</div>&gt; &gt; &gt;
&gt; &gt; &gt; yes this is still true, it was true in v1.02 and v1.05 and reverted
&gt; &gt; &gt; back to that behavior in v1.11. at v1.06 i had tried to make it so
&gt; &gt; &gt; the first call would cause code disposal of the sub created by the
&gt; &gt; &gt; second, but that was what broke your &#34;set foo&#34; tests. At the time i
&gt; &gt; &gt; introduced that behavior i thought it made sense to try to initiate
&gt; &gt; &gt; code disposal in those cases, to keep the internal table and tcl
&gt; &gt; &gt; namespace clean, but after spending some time trying to decide if
&gt; &gt; &gt; &#34;set foo&#34; was the only place this should be avoided i decided that
&gt; &gt; &gt; it was safer to revert to the original processing where code
&gt; &gt; &gt; disposal would only be triggered if there was a different coderef
&gt; &gt; &gt; in
&gt; &gt; &gt; the new call. but not when the coderef was now missing.
&gt; &gt; &gt;
&gt; &gt; &gt; I wrapped the place where it occurs with a flag so it could be
&gt; &gt; &gt; reinstated if desired when it was determined that only &#34;set foo&#34;
&gt; &gt; &gt; should be handled in this special manner
</div>&gt; &gt;
&gt; &gt; Too bad that it is disabled by default. IMO
&gt; &gt; &#39;$interp-&gt;call&#40;&#34;FILEEVENT&#34; ... &#34;WRITABLE=&gt;&#34;&#34;&#41;&#39; shall be a suggested
&gt; &gt; way to dispose the code and well documented. &#39;set&#39; command is an
&gt; &gt; exception and to be documented. Of course there are other exceptions
&gt; &gt; to be found out. The flag SAVENOCODE might be better documented in
&gt; &gt; POD too.
</div>&gt;
&gt; i did not document SAVENOCODE nor SAVEALLCODES because i feel both to
&gt; be transient flags destined to be deleted when the tcl.pm code is
&gt; solidified.
&gt;
&gt; both serve to temporarily encapsulate code i felt to be useful but
&gt; might not deserve to be in the final code, and allow the encapsulated
&gt; code to be toggled on/off to see how it works in different
&gt; situations. If you look at where both are used i think you will find
&gt; that i did document what i was trying to do when i introduced the
&gt; code they encapsulate. Again if you think you can explain it better
&gt; please feel free to do so.
&gt;
&gt; i am not a fan of &#34;Of course there are other exceptions to be found
&gt; out.&#34; methods. It disgusted me greatly that my introduction of the
&gt; code to deal with &#39;$interp-&gt;call&#40;&#34;FILEEVENT&#34; ... &#34;WRITABLE=&gt;&#34;&#34;&#41;&#39; &#40;or
&gt; its bind cousins&#41; busted the &#34;set foo&#34; test in Tkx.pm. I hate to
&gt; bust existing working code and feel it diminishes my reputation as a
&gt; responsible programmer when i do so.
&gt;
&gt; I would rather shut it off for now, reverting to the existing process
&gt; in v1.02/v1.05 than to play catchup to bug reports stating it busted
&gt; something else. I have been thru much of the tcl/tk documentation
&gt; looking for other cases the newer behavior may also break but so far
&gt; have only identified the &#34;set foo&#34; instance, but that does not mean
&gt; no other cases still exist and would rather revert to the previous
&gt; behavior until i can be assured that the &#34;set foo&#34; instance is the
&gt; only one to be exempted rather than bust someone elses code and
&gt; require them to figure out how to file a bug report about it. When
&gt; we are assured that the code will do what we want it is a simple
&gt; matter to remove the encapsulation and delete the transient flags.
&gt;
&gt;
&gt; This new code disposal process is opening a can of worms, but that
&gt; does not mean it cannot be accomplished successfully. As i was
&gt; working on the reference counting i imagined inserting a new code
&gt; disposal method that could clean up after a deleted tk element,
&gt; searching the keys of %anon_refs for keys prefixed with &#39;=&#39;
&gt; &#40;internally generated&#41; and tracking button/bind/menu objects related
&gt; to a element name specified as a parameter. It could then dispose of
&gt; them in the normal method, freeing any that are no longer referenced.
&gt; while i did not think i should being this up until the code disposal
&gt; code has stabilized more, i think now is not a bad time to mention it
&gt; as it serves to solidify the direction i think code_disposal should
&gt; proceed in.
</div>
BTW, I found _code_dispose&#40;&#41; has to be called in the form &#39;Tcl::_code_dispose&#40;...&#41;&#39; rather than &#39;$interp-&gt;_code_dispose&#40;...&#41;&#39;. It is documented, but it is counter-intuitive. Programmers can hardly find their incorrect calling via $interp object. I suggest to check input parameter and provide some warning at least.  IMO, %anon_refs{} would be better an object instance variable instead of global one.  

SJ
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1794615" href="/Public/Bug/Display.html?id=125472#txn-1794615">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;07&nbsp;10:46:48&nbsp;2018</span>
    <span class="description">huck [...] finn.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> tcltk [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #125472] error with coderefs passes as scalar args</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 07 Jul 2018 09:46:24 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> huck &lt;huck [...] finn.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1794615/965164/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/965164">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 17.7k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1795940" href="/Public/Bug/Display.html?id=125472#txn-1795940">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;13&nbsp;21:50:23&nbsp;2018</span>
    <span class="description">sjaluo [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> tcltk [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #125472] error with coderefs passes as scalar args</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 14 Jul 2018 09:49:55 +0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;S.J. Luo&#34; &lt;sjaluo [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1795940/965833/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/965833">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 5.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">2018-07-07 22:46 GMT+08:00 huck :

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; Yes, as we saw when code disposal was introduced , even existing
&gt; applications can be ruined if care is not properly taken.  Maybe if
&gt; create_tcl_sub&#40;&#41; had been documented as part of the api this problem would
&gt; not have been created in the first place.
&gt;
</div>
I think it had not been because create_tcl_sub&#40;&#41; was created for
internal use only and not intended to be an API.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
<div class="message-stanza open">&gt;&gt;
&gt;&gt; My idea is to apply a prefix to identify if first argument of call&#40;&#41; is a
&gt;&gt; DESCRNAME. If the first arg call&#40;&#41; is &#39;%&#39; , then it is a DESCRNAME. &#40;Let&#39;s
&gt;&gt; forget previous AT sign &#39;@&#39; example, which might confuse you&#41;. Otherwise the
&gt;&gt; first arg is a tcl verb. For example the following code:
&gt;&gt;
&gt;&gt; call&#40;&#39;%button1&#39;, ..., $sub1, sub{}&#41;
&gt;&gt; call&#40;&#39;%button1&#39;, ..., $sub2, $sub3&#41;
&gt;&gt; call&#40;&#39;if&#39;, &#39;1&#39;, $sub3&#41;
&gt;&gt; :
&gt;&gt; code_dispose&#40;&#39;button1&#39;&#41;;
&gt;&gt;
&gt;&gt; Then inline sub{}, $sub1 and $sub2 would get disposed while #sub3 is kept.
&gt;&gt; The code looks much cleaner compared to annoying TCLNAME/GENCODE/EVENT
&gt;&gt; dealing and storing. Here one DESCRNAME maps to multiple $subs, which is not
&gt;&gt; allowed in current implementation. Just share an idea for a better disposal
&gt;&gt; interface.
</div>&gt;
&gt;
&gt;
&gt; And how would you implement this via Tkx?
&gt; for instance how do you modify a $menu&gt;add_command&#40;%args&#41;; call?
&gt; or $button =$in-&gt;new_ttk__button&#40;-text=&gt;$args{text}, -command=&gt;$args{sub} &#41;;
&gt;
</div>
   It&#39;s not for Tkx user. It&#39;s for Tcl user &#40;such as Tkx&#41;. Tkx can
associate a unique DESCRNAME &#39;menu1&#39; with an object $menu and call
code_dispose&#40;&#39;menu1&#39;&#41; on destroyer of $button1.

   In previous example, $sub1, inline sub{}, $sub2 get disposed when
code_dispose&#40;&#39;button1&#39;&#41; is called. They get disposed because they are
associated with DESCRNAME &#39;button1&#39; via call&#40;&#39;%button1&#39;&#41;. $sub3 is
also associated with &#39;button1&#39;, it does not get disposed because it
has also been call&#40;&#41;&#39;ed once without DESCRNAME.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; like you said before if you dont know what to do with EVENT it can be
&gt; defined as undef, and then TCLNAME is the same as GENCODE &#40;as the doc says&#41;
&gt; and only that one item needs to be saved, just like you need to save the
&gt; CMDNAME passed to CreateCommand &#40;&#41;
&gt;
&gt; Changing the existing and working interface to call&#40;&#41; seems to be much more
&gt; error prone than documenting the interface to create_tcl_sub&#40;&#41;, just making
&gt; things more complex.
&gt;
&gt; As i already mentioned by using create_tcl_sub&#40;&#41; to manage code disposal, i
&gt; can just add one call to create_tcl_sub&#40;&#41; to lock down a sub from code
&gt; disposal, and add another call to _code_destroy&#40;&#41; when i want to release
&gt; that coderef.  Your proposed method requires every call with a coderef to be
&gt; modified which was one thing i was trying to avoid.
&gt;
&gt; And you say &#34;would get disposed&#34;, but when?  the only time code may get
&gt; automagicly disposed is when something has the same DESCRNAME, but here you
&gt; propose allowing DESCRNAME ot have the same value over multiple calls, are
&gt; you proposing that inside the second call  $sub1 and  sub{}&#41; get disposed?
&gt; or are you proposing that $sub3 gets added to that list for disposal later?
&gt;
&gt; And a DESCRNAME can have more than one sub attached to it since v1.06  What
&gt; it is is that when the same DESCRNAME is seen again, the prior code calls
&gt; are now eligible for code destruction. One change i made is to delay code
&gt; destuction untill after the entire command is parsed, so as not to have to
&gt; destroy/recreate a coderef that already exists in both the current and the
&gt; prior call with the same DESCRNAME This wasnt a problem at v1.02 because
&gt; %anon_refs was only assigned to if the TCLNAME did not exist already
&gt;
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; BTW, I found _code_dispose&#40;&#41; has to be called in the form
&gt;&gt; &#39;Tcl::_code_dispose&#40;...&#41;&#39; rather than &#39;$interp-&gt;_code_dispose&#40;...&#41;&#39;. It is
&gt;&gt; documented, but it is counter-intuitive. Programmers can hardly find their
&gt;&gt; incorrect calling via $interp object. I suggest to check input parameter and
&gt;&gt; provide some warning at least.  IMO, %anon_refs{} would be better an object
&gt;&gt; instance variable instead of global one.
</div>&gt;
&gt;
&gt;
&gt; but it isnt an object instance now, as far as i can tell never has been, So
&gt; the change you are proposing here is not trivial. What should it be an
&gt; instance of?
&gt;
&gt; While $interp can be considered an object all it is really is a blessed
&gt; scalar.  So where do you propose you store this new object instance? If we
&gt; make $interp be the first key to %anon_refs that will cause a lot of code to
&gt; need to be changed.
&gt;
&gt; And as i pointed out while delete_ref&#40;&#41; is called with an $interp for the
&gt; most part that doesnt matter, since the $interp stored in the Tcl::Code
&gt; object is used for the deletion, and while there could be many different
&gt; interpreters, there is only one %anon_refs, so that on a single TCLNAME can
&gt; exist, there cannot be one for each interpreter.
</div>
   I mean %anon_refs shall be better to be something like
$interp-&gt;{anon_refs}. Different interpreters shall be better have
separated TCLNAME/CMDNAME/DESCRNAME naming space. It does not make
sense that TCLNAME/DESCRNAME have to be unique across different
interpreters.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Again, maybe the solution is to make a RFP asking for input on code
&gt; disposal, what it should do, how it should be called and what modification
&gt; will be needed to existing code. Without that my intentions were to make it
&gt; so existing v1.02 code still worked, and there was a mechanism to control
&gt; code disposal. I think my patches have met both of those goals.  &#40;and as i
&gt; watched code disposal in action i realized it was destroying/recreating tcl
&gt; subs over and over and i wanted to prevent that too&#41;
&gt;
&gt; and i also realized that a deep bug in the xs code was leading to a massive
&gt; memory leak and fixed that as well.
</div>
Yes I believe v1.06 got quite some bugs fixed. Here just some
discussion for any possibility to make interface more clean.

SJ
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1795944" href="/Public/Bug/Display.html?id=125472#txn-1795944">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;14&nbsp;00:43:49&nbsp;2018</span>
    <span class="description">huck [...] finn.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> tcltk [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #125472] error with coderefs passes as scalar args</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 13 Jul 2018 23:43:32 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> huck &lt;huck [...] finn.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1795944/965836/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/965836">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 10.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">At 08:50 PM 7/13/2018, you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125472">https://rt.cpan.org/Ticket/Display.html?id=125472</a></span> &gt;
&gt;
&gt;2018-07-07 22:46 GMT+08:00 huck :
&gt;
<div class="message-stanza open">&gt; &gt;
&gt; &gt; Yes, as we saw when code disposal was introduced , even existing
&gt; &gt; applications can be ruined if care is not properly taken.  Maybe if
&gt; &gt; create_tcl_sub&#40;&#41; had been documented as part of the api this problem would
&gt; &gt; not have been created in the first place.
&gt; &gt;
</div>&gt;
&gt;I think it had not been because create_tcl_sub&#40;&#41; was created for
&gt;internal use only and not intended to be an API.
</div>
Maybe if it had been documented the original code disposal changes 
would not have busted existing programs like they did.

I also find it hard to believe that just because something was one 
designed for internal use it means it can never be exposed as part of the API.

create_tcl_sub&#40;&#41; is now integral to the code disposal changes. It is 
the place that code disposal is now controled. allowing external 
access to it is basically the only way to allow the developer to 
control code disposal.



<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt;
<div class="message-stanza open">&gt; &gt;&gt;
&gt; &gt;&gt; My idea is to apply a prefix to identify if first argument of call&#40;&#41; is a
&gt; &gt;&gt; DESCRNAME. If the first arg call&#40;&#41; is &#39;%&#39; , then it is a DESCRNAME. &#40;Let&#39;s
&gt; &gt;&gt; forget previous AT sign &#39;@&#39; example, which might confuse you&#41;. 
</div></div>&gt; Otherwise the
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt; first arg is a tcl verb. For example the following code:
&gt; &gt;&gt;
&gt; &gt;&gt; call&#40;&#39;%button1&#39;, ..., $sub1, sub{}&#41;
&gt; &gt;&gt; call&#40;&#39;%button1&#39;, ..., $sub2, $sub3&#41;
&gt; &gt;&gt; call&#40;&#39;if&#39;, &#39;1&#39;, $sub3&#41;
&gt; &gt;&gt; :
&gt; &gt;&gt; code_dispose&#40;&#39;button1&#39;&#41;;
&gt; &gt;&gt;
&gt; &gt;&gt; Then inline sub{}, $sub1 and $sub2 would get disposed while #sub3 is kept.
&gt; &gt;&gt; The code looks much cleaner compared to annoying TCLNAME/GENCODE/EVENT
&gt; &gt;&gt; dealing and storing. Here one DESCRNAME maps to multiple $subs, 
</div></div>&gt; which is not
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt; allowed in current implementation. Just share an idea for a 
</div></div>&gt; better disposal
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt; interface.
</div>&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; And how would you implement this via Tkx?
&gt; &gt; for instance how do you modify a $menu&gt;add_command&#40;%args&#41;; call?
&gt; &gt; or $button =$in-&gt;new_ttk__button&#40;-text=&gt;$args{text}, 
</div>&gt; -command=&gt;$args{sub} &#41;;
<div class="message-stanza open">&gt; &gt;
</div>&gt;
&gt;    It&#39;s not for Tkx user. It&#39;s for Tcl user &#40;such as Tkx&#41;. Tkx can
&gt;associate a unique DESCRNAME &#39;menu1&#39; with an object $menu and call
&gt;code_dispose&#40;&#39;menu1&#39;&#41; on destroyer of $button1.
</div>
Ya know i dont care much about the Tcl only user. I use it from Tkx, 
somebody busted tkx. i fixed it. QED.

Who is going to make the changes to Tkx to do this? How do i pass 
this information from my program to tkx to do it?  Right now tkx is a 
simple intercept  interface between perl and ttk. Basically a tkx 
developer does not interface with call&#40;&#41; at all. How do you propose 
they do it under your scenario?

My WORKING solution allows the tkx user to get access to code 
disposal via create_tcl_sub&#40;&#41;. I dont hear any solutions from you , 
just proposals.

And what destroyer of $button1 are you talking about? can you show me 
where Tkx sets up a destroyer for a button? Or are you proposing that 
someone come up with the new code?  Are you going to do it?

tkx just recodes a perl call into the corresponding tk name and calls 
that tk procedure.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;    In previous example, $sub1, inline sub{}, $sub2 get disposed when
&gt;code_dispose&#40;&#39;button1&#39;&#41; is called. They get disposed because they are
&gt;associated with DESCRNAME &#39;button1&#39; via call&#40;&#39;%button1&#39;&#41;. $sub3 is
&gt;also associated with &#39;button1&#39;, it does not get disposed because it
&gt;has also been call&#40;&#41;&#39;ed once without DESCRNAME.
</div>

It is never called without a DESCRNAME, call&#40;&#41; always assigns a 
DESCRNAME when it calls create_tcl_sub&#40;&#41;, i think your proposal to 
add a leading argument to call&#40;&#41;  has not been well thought out yet. 
The arguments to call&#40;&#41;  are very well defined now, they constitute 
the elements of a call to tcl, now you want to majorly modify what 
the arguments are for no good reason i can figure out so far.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; like you said before if you dont know what to do with EVENT it can be
&gt; &gt; defined as undef, and then TCLNAME is the same as GENCODE &#40;as the doc says&#41;
&gt; &gt; and only that one item needs to be saved, just like you need to save the
&gt; &gt; CMDNAME passed to CreateCommand &#40;&#41;
&gt; &gt;
&gt; &gt; Changing the existing and working interface to call&#40;&#41; seems to be much more
&gt; &gt; error prone than documenting the interface to create_tcl_sub&#40;&#41;, just making
&gt; &gt; things more complex.
&gt; &gt;
&gt; &gt; As i already mentioned by using create_tcl_sub&#40;&#41; to manage code disposal, i
&gt; &gt; can just add one call to create_tcl_sub&#40;&#41; to lock down a sub from code
&gt; &gt; disposal, and add another call to _code_destroy&#40;&#41; when i want to release
&gt; &gt; that coderef.  Your proposed method requires every call with a 
</div>&gt; coderef to be
<div class="message-stanza open">&gt; &gt; modified which was one thing i was trying to avoid.
&gt; &gt;
&gt; &gt; And you say &#34;would get disposed&#34;, but when?  the only time code may get
&gt; &gt; automagicly disposed is when something has the same DESCRNAME, but here you
&gt; &gt; propose allowing DESCRNAME ot have the same value over multiple calls, are
&gt; &gt; you proposing that inside the second call  $sub1 and  sub{}&#41; get disposed?
&gt; &gt; or are you proposing that $sub3 gets added to that list for disposal later?
&gt; &gt;
&gt; &gt; And a DESCRNAME can have more than one sub attached to it since v1.06  What
&gt; &gt; it is is that when the same DESCRNAME is seen again, the prior code calls
&gt; &gt; are now eligible for code destruction. One change i made is to delay code
&gt; &gt; destuction untill after the entire command is parsed, so as not to have to
&gt; &gt; destroy/recreate a coderef that already exists in both the current and the
&gt; &gt; prior call with the same DESCRNAME This wasnt a problem at v1.02 because
&gt; &gt; %anon_refs was only assigned to if the TCLNAME did not exist already
&gt; &gt;
</div>&gt;
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt; BTW, I found _code_dispose&#40;&#41; has to be called in the form
&gt; &gt;&gt; &#39;Tcl::_code_dispose&#40;...&#41;&#39; rather than &#39;$interp-&gt;_code_dispose&#40;...&#41;&#39;. It is
&gt; &gt;&gt; documented, but it is counter-intuitive. Programmers can hardly find their
&gt; &gt;&gt; incorrect calling via $interp object. I suggest to check input 
</div></div>&gt; parameter and
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt; provide some warning at least.  IMO, %anon_refs{} would be 
</div></div>&gt; better an object
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt; instance variable instead of global one.
</div>&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; but it isnt an object instance now, as far as i can tell never has been, So
&gt; &gt; the change you are proposing here is not trivial. What should it be an
&gt; &gt; instance of?
&gt; &gt;
&gt; &gt; While $interp can be considered an object all it is really is a blessed
&gt; &gt; scalar.  So where do you propose you store this new object instance? If we
&gt; &gt; make $interp be the first key to %anon_refs that will cause a lot 
</div>&gt; of code to
<div class="message-stanza open">&gt; &gt; need to be changed.
&gt; &gt;
&gt; &gt; And as i pointed out while delete_ref&#40;&#41; is called with an $interp for the
&gt; &gt; most part that doesnt matter, since the $interp stored in the Tcl::Code
&gt; &gt; object is used for the deletion, and while there could be many different
&gt; &gt; interpreters, there is only one %anon_refs, so that on a single TCLNAME can
&gt; &gt; exist, there cannot be one for each interpreter.
</div>&gt;
&gt;    I mean %anon_refs shall be better to be something like
&gt;$interp-&gt;{anon_refs}. Different interpreters shall be better have
&gt;separated TCLNAME/CMDNAME/DESCRNAME naming space. It does not make
&gt;sense that TCLNAME/DESCRNAME have to be unique across different
&gt;interpreters.
</div>
It is not that way now, and as far as i can tell it was never that 
way ever. What you are asking for is not a simple change to make,. it 
changes a lot of things.

   my $inter=Tcl-&gt;new&#40;&#41;; print Dumper&#40;$inter&#41;;
  $VAR1 = bless&#40; do{\&#40;my $o = 149405600&#41;}, &#39;Tcl&#39; &#41;;

there is no place for $interp-&gt;{anon_refs} to live. it is just a 
blessed scalar.

Have you even looked at the code at all yet?


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Again, maybe the solution is to make a RFP asking for input on code
&gt; &gt; disposal, what it should do, how it should be called and what modification
&gt; &gt; will be needed to existing code. Without that my intentions were to make it
&gt; &gt; so existing v1.02 code still worked, and there was a mechanism to control
&gt; &gt; code disposal. I think my patches have met both of those goals.  &#40;and as i
&gt; &gt; watched code disposal in action i realized it was destroying/recreating tcl
&gt; &gt; subs over and over and i wanted to prevent that too&#41;
&gt; &gt;
&gt; &gt; and i also realized that a deep bug in the xs code was leading to a massive
&gt; &gt; memory leak and fixed that as well.
</div>&gt;
&gt;Yes I believe v1.06 got quite some bugs fixed. Here just some
&gt;discussion for any possibility to make interface more clean.
</div>
Yes my fixes have made v1.11 working again. All is working at least 
like it used to and there is elementary code disposal for &#39;after&#39; 
calls like intorduced after v1.02.

All i see is trying to make the interface more complicated, without 
proposing any code changes yourself. You want to change what $inter 
is, from a blessed scalar to a blessed hash. you want to change how 
call&#40;&#41; is defined, yoiu are proposing major changes to tkx.pm that 
will complicate it by introducing some sort of interface between all 
the perl and tcl calls that will create destroyers.

So are you proposing to pay me to do all this or are you going to do 
it yourself?

I think the easiest thing here is for you to make your own branch and 
put in the changes you want, show me the working code that passes all 
the tests. Then explain how it is cleaner, and why it is any better 
than what we have now. I have no desire to do something just because 
you want it done.

I wanted to get my tkx programs working again, i put the time in to 
make it so, and i think i did a much better job than what you have 
proposed so far. It you can do better than go right ahead.

My proposal for you is to start with a statement of what you want 
code disposal to do. then describe how you will modify tcl.pm to do 
that, then describe how you will modify tkx.pm to incorporate that 
path. Once you have reached that point publish your proposal and see 
what comments you get back.

Then you can go in and study v1.02 and v1.05 and see what changed, 
once you have reached that point you can start making the 
improvements to the code. Then you can publish a patch  so we can 
install it to a local branch and see how it works.

Again, my purpose when I took on this task to make tcl better than it 
was because for no fault of mine my programs stopped working. I spent 
a lot of time looking thru the code and learning how to think like 
the authors did when they wrote their code.  The change from v1.02 to 
v1.05 was not minor, It changed a lot of how %anon_refs was used. My 
fix incorporates the original design of %anon_refs tracking the 
TCLNAME so it doenst constantly redefine perl &lt;-&gt;tcl coderefs, it 
also tracks the new DESCRNAME used for code disposal purposes, I does 
not redefine a TCLNAME that currently exists, and only destroys it 
when all the registered users of that TCLNAME have been 
eliminated.   I joined the original v1.02 and the v1.05 code in a way 
that satisfies the purposes of both of them

It requires no changes to existing tcl/tkx programs or to tkx.pm to 
work properly.

It also allows for developer access to this code disposal procedure 
via create_tcl_sub&#40;&#41; so they can have a say in how code disposal 
works for them.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;SJ
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1796004" href="/Public/Bug/Display.html?id=125472#txn-1796004">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;14&nbsp;10:11:52&nbsp;2018</span>
    <span class="description">sjaluo [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #125472] error with coderefs passes as scalar args</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 14 Jul 2018 22:11:35 +0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org, tcltk [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;S.J. Luo&#34; &lt;sjaluo [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1796004/965876/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/965876">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 11.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Okay I agree that showing some code would make the point more
convincing and I have plan to try it.
Let&#39;s stop the discussion.

SJ

2018-07-14 12:43 GMT+08:00 huck &lt;huck@finn.com&gt;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; At 08:50 PM 7/13/2018, you wrote:
<div class="message-stanza open">&gt;&gt;
&gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125472">https://rt.cpan.org/Ticket/Display.html?id=125472</a></span> &gt;
&gt;&gt;
&gt;&gt; 2018-07-07 22:46 GMT+08:00 huck :
&gt;&gt;
<div class="message-stanza open">&gt;&gt; &gt;
&gt;&gt; &gt; Yes, as we saw when code disposal was introduced , even existing
&gt;&gt; &gt; applications can be ruined if care is not properly taken.  Maybe if
&gt;&gt; &gt; create_tcl_sub&#40;&#41; had been documented as part of the api this problem
&gt;&gt; &gt; would
&gt;&gt; &gt; not have been created in the first place.
&gt;&gt; &gt;
</div>&gt;&gt;
&gt;&gt; I think it had not been because create_tcl_sub&#40;&#41; was created for
&gt;&gt; internal use only and not intended to be an API.
</div>&gt;
&gt;
&gt; Maybe if it had been documented the original code disposal changes would not
&gt; have busted existing programs like they did.
&gt;
&gt; I also find it hard to believe that just because something was one designed
&gt; for internal use it means it can never be exposed as part of the API.
&gt;
&gt; create_tcl_sub&#40;&#41; is now integral to the code disposal changes. It is the
&gt; place that code disposal is now controled. allowing external access to it is
&gt; basically the only way to allow the developer to control code disposal.
&gt;
&gt;
&gt;
<div class="message-stanza open"><div class="message-stanza open">&gt;&gt; &gt;
<div class="message-stanza open">&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; My idea is to apply a prefix to identify if first argument of call&#40;&#41; is
&gt;&gt; &gt;&gt; a
&gt;&gt; &gt;&gt; DESCRNAME. If the first arg call&#40;&#41; is &#39;%&#39; , then it is a DESCRNAME.
&gt;&gt; &gt;&gt; &#40;Let&#39;s
&gt;&gt; &gt;&gt; forget previous AT sign &#39;@&#39; example, which might confuse you&#41;.
&gt;&gt; &gt;&gt; Otherwise the
&gt;&gt; &gt;&gt; first arg is a tcl verb. For example the following code:
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; call&#40;&#39;%button1&#39;, ..., $sub1, sub{}&#41;
&gt;&gt; &gt;&gt; call&#40;&#39;%button1&#39;, ..., $sub2, $sub3&#41;
&gt;&gt; &gt;&gt; call&#40;&#39;if&#39;, &#39;1&#39;, $sub3&#41;
&gt;&gt; &gt;&gt; :
&gt;&gt; &gt;&gt; code_dispose&#40;&#39;button1&#39;&#41;;
&gt;&gt; &gt;&gt;
&gt;&gt; &gt;&gt; Then inline sub{}, $sub1 and $sub2 would get disposed while #sub3 is
&gt;&gt; &gt;&gt; kept.
&gt;&gt; &gt;&gt; The code looks much cleaner compared to annoying TCLNAME/GENCODE/EVENT
&gt;&gt; &gt;&gt; dealing and storing. Here one DESCRNAME maps to multiple $subs, which
&gt;&gt; &gt;&gt; is not
&gt;&gt; &gt;&gt; allowed in current implementation. Just share an idea for a better
&gt;&gt; &gt;&gt; disposal
&gt;&gt; &gt;&gt; interface.
</div>&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; And how would you implement this via Tkx?
&gt;&gt; &gt; for instance how do you modify a $menu&gt;add_command&#40;%args&#41;; call?
&gt;&gt; &gt; or $button =$in-&gt;new_ttk__button&#40;-text=&gt;$args{text},
&gt;&gt; &gt; -command=&gt;$args{sub} &#41;;
&gt;&gt; &gt;
</div>&gt;&gt;
&gt;&gt;    It&#39;s not for Tkx user. It&#39;s for Tcl user &#40;such as Tkx&#41;. Tkx can
&gt;&gt; associate a unique DESCRNAME &#39;menu1&#39; with an object $menu and call
&gt;&gt; code_dispose&#40;&#39;menu1&#39;&#41; on destroyer of $button1.
</div>&gt;
&gt;
&gt; Ya know i dont care much about the Tcl only user. I use it from Tkx,
&gt; somebody busted tkx. i fixed it. QED.
&gt;
&gt; Who is going to make the changes to Tkx to do this? How do i pass this
&gt; information from my program to tkx to do it?  Right now tkx is a simple
&gt; intercept  interface between perl and ttk. Basically a tkx developer does
&gt; not interface with call&#40;&#41; at all. How do you propose they do it under your
&gt; scenario?
&gt;
&gt; My WORKING solution allows the tkx user to get access to code disposal via
&gt; create_tcl_sub&#40;&#41;. I dont hear any solutions from you , just proposals.
&gt;
&gt; And what destroyer of $button1 are you talking about? can you show me where
&gt; Tkx sets up a destroyer for a button? Or are you proposing that someone come
&gt; up with the new code?  Are you going to do it?
&gt;
&gt; tkx just recodes a perl call into the corresponding tk name and calls that
&gt; tk procedure.
&gt;
<div class="message-stanza open">&gt;&gt;    In previous example, $sub1, inline sub{}, $sub2 get disposed when
&gt;&gt; code_dispose&#40;&#39;button1&#39;&#41; is called. They get disposed because they are
&gt;&gt; associated with DESCRNAME &#39;button1&#39; via call&#40;&#39;%button1&#39;&#41;. $sub3 is
&gt;&gt; also associated with &#39;button1&#39;, it does not get disposed because it
&gt;&gt; has also been call&#40;&#41;&#39;ed once without DESCRNAME.
</div>&gt;
&gt;
&gt;
&gt; It is never called without a DESCRNAME, call&#40;&#41; always assigns a DESCRNAME
&gt; when it calls create_tcl_sub&#40;&#41;, i think your proposal to add a leading
&gt; argument to call&#40;&#41;  has not been well thought out yet. The arguments to
&gt; call&#40;&#41;  are very well defined now, they constitute the elements of a call to
&gt; tcl, now you want to majorly modify what the arguments are for no good
&gt; reason i can figure out so far.
&gt;
&gt;
&gt;
<div class="message-stanza open"><div class="message-stanza open">&gt;&gt; &gt; like you said before if you dont know what to do with EVENT it can be
&gt;&gt; &gt; defined as undef, and then TCLNAME is the same as GENCODE &#40;as the doc
&gt;&gt; &gt; says&#41;
&gt;&gt; &gt; and only that one item needs to be saved, just like you need to save the
&gt;&gt; &gt; CMDNAME passed to CreateCommand &#40;&#41;
&gt;&gt; &gt;
&gt;&gt; &gt; Changing the existing and working interface to call&#40;&#41; seems to be much
&gt;&gt; &gt; more
&gt;&gt; &gt; error prone than documenting the interface to create_tcl_sub&#40;&#41;, just
&gt;&gt; &gt; making
&gt;&gt; &gt; things more complex.
&gt;&gt; &gt;
&gt;&gt; &gt; As i already mentioned by using create_tcl_sub&#40;&#41; to manage code
&gt;&gt; &gt; disposal, i
&gt;&gt; &gt; can just add one call to create_tcl_sub&#40;&#41; to lock down a sub from code
&gt;&gt; &gt; disposal, and add another call to _code_destroy&#40;&#41; when i want to release
&gt;&gt; &gt; that coderef.  Your proposed method requires every call with a coderef
&gt;&gt; &gt; to be
&gt;&gt; &gt; modified which was one thing i was trying to avoid.
&gt;&gt; &gt;
&gt;&gt; &gt; And you say &#34;would get disposed&#34;, but when?  the only time code may get
&gt;&gt; &gt; automagicly disposed is when something has the same DESCRNAME, but here
&gt;&gt; &gt; you
&gt;&gt; &gt; propose allowing DESCRNAME ot have the same value over multiple calls,
&gt;&gt; &gt; are
&gt;&gt; &gt; you proposing that inside the second call  $sub1 and  sub{}&#41; get
&gt;&gt; &gt; disposed?
&gt;&gt; &gt; or are you proposing that $sub3 gets added to that list for disposal
&gt;&gt; &gt; later?
&gt;&gt; &gt;
&gt;&gt; &gt; And a DESCRNAME can have more than one sub attached to it since v1.06
&gt;&gt; &gt; What
&gt;&gt; &gt; it is is that when the same DESCRNAME is seen again, the prior code
&gt;&gt; &gt; calls
&gt;&gt; &gt; are now eligible for code destruction. One change i made is to delay
&gt;&gt; &gt; code
&gt;&gt; &gt; destuction untill after the entire command is parsed, so as not to have
&gt;&gt; &gt; to
&gt;&gt; &gt; destroy/recreate a coderef that already exists in both the current and
&gt;&gt; &gt; the
&gt;&gt; &gt; prior call with the same DESCRNAME This wasnt a problem at v1.02 because
&gt;&gt; &gt; %anon_refs was only assigned to if the TCLNAME did not exist already
&gt;&gt; &gt;
</div>&gt;&gt;
<div class="message-stanza open"><div class="message-stanza open">&gt;&gt; &gt;&gt; BTW, I found _code_dispose&#40;&#41; has to be called in the form
&gt;&gt; &gt;&gt; &#39;Tcl::_code_dispose&#40;...&#41;&#39; rather than &#39;$interp-&gt;_code_dispose&#40;...&#41;&#39;. It
&gt;&gt; &gt;&gt; is
&gt;&gt; &gt;&gt; documented, but it is counter-intuitive. Programmers can hardly find
&gt;&gt; &gt;&gt; their
&gt;&gt; &gt;&gt; incorrect calling via $interp object. I suggest to check input
&gt;&gt; &gt;&gt; parameter and
&gt;&gt; &gt;&gt; provide some warning at least.  IMO, %anon_refs{} would be better an
&gt;&gt; &gt;&gt; object
&gt;&gt; &gt;&gt; instance variable instead of global one.
</div>&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt;
&gt;&gt; &gt; but it isnt an object instance now, as far as i can tell never has been,
&gt;&gt; &gt; So
&gt;&gt; &gt; the change you are proposing here is not trivial. What should it be an
&gt;&gt; &gt; instance of?
&gt;&gt; &gt;
&gt;&gt; &gt; While $interp can be considered an object all it is really is a blessed
&gt;&gt; &gt; scalar.  So where do you propose you store this new object instance? If
&gt;&gt; &gt; we
&gt;&gt; &gt; make $interp be the first key to %anon_refs that will cause a lot of
&gt;&gt; &gt; code to
&gt;&gt; &gt; need to be changed.
&gt;&gt; &gt;
&gt;&gt; &gt; And as i pointed out while delete_ref&#40;&#41; is called with an $interp for
&gt;&gt; &gt; the
&gt;&gt; &gt; most part that doesnt matter, since the $interp stored in the Tcl::Code
&gt;&gt; &gt; object is used for the deletion, and while there could be many different
&gt;&gt; &gt; interpreters, there is only one %anon_refs, so that on a single TCLNAME
&gt;&gt; &gt; can
&gt;&gt; &gt; exist, there cannot be one for each interpreter.
</div>&gt;&gt;
&gt;&gt;    I mean %anon_refs shall be better to be something like
&gt;&gt; $interp-&gt;{anon_refs}. Different interpreters shall be better have
&gt;&gt; separated TCLNAME/CMDNAME/DESCRNAME naming space. It does not make
&gt;&gt; sense that TCLNAME/DESCRNAME have to be unique across different
&gt;&gt; interpreters.
</div>&gt;
&gt;
&gt; It is not that way now, and as far as i can tell it was never that way ever.
&gt; What you are asking for is not a simple change to make,. it changes a lot of
&gt; things.
&gt;
&gt;   my $inter=Tcl-&gt;new&#40;&#41;; print Dumper&#40;$inter&#41;;
&gt;  $VAR1 = bless&#40; do{\&#40;my $o = 149405600&#41;}, &#39;Tcl&#39; &#41;;
&gt;
&gt; there is no place for $interp-&gt;{anon_refs} to live. it is just a blessed
&gt; scalar.
&gt;
&gt; Have you even looked at the code at all yet?
&gt;
&gt;
<div class="message-stanza open"><div class="message-stanza open">&gt;&gt; &gt; Again, maybe the solution is to make a RFP asking for input on code
&gt;&gt; &gt; disposal, what it should do, how it should be called and what
&gt;&gt; &gt; modification
&gt;&gt; &gt; will be needed to existing code. Without that my intentions were to make
&gt;&gt; &gt; it
&gt;&gt; &gt; so existing v1.02 code still worked, and there was a mechanism to
&gt;&gt; &gt; control
&gt;&gt; &gt; code disposal. I think my patches have met both of those goals.  &#40;and as
&gt;&gt; &gt; i
&gt;&gt; &gt; watched code disposal in action i realized it was destroying/recreating
&gt;&gt; &gt; tcl
&gt;&gt; &gt; subs over and over and i wanted to prevent that too&#41;
&gt;&gt; &gt;
&gt;&gt; &gt; and i also realized that a deep bug in the xs code was leading to a
&gt;&gt; &gt; massive
&gt;&gt; &gt; memory leak and fixed that as well.
</div>&gt;&gt;
&gt;&gt; Yes I believe v1.06 got quite some bugs fixed. Here just some
&gt;&gt; discussion for any possibility to make interface more clean.
</div>&gt;
&gt;
&gt; Yes my fixes have made v1.11 working again. All is working at least like it
&gt; used to and there is elementary code disposal for &#39;after&#39; calls like
&gt; intorduced after v1.02.
&gt;
&gt; All i see is trying to make the interface more complicated, without
&gt; proposing any code changes yourself. You want to change what $inter is, from
&gt; a blessed scalar to a blessed hash. you want to change how call&#40;&#41; is
&gt; defined, yoiu are proposing major changes to tkx.pm that will complicate it
&gt; by introducing some sort of interface between all the perl and tcl calls
&gt; that will create destroyers.
&gt;
&gt; So are you proposing to pay me to do all this or are you going to do it
&gt; yourself?
&gt;
&gt; I think the easiest thing here is for you to make your own branch and put in
&gt; the changes you want, show me the working code that passes all the tests.
&gt; Then explain how it is cleaner, and why it is any better than what we have
&gt; now. I have no desire to do something just because you want it done.
&gt;
&gt; I wanted to get my tkx programs working again, i put the time in to make it
&gt; so, and i think i did a much better job than what you have proposed so far.
&gt; It you can do better than go right ahead.
&gt;
&gt; My proposal for you is to start with a statement of what you want code
&gt; disposal to do. then describe how you will modify tcl.pm to do that, then
&gt; describe how you will modify tkx.pm to incorporate that path. Once you have
&gt; reached that point publish your proposal and see what comments you get back.
&gt;
&gt; Then you can go in and study v1.02 and v1.05 and see what changed, once you
&gt; have reached that point you can start making the improvements to the code.
&gt; Then you can publish a patch  so we can install it to a local branch and see
&gt; how it works.
&gt;
&gt; Again, my purpose when I took on this task to make tcl better than it was
&gt; because for no fault of mine my programs stopped working. I spent a lot of
&gt; time looking thru the code and learning how to think like the authors did
&gt; when they wrote their code.  The change from v1.02 to v1.05 was not minor,
&gt; It changed a lot of how %anon_refs was used. My fix incorporates the
&gt; original design of %anon_refs tracking the TCLNAME so it doenst constantly
&gt; redefine perl &lt;-&gt;tcl coderefs, it also tracks the new DESCRNAME used for
&gt; code disposal purposes, I does not redefine a TCLNAME that currently exists,
&gt; and only destroys it when all the registered users of that TCLNAME have been
&gt; eliminated.   I joined the original v1.02 and the v1.05 code in a way that
&gt; satisfies the purposes of both of them
&gt;
&gt; It requires no changes to existing tcl/tkx programs or to tkx.pm to work
&gt; properly.
&gt;
&gt; It also allows for developer access to this code disposal procedure via
&gt; create_tcl_sub&#40;&#41; so they can have a say in how code disposal works for them.
&gt;
<div class="message-stanza open">&gt;&gt; SJ
</div></div></div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 1.292777</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
