<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #34779 for POE: [PATCH] POE::Data::Envelope Integration Patch</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #34779 for POE: [PATCH] POE::Data::Envelope Integration Patch</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/POE/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/POE/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/POE/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/POE/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/POE">POE CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">34779</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/POE/Active/">POE</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
nperez [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-26342-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.0000    </td>
  </tr>
  <tr id="CF-26343-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.0000    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;09&nbsp;02:49:23&nbsp;2008</span>
    <span class="description">nperez [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] POE::Data::Envelope Integration Patch</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hola folks,

I was wanting this to go in to the 1.0 release, but since it didn&#39;t make
it not a big deal. Here is the promised integration patch with the POE
distribution. It touches the shipped filters, tests, and ReadWrite to
accommodate. I&#39;ve add documentation to explain wtf is going on and also
marked it as experimental. I&#39;ve svk pulled from the trunk, and also
tested the patch against a clean check out to verify that everything is
kosher.

And as always, if you see something that doesn&#39;t look right, please let
me know. There very well may be follow up patches as I work on my own
implementations based on this work and find something that doesn&#39;t work
as planned.

Comments welcome

-- 
Nicholas R. Perez
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> PDE_Integration.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;19&nbsp;03:00:48&nbsp;2008</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, Nick!  Now that it&#39;s the weekend, I have some time to look at your
patch.

It looks like a lot of tests have been altered to strip the blessing
from results.  Unfortunately tests like this don&#39;t test the actual data
but rather an altered copy.  I think that&#39;s bad form:

   is_deeply&#40;
-    $next, [ &#34;&#40;&#40;&#40;$compare&#41;&#41;&#41;&#34; ],
+    [@$next], [ &#34;&#40;&#40;&#40;$compare&#41;&#41;&#41;&#34; ],
     &#34;map filter get_one&#40;&#41; returns &#40;&#40;&#40;$compare&#41;&#41;&#41;&#34;
   &#41;;

This is significantly better, assuming it works:

   is_deeply&#40;
-    $next, [ &#34;&#40;&#40;&#40;$compare&#41;&#41;&#41;&#34; ],
+    $next, bless&#40;[ &#34;&#40;&#40;&#40;$compare&#41;&#41;&#41;&#34; ], &#39;POE::Data::Envelope&#39;&#41;,
     &#34;map filter get_one&#40;&#41; returns &#40;&#40;&#40;$compare&#41;&#41;&#41;&#34;
   &#41;;

You&#39;ve broken many of the ref&#40;&#41; tests.  ref&#40;[@$record]&#41; is always equal
to &#39;ARRAY&#39; because you&#39;ve wrapped the record in an arrayref!  Worse,
@$record will be a fatal error if ref&#40;$record&#41; isn&#39;t based on ARRAY.

     my $records = $filter-&gt;get&#40;[ $get_request-&gt;as_string ]&#41;;
-    is&#40;ref&#40;$records&#41;, &#39;ARRAY&#39;, &#39;simple get: get&#40;&#41; returns list of
requests&#39;&#41;;
+    is&#40;ref&#40;[@$records]&#41;, &#39;ARRAY&#39;, &#39;simple get: get&#40;&#41; returns list of
requests&#39;&#41;;
     is&#40;scalar&#40;@$records&#41;, 1, &#39;simple get: get&#40;&#41; returned single request&#39;&#41;;

As above, I&#39;d like to see $records tested for what it is.

... and that&#39;s all I have time for today.  I&#39;ll see about the
filter/wheel changes tomorrow.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;19&nbsp;03:00:49&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;19&nbsp;12:19:09&nbsp;2008</span>
    <span class="description">nicholasrperez [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #34779] [PATCH] POE::Data::Envelope Integration Patch</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 19 Apr 2008 11:18:57 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Nicholas Perez&#34; &lt;nicholasrperez [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Unfortunately, is_deeply, last time I looked, doesn&#39;t properly handle
overloaded objects in the way they are meant to be handled, meaning
the tests fail. Explicitly dereferencing the return result and
wrapping it back up gets the test to pass. The goal when it came to
the tests, was to modify as little as possible to make the tests pass.
I didn&#39;t know how comfortable you would be with me rewriting all of
the tests to test for these objects. If anything, I wanted to make
sure the functionality was almost transparent. In all of the cases of
dereferencing the result and wrapping it back up, it proves that the
results obviously can be dereferenced successfully and that the
meaning of the data is still the same, which covers the majority of
the tests.

And as for breaking ref tests, I didn&#39;t break them. Obviously if it
fails to dereference, it is semantically still a failure, but I see
your point.

Now that I understand the allowed changes to the tests, I can go back
and rewrite the tests to explicitly take the POE::Data::Envelope
objects into account.

Consider this patch a shoot from the hip largely because it has been
ignored by everyone.

On Sat, Apr 19, 2008 at 2:00 AM, RCAPUTO via RT &lt;bug-POE@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt;  &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=34779">http://rt.cpan.org/Ticket/Display.html?id=34779</a></span> &gt;
&gt;
&gt;  Hi, Nick!  Now that it&#39;s the weekend, I have some time to look at your
&gt;  patch.
&gt;
&gt;  It looks like a lot of tests have been altered to strip the blessing
&gt;  from results.  Unfortunately tests like this don&#39;t test the actual data
&gt;  but rather an altered copy.  I think that&#39;s bad form:
&gt;
&gt;    is_deeply&#40;
&gt;  -    $next, [ &#34;&#40;&#40;&#40;$compare&#41;&#41;&#41;&#34; ],
&gt;  +    [@$next], [ &#34;&#40;&#40;&#40;$compare&#41;&#41;&#41;&#34; ],
&gt;      &#34;map filter get_one&#40;&#41; returns &#40;&#40;&#40;$compare&#41;&#41;&#41;&#34;
&gt;    &#41;;
&gt;
&gt;  This is significantly better, assuming it works:
&gt;
&gt;    is_deeply&#40;
&gt;  -    $next, [ &#34;&#40;&#40;&#40;$compare&#41;&#41;&#41;&#34; ],
&gt;  +    $next, bless&#40;[ &#34;&#40;&#40;&#40;$compare&#41;&#41;&#41;&#34; ], &#39;POE::Data::Envelope&#39;&#41;,
&gt;      &#34;map filter get_one&#40;&#41; returns &#40;&#40;&#40;$compare&#41;&#41;&#41;&#34;
&gt;    &#41;;
&gt;
&gt;  You&#39;ve broken many of the ref&#40;&#41; tests.  ref&#40;[@$record]&#41; is always equal
&gt;  to &#39;ARRAY&#39; because you&#39;ve wrapped the record in an arrayref!  Worse,
&gt;  @$record will be a fatal error if ref&#40;$record&#41; isn&#39;t based on ARRAY.
&gt;
&gt;      my $records = $filter-&gt;get&#40;[ $get_request-&gt;as_string ]&#41;;
&gt;  -    is&#40;ref&#40;$records&#41;, &#39;ARRAY&#39;, &#39;simple get: get&#40;&#41; returns list of
&gt;  requests&#39;&#41;;
&gt;  +    is&#40;ref&#40;[@$records]&#41;, &#39;ARRAY&#39;, &#39;simple get: get&#40;&#41; returns list of
&gt;  requests&#39;&#41;;
&gt;      is&#40;scalar&#40;@$records&#41;, 1, &#39;simple get: get&#40;&#41; returned single request&#39;&#41;;
&gt;
&gt;  As above, I&#39;d like to see $records tested for what it is.
&gt;
&gt;  ... and that&#39;s all I have time for today.  I&#39;ll see about the
&gt;  filter/wheel changes tomorrow.
&gt;
</div>


-- 
Nicholas R. Perez
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;04&nbsp;04:02:06&nbsp;2008</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Apr 09 02:49:23 2008, NPEREZ wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [patch]
</div>
I agree that the tests should verify that PDE behaves like plain old
arrays for backward compatibility, but the spirit of many existing tests
has been violated.  I think the array-ness tests should be added, and
the existing tests changed so their purposes remain intact.

I&#39;m looking at the modified POE::Filter::Stream.  That&#39;s the most
trivial filter, so your changes really stand out.

The following are half-informed comments based on an incomplete
understanding of your changes.  Let me know where/how I get it wrong.

Something&#39;s bugging me about the way POE::Data::Envelope objects hold
data but are treated separate from it.

This puts a constraint on filters: they must not pass two PDE objects
amongst themselves, otherwise information is lost.

So if a filter receives something which triggers two PDE objects, it
will need to hold one of them until the next get_one&#40;&#41; call.

If two different PDE objects arrive via get_one_start&#40;&#41; then the filter
must not combine them:

  $f-&gt;get_one_start&#40; PDE-&gt;new&#40;...one...&#41; &#41;;
  $f-&gt;get_one_start&#40; PDE-&gt;new&#40;...two...&#41; &#41;;
  while &#40;1&#41; {
    my $one = $f-&gt;get_one&#40;&#41;;
    last unless @$one;
    ...
  }

In the above case, POE::Filter::Stream will lose the information encoded
in the first PDE object.  The second one will overwrite it.

...

The get_one&#40;&#41; call may not come for a while.  For example, the line may
be quiet, or select_pause_read&#40;&#41; may have been called until the second
PDE object arrives.  In the latter case, there&#39;s a deadlock.

  sub get_one_start {
    if &#40;blah blah&#41; {
      # push two PDE objects into the stream
    }
  }

So the wheels must, upon receipt of a PDE object, drive another filter
get cycle just in case there&#39;s a pending object in the stack.

...

The general get_one_start&#40;&#41; logic may be something like this:  If the
new PDE is the same as the last one, then combine the data with the last
one&#39;s.  Otherwise push the PDE onto the stream buffer.

A half-assed prototype:

  sub get_one_start {
    my &#40;$self, $data&#41; = @_;
    if &#40;ref&#40;$data&#41; eq ref&#40;$self-&gt;{buffer}[-1]&#41;&#41; {
      push @{$self-&gt;{buffer}[-1]}, @$data;  # or something similar
    }
    else {
      push @{$self-&gt;{buffer}}, $data;
    }
  }

...

clone&#40;&#41; clones the PDE object but not the data.  I&#39;m not sure that&#39;s a
good idea, as it could be bad for PDE objects to bleed across filters.

This could resolve itself if PDE objects were the buffer.

...

POE::Filter&#39;s get&#40;&#41; is not PDE aware.  If get_one&#40;&#41; returns a PDE
object, get wraps it up in an anonymous array.

...

Should get_pending&#40;&#41; return the current buffer wrapped in the current
PDE environment?  POE::Wheel::Whatever feeds get_pending&#40;&#41;&#39;s return
value to get_one_start&#40;&#41; for the new filter.

...

Probably other questions, but it&#39;s 4am.  G&#39;night!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;04&nbsp;21:01:42&nbsp;2008</span>
    <span class="description">nicholasrperez [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #34779] [PATCH] POE::Data::Envelope Integration Patch</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 4 May 2008 20:01:25 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Nicholas Perez&#34; &lt;nicholasrperez [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Very valid points. You&#39;re right. That is a hole that I didn&#39;t really
consider, regarding two inputs into get_one_start, but it certainly
makes sense if the data in one PDE isn&#39;t enough to trigger an event.

And thinking about it more, perhaps for the core filters, it doesn&#39;t
make sense to PDE enable them. The information passed around isn&#39;t
enough to justify the extra rigmarole. And truly, a more complex
protocol stack wouldn&#39;t end up using any of the core filters but would
be more specialized.

And to be honest, I did the most minimal integration into the core
filters that I could. Since I am not using the core filters, I didn&#39;t
have a use case to justify adding more than I needed to. The idea was
to perhaps encourage others to add to them starting where I left off.
And also if a core filter was used, the OOB data from upper levels in
the stack wouldn&#39;t be lost.

I appreciate the look-see, but I believe now I am going to retract the
patch and instead implement a separate module that will bring this
idea to fruition in a more specific context.

On Sun, May 4, 2008 at 3:02 AM, RCAPUTO via RT &lt;bug-POE@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt;  &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=34779">http://rt.cpan.org/Ticket/Display.html?id=34779</a></span> &gt;
&gt;
&gt;  On Wed Apr 09 02:49:23 2008, NPEREZ wrote:
<div class="message-stanza open">&gt;  &gt; [patch]
</div>&gt;
&gt;  I agree that the tests should verify that PDE behaves like plain old
&gt;  arrays for backward compatibility, but the spirit of many existing tests
&gt;  has been violated.  I think the array-ness tests should be added, and
&gt;  the existing tests changed so their purposes remain intact.
&gt;
&gt;  I&#39;m looking at the modified POE::Filter::Stream.  That&#39;s the most
&gt;  trivial filter, so your changes really stand out.
&gt;
&gt;  The following are half-informed comments based on an incomplete
&gt;  understanding of your changes.  Let me know where/how I get it wrong.
&gt;
&gt;  Something&#39;s bugging me about the way POE::Data::Envelope objects hold
&gt;  data but are treated separate from it.
&gt;
&gt;  This puts a constraint on filters: they must not pass two PDE objects
&gt;  amongst themselves, otherwise information is lost.
&gt;
&gt;  So if a filter receives something which triggers two PDE objects, it
&gt;  will need to hold one of them until the next get_one&#40;&#41; call.
&gt;
&gt;  If two different PDE objects arrive via get_one_start&#40;&#41; then the filter
&gt;  must not combine them:
&gt;
&gt;   $f-&gt;get_one_start&#40; PDE-&gt;new&#40;...one...&#41; &#41;;
&gt;   $f-&gt;get_one_start&#40; PDE-&gt;new&#40;...two...&#41; &#41;;
&gt;   while &#40;1&#41; {
&gt;     my $one = $f-&gt;get_one&#40;&#41;;
&gt;     last unless @$one;
&gt;     ...
&gt;   }
&gt;
&gt;  In the above case, POE::Filter::Stream will lose the information encoded
&gt;  in the first PDE object.  The second one will overwrite it.
&gt;
&gt;  ...
&gt;
&gt;  The get_one&#40;&#41; call may not come for a while.  For example, the line may
&gt;  be quiet, or select_pause_read&#40;&#41; may have been called until the second
&gt;  PDE object arrives.  In the latter case, there&#39;s a deadlock.
&gt;
&gt;   sub get_one_start {
&gt;     if &#40;blah blah&#41; {
&gt;       # push two PDE objects into the stream
&gt;     }
&gt;   }
&gt;
&gt;  So the wheels must, upon receipt of a PDE object, drive another filter
&gt;  get cycle just in case there&#39;s a pending object in the stack.
&gt;
&gt;  ...
&gt;
&gt;  The general get_one_start&#40;&#41; logic may be something like this:  If the
&gt;  new PDE is the same as the last one, then combine the data with the last
&gt;  one&#39;s.  Otherwise push the PDE onto the stream buffer.
&gt;
&gt;  A half-assed prototype:
&gt;
&gt;   sub get_one_start {
&gt;     my &#40;$self, $data&#41; = @_;
&gt;     if &#40;ref&#40;$data&#41; eq ref&#40;$self-&gt;{buffer}[-1]&#41;&#41; {
&gt;       push @{$self-&gt;{buffer}[-1]}, @$data;  # or something similar
&gt;     }
&gt;     else {
&gt;       push @{$self-&gt;{buffer}}, $data;
&gt;     }
&gt;   }
&gt;
&gt;  ...
&gt;
&gt;  clone&#40;&#41; clones the PDE object but not the data.  I&#39;m not sure that&#39;s a
&gt;  good idea, as it could be bad for PDE objects to bleed across filters.
&gt;
&gt;  This could resolve itself if PDE objects were the buffer.
&gt;
&gt;  ...
&gt;
&gt;  POE::Filter&#39;s get&#40;&#41; is not PDE aware.  If get_one&#40;&#41; returns a PDE
&gt;  object, get wraps it up in an anonymous array.
&gt;
&gt;  ...
&gt;
&gt;  Should get_pending&#40;&#41; return the current buffer wrapped in the current
&gt;  PDE environment?  POE::Wheel::Whatever feeds get_pending&#40;&#41;&#39;s return
&gt;  value to get_one_start&#40;&#41; for the new filter.
&gt;
&gt;  ...
&gt;
&gt;  Probably other questions, but it&#39;s 4am.  G&#39;night!
&gt;
</div>


-- 
Nicholas R. Perez
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;04&nbsp;18:43:05&nbsp;2008</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Rejecting the patch since it was rescinded.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;04&nbsp;18:43:07&nbsp;2008</span>
    <span class="description">RCAPUTO [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
