<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #132954 for JSON-Patch: Possible bug in JSON::Patch</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #132954 for JSON-Patch: Possible bug in JSON::Patch</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=JSON-Patch">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=JSON-Patch">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=JSON-Patch">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=JSON-Patch">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/JSON-Patch">JSON-Patch CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">132954</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=JSON-Patch">JSON-Patch</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jelices [...] hdi2.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-271808-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-271809-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=132954">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1904618" href="/Public/Bug/Display.html?id=132954#txn-1904618">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;07&nbsp;08:09:25&nbsp;2020</span>
    <span class="description">jelices [...] hdi2.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Possible bug in JSON::Patch</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 7 Jul 2020 13:46:45 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-json-patch [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Javier Elices &lt;jelices [...] hdi2.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1904618/1020558/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1020558">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Michael,

 Â  First of all, a big thank you for all the useful libraries that you 
have available!

 Â  I have a web development that uses Perl for the batch work and Node 
and Javascript for the backend and frontend respectively. One of the 
Perl scripts uses your JSON::Patch library to compare a JSON that gets 
modified by the client App. This allows showing the changes diff-like to 
the admin as well as doing and undoing them. For all to work, the 
patches need to be correct and interoperable across Perl and Javascript. 
JSON Patch seems to be the way to go as that is exactly what promises...

 Â  Consider the following script:

#!/usr/bin/env perl
# JSON::Patch operations order bug?

use strict;
use warnings;
use utf8;

use JSON::XS;
use JSON::Patch qw&#40;diff patch&#41;;

my $json1 = &#39;
{
 Â  &#34;one&#34;: [
 Â Â Â  { &#34;a&#34;: [1, 2] },
 Â Â Â  { &#34;b&#34;: [3, 4] },
 Â Â Â  { &#34;c&#34;: [5, 6] }
 Â  ]
}
&#39;;

my $json2 = &#39;
{
 Â  &#34;one&#34;: [
 Â Â Â  { &#34;a&#34;: [1, 2] }
 Â  ]
}
&#39;;

my $j1 = decode_json $json1;
my $j2 = decode_json $json2;

my $p2 = diff&#40;$j2, $j1&#41;;
print JSON::XS-&gt;new-&gt;utf8-&gt;pretty-&gt;encode&#40; $p2 &#41;, &#34;\n&#34;;
patch&#40;$j2, $p2&#41;;

 Â  The output of the script is &#40;I am using version 0.04 of JSON::Patch&#41;:

[
 Â Â  {
 Â Â Â Â Â  &#34;path&#34; : &#34;/one/2&#34;,
 Â Â Â Â Â  &#34;value&#34; : {
 Â Â Â Â Â Â Â Â  &#34;c&#34; : [
 Â Â Â Â Â Â Â Â Â Â Â  5,
 Â Â Â Â Â Â Â Â Â Â Â  6
 Â Â Â Â Â Â Â Â  ]
 Â Â Â Â Â  },
 Â Â Â Â Â  &#34;op&#34; : &#34;add&#34;
 Â Â  },
 Â Â  {
 Â Â Â Â Â  &#34;path&#34; : &#34;/one/1&#34;,
 Â Â Â Â Â  &#34;value&#34; : {
 Â Â Â Â Â Â Â Â  &#34;b&#34; : [
 Â Â Â Â Â Â Â Â Â Â Â  3,
 Â Â Â Â Â Â Â Â Â Â Â  4
 Â Â Â Â Â Â Â Â  ]
 Â Â Â Â Â  },
 Â Â Â Â Â  &#34;op&#34; : &#34;add&#34;
 Â Â  }
]

Index is out of range, step #1 at 
/home/xxx/perl5/lib/perl5/Struct/Path.pm line 336.

 Â  I have seen that JSON::Patch::diff generates three types of operation 
based on the output of Struct::Diff::list_diff&#40;$diff, sort =&gt; 1&#41;. I 
think that &#34;add&#34; operations should be generated in the oposite order, 
while &#34;remove&#34; operations are being generated in the right order and 
&#34;replace&#34; operations could be generated in any order. That is assuming 
that Struct::Diff does not produce redundant differences.

 Â  I have checked the RFC 6902 specification to ensure and found &#40;about 
&#34;add&#34; op&#39;s&#41;:

    o  An element to add to an existing array - whereupon the supplied
       value is added to the array at the indicated location.  Any
       elements at or above the specified index are shifted one position
       to the right.  The specified index MUST NOT be greater than the
       number of elements in the array.  If the &#34;-&#34; character is used to
       index the end of the array &#40;see [RFC6901  &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://tools.ietf.org/html/rfc6901">https://tools.ietf.org/html/rfc6901</a></span>&gt;]&#41;, this has the effect of
       appending the value to the array.


 Â  I have also tried a different JSON Patch library &#40;Node this one, 
which I also use&#41;: <span class="clickylink"><a target="new" rel="nofollow" href="https://json8.github.io/patch/demos/apply/">https://json8.github.io/patch/demos/apply/</a></span> and it 
also does not like the order of the operations of the patch above.

 Â  I have thought about the problem and I think that a sorting step 
after the patch generation should be all it is required:

  * Group operations by type
  * Sort &#34;add&#34; operations in alphabetical path order
  * Sort &#34;remove&#34; operations in reverse alphabetical path order

 Â  I think this function takes care of it:

sub patch_sort {
 Â  my $p = shift || [];

 Â  return [ sort {
 Â Â Â  &#40; $b-&gt;{op} cmp $a-&gt;{op} &#41; ||
 Â Â Â  &#40;
 Â Â Â Â Â  $a-&gt;{op} eq &#39;remove&#39;
 Â Â Â Â Â Â Â  ? $b-&gt;{path} cmp $a-&gt;{path}
 Â Â Â Â Â Â Â  : $a-&gt;{path} cmp $b-&gt;{path}
 Â Â Â  &#41;
 Â  } @$p ];
}

 Â  It first sorts by &#34;op&#34;, then for equal &#34;op&#34; it uses &#34;path&#34; in reverse 
alpha order for &#34;remove&#34; and in alpha order for the rest. This also 
sorts &#34;replace&#34; op&#39;s which I think does not harm.

 Â  In the above script, it will take this change:

my $p2 = patch_sort&#40; diff&#40;$j2, $j1&#41; &#41;;

 Â  To get the patch in order. With that change it works.

 Â  I have tried more complex examples and the ordering seems to work. I 
share all this with you so you can think about the problem, see if you 
agree with me about the ordering and hopefully fix the library for other 
people to use. I have not studied your other libraries which JSON::Patch 
uses, so I may be missing something.

 Â  What do you think? Any feedback would be appreciated.

 Â  Thanks a lot for your time!

 Â  Best Regards,

 Â  Javier Elices.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1904618/1020559/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1020559">with headers</a>
<br />
<span class="downloadcontenttype">text/html 7k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1904667" href="/Public/Bug/Display.html?id=132954#txn-1904667">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;08&nbsp;04:55:18&nbsp;2020</span>
    <span class="description">jelices [...] hdi2.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #132954] AutoReply: Possible bug in JSON::Patch</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 8 Jul 2020 10:55:04 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-JSON-Patch [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Javier Elices &lt;jelices [...] hdi2.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1904667/1020575/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1020575">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 5.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"> Â  Actually, I think that it takes a little bit more to get the right 
order of the operations within a JSON Patch:

sub patch_sort {
 Â  my $p = shift || [];

 Â  return [ sort {
 Â Â Â  &#40; $b-&gt;{op} cmp $a-&gt;{op} &#41; ||
 Â Â Â  &#40;
 Â Â Â Â Â  $a-&gt;{op} eq &#39;remove&#39;
 Â Â Â Â Â Â Â  ? path_cmp&#40;$b-&gt;{path}, $a-&gt;{path}&#41;
 Â Â Â Â Â Â Â  : path_cmp&#40;$a-&gt;{path}, $b-&gt;{path}&#41;
 Â Â Â  &#41;
 Â  } @$p ];
}

sub path_long {
 Â  my $p = shift || &#39;&#39;;

 Â  return join&#40; &#39;/&#39;, map { $_ =~ /^\d+$/ ? sprintf&#40;&#34;%09d&#34;, $_&#41; : $_ } 
split&#40;&#39;/&#39;, $p&#41; &#41;;
}

sub path_cmp {
 Â  my &#40;$a, $b&#41; = @_;
 Â  return path_long&#40;$a&#41; cmp path_long&#40;$b&#41;;
}


El 07/07/2020 a las 14:09, Bugs in JSON-Patch via RT escribiÃ³:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Greetings,
&gt;
&gt; This message has been automatically generated in response to the
&gt; creation of a trouble ticket regarding:
&gt;       &#34;Possible bug in JSON::Patch&#34;,
&gt; a summary of which appears below.
&gt;
&gt; There is no need to reply to this message right now.  Your ticket has been
&gt; assigned an ID of [rt.cpan.org #132954].  Your ticket is accessible
&gt; on the web at:
&gt;
&gt;      <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=132954">https://rt.cpan.org/Ticket/Display.html?id=132954</a></span>
&gt;
&gt; Please include the string:
&gt;
&gt;           [rt.cpan.org #132954]
&gt;
&gt; in the subject line of all future correspondence about this issue. To do so,
&gt; you may reply to this message.
&gt;
&gt;                          Thank you,
&gt;                          bug-JSON-Patch@rt.cpan.org
&gt;
&gt; -------------------------------------------------------------------------
&gt; Hello Michael,
&gt;
&gt;   Â  First of all, a big thank you for all the useful libraries that you
&gt; have available!
&gt;
&gt;   Â  I have a web development that uses Perl for the batch work and Node
&gt; and Javascript for the backend and frontend respectively. One of the
&gt; Perl scripts uses your JSON::Patch library to compare a JSON that gets
&gt; modified by the client App. This allows showing the changes diff-like to
&gt; the admin as well as doing and undoing them. For all to work, the
&gt; patches need to be correct and interoperable across Perl and Javascript.
&gt; JSON Patch seems to be the way to go as that is exactly what promises...
&gt;
&gt;   Â  Consider the following script:
&gt;
&gt; #!/usr/bin/env perl
&gt; # JSON::Patch operations order bug?
&gt;
&gt; use strict;
&gt; use warnings;
&gt; use utf8;
&gt;
&gt; use JSON::XS;
&gt; use JSON::Patch qw&#40;diff patch&#41;;
&gt;
&gt; my $json1 = &#39;
&gt; {
&gt;   Â  &#34;one&#34;: [
&gt;   Â Â Â  { &#34;a&#34;: [1, 2] },
&gt;   Â Â Â  { &#34;b&#34;: [3, 4] },
&gt;   Â Â Â  { &#34;c&#34;: [5, 6] }
&gt;   Â  ]
&gt; }
&gt; &#39;;
&gt;
&gt; my $json2 = &#39;
&gt; {
&gt;   Â  &#34;one&#34;: [
&gt;   Â Â Â  { &#34;a&#34;: [1, 2] }
&gt;   Â  ]
&gt; }
&gt; &#39;;
&gt;
&gt; my $j1 = decode_json $json1;
&gt; my $j2 = decode_json $json2;
&gt;
&gt; my $p2 = diff&#40;$j2, $j1&#41;;
&gt; print JSON::XS-&gt;new-&gt;utf8-&gt;pretty-&gt;encode&#40; $p2 &#41;, &#34;\n&#34;;
&gt; patch&#40;$j2, $p2&#41;;
&gt;
&gt;   Â  The output of the script is &#40;I am using version 0.04 of JSON::Patch&#41;:
&gt;
&gt; [
&gt;   Â Â  {
&gt;   Â Â Â Â Â  &#34;path&#34; : &#34;/one/2&#34;,
&gt;   Â Â Â Â Â  &#34;value&#34; : {
&gt;   Â Â Â Â Â Â Â Â  &#34;c&#34; : [
&gt;   Â Â Â Â Â Â Â Â Â Â Â  5,
&gt;   Â Â Â Â Â Â Â Â Â Â Â  6
&gt;   Â Â Â Â Â Â Â Â  ]
&gt;   Â Â Â Â Â  },
&gt;   Â Â Â Â Â  &#34;op&#34; : &#34;add&#34;
&gt;   Â Â  },
&gt;   Â Â  {
&gt;   Â Â Â Â Â  &#34;path&#34; : &#34;/one/1&#34;,
&gt;   Â Â Â Â Â  &#34;value&#34; : {
&gt;   Â Â Â Â Â Â Â Â  &#34;b&#34; : [
&gt;   Â Â Â Â Â Â Â Â Â Â Â  3,
&gt;   Â Â Â Â Â Â Â Â Â Â Â  4
&gt;   Â Â Â Â Â Â Â Â  ]
&gt;   Â Â Â Â Â  },
&gt;   Â Â Â Â Â  &#34;op&#34; : &#34;add&#34;
&gt;   Â Â  }
&gt; ]
&gt;
&gt; Index is out of range, step #1 at
&gt; /home/xxx/perl5/lib/perl5/Struct/Path.pm line 336.
&gt;
&gt;   Â  I have seen that JSON::Patch::diff generates three types of operation
&gt; based on the output of Struct::Diff::list_diff&#40;$diff, sort =&gt; 1&#41;. I
&gt; think that &#34;add&#34; operations should be generated in the oposite order,
&gt; while &#34;remove&#34; operations are being generated in the right order and
&gt; &#34;replace&#34; operations could be generated in any order. That is assuming
&gt; that Struct::Diff does not produce redundant differences.
&gt;
&gt;   Â  I have checked the RFC 6902 specification to ensure and found &#40;about
&gt; &#34;add&#34; op&#39;s&#41;:
&gt;
&gt;      o  An element to add to an existing array - whereupon the supplied
&gt;         value is added to the array at the indicated location.  Any
&gt;         elements at or above the specified index are shifted one position
&gt;         to the right.  The specified index MUST NOT be greater than the
&gt;         number of elements in the array.  If the &#34;-&#34; character is used to
&gt;         index the end of the array &#40;see [RFC6901  &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://tools.ietf.org/html/rfc6901">https://tools.ietf.org/html/rfc6901</a></span>&gt;]&#41;, this has the effect of
&gt;         appending the value to the array.
&gt;
&gt;
&gt;   Â  I have also tried a different JSON Patch library &#40;Node this one,
&gt; which I also use&#41;: <span class="clickylink"><a target="new" rel="nofollow" href="https://json8.github.io/patch/demos/apply/">https://json8.github.io/patch/demos/apply/</a></span> and it
&gt; also does not like the order of the operations of the patch above.
&gt;
&gt;   Â  I have thought about the problem and I think that a sorting step
&gt; after the patch generation should be all it is required:
&gt;
&gt;    * Group operations by type
&gt;    * Sort &#34;add&#34; operations in alphabetical path order
&gt;    * Sort &#34;remove&#34; operations in reverse alphabetical path order
&gt;
&gt;   Â  I think this function takes care of it:
&gt;
&gt; sub patch_sort {
&gt;   Â  my $p = shift || [];
&gt;
&gt;   Â  return [ sort {
&gt;   Â Â Â  &#40; $b-&gt;{op} cmp $a-&gt;{op} &#41; ||
&gt;   Â Â Â  &#40;
&gt;   Â Â Â Â Â  $a-&gt;{op} eq &#39;remove&#39;
&gt;   Â Â Â Â Â Â Â  ? $b-&gt;{path} cmp $a-&gt;{path}
&gt;   Â Â Â Â Â Â Â  : $a-&gt;{path} cmp $b-&gt;{path}
&gt;   Â Â Â  &#41;
&gt;   Â  } @$p ];
&gt; }
&gt;
&gt;   Â  It first sorts by &#34;op&#34;, then for equal &#34;op&#34; it uses &#34;path&#34; in reverse
&gt; alpha order for &#34;remove&#34; and in alpha order for the rest. This also
&gt; sorts &#34;replace&#34; op&#39;s which I think does not harm.
&gt;
&gt;   Â  In the above script, it will take this change:
&gt;
&gt; my $p2 = patch_sort&#40; diff&#40;$j2, $j1&#41; &#41;;
&gt;
&gt;   Â  To get the patch in order. With that change it works.
&gt;
&gt;   Â  I have tried more complex examples and the ordering seems to work. I
&gt; share all this with you so you can think about the problem, see if you
&gt; agree with me about the ordering and hopefully fix the library for other
&gt; people to use. I have not studied your other libraries which JSON::Patch
&gt; uses, so I may be missing something.
&gt;
&gt;   Â  What do you think? Any feedback would be appreciated.
&gt;
&gt;   Â  Thanks a lot for your time!
&gt;
&gt;   Â  Best Regards,
&gt;
&gt;   Â  Javier Elices.
&gt;
&gt;
</div></div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.291487</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
