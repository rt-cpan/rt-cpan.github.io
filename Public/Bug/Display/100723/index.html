<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #100723 for Moose: nested Roles broken on requires</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #100723 for Moose: nested Roles broken on requires</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Moose/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Moose/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Moose/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Moose/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Moose">Moose CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">100723</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Moose/Active/">Moose</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
John.Macdonald [...] oicr.on.ca

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-38786-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-38787-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;05&nbsp;12:28:56&nbsp;2014</span>
    <span class="description">John.Macdonald [...] oicr.on.ca -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> nested Roles broken on requires</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 5 Dec 2014 17:28:45 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Moose [...] rt.cpan.org&#34; &lt;bug-Moose [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> John Macdonald &lt;John.Macdonald [...] oicr.on.ca&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">If a role wishes to consume another role as part of its implementation, and the consumed role has a &#39;requires&#39; that must be provided; the consuming role can be written as a self-contained role.

The search for &#39;requires&#39; values is done in the grand&#40;n&#41;parent consumer &#40;the top level consumer which is not a role&#41;.  Attributes and methods provided by the parent role do not get installed into the top level object until the end of processing of the &#39;with&#39; statement.  So, they have not yet been installed at the point when the parent role tries to consume the child role.

The only way to make it work is for the top level object to consume the parent role, and then, in a separate &#39;with&#39; statement, consume the child role.  &#40;Even listing both the parent and the child in the same &#39;with&#39; statement does not work - the parent&#39;s attributes/methods are not installed when the child &#39;s &#39;requires&#39; statement is processed.&#41;

This breaks encapsulation badly.  Every consumer of the parent role must be coded to provide the child role that the parent needs for its internal implementation, and must provide it in a separate with statement.  If the parent role is changed to use a different implementation, then all consuming object definitions must be found and fixed to deal with the revised internal needs of the consumed role.

I suspect that this problem is inherent in the way roles have been implemented - the attributes and methods of a collection of roles are only inserted into the final parent after they have been fully processed.  That suggests that fixing it may cause existing code to break.  I&#39;d be happy to be wrong about this though, and see someone find a safe way of fixing the problem.

In the attached tar,
BRole.pm is the child role
ARole.pm is the parent role written in a fully encapsulated way
ARoleNoWith.pm is the same role, excluding the &#39;with&#39; statement consuming BRole
ABRole.pm is a grandparent role that tries to express the separated &#39;with&#39; statement requirement to provide the encapsulation again

test1.pl is the way the non-role top level consumer &#34;should&#34; be written - only requesting the role that it is actually using - it fails because ARole&#39;s attempt to consume BRole complains about the requirement missing from &#39;main&#39; - it fails because ARole|BRole have a requirement that isn&#39;t provided in &#39;main&#39;
test2.pl re-writes the top level consumer to &#34;know&#34; that ARole also implies a need for BRole but using a single &#39;with&#39; statement
test3.pl re-writes the top level consumer with the addition implementation knowledge that the two roles must be consumed separately and in the right order - it compiles correctly
test4.pl uses the ABRole attempted workaround - it again gets the complaint thatABRole has a requirement that must be provided in &#39;main&#39;


John Macdonald
Software Engineer

Ontario Institute for Cancer Research
MaRS Centre

661 University Avenue

Suite 510
Toronto, Ontario

Canada M5G 0A3


Tel:

Email: John.Macdonald@oicr.on.ca

Toll-free: 1-866-678-6427
Twitter: @OICR_news


www.oicr.on.ca&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.oicr.on.ca/">http://www.oicr.on.ca/</a></span>&gt;

This message and any attachments may contain confidential and/or privileged information for the sole use of the intended recipient. Any review or distribution by anyone other than the person for whom it was originally intended is strictly prohibited. If you have received this message in error, please contact the sender and delete all copies. Opinions, conclusions or other information contained in this message may not be that of the organization.
</div></div>

<div class="messagebody">
</div>
</div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;16&nbsp;15:16:48&nbsp;2014</span>
    <span class="description">John.Macdonald [...] oicr.on.ca -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #100723] AutoReply: nested Roles broken on requires</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 16 Dec 2014 20:16:36 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Moose [...] rt.cpan.org&#34; &lt;bug-Moose [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> John Macdonald &lt;John.Macdonald [...] oicr.on.ca&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">There is a workaround suggested by Ovid in: <span class="clickylink"><a target="new" rel="nofollow" href="http://blogs.perl.org/users/ovid/2014/12/the-mooserole-required-attributes-bug.html">http://blogs.perl.org/users/ovid/2014/12/the-mooserole-required-attributes-bug.html</a></span>

Simply add:
    sub attribute_name;
in the role that defines the attribute that is required by a nested role.  While a full solution would be nice, documenting this in the description of &#39;requires&#39; &#40;and perhaps also in the error message for a requires failure&#41; would be adequate to make this far less urgent.

John Macdonald
Software Engineer

Ontario Institute for Cancer Research
MaRS Centre

661 University Avenue

Suite 510
Toronto, Ontario

Canada M5G 0A3


Tel:

Email: John.Macdonald@oicr.on.ca

Toll-free: 1-866-678-6427
Twitter: @OICR_news


www.oicr.on.ca

This message and any attachments may contain confidential and/or privileged information for the sole use of the intended recipient. Any review or distribution by anyone other than the person for whom it was originally intended is strictly prohibited. If you have received this message in error, please contact the sender and delete all copies. Opinions, conclusions or other information contained in this message may not be that of the organization.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">________________________________________
From: Bugs in Moose via RT [bug-Moose@rt.cpan.org]
Sent: December 5, 2014 12:28 PM
To: John Macdonald
Subject: [rt.cpan.org #100723] AutoReply: nested Roles broken on requires

Greetings,

This message has been automatically generated in response to the
creation of a trouble ticket regarding:
        &#34;nested Roles broken on requires&#34;,
a summary of which appears below.

There is no need to reply to this message right now.  Your ticket has been
assigned an ID of [rt.cpan.org #100723].  Your ticket is accessible
on the web at:

    <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=100723">https://rt.cpan.org/Ticket/Display.html?id=100723</a></span>

Please include the string:

         [rt.cpan.org #100723]

in the subject line of all future correspondence about this issue. To do so,
you may reply to this message.

                        Thank you,
                        bug-Moose@rt.cpan.org

-------------------------------------------------------------------------
If a role wishes to consume another role as part of its implementation, and the consumed role has a &#39;requires&#39; that must be provided; the consuming role can be written as a self-contained role.

The search for &#39;requires&#39; values is done in the grand&#40;n&#41;parent consumer &#40;the top level consumer which is not a role&#41;.  Attributes and methods provided by the parent role do not get installed into the top level object until the end of processing of the &#39;with&#39; statement.  So, they have not yet been installed at the point when the parent role tries to consume the child role.

The only way to make it work is for the top level object to consume the parent role, and then, in a separate &#39;with&#39; statement, consume the child role.  &#40;Even listing both the parent and the child in the same &#39;with&#39; statement does not work - the parent&#39;s attributes/methods are not installed when the child &#39;s &#39;requires&#39; statement is processed.&#41;

This breaks encapsulation badly.  Every consumer of the parent role must be coded to provide the child role that the parent needs for its internal implementation, and must provide it in a separate with statement.  If the parent role is changed to use a different implementation, then all consuming object definitions must be found and fixed to deal with the revised internal needs of the consumed role.

I suspect that this problem is inherent in the way roles have been implemented - the attributes and methods of a collection of roles are only inserted into the final parent after they have been fully processed.  That suggests that fixing it may cause existing code to break.  I&#39;d be happy to be wrong about this though, and see someone find a safe way of fixing the problem.

In the attached tar,
BRole.pm is the child role
ARole.pm is the parent role written in a fully encapsulated way
ARoleNoWith.pm is the same role, excluding the &#39;with&#39; statement consuming BRole
ABRole.pm is a grandparent role that tries to express the separated &#39;with&#39; statement requirement to provide the encapsulation again

test1.pl is the way the non-role top level consumer &#34;should&#34; be written - only requesting the role that it is actually using - it fails because ARole&#39;s attempt to consume BRole complains about the requirement missing from &#39;main&#39; - it fails because ARole|BRole have a requirement that isn&#39;t provided in &#39;main&#39;
test2.pl re-writes the top level consumer to &#34;know&#34; that ARole also implies a need for BRole but using a single &#39;with&#39; statement
test3.pl re-writes the top level consumer with the addition implementation knowledge that the two roles must be consumed separately and in the right order - it compiles correctly
test4.pl uses the ABRole attempted workaround - it again gets the complaint thatABRole has a requirement that must be provided in &#39;main&#39;


John Macdonald
Software Engineer

Ontario Institute for Cancer Research
MaRS Centre

661 University Avenue

Suite 510
Toronto, Ontario

Canada M5G 0A3


Tel:

Email: John.Macdonald@oicr.on.ca

Toll-free: 1-866-678-6427
Twitter: @OICR_news


www.oicr.on.ca&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.oicr.on.ca/">http://www.oicr.on.ca/</a></span>&gt;

This message and any attachments may contain confidential and/or privileged information for the sole use of the intended recipient. Any review or distribution by anyone other than the person for whom it was originally intended is strictly prohibited. If you have received this message in error, please contact the sender and delete all copies. Opinions, conclusions or other information contained in this message may not be that of the organization.
</div></div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
