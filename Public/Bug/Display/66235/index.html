<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #66235 for Finance-Quote: Cdnfundlibrary isn&#39;t retrieving the newest available NAV</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #66235 for Finance-Quote: Cdnfundlibrary isn&#39;t retrieving the newest available NAV</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Finance-Quote/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Finance-Quote/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Finance-Quote/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Finance-Quote/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Finance-Quote">Finance-Quote CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">66235</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Finance-Quote/Active/">Finance-Quote</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
nul [...] ereomega.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-13576-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.17    </td>
  </tr>
  <tr id="CF-13577-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;28&nbsp;01:39:08&nbsp;2011</span>
    <span class="description">nul [...] ereomega.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Cdnfundlibrary isn&#39;t retrieving the newest available NAV</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The row of the table Cdnfundlibrary retrieves is the second to most
recent &#40;top&#41; row. The following current code

94          # Fund price and date
95          $row = $rows[1];

should be changed to

94          # Fund price and date
95          $row = $rows[0];

so that the newest available NAV is retrieved. A patched version of
v.1.17 is attached.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Cdnfundlibrary.pm</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w

#  Cdnfundlibrary.pm
#
#  Version 0.6 retrieve more data via different fundlibrary.com url
#  Version 0.5 made functional again
#  Version 0.4 fixed up multiple lookup  &#40;March 3, 2001&#41;
#  Version 0.3 fixed up yield lookup
#  Version 0.2 functional with Finance::Quote - added error-checking
#  Version 0.1 pre trial of parsing of info from www.fundlibrary.com


package Finance::Quote::Cdnfundlibrary;
require 5.004;

use strict;

use vars qw&#40;$VERSION $FUNDLIB_URL $FUNDLIB_MAIN_URL&#41;;

use LWP::UserAgent;
use HTTP::Request::Common;
use HTML::TableExtract;

$VERSION = &#39;1.17&#39;;

# URLs of where to obtain information.

$FUNDLIB_URL =
&#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.fundlibrary.com/funds/db/_fundcard.asp?t=2&#38;id=">http://www.fundlibrary.com/funds/db/_fundcard.asp?t=2&#38;id=</a></span>&#34;&#41;;
$FUNDLIB_MAIN_URL=&#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.fundlibrary.com">http://www.fundlibrary.com</a></span>&#34;&#41;;

sub methods { return &#40;canadamutual =&gt; \&#38;fundlibrary,
                       fundlibrary =&gt; \&#38;fundlibrary&#41;; }

{
    my @labels = qw/method source link name currency last date isodate nav yield
		    price net p_change/;
    sub labels { return &#40;canadamutual =&gt; \@labels,
                          fundlibrary =&gt; \@labels&#41;; }
}

#
# =======================================================================

sub fundlibrary   {
    my $quoter = shift;
    my @symbols = @_;

    # Make sure symbols are requested  
    ##CAN exit more gracefully - add later##

    return unless @symbols;

    # Local Variables
    my&#40;%fundquote, $mutual&#41;;
    my&#40;$ua, $url, $reply, $ts, $row, $rowhd, $te, @rows, @ts&#41;;

    $ua = $quoter-&gt;user_agent;

    foreach &#40;@symbols&#41; {

      $mutual = $_;
      $url = &#34;$FUNDLIB_URL$mutual&#34;;
      $reply = $ua-&gt;request&#40;GET $url&#41;;
      $te = new HTML::TableExtract&#40;headers =&gt; [&#34;Date&#34;, &#34;NAVPS&#34;],
				   slice_columns =&gt; 0&#41;;

      # Make sure something is returned  ##CAN exit more gracefully - add later##
      return unless &#40;$reply-&gt;is_success&#41;;

      $te-&gt;parse&#40;$reply-&gt;content&#41;;

      # Check for a page without tables
      # This gets returned when a bad symbol name is given
      unless &#40; $te-&gt;tables &gt; 0 &#41; 
      {
	$fundquote {$mutual,&#34;success&#34;} = 0;
	$fundquote {$mutual,&#34;errormsg&#34;} = &#34;Fund name $mutual not found&#34;;
	next;
      } 
     
      # Fund name
      $reply-&gt;content =~ m#&lt;div\s+class=&#34;tSmallTitle&#34;&gt;&#40;[^&lt;]+&#41;&lt;/div&gt;#;
      $fundquote {$mutual, &#34;name&#34;} = $1;

      @rows = $te-&gt;rows;
      if&#40;@rows&#41; {
          $fundquote {$mutual, &#34;symbol&#34;} = $mutual;
          $fundquote {$mutual, &#34;currency&#34;} = &#34;CAD&#34;;
          $fundquote {$mutual, &#34;source&#34;} = $FUNDLIB_MAIN_URL;
          $fundquote {$mutual, &#34;link&#34;} = $url;
          $fundquote {$mutual, &#34;method&#34;} = &#34;fundlibrary&#34;;

          # Fund price and date
	  $row = $rows[0];
          $fundquote {$mutual, &#34;price&#34;} =  $$row[2];
          $fundquote {$mutual, &#34;nav&#34;} = $$row[2];
          $fundquote {$mutual, &#34;last&#34;} = $$row[2];
          $fundquote {$mutual, &#34;net&#34;} = $$row[3];
          $fundquote {$mutual, &#34;p_change&#34;} = $$row[4];

	  $quoter-&gt;store_date&#40;\%fundquote, $mutual, {usdate =&gt; $$row[0]}&#41;;

          # Assume things are fine here.
          $fundquote {$mutual, &#34;success&#34;} = 1;

          # Performance yield
          $fundquote {$mutual, &#34;yield&#34;} = $$row[5] if &#40;$$row[5] ne &#34;--&#34;&#41;;
      }
      else {
          $fundquote {$mutual, &#34;success&#34;} = 0;
          $fundquote {$mutual, &#34;errormsg&#34;} = &#34;Fund Not Found&#34;;
      }


   } #end symbols

   return %fundquote if wantarray;
   return \%fundquote;

}

1;

=head1 NAME

Finance::Quote::Cdnfundlibrary  - Obtain mutual fund prices from
www.fundlibrary.com

=head1 SYNOPSIS

    use Finance::Quote;

    $q = Finance::Quote-&gt;new;

    %stockinfo = $q-&gt;fetch&#40;&#34;canadamutual&#34;,&#34;fundlib-code&#34;&#41;; # Can
failover to other methods
    %stockinfo = $q-&gt;fetch&#40;&#34;fundlibrary&#34;,&#34;fundlib-code&#34;&#41;; # Use this
module only.

    # NOTE: currently no failover methods exist for canadamutual

=head1 DESCRIPTION

This module obtains information about Canadian Mutual Fund prices from
www.fundlibrary.com.  The information source &#34;canadamutual&#34; can be used
if the source of prices is irrelevant, and &#34;fundlibrary&#34; if you
specifically want to use www.fundlibrary.com.

=head1 FUNDLIB-CODE

In Canada a mutual fund does not have a unique global symbol identifier.

This module uses an id that represents the mutual fund on an id used by
www.fundlibrary.com.  There is no easy way of fetching the id except
to jump onto the fundlibrary website, look up the fund and view the url
for clues to its id number.

=head1 LABELS RETURNED

Information available from fundlibrary may include the following labels:

exchange method link source name currency yield last nav price.  The
link
label will be a url location for a one page snapshot that fundlibrary
provides
on the fund.

=head1 SEE ALSO

Fundlibrary website - <span class="clickylink"><a target="new" rel="nofollow" href="http://www.fundlibrary.com/">http://www.fundlibrary.com/</a></span>

Finance::Quote

=cut

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;16&nbsp;11:29:54&nbsp;2012</span>
    <span class="description">sbrabec [...] suse.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> sbrabec [...] suse.cz</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Proposed fix as a patch.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> perl-Finance-Quote-66235-Cdnfundlibrary-row.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=66235">https://rt.cpan.org/Public/Bug/Display.html?id=66235</a></span>

Subject: Cdnfundlibrary isn&#39;t retrieving the newest available NAV
Date: Mon Feb 28 01:39:08 2011 nul [...] ereomega.net - Ticket created

The row of the table Cdnfundlibrary retrieves is the second to most
recent &#40;top&#41; row. The following current code should be changed
so that the newest available NAV is retrieved.

Index: finance-quote/lib/Finance/Quote/Cdnfundlibrary.pm
===================================================================
--- finance-quote.orig/lib/Finance/Quote/Cdnfundlibrary.pm
+++ finance-quote/lib/Finance/Quote/Cdnfundlibrary.pm
@@ -92,7 +92,7 @@ sub fundlibrary   {
           $fundquote {$mutual, &#34;method&#34;} = &#34;fundlibrary&#34;;
 
           # Fund price and date
-	  $row = $rows[1];
+	  $row = $rows[0];
           $fundquote {$mutual, &#34;price&#34;} =  $$row[2];
           $fundquote {$mutual, &#34;nav&#34;} = $$row[2];
           $fundquote {$mutual, &#34;last&#34;} = $$row[2];
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;16&nbsp;11:29:56&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
