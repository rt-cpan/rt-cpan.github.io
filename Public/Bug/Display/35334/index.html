<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #35334 for Archive-Zip: Filename Encoding by Archive::Zip</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #35334 for Archive-Zip: Filename Encoding by Archive::Zip</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Archive-Zip/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Archive-Zip/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Archive-Zip/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Archive-Zip/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Archive-Zip">Archive-Zip CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">35334</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Archive-Zip/Active/">Archive-Zip</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Torsten.Werner [...] assyst-intl.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-2540-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-2541-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;23&nbsp;08:10:26&nbsp;2008</span>
    <span class="description">Torsten.Werner [...] assyst-intl.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Filename Encoding by Archive::Zip</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 23 Apr 2008 14:09:56 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-archive-zip [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Torsten.Werner [...] assyst-intl.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">

Hi all,
There is a small problems in Archive::Zip running on Windows:
When a file name contains non ASCII-characters the file name is encoded in
the codepage for non-unicode applications. There is no unzip tool which can
extract this files properly.
When I change the encoding of the file names into the codepage used by cmd,
it is working fine.

But the basic problem is, that the archive does not include any information
about file name encoding at all.
With the current version of ZIP-specification is it possible to insert file
names utf8 encoded. The specification is available here:
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.pkware.com/documents/casestudies/APPNOTE.TXT">http://www.pkware.com/documents/casestudies/APPNOTE.TXT</a></span>

I did a few tests, it is working fine with SecureZip &#40;made by PKWare,
maintainer of the ZIP specification&#41;. With this option is it possible to
exchange the archives between systems with different encoding on the
terminal. Perhaps we can&#39;t extract it by Archive::Zip caused by Perl
limitations, but any other specification compliant unpacker can do that.

Here I have a small function used by me for tests. It would be great when
you implement such a functionality in Archive::Zip.
I would support you for that if you like.

#################### cut here ##################

use strict;

use Archive::Zip qw&#40; :ERROR_CODES :CONSTANTS &#41;;
use Encode;

use constant GPBF_is_utf8 =&gt; pack&#40;&#39;S&#39;,0x0800&#41;; # Bit 11 -&gt; utf8
use constant cdExtra_is_unicode_path =&gt; pack&#40;&#39;S&#39;,0x7075&#41;;
use constant cdExtra_is_unicode_comment =&gt; pack&#40;&#39;S&#39;,0x6375&#41;;

sub append_utf8_name&#40;$$$&#41;
# append the utf8 name to central directory extra field
{
             local $_;
             my &#40;$id,$name,$crc32&#41;=@_;
             my $new_part=cdExtra_is_unicode_path;
             my $utf8_name=encode&#40;&#39;utf8&#39;,$name&#41;;
             use bytes;
             my $length=length&#40;$utf8_name&#41;+5; # version + crc32
             $new_part.=pack&#40;&#39;S&#39;,$length&#41;;
             $new_part.=chr&#40;1&#41;;
             $new_part.=pack&#40;&#34;N&#34;,$crc32&#41;;
             $new_part.=$utf8_name;
             return $id.$new_part;
}

sub fix_zip_archive&#40;$$$&#41;
# change encoding of file names into Terminal Codepage by default, utf8 if
second parameter is set
# append the file name as utf8 to extra field if 3rd parameter is set
{
             my &#40;$zip,$utf8_names,$utf8_central_directory_entries&#41;=@_;
             foreach my $member &#40;$zip-&gt;members&#40;&#41;&#41; {
                         my
$filename=CodingInfo::OSDecode&#40;$member-&gt;fileName&#40;&#41;&#41;;
                         my $new_filename=$utf8_names ?
encode&#40;&#39;utf8&#39;,$filename&#41; : encode&#40;CodingInfo::TermEncoding&#40;&#41;,$filename&#41;;
                         $member-&gt;{fileName} = $new_filename;
                         $member-&gt;{bitFlag} = $member-&gt;{bitFlag} | 0x0800
if $utf8_names;

$member-&gt;cdExtraField&#40;append_utf8_name&#40;$member-&gt;cdExtraField&#40;&#41;,$filename,Archive::Zip::computeCRC32&#40;$new_filename&#41;&#41;&#41;
 if $utf8_central_directory_entries;

$zip-&gt;replaceMember&#40;CodingInfo::OSEncode&#40;$filename&#41;,$member&#41;;
             }
             return $zip;
}

### now the archive creation.
# make a directory with non-ascii file names for tests like this:
# ZIP-Test/
# ZIP-Test/Ärger.txt
# ZIP-Test/Häßliche Zeichen/
# ZIP-Test/Häßliche Zeichen/Öde Ümläute.txt

my $hash={
             full =&gt; [&#34;PerlZipTest_full.zip&#34;,1,1], # name in utf8, extra
field entry. Readable by SecureZip
             cde =&gt; [&#34;PerlZipTest_cde.zip&#34;,0,1], # name in terminal
codepage, extra field entry. Readable by SecureZip everywhere and by any
other windows extraction tool as long as we have the same codepage on
terminal
             header =&gt; [&#34;PerlZipTest_header.zip&#34;,1,0], # name in utf8, no
extra field entry. Readable by SecureZip everywhere
             compatible =&gt; [&#34;PerlZipTest_compatible.zip&#34;,0,0],  # name in
terminal codepage. Readable by any windows extraction tool as long as we
have the same codepage on terminal
};

my $dir=&#34;ZIP-Test&#34;;

foreach my $key &#40;keys %$hash&#41; {
             my $zip=new Archive::Zip;
             die &#34;Error adding tree for directory &#39;$dir&#39;&#34; unless
&#40;$zip-&gt;addTree&#40; $dir, &#39;&#39;&#41; == AZ_OK&#41;;
             my $name=$hash-&gt;{$key}-&gt;[0];
             fix_zip_archive&#40;$zip,$hash-&gt;{$key}-&gt;[1],$hash-&gt;{$key}-&gt;[2]&#41;;
             die &#34;Error writing zip &#39;$name&#39;&#34; unless
$zip-&gt;writeToFileNamed&#40;$name&#41; ==AZ_OK;
}


###########################################
# here the functions for encoding/decoding:
# &#40;it is a part of a other module, sorry for
# the sepparate package
###########################################

package CodingInfo;
require 5.008_007;

use strict;
require Exporter;
our @ISA=&#40;&#34;Exporter&#34;&#41;;
our @EXPORT = qw&#40;
      OSEncoding
      TermEncoding
      OSDecode
      OSEncode
&#41;;

use Carp qw&#40;confess&#41;;
use Encode;
use if &#40;$^O eq &#39;MSWin32&#39;&#41;, &#34;Win32::TieRegistry&#34;;

sub WinCodepage&#40;&#41;;
sub CmdCodepage&#40;&#41;;
sub OSEncoding&#40;&#41;;
sub TermEncoding&#40;&#41;;
sub OSDecode&#40;$&#41;;
sub OSEncode&#40;$&#41;;

my $Registry={};
if &#40;$^O eq &#39;MSWin32&#39;&#41; {
      $Registry=$Win32::TieRegistry::Registry-&gt;Open&#40;
            &#34;&#34;,
            {
                  Access=&gt;Win32::TieRegistry::KEY_READ&#40;&#41;,
                  Delimiter=&gt;&#34;\\&#34;
            }
      &#41;;
      confess &#34;Unable to open registry in read-only mode&#34; unless &#40;defined
$Registry&#41;
}

sub OSDecode&#40;$&#41;
{
      return decode&#40;OSEncoding,shift&#41;;
}

sub OSEncode&#40;$&#41;
{
      return encode&#40;OSEncoding,shift&#41;;
}

sub WinCodepage &#40;&#41;
{
      my
$cp=$Registry-&gt;{&#34;LMachine\\SYSTEM\\CurrentControlSet\\Control\\Nls\\CodePage\\\\ACP&#34;};
      $cp=&#34;1252&#34; unless &#40;defined $cp&#41;;
      return sprintf&#40;&#39;cp%s&#39;,$cp&#41;;
}

sub CmdCodepage &#40;&#41;
{
      my
$cp=$Registry-&gt;{&#34;LMachine\\SYSTEM\\CurrentControlSet\\Control\\Nls\\CodePage\\\\OEMCP&#34;};
      $cp=&#34;850&#34; unless &#40;defined $cp&#41;;
      return sprintf&#40;&#39;cp%s&#39;,$cp&#41;;
}

sub OSEncoding&#40;&#41;
{
      return WinCodepage&#40;&#41; if $^O eq &#39;MSWin32&#39;;
      return TermEncoding;
}


sub TermEncoding&#40;&#41;
{
      local $_;
      return CmdCodepage&#40;&#41; if &#40;$^O eq &#39;MSWin32&#39;&#41;;
      my @lang_settings=`locale`;
      chomp @lang_settings;
      my $lang_settings={};
      foreach &#40;@lang_settings&#41; {
            my &#40;$name,$value&#41;=split /=/,$_,2;
            $lang_settings-&gt;{$name}=$value;
      }
      ENV: foreach &#40;&#39;LC_CTYPE&#39;, &#39;LC_ALL&#39;, &#39;LANG&#39;&#41; {
            if &#40;$lang_settings-&gt;{$_}&#41; {
                  my $lang=$lang_settings-&gt;{$_};
                  $lang=~s/^&#34;//;
                  $lang=~s/&#34;$//;
                  $lang=~s/^.+\.//;
                  $lang=~s/\@euro//;
                  $lang=&#39;iso88591&#39; if $lang eq &#39;C&#39;;
                  $lang=&#39;hp-roman8&#39; if $lang eq &#39;roman8&#39;;
                  $lang=~s/8859/-8859-/;
                  return $lang;
            }
      }
      return &#39;iso-8859-1&#39;;
}

##################### cut here #################

Bye
Torsten Werner
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
