<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #77902 for Mail-DKIM: DKIM signature computation very long on large messages</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #77902 for Mail-DKIM: DKIM signature computation very long on large messages</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Mail-DKIM">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Mail-DKIM">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Mail-DKIM">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Mail-DKIM">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-DKIM">Mail-DKIM CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">77902</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Mail-DKIM">Mail-DKIM</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">jason [...] long.name
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
david.verdin [...] renater.fr

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">
Mark.Martinec [...] ijs.si

<br />

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-38938-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.39    </td>
  </tr>
  <tr id="CF-38939-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




Mail-DKIM-PR77902.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1137592/598713/Mail-DKIM-PR77902.patch">
Wed Nov 07 13:49:21 2012 (2.3k) by Mark.Martinec [...] ijs.si
</a>
</font></li>
</ul>


MessageParser.pm<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1133446/596445/MessageParser.pm">
Fri Oct 26 15:23:35 2012 (2.2k) by Mark.Martinec [...] ijs.si
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=77902">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1091370" href="/Public/Bug/Display.html?id=77902#txn-1091370">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;19&nbsp;10:57:17&nbsp;2012</span>
    <span class="description">david.verdin [...] renater.fr -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> DKIM signature computation very long on large messages</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1091370/573705/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/573705">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I recently had Sympa choking on large messages while trying to compute a
DKIM signature for large messages &#40;with an attachment larger than 7 MB&#41;.

Here is the environment:

Perl 5.8.8
OS RHEL 5

The bug is due to the PRINT function in MessageParser.pm iterating over
a linearilly growing string buffer. Hence, the larger the message is,
the longer &#40;exponentially&#41; the signing process takes.

I found that applying the following patch to MessageParser.pm brings the
signing process back to a linear dimension, which, for a 7 MB
attachment, means signing in one-two seconds instead of 40 minutes.

I am under the impression that these changes won&#39;t break anything in the
constitution of the signature, but I may have missed something important
in the module.

Please, let me know if the patch is wrong.

Regards,

David

Here is the patch: 

50,51c50
&lt;       my $buf = $self-&gt;{buf};
&lt;       $buf .= @_ == 1 ? $_[0] : join&#40;&#34;&#34;, @_&#41;  if @_;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       my $buf = @_ == 1 ? $_[0] : join&#40;&#34;&#34;, @_&#41;  if @_;
</div>81c80
&lt;       $self-&gt;{buf} = $buf;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       $self-&gt;{buf} .= $buf;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1133446" href="/Public/Bug/Display.html?id=77902#txn-1133446">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;26&nbsp;15:23:35&nbsp;2012</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark.Martinec [...] ijs.si</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1133446/596444/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/596444">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The bug is due to the PRINT function in MessageParser.pm iterating
&gt; over a linearilly growing string buffer. Hence, the larger the
&gt; message is, the longer &#40;exponentially&#41; the signing process takes.
</div>
This is not the case in a normal situation, the stored buffer
should not be growing. Each call to PRINT should process
whatever it can in the buffer and leave there only the last
unterminated line - a leftover to be processed with the next
call.

Your situation can only arise if you are feeding chunks
of a huge line, piece by piece. Seems the problem here is
that the application forgot to convert newlines to CRLF pairs,
so that a whole message looks to Mail::DKIM as one huge line,
and calls to PRINT could not process anything &#40;no full line
so far&#41; until a CLOSE, so could only keep collecting the text.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Here is the patch: 
&gt; 
&gt; 50,51c50
&gt; &lt;     my $buf = $self-&gt;{buf};
&gt; &lt;     $buf .= @_ == 1 ? $_[0] : join&#40;&#34;&#34;, @_&#41;  if @_;
&gt; ---
<div class="message-stanza open">&gt; &gt;     my $buf = @_ == 1 ? $_[0] : join&#40;&#34;&#34;, @_&#41;  if @_;
</div>&gt; 81c80
&gt; &lt;     $self-&gt;{buf} = $buf;
&gt; ---
<div class="message-stanza open">&gt; &gt;     $self-&gt;{buf} .= $buf;
</div></div>
This is also wrong: whatever leftover remains in $self-&gt;{buf}
should stay there for the next call, which should concatenate
the leftover with newly supplied arguments.


Nevertheless I do agree that the PRINT subroutine performs
some unnecessary copying. Avoiding this could save a little
bit of resources. I did some benchmarking and I&#39;ll attach
a replacement MessageParser.pm, which accesses the buffer
indirectly through a ref, avoiding copying or accessing
it through a hash. If an application passes a message
in large chunks to PRINT the speedup is very small,
while an application that does so inefficiently by calling
PRINT line-by-line can see some improvement in speed.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> MessageParser.pm</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1133446/596445/MessageParser.pm">Download MessageParser.pm</a><br />
<span class="downloadcontenttype">text/x-perl 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

# Copyright 2005 Messiah College. All rights reserved.
# Jason Long &lt;jlong@messiah.edu&gt;

# Copyright &#40;c&#41; 2004 Anthony D. Urso. All rights reserved.
# This program is free software; you can redistribute it and/or
# modify it under the same terms as Perl itself.

use strict;
use warnings;

package Mail::DKIM::MessageParser;
use Carp;

sub new_object
{
	my $class = shift;
	return $class-&gt;TIEHANDLE&#40;@_&#41;;
}

sub new_handle
{
	my $class = shift;
	local *TMP;
	tie *TMP, $class, @_;
	return *TMP;
}

sub TIEHANDLE
{
	my $class = shift;
	my %args = @_;
	my $self = bless \%args, $class;
	$self-&gt;init;
	return $self;
}

sub init
{
	my $self = shift;

        my $buf = &#34;&#34;;
	$self-&gt;{buf_ref} = \$buf;
	$self-&gt;{in_header} = 1;
}

sub PRINT
{
	my $self = shift;
	my $buf_ref = $self-&gt;{buf_ref};
	$$buf_ref .= @_ == 1 ? $_[0] : join&#40;&#34;&#34;, @_&#41;  if @_;

	if &#40;$self-&gt;{in_header}&#41; {
		local $1;  # avoid polluting a global $1
		while &#40;$$buf_ref ne &#39;&#39;&#41;
		{
			if &#40;substr&#40;$$buf_ref,0,2&#41; eq &#34;\015\012&#34;&#41;
			{
				substr&#40;$$buf_ref, 0, 2&#41; = &#39;&#39;;
				$self-&gt;finish_header&#40;&#41;;
				$self-&gt;{in_header} = 0;
				last;
			}
			if &#40;$$buf_ref !~ /^&#40;.+?\015\012&#41;[^\ \t]/s&#41;
			{
				last;
			}
			my $header = $1;
			$self-&gt;add_header&#40;$header&#41;;
			substr&#40;$$buf_ref, 0, length&#40;$header&#41;&#41; = &#39;&#39;;
		}
	}

	if &#40;!$self-&gt;{in_header}&#41; {
		my $j = rindex&#40;$$buf_ref,&#34;\015\012&#34;&#41;;
		if &#40;$j &gt;= 0&#41;
		{
			$self-&gt;add_body&#40;substr&#40;$$buf_ref, 0, $j+2&#41;&#41;;
			substr&#40;$$buf_ref, 0, $j+2&#41; = &#39;&#39;;
		}
	}
	return 1;
}

sub CLOSE
{
	my $self = shift;
	my $buf_ref = $self-&gt;{buf_ref};

	if &#40;$self-&gt;{in_header}&#41;
	{
		if &#40;$$buf_ref ne &#39;&#39;&#41;
		{
			# A line of header text ending CRLF would not have been
			# processed yet since before we couldn&#39;t tell if it was
			# the complete header. Now that we&#39;re in CLOSE, we can
			# finish the header...
			$$buf_ref =~ s/\015\012\z//s;
			$self-&gt;add_header&#40;&#34;$$buf_ref\015\012&#34;&#41;;
		}
		$self-&gt;finish_header;
		$self-&gt;{in_header} = 0;
	}
	else
	{
		if &#40;$$buf_ref ne &#39;&#39;&#41;
		{
			$self-&gt;add_body&#40;$$buf_ref&#41;;
		}
	}
	$$buf_ref = &#34;&#34;;
	$self-&gt;finish_body;
	return 1;
}

sub add_header
{
	die &#34;add_header not implemented&#34;;
}

sub finish_header
{
	die &#34;finish_header not implemented&#34;;
}

sub add_body
{
	die &#34;add_body not implemented&#34;;
}

sub finish_body
{
	# do nothing by default
}

sub reset
{
	carp &#34;reset not implemented&#34;;
}

1;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1133449" href="/Public/Bug/Display.html?id=77902#txn-1133449">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;26&nbsp;15:23:36&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1137592" href="/Public/Bug/Display.html?id=77902#txn-1137592">#</a>      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;07&nbsp;13:49:21&nbsp;2012</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark.Martinec [...] ijs.si</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1137592/598712/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/598712">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 303b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">While at it...

Here is a refinement of my previous attachment, this time in
a form of a patch. In addition to what the previous code did,
this one also avoids one more copying of a buffer, shaving off
another millisecond or two &#40;out of 50 ms&#41; on larger mail
&#40;3 MB&#41; with larger buffers &#40;32 kB or 64 kB&#41;.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Mail-DKIM-PR77902.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1137592/598713/Mail-DKIM-PR77902.patch">Download Mail-DKIM-PR77902.patch</a><br />
<span class="downloadcontenttype">text/x-diff 2.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- lib/Mail/DKIM/MessageParser.pm~	2008-08-26 00:10:56.000000000 +0200
+++ lib/Mail/DKIM/MessageParser.pm	2012-11-07 19:30:01.127433685 +0100
@@ -41,6 +41,7 @@
 	my $self = shift;
 
+	my $buf = &#39;&#39;;
+	$self-&gt;{buf_ref} = \$buf;
 	$self-&gt;{in_header} = 1;
-	$self-&gt;{buf} = &#34;&#34;;
 }
 
@@ -48,18 +49,19 @@
 {
 	my $self = shift;
-	my $buf = $self-&gt;{buf};
-	$buf .= @_ == 1 ? $_[0] : join&#40;&#34;&#34;, @_&#41;  if @_;
+	my $buf_ref = $self-&gt;{buf_ref};
+	$$buf_ref .= @_ == 1 ? $_[0] : join&#40;&#34;&#34;, @_&#41;  if @_;
 
 	if &#40;$self-&gt;{in_header}&#41; {
-		while &#40;length $buf&#41;
+		local $1;  # avoid polluting a global $1
+		while &#40;$$buf_ref ne &#39;&#39;&#41;
 		{
-			if &#40;substr&#40;$buf,0,2&#41; eq &#34;\015\012&#34;&#41;
+			if &#40;substr&#40;$$buf_ref,0,2&#41; eq &#34;\015\012&#34;&#41;
 			{
-				$buf = substr&#40;$buf, 2&#41;;
+				substr&#40;$$buf_ref, 0, 2&#41; = &#39;&#39;;
 				$self-&gt;finish_header&#40;&#41;;
 				$self-&gt;{in_header} = 0;
 				last;
 			}
-			if &#40;$buf !~ /^&#40;.+?\015\012&#41;[^\ \t]/s&#41;
+			if &#40;$$buf_ref !~ /^&#40;.+?\015\012&#41;[^\ \t]/s&#41;
 			{
 				last;
@@ -67,17 +69,21 @@
 			my $header = $1;
 			$self-&gt;add_header&#40;$header&#41;;
-			$buf = substr&#40;$buf, length&#40;$header&#41;&#41;;
+			substr&#40;$$buf_ref, 0, length&#40;$header&#41;&#41; = &#39;&#39;;
 		}
 	}
 
 	if &#40;!$self-&gt;{in_header}&#41; {
-		my $j = rindex&#40;$buf,&#34;\015\012&#34;&#41;;
+		my $j = rindex&#40;$$buf_ref,&#34;\015\012&#34;&#41;;
 		if &#40;$j &gt;= 0&#41;
 		{
-			$self-&gt;add_body&#40;substr&#40;$buf, 0, $j+2&#41;&#41;;
-			substr&#40;$buf, 0, $j+2&#41; = &#39;&#39;;
+			# avoid copying a large buffer: the unterminated
+			# last line is typically short compared to the rest
+
+			my $carry = substr&#40;$$buf_ref, $j+2&#41;;
+			substr&#40;$$buf_ref, $j+2&#41; = &#39;&#39;;  # shrink to last CRLF
+			$self-&gt;add_body&#40;$$buf_ref&#41;;    # must end on CRLF
+			$$buf_ref = $carry;  # restore unterminated last line
 		}
 	}
-	$self-&gt;{buf} = $buf;
 	return 1;
 }
@@ -86,9 +92,9 @@
 {
 	my $self = shift;
-	my $buf = $self-&gt;{buf};
+	my $buf_ref = $self-&gt;{buf_ref};
 
 	if &#40;$self-&gt;{in_header}&#41;
 	{
-		if &#40;length $buf&#41;
+		if &#40;$$buf_ref ne &#39;&#39;&#41;
 		{
 			# A line of header text ending CRLF would not have been
@@ -96,6 +102,6 @@
 			# the complete header. Now that we&#39;re in CLOSE, we can
 			# finish the header...
-			$buf =~ s/\015\012$//s;
-			$self-&gt;add_header&#40;&#34;$buf\015\012&#34;&#41;;
+			$$buf_ref =~ s/\015\012\z//s;
+			$self-&gt;add_header&#40;&#34;$$buf_ref\015\012&#34;&#41;;
 		}
 		$self-&gt;finish_header;
@@ -104,10 +110,10 @@
 	else
 	{
-		if &#40;length $buf&#41;
+		if &#40;$$buf_ref ne &#39;&#39;&#41;
 		{
-			$self-&gt;add_body&#40;$buf&#41;;
+			$self-&gt;add_body&#40;$$buf_ref&#41;;
 		}
 	}
-	$self-&gt;{buf} = &#34;&#34;;
+	$$buf_ref = &#39;&#39;;
 	$self-&gt;finish_body;
 	return 1;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1148206" href="/Public/Bug/Display.html?id=77902#txn-1148206">#</a>      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;28&nbsp;10:00:43&nbsp;2012</span>
    <span class="description">jason [...] long.name -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1148207" href="/Public/Bug/Display.html?id=77902#txn-1148207">#</a>      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;28&nbsp;10:00:58&nbsp;2012</span>
    <span class="description">jason [...] long.name -  AdminCc Mark.Martinec@ijs.si added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1148208" href="/Public/Bug/Display.html?id=77902#txn-1148208">#</a>      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;28&nbsp;10:12:01&nbsp;2012</span>
    <span class="description">jason [...] long.name -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1148208/603831/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/603831">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 961b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi David,

As Mark said, the buffer should not be growing with each successive call
to PRINT. Every time it sees a line terminator, it should consume the
line and remove that from the buffer. His theory, that you are not
feeding in input with the proper line terminators, seems plausible and
is likely the reason for the symptoms you are seeing.

&#40;The reason Mail::DKIM requires CRLF line termination was in an attempt
to make it more compliant to the DKIM specifications, but in hindsight I
think I should&#39;ve taken a more pragmatic approach. Oh well...&#41;


Mark- I&#39;ve taken your patch, thanks. I appreciate your help with this
module and the performance analysis you&#39;ve done on this and prior
occasions :&#41;. If I&#39;m not mistaken, the code is still re-iterating
through the whole buffer to look for the CRLF, is that right? I wonder
if it is worth redesigning the code to avoid that extra work, even
though it&#39;s only really problem when used incorrectly...


Jason
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1148309" href="/Public/Bug/Display.html?id=77902#txn-1148309">#</a>      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;28&nbsp;14:08:30&nbsp;2012</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark.Martinec [...] ijs.si</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1148309/603899/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/603899">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1012b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If I&#39;m not mistaken, the code is still re-iterating
&gt; through the whole buffer to look for the CRLF, is that right?
</div>
Not exactly, the rindex&#40;&#41; searches for a CRLF in reverse,
starting from the end of a buffer. Under normal circumstances
that should amount to 30 or 40 characters scanned for every
submitted buffer &#40;perhaps a 16 kB .. 64 kB chunk with each
call to PRINT for optimal results&#41;, which should be negligible.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I wonder if it is worth redesigning the code to avoid that
&gt; extra work, even though it&#39;s only really problem when used
&gt; incorrectly...
</div>
Guaranteeing that multiline text chunks are terminated by
a CRLF when they are passed downstream to canonicalization
algorithms simplifies these algorithms hence making them faster,
as they do not need to check and deal with a situation of a
split CR LF across subsequent calls. So a small penalty in
pre-processing yields a benefit in further processing.
I guess there are other possible approaches, but they would
need to be carefully benchmarked.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1177389" href="/Public/Bug/Display.html?id=77902#txn-1177389">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;04&nbsp;14:20:44&nbsp;2013</span>
    <span class="description">jason [...] long.name -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1177389/621076/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/621076">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 214b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Version 0.39_6, containing Mark&#39;s patch for this bug, has been released to 
CPAN for testing. I intend to release this as version 0.40 later this 
week, if I do not discover any problems with the new version.
Jason
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1178510" href="/Public/Bug/Display.html?id=77902#txn-1178510">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;07&nbsp;15:32:17&nbsp;2013</span>
    <span class="description">jason [...] long.name -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1178510/621682/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/621682">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 155b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Version 0.40, containing the fix for this bug, is now on its way to CPAN. 
Should show up there in a couple hours. I&#39;m going to mark this ticket 
resolved.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1178513" href="/Public/Bug/Display.html?id=77902#txn-1178513">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;07&nbsp;15:32:19&nbsp;2013</span>
    <span class="description">jason [...] long.name -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.572532</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
