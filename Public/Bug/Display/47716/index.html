<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #47716 for perl-Tk: Tk::Animation not freeing memory when object goes out of scope</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #47716 for perl-Tk: Tk::Animation not freeing memory when object goes out of scope</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/perl-Tk/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/perl-Tk/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/perl-Tk/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/perl-Tk/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>






<div class="error">
  <div class="titlebox error " id="">
  <div class="titlebox-title">
    <span class="left">Queue is disabled</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--error----UXVldWUgaXMgZGlzYWJsZWQ_---0">


This queue is disabled and you may not create new tickets in it.  Disabled queues are usually because the distribution was merged with another or changed names.  Sometimes they are the end result of a bad autocreate from PAUSE data before anyone noticed.
    <hr class="clear" />
  </div>
</div>




</div>


<h3>Maintainer&#40;s&#41;&#39; notes</h3>

<p><a href="https://rt.cpan.org/Public/Dist/Tk/Active/">Use Tk instead</a>.</p>



<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">47716</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/perl-Tk/Active/">perl-Tk</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
t.kane [...] mindspring.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-25264-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
800.023    </td>
  </tr>
  <tr id="CF-25265-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;08&nbsp;15:03:21&nbsp;2009</span>
    <span class="description">t.kane [...] mindspring.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Tk::Animation not freeing memory when object goes out of scope</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">package Tk::Animation;
$VERSION = &#39;4.006&#39;; # $Id: //depot/Tkutf8/Tk/Animation.pm#8 $
package Tk::Animation;

perl, v5.8.8 built for MSWin32-x86-multi-thread
Binary build 822 [280952] provided by ActiveState

No error messages, just dramatic slowdown in system operation

===============================================================

I was having a serious problem with Tk::Animation because running a
series of very large animated gif&#39;s &#40;e.g., 100-900Kb&#41; would eventually
bog down the system. I presumed that memory references were not being
dropped so the memory was accumulating. That was unacceptable for an
application I am developing.

I looked at how Animation.pm managed multiple animated gif frames and
discovered that they were being placed into an anonymous array in the
object&#39;s &#39;self&#39;-hash. I couldn&#39;t find any place where the references
were being deleted.

So I added a function that pops the reference elements off the array and
lets them simply die away. I was then able to open and close multiple
animated gifs, far more than I was ever able to do with the previous
version of Animation.pm.

Here the 2 functions &#40;it seems too simple&#41;: 

sub del_frames { #for memory release w/o waiting for garbage collector
    shift-&gt;DESTROY&#40;&#41; ;
}

sub DESTROY { 
    my $obj = shift;
    while&#40;  @{ $obj-&gt;{&#39;_frames_&#39;} } &#41; {
        pop @{ $obj-&gt;{&#39;_frames_&#39;} };
    }
}

In my application, I call del_frames after I stop using the animated gif
and it is available and effective.

I hope that this may be useful to others.

-- 
Tom Kane
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Animation.pm</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">package Tk::Animation;

use vars qw&#40;$VERSION&#41;;
$VERSION = &#39;4.006&#39;; # $Id: //depot/Tkutf8/Tk/Animation.pm#8 $

use Tk::Photo;
use base  qw&#40;Tk::Photo&#41;;

Construct Tk::Widget &#39;Animation&#39;;

sub MainWindow
{
 return shift-&gt;{&#39;_MainWIndow_&#39;};
}

sub add_frame
{
 my $obj = shift;
 $obj-&gt;{&#39;_frames_&#39;} = [] unless exists $obj-&gt;{&#39;_frames_&#39;};
 push&#40;@{$obj-&gt;{&#39;_frames_&#39;}},@_&#41;;
}

sub del_frames { #lets user force memory release w/o waiting for garbage collector
    shift-&gt;DESTROY&#40;&#41; ;
}

sub DESTROY { 
    my $obj = shift;
    while&#40;  @{ $obj-&gt;{&#39;_frames_&#39;} } &#41; {
        pop @{ $obj-&gt;{&#39;_frames_&#39;} };
    }
}

sub new
{
 my &#40;$class,$widget,%args&#41; = @_;
 my $obj = $class-&gt;SUPER::new&#40;$widget,%args&#41;;
 $obj-&gt;{&#39;_MainWIndow_&#39;} = $widget-&gt;MainWindow;
 if &#40;$args{&#39;-format&#39;} eq &#39;gif&#39;&#41;
  {
   my @images;
   local $@;
   while &#40;1&#41;
    {
     my $index = @images;
     $args{&#39;-format&#39;} = &#34;gif -index $index&#34;;
     my $img;
     eval {local $SIG{&#39;__DIE__&#39;};  $img = $class-&gt;SUPER::new&#40;$widget,%args&#41; };
     last if $@;
     push&#40;@images,$img&#41;;
    }
   if &#40;@images &gt; 1&#41;
    {
     $obj-&gt;add_frame&#40;@images&#41;;
     $obj-&gt;{&#39;_frame_index_&#39;}  = 0;
    }
  }
 $obj-&gt;set_image&#40; 0 &#41;;
 $obj-&gt;{_delta_} = 1;
 $obj-&gt;{_blank_} = 0;
 return $obj;
}

sub fast_forward {

    my&#40; $self, $delta&#41; = @_;

    $self-&gt;{_delta_} = $delta;
    if&#40; not exists $self-&gt;{_playing_} &#41; {
	my $playing = exists $self-&gt;{&#39;_NextId_&#39;};
	$self-&gt;{_playing_} = $playing;
	$self-&gt;resume_animation if not $playing;
    } else {
	my $playing = delete $self-&gt;{_playing_};
	$self-&gt;pause_animation if not $playing;
    }

} # end fast_forward

*fast_reverse = \&#38;fast_forward;

sub frame_count {
    my $frames = shift-&gt;{&#39;_frames_&#39;};
    return -1 unless $frames;
    return @$frames;
}

=begin comment

        #comment out due to suggestion on PerlMonks Re: Tk::Animation fix

sub blank {
    my&#40; $self, $blank &#41; = @_;
    $blank = 1 if not defined $blank;
    $self-&gt;{_blank_} = $blank;
    $self-&gt;Tk::Photo::blank&#40; $blank &#41; ;
    $blank;
}

=cut

sub set_image
{
 my &#40;$obj,$index&#41;  = @_;
 my $frames = $obj-&gt;{&#39;_frames_&#39;};
 return unless $frames &#38;&#38; @$frames;
 $index = 0 unless $index &lt; @$frames;
 #$obj-&gt;blank if $obj-&gt;{_blank_};  # helps some make others worse
 $obj-&gt;blank ; #changed due to suggestion on PerlMonks Re: Tk::Animation fix &#40;orig above&#41;
 $obj-&gt;copy&#40;$frames-&gt;[$index]&#41;;
 $obj-&gt;{&#39;_frame_index_&#39;} = $index;
}

sub next_image
{
 my &#40;$obj, $delta&#41;  = @_;
 $delta = $obj-&gt;{_delta_} unless $delta;
 my $frames = $obj-&gt;{&#39;_frames_&#39;};
 return unless $frames &#38;&#38; @$frames;
 $obj-&gt;set_image&#40;&#40;&#40;$obj-&gt;{&#39;_frame_index_&#39;} || 0&#41; + $delta&#41; % @$frames&#41;;
}

sub prev_image { shift-&gt;next_image&#40; -1 &#41; }

sub pause_animation { 
    my $self = shift;
    my $id = delete $self-&gt;{&#39;_NextId_&#39;};
    Tk::catch { $id-&gt;cancel } if $id;
}

sub resume_animation {
    my&#40; $self, $period &#41; = @_;
    if&#40; not defined $self-&gt;{&#39;_period_&#39;} &#41; {
	$self-&gt;{&#39;_period_&#39;} = defined&#40; $period &#41; ? $period : 100;
    }
    $period = $self-&gt;{&#39;_period_&#39;};
    my $w = $self-&gt;MainWindow;
    $self-&gt;{&#39;_NextId_&#39;} = $w-&gt;repeat&#40; $period =&gt; [ $self =&gt; &#39;next_image&#39; ] &#41;;
}

sub start_animation
{
 my &#40;$obj,$period&#41; = @_;
 $period ||= 100;
 my $frames = $obj-&gt;{&#39;_frames_&#39;};
 return unless $frames &#38;&#38; @$frames;
 my $w = $obj-&gt;MainWindow;
 $obj-&gt;stop_animation;
 $obj-&gt;{&#39;_period_&#39;} = $period;
 $obj-&gt;{&#39;_NextId_&#39;} = $w-&gt;repeat&#40;$period,[$obj,&#39;next_image&#39;]&#41;;
}

sub stop_animation
{
 my &#40;$obj&#41; = @_;
 my $id = delete $obj-&gt;{&#39;_NextId_&#39;};
 Tk::catch { $id-&gt;cancel } if $id;
 $obj-&gt;set_image&#40;0&#41;;
}

1;
__END__

=cut

#
# This almost works for changing the animation on the fly
# but does not resize things correctly
#

sub gif_sequence
{
 my &#40;$obj,%args&#41; = @_;
 my $widget = $obj-&gt;MainWindow;
 my @images;
 local $@;
 while &#40;1&#41;
  {
   my $index = @images;
   $args{&#39;-format&#39;} = &#34;gif -index $index&#34;;
   my $img;
   eval
    {local $SIG{&#39;__DIE__&#39;};
     my $img = $widget-&gt;Photo&#40;%args&#41;;
     push&#40;@images,$img&#41;;
    };
   last if $@;
  }
 if &#40;@images&#41;
  {
   delete $obj-&gt;{&#39;_frames_&#39;};
   $obj-&gt;add_frame&#40;@images&#41;;
   $obj-&gt;configure&#40;-width =&gt; 0, -height =&gt; 0&#41;;
   $obj-&gt;set_frame&#40;0&#41;;
  }
}

</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
