<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #46739 for DBD-Oracle: OCIHandleAlloc&#40;OCI_HTYPE_ERROR&#41; on re-use of cached OCI environment handle</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #46739 for DBD-Oracle: OCIHandleAlloc&#40;OCI_HTYPE_ERROR&#41; on re-use of cached OCI environment handle</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-Oracle/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-Oracle/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-Oracle/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-Oracle/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/pythian/DBD-Oracle/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-Oracle">DBD-Oracle CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">46739</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-Oracle/Active/">DBD-Oracle</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
trheath [...] qwest.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10192-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10193-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<ul>
<li>
1.51_00</li>
<li>
1.52</li>
</ul>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;08&nbsp;12:03:11&nbsp;2009</span>
    <span class="description">trheath [...] qwest.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> OCIHandleAlloc&#40;OCI_HTYPE_ERROR&#41; on re-use of cached OCI environment handle</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 08 Jun 2009 11:02:27 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Oracle [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tim Heath &lt;trheath [...] qwest.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Environment:

Redhat RHEL5, kernel build 2.6.18-128.1.10.el5, x86_64
Perl v5.8.8 x86_64-linux-thread-multi &#40;stock RHEL5&#41;
Apache 2.2.3 &#40;stock RHEL5 using preforked workers, no multithreading&#41;
mod_perl version 2 &#40;stock RHEL5&#41;
DBI v1.607
Oracle DBD v1.22

Using apache with mod_perl, if a connect attempt is directed to a 
shutdown database, the connection fails &#40;as it should&#41; with the following:

ORA-01034: ORACLE not available
ORA-27101: shared memory realm does not exist
Linux-x86_64 Error: 2: No such file or directory &#40;DBD ERROR: 
OCISessionBegin&#41;

However, after the database is brought up again, subsequent attempts to 
connect with the same httpd worker fail with the following:

OCIHandleAlloc&#40;OCI_HTYPE_ERROR&#41; failed at
/usr/lib64/perl5/site_perl/5.8.8/x86_64-linux-thread-multi/DBD/Oracle.pm line 232

Other httpd workers that were not used while the database was down work fine. Restarting httpd clears the problem but is not a viable fix for us.

It was suggested by Tim Bunce that the problem could possibly be avoided by including &#34;ora_envhp =&gt; 0&#34; in the connect&#40;&#41;. This indeed fixed the problem. I am including Tim&#39;s comments below:

&#34;Try passing ora_envhp =&gt; 0 in the connect&#40;&#41; attributes.
 
If that fixes it then the bug is probably that dbd::oracle
should not use a cached environment handle if it&#39;s not usable.
&#40;and OCIHandleAlloc&#40;OCI_HTYPE_ERROR&#41; is a reasonable way to test that
the environment handle is usable&#41;.&#34;


Thanks,
Tim Heath
Qwest Communications
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;02&nbsp;17:09:35&nbsp;2009</span>
    <span class="description">champoux [...] pythian.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">If you could rerun your test with dbd_verbose=&gt;15 in the connection 
string and post the results here I would be able to get a good idea of 
what is going on in your systme.

Myself I do not see the same error you are reporting on my windows box.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;02&nbsp;17:09:36&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;07&nbsp;16:16:52&nbsp;2010</span>
    <span class="description">champoux [...] pythian.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have a suspision of what it might be but I will need you to help test 
the solution as it would be hard for me to recreate the error.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;24&nbsp;07:55:31&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jun 08 12:03:11 2009, trheath wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Environment:
&gt; 
&gt; Redhat RHEL5, kernel build 2.6.18-128.1.10.el5, x86_64
&gt; Perl v5.8.8 x86_64-linux-thread-multi &#40;stock RHEL5&#41;
&gt; Apache 2.2.3 &#40;stock RHEL5 using preforked workers, no multithreading&#41;
&gt; mod_perl version 2 &#40;stock RHEL5&#41;
&gt; DBI v1.607
&gt; Oracle DBD v1.22
&gt; 
&gt; Using apache with mod_perl, if a connect attempt is directed to a
&gt; shutdown database, the connection fails &#40;as it should&#41; with the
&gt; following:
&gt; 
&gt; ORA-01034: ORACLE not available
&gt; ORA-27101: shared memory realm does not exist
&gt; Linux-x86_64 Error: 2: No such file or directory &#40;DBD ERROR:
&gt; OCISessionBegin&#41;
&gt; 
&gt; However, after the database is brought up again, subsequent attempts
&gt; to
&gt; connect with the same httpd worker fail with the following:
&gt; 
&gt; OCIHandleAlloc&#40;OCI_HTYPE_ERROR&#41; failed at
&gt; /usr/lib64/perl5/site_perl/5.8.8/x86_64-linux-thread-
&gt; multi/DBD/Oracle.pm line 232
&gt; 
&gt; Other httpd workers that were not used while the database was down
&gt; work fine. Restarting httpd clears the problem but is not a viable fix
&gt; for us.
&gt; 
&gt; It was suggested by Tim Bunce that the problem could possibly be
&gt; avoided by including &#34;ora_envhp =&gt; 0&#34; in the connect&#40;&#41;. This indeed
&gt; fixed the problem. I am including Tim&#39;s comments below:
&gt; 
&gt; &#34;Try passing ora_envhp =&gt; 0 in the connect&#40;&#41; attributes.
&gt; 
&gt; If that fixes it then the bug is probably that dbd::oracle
&gt; should not use a cached environment handle if it&#39;s not usable.
&gt; &#40;and OCIHandleAlloc&#40;OCI_HTYPE_ERROR&#41; is a reasonable way to test that
&gt; the environment handle is usable&#41;.&#34;
&gt; 
&gt; 
&gt; Thanks,
&gt; Tim Heath
&gt; Qwest Communications
&gt; 
&gt; 
</div>
Appologies for the massive amount of time it has taken to sort this
issue out. The following diff against the current subversion trunk
should do what you want. As it has been so long since you reported this
I&#39;d understand if you cannot try it out. If you cannot, I&#39;ll just have
to try and find another way of proving it.

Index: dbdimp.c
===================================================================
--- dbdimp.c    &#40;revision 15333&#41;
+++ dbdimp.c    &#40;working copy&#41;
@@ -591,6 +591,17 @@
                        forced_new_environment = 1;
                }
        }
+    /* RT46739 */
+    if &#40;imp_dbh-&gt;envhp&#41; {
+        OCIError *errhp;
+        OCIHandleAlloc_ok&#40;imp_dbh, imp_dbh-&gt;envhp, &#38;errhp,
OCI_HTYPE_ERROR,  status&#41;;
+        if &#40;status != OCI_SUCCESS&#41; {
+            imp_dbh-&gt;envhp = NULL;
+        } else {
+                       OCIHandleFree_log_stat&#40;imp_dbh, errhp,
OCI_HTYPE_ERROR,  status&#41;;
+        }
+    }
+
     if &#40;!imp_dbh-&gt;envhp &#41; {
                SV **init_mode_sv;
                ub4 init_mode = OCI_OBJECT;     /* needed for LOBs
&#40;8.0.4&#41;      */

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;10&nbsp;05:15:15&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;23&nbsp;08:33:41&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;23&nbsp;08:33:41&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Fixed in 1.51_00 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;23&nbsp;08:33:41&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Fixed in 1.52 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
