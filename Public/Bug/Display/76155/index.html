<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #76155 for Directory-Queue: Win32</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #76155 for Directory-Queue: Win32</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Directory-Queue/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Directory-Queue/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Directory-Queue/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Directory-Queue/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Directory-Queue">Directory-Queue CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">76155</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Directory-Queue/Active/">Directory-Queue</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">LCONS [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
feratilbeau [...] hotmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-233600-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.5    </td>
  </tr>
  <tr id="CF-233601-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;30&nbsp;06:03:18&nbsp;2012</span>
    <span class="description">feratilbeau [...] hotmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Win32</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Lionel,

Tried on Windows, I got the following error messages. My guess is
because Directory::Queue does not use File::Spec family and the $!
values explicitely.

C:\&gt;perl -MDirectory::Queue::Simple -e &#34;$queue =
Directory::Queue::Simple-&gt;new&#40;path =&gt; shift&#41;; $queue-&gt;add&#40;\&#34;test\&#34;&#41;;
foreach &#40;1..2
&#41; {if &#40;fork&#40;&#41; == 0&#41; {if &#40;$first = $queue-&gt;first&#40;&#41;&#41;
{$queue-&gt;lock&#40;$first&#41;}}} sleep&#40;2&#41;;&#34; C:\Windows\Temp
Directory::Queue::Simple: cannot
link&#40;C:\Windows\Temp/4f7579d0/4f7579e4880b74,
C:\Windows\Temp/4f7579d0/4f7579e4880b74.lck&#41;: Invalid argument
Directory::Queue::Simple: cannot
link&#40;C:\Windows\Temp/4f7579d0/4f7579e4880b74,
C:\Windows\Temp/4f7579d0/4f7579e4880b74.lck&#41;: Invalid argument

Since I tried only Directory::Queue::Simple, please find attached a
proposal for this sub-module &#40;and its parent Queue.pm&#41;, not validated
under *ix btw -;! But the principle remains valid; may I suggest to use
File::Spec and not explicit errno values in your package, so that your
package gains portability ? I assumed &#34;link&#34; works every where.

Thanks a lot,

Cheers,

Jean-Damien Durand.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Directory_Queue.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -Naur Directory-Queue-1.5.old/lib/Directory/Queue/Simple.pm Directory-Queue-1.5.new/lib/Directory/Queue/Simple.pm
--- Directory-Queue-1.5.old/lib/Directory/Queue/Simple.pm	2012-01-24 09:58:01.000000000 +0100
+++ Directory-Queue-1.5.new/lib/Directory/Queue/Simple.pm	2012-03-30 10:19:06.979900600 +0200
@@ -22,6 +22,7 @@
 
 use Directory::Queue qw&#40;:DIR :FILE :RE :ST _fatal _name SYSBUFSIZE&#41;;
 use POSIX qw&#40;:errno_h&#41;;
+use File::Spec::Functions qw&#40;catfile catdir&#41;;
 
 #
 # inheritance
@@ -88,10 +89,10 @@
     $dir = _add_dir&#40;$self&#41;;
     while &#40;1&#41; {
 	$name = _name&#40;&#41;;
-	$tmp = $self-&gt;{path} . &#34;/&#34; . $dir . &#34;/&#34; . $name . TEMPORARY_SUFFIX;
+	$tmp = catfile&#40;$self-&gt;{path}, $dir, $name . TEMPORARY_SUFFIX&#41;;
 	$fh = _file_create&#40;$tmp, $self-&gt;{umask}&#41;;
 	last if $fh;
-	_special_mkdir&#40;$self-&gt;{path} . &#34;/&#34; . $dir, $self-&gt;{umask}&#41; if $! == ENOENT;
+	_special_mkdir&#40;catdir&#40;$self-&gt;{path}, $dir&#41;, $self-&gt;{umask}&#41; if ! -d catdir&#40;$self-&gt;{path}, $dir&#41;;
     }
     $length = length&#40;$$dataref&#41;;
     $offset = 0;
@@ -111,13 +112,13 @@
 
     while &#40;1&#41; {
 	$name = _name&#40;&#41;;
-	$new = $self-&gt;{path} . &#34;/&#34; . $dir . &#34;/&#34; . $name;
+	$new = catfile&#40;$self-&gt;{path}, $dir, $name&#41;;
 	# N.B. we use link&#40;&#41; + unlink&#40;&#41; to make sure $new is never overwritten
 	if &#40;link&#40;$tmp, $new&#41;&#41; {
 	    unlink&#40;$tmp&#41; or _fatal&#40;&#34;cannot unlink&#40;%s&#41;: %s&#34;, $tmp, $!&#41;;
-	    return&#40;$dir . &#34;/&#34; . $name&#41;;
+	    return&#40;catfile&#40;$dir, $name&#41;&#41;;
 	}
-	_fatal&#40;&#34;cannot link&#40;%s, %s&#41;: %s&#34;, $tmp, $new, $!&#41; unless $! == EEXIST;
+	_fatal&#40;&#34;cannot link&#40;%s, %s&#41;: %s&#34;, $tmp, $new, $!&#41; unless -e $new;
     }
 }
 
@@ -146,7 +147,7 @@
     my&#40;$dir&#41;;
 
     $dir = _add_dir&#40;$self&#41;;
-    _special_mkdir&#40;$self-&gt;{path} . &#34;/&#34; . $dir, $self-&gt;{umask}&#41;;
+    _special_mkdir&#40;catdir&#40;$self-&gt;{path}, $dir&#41;, $self-&gt;{umask}&#41;;
     return&#40;_add_path&#40;$self, $path, $dir&#41;&#41;;
 }
 
@@ -157,19 +158,19 @@
 sub get : method {
     my&#40;$self, $name&#41; = @_;
 
-    return&#40;${ _file_read&#40;$self-&gt;{path} . &#34;/&#34; . $name . LOCKED_SUFFIX, 0&#41; }&#41;;
+    return&#40;${ _file_read&#40;catfile&#40;$self-&gt;{path}, $name . LOCKED_SUFFIX&#41;, 0&#41; }&#41;;
 }
 
 sub get_ref : method {
     my&#40;$self, $name&#41; = @_;
 
-    return&#40;_file_read&#40;$self-&gt;{path} . &#34;/&#34; . $name . LOCKED_SUFFIX, 0&#41;&#41;;
+    return&#40;_file_read&#40;catfile&#40;$self-&gt;{path}, $name . LOCKED_SUFFIX&#41;, 0&#41;&#41;;
 }
 
 sub get_path : method {
     my&#40;$self, $name&#41; = @_;
 
-    return&#40;$self-&gt;{path} . &#34;/&#34; . $name . LOCKED_SUFFIX&#41;;
+    return&#40;catfile&#40;$self-&gt;{path}, $name . LOCKED_SUFFIX&#41;&#41;;
 }
 
 #
@@ -183,7 +184,7 @@
     my&#40;$path, $lock, $time&#41;;
 
     $permissive = 1 unless defined&#40;$permissive&#41;;
-    $path = $self-&gt;{path} . &#34;/&#34; . $name;
+    $path = catfile&#40;$self-&gt;{path}, $name&#41;;
     $lock = $path . LOCKED_SUFFIX;
     if &#40;link&#40;$path, $lock&#41;&#41; {
 	# we also touch the element to indicate the lock time
@@ -192,7 +193,7 @@
 	    or _fatal&#40;&#34;cannot utime&#40;%d, %d, %s&#41;: %s&#34;, $time, $time, $path, $!&#41;;
 	return&#40;1&#41;;
     }
-    return&#40;0&#41; if $permissive and &#40;$! == EEXIST or $! == ENOENT&#41;;
+    return&#40;0&#41; if $permissive and &#40;-e $lock or ! -e $path&#41;;
     _fatal&#40;&#34;cannot link&#40;%s, %s&#41;: %s&#34;, $path, $lock, $!&#41;;
 }
 
@@ -207,10 +208,13 @@
     my&#40;$path, $lock&#41;;
 
     $permissive = 0 unless defined&#40;$permissive&#41;;
-    $path = $self-&gt;{path} . &#34;/&#34; . $name;
+    $path = catfile&#40;$self-&gt;{path}, $name&#41;;
     $lock = $path . LOCKED_SUFFIX;
-    return&#40;1&#41; if unlink&#40;$lock&#41;;
-    return&#40;0&#41; if $permissive and $! == ENOENT;
+    if &#40;unlink&#40;$lock&#41;&#41; {
+        return&#40;1&#41;;
+    } else {
+        return&#40;0&#41; if $permissive and -e $lock;
+    }
     _fatal&#40;&#34;cannot unlink&#40;%s&#41;: %s&#34;, $lock, $!&#41;;
 }
 
@@ -222,7 +226,7 @@
     my&#40;$self, $name&#41; = @_;
     my&#40;$path, $lock&#41;;
 
-    $path = $self-&gt;{path} . &#34;/&#34; . $name;
+    $path = catfile&#40;$self-&gt;{path}, $name&#41;;
     $lock = $path . LOCKED_SUFFIX;
     unlink&#40;$path&#41; or _fatal&#40;&#34;cannot unlink&#40;%s&#41;: %s&#34;, $path, $!&#41;;
     unlink&#40;$lock&#41; or _fatal&#40;&#34;cannot unlink&#40;%s&#41;: %s&#34;, $lock, $!&#41;;
@@ -243,7 +247,7 @@
     }
     # count the elements inside
     foreach $name &#40;@list&#41; {
-	$count += grep&#40;/^&#40;?:$_ElementRegexp&#41;$/o, _special_getdir&#40;$self-&gt;{path} . &#34;/&#34; . $name&#41;&#41;;
+	$count += grep&#40;/^&#40;?:$_ElementRegexp&#41;$/o, _special_getdir&#40;catdir&#40;$self-&gt;{path}, $name&#41;&#41;&#41;;
     }
     # that&#39;s all
     return&#40;$count&#41;;
@@ -276,18 +280,18 @@
     $oldlock = time&#40;&#41; - $option{maxlock} if $option{maxlock};
     if &#40;$oldtemp or $oldlock&#41; {
 	foreach $name &#40;@list&#41; {
-	    $path = $self-&gt;{path} . &#34;/&#34; . $name;
+	    $path = catdir&#40;$self-&gt;{path}, $name&#41;;
 	    foreach $old &#40;grep&#40;/\./, _special_getdir&#40;$path&#41;&#41;&#41; {
-		@stat = stat&#40;$path . &#34;/&#34; . $old&#41;;
+		@stat = stat&#40;catfile&#40;$path, $old&#41;&#41;;
 		unless &#40;@stat&#41; {
-		    _fatal&#40;&#34;cannot stat&#40;%s/%s&#41;: %s&#34;, $path, $old, $!&#41; unless $! == ENOENT;
+		    _fatal&#40;&#34;cannot stat&#40;%s&#41;: %s&#34;, catfile&#40;$path, $old&#41;, $!&#41; unless ! -e catfile&#40;$path, $old&#41;;
 		    next;
 		}
 		next if substr&#40;$old, -4&#41; eq TEMPORARY_SUFFIX and $stat[ST_MTIME] &gt;= $oldtemp;
 		next if substr&#40;$old, -4&#41; eq LOCKED_SUFFIX    and $stat[ST_MTIME] &gt;= $oldlock;
-		warn&#40;&#34;* removing too old volatile file: $path/$old\n&#34;&#41;;
-		next if unlink&#40;$path . &#34;/&#34; . $old&#41;;
-		_fatal&#40;&#34;cannot unlink&#40;%s/%s&#41;: %s&#34;, $path, $old, $!&#41; unless $! == ENOENT;
+		warn&#40;&#34;* removing too old volatile file: %s\n&#34;, catfile&#40;$path, $old&#41;&#41;;
+		next if unlink&#40;catfile&#40;$path, $old&#41;&#41;;
+		_fatal&#40;&#34;cannot unlink&#40;%s&#41;: %s&#34;, catfile&#40;$path, $old&#41;, $!&#41; unless ! -e catfile&#40;$path, $old&#41;;
 	    }
 	}
     }
@@ -296,7 +300,7 @@
     if &#40;@list &gt; 1&#41; {
 	pop&#40;@list&#41;;
 	foreach $name &#40;@list&#41; {
-	    $path = $self-&gt;{path} . &#34;/&#34; . $name;
+	    $path = catdir&#40;$self-&gt;{path}, $name&#41;;
 	    _special_rmdir&#40;$path&#41; unless _special_getdir&#40;$path&#41;;
 	}
     }
diff -Naur Directory-Queue-1.5.old/lib/Directory/Queue.pm Directory-Queue-1.5.new/lib/Directory/Queue.pm
--- Directory-Queue-1.5.old/lib/Directory/Queue.pm	2012-01-24 09:58:01.000000000 +0100
+++ Directory-Queue-1.5.new/lib/Directory/Queue.pm	2012-03-30 10:06:53.356211900 +0200
@@ -24,11 +24,11 @@
 our&#40;@ISA, @EXPORT, @EXPORT_OK, %EXPORT_TAGS&#41;;
 @ISA = qw&#40;Exporter&#41;;
 @EXPORT = qw&#40;&#41;;
-@EXPORT_OK = qw&#40;_fatal _name SYSBUFSIZE&#41;;
+@EXPORT_OK = qw&#40;_fatal _name _warn SYSBUFSIZE&#41;;
 %EXPORT_TAGS = &#40;
     &#34;DIR&#34;  =&gt; [qw&#40;_special_mkdir _special_rmdir _special_getdir&#41;],
     &#34;FILE&#34; =&gt; [qw&#40;_file_read _file_create _file_write&#41;],
-    &#34;RE&#34;   =&gt; [qw&#40;$_DirectoryRegexp $_ElementRegexp&#41;],
+    &#34;RE&#34;   =&gt; [qw&#40;$_DirectoryRegexp $_ElementRegexp $_CurdirOrUpdir&#41;],
     &#34;ST&#34;   =&gt; [qw&#40;ST_DEV ST_INO ST_NLINK ST_MTIME&#41;],
 &#41;;
 Exporter::export_tags&#40;&#41;;
@@ -39,6 +39,8 @@
 
 use POSIX qw&#40;:errno_h :fcntl_h&#41;;
 use Time::HiRes qw&#40;&#41;;
+use File::Spec::Functions qw&#40;curdir updir catfile catdir splitdir&#41;;
+use File::Basename qw&#40;dirname&#41;;
 
 #
 # global variables
@@ -76,10 +78,12 @@
 our&#40;
     $_DirectoryRegexp,    # regexp matching an intermediate directory
     $_ElementRegexp,      # regexp matching an element
+    $_CurdirOrUpdir       # regexp matching curdir or updir
 &#41;;
 
 $_DirectoryRegexp = qr/[0-9a-f]{8}/;
 $_ElementRegexp   = qr/[0-9a-f]{14}/;
+$_CurdirOrUpdir   = &#40;$_ = &#39;^&#40;?:&#39; . join&#40;&#39;|&#39;, quotemeta&#40;curdir&#41;, quotemeta&#40;updir&#41;&#41; . &#39;&#41;$&#39;, qr/$_/&#41;;
 
 #+++############################################################################
 #                                                                              #
@@ -100,6 +104,18 @@
 }
 
 #
+# report a warning with a sprintf&#40;&#41; API
+#
+
+sub _warn &#40;$@&#41; {
+    my&#40;$message, @arguments&#41; = @_;
+
+    $message = sprintf&#40;$message, @arguments&#41; if @arguments;
+    $message =~ s/\s+$//;
+    warn&#40;caller&#40;&#41; . &#34;: $message\n&#34;&#41;;
+}
+
+#
 # make sure a module is loaded
 #
 
@@ -155,7 +171,7 @@
 	$success = mkdir&#40;$path&#41;;
     }
     return&#40;1&#41; if $success;
-    _fatal&#40;&#34;cannot mkdir&#40;%s&#41;: %s&#34;, $path, $!&#41; unless $! == EEXIST and -d $path;
+    _fatal&#40;&#34;cannot mkdir&#40;%s&#41;: %s&#34;, $path, $!&#41; unless -d $path;
     # RACE: someone else may have created it at the the same time
     return&#40;0&#41;;
 }
@@ -171,7 +187,7 @@
     my&#40;$path&#41; = @_;
 
     return&#40;1&#41; if rmdir&#40;$path&#41;;
-    _fatal&#40;&#34;cannot rmdir&#40;%s&#41;: %s&#34;, $path, $!&#41; unless $! == ENOENT;
+    _fatal&#40;&#34;cannot rmdir&#40;%s&#41;: %s&#34;, $path, $!&#41; unless ! -d $path;
     # RACE: someone else may have deleted it at the the same time
     return&#40;0&#41;;
 }
@@ -189,12 +205,12 @@
     my&#40;$dh, @list&#41;;
 
     if &#40;opendir&#40;$dh, $path&#41;&#41; {
-	@list = grep&#40;$_ !~ /^\.\.?$/, readdir&#40;$dh&#41;&#41;;
-	closedir&#40;$dh&#41; or _fatal&#40;&#34;cannot closedir&#40;%s&#41;: %s&#34;, $path, $!&#41;;
+	@list = grep&#40;$_ !~ /$_CurdirOrUpdir/, readdir&#40;$dh&#41;&#41;;
+	closedir&#40;$dh&#41; or _warn&#40;&#34;cannot closedir&#40;%s&#41;: %s&#34;, $path, $!&#41;; # It is not fatal to not being able to close a directory
 	return&#40;@list&#41;;
     }
     _fatal&#40;&#34;cannot opendir&#40;%s&#41;: %s&#34;, $path, $!&#41;
-	unless $! == ENOENT and not $strict;
+	unless ! -d $path and not $strict;
     # RACE: someone else may have deleted it at the the same time
     return&#40;&#41;;
 }
@@ -224,7 +240,7 @@
 	$done = sysread&#40;$fh, $data, SYSBUFSIZE, length&#40;$data&#41;&#41;;
 	_fatal&#40;&#34;cannot sysread&#40;%s&#41;: %s&#34;, $path, $!&#41; unless defined&#40;$done&#41;;
     }
-    close&#40;$fh&#41; or _fatal&#40;&#34;cannot close&#40;%s&#41;: %s&#34;, $path, $!&#41;;
+    close&#40;$fh&#41; or _warn&#40;&#34;cannot close&#40;%s&#41;: %s&#34;, $path, $!&#41;; # It is not fatal to not being able to close a file, although very suspicious
     return&#40;\$data&#41;;
 }
 
@@ -249,9 +265,9 @@
     }
     return&#40;$fh&#41; if $success;
     _fatal&#40;&#34;cannot sysopen&#40;%s, O_WRONLY|O_CREAT|O_EXCL&#41;: %s&#34;, $path, $!&#41;
-	unless &#40;$! == EEXIST or $! == ENOENT&#41; and not $strict;
-    # RACE: someone else may have created the file &#40;EEXIST&#41;
-    # RACE: the containing directory may be mising &#40;ENOENT&#41;
+	unless &#40;-e $path or ! -d dirname&#40;$path&#41;&#41; and not $strict;
+    # RACE: someone else may have created the file
+    # RACE: the containing directory may be mising
     return&#40;0&#41;;
 }
 
@@ -283,7 +299,7 @@
 	$length -= $done;
 	$offset += $done;
     }
-    close&#40;$fh&#41; or _fatal&#40;&#34;cannot close&#40;%s&#41;: %s&#34;, $path, $!&#41;;
+    close&#40;$fh&#41; or _warn&#40;&#34;cannot close&#40;%s&#41;: %s&#34;, $path, $!&#41;; # It is not fatal to not being able to close a file, although very suspicious
 }
 
 #+++############################################################################
@@ -333,8 +349,8 @@
     }
     # create the toplevel directory if needed
     $path = &#34;&#34;;
-    foreach $name &#40;split&#40;/\/+/, $self-&gt;{path}&#41;&#41; {
-	$path .= $name . &#34;/&#34;;
+    foreach $name &#40;grep {defined&#40;$_&#41; &#38;&#38; $_} splitdir&#40;$path&#41;&#41; {
+	$path .= catdir&#40;$path, $name&#41;;
 	_special_mkdir&#40;$path, $self-&gt;{umask}&#41; unless -d $path;
     }
     # store the queue unique identifier
@@ -403,11 +419,11 @@
     return&#40;shift&#40;@{ $self-&gt;{elts} }&#41;&#41; if @{ $self-&gt;{elts} };
     while &#40;@{ $self-&gt;{dirs} }&#41; {
 	$dir = shift&#40;@{ $self-&gt;{dirs} }&#41;;
-	foreach $name &#40;_special_getdir&#40;$self-&gt;{path} . &#34;/&#34; . $dir&#41;&#41; {
+	foreach $name &#40;_special_getdir&#40;catdir&#40;$self-&gt;{path}, $dir&#41;&#41;&#41; {
 	    push&#40;@list, $1&#41; if $name =~ /^&#40;$_ElementRegexp&#41;$/o; # untaint
 	}
 	next unless @list;
-	$self-&gt;{elts} = [ map&#40;&#34;$dir/$_&#34;, sort&#40;@list&#41;&#41; ];
+	$self-&gt;{elts} = [ map&#40;catdir&#40;$dir, $_&#41;, sort&#40;@list&#41;&#41; ];
 	return&#40;shift&#40;@{ $self-&gt;{elts} }&#41;&#41;;
     }
     return&#40;&#34;&#34;&#41;;
@@ -438,7 +454,7 @@
     my&#40;$time, $path&#41;;
 
     $time = time&#40;&#41;;
-    $path = $self-&gt;{path} . &#34;/&#34; . $element;
+    $path = catfile&#40;$self-&gt;{path}, $element&#41;;
     utime&#40;$time, $time, $path&#41;
 	or _fatal&#40;&#34;cannot utime&#40;%d, %d, %s&#41;: %s&#34;, $time, $time, $path, $!&#41;;
 }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;02&nbsp;02:24:17&nbsp;2012</span>
    <span class="description">LCONS [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;02&nbsp;02:28:01&nbsp;2012</span>
    <span class="description">LCONS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Could you please tell me more about the OS you are using?

Directory-Queue 1.5 seems to pass all tests on cpantesters for Windows 
&#40;Win32&#41;:
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/distro/D/Directory-Queue.html?osname=mswin32">http://www.cpantesters.org/distro/D/Directory-Queue.html?osname=mswin32</a></span>

I might consider using File::Spec if it is really needed but I must use 
the error codes of the POSIX functions I&#39;m using in order to properly 
handle race conditions.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;02&nbsp;02:28:02&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;04&nbsp;01:45:18&nbsp;2012</span>
    <span class="description">feratilbeau [...] hotmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> feratilbeau [...] hotmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Le Lun 02 Avr 2012 02:28:01, LCONS a écrit :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Could you please tell me more about the OS you are using?
</div>
This is windows 7, strawberry perl 5.12.

Does the test suite of Directory-Queue adress concurrency &#40;fork&#40;&#41;&#41; ?.

Regards.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;04&nbsp;08:35:43&nbsp;2012</span>
    <span class="description">LCONS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Apr 04 01:45:18 2012, jddfr74 wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This is windows 7, strawberry perl 5.12.
</div>
Ok, I&#39;ll try to get access to a Windows 7 box to reproduce the problem.

For the record, what do you get when you execute Directory-Queue&#39;s built-
in tests &#40;i.e. make test&#41;?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Does the test suite of Directory-Queue adress concurrency &#40;fork&#40;&#41;&#41; ?.
</div>
No. The built-in tests cover only the minimal functionality.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;04&nbsp;10:33:08&nbsp;2012</span>
    <span class="description">feratilbeau [...] hotmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> feratilbeau [...] hotmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; For the record, what do you get when you execute Directory-Queue&#39;s built-
&gt; in tests &#40;i.e. make test&#41;?
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">cpan&gt; test Directory::Queue
</div>Running test for module &#39;Directory::Queue&#39;
Running make for L/LC/LCONS/Directory-Queue-1.5.tar.gz
Fetching with LWP:
<span class="clickylink"><a target="new" rel="nofollow" href="http://cpan.strawberryperl.com/authors/id/L/LC/LCONS/Directory-Queue-1.5.tar.gz">http://cpan.strawberryperl.com/authors/id/L/LC/LCONS/Directory-Queue-1.5.tar.gz</a></span>
Fetching with LWP:
<span class="clickylink"><a target="new" rel="nofollow" href="http://cpan.strawberryperl.com/authors/id/L/LC/LCONS/CHECKSUMS">http://cpan.strawberryperl.com/authors/id/L/LC/LCONS/CHECKSUMS</a></span>
Checksum for
C:\perl-5.12\cpan\sources\authors\id\L\LC\LCONS\Directory-Queue-1.5.tar.gz
ok
Scanning cache C:\perl-5.12\cpan\build for sizes
............................................................................DONE

  CPAN.pm: Going to build L/LC/LCONS/Directory-Queue-1.5.tar.gz

Checking if your kit is complete...
Looks good
Writing Makefile for Directory::Queue
Could not read metadata file. Falling back to other methods to determine
prerequisites
cp lib/Directory/Queue/Simple.pm blib\lib\Directory\Queue\Simple.pm
cp lib/Directory/Queue/Set.pm blib\lib\Directory\Queue\Set.pm
cp lib/Directory/Queue.pm blib\lib\Directory\Queue.pm
cp lib/Directory/Queue/Normal.pm blib\lib\Directory\Queue\Normal.pm
cp lib/Directory/Queue/Null.pm blib\lib\Directory\Queue\Null.pm
  LCONS/Directory-Queue-1.5.tar.gz
  C:\perl-5.12\c\bin\dmake.exe -- OK
Running make test
C:\perl-5.12\perl\bin\perl.exe &#34;-MExtUtils::Command::MM&#34; &#34;-e&#34;
&#34;test_harness&#40;0, &#39;blib\lib&#39;, &#39;blib\arch&#39;&#41;&#34; t/*.t
t/1main.t ...... ok
t/1null.t ...... ok
t/1simple.t .... ok
t/2frontend.t .. ok
t/2set.t ....... ok
t/2table.t ..... ok
t/3pod.t ....... ok
t/4podcov.t .... skipped: Test::Pod::Coverage 1.08 required for testing
POD coverage
All tests successful.
Files=8, Tests=141,  4 wallclock secs &#40; 0.17 usr +  0.05 sys =  0.22 CPU&#41;
Result: PASS
  LCONS/Directory-Queue-1.5.tar.gz
  C:\perl-5.12\c\bin\dmake.exe test -- OK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;05&nbsp;07:05:57&nbsp;2012</span>
    <span class="description">LCONS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">After investigation, the problem comes from link&#40;&#41; that does not return 
the right error code when called with an existing file path: I get EINVAL 
instead of EEXIST.

AFAIK, this violates the POSIX standard:
<span class="clickylink"><a target="new" rel="nofollow" href="http://pubs.opengroup.org/onlinepubs/009695399/functions/link.html">http://pubs.opengroup.org/onlinepubs/009695399/functions/link.html</a></span>

So, to me, this looks like a bug in Perl and/or Windows.

Anyway, I will now see if I can find a reasonable workaround for this 
bug.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;05&nbsp;07:19:13&nbsp;2012</span>
    <span class="description">LCONS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Apr 05 07:05:57 2012, LCONS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So, to me, this looks like a bug in Perl and/or Windows.
</div>
Now reported as <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=76324">https://rt.cpan.org/Ticket/Display.html?id=76324</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;29&nbsp;02:36:58&nbsp;2012</span>
    <span class="description">LCONS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The underlying Perl bug has been fixed upstream &#40;see Tony&#39;s comment on 
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=76324&#41;">https://rt.cpan.org/Ticket/Display.html?id=76324&#41;</a></span>.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;29&nbsp;02:36:59&nbsp;2012</span>
    <span class="description">LCONS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
