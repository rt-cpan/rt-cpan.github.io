<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #73387 for Plack-Middleware-ETag: [PATCH] plack content is not always an array, it can be Plack::Util::Prototpye, for example in Plack::Middleware::AccessLog::Timed add one test with a Plack::Util::Prototype, factorize tests to easier</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #73387 for Plack-Middleware-ETag: [PATCH] plack content is not always an array, it can be Plack::Util::Prototpye, for example in Plack::Middleware::AccessLog::Timed add one test with a Plack::Util::Prototype, factorize tests to easier</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Plack-Middleware-ETag/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Plack-Middleware-ETag/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Plack-Middleware-ETag/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Plack-Middleware-ETag/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/franckcuny/plack-middleware-etag/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Plack-Middleware-ETag">Plack-Middleware-ETag CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">73387</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Plack-Middleware-ETag/Active/">Plack-Middleware-ETag</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
nicolas.rochelemagne [...] cpanel.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-232256-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-232257-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;20&nbsp;14:01:44&nbsp;2011</span>
    <span class="description">nicolas.rochelemagne [...] cpanel.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Nicolas Rochelemagne &lt;nicolas.rochelemagne [...] cpanel.net&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] plack content is not always an array, it can be Plack::Util::Prototpye, for example in Plack::Middleware::AccessLog::Timed add one test with a Plack::Util::Prototype, factorize tests to easier add some more tests</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 20 Dec 2011 13:01:26 -0600</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Plack-Middleware-ETag [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> nicolas.rochelemagne [...] cpanel.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From: Nicolas Rochelemagne &lt;nicolas.rochelemagne@cpanel.net&gt;

---
 lib/Plack/Middleware/ETag.pm |    3 +
 t/01_basic.t                 |  248 +++++++++++++++++++++++-------------------
 2 files changed, 140 insertions&#40;+&#41;, 111 deletions&#40;-&#41;

diff --git a/lib/Plack/Middleware/ETag.pm b/lib/Plack/Middleware/ETag.pm
index f0a9dec..57eb4bd 100644
--- a/lib/Plack/Middleware/ETag.pm
+++ b/lib/Plack/Middleware/ETag.pm
@@ -52,6 +52,9 @@ sub call {
                     $etag .= &#40; sprintf &#34;%x&#34;, $stats[7] &#41;;
                 }
             } else {
+                # check that we have an array and not a Plack::Util::Prototpye
+                #  ie : Plack::Middleware::AccessLog::Timed
+                return if &#40; ref [] ne ref $res-&gt;[2] &#41;;
                 my $sha = Digest::SHA-&gt;new;
                 $sha-&gt;add&#40; @{ $res-&gt;[2] } &#41;;
                 $etag = $sha-&gt;hexdigest;
diff --git a/t/01_basic.t b/t/01_basic.t
index d1db7ba..d2f2981 100644
--- a/t/01_basic.t
+++ b/t/01_basic.t
@@ -9,121 +9,147 @@ use Plack::Builder;
 use HTTP::Request::Common;
 
 my $content = [qw/hello world/];
-my $sha = Digest::SHA-&gt;new-&gt;add&#40;@$content&#41;-&gt;hexdigest;
-
-my $handler = builder {
-    enable &#34;Plack::Middleware::ETag&#34;;
-    sub { [ &#39;200&#39;, [ &#39;Content-Type&#39; =&gt; &#39;text/html&#39; ], $content ] };
-};
-
-my $second_handler = builder {
-    enable &#34;Plack::Middleware::ETag&#34;;
-    sub {
-        [
-            &#39;200&#39;, [ &#39;Content-Type&#39; =&gt; &#39;text/html&#39;, &#39;ETag&#39; =&gt; &#39;123&#39; ],
-            $content
-        ];
+my $sha     = Digest::SHA-&gt;new-&gt;add&#40;@$content&#41;-&gt;hexdigest;
+
+sub handler {
+    builder {
+        enable &#34;Plack::Middleware::ETag&#34;;
+        sub { [ &#39;200&#39;, [ &#39;Content-Type&#39; =&gt; &#39;text/html&#39; ], $content ] };
     };
-};
-
-my $unmodified_handler = builder {
-    enable &#34;Plack::Middleware::ConditionalGET&#34;;
-    enable &#34;Plack::Middleware::ETag&#34;;
-    sub { [ &#39;200&#39;, [ &#39;Content-Type&#39; =&gt; &#39;text/html&#39; ], $content ] };
-};
-
-my $file_handler = builder {
-   enable &#34;Plack::Middleware::ETag&#34;;
-   open my $fh, &#39;README&#39;;
-   sub {[200, [&#39;Content-Type&#39; =&gt; &#39;text/html&#39;, ], $fh]};
-};
-
-my $cache_control = builder {
-    enable &#34;Plack::Middleware::ETag&#34;, cache_control =&gt; 1;
-    sub { [ &#39;200&#39;, [ &#39;Content-Type&#39; =&gt; &#39;text/html&#39; ], $content ] };
-};
-
-my $cache_control_array = builder {
-    enable &#34;Plack::Middleware::ETag&#34;,
-      cache_control =&gt; [ &#39;must-revalidate&#39;, &#39;max-age=3600&#39;, &#39;no-store&#39; ];
-    sub { [ &#39;200&#39;, [ &#39;Content-Type&#39; =&gt; &#39;text/html&#39; ], $content ] };
-};
-
-test_psgi
-    app    =&gt; $handler,
-    client =&gt; sub {
-    my $cb = shift;
-    {
-        my $req = GET &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/">http://localhost/</a></span>&#34;;
-        my $res = $cb-&gt;&#40;$req&#41;;
-        ok $res-&gt;header&#40;&#39;ETag&#39;&#41;;
-        is $res-&gt;header&#40;&#39;ETag&#39;&#41;, $sha;
-    }
-};
-
-test_psgi
-    app    =&gt; $second_handler,
-    client =&gt; sub {
-    my $cb = shift;
-    {
-        my $req = GET &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/">http://localhost/</a></span>&#34;;
-        my $res = $cb-&gt;&#40;$req&#41;;
-        ok $res-&gt;header&#40;&#39;ETag&#39;&#41;;
-        is $res-&gt;header&#40;&#39;ETag&#39;&#41;, &#39;123&#39;;
-    }
-};
-
-test_psgi
-    app    =&gt; $unmodified_handler,
-    client =&gt; sub {
-    my $cb = shift;
+}
+
+sub second_handler {
+    builder {
+        enable &#34;Plack::Middleware::ETag&#34;;
+        sub {
+            [
+                &#39;200&#39;, [ &#39;Content-Type&#39; =&gt; &#39;text/html&#39;, &#39;ETag&#39; =&gt; &#39;123&#39; ],
+                $content
+            ];
+        };
+    };
+}
+
+sub unmodified_handler {
+    builder {
+        enable &#34;Plack::Middleware::ConditionalGET&#34;;
+        enable &#34;Plack::Middleware::ETag&#34;;
+        sub { [ &#39;200&#39;, [ &#39;Content-Type&#39; =&gt; &#39;text/html&#39; ], $content ] };
+    };
+}
+
+sub file_handler {
+    builder {
+        enable &#34;Plack::Middleware::ETag&#34;;
+        open my $fh, &#39;README&#39;;
+        sub { [ 200, [ &#39;Content-Type&#39; =&gt; &#39;text/html&#39;, ], $fh ] };
+    };
+}
+
+sub cache_control {
+    builder {
+        enable &#34;Plack::Middleware::ETag&#34;, cache_control =&gt; 1;
+        sub { [ &#39;200&#39;, [ &#39;Content-Type&#39; =&gt; &#39;text/html&#39; ], $content ] };
+    };
+}
+
+sub cache_control_array {
+    builder {
+        enable &#34;Plack::Middleware::ETag&#34;,
+          cache_control =&gt; [ &#39;must-revalidate&#39;, &#39;max-age=3600&#39;, &#39;no-store&#39; ];
+        sub { [ &#39;200&#39;, [ &#39;Content-Type&#39; =&gt; &#39;text/html&#39; ], $content ] };
+    };
+}
+
+# Plack::Middleware::AccessLog::Timed for example can return a plack answer with :
+#  [ $status, $header, $timer_body = Plack::Util::inline_object ]
+my $inline_object = Plack::Util::inline_object&#40;
+    getline =&gt; sub { },
+    close   =&gt; sub { }
+&#41;;
+isa_ok&#40; $inline_object, &#39;Plack::Util::Prototype&#39; &#41;;
+ok&#40; !Plack::Util::is_real_fh&#40;$inline_object&#41; &#41;;
+
+sub invalid_handler {
+    builder {
+        enable &#34;Plack::Middleware::ETag&#34;;
+        sub {
+            [
+                &#39;200&#39;,
+                [ &#39;Content-Type&#39; =&gt; &#39;text/html&#39; ],
+                $inline_object || &#39;whatever&#39;
+            ];
+        };
+    };
+}
+
+# declare apps to tests
+my @tests = &#40;
+    { app =&gt; &#39;handler&#39;,        headers =&gt; { ETag =&gt; $sha } },
+    { app =&gt; &#39;second_handler&#39;, headers =&gt; { ETag =&gt; 123 } },
     {
-        my $req = GET &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/">http://localhost/</a></span>&#34;, &#39;If-None-Match&#39; =&gt; $sha;
-        my $res = $cb-&gt;&#40;$req&#41;;
-        ok $res-&gt;header&#40;&#39;ETag&#39;&#41;;
-    is $res-&gt;code, 304;
-    ok !$res-&gt;content;
-    }
-};
-
-test_psgi
-    app    =&gt; $file_handler,
-    client =&gt; sub {
-    my $cb = shift;
+        app     =&gt; &#39;unmodified_handler&#39;,
+        request =&gt; [ &#39;If-None-Match&#39; =&gt; $sha ],
+        headers =&gt; { ETag =&gt; $sha },
+        code    =&gt; 304,
+        content =&gt; &#39;&#39;
+    },
+    { app =&gt; &#39;file_handler&#39;, headers =&gt; { ETag =&gt; &#39;81a4-4ef0ae91-681&#39; } }
+    ,    # code 200 + ok content
     {
-        my $req = GET &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/">http://localhost/</a></span>&#34;;
-        my $res = $cb-&gt;&#40;$req&#41;;
-        ok $res-&gt;header&#40;&#39;ETag&#39;&#41;;
-    is $res-&gt;code, 200;
-    ok $res-&gt;content;
-    }
-};
-
-test_psgi
-  app    =&gt; $cache_control,
-  client =&gt; sub {
-    my $cb = shift;
+        app     =&gt; &#39;cache_control&#39;,
+        headers =&gt; { ETag =&gt; $sha, &#39;Cache-Control&#39; =&gt; &#39;must-revalidate&#39; }
+    },
     {
-        my $req = GET &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/">http://localhost/</a></span>&#34;;
-        my $res = $cb-&gt;&#40;$req&#41;;
-        ok $res-&gt;header&#40;&#39;ETag&#39;&#41;;
-        is $res-&gt;header&#40;&#39;ETag&#39;&#41;,          $sha;
-        is $res-&gt;header&#40;&#39;Cache-Control&#39;&#41;, &#39;must-revalidate&#39;;
-    }
-  };
-
-test_psgi
-  app    =&gt; $cache_control_array,
-  client =&gt; sub {
-    my $cb = shift;
+        app     =&gt; &#39;cache_control_array&#39;,
+        headers =&gt; {
+            ETag            =&gt; $sha,
+            &#39;Cache-Control&#39; =&gt; &#39;must-revalidate, max-age=3600, no-store&#39;
+        }
+    },
     {
-        my $req = GET &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/">http://localhost/</a></span>&#34;;
-        my $res = $cb-&gt;&#40;$req&#41;;
-        ok $res-&gt;header&#40;&#39;ETag&#39;&#41;;
-        is $res-&gt;header&#40;&#39;ETag&#39;&#41;, $sha;
-        is $res-&gt;header&#40;&#39;Cache-Control&#39;&#41;,
-          &#39;must-revalidate, max-age=3600, no-store&#39;;
-    }
-  };
+        app     =&gt; &#39;invalid_handler&#39;,
+        headers =&gt; { ETag =&gt; undef },
+        content =&gt; undef
+    },
+
+&#41;;
+
+# test the apps
+
+foreach my $t &#40;@tests&#41; {
+    subtest &#34;Testing app : $t-&gt;{app}&#34; =&gt; sub {
+        no strict &#39;refs&#39;;
+        test_psgi
+          app    =&gt; &#38;{ $t-&gt;{app} },
+          client =&gt; sub {
+            my $cb = shift;
+            {
+
+                # launch the request
+                my @get = &#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/">http://localhost/</a></span>&#34;&#41;;
+                push&#40; @get, @{ $t-&gt;{request} } &#41; if $t-&gt;{request};
+                my $req = GET @get;
+                my $res = $cb-&gt;&#40;$req&#41;;
+
+                # analyze headers
+                $t-&gt;{headers} ||= {};
+                foreach my $h &#40; keys %{ $t-&gt;{headers} } &#41; {
+                    ok $res-&gt;header&#40;$h&#41;, &#34;has header $h&#34;
+                      if defined $res-&gt;header&#40;$h&#41;;
+                    is $res-&gt;header&#40;$h&#41;, $t-&gt;{headers}-&gt;{$h},
+                      &#34;header $h has expected value&#34;;
+                }
+
+                # analyze answer
+                is $res-&gt;code, $t-&gt;{code} || 200, &#34;return code is ok&#34;;
+                ok $res-&gt;content, &#34;content exists&#34;
+                  unless exists $t-&gt;{content} &#38;&#38; &#40; !defined $t-&gt;{content} || $t-&gt;{content} eq &#39;&#39; &#41;;
+                is $res-&gt;content, $t-&gt;{content}, &#34;content has expected value&#34;
+                  if exists $t-&gt;{content};
+            }
+          };
+    };
+}
 
 done_testing;
-- 
1.7.7.1
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
