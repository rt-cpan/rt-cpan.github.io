<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #79906 for threads-shared: numeric part of a dualvar not preserved via shared array / shared hash</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #79906 for threads-shared: numeric part of a dualvar not preserved via shared array / shared hash</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/threads-shared/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/threads-shared/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/threads-shared/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/threads-shared/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/threads-shared">threads-shared CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">79906</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/threads-shared/Active/">threads-shared</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
philippe.causse [...] nsn.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-32722-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.41    </td>
  </tr>
  <tr id="CF-32723-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.42    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;28&nbsp;08:15:57&nbsp;2012</span>
    <span class="description">philippe.causse [...] nsn.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> numeric part of a dualvar not preserved via shared array / shared hash</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 28 Sep 2012 14:15:43 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-threads-shared [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Philippe Causse &lt;philippe.causse [...] nsn.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

please find the following bug-report:

Versions:
======

* perl 5.16.0
* threads::shared 1.4

Problem description:
=============

When storing a dualvar in a shared array &#40;or shared hash&#41;, only the SVPV 
part is preserved. The IV part is lost.

Storing via a shared scalar works fine though.


EXAMPLE CODE:
==========


#!/usr/bin/env perl

use 5.016;
use strict;
use warnings;
use threads;
use threads::shared;

use Scalar::Util qw&#40; dualvar &#41;;

use constant FOURTY_TWO =&gt; dualvar&#40; 42, &#39;Fourty-two&#39; &#41;;

my $ss : shared;
my @sa : shared;
my %sh : shared;

$ss      = FOURTY_TWO;
$sa[0]   = FOURTY_TWO;
$sh{key} = FOURTY_TWO;

printf &#34;Scalar ok:  %s\n&#34;, $ss == FOURTY_TWO      ? &#39;YES&#39; : &#39;NO&#39;;
printf &#34;Array ok:  %s\n&#34;,  $sa[0] == FOURTY_TWO   ? &#39;YES&#39; : &#39;NO&#39;;
printf &#34;Hash ok:  %s\n&#34;,   $sh{key} == FOURTY_TWO ? &#39;YES&#39; : &#39;NO&#39;;

#----------------------------------------------------------------------------------------------------


Execution shows:
$ ./bugtest.pl
Scalar ok:  YES
Argument &#34;Fourty-two&#34; isn&#39;t numeric in numeric eq &#40;==&#41; at ./bugtest.pl 
line 22.
Array ok:  NO
Argument &#34;Fourty-two&#34; isn&#39;t numeric in numeric eq &#40;==&#41; at ./bugtest.pl 
line 23.
Hash ok:  NO
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;28&nbsp;08:29:02&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;28&nbsp;08:29:02&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Severity Wishlist added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;28&nbsp;08:29:02&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Broken in 1.41 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;28&nbsp;09:17:21&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2012-09-28 08:15:57, philippe.causse@nsn.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; When storing a dualvar in a shared array &#40;or shared hash&#41;,
&gt; only the SVPV part is preserved. The IV part is lost.
&gt; 
&gt; Storing via a shared scalar works fine though.
</div>
Interesting.  dualvar&#40;&#41; plays tricks with a scalar such that the scalar 
is no longer a &#34;basic&#34; Perl type, nor is it an object.  Thus, 
threads::shared doesn&#39;t copy it &#34;correctly&#34; when adding it to a shared 
structure.  A dualvar&#40;&#41; passed on a Thread::Queue doesn&#39;t come out 
dualvar&#40;&#41; on the other end either.  Setting a shared scalar to a 
dualvar&#40;&#41; works because the dualvar&#40;&#41; is not copied; its refcount is 
just incremented.

This is really a bug against Scalar::Util as it&#39;s that module that is 
implementing the dualvar&#40;&#41; feature.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;28&nbsp;09:17:22&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;28&nbsp;09:41:28&nbsp;2012</span>
    <span class="description">philippe.causse [...] nsn.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #79906] numeric part of a dualvar not preserved via shared array / shared hash</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 28 Sep 2012 15:41:14 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-threads-shared [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Philippe Causse &lt;philippe.causse [...] nsn.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Jerry,

Thank you for taking the time answering this.

I agree that dualvar is &#34;playing tricks&#34;,   although a dualvar it is 
still a basic type &#40;it&#39;s an SV for with IOK / NOK is set and POK is also 
set&#41;.

When an Sv is upgraded to an SvPV, the NV slot is still available and 
that&#39;s what dualvar&#40;&#41; uses.

By curiosity, I have tested against the most famous dualvar of Perl:  
$!  and obtained slightly different results.


Example of application: if you have a thread that wants to report an 
error via message passing &#40;let&#39;s say via Thread::Queue&#41;, you would need 
to &#39;split&#39; your error code and reason into two parts &#40;or chose to only 
relay the numeric form&#41;.



use Errno qw&#40; EINTR &#41;;

$! = EINTR;

my $ss : shared;
my @sa : shared;
my $ns;

$ns    = $!;
$ss    = $!;
$sa[0] = $!;

printf &#34;Via non-shared scalar:  %d/%s\n&#34;, $ns, $ns;
printf &#34;Via shared scalar:  %d/%s\n&#34;,     $ss, $ss;
printf &#34;Via shared array:  %d/%s\n&#34;, $sa[0], $sa[0];

------------------------
GIVES:

Via non-shared scalar:  4/Interrupted system call
Argument &#34;Interrupted system call&#34; isn&#39;t numeric in printf at 
./bugtest.pl line 29.
Via shared scalar:  0/Interrupted system call
Argument &#34;Interrupted system call&#34; isn&#39;t numeric in printf at 
./bugtest.pl line 30.
Via shared array:  0/Interrupted system call


Then examining the data with Devel::Peek reveals interesting details:

===&gt; the non-shared scalar &#40;$ns&#41; :

SV = PVMG&#40;0xa1e6f44&#41; at 0xa2186d8
   REFCNT = 1
   FLAGS = &#40;PADMY,POK,pNOK,pPOK&#41;
   IV = 0
   NV = 4
   PV = 0xa207170 &#34;Interrupted system call&#34;\0
   CUR = 23
   LEN = 24


===&gt; The shared scalar &#40;$ss&#41;:
SV = PVMG&#40;0xa1e6f0c&#41; at 0xa184078
   REFCNT = 1
   FLAGS = &#40;PADMY,GMG,SMG,pPOK&#41;
   IV = 0
   NV = 4
   PV = 0xa2002c8 &#34;Interrupted system call&#34;\0
   CUR = 23
   LEN = 24
   MAGIC = 0xa21bfc0
     MG_VIRTUAL = 0xb728f300
     MG_TYPE = PERL_MAGIC_shared_scalar&#40;n&#41;
     MG_FLAGS = 0x30
       DUP
       LOCAL
     MG_PTR = 0xa1ed8e0 &#34;&#34;


You can see that after assignment the NV part of the non-shared scalar 
still contains 4 in its NV, but the pNOK flag has been cleared.
Only the pPOK flag is left.


Via non-shared scalar:  4/Interrupted system call

Argument &#34;Interrupted system call&#34; isn&#39;t numeric in printf at 
./bugtest.pl line 31.
Via shared scalar:  0/Interrupted system call






On 09/28/2012 03:17 PM, ext Jerry D. Hedden via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=79906">https://rt.cpan.org/Ticket/Display.html?id=79906</a></span> &gt;
&gt;
&gt; On 2012-09-28 08:15:57, philippe.causse@nsn.com wrote:
<div class="message-stanza open">&gt;&gt; When storing a dualvar in a shared array &#40;or shared hash&#41;,
&gt;&gt; only the SVPV part is preserved. The IV part is lost.
&gt;&gt;
&gt;&gt; Storing via a shared scalar works fine though.
</div>&gt; Interesting.  dualvar&#40;&#41; plays tricks with a scalar such that the scalar
&gt; is no longer a &#34;basic&#34; Perl type, nor is it an object.  Thus,
&gt; threads::shared doesn&#39;t copy it &#34;correctly&#34; when adding it to a shared
&gt; structure.  A dualvar&#40;&#41; passed on a Thread::Queue doesn&#39;t come out
&gt; dualvar&#40;&#41; on the other end either.  Setting a shared scalar to a
&gt; dualvar&#40;&#41; works because the dualvar&#40;&#41; is not copied; its refcount is
&gt; just incremented.
&gt;
&gt; This is really a bug against Scalar::Util as it&#39;s that module that is
&gt; implementing the dualvar&#40;&#41; feature.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;28&nbsp;09:41:29&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;rejected&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;28&nbsp;10:49:26&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2012-09-28 09:41:28, philippe.causse@nsn.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hello Jerry,
&gt; 
&gt; Thank you for taking the time answering this.
&gt; 
&gt; I agree that dualvar is &#34;playing tricks&#34;,   although a dualvar it is 
&gt; still a basic type &#40;it&#39;s an SV for with IOK / NOK is set and POK is 
</div>also 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; set&#41;.
&gt; 
&gt; When an Sv is upgraded to an SvPV, the NV slot is still available and 
&gt; that&#39;s what dualvar&#40;&#41; uses.
&gt; 
&gt; By curiosity, I have tested against the most famous dualvar of Perl:  
&gt; $!  and obtained slightly different results.
</div>
$! is a special scalar that uses &#39;magic&#39; to make it a dualvar - the same 
sort of &#39;trick&#39; is used for it as for what Scalar::Util does.  From mg.c 
for setting $!:

        SvNOK_on&#40;sv&#41;;   /* what a wonderful hack! */

I do not disagree that it would be nice for threads::shared to preserve 
the dualvar nature of scalars so set, but that &#39;nature&#39; is not generally 
supported by the Perl system and only works with special coding.

I&#39;ll leave this ticket open on the wishlist for future reference.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;28&nbsp;10:52:13&nbsp;2012</span>
    <span class="description">philippe.causse [...] nsn.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #79906] numeric part of a dualvar not preserved via shared array / shared hash</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 28 Sep 2012 16:51:58 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-threads-shared [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Philippe Causse &lt;philippe.causse [...] nsn.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks ;-&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;30&nbsp;14:08:14&nbsp;2012</span>
    <span class="description">philippe.causse [...] nsn.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> jdhedden [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #79906] numeric part of a dualvar not preserved via shared array / shared hash</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 30 Sep 2012 20:07:57 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-threads-shared [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Causse, Philippe &#40;NSN - DK/Copenhagen&#41;&#34; &lt;philippe.causse [...] nsn.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Jerry,

I have found the reason why dualvars don&#39;t work for shared arrays:

During the call to Perl_sharedsv_associate&#40;&#41;, the SV public flags IOK or 
NOK are lost, only the POK gets transferred to the shared SV.

This is happens after the call to sv_magicext&#40;&#41;  where IOK or POK become 
pIOK and pPOK respectively.
When the SvPVLV becomes magical, it loses its &#34;duality&#34;.

Checking the flags on the shared SV  when sharedsv_elem_mg_STORE is 
called, I noticed that either IOK or POK were set, but never both.

So, the workaround is to copy the IOK &#40;or NOK&#41; flag from the proxy SV 
onto the shared SV, when SvPOK&#40;ssv&#41; is true.

The following  patch does the job and all tests succeed &#40;i.e. no bad 
side effects&#41;:

*** threads-shared-1.41/shared.xs    2012-09-05 19:20:53.000000000 +0200
--- threads-shared-1.41_PHIL/shared.xs    2012-09-30 19:52:46.000000000 
+0200
***************
*** 963,970 ****
           svp = hv_fetch&#40;&#40;HV*&#41; saggregate, key, len, 1&#41;;
       }
       CALLER_CONTEXT;
!     Perl_sharedsv_associate&#40;aTHX_ sv, *svp&#41;;
       sharedsv_scalar_store&#40;aTHX_ sv, *svp&#41;;
       LEAVE_LOCK;
       return &#40;0&#41;;
   }
--- 963,977 ----
           svp = hv_fetch&#40;&#40;HV*&#41; saggregate, key, len, 1&#41;;
       }
       CALLER_CONTEXT;
!     {
!       U32 dualvar_flags = SvFLAGS&#40;sv&#41; &#38; &#40; SVf_IOK | SVf_NOK &#41;;
!       Perl_sharedsv_associate&#40;aTHX_ sv, *svp&#41;; /* this loses IOK/NOK &#38; 
POK ! */
         sharedsv_scalar_store&#40;aTHX_ sv, *svp&#41;;
+       if&#40; SvPOK&#40; *svp&#41; &#41; {
+     SvFLAGS&#40;*svp&#41; |= dualvar_flags; /* restore dualvar flags */
+       }
+     }
+
       LEAVE_LOCK;
       return &#40;0&#41;;
   }




And adding t/sv_dualvar.t to the test suite:

use strict;
use warnings;

BEGIN {
     use Config;
     if &#40; !$Config{&#39;useithreads&#39;} &#41; {
         print&#40;&#34;1..0 # SKIP Perl not compiled with &#39;useithreads&#39;\n&#34;&#41;;
         exit&#40;0&#41;;
     }
}

use ExtUtils::testlib;

sub ok {
     my &#40; $id, $ok, $name &#41; = @_;

     # You have to do it this way or VMS will get confused.
     if &#40;$ok&#41; {
         print&#40;&#34;ok $id - $name\n&#34;&#41;;
     }
     else {
         print&#40;&#34;not ok $id - $name\n&#34;&#41;;
         printf&#40; &#34;# Failed test at line %d\n&#34;, &#40;caller&#41;[2] &#41;;
     }

     return &#40;$ok&#41;;
}

BEGIN {
     $| = 1;
     print&#40;&#34;1..17\n&#34;&#41;;    ### Number of tests that will be run ###
}

use Scalar::Util qw&#40; dualvar &#41;;
use Devel::Peek;

use threads;
use threads::shared;

ok&#40; 1, 1, &#39;Loaded&#39; &#41;;

### Start of Testing ###

my $dv = dualvar&#40; 42,   &#39;Fourty-Two&#39; &#41;;
my $pi = dualvar&#40; 3.14, &#39;PI&#39; &#41;;

my @a : shared;

# Individual assignment
# Verify that dualvar preserved during individual element assignment
$a[0] = $dv;
$a[1] = $pi;

ok&#40; 2, $a[0] == 42, &#39;IV number preserved&#39; &#41;;
ok&#40; 3, $a[0] eq &#39;Fourty-Two&#39;, &#39;string preserved&#39; &#41;;
ok&#40; 4, $a[1] == 3.14, &#39;NV number preserved&#39; &#41;;
ok&#40; 5, $a[1] eq &#39;PI&#39;, &#39;string preserved&#39; &#41;;

#-- List initializer
# Verify that dualvar preserved during initialization
my @a2 : shared = &#40; $dv, $pi &#41;;

ok&#40; 6, $a2[0] == 42, &#39;IV number preserved&#39; &#41;;
ok&#40; 7, $a2[0] eq &#39;Fourty-Two&#39;, &#39;string preserved&#39; &#41;;
ok&#40; 8, $a2[1] == 3.14, &#39;NV number preserved&#39; &#41;;
ok&#40; 9, $a2[1] eq &#39;PI&#39;, &#39;string preserved&#39; &#41;;

#-- List assignment
# Verify that dualvar preserved during list assignment
my @a3 : shared = &#40; 0, 0 &#41;;
@a3 = &#40; $dv, $pi &#41;;

ok&#40; 10, $a3[0] == 42, &#39;IV number preserved&#39; &#41;;
ok&#40; 11, $a3[0] eq &#39;Fourty-Two&#39;, &#39;string preserved&#39; &#41;;
ok&#40; 12, $a3[1] == 3.14, &#39;NV number preserved&#39; &#41;;
ok&#40; 13, $a3[1] eq &#39;PI&#39;, &#39;string preserved&#39; &#41;;

# Back to non-shared
# Verify that entries are still dualvar when leaving the array
my @nsa = @a3;
ok&#40; 14, $nsa[0] == 42, &#39;IV number preserved&#39; &#41;;
ok&#40; 15, $nsa[0] eq &#39;Fourty-Two&#39;, &#39;string preserved&#39; &#41;;
ok&#40; 16, $nsa[1] == 3.14, &#39;NV number preserved&#39; &#41;;
ok&#40; 17, $nsa[1] eq &#39;PI&#39;, &#39;string preserved&#39; &#41;;

# Transmission of $! won&#39;t work because it&#39;s a tied SV
# so, sharing $! can&#39;t be done. However,  it can be &#34;ticked&#34;
# by creating a dualvar from it, which would remove the magic.
#

if&#40;0&#41; { #----- INFORMATIONAL, not part of test.
     $! = 33;

# my $ss : shared = $!;        ## &lt;&lt;== Won&#39;t work
     my @sa : shared = dualvar&#40;$!,$!&#41;; # works !

     my &#40;$x ,&#41; = @sa;
     printf &#34;X = %d/%s\n&#34;, $x, $x;
}

exit&#40;0&#41;;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;01&nbsp;09:19:27&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2012-09-30 14:08:14, philippe.causse@nsn.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The following  patch does the job and all tests succeed &#40;i.e. no bad 
&gt; side effects&#41;:
</div>
This is most excellent.  I have updated the module per your patch, and 
have sent a patch to blead.  When that is accepted, I&#39;ll propagate to 
CPAN.  Thanks.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;01&nbsp;17:03:41&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2012-10-01 09:19:27, JDHEDDEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 2012-09-30 14:08:14, philippe.causse@nsn.com wrote:
<div class="message-stanza open">&gt; &gt; The following  patch does the job and all tests succeed &#40;i.e. no bad 
&gt; &gt; side effects&#41;:
</div>&gt; 
&gt; This is most excellent.  I have updated the module per your patch, and 
&gt; have sent a patch to blead.  When that is accepted, I&#39;ll propagate to 
&gt; CPAN.  Thanks.
</div>
It turns out that there are several other places where this type of logic 
needs to be applied &#40;e.g., push, pop&#41;.  I&#39;m not going to release to CPAN 
until I have it all down.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;01&nbsp;18:36:26&nbsp;2012</span>
    <span class="description">philippe.causse [...] nsn.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #79906] numeric part of a dualvar not preserved via shared array / shared hash</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 02 Oct 2012 00:36:13 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-threads-shared [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Causse, Philippe &#40;NSN - DK/Copenhagen&#41;&#34; &lt;philippe.causse [...] nsn.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On 01/10/12 23.03, ext Jerry D. Hedden via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It turns out that there are several other places where this type of 
&gt; logic needs to be applied &#40;e.g., push, pop&#41;. I&#39;m not going to release 
&gt; to CPAN until I have it all down. 
</div>
Sorry, I have overlooked those.  The good news is that they are easily 
located and fixed.  Only PUSH and UNSHIFT required the extra work.
I have also checked operations on hashes and, as expected, it worked 
fine. So basically I checked all routines calling 
sharedsv_scalar_store&#40;&#41;  [which is basically where the problem happens] 
and added the fix as required.

Please find below a new context diff against shared.xs 1.41 &#40;including 
previously submitted changed&#41;, test code follows.

I believe that you have it all down now.

Best regards,
/Philippe.


phil$ diff -c  ~/threads-shared-1.41/shared.xs shared.xs
*** /Users/phil/threads-shared-1.41/shared.xs    2012-09-05 
19:20:53.000000000 +0200
--- shared.xs    2012-10-02 00:17:36.000000000 +0200
***************
*** 963,970 ****
           svp = hv_fetch&#40;&#40;HV*&#41; saggregate, key, len, 1&#41;;
       }
       CALLER_CONTEXT;
!     Perl_sharedsv_associate&#40;aTHX_ sv, *svp&#41;;
!     sharedsv_scalar_store&#40;aTHX_ sv, *svp&#41;;
       LEAVE_LOCK;
       return &#40;0&#41;;
   }
--- 963,976 ----
           svp = hv_fetch&#40;&#40;HV*&#41; saggregate, key, len, 1&#41;;
       }
       CALLER_CONTEXT;
!     {
!       U32 dualvar_flags = SvFLAGS&#40;sv&#41; &#38; &#40; SVf_IOK | SVf_NOK &#41;;
!       Perl_sharedsv_associate&#40;aTHX_ sv, *svp&#41;;
!       sharedsv_scalar_store&#40;aTHX_ sv, *svp&#41;;
!       if&#40;SvPOK&#40;*svp&#41;&#41; {
!     SvFLAGS&#40;*svp&#41; |= dualvar_flags; /* restore dualvar flags */
!       }
!     }
       LEAVE_LOCK;
       return &#40;0&#41;;
   }
***************
*** 1266,1275 ****
--- 1272,1283 ----
           for &#40;i = 1; i &lt; items; i++&#41; {
               SV* tmp = newSVsv&#40;ST&#40;i&#41;&#41;;
               SV *stmp;
+         U32 dualvar_flags =  SvFLAGS&#40;tmp&#41; &#38; &#40; SVf_IOK | SVf_NOK &#41;;
               ENTER_LOCK;
               stmp = S_sharedsv_new_shared&#40;aTHX_ tmp&#41;;
               sharedsv_scalar_store&#40;aTHX_ tmp, stmp&#41;;
               SHARED_CONTEXT;
+         if&#40; SvPOK&#40; stmp&#41; &#41; { SvFLAGS&#40;stmp&#41; |= dualvar_flags; }
               av_push&#40;&#40;AV*&#41; sobj, stmp&#41;;
               SvREFCNT_inc_void&#40;stmp&#41;;
               SHARED_RELEASE;
***************
*** 1289,1297 ****
--- 1297,1307 ----
           CALLER_CONTEXT;
           for &#40;i = 1; i &lt; items; i++&#41; {
               SV *tmp = newSVsv&#40;ST&#40;i&#41;&#41;;
+         U32 dualvar_flags =  SvFLAGS&#40;tmp&#41; &#38; &#40; SVf_IOK | SVf_NOK &#41;;
               SV *stmp = S_sharedsv_new_shared&#40;aTHX_ tmp&#41;;
               sharedsv_scalar_store&#40;aTHX_ tmp, stmp&#41;;
               SHARED_CONTEXT;
+         if&#40; SvPOK&#40; stmp&#41; &#41; { SvFLAGS&#40;stmp&#41; |= dualvar_flags; }
               av_store&#40;&#40;AV*&#41; sobj, i - 1, stmp&#41;;
               SvREFCNT_inc_void&#40;stmp&#41;;
               CALLER_CONTEXT;



################################################################
## Test set below, use same header as t/sv_simple.t
################################################################

use constant FOURTYTWO =&gt; dualvar&#40;42,&#39;Fourty-Two&#39;&#41;;
use constant PI =&gt; dualvar&#40;3.14,&#39;PI&#39;&#41;;

# This tests the following operations on shared arrays:
# PUSH, UNSHIFT, POP, SHIFT  &#40;others are not significant as they won&#39;t 
take an SV as input&#41;

## Test POP
my @sa2 : shared = &#40; FOURTYTWO, FOURTYTWO &#41;;

ok&#40;2, $sa2[0] == FOURTYTWO &#38;&#38; $sa2[0] eq FOURTYTWO, &#39;SA2[0] contains a 
dualvar&#39;&#41;;
ok&#40;3, $sa2[1] == FOURTYTWO &#38;&#38; $sa2[1] eq FOURTYTWO, &#39;SA2[1] contains a 
dualvar&#39;&#41;;
ok&#40;4, scalar @sa2 == 2 , &#39;SA2 is 2 elements long&#39;&#41;;

my $dv = pop @sa2;
ok&#40;5, $dv == FOURTYTWO, &#39;IV preserved after pop&#39;&#41;;
ok&#40;6, $dv eq FOURTYTWO, &#39;PV preserved after pop&#39;&#41;;


## Test SHIFT
my $dv2 = shift @sa2;

ok&#40;7, $dv2 == FOURTYTWO, &#39;IV preserved after shift&#39;&#41;;
ok&#40;8, $dv2 eq FOURTYTWO, &#39;PV preserved after shift&#39;&#41;;

## Test PUSH
my @sa : shared;
push @sa , FOURTYTWO;

ok&#40;9, $sa[0] == FOURTYTWO, &#39;IV preserved after push&#39;&#41;;
ok&#40;10, $sa[0] eq FOURTYTWO, &#39;PV preserved after push&#39;&#41;;


## Test UNSHIFT
unshift @sa, PI;
ok&#40;11, $sa[1] == FOURTYTWO &#38;&#38; $sa[1] eq FOURTYTWO , &#39;Dualvar FOURTYTWO 
now in slot 1&#39;&#41;;
ok&#40;12, $sa[0] == PI, &#39;PI.NV preserved after unshift&#39;&#41;;
ok&#40;13, $sa[0] eq PI, &#39;PI.PV preserved after unshift&#39;&#41;;


## Test shared-array to shared-array transfer. @sa3 should contain the 
same stuff

my @sa3 : shared = @sa;

ok&#40;14, $sa3[0] == PI &#38;&#38; $sa3[0] eq PI &#38;&#38;
        $sa3[1] == FOURTYTWO &#38;&#38; $sa3[1] eq FOURTYTWO,
        &#39;Copy of shared array ok&#39;&#41;;

#----------------------------------------------------------------------
#
# Test operations on hashes.
# Note that using a dualvar as hash key doesn&#39;t make sense, so we only 
test the value part.
#

my %sh : shared = &#40; pi =&gt; PI, fourtytwo =&gt; FOURTYTWO &#41;;

ok &#40;15,  &#40;2 == scalar grep { $_ &gt;0 &#38;&#38; length $_ &gt; 0 } values %sh&#41; , 
&#39;VALUES returns 2 dualvars&#39;&#41;;
my $elem = delete $sh{ pi };

ok&#40;16, $elem == PI &#38;&#38; $elem eq PI, &#39;DELETE returns a dualvar&#39;&#41;;

# Test access via EACH &#40;we have only one element, since previous test 
has deleted &#39;pi&#39;&#41;
ok&#40; 17, 1 == scalar keys %sh, &#39;One key left in hash&#39;&#41;;

my &#40;$k,$v&#41; = each %sh;
ok&#40;18, $k eq &#39;fourtytwo&#39;, &#39;Key is &#34;fourtytwo&#34;&#39;&#41;;
ok&#40;19, $v == FOURTYTWO &#38;&#38; $v eq FOURTYTWO, &#39;Dualvar present&#39;&#41;;


exit&#40;0&#41;;

# EOF
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;03&nbsp;08:52:58&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Version 1.42 uploaded to CPAN.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;03&nbsp;08:52:59&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;03&nbsp;08:53:13&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Fixed in 1.42 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
