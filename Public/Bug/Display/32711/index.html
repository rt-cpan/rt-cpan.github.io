<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #32711 for Catalyst-Runtime: Configuration parameter for utf8::encode in uri_for</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #32711 for Catalyst-Runtime: Configuration parameter for utf8::encode in uri_for</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Catalyst-Runtime/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Catalyst-Runtime/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Catalyst-Runtime/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Catalyst-Runtime/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Catalyst-Runtime">Catalyst-Runtime CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">32711</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Catalyst-Runtime/Active/">Catalyst-Runtime</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
knut-olav [...] hoven.ws

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-40040-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
5.7012    </td>
  </tr>
  <tr id="CF-40041-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;27&nbsp;12:48:20&nbsp;2008</span>
    <span class="description">knut-olav [...] hoven.ws -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Configuration parameter for utf8::encode in uri_for</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Added two files, one patch to add a configurable parameter for turning 
on/off the use of utf8::encode in the uri_for method, and the other 
file is a test for testing this.

The test file is the same as unit_core_uri_for.t, but without the use 
of utf8::encode.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> unit_core_uri_for_no_utf8_encode.t</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use warnings;

use Test::More tests =&gt; 14;
use URI;

use_ok&#40;&#39;Catalyst&#39;&#41;;

Catalyst-&gt;config&#40;
    &#39;utf8&#39;  =&gt; {
        &#39;encode&#39;    =&gt; 0,
    },
&#41;;

my $request = Catalyst::Request-&gt;new&#40; {
                base =&gt; URI-&gt;new&#40;&#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1/foo&#39;&#41;">http://127.0.0.1/foo&#39;&#41;</a></span>
              } &#41;;

my $context = Catalyst-&gt;new&#40; {
                request =&gt; $request,
                namespace =&gt; &#39;yada&#39;,
              } &#41;;

is&#40;
    Catalyst::uri_for&#40; $context, &#39;/bar/baz&#39; &#41;-&gt;as_string,
    &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1/foo/bar/baz&#39;">http://127.0.0.1/foo/bar/baz&#39;</a></span>,
    &#39;URI for absolute path&#39;
&#41;;

is&#40;
    Catalyst::uri_for&#40; $context, &#39;bar/baz&#39; &#41;-&gt;as_string,
    &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1/foo/yada/bar/baz&#39;">http://127.0.0.1/foo/yada/bar/baz&#39;</a></span>,
    &#39;URI for relative path&#39;
&#41;;

is&#40;
    Catalyst::uri_for&#40; $context, &#39;&#39;, &#39;arg1&#39;, &#39;arg2&#39; &#41;-&gt;as_string,
    &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1/foo/yada/arg1/arg2&#39;">http://127.0.0.1/foo/yada/arg1/arg2&#39;</a></span>,
    &#39;URI for undef action with args&#39;
&#41;;


is&#40; Catalyst::uri_for&#40; $context, &#39;../quux&#39; &#41;-&gt;as_string,
    &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1/foo/quux&#39;">http://127.0.0.1/foo/quux&#39;</a></span>, &#39;URI for relative dot path&#39; &#41;;

is&#40;
    Catalyst::uri_for&#40; $context, &#39;quux&#39;, { param1 =&gt; &#39;value1&#39; } &#41;-&gt;as_string,
    &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1/foo/yada/quux?param1=value1&#39;">http://127.0.0.1/foo/yada/quux?param1=value1&#39;</a></span>,
    &#39;URI for undef action with query params&#39;
&#41;;

is &#40;Catalyst::uri_for&#40; $context, &#39;/bar/wibble?&#39; &#41;-&gt;as_string,
   &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1/foo/bar/wibble%3F&#39;">http://127.0.0.1/foo/bar/wibble%3F&#39;</a></span>, &#39;Question Mark gets encoded&#39;
&#41;;
   
is&#40; Catalyst::uri_for&#40; $context, qw/bar wibble?/, &#39;with space&#39; &#41;-&gt;as_string,
    &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1/foo/yada/bar/wibble%3F/with%20space&#39;">http://127.0.0.1/foo/yada/bar/wibble%3F/with%20space&#39;</a></span>, &#39;Space gets encoded&#39;
&#41;;


# test with utf-8
is&#40;
    Catalyst::uri_for&#40; $context, &#39;quux&#39;, { param1 =&gt; &#34;\x{2620}&#34; } &#41;-&gt;as_string,
    &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1/foo/yada/quux?param1=%E2%98%A0&#39;">http://127.0.0.1/foo/yada/quux?param1=%E2%98%A0&#39;</a></span>,
    &#39;URI for undef action with query params in unicode&#39;
&#41;;


# test with object
is&#40;
    Catalyst::uri_for&#40; $context, &#39;quux&#39;, { param1 =&gt; $request-&gt;base } &#41;-&gt;as_string,
    &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1/foo/yada/quux?param1=http%3A%2F%2F127.0.0.1%2Ffoo&#39;">http://127.0.0.1/foo/yada/quux?param1=http%3A%2F%2F127.0.0.1%2Ffoo&#39;</a></span>,
    &#39;URI for undef action with query param as object&#39;
&#41;;

$request-&gt;base&#40; URI-&gt;new&#40;&#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:3000/&#39;&#41;">http://localhost:3000/&#39;&#41;</a></span> &#41;;
$request-&gt;match&#40; &#39;orderentry/contract&#39; &#41;;
is&#40;
    Catalyst::uri_for&#40; $context, &#39;/Orderentry/saveContract&#39; &#41;-&gt;as_string,
    &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:3000/Orderentry/saveContract&#39;">http://localhost:3000/Orderentry/saveContract&#39;</a></span>,
    &#39;URI for absolute path&#39;
&#41;;

{
    $request-&gt;base&#40; URI-&gt;new&#40;&#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1/&#39;&#41;">http://127.0.0.1/&#39;&#41;</a></span> &#41;;

    $context-&gt;namespace&#40;&#39;&#39;&#41;;

    is&#40; Catalyst::uri_for&#40; $context, &#39;/bar/baz&#39; &#41;-&gt;as_string,
        &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1/bar/baz&#39;">http://127.0.0.1/bar/baz&#39;</a></span>, &#39;URI with no base or match&#39; &#41;;

    # test &#34;0&#34; as the path
    is&#40; Catalyst::uri_for&#40; $context, qw/0 foo/ &#41;-&gt;as_string,
        &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1/0/foo&#39;">http://127.0.0.1/0/foo&#39;</a></span>, &#39;0 as path is ok&#39;
    &#41;;

}

# test with undef -- no warnings should be thrown
{
    my $warnings = 0;
    local $SIG{__WARN__} = sub { $warnings++ };

    Catalyst::uri_for&#40; $context, &#39;/bar/baz&#39;, { foo =&gt; undef } &#41;-&gt;as_string,
    is&#40; $warnings, 0, &#34;no warnings emitted&#34; &#41;;
}

</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Catalyst.pm-utf8-encode.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Catalyst.pm.orig    2008-01-27 18:07:51.000000000 +0100
+++ Catalyst.pm 2008-01-27 18:29:21.000000000 +0100
@@ -63,6 +63,12 @@
 __PACKAGE__-&gt;response_class&#40;&#39;Catalyst::Response&#39;&#41;;
 __PACKAGE__-&gt;stats_class&#40;&#39;Catalyst::Stats&#39;&#41;;

+__PACKAGE__-&gt;config&#40;
+    &#39;utf8&#39;  =&gt; {
+        &#39;encode&#39;    =&gt; 1,
+    },
+&#41;;
+
 # Remember to update this in Catalyst::Runtime as well!

 our $VERSION = &#39;5.7012&#39;;
@@ -673,7 +679,6 @@
     ---
     db: dsn:SQLite:foo.db

-
 =cut

 sub config {
@@ -920,6 +925,9 @@
 contain GET parameter key/value pairs, which will be appended to the URI
 in standard fashion.

+GET parameters will by default be converted with L&lt;utf8/encode&gt;. To disable
+this behaviour set the configuration parameter C&lt;{utf8}{encode}&gt; to C&lt;0&gt;.
+
 Instead of C&lt;$path&gt;, you can also optionally pass a C&lt;$action&gt; object
 which will be resolved to a path using
 C&lt;&lt; $c-&gt;dispatcher-&gt;uri_for_action &gt;&gt;; if the first element of
@@ -978,7 +986,7 @@
           $val = &#39;&#39; unless defined $val;
           &#40;map {
               $_ = &#34;$_&#34;;
-              utf8::encode&#40; $_ &#41;;
+              utf8::encode&#40; $_ &#41; if $c-&gt;config-&gt;{&#39;utf8&#39;}{&#39;encode&#39;};
               # using the URI::Escape pattern here so utf8 chars survive
               s/&#40;[^A-Za-z0-9\-_.!~*&#39;&#40;&#41; ]&#41;/$URI::Escape::escapes{$1}/go;
               s/ /+/g;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;27&nbsp;08:38:55&nbsp;2008</span>
    <span class="description">bricas [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Before we even attempt to apply this patch, can you explain in some
detail what is wrong with the way we currently do things, and why this
option would be useful? Thank you.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;27&nbsp;08:38:57&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;27&nbsp;08:39:09&nbsp;2008</span>
    <span class="description">bricas [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;13&nbsp;17:07:05&nbsp;2010</span>
    <span class="description">bobtfish [...] bobtfish.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I believe that this issue has been fixed in recent Catalyst releases,
therefore I&#39;m resolving it as this ticket hasn&#39;t been updated by the
original requester in a long time.

Please feel free to re-open if you thing there is still an issue here.

Cheers
t0m
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;13&nbsp;17:07:07&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;13&nbsp;17:07:07&nbsp;2010</span>
    <span class="description">bobtfish [...] bobtfish.net -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
