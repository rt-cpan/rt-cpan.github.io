<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #18376 for Mail-IMAPClient: fetch_hash&#40;&#41;  fails on large folders &#40;command line too long&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #18376 for Mail-IMAPClient: fetch_hash&#40;&#41;  fails on large folders &#40;command line too long&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Mail-IMAPClient/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Mail-IMAPClient/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Mail-IMAPClient/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Mail-IMAPClient/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-IMAPClient">Mail-IMAPClient CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">18376</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Mail-IMAPClient/Active/">Mail-IMAPClient</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">PLOBBES [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
kjetilho [...] ifi.uio.no

<br />
rct [...] r-t.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-19960-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-19961-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;26&nbsp;16:14:14&nbsp;2006</span>
    <span class="description">rct [...] r-t.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> fetch_hash&#40;&#41;  fails on large folders &#40;command line too long&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 26 Mar 2006 16:13:37 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Comment-Mail-IMAPClient [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Robert Terzi &lt;rct [...] r-t.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Version: 2.2.9

[FYI I tried to send this initially to DJKERNEN@cpan.org as a discussion
as mentioned in the docs.  I got a bounce back from map@kernengroup.com

I suppose technically this isn&#39;t a bug but rather more of a feature
request.]

fetch_hash&#40;&#41; can fail on large folders due to limits in
the IMAP server command length &#40;UW-IMAP takes 8,000 bytes&#41;.  In 
particular this affects &#40;older&#41; folders with sparse UID numbers, so
even when using Range&#40;&#41; the command length exceeds 8,000 bytes.

For fetch_hash&#40;&#41; I don&#39;t see a reasonable work around for client
code -- other than reimplementing fetch_hash&#40;&#41;.

After thinking about it a little bit, this is what I came up with:

Would it be reasonable to have a version of Range&#40;&#41;/MessageSet that
when given an argument for Max. command line size could return an
array of messageSets where the string version is smaller than the
max command line length?

Code that uses Range such as fetch&#40;&#41;, fetch_hash&#40;&#41;, ... would have
to iterate over of the array of objects &#40;or strings&#41; returned.

I don&#39;t know how many other IMAP servers are strict
about command length, I found one message from Mark Crispin where
he propoes that the official limit should be 1,000 characters which
sees unreasonbly strict.

I may try to implement something along these lines but I&#39;m not
sure I understand enough of messageset to do that withony breaking
anything yet.

IMAPClient is very nicely designed to make it easy to write quick
IMAP scripts.  I realize you can&#39;t possibly handle everything for
every IMAP server.  However, I think tackling &#40;some&#41; of the command
line length issues in IMAPClient, would make it more robust.

Thanks,
--Rob
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Create even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;05&nbsp;02:37:25&nbsp;2006</span>
    <span class="description">kjetilho [...] ifi.uio.no - Ticket #18547:  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> &#34;word too long&#34; using fetch_hash</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 05 Apr 2006 08:36:56 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-IMAPClient [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Kjetil Torgrim Homme &lt;kjetilho [...] ifi.uio.no&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m trying to use imapsync to move folders from one Cyrus server to
another, and it relies on Mail::IMAPClient to handle the protocol.  this
works very well with small folders, but fails when a folder contains
many messages.  we&#39;re using version 2.2.9.

transcript from debug output:

        Sending: 22 UID SEARCH ALL
        
        Sent 19 bytes
        Read: * SEARCH 841 843 844 [...] 26383 26385 26387
        
        22 OK Completed &#40;7375 msgs in 0.000 secs&#41;
        Sending: 23 UID FETCH 841,843:844,[...]26383,26385,26387 &#40;FLAGS INTERNALDATE RFC822.SIZE&#41;
        Sent 29329 bytes
        Read: * BYE Fatal error: word too long

I can&#39;t find anything in RFC 3501 which specifies limits to the length
of sequence sets, but Cyrus 2.2.12 has this limit:

imap/imapparse.c:    MAXWORD = 16384,

so the code in fetch_hash is too simplistic for use &#34;in the wild&#34;,
unfortunately:

        my $msgref = scalar&#40;$self-&gt;messages&#41;;
        my $output = scalar&#40;$self-&gt;fetch&#40;$msgref,&#34;&#40;&#34; . join&#40;&#34; &#34;,@_&#41; . &#34;&#41;&#34;&#41;&#41;

this needs to broken up into a loop, I suggest doing 1000 in each
iteration so it works even with very large mailboxes &#40;I don&#39;t think it
matters much for performance whether you do 1000 or 4000&#41;.

hmm.  perhaps it is better to fix fetch&#40;&#41; instead.

thanks for Mail::IMAPClient!
-- 
Kjetil T.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;29&nbsp;10:13:44&nbsp;2006</span>
    <span class="description">kjetilho [...] ifi.uio.no - Ticket #18547:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kjetilho [...] ifi.uio.no</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">this is a duplicate of #18376
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;29&nbsp;10:19:34&nbsp;2006</span>
    <span class="description">kjetilho [...] ifi.uio.no -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kjetilho [...] ifi.uio.no</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The suggested patch fixes fetch_hash, there may be more areas in the
code which needs a similar fix.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- ../orig/Mail-IMAPClient-2.2.9/IMAPClient.pm	2003-07-02 19:28:54.000000000 +0200
+++ IMAPClient.pm	2006-05-17 02:33:31.116283000 +0200
@@ -2333,12 +2333,22 @@
 	} elsif &#40;ref&#40;$what&#41; or $what =~ /^[,:\d]+\w*$/&#41;  {
 		$what = $self-&gt;Range&#40;$what&#41;;	
 	}
-	$self-&gt;_imap_command&#40; &#40; $self-&gt;Uid ? &#34;UID &#34; : &#34;&#34; &#41; .
-				&#34;FETCH $what&#34; . &#40; @_ ? &#34; &#34; . join&#40;&#34; &#34;,@_&#41; : &#39;&#39; &#41;
-	&#41; 	 					or return undef;
-	return wantarray ? 	$self-&gt;History&#40;$self-&gt;Count&#41; 	: 
-                              [ map { $_-&gt;[DATA] } @{$self-&gt;{&#39;History&#39;}{$self-&gt;Count}} ];
-
+	my $flags = @_ ? &#34; &#34; . join&#40;&#34; &#34;, @_&#41; : &#39;&#39;;
+	my @results = &#40;&#41;;
+	# UW-IMAPD has a max word size of 1024, Cyrus has 16384.
+	my $maxwordsize = 1024;
+	for my $range &#40;$what =~ /&#40;.{1,$maxwordsize}&#41;&#40;?:,|$&#41;/g&#41; {
+		$self-&gt;_imap_command&#40;&#40;$self-&gt;Uid ? &#34;UID &#34; : &#34;&#34;&#41; .
+				     &#34;FETCH $range&#34; . $flags&#41;
+			or next;
+		if &#40;wantarray&#41; {
+			push&#40;@results, $self-&gt;History&#40;$self-&gt;Count&#41;&#41;
+		} else {
+			push&#40;@results, map { $_-&gt;[DATA] }
+			               @{$self-&gt;{&#39;History&#39;}{$self-&gt;Count}}&#41;;
+		}
+	}
+	return wantarray ? @results : \@results;
 }
 
 
@@ -2601,7 +2611,7 @@
 
 	if &#40;$fields[0] 	=~ 	/^[Aa][Ll]{2}$/ 	&#41; { 
 
-		$string = 	&#34;$msg body&#34; . 
+		$string = 	&#34;body&#34; .
 		# use &#34;.peek&#34; if Peek parameter is a&#41; defined and true, 
 		# 	or b&#41; undefined, but not if it&#39;s defined and untrue:
 
@@ -2611,7 +2621,7 @@
 		&#41; .  &#34;[header]&#34; 			; 
 
 	} else {
-		$string	= 	&#34;$msg body&#34; .
+		$string	= 	&#34;body&#34; .
 		# use &#34;.peek&#34; if Peek parameter is a&#41; defined and true, or 
 		# b&#41; undefined, but not if it&#39;s defined and untrue:
 
@@ -2621,7 +2631,7 @@
 		&#41; .  &#34;[header.fields &#40;&#34;	. join&#40;&#34; &#34;,@fields&#41; 	. &#39;&#41;]&#39; ;
 	}
 
-	my @raw=$self-&gt;fetch&#40;	$string	&#41; or return undef;
+	my @raw=$self-&gt;fetch&#40;$msg, $string&#41; or return undef;
 
 	my $headers = {};	# hash from message ids to header hash
 	my $h = 0;		# reference to hash of current msgid, or 0 between msgs
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;29&nbsp;10:19:38&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;22&nbsp;17:33:57&nbsp;2007</span>
    <span class="description">MARKOV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Rob,

On Sun Mar 26 16:14:14 2006, rct@r-t.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [FYI I tried to send this initially to DJKERNEN@cpan.org as a
&gt; discussion has mentioned in the docs.  I got a bounce back from
&gt; map@kernengroup.com
</div>
I cannot reach him either, so captured this name-space.  A rigorous
cleanup of the code is complete, but needs testing... however there
are no interface changes &#40;yet0.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I suppose technically this isn&#39;t a bug but rather more of a feature
&gt; request.
</div>
It&#39;s more like a protocol design bug/problem.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; fetch_hash&#40;&#41; can fail on large folders due to limits in
&gt; the IMAP server command length &#40;UW-IMAP takes 8,000 bytes&#41;.  In 
&gt; particular this affects &#40;older&#41; folders with sparse UID numbers, so
&gt; even when using Range&#40;&#41; the command length exceeds 8,000 bytes.
&gt; 
&gt; For fetch_hash&#40;&#41; I don&#39;t see a reasonable work around for client
&gt; code -- other than reimplementing fetch_hash&#40;&#41;.
</div>
So... let&#39;s rewrite it.  Did you find a solutions?
Doesn&#39;t look too complex to me: in fetch&#40;&#41; simple check for the
length of the _imap_command&#40;&#41;, and split/rejoin when it is too
long.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Would it be reasonable to have a version of Range&#40;&#41;/MessageSet that
&gt; when given an argument for Max. command line size could return an
&gt; array of messageSets where the string version is smaller than the
&gt; max command line length?
&gt; Code that uses Range such as fetch&#40;&#41;, fetch_hash&#40;&#41;, ... would have
&gt; to iterate over of the array of objects &#40;or strings&#41; returned.
</div>
possible.  Probably, there are only a few places.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I don&#39;t know how many other IMAP servers are strict
&gt; about command length, I found one message from Mark Crispin where
&gt; he propoes that the official limit should be 1,000 characters which
&gt; sees unreasonbly strict.
</div>
Once the solution is made, it doesn&#39;t matter much.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I may try to implement something along these lines but I&#39;m not
&gt; sure I understand enough of messageset to do that withony breaking
&gt; anything yet.
</div>
I hope you have time for it.  Be warned: the new code looks much
different &#40;cleaner, I hope&#41;
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; IMAPClient is very nicely designed to make it easy to write quick
&gt; IMAP scripts.  I realize you can&#39;t possibly handle everything for
&gt; every IMAP server.  However, I think tackling &#40;some&#41; of the command
&gt; line length issues in IMAPClient, would make it more robust.
</div>
Sure

-- MarkOv
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;22&nbsp;17:36:42&nbsp;2007</span>
    <span class="description">MARKOV [...] cpan.org - Ticket #18547:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Apr 05 02:37:25 2006, kjetilho@ifi.uio.no wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m trying to use imapsync to move folders from one Cyrus server to
&gt; another, and it relies on Mail::IMAPClient to handle the protocol.
&gt; this
&gt; works very well with small folders, but fails when a folder contains
&gt; many messages.  we&#39;re using version 2.2.9.
</div>
I am the new maintainer, and will include patches/fixes.  The code
has seen a major clean-up &#40;to be released&#41;.  Did you implement a
work-around for your problem?  Maybe join efforts with the author of
the other reports about the same limitation?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;22&nbsp;17:36:44&nbsp;2007</span>
    <span class="description">The RT System itself - Ticket #18547:  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Take odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;25&nbsp;00:18:57&nbsp;2009</span>
    <span class="description">PLOBBES [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;25&nbsp;00:21:35&nbsp;2009</span>
    <span class="description">PLOBBES [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">In 3.17_01 &#40;not released&#41; and/or in 3.17 when released we will have the
following changes:

  - *new attribute Maxcommandlength used by fetch&#40;&#41; to limit
    length of commands sent to a server.  This should removes
    need for utilities like imapsync to create their own split&#40;&#41;
    functions and instead allows Mail::IMAPClient to hopefully
    &#34;do the right thing&#34; &#40;default will still be unlimited length&#41;
  - added _split_sequence&#40;&#41; to support new Maxcommandlength argument
  - fetch&#40;&#41;   
    + use new Maxcommandlength to split a request into multiple
      subrequests then aggregate results before passing them
      back to the caller
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;25&nbsp;00:21:36&nbsp;2009</span>
    <span class="description">PLOBBES [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;25&nbsp;00:24:26&nbsp;2009</span>
    <span class="description">PLOBBES [...] cpan.org - Ticket #18547:  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;25&nbsp;00:25:24&nbsp;2009</span>
    <span class="description">PLOBBES [...] cpan.org - Ticket #18547:  Merged into ticket #18376</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;25&nbsp;00:25:24&nbsp;2009</span>
    <span class="description">PLOBBES [...] cpan.org -  Merged into ticket #18376</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;25&nbsp;11:46:00&nbsp;2009</span>
    <span class="description">solutions [...] overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #18376] fetch_hash&#40;&#41;  fails on large folders &#40;command line too long&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 25 Apr 2009 17:39:28 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Phil Lobbes via RT &lt;bug-Mail-IMAPClient [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;solutions [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Phil Lobbes via RT &#40;bug-Mail-IMAPClient@rt.cpan.org&#41; [090425 04:21]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Mail-IMAPClient
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=18376">https://rt.cpan.org/Ticket/Display.html?id=18376</a></span> &gt;
&gt; 
&gt; In 3.17_01 &#40;not released&#41; and/or in 3.17 when released we will have the
&gt; following changes:
</div>
Good to hear

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;   - *new attribute Maxcommandlength used by fetch&#40;&#41; to limit
&gt;     length of commands sent to a server.  This should removes
&gt;     need for utilities like imapsync to create their own split&#40;&#41;
&gt;     functions and instead allows Mail::IMAPClient to hopefully
&gt;     &#34;do the right thing&#34; &#40;default will still be unlimited length&#41;
</div>
I would use a good large default, which DWIMs more.  It will probably
not hurt existing applications.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;25&nbsp;11:46:02&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;25&nbsp;17:15:51&nbsp;2009</span>
    <span class="description">phil [...] perkpartners.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #18376] fetch_hash&#40;&#41; fails on large folders &#40;command line too long&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 25 Apr 2009 17:15:25 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-IMAPClient [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Phil Lobbes &lt;phil [...] perkpartners.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Mark Overmeer via RT &lt;bug-Mail-IMAPClient@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt;   - *new attribute Maxcommandlength used by fetch&#40;&#41; to limit
&gt; &gt;     length of commands sent to a server.  This should removes
&gt; &gt;     need for utilities like imapsync to create their own split&#40;&#41;
&gt; &gt;     functions and instead allows Mail::IMAPClient to hopefully
&gt; &gt;     &#34;do the right thing&#34; &#40;default will still be unlimited length&#41;
</div>&gt; 
&gt; I would use a good large default, which DWIMs more.  It will probably
&gt; not hurt existing applications.
</div>
Preferences? 1000B, 1K or maybe 8K... I&#39;ve seen a 16K limit for
courier-imap:

  #define        IT_MAX_ATOM_SIZE        16384

But I wouldn&#39;t be surprised if someone else has a lower limit.

FWIW, RFC2683 section 3.2.1.5 suggests:

  &#34;A client should limit the length of the command lines it generates to
  approximately 1000 octets&#34;
  ...
  &#34;For its part, a server should allow for a command line of at least
  8000 octets&#34;

Maybe we should default to 1000 and be done with it.  At least we&#39;ll
follow one recommendation :-&#41;.

Phil
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;27&nbsp;04:20:58&nbsp;2009</span>
    <span class="description">solutions [...] overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #18376] fetch_hash&#40;&#41; fails on large folders &#40;command line too long&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 27 Apr 2009 10:20:39 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;phil [...] perkpartners.com via RT&#34; &lt;bug-Mail-IMAPClient [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;solutions [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* phil@perkpartners.com via RT &#40;bug-Mail-IMAPClient@rt.cpan.org&#41; [090425 21:15]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Preferences? 1000B, 1K or maybe 8K... I&#39;ve seen a 16K limit for
&gt; courier-imap:
&gt;   #define        IT_MAX_ATOM_SIZE        16384
&gt; But I wouldn&#39;t be surprised if someone else has a lower limit.
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; FWIW, RFC2683 section 3.2.1.5 suggests:
&gt;   &#34;A client should limit the length of the command lines it generates to
&gt;   approximately 1000 octets&#34;
</div>
If you put the limit low, than the option will get tested
continuously ;-&#41;   I can imagin that it will have considerable
impact on server where the messages are kept in a database, but
am unsure whether they benefit or not.

Great improvement.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;27&nbsp;05:24:53&nbsp;2009</span>
    <span class="description">kjetilho [...] ifi.uio.no -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> rct [...] r-t.org, DJKERNEN__NO_SOLICITING__ [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #18376] fetch_hash&#40;&#41; fails on large folders &#40;command line too long&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 27 Apr 2009 11:24:29 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-IMAPClient [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Kjetil Torgrim Homme &lt;kjetilho [...] ifi.uio.no&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, 2009-04-27 at 04:21 -0400, Mark Overmeer via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=18376">http://rt.cpan.org/Ticket/Display.html?id=18376</a></span> &gt;
&gt; 
&gt; * phil@perkpartners.com via RT &#40;bug-Mail-IMAPClient@rt.cpan.org&#41; [090425 21:15]:
<div class="message-stanza open">&gt; &gt; Preferences? 1000B, 1K or maybe 8K... I&#39;ve seen a 16K limit for
&gt; &gt; courier-imap:
&gt; &gt;   #define        IT_MAX_ATOM_SIZE        16384
&gt; &gt; But I wouldn&#39;t be surprised if someone else has a lower limit.
</div>&gt; 
<div class="message-stanza open">&gt; &gt; FWIW, RFC2683 section 3.2.1.5 suggests:
&gt; &gt;   &#34;A client should limit the length of the command lines it generates to
&gt; &gt;   approximately 1000 octets&#34;
</div>&gt; 
&gt; If you put the limit low, than the option will get tested
&gt; continuously ;-&#41;   I can imagin that it will have considerable
&gt; impact on server where the messages are kept in a database, but
&gt; am unsure whether they benefit or not.
</div>
thank you for fixing this!  1000 sounds good, but it would be useful to
include the practical information about limits which have surfaced in
the documentation, ie. 8000 octets for UW-IMAPD and 16384 octets for
Courier and Cyrus so that users can make an informed decision when
tweaking the limit.

&#40;BTW, although the Courier and Cyrus limit is on the word/atom length,
not the total command line length, I don&#39;t think it&#39;s very useful to go
to that kind of detail in the docs.&#41;

-- 
best wishes,
Kjetil T.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;08&nbsp;00:24:14&nbsp;2009</span>
    <span class="description">PLOBBES [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Next release &#40;3.17&#41; will have Maxcommandlength documented and also
includes some notes on the limits seen with UW-IMAPD, Courier and Cyrus.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;08&nbsp;00:24:15&nbsp;2009</span>
    <span class="description">PLOBBES [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
