<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #39849 for XML-Twig: XML::Twig output-encoding utf-8 doesn&#39;t play nice with binmode :utf8</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #39849 for XML-Twig: XML::Twig output-encoding utf-8 doesn&#39;t play nice with binmode :utf8</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=XML-Twig">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=XML-Twig">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=XML-Twig">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=XML-Twig">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-Twig">XML-Twig CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">39849</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=XML-Twig">XML-Twig</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
AZED [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-37682-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
3.32    </td>
  </tr>
  <tr id="CF-37683-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




test_unicode_fh-1252_input.xml<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/520015/259629/test_unicode_fh-1252_input.xml">
Wed Oct 15 18:04:25 2008 (72b) by AZED [...] cpan.org
</a>
</font></li>
</ul>


test_unicode_fh.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/519576/259365/test_unicode_fh.t">
Tue Oct 14 17:03:53 2008 (1.3k) by AZED [...] cpan.org
</a>
</font></li>
</ul>


test_unicode_fh_v2.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/519650/259406/test_unicode_fh_v2.t">
Tue Oct 14 23:02:31 2008 (2.6k) by AZED [...] cpan.org
</a>
</font></li>
</ul>


test_unicode_fh_v3.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/520015/259626/test_unicode_fh_v3.t">
Wed Oct 15 18:04:25 2008 (5.4k) by AZED [...] cpan.org
</a>
</font></li>
</ul>


twig-unicode.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/516761/257753/twig-unicode.pl">
Mon Oct 06 21:38:36 2008 (476b) by AZED [...] cpan.org
</a>
</font></li>
</ul>


twig_slow-unicode_print.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/519648/259400/twig_slow-unicode_print.patch">
Tue Oct 14 23:00:34 2008 (935b) by AZED [...] cpan.org
</a>
</font></li>
</ul>


twig_slow-unicode_print_v3.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/520015/259632/twig_slow-unicode_print_v3.patch">
Wed Oct 15 18:04:25 2008 (1k) by AZED [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=39849">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-516761" href="/Public/Bug/Display.html?id=39849#txn-516761">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;06&nbsp;21:38:36&nbsp;2008</span>
    <span class="description">AZED [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> XML::Twig output-encoding utf-8 doesn&#39;t play nice with binmode :utf8</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/516761/257750/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/257750">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 757b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve attached a small test case that should illustrate the problem.  If
you leave :utf8 on the filehandle, the twig unicode characters get
encoded twice, and end up garbled.  If you take it off, the perl print
output doesn&#39;t get encoded, and ends up garbled.

You can get around this by not specifying output-encoding in new&#40;&#41;, but
if you do that, you lose your XML declaration and have to print it in by
hand.

The only way to make this work currently, it seems, is to make sure
never to share filehandles, and make sure that any filehandles used for
Twig output have no layer set, and any filehandles used for anything
else do.

I suspect this might be what bit the guy who reported #18284, but since
he never wrote back, there&#39;s no way to tell for sure.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> twig-unicode.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/516761/257753/twig-unicode.pl">Download twig-unicode.pl</a><br />
<span class="downloadcontenttype">text/x-perl 476b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use XML::Twig;
use utf8;

my $twig = XML::Twig-&gt;new&#40;
    keep_atts_order =&gt; 1,
    output_encoding =&gt; &#39;utf-8&#39;,
    pretty_print =&gt; &#39;record&#39;
&#41;;
$twig-&gt;parse&#40;\*DATA&#41;;
my $greet = $twig-&gt;root-&gt;insert_new_elt&#40;&#39;last_child&#39;,&#39;greeting&#39;&#41;;
$greet-&gt;set_text&#40;&#34;Gr\x{00FC}\x{00DF} Dich!&#34;&#41;;
open&#40;my $fh,&#34;&gt;:encoding&#40;utf8&#41;&#34;,&#39;twig-unicode-out.xml&#39;&#41;;
$twig-&gt;print&#40;\*$fh&#41;;
print {*$fh} &#34;&lt;copyright&gt;Copyright \x{00A9} 2008 Me&lt;/copyright&gt;\n&#34;;
close&#40;$fh&#41;;

__DATA__
&lt;root&gt;
&lt;/root&gt;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-516764" href="/Public/Bug/Display.html?id=39849#txn-516764">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;06&nbsp;21:38:51&nbsp;2008</span>
    <span class="description">AZED [...] cpan.org -  Reference to ticket #18284 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-517310" href="/Public/Bug/Display.html?id=39849#txn-517310">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;08&nbsp;03:50:19&nbsp;2008</span>
    <span class="description">xmltwig [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #39849] XML::Twig output-encoding utf-8 doesn&#39;t play nice with binmode :utf8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 08 Oct 2008 09:50:18 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mirod &lt;xmltwig [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/517310/258085/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/258085">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Zed Pobre via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Mon Oct 06 21:38:36 2008: Request 39849 was acted upon.
&gt; Transaction: Ticket created by AZED
&gt;        Queue: XML-Twig
&gt;      Subject: XML::Twig output-encoding utf-8 doesn&#39;t play nice with binmode :utf8
&gt;    Broken in: 3.32
&gt;     Severity: Normal
&gt;        Owner: Nobody
&gt;   Requestors: AZED@cpan.org
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=39849">http://rt.cpan.org/Ticket/Display.html?id=39849</a></span> &gt;
&gt; 
&gt; 
&gt; I&#39;ve attached a small test case that should illustrate the problem.  If
&gt; you leave :utf8 on the filehandle, the twig unicode characters get
&gt; encoded twice, and end up garbled.  If you take it off, the perl print
&gt; output doesn&#39;t get encoded, and ends up garbled.
&gt; 
&gt; You can get around this by not specifying output-encoding in new&#40;&#41;, but
&gt; if you do that, you lose your XML declaration and have to print it in by
&gt; hand.
&gt; 
&gt; The only way to make this work currently, it seems, is to make sure
&gt; never to share filehandles, and make sure that any filehandles used for
&gt; Twig output have no layer set, and any filehandles used for anything
&gt; else do.
</div>
I see the problem.

output-encoding creates the xml declaration, but also a filter to convert the 
output to the proper encoding. By default what the parser gets is already in 
utf8, so nothing needs to be done on it. The filter should do nothing, and the 
binmode :utf8 should just keep the output from being downgraded to latin1 &#40;which 
is what it does for the regular print&#41;.

I have tried a couple of fixes so far, but they don&#39;t pass the regression tests. 
I&#39;ll keep you posted.

Thanks

-- 
mirod
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-517311" href="/Public/Bug/Display.html?id=39849#txn-517311">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;08&nbsp;03:50:21&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-519441" href="/Public/Bug/Display.html?id=39849#txn-519441">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;14&nbsp;08:37:23&nbsp;2008</span>
    <span class="description">xmltwig [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #39849] XML::Twig output-encoding utf-8 doesn&#39;t play nice with binmode :utf8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 14 Oct 2008 14:37:26 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mirod &lt;xmltwig [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/519441/259259/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/259259">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Zed Pobre via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Mon Oct 06 21:38:36 2008: Request 39849 was acted upon.
&gt; Transaction: Ticket created by AZED
&gt;        Queue: XML-Twig
&gt;      Subject: XML::Twig output-encoding utf-8 doesn&#39;t play nice with binmode :utf8
&gt;    Broken in: 3.32
&gt;     Severity: Normal
&gt;        Owner: Nobody
&gt;   Requestors: AZED@cpan.org
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=39849">http://rt.cpan.org/Ticket/Display.html?id=39849</a></span> &gt;
&gt; 
&gt; 
&gt; I&#39;ve attached a small test case that should illustrate the problem.  If
&gt; you leave :utf8 on the filehandle, the twig unicode characters get
&gt; encoded twice, and end up garbled.  If you take it off, the perl print
&gt; output doesn&#39;t get encoded, and ends up garbled.
&gt; 
&gt; You can get around this by not specifying output-encoding in new&#40;&#41;, but
&gt; if you do that, you lose your XML declaration and have to print it in by
&gt; hand.
&gt; 
&gt; The only way to make this work currently, it seems, is to make sure
&gt; never to share filehandles, and make sure that any filehandles used for
&gt; Twig output have no layer set, and any filehandles used for anything
&gt; else do.
&gt; 
&gt; I suspect this might be what bit the guy who reported #18284, but since
&gt; he never wrote back, there&#39;s no way to tell for sure.
</div>
OK, I think I have it.

You can try the development version, it passes both the test you sent &#40;with the 
output file opened with &#39;:utf8&#39;&#41; and the regression tests, so it looks good.

-- 
mirod
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-519476" href="/Public/Bug/Display.html?id=39849#txn-519476">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;14&nbsp;10:50:08&nbsp;2008</span>
    <span class="description">AZED [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/519476/259288/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/259288">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 314b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Very short answer for now is no, something isn&#39;t right.  I installed
today&#39;s build, ran the regression tests on my current project and
something broke, and it works fine with yesterday&#39;s build.

It looks like some output switched to Latin-1, but it will take me a
little while to write you a simplified test case.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-519576" href="/Public/Bug/Display.html?id=39849#txn-519576">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;14&nbsp;17:03:53&nbsp;2008</span>
    <span class="description">AZED [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/519576/259362/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/259362">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 443b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Okay, now that I&#39;ve had the time to poke at it again, the problem is
that XML::Twig is no longer doing the right thing when the filehandle
*isn&#39;t* binmode :utf8 -- no conversion is being applied at all, even
when encoding is set for utf-8.

I&#39;m attaching a Test::More case that simply writes and reads back an
element with UTF8 text under three filehandle conditions -- you can see
the results flip-flop between yesterday&#39;s build and today&#39;s.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/519576/259365/test_unicode_fh.t">Download test_unicode_fh.t</a><br />
<span class="downloadcontenttype">text/x-perl 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">use warnings; use strict;
use utf8;
binmode&#40;STDOUT,&#39;:utf8&#39;&#41;;
binmode&#40;STDERR,&#39;:utf8&#39;&#41;;

use Test::More tests =&gt; 7;
binmode&#40;Test::More-&gt;builder-&gt;failure_output,&#39;:utf8&#39;&#41;;
BEGIN { use_ok&#40;&#39;XML::Twig&#39;&#41; };

my $twig = XML::Twig-&gt;new&#40;
    output_encoding =&gt; &#39;utf-8&#39;,
    pretty_print =&gt; &#39;record&#39;
&#41;;
my $u8string = &#34;Gr\x{00FC}\x{00DF} Dich!&#34;;
utf8::upgrade&#40;$u8string&#41;;
my $twigstring = &#34;&lt;twiggreet&gt;&#34; . $u8string . &#34;&lt;/twiggreet&gt;\n&#34;;

my $fh;

$twig-&gt;parse&#40;$twigstring&#41;;
open&#40;$fh,&#34;&gt;:encoding&#40;utf8&#41;&#34;,&#39;twig-unicode-openencutf8.xml&#39;&#41; or die;
$twig-&gt;print&#40;\*$fh&#41;;
close&#40;$fh&#41; or die;
ok&#40;$twig-&gt;safe_parsefile&#40;&#39;twig-unicode-openencutf8.xml&#39;&#41;,
   &#39;output via &#34;&gt;:encoding&#40;utf8&#41;&#34; is parseable&#39;&#41;;
is&#40;$twig-&gt;root-&gt;text,$u8string,
   &#39;output via &#34;&gt;:encoding&#40;utf8&#41;&#34; is correct&#39;&#41;;

$twig-&gt;parse&#40;$twigstring&#41;;
open&#40;$fh,&#34;&gt;:utf8&#34;,&#39;twig-unicode-openutf8.xml&#39;&#41; or die;
$twig-&gt;print&#40;\*$fh&#41;;
close&#40;$fh&#41; or die;
ok&#40;$twig-&gt;safe_parsefile&#40;&#39;twig-unicode-openutf8.xml&#39;&#41;,
   &#39;output via &#34;&gt;:utf8&#34; is parseable&#39;&#41;;
is&#40;$twig-&gt;root-&gt;text,$u8string,
   &#39;output via &#34;&gt;:utf8&#34; is correct&#39;&#41;;

$twig-&gt;parse&#40;$twigstring&#41;;
open&#40;$fh,&#34;&gt;&#34;,&#39;twig-unicode-open.xml&#39;&#41; or die;
$twig-&gt;print&#40;\*$fh&#41;;
close&#40;$fh&#41; or die;
ok&#40;$twig-&gt;safe_parsefile&#40;&#39;twig-unicode-open.xml&#39;&#41;,
   &#39;output via &#34;&gt;&#34; is parseable&#39;&#41;;
is&#40;$twig-&gt;root-&gt;text,$u8string,
   &#39;output via &#34;&gt;&#34; is correct&#39;&#41;;

unlink&#40;&#39;twig-unicode-openencutf8.xml&#39;&#41;;
unlink&#40;&#39;twig-unicode-openutf8.xml&#39;&#41;;
unlink&#40;&#39;twig-unicode-open.xml&#39;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-519589" href="/Public/Bug/Display.html?id=39849#txn-519589">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;14&nbsp;18:34:21&nbsp;2008</span>
    <span class="description">AZED [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/519589/259372/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/259372">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 533b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">An additional thought:

While poking at your code, I thought that perhaps I could solve the
problem by creating an additional converter method using utf8::upgrade
&#40;which is idempotent&#41; to use if $enc is utf-8, but I haven&#39;t been able
to make it work.  Inserting a debugging line, I can see the damn thing
activating in all three cases, but it doesn&#39;t change the output, so
there&#39;s something I fundamentally don&#39;t understand about how XML::Twig
is using those filters.

Maybe you can take that idea and run with it better than I did.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-519591" href="/Public/Bug/Display.html?id=39849#txn-519591">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;14&nbsp;19:23:23&nbsp;2008</span>
    <span class="description">AZED [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/519591/259374/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/259374">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 433b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Scratch that last thought.  The strings are already considered utf8
internally, which is why upgrade wasn&#39;t doing anything.  I&#39;m not quite
sure what&#39;s going on, but my attempt to move the detection to inside
encode_convert showed that is_utf8&#40;$_[0],1&#41; always returned true for the
user string and false for the XML declaration.

I&#39;m now thinking about forcing the binmode at the XML::Twig::Elt-&gt;print
stage if the encoding is utf-8.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-519648" href="/Public/Bug/Display.html?id=39849#txn-519648">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;14&nbsp;23:00:34&nbsp;2008</span>
    <span class="description">AZED [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/519648/259397/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/259397">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Got it.

The attached patch &#40;against the 2008.10.14 dev release&#41; fixes the issue,
at least for XML::Twig-&gt;print, and passes all unit tests.  I have left
the code that would have done the same for XML::Twig::Elt-&gt;print
commented out, because it causes the IO::Scalar unit tests to break near
the end, with the error:

Can&#39;t locate object method &#34;BINMODE&#34; via package &#34;IO::Scalar&#34;

Googling around a bit, this is almost certainly a bug in IO::Scalar, but
I have no idea how to fix it, and given your other responses, I imagine
you&#39;d rather just wait it out rather than implement a fix to XML::Twig
that triggers an IO::Scalar bug for existing users.

I&#39;ve rewritten the unit test file for this issue to include tests for
XML::Twig::Elt-&gt;print, but has the two failing cases inside a TODO
block, so it won&#39;t interrupt the normal build process until this issue
gets resolved.  I&#39;ll attach that to the next update.

One final note:  could you PLEASE have the &#39;speedup&#39; script copy the
existing Twig.pm to a backup, and document in the README that you have
to edit Twig_pm.slow to get your changes to stick?  I&#39;m very happy I was
regularly diffing out my changes into patch files, because I got a nasty
surprise the first time I ran &#39;make test&#39;.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/519648/259400/twig_slow-unicode_print.patch">Download twig_slow-unicode_print.patch</a><br />
<span class="downloadcontenttype">text/x-diff 935b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- XML-Twig-3.33/Twig_pm.slow	2008-10-14 06:45:01.000000000 -0400
+++ libxml-twig-perl-3.33~20081014/Twig_pm.slow	2008-10-14 22:43:22.000000000 -0400
@@ -2865,6 +2865,10 @@
 sub print
   { my $t= shift;
     my $fh=  _is_fh&#40; $_[0]&#41;  ? shift : undef;
+    if&#40;defined $fh&#41;
+      { binmode $fh,&#34;:utf8&#34;
+            if&#40;$t-&gt;{output_encoding} &#38;&#38; $t-&gt;{output_encoding} =~ /^utf-8$/i&#41;;
+      }
     my %args= _normalize_args&#40; @_&#41;;
 
     my $old_select    = defined $fh                  ? select $fh                                 : undef;
@@ -7695,6 +7699,9 @@
   
       my $pretty;
       my $fh= _is_fh&#40; $_[0]&#41; ? shift : undef;
+# This breaks IO::Scalar tests, but that may be a bug in IO::Scalar
+#      if&#40;defined $fh&#41; { binmode $fh,&#34;:utf8&#34; unless&#40;$output_filter&#41;; }
+
       my $old_select= defined $fh ? select $fh : undef;
       my $old_pretty= defined &#40;$pretty= shift&#41; ? set_pretty_print&#40; $pretty&#41; : undef;
       $pretty ||=0;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-519650" href="/Public/Bug/Display.html?id=39849#txn-519650">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;14&nbsp;23:02:31&nbsp;2008</span>
    <span class="description">AZED [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/519650/259403/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/259403">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 136b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The new unit test is attached here.  And I&#39;m an idiot because I missed
the &#39;Add More Files&#39; button right in front of my face.  Ah well.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/519650/259406/test_unicode_fh_v2.t">Download test_unicode_fh_v2.t</a><br />
<span class="downloadcontenttype">text/x-perl 2.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use utf8;

use Test::More tests =&gt; 13;
binmode&#40;Test::More-&gt;builder-&gt;failure_output,&#39;:utf8&#39;&#41;;
BEGIN { use_ok&#40;&#39;XML::Twig&#39;&#41; };

my $twig = XML::Twig-&gt;new&#40;
    output_encoding =&gt; &#39;utf-8&#39;,
    pretty_print =&gt; &#39;record&#39;
&#41;;
my $u8string = &#34;Gr\x{00FC}\x{00DF} Dich!&#34;;
utf8::upgrade&#40;$u8string&#41;;
my $twigstring = &#34;&lt;twiggreet&gt;&#34; . $u8string . &#34;&lt;/twiggreet&gt;\n&#34;;
utf8::upgrade&#40;$twigstring&#41;;
utf8::upgrade&#40;$twigstring&#41;;

my $fh;

$twig-&gt;parse&#40;$twigstring&#41;;
open&#40;$fh,&#34;&gt;:encoding&#40;utf8&#41;&#34;,&#39;twig-unicode-openencutf8.xml&#39;&#41; or die;
$twig-&gt;print&#40;\*$fh&#41;;
close&#40;$fh&#41; or die;
ok&#40;$twig-&gt;safe_parsefile&#40;&#39;twig-unicode-openencutf8.xml&#39;&#41;,
   &#39;twig output via &#34;&gt;:encoding&#40;utf8&#41;&#34; is parseable&#39;&#41;;
is&#40;$twig-&gt;root-&gt;text,$u8string,
   &#39;twig output via &#34;&gt;:encoding&#40;utf8&#41;&#34; is correct&#39;&#41;;

$twig-&gt;parse&#40;$twigstring&#41;;
open&#40;$fh,&#34;&gt;:utf8&#34;,&#39;twig-unicode-openutf8.xml&#39;&#41; or die;
$twig-&gt;print&#40;\*$fh&#41;;
close&#40;$fh&#41; or die;
ok&#40;$twig-&gt;safe_parsefile&#40;&#39;twig-unicode-openutf8.xml&#39;&#41;,
   &#39;twig output via &#34;&gt;:utf8&#34; is parseable&#39;&#41;;
is&#40;$twig-&gt;root-&gt;text,$u8string,
   &#39;twig output via &#34;&gt;:utf8&#34; is correct&#39;&#41;;

$twig-&gt;parse&#40;$twigstring&#41;;
open&#40;$fh,&#34;&gt;&#34;,&#39;twig-unicode-open.xml&#39;&#41; or die;
$twig-&gt;print&#40;\*$fh&#41;;
close&#40;$fh&#41; or die;
ok&#40;$twig-&gt;safe_parsefile&#40;&#39;twig-unicode-open.xml&#39;&#41;,
   &#39;twig output via &#34;&gt;&#34; is parseable&#39;&#41;;
is&#40;$twig-&gt;root-&gt;text,$u8string,
   &#39;twig output via &#34;&gt;&#34; is correct&#39;&#41;;

$twig-&gt;parse&#40;$twigstring&#41;;
open&#40;$fh,&#34;&gt;:encoding&#40;utf8&#41;&#34;,&#39;twigelt-unicode-openencutf8.xml&#39;&#41; or die;
print {*fh} $twig-&gt;prolog;
$twig-&gt;root-&gt;print&#40;\*$fh&#41;;
close&#40;$fh&#41; or die;
ok&#40;$twig-&gt;safe_parsefile&#40;&#39;twigelt-unicode-openencutf8.xml&#39;&#41;,
   &#39;twigelt output via &#34;&gt;:encoding&#40;utf8&#41;&#34; is parseable&#39;&#41;;
is&#40;$twig-&gt;root-&gt;text,$u8string,
   &#39;twigelt output via &#34;&gt;:encoding&#40;utf8&#41;&#34; is correct&#39;&#41;;

$twig-&gt;parse&#40;$twigstring&#41;;
open&#40;$fh,&#34;&gt;:utf8&#34;,&#39;twigelt-unicode-openutf8.xml&#39;&#41; or die;
print {*fh} $twig-&gt;prolog;
$twig-&gt;root-&gt;print&#40;\*$fh&#41;;
close&#40;$fh&#41; or die;
ok&#40;$twig-&gt;safe_parsefile&#40;&#39;twigelt-unicode-openutf8.xml&#39;&#41;,
   &#39;twigelt output via &#34;&gt;:utf8&#34; is parseable&#39;&#41;;
is&#40;$twig-&gt;root-&gt;text,$u8string,
   &#39;twigelt output via &#34;&gt;:utf8&#34; is correct&#39;&#41;;

TODO:
{
local $TODO = &#34;Fixing utf-8 output for XML::Twig::Elt-&gt;print breaks IO::Scalar tests&#34;;
$twig-&gt;parse&#40;$twigstring&#41;;
open&#40;$fh,&#34;&gt;&#34;,&#39;twigelt-unicode-open.xml&#39;&#41; or die;
print {*fh} $twig-&gt;prolog;
$twig-&gt;root-&gt;print&#40;\*$fh&#41;;
close&#40;$fh&#41; or die;
ok&#40;$twig-&gt;safe_parsefile&#40;&#39;twigelt-unicode-open.xml&#39;&#41;,
   &#39;twigelt output via &#34;&gt;&#34; is parseable&#39;&#41;;
is&#40;$twig-&gt;root-&gt;text,$u8string,
   &#39;twigelt output via &#34;&gt;&#34; is correct&#39;&#41;;
}
unlink&#40;&#39;twig-unicode-openencutf8.xml&#39;&#41;;
unlink&#40;&#39;twig-unicode-openutf8.xml&#39;&#41;;
unlink&#40;&#39;twig-unicode-open.xml&#39;&#41;;
unlink&#40;&#39;twigelt-unicode-openencutf8.xml&#39;&#41;;
unlink&#40;&#39;twigelt-unicode-openutf8.xml&#39;&#41;;
unlink&#40;&#39;twigelt-unicode-open.xml&#39;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-519746" href="/Public/Bug/Display.html?id=39849#txn-519746">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;15&nbsp;04:31:33&nbsp;2008</span>
    <span class="description">xmltwig [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #39849] XML::Twig output-encoding utf-8 doesn&#39;t play nice with binmode :utf8</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 15 Oct 2008 10:31:39 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mirod &lt;xmltwig [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/519746/259447/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/259447">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Zed Pobre via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: XML-Twig
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=39849">http://rt.cpan.org/Ticket/Display.html?id=39849</a></span> &gt;
&gt; 
&gt; Okay, now that I&#39;ve had the time to poke at it again, the problem is
&gt; that XML::Twig is no longer doing the right thing when the filehandle
&gt; *isn&#39;t* binmode :utf8 -- no conversion is being applied at all, even
&gt; when encoding is set for utf-8.
</div>
The goal is to be able to mix XML::Twig&#39;s print method and regular Perl print.
This can be done by opening the filehandle with in :utf8 mode. So you have a way 
to get the output you want. Beyond that, I am not sure what I can do, especially 
as there is no way that I know of to determine what the IO layer applied to an 
open filehandle is &#40;I might be wrong&#41;.

If I understand correctly, all these complex tests that try to figure out 
whether the output filter needs or needs not be applied are there only to avoid 
you printing the XML declaration. Which you don&#39;t need if you&#39;re working in 
unicode. So I am a bit hesitant to go much further down that road for what I see 
as a not-so-compelling reason.

Unicode is tricky in regular Perl. If you print a string to a filehandle that is 
not open as :utf8, then it will be converted to latin-1 &#40;in order for older code 
to still work the same&#41;. Which is what will happen here, whether the print is 
done by XML::Twig or by a regular print. That&#39;s consistent. Bottom line, if 
you&#39;re working with utf8 and your filehandle is not open as :utf-8, you are just 
asking for trouble.

XML::Twig cannot make things easier than they are in Perl.

In short, you should open all of your output files with a :utf8 layer, and the 
code should work, and maybe drop the output_encoding option, which was created 
to allow output in non-utf8, IIRC in the days before 5.8, when encoding 
conversions weren&#39;t as easy as specifying the encoding layer when opening the 
file. I might add something about it, or even write a piece in the docs about 
how to handle encodings.

I will look at your patch, but it doesn&#39;t seem to take into account the 
keep_encoding option, that keeps the original encoding of the XML, and which is 
a feature that&#39;s &#40;still&#41; quite popular. So I have to test it some more.

-- 
mirod
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-520015" href="/Public/Bug/Display.html?id=39849#txn-520015">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;15&nbsp;18:04:25&nbsp;2008</span>
    <span class="description">AZED [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/520015/259623/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/259623">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 5.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If I understand correctly, all these complex tests that try to figure
&gt; out whether the output filter needs or needs not be applied are there 
&gt; only to avoid you printing the XML declaration. Which you don&#39;t need
&gt; if you&#39;re working in unicode. So I am a bit hesitant to go much 
&gt; further down that road for what I see as a not-so-compelling reason.
</div>
Oh, if you&#39;re only concerned about my personal problem, sure.  As long
as I can universally set :utf8 on my filehandles and stop thinking about
them, I&#39;d be perfectly happy.  I went to the trouble of trying to
improve your patch because after our previous conversation on the other
bug report I thought that _you_ would be very unhappy to discover that
what you had done changed the output between previous versions of
XML::Twig and your latest version.

I figured that the general goal here is to have XML::Twig with
&#34;output_encoding =&gt; utf-8&#34; produce the correct output whether or not it
is printing to a handle with the binmode layer set or not.  You appear
to be correct that there is no way to detect the presence of a binmode
layer -- but you *can* force it, with minimal side effects, so that&#39;s
what I did.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Unicode is tricky in regular Perl. If you print a string to a
&gt; filehandle that is not open as :utf8, then it will be converted to
&gt; latin-1 &#40;in order for older code to still work the same&#41;. Which is
&gt; what will happen here, whether the print is done by XML::Twig or by
&gt; a regular print. That&#39;s consistent.
</div>
You&#39;re aware that versions of XML::Twig prior to 20081014 *don&#39;t*
convert to latin-1 when printing to a filehandle without a :utf8 layer
set, right?  Previously, if you set output_encoding =&gt; utf-8, and then
printed to a filehandle with no output layer set, you got utf-8 output
&#40;you can see this by running the unit test I provided both against the
current version and any prior version, including the stable version --
the &#39;twig output via &#34;&gt;&#34;&#39; tests pass&#41;.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Bottom line, if you&#39;re working with utf8 and your filehandle is not
&gt; open as :utf-8, you are just asking for trouble.
</div>
Well, this is what I ordinarily would have thought, yes, but I&#39;m a
little surprised to hear you take that stance given your strong reaction
to breaking backwards-compatibility in my other bug report.  Proceeding
with the 20081014 code as is will break the output of every program
relying on output_encoding=&gt;utf-8 to generate utf-8 output when printing
to a filehandle with no layer.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In short, you should open all of your output files with a :utf8 layer,
&gt; and the code should work, and maybe drop the output_encoding option,
&gt; which was created to allow output in non-utf8, IIRC in the days
&gt; before 5.8, when encoding conversions weren&#39;t as easy as specifying
&gt; the encoding layer when opening the file. I might add something about
&gt; it, or even write a piece in the docs about how to handle encodings.
</div>
This is a perfectly fine solution by me, and in fact, it tends towards
the way that I would have been inclined to solve the problem, because it
seems like the Perl Way to handle things, and because
XML::Twig::Elt-&gt;print is looking like an increasingly sticky problem to
solve.  I&#39;ve already comment-tagged all of the spots in my current
project where Twig is printing to a filehandle just to make sure that I
didn&#39;t accidentally :utf8 them in the future, so it wouldn&#39;t take me at
all long to force them back to :utf8 and declare a dependency on Twig &gt;=
3.34, or whatnot, but again, I&#39;m a little surprised to hear you talking
this way given your dedication to not changing existing behaviour. 
Maybe I shouldn&#39;t be trying to talk you out of it, though, since it
would make my life much easier. :P

If you drop the output_encoding option entirely, however, please at
least replace it with &#39;encoding&#39; or some other way to have set_encoding
called automatically, so you can still request that XML declarations be
printed via a single new&#40;&#41;.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I will look at your patch, but it doesn&#39;t seem to take into account
&gt; the keep_encoding option, that keeps the original encoding of the
&gt; XML, and which is a feature that&#39;s &#40;still&#41; quite popular. So I have
&gt; to test it some more.
</div>
Hm, this is true of the commented-out XML::Twig::Elt-&gt;print changes. 
That&#39;s hard to fix, unless there&#39;s some way of finding out whether
keep_encoding was set on the twig containing the element from inside the
element.  It looks like you&#39;d have to have every element inherit the
keep_encoding attribute from its parent twig somehow.

The XML::Twig-&gt;print section, however, assumes that if someone set
output_encoding =&gt; utf-8 that they wouldn&#39;t also set keep_encoding and
vice versa &#40;the patch only triggers if output_encoding matches utf-8&#41;.

Are you expecting that someone would try to use both output_encoding =&gt;
utf-8 and keep_encoding =&gt; 1 at the same time?  I&#39;ve been playing around
with this a bit today across but I made an interesting discovery when I
went to update the patch to explicitly recognize keep_encoding: it
doesn&#39;t matter if my code triggers or not -- if you set both
output_encoding =&gt; utf-8 and keep_encoding =&gt; 1, data from another
codepage, set either via set_text or imported via an external file, the
text ends up not only utf-8 but *double-encoded* utf-8 even when the
output filehandle has no layer.  This holds all the way back to Twig
3.32.  If you were intending keep_encoding to continue to function with
output_encoding set, there&#39;s a deeper issue than what we&#39;ve been working
on.  Personally, I think it would not be unwarranted to croak &#40;or at
least carp a warning&#41; if someone set both of those options at the same
time during a new&#40;&#41;.

I&#39;m attaching the latest version of my patch, which makes explicit the
XML::Twig-&gt;print handling of keep_encoding, and adds a note about
keep_encoding to the commented-out addition in XML::Twig::Elt-&gt;print.

I&#39;m also attaching a new test file that explicitly tests for breakage
using keep_encoding =&gt; 1, and also has a TODO test covering when
keep_encoding =&gt; 1 and output_encoding = utf-8 are simultaneously set,
just as an informative reference.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/520015/259626/test_unicode_fh_v3.t">Download test_unicode_fh_v3.t</a><br />
<span class="downloadcontenttype">text/x-perl 5.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use utf8;

use Cwd qw&#40;chdir getcwd&#41;;
use File::Basename qw&#40;basename&#41;;
use Test::More tests =&gt; 18;
binmode&#40;Test::More-&gt;builder-&gt;failure_output,&#39;:utf8&#39;&#41;;
binmode&#40;Test::More-&gt;builder-&gt;todo_output,&#39;:utf8&#39;&#41;;
binmode STDOUT, &#34;:utf8&#34;;
binmode STDERR, &#34;:utf8&#34;;
BEGIN { use_ok&#40;&#39;XML::Twig&#39;&#41; };                                  # test 1
ok&#40; &#40;basename&#40;getcwd&#40;&#41;&#41; eq &#39;t&#39;&#41; || chdir&#40;&#39;t/&#39;&#41;,                 # test 2
    &#34;Working in &#39;t/&#34; &#41; or die;

my $twig = XML::Twig-&gt;new&#40;
    output_encoding =&gt; &#39;utf-8&#39;,
    pretty_print =&gt; &#39;record&#39;
&#41;;
my $cp1252file = &#39;test_unicode_fh-1252_input.xml&#39;;
my $latin1string = &#34;Gr\x{00FC}\x{00DF} Dich!&#34;;
my $u8string = &#34;Gr\x{00FC}\x{00DF} Dich!&#34;;
utf8::upgrade&#40;$u8string&#41;;
my $twigstring = &#34;&lt;greet&gt;&#34; . $u8string . &#34;&lt;/greet&gt;\n&#34;;
utf8::upgrade&#40;$twigstring&#41;;
utf8::upgrade&#40;$twigstring&#41;;

my $fh;
my @result;

$twig-&gt;parse&#40;$twigstring&#41;;
open&#40;$fh,&#34;&gt;:encoding&#40;utf8&#41;&#34;,&#39;twig-unicode-openencutf8.xml&#39;&#41; or die;
$twig-&gt;print&#40;\*$fh&#41;;
close&#40;$fh&#41; or die;
ok&#40;$twig-&gt;safe_parsefile&#40;&#39;twig-unicode-openencutf8.xml&#39;&#41;,       # test 3
   &#39;twig output via &#34;&gt;:encoding&#40;utf8&#41;&#34; is parseable&#39;&#41;;
is&#40;$twig-&gt;root-&gt;text,$u8string,                                 # test 4
   &#39;twig output via &#34;&gt;:encoding&#40;utf8&#41;&#34; is correct&#39;&#41;;

$twig-&gt;parse&#40;$twigstring&#41;;
open&#40;$fh,&#34;&gt;:utf8&#34;,&#39;twig-unicode-openutf8.xml&#39;&#41; or die;
$twig-&gt;print&#40;\*$fh&#41;;
close&#40;$fh&#41; or die;
ok&#40;$twig-&gt;safe_parsefile&#40;&#39;twig-unicode-openutf8.xml&#39;&#41;,          # test 5
   &#39;twig output via &#34;&gt;:utf8&#34; is parseable&#39;&#41;;
is&#40;$twig-&gt;root-&gt;text,$u8string,                                 # test 6
   &#39;twig output via &#34;&gt;:utf8&#34; is correct&#39;&#41;;

$twig-&gt;parse&#40;$twigstring&#41;;
open&#40;$fh,&#34;&gt;&#34;,&#39;twig-unicode-open.xml&#39;&#41; or die;
$twig-&gt;print&#40;\*$fh&#41;;
close&#40;$fh&#41; or die;
ok&#40;$twig-&gt;safe_parsefile&#40;&#39;twig-unicode-open.xml&#39;&#41;,              # test 7
   &#39;twig output via &#34;&gt;&#34; is parseable&#39;&#41;;
is&#40;$twig-&gt;root-&gt;text,$u8string,                                 # test 8
   &#39;twig output via &#34;&gt;&#34; is correct&#39;&#41;;

$twig-&gt;parse&#40;$twigstring&#41;;
open&#40;$fh,&#34;&gt;:encoding&#40;utf8&#41;&#34;,&#39;twigelt-unicode-openencutf8.xml&#39;&#41; or die;
print {*fh} $twig-&gt;prolog;
$twig-&gt;root-&gt;print&#40;\*$fh&#41;;
close&#40;$fh&#41; or die;
ok&#40;$twig-&gt;safe_parsefile&#40;&#39;twigelt-unicode-openencutf8.xml&#39;&#41;,    # test 9
   &#39;twigelt output via &#34;&gt;:encoding&#40;utf8&#41;&#34; is parseable&#39;&#41;;
is&#40;$twig-&gt;root-&gt;text,$u8string,                                 # test 10
   &#39;twigelt output via &#34;&gt;:encoding&#40;utf8&#41;&#34; is correct&#39;&#41;;

$twig-&gt;parse&#40;$twigstring&#41;;
open&#40;$fh,&#34;&gt;:utf8&#34;,&#39;twigelt-unicode-openutf8.xml&#39;&#41; or die;
print {*fh} $twig-&gt;prolog;
$twig-&gt;root-&gt;print&#40;\*$fh&#41;;
close&#40;$fh&#41; or die;
ok&#40;$twig-&gt;safe_parsefile&#40;&#39;twigelt-unicode-openutf8.xml&#39;&#41;,       # test 11
   &#39;twigelt output via &#34;&gt;:utf8&#34; is parseable&#39;&#41;;
is&#40;$twig-&gt;root-&gt;text,$u8string,                                 # test 12
   &#39;twigelt output via &#34;&gt;:utf8&#34; is correct&#39;&#41;;

TODO:
{
local $TODO = &#34;Fixing utf-8 output for XML::Twig::Elt-&gt;print breaks IO::Scalar tests&#34;;
$twig-&gt;parse&#40;$twigstring&#41;;
open&#40;$fh,&#34;&gt;&#34;,&#39;twigelt-unicode-open.xml&#39;&#41; or die;
print {*fh} $twig-&gt;prolog;
$twig-&gt;root-&gt;print&#40;\*$fh&#41;;
close&#40;$fh&#41; or die;
ok&#40;$twig-&gt;safe_parsefile&#40;&#39;twigelt-unicode-open.xml&#39;&#41;,           # test 13
   &#39;twigelt output via &#34;&gt;&#34; is parseable&#39;&#41;;
is&#40;$twig-&gt;root-&gt;text,$u8string,                                 # test 14
   &#39;twigelt output via &#34;&gt;&#34; is correct&#39;&#41;;
}


# Check for twig_keep_encoding not altering output on filehandles
# with no layer
$twig = XML::Twig-&gt;new&#40;keep_encoding =&gt; 1&#41;;
$twig-&gt;parse&#40;&#39;&lt;greet&gt;Hi!&lt;/greet&gt;&#39;&#41;;
$twig-&gt;root-&gt;set_text&#40;$latin1string&#41;;
open&#40;$fh,&#34;&gt;&#34;,&#39;twig-keepenc-open.xml&#39;&#41; or die;
$twig-&gt;print&#40;\*$fh&#41;;
close&#40;$fh&#41; or die;
open&#40;$fh,&#34;&lt;&#34;,&#39;twig-keepenc-open.xml&#39;&#41; or die;
{
    local $/;
    @result = &lt;$fh&gt;;
}
close&#40;$fh&#41; or die;
$result[0] =~ s/^\s+//;
chomp&#40;$result[0]&#41;;
is&#40;$result[0],&#34;&lt;greet&gt;&#34; . $latin1string . &#34;&lt;/greet&gt;&#34;,           # test 15
   &#39;twig &#40;keep_encoding&#41; output via &#34;&gt;&#34; is correct&#39;&#41;;
# Checking XML::Twig::Elt-&gt;print
open&#40;$fh,&#34;&gt;&#34;,&#39;twigelt-keepenc-open.xml&#39;&#41; or die;
$twig-&gt;root-&gt;print&#40;\*$fh&#41;;
close&#40;$fh&#41; or die;
open&#40;$fh,&#34;&lt;&#34;,&#39;twigelt-keepenc-open.xml&#39;&#41; or die;
{
    local $/;
    @result = &lt;$fh&gt;;
}
close&#40;$fh&#41; or die;
$result[0] =~ s/^\s+//;
chomp&#40;$result[0]&#41;;
is&#40;$result[0],&#34;&lt;greet&gt;&#34; . $latin1string . &#34;&lt;/greet&gt;&#34;,           # test 16
   &#39;twigelt &#40;keep_encoding&#41; output via &#34;&gt;&#34; is correct&#39;&#41;;


# Check for twig_keep_encoding not altering output on filehandles with
# no layer even if both keep_encoding and output_encoding are set
$twig = XML::Twig-&gt;new&#40;
    output_encoding =&gt; &#39;utf-8&#39;,
    keep_encoding =&gt; 1,
    &#41;;
$twig-&gt;parsefile&#40;$cp1252file&#41;;
open&#40;$fh,&#34;&gt;&#34;,&#39;twig-utf8keepenc-open.xml&#39;&#41; or die;
$twig-&gt;print&#40;\*$fh&#41;;
close&#40;$fh&#41; or die;
open&#40;$fh,&#34;&lt;&#34;,&#39;twig-utf8keepenc-open.xml&#39;&#41; or die;
{
    local $/;
    @result = &lt;$fh&gt;;
}
close&#40;$fh&#41; or die;
# Split XML declaration and element
# &#40;There&#39;s no way to ensure that XML::Twig outputs this in two lines?&#41;
$result[0] =~ /^ &#40;&lt;.*?&gt;&#41; \s* &#40;&lt;.*&gt;&#41; $/x;
$result[0] = $1;
$result[1] = $2;
is&#40;$result[0],&#39;&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;&#39;,         # test 17
   &#39;twig &#40;keep_encoding+utf8&#41; output via &#34;&gt;&#34; has utf-8 XML declaration&#39;&#41;;
TODO:
{
local $TODO = &#34;keep-encoding and output_encoding are mutually exclusive?&#34;;
is&#40;$result[1],&#34;&lt;greet&gt;&#34; . $u8string . &#34;&lt;/greet&gt;&#34;,               # test 18
   &#39;twig &#40;keep_encoding+utf8&#41; output via &#34;&gt;&#34; is correct&#39;&#41;;
}

unlink&#40;&#39;twig-unicode-openencutf8.xml&#39;&#41;;
unlink&#40;&#39;twig-unicode-openutf8.xml&#39;&#41;;
unlink&#40;&#39;twig-unicode-open.xml&#39;&#41;;
unlink&#40;&#39;twig-keepenc-open.xml&#39;&#41;;
unlink&#40;&#39;twig-utf8keepenc-open.xml&#39;&#41;;
unlink&#40;&#39;twigelt-unicode-openencutf8.xml&#39;&#41;;
unlink&#40;&#39;twigelt-unicode-openutf8.xml&#39;&#41;;
unlink&#40;&#39;twigelt-unicode-open.xml&#39;&#41;;
unlink&#40;&#39;twigelt-keepenc-open.xml&#39;&#41;;
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/520015/259629/test_unicode_fh-1252_input.xml">Download test_unicode_fh-1252_input.xml</a><br />
<span class="downloadcontenttype">text/xml 72b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;?xml version=&#34;1.0&#34; encoding=&#34;windows-1252&#34;?&gt;
&lt;greet&gt;GrÃ¼ÃŸ Dich!&lt;/greet&gt;
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/520015/259632/twig_slow-unicode_print_v3.patch">Download twig_slow-unicode_print_v3.patch</a><br />
<span class="downloadcontenttype">text/x-diff 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- XML-Twig-3.33/Twig_pm.slow	2008-10-14 06:45:01.000000000 -0400
+++ libxml-twig-perl-3.33~20081014/Twig_pm.slow	2008-10-15 17:47:36.000000000 -0400
@@ -2865,6 +2865,11 @@
 sub print
   { my $t= shift;
     my $fh=  _is_fh&#40; $_[0]&#41;  ? shift : undef;
+    if&#40; defined $fh
+        &#38;&#38; !$t-&gt;{twig_keep_encoding}
+        &#38;&#38; $t-&gt;{output_encoding}
+        &#38;&#38; &#40;$t-&gt;{output_encoding} =~ /^utf-8$/i&#41; &#41;
+      { binmode $fh,&#34;:utf8&#34;; }
     my %args= _normalize_args&#40; @_&#41;;
 
     my $old_select    = defined $fh                  ? select $fh                                 : undef;
@@ -7695,6 +7700,11 @@
   
       my $pretty;
       my $fh= _is_fh&#40; $_[0]&#41; ? shift : undef;
+# This maintains output consistency with older versions, but breaks
+# IO::Scalar tests, but that may be a bug in IO::Scalar
+# It also breaks keep_encoding =&gt; 1 output
+#      if&#40;defined $fh&#41; { binmode $fh,&#34;:utf8&#34; unless&#40;$output_filter&#41;; }
+
       my $old_select= defined $fh ? select $fh : undef;
       my $old_pretty= defined &#40;$pretty= shift&#41; ? set_pretty_print&#40; $pretty&#41; : undef;
       $pretty ||=0;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-567093" href="/Public/Bug/Display.html?id=39849#txn-567093">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;16&nbsp;18:51:48&nbsp;2009</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/567093/286278/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/286278">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 617b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Oct 15 04:31:33 2008, xmltwig@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ...
&gt; This can be done by opening the filehandle with in :utf8 mode. So you
&gt; have a way
&gt; to get the output you want. Beyond that, I am not sure what I can do,
&gt; especially
&gt; as there is no way that I know of to determine what the IO layer
&gt; applied to an
&gt; open filehandle is &#40;I might be wrong&#41;.
&gt; ...
</div>
Saw this thread by accident - I think this is what you are looking for:
<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~nwclark/perl-5.8.9/lib/PerlIO.pm#Querying_the_layers_of_filehandles">http://search.cpan.org/~nwclark/perl-5.8.9/lib/PerlIO.pm#Querying_the_layers_of_filehandles</a></span>

I myself used this before, but can&#39;t seem to find the code in question
right now.

Cheers
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 1.09445</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
