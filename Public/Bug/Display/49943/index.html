<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #49943 for CGI: Needs discussion: wish: PSGI support in CGI.pm</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #49943 for CGI: Needs discussion: wish: PSGI support in CGI.pm</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=CGI">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=CGI">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=CGI">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=CGI">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/leejo/CGI.pm/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/CGI">CGI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">49943</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=CGI">CGI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
MARKSTOS [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
miyagawa [...] bulknews.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-230860-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-230861-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=49943">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-667569" href="/Public/Bug/Display.html?id=49943#txn-667569">#</a>      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;23&nbsp;08:09:00&nbsp;2009</span>
    <span class="description">MARKSTOS [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> miyagawa [...] bulknews.net</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Needs discussion: wish: PSGI support in CGI.pm</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/667569/342885/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/342885">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Miyagawa has proposed that CGI.pm include direct support for the PSGI
specification. An initial implementation has already been completed and
is available in the &#39;pgsi_support&#39; branch of my repo:

<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/markstos/CGI.pm/commits/psgi_support">http://github.com/markstos/CGI.pm/commits/psgi_support</a></span>

I support the theory of the project, which ports WSGI to Perl, which
seems to have proven valuable in the Python and Ruby communities. This
post explains more:

<span class="clickylink"><a target="new" rel="nofollow" href="http://bulknews.typepad.com/blog/2009/09/psgi-perl-wsgi.html">http://bulknews.typepad.com/blog/2009/09/psgi-perl-wsgi.html</a></span>

Before this work is merged into the core, a few things need to happen:

1. We need to agree on the exact API
2. It needs to be tested and documented
3. Lincoln Stein needs to approve it. 

Here are my concerns regarding the API as it is proposed:

1. I&#39;m concerned that the CGI::PSGI module exists primarily to set a
variable: $CGI::PSGI. Directly setting the global or using a pragma
seems more consistent with existing features. 

2. I&#39;m concerned about adding *any* significant features to CGI.pm at
this point. However, there is no easy way to add this functionality
externally. 

Ideally, if this moves forward, it would be ideal to have a similar
update released to CGI::Simple at the same time. 

Next, I&#39;m interested in feedback from other CGI.pm users about the
proposed change
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-668525" href="/Public/Bug/Display.html?id=49943#txn-668525">#</a>      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;24&nbsp;21:05:21&nbsp;2009</span>
    <span class="description">yanick [...] babyl.dyndns.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #49943] Needs discussion: wish: PSGI support in CGI.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 24 Sep 2009 21:07:45 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI.pm [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Yanick Champoux &lt;yanick [...] babyl.dyndns.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/668525/343413/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/343413">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 734b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">MARKSTOS via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Miyagawa has proposed that CGI.pm include direct support for the PSGI
&gt; specification. [..]
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Next, I&#39;m interested in feedback from other CGI.pm users about the
&gt; proposed change
</div>

        I share Mark&#39;s caution about adding new functionality to CGI.  It&#39;s a 
module with a long history used by a lot of people, and in consequence 
we want to be extra-careful with any changes.  On the other hand, the 
modifications to support PSGI are fairly minimal, and shouldn&#39;t impact 
any of the current functionality of the module.

        In this specific case, I think my vote would go for including the PSGI 
support, but only after making sure the implemented API is sound, and 
after having tested it through and through.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-668526" href="/Public/Bug/Display.html?id=49943#txn-668526">#</a>      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;24&nbsp;21:05:23&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-668540" href="/Public/Bug/Display.html?id=49943#txn-668540">#</a>      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;24&nbsp;21:37:46&nbsp;2009</span>
    <span class="description">miyagawa [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #49943] Needs discussion: wish: PSGI support in  CGI.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 25 Sep 2009 10:37:29 +0900</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI.pm [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tatsuhiko Miyagawa &lt;miyagawa [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/668540/343425/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/343425">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 1. I&#39;m concerned that the CGI::PSGI module exists primarily to set a
&gt; variable: $CGI::PSGI. Directly setting the global or using a pragma
&gt; seems more consistent with existing features.
</div>
CGI::PSGI module is there to help ease the migration in web
frameworks, so &#34;use CGI::PSGI&#34; will fail if the installed CGI.pm
doesn&#39;t support PSGI.

The problem here is that current &#40;unpatched&#41; CGI.pm DOESN&#39;T fail when
called &#34;$CGI::PSGI = 1&#34; nor &#34;use CGI qw&#40;:psgi&#41;&#34; and silently doesn&#39;t
do anything useful re: PSGI variables. Making CGI::PSGI module just to
set the flag then makes sure that your application bails out if you
need PSGI support but when your CGI.pm doesn&#39;t support it.

Also, your frameworks can say &#34;requires &#39;CGI::PSGI&#39;&#34; in Makefile.PL,
instead of specifying the CGI.pm version number.

the API&#39;s awkwardness is something separate worth discussing. I wanted to say

  use CGI::PSGI;
  my $q = CGI::PSGI-&gt;new&#40;$env&#41;;
  my&#40;$status, $headers&#41; = $q-&gt;headers&#40;$content_type&#41;;

without touching CGI.pm at all, but it was really hard since CGI.pm
directly manipulates %ENV and there are so many methods to clone.
&#40;That means it&#39;s not technically impossible, so we still keep that as
an option if a direct PSGI support is unapproved&#41;.

Thanks,
-- 
Tatsuhiko Miyagawa
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-668563" href="/Public/Bug/Display.html?id=49943#txn-668563">#</a>      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;24&nbsp;22:10:07&nbsp;2009</span>
    <span class="description">miyagawa [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #49943] Needs discussion: wish: PSGI support in  CGI.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 25 Sep 2009 11:09:47 +0900</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI.pm [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tatsuhiko Miyagawa &lt;miyagawa [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/668563/343436/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/343436">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 657b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Sep 25, 2009 at 10:37 AM, miyagawa@gmail.com via RT
&lt;bug-CGI.pm@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The problem here is that current &#40;unpatched&#41; CGI.pm DOESN&#39;T fail when
&gt; called &#34;$CGI::PSGI = 1&#34; nor &#34;use CGI qw&#40;:psgi&#41;&#34; and silently doesn&#39;t
&gt; do anything useful re: PSGI variables. Making CGI::PSGI module just to
&gt; set the flag then makes sure that your application bails out if you
&gt; need PSGI support but when your CGI.pm doesn&#39;t support it.
</div>
The other approach for this would be to let app developers to say:

  use CGI qw&#40;:psgi&#41;; # this would set $CGI::PSGI to 1
  die &#34;Your CGI.pm doesn&#39;t support PSGI!&#34; unless defined $CGI::PSGI;


-- 
Tatsuhiko Miyagawa
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-668574" href="/Public/Bug/Display.html?id=49943#txn-668574">#</a>      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;24&nbsp;22:16:46&nbsp;2009</span>
    <span class="description">miyagawa [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> MARKSTOS [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #49943] Needs discussion: wish: PSGI support in  CGI.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 25 Sep 2009 11:16:26 +0900</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI.pm [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tatsuhiko Miyagawa &lt;miyagawa [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/668574/343443/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/343443">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Sep 25, 2009 at 10:37 AM, miyagawa@gmail.com via RT
&lt;bug-CGI.pm@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Â use CGI::PSGI;
&gt; Â my $q = CGI::PSGI-&gt;new&#40;$env&#41;;
&gt; Â my&#40;$status, $headers&#41; = $q-&gt;headers&#40;$content_type&#41;;
&gt;
&gt; without touching CGI.pm at all, but it was really hard since CGI.pm
&gt; directly manipulates %ENV and there are so many methods to clone.
&gt; &#40;That means it&#39;s not technically impossible, so we still keep that as
&gt; an option if a direct PSGI support is unapproved&#41;.
</div>
The actual implementation for that would be:

1&#41; in CGI::PSGI::new, save the current %ENV somewhere and populate
%ENV with PSGI&#39;s $env
2&#41; Override methods that reads from STDIN, like read_from_stdin and
read_from_client to read from $env-&gt;{&#39;psgi.input&#39;}
3&#41; Override header&#40;&#41; method, or implement a different named method
&#40;like psgi_header&#41; to return $status and $headers_ref
4&#41; in DESTROY, restore the saved %ENV, and call CGI::initialize_globals&#40;&#41;

I *think* this can be done without touching CGI.pm at all, but a&#41; a
fair amount of code may need to be duplicated b&#41; I&#39;m not really sure
that&#39;s &#34;thread-safe&#34; &#40;or event-loop safe&#41;.

If you run multiple PSGI apps in parallel, in our case with
AnyEvent/Danga::Socket based event-loop server or with Coro server and
if the app does streaming output &#40;rather than direct response&#41;, global
resetting and sharing of %ENV might cause issues. &#40;Well, actually this
might be problematic with the current patch as well though: local *ENV
= $env gets reset when it goes out of scope -- same problem&#41;.

-- 
Tatsuhiko Miyagawa
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-668598" href="/Public/Bug/Display.html?id=49943#txn-668598">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;25&nbsp;00:24:41&nbsp;2009</span>
    <span class="description">miyagawa [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> MARKSTOS [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #49943] Needs discussion: wish: PSGI support in  CGI.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 25 Sep 2009 13:24:23 +0900</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI.pm [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tatsuhiko Miyagawa &lt;miyagawa [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/668598/343455/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/343455">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Sep 25, 2009 at 11:16 AM, Tatsuhiko Miyagawa &lt;miyagawa@gmail.com&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The actual implementation for that would be:
&gt;
&gt; 1&#41; in CGI::PSGI::new, save the current %ENV somewhere and populate
&gt; %ENV with PSGI&#39;s $env
&gt; 2&#41; Override methods that reads from STDIN, like read_from_stdin and
&gt; read_from_client to read from $env-&gt;{&#39;psgi.input&#39;}
&gt; 3&#41; Override header&#40;&#41; method, or implement a different named method
&gt; &#40;like psgi_header&#41; to return $status and $headers_ref
&gt; 4&#41; in DESTROY, restore the saved %ENV, and call CGI::initialize_globals&#40;&#41;
</div>
Okay, I&#39;ve done this:
<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/miyagawa/CGI-PSGI">http://github.com/miyagawa/CGI-PSGI</a></span>

The implemenation is slightly modified, so PSGI $env is stored in the
object and set to local *ENV whenever a method that touches %ENV is
called. This might have a slight performance impact but I don&#39;t think
it&#39;s really a problem.

I also left $q-&gt;header as it was, and added a new $q-&gt;psgi_header
method instead. This is not a big deal since app developers need to
change wherever $q-&gt;header was called to do print&#40;&#41;.

The benefit of new implementation is, as stated in README and POD,
that it doesn&#39;t require CGI.pm patched to support PSGI natively.

Mark, let&#39;s remove CGI::PSGI from CGI.pm main repo as you suggested
and use $CGI::PSGI variable&#39;s defined-ness to see if CGI.pm supports
PSGI or not.

I think I can ship this CGI::PSGI to CPAN, and then CGI.pm can
individually support PSGI with $CGI::PSGI or use CGI qw&#40;:psgi&#41;; and
both can live on CPAN: application users can chose whichever they want
to.

a&#41; If they don&#39;t want to upgrade CGI.pm and are fine with changing
their code, use CGI::PSGI
b&#41; If they don&#39;t want to change their CGI.pm based code, then upgrade
CGI.pm that fully supports PSGI

By &#34;fully supports PSGI&#34; the current CGI.pm &#40;my patch&#41; is not complete
since it only does the read side. The app should still update their
code to do return [ $q-&gt;header, [ $body ] ] instead of print
$q-&gt;header, $body; To enable that you need to tie STDOUT, which
actually CGI::Emulate::PSGI generally solves, in which case CGI.pm
doesn&#39;t really need to be patched.

Hmm ... ;&#41;




-- 
Tatsuhiko Miyagawa
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1173050" href="/Public/Bug/Display.html?id=49943#txn-1173050">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;22&nbsp;21:16:02&nbsp;2013</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> miyagawa [...] bulknews.net</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1173050/618649/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/618649">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 58b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m not sure there&#39;s anything else to do here. Resolving. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1173055" href="/Public/Bug/Display.html?id=49943#txn-1173055">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;22&nbsp;21:16:04&nbsp;2013</span>
    <span class="description">MARKSTOS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1367241" href="/Public/Bug/Display.html?id=49943#txn-1367241">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;May&nbsp;23&nbsp;14:29:34&nbsp;2014</span>
    <span class="description">The RT System itself -  Queue changed from CGI.pm to CGI</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.53479</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
