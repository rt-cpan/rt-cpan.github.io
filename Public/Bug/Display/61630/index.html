<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #61630 for DBD-ODBC: Invalid precision value &#40;SQL-HY104&#41; error on inserts</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #61630 for DBD-ODBC: Invalid precision value &#40;SQL-HY104&#41; error on inserts</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-ODBC/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-ODBC/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-ODBC/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-ODBC/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-ODBC">DBD-ODBC CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">61630</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-ODBC/Active/">DBD-ODBC</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mertap [...] upcmail.cz

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10188-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10189-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.26_1    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;25&nbsp;13:32:07&nbsp;2010</span>
    <span class="description">mertap [...] upcmail.cz -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Invalid precision value &#40;SQL-HY104&#41; error on inserts</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 25 Sep 2010 19:31:49 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-ODBC [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Petr Merta &lt;mertap [...] upcmail.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,


I&#39;d like to report what I believe is a bug in DBD::ODBC code, causing HY104 
errors on varchar INSERTs when running against Microsoft SQL server.

Working demo code is given as attachment, changing the connection string 
should be enough for making it run.

The bug appeared when running on Windows &#40;2k3, vista, win7&#41;, with various perl 
distributions and versions &#40;Strawberry Perl both 32/64bit, ActivePerl, 
Cygwin&#41;. DBD::ODBC version primarily tested was 1.25, but the bug showed up 
also in 1.24 and 1.21.

As for database environment, the bug seems rather independent of version of 
database server and client connectivity drivers. The sample code was tested 
against MS SQL Server 2K, 2k5, 2k8 and 2k8r2, with client drivers ranging 
from default win2k SQL server drivers to SQL Server Native Client 10.

Interesting enough, the code works as expected when run on rather antique 
cygwin installation &#40;1.5.25, perl 5.10.0, dbi 1.607, dbd::odbc 1.18&#41;.

&#40;complete detailed info on tested versions is also given in comments in the 
end of the sample code&#41;

There are two INSERTs in demo code. The first one is plain INSERT into one of 
the tables; it succeeds. The second INSERT is combined with SELECT from the 
other table, and this is the one which fails with HY104.

Should you need any further information, please let me know.


Regards,
-- 
Petr Merta, mertap@upcmail.cz
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;25&nbsp;17:11:08&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Sep 25 13:32:07 2010, mertap@upcmail.cz wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; 
&gt; I&#39;d like to report what I believe is a bug in DBD::ODBC code, causing
&gt; HY104
&gt; errors on varchar INSERTs when running against Microsoft SQL server.
&gt; 
&gt; Working demo code is given as attachment, changing the connection
&gt; string
&gt; should be enough for making it run.
&gt; 
&gt; The bug appeared when running on Windows &#40;2k3, vista, win7&#41;, with
&gt; various perl
&gt; distributions and versions &#40;Strawberry Perl both 32/64bit, ActivePerl,
&gt; Cygwin&#41;. DBD::ODBC version primarily tested was 1.25, but the bug
&gt; showed up
&gt; also in 1.24 and 1.21.
&gt; 
&gt; As for database environment, the bug seems rather independent of
&gt; version of
&gt; database server and client connectivity drivers. The sample code was
&gt; tested
&gt; against MS SQL Server 2K, 2k5, 2k8 and 2k8r2, with client drivers
&gt; ranging
&gt; from default win2k SQL server drivers to SQL Server Native Client 10.
&gt; 
&gt; Interesting enough, the code works as expected when run on rather
&gt; antique
&gt; cygwin installation &#40;1.5.25, perl 5.10.0, dbi 1.607, dbd::odbc 1.18&#41;.
&gt; 
&gt; &#40;complete detailed info on tested versions is also given in comments
&gt; in the
&gt; end of the sample code&#41;
&gt; 
&gt; There are two INSERTs in demo code. The first one is plain INSERT into
&gt; one of
&gt; the tables; it succeeds. The second INSERT is combined with SELECT
&gt; from the
&gt; other table, and this is the one which fails with HY104.
&gt; 
&gt; Should you need any further information, please let me know.
&gt; 
&gt; 
&gt; Regards,
</div>
Hi,

I&#39;ve not tried your code yet but I will get around to it.

I suspect you&#39;ll find that the MS SQL Server ODBC driver is attempting
to rearrange your SQL in order to find out what the parameters are and
failing to come up with the right SQL. You can probably see this if you
enough about SQL Server and can monitor the SQL being executed or you
can set DBI_TRACE=15=x.log in your environment and rerun your script
then examine the x.log file to see if SQLDescribeParam is failing. Try
splitting the failing do into a prepare, bind_param and execute and
setting the TYPE of each bound parameter to SQL_VARCHAR. See the
DBD::ODBC FAQ for examples
&#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~mjevans/DBD-ODBC-1.25/FAQ#Why_do_I_get_errors_with_bound_parameters_and_MS_SQL_Server?&#41;">http://search.cpan.org/~mjevans/DBD-ODBC-1.25/FAQ#Why_do_I_get_errors_with_bound_parameters_and_MS_SQL_Server?&#41;</a></span>.

I will look at this in more detail but in the mean time you can help
yourself and me by trying my suggestion and providing a log.

Thanks.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;25&nbsp;17:11:08&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;26&nbsp;02:59:03&nbsp;2010</span>
    <span class="description">mertap [...] upcmail.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #61630] Invalid precision value &#40;SQL-HY104&#41; error on inserts</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 26 Sep 2010 08:58:49 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-ODBC [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Petr Merta &lt;mertap [...] upcmail.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Saturday 25 September 2010 23:11:08 Martin J Evans via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt;
&gt; I&#39;ve not tried your code yet but I will get around to it.
&gt;
&gt; I suspect you&#39;ll find that the MS SQL Server ODBC driver is attempting
&gt; to rearrange your SQL in order to find out what the parameters are and
&gt; failing to come up with the right SQL. You can probably see this if you
&gt; enough about SQL Server and can monitor the SQL being executed or you
&gt; can set DBI_TRACE=15=x.log in your environment and rerun your script
&gt; then examine the x.log file to see if SQLDescribeParam is failing. Try
&gt; splitting the failing do into a prepare, bind_param and execute and
&gt; setting the TYPE of each bound parameter to SQL_VARCHAR. See the
&gt; DBD::ODBC FAQ for examples
&gt; &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~mjevans/DBD-ODBC-1.25/FAQ#Why_do_I_get_errors_with">http://search.cpan.org/~mjevans/DBD-ODBC-1.25/FAQ#Why_do_I_get_errors_with</a></span>
&gt;_bound_parameters_and_MS_SQL_Server?&#41;.
&gt;
&gt; I will look at this in more detail but in the mean time you can help
&gt; yourself and me by trying my suggestion and providing a log.
</div>
Martin,

first I have to apologize I was not more careful when looking for bug 
cause/solution; I&#39;ve relied on google little too much for this one :-&#41;

Your suggestion with splitting the code to prep-bind-exec works like a charm. 
As for me, I&#39;m quite happy with this solution, I suppose it won&#39;t be a 
problem to handle failing statements this way. So please consider the urgency 
of my report rather low.

There are logs attached gathered with single do&#40;&#41; call and another one 
gathered with splitted command. It really looks like SQLDescribeParam is not 
able to handle long varchars.

Thanks for your time, I really appreciate your help.

-- 
Petr Merta, mertap@upcmail.cz
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;27&nbsp;09:09:05&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Sep 26 02:59:03 2010, mertap@upcmail.cz wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Saturday 25 September 2010 23:11:08 Martin J Evans via RT wrote:
<div class="message-stanza open">&gt; &gt; Hi,
&gt; &gt;
&gt; &gt; I&#39;ve not tried your code yet but I will get around to it.
&gt; &gt;
&gt; &gt; I suspect you&#39;ll find that the MS SQL Server ODBC driver is
</div>&gt; attempting
<div class="message-stanza open">&gt; &gt; to rearrange your SQL in order to find out what the parameters are
</div>&gt; and
<div class="message-stanza open">&gt; &gt; failing to come up with the right SQL. You can probably see this if
</div>&gt; you
<div class="message-stanza open">&gt; &gt; enough about SQL Server and can monitor the SQL being executed or
</div>&gt; you
<div class="message-stanza open">&gt; &gt; can set DBI_TRACE=15=x.log in your environment and rerun your script
&gt; &gt; then examine the x.log file to see if SQLDescribeParam is failing.
</div>&gt; Try
<div class="message-stanza open">&gt; &gt; splitting the failing do into a prepare, bind_param and execute and
&gt; &gt; setting the TYPE of each bound parameter to SQL_VARCHAR. See the
&gt; &gt; DBD::ODBC FAQ for examples
&gt; &gt; &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~mjevans/DBD-ODBC-">http://search.cpan.org/~mjevans/DBD-ODBC-</a></span>
</div>&gt; 1.25/FAQ#Why_do_I_get_errors_with
<div class="message-stanza open">&gt; &gt;_bound_parameters_and_MS_SQL_Server?&#41;.
&gt; &gt;
&gt; &gt; I will look at this in more detail but in the mean time you can help
&gt; &gt; yourself and me by trying my suggestion and providing a log.
</div>&gt; 
&gt; Martin,
&gt; 
&gt; first I have to apologize I was not more careful when looking for bug
&gt; cause/solution; I&#39;ve relied on google little too much for this one :-&#41;
</div>
Not a problem.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Your suggestion with splitting the code to prep-bind-exec works like a
&gt; charm.
</div>
:-&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; As for me, I&#39;m quite happy with this solution, I suppose it won&#39;t be a
&gt; problem to handle failing statements this way. So please consider the
&gt; urgency
&gt; of my report rather low.
</div>
I would but I don&#39;t like rts hanging around.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; There are logs attached gathered with single do&#40;&#41; call and another one
&gt; gathered with splitted command. It really looks like SQLDescribeParam
&gt; is not
&gt; able to handle long varchars.
</div>
Your log shows:

 SQLDescribeParam failed reverting to default SQL bind type -9
07009 [Microsoft][ODBC SQL Server Driver]Invalid Descriptor Index
42000 [Microsoft][ODBC SQL Server Driver]Syntax error or access violation

It is nothing to do with long varchars it is your SQL which is breaking
the ODBC driver.

    SQLPrepare   INSERT INTO EventLog &#40;ComputerIDC, EventMessage&#41;
                    SELECT cs.ComputerIDC, ?
                    FROM ComputerSlice AS cs
                    WHERE cs.ComputerSliceID = ?

In order for the SQL Server ODBC driver to work out what the 2
parameters are it attempts to rearrange your SQL into a select for the
parameter columns from a table e.g.,

select a_col from mytable where b_col = ?

SQL Server rearranges it into &#34;select b_col from mytable&#34; and hence
finds out what column b_col is.

In your SQL one of the parameters is a string not related to a column so
SQLDescribeParam fails and DBD::ODBC has no choice to assume a default
&#40;it chose SQL_WCHAR&#41;. Then you tried to pass input parameter data of
4002 chrs which is too big for an SQL_WCHAR and hence the HY104 invalid
precision error.

So, although I see why this failed I am slightly surprised DBD::ODBC did
not default the parameter type to SQL_WLONGVARCHAR when it saw the
parameter was &gt; 4000 bytes. I will look into this as it may mean you can
go back to how you had it although the SQLDescribeParam will have to be
called and fail - so slightly more work than specifying a bind type.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks for your time, I really appreciate your help.
</div>
No problem.

I&#39;ll try and get back to you soon.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;27&nbsp;10:14:24&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Sep 27 09:09:05 2010, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So, although I see why this failed I am slightly surprised DBD::ODBC did
&gt; not default the parameter type to SQL_WLONGVARCHAR when it saw the
&gt; parameter was &gt; 4000 bytes. I will look into this as it may mean you can
&gt; go back to how you had it although the SQLDescribeParam will have to be
&gt; called and fail - so slightly more work than specifying a bind type.
</div>
ok, I see why this happens now. When SQLDescribeParam fails DBD::ODBC
picks either SQL_WCHAR or SQL_WLONGVARCHAR to fall back on. If the
parameter is &gt; 4000 bytes it uses the latter so in your case it used
SQL_WCHAR. However, in your case the parameter is 2001 bytes but will be
converted to wide characters hence doubling the length to 4002. A
varchar should be able to hold 4000 characters not bytes so yet another
issue in SQL Server.

You kind of had it nailed yourself with this comment in your code:

# THIS IS IT; &#34;X&#34; x 2000 works ok, x 2001 will fail; however, value goes
to column VARCHAR&#40;8000&#41;

The SQL Server ODBC driver appears broken as 2001 characters should fit
into a VARCHAR&#40;8000&#41; especially when they are all &#39;X&#39;. I could sort of
understood it if it was a varchar&#40;4000&#41;.

I am however, going to change DBD::ODBC to switch to longvarchar at 2000
bytes instead of 4000.

I hope you&#39;ll be happy with me writing this issue off now.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;28&nbsp;04:23:05&nbsp;2010</span>
    <span class="description">mertap [...] upcmail.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #61630] Invalid precision value &#40;SQL-HY104&#41; error on inserts</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 28 Sep 2010 10:22:50 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-ODBC [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Petr Merta &lt;mertap [...] upcmail.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Monday 27 September 2010 16:14:26 Martin J Evans via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ok, I see why this happens now. When SQLDescribeParam fails DBD::ODBC
&gt; picks either SQL_WCHAR or SQL_WLONGVARCHAR to fall back on. If the
&gt; parameter is &gt; 4000 bytes it uses the latter so in your case it used
&gt; SQL_WCHAR. However, in your case the parameter is 2001 bytes but will be
&gt; converted to wide characters hence doubling the length to 4002. A
&gt; varchar should be able to hold 4000 characters not bytes so yet another
&gt; issue in SQL Server.
&gt;
&gt; You kind of had it nailed yourself with this comment in your code:
&gt;
&gt; # THIS IS IT; &#34;X&#34; x 2000 works ok, x 2001 will fail; however, value goes
&gt; to column VARCHAR&#40;8000&#41;
&gt;
&gt; The SQL Server ODBC driver appears broken as 2001 characters should fit
&gt; into a VARCHAR&#40;8000&#41; especially when they are all &#39;X&#39;. I could sort of
&gt; understood it if it was a varchar&#40;4000&#41;.
</div>
well, you&#39;re right. I never consider possibility that this &#34;2000&#34; is almost 
completely unrelated to column size; now when I&#39;ve checked it I could see it 
fails on the same boundary for varchar&#40;7000&#41; too. I simply thought there has 
to be some magic in the process causing strings grow four times bigger. Hm, I 
probably should have warned you: I&#39;m merely a user, most of that things going 
under the hood is greek to me :-&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I am however, going to change DBD::ODBC to switch to longvarchar at 2000
&gt; bytes instead of 4000.
</div>
ok

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; I hope you&#39;ll be happy with me writing this issue off now.
</div>
of course.
You did a nice piece of work here. Thanks again, and good luck with future 
development.

Petr
-- 
Petr Merta, mertap@upcmail.cz
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;26&nbsp;09:28:09&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Fixed in 1.26_1 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;26&nbsp;09:28:23&nbsp;2010</span>
    <span class="description">bohica [...] ntlworld.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
