<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #2759 for MIME-Lite: send&#40;&#41; doesn&#39;t set sender with send_by_sendmail&#40;&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #2759 for MIME-Lite: send&#40;&#41; doesn&#39;t set sender with send_by_sendmail&#40;&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/MIME-Lite/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/MIME-Lite/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/MIME-Lite/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/MIME-Lite/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/MIME-Lite">MIME-Lite CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">2759</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/MIME-Lite/Active/">MIME-Lite</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dom [...] semantico.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
MSCHOUT [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-21346-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
3.01    </td>
  </tr>
  <tr id="CF-21347-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




0001-send_by_sendmail-set-sender-by-default-as-documen.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/633640/322832/0001-send_by_sendmail-set-sender-by-default-as-documen.patch">
Wed Jul 15 23:32:19 2009 (1.6k) by MSCHOUT [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;09&nbsp;06:03:23&nbsp;2003</span>
    <span class="description">semantico [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> send&#40;&#41; doesn&#39;t set sender with send_by_sendmail&#40;&#41;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve just noticed that send&#40;&#41; calls send_by_sendmail&#40;&#39;/usr/sbin/sendmail -t -oi -oem&#39;&#41;.  Nothing wrong with that, except that it defeats the SetSender logic in send_by_sendmail&#40;&#41;, so all my emails are coming out as from nobody...

For the moment, I&#39;ve switched to explicity call send_by_sendmail&#40;&#41; instead of send&#40;&#41;, but it would be useful to have send&#40;&#41; call send_by_sendmail&#40;&#41; in such a fashion that it&#39;s able to do the SetSender stuff.

Thanks,
-Dom
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;09&nbsp;06:15:07&nbsp;2003</span>
    <span class="description">eryq [...] zeegee.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 9 Jun 2003 10:15:02 UT</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-Lite [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Refused: [cpan #2759] send&#40;&#41; doesn&#39;t set sender with send_by_sendmail&#40;&#41; </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &lt;nobody [...] fsck.com&gt;, &#34; via RT&#34; &lt;bug-MIME-Lite [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> eryq [...] zeegee.com</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry, but my spam filter doesn&#39;t recognize you,
so your message is being deleted and returned. 

If you are trying to get in touch with me, please 
forward this letter back, and give it the special
subject line of:

white rabbit

This will guarantee that I receive your message, and
I may choose to add you to my whitelist.  Or not.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/82293/9646/">Download &#40;untitled&#41;</a><br />
<span class="downloadcontenttype">message/rfc822 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Return-Path: &lt;nobody@fsck.com&gt;
Received: from mr01.mrf.mail.rcn.net &#40;207.172.4.20 [207.172.4.20]&#41;
        by ms02.mrf.mail.rcn.net &#40;Mirapoint Messaging Server MOS 3.2.2-GA FastPath&#41;
        with ESMTP id CHQ76277;
        Mon, 09 Jun 2003 06:03:40 -0400 &#40;EDT&#41;
Received: from virtual.mrf.mail.rcn.net &#40;virtual.mrf.mail.rcn.net [207.172.4.103]&#41;
        by mr01.mrf.mail.rcn.net &#40;Mirapoint Messaging Server MOS 3.2.2-GA&#41;
        with ESMTP id CPR14508;
        Mon, 9 Jun 2003 06:03:38 -0400 &#40;EDT&#41;
Received: from one.develooper.com &#40;[64.81.84.115] helo=ran-out.mx.develooper.com&#41;
        by virtual.mrf.mail.rcn.net with smtp &#40;Exim 3.35 #4&#41;
        id 19PJV4-0006uC-00
        for eryq@zeegee.com; Mon, 09 Jun 2003 06:03:38 -0400
Received: &#40;qmail 24996 invoked by uid 225&#41;; 9 Jun 2003 10:03:34 -0000
Delivered-To: ERYQ@cpan.org
Received: &#40;qmail 24991 invoked by uid 507&#41;; 9 Jun 2003 10:03:34 -0000
Received: from pallas.eruditorum.org &#40;HELO pallas.eruditorum.org&#41; &#40;63.251.136.85&#41; by one.develooper.com &#40;qpsmtpd/0.26-dev&#41; with SMTP; Mon, 09 Jun 2003 03:03:30 -0700
Received: by pallas.eruditorum.org &#40;Postfix, from userid 65534&#41; id 65A62111EE; Mon,  9 Jun 2003 06:03:24 -0400 &#40;EDT&#41;
Subject: [cpan #2759] send&#40;&#41; doesn&#39;t set sender with send_by_sendmail&#40;&#41; 
From: &#34; via RT&#34; &lt;bug-MIME-Lite@rt.cpan.org&gt;
Reply-To: bug-MIME-Lite@rt.cpan.org
In-Reply-To: &lt;rt-2759@cpan&gt;
Message-ID: &lt;rt-2759-7846.2.02204527172945@cpan.org&gt;
Precedence: bulk
X-RT-Loop-Prevention: cpan
RT-Ticket: cpan #2759
Managed-by: RT 2.0.15 &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://bestpractical.com/rt/&#41;">http://bestpractical.com/rt/&#41;</a></span>
RT-Originator: SEMANTICO@cpan.org
To: &#34;AdminCc of cpan Ticket #2759&#34;: ;
Date: Mon,  9 Jun 2003 06:03:24 -0400 &#40;EDT&#41;
X-SMTPD: qpsmtpd/0.26-dev, <span class="clickylink"><a target="new" rel="nofollow" href="http://develooper.com/code/qpsmtpd/">http://develooper.com/code/qpsmtpd/</a></span>
X-Spam-Check-By: one.develooper.com
X-Spam-Status: No, hits=2.1 required=7.0 tests=CARRIAGE_RETURNS,IN_REP_TO,SPAM_PHRASE_01_02,SUPERLONG_LINE,TO_HAS_SPACES,TO_MALFORMED version=2.44


This message about MIME-Lite was sent to you by SEMANTICO &lt;SEMANTICO@cpan.org&gt; via rt.cpan.org

Full context and any attached attachments can be found at:
&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=2759">https://rt.cpan.org/Ticket/Display.html?id=2759</a></span> &gt;

I&#39;ve just noticed that send&#40;&#41; calls send_by_sendmail&#40;&#39;/usr/sbin/sendmail -t -oi -oem&#39;&#41;.  Nothing wrong with that, except that it defeats the SetSender logic in send_by_sendmail&#40;&#41;, so all my emails are coming out as from nobody...

For the moment, I&#39;ve switched to explicity call send_by_sendmail&#40;&#41; instead of send&#40;&#41;, but it would be useful to have send&#40;&#41; call send_by_sendmail&#40;&#41; in such a fashion that it&#39;s able to do the SetSender stuff.

Thanks,
-Dom
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;21&nbsp;19:17:45&nbsp;2003</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> demerphq [...] hotmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[SEMANTICO - Mon Jun  9 06:03:23 2003]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve just noticed that send&#40;&#41; calls
&gt;    send_by_sendmail&#40;&#39;/usr/sbin/sendmail -t -oi -oem&#39;&#41;.  Nothing wrong
&gt;    with that, except that it defeats the SetSender logic in
&gt;    send_by_sendmail&#40;&#41;, so all my emails are coming out as from
&gt;    nobody...
&gt; 
&gt; For the moment, I&#39;ve switched to explicity call send_by_sendmail&#40;&#41;
&gt;    instead of send&#40;&#41;, but it would be useful to have send&#40;&#41; call
&gt;    send_by_sendmail&#40;&#41; in such a fashion that it&#39;s able to do the
&gt;    SetSender stuff.
</div>
Hi, 

Sorry for the delay in getting to this, Ive been very busy.  However I 
have to say that im a touch at a loss to understand exactly what is 
going wrong here.  Can you provide me with a code snippet that causes 
the problem you mean so i can trace it through?

Are you sure this wasnt a bug on your behalf? I dont see how it ends up 
using the command you describe if you have already set the From using 
send earlier. Ie, if you called 

MIME::Lite-&gt;send&#40;&#39;sendmail&#39;,FromSender =&gt; &#39;me@myhost.com&#39;&#41;;

and then later 

$msg-&gt;send&#40;&#41;;

then it should be the same as calling

$msg-&gt;send_by_sendmail&#40;FromSender =&gt; &#39;me@myhost.com&#39;&#41;;

But I have to admit I dont have sendmail handy to test against, and as 
such without a code snippet that causes the error to work from its 
difficult for me to fix this.

Cheers,
Yves
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;11&nbsp;12:00:38&nbsp;2006</span>
    <span class="description">OPIATE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is copied from a debian bug report that I opened. As a result, some
of the line numbers below may not match the source package, but they
should be close enough that it doesn&#39;t matter.

From the documentation:

-- begin --

SetSender

Unless this is explicitly given as false, we attempt to automatically
set the -f argument to the first address that can be extracted from
the &#34;From:&#34; field of the message &#40;if there is one&#41;.

What is the -f, and why do we use it?
Suppose we did not use -f, and you gave an explicit &#34;From:&#34; field in
your message: in this case, the sendmail &#34;envelope&#34; would indicate the
real user your process was running under, as a way of preventing mail
forgery.  Using the -f switch causes the sender to be set in the
envelope as well.

-- end --

A simple test case:

root@test:~# cat test.pl
#!/usr/bin/perl -w

use strict;
use MIME::Lite;

my $msg = MIME::Lite-&gt;new&#40;
             From     =&gt;&#39;foo@hrsmart.com&#39;,
             To       =&gt;&#39;sallen@hrsmart.com&#39;,
             Subject  =&gt;&#39;Helloooooo, nurse!&#39;,
             Data     =&gt;&#34;How&#39;s it goin&#39;, eh?&#34;
             &#41;;
$msg-&gt;send&#40;&#41;;

root@test:~# perl test.pl
root@test:~# tail -3 /var/log/exim/mainlog
2006-09-11 10:30:04 1GMnjX-0007Br-00 &lt;= root@hrsmart.com U=root P=local
S=507
2006-09-11 10:30:04 1GMnjX-0007Br-00 =&gt; sallen@hrsmart.com R=lookuphost
T=remote_smtp H=mail.hrsmart.com [xx.xx.xx.xx]
2006-09-11 10:30:04 1GMnjX-0007Br-00 Completed

Here&#39;s the resulting message source:

X-Real-To: sallen@hrsmart.com
Return-Path: &lt;root@hrsmart.com&gt;
Received: from test.hrsmart.com &#40;[xx.xx.xx.xx] verified&#41;
  by franklin.hrsmart.com &#40;SMTP&#41;
  with ESMTP id 2191773 for sallen@hrsmart.com; Mon, 11 Sep 2006
10:30:20 -0500
Received: from root by test.hrsmart.com with local &#40;Exim 3.36 #1 &#40;Debian&#41;&#41;
        id 1GMnjX-0007Br-00
        for &lt;sallen@hrsmart.com&gt;; Mon, 11 Sep 2006 10:30:03 -0500
Content-Disposition: inline
Content-Length: 19
Content-Transfer-Encoding: binary
Content-Type: text/plain
MIME-Version: 1.0
X-Mailer: MIME::Lite 3.01 &#40;F2.72; B3.04; Q3.03&#41;
Date: Mon, 11 Sep 2006 15:30:02 UT
From: foo@hrsmart.com
To: sallen@hrsmart.com
Subject: Helloooooo, nurse!
Message-Id: &lt;E1GMnjX-0007Br-00@test.hrsmart.com&gt;

How&#39;s it goin&#39;, eh?

An alternate test case:

root@test:~# cat test.pl
#!/usr/bin/perl -w

use strict;
use MIME::Lite;

my $msg = MIME::Lite-&gt;new&#40;
             From     =&gt;&#39;foo@hrsmart.com&#39;,
             To       =&gt;&#39;sallen@hrsmart.com&#39;,
             Subject  =&gt;&#39;Helloooooo, nurse!&#39;,
             Data     =&gt;&#34;How&#39;s it goin&#39;, eh?&#34;
             &#41;;
$msg-&gt;send_by_sendmail&#40;&#41;;

root@test:~# perl test.pl
root@test:~# tail -3 /var/log/exim/mainlog
2006-09-11 10:36:50 1GMnq6-0007Cg-00 &lt;= foo@hrsmart.com U=root P=local S=507
2006-09-11 10:36:50 1GMnq6-0007Cg-00 =&gt; sallen@hrsmart.com R=lookuphost
T=remote_smtp H=mail.hrsmart.com [xx.xx.xx.xx]
2006-09-11 10:36:50 1GMnq6-0007Cg-00 Completed

Message source:

X-Real-To: sallen@hrsmart.com
Return-Path: &lt;foo@hrsmart.com&gt;
Received: from test.hrsmart.com &#40;[xx.xx.xx.xx] verified&#41;
  by franklin.hrsmart.com &#40;SMTP&#41;
  with ESMTP id 2191967 for sallen@hrsmart.com; Mon, 11 Sep 2006
10:37:06 -0500
Received: from root by test.hrsmart.com with local &#40;Exim 3.36 #1 &#40;Debian&#41;&#41;
        id 1GMnq6-0007Cg-00
        for &lt;sallen@hrsmart.com&gt;; Mon, 11 Sep 2006 10:36:50 -0500
Content-Disposition: inline
Content-Length: 19
Content-Transfer-Encoding: binary
Content-Type: text/plain
MIME-Version: 1.0
X-Mailer: MIME::Lite 3.01 &#40;F2.72; B3.04; Q3.03&#41;
Date: Mon, 11 Sep 2006 15:36:50 UT
From: foo@hrsmart.com
To: sallen@hrsmart.com
Subject: Helloooooo, nurse!
Message-Id: &lt;E1GMnq6-0007Cg-00@test.hrsmart.com&gt;

How&#39;s it goin&#39;, eh?

Things to note:

1. The log lines in test #2 shows the message from foo, not root.
2. The Return-Path header in #2 shows the message from foo, not root.

These are the effects of the SetSender flag. It is supposed to be active
by default, per the documentation.

The problem is a result of an inconsistency in send_by_sendmail, which I
am filing an additional bug report about. send_by_sendmail has two
&#34;modes&#34; of operation. In the first, if arguments are passed in, no
further processing is done. A pipe is opened to sendmail, and the
message is sent using that pipe. The sendmail instance is executed using
only the arguments passed in to send_by_sendmail; no further processing
is done. This means the SetSender flag is ignored.

The *actual* problem causing this issue is because the send&#40;&#41; function
uses default arguments for send_by_sendmail, which triggers the
inconsistent behaviour noted above. From the module source:

    380 ### Our sending facilities:
    381 my $Sender     = &#34;sendmail&#34;;
    382 my %SenderArgs = &#40;
    383     &#34;sendmail&#34; =&gt; [&#34;$SENDMAIL -t -oi -oem&#34;],
    384     &#34;smtp&#34;     =&gt; [],
    385     &#34;sub&#34;      =&gt; [],
    386 &#41;;

.... &lt;snip&gt; ....

   2440 sub send {
   2441     my $self = shift;
   2442
   2443     if &#40;ref&#40;$self&#41;&#41; {              ### instance method:
   2444         my &#40;$method, @args&#41;;
   2445         if &#40;@_&#41; {                            ### args; use them
just this once
   2446             $method = &#39;send_by_&#39; . shift;
   2447             @args   = @_;
   2448         }
   2449         else {                               ### no args; use
defaults
   2450             $method = &#34;send_by_$Sender&#34;;
   2451             @args   = @{$SenderArgs{$Sender} || []};
   2452         }
   2453         $self-&gt;verify_data if $AUTO_VERIFY;  ### prevents
missing parts!
   2454         return $self-&gt;$method&#40;@args&#41;;
   2455     }

.... &lt;snip&gt; ....

   2536 sub send_by_sendmail {
   2537     my $self = shift;
   2538
   2539     if &#40;@_ == 1&#41; {                    ### Use the given command...
   2540         my $sendmailcmd = shift @_;
   2541
   2542         ### Do it:
   2543         open SENDMAIL, &#34;|$sendmailcmd&#34; or Carp::croak &#34;open
|$sendmailcmd: $!\n&#34;;
   2544         $self-&gt;print&#40;\*SENDMAIL&#41;;
   2545         close SENDMAIL;
   2546         return &#40;&#40;$? &gt;&gt; 8&#41; ? undef : 1&#41;;
   2547     }
   2548     else {                            ### Build the command...
   2549         my %p = @_;
   2550         $p{Sendmail} ||= &#34;/usr/lib/sendmail&#34;;
   2551
   2552         ### Start with the command and basic args:
   2553         my @cmd = &#40;$p{Sendmail}, @{$p{BaseArgs} || [&#39;-t&#39;, &#39;-oi&#39;,
&#39;-oem&#39;]}&#41;;
   2554
   2555         ### See if we are forcibly setting the sender:
   2556         $p{SetSender} = 1 if defined&#40;$p{FromSender}&#41;;
   2557
   2558         ### Add the -f argument, unless we&#39;re explicitly told
NOT to:
   2559         unless &#40;exists&#40;$p{SetSender}&#41; and !$p{SetSender}&#41; {
   2560             my $from = $p{FromSender} || &#40;$self-&gt;get&#40;&#39;From&#39;&#41;&#41;[0];


Suggested fixes:

1. Move the default argument construction to a separate function:

sub build_sendmail_args
{
    # do the work occurring in lines 2549 - 2965
}

2. Change Sender Args like so:

    380 ### Our sending facilities:
    381 my $Sender     = &#34;sendmail&#34;;
    382 my %SenderArgs = &#40;
    383     &#34;sendmail&#34; =&gt; [ build_sendmail_args&#40;&#41; ],
    384     &#34;smtp&#34;     =&gt; [],
    385     &#34;sub&#34;      =&gt; [],
    386 &#41;;

3. Modify sub send_by_sendmail to use build_sendmail_args &#40;to avoid code
duplication&#41;

4. Modify the documentation:

SetSender

Unless this is explicitly given as false **or unless you override the
arguments being passed to sendmail**, we attempt to automatically set
the -f argument to the first address that can be extracted from the
&#34;From:&#34; field of the message &#40;if there is one&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;11&nbsp;12:00:41&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;03&nbsp;11:15:31&nbsp;2006</span>
    <span class="description">GWOLF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Bug report linked in the Debian BTS</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> GWOLF [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,
Just to let you know that we have this bug filed in the Debian BTS:

<span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=387003">http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=387003</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;02&nbsp;10:51:19&nbsp;2007</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> MARKSTOS [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I tried upgrading to 3.01_05 to fix this, but I got errors referring to
UNIVERSAL::isa&#40;&#41;, which was added in the newer code. &#40;Perl 5.8.0,
FreeBSD 5.1&#41;. 

What worked for me instead was to be very explicit:

send_by_sendmail&#40;
           Sendmail   =&gt;  &#34;/usr/sbin/sendmail&#34;,
           BaseArgs   =&gt;  [&#34;-t&#34;, &#34;-oi&#34;, &#34;-oem&#34;],
           FromSender =&gt; &#39;...&#39;,
      &#41;;

This works with sendmail and qmail. &#40;There didn&#39;t seem a problem with
Qmail anyway, as it was picking up the Return-Path set, I believe. &#41;. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;15&nbsp;23:32:18&nbsp;2009</span>
    <span class="description">MSCHOUT [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">There are two problems with the implementation of send_by_sendmail&#40;&#41;
that prevent it from adding -fsender to the command line args.  The
attached patch makes it do what the documentation says it should do.

First problem is that the &#34;else&#34; section in send_by_sendmail&#40;&#41; never
gets called because send&#40;&#41; passes an argument to it with the contents of
$SenderArgs{sendmail}.

I fixed by dropping the $SenderArgs{sendmail} array.  send_by_sendmail&#40;&#41;
generates the exact same command anyway.  That is, it automatically adds
-t -oi -oem which is all the SenderArgs was doing anyway.  We still need
to keep the SenderArgs placeholder though so that the class method still
works &#40;MIME::Lite-&gt;send&#40;sendmail =&gt; &#39;/foo/sendmail -t -oi -oem -whatever&#39;&#41;&#41;.

The second problem is that the docs say that the default is to ADD
-fsender, unless you explicity disable it.  However, $p{SetSender} is
never initialized in send_by_sendmail&#40;&#41;, so the result is that it will
never add the -fsender unless you explicitly ask it to do that, either
by using FromSender, or passing SetSender =&gt; 1.

Fix for this issue was obvious.

Attached patch fixes both problems, and includes a test case for the
class method.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 167f761008248efa7f308649d66f23b1e3be2c1b Mon Sep 17 00:00:00 2001
From: Michael Schout &lt;mschout@gkg.net&gt;
Date: Wed, 15 Jul 2009 22:27:41 -0500
Subject: [PATCH] send_by_sendmail&#40;&#41;: set sender by default as documented

---
 lib/MIME/Lite.pm |    5 ++++-
 t/sendmail.t     |   16 ++++++++++++++++
 2 files changed, 20 insertions&#40;+&#41;, 1 deletions&#40;-&#41;
 create mode 100644 t/sendmail.t

diff --git a/lib/MIME/Lite.pm b/lib/MIME/Lite.pm
index 412dd80..1149fa0 100644
--- a/lib/MIME/Lite.pm
+++ b/lib/MIME/Lite.pm
@@ -401,7 +401,7 @@ if &#40; $^O =~ /win32|cygwin/i &#41; {
 
 ### Our sending facilities:
 my %SenderArgs = &#40;
-  sendmail  =&gt; [$SENDMAIL ? &#34;$SENDMAIL -t -oi -oem&#34; : undef],
+  sendmail  =&gt; [],
   smtp      =&gt; [],
   sub       =&gt; [],
 &#41;;
@@ -2698,6 +2698,9 @@ sub send_by_sendmail {
         ### Start with the command and basic args:
         my @cmd = &#40; $p{Sendmail}, @{ $p{BaseArgs} || [ &#39;-t&#39;, &#39;-oi&#39;, &#39;-oem&#39; ] } &#41;;
 
+        # SetSender default is true
+        $p{SetSender} = 1 unless defined $p{SetSender};
+
         ### See if we are forcibly setting the sender:
         $p{SetSender} ||= defined&#40; $p{FromSender} &#41;;
 
diff --git a/t/sendmail.t b/t/sendmail.t
new file mode 100644
index 0000000..4bd4d8f
--- /dev/null
+++ b/t/sendmail.t
@@ -0,0 +1,16 @@
+#!/usr/bin/perl
+
+use lib &#34;lib&#34;, &#34;t&#34;;
+use MIME::Lite;
+use Test::More tests =&gt; 2;
+
+use_ok&#40;&#39;MIME::Lite&#39;&#41; or exit 1;
+
+# set up dummy sendmail args.
+MIME::Lite-&gt;send&#40;&#39;sendmail&#39;, &#39;/foo/bar/sendmail -x -y -z&#39;&#41;;
+
+# retrieve the settings.
+my @prev = MIME::Lite-&gt;send&#40;sendmail =&gt; &#39;/foo/bar/sendmail&#39;&#41;;
+
+is_deeply \@prev, [&#39;sendmail&#39;, &#39;/foo/bar/sendmail -x -y -z&#39;],
+    &#39;sendmail args updated&#39;;
-- 
1.6.0.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;15&nbsp;23:40:03&nbsp;2009</span>
    <span class="description">MSCHOUT [...] cpan.org -  Cc MSCHOUT added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;20&nbsp;15:20:48&nbsp;2011</span>
    <span class="description">sup2000 [...] hotmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> sup2000 [...] hotmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m having this same problem with MIME::Lite. 

A couple of patches have been offered. I&#39;m chiming in for two reasons:

a&#41; A &#34;Me Too&#34; report, to help you gauge how many people this is affecting; and,
b&#41; Ask &#34;What can I do to help?&#34;

I see a few different approaches have been offered up, and a patch has been offered. This 
problem has been outstanding for more than 8 years &#40;egads!&#41; it seems. Can I re-work one of the 
patches, or do something to help resolve this bug once and for all?

Thanks!

Scott
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;03&nbsp;21:13:13&nbsp;2013</span>
    <span class="description">rjbs [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">fixed in git

-- 
rjbs
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;03&nbsp;21:13:14&nbsp;2013</span>
    <span class="description">rjbs [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
