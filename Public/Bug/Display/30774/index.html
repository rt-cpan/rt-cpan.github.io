<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #30774 for CGI: Needs Bug Hunting: mod_perl resets $XHTML to 1 after first request</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #30774 for CGI: Needs Bug Hunting: mod_perl resets $XHTML to 1 after first request</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/CGI/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/CGI/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/CGI/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/CGI/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/leejo/CGI.pm/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/CGI">CGI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">30774</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/CGI/Active/">CGI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">MARKSTOS [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ldm [...] apartia.fr

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-230860-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-230861-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;16&nbsp;04:58:50&nbsp;2007</span>
    <span class="description">ldm [...] apartia.fr -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> CGI.pm with modperl resets $XHTML to 1 after first request</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 16 Nov 2007 10:57:53 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI.pm [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Louis-David Mitterrand &lt;ldm [...] apartia.fr&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

In my modperl startup file I have:

    use CGI qw&#40;... -no_xhtml ...&#41;;

and use: 

        start_html&#40;
        -dtd=&gt;[ &#39;-//W3C//DTD HTML 4.01//EN&#39;, &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/TR/html4/strict.dtd&#39;">http://www.w3.org/TR/html4/strict.dtd&#39;</a></span> ],
        ... etc.
        &#41;


After restarting apache2, CGI.pm&#39;s start_html&#40;&#41; function emits:

        &lt;html lang=&#34;fr-FR&#34;&gt;&lt;head&gt;&lt;title&gt;My title&lt;/title&gt;

But after a 3/4 reloads it starts emitting:

        &lt;html xmlns=&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</a></span>&#34; lang=&#34;fr-FR&#34; xml:lang=&#34;fr-FR&#34;&gt;

So I have to add:

    $CGI::XHTML = 0;

in my startup file to keep xthml off.

Somehow $XHTML goes back to 1 after the first request in the apache child.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;24&nbsp;21:35:20&nbsp;2009</span>
    <span class="description">MARKSTOS [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;24&nbsp;21:35:41&nbsp;2009</span>
    <span class="description">MARKSTOS [...] cpan.org -  Subject changed from &#39;CGI.pm with modperl resets $XHTML to 1 after first request&#39; to &#39;Needs Confirmation: CGI.pm with modperl resets $XHTML to 1 after first request&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;24&nbsp;21:36:13&nbsp;2009</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Nov 16 04:58:50 2007, ldm@apartia.fr wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; In my modperl startup file I have:
&gt; 
&gt;     use CGI qw&#40;... -no_xhtml ...&#41;;
&gt; 
&gt; and use:
&gt; 
&gt;       start_html&#40;
&gt;       -dtd=&gt;[ &#39;-//W3C//DTD HTML 4.01//EN&#39;,
&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/TR/html4/strict.dtd&#39;">http://www.w3.org/TR/html4/strict.dtd&#39;</a></span> ],
&gt;       ... etc.
&gt;       &#41;
&gt; 
&gt; 
&gt; After restarting apache2, CGI.pm&#39;s start_html&#40;&#41; function emits:
&gt; 
&gt;       &lt;html lang=&#34;fr-FR&#34;&gt;&lt;head&gt;&lt;title&gt;My title&lt;/title&gt;
&gt; 
&gt; But after a 3/4 reloads it starts emitting:
&gt; 
&gt;       &lt;html xmlns=&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</a></span>&#34; lang=&#34;fr-FR&#34; xml:lang=&#34;fr-
&gt; FR&#34;&gt;
&gt; 
&gt; So I have to add:
&gt; 
&gt;     $CGI::XHTML = 0;
&gt; 
&gt; in my startup file to keep xthml off.
&gt; 
&gt; Somehow $XHTML goes back to 1 after the first request in the apache
&gt; child.
</div>
Thanks for the report. Do you find that this bug still exists with
CGI.pm 3.43?

   Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;24&nbsp;21:36:14&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;25&nbsp;04:14:05&nbsp;2009</span>
    <span class="description">ldm [...] apartia.fr -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #30774] Needs Confirmation: CGI.pm with modperl resets $XHTML to 1 after first request</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 25 Jul 2009 10:13:41 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> MARKSTOS via RT &lt;bug-CGI.pm [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Louis-David Mitterrand &lt;ldm [...] apartia.fr&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Jul 24, 2009 at 09:36:15PM -0400, MARKSTOS via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=30774">https://rt.cpan.org/Ticket/Display.html?id=30774</a></span> &gt;
&gt; 
&gt; On Fri Nov 16 04:58:50 2007, ldm@apartia.fr wrote:
<div class="message-stanza open">&gt; &gt; Hi,
&gt; &gt; 
&gt; &gt; In my modperl startup file I have:
&gt; &gt; 
&gt; &gt;     use CGI qw&#40;... -no_xhtml ...&#41;;
&gt; &gt; 
&gt; &gt; and use:
&gt; &gt; 
&gt; &gt;     start_html&#40;
&gt; &gt;     -dtd=&gt;[ &#39;-//W3C//DTD HTML 4.01//EN&#39;,
&gt; &gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/TR/html4/strict.dtd&#39;">http://www.w3.org/TR/html4/strict.dtd&#39;</a></span> ],
&gt; &gt;     ... etc.
&gt; &gt;     &#41;
&gt; &gt; 
&gt; &gt; 
&gt; &gt; After restarting apache2, CGI.pm&#39;s start_html&#40;&#41; function emits:
&gt; &gt; 
&gt; &gt;     &lt;html lang=&#34;fr-FR&#34;&gt;&lt;head&gt;&lt;title&gt;My title&lt;/title&gt;
&gt; &gt; 
&gt; &gt; But after a 3/4 reloads it starts emitting:
&gt; &gt; 
&gt; &gt;     &lt;html xmlns=&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</a></span>&#34; lang=&#34;fr-FR&#34; xml:lang=&#34;fr-
&gt; &gt; FR&#34;&gt;
&gt; &gt; 
&gt; &gt; So I have to add:
&gt; &gt; 
&gt; &gt;     $CGI::XHTML = 0;
&gt; &gt; 
&gt; &gt; in my startup file to keep xthml off.
&gt; &gt; 
&gt; &gt; Somehow $XHTML goes back to 1 after the first request in the apache
&gt; &gt; child.
</div>&gt; 
&gt; Thanks for the report. Do you find that this bug still exists with
&gt; CGI.pm 3.43?
</div>
Hi,

I don&#39;t know since I use debian&#39;s version which is still at 3.29.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;27&nbsp;16:07:57&nbsp;2009</span>
    <span class="description">MSCHOUT [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This happens because under mod_perl, CGI.pm registers a cleanup handler
that calls _reset_globals&#40;&#41; &#40;which then calls initialize_globals&#40;&#41;&#41;.

So globals &#40;$XHTML, $PARAM_UTF8 etc&#41; that may have been changed will be
wiped out at the end of the request.

The only way I see around this is to reset the globals at the start of
each request to what you want &#40;e.g.: set $XHTML = 0&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;27&nbsp;22:10:06&nbsp;2009</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Aug 27 16:07:57 2009, MSCHOUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This happens because under mod_perl, CGI.pm registers a cleanup handler
&gt; that calls _reset_globals&#40;&#41; &#40;which then calls initialize_globals&#40;&#41;&#41;.
&gt; 
&gt; So globals &#40;$XHTML, $PARAM_UTF8 etc&#41; that may have been changed will be
&gt; wiped out at the end of the request.
&gt; 
&gt; The only way I see around this is to reset the globals at the start of
&gt; each request to what you want &#40;e.g.: set $XHTML = 0&#41;.
</div>
Ok, this explanation sounds plausible. So maybe it would work to
redefine _reset_globals&#40;&#41; like this:?

sub _reset_globals {
    initialize_globals&#40;&#41;;
    CGI-&gt;_setup_symbols&#40;@SAVED_SYMBOLS&#41;; 
}

That&#39;s not been tested, but seems like it might do the right think to
make changes to global variables persis in mod_perl. 

   Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;29&nbsp;14:53:58&nbsp;2009</span>
    <span class="description">MARKSTOS [...] cpan.org -  Subject changed from &#39;Needs Confirmation: CGI.pm with modperl resets $XHTML to 1 after first request&#39; to &#39;Needs Testing, Peer Review: modperl resets $XHTML to 1 after first request&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;02&nbsp;09:41:59&nbsp;2009</span>
    <span class="description">MARKSTOS [...] cpan.org -  Reference by ticket #32119 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;03&nbsp;22:41:03&nbsp;2009</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Aug 27 22:10:06 2009, MARKSTOS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Aug 27 16:07:57 2009, MSCHOUT wrote:
<div class="message-stanza open">&gt; &gt; This happens because under mod_perl, CGI.pm registers a cleanup handler
&gt; &gt; that calls _reset_globals&#40;&#41; &#40;which then calls initialize_globals&#40;&#41;&#41;.
&gt; &gt; 
&gt; &gt; So globals &#40;$XHTML, $PARAM_UTF8 etc&#41; that may have been changed will be
&gt; &gt; wiped out at the end of the request.
&gt; &gt; 
&gt; &gt; The only way I see around this is to reset the globals at the start of
&gt; &gt; each request to what you want &#40;e.g.: set $XHTML = 0&#41;.
</div></div>
In CGI::new, we can see the related code. You mentioned using Apache2,
so I assume you are using mod_perl2. In that code path, these two lines
should be triggered:

      $r-&gt;pool-&gt;cleanup_register&#40;\&#38;CGI::_reset_globals&#41;;
      $self-&gt;_setup_symbols&#40;@SAVED_SYMBOLS&#41; if @SAVED_SYMBOLS;

Calling _setup_symbols&#40;&#41; like this is usually want preserves the pragmas
in a persistent environment. Do you see a bug here? It&#39;s not clear to me
what to change. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;03&nbsp;22:41:27&nbsp;2009</span>
    <span class="description">MARKSTOS [...] cpan.org -  Subject changed from &#39;Needs Testing, Peer Review: modperl resets $XHTML to 1 after first request&#39; to &#39;Needs Bug Hunting: modperl resets $XHTML to 1 after first request&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;04&nbsp;21:49:09&nbsp;2009</span>
    <span class="description">MARKSTOS [...] cpan.org -  Subject changed from &#39;Needs Bug Hunting: modperl resets $XHTML to 1 after first request&#39; to &#39;Needs Bug Hunting: mod_perl resets $XHTML to 1 after first request&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;02&nbsp;03:54:28&nbsp;2011</span>
    <span class="description">mkanat [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Sep 03 22:41:03 2009, MARKSTOS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Calling _setup_symbols&#40;&#41; like this is usually want preserves the 
</div>pragmas
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; in a persistent environment. Do you see a bug here? It&#39;s not clear to 
</div>me
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; what to change. 
</div>
  I&#39;ve hit this and I&#39;m pretty sure I know what the problem is. Try this:

  use Data::Dumper;
  CGI-&gt;compile&#40;&#39;:unique_headers&#39;&#41;;
  CGI-&gt;compile&#40;&#39;:cgi&#39;&#41;;
  print Dumper&#40;\@CGI::SAVED_SYMBOLS&#41;;

  _setup_symbols needs to do push&#40;@SAVED_SYMBOLS, @_&#41; instead of doing =.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;02&nbsp;09:19:46&nbsp;2011</span>
    <span class="description">mark [...] summersault.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #30774] Needs Bug Hunting: mod_perl resets $XHTML to 1 after first request</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 02 Mar 2011 09:19:38 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI.pm [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Stosberg &lt;mark [...] summersault.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;   _setup_symbols needs to do push&#40;@SAVED_SYMBOLS, @_&#41; instead of doing =.
</div>
Thanks, Max! That sounds right. We&#39;ll look into it further.

    Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;02&nbsp;21:29:52&nbsp;2011</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> lincoln.stein [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve looked into this some more, and my current opinion is this not
clearly flexible.

The pragma/symbol/global system dates to back to when CGI scripts were
king, &#34;applications&#34; fit into a single file and name space, CGI.pm was
loaded once, and mod_perl was not in use.

Consider a modern web application which uses multiple packages. More
than one might &#34;use CGI&#34;, the below script:

 use v5.10;
 
 package First;
 use CGI &#39;-xhtml&#39;;
 
 sub first_foo {
     my $q = CGI-&gt;new;
     return  $q-&gt;input&#40;&#41;;
 }
 
 package Second;
 use CGI &#39;-no_xhtml&#39;;
 
 sub second_foo {
     my $q = CGI-&gt;new;
     return  $q-&gt;input&#40;&#41;;
 }
 
 package main;
 import First;
 say First::first_foo&#40;&#41;;
 
 import Second;
 say Second::second_foo&#40;&#41;;

###

One package intends to set the &#34;-no_xhtml&#34; pragma, while another sets
the opposite. The result is that silently one pragma &#34;wins&#34; in both
cases.

Setting these values by global variables also has problems, a truly
global variable could affect another package at a distance that didn&#39;t
what the setting. And with global variables the intent is not always
clear or possible to express precisely. Did you intend to affect
everything everywhere, just the current package, or just the current
object?

Because of this inherent lack of clarity, it&#39;s hard to change with
confidence which controls how these are variables are managed. In the
cases reported here, are we certain for instance that there is only one
&#34;use CGI&#34; throughout the entire code-base... and only one &#34;CGI-&gt;compile&#34;
?  Can we be certain that we are updating the behavior that correctly
represents what people expect about per-object values being reset and
how they related to global settings?

Here are my thoughts on addressing this:

- Using a framework like CGI::Application helps. It highly encourages
  the application and plugins to access CGI through $self-&gt;query&#40;&#41;. So 
  CGI.pm is &#34;used&#34; exactly once and any global changes can be declared 
  with &#34;local&#34; just before calling CGI-&gt;new in cgiapp_get_query&#40;&#41;.

- The documentation can be updated to be clearer about the best
  practices for declaring global-scope and object-scope preferences,
  as well as how to do deal with gotchas.

- CGI.pm could could consider adding object-scope pragmas something like
  this: $q-&gt;pragmas&#40;&#39;-no_xhtml -no_sticky&#39;&#41;; That may be a horrible name
  and interface, but the intent is there: a way to explicitly support
  settings that are per-object.

  Such a notion would be easy to manage the code for, and would provide
  explicit clarity fo users.

If you still think there&#39;s some other global change to be made, I&#39;d like
to see a reduced case example that triggers so that we understand
exactly which case is being proposed to be changed.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;22&nbsp;08:02:43&nbsp;2014</span>
    <span class="description">LEEJO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This issue has been copied to: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/leejo/CGI.pm/issues/51">https://github.com/leejo/CGI.pm/issues/51</a></span> please take all future correspondence there.
This ticket will remain open but please do not reply here.
This ticket will be closed when the github issue is dealt with.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;23&nbsp;14:28:02&nbsp;2014</span>
    <span class="description">The RT System itself -  Queue changed from CGI.pm to CGI</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;18&nbsp;15:53:59&nbsp;2014</span>
    <span class="description">LEEJO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Rejecting as &#34;won&#39;t fix&#34; &#40;mod_perl&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;18&nbsp;15:54:00&nbsp;2014</span>
    <span class="description">LEEJO [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
