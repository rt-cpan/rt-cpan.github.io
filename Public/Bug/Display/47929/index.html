<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #47929 for Template-Toolkit: XS stash crashes with string eval in stash.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #47929 for Template-Toolkit: XS stash crashes with string eval in stash.</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Template-Toolkit">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Template-Toolkit">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Template-Toolkit">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Template-Toolkit">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Template-Toolkit">Template-Toolkit CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">47929</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">4 hours (240 min)

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Template-Toolkit">Template-Toolkit</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
perl-cpan [...] bereft.net

<br />
ROBINS [...] cpan.org

<br />
TJC [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-31100-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
2.21</li>
<li>
2.06</li>
<li>
2.07</li>
<li>
2.08</li>
<li>
2.09</li>
<li>
2.10</li>
<li>
2.11</li>
<li>
2.12</li>
<li>
2.13</li>
<li>
2.14</li>
<li>
2.15</li>
<li>
2.16</li>
<li>
2.17</li>
<li>
2.18</li>
<li>
2.19</li>
<li>
2.20</li>
<li>
2.22</li>
</ul>
    </td>
  </tr>
  <tr id="CF-31101-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




call.c<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/839607/434824/call.c">
Tue Oct 05 10:08:29 2010 (1.3k) by perl-cpan [...] bereft.net
</a>
</font></li>
</ul>


call.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/839607/434823/call.pl">
Tue Oct 05 10:08:29 2010 (855b) by perl-cpan [...] bereft.net
</a>
</font></li>
</ul>


crash.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/633571/322786/crash.pl">
Wed Jul 15 21:13:50 2009 (707b) by TJC [...] cpan.org
</a>
</font></li>
</ul>


crash2.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/633607/322815/crash2.pl">
Wed Jul 15 22:01:42 2009 (625b) by TJC [...] cpan.org
</a>
</font></li>
</ul>


evalusecrash.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/649407/332519/evalusecrash.t">
Mon Aug 17 22:13:39 2009 (452b) by TJC [...] cpan.org
</a>
</font></li>
</ul>


runtest.sh<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/649407/332516/runtest.sh">
Mon Aug 17 22:13:39 2009 (155b) by TJC [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=47929">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-633571" href="/Public/Bug/Display.html?id=47929#txn-633571">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;15&nbsp;21:13:50&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> XS stash crashes with DateTime::TimeZone::Local</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/633571/322783/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/322783">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 475b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The attached file calls DateTime::TimeZone::Local-&gt;TimeZone&#40;&#41; from
inside a callback function in a template stash.

This has the surprising result of neatly exiting Perl upon return from
the callback function, rather than returning to the template processing.

This was tested with Template Toolkit 2.20 and 2.21, and
DateTime::TimeZone 0.91 on Perl 5.10.0 on Linux and MacOSX.

&#40;I will also report this bug against DateTime::TimeZone as I&#39;m unsure
which module is at fault.&#41;
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> crash.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/633571/322786/crash.pl">Download crash.pl</a><br />
<span class="downloadcontenttype">text/x-perl 707b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
use strict;
use warnings;
use DateTime::TimeZone::Local;
use Template;
use Template::Stash::XS;
    
print &#34;DateTime::TimeZone version: &#34; . $DateTime::TimeZone::VERSION . &#34;\n&#34;;
print &#34;Template version: &#34; . $Template::VERSION . &#34;\n&#34;;

my $status = &#39;FAILED&#39;;

my $template = &#39;[% crasher&#40;&#41; %]&#39;;
my $output;

# Note that only the XS stash fails..
my $tt2 = Template-&gt;new&#40; STASH =&gt; Template::Stash::XS-&gt;new &#41;;
$tt2-&gt;process&#40;\$template, { crasher =&gt; \&#38;crasher }, \$output&#41;;
print &#34;Generated output: $output\n&#34;;

$status = &#39;SUCCESS&#39;;

sub crasher {
    DateTime::TimeZone::Local-&gt;TimeZone;
    warn &#34;** In crasher&#40;&#41;, about to return..&#34;;
    return &#39;foo&#39;;
}


sub END { print &#34;Status: $status\n&#34;; }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-633588" href="/Public/Bug/Display.html?id=47929#txn-633588">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;15&nbsp;21:18:21&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Reference to ticket #47930 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-633606" href="/Public/Bug/Display.html?id=47929#txn-633606">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;15&nbsp;21:58:43&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Subject changed from &#39;XS stash crashes with DateTime::TimeZone::Local&#39; to &#39;XS stash crashes with string eval in stash.&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-633607" href="/Public/Bug/Display.html?id=47929#txn-633607">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;15&nbsp;22:01:41&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/633607/322812/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/322812">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 185b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have eliminated DateTime::TimeZone from the test, and narrowed down
the cause of the problem to using a string eval inside the template
stash callback.

See attached file for details.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/633607/322815/crash2.pl">Download crash2.pl</a><br />
<span class="downloadcontenttype">text/x-perl 625b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
use strict;
use warnings;
use Template;
use Template::Stash::XS;
    
print &#34;Template version: &#34; . $Template::VERSION . &#34;\n&#34;;

my $status = &#39;FAILED&#39;;

my $template = &#39;[% crasher&#40;&#41; %]&#39;;
my $output;

# Note that only the XS stash fails..
my $tt2 = Template-&gt;new&#40; STASH =&gt; Template::Stash::XS-&gt;new &#41;;
$tt2-&gt;process&#40;\$template, { crasher =&gt; \&#38;load_subclass }, \$output&#41;
    or warn &#34;Failed to process..\n&#34;;

$status = &#39;SUCCESS&#39;;

sub END { print &#34;Status: $status\n&#34;; }

sub load_subclass {
    eval &#34;use Nonexistent::Class&#34;;
    if &#40;$@&#41; {
        warn &#34;Caught expected failure to use Nonexistent::Class&#34;;
    }
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-633609" href="/Public/Bug/Display.html?id=47929#txn-633609">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;15&nbsp;22:01:44&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-635830" href="/Public/Bug/Display.html?id=47929#txn-635830">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;21&nbsp;09:10:09&nbsp;2009</span>
    <span class="description">cpan [...] wardley.org -  Correspondence added</span>
    <span class="time-taken">240 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> robin [...] smidsrod.no</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/635830/324098/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/324098">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 743b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve closed bug #48020 as it looks like it&#39;s a manifestation of the same
bug.

<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=48020">https://rt.cpan.org/Ticket/Display.html?id=48020</a></span>

Based on the code that Robin produced to demonstrate bug #48020, I&#39;ve
created a stripped down version of the XS Stash to try and narrow down
the problem.

<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/abw/TT-XS-Stash-DateTime/tree/master">http://github.com/abw/TT-XS-Stash-DateTime/tree/master</a></span>

I&#39;ve added your string eval test and can confirm that it fails on my
machine.  Interestingly, the string eval test fails on my Macbook, but
the DateTime tests pass.  On a Fedora 64 bit machine all the tests fail.

So although I&#39;m no closer to finding and fixing the problem, it is at
least reproducible and there&#39;s a minimal version of the XS Stash in the
above git repo which demonstrates the problem.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-635837" href="/Public/Bug/Display.html?id=47929#txn-635837">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;21&nbsp;10:06:00&nbsp;2009</span>
    <span class="description">robin [...] smidsrod.no -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #47929] XS stash crashes with string eval in stash.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 21 Jul 2009 16:04:41 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Template-Toolkit [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Robin Smidsrød &lt;robin [...] smidsrod.no&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/635837/324105/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/324105">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Andy Wardley via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve added your string eval test and can confirm that it fails on my
&gt; machine.  Interestingly, the string eval test fails on my Macbook, but
&gt; the DateTime tests pass.  On a Fedora 64 bit machine all the tests fail.
</div>
Running on Strawberry perl 5.10.0.5 on a Vista x64 machine:

As you can see the datetime seems to work, but the string eval seems to
fail:

&#40;TT 2.22 and DateTime 0.50 from CPAN was used&#41;

C:\Users\robin\perl\TT-XS-Stash-DateTime&gt;dmake test
C:\strawberry\perl\bin\perl.exe &#34;-MExtUtils::Command::MM&#34; &#34;-e&#34;
&#34;test_harness&#40;0, &#39;blib\lib&#39;, &#39;blib\arch&#39;&#41;&#34; t/datetime.t t/string_eval.t
t/datetime.t ..... - dotop&#40;date_time&#41;
- - fetch item: date_time
- - fetching hash item
- - got value, triggering any tied magic
- - TT_RET_OK
- - dotop&#40;date_time_sub&#41;
- - fetch item: date_time_sub
- - fetching hash item
- - got value, triggering any tied magic
- - calling coderef
t/datetime.t ..... 1/2  in call_coderef&#40;&#41;
- - about to push args
- - pushed args
- - calling call_sv&#40;&#41;
# Creating DateTime object
# Created DateTime object, returning
- - called call_sv&#40;&#41;
- - called coderef, returning result
- - TT_RET_CODEREF
t/datetime.t ..... ok
t/string_eval.t .. - dotop&#40;eval_fail&#41;
- - fetch item: eval_fail
- - fetching hash item
- - got value, triggering any tied magic
- - calling coderef
- - in call_coderef&#40;&#41;
- - about to push args
- - pushed args
- - calling call_sv&#40;&#41;
# About to use NonExistantClass
# Caught expected failure to use Nonexistent::Class at t/string_eval.t
line 24.
# No tests run!
t/string_eval.t .. Dubious, test returned 255 &#40;wstat 65280, 0xff00&#41;
Failed 1/1 subtests
Test Summary Report
- -------------------
t/string_eval.t &#40;Wstat: 65280 Tests: 0 Failed: 0&#41;
  Non-zero exit status: 255
  Parse errors: Bad plan.  You planned 1 tests but ran 0.
Files=2, Tests=2,  1 wallclock secs &#40; 0.05 usr +  0.00 sys =  0.05 CPU&#41;
Result: FAIL
Failed 1/2 test programs. 0/2 subtests failed.
dmake:  Error code 255, while making &#39;test_dynamic&#39;
C:\Users\robin\perl\TT-XS-Stash-DateTime&gt;

C:\Users\robin\perl\TT-XS-Stash-DateTime&gt;perl t/string_eval.t
1..1
- - dotop&#40;eval_fail&#41;
- - fetch item: eval_fail
- - fetching hash item
- - got value, triggering any tied magic
- - calling coderef
- - in call_coderef&#40;&#41;
- - about to push args
- - pushed args
- - calling call_sv&#40;&#41;
# About to use NonExistantClass
# Caught expected failure to use Nonexistent::Class at t/string_eval.t
line 24.
# No tests run!
C:\Users\robin\perl\TT-XS-Stash-DateTime&gt;

Maybe this can help you to get one step closer to the problem.

- -- Robin
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 &#40;MingW32&#41;
Comment: Using GnuPG with Mozilla - <span class="clickylink"><a target="new" rel="nofollow" href="http://enigmail.mozdev.org/">http://enigmail.mozdev.org/</a></span>

iEYEARECAAYFAkplyvgACgkQHAwEVD/in27biACfar+XRWh6LPu0sC7o0iGGkWhd
bhYAn1aY9zttW9yKu29My4I8FSLOnozm
=dbD1
-----END PGP SIGNATURE-----
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-635840" href="/Public/Bug/Display.html?id=47929#txn-635840">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;21&nbsp;10:08:35&nbsp;2009</span>
    <span class="description">robin [...] smidsrod.no -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #47929] XS stash crashes with string eval in stash.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 21 Jul 2009 16:07:17 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Template-Toolkit [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Robin Smidsrød &lt;robin [...] smidsrod.no&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/635840/324108/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/324108">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 661b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Andy Wardley via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve added your string eval test and can confirm that it fails on my
&gt; machine.  Interestingly, the string eval test fails on my Macbook, but
&gt; the DateTime tests pass.  On a Fedora 64 bit machine all the tests fail.
</div>
Forgot to mention that my tests where run from:
commit f9c9ca2ba2c68fc8772e73aedd36a794e503c639

- -- Robin
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 &#40;MingW32&#41;
Comment: Using GnuPG with Mozilla - <span class="clickylink"><a target="new" rel="nofollow" href="http://enigmail.mozdev.org/">http://enigmail.mozdev.org/</a></span>

iEYEARECAAYFAkply5UACgkQHAwEVD/in27lDQCfXUZFRZKewO5R1BSRydo0x6r0
MvkAnA1/XjO7ZYB2Hyuy3HVyX5TcCgek
=NybL
-----END PGP SIGNATURE-----
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-636135" href="/Public/Bug/Display.html?id=47929#txn-636135">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;21&nbsp;20:59:09&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/636135/324318/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/324318">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 394b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,
I think I can at least explain why the datetime test passes on the mac.
The older versions of datetime did not use the string eval method to
load further modules.
&#40;I hit this bug after an upgrade of datetime occurred, and then narrowed
it down to the eval which failed and caused the problem. I initially
reported it against datetime because downgrading datetime fixed the high
level crash&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-648060" href="/Public/Bug/Display.html?id=47929#txn-648060">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;14&nbsp;15:30:55&nbsp;2009</span>
    <span class="description">ROBINS [...] cpan.org -  Requestor ROBINS added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-649407" href="/Public/Bug/Display.html?id=47929#txn-649407">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;17&nbsp;22:13:38&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/649407/332513/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/332513">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 213b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I tried git bisecting* the source history of TT2 with the XS stash &#40;from 
version 2.06 to 2.22&#41; with the attached files, and it seems like every 
revision fails against the test!

&#40;ie. git bisect run ./runtest.sh&#41;
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/649407/332516/runtest.sh">Download runtest.sh</a><br />
<span class="downloadcontenttype">application/x-shellscript 155b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/649407/332519/evalusecrash.t">Download evalusecrash.t</a><br />
<span class="downloadcontenttype">text/x-perl 452b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
use strict;
use warnings;
use Test::More tests =&gt; 3;
use_ok&#40;&#39;Template&#39;&#41;;
use_ok&#40;&#39;Template::Stash::XS&#39;&#41;;
    
diag&#40;&#34;Template version: $Template::VERSION&#34;&#41;;

# Note that only the XS stash fails..
my $tt2 = Template-&gt;new&#40; STASH =&gt; Template::Stash::XS-&gt;new &#41;;
$tt2-&gt;process&#40;
    \&#39;[% crasher&#40;&#41; %]&#39;,
    { crasher =&gt; sub { eval &#34;use Nonexistent::Class&#34; } },
&#41; or warn &#34;Failed to process..\n&#34;;

ok&#40;1, &#39;Reached end of test without crashing&#39;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-649410" href="/Public/Bug/Display.html?id=47929#txn-649410">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;17&nbsp;22:14:37&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Broken in 2.06 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-649411" href="/Public/Bug/Display.html?id=47929#txn-649411">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;17&nbsp;22:14:37&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Broken in 2.07 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-649412" href="/Public/Bug/Display.html?id=47929#txn-649412">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;17&nbsp;22:14:37&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Broken in 2.08 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-649413" href="/Public/Bug/Display.html?id=47929#txn-649413">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;17&nbsp;22:14:37&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Broken in 2.09 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-649414" href="/Public/Bug/Display.html?id=47929#txn-649414">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;17&nbsp;22:14:37&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Broken in 2.10 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-649415" href="/Public/Bug/Display.html?id=47929#txn-649415">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;17&nbsp;22:14:38&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Broken in 2.11 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-649416" href="/Public/Bug/Display.html?id=47929#txn-649416">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;17&nbsp;22:14:38&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Broken in 2.12 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-649417" href="/Public/Bug/Display.html?id=47929#txn-649417">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;17&nbsp;22:14:38&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Broken in 2.13 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-649418" href="/Public/Bug/Display.html?id=47929#txn-649418">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;17&nbsp;22:14:38&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Broken in 2.14 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-649419" href="/Public/Bug/Display.html?id=47929#txn-649419">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;17&nbsp;22:14:38&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Broken in 2.15 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-649420" href="/Public/Bug/Display.html?id=47929#txn-649420">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;17&nbsp;22:14:38&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Broken in 2.16 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-649421" href="/Public/Bug/Display.html?id=47929#txn-649421">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;17&nbsp;22:14:38&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Broken in 2.17 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-649422" href="/Public/Bug/Display.html?id=47929#txn-649422">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;17&nbsp;22:14:38&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Broken in 2.18 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-649423" href="/Public/Bug/Display.html?id=47929#txn-649423">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;17&nbsp;22:14:38&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Broken in 2.19 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-649424" href="/Public/Bug/Display.html?id=47929#txn-649424">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;17&nbsp;22:14:38&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Broken in 2.20 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-649425" href="/Public/Bug/Display.html?id=47929#txn-649425">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;17&nbsp;22:14:38&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Broken in 2.22 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-732658" href="/Public/Bug/Display.html?id=47929#txn-732658">#</a>      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;12&nbsp;02:17:16&nbsp;2010</span>
    <span class="description">mkanat [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/732658/378544/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/378544">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 146b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Any hope of a resolution on this? I just hit this while working on some 
code for Bugzilla, and I spent about five or six hours tracing this down.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-732661" href="/Public/Bug/Display.html?id=47929#txn-732661">#</a>      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;12&nbsp;02:25:12&nbsp;2010</span>
    <span class="description">TJC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/732661/378547/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/378547">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 331b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Feb 12 02:17:16 2010, MKANAT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Any hope of a resolution on this? I just hit this while working on some 
&gt; code for Bugzilla, and I spent about five or six hours tracing this 
</div>down.

I ported my code to Template::Alloy; wasn&#39;t too painful, and decent 
performance. &#40;But avoid Template::Alloy::XS, it&#39;s totally broken.&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-732847" href="/Public/Bug/Display.html?id=47929#txn-732847">#</a>      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;12&nbsp;11:22:41&nbsp;2010</span>
    <span class="description">ROBINS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/732847/378646/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/378646">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 482b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Feb 12 08:25:12 2010, TJC wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Feb 12 02:17:16 2010, MKANAT wrote:
<div class="message-stanza open">&gt; &gt; Any hope of a resolution on this? I just hit this while working on some 
&gt; &gt; code for Bugzilla, and I spent about five or six hours tracing this 
</div>&gt; down.
&gt; 
&gt; I ported my code to Template::Alloy; wasn&#39;t too painful, and decent 
&gt; performance. &#40;But avoid Template::Alloy::XS, it&#39;s totally broken.&#41;
</div>
There is a simple workaround available. Disable the XS stash and take
the performance penalty.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-756180" href="/Public/Bug/Display.html?id=47929#txn-756180">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;30&nbsp;21:16:35&nbsp;2010</span>
    <span class="description">mkanat [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/756180/391004/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/391004">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 318b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">  Okay, so, again--any hope of an actual fix for this issue? Telling 
10,000+ Bugzilla installations that they just have to suck up being slow 
to work around a critical but not-all-affecting bug would be pretty lame. 
I keep getting reports that this bug causes varying parts of Bugzilla to 
break for various people.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-764073" href="/Public/Bug/Display.html?id=47929#txn-764073">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;16&nbsp;01:21:12&nbsp;2010</span>
    <span class="description">TJC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/764073/395323/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/395323">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 900b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Feb 12 11:22:41 2010, ROBINS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Feb 12 08:25:12 2010, TJC wrote:
<div class="message-stanza open">&gt; &gt; I ported my code to Template::Alloy; wasn&#39;t too painful, and decent 
&gt; &gt; performance. &#40;But avoid Template::Alloy::XS, it&#39;s totally broken.&#41;
</div>&gt; 
&gt; There is a simple workaround available. Disable the XS stash and take
&gt; the performance penalty.
</div>

Template::Alloy was quicker than Template::Toolkit with non-XS stash 
though. &#40;At least in the real-world benchmarks I was doing with our 
code.&#41;


I&#39;d also suggest that the build-time question of &#34;Do you want to use the 
XS stash by default?&#34; should be forced to &#34;No&#34;, until such time as this 
bug is fixed.

People who actually need the performance of XS can then evaluate the 
risks, and then test and enable it on a selective basis.
To leave a known-bad thing enabled by default simply because it is 
faster sounds like premature optimisation to me.

Cheers,
Toby
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-839607" href="/Public/Bug/Display.html?id=47929#txn-839607">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;05&nbsp;10:08:29&nbsp;2010</span>
    <span class="description">perl-cpan [...] bereft.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/839607/434822/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/434822">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jul 21 09:10:09 2009, ABW wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/abw/TT-XS-Stash-DateTime/tree/master">http://github.com/abw/TT-XS-Stash-DateTime/tree/master</a></span>
</div>
I&#39;ve looked into this some more and:
  eval &#34;BEGIN { die &#39;compile time die&#39; }&#34;
seems to reproduce the issue also:

 <span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/bowman/TT-XS-Stash-DateTime">http://github.com/bowman/TT-XS-Stash-DateTime</a></span>

&#40;I should mention that from here on I&#39;m just stumbling around
and don&#39;t have much of a clue&#41;

Using call_pv &#40;a call_sv wrapper&#41; from a little C program
in the same way as the XS Stash results in a crash, although
it does have a message &#34;panic: top_env&#34; error.  &#34;panic&#34; is bad.
&#40;see call.c &#38; call.pl attached&#41;

Adding the G_EVAL flag &#40;describe in perlcall&#41; to the call_{pv,sv}
calls seems to trap these errors and prevent the code bombing out.
I tried adding G_EVAL to TT2 version 2.22 but it did cause some test
failures related to exception handling.  This seems to be more
of a work-around than a fix, as the error should already have been
contained by the string eval, right?

I&#39;m not certain my test really does reflect what is happening
in TT2, does it look right?
Where does it look like the bug is?  I&#39;m starting to think Perl,
but it could easily be something else.
What versions of Perl are effected?  5.10.1 for me, but I&#39;ll try others.
Is this really is a 64bit issue only?

There&#39;s been some very recent commits that look like they may be
relevant:

<span class="clickylink"><a target="new" rel="nofollow" href="http://www.nntp.perl.org/group/perl.perl5.changes/2010/10/msg27575.html">http://www.nntp.perl.org/group/perl.perl5.changes/2010/10/msg27575.html</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/greerga/perl/commit/4aca2f62efca883199d7975f34b7fb876c280366">http://github.com/greerga/perl/commit/4aca2f62efca883199d7975f34b7fb876c280366</a></span>

I&#39;m going to keep looking at this on and off, but wanted to post
what I have so far,

Brad
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> call.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/839607/434823/call.pl">Download call.pl</a><br />
<span class="downloadcontenttype">text/x-perl 855b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"># see call.c
use strict;
use warnings;

sub test_use_fail {
    warn __FILE__, &#34;: &#34;, __LINE__, &#34;\n&#34;;
    eval &#34;use NonExistent;&#34;;
    warn &#34; \$@ is &lt;$@&gt;\n&#34;;
}

sub test_eval_begin_die {
    warn __FILE__, &#34;: &#34;, __LINE__, &#34;\n&#34;;
    eval &#34;BEGIN { die &#39;compile time die&#39; }&#34;;
    warn &#34; \$@ is &lt;$@&gt;\n&#34;;
}

sub test_eval_syntax {
    warn __FILE__, &#34;: &#34;, __LINE__, &#34;\n&#34;;
    eval &#34;/syntax&#34;;
    warn &#34; \$@ is &lt;$@&gt;\n&#34;;
}

# the following are all ok

sub test_eval_begin_eval_die {
    warn __FILE__, &#34;: &#34;, __LINE__, &#34;\n&#34;;
    eval &#34;BEGIN { eval { die &#39;compile time die&#39; } }&#34;;
    warn &#34; \$@ is &lt;$@&gt;\n&#34;;
}

sub test_eval_end_die {
    warn __FILE__, &#34;: &#34;, __LINE__, &#34;\n&#34;;
    eval &#34;END { die &#39;end time die&#39; }&#34;;
    warn &#34; \$@ is &lt;$@&gt;\n&#34;;
}

sub test_eval_die {
    warn __FILE__, &#34;: &#34;, __LINE__, &#34;\n&#34;;
    eval &#34;die &#39;run time die&#39;&#34;;
    warn &#34; \$@ is &lt;$@&gt;\n&#34;;
}
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> call.c</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/839607/434824/call.c">Download call.c</a><br />
<span class="downloadcontenttype">text/x-csrc 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">/*
 cc `perl -MExtUtils::Embed -e ccopts -e ldopts` -g call.c -o call &#38;&#38; ./call

 for s in `perl -nle &#39;print $1 if /sub &#40;\w+&#41;/&#39; call.pl`; \
   do if ./call $s 2&gt; /dev/null; then echo &#34;$s PASS&#34;; else echo &#34;$s FAIL&#34;; fi;\
 done

 test_use_fail FAIL
 test_eval_begin_die FAIL
 test_eval_syntax FAIL
 test_eval_begin_eval_die PASS
 test_eval_end_die PASS
 test_eval_die PASS

 */
#include &lt;stdio.h&gt;

#include &lt;EXTERN.h&gt;
#include &lt;perl.h&gt;

static PerlInterpreter *my_perl;

main &#40;int argc, char **argv, char **env&#41;
{
    char *embedding[] = { &#34;&#34;, &#34;call.pl&#34; };
    char *default_sub = &#34;test_eval_begin_die&#34;;
    char *call_sub = &#40;argc &gt; 1&#41; ? argv[1] : default_sub;

    fprintf&#40;stderr, &#34;Hello &#40;successful end is Goodbye&#41;\n&#34;&#41;;

    PERL_SYS_INIT3&#40;&#38;argc,&#38;argv,&#38;env&#41;;
    my_perl = perl_alloc&#40;&#41;;
    perl_construct&#40; my_perl &#41;;

    perl_parse&#40;my_perl, NULL, 3, embedding, NULL&#41;;
    PL_exit_flags |= PERL_EXIT_DESTRUCT_END;
    perl_run&#40;my_perl&#41;;

    fprintf&#40;stderr, &#34;calling %s with G_EVAL | G_KEEPERR\n&#34;, call_sub&#41;;
    call_pv&#40;call_sub, G_DISCARD | G_NOARGS | G_EVAL | G_KEEPERR&#41;;
    fprintf&#40;stderr, &#34; $@ = %s\n\n&#34;, SvPV_nolen&#40;ERRSV&#41;&#41;;

    fprintf&#40;stderr, &#34;calling %s with no G*\n&#34;, call_sub&#41;;
    call_pv&#40;call_sub, G_DISCARD | G_NOARGS&#41;;
    fprintf&#40;stderr, &#34; $@ = %s\n\n&#34;, SvPV_nolen&#40;ERRSV&#41;&#41;;

    perl_destruct&#40;my_perl&#41;;
    perl_free&#40;my_perl&#41;;
    PERL_SYS_TERM&#40;&#41;;

    fprintf&#40;stderr, &#34;Goodbye\n&#34;&#41;;
    exit&#40;0&#41;;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-839618" href="/Public/Bug/Display.html?id=47929#txn-839618">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;05&nbsp;10:25:58&nbsp;2010</span>
    <span class="description">perl-cpan [...] bereft.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/839618/434831/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/434831">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 684b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Oct 05 10:08:29 2010, BOWMANBS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; There&#39;s been some very recent commits that look like they may be
&gt; relevant:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.nntp.perl.org/group/perl.perl5.changes/2010/10/msg27575.html">http://www.nntp.perl.org/group/perl.perl5.changes/2010/10/msg27575.html</a></span>
&gt;
</div><span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/greerga/perl/commit/4aca2f62efca883199d7975f34b7fb876c280366">http://github.com/greerga/perl/commit/4aca2f62efca883199d7975f34b7fb876c280366</a></span>

Looks like my call.* tests work in blead perl, although I haven&#39;t
tried the TT2 test yet &#40;I need to work out how to&#41;.

$ for s in `perl -nle &#39;print $1 if /sub &#40;\w+&#41;/&#39; call.pl`; do if ./call
$s 2&gt; /dev/null; then echo &#34;$s PASS&#34;; else echo &#34;$s FAIL&#34;; fi; done
test_use_fail PASS
test_eval_begin_die PASS
test_eval_syntax PASS
test_eval_begin_eval_die PASS
test_eval_end_die PASS
test_eval_die PASS

Brad
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-839786" href="/Public/Bug/Display.html?id=47929#txn-839786">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;05&nbsp;19:11:33&nbsp;2010</span>
    <span class="description">perl-cpan [...] bereft.net -  Requestor BOWMANBS added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-839818" href="/Public/Bug/Display.html?id=47929#txn-839818">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;05&nbsp;20:57:03&nbsp;2010</span>
    <span class="description">TJC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/839818/434933/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/434933">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 333b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Oct 05 10:08:29 2010, BOWMANBS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; What versions of Perl are effected?  5.10.1 for me, but I&#39;ll try
&gt; others.
&gt; Is this really is a 64bit issue only?
</div>
I have reproduced my original bug on several combinations of perl and 32/64bit 
architectures:
Perl 5.8.8 i386
Perl 5.10.1 i386
Perl 5.10.1 AMD64
Perl 5.12.1 AMD64

-Toby
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-905654" href="/Public/Bug/Display.html?id=47929#txn-905654">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;02&nbsp;00:34:55&nbsp;2011</span>
    <span class="description">TJC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/905654/469803/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/469803">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 83b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I note that the bug is still present in Perl 5.12.2.

Will test in 5.12.3 shortly..
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-905657" href="/Public/Bug/Display.html?id=47929#txn-905657">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;02&nbsp;00:43:40&nbsp;2011</span>
    <span class="description">TJC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/905657/469806/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/469806">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 46b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Tested on Perl 5.12.3, test still crashes out.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1021943" href="/Public/Bug/Display.html?id=47929#txn-1021943">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;13&nbsp;11:27:51&nbsp;2012</span>
    <span class="description">cpan [...] wardley.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1021943/532988/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/532988">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 281b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I believe this is now fixed.

<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/abw/Template2/commit/cb1d793924ac105c188c2a573b7233621a6c5e24">https://github.com/abw/Template2/commit/cb1d793924ac105c188c2a573b7233621a6c5e24</a></span>

Tested on Perl 5.10.0 and Perl 5.12.3.  All test pass, including a new test in t/stash-xs.t which 
tickles the bug.  The test fails without the patch and passes with it.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1021946" href="/Public/Bug/Display.html?id=47929#txn-1021946">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;13&nbsp;11:27:52&nbsp;2012</span>
    <span class="description">cpan [...] wardley.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 1.445746</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
