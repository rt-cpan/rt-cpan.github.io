<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #12038 for BerkeleyDB: request for enhancements to version 0.26</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #12038 for BerkeleyDB: request for enhancements to version 0.26</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/BerkeleyDB/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/BerkeleyDB/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/BerkeleyDB/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/BerkeleyDB/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/BerkeleyDB">BerkeleyDB CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">12038</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/BerkeleyDB/Active/">BerkeleyDB</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">pmqs [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
barborak [...] basikgroup.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-3650-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-3651-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




patches.tar.gz<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/127820/33013/patches.tar.gz">
Mon Mar 28 13:58:42 2005 (1.9k) by 
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;28&nbsp;13:58:42&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> request for enhancements to version 0.26</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">In building my BerkeleyDB application, I have made a few enhancements to the BerkeleyDB Perl module. Perhaps you would consider adding them to the standard package? It would be great for me and perhaps useful for others as well.

Thanks,
Mike

* Support for the panic callback.

This is useful in detecting when the environment might need recovery. In the patch, setting the callback is done with an argument to the new method of the BerkeleyDB::Env package. Then in the XS file when the environment is opened, the callback is stored in the BerkeleyDB_ENV_type data structure and the BerkeleyDB API DB_ENV-&gt;set_paniccall is called to register the new function env_paniccall as the panic callback. Also, in the environment&#39;s app_private variable &#40;provided by the BerekeleyDB API to store application-specific data along with it&#39;s data structure&#41; is stored a pointer to the Perl BerkeleyDB environment object. So on a database panic, env_paniccall is called. It pushes a pointer to the Perl BerkeleyDB environment object &#40;from the app_private variable&#41; and the error value on to the stack. It then calls the registered Perl callback.

To use the callback feature then, you first open the environment someway like this:

$dbEnv = BerkeleyDB::Env-&gt;new &#40;
        ...
        -PanicCall      =&gt; \&#38;panicCall
&#41;;

where panicCall is defined perhaps like this:

sub panicCall
{
        my $dbEnv  = shift;
        my $errVal = shift;

        my $envSettings = $dbEnv-&gt;get_settings &#40; &#41;;
        my $dbEnvPath = $envSettings-&gt;{ home };
        my $dbLock = synchronizeDB &#40; undef, $dbEnvPath &#41;; # One process at a time.
        setRecoveryFlag &#40; $dbEnvPath, $dbInRecovery ? 2 : 1 &#41;;
        synchronizeDB &#40; $dbLock, $dbEnvPath &#41; if $dbLock;
        
        exit &#40; 1 &#41;;
}

* New method to get the settings of an environment.

When dealing with multiple environments at once, it is necessary to have a way to differentiate one from another via an environment pointer. For example, in the panicCall callback in the example above, it is necessary to be able to retrieve some settings about the environment in order to know in which one the database panic occurred. To support that there is a new method defined in the BerkeleyDB::Env package in BerkeleyDB.xs called get_settings. It returns a hash reference with the home path of the environment &#40;with key &#34;home&#34;&#41; and the flags &#40;with key &#34;flags&#34;&#41; used when opening the environment. To support this method there is a new helper function call hv_store_pv. &#40;This function is really just the BerkeleyDB APIs DB_ENV-&gt;get_home and DB_ENV-&gt;get_open_flags rolled up into one. In hindsight, I would have simply added these two methods rather than inventing this new one.&#41;

* Support for setting environment and transaction timeouts.

To avoid deadlocks from tying up the system, it is useful to have the DB_ENV-&gt;set_timeout and DB_TXN-&gt;set_timeout APIs. Two new methods were added to the BerkeleyDB::Env package in BerkeleyDB.xs to support this.

* Support ability to remove an environment.

To be able to delete an environment, it is useful to have the DB_ENV-&gt;remove API. A new method was added to the BerkeleyDB::Env package in BerkeleyDB.xs to support this.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/127820/33013/patches.tar.gz">Download patches.tar.gz</a><br />
<span class="downloadcontenttype">application/x-gzip 1.9k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;30&nbsp;08:01:13&nbsp;2005</span>
    <span class="description">pmqs [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Mike,

many thanks for the patch. 

I&#39;m a bit snowed under with &#40;real&#41; work at the moment, but once I get a
chance to review what you&#39;ve sent me I will certainly merge your changes
into my development copy. Whether the inferface you picked for each of
your changes remains exactly the same once I&#39;ve merged it remains to be
seen -- the important thing is that the the new features will be available.

One thing I&#39;ll probably do is drop your get_settings in favour of
providing an interface to get_home and get_open_flags as you suggest
yourself.

cheers and thanks again
Paul
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;30&nbsp;08:02:17&nbsp;2005</span>
    <span class="description">pmqs [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;13&nbsp;14:19:22&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I hear you about being snowed under and appreciate the serious amount of
time you&#39;ve obviously put into this module. Along the lines of
enhancements, I have another selfish request for a rather obscure API.
This time, it&#39;s for lsn_reset. My desire for it is based on the advice
given by Keith Bostic in this thread:

<span class="clickylink"><a target="new" rel="nofollow" href="http://groups-beta.google.com/group/comp.databases.berkeley-db/browse_thread/thread/13a3ec4f3afa28b2/6658ed4eb06589a3#6658ed4eb06589a3">http://groups-beta.google.com/group/comp.databases.berkeley-db/browse_thread/thread/13a3ec4f3afa28b2/6658ed4eb06589a3#6658ed4eb06589a3</a></span>

If you&#39;re interested, this is the code I added to the BerkeleyDB::Env
module of BerkeleyDB.xs version 0.26 to support this API:

int
lsn_reset&#40;env, file, flags&#41;
        BerkeleyDB::Env env
        char * file
        u_int32_t flags
        INIT:
            ckActive_Environment&#40;env-&gt;active&#41; ;
        CODE:
        {
#ifndef AT_LEAST_DB_4_3
            softCrash&#40;&#34;$env-&gt;lsn_reset needs Berkeley DB 4.3 or better&#34;&#41; ;
#else
                RETVAL = env-&gt;Status = env-&gt;Env-&gt;lsn_reset&#40;env-&gt;Env, file, flags&#41;;
#endif
        }
        OUTPUT:
            RETVAL

Note that Keith&#39;s documentation for this API calls for the file
parameter to be a const char * &#40;which seems right&#41; but db.h has it as
just a char *.

Thanks again!
Mike
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;13&nbsp;20:29:46&nbsp;2005</span>
    <span class="description">pmqs [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Mike,

thanks for the patch. Once the snow melts a bit, I will add this to my 
development copy.

cheers
Paul

[guest - Fri May 13 14:19:22 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I hear you about being snowed under and appreciate the serious amount
&gt; of
&gt; time you&#39;ve obviously put into this module. Along the lines of
&gt; enhancements, I have another selfish request for a rather obscure API.
&gt; This time, it&#39;s for lsn_reset. My desire for it is based on the advice
&gt; given by Keith Bostic in this thread:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://groups-beta.google.com/group/comp.databases.berkeley-">http://groups-beta.google.com/group/comp.databases.berkeley-</a></span>
&gt; 
</div>db/browse_thread/thread/13a3ec4f3afa28b2/6658ed4eb06589a3#6658ed4eb06589
a3
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; If you&#39;re interested, this is the code I added to the BerkeleyDB::Env
&gt; module of BerkeleyDB.xs version 0.26 to support this API:
&gt; 
&gt; int
&gt; lsn_reset&#40;env, file, flags&#41;
&gt;       BerkeleyDB::Env env
&gt;       char * file
&gt;       u_int32_t flags
&gt;       INIT:
&gt;           ckActive_Environment&#40;env-&gt;active&#41; ;
&gt;       CODE:
&gt;       {
&gt; #ifndef AT_LEAST_DB_4_3
&gt;           softCrash&#40;&#34;$env-&gt;lsn_reset needs Berkeley DB 4.3 or 
</div>better&#34;&#41; ;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; #else
&gt;               RETVAL = env-&gt;Status = env-&gt;Env-&gt;lsn_reset&#40;env-&gt;Env, 
</div>file, flags&#41;;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; #endif
&gt;       }
&gt;       OUTPUT:
&gt;           RETVAL
&gt; 
&gt; Note that Keith&#39;s documentation for this API calls for the file
&gt; parameter to be a const char * &#40;which seems right&#41; but db.h has it as
&gt; just a char *.
&gt; 
&gt; Thanks again!
&gt; Mike
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;04&nbsp;08:26:59&nbsp;2007</span>
    <span class="description">pmqs [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;28&nbsp;16:27:34&nbsp;2007</span>
    <span class="description">pmqs [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
