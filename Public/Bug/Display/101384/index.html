<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #101384 for Net-LDAP-SimpleServer: Enhancement request: add support for referrals and references</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #101384 for Net-LDAP-SimpleServer: Enhancement request: add support for referrals and references</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-LDAP-SimpleServer/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-LDAP-SimpleServer/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-LDAP-SimpleServer/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-LDAP-SimpleServer/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-LDAP-SimpleServer">Net-LDAP-SimpleServer CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">101384</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-LDAP-SimpleServer/Active/">Net-LDAP-SimpleServer</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">RUSSOZ [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ipuleston [...] SonicWALL.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-235170-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.0.17    </td>
  </tr>
  <tr id="CF-235171-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;07&nbsp;14:35:13&nbsp;2015</span>
    <span class="description">http://facebook-openid.appspot.com/ian.puleston.5 -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Enhancement request: add support for referrals and references</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am using Net::LDAP::SimpleServer as a back-end server for testing of an LDAP client, and one of the features of the latter that I need to test is following referrals and references returned from the server. That is not currently supported by this module but it is I think a useful feature to have here, so this is an enhancement request to add it, with a patch for that.

This patch enables returning references and/or referrals based on standard &#34;named subordinate reference&#34; entries in the data store &#40;entries with objectClass &#39;referral&#39; and one or more &#39;ref&#39; attributes giving the referral URIs - as per RFC 3296 section 2&#41;.

In regard to when to return a referral result, RFC 4511 says &#34;the referral result code indicates that the contacted server cannot or will not perform the operation and that one or more other servers may be able to&#34; and that reasons for this include &#34;The target entry of the request is not held locally, but the server has knowledge of its possible existence elsewhere&#34;. So to try to follow that within the scope of how this Net::LDAP::SimpleServer module operates, my patch returns them as follows:

If the search found nothing &#40;other than referral entries&#41; and a baseObject was given and that matches a referral entry or falls in sub-tree scope under one,
and there is no non-referral entry for the baseObject, then an LDAP_REFERRAL result is returned with the URI&#40;s&#41; from that referral entry.

Otherwise, if there are any referral entries in the search scope then references are returned for those, inserting searchResRef entries into the search results in addition to any search results from matching other entries in the data store. Note that for this Net::LDAP::Reference objects are returned to Net::LDAP::Server from search&#40;&#41;.

The patch is attached - note that it requires the patch from issues 101365 &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=101365&#41;">https://rt.cpan.org/Public/Bug/Display.html?id=101365&#41;</a></span> and 101382 &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=101382&#41;">https://rt.cpan.org/Public/Bug/Display.html?id=101382&#41;</a></span> to be applied first. To apply the patch during installation, after unpacking Net-LDAP-SimpleServer-0.0.17.tar.gz, cd into the Net-LDAP-SimpleServer-0.0.17 directory and type:

- patch -p1 &lt;path-to-it/add-srch-scope.patch &#40;see issue 101365&#41;
- patch -p1 &lt;path-to-it/add-user-pwds.patch &#40;see issue 101382&#41;
- patch -p1 &lt;path-to-it/add-refs.patch

Then continue the install as normal.

For references &#40;not referrals&#41; this also requires the fix for issue 101261 be applied in Net::LDAP::Server.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> add-refs.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -Naur Net-LDAP-SimpleServer-0.0.17-3/lib/Net/LDAP/SimpleServer/ProtocolHandler.pm Net-LDAP-SimpleServer-0.0.17/lib/Net/LDAP/SimpleServer/ProtocolHandler.pm
--- Net-LDAP-SimpleServer-0.0.17-3/lib/Net/LDAP/SimpleServer/ProtocolHandler.pm	2015-01-07 11:01:32.627040224 -0800
+++ Net-LDAP-SimpleServer-0.0.17/lib/Net/LDAP/SimpleServer/ProtocolHandler.pm	2015-01-07 11:24:59.970168693 -0800
@@ -18,7 +18,8 @@
 
 use Net::LDAP::Constant &#40;
     qw/LDAP_SUCCESS LDAP_AUTH_UNKNOWN LDAP_INVALID_CREDENTIALS/,
-    qw/LDAP_AUTH_METHOD_NOT_SUPPORTED/ &#41;;
+    qw/LDAP_AUTH_METHOD_NOT_SUPPORTED/,
+    qw/LDAP_REFERRAL/ &#41;;
 
 use Scalar::Util qw{reftype};
 use UNIVERSAL::isa;
@@ -30,11 +31,18 @@
     my $dn   = shift || &#39;&#39;;
     my $msg  = shift || &#39;&#39;;
 
-    return {
+    my $result = {
         matchedDN    =&gt; $dn,
         errorMessage =&gt; $msg,
-        resultCode   =&gt; $code,
+        resultCode   =&gt; $code
     };
+
+    if &#40;$code == LDAP_REFERRAL&#41; {
+        my $rfrl = shift;
+        $result-&gt;{referral} = $rfrl;
+    }
+
+    return $result;
 }
 
 sub new {
@@ -198,6 +206,86 @@
     return $vals;
 }
 
+sub _has_class {
+    my &#40; $elem, $class &#41; = @_;
+
+    my $classes = _get_attr&#40;$elem, &#39;objectClass&#39;&#41;;
+    if &#40;$classes&#41; {
+        foreach my $cl &#40;@{$classes}&#41; {
+            return 1 if &#40;uc&#40;$cl&#41; eq uc&#40;$class&#41;&#41;;
+        }
+    }
+
+    return 0;
+}
+
+sub _check_refs {
+    my &#40; $self, $list, $res, $basedn &#41; = @_;
+
+    # This takes care of returning referrals or references based on &#34;named
+    # subordinate reference&#34; entries in the data store &#40;see RFC 3296 section 2&#41;
+    # as follows:
+    #  - if the search found nothing &#40;other than ref entries&#41; and a baseObject
+    #    is given and that matches a ref entry or falls in sub-tree scope
+    #    under one, and there is no non-ref entry for the baseObject, then an
+    #    LDAP_REFERRAL result is returned with the URIs from that ref entry.
+    #  - otherwise, if there are any reference entries in the search scope
+    #    then searchResRef &#40;Net::LDAP::Reference&#41; entries for them are
+    #    inserted into the results to return.
+
+    my $refs_filter = Net::LDAP::Filter-&gt;new&#40;&#34;&#40;&#38;&#40;objectClass=referral&#41;&#40;ref=*&#41;&#41;&#34;&#41;;
+    my $refs = _match&#40; $refs_filter, $list &#41;;
+    my $rfrl = 0;
+    my $result = 0;
+    if &#40;$#{$refs} == $#{$list}&#41; {
+        # The search found nothing other then ref entries,
+        # so should we return a referral?
+        if &#40;defined&#40;$basedn&#41;&#41; {
+            my $base = _find&#40;$basedn, $self-&gt;{store}-&gt;list&#41;;
+            if &#40;$base &#38;&#38; _has_class&#40;$base, &#39;referral&#39;&#41;&#41; {
+                $refs = [ $base ];
+                $rfrl = 1;
+            } elsif &#40;!$base&#41; {
+                my $all_refs = _match&#40;$refs_filter, $self-&gt;{store}-&gt;list&#41;;
+                my @use_refs = &#40;&#41;;
+                foreach my $ref &#40;@{$all_refs}&#41; {
+                    if &#40;_in_scope&#40;uc&#40;$basedn&#41;, uc&#40;$ref-&gt;{asn}-&gt;{objectName}&#41;, &#39;subTree&#39;&#41;&#41; {
+                        push&#40;@use_refs, $ref&#41;;
+                    }
+                }
+                if &#40;scalar&#40;@use_refs&#41; &gt; 0&#41; {
+                    $refs = \@use_refs;
+                    $rfrl = 1;
+                }
+            }
+        }
+    }
+    if &#40;$rfrl&#41; {
+        # Will return a referral: collect the URIs
+        my @ref_uris = &#40;&#41;;
+        foreach my $ref &#40;@{$refs}&#41; {
+            my $ref_vals = _get_attr&#40;$ref, &#39;ref&#39;&#41;;
+            if &#40;$ref_vals &#38;&#38; scalar&#40;@{$ref_vals}&#41; &gt; 0&#41; {
+                push&#40;@ref_uris, @{$ref_vals}&#41;;
+            }
+        }
+        if &#40;scalar&#40;@ref_uris&#41; &gt; 0&#41; {
+            $result = _make_result&#40;LDAP_REFERRAL, &#34;&#34;, &#34;&#34;, \@ref_uris&#41;;
+        }
+    } else {
+        # Add in a reference entry for any refs in the search scope
+        foreach my $ref &#40;@{$refs}&#41; {
+            my $ref_vals = _get_attr&#40;$ref, &#39;ref&#39;&#41;;
+            if &#40;$ref_vals &#38;&#38; scalar&#40;@{$ref_vals}&#41; &gt; 0&#41; {
+                my $ref_entry = { &#39;asn&#39; =&gt; $ref_vals };
+                push&#40;@{$res}, bless $ref_entry, &#39;Net::LDAP::Reference&#39;&#41;;
+            }
+        }
+    }
+
+    return $result;
+}
+
 sub search {
     my &#40; $self, $request &#41; = @_;
 
@@ -252,6 +340,13 @@
         }
     }
 
+    # Check for references in the list &#40;filtered on $basedn/$scope&#41; from LDIF:
+    my $rslt = _check_refs&#40;$self, $list, $res, $basedn&#41;;
+    if &#40;$rslt &#38;&#38; $rslt-&gt;{resultCode} == LDAP_REFERRAL&#41; {
+        print STDERR &#34;Referral: &#34; . Dumper&#40;$rslt&#41;;
+        return $rslt;
+    }
+
     #print STDERR Dumper&#40;$res&#41;;
 
     return &#40; _make_result&#40;LDAP_SUCCESS&#41;, @{$res} &#41;;
@@ -318,6 +413,33 @@
 The search filter, baseObject and scope are supported, with other search fields
 currently being ignored.
 
+Referrals and references are supported via referral entries in the data store,
+as follows:
+
+=over 4
+
+=item *
+
+The reference/referral entry must have objectClass &#39;referral&#39; and one or more
+&#39;ref&#39; attributes giving the referral URIs &#40;as per RFC 3296 section 2&#41;.
+
+=item *
+
+If the search found nothing &#40;other than referral entries&#41; and a baseObject was
+given and that matches a referral entry or falls in sub-tree scope under one,
+and there is no non-referral entry for the baseObject, then an LDAP_REFERRAL
+result is returned with the URI&#40;s&#41; from that referral entry.
+
+=item *
+
+Otherwise, if there are any referral entries in the search scope then
+references are returned for those, inserting searchResRef entries into the
+search results in addition to any search results from matching other entries
+in the data store. Note that for this L&lt;Net::LDAP::Reference&gt; objects are
+returned to L&lt;Net::LDAP::Server&gt; from search&#40;&#41;.
+
+=back
+
 =head1 SEE ALSO
 
 Please see those modules/websites for more information related to this module.
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;15&nbsp;16:05:21&nbsp;2015</span>
    <span class="description">ipuleston [...] SonicWALL.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #101384]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 15 Jan 2015 12:55:37 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Bugs in Net-LDAP-SimpleServer via RT &lt;bug-Net-LDAP-SimpleServer [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ian Puleston &lt;ipuleston [...] SonicWALL.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have attached an additional patch, to be applied after the above patch, that improves the update. This additional change avoids it returning multiple redundant nested references when the data file contains nested ref entries &#40;which can be necessary to provoke specific referrals&#41;.
</div></div>

<div class="messagebody">
</div>
</div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;07&nbsp;02:28:01&nbsp;2017</span>
    <span class="description">RUSSOZ [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;06&nbsp;02:28:11&nbsp;2017</span>
    <span class="description">RUSSOZ [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
