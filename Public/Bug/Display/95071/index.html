<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #95071 for POE-Component-SSLify: CPU pinned at 100% with SSLify and POE::Component::Server::TCP</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #95071 for POE-Component-SSLify: CPU pinned at 100% with SSLify and POE::Component::Server::TCP</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/POE-Component-SSLify/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/POE-Component-SSLify/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/POE-Component-SSLify/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/POE-Component-SSLify/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/POE-Component-SSLify">POE-Component-SSLify CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">95071</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/POE-Component-SSLify/Active/">POE-Component-SSLify</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jhuckaby [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-26666-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-26667-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;26&nbsp;12:20:58&nbsp;2014</span>
    <span class="description">jhuckaby [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> CPU pinned at 100% with SSLify and POE::Component::Server::TCP</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 26 Apr 2014 09:20:44 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE-Component-SSLify [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Joseph Huckaby &lt;jhuckaby [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hey SSLify Team,

I believe I have found a bug using POE::Component::Server::TCP and SSLify.  I have a very simple HTTPS web server &#40;created using the cookbook example&#41;, which does nothing except serve up 300K of plain text for every incoming HTTPS GET request.  This works fine until it receives multiple requests at once.  Then it shoots up to 100% CPU and stays there indefinitely, long after the requests have completed.

Here is a snapshot of &#34;top&#34; on my server after sending in 10 simultaneous requests and allowing them to complete fully:

 PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
1365 root      20   0  191m  20m 4168 R 99.9  0.6   0:10.95 perl

The CPU stays at or around 99.9% indefinitely &#40;I have witnessed several days at least&#41;.  Also, something to note, even after the CPU is pinned at 100%, the server still accepts new incoming connections, and serves them.

Here is a ZIP file containing my script and sample SSL cert:
<span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug.zip">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug.zip</a></span>

Here are links to the individual files:
<span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/server.pl">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/server.pl</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.crt">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.crt</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.key">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.key</a></span>

I can reproduce the issue every time by sending in 10 simultaneous HTTPS GET requests from a shell script such as this:

#!/bin/sh
# Fetch URL 10 times simultaneously
curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;

The --insecure flag is to prevent curl from validating the cert &#40;which is self-signed&#41;.

I am running:
POE version 1.358
POE::Component::SSLify version 1.008

This is perl 5, version 16, subversion 3 &#40;v5.16.3&#41; built for x86_64-linux-thread-multi
Linux pvp.effectgames.com 3.4.82-69.112.amzn1.x86_64 #1 SMP Mon Feb 24 16:31:21 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux

openssl-perl-1.0.1g-1.69.amzn1.x86_64
openssl-1.0.1g-1.69.amzn1.x86_64

Other Notes: I cannot reproduce this without SSLify.  Meaning, if I strip out all the SSL code and just run a plain HTTP server, everything works fine.  Also note that I cannot seem to reproduce this on my local OS X machine hitting localhost, although I suspect that is because localhost is a virtual interface, and all the requests complete &#34;instantly&#34;.  This bug seems to require a slower network &#40;DSL to Amazon EC2 for example&#41; to occur.

If there is anything else you&#39;d like me to try, please let me know.  My server is at your disposal!

Thanks for your time!

- Joe
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;11&nbsp;19:45:21&nbsp;2014</span>
    <span class="description">APOCAL [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

  Thanks for this report! I appreciate the work you put in to make a testcase that I could look at :&#41; Again, I apologize for the delay in getting back to you! I&#39;ve just released v1.009 to CPAN with additional tests. Here&#39;s the good and the bad:

  I was able to reproduce your problem, please look at t/simple_superbig.t and t/simple_parallel_superbig.t which locks up on my machine too. &#40;Ubuntu Trusty x64&#41; The issue seems to be a buffer size limitation somewhere in the stack. The t/simple_large.t test passes nicely while the superbig one blows up. It&#39;s interesting because RT#58243 mentioned the same problem with large response sizes. I hope we are on to something!

  I wasn&#39;t able to fix the problem and will get back to it later this week. Can you please run the tests and let me know if the superbig ones lock up on your box too? Thanks again!

On Sat Apr 26 12:20:58 2014, jhuckaby@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hey SSLify Team,
&gt; 
&gt; I believe I have found a bug using POE::Component::Server::TCP and
&gt; SSLify.  I have a very simple HTTPS web server &#40;created using the
&gt; cookbook example&#41;, which does nothing except serve up 300K of plain
&gt; text for every incoming HTTPS GET request.  This works fine until it
&gt; receives multiple requests at once.  Then it shoots up to 100% CPU and
&gt; stays there indefinitely, long after the requests have completed.
&gt; 
&gt; Here is a snapshot of &#34;top&#34; on my server after sending in 10
&gt; simultaneous requests and allowing them to complete fully:
&gt; 
&gt; PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
&gt; 1365 root      20   0  191m  20m 4168 R 99.9  0.6   0:10.95 perl
&gt; 
&gt; The CPU stays at or around 99.9% indefinitely &#40;I have witnessed
&gt; several days at least&#41;.  Also, something to note, even after the CPU
&gt; is pinned at 100%, the server still accepts new incoming connections,
&gt; and serves them.
&gt; 
&gt; Here is a ZIP file containing my script and sample SSL cert:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug.zip">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug.zip</a></span>
&gt; 
&gt; Here are links to the individual files:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-</a></span>
&gt; bug/server.pl
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.crt">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.crt</a></span>
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.key">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.key</a></span>
&gt; 
&gt; I can reproduce the issue every time by sending in 10 simultaneous
&gt; HTTPS GET requests from a shell script such as this:
&gt; 
&gt; #!/bin/sh
&gt; # Fetch URL 10 times simultaneously
&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; 
&gt; The --insecure flag is to prevent curl from validating the cert &#40;which
&gt; is self-signed&#41;.
&gt; 
&gt; I am running:
&gt; POE version 1.358
&gt; POE::Component::SSLify version 1.008
&gt; 
&gt; This is perl 5, version 16, subversion 3 &#40;v5.16.3&#41; built for x86_64-
&gt; linux-thread-multi
&gt; Linux pvp.effectgames.com 3.4.82-69.112.amzn1.x86_64 #1 SMP Mon Feb 24
&gt; 16:31:21 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux
&gt; 
&gt; openssl-perl-1.0.1g-1.69.amzn1.x86_64
&gt; openssl-1.0.1g-1.69.amzn1.x86_64
&gt; 
&gt; Other Notes: I cannot reproduce this without SSLify.  Meaning, if I
&gt; strip out all the SSL code and just run a plain HTTP server,
&gt; everything works fine.  Also note that I cannot seem to reproduce this
&gt; on my local OS X machine hitting localhost, although I suspect that is
&gt; because localhost is a virtual interface, and all the requests
&gt; complete &#34;instantly&#34;.  This bug seems to require a slower network &#40;DSL
&gt; to Amazon EC2 for example&#41; to occur.
&gt; 
&gt; If there is anything else you&#39;d like me to try, please let me know.
&gt; My server is at your disposal!
&gt; 
&gt; Thanks for your time!
&gt; 
&gt; - Joe
</div>

-- 
~Apocalypse
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;11&nbsp;19:45:22&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;12&nbsp;01:22:50&nbsp;2014</span>
    <span class="description">APOCAL [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hey,

  I had some luck and found some information that pointed towards a 16K limitation in the TLS packet sizes. It seems like on certain conditions the write&#40;&#41; call will lock up because the underlying buffers was not flushed. I haven&#39;t found the root cause for this but with my modification by clamping the writes the superbig tests passed! I&#39;ve just released v1.010 to CPAN with the change, can you please test it to see if it helps you? If not, then I&#39;ll have to attack it from a different angle :&#41;

On Sat Apr 26 12:20:58 2014, jhuckaby@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hey SSLify Team,
&gt; 
&gt; I believe I have found a bug using POE::Component::Server::TCP and
&gt; SSLify.  I have a very simple HTTPS web server &#40;created using the
&gt; cookbook example&#41;, which does nothing except serve up 300K of plain
&gt; text for every incoming HTTPS GET request.  This works fine until it
&gt; receives multiple requests at once.  Then it shoots up to 100% CPU and
&gt; stays there indefinitely, long after the requests have completed.
&gt; 
&gt; Here is a snapshot of &#34;top&#34; on my server after sending in 10
&gt; simultaneous requests and allowing them to complete fully:
&gt; 
&gt; PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
&gt; 1365 root      20   0  191m  20m 4168 R 99.9  0.6   0:10.95 perl
&gt; 
&gt; The CPU stays at or around 99.9% indefinitely &#40;I have witnessed
&gt; several days at least&#41;.  Also, something to note, even after the CPU
&gt; is pinned at 100%, the server still accepts new incoming connections,
&gt; and serves them.
&gt; 
&gt; Here is a ZIP file containing my script and sample SSL cert:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug.zip">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug.zip</a></span>
&gt; 
&gt; Here are links to the individual files:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-</a></span>
&gt; bug/server.pl
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.crt">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.crt</a></span>
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.key">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.key</a></span>
&gt; 
&gt; I can reproduce the issue every time by sending in 10 simultaneous
&gt; HTTPS GET requests from a shell script such as this:
&gt; 
&gt; #!/bin/sh
&gt; # Fetch URL 10 times simultaneously
&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; 
&gt; The --insecure flag is to prevent curl from validating the cert &#40;which
&gt; is self-signed&#41;.
&gt; 
&gt; I am running:
&gt; POE version 1.358
&gt; POE::Component::SSLify version 1.008
&gt; 
&gt; This is perl 5, version 16, subversion 3 &#40;v5.16.3&#41; built for x86_64-
&gt; linux-thread-multi
&gt; Linux pvp.effectgames.com 3.4.82-69.112.amzn1.x86_64 #1 SMP Mon Feb 24
&gt; 16:31:21 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux
&gt; 
&gt; openssl-perl-1.0.1g-1.69.amzn1.x86_64
&gt; openssl-1.0.1g-1.69.amzn1.x86_64
&gt; 
&gt; Other Notes: I cannot reproduce this without SSLify.  Meaning, if I
&gt; strip out all the SSL code and just run a plain HTTP server,
&gt; everything works fine.  Also note that I cannot seem to reproduce this
&gt; on my local OS X machine hitting localhost, although I suspect that is
&gt; because localhost is a virtual interface, and all the requests
&gt; complete &#34;instantly&#34;.  This bug seems to require a slower network &#40;DSL
&gt; to Amazon EC2 for example&#41; to occur.
&gt; 
&gt; If there is anything else you&#39;d like me to try, please let me know.
&gt; My server is at your disposal!
&gt; 
&gt; Thanks for your time!
&gt; 
&gt; - Joe
</div>

-- 
~Apocalypse
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;12&nbsp;01:22:50&nbsp;2014</span>
    <span class="description">APOCAL [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;12&nbsp;21:23:12&nbsp;2014</span>
    <span class="description">jhuckaby [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95071] CPU pinned at 100% with SSLify and POE::Component::Server::TCP</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 12 Nov 2014 18:22:54 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE-Component-SSLify [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Joseph Huckaby &lt;jhuckaby [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hey man,

Thanks for getting back to me!  I just tried SSLify v1.010 and it fails on
the t/simple_parallel_large.t test number 86 with this output:

t/simple_parallel_large.t ..... 86/?
#   Failed test &#39;SERVER: SSLify_Options 3105: private key
# &#39;
#   at t/simple_parallel_large.t line 54.

#   Failed test &#39;SERVER: Server_SSLify Please do SSLify_Options&#40;&#41; first &#40;
or pass in a $ctx object &#41; at
/root/.cpanm/work/1415844865.2217/POE-Component-SSLify-1.010/blib/lib/POE/Component/SSLify.pm
line 247.
# &#39;
#   at t/simple_parallel_large.t line 57.
Can&#39;t use an undefined value as a symbol reference at
/root/.cpanm/work/1415844865.2217/POE-Component-SSLify-1.010/blib/lib/POE/Component/SSLify.pm
line 446.

Here is the full test output if it helps:
<span class="clickylink"><a target="new" rel="nofollow" href="https://www.dropbox.com/s/gpd9pyhs8lnbxig/sslify-v1.010-test-output-2014-11-12.txt?dl=0">https://www.dropbox.com/s/gpd9pyhs8lnbxig/sslify-v1.010-test-output-2014-11-12.txt?dl=0</a></span>

Thanks again for your time on this!

- Joe


On Tue, Nov 11, 2014 at 10:22 PM, Apocalypse via RT &lt;
bug-POE-Component-SSLify@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95071">https://rt.cpan.org/Ticket/Display.html?id=95071</a></span> &gt;
&gt;
&gt; Hey,
&gt;
&gt;   I had some luck and found some information that pointed towards a 16K
&gt; limitation in the TLS packet sizes. It seems like on certain conditions the
&gt; write&#40;&#41; call will lock up because the underlying buffers was not flushed. I
&gt; haven&#39;t found the root cause for this but with my modification by clamping
&gt; the writes the superbig tests passed! I&#39;ve just released v1.010 to CPAN
&gt; with the change, can you please test it to see if it helps you? If not,
&gt; then I&#39;ll have to attack it from a different angle :&#41;
&gt;
&gt; On Sat Apr 26 12:20:58 2014, jhuckaby@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; Hey SSLify Team,
&gt; &gt;
&gt; &gt; I believe I have found a bug using POE::Component::Server::TCP and
&gt; &gt; SSLify.  I have a very simple HTTPS web server &#40;created using the
&gt; &gt; cookbook example&#41;, which does nothing except serve up 300K of plain
&gt; &gt; text for every incoming HTTPS GET request.  This works fine until it
&gt; &gt; receives multiple requests at once.  Then it shoots up to 100% CPU and
&gt; &gt; stays there indefinitely, long after the requests have completed.
&gt; &gt;
&gt; &gt; Here is a snapshot of &#34;top&#34; on my server after sending in 10
&gt; &gt; simultaneous requests and allowing them to complete fully:
&gt; &gt;
&gt; &gt; PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
&gt; &gt; 1365 root      20   0  191m  20m 4168 R 99.9  0.6   0:10.95 perl
&gt; &gt;
&gt; &gt; The CPU stays at or around 99.9% indefinitely &#40;I have witnessed
&gt; &gt; several days at least&#41;.  Also, something to note, even after the CPU
&gt; &gt; is pinned at 100%, the server still accepts new incoming connections,
&gt; &gt; and serves them.
&gt; &gt;
&gt; &gt; Here is a ZIP file containing my script and sample SSL cert:
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug.zip">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug.zip</a></span>
&gt; &gt;
&gt; &gt; Here are links to the individual files:
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-</a></span>
&gt; &gt; bug/server.pl
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.crt">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.crt</a></span>
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.key">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.key</a></span>
&gt; &gt;
&gt; &gt; I can reproduce the issue every time by sending in 10 simultaneous
&gt; &gt; HTTPS GET requests from a shell script such as this:
&gt; &gt;
&gt; &gt; #!/bin/sh
&gt; &gt; # Fetch URL 10 times simultaneously
&gt; &gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt;
&gt; &gt; The --insecure flag is to prevent curl from validating the cert &#40;which
&gt; &gt; is self-signed&#41;.
&gt; &gt;
&gt; &gt; I am running:
&gt; &gt; POE version 1.358
&gt; &gt; POE::Component::SSLify version 1.008
&gt; &gt;
&gt; &gt; This is perl 5, version 16, subversion 3 &#40;v5.16.3&#41; built for x86_64-
&gt; &gt; linux-thread-multi
&gt; &gt; Linux pvp.effectgames.com 3.4.82-69.112.amzn1.x86_64 #1 SMP Mon Feb 24
&gt; &gt; 16:31:21 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux
&gt; &gt;
&gt; &gt; openssl-perl-1.0.1g-1.69.amzn1.x86_64
&gt; &gt; openssl-1.0.1g-1.69.amzn1.x86_64
&gt; &gt;
&gt; &gt; Other Notes: I cannot reproduce this without SSLify.  Meaning, if I
&gt; &gt; strip out all the SSL code and just run a plain HTTP server,
&gt; &gt; everything works fine.  Also note that I cannot seem to reproduce this
&gt; &gt; on my local OS X machine hitting localhost, although I suspect that is
&gt; &gt; because localhost is a virtual interface, and all the requests
&gt; &gt; complete &#34;instantly&#34;.  This bug seems to require a slower network &#40;DSL
&gt; &gt; to Amazon EC2 for example&#41; to occur.
&gt; &gt;
&gt; &gt; If there is anything else you&#39;d like me to try, please let me know.
&gt; &gt; My server is at your disposal!
&gt; &gt;
&gt; &gt; Thanks for your time!
&gt; &gt;
&gt; &gt; - Joe
</div>&gt;
&gt;
&gt; --
&gt; ~Apocalypse
&gt;
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;12&nbsp;21:59:57&nbsp;2014</span>
    <span class="description">perl [...] 0ne.us -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95071] CPU pinned at 100% with SSLify and POE::Component::Server::TCP</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 12 Nov 2014 18:59:45 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE-Component-SSLify [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Apocalypse &lt;perl [...] 0ne.us&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

     Thanks for testing it for me :&#41;

     Hmm, I just received the CPANTesters daily digest and a boatload of 
testers confirmed the same thing you saw.

<span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/distro/P/POE-Component-SSLify.html?grade=1&#38;perlmat=2&#38;patches=2&#38;oncpan=1&#38;distmat=1&#38;perlver=ALL&#38;osname=ALL&#38;version=1.010">http://www.cpantesters.org/distro/P/POE-Component-SSLify.html?grade=1&#38;perlmat=2&#38;patches=2&#38;oncpan=1&#38;distmat=1&#38;perlver=ALL&#38;osname=ALL&#38;version=1.010</a></span>

     Two things jumped out at me:
         * They all failed in the same tests &#40;parallel_large or the 
superbig ones&#41;. They use HUGE strings to stress the buffers and it might 
be memory limitations somewhere? Can you confirm that it isn&#39;t an issue 
on your end?

         * All of those failures are during the initial connection stage 
&#40;loading the cert pem files&#41;. Maybe something funky going on with 
filehandles? I suspect the memory running out and not being able to 
create the CTX object is the culprit. While this problem is interesting, 
it&#39;s not related to your issue at all! You can safely ignore this :&#40;

     I&#39;ll continue testing and see if I can find something else to 
patch, ha! In the meantime can you please try and reproduce your lock-up 
with the latest version of SSLify using your scripts? Also please give 
the superbig tests a whirl by installing IO::Prompt::Tiny and re-running 
the testsuite.

     Maybe my testsuite didn&#39;t replicate yours fully as you mentioned 
regarding latency being a possible factor. I made changes to 
SSLify::write&#40;&#41; that worked around the lock-up that I manged to 
replicate in the superbig tests on my machine. Please let me know if you 
experience the lockup and I&#39;ll try to reproduce it on my side.

     Thanks again and I hope we&#39;ll squash this bug soon!

On 11/12/2014 06:23 PM, Joseph Huckaby via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         Queue: POE-Component-SSLify
&gt;   Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95071">https://rt.cpan.org/Ticket/Display.html?id=95071</a></span> &gt;
&gt;
&gt; Hey man,
&gt;
&gt; Thanks for getting back to me!  I just tried SSLify v1.010 and it fails on
&gt; the t/simple_parallel_large.t test number 86 with this output:
&gt;
&gt; t/simple_parallel_large.t ..... 86/?
&gt; #   Failed test &#39;SERVER: SSLify_Options 3105: private key
&gt; # &#39;
&gt; #   at t/simple_parallel_large.t line 54.
&gt;
&gt; #   Failed test &#39;SERVER: Server_SSLify Please do SSLify_Options&#40;&#41; first &#40;
&gt; or pass in a $ctx object &#41; at
&gt; /root/.cpanm/work/1415844865.2217/POE-Component-SSLify-1.010/blib/lib/POE/Component/SSLify.pm
&gt; line 247.
&gt; # &#39;
&gt; #   at t/simple_parallel_large.t line 57.
&gt; Can&#39;t use an undefined value as a symbol reference at
&gt; /root/.cpanm/work/1415844865.2217/POE-Component-SSLify-1.010/blib/lib/POE/Component/SSLify.pm
&gt; line 446.
&gt;
&gt; Here is the full test output if it helps:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://www.dropbox.com/s/gpd9pyhs8lnbxig/sslify-v1.010-test-output-2014-11-12.txt?dl=0">https://www.dropbox.com/s/gpd9pyhs8lnbxig/sslify-v1.010-test-output-2014-11-12.txt?dl=0</a></span>
&gt;
&gt; Thanks again for your time on this!
&gt;
&gt; - Joe
&gt;
&gt;
&gt; On Tue, Nov 11, 2014 at 10:22 PM, Apocalypse via RT &lt;
&gt; bug-POE-Component-SSLify@rt.cpan.org&gt; wrote:
&gt;
<div class="message-stanza open">&gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95071">https://rt.cpan.org/Ticket/Display.html?id=95071</a></span> &gt;
&gt;&gt;
&gt;&gt; Hey,
&gt;&gt;
&gt;&gt;    I had some luck and found some information that pointed towards a 16K
&gt;&gt; limitation in the TLS packet sizes. It seems like on certain conditions the
&gt;&gt; write&#40;&#41; call will lock up because the underlying buffers was not flushed. I
&gt;&gt; haven&#39;t found the root cause for this but with my modification by clamping
&gt;&gt; the writes the superbig tests passed! I&#39;ve just released v1.010 to CPAN
&gt;&gt; with the change, can you please test it to see if it helps you? If not,
&gt;&gt; then I&#39;ll have to attack it from a different angle :&#41;
&gt;&gt;
&gt;&gt; On Sat Apr 26 12:20:58 2014, jhuckaby@gmail.com wrote:
<div class="message-stanza open">&gt;&gt;&gt; Hey SSLify Team,
&gt;&gt;&gt;
&gt;&gt;&gt; I believe I have found a bug using POE::Component::Server::TCP and
&gt;&gt;&gt; SSLify.  I have a very simple HTTPS web server &#40;created using the
&gt;&gt;&gt; cookbook example&#41;, which does nothing except serve up 300K of plain
&gt;&gt;&gt; text for every incoming HTTPS GET request.  This works fine until it
&gt;&gt;&gt; receives multiple requests at once.  Then it shoots up to 100% CPU and
&gt;&gt;&gt; stays there indefinitely, long after the requests have completed.
&gt;&gt;&gt;
&gt;&gt;&gt; Here is a snapshot of &#34;top&#34; on my server after sending in 10
&gt;&gt;&gt; simultaneous requests and allowing them to complete fully:
&gt;&gt;&gt;
&gt;&gt;&gt; PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
&gt;&gt;&gt; 1365 root      20   0  191m  20m 4168 R 99.9  0.6   0:10.95 perl
&gt;&gt;&gt;
&gt;&gt;&gt; The CPU stays at or around 99.9% indefinitely &#40;I have witnessed
&gt;&gt;&gt; several days at least&#41;.  Also, something to note, even after the CPU
&gt;&gt;&gt; is pinned at 100%, the server still accepts new incoming connections,
&gt;&gt;&gt; and serves them.
&gt;&gt;&gt;
&gt;&gt;&gt; Here is a ZIP file containing my script and sample SSL cert:
&gt;&gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug.zip">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug.zip</a></span>
&gt;&gt;&gt;
&gt;&gt;&gt; Here are links to the individual files:
&gt;&gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-</a></span>
&gt;&gt;&gt; bug/server.pl
&gt;&gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.crt">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.crt</a></span>
&gt;&gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.key">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.key</a></span>
&gt;&gt;&gt;
&gt;&gt;&gt; I can reproduce the issue every time by sending in 10 simultaneous
&gt;&gt;&gt; HTTPS GET requests from a shell script such as this:
&gt;&gt;&gt;
&gt;&gt;&gt; #!/bin/sh
&gt;&gt;&gt; # Fetch URL 10 times simultaneously
&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt;&gt;&gt;
&gt;&gt;&gt; The --insecure flag is to prevent curl from validating the cert &#40;which
&gt;&gt;&gt; is self-signed&#41;.
&gt;&gt;&gt;
&gt;&gt;&gt; I am running:
&gt;&gt;&gt; POE version 1.358
&gt;&gt;&gt; POE::Component::SSLify version 1.008
&gt;&gt;&gt;
&gt;&gt;&gt; This is perl 5, version 16, subversion 3 &#40;v5.16.3&#41; built for x86_64-
&gt;&gt;&gt; linux-thread-multi
&gt;&gt;&gt; Linux pvp.effectgames.com 3.4.82-69.112.amzn1.x86_64 #1 SMP Mon Feb 24
&gt;&gt;&gt; 16:31:21 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux
&gt;&gt;&gt;
&gt;&gt;&gt; openssl-perl-1.0.1g-1.69.amzn1.x86_64
&gt;&gt;&gt; openssl-1.0.1g-1.69.amzn1.x86_64
&gt;&gt;&gt;
&gt;&gt;&gt; Other Notes: I cannot reproduce this without SSLify.  Meaning, if I
&gt;&gt;&gt; strip out all the SSL code and just run a plain HTTP server,
&gt;&gt;&gt; everything works fine.  Also note that I cannot seem to reproduce this
&gt;&gt;&gt; on my local OS X machine hitting localhost, although I suspect that is
&gt;&gt;&gt; because localhost is a virtual interface, and all the requests
&gt;&gt;&gt; complete &#34;instantly&#34;.  This bug seems to require a slower network &#40;DSL
&gt;&gt;&gt; to Amazon EC2 for example&#41; to occur.
&gt;&gt;&gt;
&gt;&gt;&gt; If there is anything else you&#39;d like me to try, please let me know.
&gt;&gt;&gt; My server is at your disposal!
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks for your time!
&gt;&gt;&gt;
&gt;&gt;&gt; - Joe
</div>&gt;&gt;
&gt;&gt; --
&gt;&gt; ~Apocalypse
&gt;&gt;
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;12&nbsp;23:22:12&nbsp;2014</span>
    <span class="description">jhuckaby [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95071] CPU pinned at 100% with SSLify and POE::Component::Server::TCP</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 12 Nov 2014 20:21:57 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE-Component-SSLify [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Joseph Huckaby &lt;jhuckaby [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ah ha!  You were right!  I believe it was a memory issue as you suspected.
That box I was running on only had 1 GB of RAM, and much of it was already
in use.  I tried the test again on a VERY LARGE box &#40;Amazon c3.8xlarge, 64
GB RAM&#41;, and all tests pass!  Here are the results:

<span class="clickylink"><a target="new" rel="nofollow" href="https://www.dropbox.com/s/924lcwdm4xg0y4v/sslify-v1.010-test-output-2014-11-12-pass.txt?dl=0">https://www.dropbox.com/s/924lcwdm4xg0y4v/sslify-v1.010-test-output-2014-11-12-pass.txt?dl=0</a></span>

&#40;I installed IO::Prompt::Tiny as well&#41;

Okay, I am now installing SSLify v1.010 on my primary production server
now, and will see if any 100% CPU issues occur.  I had a nightly crontab
restart going, but I have disabled that, in an effort to try and reproduce
it more readily.

Thanks again, and I&#39;ll keep you posted!

- Joe


On Wed, Nov 12, 2014 at 6:59 PM, Apocalypse via RT &lt;
bug-POE-Component-SSLify@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95071">https://rt.cpan.org/Ticket/Display.html?id=95071</a></span> &gt;
&gt;
&gt; Hello,
&gt;
&gt;      Thanks for testing it for me :&#41;
&gt;
&gt;      Hmm, I just received the CPANTesters daily digest and a boatload of
&gt; testers confirmed the same thing you saw.
&gt;
&gt;
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/distro/P/POE-Component-SSLify.html?grade=1&#38;perlmat=2&#38;patches=2&#38;oncpan=1&#38;distmat=1&#38;perlver=ALL&#38;osname=ALL&#38;version=1.010">http://www.cpantesters.org/distro/P/POE-Component-SSLify.html?grade=1&#38;perlmat=2&#38;patches=2&#38;oncpan=1&#38;distmat=1&#38;perlver=ALL&#38;osname=ALL&#38;version=1.010</a></span>
&gt;
&gt;      Two things jumped out at me:
&gt;          * They all failed in the same tests &#40;parallel_large or the
&gt; superbig ones&#41;. They use HUGE strings to stress the buffers and it might
&gt; be memory limitations somewhere? Can you confirm that it isn&#39;t an issue
&gt; on your end?
&gt;
&gt;          * All of those failures are during the initial connection stage
&gt; &#40;loading the cert pem files&#41;. Maybe something funky going on with
&gt; filehandles? I suspect the memory running out and not being able to
&gt; create the CTX object is the culprit. While this problem is interesting,
&gt; it&#39;s not related to your issue at all! You can safely ignore this :&#40;
&gt;
&gt;      I&#39;ll continue testing and see if I can find something else to
&gt; patch, ha! In the meantime can you please try and reproduce your lock-up
&gt; with the latest version of SSLify using your scripts? Also please give
&gt; the superbig tests a whirl by installing IO::Prompt::Tiny and re-running
&gt; the testsuite.
&gt;
&gt;      Maybe my testsuite didn&#39;t replicate yours fully as you mentioned
&gt; regarding latency being a possible factor. I made changes to
&gt; SSLify::write&#40;&#41; that worked around the lock-up that I manged to
&gt; replicate in the superbig tests on my machine. Please let me know if you
&gt; experience the lockup and I&#39;ll try to reproduce it on my side.
&gt;
&gt;      Thanks again and I hope we&#39;ll squash this bug soon!
&gt;
&gt; On 11/12/2014 06:23 PM, Joseph Huckaby via RT wrote:
<div class="message-stanza open">&gt; &gt;         Queue: POE-Component-SSLify
&gt; &gt;   Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95071">https://rt.cpan.org/Ticket/Display.html?id=95071</a></span> &gt;
&gt; &gt;
&gt; &gt; Hey man,
&gt; &gt;
&gt; &gt; Thanks for getting back to me!  I just tried SSLify v1.010 and it fails
</div>&gt; on
<div class="message-stanza open">&gt; &gt; the t/simple_parallel_large.t test number 86 with this output:
&gt; &gt;
&gt; &gt; t/simple_parallel_large.t ..... 86/?
&gt; &gt; #   Failed test &#39;SERVER: SSLify_Options 3105: private key
&gt; &gt; # &#39;
&gt; &gt; #   at t/simple_parallel_large.t line 54.
&gt; &gt;
&gt; &gt; #   Failed test &#39;SERVER: Server_SSLify Please do SSLify_Options&#40;&#41; first &#40;
&gt; &gt; or pass in a $ctx object &#41; at
&gt; &gt;
</div>&gt; /root/.cpanm/work/1415844865.2217/POE-Component-SSLify-1.010/blib/lib/POE/Component/SSLify.pm
<div class="message-stanza open">&gt; &gt; line 247.
&gt; &gt; # &#39;
&gt; &gt; #   at t/simple_parallel_large.t line 57.
&gt; &gt; Can&#39;t use an undefined value as a symbol reference at
&gt; &gt;
</div>&gt; /root/.cpanm/work/1415844865.2217/POE-Component-SSLify-1.010/blib/lib/POE/Component/SSLify.pm
<div class="message-stanza open">&gt; &gt; line 446.
&gt; &gt;
&gt; &gt; Here is the full test output if it helps:
&gt; &gt;
</div>&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://www.dropbox.com/s/gpd9pyhs8lnbxig/sslify-v1.010-test-output-2014-11-12.txt?dl=0">https://www.dropbox.com/s/gpd9pyhs8lnbxig/sslify-v1.010-test-output-2014-11-12.txt?dl=0</a></span>
<div class="message-stanza open">&gt; &gt;
&gt; &gt; Thanks again for your time on this!
&gt; &gt;
&gt; &gt; - Joe
&gt; &gt;
&gt; &gt;
&gt; &gt; On Tue, Nov 11, 2014 at 10:22 PM, Apocalypse via RT &lt;
&gt; &gt; bug-POE-Component-SSLify@rt.cpan.org&gt; wrote:
&gt; &gt;
<div class="message-stanza open">&gt; &gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95071">https://rt.cpan.org/Ticket/Display.html?id=95071</a></span> &gt;
&gt; &gt;&gt;
&gt; &gt;&gt; Hey,
&gt; &gt;&gt;
&gt; &gt;&gt;    I had some luck and found some information that pointed towards a 16K
&gt; &gt;&gt; limitation in the TLS packet sizes. It seems like on certain conditions
</div></div>&gt; the
<div class="message-stanza open">&gt; &gt;&gt; write&#40;&#41; call will lock up because the underlying buffers was not
</div>&gt; flushed. I
<div class="message-stanza open">&gt; &gt;&gt; haven&#39;t found the root cause for this but with my modification by
</div>&gt; clamping
<div class="message-stanza open">&gt; &gt;&gt; the writes the superbig tests passed! I&#39;ve just released v1.010 to CPAN
&gt; &gt;&gt; with the change, can you please test it to see if it helps you? If not,
&gt; &gt;&gt; then I&#39;ll have to attack it from a different angle :&#41;
&gt; &gt;&gt;
&gt; &gt;&gt; On Sat Apr 26 12:20:58 2014, jhuckaby@gmail.com wrote:
<div class="message-stanza open">&gt; &gt;&gt;&gt; Hey SSLify Team,
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; I believe I have found a bug using POE::Component::Server::TCP and
&gt; &gt;&gt;&gt; SSLify.  I have a very simple HTTPS web server &#40;created using the
&gt; &gt;&gt;&gt; cookbook example&#41;, which does nothing except serve up 300K of plain
&gt; &gt;&gt;&gt; text for every incoming HTTPS GET request.  This works fine until it
&gt; &gt;&gt;&gt; receives multiple requests at once.  Then it shoots up to 100% CPU and
&gt; &gt;&gt;&gt; stays there indefinitely, long after the requests have completed.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Here is a snapshot of &#34;top&#34; on my server after sending in 10
&gt; &gt;&gt;&gt; simultaneous requests and allowing them to complete fully:
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
&gt; &gt;&gt;&gt; 1365 root      20   0  191m  20m 4168 R 99.9  0.6   0:10.95 perl
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; The CPU stays at or around 99.9% indefinitely &#40;I have witnessed
&gt; &gt;&gt;&gt; several days at least&#41;.  Also, something to note, even after the CPU
&gt; &gt;&gt;&gt; is pinned at 100%, the server still accepts new incoming connections,
&gt; &gt;&gt;&gt; and serves them.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Here is a ZIP file containing my script and sample SSL cert:
&gt; &gt;&gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug.zip">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug.zip</a></span>
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Here are links to the individual files:
&gt; &gt;&gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-</a></span>
&gt; &gt;&gt;&gt; bug/server.pl
&gt; &gt;&gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.crt">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.crt</a></span>
&gt; &gt;&gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.key">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.key</a></span>
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; I can reproduce the issue every time by sending in 10 simultaneous
&gt; &gt;&gt;&gt; HTTPS GET requests from a shell script such as this:
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; #!/bin/sh
&gt; &gt;&gt;&gt; # Fetch URL 10 times simultaneously
&gt; &gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; The --insecure flag is to prevent curl from validating the cert &#40;which
&gt; &gt;&gt;&gt; is self-signed&#41;.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; I am running:
&gt; &gt;&gt;&gt; POE version 1.358
&gt; &gt;&gt;&gt; POE::Component::SSLify version 1.008
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; This is perl 5, version 16, subversion 3 &#40;v5.16.3&#41; built for x86_64-
&gt; &gt;&gt;&gt; linux-thread-multi
&gt; &gt;&gt;&gt; Linux pvp.effectgames.com 3.4.82-69.112.amzn1.x86_64 #1 SMP Mon Feb 24
&gt; &gt;&gt;&gt; 16:31:21 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; openssl-perl-1.0.1g-1.69.amzn1.x86_64
&gt; &gt;&gt;&gt; openssl-1.0.1g-1.69.amzn1.x86_64
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Other Notes: I cannot reproduce this without SSLify.  Meaning, if I
&gt; &gt;&gt;&gt; strip out all the SSL code and just run a plain HTTP server,
&gt; &gt;&gt;&gt; everything works fine.  Also note that I cannot seem to reproduce this
&gt; &gt;&gt;&gt; on my local OS X machine hitting localhost, although I suspect that is
&gt; &gt;&gt;&gt; because localhost is a virtual interface, and all the requests
&gt; &gt;&gt;&gt; complete &#34;instantly&#34;.  This bug seems to require a slower network &#40;DSL
&gt; &gt;&gt;&gt; to Amazon EC2 for example&#41; to occur.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; If there is anything else you&#39;d like me to try, please let me know.
&gt; &gt;&gt;&gt; My server is at your disposal!
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Thanks for your time!
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; - Joe
</div>&gt; &gt;&gt;
&gt; &gt;&gt; --
&gt; &gt;&gt; ~Apocalypse
&gt; &gt;&gt;
</div>&gt;
&gt;
&gt;
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;13&nbsp;13:44:06&nbsp;2014</span>
    <span class="description">perl [...] 0ne.us -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95071] CPU pinned at 100% with SSLify and POE::Component::Server::TCP</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 13 Nov 2014 10:43:56 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE-Component-SSLify [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Apocalypse &lt;perl [...] 0ne.us&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Awesome! I&#39;m glad we are on the right track!

     Oh, I noticed an omission in the test you pasted - I forgot to tell 
you that installing IO::Prompt::Tiny alone wasn&#39;t enough to enable the 
superbig tests, d0h! In your case, you were running under 
PERL_MM_USE_DEFAULT=1 and it defaulted to NO. Can you please re-run it 
without the default, or override it via AUTOMATED_TESTING=1 ?

     The superbig tests actually reproduce your issue on my machine with 
SSLify v1.008. That&#39;s why I really wanted to verify that it fixed your 
problem. If you can, please try copying &#40;simple_superbig.t and 
simple_parallel_superbig.t&#41; from v1.010 over to v1.008 and running the 
testsuite and comparing the result to v1.010? Hopefully on your setup 
v1.008 will lockup and v1.010 eats it for breakfast. Thanks for digging 
into this with me :&#41;

On 11/12/2014 08:22 PM, Joseph Huckaby via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         Queue: POE-Component-SSLify
&gt;   Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95071">https://rt.cpan.org/Ticket/Display.html?id=95071</a></span> &gt;
&gt;
&gt; Ah ha!  You were right!  I believe it was a memory issue as you suspected.
&gt; That box I was running on only had 1 GB of RAM, and much of it was already
&gt; in use.  I tried the test again on a VERY LARGE box &#40;Amazon c3.8xlarge, 64
&gt; GB RAM&#41;, and all tests pass!  Here are the results:
&gt;
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://www.dropbox.com/s/924lcwdm4xg0y4v/sslify-v1.010-test-output-2014-11-12-pass.txt?dl=0">https://www.dropbox.com/s/924lcwdm4xg0y4v/sslify-v1.010-test-output-2014-11-12-pass.txt?dl=0</a></span>
&gt;
&gt; &#40;I installed IO::Prompt::Tiny as well&#41;
&gt;
&gt; Okay, I am now installing SSLify v1.010 on my primary production server
&gt; now, and will see if any 100% CPU issues occur.  I had a nightly crontab
&gt; restart going, but I have disabled that, in an effort to try and reproduce
&gt; it more readily.
&gt;
&gt; Thanks again, and I&#39;ll keep you posted!
&gt;
&gt; - Joe
&gt;
&gt;
&gt; On Wed, Nov 12, 2014 at 6:59 PM, Apocalypse via RT &lt;
&gt; bug-POE-Component-SSLify@rt.cpan.org&gt; wrote:
&gt;
<div class="message-stanza open">&gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95071">https://rt.cpan.org/Ticket/Display.html?id=95071</a></span> &gt;
&gt;&gt;
&gt;&gt; Hello,
&gt;&gt;
&gt;&gt;       Thanks for testing it for me :&#41;
&gt;&gt;
&gt;&gt;       Hmm, I just received the CPANTesters daily digest and a boatload of
&gt;&gt; testers confirmed the same thing you saw.
&gt;&gt;
&gt;&gt;
&gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/distro/P/POE-Component-SSLify.html?grade=1&#38;perlmat=2&#38;patches=2&#38;oncpan=1&#38;distmat=1&#38;perlver=ALL&#38;osname=ALL&#38;version=1.010">http://www.cpantesters.org/distro/P/POE-Component-SSLify.html?grade=1&#38;perlmat=2&#38;patches=2&#38;oncpan=1&#38;distmat=1&#38;perlver=ALL&#38;osname=ALL&#38;version=1.010</a></span>
&gt;&gt;
&gt;&gt;       Two things jumped out at me:
&gt;&gt;           * They all failed in the same tests &#40;parallel_large or the
&gt;&gt; superbig ones&#41;. They use HUGE strings to stress the buffers and it might
&gt;&gt; be memory limitations somewhere? Can you confirm that it isn&#39;t an issue
&gt;&gt; on your end?
&gt;&gt;
&gt;&gt;           * All of those failures are during the initial connection stage
&gt;&gt; &#40;loading the cert pem files&#41;. Maybe something funky going on with
&gt;&gt; filehandles? I suspect the memory running out and not being able to
&gt;&gt; create the CTX object is the culprit. While this problem is interesting,
&gt;&gt; it&#39;s not related to your issue at all! You can safely ignore this :&#40;
&gt;&gt;
&gt;&gt;       I&#39;ll continue testing and see if I can find something else to
&gt;&gt; patch, ha! In the meantime can you please try and reproduce your lock-up
&gt;&gt; with the latest version of SSLify using your scripts? Also please give
&gt;&gt; the superbig tests a whirl by installing IO::Prompt::Tiny and re-running
&gt;&gt; the testsuite.
&gt;&gt;
&gt;&gt;       Maybe my testsuite didn&#39;t replicate yours fully as you mentioned
&gt;&gt; regarding latency being a possible factor. I made changes to
&gt;&gt; SSLify::write&#40;&#41; that worked around the lock-up that I manged to
&gt;&gt; replicate in the superbig tests on my machine. Please let me know if you
&gt;&gt; experience the lockup and I&#39;ll try to reproduce it on my side.
&gt;&gt;
&gt;&gt;       Thanks again and I hope we&#39;ll squash this bug soon!
&gt;&gt;
&gt;&gt; On 11/12/2014 06:23 PM, Joseph Huckaby via RT wrote:
<div class="message-stanza open">&gt;&gt;&gt;          Queue: POE-Component-SSLify
&gt;&gt;&gt;    Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95071">https://rt.cpan.org/Ticket/Display.html?id=95071</a></span> &gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Hey man,
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks for getting back to me!  I just tried SSLify v1.010 and it fails
</div>&gt;&gt; on
<div class="message-stanza open">&gt;&gt;&gt; the t/simple_parallel_large.t test number 86 with this output:
&gt;&gt;&gt;
&gt;&gt;&gt; t/simple_parallel_large.t ..... 86/?
&gt;&gt;&gt; #   Failed test &#39;SERVER: SSLify_Options 3105: private key
&gt;&gt;&gt; # &#39;
&gt;&gt;&gt; #   at t/simple_parallel_large.t line 54.
&gt;&gt;&gt;
&gt;&gt;&gt; #   Failed test &#39;SERVER: Server_SSLify Please do SSLify_Options&#40;&#41; first &#40;
&gt;&gt;&gt; or pass in a $ctx object &#41; at
&gt;&gt;&gt;
</div>&gt;&gt; /root/.cpanm/work/1415844865.2217/POE-Component-SSLify-1.010/blib/lib/POE/Component/SSLify.pm
<div class="message-stanza open">&gt;&gt;&gt; line 247.
&gt;&gt;&gt; # &#39;
&gt;&gt;&gt; #   at t/simple_parallel_large.t line 57.
&gt;&gt;&gt; Can&#39;t use an undefined value as a symbol reference at
&gt;&gt;&gt;
</div>&gt;&gt; /root/.cpanm/work/1415844865.2217/POE-Component-SSLify-1.010/blib/lib/POE/Component/SSLify.pm
<div class="message-stanza open">&gt;&gt;&gt; line 446.
&gt;&gt;&gt;
&gt;&gt;&gt; Here is the full test output if it helps:
&gt;&gt;&gt;
</div>&gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://www.dropbox.com/s/gpd9pyhs8lnbxig/sslify-v1.010-test-output-2014-11-12.txt?dl=0">https://www.dropbox.com/s/gpd9pyhs8lnbxig/sslify-v1.010-test-output-2014-11-12.txt?dl=0</a></span>
<div class="message-stanza open">&gt;&gt;&gt; Thanks again for your time on this!
&gt;&gt;&gt;
&gt;&gt;&gt; - Joe
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; On Tue, Nov 11, 2014 at 10:22 PM, Apocalypse via RT &lt;
&gt;&gt;&gt; bug-POE-Component-SSLify@rt.cpan.org&gt; wrote:
&gt;&gt;&gt;
<div class="message-stanza open">&gt;&gt;&gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95071">https://rt.cpan.org/Ticket/Display.html?id=95071</a></span> &gt;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; Hey,
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;     I had some luck and found some information that pointed towards a 16K
&gt;&gt;&gt;&gt; limitation in the TLS packet sizes. It seems like on certain conditions
</div></div>&gt;&gt; the
<div class="message-stanza open">&gt;&gt;&gt;&gt; write&#40;&#41; call will lock up because the underlying buffers was not
</div>&gt;&gt; flushed. I
<div class="message-stanza open">&gt;&gt;&gt;&gt; haven&#39;t found the root cause for this but with my modification by
</div>&gt;&gt; clamping
<div class="message-stanza open">&gt;&gt;&gt;&gt; the writes the superbig tests passed! I&#39;ve just released v1.010 to CPAN
&gt;&gt;&gt;&gt; with the change, can you please test it to see if it helps you? If not,
&gt;&gt;&gt;&gt; then I&#39;ll have to attack it from a different angle :&#41;
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt; On Sat Apr 26 12:20:58 2014, jhuckaby@gmail.com wrote:
<div class="message-stanza open">&gt;&gt;&gt;&gt;&gt; Hey SSLify Team,
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; I believe I have found a bug using POE::Component::Server::TCP and
&gt;&gt;&gt;&gt;&gt; SSLify.  I have a very simple HTTPS web server &#40;created using the
&gt;&gt;&gt;&gt;&gt; cookbook example&#41;, which does nothing except serve up 300K of plain
&gt;&gt;&gt;&gt;&gt; text for every incoming HTTPS GET request.  This works fine until it
&gt;&gt;&gt;&gt;&gt; receives multiple requests at once.  Then it shoots up to 100% CPU and
&gt;&gt;&gt;&gt;&gt; stays there indefinitely, long after the requests have completed.
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; Here is a snapshot of &#34;top&#34; on my server after sending in 10
&gt;&gt;&gt;&gt;&gt; simultaneous requests and allowing them to complete fully:
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
&gt;&gt;&gt;&gt;&gt; 1365 root      20   0  191m  20m 4168 R 99.9  0.6   0:10.95 perl
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; The CPU stays at or around 99.9% indefinitely &#40;I have witnessed
&gt;&gt;&gt;&gt;&gt; several days at least&#41;.  Also, something to note, even after the CPU
&gt;&gt;&gt;&gt;&gt; is pinned at 100%, the server still accepts new incoming connections,
&gt;&gt;&gt;&gt;&gt; and serves them.
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; Here is a ZIP file containing my script and sample SSL cert:
&gt;&gt;&gt;&gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug.zip">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug.zip</a></span>
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; Here are links to the individual files:
&gt;&gt;&gt;&gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-</a></span>
&gt;&gt;&gt;&gt;&gt; bug/server.pl
&gt;&gt;&gt;&gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.crt">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.crt</a></span>
&gt;&gt;&gt;&gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.key">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.key</a></span>
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; I can reproduce the issue every time by sending in 10 simultaneous
&gt;&gt;&gt;&gt;&gt; HTTPS GET requests from a shell script such as this:
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; #!/bin/sh
&gt;&gt;&gt;&gt;&gt; # Fetch URL 10 times simultaneously
&gt;&gt;&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt;&gt;&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt;&gt;&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt;&gt;&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt;&gt;&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt;&gt;&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt;&gt;&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt;&gt;&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt;&gt;&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt;&gt;&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; The --insecure flag is to prevent curl from validating the cert &#40;which
&gt;&gt;&gt;&gt;&gt; is self-signed&#41;.
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; I am running:
&gt;&gt;&gt;&gt;&gt; POE version 1.358
&gt;&gt;&gt;&gt;&gt; POE::Component::SSLify version 1.008
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; This is perl 5, version 16, subversion 3 &#40;v5.16.3&#41; built for x86_64-
&gt;&gt;&gt;&gt;&gt; linux-thread-multi
&gt;&gt;&gt;&gt;&gt; Linux pvp.effectgames.com 3.4.82-69.112.amzn1.x86_64 #1 SMP Mon Feb 24
&gt;&gt;&gt;&gt;&gt; 16:31:21 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; openssl-perl-1.0.1g-1.69.amzn1.x86_64
&gt;&gt;&gt;&gt;&gt; openssl-1.0.1g-1.69.amzn1.x86_64
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; Other Notes: I cannot reproduce this without SSLify.  Meaning, if I
&gt;&gt;&gt;&gt;&gt; strip out all the SSL code and just run a plain HTTP server,
&gt;&gt;&gt;&gt;&gt; everything works fine.  Also note that I cannot seem to reproduce this
&gt;&gt;&gt;&gt;&gt; on my local OS X machine hitting localhost, although I suspect that is
&gt;&gt;&gt;&gt;&gt; because localhost is a virtual interface, and all the requests
&gt;&gt;&gt;&gt;&gt; complete &#34;instantly&#34;.  This bug seems to require a slower network &#40;DSL
&gt;&gt;&gt;&gt;&gt; to Amazon EC2 for example&#41; to occur.
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; If there is anything else you&#39;d like me to try, please let me know.
&gt;&gt;&gt;&gt;&gt; My server is at your disposal!
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; Thanks for your time!
&gt;&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;&gt; - Joe
</div>&gt;&gt;&gt;&gt; --
&gt;&gt;&gt;&gt; ~Apocalypse
&gt;&gt;&gt;&gt;
</div>&gt;&gt;
&gt;&gt;
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;13&nbsp;20:52:23&nbsp;2014</span>
    <span class="description">jhuckaby [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95071] CPU pinned at 100% with SSLify and POE::Component::Server::TCP</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 13 Nov 2014 17:52:06 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE-Component-SSLify [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Joseph Huckaby &lt;jhuckaby [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Uh oh.... the plot thickens!

I did exactly as you said.  I downloaded 1.008, copied the two superbig
tests from 1.010/t/ into 1.008/t/, and ran with AUTOMATED_TESTING=1.
Everything passed!

v1.008 Output:
<span class="clickylink"><a target="new" rel="nofollow" href="https://www.dropbox.com/s/7hsks226zjr8lht/sslify-v1.008-test-output-2014-11-13-pass.txt?dl=0">https://www.dropbox.com/s/7hsks226zjr8lht/sslify-v1.008-test-output-2014-11-13-pass.txt?dl=0</a></span>

I also tried v1.010 with AUTOMATED_TESTING=1.  Same result, everything
passed:
<span class="clickylink"><a target="new" rel="nofollow" href="https://www.dropbox.com/s/32jdq39pnmj9q85/sslify-v1.010-test-output-2014-11-13-pass.txt?dl=0">https://www.dropbox.com/s/32jdq39pnmj9q85/sslify-v1.010-test-output-2014-11-13-pass.txt?dl=0</a></span>

And to make this even more confusing, my IRC server which uses SSLify got
stuck again with 100% CPU today, using the latest SSLify v1.010.  So it
looks like I&#39;m doing something quite different which is causing the issue.

Oh, just to give you an update on that.  I am using SSLify for an IRC
server, but it is also an HTTPS web server in the same process.  Since I
was able to reproduce the issue using a simple HTTPS GET, that is the bug
report I sent to you.  But over the last few months I have tried a number
of things in my IRC server, including completely disabling SSL in the HTTP
server, and just having SSLify run on the IRC connections &#40;it&#39;s using
POE::Component::Server::IRC&#41;.  Anyway, even after that change, it still
randomly sticks at 100% CPU &#40;while still remaining somewhat responsive and
usable&#41;.  Such a weird issue!

Here&#39;s my code if you are interested: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/jhuckaby/simpleirc">https://github.com/jhuckaby/simpleirc</a></span>

Anyway, thanks for your time and effort in looking at this!  One bug at a
time I guess!

- Joe


On Thu, Nov 13, 2014 at 10:44 AM, Apocalypse via RT &lt;
bug-POE-Component-SSLify@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95071">https://rt.cpan.org/Ticket/Display.html?id=95071</a></span> &gt;
&gt;
&gt; Awesome! I&#39;m glad we are on the right track!
&gt;
&gt;      Oh, I noticed an omission in the test you pasted - I forgot to tell
&gt; you that installing IO::Prompt::Tiny alone wasn&#39;t enough to enable the
&gt; superbig tests, d0h! In your case, you were running under
&gt; PERL_MM_USE_DEFAULT=1 and it defaulted to NO. Can you please re-run it
&gt; without the default, or override it via AUTOMATED_TESTING=1 ?
&gt;
&gt;      The superbig tests actually reproduce your issue on my machine with
&gt; SSLify v1.008. That&#39;s why I really wanted to verify that it fixed your
&gt; problem. If you can, please try copying &#40;simple_superbig.t and
&gt; simple_parallel_superbig.t&#41; from v1.010 over to v1.008 and running the
&gt; testsuite and comparing the result to v1.010? Hopefully on your setup
&gt; v1.008 will lockup and v1.010 eats it for breakfast. Thanks for digging
&gt; into this with me :&#41;
&gt;
&gt; On 11/12/2014 08:22 PM, Joseph Huckaby via RT wrote:
<div class="message-stanza open">&gt; &gt;         Queue: POE-Component-SSLify
&gt; &gt;   Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95071">https://rt.cpan.org/Ticket/Display.html?id=95071</a></span> &gt;
&gt; &gt;
&gt; &gt; Ah ha!  You were right!  I believe it was a memory issue as you
</div>&gt; suspected.
<div class="message-stanza open">&gt; &gt; That box I was running on only had 1 GB of RAM, and much of it was
</div>&gt; already
<div class="message-stanza open">&gt; &gt; in use.  I tried the test again on a VERY LARGE box &#40;Amazon c3.8xlarge,
</div>&gt; 64
<div class="message-stanza open">&gt; &gt; GB RAM&#41;, and all tests pass!  Here are the results:
&gt; &gt;
&gt; &gt;
</div>&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://www.dropbox.com/s/924lcwdm4xg0y4v/sslify-v1.010-test-output-2014-11-12-pass.txt?dl=0">https://www.dropbox.com/s/924lcwdm4xg0y4v/sslify-v1.010-test-output-2014-11-12-pass.txt?dl=0</a></span>
<div class="message-stanza open">&gt; &gt;
&gt; &gt; &#40;I installed IO::Prompt::Tiny as well&#41;
&gt; &gt;
&gt; &gt; Okay, I am now installing SSLify v1.010 on my primary production server
&gt; &gt; now, and will see if any 100% CPU issues occur.  I had a nightly crontab
&gt; &gt; restart going, but I have disabled that, in an effort to try and
</div>&gt; reproduce
<div class="message-stanza open">&gt; &gt; it more readily.
&gt; &gt;
&gt; &gt; Thanks again, and I&#39;ll keep you posted!
&gt; &gt;
&gt; &gt; - Joe
&gt; &gt;
&gt; &gt;
&gt; &gt; On Wed, Nov 12, 2014 at 6:59 PM, Apocalypse via RT &lt;
&gt; &gt; bug-POE-Component-SSLify@rt.cpan.org&gt; wrote:
&gt; &gt;
<div class="message-stanza open">&gt; &gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95071">https://rt.cpan.org/Ticket/Display.html?id=95071</a></span> &gt;
&gt; &gt;&gt;
&gt; &gt;&gt; Hello,
&gt; &gt;&gt;
&gt; &gt;&gt;       Thanks for testing it for me :&#41;
&gt; &gt;&gt;
&gt; &gt;&gt;       Hmm, I just received the CPANTesters daily digest and a boatload
</div></div>&gt; of
<div class="message-stanza open">&gt; &gt;&gt; testers confirmed the same thing you saw.
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt;
</div>&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/distro/P/POE-Component-SSLify.html?grade=1&#38;perlmat=2&#38;patches=2&#38;oncpan=1&#38;distmat=1&#38;perlver=ALL&#38;osname=ALL&#38;version=1.010">http://www.cpantesters.org/distro/P/POE-Component-SSLify.html?grade=1&#38;perlmat=2&#38;patches=2&#38;oncpan=1&#38;distmat=1&#38;perlver=ALL&#38;osname=ALL&#38;version=1.010</a></span>
<div class="message-stanza open">&gt; &gt;&gt;
&gt; &gt;&gt;       Two things jumped out at me:
&gt; &gt;&gt;           * They all failed in the same tests &#40;parallel_large or the
&gt; &gt;&gt; superbig ones&#41;. They use HUGE strings to stress the buffers and it might
&gt; &gt;&gt; be memory limitations somewhere? Can you confirm that it isn&#39;t an issue
&gt; &gt;&gt; on your end?
&gt; &gt;&gt;
&gt; &gt;&gt;           * All of those failures are during the initial connection
</div>&gt; stage
<div class="message-stanza open">&gt; &gt;&gt; &#40;loading the cert pem files&#41;. Maybe something funky going on with
&gt; &gt;&gt; filehandles? I suspect the memory running out and not being able to
&gt; &gt;&gt; create the CTX object is the culprit. While this problem is interesting,
&gt; &gt;&gt; it&#39;s not related to your issue at all! You can safely ignore this :&#40;
&gt; &gt;&gt;
&gt; &gt;&gt;       I&#39;ll continue testing and see if I can find something else to
&gt; &gt;&gt; patch, ha! In the meantime can you please try and reproduce your lock-up
&gt; &gt;&gt; with the latest version of SSLify using your scripts? Also please give
&gt; &gt;&gt; the superbig tests a whirl by installing IO::Prompt::Tiny and re-running
&gt; &gt;&gt; the testsuite.
&gt; &gt;&gt;
&gt; &gt;&gt;       Maybe my testsuite didn&#39;t replicate yours fully as you mentioned
&gt; &gt;&gt; regarding latency being a possible factor. I made changes to
&gt; &gt;&gt; SSLify::write&#40;&#41; that worked around the lock-up that I manged to
&gt; &gt;&gt; replicate in the superbig tests on my machine. Please let me know if you
&gt; &gt;&gt; experience the lockup and I&#39;ll try to reproduce it on my side.
&gt; &gt;&gt;
&gt; &gt;&gt;       Thanks again and I hope we&#39;ll squash this bug soon!
&gt; &gt;&gt;
&gt; &gt;&gt; On 11/12/2014 06:23 PM, Joseph Huckaby via RT wrote:
<div class="message-stanza open">&gt; &gt;&gt;&gt;          Queue: POE-Component-SSLify
&gt; &gt;&gt;&gt;    Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95071">https://rt.cpan.org/Ticket/Display.html?id=95071</a></span> &gt;
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Hey man,
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Thanks for getting back to me!  I just tried SSLify v1.010 and it fails
</div>&gt; &gt;&gt; on
<div class="message-stanza open">&gt; &gt;&gt;&gt; the t/simple_parallel_large.t test number 86 with this output:
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; t/simple_parallel_large.t ..... 86/?
&gt; &gt;&gt;&gt; #   Failed test &#39;SERVER: SSLify_Options 3105: private key
&gt; &gt;&gt;&gt; # &#39;
&gt; &gt;&gt;&gt; #   at t/simple_parallel_large.t line 54.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; #   Failed test &#39;SERVER: Server_SSLify Please do SSLify_Options&#40;&#41;
</div></div>&gt; first &#40;
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt;&gt; or pass in a $ctx object &#41; at
&gt; &gt;&gt;&gt;
</div>&gt; &gt;&gt;
</div>&gt; /root/.cpanm/work/1415844865.2217/POE-Component-SSLify-1.010/blib/lib/POE/Component/SSLify.pm
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt;&gt; line 247.
&gt; &gt;&gt;&gt; # &#39;
&gt; &gt;&gt;&gt; #   at t/simple_parallel_large.t line 57.
&gt; &gt;&gt;&gt; Can&#39;t use an undefined value as a symbol reference at
&gt; &gt;&gt;&gt;
</div>&gt; &gt;&gt;
</div>&gt; /root/.cpanm/work/1415844865.2217/POE-Component-SSLify-1.010/blib/lib/POE/Component/SSLify.pm
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt;&gt; line 446.
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; Here is the full test output if it helps:
&gt; &gt;&gt;&gt;
</div>&gt; &gt;&gt;
</div>&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://www.dropbox.com/s/gpd9pyhs8lnbxig/sslify-v1.010-test-output-2014-11-12.txt?dl=0">https://www.dropbox.com/s/gpd9pyhs8lnbxig/sslify-v1.010-test-output-2014-11-12.txt?dl=0</a></span>
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt;&gt; Thanks again for your time on this!
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; - Joe
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt;
&gt; &gt;&gt;&gt; On Tue, Nov 11, 2014 at 10:22 PM, Apocalypse via RT &lt;
&gt; &gt;&gt;&gt; bug-POE-Component-SSLify@rt.cpan.org&gt; wrote:
&gt; &gt;&gt;&gt;
<div class="message-stanza open">&gt; &gt;&gt;&gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95071">https://rt.cpan.org/Ticket/Display.html?id=95071</a></span> &gt;
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; Hey,
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;     I had some luck and found some information that pointed towards a
</div></div></div>&gt; 16K
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt;&gt;&gt; limitation in the TLS packet sizes. It seems like on certain
</div></div>&gt; conditions
<div class="message-stanza open">&gt; &gt;&gt; the
<div class="message-stanza open">&gt; &gt;&gt;&gt;&gt; write&#40;&#41; call will lock up because the underlying buffers was not
</div>&gt; &gt;&gt; flushed. I
<div class="message-stanza open">&gt; &gt;&gt;&gt;&gt; haven&#39;t found the root cause for this but with my modification by
</div>&gt; &gt;&gt; clamping
<div class="message-stanza open">&gt; &gt;&gt;&gt;&gt; the writes the superbig tests passed! I&#39;ve just released v1.010 to
</div></div>&gt; CPAN
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt;&gt;&gt; with the change, can you please test it to see if it helps you? If
</div></div>&gt; not,
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt;&gt;&gt; then I&#39;ll have to attack it from a different angle :&#41;
&gt; &gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt; On Sat Apr 26 12:20:58 2014, jhuckaby@gmail.com wrote:
<div class="message-stanza open">&gt; &gt;&gt;&gt;&gt;&gt; Hey SSLify Team,
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; I believe I have found a bug using POE::Component::Server::TCP and
&gt; &gt;&gt;&gt;&gt;&gt; SSLify.  I have a very simple HTTPS web server &#40;created using the
&gt; &gt;&gt;&gt;&gt;&gt; cookbook example&#41;, which does nothing except serve up 300K of plain
&gt; &gt;&gt;&gt;&gt;&gt; text for every incoming HTTPS GET request.  This works fine until it
&gt; &gt;&gt;&gt;&gt;&gt; receives multiple requests at once.  Then it shoots up to 100% CPU
</div></div></div>&gt; and
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt;&gt;&gt;&gt; stays there indefinitely, long after the requests have completed.
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; Here is a snapshot of &#34;top&#34; on my server after sending in 10
&gt; &gt;&gt;&gt;&gt;&gt; simultaneous requests and allowing them to complete fully:
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
&gt; &gt;&gt;&gt;&gt;&gt; 1365 root      20   0  191m  20m 4168 R 99.9  0.6   0:10.95 perl
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; The CPU stays at or around 99.9% indefinitely &#40;I have witnessed
&gt; &gt;&gt;&gt;&gt;&gt; several days at least&#41;.  Also, something to note, even after the CPU
&gt; &gt;&gt;&gt;&gt;&gt; is pinned at 100%, the server still accepts new incoming connections,
&gt; &gt;&gt;&gt;&gt;&gt; and serves them.
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; Here is a ZIP file containing my script and sample SSL cert:
&gt; &gt;&gt;&gt;&gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug.zip">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug.zip</a></span>
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; Here are links to the individual files:
&gt; &gt;&gt;&gt;&gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-</a></span>
&gt; &gt;&gt;&gt;&gt;&gt; bug/server.pl
&gt; &gt;&gt;&gt;&gt;&gt;
</div></div>&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.crt">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.crt</a></span>
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt;&gt;&gt;&gt;
</div></div>&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.key">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.key</a></span>
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; I can reproduce the issue every time by sending in 10 simultaneous
&gt; &gt;&gt;&gt;&gt;&gt; HTTPS GET requests from a shell script such as this:
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; #!/bin/sh
&gt; &gt;&gt;&gt;&gt;&gt; # Fetch URL 10 times simultaneously
&gt; &gt;&gt;&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt;&gt;&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt;&gt;&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt;&gt;&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt;&gt;&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt;&gt;&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt;&gt;&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt;&gt;&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt;&gt;&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt;&gt;&gt;&gt;&gt; curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; The --insecure flag is to prevent curl from validating the cert
</div></div>&gt; &#40;which
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt;&gt;&gt;&gt; is self-signed&#41;.
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; I am running:
&gt; &gt;&gt;&gt;&gt;&gt; POE version 1.358
&gt; &gt;&gt;&gt;&gt;&gt; POE::Component::SSLify version 1.008
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; This is perl 5, version 16, subversion 3 &#40;v5.16.3&#41; built for x86_64-
&gt; &gt;&gt;&gt;&gt;&gt; linux-thread-multi
&gt; &gt;&gt;&gt;&gt;&gt; Linux pvp.effectgames.com 3.4.82-69.112.amzn1.x86_64 #1 SMP Mon Feb
</div></div>&gt; 24
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt;&gt;&gt;&gt; 16:31:21 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; openssl-perl-1.0.1g-1.69.amzn1.x86_64
&gt; &gt;&gt;&gt;&gt;&gt; openssl-1.0.1g-1.69.amzn1.x86_64
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; Other Notes: I cannot reproduce this without SSLify.  Meaning, if I
&gt; &gt;&gt;&gt;&gt;&gt; strip out all the SSL code and just run a plain HTTP server,
&gt; &gt;&gt;&gt;&gt;&gt; everything works fine.  Also note that I cannot seem to reproduce
</div></div>&gt; this
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt;&gt;&gt;&gt; on my local OS X machine hitting localhost, although I suspect that
</div></div>&gt; is
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt;&gt;&gt;&gt; because localhost is a virtual interface, and all the requests
&gt; &gt;&gt;&gt;&gt;&gt; complete &#34;instantly&#34;.  This bug seems to require a slower network
</div></div>&gt; &#40;DSL
<div class="message-stanza open"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt;&gt;&gt;&gt; to Amazon EC2 for example&#41; to occur.
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; If there is anything else you&#39;d like me to try, please let me know.
&gt; &gt;&gt;&gt;&gt;&gt; My server is at your disposal!
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; Thanks for your time!
&gt; &gt;&gt;&gt;&gt;&gt;
&gt; &gt;&gt;&gt;&gt;&gt; - Joe
</div>&gt; &gt;&gt;&gt;&gt; --
&gt; &gt;&gt;&gt;&gt; ~Apocalypse
&gt; &gt;&gt;&gt;&gt;
</div>&gt; &gt;&gt;
&gt; &gt;&gt;
</div>&gt;
&gt;
&gt;
</div></div></div>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;14&nbsp;15:32:59&nbsp;2014</span>
    <span class="description">APOCAL [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;14&nbsp;15:33:00&nbsp;2014</span>
    <span class="description">APOCAL [...] cpan.org -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;16&nbsp;02:45:05&nbsp;2014</span>
    <span class="description">jhuckaby [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95071] CPU pinned at 100% with SSLify and POE::Component::Server::TCP</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 15 Nov 2014 23:44:49 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE-Component-SSLify [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Joseph Huckaby &lt;jhuckaby [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;23&nbsp;21:55:11&nbsp;2014</span>
    <span class="description">jhuckaby [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95071] CPU pinned at 100% with SSLify and POE::Component::Server::TCP</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 23 Nov 2014 18:54:52 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE-Component-SSLify [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Joseph Huckaby &lt;jhuckaby [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
