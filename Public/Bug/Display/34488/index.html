<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #34488 for FCGI-Engine: Unexpected behavior when &#34;dropped-in&#34; to Catalyst</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #34488 for FCGI-Engine: Unexpected behavior when &#34;dropped-in&#34; to Catalyst</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/FCGI-Engine/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/FCGI-Engine/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/FCGI-Engine/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/FCGI-Engine/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/FCGI-Engine">FCGI-Engine CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">34488</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/FCGI-Engine/Active/">FCGI-Engine</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">stevan.little [...] gmail.com
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mpitts [...] a3its.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-220178-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.03    </td>
  </tr>
  <tr id="CF-220179-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;27&nbsp;16:42:32&nbsp;2008</span>
    <span class="description">INVINITY [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Unexpected behavior when &#34;dropped-in&#34; to Catalyst</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m interested in writing a patch to add better process management for
FCGI processes and FCGI::Engine seemed much more sane to me than
C::E::FastCGI and FCGI::ProcManager.

However, when attempting to create a script to launch an existing
Catalyst app as FastCGI processes via FCGI::Engine I get the following
strange behavior &#40;Apache 2.2 w/ mod_fastcgi talking to Catalyst via
console-launched external FastCGI socket&#41;:

1. Requests to Apache seem to connect and begin to get data but then
hang and Apache&#39;s memory usage skyrockets. Is there a bad loop somewhere
that&#39;s constantly writing to Apache? I can literally go back-and-forth
b/t my old C::E::FastCGI script and my new FCGI::Engine script and the
C::E::FastCGI version works fine.

2. The processes spawned via the FCGI::Engine script do not appear to
honor SIGNALs. Again I can go back-and-forth b/t my old C::E::FastCGI
script and the FCGI::Engine one and the latter does not respond to &#39;kill
-TERM&#39; only &#39;kill -KILL&#39;, while the processes created via the old-style
script seem to work fine when sent a SIGTERM.


######### BEGIN FCGI::Engine based script

#!/usr/bin/perl

#BEGIN {
#    $ENV{CATALYST_ENGINE} ||= &#39;CGI&#39;;
#}

use strict;
use warnings;

use FindBin;
use lib&#40;
    &#34;$FindBin::Bin/../lib&#34;,
    &#34;$FindBin::Bin/../ext-lib&#34;,
    &#41;;
    
use FCGI::Engine;
#use My::Cat::App;

FCGI::Engine-&gt;new_with_options&#40;
    handler_class  =&gt; &#39;My::Cat::App&#39;,
    handler_method =&gt; &#39;handle_request&#39;,
&#41;-&gt;run;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;27&nbsp;21:35:22&nbsp;2008</span>
    <span class="description">stevan.little [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> stevan.little [...] iinteractive.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Matthew,

Patches are very welcome.

I have had issues with Catalyst, mod_perl and Apache where errors thrown by Cat are not trapped correctly and throw 
Apache into a loop which attempts to consume all the available memory. We tried several times to debug this without 
success &#40;some of my coworkers are Core Cat developers too&#41;. Upgrading Catalyst seems to help this a little, along with 
some other really ugly hacks. However, this is probably not related to your issue, although it does sound kind of 
similar. However, this was before FCGI::Engine, and since then we have moved to Lighttpd from Apache. And to be 
completely honest, I didn&#39;t test this module much under Apache either since we don&#39;t use it much anymore.

There are some slight differences between C::E::FastCGI and FCGI::Engine, mostly in how they are daemonized. This 
may be what is causing the problem, and might be a good place to start looking.

- Stevan



On Thu Mar 27 16:42:32 2008, invinity wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m interested in writing a patch to add better process management for
&gt; FCGI processes and FCGI::Engine seemed much more sane to me than
&gt; C::E::FastCGI and FCGI::ProcManager.
&gt; 
&gt; However, when attempting to create a script to launch an existing
&gt; Catalyst app as FastCGI processes via FCGI::Engine I get the following
&gt; strange behavior &#40;Apache 2.2 w/ mod_fastcgi talking to Catalyst via
&gt; console-launched external FastCGI socket&#41;:
&gt; 
&gt; 1. Requests to Apache seem to connect and begin to get data but then
&gt; hang and Apache&#39;s memory usage skyrockets. Is there a bad loop somewhere
&gt; that&#39;s constantly writing to Apache? I can literally go back-and-forth
&gt; b/t my old C::E::FastCGI script and my new FCGI::Engine script and the
&gt; C::E::FastCGI version works fine.
&gt; 
&gt; 2. The processes spawned via the FCGI::Engine script do not appear to
&gt; honor SIGNALs. Again I can go back-and-forth b/t my old C::E::FastCGI
&gt; script and the FCGI::Engine one and the latter does not respond to &#39;kill
&gt; -TERM&#39; only &#39;kill -KILL&#39;, while the processes created via the old-style
&gt; script seem to work fine when sent a SIGTERM.
&gt; 
&gt; 
&gt; ######### BEGIN FCGI::Engine based script
&gt; 
&gt; #!/usr/bin/perl
&gt; 
&gt; #BEGIN {
&gt; #    $ENV{CATALYST_ENGINE} ||= &#39;CGI&#39;;
&gt; #}
&gt; 
&gt; use strict;
&gt; use warnings;
&gt; 
&gt; use FindBin;
&gt; use lib&#40;
&gt;     &#34;$FindBin::Bin/../lib&#34;,
&gt;     &#34;$FindBin::Bin/../ext-lib&#34;,
&gt;     &#41;;
&gt;     
&gt; use FCGI::Engine;
&gt; #use My::Cat::App;
&gt; 
&gt; FCGI::Engine-&gt;new_with_options&#40;
&gt;     handler_class  =&gt; &#39;My::Cat::App&#39;,
&gt;     handler_method =&gt; &#39;handle_request&#39;,
&gt; &#41;-&gt;run;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;27&nbsp;21:35:24&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;29&nbsp;14:14:04&nbsp;2008</span>
    <span class="description">INVINITY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mpitts [...] a3its.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Mar 27 21:35:22 2008, STEVAN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Matthew,
&gt; 
&gt; Patches are very welcome.
&gt; 
&gt; I have had issues with Catalyst, mod_perl and Apache where errors
&gt; thrown by Cat are not trapped correctly and throw
&gt; Apache into a loop which attempts to consume all the available memory.
&gt; We tried several times to debug this without
&gt; success &#40;some of my coworkers are Core Cat developers too&#41;. Upgrading
&gt; Catalyst seems to help this a little, along with
&gt; some other really ugly hacks. However, this is probably not related to
&gt; your issue, although it does sound kind of
&gt; similar. However, this was before FCGI::Engine, and since then we have
&gt; moved to Lighttpd from Apache. And to be
&gt; completely honest, I didn&#39;t test this module much under Apache either
&gt; since we don&#39;t use it much anymore.
&gt; 
&gt; There are some slight differences between C::E::FastCGI and
&gt; FCGI::Engine, mostly in how they are daemonized. This
&gt; may be what is causing the problem, and might be a good place to start
&gt; looking.
</div>
Thanks for the quick response.

Actually, it turned out to be the missing MyApp-&gt;write method from
C::E::FastCGI. I assumed that by using FCGI::Engine, Catalyst wouldn&#39;t
need to use C::E::FastCGI, but because Catalyst delegates $c-&gt;write to 
$c-&gt;engine-&gt;write the FastCGI compatible write method still needs to exist.

I guess a solution to this would be to subclass FCGI::Engine in the
C::Engine namespace, copy over the C::Engine::FastCGI-&gt;write method, and
write the myapp_fastcgi.pl script as necessary. However, I doubt that
the need for a FastCGI-compatiable write method is only a problem in the
Catalyst world.

Thoughts?

v/r

-matt pitts
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;29&nbsp;15:08:34&nbsp;2008</span>
    <span class="description">stevan.little [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> stevan.little [...] iinteractive.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Matthew,

On Sat Mar 29 14:14:04 2008, invinity wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Actually, it turned out to be the missing MyApp-&gt;write method from
&gt; C::E::FastCGI. I assumed that by using FCGI::Engine, Catalyst wouldn&#39;t
&gt; need to use C::E::FastCGI, but because Catalyst delegates $c-&gt;write to 
&gt; $c-&gt;engine-&gt;write the FastCGI compatible write method still needs to exist.
</div>
Ahh good catch!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I guess a solution to this would be to subclass FCGI::Engine in the
&gt; C::Engine namespace, copy over the C::Engine::FastCGI-&gt;write method, and
&gt; write the myapp_fastcgi.pl script as necessary. However, I doubt that
&gt; the need for a FastCGI-compatiable write method is only a problem in the
&gt; Catalyst world.
</div>
Actually now that you talk about it and I looked over my Cat apps using FCGI::Engine I realize that I never 
replaced C::E::FastCGI with FCGI::Engine at the application level, but instead use the FCGI::Engine::Manager to 
manage my C::E::FastCGI apps. Really FCGI::Engine is only compatible with C::E::FastCGI in terms of it&#39;s command 
line API, not with it&#39;s API to Cat, sorry I should have been more explicit about that in the docs.

I have planned to eventually write a Cat::Engine::FCGI::Engine, but I haven&#39;t found the time &#40;or had the need fully 
yet&#41;. If you want to take a stab at it, please feel free. If you want to do this, probably best to take this 
conversation off RT and onto regular email, you can email me at my stevan@cpan.org address and we can 
discuss.

THanks,

- Stevan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;10&nbsp;11:21:18&nbsp;2008</span>
    <span class="description">stevan.little [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have added a note to the docs about usage with Catalyst in the latest release &#40;0.04&#41;. Eventually 
it would be nice to have a Catalyst::Engine::FCGI::Engine, but the need is minimal so i think that 
docs will suffice for now. 

Thanks,

- Stevan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;10&nbsp;11:21:27&nbsp;2008</span>
    <span class="description">stevan.little [...] gmail.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;10&nbsp;11:21:34&nbsp;2008</span>
    <span class="description">stevan.little [...] gmail.com -  Given to STEVAN</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
