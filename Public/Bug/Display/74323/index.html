<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #74323 for Math-Currency: Test failure with unicode locale</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #74323 for Math-Currency: Test failure with unicode locale</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Math-Currency/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Math-Currency/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Math-Currency/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Math-Currency/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Math-Currency">Math-Currency CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">74323</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Math-Currency/Active/">Math-Currency</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
matt.lawrence [...] virgin.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-20602-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.47    </td>
  </tr>
  <tr id="CF-20603-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.49    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;24&nbsp;10:44:51&nbsp;2012</span>
    <span class="description">matt.lawrence [...] virgin.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Test failure with unicode locale</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">t/004-localize.t is failing for me:

t/004_localize.t .. 1/32 
#   Failed test &#39;       &#39;£&#39;     = &#39;�&#39;&#39;
#   at t/004_localize.t line 45.
# Looks like you failed 1 test of 32.


This is a UTF-8 pound sign being compared to an iso-8859-1 character.
This arises because the only en_GB locale available on this system is
en_GB.utf8

$ locale -a | grep ^en_GB
en_GB.utf8

In this situation, localeconv produces UTF-8 bytes for currency_symbol,
so to meaningfully compare this to the single-byte version found in
Math::Currency::en_GB, both values need to be decoded from the
appropriate character set.

The attached patch addresses this in the tests, along with a relatively
minor warning about deprecated syntax and a POD formatting problem &#40;see
<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~jpeacock/Math-Currency-0.47/lib/Math/Currency.pm#Format_Parameters&#41;">http://search.cpan.org/~jpeacock/Math-Currency-0.47/lib/Math/Currency.pm#Format_Parameters&#41;</a></span>.
I&#39;ve run the tests on an environment with access to a non-unicode en_GB
locale and they continue to pass after the patch.


It might be preferable for the class itself to produce unicode output
where appropriate, although this would probably be best provided
optionally to maintain backwards compatibility.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Math-Currency-0.47.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/lib/Math/Currency.pm b/lib/Math/Currency.pm
index eb3b029..3170a16 100644
--- a/lib/Math/Currency.pm
+++ b/lib/Math/Currency.pm
@@ -681,6 +681,7 @@ like this:
 The format must contains all of the commonly configured LC_MONETARY
 Locale settings.  For example, these are the values of the default US format
 &#40;with comments&#41;:
+
   {
     INT_CURR_SYMBOL    =&gt; &#39;USD&#39;,  # ISO currency text
     CURRENCY_SYMBOL    =&gt; &#39;$&#39;,    # Local currency character
diff --git a/t/002_basic.t b/t/002_basic.t
index 3bc4cf8..f116702 100644
--- a/t/002_basic.t
+++ b/t/002_basic.t
@@ -41,12 +41,12 @@ sub run_tests {
 
     ok &#40; defined $FORMAT, &#34;format defaults configured&#34; &#41;;
 
-    foreach $param qw&#40; INT_CURR_SYMBOL CURRENCY_SYMBOL MON_DECIMAL_POINT
+    foreach $param &#40;qw&#40; INT_CURR_SYMBOL CURRENCY_SYMBOL MON_DECIMAL_POINT
 		       MON_THOUSANDS_SEP MON_GROUPING POSITIVE_SIGN
 		       NEGATIVE_SIGN INT_FRAC_DIGITS FRAC_DIGITS
 		       P_CS_PRECEDES P_SEP_BY_SPACE N_CS_PRECEDES
 		       N_SEP_BY_SPACE P_SIGN_POSN N_SIGN_POSN
-		     &#41; # hardcoded keys to be sure they are all there
+		     &#41;&#41; # hardcoded keys to be sure they are all there
     {
 	    ok &#40; defined $CLASS-&gt;format&#40;$param&#41;, sprintf&#40;&#34; \t%-20s = &#39;%s&#39;&#34;,$param,$CLASS-&gt;format&#40;$param&#41;&#41; &#41;;
     }
diff --git a/t/004_localize.t b/t/004_localize.t
index 227d2b9..602cc5c 100644
--- a/t/004_localize.t
+++ b/t/004_localize.t
@@ -1,6 +1,8 @@
 #!/usr/bin/perl -w
 use Test::More tests =&gt; 32;
 use Math::Currency qw&#40;$LC_MONETARY&#41;;
+use Encode qw&#40; is_utf8 decode &#41;;
+use I18N::Langinfo qw&#40; langinfo CODESET &#41;;
 
 # monetary_locale testing
 use POSIX qw&#40; locale_h &#41;;
@@ -8,22 +10,36 @@ my $locale = setlocale&#40; LC_ALL, &#34;en_GB&#34; &#41;;
 my $format = {};
 Math::Currency-&gt;localize&#40; \$format &#41;;
 
+# hardcoded keys to be sure they are all there
+my @format_keys = qw&#40;
+      INT_CURR_SYMBOL
+      CURRENCY_SYMBOL
+      MON_DECIMAL_POINT
+      MON_THOUSANDS_SEP
+      MON_GROUPING
+      POSITIVE_SIGN
+      NEGATIVE_SIGN
+      INT_FRAC_DIGITS
+      FRAC_DIGITS
+
+      P_CS_PRECEDES
+      P_SEP_BY_SPACE
+      P_SIGN_POSN
+
+      N_CS_PRECEDES
+      N_SEP_BY_SPACE
+      N_SIGN_POSN
+&#41;;
+
+
 SKIP: {
     skip &#40;&#34;No locale support&#34;, 16&#41; unless Math::Currency-&gt;localize&#40;&#41;;
     pass&#40;&#34;Re-initialized locale with en_GB&#34;&#41;;
 
-    foreach my $param qw&#40;
-      INT_CURR_SYMBOL CURRENCY_SYMBOL MON_DECIMAL_POINT
-      MON_THOUSANDS_SEP MON_GROUPING POSITIVE_SIGN
-      NEGATIVE_SIGN INT_FRAC_DIGITS FRAC_DIGITS
-      P_CS_PRECEDES P_SEP_BY_SPACE N_CS_PRECEDES
-      N_SEP_BY_SPACE P_SIGN_POSN N_SIGN_POSN
-      &#41;    # hardcoded keys to be sure they are all there
-      {
+    foreach my $param &#40;@format_keys&#41; {
         ok&#40; defined $format-&gt;{$param},
             sprintf&#40; &#34; \t%-20s = &#39;%s&#39;&#34;, $param, $format-&gt;{$param} &#41; &#41;;
-      }
-
+    }
 }
 
 SKIP: {
@@ -33,18 +49,14 @@ SKIP: {
     	unless $format-&gt;{INT_CURR_SYMBOL} =~ /GBP/;
 
     use_ok&#40;&#34;Math::Currency::en_GB&#34;&#41;;
-    foreach my $param qw&#40;
-      INT_CURR_SYMBOL CURRENCY_SYMBOL MON_DECIMAL_POINT
-      MON_THOUSANDS_SEP MON_GROUPING POSITIVE_SIGN
-      NEGATIVE_SIGN INT_FRAC_DIGITS FRAC_DIGITS
-      P_CS_PRECEDES P_SEP_BY_SPACE N_CS_PRECEDES
-      N_SEP_BY_SPACE P_SIGN_POSN N_SIGN_POSN
-      &#41;    # hardcoded keys to be sure they are all there
-      {
+    foreach my $param &#40;@format_keys&#41; {
 	my $global_param = $LC_MONETARY-&gt;{&#39;en_GB&#39;}-&gt;{$param};
-        ok&#40; $format-&gt;{$param} eq $global_param,
+        $global_param = decode&#40;&#39;ISO-8859-1&#39;, $global_param&#41;;
+        $format-&gt;{$param} = decode&#40;langinfo&#40;CODESET&#41;, $format-&gt;{$param}&#41;;
+        
+        is&#40;$format-&gt;{$param}, $global_param,
             sprintf&#40; &#34; \t&#39;%s&#39;\t= &#39;%s&#39;&#34;, $format-&gt;{$param}, $global_param &#41; &#41;;
-      }
+    }
 }
 SKIP: {
     my $mckensie = Math::Currency-&gt;new&#40;&#34;4.56&#34;,&#34;CAD&#34;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;16&nbsp;12:55:53&nbsp;2016</span>
    <span class="description">MSCHOUT [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi.

I have just uploaded Math::Currency v0.48 to CPAN which I believe fixes this issue.

Can you please let me know if you are still experiencing this error with v0.48 &#40;which it hits the mirrors&#41;?

-- 
Regards,
Michael Schout
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;16&nbsp;12:55:53&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;16&nbsp;12:55:59&nbsp;2016</span>
    <span class="description">MSCHOUT [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi.

I have just uploaded Math::Currency v0.48 to CPAN which I believe fixes this issue.

Can you please let me know if you are still experiencing this error with v0.48 &#40;which it hits the mirrors&#41;?

-- 
Regards,
Michael Schout
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;21&nbsp;19:06:31&nbsp;2016</span>
    <span class="description">MSCHOUT [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This has been corrected in v0.49 which has just been uploaded to CPAN.

The issue is really that POSIX::localeconv&#40;&#41; returns data that is encoded in whatever the current locale setting is set to.  Sometimes this is UTF-8, but it could be any other charset depending on what the locale is.  In addition, perl 5.22 and later now automatically turn on the UTF8 flag if localeconv&#40;&#41; returned UTF-8 encoded data.

Math::Currency now decodes correctly &#40;unless the UTF8 flag is already on, in which case we leave it as-is&#41; in all of these cases, tested on 5.8.9 through 5.24.0 with tests in t/009_localeconv_encoding.t.
-- 
Regards,
Michael Schout
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;21&nbsp;19:06:42&nbsp;2016</span>
    <span class="description">MSCHOUT [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;22&nbsp;09:10:17&nbsp;2016</span>
    <span class="description">MSCHOUT [...] cpan.org -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;22&nbsp;09:10:23&nbsp;2016</span>
    <span class="description">MSCHOUT [...] cpan.org -  Fixed in 0.49 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
