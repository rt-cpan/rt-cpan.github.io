<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #13582 for DBD-mysql: prepare &#38; execute corruption in 3.000</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #13582 for DBD-mysql: prepare &#38; execute corruption in 3.000</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-mysql/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-mysql/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-mysql/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-mysql/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-mysql">DBD-mysql CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">13582</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-mysql/Active/">DBD-mysql</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dennis.doyle [...] morgandoyle.co.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-10170-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
3.0000    </td>
  </tr>
  <tr id="CF-10171-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;07&nbsp;13:56:11&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> prepare &#38; execute corruption in 3.000</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

A bug seems to have been introduced between DBD:mysql versions 2.9008 and 3.0000.

o/s is:
Linux ultra4.me2uweb.net 2.4.21-27.0.2.ELsmp #1 SMP Wed Jan 12 23:35:44 EST 2005 i686 i686 i386 GNU/Linux

It seems to be related to $dbh-&gt;prepare with DELAYED syntax &#38; $sth-&gt;execute
and escaping quotes and/or escaped quotes.

It looks like corruption of memory from the stderr trace logging which contains control characters so I am unable to past it into this - see attached file.

It manfests itself in many different ways
- sometimes a runaway process
- sometimes apparently stalling in the execute
- sometimes producing a segmentation violation
these symptoms change if you make the smallest change to any of the code,
including changing the tracelevel.

On 3 different installations of 2.9008 this style of code has been working fine for months.

The 2 different installations of 3.0000 this style of code has been falling all over the place
since 3.0000 was installed on Saturday 2/7/5.

Hope the following helps:

The following small testharness reproduces one variant of the bug:

It returns status code: 65280.
The database field is updated.
The tracelog complains about invalid SQL because the sting being inserted 
appears to have been overwritten towards the end with STX NULL NULL NULL

The stdout from 3.0000 which fails is:

------------------------------------------------------------------------------------------
testfred starts

This is perl, v5.8.4 built for i686-linux

Copyright 1987-2004, Larry Wall

Perl may be copied only under the terms of either the Artistic License or the
GNU General Public License, which may be found in the Perl 5 source kit.

Complete documentation for Perl, including FAQ lists, should be found on
this system using `man perl&#39; or `perldoc perl&#39;.  If you have access to the
Internet, point your browser at <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perl.com/">http://www.perl.com/</a></span>, the Perl Home Page.

module DBI OK; version: 1.48
module DBD::mysql OK; version: 3.0000
testfred Preparing handle
testfred Executing 12
testfred Executing long
------------------------------------------------------------------------------------------

The stderr tracelog with connect params removed for security reasons, from 2.9008 which works is:

------------------------------------------------------------------------------------------

    -&gt; prepare for DBD::mysql::db &#40;DBI::db=HASH&#40;0x82093ec&#41;~0x833e658 &#39;
        INSERT DELAYED INTO Test1 &#40;
        Message&#41; VALUES &#40;?&#41;
        &#39;&#41;
Setting mysql_use_result to 0
    &lt;- prepare= DBI::st=HASH&#40;0x833e7d8&#41; at testfred13.pl line 46
    -&gt; execute for DBD::mysql::st &#40;DBI::st=HASH&#40;0x833e7d8&#41;~0x81f12ac &#39;\&#34;12\&#34;&#39;&#41;
    -&gt; dbd_st_execute for 081f109c
      -&gt; mysql_st_interal_execute
      Binding parameters: INSERT DELAYED INTO Test1 &#40;
        Message&#41; VALUES &#40;&#39;\\\&#34;12\\\&#34;&#39;&#41;
        
      &lt;- mysql_st_internal_execute returning rows 1
    &lt;- dbd_st_execute returning imp_sth-&gt;row_num 1
    &lt;- execute= 1 at testfred13.pl line 53
    -&gt; execute for DBD::mysql::st &#40;DBI::st=HASH&#40;0x833e7d8&#41;~0x81f12ac &#39;FINAL LOCATION\n\nURL: <span class="clickylink"><a target="new" rel="nofollow" href="http://myweb.tiscali.co.uk/dennisdoylewrong">http://myweb.tiscali.co.uk/dennisdoylewrong</a></span>\nReturn Code: 404\nReturn Message: Not Found\nPage Size: 707\nHeaders: \nConnection: close\nDate: Thu, 07 Jul 2005 14:19:58 GMT\nAccept-Ranges: bytes\nETag: \&#34;32410b-2c3-3cb2ead0\&#34;\nServer: Apache/1.3.22 &#40;Unix&#41; mod_throttle/3.1.2\nVary: Host\nContent-Length: 707\nContent-Type: text/html\nLast-Modified: Tue, 09 Apr 2002 13:21:2...&#39;&#41;
    -&gt; dbd_st_execute for 081f109c
      -&gt; mysql_st_interal_execute
      Binding parameters: INSERT DELAYED INTO Test1 &#40;
        Message&#41; VALUES &#40;&#39;FINAL LOCATION\\n\\nURL: <span class="clickylink"><a target="new" rel="nofollow" href="http://myweb.tiscali.co.uk/dennisdoylewrong">http://myweb.tiscali.co.uk/dennisdoylewrong</a></span>\\nReturn Code: 404\\nReturn Message: Not Found\\nPage Size: 707\\nHeaders: \\nConnection: close\\nDate: Thu, 07 Jul 2005 14:19:58 GMT\\nAccept-Ranges: bytes\\nETag: \\\&#34;32410b-2c3-3cb2ead0\\\&#34;\\nServer: Apache/1.3.22 &#40;Unix&#41; mod_throttle/3.1.2\\nVary: Host\\nContent-Length: 707\\nContent-Type: text/html\\nLast-Modified: Tue, 09 Apr 2002 13:21:20 GMT\\nClient-Date: Thu, 07 Jul 2005 14:20:16 GMT\\nClient-Peer: 212.74.114.59:80\\nClient-Response-Num: 1\\nRefresh: 0; url=<span class="clickylink"><a target="new" rel="nofollow" href="http://www.tiscali.co.uk/services/webspace/404.html">http://www.tiscali.co.uk/services/webspace/404.html</a></span>\\n\\n&#39;&#41;
        
      &lt;- mysql_st_internal_execute returning rows 1
    &lt;- dbd_st_execute returning imp_sth-&gt;row_num 1
    &lt;- execute= 1 at testfred13.pl line 58
    -&gt; finish for DBD::mysql::st &#40;DBI::st=HASH&#40;0x833e7d8&#41;~0x81f12ac&#41;
    &lt;- finish= 1 at testfred13.pl line 62
    -&gt; disconnect for DBD::mysql::db &#40;DBI::db=HASH&#40;0x82093ec&#41;~0x833e658&#41;
&#38;imp_dbh-&gt;mysql: 833ea44
    &lt;- disconnect= 1 at testfred13.pl line 63
    -&gt; DESTROY for DBD::mysql::st &#40;DBI::st=HASH&#40;0x81f12ac&#41;~INNER&#41;
    &lt;- DESTROY= undef
    -&gt; DESTROY for DBD::mysql::db &#40;DBI::db=HASH&#40;0x833e658&#41;~INNER&#41;
    &lt;- DESTROY= undef
------------------------------------------------------------------------------------------

The stdout from 2.9008 which works is:

------------------------------------------------------------------------------------------
testfred starts

This is perl, v5.8.4 built for i686-linux

Copyright 1987-2004, Larry Wall

Perl may be copied only under the terms of either the Artistic License or the
GNU General Public License, which may be found in the Perl 5 source kit.

Complete documentation for Perl, including FAQ lists, should be found on
this system using `man perl&#39; or `perldoc perl&#39;.  If you have access to the
Internet, point your browser at <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perl.com/">http://www.perl.com/</a></span>, the Perl Home Page.

module DBI OK; version: 1.48
module DBD::mysql OK; version: 2.9008
testfred Preparing handle
testfred Executing 12
testfred Executing long
testfred Ending

------------------------------------------------------------------------------------------

To reproduce the bug:

Create a table with a single text field:

CREATE TABLE `Test1` &#40;
  `Message` text NOT NULL
&#41; TYPE=MyISAM;

Then run the following test script - replacing XXX, YYY &#38; ZZZ with your connect paramters::

#!/usr/bin/perl -w
$|=1;
# DATE: 6/7/5

print &#34;testfred starts\n&#34;;

my $version;
my $dbh;
my $sthdiag;
my $ans;
my $diagnostic;

print `perl -v`;

eval &#34;use DBI&#34;;
if &#40;$@ ne &#34;&#34;&#41;
{
        print&#40;&#34;module DBI LOAD FAILED - $@\n&#34;&#41;;
}
else
{
        $version = getversion&#40;&#34;DBI&#34;&#41;;
        print &#34;module DBI OK; version: $version\n&#34;;
}

eval &#34;use DBD::mysql&#34;;
if &#40;$@ ne &#34;&#34;&#41;
{
        print&#40;&#34;module DBD::mysql LOAD FAILED - $@\n&#34;&#41;;
}
else
{
        $version = getversion&#40;&#34;DBD::mysql&#34;&#41;;
        print &#34;module DBD::mysql OK; version: $version\n&#34;;
}

if &#40;!&#40;$dbh = DBI-&gt;connect&#40;&#39;XXX&#39;, &#39;YYY&#39;, &#39;ZZZ&#39;,
        { AutoCommit =&gt; 1, RaiseError =&gt; 1, PrintError =&gt; 1, TraceLevel =&gt; 2} &#41;&#41;&#41;
{
        print&#40;$dbh-&gt;errstr&#41;;
        exit;
}

print &#34;testfred Preparing handle\n&#34;;

$sthdiag = $dbh-&gt;prepare&#40;q{
        INSERT DELAYED INTO Test1 &#40;
        Message&#41; VALUES &#40;?&#41;
        }&#41;;

print &#34;testfred Executing 12\n&#34;;

$ans = $sthdiag-&gt;execute&#40;&#39;\&#34;12\&#34;&#39;&#41;;

print &#34;testfred Executing long\n&#34;;

$diagnostic = &#39;FINAL LOCATION\n\nURL: <span class="clickylink"><a target="new" rel="nofollow" href="http://myweb.tiscali.co.uk/dennisdoylewrong">http://myweb.tiscali.co.uk/dennisdoylewrong</a></span>\nReturn Code: 404\nReturn Message: Not Found\nPage Size: 707\nHeaders: \nConnection: close\nDate: Thu, 07 Jul 2005 14:19:58 GMT\nAccept-Ranges: bytes\nETag: \&#34;32410b-2c3-3cb2ead0\&#34;\nServer: Apache/1.3.22 &#40;Unix&#41; mod_throttle/3.1.2\nVary: Host\nContent-Length: 707\nContent-Type: text/html\nLast-Modified: Tue, 09 Apr 2002 13:21:20 GMT\nClient-Date: Thu, 07 Jul 2005 14:20:16 GMT\nClient-Peer: 212.74.114.59:80\nClient-Response-Num: 1\nRefresh: 0; url=<span class="clickylink"><a target="new" rel="nofollow" href="http://www.tiscali.co.uk/services/webspace/404.html">http://www.tiscali.co.uk/services/webspace/404.html</a></span>\n\n&#39;;
$ans = $sthdiag-&gt;execute&#40;$diagnostic&#41;;

print &#34;testfred Ending\n&#34;;

$sthdiag-&gt;finish&#40;&#41;;
$dbh-&gt;disconnect&#40;&#41;;
exit;

print &#34;testfred ends\n&#34;;

exit;

sub getversion
{
my $mod = shift;
my $vers = `$^X -m$mod -e &#39;print \$${mod}::VERSION&#39; 2&gt;/dev/null`;
$vers =~ s/^\s*&#40;.*?&#41;\s*$/$1/; # remove stray whitespace
return &#40;$vers || undef&#41;;
}
1;
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
    -&gt; prepare for DBD::mysql::db &#40;DBI::db=HASH&#40;0x8df450c&#41;~0x8ed8d30 &#39;
	INSERT DELAYED INTO Test1 &#40;
	Message&#41; VALUES &#40;?&#41;
	&#39;&#41;
    &lt;- prepare= DBI::st=HASH&#40;0x8ed8ea4&#41; at testfred13.pl line 46
    -&gt; execute for DBD::mysql::st &#40;DBI::st=HASH&#40;0x8ed8ea4&#41;~0x8d8b2a0 &#39;\&#34;12\&#34;&#39;&#41;
    -&gt; dbd_st_execute for 08d8b09c
Binding parameters: INSERT DELAYED INTO Test1 &#40;
	Message&#41; VALUES &#40;&#39;\\\&#34;12\\\&#34;&#39;&#41;
	
    &lt;- dbd_st_execute returning imp_sth-&gt;row_num 1
    &lt;- execute= 1 at testfred13.pl line 53
    -&gt; execute for DBD::mysql::st &#40;DBI::st=HASH&#40;0x8ed8ea4&#41;~0x8d8b2a0 &#39;FINAL LOCATION\n\nURL: <span class="clickylink"><a target="new" rel="nofollow" href="http://myweb.tiscali.co.uk/dennisdoylewrong">http://myweb.tiscali.co.uk/dennisdoylewrong</a></span>\nReturn Code: 404\nReturn Message: Not Found\nPage Size: 707\nHeaders: \nConnection: close\nDate: Thu, 07 Jul 2005 14:19:58 GMT\nAccept-Ranges: bytes\nETag: \&#34;32410b-2c3-3cb2ead0\&#34;\nServer: Apache/1.3.22 &#40;Unix&#41; mod_throttle/3.1.2\nVary: Host\nContent-Length: 707\nContent-Type: text/html\nLast-Modified: Tue, 09 Apr 2002 13:21:2...&#39;&#41;
    -&gt; dbd_st_execute for 08d8b09c
Binding parameters: INSERT DELAYED INTO Test1 &#40;
	Message&#41; VALUES &#40;&#39;FINAL LOCATION\\n\\nURL: <span class="clickylink"><a target="new" rel="nofollow" href="http://myweb.tiscali.co.uk/dennisdoylewrong">http://myweb.tiscali.co.uk/dennisdoylewrong</a></span>\\nReturn Code: 404\\nReturn Message: Not Found\\nPage Size: 707\\nHeaders: \\nConnection: close\\nDate: Thu, 07 Jul 2005 14:19:58 GMT\\nAccept-Ranges: bytes\\nETag: \\\&#34;32410b-2c3-3cb2ead0\\\&#34;\\nServer: Apache/1.3.22 &#40;Unix&#41; mod_throttle/3.1.2\\nVary: Host\\nContent-Length: 707\\nContent-Type: text/html\\nLast-Modified: Tue, 09 Apr 2002 13:21:20 GMT\\nClient-Date: Thu, 07 Jul 2005 14:20:16 GMT\\nClient-Peer: 212.74.114.59:80\\nClient-Response-Num: 1\\nRefresh: 0; url=<span class="clickylink"><a target="new" rel="nofollow" href="http://www.tiscali.co.uk/services/webspac">http://www.tiscali.co.uk/services/webspac</a></span>©  Binding paramete
You have an error in your SQL syntax.  Check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&#39;FINAL LOCATION\\n\\nURL: <span class="clickylink"><a target="new" rel="nofollow" href="http://myweb.tiscali.co.uk/dennisdoyl">http://myweb.tiscali.co.uk/dennisdoyl</a></span> error 1064 recorded: You have an error in your SQL syntax.  Check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&#39;FINAL LOCATION\\n\\nURL: <span class="clickylink"><a target="new" rel="nofollow" href="http://myweb.tiscali.co.uk/dennisdoyl">http://myweb.tiscali.co.uk/dennisdoyl</a></span>
    &lt;- dbd_st_execute returning imp_sth-&gt;row_num 18446744073709551614
    !! ERROR: 1064 &#39;You have an error in your SQL syntax.  Check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&#39;FINAL LOCATION\\n\\nURL: <span class="clickylink"><a target="new" rel="nofollow" href="http://myweb.tiscali.co.uk/dennisdoyl&#39;">http://myweb.tiscali.co.uk/dennisdoyl&#39;</a></span> &#40;err#0&#41;
    &lt;- execute= undef at testfred13.pl line 58
DBD::mysql::st execute failed: You have an error in your SQL syntax.  Check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&#39;FINAL LOCATION\\n\\nURL: <span class="clickylink"><a target="new" rel="nofollow" href="http://myweb.tiscali.co.uk/dennisdoyl">http://myweb.tiscali.co.uk/dennisdoyl</a></span> at ./testfred13.pl line 58.
DBD::mysql::st execute failed: You have an error in your SQL syntax.  Check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&#39;FINAL LOCATION\\n\\nURL: <span class="clickylink"><a target="new" rel="nofollow" href="http://myweb.tiscali.co.uk/dennisdoyl">http://myweb.tiscali.co.uk/dennisdoyl</a></span> at ./testfred13.pl line 58.
    -&gt; DESTROY for DBD::mysql::st &#40;DBI::st=HASH&#40;0x8d8b2a0&#41;~INNER&#41;
       ERROR: 1064 &#39;You have an error in your SQL syntax.  Check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&#39;FINAL LOCATION\\n\\nURL: <span class="clickylink"><a target="new" rel="nofollow" href="http://myweb.tiscali.co.uk/dennisdoyl&#39;">http://myweb.tiscali.co.uk/dennisdoyl&#39;</a></span> &#40;err#0&#41;
    &lt;- DESTROY= undef
    -&gt; DESTROY for DBD::mysql::db &#40;DBI::db=HASH&#40;0x8ed8d30&#41;~INNER&#41;
&#38;imp_dbh-&gt;mysql: 8ed90bc
       ERROR: 1064 &#39;You have an error in your SQL syntax.  Check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&#39;FINAL LOCATION\\n\\nURL: <span class="clickylink"><a target="new" rel="nofollow" href="http://myweb.tiscali.co.uk/dennisdoyl&#39;">http://myweb.tiscali.co.uk/dennisdoyl&#39;</a></span> &#40;err#0&#41;
    &lt;- DESTROY= undef
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;08&nbsp;08:28:45&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dennis.doyle [...] morgandoyle.co.uk</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Thu Jul  7 13:56:11 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; A bug seems to have been introduced between DBD:mysql versions 2.9008
&gt;    and 3.0000.
&gt; 
&gt; o/s is:
&gt; Linux ultra4.me2uweb.net 2.4.21-27.0.2.ELsmp #1 SMP Wed Jan 12
&gt;    23:35:44 EST 2005 i686 i686 i386 GNU/Linux
&gt; 
&gt; It seems to be related to $dbh-&gt;prepare with DELAYED syntax &#38; $sth-
<div class="message-stanza open">&gt;    &gt;execute
</div>&gt; and escaping quotes and/or escaped quotes.
&gt; 
&gt; It looks like corruption of memory from the stderr trace logging 
</div>which
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;    contains control characters so I am unable to past it into this -
&gt;    see attached file.
&gt; 
&gt; It manfests itself in many different ways
&gt; - sometimes a runaway process
&gt; - sometimes apparently stalling in the execute
&gt; - sometimes producing a segmentation violation
&gt; these symptoms change if you make the smallest change to any of the
&gt;    code,
&gt; including changing the tracelevel.
&gt; 
&gt; On 3 different installations of 2.9008 this style of code has been
&gt;    working fine for months.
&gt; 
&gt; The 2 different installations of 3.0000 this style of code has been
&gt;    falling all over the place
&gt; since 3.0000 was installed on Saturday 2/7/5.
&gt; 
&gt; Hope the following helps:
&gt; 
&gt; The following small testharness reproduces one variant of the bug:
&gt; 
&gt; It returns status code: 65280.
&gt; The database field is updated.
&gt; The tracelog complains about invalid SQL because the sting being
&gt;    inserted
&gt; appears to have been overwritten towards the end with STX NULL NULL
&gt;    NULL
&gt; 
&gt; The stdout from 3.0000 which fails is:
&gt; 
&gt; ---------------------------------------------------------------------
</div>---------------------
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; testfred starts
&gt; 
&gt; This is perl, v5.8.4 built for i686-linux
&gt; 
&gt; Copyright 1987-2004, Larry Wall
&gt; 
&gt; Perl may be copied only under the terms of either the Artistic 
</div>License
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;    or the
&gt; GNU General Public License, which may be found in the Perl 5 source
&gt;    kit.
&gt; 
&gt; Complete documentation for Perl, including FAQ lists, should be found
&gt;    on
&gt; this system using `man perl&#39; or `perldoc perl&#39;.  If you have access 
</div>to
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;    the
&gt; Internet, point your browser at <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perl.com/">http://www.perl.com/</a></span>, the Perl Home
&gt;    Page.
&gt; 
&gt; module DBI OK; version: 1.48
&gt; module DBD::mysql OK; version: 3.0000
&gt; testfred Preparing handle
&gt; testfred Executing 12
&gt; testfred Executing long
&gt; ---------------------------------------------------------------------
</div>---------------------
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; The stderr tracelog with connect params removed for security reasons,
&gt;    from 2.9008 which works is:
&gt; 
&gt; ---------------------------------------------------------------------
</div>---------------------
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt;     -&gt; prepare for DBD::mysql::db &#40;DBI::db=HASH&#40;0x82093ec&#41;
</div>~0x833e658 &#39;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       INSERT DELAYED INTO Test1 &#40;
&gt;       Message&#41; VALUES &#40;?&#41;
&gt;       &#39;&#41;
&gt; Setting mysql_use_result to 0
&gt;     &lt;- prepare= DBI::st=HASH&#40;0x833e7d8&#41; at testfred13.pl line 46
&gt;     -&gt; execute for DBD::mysql::st &#40;DBI::st=HASH&#40;0x833e7d8&#41;~0x81f12ac
&gt;    &#39;\&#34;12\&#34;&#39;&#41;
&gt;     -&gt; dbd_st_execute for 081f109c
&gt;       -&gt; mysql_st_interal_execute
&gt;       Binding parameters: INSERT DELAYED INTO Test1 &#40;
&gt;       Message&#41; VALUES &#40;&#39;\\\&#34;12\\\&#34;&#39;&#41;
&gt; 
&gt;       &lt;- mysql_st_internal_execute returning rows 1
&gt;     &lt;- dbd_st_execute returning imp_sth-&gt;row_num 1
&gt;     &lt;- execute= 1 at testfred13.pl line 53
&gt;     -&gt; execute for DBD::mysql::st &#40;DBI::st=HASH&#40;0x833e7d8&#41;~0x81f12ac
&gt;    &#39;FINAL LOCATION\n\nURL:
&gt;    <span class="clickylink"><a target="new" rel="nofollow" href="http://myweb.tiscali.co.uk/dennisdoylewrong">http://myweb.tiscali.co.uk/dennisdoylewrong</a></span>\nReturn Code:
&gt;    404\nReturn Message: Not Found\nPage Size: 707\nHeaders:
&gt;    \nConnection: close\nDate: Thu, 07 Jul 2005 14:19:58 GMT\nAccept-
&gt;    Ranges: bytes\nETag: \&#34;32410b-2c3-3cb2ead0\&#34;\nServer: 
</div>Apache/1.3.22
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;    &#40;Unix&#41; mod_throttle/3.1.2\nVary: Host\nContent-Length:
&gt;    707\nContent-Type: text/html\nLast-Modified: Tue, 09 Apr 2002
&gt;    13:21:2...&#39;&#41;
&gt;     -&gt; dbd_st_execute for 081f109c
&gt;       -&gt; mysql_st_interal_execute
&gt;       Binding parameters: INSERT DELAYED INTO Test1 &#40;
&gt;       Message&#41; VALUES &#40;&#39;FINAL LOCATION\\n\\nURL:
&gt;    <span class="clickylink"><a target="new" rel="nofollow" href="http://myweb.tiscali.co.uk/dennisdoylewrong">http://myweb.tiscali.co.uk/dennisdoylewrong</a></span>\\nReturn Code:
&gt;    404\\nReturn Message: Not Found\\nPage Size: 707\\nHeaders:
&gt;    \\nConnection: close\\nDate: Thu, 07 Jul 2005 14:19:58
&gt;    GMT\\nAccept-Ranges: bytes\\nETag: \\\&#34;32410b-2c3-
&gt;    3cb2ead0\\\&#34;\\nServer: Apache/1.3.22 &#40;Unix&#41;
&gt;    mod_throttle/3.1.2\\nVary: Host\\nContent-Length: 707\\nContent-
&gt;    Type: text/html\\nLast-Modified: Tue, 09 Apr 2002 13:21:20
&gt;    GMT\\nClient-Date: Thu, 07 Jul 2005 14:20:16 GMT\\nClient-Peer:
&gt;    212.74.114.59:80\\nClient-Response-Num: 1\\nRefresh: 0;
&gt;    url=<span class="clickylink"><a target="new" rel="nofollow" href="http://www.tiscali.co.uk/services/webspace/404.html">http://www.tiscali.co.uk/services/webspace/404.html</a></span>\\n\\n&#39;&#41;
&gt; 
&gt;       &lt;- mysql_st_internal_execute returning rows 1
&gt;     &lt;- dbd_st_execute returning imp_sth-&gt;row_num 1
&gt;     &lt;- execute= 1 at testfred13.pl line 58
&gt;     -&gt; finish for DBD::mysql::st &#40;DBI::st=HASH&#40;0x833e7d8&#41;~0x81f12ac&#41;
&gt;     &lt;- finish= 1 at testfred13.pl line 62
&gt;     -&gt; disconnect for DBD::mysql::db
&gt;    &#40;DBI::db=HASH&#40;0x82093ec&#41;~0x833e658&#41;
&gt; &#38;imp_dbh-&gt;mysql: 833ea44
&gt;     &lt;- disconnect= 1 at testfred13.pl line 63
&gt;     -&gt; DESTROY for DBD::mysql::st &#40;DBI::st=HASH&#40;0x81f12ac&#41;~INNER&#41;
&gt;     &lt;- DESTROY= undef
&gt;     -&gt; DESTROY for DBD::mysql::db &#40;DBI::db=HASH&#40;0x833e658&#41;~INNER&#41;
&gt;     &lt;- DESTROY= undef
&gt; ---------------------------------------------------------------------
</div>---------------------
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; The stdout from 2.9008 which works is:
&gt; 
&gt; ---------------------------------------------------------------------
</div>---------------------
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; testfred starts
&gt; 
&gt; This is perl, v5.8.4 built for i686-linux
&gt; 
&gt; Copyright 1987-2004, Larry Wall
&gt; 
&gt; Perl may be copied only under the terms of either the Artistic 
</div>License
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;    or the
&gt; GNU General Public License, which may be found in the Perl 5 source
&gt;    kit.
&gt; 
&gt; Complete documentation for Perl, including FAQ lists, should be found
&gt;    on
&gt; this system using `man perl&#39; or `perldoc perl&#39;.  If you have access 
</div>to
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;    the
&gt; Internet, point your browser at <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perl.com/">http://www.perl.com/</a></span>, the Perl Home
&gt;    Page.
&gt; 
&gt; module DBI OK; version: 1.48
&gt; module DBD::mysql OK; version: 2.9008
&gt; testfred Preparing handle
&gt; testfred Executing 12
&gt; testfred Executing long
&gt; testfred Ending
&gt; 
&gt; ---------------------------------------------------------------------
</div>---------------------
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; To reproduce the bug:
&gt; 
&gt; Create a table with a single text field:
&gt; 
&gt; CREATE TABLE `Test1` &#40;
&gt;   `Message` text NOT NULL
&gt; &#41; TYPE=MyISAM;
&gt; 
&gt; Then run the following test script - replacing XXX, YYY &#38; ZZZ with
&gt;    your connect paramters::
&gt; 
&gt; #!/usr/bin/perl -w
&gt; $|=1;
&gt; # DATE: 6/7/5
&gt; 
&gt; print &#34;testfred starts\n&#34;;
&gt; 
&gt; my $version;
&gt; my $dbh;
&gt; my $sthdiag;
&gt; my $ans;
&gt; my $diagnostic;
&gt; 
&gt; print `perl -v`;
&gt; 
&gt; eval &#34;use DBI&#34;;
&gt; if &#40;$@ ne &#34;&#34;&#41;
&gt; {
&gt;       print&#40;&#34;module DBI LOAD FAILED - $@\n&#34;&#41;;
&gt; }
&gt; else
&gt; {
&gt;       $version = getversion&#40;&#34;DBI&#34;&#41;;
&gt;       print &#34;module DBI OK; version: $version\n&#34;;
&gt; }
&gt; 
&gt; eval &#34;use DBD::mysql&#34;;
&gt; if &#40;$@ ne &#34;&#34;&#41;
&gt; {
&gt;       print&#40;&#34;module DBD::mysql LOAD FAILED - $@\n&#34;&#41;;
&gt; }
&gt; else
&gt; {
&gt;       $version = getversion&#40;&#34;DBD::mysql&#34;&#41;;
&gt;       print &#34;module DBD::mysql OK; version: $version\n&#34;;
&gt; }
&gt; 
&gt; if &#40;!&#40;$dbh = DBI-&gt;connect&#40;&#39;XXX&#39;, &#39;YYY&#39;, &#39;ZZZ&#39;,
&gt;       { AutoCommit =&gt; 1, RaiseError =&gt; 1, PrintError =&gt; 1, 
</div>TraceLevel =&gt; 2}
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;    &#41;&#41;&#41;
&gt; {
&gt;       print&#40;$dbh-&gt;errstr&#41;;
&gt;       exit;
&gt; }
&gt; 
&gt; print &#34;testfred Preparing handle\n&#34;;
&gt; 
&gt; $sthdiag = $dbh-&gt;prepare&#40;q{
&gt;       INSERT DELAYED INTO Test1 &#40;
&gt;       Message&#41; VALUES &#40;?&#41;
&gt;       }&#41;;
&gt; 
&gt; print &#34;testfred Executing 12\n&#34;;
&gt; 
&gt; $ans = $sthdiag-&gt;execute&#40;&#39;\&#34;12\&#34;&#39;&#41;;
&gt; 
&gt; print &#34;testfred Executing long\n&#34;;
&gt; 
&gt; $diagnostic = &#39;FINAL LOCATION\n\nURL:
&gt;    <span class="clickylink"><a target="new" rel="nofollow" href="http://myweb.tiscali.co.uk/dennisdoylewrong">http://myweb.tiscali.co.uk/dennisdoylewrong</a></span>\nReturn Code:
&gt;    404\nReturn Message: Not Found\nPage Size: 707\nHeaders:
&gt;    \nConnection: close\nDate: Thu, 07 Jul 2005 14:19:58 GMT\nAccept-
&gt;    Ranges: bytes\nETag: \&#34;32410b-2c3-3cb2ead0\&#34;\nServer: 
</div>Apache/1.3.22
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;    &#40;Unix&#41; mod_throttle/3.1.2\nVary: Host\nContent-Length:
&gt;    707\nContent-Type: text/html\nLast-Modified: Tue, 09 Apr 2002
&gt;    13:21:20 GMT\nClient-Date: Thu, 07 Jul 2005 14:20:16 GMT\nClient-
&gt;    Peer: 212.74.114.59:80\nClient-Response-Num: 1\nRefresh: 0;
&gt;    url=<span class="clickylink"><a target="new" rel="nofollow" href="http://www.tiscali.co.uk/services/webspace/404.html">http://www.tiscali.co.uk/services/webspace/404.html</a></span>\n\n&#39;;
&gt; $ans = $sthdiag-&gt;execute&#40;$diagnostic&#41;;
&gt; 
&gt; print &#34;testfred Ending\n&#34;;
&gt; 
&gt; $sthdiag-&gt;finish&#40;&#41;;
&gt; $dbh-&gt;disconnect&#40;&#41;;
&gt; exit;
&gt; 
&gt; print &#34;testfred ends\n&#34;;
&gt; 
&gt; exit;
&gt; 
&gt; sub getversion
&gt; {
&gt; my $mod = shift;
&gt; my $vers = `$^X -m$mod -e &#39;print \$${mod}::VERSION&#39; 2&gt;/dev/null`;
&gt; $vers =~ s/^\s*&#40;.*?&#41;\s*$/$1/; # remove stray whitespace
&gt; return &#40;$vers || undef&#41;;
&gt; }
&gt; 1;
</div>
We are pretty confident that the bug relates to the changes to 
escaping of quotes done by execute
for the following reasons:

1. Replacing all occurrences of execute{} with do{} in our code and 
remoing the quotes in 
SQL strings ourselves is rapidly reducing the number of failures.
2. do{} does not mess with quotes wheras execute{} does.
3. The todo list for DBD::mysql version 3 says the quoting needs 
testing, which I assume means
it has been changed and it doesn&#39;t work.

Since we never encountered any problems with execute&#39;s escaping of 
quotes in 2.9008, would
it be worth switching that bit of code back to the original - or will 
that cause faults elsewhere?

In the meantime, I&#39;d suggest any other users experiencing the same 
problems try the workaround
suggested above - far from ideal but better than having your 
processing hanging and/or thrashing.



Hope this helps.

Dennis Doyle
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;15&nbsp;13:09:05&nbsp;2006</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed in latest 3.0007 and 3.0007_1

module DBI OK; version: 1.48
module DBD::mysql OK; version: 3.0007
testfred Preparing handle
testfred Executing 12
testfred Executing long
testfred Ending
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;15&nbsp;13:09:07&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;15&nbsp;13:09:08&nbsp;2006</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
