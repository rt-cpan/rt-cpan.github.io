<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #68613 for ExtUtils-MakeMaker: CCFLAGS should not override $Config{ccflags}</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #68613 for ExtUtils-MakeMaker: CCFLAGS should not override $Config{ccflags}</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/ExtUtils-MakeMaker/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/ExtUtils-MakeMaker/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/ExtUtils-MakeMaker/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/ExtUtils-MakeMaker/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/ExtUtils-MakeMaker">ExtUtils-MakeMaker CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">68613</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/ExtUtils-MakeMaker/Active/">ExtUtils-MakeMaker</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ntyni [...] iki.fi

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
dom [...] cpan.org

<br />
jquelin [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-12494-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
6.57_05</li>
<li>
6.57_11</li>
</ul>
    </td>
  </tr>
  <tr id="CF-12495-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;02&nbsp;15:01:26&nbsp;2011</span>
    <span class="description">ntyni [...] iki.fi -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> CCFLAGS should not override $Config{ccflags}</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">As seen in <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/628522">http://bugs.debian.org/628522</a></span> and possibly also
<span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=67990">http://rt.cpan.org/Ticket/Display.html?id=67990</a></span> :

Compiling XS extensions without $Config{ccflags} can break the
binary interface on some platforms as preprocessor definitions like 
-D_FILE_OFFSET_BITS=64 are not used for the build.

This has become a practical problem for us &#40;Debian&#41; with 5.14.0 where
such extensions actually stop working on the x86 &#40;32-bit&#41; architecture;
see also the recent similar EU::CBuilder issue at
<span class="clickylink"><a target="new" rel="nofollow" href="http://rt.perl.org/rt3/Public/Bug/Display.html?id=89478">http://rt.perl.org/rt3/Public/Bug/Display.html?id=89478</a></span>

Unless a correct use case exists for compiling an XS module without
$Config{ccflags} &#40;I can&#39;t think of any&#41;, it seems to me that any extra
CCFLAGS should be appended to those rather than overriding them.

The alternative to such a fix seems to be that the modules overriding
CCFLAGS should include $Config{ccflags} themselves. In that case this
requirement should probably be mentioned in the EU::MM documentation.

The attached naive patch implements the first option. Please note that I
had to change an existing test to accomodate the new behaviour. Based on
the comment the aim of the test is not to check that CCFLAGS was
completely overridden, just that the contents are not deleted.

This potentially affects modules that already explicitly set CCFLAGS to
a value that includes $Config{ccflags}. I&#39;m only aware of DBD::Oracle
doing this if it&#39;s building with &#39;bcc32&#39; &#40;probably a win32 thing?&#41;. 

FWIW, Dominic Hargreaves has tested a rebuild of about 400 XS modules on
Debian/5.14.0 with the patch without any regressions, as mentioned in
the Debian bug report.

Please let me know what you think. Many thanks for your work on
ExtUtils::MakeMaker!
-- 
Niko Tyni
ntyni@debian.org
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Append-CCFLAGS-to-Config-ccflags-instead-of-overridi.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From bb5cff55e52477be757b73d915bda76b4c5e088f Mon Sep 17 00:00:00 2001
From: Niko Tyni &lt;ntyni@debian.org&gt;
Date: Mon, 30 May 2011 22:54:24 +0300
Subject: [PATCH] Append CCFLAGS to $Config{ccflags} instead of overriding it

As seen in
 <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/628522">http://bugs.debian.org/628522</a></span>
and possibly also
 <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=67990">http://rt.cpan.org/Ticket/Display.html?id=67990</a></span>
compiling XS extensions without $Config{ccflags} can break the
binary interface on some platforms. There does not seem to be any correct
use case for compiling a module without $Config{ccflags}, so any extra
CCFLAGS should be appended to those rather than overriding them.
---
 lib/ExtUtils/MM_Unix.pm |    6 +++++-
 t/MM_Unix.t             |    8 ++++++--
 2 files changed, 11 insertions&#40;+&#41;, 3 deletions&#40;-&#41;

diff --git a/lib/ExtUtils/MM_Unix.pm b/lib/ExtUtils/MM_Unix.pm
index a3b7e9d..5e0758a 100644
--- a/lib/ExtUtils/MM_Unix.pm
+++ b/lib/ExtUtils/MM_Unix.pm
@@ -250,7 +250,11 @@ sub cflags {
 	$cflags{$_} =~ s/^\s+//;
 	$cflags{$_} =~ s/\s+/ /g;
 	$cflags{$_} =~ s/\s+$//;
-	$self-&gt;{uc $_} ||= $cflags{$_};
+	if &#40;/ccflags/ &#38;&#38; $self-&gt;{uc $_}&#41; {
+	        $self-&gt;{uc $_} = &#34;$cflags{$_} &#34; . $self-&gt;{uc $_};
+        } else {
+	        $self-&gt;{uc $_} ||= $cflags{$_};
+        }
     }
 
     if &#40;$self-&gt;{POLLUTE}&#41; {
diff --git a/t/MM_Unix.t b/t/MM_Unix.t
index 55c29e3..5f76e08 100644
--- a/t/MM_Unix.t
+++ b/t/MM_Unix.t
@@ -12,7 +12,7 @@ BEGIN {
         plan skip_all =&gt; &#39;Non-Unix platform&#39;;
     }
     else {
-        plan tests =&gt; 110;
+        plan tests =&gt; 112;
     }
 }
 
@@ -20,6 +20,7 @@ BEGIN { use_ok&#40; &#39;ExtUtils::MM_Unix&#39; &#41;; }
 
 use strict;
 use File::Spec;
+use Config;
 
 my $class = &#39;ExtUtils::MM_Unix&#39;;
 
@@ -220,6 +221,9 @@ foreach &#40;qw/ EXPORT_LIST PERL_ARCHIVE PERL_ARCHIVE_AFTER /&#41;
     $t-&gt;cflags&#40;&#41;;
 
     # Brief bug where CCFLAGS was being blown away
-    is&#40; $t-&gt;{CCFLAGS}, &#39;-DMY_THING&#39;,    &#39;cflags retains CCFLAGS&#39; &#41;;
+    like&#40; $t-&gt;{CCFLAGS}, &#34;/-DMY_THING/&#34;,    &#39;cflags retains CCFLAGS&#39; &#41;;
+
+    like&#40; $t-&gt;{CCFLAGS}, &#34;/\Q$Config{ccflags}\E/&#34;,    &#39;cflags does not override $Config{ccflags} with CCFLAGS&#39; &#41;;
+    like&#40; $t-&gt;{CCFLAGS}, &#39;/ -DMY_THING$/&#39;,    &#39;cflags appends CCFLAGS to $Config{ccflags}&#39; &#41;;
 }
 
-- 
1.7.5.1

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;03&nbsp;01:22:35&nbsp;2011</span>
    <span class="description">ntyni [...] iki.fi -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #68613] AutoReply: CCFLAGS should not override $Config{ccflags}</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 3 Jun 2011 08:22:21 +0300</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Bugs in ExtUtils-MakeMaker via RT &lt;bug-ExtUtils-MakeMaker [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Niko Tyni &lt;ntyni [...] iki.fi&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, Jun 02, 2011 at 03:01:27PM -0400, Bugs in ExtUtils-MakeMaker via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Compiling XS extensions without $Config{ccflags} can break the
&gt; binary interface on some platforms as preprocessor definitions like 
&gt; -D_FILE_OFFSET_BITS=64 are not used for the build.
&gt; 
&gt; This has become a practical problem for us &#40;Debian&#41; with 5.14.0 where
&gt; such extensions actually stop working on the x86 &#40;32-bit&#41; architecture;
&gt; see also the recent similar EU::CBuilder issue at
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.perl.org/rt3/Public/Bug/Display.html?id=89478">http://rt.perl.org/rt3/Public/Bug/Display.html?id=89478</a></span>
&gt; 
&gt; Unless a correct use case exists for compiling an XS module without
&gt; $Config{ccflags} &#40;I can&#39;t think of any&#41;, it seems to me that any extra
&gt; CCFLAGS should be appended to those rather than overriding them.
&gt; 
&gt; The alternative to such a fix seems to be that the modules overriding
&gt; CCFLAGS should include $Config{ccflags} themselves. In that case this
&gt; requirement should probably be mentioned in the EU::MM documentation.
</div>
It turns out that some modules currently modify $Config{ccflags} settings.
For instance, the Verilog-Perl CPAN module has this:

  # Grr; some flags cause warnings in g++
  &#40;my $ccflags = $Config{ccflags}&#41; =~ s/ *-Wdeclaration-after-statement//;

and Search-Xapian &#40;also on CPAN&#41; has this:

  # Filter out some gcc options which g++ doesn&#39;t support.
  my $CCFLAGS = $Config{&#39;ccflags&#39;};
  # Perl is built with -Wdeclaration-after-statement on RHEL5 - this isn&#39;t
  # meaningful for C++ - it only emits a warning but it&#39;s easy to fix.
  $CCFLAGS =~ s/&#40;?:^|\s+&#41;-Wdeclaration-after-statement&#40;?:\s+|$&#41;/ /;
  # The generated code causes &#34;variable may be used uninitialized&#34; warnings
  # if Perl was built with -Wall.
  $CCFLAGS =~ s/&#40;^|\s+&#41;-Wall&#40;\s+|$&#41;/$1-Wall -Wno-uninitialized$2/;

Also, a few modules &#40;DBD::Pg, Algorith::Permute&#41; already use
$Config{ccflags} unmodified and would get them twice with the patch.

This seems to imply that appending CCFLAGS to $Config{ccflags} isn&#39;t quite
the right thing to do after all. A better approach might be to update the
EU::MM documentation, optionally add a new CCEXTRAFLAGS that automatically
includes $Config{ccflags}, and fix the modules that currently don&#39;t use
$Config{ccflags} at all &#40;this includes at least GD, OIS, Ogre on CPAN&#41;.

See the attached patches. They may need some tweaking for non-MM_Unix
platforms.

Again, thanks for your work on EU::MM.
-- 
Niko Tyni   ntyni@debian.org
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;10&nbsp;09:06:30&nbsp;2011</span>
    <span class="description">jquelin [...] cpan.org -  Cc JQUELIN added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;13&nbsp;02:53:40&nbsp;2011</span>
    <span class="description">dom [...] cpan.org -  Cc DOM added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
