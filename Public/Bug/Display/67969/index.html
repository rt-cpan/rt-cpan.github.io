<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #67969 for DBIx-Class: FW: Class::Storage::Oracle::Generic.pm</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #67969 for DBIx-Class: FW: Class::Storage::Oracle::Generic.pm</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=DBIx-Class">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=DBIx-Class">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=DBIx-Class">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=DBIx-Class">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBIx-Class">DBIx-Class CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">67969</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=DBIx-Class">DBIx-Class</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Duncan.Garland [...] motortrak.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10410-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10411-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.08191    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=67969">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-931374" href="/Public/Bug/Display.html?id=67969#txn-931374">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;05&nbsp;11:45:24&nbsp;2011</span>
    <span class="description">Duncan.Garland [...] motortrak.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> FW: Class::Storage::Oracle::Generic.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 5 May 2011 16:45:07 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBIx-Class [...] rt.cpan.org&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Duncan Garland &lt;Duncan.Garland [...] motortrak.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/931374/483420/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/483420">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">

From: Duncan Garland
Sent: 05 May 2011 16:40
To: &#39;bug-DBIx-Class@rt.cpan.org.&#39;
Subject: Class::Storage::Oracle::Generic.pm

Hi,

I think there&#39;s a bug in this module.

We&#39;ve set up our system so that there are two users, each with their own schema, on the same Oracle instance. One is motrak and one is mbfl2_training.

The config file tells it which user to log in as:

mbfl2.conf:

&lt;Model::DB&gt;
  schema_class   MBFL2SCHEMA
  &lt;connect_info&gt;
    dsn            dbi:Oracle:ORCL
    user           motrak
    password       XXXXXXXXXXX
    on_connect_do  ALTER SESSION SET NLS_DATE_FORMAT = &#39;YYYY-MM-DD HH24:MI:SS&#39;
    on_connect_do  ALTER SESSION SET NLS_TIMESTAMP_FORMAT = &#39;YYYY-MM-DD HH24:MI:SS&#39;
    LongReadLen    2000000
  &lt;/connect_info&gt;
&lt;/Model::DB&gt;

mbfl2_training.conf:

&lt;Model::DB&gt;
  schema_class   MBFL2SCHEMA
  &lt;connect_info&gt;
    dsn            dbi:Oracle:ORCL
    user           mbfl2_training
    password       XXXXXXXXXXXXXXX
    on_connect_do  ALTER SESSION SET NLS_DATE_FORMAT = &#39;YYYY-MM-DD HH24:MI:SS&#39;
    on_connect_do  ALTER SESSION SET NLS_TIMESTAMP_FORMAT = &#39;YYYY-MM-DD HH24:MI:SS&#39;
    LongReadLen    2000000
  &lt;/connect_info&gt;
&lt;/Model::DB&gt;

This has been working quite well, but we&#39;ve suddenly started getting insert errors on one table in particular:

[05/May/2011:15:27:22 +0100] WARN:www.mbfl2-training.com:[FCGI: /usr/local/etc/httpd/fcgi/catalyst/mbfl2/script/mbfl2_training_fastcgi.pl]: [error] DBIx::Class::ResultSet::create&#40;&#41;: DBI Exception: DBD::Oracle::db selectrow_array failed: ORA-00942: table or view does not exist &#40;DBD ERROR: error possibly near &lt;*&gt; indicator at char 14 in &#39;SELECT MOTRAK.&lt;*&gt;s_mbfl2_dealer_package_models.currval FROM DUAL&#39;&#41; [for Statement &#34;SELECT MOTRAK.s_mbfl2_dealer_package_models.currval FROM DUAL&#34;] at /usr/local/etc/httpd/fcgi/catalyst/mbfl2/script/../lib/mbfl2/Controller/DealerAdmin.pm line 675

This is bizarre because the user should be logged in as mbfl2_training and, as far as I can tell, is logged in as mbfl2_training. MOTRAK.s_mbfl2_dealer_package_models exists but the user does not have access to it. He should be accessing MBFL2_TRAINING.s_mbfl2_dealer_package_models or just  s_mbfl2_dealer_package_models.

The problem seems to be in Generic:: _dbh_get_autoinc_seq&#40;&#41;. It derives the schema name by selecting the trigger name and the owner name from all_triggers. All_triggers returns triggers which belong to both MOTRAK and MBFL2_TRAINING and which contain the sequence s_mbfl2_dealer_package_models.

The MOTRAK trigger is returned first, so the schema is set incorrectly. When I change the statement to use USER_TRIGGER is works.

MBFL2_TRAINING has select access on some of MOTRAK&#39;s tables &#40;and thus their triggers&#41; because I copied some data across a couple of month ago. If I revoke the select access, I think the original code &#40;using ALL_TRIGGERS&#41; will work.

However, I have worked on systems in the past where the user genuinely needs access to two tables with the same name. For example, on development systems it is common to read from a central set of tables and create a local copy of any tables which need to be written to. Oracle will correctly select the table in the current schema in preference to one in another schema, but your code might not.

I hope this feedback is useful.

All the best.


Duncan
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/931374/483421/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/483421">with headers</a>
<br />
<span class="downloadcontenttype">text/html 7.9k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-931400" href="/Public/Bug/Display.html?id=67969#txn-931400">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;05&nbsp;12:37:26&nbsp;2011</span>
    <span class="description">abraxxa [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/931400/483436/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/483436">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 84b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Which DBIx::Class version do you use?
There where several fixed for this in 0.08125.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-931403" href="/Public/Bug/Display.html?id=67969#txn-931403">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;05&nbsp;12:37:28&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-931412" href="/Public/Bug/Display.html?id=67969#txn-931412">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;05&nbsp;12:39:13&nbsp;2011</span>
    <span class="description">Duncan.Garland [...] motortrak.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 5 May 2011 17:39:04 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBIx-Class [...] rt.cpan.org&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Duncan Garland &lt;Duncan.Garland [...] motortrak.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/931412/483444/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/483444">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 716b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Module id = DBIx::Class
    CPAN_USERID  ARCANEZ &#40;Justin Hunter &lt;justin.d.hunter@gmail.com&gt;&#41;
    CPAN_VERSION 0.08191
    CPAN_FILE    F/FR/FREW/DBIx-Class-0.08191.tar.gz
    MANPAGE      DBIx::Class - Extensible and flexible object &lt;-&gt; relational mapper.
    INST_FILE    /usr/lib/perl5/site_perl/5.8.8/DBIx/Class.pm
    INST_VERSION 0.08123

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Alexander Hartmaier via RT [mailto:bug-DBIx-Class@rt.cpan.org] 
Sent: 05 May 2011 17:37
To: Duncan Garland
Subject: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm 

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=67969">https://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;

Which DBIx::Class version do you use?
There where several fixed for this in 0.08125.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-931969" href="/Public/Bug/Display.html?id=67969#txn-931969">#</a>      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;07&nbsp;09:07:57&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/931969/483785/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/483785">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu May 05 11:45:24 2011, Duncan.Garland@motortrak.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; The problem seems to be in Generic:: _dbh_get_autoinc_seq&#40;&#41;. It
&gt;    derives the schema name by selecting the trigger name and the owner
&gt;    name from all_triggers. All_triggers returns triggers which belong
&gt;    to both MOTRAK and MBFL2_TRAINING and which contain the sequence
&gt;    s_mbfl2_dealer_package_models.
&gt; 
&gt; The MOTRAK trigger is returned first, so the schema is set
&gt;    incorrectly. When I change the statement to use USER_TRIGGER is
&gt;    works.
&gt; 
</div>
So do I understand correctly that the heuristics should be adjusted to
first scan USER_TRIGGER and then if nothing is found re-scan
ALL_TRIGGERS? I am not very well versed in the vagaries of Oracle, so
it&#39;s on you as the user to come up with a sensible design &#40;and hopefully
a patch :P&#41;.

Let us know what exactly will work for you, and we&#39;ll be happy to fix it.

As a workaround for the time being you can specify an explicit
&#39;sequence&#39; in your column_info of the particular PK, which will preempt
the entire heuristics. Of course fixing this on the DBIC level is always
preferable :&#41;

Cheers!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-934781" href="/Public/Bug/Display.html?id=67969#txn-934781">#</a>      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;14&nbsp;04:15:29&nbsp;2011</span>
    <span class="description">rkitover [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/934781/485324/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/485324">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 301b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I don&#39;t see how this situation is possible with the code in master.

One of the select criteria on ALL_TRIGGERS is OWNER, which is set to the
schema of the table or to the logged in user.

It would only pick up the MOTRAK sequence if your -&gt;table call was
something like:

-&gt;table&#40;&#39;MOTRAK.table_name&#39;&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-936336" href="/Public/Bug/Display.html?id=67969#txn-936336">#</a>      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;18&nbsp;05:45:25&nbsp;2011</span>
    <span class="description">Duncan.Garland [...] motortrak.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 18 May 2011 10:45:14 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBIx-Class [...] rt.cpan.org&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Duncan Garland &lt;Duncan.Garland [...] motortrak.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/936336/486146/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/486146">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Rafael,

The problem definitely is repeatable. I solved the problem by revoking the permission. As soon as I give mbfl2_training select permission on motrak&#39;s table:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">SQL&gt; GRANT SELECT ON mbfl2_dealer_package_models TO mbfl2_training;
</div>
mbfl2_training starts to throw errors because it is getting confused about which sequence to use:

[18/May/2011:10:29:29 +0100] WARN:www.mbfl2-training.com:[FCGI: /usr/local/etc/httpd/fcgi/catalyst/mbfl2/script/mbfl2_training_fastcgi.pl]: [debug] Check: DBIx::Class::ResultSet::create&#40;&#41;: DBI Exception: DBD::Oracle::db selectrow_array failed: ORA-00942: table or view does not exist &#40;DBD ERROR: error possibly near &lt;*&gt; indicator at char 14 in &#39;SELECT MOTRAK.&lt;*&gt;s_mbfl2_dealer_package_models.currval FROM DUAL&#39;&#41; [for Statement &#34;SELECT MOTRAK.s_mbfl2_dea
[18/May/2011:10:29:29 +0100] WARN:www.mbfl2-training.com:[FCGI: /usr/local/etc/httpd/fcgi/catalyst/mbfl2/script/mbfl2_training_fastcgi.pl]: ler_package_models.currval FROM DUAL&#34;] at /usr/local/etc/httpd/fcgi/catalyst/mbfl2/script/../lib/mbfl2/Controller/DealerAdmin.pm line 675

It should be selecting from mbfl2_training.s_mbfl2_dealer_package_models or just s_mbfl2_dealer_package_models. It can&#39;t see motrak.s_mbfl2_dealer_package_models which is good because it&#39;s the wrong sequence.

It&#39;s possible that my diagnosis is wrong. I removed my debug messages from Generic.pm. I&#39;ll re-instate them and try again.

Regards

Duncan

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Rafael Kitover via RT [mailto:bug-DBIx-Class@rt.cpan.org] 
Sent: 14 May 2011 09:16
To: Duncan Garland
Subject: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm 

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=67969">https://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;

I don&#39;t see how this situation is possible with the code in master.

One of the select criteria on ALL_TRIGGERS is OWNER, which is set to the
schema of the table or to the logged in user.

It would only pick up the MOTRAK sequence if your -&gt;table call was
something like:

-&gt;table&#40;&#39;MOTRAK.table_name&#39;&#41;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-936345" href="/Public/Bug/Display.html?id=67969#txn-936345">#</a>      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;18&nbsp;06:30:06&nbsp;2011</span>
    <span class="description">abraxxa [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/936345/486153/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/486153">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 132b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;d suggest that you enable DBI debugging &#40;not DBIC!&#41; and show us the
exact sql queries that get executed to determine the sequence.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-936348" href="/Public/Bug/Display.html?id=67969#txn-936348">#</a>      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;18&nbsp;06:35:24&nbsp;2011</span>
    <span class="description">Duncan.Garland [...] motortrak.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 18 May 2011 11:35:14 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBIx-Class [...] rt.cpan.org&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Duncan Garland &lt;Duncan.Garland [...] motortrak.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/936348/486156/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/486156">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 5.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Rafael,

The marked up code is now:

sub _dbh_get_autoinc_seq {
  my &#40;$self, $dbh, $source, $col&#41; = @_;

  print STDERR &#34;DMG In _dbh_get_autoinc_seq\n&#34;;
  my $sql_maker = $self-&gt;sql_maker;

  my $source_name;
  if &#40; ref $source-&gt;name eq &#39;SCALAR&#39; &#41; {
    $source_name = ${$source-&gt;name};
  }
  else {
    $source_name = $source-&gt;name;
  }
  print STDERR &#34;DMG source_name=$source_name\n&#34;;
  $source_name = uc&#40;$source_name&#41; unless $sql_maker-&gt;quote_char;
  print STDERR &#34;DMG source_name=$source_name\n&#34;;

  # trigger_body is a LONG
  local $dbh-&gt;{LongReadLen} = 64 * 1024 if &#40;$dbh-&gt;{LongReadLen} &lt; 64 * 1024&#41;;

  # disable default bindtype
  local $sql_maker-&gt;{bindtype} = &#39;normal&#39;;

  # look up the correct sequence automatically
  my &#40; $schema, $table &#41; = $source_name =~ /&#40;\w+&#41;\.&#40;\w+&#41;/;
  print STDERR &#34;DMG schema=$schema table=$table\n&#34;;
  my &#40;$sql, @bind&#41; = $sql_maker-&gt;select &#40;
    &#39;ALL_TRIGGERS&#39;,
    [&#39;trigger_body&#39;, &#39;table_owner&#39;],
    {
      $schema ? &#40;owner =&gt; $schema&#41; : &#40;&#41;,
      table_name =&gt; $table || $source_name,
      triggering_event =&gt; { -like =&gt; &#39;%INSERT%&#39; },
      status =&gt; &#39;ENABLED&#39;,
     },
  &#41;;
  my $sth = $dbh-&gt;prepare&#40;$sql&#41;;
  $sth-&gt;execute &#40;@bind&#41;;

  while &#40;my &#40;$insert_trigger, $schema&#41; = $sth-&gt;fetchrow_array&#41; {
    print STDERR &#34;DMG trigger_body:\n$insert_trigger\n&#34;;
    my &#40;$seq_name&#41; = $insert_trigger =~ m!&#40;&#34;?[.\w&#34;]+?&#34;?&#41;\.nextval!i;

    print STDERR &#34;DMG seq_name=$seq_name\n&#34;;
    next unless $seq_name;

    if &#40;$seq_name !~ /\./&#41; {
      $seq_name = join &#39;.&#39; =&gt; map $self-&gt;sql_maker-&gt;_quote&#40;$_&#41;, $schema, $seq_name;
    }
    print STDERR &#34;DMG returning seq_name=$seq_name\n&#34;;

    return $seq_name;
  }
  $self-&gt;throw_exception&#40;&#34;Unable to find a sequence %INSERT% trigger on table &#39;$source_name&#39;.&#34;&#41;;
}

This produces:

[18/May/2011:11:02:39 +0100]: DMG In _dbh_get_autoinc_seq
[18/May/2011:11:02:39 +0100]: DMG source_name=mbfl2_dealer_package_models
[18/May/2011:11:02:39 +0100]: DMG source_name=MBFL2_DEALER_PACKAGE_MODELS
[18/May/2011:11:02:39 +0100]: Use of uninitialized value in concatenation &#40;.&#41; or string at /usr/lib/perl5/site_perl/5.8.8/DBIx/Class/Storage/DBI/Oracle/Generic.pm line 138.
[18/May/2011:11:02:39 +0100]: Use of uninitialized value in concatenation &#40;.&#41; or string at /usr/lib/perl5/site_perl/5.8.8/DBIx/Class/Storage/DBI/Oracle/Generic.pm line 138.
[18/May/2011:11:02:39 +0100]: DMG schema= table=
[18/May/2011:11:02:39 +0100]: DMG trigger_body:
[18/May/2011:11:02:39 +0100]: BEGIN
[18/May/2011:11:02:39 +0100]:   SELECT s_mbfl2_dealer_package_models.NEXTVAL INTO :new.id
[18/May/2011:11:02:39 +0100]:  FROM dual;
[18/May/2011:11:02:39 +0100]: END;
[18/May/2011:11:02:39 +0100]: DMG seq_name=s_mbfl2_dealer_package_models
[18/May/2011:11:02:39 +0100]: DMG returning seq_name=MOTRAK.s_mbfl2_dealer_package_models

The data in the database is:

  1  SELECT trigger_name, trigger_body, table_owner FROM all_triggers
  2  WHERE table_name = &#39;MBFL2_DEALER_PACKAGE_MODELS&#39;
  3  AND triggering_event LIKE &#39;%INSERT%&#39;
  4* AND status = &#39;ENABLED&#39;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">SQL&gt; /
</div>
TRIGGER_NAME                   TRIGGER_BODY                                                                     TABLE_OWNER
------------------------------ -------------------------------------------------------------------------------- ------------------------------
T_MBFL2_DEALER_PACKAGE_MODELS  BEGIN                                                                            MOTRAK
                                 SELECT s_mbfl2_dealer_package_models.NEXTVAL INTO :new.id FROM dual;
                               END

T_MBFL2_DEALER_PACKAGE_MODELS  BEGIN                                                                            MBFL2_TRAINING
                                 SELECT s_mbfl2_dealer_package_models.NEXTVAL INTO :new.id FROM dual;
                               END

T_INTEGRITY_MBFL2_DPM          DECLARE                                                                          MOTRAK
                                x NUMBER;
                                e_DUPLICATE_ROW EXCEPTION;

TRIGGER_NAME                   TRIGGER_BODY                                                                     TABLE_OWNER
------------------------------ -------------------------------------------------------------------------------- ------------------------------
                               BEGIN
                                 SELECT t1.id INTO x
                                 FRO

T_INTEGRITY_MBFL2_DPM          DECLARE                                                                          MBFL2_TRAINING
                                x NUMBER;
                                e_DUPLICATE_ROW EXCEPTION;
                               BEGIN
                                 SELECT t1.id INTO x
                                 FRO


4 rows selected.

So I was more or less correct in what I said before. The first trigger returned belongs to a table owned by motrak. This causes the schema to be set to motrak.

All the best.

Duncan

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Rafael Kitover via RT [mailto:bug-DBIx-Class@rt.cpan.org] 
Sent: 14 May 2011 09:16
To: Duncan Garland
Subject: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm 

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=67969">https://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;

I don&#39;t see how this situation is possible with the code in master.

One of the select criteria on ALL_TRIGGERS is OWNER, which is set to the
schema of the table or to the logged in user.

It would only pick up the MOTRAK sequence if your -&gt;table call was
something like:

-&gt;table&#40;&#39;MOTRAK.table_name&#39;&#41;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-936372" href="/Public/Bug/Display.html?id=67969#txn-936372">#</a>      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;18&nbsp;07:34:49&nbsp;2011</span>
    <span class="description">Duncan.Garland [...] motortrak.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 18 May 2011 12:34:38 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBIx-Class [...] rt.cpan.org&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Duncan Garland &lt;Duncan.Garland [...] motortrak.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/936372/486170/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/486170">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Peter,

It would have worked correctly using all_triggers if the schema had defaulted correctly.

Something like:

  1  SELECT trigger_name, trigger_body, table_owner FROM all_triggers
  2  WHERE table_name = &#39;MBFL2_DEALER_PACKAGE_MODELS&#39;
  3  AND triggering_event LIKE &#39;%INSERT%&#39;
  4  AND status = &#39;ENABLED&#39;
  5* AND table_owner = NVL&#40; :schema, USER &#41;

I think it&#39;s reasonable for it to default to the current user. However, it&#39;s quite common for the tables to be owned by another user. In such cases it&#39;s important
that the schema is set correctly. I assume that&#39;s done elsewhere in DBIC.

It&#39;s possible that there could genuinely be more than one insert trigger and that a trigger could contain more than one sequence. I don&#39;t think the heuristics should stop when they find a sequence. I think they should carry on, read all the triggers, and error if there is not exactly one matching sequence. Similarly, I think your regular expression should be made to find all the sequences in the trigger and error if there is more than one.

In the future, it might be useful if the configuration file could contain the regular expression which would be used to identify the sequence which is used for the primary key. On this project the sequence name is simply &#34;s_$table_name&#34;. I suppose on another project the naming convention might be &#34;s_pkey_$table_name&#34;.

Let me know if there are any other Oracle issues you would like me to comment on.

All the best.

Duncan

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Peter Rabbitson via RT [mailto:bug-DBIx-Class@rt.cpan.org] 
Sent: 07 May 2011 14:08
To: Duncan Garland
Subject: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm 

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=67969">https://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;

On Thu May 05 11:45:24 2011, Duncan.Garland@motortrak.com wrote:
<div class="message-stanza open">&gt; 
&gt; The problem seems to be in Generic:: _dbh_get_autoinc_seq&#40;&#41;. It
&gt;    derives the schema name by selecting the trigger name and the owner
&gt;    name from all_triggers. All_triggers returns triggers which belong
&gt;    to both MOTRAK and MBFL2_TRAINING and which contain the sequence
&gt;    s_mbfl2_dealer_package_models.
&gt; 
&gt; The MOTRAK trigger is returned first, so the schema is set
&gt;    incorrectly. When I change the statement to use USER_TRIGGER is
&gt;    works.
&gt; 
</div>
So do I understand correctly that the heuristics should be adjusted to
first scan USER_TRIGGER and then if nothing is found re-scan
ALL_TRIGGERS? I am not very well versed in the vagaries of Oracle, so
it&#39;s on you as the user to come up with a sensible design &#40;and hopefully
a patch :P&#41;.

Let us know what exactly will work for you, and we&#39;ll be happy to fix it.

As a workaround for the time being you can specify an explicit
&#39;sequence&#39; in your column_info of the particular PK, which will preempt
the entire heuristics. Of course fixing this on the DBIC level is always
preferable :&#41;

Cheers!
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-937094" href="/Public/Bug/Display.html?id=67969#txn-937094">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;19&nbsp;20:58:20&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/937094/486539/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/486539">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed May 18 07:34:49 2011, Duncan.Garland@motortrak.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Peter,
&gt; 
&gt; It would have worked correctly using all_triggers if the
&gt;    schema had defaulted correctly.
&gt; 
&gt; Something like:
&gt; 
&gt;   1  SELECT
&gt;    trigger_name, trigger_body, table_owner FROM all_triggers
&gt;   2
&gt;    WHERE table_name = &#39;MBFL2_DEALER_PACKAGE_MODELS&#39;
&gt;   3  AND
&gt;    triggering_event LIKE &#39;%INSERT%&#39;
&gt;   4  AND status = &#39;ENABLED&#39;
&gt;   5*
&gt;    AND table_owner = NVL&#40; :schema, USER &#41;
&gt; 
&gt; I think it&#39;s reasonable
&gt;    for it to default to the current user. However, it&#39;s quite common
&gt;    for the tables to be owned by another user. In such cases it&#39;s
&gt;    important
&gt; that the schema is set correctly. I assume that&#39;s done
&gt;    elsewhere in DBIC.
&gt; 
&gt; It&#39;s possible that there could genuinely be
&gt;    more than one insert trigger and that a trigger could contain more
&gt;    than one sequence. I don&#39;t think the heuristics should stop when
&gt;    they find a sequence. I think they should carry on, read all the
&gt;    triggers, and error if there is not exactly one matching sequence.
&gt;    Similarly, I think your regular expression should be made to find
&gt;    all the sequences in the trigger and error if there is more than
&gt;    one.
</div>
I think I am getting confused by this. Is it possible for you to provide
us a patch that adjusts the heuristics to work in a way that suits your
situation?


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; In the future, it might be useful if the configuration file
&gt;    could contain the regular expression which would be used to
&gt;    identify the sequence which is used for the primary key. On this
&gt;    project the sequence name is simply &#34;s_$table_name&#34;. I suppose on
&gt;    another project the naming convention might be
&gt;    &#34;s_pkey_$table_name&#34;.
</div>
I think that&#39;s going into &#34;configuration hell&#34; territory. We already
provide a way to specify an explicit sequence &#40;bypassing all heuristics&#41;
for esoteric schema designs. I find it very hard to justify another
independent &#40;and quite non-transparent at that&#41; way to influence the
sequence selecting process.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-937231" href="/Public/Bug/Display.html?id=67969#txn-937231">#</a>      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;20&nbsp;04:18:30&nbsp;2011</span>
    <span class="description">Duncan.Garland [...] motortrak.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 20 May 2011 09:18:19 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBIx-Class [...] rt.cpan.org&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Duncan Garland &lt;Duncan.Garland [...] motortrak.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/937231/486618/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/486618">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Peter,

What is it that&#39;s confusing you? Is it that I haven&#39;t expressed myself clearly or is it that you don&#39;t agree with what I&#39;ve said?

I&#39;m not an expert on DBIC, I hadn&#39;t used it at all until we began the current project last summer. We only use it for simple DML statements, partly because I&#39;m not sure I understand all the concepts. &#40;We use DBI directly for the more complicated stuff.&#41;

I have worked with Oracle for twenty years, so I feel that I can comment on that with a bit more authority.

What is this method supposed to do? What does it have to do to be consistent with the equivalent methods used for other databases &#40;Postgres, MySQL, etc&#41;?

If we can agree on that then I&#39;ll have a go at writing a patch. I&#39;m quite keen to help with some of this stuff. However, I can&#39;t do it now. I spent all yesterday morning investigating this and writing those three emails. I&#39;m going to get shot by the project manager if I don&#39;t go back to his project.

All the best.

Duncan

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Peter Rabbitson via RT [mailto:bug-DBIx-Class@rt.cpan.org] 
Sent: 20 May 2011 01:58
To: Duncan Garland
Subject: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm 

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=67969">https://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;

On Wed May 18 07:34:49 2011, Duncan.Garland@motortrak.com wrote:
<div class="message-stanza open">&gt; Hi Peter,
&gt; 
&gt; It would have worked correctly using all_triggers if the
&gt;    schema had defaulted correctly.
&gt; 
&gt; Something like:
&gt; 
&gt;   1  SELECT
&gt;    trigger_name, trigger_body, table_owner FROM all_triggers
&gt;   2
&gt;    WHERE table_name = &#39;MBFL2_DEALER_PACKAGE_MODELS&#39;
&gt;   3  AND
&gt;    triggering_event LIKE &#39;%INSERT%&#39;
&gt;   4  AND status = &#39;ENABLED&#39;
&gt;   5*
&gt;    AND table_owner = NVL&#40; :schema, USER &#41;
&gt; 
&gt; I think it&#39;s reasonable
&gt;    for it to default to the current user. However, it&#39;s quite common
&gt;    for the tables to be owned by another user. In such cases it&#39;s
&gt;    important
&gt; that the schema is set correctly. I assume that&#39;s done
&gt;    elsewhere in DBIC.
&gt; 
&gt; It&#39;s possible that there could genuinely be
&gt;    more than one insert trigger and that a trigger could contain more
&gt;    than one sequence. I don&#39;t think the heuristics should stop when
&gt;    they find a sequence. I think they should carry on, read all the
&gt;    triggers, and error if there is not exactly one matching sequence.
&gt;    Similarly, I think your regular expression should be made to find
&gt;    all the sequences in the trigger and error if there is more than
&gt;    one.
</div>
I think I am getting confused by this. Is it possible for you to provide
us a patch that adjusts the heuristics to work in a way that suits your
situation?


<div class="message-stanza open">&gt; 
&gt; In the future, it might be useful if the configuration file
&gt;    could contain the regular expression which would be used to
&gt;    identify the sequence which is used for the primary key. On this
&gt;    project the sequence name is simply &#34;s_$table_name&#34;. I suppose on
&gt;    another project the naming convention might be
&gt;    &#34;s_pkey_$table_name&#34;.
</div>
I think that&#39;s going into &#34;configuration hell&#34; territory. We already
provide a way to specify an explicit sequence &#40;bypassing all heuristics&#41;
for esoteric schema designs. I find it very hard to justify another
independent &#40;and quite non-transparent at that&#41; way to influence the
sequence selecting process.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-942986" href="/Public/Bug/Display.html?id=67969#txn-942986">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;07&nbsp;06:33:39&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/942986/490308/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/490308">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri May 20 04:18:30 2011, Duncan.Garland@motortrak.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Peter,
&gt; 
&gt; What is it that&#39;s confusing you? Is it that I haven&#39;t
&gt;    expressed myself clearly or is it that you don&#39;t agree with what
&gt;    I&#39;ve said?
&gt; 
&gt; I&#39;m not an expert on DBIC, I hadn&#39;t used it at all
&gt;    until we began the current project last summer. We only use it for
&gt;    simple DML statements, partly because I&#39;m not sure I understand all
&gt;    the concepts. &#40;We use DBI directly for the more complicated stuff.&#41;
&gt;    I have worked with Oracle for twenty years, so I feel that I can
&gt;    comment on that with a bit more authority.
</div>
Sorry for the late reply, was away from OSS for a while. What is
confusing me is your explanation, no disagreement of any sort :&#41; Is it
possible for you to pop on IRC
&#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://chat.mibbit.com/#dbix-class@irc.perl.org&#41;">http://chat.mibbit.com/#dbix-class@irc.perl.org&#41;</a></span> so we can quickly
figure this out? If you prefer communication by email - I&#39;ll reply with
a more in-depth explanation of what I fail to understand &#40;and hence
can&#39;t reliably implement&#41;.

Cheers!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-942996" href="/Public/Bug/Display.html?id=67969#txn-942996">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;07&nbsp;06:44:24&nbsp;2011</span>
    <span class="description">Duncan.Garland [...] motortrak.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 7 Jun 2011 11:44:13 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBIx-Class [...] rt.cpan.org&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Duncan Garland &lt;Duncan.Garland [...] motortrak.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/942996/490314/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/490314">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Peter,

An email would be better, I think.

I managed to sit down for a couple of hours a Sunday or two back and do some work on a possible patch, but I haven&#39;t had any spare time since then.

All the best.

Duncan

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Peter Rabbitson via RT [mailto:bug-DBIx-Class@rt.cpan.org] 
Sent: 07 June 2011 11:34
To: Duncan Garland
Subject: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm 

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=67969">https://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;

On Fri May 20 04:18:30 2011, Duncan.Garland@motortrak.com wrote:
<div class="message-stanza open">&gt; Hi Peter,
&gt; 
&gt; What is it that&#39;s confusing you? Is it that I haven&#39;t
&gt;    expressed myself clearly or is it that you don&#39;t agree with what
&gt;    I&#39;ve said?
&gt; 
&gt; I&#39;m not an expert on DBIC, I hadn&#39;t used it at all
&gt;    until we began the current project last summer. We only use it for
&gt;    simple DML statements, partly because I&#39;m not sure I understand all
&gt;    the concepts. &#40;We use DBI directly for the more complicated stuff.&#41;
&gt;    I have worked with Oracle for twenty years, so I feel that I can
&gt;    comment on that with a bit more authority.
</div>
Sorry for the late reply, was away from OSS for a while. What is
confusing me is your explanation, no disagreement of any sort :&#41; Is it
possible for you to pop on IRC
&#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://chat.mibbit.com/#dbix-class@irc.perl.org&#41;">http://chat.mibbit.com/#dbix-class@irc.perl.org&#41;</a></span> so we can quickly
figure this out? If you prefer communication by email - I&#39;ll reply with
a more in-depth explanation of what I fail to understand &#40;and hence
can&#39;t reliably implement&#41;.

Cheers!
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-945522" href="/Public/Bug/Display.html?id=67969#txn-945522">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;15&nbsp;02:54:08&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/945522/491647/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/491647">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 985b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jun 07 06:44:24 2011, Duncan.Garland@motortrak.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Peter,
&gt; 
&gt; An email would be better, I think.
&gt; 
&gt; I managed to sit
&gt; down for a couple of hours a Sunday or two back and do some work on a
&gt; possible patch, but I haven&#39;t had any spare time since then.
</div>
Hi Duncan!

I re-read your diagnostics and then your reply when asked which version
you are running. It seems everyone in the thread got confused by:

Module id = DBIx::Class
CPAN_USERID ARCANEZ &#40;Justin Hunter &lt;justin.d.hunter@gmail.com&gt;&#41;
CPAN_VERSION 0.08191
CPAN_FILE F/FR/FREW/DBIx-Class-0.08191.tar.gz
MANPAGE DBIx::Class - Extensible and flexible object &lt;-&gt; relational mapper.
INST_FILE /usr/lib/perl5/site_perl/5.8.8/DBIx/Class.pm
INST_VERSION 0.08123

And we all assumed you are running 0.08191, whereas in fact you were
running the very old 0.08123. I am 99.9% sure that the issue you
described is fixed in the 0.0819x series. Please verify this when time
permits so I can close this ticket. Thank you!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-945569" href="/Public/Bug/Display.html?id=67969#txn-945569">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;15&nbsp;05:18:13&nbsp;2011</span>
    <span class="description">Duncan.Garland [...] motortrak.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 15 Jun 2011 10:18:01 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBIx-Class [...] rt.cpan.org&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Duncan Garland &lt;Duncan.Garland [...] motortrak.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/945569/491672/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/491672">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Peter,

OK, I&#39;ve upgraded DBIx::Class but my initial test has failed. I&#39;m still getting:

[15/Jun/2011:10:04:45 +0100] WARN:www.mbfl2-training.com:[FCGI: /usr/local/etc/httpd/fcgi/catalyst/mbfl2/script/mbfl2_training_fastcgi.pl]: [debug] Check: DBIx::Class::ResultSet::create&#40;&#41;: DBI Exception: DBD::Oracle::db selectrow_array failed: ORA-00942: table or view does not exist &#40;DBD ERROR: error possibly near &lt;*&gt; indicator at char 14 in &#39;SELECT MOTRAK.&lt;*&gt;s_mbfl2_dealer_package_models.currval FROM DUAL&#39;&#41; [for Statement &#34;SELECT MOTRAK.s_mbfl2_dea
[15/Jun/2011:10:04:45 +0100] WARN:www.mbfl2-training.com:[FCGI: /usr/local/etc/httpd/fcgi/catalyst/mbfl2/script/mbfl2_training_fastcgi.pl]: ler_package_models.currval FROM DUAL&#34;] at /usr/local/etc/httpd/fcgi/catalyst/mbfl2/script/../lib/mbfl2/Controller/DealerAdmin.pm line 675

The correct user is mbfl2_training. This error occurs when I allow mbfl2_training to see the table motrak.mbfl2_dealer_package_models.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">SQL&gt; GRANT SELECT ON mbfl2_dealer_package_models TO mbfl2_training;
</div>
Grant succeeded.

As soon as I do that, motrak&#39;s trigger becomes visible and your code gets confused because it can see two triggers with sequences but it only has access to one of the sequences.

I only upgraded DBIx::Class. Should I have specifically upgraded some of the sub-packages?

Regards

Duncan

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Peter Rabbitson via RT [mailto:bug-DBIx-Class@rt.cpan.org] 
Sent: 15 June 2011 07:54
To: Duncan Garland
Subject: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm 

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=67969">https://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;

On Tue Jun 07 06:44:24 2011, Duncan.Garland@motortrak.com wrote:
<div class="message-stanza open">&gt; Hi Peter,
&gt; 
&gt; An email would be better, I think.
&gt; 
&gt; I managed to sit
&gt; down for a couple of hours a Sunday or two back and do some work on a
&gt; possible patch, but I haven&#39;t had any spare time since then.
</div>
Hi Duncan!

I re-read your diagnostics and then your reply when asked which version
you are running. It seems everyone in the thread got confused by:

Module id = DBIx::Class
CPAN_USERID ARCANEZ &#40;Justin Hunter &lt;justin.d.hunter@gmail.com&gt;&#41;
CPAN_VERSION 0.08191
CPAN_FILE F/FR/FREW/DBIx-Class-0.08191.tar.gz
MANPAGE DBIx::Class - Extensible and flexible object &lt;-&gt; relational mapper.
INST_FILE /usr/lib/perl5/site_perl/5.8.8/DBIx/Class.pm
INST_VERSION 0.08123

And we all assumed you are running 0.08191, whereas in fact you were
running the very old 0.08123. I am 99.9% sure that the issue you
described is fixed in the 0.0819x series. Please verify this when time
permits so I can close this ticket. Thank you!
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-945581" href="/Public/Bug/Display.html?id=67969#txn-945581">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;15&nbsp;06:10:08&nbsp;2011</span>
    <span class="description">Duncan.Garland [...] motortrak.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 15 Jun 2011 11:09:57 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBIx-Class [...] rt.cpan.org&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Duncan Garland &lt;Duncan.Garland [...] motortrak.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/945581/491676/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/491676">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hang fire on that. The problem may be at this end. I&#39;m digging a bit more.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Peter Rabbitson via RT [mailto:bug-DBIx-Class@rt.cpan.org] 
Sent: 15 June 2011 07:54
To: Duncan Garland
Subject: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm 

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=67969">https://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;

On Tue Jun 07 06:44:24 2011, Duncan.Garland@motortrak.com wrote:
<div class="message-stanza open">&gt; Hi Peter,
&gt; 
&gt; An email would be better, I think.
&gt; 
&gt; I managed to sit
&gt; down for a couple of hours a Sunday or two back and do some work on a
&gt; possible patch, but I haven&#39;t had any spare time since then.
</div>
Hi Duncan!

I re-read your diagnostics and then your reply when asked which version
you are running. It seems everyone in the thread got confused by:

Module id = DBIx::Class
CPAN_USERID ARCANEZ &#40;Justin Hunter &lt;justin.d.hunter@gmail.com&gt;&#41;
CPAN_VERSION 0.08191
CPAN_FILE F/FR/FREW/DBIx-Class-0.08191.tar.gz
MANPAGE DBIx::Class - Extensible and flexible object &lt;-&gt; relational mapper.
INST_FILE /usr/lib/perl5/site_perl/5.8.8/DBIx/Class.pm
INST_VERSION 0.08123

And we all assumed you are running 0.08191, whereas in fact you were
running the very old 0.08123. I am 99.9% sure that the issue you
described is fixed in the 0.0819x series. Please verify this when time
permits so I can close this ticket. Thank you!
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-945595" href="/Public/Bug/Display.html?id=67969#txn-945595">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;15&nbsp;06:51:51&nbsp;2011</span>
    <span class="description">Duncan.Garland [...] motortrak.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 15 Jun 2011 11:51:38 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBIx-Class [...] rt.cpan.org&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Duncan Garland &lt;Duncan.Garland [...] motortrak.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/945595/491687/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/491687">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Peter,

I can&#39;t make it fail so perhaps it is fixed.

The operation of the whole DBIx::Class setup seems to have changed. _dbh_get_autoinc_seq used to run on every insert and I was able to add
some debug statements. I&#39;ve tried to do the same thing this time, but I can&#39;t detect it running and I can&#39;t see my debug messages. In fact, I can create rows even when I put a &#34;die&#34; statement in _dbh_get_autoinc_seq.

Anyway, I&#39;m not getting the error any more. You can close the ticket.

Regards

Duncan

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Peter Rabbitson via RT [mailto:bug-DBIx-Class@rt.cpan.org] 
Sent: 15 June 2011 07:54
To: Duncan Garland
Subject: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm 

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=67969">https://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;

On Tue Jun 07 06:44:24 2011, Duncan.Garland@motortrak.com wrote:
<div class="message-stanza open">&gt; Hi Peter,
&gt; 
&gt; An email would be better, I think.
&gt; 
&gt; I managed to sit
&gt; down for a couple of hours a Sunday or two back and do some work on a
&gt; possible patch, but I haven&#39;t had any spare time since then.
</div>
Hi Duncan!

I re-read your diagnostics and then your reply when asked which version
you are running. It seems everyone in the thread got confused by:

Module id = DBIx::Class
CPAN_USERID ARCANEZ &#40;Justin Hunter &lt;justin.d.hunter@gmail.com&gt;&#41;
CPAN_VERSION 0.08191
CPAN_FILE F/FR/FREW/DBIx-Class-0.08191.tar.gz
MANPAGE DBIx::Class - Extensible and flexible object &lt;-&gt; relational mapper.
INST_FILE /usr/lib/perl5/site_perl/5.8.8/DBIx/Class.pm
INST_VERSION 0.08123

And we all assumed you are running 0.08191, whereas in fact you were
running the very old 0.08123. I am 99.9% sure that the issue you
described is fixed in the 0.0819x series. Please verify this when time
permits so I can close this ticket. Thank you!
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-945608" href="/Public/Bug/Display.html?id=67969#txn-945608">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;15&nbsp;08:08:17&nbsp;2011</span>
    <span class="description">rabbit [...] rabbit.us -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 15 Jun 2011 14:08:01 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Rabbitson &lt;rabbit [...] rabbit.us&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/945608/491695/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/491695">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Duncan Garland via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: DBIx-Class
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=67969">http://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;
&gt; 
&gt; Hi Peter,
&gt; 
&gt; I can&#39;t make it fail so perhaps it is fixed.
&gt; 
&gt; The operation of the whole DBIx::Class setup seems to have changed. _dbh_get_autoinc_seq used to run on every insert and I was able to add
&gt; some debug statements. I&#39;ve tried to do the same thing this time, but I can&#39;t detect it running and I can&#39;t see my debug messages. In fact, I can create rows even when I put a &#34;die&#34; statement in _dbh_get_autoinc_seq.
&gt; 
&gt; Anyway, I&#39;m not getting the error any more. You can close the ticket.
</div>
It runs only once and only if you have not already supplied a
sequence in your column_info &#40;add_columns&#41;. The code in question
lives here: <span class="clickylink"><a target="new" rel="nofollow" href="http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=dbsrgits/DBIx-Class.git;a=blob;f=lib/DBIx/Class/Storage/DBI/Oracle/Generic.pm;h=12a14d3f429b8f0bce41708ead3148b7523726e7;hb=HEAD#l125">http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=dbsrgits/DBIx-Class.git;a=blob;f=lib/DBIx/Class/Storage/DBI/Oracle/Generic.pm;h=12a14d3f429b8f0bce41708ead3148b7523726e7;hb=HEAD#l125</a></span>

Can you verify that the sequence is properly detected the first
time please?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-945611" href="/Public/Bug/Display.html?id=67969#txn-945611">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;15&nbsp;08:27:12&nbsp;2011</span>
    <span class="description">Duncan.Garland [...] motortrak.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 15 Jun 2011 13:27:00 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBIx-Class [...] rt.cpan.org&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Duncan Garland &lt;Duncan.Garland [...] motortrak.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/945611/491698/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/491698">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Peter,

When does it run?

I can create rows when I mark the code up as follows and restart the server:

sub _dbh_get_autoinc_seq {
  my &#40;$self, $dbh, $source, $col&#41; = @_;

  die &#34;BANG!&#34;;

  my $sql_maker = $self-&gt;sql_maker;
  my &#40;$ql, $qr&#41; = map { $_ ? &#40;quotemeta $_&#41; : &#39;&#39; } $sql_maker-&gt;_quote_chars;

The module itself is loaded when the row is created because I can see statements and/or force it to die by putting statements at the top of the module.

I can&#39;t do any more on this today. I&#39;ll do some more tracing tomorrow or Friday.

Regards

Duncan 

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: rabbit@rabbit.us via RT [mailto:bug-DBIx-Class@rt.cpan.org] 
Sent: 15 June 2011 13:08
To: Duncan Garland
Subject: Re: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=67969">https://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;

Duncan Garland via RT wrote:
<div class="message-stanza open">&gt;        Queue: DBIx-Class
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=67969">http://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;
&gt; 
&gt; Hi Peter,
&gt; 
&gt; I can&#39;t make it fail so perhaps it is fixed.
&gt; 
&gt; The operation of the whole DBIx::Class setup seems to have changed. _dbh_get_autoinc_seq used to run on every insert and I was able to add
&gt; some debug statements. I&#39;ve tried to do the same thing this time, but I can&#39;t detect it running and I can&#39;t see my debug messages. In fact, I can create rows even when I put a &#34;die&#34; statement in _dbh_get_autoinc_seq.
&gt; 
&gt; Anyway, I&#39;m not getting the error any more. You can close the ticket.
</div>
It runs only once and only if you have not already supplied a
sequence in your column_info &#40;add_columns&#41;. The code in question
lives here: <span class="clickylink"><a target="new" rel="nofollow" href="http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=dbsrgits/DBIx-Class.git;a=blob;f=lib/DBIx/Class/Storage/DBI/Oracle/Generic.pm;h=12a14d3f429b8f0bce41708ead3148b7523726e7;hb=HEAD#l125">http://git.shadowcat.co.uk/gitweb/gitweb.cgi?p=dbsrgits/DBIx-Class.git;a=blob;f=lib/DBIx/Class/Storage/DBI/Oracle/Generic.pm;h=12a14d3f429b8f0bce41708ead3148b7523726e7;hb=HEAD#l125</a></span>

Can you verify that the sequence is properly detected the first
time please?


</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-945613" href="/Public/Bug/Display.html?id=67969#txn-945613">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;15&nbsp;08:36:03&nbsp;2011</span>
    <span class="description">rabbit [...] rabbit.us -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 15 Jun 2011 14:35:49 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Rabbitson &lt;rabbit [...] rabbit.us&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/945613/491700/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/491700">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 372b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Duncan Garland via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: DBIx-Class
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=67969">https://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;
&gt; 
&gt; Hi Peter,
&gt; 
&gt; When does it run?
</div>
Note the ||= in the code I linked in my last email. If your column_info
specifies a &#39;sequence&#39; value it will never run at all. Please check your
add_columns statement in the corresponding ResultClass.

Thanks!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-945644" href="/Public/Bug/Display.html?id=67969#txn-945644">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;15&nbsp;11:26:25&nbsp;2011</span>
    <span class="description">Duncan.Garland [...] motortrak.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 15 Jun 2011 16:26:11 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBIx-Class [...] rt.cpan.org&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Duncan Garland &lt;Duncan.Garland [...] motortrak.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/945644/491716/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/491716">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Peter,

The method you are referring to doesn&#39;t run either because putting a die statement in it has no effect:

sub _dbh_last_insert_id {
  my &#40;$self, $dbh, $source, @columns&#41; = @_;
  my @ids = &#40;&#41;;
  die &#34;BANG!&#34;;
  foreach my $col &#40;@columns&#41; {
    my $seq = &#40;$source-&gt;column_info&#40;$col&#41;-&gt;{sequence} ||= $self-&gt;get_autoinc_seq&#40;$source,$col&#41;&#41;;
    my $id = $self-&gt;_sequence_fetch&#40; &#39;CURRVAL&#39;, $seq &#41;;
    push @ids, $id;
  }
  return @ids;
}

I don&#39;t specify the sequence name in the result set definition file.

Do these methods get over-ridden somewhere?

Regards

Duncan


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: rabbit@rabbit.us via RT [mailto:bug-DBIx-Class@rt.cpan.org] 
Sent: 15 June 2011 13:36
To: Duncan Garland
Subject: Re: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=67969">http://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;

Duncan Garland via RT wrote:
<div class="message-stanza open">&gt;        Queue: DBIx-Class
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=67969">https://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;
&gt; 
&gt; Hi Peter,
&gt; 
&gt; When does it run?
</div>
Note the ||= in the code I linked in my last email. If your column_info
specifies a &#39;sequence&#39; value it will never run at all. Please check your
add_columns statement in the corresponding ResultClass.

Thanks!

</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-945661" href="/Public/Bug/Display.html?id=67969#txn-945661">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;15&nbsp;12:19:20&nbsp;2011</span>
    <span class="description">rabbit [...] rabbit.us -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 15 Jun 2011 18:19:10 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Rabbitson &lt;rabbit [...] rabbit.us&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/945661/491729/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/491729">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 768b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Duncan Garland via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: DBIx-Class
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=67969">https://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;
&gt; 
&gt; Hi Peter,
</div>
Hi

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; The method you are referring to doesn&#39;t run either because putting a die statement in it has no effect:
</div>
Ooooooohhhhhh. This is because newer DBIC versions support
INSERT...RETURNING, so Oracle gives back everything right
after the statement executed, making subsequent queries
&#40;and hence sequence detections&#41; unnecessary.

You can revert back to the original behavior by doing:
$schema-&gt;storage-&gt;_use_insert_returning&#40;0&#41;;
&#40;this is an unofficial API, subject to massive change&#41;.
Can you please see if the sequence is detected correctly?

Sorry for wasting your time on this, I should have thought
of it sooner.

Cheers!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-945664" href="/Public/Bug/Display.html?id=67969#txn-945664">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;15&nbsp;12:22:35&nbsp;2011</span>
    <span class="description">Duncan.Garland [...] motortrak.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 15 Jun 2011 17:22:26 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBIx-Class [...] rt.cpan.org&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Duncan Garland &lt;Duncan.Garland [...] motortrak.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/945664/491732/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/491732">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Peter,

I can trace the create statement as far as:

sub _prefetch_autovalues {
  my &#40;$self, $source, $to_insert&#41; = @_;

  my $colinfo = $source-&gt;columns_info;

  my %values;
  print STDERR &#34;_prefetch_autovalues\n&#34;;
  use Data::Dumper;
  for my $col &#40;keys %$colinfo&#41; {
    print STDERR Dumper&#40; $col &#41;;
    print STDERR &#34;auto_nextval is true\n&#34; if $colinfo-&gt;{$col}{auto_nextval};
    print STDERR &#34;to_insert-&gt;{col} exists.\n&#34; if exists $to_insert-&gt;{$col};
    print STDERR &#34;to_insert-&gt;{col} is a scalar\n&#34; if &#40; ref $to_insert-&gt;{$col} eq &#39;SCALAR&#39; &#41;;
    print STDERR &#34;to_insert-&gt;{col} ????&#34; if &#40;ref $to_insert-&gt;{$col} eq &#39;REF&#39; and ref ${$to_insert-&gt;{$col}} eq &#39;ARRAY&#39;&#41;;
    if &#40;
      $colinfo-&gt;{$col}{auto_nextval}
        and
      &#40;
        ! exists $to_insert-&gt;{$col}
          or
        ref $to_insert-&gt;{$col} eq &#39;SCALAR&#39;
          or
        &#40;ref $to_insert-&gt;{$col} eq &#39;REF&#39; and ref ${$to_insert-&gt;{$col}} eq &#39;ARRAY&#39;&#41;
      &#41;
    &#41; {
      print STDERR &#34;Get the sequence.\n&#34;;
      $values{$col} = $self-&gt;_sequence_fetch&#40;
        &#39;NEXTVAL&#39;,
        &#40; $colinfo-&gt;{$col}{sequence} ||=
            $self-&gt;_dbh_get_autoinc_seq&#40;$self-&gt;_get_dbh, $source, $col&#41;
        &#41;,
      &#41;;
    }
  }

  \%values;
}

This produces the output:

_prefetch_autovalues
$VAR1 = &#39;date_to&#39;;
$VAR1 = &#39;dealer_group_id&#39;;
to_insert-&gt;{col} exists.
$VAR1 = &#39;package_id&#39;;
to_insert-&gt;{col} exists.
$VAR1 = &#39;dealer_id&#39;;
to_insert-&gt;{col} exists.
$VAR1 = &#39;date_from&#39;;
$VAR1 = &#39;left_by&#39;;
$VAR1 = &#39;description_id&#39;;
to_insert-&gt;{col} exists.
$VAR1 = &#39;joined_by&#39;;
to_insert-&gt;{col} exists.
$VAR1 = &#39;price&#39;;
to_insert-&gt;{col} exists.
$VAR1 = &#39;id&#39;;

This means that _dbh_get_autoinc_seq is not called because the conditions aren&#39;t met.

The row is created correctly and
        my $created = $c-&gt;model&#40; &#39;DB::Mbfl2DealerPackageModel&#39; &#41;-&gt;create&#40; { package_id =&gt; $current-&gt;package_id,
                                                              dealer_id  =&gt; $dealer_id,
                                                              dealer_group_id =&gt; $dealer_group_id,
                                                              # baumuster1_3 =&gt; $current-&gt;baumuster1_3,
                                                              # baumuster4_6 =&gt; $current-&gt;baumuster4_6,
                                                              description_id =&gt; $current-&gt;description_id,
                                                              price        =&gt; $new_price,
                                                              joined_by    =&gt;  $c-&gt;user-&gt;get&#40; &#39;id&#39; &#41;
                                                            } &#41;;
        $c-&gt;log-&gt;debug&#40; &#34;id=&#34; . $created-&gt;id &#41;;

Prints the correct id.


........ Just got your email about INSERT - RETURNING. I&#39;ll do what you&#39;ve asked.

Duncan

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: rabbit@rabbit.us via RT [mailto:bug-DBIx-Class@rt.cpan.org] 
Sent: 15 June 2011 13:36
To: Duncan Garland
Subject: Re: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=67969">http://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;

Duncan Garland via RT wrote:
<div class="message-stanza open">&gt;        Queue: DBIx-Class
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=67969">https://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;
&gt; 
&gt; Hi Peter,
&gt; 
&gt; When does it run?
</div>
Note the ||= in the code I linked in my last email. If your column_info
specifies a &#39;sequence&#39; value it will never run at all. Please check your
add_columns statement in the corresponding ResultClass.

Thanks!

</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-945673" href="/Public/Bug/Display.html?id=67969#txn-945673">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;15&nbsp;12:45:21&nbsp;2011</span>
    <span class="description">Duncan.Garland [...] motortrak.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 15 Jun 2011 17:45:11 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBIx-Class [...] rt.cpan.org&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Duncan Garland &lt;Duncan.Garland [...] motortrak.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/945673/491737/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/491737">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Peter,

Yes, it works now.

Thanks.

Duncan

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: rabbit@rabbit.us via RT [mailto:bug-DBIx-Class@rt.cpan.org] 
Sent: 15 June 2011 17:19
To: Duncan Garland
Subject: Re: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=67969">http://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;

Duncan Garland via RT wrote:
<div class="message-stanza open">&gt;        Queue: DBIx-Class
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=67969">https://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;
&gt; 
&gt; Hi Peter,
</div>
Hi

<div class="message-stanza open">&gt; 
&gt; The method you are referring to doesn&#39;t run either because putting a die statement in it has no effect:
</div>
Ooooooohhhhhh. This is because newer DBIC versions support
INSERT...RETURNING, so Oracle gives back everything right
after the statement executed, making subsequent queries
&#40;and hence sequence detections&#41; unnecessary.

You can revert back to the original behavior by doing:
$schema-&gt;storage-&gt;_use_insert_returning&#40;0&#41;;
&#40;this is an unofficial API, subject to massive change&#41;.
Can you please see if the sequence is detected correctly?

Sorry for wasting your time on this, I should have thought
of it sooner.

Cheers!

</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-945683" href="/Public/Bug/Display.html?id=67969#txn-945683">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;15&nbsp;12:49:52&nbsp;2011</span>
    <span class="description">rabbit [...] rabbit.us -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 15 Jun 2011 18:49:40 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Rabbitson &lt;rabbit [...] rabbit.us&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/945683/491744/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/491744">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 322b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Duncan Garland via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: DBIx-Class
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=67969">http://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;
&gt; 
&gt; Hi Peter,
&gt; 
&gt; Yes, it works now.
&gt; 
</div>
By &#34;it works&#34; I assume you mean &#34;DBIC 0.0819x correctly guesses
the sequence name&#34;?

Thank you so much for taking time to get to the bottom of this.
Cheers!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-945686" href="/Public/Bug/Display.html?id=67969#txn-945686">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;15&nbsp;12:51:07&nbsp;2011</span>
    <span class="description">Duncan.Garland [...] motortrak.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 15 Jun 2011 17:50:58 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBIx-Class [...] rt.cpan.org&#34; &lt;bug-DBIx-Class [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Duncan Garland &lt;Duncan.Garland [...] motortrak.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/945686/491747/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/491747">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 624b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Yes.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: rabbit@rabbit.us via RT [mailto:bug-DBIx-Class@rt.cpan.org] 
Sent: 15 June 2011 17:50
To: Duncan Garland
Subject: Re: [rt.cpan.org #67969] FW: Class::Storage::Oracle::Generic.pm

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=67969">https://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;

Duncan Garland via RT wrote:
<div class="message-stanza open">&gt;        Queue: DBIx-Class
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=67969">http://rt.cpan.org/Ticket/Display.html?id=67969</a></span> &gt;
&gt; 
&gt; Hi Peter,
&gt; 
&gt; Yes, it works now.
&gt; 
</div>
By &#34;it works&#34; I assume you mean &#34;DBIC 0.0819x correctly guesses
the sequence name&#34;?

Thank you so much for taking time to get to the bottom of this.
Cheers!

</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-945688" href="/Public/Bug/Display.html?id=67969#txn-945688">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;15&nbsp;12:54:43&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/945688/491749/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/491749">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 26b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Confirmed fixed in 0.08191
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-945691" href="/Public/Bug/Display.html?id=67969#txn-945691">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;15&nbsp;12:54:44&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-945693" href="/Public/Bug/Display.html?id=67969#txn-945693">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;15&nbsp;12:54:57&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Fixed in 0.08191 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 1.324107</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
