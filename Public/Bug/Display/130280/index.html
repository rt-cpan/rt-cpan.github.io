<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #130280 for Poppler: Double free when handling quadrilaterals</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #130280 for Poppler: Double free when handling quadrilaterals</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Poppler/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Poppler/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Poppler/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Poppler/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Poppler">Poppler CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">130280</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Poppler/Active/">Poppler</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
NOCTUX [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-227180-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.0101    </td>
  </tr>
  <tr id="CF-227181-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;09&nbsp;11:00:16&nbsp;2019</span>
    <span class="description">NOCTUX [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Double free when handling quadrilaterals</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">There is a double free when using quadrilaterals returned from
highlight-annotations, that sometimes manifests into glibc asserts being
triggered &#40;&#34;double free&#34; or &#34;free of invalid size&#34;&#41;.

A minimal example program and example pdf is attached to this bugreport.
Executing the program under valgrind shows the double free:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; valgrind perl ./pdfextract_bug.pl ./test_annot.pdf
&gt; ==20006== Memcheck, a memory error detector
&gt; ==20006== Copyright &#40;C&#41; 2002-2017, and GNU GPL&#39;d, by Julian Seward et al.
&gt; ==20006== Using Valgrind-3.14.0 and LibVEX; rerun with -h for copyright info
&gt; ==20006== Command: perl ./pdfextract_bug.pl /tmp/test_annot.pdf
&gt; ==20006==
&gt; $VAR1 = bless&#40; {}, &#39;Poppler::AnnotTextMarkup&#39; &#41;;
&gt;   Poppler::Quadrilateral
&gt; ==20006== Invalid free&#40;&#41; / delete / delete[] / realloc&#40;&#41;
&gt; ==20006==    at 0x48399AB: free &#40;vg_replace_malloc.c:530&#41;
&gt; ==20006==    by 0x6496ECA: g_boxed_free &#40;gboxed.c:401&#41;
&gt; ==20006==    by 0x640091D: boxed_wrapper_destroy &#40;GBoxed.xs:391&#41;
&gt; ==20006==    by 0x640091D: default_boxed_destroy &#40;GBoxed.xs:454&#41;
&gt; ==20006==    by 0x64019F5: XS_Glib__Boxed_DESTROY &#40;GBoxed.xs:907&#41;
&gt; ==20006==    by 0x49BF49E: Perl_pp_entersub &#40;pp_hot.c:5237&#41;
&gt; ==20006==    by 0x48C8298: Perl_call_sv &#40;perl.c:3043&#41;
&gt; ==20006==    by 0x49C81EE: S_curse &#40;sv.c:6992&#41;
&gt; ==20006==    by 0x49C8CDC: Perl_sv_clear &#40;sv.c:6586&#41;
&gt; ==20006==    by 0x49C9D47: Perl_sv_free2 &#40;sv.c:7093&#41;
&gt; ==20006==    by 0x4A2E494: Perl_leave_scope &#40;scope.c:1191&#41;
&gt; ==20006==    by 0x4A47BF7: Perl_pp_leave &#40;pp_ctl.c:2136&#41;
&gt; ==20006==    by 0x4976E79: Perl_runops_debug &#40;dump.c:2537&#41;
&gt; ==20006==  Address 0x90c1cb0 is 0 bytes inside a block of size 64 free&#39;d
&gt; ==20006==    at 0x48399AB: free &#40;vg_replace_malloc.c:530&#41;
&gt; ==20006==    by 0x654A0A2: array_free &#40;garray.c:372&#41;
&gt; ==20006==    by 0x66647CC: _free_array &#40;gperl-i11n-marshal-array.c:48&#41;
&gt; ==20006==    by 0x66647CC: array_to_sv &#40;gperl-i11n-marshal-array.c:181&#41;
&gt; ==20006==    by 0x66647CC: arg_to_sv &#40;gperl-i11n-marshal-arg.c:230&#41;
&gt; ==20006==    by 0x6665E37: invoke_c_code.isra.0 &#40;gperl-i11n-invoke-c.c:236&#41;
&gt; ==20006==    by 0x666BCAE: XS_Glib__Object__Introspection_invoke &#40;GObjectIntrospection.xs:992&#41;
&gt; ==20006==    by 0x49BF49E: Perl_pp_entersub &#40;pp_hot.c:5237&#41;
&gt; ==20006==    by 0x4976E79: Perl_runops_debug &#40;dump.c:2537&#41;
&gt; ==20006==    by 0x48D3E0D: S_run_body &#40;perl.c:2716&#41;
&gt; ==20006==    by 0x48D3E0D: perl_run &#40;perl.c:2639&#41;
&gt; ==20006==    by 0x1091B5: main &#40;perlmain.c:127&#41;
&gt; ==20006==  Block was alloc&#39;d at
&gt; ==20006==    at 0x48386AF: malloc &#40;vg_replace_malloc.c:298&#41;
&gt; ==20006==    by 0x483ADE7: realloc &#40;vg_replace_malloc.c:826&#41;
&gt; ==20006==    by 0x651A0C8: g_realloc &#40;gmem.c:164&#41;
&gt; ==20006==    by 0x6549AFB: g_array_maybe_expand &#40;garray.c:820&#41;
&gt; ==20006==    by 0x654B139: g_array_sized_new &#40;garray.c:208&#41;
&gt; ==20006==    by 0x700526E: create_poppler_quads_from_annot_quads &#40;poppler-annot.cc:293&#41;
&gt; ==20006==    by 0x700526E: poppler_annot_text_markup_get_quadrilaterals &#40;poppler-annot.cc:1648&#41;
&gt; ==20006==    by 0x65E06CF: ffi_call_unix64 &#40;in /usr/lib/libffi.so.6.0.4&#41;
&gt; ==20006==    by 0x65E009F: ffi_call &#40;in /usr/lib/libffi.so.6.0.4&#41;
&gt; ==20006==    by 0x666592A: invoke_c_code.isra.0 &#40;gperl-i11n-invoke-c.c:202&#41;
&gt; ==20006==    by 0x666BCAE: XS_Glib__Object__Introspection_invoke &#40;GObjectIntrospection.xs:992&#41;
&gt; ==20006==    by 0x49BF49E: Perl_pp_entersub &#40;pp_hot.c:5237&#41;
&gt; ==20006==    by 0x4976E79: Perl_runops_debug &#40;dump.c:2537&#41;
</div>
From debugging with GDB, I could debug that 0x90c1cb0 in the output above is
the address of the g_array.data of the glib-array of Poppler-quadrilaterals, so
basically the address of the first element of the quads.
From gdb, I further saw, that glib&#39;s array_free is then later called with
&#39;flags=FREE_SEGMENT&#39;, so when deallocating the whole array, all quad-elements
are freeed as well when cleaning up the local variables in perls stackframe.
Yet, the individual quads contained in the array are once more deconstructed by
the perl-bindings as a boxed glib-value &#40;XS_Glib__Boxed_DESTROY&#41;, causing the
actual double free.

Unfortunately, I am not firm enough with glib and its ownership model to
actually fix the issue myself.

I have however written an equivalent C-implementation that exhibits exactly the
same error-pattern &#40;attached as pdfextract_bug.c&#41; with some comments, which
hopefully help to better understand the specific issue. Compile and run with:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; gcc -o /tmp/pdfextract ./pdfextract_bug.c `pkg-config --cflags --libs poppler-glib` \
&gt;       &#38;&#38; valgrind /tmp/pdfextract file://$&#40;readlink -f /tmp/test_annot.pdf&#41;
</div>
Thank you for your project and for reading this bugreport :&#41;
I hope the information is more or less complete, but I&#39;d be happy to assist you
in any way in further troubleshooting the issue.

Best regards,
Simon

Relevant library versions:
        - CPAN Module Poppler: 1.0101
        - Distro: Archlinux
        - Perl Version 5.30.0-3
        - Glib2 version: 2.60.6-1
        - glib-perl/gtk2-perl version: 1.329-2
        - Glib::Object::Introspection version 0.047-3
        - gcc version: 9.1.0
        - glibc version: 2.29-4
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> pdfannots_bug.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/env perl

use strict;
use warnings;

BEGIN {
	push @INC, qw&#40; /home/noctux/perl5/lib/perl5/x86_64-linux-thread-multi /home/noctux/perl5/lib/perl5 /usr/lib/perl5/5.28/site_perl /usr/share/perl5/site_perl /usr/lib/perl5/5.28/vendor_perl /usr/share/perl5/vendor_perl /usr/lib/perl5/5.28/core_perl /usr/share/perl5/core_perl&#41;;
}

use Poppler;
use Search::Xapian;
use Data::Dumper;

my $pdf = Poppler::Document-&gt;new_from_file&#40;$ARGV[0]&#41;;

my $n_pages  = $pdf-&gt;get_n_pages;

for my $pagenr &#40;2&#41; {
	my $page = $pdf-&gt;get_page&#40;$pagenr&#41;;
	my $mappings = $page-&gt;get_annot_mapping&#40;&#41;;
	for my $mapping &#40;$mappings&#41; {
		next unless $mapping;
		my $annot = $mapping-&gt;annot;
		my $type  = $annot-&gt;get_annot_type&#40;&#41;;
		if &#40;$type eq &#34;highlight&#34;&#41; {
			study 1;
			my @quads = $annot-&gt;get_quadrilaterals&#40;&#41;;
			#for my $quad &#40;@$quads&#41; {
				##print &#34;  &#34; . ref&#40;$quad&#41; . &#34;\n&#34;;
			#}
		} else {
			# TODO: DEBUG
			print &#34;Unsupported Annotation type: $type\n&#34;;
		}
	}
}
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> pdfextract_bug.c</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#include &lt;poppler.h&gt;
#include &lt;stdio.h&gt;

int main&#40;int argc, const char *argv[]&#41;
{
	if &#40;argc &lt; 2&#41; {
		printf&#40;&#34;Usage: %s &lt;document&gt;&#34;, argv[0]&#41;;
		return -1;
	}

	GError *err = NULL;
	PopplerDocument *doc = poppler_document_new_from_file&#40;argv[1], NULL, &#38;err&#41;;
	if &#40;!doc&#41; {
		fprintf&#40;stderr, &#34;Error creating poppler document: %s\n&#34;, err-&gt;message&#41;;
		g_error_free&#40;err&#41;;
		return -2;
	}

	int npages = poppler_document_get_n_pages&#40;doc&#41;;
	for &#40;int i = 0; i &lt; npages; i++&#41; {
		PopplerPage *page = poppler_document_get_page&#40;doc, i&#41;;
		if &#40;!page&#41; return -3;

		GList *mapping = poppler_page_get_annot_mapping&#40;page&#41;;
		if &#40;!mapping&#41; {
			g_object_unref&#40;page&#41;;
			continue;
		}

		for&#40;GList *i=mapping; i; i = i-&gt;next&#41; {
			PopplerAnnot* annot = &#40;&#40;PopplerAnnotMapping *&#41;i-&gt;data&#41;-&gt;annot;
			PopplerAnnotType type = poppler_annot_get_annot_type&#40;annot&#41;;
			if &#40;type == POPPLER_ANNOT_HIGHLIGHT&#41; {
				GArray* quads = poppler_annot_text_markup_get_quadrilaterals&#40;&#40;PopplerAnnotTextMarkup*&#41; annot&#41;;
				for &#40;guint i = 0; i &lt; quads-&gt;len; i++&#41; {
					PopplerQuadrilateral *quad = &#38;g_array_index&#40;quads, PopplerQuadrilateral, i&#41;;
					printf&#40;&#34;%p\n&#34;, quad&#41;;
					// This free is invalid, as we will free quad twice, once here and once below
					g_free&#40;quad&#41;;
				}
				// this is where the double free will then happen, because free_segment is set to 1, so we try to double free quad
				g_array_free&#40;quads, 1&#41;;
			}
		}

		poppler_page_free_annot_mapping&#40;mapping&#41;;

		g_object_unref&#40;page&#41;;
	}

	g_object_unref&#40;doc&#41;;

	return 0;
}
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test_annot.pdf</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;26&nbsp;12:45:06&nbsp;2019</span>
    <span class="description">VOLKENING [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the detailed bug report. The Poppler module doesn&#39;t actually include any XS anymore -- it utilizes Glib::Object::Introspection to auto-generate the bindings. It might be possible to fix this by overriding the behavior of the appropriate class, but I suspect this will be beyond my capabilities -- at least to solve quickly.

I have contacted the gtk-perl mailing list to seek advice on whether this is an issue with the Poppler bindings or with Glib::Object::Introspection.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;26&nbsp;12:45:07&nbsp;2019</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;26&nbsp;14:25:23&nbsp;2019</span>
    <span class="description">NOCTUX [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Aug 26 12:45:06 2019, VOLKENING wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks for the detailed bug report. The Poppler module doesn&#39;t
&gt; actually include any XS anymore -- it utilizes
&gt; Glib::Object::Introspection to auto-generate the bindings. It might be
&gt; possible to fix this by overriding the behavior of the appropriate
&gt; class, but I suspect this will be beyond my capabilities -- at least
&gt; to solve quickly.
</div>
No worries, I know how that feels, got a bit lost in G::O::I&#39;s source code at least once as well.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have contacted the gtk-perl mailing list to seek advice on whether
&gt; this is an issue with the Poppler bindings or with
&gt; Glib::Object::Introspection.
</div>
Thank you for forwarding this bug to gtk-perl! Let&#39;s see how this develops.

While rereading this bug, I noticed that I made a small mistake within my original upload and pasted an old version of pdfannots_bug.pl with the wrong page number &#40;the original faulty pdf was copyright-protected and had a bug on page 2, but the uploaded pdf exhibits this issue on page 0&#41;. I&#39;m reuploading the fixed version with this message.

Diff:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 18c18
&gt; &lt; for my $pagenr &#40;2&#41; {
&gt; ---
<div class="message-stanza open">&gt; &gt; for my $pagenr &#40;0&#41; {
</div></div>
Thank you again for the prompt response and for relaying this issue.

Best regards,
Simon
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> pdfannots_bug.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/env perl

use strict;
use warnings;

BEGIN {
	push @INC, qw&#40; /home/noctux/perl5/lib/perl5/x86_64-linux-thread-multi /home/noctux/perl5/lib/perl5 /usr/lib/perl5/5.28/site_perl /usr/share/perl5/site_perl /usr/lib/perl5/5.28/vendor_perl /usr/share/perl5/vendor_perl /usr/lib/perl5/5.28/core_perl /usr/share/perl5/core_perl&#41;;
}

use Poppler;
use Search::Xapian;
use Data::Dumper;

my $pdf = Poppler::Document-&gt;new_from_file&#40;$ARGV[0]&#41;;

my $n_pages  = $pdf-&gt;get_n_pages;

for my $pagenr &#40;0&#41; {
	my $page = $pdf-&gt;get_page&#40;$pagenr&#41;;
	my $mappings = $page-&gt;get_annot_mapping&#40;&#41;;
	for my $mapping &#40;$mappings&#41; {
		next unless $mapping;
		my $annot = $mapping-&gt;annot;
		my $type  = $annot-&gt;get_annot_type&#40;&#41;;
		if &#40;$type eq &#34;highlight&#34;&#41; {
			study 1;
			my @quads = $annot-&gt;get_quadrilaterals&#40;&#41;;
			#for my $quad &#40;@$quads&#41; {
				##print &#34;  &#34; . ref&#40;$quad&#41; . &#34;\n&#34;;
			#}
		} else {
			# TODO: DEBUG
			print &#34;Unsupported Annotation type: $type\n&#34;;
		}
	}
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;16&nbsp;03:57:11&nbsp;2019</span>
    <span class="description">NOCTUX [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">As it seems, there has been some activity on gtk-perl regarding the issue that you posted on G::O::I:
  <span class="clickylink"><a target="new" rel="nofollow" href="https://mail.gnome.org/archives/gtk-perl-list/2019-September/msg00004.html">https://mail.gnome.org/archives/gtk-perl-list/2019-September/msg00004.html</a></span>

I have tested the code with the proposed changes by building G::O::I from master which includes <span class="clickylink"><a target="new" rel="nofollow" href="https://gitlab.gnome.org/GNOME/perl-glib-object-introspection/commit/42cdec8f455bd855c3f4af056d82f6acd10ab36a">https://gitlab.gnome.org/GNOME/perl-glib-object-introspection/commit/42cdec8f455bd855c3f4af056d82f6acd10ab36a</a></span>
This commit seems to indeed resolve the original issue, Segfaults are gone in the test code and valgrind is happy as well.

I did not directly respond to the mailinglist as I could not really figure out what Message-ID to respond to to not break threading. Please pass along my thanks to Torsten Sch√∂nfeld if you reply to the list.

However, there is something fishy about the objects returned. When acting upon those objects returned. Transitive objects &#40;in this case the points within the quadrilaterals&#41; themselves seem to be freed too early while they are still in use from the perl side, causing invalid reads. I&#39;ve attached an slightly revised example of the test code &#40;pdfextract_invalid_read.pl&#41; to this message, which exhibits the issue with the test pdf &#40;test_annot.pdf&#41; using current git-master of G::O::I &#40;revision 42cdec8f455bd855c3f4af056d82f6acd10ab36a&#41;.

Valgrind output:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; $ valgrind perl -I/tmp/poppler-test/local/lib/perl5 -I/home/noctux/perl5/lib/perl5/x86_64-linux-thread-multi -I/home/noctux/perl5/lib/perl5 -I/usr/lib/perl5/5.28/site_perl -I/usr/share/perl5/site_perl -I/usr/lib/perl5/5.28/vendor_perl -I/usr/share/perl5/vendor_perl -I/usr/lib/perl5/5.28/core_perl -I/usr/share/perl5/core_perl ./pdfextract_invalid_read.pl ./test_annot.pdf
&gt; ==25785== Memcheck, a memory error detector
&gt; ==25785== Copyright &#40;C&#41; 2002-2017, and GNU GPL&#39;d, by Julian Seward et al.
&gt; ==25785== Using Valgrind-3.14.0 and LibVEX; rerun with -h for copyright info
&gt; ==25785== Command: perl -I/tmp/poppler-test/local/lib/perl5 -I/home/noctux/perl5/lib/perl5/x86_64-linux-thread-multi -I/home/noctux/perl5/lib/perl5 -I/usr/lib/perl5/5.28/site_perl -I/usr/share/perl5/site_perl -I/usr/lib/perl5/5.28/vendor_perl -I/usr/share/perl5/vendor_perl -I/usr/lib/perl5/5.28/core_perl -I/usr/share/perl5/core_perl ./pdfextract_invalid_read.pl ./test_annot.pdf
&gt; ==25785== 
&gt; ==25785== Invalid read of size 8
&gt; ==25785==    at 0x650CF50: g_field_info_get_field &#40;in /usr/lib/libgirepository-1.0.so.1.0.0&#41;
&gt; ==25785==    by 0x64EECBF: get_field.constprop.0 &#40;in /tmp/poppler-test/local/lib/perl5/x86_64-linux-thread-multi/auto/Glib/Object/Introspection/Introspection.so&#41;
&gt; ==25785==    by 0x64EF02C: XS_Glib__Object__Introspection__get_field &#40;in /tmp/poppler-test/local/lib/perl5/x86_64-linux-thread-multi/auto/Glib/Object/Introspection/Introspection.so&#41;
&gt; ==25785==    by 0x4953220: Perl_pp_entersub &#40;in /usr/lib/perl5/5.30/core_perl/CORE/libperl.so&#41;
&gt; ==25785==    by 0x4949785: Perl_runops_standard &#40;in /usr/lib/perl5/5.30/core_perl/CORE/libperl.so&#41;
&gt; ==25785==    by 0x48BE2A5: perl_run &#40;in /usr/lib/perl5/5.30/core_perl/CORE/libperl.so&#41;
&gt; ==25785==    by 0x1091A6: main &#40;in /usr/bin/perl&#41;
&gt; ==25785==  Address 0x8cbf920 is 0 bytes inside a block of size 64 free&#39;d
&gt; ==25785==    at 0x48399AB: free &#40;vg_replace_malloc.c:530&#41;
&gt; ==25785==    by 0x63DD112: ??? &#40;in /usr/lib/libglib-2.0.so.0.6200.0&#41;
&gt; ==25785==    by 0x64EFE2C: arg_to_sv &#40;in /tmp/poppler-test/local/lib/perl5/x86_64-linux-thread-multi/auto/Glib/Object/Introspection/Introspection.so&#41;
&gt; ==25785==    by 0x64F1327: invoke_c_code.isra.0 &#40;in /tmp/poppler-test/local/lib/perl5/x86_64-linux-thread-multi/auto/Glib/Object/Introspection/Introspection.so&#41;
&gt; ==25785==    by 0x64F1836: XS_Glib__Object__Introspection_invoke &#40;in /tmp/poppler-test/local/lib/perl5/x86_64-linux-thread-multi/auto/Glib/Object/Introspection/Introspection.so&#41;
&gt; ==25785==    by 0x4953220: Perl_pp_entersub &#40;in /usr/lib/perl5/5.30/core_perl/CORE/libperl.so&#41;
&gt; ==25785==    by 0x4949785: Perl_runops_standard &#40;in /usr/lib/perl5/5.30/core_perl/CORE/libperl.so&#41;
&gt; ==25785==    by 0x48BE2A5: perl_run &#40;in /usr/lib/perl5/5.30/core_perl/CORE/libperl.so&#41;
&gt; ==25785==    by 0x1091A6: main &#40;in /usr/bin/perl&#41;
&gt; ==25785==  Block was alloc&#39;d at
&gt; ==25785==    at 0x48386AF: malloc &#40;vg_replace_malloc.c:298&#41;
&gt; ==25785==    by 0x483ADE7: realloc &#40;vg_replace_malloc.c:826&#41;
&gt; ==25785==    by 0x63AE728: g_realloc &#40;in /usr/lib/libglib-2.0.so.0.6200.0&#41;
&gt; ==25785==    by 0x63E346B: ??? &#40;in /usr/lib/libglib-2.0.so.0.6200.0&#41;
&gt; ==25785==    by 0x63E3929: g_array_sized_new &#40;in /usr/lib/libglib-2.0.so.0.6200.0&#41;
&gt; ==25785==    by 0x6E9266E: poppler_annot_text_markup_get_quadrilaterals &#40;in /usr/lib/libpoppler-glib.so.8.14.0&#41;
&gt; ==25785==    by 0x4BE26CF: ffi_call_unix64 &#40;in /usr/lib/libffi.so.6.0.4&#41;
&gt; ==25785==    by 0x4BE209F: ffi_call &#40;in /usr/lib/libffi.so.6.0.4&#41;
&gt; ==25785==    by 0x64F0E4A: invoke_c_code.isra.0 &#40;in /tmp/poppler-test/local/lib/perl5/x86_64-linux-thread-multi/auto/Glib/Object/Introspection/Introspection.so&#41;
&gt; ==25785==    by 0x64F1836: XS_Glib__Object__Introspection_invoke &#40;in /tmp/poppler-test/local/lib/perl5/x86_64-linux-thread-multi/auto/Glib/Object/Introspection/Introspection.so&#41;
&gt; ==25785==    by 0x4953220: Perl_pp_entersub &#40;in /usr/lib/perl5/5.30/core_perl/CORE/libperl.so&#41;
&gt; ==25785==    by 0x4949785: Perl_runops_standard &#40;in /usr/lib/perl5/5.30/core_perl/CORE/libperl.so&#41;
&gt; ==25785== 
&gt; 216
&gt; ==25785== 
&gt; ==25785== HEAP SUMMARY:
&gt; ==25785==     in use at exit: 6,877,766 bytes in 33,066 blocks
&gt; ==25785==   total heap usage: 93,703 allocs, 60,637 frees, 17,065,111 bytes allocated
&gt; ==25785== 
&gt; ==25785== LEAK SUMMARY:
&gt; ==25785==    definitely lost: 21,117 bytes in 31 blocks
&gt; ==25785==    indirectly lost: 65,200 bytes in 29 blocks
&gt; ==25785==      possibly lost: 6,113,354 bytes in 26,529 blocks
&gt; ==25785==    still reachable: 674,159 bytes in 6,450 blocks
&gt; ==25785==                       of which reachable via heuristic:
&gt; ==25785==                         newarray           : 20,720 bytes in 607 blocks
&gt; ==25785==         suppressed: 0 bytes in 0 blocks
&gt; ==25785== Rerun with --leak-check=full to see details of leaked memory
&gt; ==25785== 
&gt; ==25785== For counts of detected and suppressed errors, rerun with: -v
&gt; ==25785== ERROR SUMMARY: 1 errors from 1 contexts &#40;suppressed: 0 from 0&#41;
</div>
Thank you again for taking interest in this bug-report :&#41;
~ Simon
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> pdfextract_invalid_read.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/env perl

use strict;
use warnings;

use Poppler;
use Data::Dumper;

my $pdf = Poppler::Document-&gt;new_from_file&#40;$ARGV[0]&#41;;

my $n_pages  = $pdf-&gt;get_n_pages;
my $title    = $pdf-&gt;get_title;
my $author   = $pdf-&gt;get_author;
my $keywords = $pdf-&gt;get_keywords;


my $i = 0;
for my $pagenr &#40;0 .. $n_pages-1&#41; {
	my $page = $pdf-&gt;get_page&#40;$pagenr&#41;;
	for my $mapping &#40;$page-&gt;get_annot_mapping&#40;&#41;&#41; {
		my $annot = $mapping-&gt;annot;
		my $type  = $annot-&gt;get_annot_type&#40;&#41;;
		if &#40;$type eq &#34;highlight&#34;&#41; {
			my $quads = $annot-&gt;get_quadrilaterals&#40;&#41;;
			for my $quad &#40;@$quads&#41; {
				my $p1 = $quad-&gt;p1;
				print $p1-&gt;x . &#34;\n&#34;;
			}
		}
	}
}
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test_annot.pdf</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;16&nbsp;05:14:30&nbsp;2019</span>
    <span class="description">NOCTUX [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ah, what I&#39;ve forgotten above: removing the &#34;print $p1-&gt;x&#34; line removes the invalid read, so it is the culprit of the issue.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;16&nbsp;11:38:12&nbsp;2019</span>
    <span class="description">VOLKENING [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for testing Torsten&#39;s patches and reporting back.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; However, there is something fishy about the objects returned. When
&gt; acting upon those objects returned. Transitive objects &#40;in this case
&gt; the points within the quadrilaterals&#41; themselves seem to be freed too
&gt; early while they are still in use from the perl side, causing invalid
&gt; reads. I&#39;ve attached an slightly revised example of the test code
&gt; &#40;pdfextract_invalid_read.pl&#41; to this message, which exhibits the issue
&gt; with the test pdf &#40;test_annot.pdf&#41; using current git-master of G::O::I
&gt; &#40;revision 42cdec8f455bd855c3f4af056d82f6acd10ab36a&#41;.
</div>
Do you want to open a new thread on the gtk-perl mailing list regarding this? I think that will be the place to get help, as the new issue is probably still related to G:I:O. In the meantime, I will reply to the original request and let them know the status.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;20&nbsp;15:07:37&nbsp;2019</span>
    <span class="description">NOCTUX [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Sep 16 11:38:12 2019, VOLKENING wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Do you want to open a new thread on the gtk-perl mailing list
&gt; regarding this? I think that will be the place to get help, as the new
&gt; issue is probably still related to G:I:O. In the meantime, I will
&gt; reply to the original request and let them know the status.
</div>
Thank you for your efforts and for relaying that message.

Yepp, you are write, this bug is most likely not related to Poppler itself, but to the perl-glib-bindings. I have reported the issue to G::O::I&#39;s bugtracker now:

<span class="clickylink"><a target="new" rel="nofollow" href="https://gitlab.gnome.org/GNOME/perl-glib-object-introspection/issues/1">https://gitlab.gnome.org/GNOME/perl-glib-object-introspection/issues/1</a></span>

So I&#39;m closing this bug for now. Thank you once more for your help.
~Simon
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;20&nbsp;15:07:38&nbsp;2019</span>
    <span class="description">NOCTUX [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
