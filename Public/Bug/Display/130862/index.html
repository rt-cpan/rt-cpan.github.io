<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #130862 for Mail-Mbox-MessageParser: Skips From-line longer than 90 chars starting just before a chunk</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #130862 for Mail-Mbox-MessageParser: Skips From-line longer than 90 chars starting just before a chunk</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Mail-Mbox-MessageParser/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Mail-Mbox-MessageParser/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Mail-Mbox-MessageParser/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Mail-Mbox-MessageParser/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-Mbox-MessageParser">Mail-Mbox-MessageParser CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">130862</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Mail-Mbox-MessageParser/Active/">Mail-Mbox-MessageParser</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
peter [...] peternowee.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-19994-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-19995-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;30&nbsp;06:52:57&nbsp;2019</span>
    <span class="description">peter [...] peternowee.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Skips From-line longer than 90 chars starting just before a chunk</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 30 Oct 2019 18:25:09 +0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-Mbox-MessageParser [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Nowee &lt;peter [...] peternowee.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I noticed that a mail with a From-line &#40;the line that marks the start 
of another email in an mbox&#41; longer than 90 characters starting just 
before a multiple of MessageParser&#39;s `read_chunk_size` &#40;default 
20000&#41;, at least if it is the last mail in the file, possibly also at 
other places, is not seen by grepmail.

Attached are two anonymized mbox files, mostly identical. They both 
contain two emails:

    $ grep -c &#39;^From &#39; *mbox
    right--last-mail-after-chunk.mbox:2
    wrong--last-mail-before-chunk.mbox:2

The only difference between the two files is the length of the first 
email and thereby the start of the last email. It starts at byte 19885 
in the &#39;wrong&#39; mbox and at byte 20048 in the &#39;right&#39; mbox. This leads 
to a wrong count by grepmail:

    $ grepmail -r -e &#39;.&#39; *mbox
    right--last-mail-after-chunk.mbox: 2
    wrong--last-mail-before-chunk.mbox: 1

I found that increasing the value of `$backup_amount` in 
`Mail/Mbox/MessageParser/Perl.pm`, line 216 &#40;version 1.5111&#41; solves 
the problem for me.

The value 90 is hardcoded in some other places as well:

    Mail/Mbox/MessageParser/Grep.pm:239:    # believe the RFC says header lines can be at most 90 characters long.
    Mail/Mbox/MessageParser/Grep.pm:241:      qr/$Mail::Mbox::MessageParser::Config{&#39;from_pattern&#39;}/m,90&#41;&#41;
    Mail/Mbox/MessageParser/Perl.pm:215:    # believe the RFC says header lines can be at most 90 characters long.
    Mail/Mbox/MessageParser/Perl.pm:216:    my $backup_amount = 90;
    Mail/Mbox/MessageParser/Perl.pm:221:    # 90-character lookback, but doesn&#39;t indicate the start of the next email.
    anonymize_mailbox:74:  # RFC says header lines can be at most 90 characters long.
    anonymize_mailbox:75:  my $search_position = length&#40;$READ_BUFFER&#41; - 90;

I could not quickly find where the maximum of 90 could have come from, 
but I think that a 998-character limit should apply today:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2.1.1.  Line Length Limits
&gt; There are two limits that this specification places on the number of
&gt; characters in a line.  Each line of characters MUST be no more than
&gt; 998 characters, and SHOULD be no more than 78 characters, excluding
&gt; the CRLF.
</div>-- [RFC 5322, Internet Message Format]&#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://tools.ietf.org/html/rfc5322&#41;">https://tools.ietf.org/html/rfc5322&#41;</a></span>

I think it is not uncommon these days to have emails with a From-line 
longer than 78 or 90 characters. For example, some automated mailers 
seem to use dynamically generated addresses containing some long, 
probably unique, string in the local part of their From-address.

I did not file any pull request, because I cannot really oversee the 
possible side-effects of increasing the limit more than tenfold, for 
example for very short emails.

Used versions:
- Debian 10.1 buster, Linux 4.19.67-2+deb10u1 on amd64 with:
  - perl 5.28.1-6 &#40;Debian package&#41;.
  - libmail-mbox-messageparser-perl 1.5111-2 &#40;Debian package&#41;.
  - grepmail 5.3104-1 &#40;Debian package&#41;, or
  - grepmail 5.3111 &#40;coppit/grepmail master at commit 3fc994a of 
    2018-07-12&#41;.
- Debian 9.11 stretch, Linux 4.9.189-3+deb9u1 on amd64 with:
  - perl 5.24.1-3+deb9u5 &#40;Debian package&#41;.
  - libmail-mbox-messageparser-perl 1.5105-1 &#40;Debian package&#41;.
  - grepmail 5.3033-8 &#40;Debian package&#41;.

Hope this helps and thank you for your work!

Best regards,
Peter Nowee
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;30&nbsp;07:59:39&nbsp;2019</span>
    <span class="description">peter [...] peternowee.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #130862] Skips From-line longer than 90 chars starting just before a chunk</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 30 Oct 2019 19:59:05 +0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Bugs in Mail-Mbox-MessageParser via RT &lt;bug-Mail-Mbox-MessageParser [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Nowee &lt;peter [...] peternowee.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Correction on the limit of 998 I mentioned just now:

The From-line that separates emails in an mbox is actually not part of 
the email itself, so probably not governed by RFC 5322 after all.

RFC 4155 &#40;The application/mbox Media Type&#41; defines the mbox format, 
but does not seem to say anything about the maximum length of the From-
line. It does say that the From-line consists of the email address and 
timestamp: <span class="clickylink"><a target="new" rel="nofollow" href="https://tools.ietf.org/html/rfc4155">https://tools.ietf.org/html/rfc4155</a></span>

Here is some discussion about the maximum length of an email address, 
which is seems to be 254 characters, although others say 320:
<span class="clickylink"><a target="new" rel="nofollow" href="https://stackoverflow.com/questions/386294/what-is-the-maximum-length-of-a-valid-email-address">https://stackoverflow.com/questions/386294/what-is-the-maximum-length-of-a-valid-email-address</a></span>

The `from_pattern` in `Mail/Mbox/MessageParser/Config.pm` also 
mentions a possible additional string in the From-line for smail 
compatibility. Not sure how long that can be.

So, maybe the mbox From-line will never reach 998 characters, but a 
safe choice would still be probably be in the hundreds &#40;400 or more&#41;.

Regards,
Peter Nowee
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
