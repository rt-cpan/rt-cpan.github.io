<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #14755 for Net-MySQL: bad insert id being returned</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #14755 for Net-MySQL: bad insert id being returned</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-MySQL/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-MySQL/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-MySQL/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-MySQL/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-MySQL">Net-MySQL CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">14755</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-MySQL/Active/">Net-MySQL</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bugs [...] dcmconsulting.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-22906-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22907-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;26&nbsp;09:52:18&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> bad insert id being returned</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here is stuff about my environment:

for perl version This is perl, v5.8.4 built for i386-freebsd
Net::MySQL
FreeBSD 4.7-RELEASE-p28 FreeBSD 4.7-RELEASE-p28 #40: Fri Mar 11 14:16:49 MST 2005     root@fc2:/usr/src/sys/compile/VKERN  i386


The problem is that i call the package Net::MySQL to insert some rows into a database. When i call the method, get_insert_id&#40;&#41;

it returns the correct id, until i get to id 65536 &#40;2^8&#41;

Here is the code sample:
         if &#40;$mysql-&gt;is_error&#41;{
                #get error message              
                $toBeReturned=&#34;ERROR:&#34;.$mysql-&gt;get_error_message;
                open&#40;FILE, &#34;&gt;&gt;$LOG_FILE&#34;&#41; || die&#40;&#34;n$LOG_FILE: $!nn&#34;&#41;;
                #Print to the file the name and email to the file
                print FILE &#34;ERROR Customer Insert sql:$insertSQL\n&#34;;
                close&#40;FILE&#41;;
        }
        else{
                $toBeReturned=$mysql-&gt;get_insert_id;
        }

$toBeReturned equals 253 for every customer after I have passed the id 65535. 

Please help me resolve this problem.

Thanks,
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;31&nbsp;18:53:00&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Asgeir</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I also bumped into this by way of the DBD-mysqlPP module... mysqlPP uses
Net-MySQL, so this bug is propagated into this module as well. Whenever
I insert rows in a table with an auto incremented index field above 16
bit &#40;65536&#41;, I get 253 from get_insert_id &#40;by way of the mysqlPP
property &#39;mysql_insertid&#39;&#41;...

My guess is that the MySQL guys changed the interface slightly at some
point, to accomodate for really big indexes and Net-MySQL was never
adjusted to accustom this.

The relevant part of Net-MySQL looks like this:
sub _get_insert_id
{
        my $self = shift;
        my $packet = shift;
        return ord&#40;substr $packet, 6, 1&#41; if ord&#40;substr $packet, 6, 1&#41; !=
0xfc;
        unpack &#39;v&#39;, substr $packet, 7, 2;
}

I am sure those with knowledge would instantly see what could cause
this... I have no knowledge of the MySQL protocols, so it is really
beyond my abilities and resources.

This bug is annoying like hell. We really need to get the newly inserted
index value without an additional SQL query... The alternative is to
switch to DBD-MySQL of course...

On Mon Sep 26 09:52:18 2005, guest wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Here is stuff about my environment:
&gt; 
&gt; for perl version This is perl, v5.8.4 built for i386-freebsd
&gt; Net::MySQL
&gt; FreeBSD 4.7-RELEASE-p28 FreeBSD 4.7-RELEASE-p28 #40: Fri Mar 11
&gt; 14:16:49 MST 2005     root@fc2:/usr/src/sys/compile/VKERN  i386
&gt; 
&gt; 
&gt; The problem is that i call the package Net::MySQL to insert some rows
&gt; into a database. When i call the method, get_insert_id&#40;&#41;
&gt; 
&gt; it returns the correct id, until i get to id 65536 &#40;2^8&#41;
&gt; 
&gt; Here is the code sample:
&gt;          if &#40;$mysql-&gt;is_error&#41;{
&gt;               #get error message
&gt;               $toBeReturned=&#34;ERROR:&#34;.$mysql-&gt;get_error_message;
&gt;               open&#40;FILE, &#34;&gt;&gt;$LOG_FILE&#34;&#41; || die&#40;&#34;n$LOG_FILE: $!nn&#34;&#41;;
&gt;               #Print to the file the name and email to the file
&gt;               print FILE &#34;ERROR Customer Insert sql:$insertSQL\n&#34;;
&gt;               close&#40;FILE&#41;;
&gt;       }
&gt;       else{
&gt;               $toBeReturned=$mysql-&gt;get_insert_id;
&gt;       }
&gt; 
&gt; $toBeReturned equals 253 for every customer after I have passed the id
&gt; 65535.
&gt; 
&gt; Please help me resolve this problem.
&gt; 
&gt; Thanks,
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;31&nbsp;18:53:01&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;14&nbsp;04:29:24&nbsp;2006</span>
    <span class="description">krisodb [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> krisodb [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Replace the function with following code. &#40;see below&#41;
Note: I only tested till 131072 records.
The last part of the if then else should get you going to 2^32.
I didn&#39;t verify if it&#39;s implemented like that in mysql &#40;0xfe and above&#41;,
I just assume so.
if 6th byte &lt; 0xfc =&gt; 1byte notation
if 6th byte == 0xfc =&gt; 2byte notation
if 6th byte == 0xfd =&gt; 3byte notation
if 6th byte == 0xfe =&gt; 4byte notation ???
if 6th byte == 0xff =&gt; 5byte notation ???

sub _get_insert_id
{
    my $self = shift;
    my $packet = shift;
    my $index;
    if &#40;ord&#40;substr $packet, 6, 1&#41; &lt; 0xfc&#41; {
        $index = ord&#40;substr $packet, 6, 1&#41;
    } elsif &#40;ord&#40;substr $packet, 6, 1&#41; == 0xfc&#41; {       
        $index = unpack &#39;v&#39;, substr $packet, 7, 2;
    } elsif &#40;ord&#40;substr $packet, 6, 1&#41; == 0xfd&#41; {
        $index = unpack &#39;V&#39;, &#40;substr $packet, 7, 3&#41;.chr&#40;0&#41;;
    } else {
        $index = unpack &#39;V&#39;, substr $packet, 7, 4;
    }
    return $index;
}


$ ./mysqltest.pl
Inserted a record, last_index == 65534
$ ./mysqltest.pl
Inserted a record, last_index == 65535
$ ./mysqltest.pl
Inserted a record, last_index == 65536
$ ./mysqltest.pl
Inserted a record, last_index == 65537
$ ./mysqltest.pl
Inserted a record, last_index == 65538
$ ./mysqltest.pl
Inserted a record, last_index == 65539
$ ./mysqltest4.pl
$ ./mysqltest.pl
Inserted a record, last_index == 131070
$ ./mysqltest.pl
Inserted a record, last_index == 131071
$ ./mysqltest.pl
Inserted a record, last_index == 131072
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;30&nbsp;15:57:02&nbsp;2008</span>
    <span class="description">rosenfield.albert [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rosenfield.albert [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">According to the manual:

if &#40;server_version &lt;= 4.0&#41; insert_id = byte1
else if &#40;byte1 &lt;= 0xfa&#41; insert_id = byte1
else if &#40;byte1 == 0xfb&#41; error&#40;&#34;wrong value in this context&#34;&#41;
else if &#40;byte1 == 0xfc&#41; insert_id = byte1..byte2  # 2 bytes
else if &#40;byte1 == 0xfd&#41; insert_id = byte1..byte3  # 3 bytes
else if &#40;byte1 == 0xfe&#41; insert_id = byte1..byte8  # 8 bytes &#40;BIGINT&#41;
else error&#40;&#34;wrong value in this context&#34;&#41;
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
