<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #62169 for iCal-Parser: events timezone is ignored</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #62169 for iCal-Parser: events timezone is ignored</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/iCal-Parser/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/iCal-Parser/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/iCal-Parser/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/iCal-Parser/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/iCal-Parser">iCal-Parser CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">62169</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/iCal-Parser/Active/">iCal-Parser</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Vladimir.Marek [...] oracle.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-16534-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-16535-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.21    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;15&nbsp;10:56:10&nbsp;2010</span>
    <span class="description">Vladimir.Marek [...] oracle.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> events timezone is ignored</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 15 Oct 2010 16:55:21 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-iCal-Parser [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Vladimir Marek &lt;Vladimir.Marek [...] oracle.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Thanks for iCal::Parser!

After some investigation I have found out that timezone of an event is
being ignored while passing the date to DateTime::Format::ICal in the
convert_value function.

The event looks like this:

TYPE: DTEND   
$VAR1 = {
          &#39;value&#39; =&gt; &#39;20100903T093000&#39;,
          &#39;param&#39; =&gt; {
                       &#39;TZID&#39; =&gt; &#39;America/Los_Angeles&#39;
                     } 
        };

DateTime::Format::ICal can parse strings containing timezone in the
format &#34;TZID=America/Los_Angeles:20100903T093000&#34;.

I fixed the issue locally via this patch:

--- /tmp/vm156888/x/perl-5.12.2/lib/site_perl/5.12.2/iCal/Parser.pm     pá říj 15 16:45:29 2010
+++ /tmp/vm156888/x/perl-5.12.2/lib/site_perl/5.12.2/iCal/Parser.pm.good2       pá říj 15 16:42:12 2010
@@ -229,10 +229,13 @@
     my&#40;$self,$type,$hash&#41;=@_;
 
     my $value=$hash-&gt;{value};
+    my $this_tz=&#34;&#34;;
+    $this_tz=&#34;TZID=$hash-&gt;{param}{TZID}:&#34; if defined $hash-&gt;{param}{TZID};
     return $value unless $value; #should protect from invalid datetimes
 
     if &#40;$type eq &#39;TRIGGER&#39;&#41; {
         #can be date or duration!
+        $value=&#34;$this_tz$value&#34;;
         return $dfmt-&gt;parse_duration&#40;$value&#41; if $value =~/^[-+]?P/;
         return $dfmt-&gt;parse_datetime&#40;$value&#41;-&gt;set_time_zone&#40;$self-&gt;{tz}&#41;;
     }
@@ -241,7 +244,9 @@
         map { $h{$_}=$hash-&gt;{param}{$_} } keys %{ $hash-&gt;{param} };
         return \%h;
     }
-    return $dfmt-&gt;parse_duration&#40;$value&#41; if $TYPES{durations}{$type};
+    if &#40;$TYPES{durations}{$type}&#41; {
+        return $dfmt-&gt;parse_duration&#40;$this_tz.$value&#41;;
+    }
     return $value unless $TYPES{dates}{$type};
 
     #mozilla calendar bug: negative dates on todos!
@@ -255,10 +260,11 @@
         # so, handle the exception
         my $date;
         eval {
-            $date=$dfmt-&gt;parse_datetime&#40;$s&#41;-&gt;set_time_zone&#40;$self-&gt;{tz}&#41;;
+            $date=$dfmt-&gt;parse_datetime&#40;$this_tz.$s&#41;-&gt;set_time_zone&#40;$self-&gt;{tz}&#41;;
         };
         push @dates, $date and next unless $@;
         die $@ if $@ &#38;&#38; $type ne &#39;DTEND&#39;;
+        $value=&#34;$this_tz$value&#34;;
         push @dates,
             $dfmt-&gt;parse_datetime&#40;--$value&#41;-&gt;set_time_zone&#40;$self-&gt;{tz}&#41;;
     }


But I am not convinced that it&#39;s completely correct fix.

a&#41; ... if $value =~/^[-+]?P/;  will be broken if timezone is prepended
  to $value

b&#41; I do not uderstand what $dfmt-&gt;parse_datetime&#40;--$value&#41; does, resp.
the --$value ...

So with the hope that you&#39;ll be able to fix it properly I&#39;m sending what
I currently have :&#41;

Thank you
-- 
        Vlad
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;31&nbsp;13:11:09&nbsp;2013</span>
    <span class="description">https://www.google.com/accounts/o8/id?id=AItOawlsFr716ITHX5fFqEoy1RDF6vBODDmICWg -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bruce [...] momjian.us</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have successfully used this patch against version 1.16 with a Google calendar file.  Events with specified non-local TZID times were not being properly processed before this patch.  I suggest this patch be cleaned up and merged into an updated version.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;31&nbsp;13:11:09&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;31&nbsp;14:29:57&nbsp;2013</span>
    <span class="description">https://www.google.com/accounts/o8/id?id=AItOawlsFr716ITHX5fFqEoy1RDF6vBODDmICWg -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bruce [...] momjian.us</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Just to clarify, the TZID timezone value on this iCal line in version 1.16 is currently ignored:

       DTSTART;TZID=Asia/Karachi:20130520T180000

The patch fixes this.

While Google calendar does not use this format for single events &#40;those are mapped to local or UTC&#41;, it does output these TZID entries for recurring events.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;06&nbsp;19:00:49&nbsp;2013</span>
    <span class="description">Vladimir.Marek [...] oracle.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #62169] events timezone is ignored</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 7 Jun 2013 01:00:32 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;<span class="clickylink"><a target="new" rel="nofollow" href="https://www.google.com/accounts/o8/id?id=AItOawlsFr716ITHX5fFqEoy1RDF6vBODDmICWg">https://www.google.com/accounts/o8/id?id=AItOawlsFr716ITHX5fFqEoy1RDF6vBODDmICWg</a></span> via RT&#34; &lt;bug-iCal-Parser [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Vladimir Marek &lt;Vladimir.Marek [...] Oracle.COM&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have successfully used this patch against version 1.16 with a Google
&gt; calendar file.  Events with specified non-local TZID times were not
&gt; being properly processed before this patch.  I suggest this patch be
&gt; cleaned up and merged into an updated version.
</div>
When I filed the bug, I was not sure whether the patch I have is
correct. At this time I am sure it is not correct. I don&#39;t remember any
details today, but it seems that the recurring evens are wrong around
daylight savings time change. I think the problem is that DST does
change in a different moment in each country. My patch translates
the date into local time zone and then again computes the recurrence of
the event in local timezone.

But it has been some time and I might be all wrong ...

Still this is the best thing I have.

Cheers
-- 
        Vlad
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;15&nbsp;13:26:57&nbsp;2013</span>
    <span class="description">https://www.google.com/accounts/o8/id?id=AItOawlsFr716ITHX5fFqEoy1RDF6vBODDmICWg -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have given the idea more thought as well.  Your code might work because if the timezone changes in the origin country, like Pakistan, we are going to map the time entry to Pakistan time, then to local time.  I thought that might handle the DST issue.

One larger issue is that your patch only works because the TZID happens to be something Perl understands, e.g. America/New_York.  &#40;Google generates that format.&#41;  If it is one of those odd TZIDs, like created on Windows, I am afraid your patch is not going to work.  That is what those GMT+0500 stuff is that you had comments about in your patch.  I am wondering if your patch should only try its magic if it thinks the TZID is something Perl can understand, and fall back to trying to find a GMT offset number in the TZID.

Frankly, I am surprised at the poor iCal parsing support available in any language, and that Perl&#39;s isn&#39;t fully functional, e.g. doesn&#39;t understand VTIMEZONE.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;15&nbsp;13:54:10&nbsp;2013</span>
    <span class="description">https://www.google.com/accounts/o8/id?id=AItOawlsFr716ITHX5fFqEoy1RDF6vBODDmICWg -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Just to summarize, the TZID is supposed to map to the VTIMEZONE section at the top of the iCal file, which contains GMT offsets and DST information.  Because we don&#39;t have VTIMEZONE support, your patch punts the TZID for Perl to process.  That works fine, but only if the TZID is something Perl can understand.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;16&nbsp;11:41:36&nbsp;2013</span>
    <span class="description">https://www.google.com/accounts/o8/id?id=AItOawlsFr716ITHX5fFqEoy1RDF6vBODDmICWg -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here is an example of a TZID that contains a GMT offset:

DTSTART;TZID=&#34;&#40;GMT-05.00&#41; Eastern Time &#40;US &#38; Canada&#41;&#34;:20090205T100000

I don&#39;t know how many TZIDs have either a designation that Perl understands or a GMT offset, but we should support both if we can.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;16&nbsp;12:08:00&nbsp;2013</span>
    <span class="description">https://www.google.com/accounts/o8/id?id=AItOawlsFr716ITHX5fFqEoy1RDF6vBODDmICWg -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bruce [...] momjian.us</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here is an example of an entry that isn&#39;t understood by Perl, and doesn&#39;t have a GMT offset:

DTSTART;TZID=&#34;Chennai, Kolkata, Mumbai, New Delhi&#34;:20090220T200000

I think we have to give up on those until we support VTIMEZONE.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;05&nbsp;21:28:03&nbsp;2017</span>
    <span class="description">https://me.yahoo.com/lkjasdifjoijwe2323#348d4 -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bruce [...] momjian.us</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Jun 16 12:08:00 2013, <span class="clickylink"><a target="new" rel="nofollow" href="https://www.google.com/accounts/o8/id?id=AItOawlsFr716ITHX5fFqEoy1RDF6vBODDmICWg">https://www.google.com/accounts/o8/id?id=AItOawlsFr716ITHX5fFqEoy1RDF6vBODDmICWg</a></span> wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Here is an example of an entry that isn&#39;t understood by Perl, and
&gt; doesn&#39;t have a GMT offset:
&gt; 
&gt; DTSTART;TZID=&#34;Chennai, Kolkata, Mumbai, New Delhi&#34;:20090220T200000
&gt; 
&gt; I think we have to give up on those until we support VTIMEZONE.
</div>
I can confirm I still need this patch on version 1.21.  I can provide a reproduceable test case if desired.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;05&nbsp;21:34:47&nbsp;2017</span>
    <span class="description">https://me.yahoo.com/lkjasdifjoijwe2323#348d4 -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bruce [...] momjian.us</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Mar 05 21:28:03 2017, <span class="clickylink"><a target="new" rel="nofollow" href="https://me.yahoo.com/lkjasdifjoijwe2323#348d4">https://me.yahoo.com/lkjasdifjoijwe2323#348d4</a></span> wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I think we have to give up on those until we support VTIMEZONE.
</div>&gt; 
&gt; I can confirm I still need this patch on version 1.21.  I can provide
&gt; a reproduceable test case if desired.
</div>
Attached is an updated patch for version 1.21.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> TZID.1.21.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">62169 	events timezone is ignored

Hi,

Thanks for iCal::Parser!

After some investigation I have found out that timezone of an event is
being ignored while passing the date to DateTime::Format::ICal in the
convert_value function.

The event looks like this:

TYPE: DTEND   
$VAR1 = {
          &#39;value&#39; =&gt; &#39;20100903T093000&#39;,
          &#39;param&#39; =&gt; {
                       &#39;TZID&#39; =&gt; &#39;America/Los_Angeles&#39;
                     } 
        };

DateTime::Format::ICal can parse strings containing timezone in the
format &#34;TZID=America/Los_Angeles:20100903T093000&#34;.

I fixed the issue locally via this patch:

*** ./Parser.pm.orig	2016-12-08 05:53:40.000000000 -0500
--- ./Parser.pm	2017-03-05 18:35:18.818392189 -0500
***************
*** 232,237 ****
--- 232,239 ----
      my&#40;$self,$type,$hash&#41;=@_;
  
      my $value=$hash-&gt;{value};
+     my $this_tz=&#34;&#34;;
+     $this_tz=&#34;TZID=$hash-&gt;{param}{TZID}:&#34; if defined $hash-&gt;{param}{TZID};
      return $value unless $value; #should protect from invalid datetimes
  
      # Trim common types that do not allow whitespaces
***************
*** 240,245 ****
--- 242,248 ----
  
      if &#40;$type eq &#39;TRIGGER&#39;&#41; {
          #can be date or duration!
+         $value=&#34;$this_tz$value&#34;;
          return $dfmt-&gt;parse_duration&#40;$value&#41; if $value =~/^[-+]?P/;
          return $dfmt-&gt;parse_datetime&#40;$value&#41;-&gt;set_time_zone&#40;$self-&gt;{tz}&#41;;
      }
***************
*** 248,254 ****
          map { $h{$_}=$hash-&gt;{param}{$_} } keys %{ $hash-&gt;{param} };
          return \%h;
      }
!     return $dfmt-&gt;parse_duration&#40;$value&#41; if $TYPES{durations}{$type};
      return $value unless $TYPES{dates}{$type};
  
      #mozilla calendar bug: negative dates on todos!
--- 251,259 ----
          map { $h{$_}=$hash-&gt;{param}{$_} } keys %{ $hash-&gt;{param} };
          return \%h;
      }
!     if &#40;$TYPES{durations}{$type}&#41; {
!         return $dfmt-&gt;parse_duration&#40;$this_tz.$value&#41;;
!     }
      return $value unless $TYPES{dates}{$type};
  
      #mozilla calendar bug: negative dates on todos!
***************
*** 262,271 ****
          # so, handle the exception
          my $date;
          eval {
!             $date=$dfmt-&gt;parse_datetime&#40;$s&#41;-&gt;set_time_zone&#40;$self-&gt;{tz}&#41;;
          };
          push @dates, $date and next unless $@;
          die $@ if $@ &#38;&#38; $type ne &#39;DTEND&#39;;
          push @dates,
              $dfmt-&gt;parse_datetime&#40;--$value&#41;-&gt;set_time_zone&#40;$self-&gt;{tz}&#41;;
      }
--- 267,277 ----
          # so, handle the exception
          my $date;
          eval {
!             $date=$dfmt-&gt;parse_datetime&#40;$this_tz.$s&#41;-&gt;set_time_zone&#40;$self-&gt;{tz}&#41;;
          };
          push @dates, $date and next unless $@;
          die $@ if $@ &#38;&#38; $type ne &#39;DTEND&#39;;
+         $value=&#34;$this_tz$value&#34;;
          push @dates,
              $dfmt-&gt;parse_datetime&#40;--$value&#41;-&gt;set_time_zone&#40;$self-&gt;{tz}&#41;;
      }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;27&nbsp;13:46:15&nbsp;2019</span>
    <span class="description">bruce [...] momjian.us -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have developed a further refined patch against 1.21 that fixes another time zone bug.  If you have a recurring events, the events must be at the same time in the origin time zone, even if daylight saving time changes happen in the origin or local time zone.  This cumulative patch includes the above fixes, and a fix for this by moving the datetime back to the origin time zone before generating recurring entries.  It also improves the above patches by using a cleaner fix.

This patch still requires that ics file time zone specifications be recognized to the operating system.  I could use eval{} to avoid errors, but I would rather know when an entry is not properly time-zone adjusted.  It would be nice to have this in a released version of the module.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> TZID.1.21-current.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- lib/iCal/Parser.pm.orig	2019-11-12 11:40:17.083546619 -0500
+++ lib/iCal/Parser.pm	2019-11-27 13:31:42.131158257 -0500
@@ -102,6 +102,9 @@
 
     my %e=&#40;idref=&gt;$self-&gt;_cur_calid&#41;;
 
+    my $orig_tzid = $event-&gt;{properties}-&gt;{DTSTART}[0]-&gt;{param}{TZID};
+    my $shift_to_local_tz = 0;
+
     $self-&gt;map_properties&#40;\%e,$event&#41;;
     $self-&gt;add_objects&#40;$event,\%e&#41;;
 
@@ -130,6 +133,15 @@
         return;
     }
     if &#40;my $recur=delete $e{RRULE}&#41; {
+        if &#40;defined&#40;$orig_tzid&#41; &#38;&#38; $orig_tzid ne $self-&gt;{tz}-&gt;name&#41; {
+            # Use the original time zone so future events are the same
+            # time of day in that time zone, independent of daylight
+            # saving time changes in that time zone.  This might change
+            # the time of day in the local time zone.
+            $start-&gt;set_time_zone&#40;$orig_tzid&#41;;
+            # shift to local time zone later
+            $shift_to_local_tz = 1;
+        }
         $set=$dfmt-&gt;parse_recurrence&#40;recurrence=&gt;$recur, dtstart=&gt;$start,
                                      #cap infinite repeats
                                      until =&gt;$self-&gt;{span}-&gt;end&#41;;
@@ -161,20 +173,21 @@
     return if defined $set-&gt;count &#38;&#38; $set-&gt;count==0;
 
     if &#40;my $dates=delete $e{&#39;EXDATE&#39;}&#41; {
-        #mozilla/sunbird set exdate to T00..., so, get first start date
-        #and set times on exdates
-        my $d=$set-&gt;min;
-        my $exset=DateTime::Set-&gt;from_datetimes
-            &#40;dates=&gt;[
-                map {$_-&gt;set&#40;hour=&gt;$d-&gt;hour,minute=&gt;$d-&gt;minute,
-                             second=&gt;$d-&gt;second&#41;
-                 } @$dates]&#41;;
+        if &#40;$shift_to_local_tz&#41; {
+             for my $dt &#40;@$dates&#41; {
+                 $dt-&gt;set_time_zone&#40;$orig_tzid&#41;;
+             }
+        }
         $set=$set
             -&gt;complement&#40;DateTime::Set-&gt;from_datetimes&#40;dates=&gt;$dates&#41;&#41;;
     }
     $set=$set-&gt;intersection&#40;$self-&gt;{span}&#41; if $self-&gt;{span};
     my $iter=$set-&gt;iterator;
     while &#40;my $dt=$iter-&gt;next&#41; {
+        # convert &#34;floating&#34; time zone to original time zone, then local time zone
+        $dt-&gt;set_time_zone&#40;$orig_tzid&#41;-&gt;set_time_zone&#40;$self-&gt;{tz}&#41;
+            if &#40;$shift_to_local_tz&#41;;
+
         #bug found by D. Sweet. Fix alarms on entries
         #other than first
         my $new_event={%e,DTSTART=&gt;$dt,DTEND=&gt;$dt+$duration};
@@ -232,6 +245,7 @@
     my&#40;$self,$type,$hash&#41;=@_;
 
     my $value=$hash-&gt;{value};
+    my $entry_tz = defined&#40;$hash-&gt;{param}{TZID}&#41; ? $hash-&gt;{param}{TZID} : $self-&gt;{tz};
     return $value unless $value; #should protect from invalid datetimes
 
     # Trim common types that do not allow whitespaces
@@ -241,7 +255,7 @@
     if &#40;$type eq &#39;TRIGGER&#39;&#41; {
         #can be date or duration!
         return $dfmt-&gt;parse_duration&#40;$value&#41; if $value =~/^[-+]?P/;
-        return $dfmt-&gt;parse_datetime&#40;$value&#41;-&gt;set_time_zone&#40;$self-&gt;{tz}&#41;;
+        return $dfmt-&gt;parse_datetime&#40;$value&#41;-&gt;set_time_zone&#40;$entry_tz&#41;-&gt;set_time_zone&#40;$self-&gt;{tz}&#41;;
     }
     if &#40;$TYPES{hash}{$type}&#41; {
         my %h=&#40;value=&gt;$value&#41;;
@@ -260,14 +274,11 @@
         # I have a sample calendar &#34;Employer Tax calendar&#34;
         # which has an allday event ending on 20040332!
         # so, handle the exception
-        my $date;
-        eval {
-            $date=$dfmt-&gt;parse_datetime&#40;$s&#41;-&gt;set_time_zone&#40;$self-&gt;{tz}&#41;;
-        };
+        my $date=$dfmt-&gt;parse_datetime&#40;$s&#41;-&gt;set_time_zone&#40;$entry_tz&#41;-&gt;set_time_zone&#40;$self-&gt;{tz}&#41;;
         push @dates, $date and next unless $@;
         die $@ if $@ &#38;&#38; $type ne &#39;DTEND&#39;;
         push @dates,
-            $dfmt-&gt;parse_datetime&#40;--$value&#41;-&gt;set_time_zone&#40;$self-&gt;{tz}&#41;;
+            $dfmt-&gt;parse_datetime&#40;--$value&#41;-&gt;set_time_zone&#40;$entry_tz&#41;-&gt;set_time_zone&#40;$self-&gt;{tz}&#41;;
     }
     return @dates;
 }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;27&nbsp;13:46:16&nbsp;2019</span>
    <span class="description">bruce [...] momjian.us -  Fixed in 1.21 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
