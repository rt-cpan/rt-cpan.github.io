<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #34769 for URI: Escape.pm encodes to RFC 2396/2732 , but 3986 is most current</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #34769 for URI: Escape.pm encodes to RFC 2396/2732 , but 3986 is most current</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/URI/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/URI/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/URI/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/URI/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/URI">URI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">34769</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/URI/Active/">URI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cpan [...] 2xlp.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-34672-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.36    </td>
  </tr>
  <tr id="CF-34673-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;08&nbsp;12:40:00&nbsp;2008</span>
    <span class="description">cpan [...] 2xlp.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Escape.pm encodes to RFC 2396/2732 , but 3986 is most current</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">2732:
        unreserved
                [A-Za-z0-9\-\._~!*&#39;&#40;&#41;]
        reserved
                ;/?:@&#38;=+$,[]

3986:
        unreserved:
                [A-Za-z0-9\-\._~]

        reserved:
                gen-delims
                        :/?#[]@
                sub-delims
                        !$&#38;&#39;&#40;&#41;*+,;=

the fix would be to make *&#39;&#40;&#41; reserved

since 2732 is still popular, i would suggest using either a package/global var or a keyword to 
let people choose a default behavior/override... but conform to 3986 otherwise
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;16&nbsp;20:43:55&nbsp;2009</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">URI::Find needs this in order to round trip URLs with Unicode in them
such as http://➡.ws/䯡

Even better would be a way to turn escaping off entirely or a method to
get an unescaped version.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;16&nbsp;20:43:56&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;17&nbsp;01:55:13&nbsp;2009</span>
    <span class="description">GAAS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Mar 16 20:43:55 2009, MSCHWERN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; URI::Find needs this in order to round trip URLs with Unicode in them
&gt; such as http://➡.ws/䯡
</div>
How does making *&#39;&#40;&#41; reserved affect this Unicode stuff?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Even better would be a way to turn escaping off entirely or a method to
&gt; get an unescaped version.
</div>
Please expand.  I don&#39;t understand what you are suggesting here.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;05&nbsp;22:01:20&nbsp;2009</span>
    <span class="description">ddascalescu+perl [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ddascalescu+perl [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Mar 17 01:55:13 2009, GAAS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Mar 16 20:43:55 2009, MSCHWERN wrote:
<div class="message-stanza open">&gt; &gt; URI::Find needs this in order to round trip URLs with Unicode in them
&gt; &gt; such as http://➡.ws/䯡
</div>&gt; 
&gt; How does making *&#39;&#40;&#41; reserved affect this Unicode stuff?
&gt; 
<div class="message-stanza open">&gt; &gt; Even better would be a way to turn escaping off entirely or a method to
&gt; &gt; get an unescaped version.
</div>&gt; 
&gt; Please expand.  I don&#39;t understand what you are suggesting here.
</div>
Any updates on this?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;28&nbsp;05:43:12&nbsp;2010</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Mar 17 01:55:13 2009, GAAS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Mar 16 20:43:55 2009, MSCHWERN wrote:
<div class="message-stanza open">&gt; &gt; URI::Find needs this in order to round trip URLs with Unicode in them
&gt; &gt; such as http://➡.ws/䯡
</div>&gt; 
&gt; How does making *&#39;&#40;&#41; reserved affect this Unicode stuff?
&gt; 
<div class="message-stanza open">&gt; &gt; Even better would be a way to turn escaping off entirely or a method to
&gt; &gt; get an unescaped version.
</div>&gt; 
&gt; Please expand.  I don&#39;t understand what you are suggesting here.
</div>
IIRC I was referring to being able to control the set of escaped
characters.  In this case, turning them all off so I could get URI to
stop escaping more than I&#39;d like.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;28&nbsp;11:13:33&nbsp;2010</span>
    <span class="description">IKEGAMI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is a dup of RT#21640
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;28&nbsp;16:56:45&nbsp;2010</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The attached patches update URI::Escape to RFC 3986.

The first patch rewrites t/escape.t to use Test::More.  This was just
some housecleaning to do before updating the test.

The second patch updates the docs to refer to RFC 3986 and updates the
default regex used to RFC 3986 standard.

You&#39;ll note I left in the 2732 regex.  Its not used right now, but I can
imagine a scenario where URI::Escape offers the user which escape to
use.  A flexible set of options can be added to uri_escape&#40;&#41; in place of
the second argument.  For example...

    uri_escape&#40; $uri, { rfc =&gt; 2732 } &#41;;

Would be equivalent to:

    uri_escape&#40; $uri, &#34;^A-Za-z0-9\-_.!~*&#39;&#40;&#41;&#34; &#41;;

Except the user won&#39;t get it wrong.

The current manual escape syntax can be deprecated and replaced with:

    uri_escape&#40; $uri, { escape =&gt; qr/[^...]/ } &#41;;

Or even...

    uri_escape&#40; $uri, { escape =&gt; [&#34;A&#34;..&#34;Z&#34;, &#34;a&#34;..&#34;z&#34;, ...] } &#41;;

uri_escape&#40;&#41; would check if the second argument is a hash ref to
determine how to interpret it.

I can&#39;t see a use case for users preserving RFC 2732 semantics except
maybe to support fiddly old tests that they don&#39;t want to change, so I&#39;m
not going to bother patching it.  Its worth noting that the URI::Escape
patch did not effect the URI tests at all.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Rewrite-the-URI-Escape-tests-with-Test-More.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From c17e39a26bb4a2a7ea715ca75470e85111808d54 Mon Sep 17 00:00:00 2001
From: Michael G. Schwern &lt;schwern@pobox.com&gt;
Date: Thu, 28 Jan 2010 13:41:57 -0800
Subject: [PATCH 1/2] Rewrite the URI::Escape tests with Test::More

---
 t/escape.t |   43 +++++++++++++++++--------------------------
 1 files changed, 17 insertions&#40;+&#41;, 26 deletions&#40;-&#41;

diff --git a/t/escape.t b/t/escape.t
index daebd9d..46da877 100644
--- a/t/escape.t
+++ b/t/escape.t
@@ -1,48 +1,39 @@
 #!perl -w
 
-print &#34;1..9\n&#34;;
+use strict;
+use warnings;
+
+use Test::More tests =&gt; 10;
 
 use URI::Escape;
 
-print &#34;not &#34; unless uri_escape&#40;&#34;|abcå&#34;&#41; eq &#34;%7Cabc%E5&#34;;
-print &#34;ok 1\n&#34;;
+is uri_escape&#40;&#34;|abcå&#34;&#41;, &#34;%7Cabc%E5&#34;;
 
-print &#34;not &#34; unless uri_escape&#40;&#34;abc&#34;, &#34;b-d&#34;&#41; eq &#34;a%62%63&#34;;
-print &#34;ok 2\n&#34;;
+is uri_escape&#40;&#34;abc&#34;, &#34;b-d&#34;&#41;, &#34;a%62%63&#34;;
 
-print &#34;not &#34; if defined&#40;uri_escape&#40;undef&#41;&#41;;
-print &#34;ok 3\n&#34;;
+is uri_escape&#40;undef&#41;, undef;
 
-print &#34;not &#34; unless uri_unescape&#40;&#34;%7Cabc%e5&#34;&#41; eq &#34;|abcå&#34;;
-print &#34;ok 4\n&#34;;
+is uri_unescape&#40;&#34;%7Cabc%e5&#34;&#41;, &#34;|abcå&#34;;
 
-print &#34;not &#34; unless join&#40;&#34;:&#34;, uri_unescape&#40;&#34;%40A%42&#34;, &#34;CDE&#34;, &#34;F%47H&#34;&#41;&#41; eq
-                    &#39;@AB:CDE:FGH&#39;;
-print &#34;ok 5\n&#34;;
+is_deeply [uri_unescape&#40;&#34;%40A%42&#34;, &#34;CDE&#34;, &#34;F%47H&#34;&#41;], [qw&#40;@AB CDE FGH&#41;];
 
 
 use URI::Escape qw&#40;%escapes&#41;;
 
-print &#34;not&#34; unless $escapes{&#34;%&#34;} eq &#34;%25&#34;;
-print &#34;ok 6\n&#34;;
+is $escapes{&#34;%&#34;}, &#34;%25&#34;;
 
 
 use URI::Escape qw&#40;uri_escape_utf8&#41;;
 
-print &#34;not &#34; unless uri_escape_utf8&#40;&#34;|abcå&#34;&#41; eq &#34;%7Cabc%C3%A5&#34;;
-print &#34;ok 7\n&#34;;
+is uri_escape_utf8&#40;&#34;|abcå&#34;&#41;, &#34;%7Cabc%C3%A5&#34;;
 
-if &#40;$] &lt; 5.008&#41; {
-    print &#34;ok 8  # skip perl-5.8 required\n&#34;;
-    print &#34;ok 9  # skip perl-5.8 required\n&#34;;
-}
-else {
-    eval { print uri_escape&#40;&#34;abc&#34; . chr&#40;300&#41;&#41; };
-    print &#34;not &#34; unless $@ &#38;&#38; $@ =~ /^Can\&#39;t escape \\x{012C}, try uri_escape_utf8\&#40;\&#41; instead/;
-    print &#34;ok 8\n&#34;;
+SKIP: {
+    skip &#34;Perl 5.8.0 or higher required&#34;, 3 if $] &lt; 5.008;
+
+    ok !eval { print uri_escape&#40;&#34;abc&#34; . chr&#40;300&#41;&#41;; 1 };
+    like $@, qr/^Can\&#39;t escape \\x{012C}, try uri_escape_utf8\&#40;\&#41; instead/;
 
-    print &#34;not &#34; unless uri_escape_utf8&#40;chr&#40;0xFFF&#41;&#41; eq &#34;%E0%BF%BF&#34;;
-    print &#34;ok 9\n&#34;;
+    is uri_escape_utf8&#40;chr&#40;0xFFF&#41;&#41;, &#34;%E0%BF%BF&#34;;
 }
 
 
-- 
1.6.6.1

</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0002-Update-URI-Escape-for-RFC-3986.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 24f4d462614e303bccb64675bfefe01fbd9ffc40 Mon Sep 17 00:00:00 2001
From: Michael G. Schwern &lt;schwern@pobox.com&gt;
Date: Thu, 28 Jan 2010 13:45:50 -0800
Subject: [PATCH 2/2] Update URI::Escape for RFC 3986

---
 URI/Escape.pm |   43 ++++++++++++++++++++++++-------------------
 t/escape.t    |    7 ++++---
 2 files changed, 28 insertions&#40;+&#41;, 22 deletions&#40;-&#41;

diff --git a/URI/Escape.pm b/URI/Escape.pm
index c2da23b..4543212 100644
--- a/URI/Escape.pm
+++ b/URI/Escape.pm
@@ -15,26 +15,27 @@ URI::Escape - Escape and unescape unsafe characters
 =head1 DESCRIPTION
 
 This module provides functions to escape and unescape URI strings as
-defined by RFC 2396 &#40;and updated by RFC 2732&#41;.
-A URI consists of a restricted set of characters,
-denoted as C&lt;uric&gt; in RFC 2396.  The restricted set of characters
-consists of digits, letters, and a few graphic symbols chosen from
-those common to most of the character encodings and input facilities
-available to Internet users:
+defined by RFC 3986.
 
-  &#34;A&#34; .. &#34;Z&#34;, &#34;a&#34; .. &#34;z&#34;, &#34;0&#34; .. &#34;9&#34;,
-  &#34;;&#34;, &#34;/&#34;, &#34;?&#34;, &#34;:&#34;, &#34;@&#34;, &#34;&#38;&#34;, &#34;=&#34;, &#34;+&#34;, &#34;$&#34;, &#34;,&#34;, &#34;[&#34;, &#34;]&#34;,   # reserved
-  &#34;-&#34;, &#34;_&#34;, &#34;.&#34;, &#34;!&#34;, &#34;~&#34;, &#34;*&#34;, &#34;&#39;&#34;, &#34;&#40;&#34;, &#34;&#41;&#34;
+A URI consists of a restricted set of characters.  The restricted set
+of characters consists of digits, letters, and a few graphic symbols
+chosen from those common to most of the character encodings and input
+facilities available to Internet users.  They are made up of the
+&#34;unreserved&#34; and &#34;reserved&#34; character sets as defined in RFC 3986.
+
+   unreserved    = ALPHA / DIGIT / &#34;-&#34; / &#34;.&#34; / &#34;_&#34; / &#34;~&#34;
+   reserved      = &#34;:&#34; / &#34;/&#34; / &#34;?&#34; / &#34;#&#34; / &#34;[&#34; / &#34;]&#34; / &#34;@&#34;
+                   &#34;!&#34; / &#34;$&#34; / &#34;&#38;&#34; / &#34;&#39;&#34; / &#34;&#40;&#34; / &#34;&#41;&#34;
+                 / &#34;*&#34; / &#34;+&#34; / &#34;,&#34; / &#34;;&#34; / &#34;=&#34;
 
 In addition, any byte &#40;octet&#41; can be represented in a URI by an escape
 sequence: a triplet consisting of the character &#34;%&#34; followed by two
 hexadecimal digits.  A byte can also be represented directly by a
-character, using the US-ASCII character for that octet &#40;iff the
-character is part of C&lt;uric&gt;&#41;.
+character, using the US-ASCII character for that octet.
 
-Some of the C&lt;uric&gt; characters are I&lt;reserved&gt; for use as delimiters
-or as part of certain URI components.  These must be escaped if they are
-to be treated as ordinary data.  Read RFC 2396 for further details.
+Some of the characters are I&lt;reserved&gt; for use as delimiters or as
+part of certain URI components.  These must be escaped if they are to
+be treated as ordinary data.  Read RFC 3986 for further details.
 
 The functions provided &#40;and exported by default&#41; from this module are:
 
@@ -61,10 +62,10 @@ character class &#40;between [ ]&#41;.  E.g.:
   &#34;^A-Za-z&#34;                     # everything not a letter
 
 The default set of characters to be escaped is all those which are
-I&lt;not&gt; part of the C&lt;uric&gt; character class shown above as well as the
-reserved characters.  I.e. the default is:
+I&lt;not&gt; part of the C&lt;unreserved&gt; character class shown above as well
+as the reserved characters.  I.e. the default is:
 
-  &#34;^A-Za-z0-9\-_.!~*&#39;&#40;&#41;&#34;
+    &#34;^A-Za-z0-9\-\._~&#34;
 
 =item uri_escape_utf8&#40; $string &#41;
 
@@ -156,6 +157,11 @@ for &#40;0..255&#41; {
 
 my %subst;  # compiled patternes
 
+my %Unsafe = &#40;
+    RFC2732 =&gt; qr/[^A-Za-z0-9\-_.!~*&#39;&#40;&#41;]/,
+    RFC3986 =&gt; qr/[^A-Za-z0-9\-\._~&#34;]/,
+&#41;;
+
 sub uri_escape
 {
     my&#40;$text, $patn&#41; = @_;
@@ -169,8 +175,7 @@ sub uri_escape
 	}
 	&#38;{$subst{$patn}}&#40;$text&#41;;
     } else {
-	# Default unsafe characters.  RFC 2732 ^&#40;uric - reserved&#41;
-	$text =~ s/&#40;[^A-Za-z0-9\-_.!~*&#39;&#40;&#41;]&#41;/$escapes{$1} || _fail_hi&#40;$1&#41;/ge;
+	$text =~ s/&#40;$Unsafe{RFC3986}&#41;/$escapes{$1} || _fail_hi&#40;$1&#41;/ge;
     }
     $text;
 }
diff --git a/t/escape.t b/t/escape.t
index 46da877..7867160 100644
--- a/t/escape.t
+++ b/t/escape.t
@@ -3,7 +3,7 @@
 use strict;
 use warnings;
 
-use Test::More tests =&gt; 10;
+use Test::More tests =&gt; 11;
 
 use URI::Escape;
 
@@ -11,6 +11,9 @@ is uri_escape&#40;&#34;|abc
 
 is uri_escape&#40;&#34;abc&#34;, &#34;b-d&#34;&#41;, &#34;a%62%63&#34;;
 
+# New escapes in RFC 3986
+is uri_escape&#40;&#34;~*&#39;&#40;&#41;&#34;&#41;, &#34;~%2A%27%28%29&#34;;
+
 is uri_escape&#40;undef&#41;, undef;
 
 is uri_unescape&#40;&#34;%7Cabc%e5&#34;&#41;, &#34;|abcå&#34;;
@@ -35,5 +38,3 @@ SKIP: {
 
     is uri_escape_utf8&#40;chr&#40;0xFFF&#41;&#41;, &#34;%E0%BF%BF&#34;;
 }
-
-
-- 
1.6.6.1

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;29&nbsp;18:01:56&nbsp;2010</span>
    <span class="description">GAAS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks Michael!  Your patches has been applied as:

  a3a2e2c Update URI::Escape for RFC 3986
  cc44daf Rewrite the URI::Escape tests with Test::More
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;29&nbsp;18:01:57&nbsp;2010</span>
    <span class="description">GAAS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
