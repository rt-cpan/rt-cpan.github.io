<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #93887 for Math-BigInt: Math::BigInt-&gt;new&#40;&#41; wrongly converts large floats</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #93887 for Math-BigInt: Math::BigInt-&gt;new&#40;&#41; wrongly converts large floats</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Math-BigInt/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Math-BigInt/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Math-BigInt/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Math-BigInt/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Math-BigInt">Math-BigInt CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">93887</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Math-BigInt/Active/">Math-BigInt</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bitcard [...] volkerschatz.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-20500-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-20501-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;15&nbsp;11:39:43&nbsp;2014</span>
    <span class="description">bitcard [...] volkerschatz.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Math::BigInt-&gt;new&#40;&#41; wrongly converts large floats</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">A conversion of large integral floating-point numbers into BigInts can lose
significant digits.  Test case: 504403158265495552.0 == 7 * 2**56, which is
exactly representable as a float/double.

 $ perl -MMath::BigInt -e &#39;print Math::BigInt-&gt;new&#40;504403158265495552.0&#41;-&gt;bstr&#40;&#41;, &#34;\n&#34;;&#39;
504403158265496000

A test case that reqires more than 64 integer bits is 7 * 2**66 = 516508834063867445248.0.

The cause is that the _split function in Math::BigInt treats its argument as a string and hereby triggers Perl&#39;s automatic conversion which does not output enough digits for large integers.  A fix is to explicitly convert via sprintf&#40;&#34;%f&#34;,..&#41;, which retains all digits before the decimal point.  Doing this for non-floats is superfluous and possibly harmful, so we test the accuracy of a roundtrip with the automatic conversion first:

@@ -3048,6 +3048,8 @@
   # invalid input.
   my $x = shift;

+  $x= sprintf&#40;&#34;%f&#34;, $x&#41; unless &#34;$x&#34; == $x;    # ensure enough digits from float
+
   # strip white space at front, also extraneous leading zeros
   $x =~ s/^\s*&#40;[-]?&#41;0*&#40;[0-9]&#41;/$1$2/g;   # will not strip &#39;  .2&#39;
   $x =~ s/^\s+//;                       # but this will


Line numbers refer to version 1.9991, which my distribution ships but CPAN does not yet &#40;?!&#41;.

This issue was first reported to the perlbug list, as [perl #121136].
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;16&nbsp;10:04:37&nbsp;2014</span>
    <span class="description">peter.john.acklam [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Good catch! Alas, your suggested fix isn&#39;t good enough. The sprintf&#40;&#34;%f&#34;, ...&#41; conversion would also be applied to input like 0.00000005044031582654955529, since it&#39;s stringified version different: it&#39;s &#34;5.04403158265496e-08&#34;. Now, sprintf&#40;&#34;%f&#34;, 0.00000005044031582654955529&#41; returns &#34;0.000000&#34;, which Math::BigInt returns as zero. However, the current behaviour is to return NaN when the input is something other than an integer. This behaviour is likely to change, so that the semantics are the same as those of core Perl, but until then, we have to use a better fix. We can&#39;t introduce inconsistent behaviour.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;16&nbsp;10:04:37&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;16&nbsp;16:59:23&nbsp;2014</span>
    <span class="description">foss [...] volkerschatz.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #93887] Math::BigInt-&gt;new&#40;&#41; wrongly converts large floats</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 16 Apr 2014 22:59:06 +0200 &#40;CEST&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Peter John Acklam via RT &lt;bug-Math-BigInt [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Volker Schatz &lt;foss [...] volkerschatz.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Thanks for reminding me of fractional input, I had not thought of that. 
Playing around with non-integers, I found two more test cases that are 
broken in 1.9991:

4503599627370495.5 = 2**52 - 0.5, the largest non-integer representable as a 
double.  This needs to be sprintf&#39;ed because autoconversion discards some 
digits, including the fractional digit that triggers the NaN.

This and all values &lt;1 and &gt;0 are fixed by replacing the line inserted in my 
patch by:

$x= sprintf&#40;&#34;%f&#34;, $x&#41; if &#34;$x&#34; != $x &#38;&#38; $x &gt; 1;


The second, more problematic test case I dug up is 1+DBL_EPSILON = 
1.00000000000000022.  This is handled correctly in _split&#40;&#41; if one raises the 
precision of the sprintf:

$x= sprintf&#40;&#34;%.17f&#34;, $x&#41; if &#34;$x&#34; != $x &#38;&#38; $x &gt; 1;

17 = DBL_DECIMAL_DIG, the number of digits sufficient for a 
double-&gt;string-&gt;double roundtrip conversion.  However, in this case split&#40;&#41; is 
never reached because of a &#34;shortcut&#34; in new&#40;&#41; that also applies a regex to the 
autoconverted value.  Applying the same roundtrip conversion check as in 
_split&#40;&#41; should fix this too:

@@ -534,7 +534,7 @@
    my $self = bless {}, $class;

    # shortcut for &#34;normal&#34; numbers
-  if &#40;&#40;!ref $wanted&#41; &#38;&#38; &#40;$wanted =~ /^&#40;[+-]?&#41;[1-9][0-9]*\z/&#41;&#41;
+  if &#40;&#40;!ref $wanted&#41; &#38;&#38; &#34;$wanted&#34; == $wanted &#38;&#38; &#40;$wanted =~ /^&#40;[+-]?&#41;[1-9][0-9]*\z/&#41;&#41;
      {
      $self-&gt;{sign} = $1 || &#39;+&#39;;

@@ -3048,6 +3048,8 @@
    # invalid input.
    my $x = shift;

+  $x= sprintf&#40;&#34;%.17f&#34;, $x&#41; if &#34;$x&#34; != $x &#38;&#38; $x &gt; 1;    # ensure enough digits from float
+
    # strip white space at front, also extraneous leading zeros
    $x =~ s/^\s*&#40;[-]?&#41;0*&#40;[0-9]&#41;/$1$2/g;   # will not strip &#39;  .2&#39;
    $x =~ s/^\s+//;                       # but this will



This is quite an effort to make for the NaN behaviour, considering it is on the 
way out, and has never worked for large numbers like 2**52 - 0.5.  I hope you
remember to revert back to the version from my last post when the time comes, 
so code complexity is kept down a little.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
