<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #103805 for File-BaseDir: t/03_userdirs.t does not restore ~/.config/user-dirs.dirs</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #103805 for File-BaseDir: t/03_userdirs.t does not restore ~/.config/user-dirs.dirs</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/File-BaseDir/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/File-BaseDir/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/File-BaseDir/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/File-BaseDir/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/File-BaseDir">File-BaseDir CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">103805</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/File-BaseDir/Active/">File-BaseDir</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">kimryan [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
SREZIC [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-12666-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.06    </td>
  </tr>
  <tr id="CF-12667-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.07    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;18&nbsp;05:58:54&nbsp;2015</span>
    <span class="description">SREZIC [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> t/03_userdirs.t does not restore ~/.config/user-dirs.dirs</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The END block in t/03_userdirs.t is supposed to restore the old contents of ~/.config/user-dirs.dirs. Unfortunately $xdg_user_dir_installed is never set to true, so the END block never runs.

Moreover, changing this configuration file for tests is problematic if users test the module with multiple perls in parallel --- so race conditions are possible, and this might be the case in this fail report: <span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/cpan/report/cec91274-dc00-11e4-95a6-11378e88e62e">http://www.cpantesters.org/cpan/report/cec91274-dc00-11e4-95a6-11378e88e62e</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;18&nbsp;22:04:22&nbsp;2015</span>
    <span class="description">kimryan [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;18&nbsp;22:12:20&nbsp;2015</span>
    <span class="description">kimryan [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for pointing out this bug. I think this is the change required to get it working.

my $xdg_user_dir_installed = 0;
if &#40;which &#39;xdg-user-dir&#39;&#41; {
    plan tests =&gt; 8;
    $xdg_user_dir_installed = 0;
} else {
    plan skip_all =&gt; &#39;&#34;xdg-user-dir&#34; executable not found. Install package &#34;xdg-user-dirs&#34;.&#39;;
    $xdg_user_dir_installed = 1;
    
}

Agree it is not good practice to be altering config file contents during test phase. I adopted this module as it had been abandoned, and applied several old patches.  This includes the 03_userdirs.t test. It relies on running the xdg-user-dir binary, which doesn&#39;t seem like a good thing to put into a CPAN test suite. But I don&#39;t really have the time or knowledge to try and unravel all this code. So if you think above fix is enough, I can apply that.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;18&nbsp;22:12:20&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;18&nbsp;22:32:57&nbsp;2015</span>
    <span class="description">kimryan [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry, code should be

my $xdg_user_dir_installed = 0;
if &#40;which &#39;xdg-user-dir&#39;&#41; {
    plan tests =&gt; 8;
    $xdg_user_dir_installed = 1;
} else {
    plan skip_all =&gt; &#39;&#34;xdg-user-dir&#34; executable not found. Install package &#34;xdg-user-dirs&#34;.&#39;;    
    
}

On Sat Apr 18 22:12:20 2015, KIMRYAN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks for pointing out this bug. I think this is the change required
&gt; to get it working.
&gt; 
&gt; my $xdg_user_dir_installed = 0;
&gt; if &#40;which &#39;xdg-user-dir&#39;&#41; {
&gt;     plan tests =&gt; 8;
&gt;     $xdg_user_dir_installed = 0;
&gt; } else {
&gt;     plan skip_all =&gt; &#39;&#34;xdg-user-dir&#34; executable not found. Install
&gt; package &#34;xdg-user-dirs&#34;.&#39;;
&gt;     $xdg_user_dir_installed = 1;
&gt; 
&gt; }
&gt; 
&gt; Agree it is not good practice to be altering config file contents
&gt; during test phase. I adopted this module as it had been abandoned, and
&gt; applied several old patches.  This includes the 03_userdirs.t test. It
&gt; relies on running the xdg-user-dir binary, which doesn&#39;t seem like a
&gt; good thing to put into a CPAN test suite. But I don&#39;t really have the
&gt; time or knowledge to try and unravel all this code. So if you think
&gt; above fix is enough, I can apply that.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;19&nbsp;08:52:34&nbsp;2015</span>
    <span class="description">SREZIC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Still there&#39;s the possibility of race conditions &#40;multiple test runs happen at the same time, e.g. for multiple perls&#41; or the possibility of some crash between creation of the test contents and running the END{} block.

One possibility would be to fake the $HOME environment variable and use an exclusive version of the config file. See the attached patch.

The original test could maybe still be used as an author or travis-ci only test.

On 2015-04-18 22:32:57, KIMRYAN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sorry, code should be
&gt; 
&gt; my $xdg_user_dir_installed = 0;
&gt; if &#40;which &#39;xdg-user-dir&#39;&#41; {
&gt;     plan tests =&gt; 8;
&gt;     $xdg_user_dir_installed = 1;
&gt; } else {
&gt;         plan skip_all =&gt; &#39;&#34;xdg-user-dir&#34; executable not found. Install
&gt; package &#34;xdg-user-dirs&#34;.&#39;;
&gt; 
&gt; }
&gt; 
&gt; On Sat Apr 18 22:12:20 2015, KIMRYAN wrote:
<div class="message-stanza open">&gt; &gt; Thanks for pointing out this bug. I think this is the change required
&gt; &gt; to get it working.
&gt; &gt;
&gt; &gt; my $xdg_user_dir_installed = 0;
&gt; &gt; if &#40;which &#39;xdg-user-dir&#39;&#41; {
&gt; &gt;     plan tests =&gt; 8;
&gt; &gt;     $xdg_user_dir_installed = 0;
&gt; &gt; } else {
&gt; &gt;     plan skip_all =&gt; &#39;&#34;xdg-user-dir&#34; executable not found. Install
&gt; &gt; package &#34;xdg-user-dirs&#34;.&#39;;
&gt; &gt;     $xdg_user_dir_installed = 1;
&gt; &gt;
&gt; &gt; }
&gt; &gt;
&gt; &gt; Agree it is not good practice to be altering config file contents
&gt; &gt; during test phase. I adopted this module as it had been abandoned,
&gt; &gt; and
&gt; &gt; applied several old patches.  This includes the 03_userdirs.t test.
&gt; &gt; It
&gt; &gt; relies on running the xdg-user-dir binary, which doesn&#39;t seem like a
&gt; &gt; good thing to put into a CPAN test suite. But I don&#39;t really have the
&gt; &gt; time or knowledge to try and unravel all this code. So if you think
&gt; &gt; above fix is enough, I can apply that.
</div></div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> File-BaseDir-0.06-RT103805.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git i/t/03_userdirs.t w/t/03_userdirs.t
index d28f344..0302c7b 100644
--- i/t/03_userdirs.t
+++ w/t/03_userdirs.t
@@ -6,6 +6,7 @@ use File::UserDirs qw&#40;:all&#41;;
 use File::BaseDir qw&#40;config_home&#41;;
 use File::Spec::Functions qw&#40;catfile&#41;;
 use File::Which qw&#40;which&#41;;
+use File::Temp qw&#40;tempdir&#41;;
 
 my $xdg_user_dir_installed = 0;
 if &#40;which &#39;xdg-user-dir&#39;&#41; {
@@ -16,10 +17,10 @@ if &#40;which &#39;xdg-user-dir&#39;&#41; {
     
 }
 
-my $udd = config_home&#40;&#39;user-dirs.dirs&#39;&#41;;
-if &#40;-e $udd&#41; {
-    rename $udd, &#34;$udd~&#34; or die &#34;could not make backup of $udd: $!&#34;;
-}
+my $temphomedir = tempdir&#40;CLEANUP =&gt; 1&#41;;
+local $ENV{HOME} = $temphomedir;
+mkdir &#34;$temphomedir/.config&#34;;
+my $udd = &#34;$temphomedir/.config/user-dirs.dirs&#34;;
 
 open my $fh, &#39;&gt;&#39;, $udd or die &#34;could not open $udd for writing: $!&#34;;
 print $fh &lt;&lt;&#39;UDD&#39;;
@@ -43,12 +44,3 @@ is xdg_publicshare_dir, catfile&#40;$ENV{HOME}, &#39;public_html&#39;&#41;;
 is xdg_templates_dir,   catfile&#40;$ENV{HOME}, &#39;Files/Document templates&#39;&#41;;
 is xdg_videos_dir,      catfile&#40;$ENV{HOME}, &#39;Files/Video&#39;&#41;;
 
-END {
-    if &#40;$xdg_user_dir_installed&#41; {
-        if &#40;-e &#34;$udd~&#34;&#41; {
-            rename &#34;$udd~&#34;, $udd or die &#34;could not restore backup of $udd: $!&#34;;
-        } else {
-            unlink $udd or die &#34;could not delete $udd: $!&#34;;
-        }
-    }
-}
\ No newline at end of file
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;23&nbsp;19:41:28&nbsp;2015</span>
    <span class="description">kimryan [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Looks like it is passing all tests now at CPAN Testers.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;23&nbsp;19:41:34&nbsp;2015</span>
    <span class="description">kimryan [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;23&nbsp;19:41:35&nbsp;2015</span>
    <span class="description">kimryan [...] cpan.org -  Fixed in 0.07 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
