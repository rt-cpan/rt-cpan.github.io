<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #68516 for Net-SCP-Expect: Module can hang when using an identity file &#38; auto_yes =&gt; 1 </title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #68516 for Net-SCP-Expect: Module can hang when using an identity file &#38; auto_yes =&gt; 1 </h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-SCP-Expect/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-SCP-Expect/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-SCP-Expect/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-SCP-Expect/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-SCP-Expect">Net-SCP-Expect CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">68516</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-SCP-Expect/Active/">Net-SCP-Expect</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
SHAW [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-23126-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.16    </td>
  </tr>
  <tr id="CF-23127-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;27&nbsp;20:01:49&nbsp;2011</span>
    <span class="description">SHAW [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Module can hang when using an identity file &#38; auto_yes =&gt; 1</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Some transfers can complete before the first call to expect&#40;&#41;.
When this happens &#38; auto_yes is true EOF is not detected, this causes a 
latter call to expect&#40;&#41; to hang indefinitely if $timeout_err has not 
been specified which, by default, isn&#39;t. 

From the code:

   # EOF is sent here but is not detected
   if&#40;$auto_yes&#41;{
      while&#40;$scp-&gt;expect&#40;$timeout_auto,-re=&gt;&#39;[Yy]es\/[Nn]o&#39;&#41;&#41;{
         $scp-&gt;send&#40;&#34;yes\n&#34;&#41;;
      }
   }

  #...
  #
  # EOF is never detected here and we hang
  unless&#40;$no_check || $verbose&#41;{
    $error = &#40;$scp-&gt;expect&#40;$timeout_err,
             # other matches
             [&#39;eof&#39; =&gt; sub{ $eof = 1 } ],
      &#41;&#41;[1];
   }
   else{
      $error = &#40;$scp-&gt;expect&#40;$timeout_err, [&#39;eof&#39; =&gt; sub { $eof = 1 }]&#41;&#41;
[1];
   }


Here&#39;s a sample that includes Expect output:

[sshaw@localhost ~]$ cat scp.pl
$Expect::Exp_Internal = 1;
my $scp = Net::SCP::Expect-&gt;new&#40;host =&gt; &#39;hostey&#39;,
                                identity_file =&gt; &#34;$ENV{HOME}/id_rsa&#34;,
                                auto_yes =&gt; 1&#41;;
$scp-&gt;scp&#40;shift&#41;;

[sshaw@localhost ~]$ perl scp.pl a.out
Spawned &#39;scp  -q -i &#39;/home/sshaw/id_rsa&#39;  &#39;a.out&#39; &#39;sshaw@hostey:a.out&#39;&#39;
        spawn id&#40;5&#41;
        Pid: 10902
        Tty: /dev/pts/6
 at /usr/lib/perl5/site_perl/5.8.8/Expect.pm line 181
        Expect::spawn&#40;&#39;Expect&#39;, &#39;scp  -q -i \&#39;/home/sshaw/id_rsa\&#39;  
\&#39;a.out\&#39; \&#39;sshaw@pstor3:a...&#39;&#41; called at /usr/lib/perl5/
site_perl/5.8.8/Net/SCP/Expect.pm line 204
        Net::SCP::Expect::scp&#40;&#39;Net::SCP::Expect=HASH&#40;0x841cb44&#41;&#39;, 
&#39;a.out&#39;&#41; called at scp.pl line 18
Starting EXPECT pattern matching...
 at /usr/lib/perl5/site_perl/5.8.8/Expect.pm line 561
        Expect::expect&#40;&#39;Expect=GLOB&#40;0x8529304&#41;&#39;, 1, &#39;-re&#39;, &#39;[Yy]es\/
[Nn]o&#39;&#41; called at /usr/lib/perl5/site_perl/5.8.8/Net/SCP/Expect.pm line 
213
        Net::SCP::Expect::scp&#40;&#39;Net::SCP::Expect=HASH&#40;0x841cb44&#41;&#39;, 
&#39;a.out&#39;&#41; called at scp.pl line 18
spawn id&#40;5&#41;: list of patterns:
  #1: -re `[Yy]es\\/[Nn]o&#39;


spawn id&#40;5&#41;: Does `&#39;
match:
  pattern #1: -re `[Yy]es\\/[Nn]o&#39;? No.

Waiting for new data &#40;1 seconds&#41;...
Returning from expect with TIMEOUT or EOF
Starting EXPECT pattern matching...
 at /usr/lib/perl5/site_perl/5.8.8/Expect.pm line 561
        Expect::expect&#40;&#39;Expect=GLOB&#40;0x8529304&#41;&#39;, &#39;undef&#39;, &#39;ARRAY
&#40;0x85297fc&#41;&#39;, &#39;ARRAY&#40;0x852985c&#41;&#39;, &#39;ARRAY&#40;0x8529ec8&#41;&#39;&#41; called at /usr/
lib/perl5/site_perl/5.8.8/Net/SCP/Expect.pm line 273
        Net::SCP::Expect::scp&#40;&#39;Net::SCP::Expect=HASH&#40;0x841cb44&#41;&#39;, 
&#39;a.out&#39;&#41; called at scp.pl line 18
spawn id&#40;5&#41;: list of patterns:
  #1: -re `&#40;?-xism:[Pp]ass.*&#41;&#39;
  #2: -re `&#40;?-xism:\w+.*&#41;&#39;
  #3: -eof `&#39;


spawn id&#40;5&#41;: Does `&#39;
match:
  pattern #1: -re `&#40;?-xism:[Pp]ass.*&#41;&#39;? No.
  pattern #2: -re `&#40;?-xism:\w+.*&#41;&#39;? No.
  pattern #3: -eof `&#39;? No.

Waiting for new data &#40;unlimited seconds&#41;...

I&#39;ve attached a path that fixes this with minimal code restructuring. 

-Skye
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net-SCP-Expect-0.16.expect-eof.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Net-SCP-Expect-0.16/Expect.pm	2009-02-06 09:16:10.000000000 -0800
+++ Net-SCP-Expect-0.16a/Expect.pm	2011-05-27 04:24:42.000000000 -0700
@@ -210,10 +210,21 @@ sub scp{
 
    $scp-&gt;log_stdout&#40;0&#41;;
 
+   my $eof = 0;
+   my $error;
+   ################################################################
+   # Some transfers can finish by the time we get here. 
+   # If $timeout_err is not set and we don&#39;t check for EOF
+   # we would wait indefinitely below for an EOF that will never happen.
+   ################################################################
    if&#40;$auto_yes&#41;{
-      while&#40;$scp-&gt;expect&#40;$timeout_auto,-re=&gt;&#39;[Yy]es\/[Nn]o&#39;&#41;&#41;{
-         $scp-&gt;send&#40;&#34;yes\n&#34;&#41;;
-      }
+       $error = &#40;$scp-&gt;expect&#40;$timeout_auto,
+           [qr/[Yy]es\/[Nn]o/ =&gt; sub { 
+	       $scp-&gt;send&#40;&#34;yes\n&#34;&#41;; 
+	       exp_continue; 
+	    } 
+	   ],
+	   [&#39;eof&#39; =&gt; sub { $eof = 1 }]&#41;&#41;[1];
    }
 
    if &#40;$password&#41; {
@@ -243,38 +254,37 @@ sub scp{
    # The exception to this is verbose output, which can mistakenly
    # be picked up by Expect.
    ################################################################
-   my $error;
-   my $eof = 0;
-   unless&#40;$no_check || $verbose&#41;{
-
-      $error = &#40;$scp-&gt;expect&#40;$timeout_err,
-         [qr/[Pp]ass.*/ =&gt; sub{
-               my $error = $scp-&gt;before&#40;&#41; || $scp-&gt;match&#40;&#41;;
-               if&#40;$handler&#41;{
-                  $handler-&gt;&#40;$error&#41;;
-                  return;
-               }
-               else{
-                  croak&#40;&#34;Error: Bad password [$error]&#34;&#41;;
-               }
-            }
-         ],
-         [qr/\w+.*/ =&gt; sub{
-               my $error = $scp-&gt;match&#40;&#41; || $scp-&gt;before&#40;&#41;;
-               if&#40;$handler&#41;{
-                  $handler-&gt;&#40;$error&#41;;
-                  return;
-               }
-               else{
-                  croak&#40;&#34;Error: last line returned was: $error&#34;&#41;;
-               }
-            }
-         ],
-         [&#39;eof&#39; =&gt; sub{ $eof = 1 } ],
-      &#41;&#41;[1];
-   }
-   else{
-      $error = &#40;$scp-&gt;expect&#40;$timeout_err, [&#39;eof&#39; =&gt; sub { $eof = 1 }]&#41;&#41;[1];
+   unless&#40;$eof&#41; {
+       unless&#40;$no_check || $verbose&#41;{
+	   $error = &#40;$scp-&gt;expect&#40;$timeout_err,
+               [qr/[Pp]ass.*/ =&gt; sub{
+		   my $error = $scp-&gt;before&#40;&#41; || $scp-&gt;match&#40;&#41;;
+		   if&#40;$handler&#41;{
+		       $handler-&gt;&#40;$error&#41;;
+		       return;
+		   }
+		   else{
+		       croak&#40;&#34;Error: Bad password [$error]&#34;&#41;;
+		   }
+		}
+	       ],
+              [qr/\w+.*/ =&gt; sub{
+		  my $error = $scp-&gt;match&#40;&#41; || $scp-&gt;before&#40;&#41;;
+		  if&#40;$handler&#41;{
+		      $handler-&gt;&#40;$error&#41;;
+		      return;
+		  }
+		  else{
+		      croak&#40;&#34;Error: last line returned was: $error&#34;&#41;;
+		  }
+	       }
+	      ],
+              [&#39;eof&#39; =&gt; sub{ $eof = 1 } ],
+         &#41;&#41;[1];
+       }
+       else{
+	   $error = &#40;$scp-&gt;expect&#40;$timeout_err, [&#39;eof&#39; =&gt; sub { $eof = 1 }]&#41;&#41;[1];
+       }
    }
 
    if&#40;$verbose&#41;{ print $scp-&gt;after&#40;&#41;,&#34;\n&#34; }
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
