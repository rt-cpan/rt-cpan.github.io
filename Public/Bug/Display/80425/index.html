<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #80425 for Mail-DKIM: Provide a way to specify options to Net::DNS::Resolver - like enabling EDNS0</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #80425 for Mail-DKIM: Provide a way to specify options to Net::DNS::Resolver - like enabling EDNS0</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Mail-DKIM/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Mail-DKIM/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Mail-DKIM/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Mail-DKIM/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-DKIM">Mail-DKIM CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">80425</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Mail-DKIM/Active/">Mail-DKIM</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">jason [...] long.name
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Mark.Martinec [...] ijs.si

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-38938-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.39    </td>
  </tr>
  <tr id="CF-38939-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;26&nbsp;15:51:38&nbsp;2012</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Provide a way to specify options to Net::DNS::Resolver - like
 enabling EDNS0</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Now that google.com went overboard with switching to DKIM
signatures signed with a 2048-bit key, a DNS query for a public
key comes close to an old DNS/UDP limit of 512 bytes. Depending
on a recursive DNS server in use, the google&#39;s public key comes
back either just below the 512 byte limit &#40;when there are no
additional answer sections, like with an &#39;unbound&#39; resolver&#41;,
or somewhat above this limit &#40;with &#39;bind&#39;&#41;, in which case
the Net::DNS::Resolver on seeing a truncated response
retries the query using TCP.

The issue could be avoided if Net::DNS::Resolver were allowed
to form an extended query &#40;EDNS0, RFC 2671&#41;, which can tell
that a client is willing to accept larger UDP packets than
the ancient 512 limit.

Here is an example:

perl -le &#39;use Net::DNS; $r=Net::DNS::Resolver-&gt;new;
  $r-&gt;udppacketsize&#40;4096&#41;;
  print $r-&gt;send&#40;&#34;20120113._domainkey.google.com&#34;,&#34;TXT&#34;&#41;-&gt;print&#39;

Now, not to restrict ourselves to this particular case,
it would be nice to be able either to provide additional
options to Net::DNS::Resolver &#40;like timeouts, ...&#41;, or
perhaps just allow an application to pass a configured
Net::DNS::Resolver object to be used by Mail::DKIM.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;06&nbsp;09:16:41&nbsp;2012</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark.Martinec [...] ijs.si</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached is a proposed patch.

Besides adding a DnsResolver option, it contains two small
extras:

- avoids an undef warning: 

t/verifier.t ................. 1/104 Use of uninitialized value 
$query_type in lc at .../blib/lib/Mail/DKIM/PublicKey.pm line 86.
Use of uninitialized value $query_type in concatenation &#40;.&#41; or string
at .../blib/lib/Mail/DKIM/PublicKey.pm line 88.

- uses Net::DNS::Resolver::send instead of Net::DNS::Resolver::query,
it makes no sense to apply a default domain in case of a non-FQDN;
also paves a path to using bgsend&#40;&#41; for potential async queries.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Mail-DKIM-0.39-edns0.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -r -U2 Mail-DKIM-0.39-orig/lib/Mail/DKIM/AuthorDomainPolicy.pm Mail-DKIM-0.39-new/lib/Mail/DKIM/AuthorDomainPolicy.pm
--- Mail-DKIM-0.39-orig/lib/Mail/DKIM/AuthorDomainPolicy.pm	2010-01-23 18:44:52.000000000 +0100
+++ Mail-DKIM-0.39-new/lib/Mail/DKIM/AuthorDomainPolicy.pm	2012-11-06 14:17:33.220434302 +0100
@@ -42,4 +42,5 @@
             Protocol =&gt; &#34;dns&#34;,
             Author =&gt; &#39;jsmith@example.org&#39;,
+            DnsResolver =&gt; Net::DNS::Resolver-&gt;new,  # optional
           &#41;;
 
@@ -82,5 +83,7 @@
 		}
 
-		my @resp = Mail::DKIM::DNS::query&#40;$prms{Domain}, &#34;MX&#34;&#41;;
+		my @resp = Mail::DKIM::DNS::query&#40;$prms{Domain}, &#34;MX&#34;,
+					DnsResolver =&gt; $prms{DnsResolver} &#41;;
+
 		if &#40;!@resp &#38;&#38; $@ eq &#34;NXDOMAIN&#34;&#41;
 		{
diff -r -U2 Mail-DKIM-0.39-orig/lib/Mail/DKIM/DNS.pm Mail-DKIM-0.39-new/lib/Mail/DKIM/DNS.pm
--- Mail-DKIM-0.39-orig/lib/Mail/DKIM/DNS.pm	2010-01-23 18:44:52.000000000 +0100
+++ Mail-DKIM-0.39-new/lib/Mail/DKIM/DNS.pm	2012-11-06 14:34:06.527433369 +0100
@@ -26,8 +26,8 @@
 sub query
 {
-	my &#40;$domain, $type&#41; = @_;
+	my &#40;$domain, $type, %prms&#41; = @_;
 
-	my $rslv = Net::DNS::Resolver-&gt;new&#40;&#41;
-		or die &#34;can&#39;t create DNS resolver&#34;;
+	my $rslv = $prms{DnsResolver} || Net::DNS::Resolver-&gt;new;
+	$rslv or die &#34;can&#39;t create DNS resolver&#34;;
 
 	#
@@ -49,5 +49,5 @@
 		eval
 		{
-			$resp = $rslv-&gt;query&#40;$domain, $type&#41;;
+			$resp = $rslv-&gt;send&#40;$domain, $type&#41;;
 		};
 		my $E = $@;
@@ -100,5 +100,5 @@
 		my $warning;
 		eval {
-			@resp = query&#40;$domain, $type&#41;;
+			@resp = query&#40;$domain, $type, %prms&#41;;
 			$warning = $@;
 			undef $@;
diff -r -U2 Mail-DKIM-0.39-orig/lib/Mail/DKIM/Policy.pm Mail-DKIM-0.39-new/lib/Mail/DKIM/Policy.pm
--- Mail-DKIM-0.39-orig/lib/Mail/DKIM/Policy.pm	2010-01-23 18:44:52.000000000 +0100
+++ Mail-DKIM-0.39-new/lib/Mail/DKIM/Policy.pm	2012-11-06 02:05:19.407434501 +0100
@@ -98,4 +98,5 @@
 			$host, &#34;TXT&#34;,
 			Callbacks =&gt; \%callbacks,
+			DnsResolver =&gt; $prms{DnsResolver},
 			&#41;;
 	return $waiter;
diff -r -U2 Mail-DKIM-0.39-orig/lib/Mail/DKIM/PublicKey.pm Mail-DKIM-0.39-new/lib/Mail/DKIM/PublicKey.pm
--- Mail-DKIM-0.39-orig/lib/Mail/DKIM/PublicKey.pm	2010-01-23 18:44:52.000000000 +0100
+++ Mail-DKIM-0.39-new/lib/Mail/DKIM/PublicKey.pm	2012-11-06 14:11:43.800434696 +0100
@@ -41,4 +41,5 @@
                       Selector =&gt; &#34;brisbane&#34;,
                       Domain =&gt; &#34;example.com&#34;,
+                      DnsResolver =&gt; Net::DNS::Resolver-&gt;new,  # optional
                     &#41;;
 
@@ -84,6 +85,7 @@
 
 	my &#40;$query_type, $query_options&#41; = split&#40;/\//, $prms{Protocol}, 2&#41;;
-	if &#40;lc&#40;$query_type&#41; ne &#34;dns&#34;&#41;
-	{
+	if &#40;!defined $query_type&#41; {
+		die &#34;empty or unrecognized query type\n&#34;;
+	} elsif &#40;lc&#40;$query_type&#41; ne &#34;dns&#34;&#41; {
 		die &#34;unknown query type &#39;$query_type&#39;\n&#34;;
 	}
@@ -123,4 +125,5 @@
 			$host, &#34;TXT&#34;,
 			Callbacks =&gt; \%callbacks,
+			DnsResolver =&gt; $prms{DnsResolver},
 			&#41;;
 	return $waiter;
diff -r -U2 Mail-DKIM-0.39-orig/lib/Mail/DKIM/Signature.pm Mail-DKIM-0.39-new/lib/Mail/DKIM/Signature.pm
--- Mail-DKIM-0.39-orig/lib/Mail/DKIM/Signature.pm	2010-11-14 22:05:44.000000000 +0100
+++ Mail-DKIM-0.39-new/lib/Mail/DKIM/Signature.pm	2012-11-06 15:08:22.032432356 +0100
@@ -49,4 +49,5 @@
 	bless $self, $class;
 
+	$self-&gt;{DnsResolver} = $prms{DnsResolver};
 	$self-&gt;version&#40;&#34;1&#34;&#41;;
 	$self-&gt;algorithm&#40;$prms{&#39;Algorithm&#39;} || &#34;rsa-sha1&#34;&#41;;
@@ -506,4 +507,5 @@
 	my $self = shift;
 	return if exists $self-&gt;{public_key_query};
+	my %prms = @_;
 
 	my $on_success = sub {
@@ -517,4 +519,5 @@
 	$self-&gt;{public_key_query} =
 		Mail::DKIM::PublicKey-&gt;fetch_async&#40;
+			DnsResolver =&gt; $prms{DnsResolver},
 			Protocol =&gt; $self-&gt;protocol,
 			Selector =&gt; $self-&gt;selector,
@@ -540,5 +543,5 @@
 	delete $self-&gt;{public};
 	delete $self-&gt;{public_error};
-	$self-&gt;fetch_public_key;
+	$self-&gt;fetch_public_key&#40;@_&#41;;
 }
 
@@ -564,5 +567,5 @@
 	if &#40;not exists $self-&gt;{public_key_query}&#41;
 	{
-		$self-&gt;fetch_public_key;
+		$self-&gt;fetch_public_key&#40;@_&#41;;
 	}
 
diff -r -U2 Mail-DKIM-0.39-orig/lib/Mail/DKIM/Verifier.pm Mail-DKIM-0.39-new/lib/Mail/DKIM/Verifier.pm
--- Mail-DKIM-0.39-orig/lib/Mail/DKIM/Verifier.pm	2010-11-14 22:05:44.000000000 +0100
+++ Mail-DKIM-0.39-new/lib/Mail/DKIM/Verifier.pm	2012-11-06 15:05:23.737432715 +0100
@@ -96,5 +96,5 @@
   my $dkim = Mail::DKIM::Verifier-&gt;new&#40;%options&#41;;
 
-The only option supported at this time is:
+Options supported at this time are:
 
 =over
@@ -105,4 +105,18 @@
 is written to the referenced string or file handle.
 
+=item DnsResolver
+
+a DNS resolver object. When the option is missing or undefined, method
+Net::DNS::Resolver-&gt;new&#40;&#41; will be called to provide a resolver object.
+This options allows for more flexibility in passing options to a
+DNS resolver, e.g.:
+
+  my $r;
+  $r = Net::DNS::Resolver-&gt;new&#40;udp_timeout =&gt; 3, tcp_timeout =&gt; 3, retry =&gt; 2&#41;;
+  $r-&gt;udppacketsize&#40;1280&#41;;  # enables EDNS0, sets acceptable UDP packet size
+  $r-&gt;persistent_udp&#40;1&#41;;
+# $r-&gt;debug&#40;1&#41;;
+  my $dkim = Mail::DKIM::Verifier-&gt;new&#40;$r&#41;;
+
 =back
 
@@ -159,5 +173,6 @@
 			my $signature = Mail::DKIM::Signature-&gt;parse&#40;$line&#41;;
 			$self-&gt;add_signature&#40;$signature&#41;;
-			$signature-&gt;fetch_public_key;
+			$signature-&gt;fetch_public_key&#40;
+				DnsResolver =&gt; $self-&gt;{DnsResolver} &#41;;
 		};
 		if &#40;$@&#41;
@@ -179,5 +194,6 @@
 			my $signature = Mail::DKIM::DkSignature-&gt;parse&#40;$line&#41;;
 			$self-&gt;add_signature&#40;$signature&#41;;
-			$signature-&gt;fetch_public_key;
+			$signature-&gt;fetch_public_key&#40;
+				DnsResolver =&gt; $self-&gt;{DnsResolver} &#41;;
 		};
 		if &#40;$@&#41;
@@ -435,5 +451,6 @@
 		eval
 		{
-			$pkey = $signature-&gt;get_public_key;
+			$pkey = $signature-&gt;get_public_key&#40;
+					DnsResolver =&gt; $self-&gt;{DnsResolver} &#41;;
 		};
 		if &#40;$@&#41;
@@ -571,6 +588,7 @@
 	return map {
 		Mail::DKIM::AuthorDomainPolicy-&gt;fetch&#40;
-			Protocol =&gt; &#34;dns&#34;,
 			Author =&gt; $_,
+			Protocol =&gt; &#34;dns&#34;,
+			DnsResolver =&gt; $self-&gt;{DnsResolver},
 			&#41;
 		} @authors;
@@ -604,6 +622,7 @@
 	# fetch the policy
 	return Mail::DKIM::DkimPolicy-&gt;fetch&#40;
-			Protocol =&gt; &#34;dns&#34;,
 			Author =&gt; $author,
+			Protocol =&gt; &#34;dns&#34;,
+			DnsResolver =&gt; $self-&gt;{DnsResolver},
 			&#41;;
 }
@@ -647,4 +666,5 @@
 			Author =&gt; $author,
 			Sender =&gt; $sender,
+			DnsResolver =&gt; $self-&gt;{DnsResolver},
 			&#41;;
 }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;06&nbsp;13:33:27&nbsp;2012</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark.Martinec [...] ijs.si</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; - uses Net::DNS::Resolver::send instead of Net::DNS::Resolver::query,
&gt; it makes no sense to apply a default domain in case of a non-FQDN;
&gt; also paves a path to using bgsend&#40;&#41; for potential async queries.
</div>
Btw, the use of send&#40;&#41; instead of query&#40;&#41; is also compatible
with Mail::SPF::Server, along with an equivalent passing of a
resolver object from a caller:

$ man Mail::SPF::Server
  [...]
Mail::SPF::Server is a server class for processing SPF requests.  Each
server instance can be configured with specific processing parameters.
Also, the default Net::DNS::Resolver DNS resolver used for making DNS
look-ups can be overridden with a custom resolver object.
  [...]
dns_resolver:
  [...]
An optional DNS resolver object.  If none is specified, a new
Net::DNS::Resolver object is used.  The resolver object may be
of a different class, but it must provide an interface similar
to Net::DNS::Resolver -- at least the &#34;send&#34; and &#34;errorstring&#34;
methods must be supported, and the &#34;send&#34; method must return
either an object of class Net::DNS::Packet, or, in the case of
an error, undef.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;28&nbsp;10:12:34&nbsp;2012</span>
    <span class="description">jason [...] long.name -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;28&nbsp;12:58:40&nbsp;2012</span>
    <span class="description">jason [...] long.name -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Regarding this,


On Tue Nov 06 09:16:41 2012, Mark.Martinec@ijs.si wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; - uses Net::DNS::Resolver::send instead of Net::DNS::Resolver::query,
&gt; it makes no sense to apply a default domain in case of a non-FQDN;
&gt; also paves a path to using bgsend&#40;&#41; for potential async queries.
</div>


The documentation for Net::DNS::Resolver::query&#40;&#41; says the search domain
is NOT applied. From what I can tell, the difference between query&#40;&#41; and
send&#40;&#41; is not whether the search list is applied but rather how failures
are handled. Do you concur? I think I&#39;m ok with replacing query&#40;&#41; with
send&#40;&#41;, as long as I know the ramifications.


Jason
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;28&nbsp;12:58:41&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;28&nbsp;14:25:10&nbsp;2012</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark.Martinec [...] ijs.si</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The documentation for Net::DNS::Resolver::query&#40;&#41; says the search
&gt; domain is NOT applied. From what I can tell, the difference between
&gt; query&#40;&#41; and send&#40;&#41; is not whether the search list is applied but
&gt; rather how failures are handled. Do you concur? I think I&#39;m ok with
&gt; replacing query&#40;&#41; with send&#40;&#41;, as long as I know the ramifications.
</div>
$ man Net::DNS::Resolver :

query
  Performs a DNS query for the given name; the search list is
  not applied.  If the name doesn&#39;t contain any dots and defnames
  is true then the default domain will be appended.

send
  Performs a DNS query for the given name.  Neither the searchlist
  nor the default domain will be appended.

So as long a defnames is not set to true, query&#40;&#41; and send&#40;&#41;
are pretty much the same. Indeed the query&#40;&#41; additionally
checks for presence of the &#39;answer&#39; section in a response,
although I believe the Mail::DKIM would also notice
absence of the &#39;answer&#39; section.

This is the code in Net/DNS/Resolver/Base.pm :

sub query {
  my $self = shift;
  my $name = shift || &#39;.&#39;;
  # resolve name containing no dots or colons by appending domain
  my @suffix = &#40;$self-&gt;{domain} || &#40;&#41;&#41;
    if $name !~ m/[:.]/ and $self-&gt;{defnames};
  my $fqname = join &#39;.&#39;, $name, @suffix;
  print &#39;;; query&#40;&#39;, join&#40;&#39;, &#39;, $fqname, @_&#41;, &#34;&#41;\n&#34; if $self-&gt;{debug};
  my $packet = $self-&gt;send&#40;$fqname, @_&#41; || return undef;
  return $packet if $packet-&gt;header-&gt;ancount;     # answer found
  return undef;
}

I&#39;m suggesting the use of send&#40;&#41; instead of query&#40;&#41;
mostly for compatibility with Mail::SPF::Server.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;28&nbsp;15:04:01&nbsp;2012</span>
    <span class="description">jason [...] long.name -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Yup, you&#39;re right about the default domain.
I&#39;m replacing query&#40;&#41; with send&#40;&#41; as you suggested.

For specifying options to the resolver, I looked at your patch but I am
considering a simpler change than that... adding a global configuration
variable to control the resolver.

So basically, the usage pattern would be the following. At the top of
the script that uses Mail::DKIM, you would have

my $res = Net::DNS::Resolver-&gt;new&#40;&#41;;
$res-&gt;udppacketsize&#40;2048&#41;;

$Mail::DKIM::DNS::RESOLVER = $res;


and then all the Mail::DKIM functions will use the specified resolver
object. It&#39;s not as pure a solution, perhaps, but in my mind this is
more of a configuration thing than a per-instance setting.


Any objections?


Jason
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;28&nbsp;15:20:34&nbsp;2012</span>
    <span class="description">Mark.Martinec [...] ijs.si -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #80425] Provide a way to specify options to Net::DNS::Resolver - like enabling EDNS0</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 28 Nov 2012 21:20:20 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;Jason Long via RT&#34; &lt;bug-Mail-DKIM [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Martinec &lt;Mark.Martinec [...] ijs.si&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Jason,

Thanks for looking into this.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; For specifying options to the resolver, I looked at your patch but I am
&gt; considering a simpler change than that... adding a global configuration
&gt; variable to control the resolver.
&gt; 
&gt; So basically, the usage pattern would be the following. At the top of
&gt; the script that uses Mail::DKIM, you would have
&gt; 
&gt; my $res = Net::DNS::Resolver-&gt;new&#40;&#41;;
&gt; $res-&gt;udppacketsize&#40;2048&#41;;
&gt; 
&gt; $Mail::DKIM::DNS::RESOLVER = $res;
&gt; 
&gt; and then all the Mail::DKIM functions will use the specified resolver
&gt; object. It&#39;s not as pure a solution, perhaps, but in my mind this is
&gt; more of a configuration thing than a per-instance setting.
&gt; 
&gt; Any objections?
</div>
It gives me an ugly warning:

  Name &#34;Mail::DKIM::DNS::RESOLVER&#34; used only once: possible typo at ...

and one cannot have two instances of a Mail::DKIM::Verifier, each
with its own resolver - but I could live with that.

  Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;04&nbsp;14:27:11&nbsp;2013</span>
    <span class="description">jason [...] long.name -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ok, I finally got the new version ready for testing; it&#39;s now available 
as version 0.39_6 &#40;developer release&#41; on CPAN.

The new version contains a supported way of overriding the DNS resolver. 
Yeah, if you&#39;re using an older version of the Mail::DKIM module, you&#39;ll 
get a warning about a variable name used only once. I suppose you&#39;ll 
need a &#39;no warnings&#39; directive to avoid that.

Version 0.39_6 also changes the DEFAULT resolver to use a large udp 
packet size &#40;2048 bytes&#41;, so maybe you won&#39;t even need to override the 
resolver at all.

I intend to release this as version 0.40 later this week, if I do not 
discover any problems with the new version. Hopefully I won&#39;t once again 
get distracted by some other project for several weeks :&#41;.

Jason
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;07&nbsp;15:38:06&nbsp;2013</span>
    <span class="description">jason [...] long.name -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">As noted in another ticket, the change to use EDNS0 by default has been 
reverted. In version 0.40, which has just been sent on its way to CPAN, 
there is now a documented subroutine available for enabling EDNS0 if 
desired. Do something like

if &#40;Mail::DKIM::Verifier-&gt;VERSION &gt;= 0.40&#41; {
    Mail::DKIM::DNS::enable_EDNS0&#40;&#41;;
}



I&#39;m going to mark this ticket resolved.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;07&nbsp;15:38:07&nbsp;2013</span>
    <span class="description">jason [...] long.name -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
