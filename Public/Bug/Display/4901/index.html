<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #4901 for Storable: Letting STORABLE_thaw return object</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #4901 for Storable: Letting STORABLE_thaw return object</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Storable">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Storable">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Storable">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Storable">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="http://rt.perl.org/perlbug/">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Storable">Storable CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">4901</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">1.9 hours (115 min)

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Storable">Storable</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
natg [...] shore.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
adamk [...] cpan.org

<br />
RSOD [...] cpan.org

<br />
simon [...] simon-cozens.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-29856-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.09    </td>
  </tr>
  <tr id="CF-29857-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




attach.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/95225/33197/attach.patch">
Thu Mar 31 21:16:09 2005 (17.1k) by 
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/95224/32903/attach.patch">
Thu Mar 24 21:54:49 2005 (17k) by 
</a>
</font></li>
</ul>


attach_thaw.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/95223/32533/attach_thaw.t">
Mon Mar 14 22:34:19 2005 (2.8k) by 
</a>
</font></li>
</ul>


circular_hook.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/95208/32413/circular_hook.t">
Thu Mar 10 23:18:52 2005 (1.5k) by 
</a>
</font></li>
</ul>


hook_attach_errors.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/95211/32421/hook_attach_errors.t">
Fri Mar 11 01:58:41 2005 (6.9k) by 
</a>
</font></li>
</ul>


side_reference.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/95215/32467/side_reference.t">
Sat Mar 12 14:37:07 2005 (900b) by 
</a>
</font></li>
</ul>


singleton.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/95210/32418/singleton.t">
Fri Mar 11 00:26:06 2005 (2.3k) by 
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/95194/32291/singleton.t">
Wed Mar 09 00:54:44 2005 (2.7k) by 
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=4901">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95190" href="/Public/Bug/Display.html?id=4901#txn-95190">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;10&nbsp;14:10:45&nbsp;2004</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Letting STORABLE_thaw return object</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/95190/15019/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/15019">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">It would be nice if there were a way for STORABLE_thaw to return a reference of its own choosing, rather than requiring that it fill in the empty object passed to it.

I&#39;m developing a persistent object store, Class::AutoDB, that features the ability to incrementally reload objects from the database and reconstruct shared object structures as objects are fetched.  Suppose objects A and B both refer to object C.  A and B can be fetched independently, and this does not immediately cause C to be fetched.  But when C is fetched, the references from A and B must be Â“swizzledÂ” to point to the same in-memory version of C. 

To make this work, we want the thaw hook to consult a hash to see if the object being thawed is already in memory, and if so, return a reference to the existing in-memory copy.  Data:DumperÂ’s thaw hook lets us do this and thatÂ’s what weÂ’re using now.  Storable has many advantages over Data::Dumper and we would prefer to use it instead &#40;or provide both and let users choose&#41;, if only the thaw hook gave us this one additional feature. 

Thanks very much,
Nat Goodman
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95191" href="/Public/Bug/Display.html?id=4901#txn-95191">#</a>      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;06&nbsp;23:41:29&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/95191/32147/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32147">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 905b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I concur.

The whole &#34;we&#39;ll give you an object&#34; idea is flawed. For such a
low-level coding interface, it&#39;s a bad example of trying to help out.

The ideal interface would be not to create an empty and instantiated
&#40;and in most cases illegal&#41; object for you, but let you do it yourself
and return it.

The current implementation does not support Singleton classes... it
creates an illegal second instance of the Singleton.

It doesn&#39;t support pooled or keyed objects that a process-wide and
should NOT go into the Storable.

Since you obviously don&#39;t want to change the existing interface,
allowing the user to return an alternative object would be ideal, or
perhaps to create a second alternate STORABLE_thaw_class for the task &#40;I
prefer the former&#41;.

In most cases where existing implmentations are accidentally returning
objects, it should almost certainly be the SAME object as what they were
passed.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95192" href="/Public/Bug/Display.html?id=4901#txn-95192">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;07&nbsp;00:30:21&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> cpan [...] ali.as</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/95192/32156/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32156">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 380b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">OK

I&#39;ve done a full sweep through every single module in CPAN that uses
STORABLE_thaw.

About a third of them ASSUME that they have to pass $self as the return
value, another third just C&lt; return; &gt; and the rest look ok, except for
very rare race conditions.

I&#39;ve filed RT bugs against all of THOSE to ensure they move to C&lt;
return; &gt; or C&lt; return $self; &gt; to prevent any races.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95193" href="/Public/Bug/Display.html?id=4901#txn-95193">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;07&nbsp;14:00:01&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> natg [...] shore.net</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/95193/32202/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32202">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 184b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I appreciate your looking into this.  Your response suggests that 
you&#39;re planning to make the change.  Yes?  If so, do you have an 
expected completion date?

Many thanks,
Nat Goodman
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95194" href="/Public/Bug/Display.html?id=4901#txn-95194">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;09&nbsp;00:54:44&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> cpan [...] ali.as</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/95194/32290/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32290">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 192b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have just filed a bug 11813 for the specific Singleton case that can&#39;t
be fixed except with this change.

Listed in that bug is a full test case for the problem, which I&#39;ll also
attach here.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/95194/32291/singleton.t">Download singleton.t</a><br />
<span class="downloadcontenttype">text/x-perl 2.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w

# Tests the freezing/thawing structures containing Singleton objects,
# which should see both structs pointing to the same object.

# In order to make this test work, ANY method needs to exist that can
# be used in STORABLE_freeze and STORABLE_thaw in order to make the tests
# pass.

use Storable &#40;&#41;;
use Test::More tests =&gt; 7;

# Get the singleton
my $object = My::Singleton-&gt;new;
isa_ok&#40; $object, &#39;My::Singleton&#39; &#41;;

# Confirm &#40;for the record&#41; that the class is actually a Singleton
my $object2 = My::Singleton-&gt;new;
isa_ok&#40; $object2, &#39;My::Singleton&#39; &#41;;
is&#40; &#34;$object&#34;, &#34;$object2&#34;, &#39;Class is a singleton&#39; &#41;;

############
# Main Tests

my $struct = [ 1, $object, 3 ];

# Freeze the struct
my $frozen = Storable::freeze&#40; $struct &#41;;
ok&#40; &#40;defined&#40;$frozen&#41; and ! ref&#40;$frozen&#41; and length&#40;$frozen&#41;&#41;, &#39;freeze returns a string&#39; &#41;;

# Thaw the struct
my $thawed = Storable::thaw&#40; $frozen &#41;;

# Now it should look exactly like the original
is_deeply&#40; $struct, $thawed, &#39;Struct superficially looks like the original&#39; &#41;;

# ... EXCEPT that the Singleton should be the same instance of the object
is&#40; &#34;$struct-&gt;[1]&#34;, &#34;$thawed-&gt;[1]&#34;, &#39;Singleton thaws correctly&#39; &#41;;

# We can also test this empirically
$struct-&gt;[1]-&gt;{value} = &#39;Goodbye cruel world!&#39;;
is_deeply&#40; $struct, $thawed, &#39;Empiric testing corfirms correct behaviour&#39; &#41;;

# End Tests
###########

package My::Singleton;

my $SINGLETON = undef;

sub new {
	$SINGLETON or
	$SINGLETON = bless { value =&gt; &#39;Hello World!&#39; }, $_[0];
}

sub STORABLE_freeze {
	my $self = shift;

	# We don&#39;t actually need to return anything, but provide a null string
	# to avoid the null-list-return behaviour.
	return &#40;&#39;&#39;&#41;;
}

sub STORABLE_thaw {
	my &#40;$obj, $clone, $string&#41; = @_;

	# Get the Singleton object
	my $self = My::Singleton-&gt;new;

	### IS THERE ANY POSSIBLE CODE FOR STORABLE_thaw THAT CAN
	### BE USED TO PASS THE TESTS???
	### LET&#39;S TRY TO DOCUMENTED WAY OF CREATING THE OBJECT
	%$obj = %$self;

	return;
}

# This one would work under the proposed changes to Storable
sub STORABLE_thaw_new {
	My::Singleton-&gt;new;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95195" href="/Public/Bug/Display.html?id=4901#txn-95195">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;09&nbsp;01:18:22&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> cpan [...] ali.as</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/95195/32294/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32294">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m no C coder myself, but I&#39;ve written up the following project
specification, and I&#39;ll be paying Coraline &#40;RSOD&#41; to implement it for me.

I&#39;d imagine he&#39;ll find the time to do it and post the patch some time in
the next few days, assuming you are happy to review/merge/release.

---------------------------------

Overview:

Storable&#39;s STORABLE_thaw method currently &#34;helpfully&#34; provides a blessed
method which you are expected to fill when thawing objects with custom
Storable hooks. More details in the Storable documentation.

This is a major problem with Singleton classes and other things that it
is NEVER safe for anyone outside of the Singleton class itself to
arbitrarily bless object.

The full list of the types of classes are

Singleton:
my $one = My::Singleton-&gt;new;
my $two = My::Singleton-&gt;new;
ok&#40;refaddr&#40;$one&#41; == refaddr&#40;$two&#41;, &#39;Singleton class working&#39;&#41;;

Keyed:
my $one   = My::Keyed-&gt;new&#40;&#39;foo&#39;&#41;;
my $two   = My::Keyed-&gt;new&#40;&#39;foo&#39;&#41;;
my $three = My::Keyed-&gt;new&#40;&#39;bar&#39;&#41;;
ok&#40;refaddr&#40;$one&#41; == refaddr&#40;$two&#41;,   &#39;Keyed class works for same key&#39;&#41;;
ok&#40;refaddr&#40;$one&#41; != refaddr&#40;$three&#41;, &#39;Keyed class works for different&#39;&#41;;

Pooled:
&#40;As above but with the actual objects such as database connections
returned determined by some more complex means such as resource load
levels or so on&#41;.

The expected behaviour would thus be that when the object is frozen it
returns no information &#40;Singleton&#41; or the key name &#40;Keyed&#41; and when
thawed the correct object is obtained from the class and used in the
thawed struct.

----------------------

Work Description:

Alter the behaviour of STORABLE_thaw in a backwards compatible way so
that some implementation of STORABLE_freeze/thaw is possible to properly
implement Storable hooks support for the above cases.

The recommended way is described in part at the following URL.

<span class="clickylink"><a target="new" rel="nofollow" href="http://perlmonks.org/?node_id=437784">http://perlmonks.org/?node_id=437784</a></span>

It is also mentioned as point 2&#41; at the following Storable bug

<span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/NoAuth/Bug.html?id=6641">http://rt.cpan.org/NoAuth/Bug.html?id=6641</a></span>

And also at the following

<span class="clickylink"><a target="new" rel="nofollow" href="http://perlmonks.org/NoAuth/Bug.html?id=4901">http://perlmonks.org/NoAuth/Bug.html?id=4901</a></span>

A complete unit tests for the correct behaviour in Singleton classes &#40;as
an example&#41; can be found at

<span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/NoAuth/Bug.html?id=11813">http://rt.cpan.org/NoAuth/Bug.html?id=11813</a></span>

The items to be implemented are

1. Alter Storable to implement in C/XS at the appropriate location the
as described in the Equivalent Perl Implementation following. The
porting need not be identical, but should implement the same intent.

2. Add singleton.t to the Storable tests.

3. Write and add keyed.t &#40;testing the &#34;Keyed&#34; case described at top&#41; to
the Storable tests. &#40;The Pooled case is not required&#41;

4. Ensure all unit tests pass

5. Create a patch against the most current released Storable dist and
submit/attach it to rt.cpan.org bug 4901 with any comments for the
maintainer.

6. If needed, make any minor structural or style changes as requested by
the maintainer and resubmit the patch to the same location.

--------------------------

Equivalent Perl Implementation

If the current implementation of Storable&#39;s use of STORABLE_thaw could
be described as &#40;describing only the HASH case&#41;

  &#40;$class, $string, @references&#41; = get_basic_hooked_thaw;
  $object = bless { }, $class;
  if &#40; $object-&gt;can&#40;&#39;STORABLE_thaw&#39;&#41; &#41; {
      $object-&gt;STORABLE_thaw&#40;$string, @references&#41;;
  }

Alter it to the following

    use Scalar::Util &#39;blessed&#39;;
    
    &#40;$class, $string, @references&#41; = get_basic_hooked_thaw;
    $object = bless { }, $class;
    if &#40; $object-&gt;can&#40;&#39;STORABLE_thaw&#39;&#41; &#41; {
        # Call in scalar context and get the return value
        my $rv = $object-&gt;STORABLE_thaw&#40;$string, @references&#41;;
        
        # Did STORABLE_thaw return an alternate object of the same class
        if &#40; ref $rv and blessed&#40;$rv&#41; and $rv-&gt;isa&#40;$class&#41; &#41; {
            $object = $rv;
        }
    }

Please note that Scalar::Util is not a dependency for Storable, and thus
the C/XS equivalent of &#34;Is the return value an alternate object of the
same class&#34; should be used to the satisfaction of yourself and the
Storable maintainers.

---------------
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95197" href="/Public/Bug/Display.html?id=4901#txn-95197">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;09&nbsp;21:26:43&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> cpan [...] ali.as</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/95197/32361/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32361">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve got an objection on PerlMonks &#40;just the one&#41; to changing
STORABLE_thaw, so I should probably outline the alternatives I had
considered.

1. New module or subclass

Probably not a good idea, because we can&#39;t control which version is
called at the top level. If my Singleton works with one and not with the
other, the problems still occur, because I can&#39;t control which one some
user will use. They would also likely be incompatible.

Better to wait and possible do Storable2 or Perl6 Storable with a new API?

2. New mechanism

Do a different pair of DIFFERENTSTORABLE_freeze/thaw methods... ugh

3. New and alternate thaw method

Add a new strictly correct alternate one

sub STORABLE_static_thaw {
    my &#40;$class, $string, @references&#41; = @_;

    # Instantiate and return
    my $self = bless {}, $class;

    ....

    return $self;
}

And then in Storable

my &#40;$class, $string, @refs&#41; = raw_thaw&#40;&#41;;

my $object;
if &#40; $class-&gt;can&#40;&#39;STORABLE_static_thaw&#39;&#41; &#41; {
   $object = $class-&gt;STORABLE_static_thaw&#40; $string, @refs &#41;;
   die unless $object-&gt;isa&#40;$class&#41;;
} else {
   # Same as we do now
   $object = bless {}, $class;
   if &#40; $class-&gt;can&#40;&#39;STORABLE_thaw&#39;&#41; &#41; {
       $object-&gt;STORABLE_thaw&#40; $string, @refs &#41;;
   }
}




If we want to be REALLY careful, and given that much of the core&#39;ish
modules like Storable are going to be rewritten for Perl6 anyway, maybe
this last one is a better choice.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95198" href="/Public/Bug/Display.html?id=4901#txn-95198">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;09&nbsp;21:42:43&nbsp;2005</span>
    <span class="description">SAMV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> samv [...] cpan.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/95198/32362/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32362">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">In order to successfully complete this change, you will need to
understand why the API was designed like that in the first place.

STORABLE_freeze lets you return a list of objects that will be frozen in
place of the `real&#39; object.  On the way back, it needs to construct the
object again.

However, what if the object returns a list of items that end up
referring back to another point in the data structure?

For instance,

  my $object = bless { foo =&gt; &#34;bar&#34; }, &#34;Thing&#34;;
  my $object2 = bless { bar =&gt; &#34;baz&#34; }, &#34;Thing&#34;;
  $object-&gt;{superset} = Set::Object-&gt;new&#40;$object, $object2&#41;;

So, in this case the structure will be stored as the logical;

  $o = { foo =&gt; &#34;bar&#34;,
    superset =&gt; \[ $o, { bar =&gt; &#34;baz&#34; } ]
  }

You can see already that there is a precedence problem.  The picture can
get much, much worse than this - the end result being that not all
objects being used to do the reconstruction may be built yet, but
Storable has to construct an object in terms of it.  Hence you have a
&#34;chicken and egg problem&#34; that means Storable has to construct these
placeholders in order to break the loop.

It is quite easy to work around this problem; before the freeze you
traverse the data structure and replace occurances of the
singleton/storage object with placeholders, which are replaced
afterwards.  See Tangram::Dump in recent Tangram distributions for an
example of this.

Part of the reason Storable has such great performance is because it
performs its task with a single pass of the data structure.  If this
cannot be maintained, then the distribution needs to be forked rather
than &#34;fixed&#34;.

In short, I think you might be hitting a rather obscure &#34;caveat&#34;, not a
&#34;flaw&#34;, and it might not be possible to make this change without
drastically breaking performance.

But please, feel free to prove me wrong.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95199" href="/Public/Bug/Display.html?id=4901#txn-95199">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;09&nbsp;21:59:19&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/95199/32363/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32363">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It is quite easy to work around this problem; before the freeze you
&gt; traverse the data structure and replace occurances of the
&gt; singleton/storage object with placeholders, which are replaced
&gt; afterwards.  See Tangram::Dump in recent Tangram distributions for an
&gt; example of this.
&gt; 
&gt; Part of the reason Storable has such great performance is because it
&gt; performs its task with a single pass of the data structure.  If this
&gt; cannot be maintained, then the distribution needs to be forked rather
&gt; than &#34;fixed&#34;.
</div>
Good points.

I have a similar situation in import/export in a relation system, and I
see how this might have similar issues.

Without changing the way in which the freeze half is done, one option
for the thaw half which would not require the use of placeholders might
be to make it two pass as follows.

On the first pass we leave the empty/illegal/default &#40;EID from here on&#41;
object in place to keep the references sane, but store the returned
object away, keyed against the memory address of the EID object.

After the normal first pass we do a second pass &#40;conditional on there
actually being anything stored away&#41; which walks the resulting structure
&#40;using normal circular and recursion prevention&#41; and replaces EID
references with the ones in the store.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95200" href="/Public/Bug/Display.html?id=4901#txn-95200">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;10&nbsp;01:09:00&nbsp;2005</span>
    <span class="description">RSOD [...] cpan.org -  Cc RSOD added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95201" href="/Public/Bug/Display.html?id=4901#txn-95201">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;10&nbsp;01:15:17&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Cc ADAMK added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95205" href="/Public/Bug/Display.html?id=4901#txn-95205">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;10&nbsp;23:10:24&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/95205/32408/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32408">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 16b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Testing for RSOD
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95208" href="/Public/Bug/Display.html?id=4901#txn-95208">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;10&nbsp;23:18:52&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/95208/32412/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32412">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 142b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Due to permissions bizarreness, for some reason I can&#39;t see my own
comments. I&#39;m told &#34;Reply&#34; might fix this.

This is the circular hooks demo
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/95208/32413/circular_hook.t">Download circular_hook.t</a><br />
<span class="downloadcontenttype">text/x-perl 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use Storable &#40;&#41;;
use Test::More tests =&gt; 8;

my $ddd = bless { }, &#39;Foo&#39;;
my $eee = bless { Bar =&gt; $ddd }, &#39;Bar&#39;;
$ddd-&gt;{Foo} = $eee;

my $array = [ $ddd ];

my $string = Storable::freeze&#40; $array &#41;;
my $thawed = Storable::thaw&#40; $string &#41;;

# is_deeply infinite loops in ciculars, so do it manually
# is_deeply&#40; $array, $thawed, &#39;Circular hooked objects work&#39; &#41;;
is&#40; ref&#40;$thawed&#41;, &#39;ARRAY&#39;, &#39;Top level ARRAY&#39; &#41;;
is&#40; scalar&#40;@$thawed&#41;, 1, &#39;ARRAY contains one element&#39; &#41;;
isa_ok&#40; $thawed-&gt;[0], &#39;Foo&#39; &#41;;
is&#40; scalar&#40;keys %{$thawed-&gt;[0]}&#41;, 1, &#39;Foo contains one element&#39; &#41;;
isa_ok&#40; $thawed-&gt;[0]-&gt;{Foo}, &#39;Bar&#39; &#41;;
is&#40; scalar&#40;keys %{$thawed-&gt;[0]-&gt;{Foo}}&#41;, 1, &#39;Bar contains one element&#39; &#41;;
isa_ok&#40; $thawed-&gt;[0]-&gt;{Foo}-&gt;{Bar}, &#39;Foo&#39; &#41;;
is&#40; $thawed-&gt;[0], $thawed-&gt;[0]-&gt;{Foo}-&gt;{Bar}, &#39;Circular is... well... circular&#39; &#41;;




package Foo;

sub STORABLE_freeze {
	my &#40;$self, $clone&#41; = @_;
	my $class = ref $self;
	
	print &#34;# Freezing $class\n&#34;;

	return &#40;$class, $self-&gt;{$class}&#41;;
}

sub STORABLE_thaw {
	my &#40;$self, $clone, $string, @refs&#41; = @_;
	my $class = ref $self;

	print &#34;# Thawing $class\n&#34;;

	$self-&gt;{$class} = shift @refs;

 	return;
}

package Bar;

BEGIN {
@ISA = &#39;Foo&#39;;
}

1;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95209" href="/Public/Bug/Display.html?id=4901#txn-95209">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;10&nbsp;23:21:28&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/95209/32414/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32414">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Reposting again due to permissions weirdness, so people other than the
queue admin can see it.

------------------------------------

OK, having thoroughly whiteboarded some more obscure cases and had a
read through the thawing code, I think I can resolve all the problems to
get to a final implementation.

----------------------------------

1. Addition of a new method STORABLE_attach, which is to be used instead
of STORABLE_thaw for classes where the object is a process or system
level resource and the thawed structure needs to attach to an existing
shared object rather than create a new object.

2. This alternative freeze/attach will have NO ability to use child
references, to prevent circular loops below a detached object and thus
the main cause of the problem of &#34;create the reference early, but call
the thaw hooks depth-first&#34;.

This approach is reasonably as we really should not be storing anything
inside the singleton&#39;ish object anyway, it is owned and controled by the
class itself, and anything inside it isn&#39;t really &#34;our&#34; data anyway.

3. Continue to use STORABLE_freeze as normal. However, on return from
STORABLE_freeze check to see if the class has a STORABLE_attach method. 

If the class has a STORABLE_attach method AND the STORABLE_freeze call
returned more than just a string &#40;child references&#41;, throw an exception.

4. At thaw-time, check for a STORABLE_attach and if it has one, get the
empty reference as normal, but rather than indexing and adding it to the
context, use it to find it&#39;s class. Then get the string part as normal,
and call

$object = STORABLE_attach&#40; $class, $string &#41;;

Store this object instead and add it to the context against the
appropriate Object-ID so that additional references to the object will
be linked to the same object as per normal.

After storing, double check that the frozen object did not have any
references. If so, throw an exception.

-----------------------------

Short of someone changing the behaviour of a class to INTENTIONALLY
cause problems, I don&#39;t see any remaining issues with this version.

plain text &#40;suitable for cut and paste, overrides all&#41; 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95210" href="/Public/Bug/Display.html?id=4901#txn-95210">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;11&nbsp;00:26:06&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">10 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/95210/32417/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32417">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 106b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attaching the basic singleton.t test, rewritten against the final
STORABLE_attach concept described above.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/95210/32418/singleton.t">Download singleton.t</a><br />
<span class="downloadcontenttype">text/x-perl 2.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w

# Tests the freezing/thawing structures containing Singleton objects,
# which should see both structs pointing to the same object.

# In order to make this test work, ANY method needs to exist that can
# be used in STORABLE_freeze and STORABLE_thaw in order to make the tests
# pass.

use Storable &#40;&#41;;
use Test::More tests =&gt; 7;

# Get the singleton
my $object = My::Singleton-&gt;new;
isa_ok&#40; $object, &#39;My::Singleton&#39; &#41;;

# Confirm &#40;for the record&#41; that the class is actually a Singleton
my $object2 = My::Singleton-&gt;new;
isa_ok&#40; $object2, &#39;My::Singleton&#39; &#41;;
is&#40; &#34;$object&#34;, &#34;$object2&#34;, &#39;Class is a singleton&#39; &#41;;

############
# Main Tests

my $struct = [ 1, $object, 3 ];

# Freeze the struct
my $frozen = Storable::freeze&#40; $struct &#41;;
ok&#40; &#40;defined&#40;$frozen&#41; and ! ref&#40;$frozen&#41; and length&#40;$frozen&#41;&#41;, &#39;freeze returns a string&#39; &#41;;

# Thaw the struct
my $thawed = Storable::thaw&#40; $frozen &#41;;

# Now it should look exactly like the original
is_deeply&#40; $struct, $thawed, &#39;Struct superficially looks like the original&#39; &#41;;

# ... EXCEPT that the Singleton should be the same instance of the object
is&#40; &#34;$struct-&gt;[1]&#34;, &#34;$thawed-&gt;[1]&#34;, &#39;Singleton thaws correctly&#39; &#41;;

# We can also test this empirically
$struct-&gt;[1]-&gt;{value} = &#39;Goodbye cruel world!&#39;;
is_deeply&#40; $struct, $thawed, &#39;Empiric testing corfirms correct behaviour&#39; &#41;;

# End Tests
###########

package My::Singleton;

my $SINGLETON = undef;

sub new {
	$SINGLETON or
	$SINGLETON = bless { value =&gt; &#39;Hello World!&#39; }, $_[0];
}

sub STORABLE_freeze {
	my $self = shift;

	# We don&#39;t actually need to return anything, but provide a null string
	# to avoid the null-list-return behaviour.
	return &#40;&#39;&#39;&#41;;
}

sub STORABLE_attach {
	my &#40;$class, $clone, $string&#41; = @_;

	# Get the Singleton object and return it
	return $class-&gt;new;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95211" href="/Public/Bug/Display.html?id=4901#txn-95211">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;11&nbsp;01:58:41&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">60 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/95211/32420/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32420">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 152b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attaching hook_attach_errors.t test script, which tests for the three
main exceptions that it is possible for the new functionality to
correctly cause.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/95211/32421/hook_attach_errors.t">Download hook_attach_errors.t</a><br />
<span class="downloadcontenttype">text/x-perl 6.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w

use Storable &#40;&#41;;
use Test::More tests =&gt; 35;





#####################################################################
# Error 1
# 
# Classes that implement STORABLE_thaw _cannot_ have references
# returned by their STORABLE_freeze method. When they do, Storable
# should throw an exception



# Good Case - should not die
{
	my $goodfreeze = bless {}, &#39;My::GoodFreeze&#39;;
	my $frozen = undef;
	eval {
		$frozen = Storable::freeze&#40; $goodfreeze &#41;;
	};
	ok&#40; ! $@, &#39;Storable does not die when STORABLE_freeze does not return references&#39; &#41;;
	ok&#40; $frozen, &#39;Storable freezes to a string successfully&#39; &#41;;

	package My::GoodFreeze;

	sub STORABLE_freeze {
		my &#40;$self, $clone&#41; = @_;
		
		# Illegally include a reference in this return
		return &#40;&#39;&#39;&#41;;
	}

	sub STORABLE_attach {
		my &#40;$class, $clone, $string&#41; = @_;
		return bless { }, &#39;My::GoodFreeze&#39;;
	}
}



# Error Case - should die on freeze
{
	my $badfreeze = bless {}, &#39;My::BadFreeze&#39;;
	eval {
		Storable::freeze&#40; $badfreeze &#41;;
	};
	ok&#40; $@, &#39;Storable dies correctly when STORABLE_freeze returns a referece&#39; &#41;;
	# Check for a unique substring of the error message
	ok&#40; $@ =~ /cannot return references/, &#39;Storable dies with the expected error&#39; &#41;;

	package My::BadFreeze;

	sub STORABLE_freeze {
		my &#40;$self, $clone&#41; = @_;
		
		# Illegally include a reference in this return
		return &#40;&#39;&#39;, []&#41;;
	}

	sub STORABLE_attach {
		my &#40;$class, $clone, $string&#41; = @_;
		return bless { }, &#39;My::BadFreeze&#39;;
	}
}





#####################################################################
# Error 2
#
# If, for some reason, a STORABLE_attach object is accidentally stored
# with references, this should be checked and and error should be throw.



# Good Case - should not die
{
	my $goodthaw = bless {}, &#39;My::GoodThaw&#39;;
	my $frozen = undef;
	eval {
		$frozen = Storable::freeze&#40; $goodthaw &#41;;
	};
	ok&#40; $frozen, &#39;Storable freezes to a string as expected&#39; &#41;;
	my $thawed = eval {
		Storable::thaw&#40; $frozen &#41;;
	};
	isa_ok&#40; $thawed, &#39;My::GoodThaw&#39; &#41;;
	is&#40; $thawed-&gt;{foo}, &#39;bar&#39;, &#39;My::GoodThaw thawed correctly as expected&#39; &#41;;

	package My::GoodThaw;

	sub STORABLE_freeze {
		my &#40;$self, $clone&#41; = @_;

		return &#40;&#39;&#39;&#41;;
	}

	sub STORABLE_attach {
		my &#40;$class, $clone, $string&#41; = @_;
		return bless { &#39;foo&#39; =&gt; &#39;bar&#39; }, &#39;My::GoodThaw&#39;;
	}
}



# Bad Case - should die on thaw
{
	# Create the frozen string normally
	my $badthaw = bless { }, &#39;My::BadThaw&#39;;
	my $frozen = undef;
	eval {
		$frozen = Storable::freeze&#40; $badthaw &#41;;
	};
	ok&#40; $frozen, &#39;BadThaw was frozen with references correctly&#39; &#41;;

	# Set up the error condition by deleting the normal STORABLE_thaw,
	# and creating a STORABLE_attach.
	*My::BadThaw::STORABLE_attach = *My::BadThaw::STORABLE_thaw;
	*My::BadThaw::STORABLE_attach = *My::BadThaw::STORABLE_thaw; # Suppress a warning
	delete ${&#39;My::BadThaw::&#39;}{STORABLE_thaw};

	# Trigger the error condition
	my $thawed = undef;
	eval {
		$thawed = Storable::thaw&#40; $frozen &#41;;
	};
	ok&#40; $@, &#39;My::BadThaw object dies when thawing as expected&#39; &#41;;
	# Check for a snippet from the error message
	ok&#40; $@ =~ /unexpected references/, &#39;Dies with the expected error message&#39; &#41;;

	package My::BadThaw;

	sub STORABLE_freeze {
		my &#40;$self, $clone&#41; = @_;

		return &#40;&#39;&#39;, []&#41;;
	}

	# Start with no STORABLE_attach method so we can get a
	# frozen object-containing-a-reference into the freeze string.
	sub STORABLE_thaw {
		my &#40;$class, $clone, $string&#41; = @_;
		return bless { &#39;foo&#39; =&gt; &#39;bar&#39; }, &#39;My::BadThaw&#39;;
	}
}




#####################################################################
# Error 3
#
# Die if what is returned by STORABLE_attach is not something of that class



# Good Case - should not die
{
	my $goodattach = bless { }, &#39;My::GoodAttach&#39;;
	my $frozen = Storable::freeze&#40; $goodattach &#41;;
	ok&#40; $frozen, &#39;My::GoodAttach return as expected&#39; &#41;;
	my $thawed = eval {
		Storable::thaw&#40; $frozen &#41;;
	};
	isa_ok&#40; $thawed, &#39;My::GoodAttach&#39; &#41;;
	is&#40; ref&#40;$thawed&#41;, &#39;My::GoodAttach::Subclass&#39;,
		&#39;The slightly-tricky good &#34;returns a subclass&#34; case returns as expected&#39; &#41;;

	package My::GoodAttach;

	sub STORABLE_freeze {
		my &#40;$self, $cloning&#41; = @_;
		return &#40;&#39;&#39;&#41;;
	}

	sub STORABLE_attach {
		my &#40;$class, $cloning, $string&#41; = @_;

		return bless { }, &#39;My::GoodAttach::Subclass&#39;;
	}

	package My::GoodAttach::Subclass;

	BEGIN {
		@ISA = &#39;My::GoodAttach&#39;;
	}
}



# Bad Cases - die on thaw
{
	my $returnvalue = undef;

	# Create and freeze the object
	my $badattach = bless { }, &#39;My::BadAttach&#39;;
	my $frozen = Storable::freeze&#40; $badattach &#41;;
	ok&#40; $frozen, &#39;BadAttach freezes as expected&#39; &#41;;

	# Try a number of different return values, all of which
	# should cause Storable to die.
	my @badthings = &#40;
		undef,
		&#39;&#39;,
		1,
		[],
		{},
		\&#34;foo&#34;,
		&#40;bless { }, &#39;Foo&#39;&#41;,
		&#41;;
	foreach &#40; @badthings &#41; {
		$returnvalue = $_;

		my $thawed = undef;
		eval {
			$thawed = Storable::thaw&#40; $frozen &#41;;
		};
		ok&#40; $@, &#39;BadAttach dies on thaw&#39; &#41;;
		ok&#40; $@ =~ /STORABLE_attach did not return a My::BadAttach object/,
			&#39;BadAttach dies on thaw with the expected error message&#39; &#41;;
		is&#40; $thawed, undef, &#39;Double checking $thawed was not set&#39; &#41;;
	}
	
	package My::BadAttach;

	sub STORABLE_freeze {
		my &#40;$self, $cloning&#41; = @_;
		return &#40;&#39;&#39;&#41;;
	}

	sub STORABLE_attach {
		my &#40;$class, $cloning, $string&#41; = @_;

		return $returnvalue;
	}
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95212" href="/Public/Bug/Display.html?id=4901#txn-95212">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;11&nbsp;12:06:21&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> natg [...] shore.net</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/95212/32438/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32438">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fascinating discussion but I think itÂ’s gotten a little off track.  
[By way of introduction, IÂ’m the Â‘guestÂ’ who posed the initial bug 
report.  We have  a persistent object store &#40;Class::AutoDB&#41; that uses 
Data::Dumper.  We want to make this work on all reasonable 
serialization engines, including Storable and YAML.]

A thaw hook, in any scheme, needs two pieces of information: the 
serialized form to be thawed, and a unique identifier for the 
reference being thawed &#40;to break cycles among other things&#41;.  In 
Storable, the unique identifier is the refaddr of the empty object 
created by the engine.  This is an elegant approach that works in many 
cases. The problem comes from ASSUMING that the empty object will 
always become the real object.  The solution is to let the thaw hook 
decide whether it can use the empty object or whether it needs to use 
something else.  The engine is not seriously affected by this decision 
for the simple reason that there is no logical connection between the 
objects passed from engine to hook and the objects put by the hook 
into the output data structure. 

Turning to SAMVÂ’s example:
----------
Â… the structure will be stored as the logical;

  $o = { foo =&gt; &#34;bar&#34;,
    superset =&gt; \[ $o, { bar =&gt; &#34;baz&#34; } ]
  }
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">______
Assuming $o has a thaw hook, it will be called first for the outer 
reference.  The engine will pass in an empty object with refaddr, say 
12345.  The hook should record this information &#40;in a hash, typically&#41; 
to say Â“IÂ’ve been seenÂ”.  If the hook wants to use an object of its 
own choosing, it associates this object with the refaddr.  Then it 
calls the Storable engine to continue thawing.  The hook will be 
called again on the inner reference.  Again, the engine will pass in 
12345. This time the hook will know itÂ’s been seen before and &#40;1&#41; 
break the cycle by not calling the engine, and &#40;2&#41; return the object 
previously associated with refaddr 12345.  

The only change thatÂ’s needed in the Storable code is to pay attention 
to the object returned by the thaw hook and put it into the thawed 
data structure.  Nothing else has to change! 

What have I missed?

Best,
Nat Goodman
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95213" href="/Public/Bug/Display.html?id=4901#txn-95213">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;11&nbsp;22:01:13&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/95213/32452/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32452">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Turning to SAMVÂ’s example:
&gt; ----------
&gt; Â… the structure will be stored as the logical;
&gt; 
&gt;   $o = { foo =&gt; &#34;bar&#34;,
&gt;     superset =&gt; \[ $o, { bar =&gt; &#34;baz&#34; } ]
&gt;   }
&gt; ______
&gt; Assuming $o has a thaw hook, it will be called first for the outer 
&gt; reference.
&gt;
&gt; What have I missed?
</div>
The hook is NOT called for the outer reference first. That is what you
have missed.

Grab the circular_hooks.t test script I attached earlier, which
demonstrates this. Run through it in the debugger if you like.

The key problem is that in order to call the hook, we need to have any
references it might have stored in STORABLE_freeze. THOSE references may
have other references in them, that eventually circular back to the same
object.

So in order to do it in one pass, the following steps have to occur.

1. Create stub &#40;the object currently passed to STORABLE_thaw&#41; for the
outer object.

2. Start to parse the refs inside the outer &#40;descending&#41;

3. Create placeholder for inner object.

4. Start to parse the refs inside the inner.

5. Encounter the ref back to the outer, create the ref to the stub for
the outer.

6. Call STORABLE_thaw for the inner, passing it the ref to the stub for
the outer.

7. Call STORABLE_thaw for the outer, passing it the ref to the inner.

------------------------------------------

So in other words, STORABLE_thaw has to be called depth-first, but in
order to handle circulars, but the stub objects need to be created
before descending.

There are only two ways of avoiding this problem.

1. Store the replacement object in a lookup hash as we go, and then do a
second pass over the thawed struct and replace all refs to the stub with
refs to the replacement.

2. Guarentee that you will never have circular references below the object.

Doing 1. would be touchy to say the least, and might significantly
impact on the performance of Storable itself, especially if lots of
classes started to use it. My spidey senses are also tingling that there
are some additional corner cases that would be very problematic.

Doing 2. is nicely self-contained and solves as big a proportion of the
problem space as possible, without impacting on the existing users.

So I&#39;m going with 2.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95214" href="/Public/Bug/Display.html?id=4901#txn-95214">#</a>      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;12&nbsp;10:21:32&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> natg [...] shore.net</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/95214/32461/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32461">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 595b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; What have I missed?
</div>&gt; 
&gt; The hook is NOT called for the outer reference first. That is 
&gt; what you have missed.
</div>
Sorry.  I should have checked your test more carefully.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2. Guarentee that you will never have circular references 
&gt; below the object.
&gt; ...
&gt; So I&#39;m going with 2.
</div>
NOOOOO!!!!!  This is wrong!  Who can guarantee that their object 
structures are cycle-free?  It&#39;s better to leave it the way it is!! 

Please give me a few days to ponder the problem.  &#40;I have a big 
deadline at work on Monday and may not be able to give this enough 
attention over the weekend.&#41; 

Best,
Nat
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95215" href="/Public/Bug/Display.html?id=4901#txn-95215">#</a>      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;12&nbsp;14:37:07&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> natg [...] shore.net</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/95215/32466/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32466">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I scraped together some time to look at this further.  

ThereÂ’s actually a deeper problem with the current design: if the 
structure is circular, the Â‘side referencesÂ’ Â– by which I mean the 
extra references returned by STORABLE_freeze Â– are not guaranteed to 
be thawed by the time the thaw hook is called. 

The problem is obvious: if the freeze hook for object $a returns $a 
itself as a side reference, it is impossible for the side reference to 
$a to be thawed before the thaw hook for $a is called, because the 
thaw hook is the guy who thaws $a!  The engine currently hands back a 
reference to $a, but the referent object is not valid.  In an object 
oriented setting, this is a recipe for some very subtle bugs!

IÂ’ve attached a small test program that demonstrates this obvious 
point.

The conclusion is that freeze/thaw hooks and side references are 
incompatible features.  In your sweep of CPAN modules that use 
STORABLE_thaw, did you find any that use side references?  Since no 
one has reported this bug yet, it probably means that no one is using 
the combination, or, at least, no one is doing anything fancy with it.

If side references arenÂ’t being used, weÂ’re back to the simpler case 
in which the thaw hook can be called top-down, and it will work to let 
the thaw hook return an object of its own choosing.

Best,
Nat
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/95215/32467/side_reference.t">Download side_reference.t</a><br />
<span class="downloadcontenttype">text/x-perl 900b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use Storable &#40;&#41;;
use Test::More tests =&gt; 4;

my $a=new Foo&#40;&#39;a&#39;&#41;;
my $string = Storable::freeze&#40; $a &#41;;
my $thawed = Storable::thaw&#40; $string &#41;;

is&#40;ref $thawed,ref $a,&#34;Thawed class correct&#34;&#41;;
is&#40;$thawed-&gt;{name},$a-&gt;{name},&#34;Thawed name correct&#34;&#41;;

exit;

package Foo;
use Test::More;

sub new {
  my $class=shift;
  $class=&#40;ref $class&#41;||$class;
  my $self=bless {name=&gt;$_[0]},$class; 
}  

sub STORABLE_freeze {
  my &#40;$self, $clone&#41; = @_;
  my $class = ref $self;
  print &#34;# Freezing $class\n&#34;;
  return &#40;$self-&gt;{name},$self&#41;;	
}

sub STORABLE_thaw {
  my &#40;$self, $clone, $string, @refs&#41; = @_; 
  my $class = ref $self;
  print &#34;# Thawing $class\n&#34;;
  my $thawed_ref=$refs[0];
  my&#40;$thawed_name&#41;=$string;

  is&#40;$thawed_ref,$self,&#34;Thawed ref points to thawed object&#34;&#41;;
  is&#40;$thawed_ref-&gt;{name},$thawed_name,&#34;Thawed ref contains correct name&#34;&#41;;

  $self-&gt;{name}=$thawed_name;
  return;
}

1;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95216" href="/Public/Bug/Display.html?id=4901#txn-95216">#</a>      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;12&nbsp;23:12:59&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/95216/32471/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32471">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Sat Mar 12 14:37:07 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I scraped together some time to look at this further.  
&gt; 
&gt; ThereÂ’s actually a deeper problem with the current design: if the 
&gt; structure is circular, the Â‘side referencesÂ’ Â– by which I mean the 
&gt; extra references returned by STORABLE_freeze Â– are not guaranteed to 
&gt; be thawed by the time the thaw hook is called. 
</div>
Bingo. In a circular topology, you MUST initialise one before the other,
and the current side reference solutions allows Storable to remain
single-pass and sane.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The conclusion is that freeze/thaw hooks and side references are 
&gt; incompatible features.  In your sweep of CPAN modules that use 
&gt; STORABLE_thaw, did you find any that use side references?  Since no 
&gt; one has reported this bug yet, it probably means that no one is using 
&gt; the combination, or, at least, no one is doing anything fancy with it.
&gt; 
&gt; If side references arenÂ’t being used, weÂ’re back to the simpler case 
&gt; in which the thaw hook can be called top-down, and it will work to let 
&gt; the thaw hook return an object of its own choosing.
</div>
It isn&#39;t so much the DIRECT use of circular references, as it is the
unknown nature of these things. If I have a basic collection/ARRAY type
object, all it cares about, and all it NEEDS to care about, is that it
can store the things inside it.

If those things contain references to other things and so on until 15
references down the chain you finally get back to something near the
top, then you are going to have a circular situation. BUT it is likely
to be one that is both legal, and can be handled by hooks cleanly.

Admittedly doing REALLY close in things where the thaw hooks depend
deeply on the child references &#40;not just that they exist at all&#41; is
incompatible. But I would suggest that nobody is doing that, otherwise
they would have a problem.

Most of the CPAN uses fall into that category. They don&#39;t appear to use
them directly, but they concievably might down the line.

The bigger issue is the implementation problem... somehow &#34;banning&#34;
hooks in situations where there are circulars would be hard as it might
not the classes fault, so it could work sometimes and die others.
Remember that we might have large structure with quite a diverse range
of data and multiple hooked classes. Implementation would be a
nightmare, and since hooks are a &#34;wizards only&#34; feature, there&#39;s an
understanding that you should now how to handle these situations.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95217" href="/Public/Bug/Display.html?id=4901#txn-95217">#</a>      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;12&nbsp;23:16:44&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/95217/32472/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32472">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 809b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; So I&#39;m going with 2.
</div>&gt; 
&gt; NOOOOO!!!!!  This is wrong!  Who can guarantee that their object 
&gt; structures are cycle-free?  It&#39;s better to leave it the way it is!! 
</div>
That&#39;s why we are leaving it the way it is. By not changing the
behaviour of STORABLE_thaw, and adding an additional STORABLE_attach
method, we can guarentee not to break any existing code.

You guarentee the object structure is cycle-free by not allowing ANY
references to be stored in the freeze.

If you have complex data that you still want to go into the freeze, the
recommended way is to re-enter Storable to create the string. Now, if
something underneath the hooked object shares a reference with something
above the hooked object, they WON&#39;T say shared once you thaw.

But it does mean that you can guarentee not to have circulars.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95218" href="/Public/Bug/Display.html?id=4901#txn-95218">#</a>      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;13&nbsp;11:53:35&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> natg [...] shore.net</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/95218/32474/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32474">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the interesting conversation.  As you point out, the 
problem with references to incomplete objects can occur even in the 
absence of side references.

Your STORABLE_attach solution will work quite well if it is called the 
first time the object is seen. Here is a possibly cleaner way to 
package the solution.

1. STORABLE_attach would be called by the engine the first time the 
object is seen.  Its job is to make or choose the thawed 
representation of the object and return it.  This object will not, in 
general, be completely filled in, but STORABLE_attach is expected to 
ensure that the object is at least valid.

2. The engine would add the returned object to the structure it uses 
to map frozen references to thawed ones and proceed as normal. 

3. Later, when the engine is finished with all side references, it 
would call STORABLE_thaw as it does now. STORABLE_thaw would be 
expected to complete the object initialization if any is required.  
&#40;Probably none in your application, but lots in mine.&#41; 

A class can leave either method undefined if does not need that 
capability.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95219" href="/Public/Bug/Display.html?id=4901#txn-95219">#</a>      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;13&nbsp;21:47:02&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/95219/32487/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32487">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">ooooo, much better.

The only issue I see with that case, is that we have to make sure that
BOTH methods get passed the frozen string, so we might have to store the
string away somewhere until it is needed the second time.

I&#39;ve got test cases attached already for &#34;STORABLE_attach AND NOT
STORABLE_thaw&#34; case.

Can you provide a test script that covers the correct &#34;STORABLE_attach
AND STORABLE_thaw&#34; behaviour, so I can double check we are on the same
page here, and to give coraline something to code against?

The other good thing here is that if needed, we can implement this in
two steps. Having an alternative STORABLE_attach as step 1 does not
limit upgrading the implementation to support it being an additional
STORABLE_attach as a step 2.

Since I&#39;m having to pay for the actual XS coding here, and it has been
tough enough to justify an external constractor in any case, I&#39;ll get
coraline to start and get step 1 out the way now, adding an additional
path from 3901 to 4189. Doing step 2 then just means adding a third path
to handle the &#34;both methods&#34; case. But the XS should be in place from
step 1 to largely recycle.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95220" href="/Public/Bug/Display.html?id=4901#txn-95220">#</a>      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;13&nbsp;21:51:22&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/95220/32488/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32488">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 143b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; path from 3901 to 4189. Doing step 2 then just means adding a third path
</div>
That should read &#34;line 3901 to line 4189, in the current version&#34;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95221" href="/Public/Bug/Display.html?id=4901#txn-95221">#</a>      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;13&nbsp;22:37:01&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> natg [...] shore.net</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/95221/32489/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32489">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 998b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The only issue I see with that case, is that we have to make 
&gt; sure that BOTH methods get passed the frozen string, so we 
&gt; might have to store the string away somewhere until it is 
&gt; needed the second time.
</div>
Good point.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Can you provide a test script that covers the correct 
&gt; &#34;STORABLE_attach AND STORABLE_thaw&#34; behaviour, so I can 
&gt; double check we are on the same page here, and to give 
&gt; coraline something to code against?
</div>
Will do.  Tomorrow &#40;Mon Mar 14&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Since I&#39;m having to pay for the actual XS coding here, and it 
&gt; has been tough enough to justify an external constractor in 
&gt; any case...
</div>
How much money are we talking about?  I may be able to contribute 
something.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ll get coraline to start and get step 1 out the 
&gt; way now, adding an additional path from 3901 to 4189. Doing 
&gt; step 2 then just means adding a third path to handle the 
&gt; &#34;both methods&#34; case. But the XS should be in place from step 
&gt; 1 to largely recycle.
</div>
Sounds like a great plan.

Best,
Nat
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95223" href="/Public/Bug/Display.html?id=4901#txn-95223">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;14&nbsp;22:34:19&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/95223/32532/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32532">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here is the promised test program for &#34;STORABLE_attach AND 
STORABLE_thaw&#34;. The output is

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; perl attach_thaw.t
</div>1..19
# Freezing a
# Freezing b
# Freezing c
# Thawing c
# Thawing b
# Thawing a
ok 1 - structures have same content -- should pass with or without 
attach
not ok 2 - structures are identical -- should only pass when attach is 
working
#     Failed test &#40;attach_thaw.t at line 18&#41;
#          got: &#39;AttachThaw=HASH&#40;0x827f40c&#41;&#39;
#     expected: &#39;AttachThaw=HASH&#40;0x811b154&#41;&#39;
ok 3 - oid2obj correct for object a
ok 4 - correct freeze count &#40;1&#41; for object a
not ok 5 - correct attach count &#40;1&#41; for object a -- should only pass 
when attach is working
#     Failed test &#40;attach_thaw.t at line 24&#41;
#          got: undef
#     expected: &#39;1&#39;
ok 6 - correct thaw count &#40;1&#41; for object a
ok 7 - oid2obj correct for object b
ok 8 - correct freeze count &#40;1&#41; for object b
not ok 9 - correct attach count &#40;1&#41; for object b -- should only pass 
when attach is working
#     Failed test &#40;attach_thaw.t at line 24&#41;
#          got: undef
#     expected: &#39;1&#39;
ok 10 - correct thaw count &#40;1&#41; for object b
ok 11 - oid2obj correct for object c
ok 12 - correct freeze count &#40;1&#41; for object c
not ok 13 - correct attach count &#40;1&#41; for object c -- should only pass 
when attach is working
#     Failed test &#40;attach_thaw.t at line 24&#41;
#          got: undef
#     expected: &#39;1&#39;
ok 14 - correct thaw count &#40;1&#41; for object c
# Thawing c
# Thawing b
# Thawing a
ok 15 - structures have same content -- should pass with or without 
attach
ok 16 - structures are not identical -- should pass with or without 
attach
not ok 17 - oid2obj correct for thawed object a -- should only pass 
when attach is working
#     Failed test &#40;attach_thaw.t at line 36&#41;
#          got: undef
#     expected: &#39;AttachThaw=HASH&#40;0x82bf444&#41;&#39;
not ok 18 - oid2obj correct for thawed object b -- should only pass 
when attach is working
#     Failed test &#40;attach_thaw.t at line 36&#41;
#          got: undef
#     expected: &#39;AttachThaw=HASH&#40;0x818fa14&#41;&#39;
not ok 19 - oid2obj correct for thawed object c -- should only pass 
when attach is working
#     Failed test &#40;attach_thaw.t at line 36&#41;
#          got: undef
#     expected: &#39;AttachThaw=HASH&#40;0x82bf044&#41;&#39;
# Looks like you failed 7 tests of 19.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/95223/32533/attach_thaw.t">Download attach_thaw.t</a><br />
<span class="downloadcontenttype">text/x-perl 2.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use Storable &#40;&#41;;
use Test::More tests =&gt; 19;
use Test::Deep;

my $a=new AttachThaw&#40;&#39;a&#39;,1&#41;;
my $b=new AttachThaw&#40;&#39;b&#39;,2&#41;;
my $c=new AttachThaw&#40;&#39;c&#39;,3&#41;;
# Link objects into a cycle
$a-&gt;{next}=$b;
$b-&gt;{next}=$c;
$c-&gt;{next}=$a;

my $string=Storable::freeze&#40;$a&#41;;    # freeze entire structure
my $thawed=Storable::thaw&#40;$string&#41;; # get it back

cmp_deeply&#40;$thawed,$a,&#34;structures have same content -- should pass with or without attach&#34;&#41;;
is&#40;$thawed,$a,&#34;structures are identical -- should only pass when attach is working&#34;&#41;;

for my $obj &#40;$a,$b,$c&#41; {
  my&#40;$name,$oid&#41;=@$obj{qw&#40;name oid&#41;};
  is&#40;$AttachThaw::oid2obj{$oid},$obj,&#34;oid2obj correct for object $name&#34;&#41;;
  is&#40;$AttachThaw::oid2freeze{$oid},1,&#34;correct freeze count &#40;1&#41; for object $name&#34;&#41;;
  is&#40;$AttachThaw::oid2attach{$oid},1,&#34;correct attach count &#40;1&#41; for object $name -- should only pass when attach is working&#34;&#41;;
  is&#40;$AttachThaw::oid2thaw{$oid},1,&#34;correct thaw count &#40;1&#41; for object $name&#34;&#41;;
}

%AttachThaw::oid2obj=undef;	    # clear memory of objects
my $thawed=Storable::thaw&#40;$string&#41;; #   and get structure again
cmp_deeply&#40;$thawed,$a,&#34;structures have same content -- should pass with or without attach&#34;&#41;;
isnt&#40;$thawed,$a,&#34;structures are not identical -- should pass with or without attach&#34;&#41;;

my $obj=$thawed;
for my $i &#40;1..3&#41; {
  my&#40;$name,$oid&#41;=@$obj{qw&#40;name oid&#41;};
  is&#40;$AttachThaw::oid2obj{$oid},$obj,&#34;oid2obj correct for thawed object $name -- should only pass when attach is working&#34;&#41;;
  $obj=$obj-&gt;{next};
}
exit;

package AttachThaw;
                                # Note: &#39;oid&#39; stands for &#39;object id&#39;
our %oid2obj;			# Used by attach to recreate shared structure
our %oid2freeze;		# Number of freezes
our %oid2attach;		# Number of attaches
our %oid2thaw;			# Number of thaws

sub new {
  my $class=shift;
  $class=&#40;ref $class&#41;||$class;
  my&#40;$name,$oid&#41;=@_;
  my $self=bless {name=&gt;$name,oid=&gt;$oid},$class; 
  $oid2obj{$oid}=$self;		# Remember object for attach
  return $self;
}  

sub STORABLE_freeze {
  my &#40;$self,$clone&#41;=@_;
  my&#40;$name,$next,$oid&#41;=@$self{qw&#40;name next oid&#41;};
  print &#34;# Freezing $name\n&#34;;
  $oid2freeze{$oid}++;
  return &#40;join&#40;$;,$name,$oid&#41;,$next&#41;; # Obviously not completely general...
}

sub STORABLE_attach {
  my &#40;$class,$string&#41; = @_; 
  my&#40;$name,$oid&#41;=split&#40;$;,$string&#41;;
  print &#34;# Attaching $name\n&#34;;
  $oid2attach{$oid}++;
  my $object=$oid2obj{$oid};	# Get existing object, if any
  unless &#40;$object&#41; {		# Object does not yet exist
    $object=bless {},$class;	#   so make new empty one
                                # Note that content filled in by thaw
    $oid2obj{$oid}=$object;	# Remember object for next time
  }
  return $object;
}

sub STORABLE_thaw {
  my &#40;$self, $clone, $string, @refs&#41; = @_; 
  my&#40;$name,$oid&#41;=split&#40;$;,$string&#41;;
  print &#34;# Thawing $name\n&#34;;
  $oid2thaw{$oid}++;
  my $next=$refs[0];	# 

  @$self{qw&#40;name next oid&#41;}=&#40;$name,$next,$oid&#41;;
  return;
}

1;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95224" href="/Public/Bug/Display.html?id=4901#txn-95224">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;24&nbsp;21:54:49&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">45 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/95224/32902/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32902">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 230b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">See attached draft patch for step 1 against Storable 2.13.

Unfortunately, some of the tests were returning false positives, so I&#39;ve
modified them slightly to test more explicitly.

So parts of attach_singleton.t will fail tests.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/95224/32903/attach.patch">Download attach.patch</a><br />
<span class="downloadcontenttype">text/x-diff 17k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95225" href="/Public/Bug/Display.html?id=4901#txn-95225">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;31&nbsp;21:16:09&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/95225/33196/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/33196">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 242b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Find attached second version of step 1 patch.

I&#39;ll be checking this shortly to ensure it works as expected. Once I&#39;m
comfortable you should be able to merge and release.

If anyone else wants to take a look at is as well, feel free to do so.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/95225/33197/attach.patch">Download attach.patch</a><br />
<span class="downloadcontenttype">text/x-diff 17.1k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95226" href="/Public/Bug/Display.html?id=4901#txn-95226">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;31&nbsp;21:50:55&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/95226/33199/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/33199">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 299b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ll be checking this shortly to ensure it works as expected. Once I&#39;m
&gt; comfortable you should be able to merge and release.
</div>
Patch looks good to me. I&#39;m happy for merge and 2.14 release for this
patch. I think the only think it lacks is the actual 2.14 version
increment and Changes file entry?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95227" href="/Public/Bug/Display.html?id=4901#txn-95227">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;31&nbsp;21:55:26&nbsp;2005</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/95227/33200/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/33200">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 620b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Moving on to step 2, Simon Cozens just emailed the following.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt;    Something seems wrong with the test you sent for step 2;
&gt; I have attach and thaw both being called as expected, but
&gt; I don&#39;t see how the test is expected to work. If, as I
&gt; understand it, each object should have attach and then
&gt; thaw called on it in turn, you&#39;re going to end up with 
&gt; the object &#34;C&#34;&#39;s next point not correctly pointing to 
&gt; anything because object &#34;A&#34; is created from scratch.
&gt;    Could you have a look over it and see if you think
&gt; the test is sound?
&gt; Also, we still didn&#39;t agree a price for this one.
&gt;
&gt; Simon
</div>
Nat?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95228" href="/Public/Bug/Display.html?id=4901#txn-95228">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;01&nbsp;10:26:19&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> natg [...] shore.net</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/95228/33209/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/33209">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Simon

I donÂ’t think I understand your question.  Is it an issue with the 
first part of the test &#40;lines 15-27&#41; or the second part &#40;lines 28-38&#41;?

HereÂ’s how I think the attach/thaw capability is supposed to work

1.  attach is called the first time the object is seen during the de-
serialization.  Its job is to define the mapping from StorableÂ’s 
internal reference ids &#40;sorry, I donÂ’t what these are called&#41; to 
actual Perl references that exist in the client program&#39;s memory.  In 
the test program, the Perl references are found in %oid2obj or created 
from scratch if the object does not yet exist.

2.  thaw is called after all side references have been de-serialized.  
Its job is to fill in the content of the object based on the 
serialization string and the side references.

The client program can define or omit either method.  If no attach 
method is provided, Storable works exactly as it does now &#40;of course Â– 
backwards compatibility!!&#41;.  If thereÂ’s an attach but no thaw, the 
client has to do all the work in attach; this makes sense if there are 
no side references. 

If I missed the point, please ask againÂ…  IÂ’d also be happy to discuss 
by phone.

Thanks,
Nat

[ADAMK - Thu Mar 31 21:55:26 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Moving on to step 2, Simon Cozens just emailed the following.
&gt; 
<div class="message-stanza open">&gt; &gt; Hi,
&gt; &gt;    Something seems wrong with the test you sent for step 2;
&gt; &gt; I have attach and thaw both being called as expected, but
&gt; &gt; I don&#39;t see how the test is expected to work. If, as I
&gt; &gt; understand it, each object should have attach and then
&gt; &gt; thaw called on it in turn, you&#39;re going to end up with 
&gt; &gt; the object &#34;C&#34;&#39;s next point not correctly pointing to 
&gt; &gt; anything because object &#34;A&#34; is created from scratch.
&gt; &gt;    Could you have a look over it and see if you think
&gt; &gt; the test is sound?
&gt; &gt; Also, we still didn&#39;t agree a price for this one.
&gt; &gt;
&gt; &gt; Simon
</div>&gt; 
&gt; Nat?
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-95229" href="/Public/Bug/Display.html?id=4901#txn-95229">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;03&nbsp;22:18:15&nbsp;2005</span>
    <span class="description">ams [...] wiw.org -  Cc simon@simon-cozens.org added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 1.37166</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
