<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #31556 for Class-Prototyped: Doesn&#39;t work with 5.10</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #31556 for Class-Prototyped: Doesn&#39;t work with 5.10</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Class-Prototyped/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Class-Prototyped/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Class-Prototyped/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Class-Prototyped/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Class-Prototyped">Class-Prototyped CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">31556</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Class-Prototyped/Active/">Class-Prototyped</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">TEVERETT [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ANDK [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-7224-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.10    </td>
  </tr>
  <tr id="CF-7225-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.11    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;15&nbsp;00:14:26&nbsp;2007</span>
    <span class="description">ANDK [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Doesn&#39;t work with 5.10</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span class="clickylink"><a target="new" rel="nofollow" href="http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/2007-12/msg00308.html">http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/2007-12/msg00308.html</a></span>


The posting describes that patch 30980 to bleadperl broke Class::Prototyped.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;15&nbsp;15:59:54&nbsp;2007</span>
    <span class="description">toby [...] ovod-everett.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #31556] Doesn&#39;t work with 5.10</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 15 Dec 2007 11:59:10 -0900</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Andreas Koenig via RT &lt;bug-Class-Prototyped [...] rt.cpan.org&gt;, perl5-porters [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Toby Ovod-Everett &lt;toby [...] ovod-everett.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry I&#39;ve been playing an ostrich for a while - sort of hoping the bug would
break something else and I wouldn&#39;t have to subject my poor skull to the pain
of poking back into Class::Prototyped.  Luckily, it didn&#39;t take me very long
to find a workaround.

I can fix Class::Prototyped &#40;at least it passes the whole test suite&#41; with a
single line:

@@ -1120,6 +1120,7 @@
                                #Defends against ISA caching problems
                                no strict &#39;refs&#39;;
                                delete ${&#34;$package\::&#34;}{&#39;::ISA::CACHE::&#39;};
+                               @$isa = @$isa;
                        }
                        splice&#40;@$parentOrder, $splice_point, 0, $slotName&#41;;
                }

It didn&#39;t take me long to come up with that line because we &#40;Ned Konz and I&#41;
had this problem in the past and we fixed it using this approach at that time.
The problem is that using splice to modify @ISA &#40;in this case, $isa is an
alias&#41; doesn&#39;t work properly.  I know this was a problem in the past - I have
a vague recollection of being in Vancouver for the Folk Music Festival in 2001
&#40;I think it was 2001&#41; and meeting up with the folks from ActiveState and
mentioning to Gurusamy that we had to hack around the using splice with @ISA,
and he replied that it was probably a bug.  I think it must have gotten fixed
at some point, because that code is no longer in Class::Prototyped and it&#39;s
been passing test suites for 5.6 and 6.8 for sometime.  I&#39;m guessing that the
patches you identified must have somehow broken the behavior of splice on @ISA.

I don&#39;t have a problem doing a release of Class::Prototyped to fix this issue
if that&#39;s the preferred approach.  On the other hand, if it&#39;s preferable to
fix splice for @ISA, that&#39;s another solution!  :-&#41;

Please cc me on any followup to this e-mail as I&#39;m not on the perl5-porters
mailing list.

Thanks,
--Toby Ovod-Everett




On Sat, Dec 15, 2007 at 12:14:38AM -0500, Andreas Koenig via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Sat Dec 15 00:14:26 2007: Request 31556 was acted upon.
&gt; Transaction: Ticket created by ANDK
&gt;        Queue: Class-Prototyped
&gt;      Subject: Doesn&#39;t work with 5.10
&gt;    Broken in: 1.10
&gt;     Severity: Critical
&gt;        Owner: Nobody
&gt;   Requestors: ANDK@cpan.org
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=31556">http://rt.cpan.org/Ticket/Display.html?id=31556</a></span> &gt;
&gt; 
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/2007-12/msg00308.html">http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/2007-12/msg00308.html</a></span>
&gt; 
&gt; 
&gt; The posting describes that patch 30980 to bleadperl broke Class::Prototyped.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;15&nbsp;15:59:56&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;16&nbsp;11:58:50&nbsp;2007</span>
    <span class="description">toby [...] ovod-everett.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> 7+793 [...] ovod-everett.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #31556] Doesn&#39;t work with 5.10</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 16 Dec 2007 07:58:24 -0900</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;toby [...] ovod-everett.org via RT&#34; &lt;bug-Class-Prototyped [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Toby Ovod-Everett &lt;toby [...] ovod-everett.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here&#39;s the information I was able to track down on the @ISA issues we ran into
back in 2001.  Turns out chromatic tracked down the resolution we&#39;ve been
using ever since then.  In 0.10, I found the @$isa = @$isa code &#40;had to track
down those versions in e-mails Ned and I sent each other&#41;.  In 0.11 it was
gone.  And then I found the following messages:


======BEGIN MESSAGE======
From: chromatic
Date: Sat, 14 Jul 2001 12:34:24 -0600
Subject: More @ISA Fun

I couldn&#39;t believe that manipulating @ISA was broken in 5.005, so I put
together a series of tests.  It points to something wrong with isa&#40;&#41;.  I get
the same results on 5.6.0.

The attached file puts together two dummy packages and an object.  It goes
through a few different ways to manipulate the object&#39;s @ISA.  That works for
the method dispatch, but it never seems to invalidate the cache isa&#40;&#41; uses.

The output should be 6 instances of &#39;ok&#39; for expected dispatch successes or
failures.  I see isa&#40;&#41; failures on ref_isa&#40;&#41; and direct assignment.

Additionally, after all of the manipulations, there&#39;s a check to see if the
initial contents of @ISA are still in the isa&#40;&#41; cache.  Unfortunately, they
are, so it displays &#34;Really bad caching!&#34;.

I&#39;m curious to see your results.

-- c

#!/usr/bin/perl -w

use strict;

package Zot;

package Foo;

sub foo { }

package Bar;
# works even without declaring
use vars qw&#40; @ISA &#41;;
@ISA = &#40; &#39;Zot&#39; &#41;;

sub new {
        bless&#40;{}, $_[0]&#41;;
}

sub bar {}

sub plain_isa {
        shift;
        @Bar::ISA = @_;
}

my $isa = \@Bar::ISA;
sub ref_isa {
        shift;
        @$isa = @_;
}

package main;

# set up object, attempt normal dispatch
my $bar = Bar-&gt;new&#40;&#41;;
$bar-&gt;bar&#40;&#41;;

# check isa&#40;&#41; to start
print &#34;ISA: &#40;@Bar::ISA&#41;\n&#34;;
print &#34;ok\n\n&#34; if $bar-&gt;isa&#40;&#39;Zot&#39;&#41;;

# check inheritance, call should fail
print &#34;ISA: &#40;@Bar::ISA&#41;\n&#34;;
eval { $bar -&gt; foo&#40;&#41; };
warn &#34;isa&#40;&#41; failed initially!\n&#34; if $bar-&gt;isa&#40;&#39;Foo&#39;&#41;;
print &#34;ok\n\n&#34; if &#40;$@ =~ /^Can&#39;t locate object method &#34;foo&#34;/&#41;;

# add parent via ref to @ISA, call should succeed
$bar-&gt;ref_isa&#40;&#39;Foo&#39;&#41;;
print &#34;ISA: &#40;@Bar::ISA&#41;\n&#34;;
eval { $bar -&gt; foo&#40;&#41; };
warn &#34;isa&#40;&#41; failed after ref_isa&#40;&#41;!\n&#34; unless $bar-&gt;isa&#40;&#39;Foo&#39;&#41;;
print &#34;ok\n\n&#34; unless $@;

# remove parent via direct assignment, call should fail
$bar-&gt;plain_isa&#40;&#41;;
print &#34;ISA: &#40;@Bar::ISA&#41;\n&#34;;
eval { $bar -&gt; foo&#40;&#41; };
warn &#34;isa&#40;&#41; failed after plain_isa&#40;&#41;!\n&#34; if $bar-&gt;isa&#40;&#39;Foo&#39;&#41;;
print &#34;ok\n\n&#34; if &#40;$@ =~ /^Can&#39;t locate object method &#34;foo&#34;/&#41;;

# manipulate inheritance directoy
@Bar::ISA = qw&#40; Foo &#41;;
print &#34;ISA: &#40;@Bar::ISA&#41;\n&#34;;
eval { $bar -&gt; foo&#40;&#41; };
warn &#34;isa&#40;&#41; failed in direct!\n&#34; unless $bar-&gt;isa&#40;&#39;Foo&#39;&#41;;
print &#34;ok\n\n&#34; unless $@;

# manipulate via symref in another package
{
        no strict &#39;refs&#39;;
        @{ ref&#40;$bar&#41; . &#39;::ISA&#39; } = &#40;&#41;;
}

print &#34;ISA: &#40;@Bar::ISA&#41;\n&#34;;
eval { $bar -&gt; foo&#40;&#41; };
warn &#34;isa&#40;&#41; failed!\n&#34; if $bar-&gt;isa&#40;&#39;Foo&#39;&#41;;
warn &#34;Really bad caching!\n&#34; if $bar-&gt;isa&#40;&#39;Zot&#39;&#41;;
print &#34;ok\n\n&#34; if &#40;$@ =~ /^Can&#39;t locate object method &#34;foo&#34;/&#41;;


=======END MESSAGE=======


======BEGIN MESSAGE======

From: Ned Konz
Subject: Re: More @ISA Fun
Date: Sat, 14 Jul 2001 12:46:27 -0700


On Saturday 14 July 2001 11:34 am, you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I couldn&#39;t believe that manipulating @ISA was broken in 5.005, so I put
&gt; together a series of tests.  It points to something wrong with isa&#40;&#41;.  I
&gt; get the same results on 5.6.0.
</div>
Except that it works under 5.6.1 just fine. Ugh. I just installed 5.005 to
test with. Of course, both Toby and I have been testing &#40;mostly&#41; under 5.6.1.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The attached file puts together two dummy packages and an object.  It goes
&gt; through a few different ways to manipulate the object&#39;s @ISA.  That works
&gt; for the method dispatch, but it never seems to invalidate the cache isa&#40;&#41;
&gt; uses.
&gt;
&gt; The output should be 6 instances of &#39;ok&#39; for expected dispatch successes or
&gt; failures.  I see isa&#40;&#41; failures on ref_isa&#40;&#41; and direct assignment.
&gt;
&gt; Additionally, after all of the manipulations, there&#39;s a check to see if the
&gt; initial contents of @ISA are still in the isa&#40;&#41; cache.  Unfortunately, they
&gt; are, so it displays &#34;Really bad caching!&#34;.
&gt;
&gt; I&#39;m curious to see your results.
</div>
Under 5.005_03:

ISA: &#40;Zot&#41;
ok

ISA: &#40;Zot&#41;
ok

ISA: &#40;Foo&#41;
isa&#40;&#41; failed after ref_isa&#40;&#41;!
ok

ISA: &#40;&#41;
ok

ISA: &#40;Foo&#41;
isa&#40;&#41; failed in direct!
ok

ISA: &#40;&#41;
Really bad caching!
ok

Under 5.6.1:

ISA: &#40;Zot&#41;
ok

ISA: &#40;Zot&#41;
ok

ISA: &#40;Foo&#41;
ok

ISA: &#40;&#41;
ok

ISA: &#40;Foo&#41;
ok

ISA: &#40;&#41;
ok
--
Ned Konz


=======END MESSAGE=======


======BEGIN MESSAGE======

From: chromatic
Date: Sat, 14 Jul 2001 14:11:44 -0600
Subject: Re: More @ISA Fun

On Saturday 14 July 2001 13:46, you wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I couldn&#39;t believe that manipulating @ISA was broken in 5.005, so I put
&gt; &gt; together a series of tests.  It points to something wrong with isa&#40;&#41;.  I
&gt; &gt; get the same results on 5.6.0.
</div>&gt;
&gt; Except that it works under 5.6.1 just fine. Ugh. I just installed 5.005 to
&gt; test with. Of course, both Toby and I have been testing &#40;mostly&#41; under
&gt; 5.6.1.
</div>
Yes, this seems to have come up on p5p last year.

<span class="clickylink"><a target="new" rel="nofollow" href="http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/2000-03/msg02705.html">http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/2000-03/msg02705.html</a></span>

Borrowing from a fix by Nick Ing-Simmons, I&#39;ve created another patch that
fixes that particular nastiness.

My test and t/include.t now both run correctly.

-- c

=======END MESSAGE=======

And, cropping the patch down to some example lines:

======BEGIN PATCH SEGMENT======
@@ -779,7 +793,11 @@

                        my $splice_point = $parent_header ? 0 :
@$parentOrder;
                        splice&#40; @$isa, $splice_point, 0, $parentPackage &#41;;
- @$isa = @$isa; #Defends against ISA caching problems
+                       {
+                               #Defends against ISA caching problems
+                               no strict &#39;refs&#39;;
+                               delete ${&#34;$package\::&#34;}{&#39;::ISA::CACHE::&#39;};
+                       }
                        splice&#40; @$parentOrder, $splice_point, 0, $slot &#41;;
                }
                else {
=======END PATCH SEGMENT=======

So, on July 14, 2001, we changed our workaround for the ISA caching problems
from using @$isa = @$isa to deleting ::ISA::CACHE:: from the namespace.

Which worked for 5.005 through 5.8.  Should I return to @$isa = @$isa?  Or is
there a new approved mechanism for resetting the ISA cache?

--Toby Ovod-Everett
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;16&nbsp;11:59:46&nbsp;2007</span>
    <span class="description">toby [...] ovod-everett.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> perl5-porters [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #31556] Doesn&#39;t work with 5.10</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 16 Dec 2007 07:58:56 -0900</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;toby [...] ovod-everett.org via RT&#34; &lt;bug-Class-Prototyped [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Toby Ovod-Everett &lt;toby [...] ovod-everett.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here&#39;s the information I was able to track down on the @ISA issues we ran into
back in 2001.  Turns out chromatic tracked down the resolution we&#39;ve been
using ever since then.  In 0.10, I found the @$isa = @$isa code &#40;had to track
down those versions in e-mails Ned and I sent each other&#41;.  In 0.11 it was
gone.  And then I found the following messages:


======BEGIN MESSAGE======
From: chromatic
Date: Sat, 14 Jul 2001 12:34:24 -0600
Subject: More @ISA Fun

I couldn&#39;t believe that manipulating @ISA was broken in 5.005, so I put
together a series of tests.  It points to something wrong with isa&#40;&#41;.  I get
the same results on 5.6.0.

The attached file puts together two dummy packages and an object.  It goes
through a few different ways to manipulate the object&#39;s @ISA.  That works for
the method dispatch, but it never seems to invalidate the cache isa&#40;&#41; uses.

The output should be 6 instances of &#39;ok&#39; for expected dispatch successes or
failures.  I see isa&#40;&#41; failures on ref_isa&#40;&#41; and direct assignment.

Additionally, after all of the manipulations, there&#39;s a check to see if the
initial contents of @ISA are still in the isa&#40;&#41; cache.  Unfortunately, they
are, so it displays &#34;Really bad caching!&#34;.

I&#39;m curious to see your results.

-- c

#!/usr/bin/perl -w

use strict;

package Zot;

package Foo;

sub foo { }

package Bar;
# works even without declaring
use vars qw&#40; @ISA &#41;;
@ISA = &#40; &#39;Zot&#39; &#41;;

sub new {
        bless&#40;{}, $_[0]&#41;;
}

sub bar {}

sub plain_isa {
        shift;
        @Bar::ISA = @_;
}

my $isa = \@Bar::ISA;
sub ref_isa {
        shift;
        @$isa = @_;
}

package main;

# set up object, attempt normal dispatch
my $bar = Bar-&gt;new&#40;&#41;;
$bar-&gt;bar&#40;&#41;;

# check isa&#40;&#41; to start
print &#34;ISA: &#40;@Bar::ISA&#41;\n&#34;;
print &#34;ok\n\n&#34; if $bar-&gt;isa&#40;&#39;Zot&#39;&#41;;

# check inheritance, call should fail
print &#34;ISA: &#40;@Bar::ISA&#41;\n&#34;;
eval { $bar -&gt; foo&#40;&#41; };
warn &#34;isa&#40;&#41; failed initially!\n&#34; if $bar-&gt;isa&#40;&#39;Foo&#39;&#41;;
print &#34;ok\n\n&#34; if &#40;$@ =~ /^Can&#39;t locate object method &#34;foo&#34;/&#41;;

# add parent via ref to @ISA, call should succeed
$bar-&gt;ref_isa&#40;&#39;Foo&#39;&#41;;
print &#34;ISA: &#40;@Bar::ISA&#41;\n&#34;;
eval { $bar -&gt; foo&#40;&#41; };
warn &#34;isa&#40;&#41; failed after ref_isa&#40;&#41;!\n&#34; unless $bar-&gt;isa&#40;&#39;Foo&#39;&#41;;
print &#34;ok\n\n&#34; unless $@;

# remove parent via direct assignment, call should fail
$bar-&gt;plain_isa&#40;&#41;;
print &#34;ISA: &#40;@Bar::ISA&#41;\n&#34;;
eval { $bar -&gt; foo&#40;&#41; };
warn &#34;isa&#40;&#41; failed after plain_isa&#40;&#41;!\n&#34; if $bar-&gt;isa&#40;&#39;Foo&#39;&#41;;
print &#34;ok\n\n&#34; if &#40;$@ =~ /^Can&#39;t locate object method &#34;foo&#34;/&#41;;

# manipulate inheritance directoy
@Bar::ISA = qw&#40; Foo &#41;;
print &#34;ISA: &#40;@Bar::ISA&#41;\n&#34;;
eval { $bar -&gt; foo&#40;&#41; };
warn &#34;isa&#40;&#41; failed in direct!\n&#34; unless $bar-&gt;isa&#40;&#39;Foo&#39;&#41;;
print &#34;ok\n\n&#34; unless $@;

# manipulate via symref in another package
{
        no strict &#39;refs&#39;;
        @{ ref&#40;$bar&#41; . &#39;::ISA&#39; } = &#40;&#41;;
}

print &#34;ISA: &#40;@Bar::ISA&#41;\n&#34;;
eval { $bar -&gt; foo&#40;&#41; };
warn &#34;isa&#40;&#41; failed!\n&#34; if $bar-&gt;isa&#40;&#39;Foo&#39;&#41;;
warn &#34;Really bad caching!\n&#34; if $bar-&gt;isa&#40;&#39;Zot&#39;&#41;;
print &#34;ok\n\n&#34; if &#40;$@ =~ /^Can&#39;t locate object method &#34;foo&#34;/&#41;;


=======END MESSAGE=======


======BEGIN MESSAGE======

From: Ned Konz
Subject: Re: More @ISA Fun
Date: Sat, 14 Jul 2001 12:46:27 -0700


On Saturday 14 July 2001 11:34 am, you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I couldn&#39;t believe that manipulating @ISA was broken in 5.005, so I put
&gt; together a series of tests.  It points to something wrong with isa&#40;&#41;.  I
&gt; get the same results on 5.6.0.
</div>
Except that it works under 5.6.1 just fine. Ugh. I just installed 5.005 to
test with. Of course, both Toby and I have been testing &#40;mostly&#41; under 5.6.1.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The attached file puts together two dummy packages and an object.  It goes
&gt; through a few different ways to manipulate the object&#39;s @ISA.  That works
&gt; for the method dispatch, but it never seems to invalidate the cache isa&#40;&#41;
&gt; uses.
&gt;
&gt; The output should be 6 instances of &#39;ok&#39; for expected dispatch successes or
&gt; failures.  I see isa&#40;&#41; failures on ref_isa&#40;&#41; and direct assignment.
&gt;
&gt; Additionally, after all of the manipulations, there&#39;s a check to see if the
&gt; initial contents of @ISA are still in the isa&#40;&#41; cache.  Unfortunately, they
&gt; are, so it displays &#34;Really bad caching!&#34;.
&gt;
&gt; I&#39;m curious to see your results.
</div>
Under 5.005_03:

ISA: &#40;Zot&#41;
ok

ISA: &#40;Zot&#41;
ok

ISA: &#40;Foo&#41;
isa&#40;&#41; failed after ref_isa&#40;&#41;!
ok

ISA: &#40;&#41;
ok

ISA: &#40;Foo&#41;
isa&#40;&#41; failed in direct!
ok

ISA: &#40;&#41;
Really bad caching!
ok

Under 5.6.1:

ISA: &#40;Zot&#41;
ok

ISA: &#40;Zot&#41;
ok

ISA: &#40;Foo&#41;
ok

ISA: &#40;&#41;
ok

ISA: &#40;Foo&#41;
ok

ISA: &#40;&#41;
ok
--
Ned Konz


=======END MESSAGE=======


======BEGIN MESSAGE======

From: chromatic
Date: Sat, 14 Jul 2001 14:11:44 -0600
Subject: Re: More @ISA Fun

On Saturday 14 July 2001 13:46, you wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I couldn&#39;t believe that manipulating @ISA was broken in 5.005, so I put
&gt; &gt; together a series of tests.  It points to something wrong with isa&#40;&#41;.  I
&gt; &gt; get the same results on 5.6.0.
</div>&gt;
&gt; Except that it works under 5.6.1 just fine. Ugh. I just installed 5.005 to
&gt; test with. Of course, both Toby and I have been testing &#40;mostly&#41; under
&gt; 5.6.1.
</div>
Yes, this seems to have come up on p5p last year.

<span class="clickylink"><a target="new" rel="nofollow" href="http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/2000-03/msg02705.html">http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/2000-03/msg02705.html</a></span>

Borrowing from a fix by Nick Ing-Simmons, I&#39;ve created another patch that
fixes that particular nastiness.

My test and t/include.t now both run correctly.

-- c

=======END MESSAGE=======

And, cropping the patch down to some example lines:

======BEGIN PATCH SEGMENT======
@@ -779,7 +793,11 @@

                        my $splice_point = $parent_header ? 0 :
@$parentOrder;
                        splice&#40; @$isa, $splice_point, 0, $parentPackage &#41;;
- @$isa = @$isa; #Defends against ISA caching problems
+                       {
+                               #Defends against ISA caching problems
+                               no strict &#39;refs&#39;;
+                               delete ${&#34;$package\::&#34;}{&#39;::ISA::CACHE::&#39;};
+                       }
                        splice&#40; @$parentOrder, $splice_point, 0, $slot &#41;;
                }
                else {
=======END PATCH SEGMENT=======

So, on July 14, 2001, we changed our workaround for the ISA caching problems
from using @$isa = @$isa to deleting ::ISA::CACHE:: from the namespace.

Which worked for 5.005 through 5.8.  Should I return to @$isa = @$isa?  Or is
there a new approved mechanism for resetting the ISA cache?

--Toby Ovod-Everett
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;17&nbsp;05:55:29&nbsp;2007</span>
    <span class="description">rgarciasuarez [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &#34;toby [...] ovod-everett.org via RT&#34; &lt;bug-Class-Prototyped [...] rt.cpan.org&gt;,  perl5-porters [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #31556] Doesn&#39;t work with 5.10</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 17 Dec 2007 11:55:04 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;Toby Ovod-Everett&#34; &lt;toby [...] ovod-everett.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Rafael Garcia-Suarez&#34; &lt;rgarciasuarez [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 16/12/2007, Toby Ovod-Everett &lt;toby@ovod-everett.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So, on July 14, 2001, we changed our workaround for the ISA caching problems
&gt; from using @$isa = @$isa to deleting ::ISA::CACHE:: from the namespace.
&gt;
&gt; Which worked for 5.005 through 5.8.  Should I return to @$isa = @$isa?  Or is
&gt; there a new approved mechanism for resetting the ISA cache?
</div>
You can probably use a function in the mro package, but the
@$isa=@$isa way to do it is backwards compatible, so you can stick
with it.

ISA::CACHE is no longer used in 5.10. I&#39;ll mention that in perldelta.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;17&nbsp;23:03:05&nbsp;2007</span>
    <span class="description">toby [...] ovod-everett.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Toby Ovod-Everett &lt;toby [...] ovod-everett.org&gt;, &#34;toby [...] ovod-everett.org via RT&#34; &lt;bug-Class-Prototyped [...] rt.cpan.org&gt;, perl5-porters [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #31556] Doesn&#39;t work with 5.10</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 17 Dec 2007 19:01:51 -0900</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Rafael Garcia-Suarez &lt;rgarciasuarez [...] gmail.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Toby Ovod-Everett &lt;toby [...] ovod-everett.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, Dec 17, 2007 at 11:55:04AM +0100, Rafael Garcia-Suarez wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 16/12/2007, Toby Ovod-Everett &lt;toby@ovod-everett.org&gt; wrote:
<div class="message-stanza open">&gt; &gt; So, on July 14, 2001, we changed our workaround for the ISA caching problems
&gt; &gt; from using @$isa = @$isa to deleting ::ISA::CACHE:: from the namespace.
&gt; &gt;
&gt; &gt; Which worked for 5.005 through 5.8.  Should I return to @$isa = @$isa?  Or is
&gt; &gt; there a new approved mechanism for resetting the ISA cache?
</div>&gt; 
&gt; You can probably use a function in the mro package, but the
&gt; @$isa=@$isa way to do it is backwards compatible, so you can stick
&gt; with it.
&gt; 
&gt; ISA::CACHE is no longer used in 5.10. I&#39;ll mention that in perldelta.
</div>
You might also want to mention that the ISA caching behavior has another issue
in it 5.10 that may require the use of mro::method_changed_in or
mro::invalidate_all_method_caches.  In 5.8.8, I can comment out both the
::ISA::CACHE:: code and the @$isa=@$isa code and everything in C::P passes the
test suite.  In 5.10, the @$isa=@$isa line is required to get the test suite
to pass.  We only had the ::ISA::CACHE:: code in C::P to support 5.6.0 and
earlier revs of Perl that had issues with splice being used on @ISA.

It looks like the issue with 5.10 is different than the issue with pre-5.6.1
code.  For instance, the test suite chromatic came up with related to our
issues back then failed with pre-5.6.1 but passes with 5.10.  But the
following test fails under 5.10 and passes under 5.8.8:

=====BEGIN PERL CODE=====
package Foo;
sub foo {
        print &#34;This is Foo::foo\n&#34;;
}

package Bar;
@Bar::ISA = &#40; &#41;;

splice&#40;@Bar::ISA, 0, 0, &#39;Foo&#39;&#41;;

Bar-&gt;foo;
======END PERL CODE======

Interestingly, it appears that using splice on @ISA is only a problem if @ISA
both exists and is empty &#40;took me a while to figure that one out&#41;!

The failure &#40;Can&#39;t locate object method &#34;foo&#34; via package &#34;Bar&#34;&#41; was seen
against:

This is perl, v5.10.0 built for MSWin32-x86-multi-thread
&#40;with 2 registered patches, see perl -V for more detail&#41;

Copyright 1987-2007, Larry Wall

Binary build 1000 [283192] Beta provided by ActiveState
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.ActiveState.com">http://www.ActiveState.com</a></span>
Built Nov 22 2007 14:37:48


Thoughts?  I think I can still download ActiveState builds for 5.005_03, so I
should be able to put together test vectors for 5.005_03, 5.6.0, 5.6.x, 5.8.x,
and 5.10.0 to validate any resolution we come up with.  My preference is first
for functionality against all versions and second for performance.  Should I
go for the belt and suspenders approach and use both ::ISA::CACHE:: and
@$isa=@$isa everywhere I use splice against @ISA just to be safe?  It still
might be nice to figure out why the above code fails under 5.10, though.

For what it&#39;s worth, Class::Prototyped stresses the dynamic capabilities of
the Perl object system pretty intensively &#40;and a whole bunch of other stuff as
well&#41;.  Making the interface pretty came at the expense of some evil tricks on
the inside.  So it doesn&#39;t surprise me that there might be changes to Perl
that introduce subtle bugs that only end up surfacing in C::P.

--Toby Ovod-Everett
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;18&nbsp;02:49:08&nbsp;2007</span>
    <span class="description">rgarciasuarez [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &#34;toby [...] ovod-everett.org via RT&#34; &lt;bug-Class-Prototyped [...] rt.cpan.org&gt;,  perl5-porters [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #31556] Doesn&#39;t work with 5.10</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 18 Dec 2007 08:48:45 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;Toby Ovod-Everett&#34; &lt;toby [...] ovod-everett.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Rafael Garcia-Suarez&#34; &lt;rgarciasuarez [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 18/12/2007, Toby Ovod-Everett &lt;toby@ovod-everett.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Interestingly, it appears that using splice on @ISA is only a problem if @ISA
&gt; both exists and is empty &#40;took me a while to figure that one out&#41;!
</div>
That&#39;s typically a bug.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;18&nbsp;10:25:07&nbsp;2007</span>
    <span class="description">toby [...] ovod-everett.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Toby Ovod-Everett &lt;toby [...] ovod-everett.org&gt;, &#34;toby [...] ovod-everett.org via RT&#34; &lt;bug-Class-Prototyped [...] rt.cpan.org&gt;, perl5-porters [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #31556] Doesn&#39;t work with 5.10</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 18 Dec 2007 06:23:58 -0900</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Rafael Garcia-Suarez &lt;rgarciasuarez [...] gmail.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Toby Ovod-Everett &lt;toby [...] ovod-everett.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Dec 18, 2007 at 08:48:45AM +0100, Rafael Garcia-Suarez wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 18/12/2007, Toby Ovod-Everett &lt;toby@ovod-everett.org&gt; wrote:
<div class="message-stanza open">&gt; &gt; Interestingly, it appears that using splice on @ISA is only a problem if @ISA
&gt; &gt; both exists and is empty &#40;took me a while to figure that one out&#41;!
</div>&gt; 
&gt; That&#39;s typically a bug.
</div>
If that bug is fixed &#40;and there are no other bugs when manipulating @ISA&#41;,
there&#39;s a very good chance Class::Prototyped will run as-is without problems on
5.10.  Otherwise, I&#39;ll need to use the @$isa=@$isa workaround.

I have managed to test C::P against the following versions of ActivePerl:
* 5.6.0-623
* 5.6.1-626
* 5.8.0-802
* 5.8.8-822
* 5.10.0-1000

Unfortunately, the earlier versions of ActivePerl aren&#39;t made available in a
.zip format, so they have to be installed.  I&#39;d rather not risk hosing up my
production home machine with 8 year old versions of Perl &#40;i.e. 5.005_03-514
and 5.6.0-611&#41;.  I&#39;m leaving on vacation tomorrow for 3 weeks, and I&#39;m not
going to have time today at work to do installs into a VM so I can grab .zip
files of the directory tree for testing.  I should be able to do that when I
get back, though, at which point I should be able to indefinitely maintain a
set of versions of Perl to test against.

With both the @$isa=@$isa and the ::ISA::CACHE:: code disabled, the full test
suite for Class::Prototyped passed under all of those versions except for
5.10.0-1000, which I imagine is related to the bug identified above.

Is there a rough estimate for the release of 5.10?  Should I release a version
of Class::Prototyped with both the ::ISA::CACHE:: and @$isa=@$isa workarounds
in it and then plan on paring those lines back when I get back from vacation
and can test against both earlier versions of Perl and the released version of
5.10?

--Toby Ovod-Everett
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;18&nbsp;10:30:16&nbsp;2007</span>
    <span class="description">rgarciasuarez [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &#34;toby [...] ovod-everett.org via RT&#34; &lt;bug-Class-Prototyped [...] rt.cpan.org&gt;,  perl5-porters [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #31556] Doesn&#39;t work with 5.10</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 18 Dec 2007 16:29:40 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;Toby Ovod-Everett&#34; &lt;toby [...] ovod-everett.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Rafael Garcia-Suarez&#34; &lt;rgarciasuarez [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 18/12/2007, Toby Ovod-Everett wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Is there a rough estimate for the release of 5.10?
</div>
Probably in a few hours. We were in code freeze, except for
critical bugs, for weeks.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Should I release a version
&gt; of Class::Prototyped with both the ::ISA::CACHE:: and @$isa=@$isa workarounds
&gt; in it and then plan on paring those lines back when I get back from vacation
&gt; and can test against both earlier versions of Perl and the released version of
&gt; 5.10?
</div>
I think the workarounds need to go in, yes. The bug is not critical, it will
be fixed in 5.10.1 hopefully.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;18&nbsp;11:11:34&nbsp;2007</span>
    <span class="description">blblack [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &#34;Toby Ovod-Everett&#34; &lt;toby [...] ovod-everett.org&gt;,  &#34;toby [...] ovod-everett.org via RT&#34; &lt;bug-Class-Prototyped [...] rt.cpan.org&gt;,  &#34;Rafael Garcia-Suarez&#34; &lt;rgarciasuarez [...] gmail.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #31556] Doesn&#39;t work with 5.10</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 18 Dec 2007 10:11:09 -0600</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;Perl 5 Porters&#34; &lt;perl5-porters [...] perl.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Brandon Black&#34; &lt;blblack [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Dec 18, 2007 9:29 AM, Rafael Garcia-Suarez &lt;rgarciasuarez@gmail.com&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 18/12/2007, Toby Ovod-Everett wrote:
<div class="message-stanza open">&gt; &gt; Is there a rough estimate for the release of 5.10?
</div>&gt;
&gt; Probably in a few hours. We were in code freeze, except for
&gt; critical bugs, for weeks.
&gt;
<div class="message-stanza open">&gt; &gt; Should I release a version
&gt; &gt; of Class::Prototyped with both the ::ISA::CACHE:: and @$isa=@$isa workarounds
&gt; &gt; in it and then plan on paring those lines back when I get back from vacation
&gt; &gt; and can test against both earlier versions of Perl and the released version of
&gt; &gt; 5.10?
</div>&gt;
&gt; I think the workarounds need to go in, yes. The bug is not critical, it will
&gt; be fixed in 5.10.1 hopefully.
&gt;
</div>
Sorry this thread slipped under my radar somehow.  Splicing @ISA
probably isn&#39;t the only broken operation, but this stuff doesn&#39;t get
tested much because 99.99% of all Perl software at most uses
assignment and push to set simple @ISAs.  Another one we already know
about is aliasing @ISA between two packages.  I&#39;d love it if we could
get @ISA to be as flexible as every other array in Perl, but it&#39;s not
there yet.  The aliasing is probably more 5.11 material because it&#39;s
complicated.

Toby: the @$isa = @$isa trick is fine for now, it won&#39;t break anything
and is probably the most compatible thing to do.  Assigning an @ISA to
itself is effectively a way to do &#34;PL_sub_generation++&#34; on older
Perls, and a way to trigger the mro code to notice the change in 5.10.
 It&#39;s important to note that on the older Perls, just assigning any
one @ISA to itself would fix up every cache in the whole interpreter,
whereas on 5.10, you really need to do it for each affected @ISA
individually.

-- Brandon
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;18&nbsp;20:57:52&nbsp;2007</span>
    <span class="description">toby [...] ovod-everett.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Perl 5 Porters &lt;perl5-porters [...] perl.org&gt;, Toby Ovod-Everett &lt;toby [...] ovod-everett.org&gt;, &#34;toby [...] ovod-everett.org via RT&#34; &lt;bug-Class-Prototyped [...] rt.cpan.org&gt;, Rafael Garcia-Suarez &lt;rgarciasuarez [...] gmail.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #31556] Doesn&#39;t work with 5.10</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 18 Dec 2007 16:56:48 -0900</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Brandon Black &lt;blblack [...] gmail.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Toby Ovod-Everett &lt;toby [...] ovod-everett.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Dec 18, 2007 at 10:11:09AM -0600, Brandon Black wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Dec 18, 2007 9:29 AM, Rafael Garcia-Suarez &lt;rgarciasuarez@gmail.com&gt; wrote:
<div class="message-stanza open">&gt; &gt; On 18/12/2007, Toby Ovod-Everett wrote:
<div class="message-stanza open">&gt; &gt; &gt; Is there a rough estimate for the release of 5.10?
</div>&gt; &gt;
&gt; &gt; Probably in a few hours. We were in code freeze, except for
&gt; &gt; critical bugs, for weeks.
&gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; Should I release a version
&gt; &gt; &gt; of Class::Prototyped with both the ::ISA::CACHE:: and @$isa=@$isa workarounds
&gt; &gt; &gt; in it and then plan on paring those lines back when I get back from vacation
&gt; &gt; &gt; and can test against both earlier versions of Perl and the released version of
&gt; &gt; &gt; 5.10?
</div>&gt; &gt;
&gt; &gt; I think the workarounds need to go in, yes. The bug is not critical, it will
&gt; &gt; be fixed in 5.10.1 hopefully.
&gt; &gt;
</div>&gt; 
&gt; Sorry this thread slipped under my radar somehow.  Splicing @ISA
&gt; probably isn&#39;t the only broken operation, but this stuff doesn&#39;t get
&gt; tested much because 99.99% of all Perl software at most uses
&gt; assignment and push to set simple @ISAs.  Another one we already know
&gt; about is aliasing @ISA between two packages.  I&#39;d love it if we could
&gt; get @ISA to be as flexible as every other array in Perl, but it&#39;s not
&gt; there yet.  The aliasing is probably more 5.11 material because it&#39;s
&gt; complicated.
&gt; 
&gt; Toby: the @$isa = @$isa trick is fine for now, it won&#39;t break anything
&gt; and is probably the most compatible thing to do.  Assigning an @ISA to
&gt; itself is effectively a way to do &#34;PL_sub_generation++&#34; on older
&gt; Perls, and a way to trigger the mro code to notice the change in 5.10.
&gt;  It&#39;s important to note that on the older Perls, just assigning any
&gt; one @ISA to itself would fix up every cache in the whole interpreter,
&gt; whereas on 5.10, you really need to do it for each affected @ISA
&gt; individually.
</div>
I can probably get rid of the ::ISA::CACHE:: code and just rely on @$isa
= @$isa, but I&#39;ll worry about that at a later date.  C::P 1.11 was just posted
to CPAN.

I&#39;m a little unhappy that I can&#39;t figure out why when I build it on my Linux
box it won&#39;t create the HTML files for the PPM file.  Works fine when built
under Win32, but then I end up with CRLF formatted files, and in non-Win32
modules I prefer to build under Linux so I can more easily get Unix-formatted
files &#40;Windows machines deal with Unix-formatted files better than Unix
machines deal with DOS-formatted files&#41;.  I&#39;m using Fedora 8, standard Fedora
Perl install, with Module-Build installed from the normal Fedora 8
repositories.  The Build.PL file is in the distribution, and I&#39;m using the
following process to build the files:

rm *.ppd
rm -rf MSWin32-x86-multi-thread
rm *.tar.gz
rm *.zip

./Build realclean
perl Build.PL

rm MANIFEST
rm MANIFEST.bak

./Build manifest

./Build ppmzip --tar tar --gzip gzip

./Build clean
./Build dist --tar tar --gzip gzip

rm -rf *.ppd
rm -rf MSWin32-x86-multi-thread

mv -f *.tar.gz ..
mv -f *.zip ..

./Build realclean


Of course, I haven&#39;t messed with building modules in ages, and there have been
rebuilds of the Linux box since then.  Who knows.  Looks like modern
ActivePerl installs may auto-build the HTML files when installing via PPM
anyway.

--Toby Ovod-Everett
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;28&nbsp;17:30:42&nbsp;2013</span>
    <span class="description">TEVERETT [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;28&nbsp;17:30:43&nbsp;2013</span>
    <span class="description">TEVERETT [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;28&nbsp;17:30:43&nbsp;2013</span>
    <span class="description">TEVERETT [...] cpan.org -  Fixed in 0.11 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;28&nbsp;17:31:11&nbsp;2013</span>
    <span class="description">TEVERETT [...] cpan.org -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;28&nbsp;17:31:11&nbsp;2013</span>
    <span class="description">TEVERETT [...] cpan.org -  Fixed in 1.11 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;28&nbsp;17:31:12&nbsp;2013</span>
    <span class="description">TEVERETT [...] cpan.org -  Fixed in 0.11 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;28&nbsp;17:31:20&nbsp;2013</span>
    <span class="description">TEVERETT [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
