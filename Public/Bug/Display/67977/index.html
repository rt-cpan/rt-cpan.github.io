<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #67977 for CGI-Session-Auth: libcgi-session-auth-dbi-perl: Room for improved security.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #67977 for CGI-Session-Auth: libcgi-session-auth-dbi-perl: Room for improved security.</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=CGI-Session-Auth">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=CGI-Session-Auth">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=CGI-Session-Auth">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=CGI-Session-Auth">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/CGI-Session-Auth">CGI-Session-Auth CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">67977</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=CGI-Session-Auth">CGI-Session-Auth</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">geewiz [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cheako [...] mikemestnik.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-5876-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-5877-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=67977">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-931542" href="/Public/Bug/Display.html?id=67977#txn-931542">#</a>      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;06&nbsp;01:11:21&nbsp;2011</span>
    <span class="description">cheako [...] mikemestnik.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> libcgi-session-auth-dbi-perl: Room for improved security.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 06 May 2011 00:11:10 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI-Session-Auth [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike Mestnik &lt;cheako [...] mikemestnik.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/931542/483527/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/483527">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Version: DBI.pm 25 2006-02-21 12:07:26Z geewiz

There are 6 bugs here, feel free to clone this or ignore some of
these...  Just not the bug I&#39;m reporting,

The really really really important part, line 106 should be moved down
at least 6 lines.  The password should not be going anywhere until after
it&#39;s hashed.  Any logs made as a result of this statement would result
in the generation of a lookup table matching passwords to hash though
user-names to passwords is more accurate.
Let me try and be clear on this.  The idea of hashing all the passwords
is to protect the passwords from any one and every one&#40;including and
especially the administrators/owners/operators&#41; who may have access to
the stored passwords.  It&#39;s not likely the stored passwords will be kept
in a place less secure then any logs and it&#39;s considerably impossible to
imagine that crypted passwords would be readable by anyone who would be
unable to read the logs and/or activate debugging to create logs. 
Though it&#39;s true every application has a week spot where it&#39;s data can
be shunted out a backdoor some where, it&#39;s not something that should be
readily accessible.
The purpose being so that users can albeit not safely use the same
password to multiple resources without the fear that one admin will use
this to gain access to a resource he/she is not entitled.  An example
being A Yahoo mail user using the same password for a Google Account of
some sort, could be Gmail or something else.  One day as Yahoo goes out
of business they may try there extensive password database against
Google accounts to see what&#39;s what.  Nothing could prevent this, but a
good step is to ensure that every or at least as many password database
are unusable to any one who may or may not have malicious intent.

EncryptPW is not documented.

HashPW should be an alias to EncryptPW because [1]md5, the cryptographic
hash function, is not Encrypt&#40;ion&#41;.
CryptPW could also be an alias, though you need to support a lot
MORE&#40;DES, MD5, Blowfish, SHA-256, SHA-512, ect&#41; then md5 to be
considered a replacement for crypt&#40;&#41;.  Neither of these functions have
much if anything to do with Encryption, though the term
One-Way-Encryption was used prior to these functions being named hash
functions.

1. <span class="clickylink"><a target="new" rel="nofollow" href="http://en.wikipedia.org/wiki/MD5">http://en.wikipedia.org/wiki/MD5</a></span>

I say this mainly because MD5 has been made unusable, SHA1 is even
becoming less usefull.  SHA-256 with support for SHA-512 is where most
new deployments and applications should be pointed.

The default passwordfield for hashed passwords should be changed, this
is to avoid the types of problems typically corrected by &#34;strict vars&#34;.

On another note:
Postgresql has support for a UUID type, detection of this would be great
for the userid field.  The semantics are simple &#40;Input&#41;INSERT and UPDATE
as you do now is transparently supported, though &#40;Output&#41;SELECT is
always in the standard form.  eg: a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11
It should only take a small bit of code to support this, like s/-//g.

-- System Information:
Debian Release: 6.0.1
  APT prefers stable
  APT policy: &#40;500, &#39;stable&#39;&#41;
Architecture: amd64 &#40;x86_64&#41;

Kernel: Linux 2.6.35.4-rscloud &#40;SMP w/4 CPU cores&#41;
Locale: LANG=C, LC_CTYPE=C &#40;charmap=ANSI_X3.4-1968&#41;
Shell: /bin/sh linked to /bin/dash

Versions of packages libcgi-session-perl depends on:
ii  perl                          5.10.1-17  Larry Wall&#39;s Practical
Extraction

Versions of packages libcgi-session-perl recommends:
ii  libdbi-perl                   1.612-1    Perl Database Interface &#40;DBI&#41;

libcgi-session-perl suggests no packages.

-- no debconf information
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-933910" href="/Public/Bug/Display.html?id=67977#txn-933910">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;12&nbsp;00:02:48&nbsp;2011</span>
    <span class="description">cheako [...] mikemestnik.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #67977] AutoReply: libcgi-session-auth-dbi-perl: Room for improved security.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 11 May 2011 23:02:37 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI-Session-Auth [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike Mestnik &lt;cheako [...] mikemestnik.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/933910/484866/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/484866">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here is a patch that addresses some of these issues.

--- share/perl/5.10.1/CGI/Session/Auth/DBI.pm    2010-03-03
09:13:24.000000000 -0600
+++ ./lib/site_perl/CGI/Session/Auth/DBI.pm    2011-05-11
22:49:20.000000000 -0500
@@ -61,6 +61,7 @@
    
     # parameter &#39;EncryptPW&#39;: passwords are MD5-encrypted &#40;default 0&#41;
     $self-&gt;{encryptpw} = $params-&gt;{EncryptPW} || 0;
+    $self-&gt;{saltencryptpw} = $params-&gt;{SaltEncryptPW} || 0;
     # parameter &#39;UserTable&#39;: name of user data table
     $self-&gt;{usertable} = $params-&gt;{UserTable} || &#39;auth_user&#39;;
     $self-&gt;{usernamefield} = $params-&gt;{UsernameField} || &#39;username&#39;;
@@ -103,7 +104,7 @@
     my $self = shift;
     my &#40;$username, $password&#41; = @_;
    
-    $self-&gt;_debug&#40;&#34;username: $username, password: $password&#34;&#41;;
+    $self-&gt;_debug&#40;&#34;username: $username&#34;&#41;;
 
     if &#40;$self-&gt;{encryptpw}&#41; {
         $password = $self-&gt;_encpw&#40;$password&#41;;
@@ -113,16 +114,26 @@
     my $result = 0;
    
     my $query = sprintf&#40;
-        &#34;SELECT * FROM %s WHERE %s = ? AND %s = ?&#34;,
+        &#34;SELECT * FROM %s WHERE %s = ?&#34;,
         $self-&gt;{usertable},
         $self-&gt;{usernamefield},
-        $self-&gt;{passwordfield},
     &#41;;
     $self-&gt;_debug&#40;&#34;query: $query&#34;&#41;;
     # search for username
     my $sth = $self-&gt;_dbh-&gt;prepare&#40;$query&#41;;
-    $sth-&gt;execute&#40;$username, $password&#41; or croak $self-&gt;_dbh-&gt;errstr;
+    $sth-&gt;execute&#40;$username&#41; or croak $self-&gt;_dbh-&gt;errstr;
     if &#40;my $rec = $sth-&gt;fetchrow_hashref&#41; {
+    my $pwhash = $rec-&gt;{$self-&gt;{passwordfield}};
+    {
+          if &#40; $self-&gt;{saltencryptpw} &#41; {
+        require Crypt::SaltedHash;
+        # TODO the default is 4, I need 16.
+        last unless Crypt::SaltedHash-&gt;validate&#40; $pwhash, $password,
+        $self-&gt;{saltencryptpw}&#41;;
+      } else {
+        last if &#40;$password ne $pwhash&#41;;
+      }
+    }
         $self-&gt;_debug&#40;&#34;found user entry&#34;&#41;;
         $self-&gt;_extractProfile&#40;$rec&#41;;
         $result = 1;

Base64/BZ2 compressed copy of above patch, with example usage:
&lt;&lt;EOF tr -d &#39;\n&#39; | base64 -d | bzcat
QlpoOTFBWSZTWTfrs9oAARFfgGcwXv//u//n3oC/7//uUAM5PZRm1T0MJSKelNMaTzKmRkeUaGQG
nqMnqGg0GmjwoaNBwDCMJpiGAQDIAYRpkyYRgIaCU0QKaACT0mmQzU0DamgBoZPUAD1AaDJSNAaA
DQNNAAAAAAAAAJJCaDQEmKPU9qh6jyNGo9QANGQAAMmlRmbcEzZWax8R2/vDxovJtC9um6J0JwdK
oytvJxKSaUYbS3Zu0rgYM4gGDHi3kJ2kMDwnYeDAGCsmmF9bFPKPcWMqLYSEkp8n8Z01c69nyJJD
eI0t6Od1kfXh0WQnHpqw8l9rq6NapfXV2+gjXhYlxKjVtgIneM+QqJRd3bj6++Wau2VbFwcI/ORy
m81hv3KgNsHJmGSSOJApTIiJU5J0rSqUpCKshr/zxvAZHf7Av9A6SR4MkLNKvkMWp+xR9y1jlZm7
onahSae+W5n7zuNzOpDUNC+aS5WMEFSV/ED0ibkjRW0Np+v2VurJHmy7bwX7c6gw4HLEzPRJNUHq
KdFPSoTy5FrsRqHeLrUQpp4m/l53nWjxddNo0b/BmOc6DfwazIa7+1OW7dIOsjiVJvnq/UANAAJv
OMm1MjSbojmIJu5hjoJykoILctgimMZeGTFA4gGT2vVxrBVKCUh3zYGj+4WtQpYKIqUDJcvwjlKV
Y+zTGmRO1BHhPwSvc6QahnJHqNRymboevkipKWFlgyCaYJh7CcQrys2yJtgG22gxxlU1gnDkBCZ5
YQk3SSwovSmVLEUIRKzfTizNCkcRRwDAuwMdQX9YnM9pOWRbEC6uDNAMIosqU8fDbEGO73ObCGTu
JLrtiiCdpfsZf2z4mmGakti7skD5mZGBkxcnoRxTuqBwtIyQe67UwaCy5kinkTCqgNa+YgzxxhoS
Gg86AbISpMCP5O0Mr6iQw5MshCysYQQIjUIEXJaEiCoYrHRi8dQJVG6LzKMEmO8RQS6Vexr2B11s
0XoRiv8MgZgyogNUaX3KCFOGA8ikUpmbKYvcsKKaCh8jCehExrkEVTFDzjm6g4QaUw2mhamw3MHa
M4cB5CnuXyZVpDIyLQlnALQ20AHSDweuNq8EO/pJDwti/4u5IpwoSBv12e0A
EOF
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-933912" href="/Public/Bug/Display.html?id=67977#txn-933912">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;12&nbsp;00:10:04&nbsp;2011</span>
    <span class="description">cheako [...] mikemestnik.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #67977] AutoReply: libcgi-session-auth-dbi-perl: Room for improved security.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 11 May 2011 23:09:54 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI-Session-Auth [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike Mestnik &lt;cheako [...] mikemestnik.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/933912/484868/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/484868">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m sooo sorry for the following patch.  It works when using the correct
password and works using any other password.

On 05/11/11 23:02, Mike Mestnik wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Here is a patch that addresses some of these issues.
&gt;
&gt; --- share/perl/5.10.1/CGI/Session/Auth/DBI.pm    2010-03-03
&gt; 09:13:24.000000000 -0600
&gt; +++ ./lib/site_perl/CGI/Session/Auth/DBI.pm    2011-05-11
&gt; 22:49:20.000000000 -0500
&gt; @@ -61,6 +61,7 @@
&gt;     
&gt;      # parameter &#39;EncryptPW&#39;: passwords are MD5-encrypted &#40;default 0&#41;
&gt;      $self-&gt;{encryptpw} = $params-&gt;{EncryptPW} || 0;
&gt; +    $self-&gt;{saltencryptpw} = $params-&gt;{SaltEncryptPW} || 0;
&gt;      # parameter &#39;UserTable&#39;: name of user data table
&gt;      $self-&gt;{usertable} = $params-&gt;{UserTable} || &#39;auth_user&#39;;
&gt;      $self-&gt;{usernamefield} = $params-&gt;{UsernameField} || &#39;username&#39;;
&gt; @@ -103,7 +104,7 @@
&gt;      my $self = shift;
&gt;      my &#40;$username, $password&#41; = @_;
&gt;     
&gt; -    $self-&gt;_debug&#40;&#34;username: $username, password: $password&#34;&#41;;
&gt; +    $self-&gt;_debug&#40;&#34;username: $username&#34;&#41;;
&gt;  
&gt;      if &#40;$self-&gt;{encryptpw}&#41; {
&gt;          $password = $self-&gt;_encpw&#40;$password&#41;;
&gt; @@ -113,16 +114,26 @@
&gt;      my $result = 0;
&gt;     
&gt;      my $query = sprintf&#40;
&gt; -        &#34;SELECT * FROM %s WHERE %s = ? AND %s = ?&#34;,
&gt; +        &#34;SELECT * FROM %s WHERE %s = ?&#34;,
&gt;          $self-&gt;{usertable},
&gt;          $self-&gt;{usernamefield},
&gt; -        $self-&gt;{passwordfield},
&gt;      &#41;;
&gt;      $self-&gt;_debug&#40;&#34;query: $query&#34;&#41;;
&gt;      # search for username
&gt;      my $sth = $self-&gt;_dbh-&gt;prepare&#40;$query&#41;;
&gt; -    $sth-&gt;execute&#40;$username, $password&#41; or croak $self-&gt;_dbh-&gt;errstr;
&gt; +    $sth-&gt;execute&#40;$username&#41; or croak $self-&gt;_dbh-&gt;errstr;
&gt;      if &#40;my $rec = $sth-&gt;fetchrow_hashref&#41; {
&gt; +    my $pwhash = $rec-&gt;{$self-&gt;{passwordfield}};
&gt; +    {
&gt; +          if &#40; $self-&gt;{saltencryptpw} &#41; {
&gt; +        require Crypt::SaltedHash;
&gt; +        # TODO the default is 4, I need 16.
&gt; +        last unless Crypt::SaltedHash-&gt;validate&#40; $pwhash, $password,
&gt; +        $self-&gt;{saltencryptpw}&#41;;
&gt; +      } else {
&gt; +        last if &#40;$password ne $pwhash&#41;;
&gt; +      }
&gt; +    }
&gt;          $self-&gt;_debug&#40;&#34;found user entry&#34;&#41;;
&gt;          $self-&gt;_extractProfile&#40;$rec&#41;;
&gt;          $result = 1;
&gt;
&gt; Base64/BZ2 compressed copy of above patch, with example usage:
&gt; &lt;&lt;EOF tr -d &#39;\n&#39; | base64 -d | bzcat
&gt; QlpoOTFBWSZTWTfrs9oAARFfgGcwXv//u//n3oC/7//uUAM5PZRm1T0MJSKelNMaTzKmRkeUaGQG
&gt; nqMnqGg0GmjwoaNBwDCMJpiGAQDIAYRpkyYRgIaCU0QKaACT0mmQzU0DamgBoZPUAD1AaDJSNAaA
&gt; DQNNAAAAAAAAAJJCaDQEmKPU9qh6jyNGo9QANGQAAMmlRmbcEzZWax8R2/vDxovJtC9um6J0JwdK
&gt; oytvJxKSaUYbS3Zu0rgYM4gGDHi3kJ2kMDwnYeDAGCsmmF9bFPKPcWMqLYSEkp8n8Z01c69nyJJD
&gt; eI0t6Od1kfXh0WQnHpqw8l9rq6NapfXV2+gjXhYlxKjVtgIneM+QqJRd3bj6++Wau2VbFwcI/ORy
&gt; m81hv3KgNsHJmGSSOJApTIiJU5J0rSqUpCKshr/zxvAZHf7Av9A6SR4MkLNKvkMWp+xR9y1jlZm7
&gt; onahSae+W5n7zuNzOpDUNC+aS5WMEFSV/ED0ibkjRW0Np+v2VurJHmy7bwX7c6gw4HLEzPRJNUHq
&gt; KdFPSoTy5FrsRqHeLrUQpp4m/l53nWjxddNo0b/BmOc6DfwazIa7+1OW7dIOsjiVJvnq/UANAAJv
&gt; OMm1MjSbojmIJu5hjoJykoILctgimMZeGTFA4gGT2vVxrBVKCUh3zYGj+4WtQpYKIqUDJcvwjlKV
&gt; Y+zTGmRO1BHhPwSvc6QahnJHqNRymboevkipKWFlgyCaYJh7CcQrys2yJtgG22gxxlU1gnDkBCZ5
&gt; YQk3SSwovSmVLEUIRKzfTizNCkcRRwDAuwMdQX9YnM9pOWRbEC6uDNAMIosqU8fDbEGO73ObCGTu
&gt; JLrtiiCdpfsZf2z4mmGakti7skD5mZGBkxcnoRxTuqBwtIyQe67UwaCy5kinkTCqgNa+YgzxxhoS
&gt; Gg86AbISpMCP5O0Mr6iQw5MshCysYQQIjUIEXJaEiCoYrHRi8dQJVG6LzKMEmO8RQS6Vexr2B11s
&gt; 0XoRiv8MgZgyogNUaX3KCFOGA8ikUpmbKYvcsKKaCh8jCehExrkEVTFDzjm6g4QaUw2mhamw3MHa
&gt; M4cB5CnuXyZVpDIyLQlnALQ20AHSDweuNq8EO/pJDwti/4u5IpwoSBv12e0A
&gt; EOF
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-933914" href="/Public/Bug/Display.html?id=67977#txn-933914">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;12&nbsp;00:15:47&nbsp;2011</span>
    <span class="description">cheako [...] mikemestnik.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #67977] AutoReply: libcgi-session-auth-dbi-perl: Room for improved security.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 11 May 2011 23:15:37 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI-Session-Auth [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike Mestnik &lt;cheako [...] mikemestnik.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/933914/484870/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/484870">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here is a better tested copy of the a similar patch!!!
Notice the closing brace was moved down a few lines, notably after the
session is marked authenticated.

--- share/perl/5.10.1/CGI/Session/Auth/DBI.pm    2010-03-03
09:13:24.000000000 -0600
+++ ./lib/site_perl/CGI/Session/Auth/DBI.pm    2011-05-11
23:11:01.000000000 -0500
@@ -61,6 +61,7 @@
    
     # parameter &#39;EncryptPW&#39;: passwords are MD5-encrypted &#40;default 0&#41;
     $self-&gt;{encryptpw} = $params-&gt;{EncryptPW} || 0;
+    $self-&gt;{saltencryptpw} = $params-&gt;{SaltEncryptPW} || 0;
     # parameter &#39;UserTable&#39;: name of user data table
     $self-&gt;{usertable} = $params-&gt;{UserTable} || &#39;auth_user&#39;;
     $self-&gt;{usernamefield} = $params-&gt;{UsernameField} || &#39;username&#39;;
@@ -103,7 +104,7 @@
     my $self = shift;
     my &#40;$username, $password&#41; = @_;
    
-    $self-&gt;_debug&#40;&#34;username: $username, password: $password&#34;&#41;;
+    $self-&gt;_debug&#40;&#34;username: $username&#34;&#41;;
 
     if &#40;$self-&gt;{encryptpw}&#41; {
         $password = $self-&gt;_encpw&#40;$password&#41;;
@@ -113,20 +114,30 @@
     my $result = 0;
    
     my $query = sprintf&#40;
-        &#34;SELECT * FROM %s WHERE %s = ? AND %s = ?&#34;,
+        &#34;SELECT * FROM %s WHERE %s = ?&#34;,
         $self-&gt;{usertable},
         $self-&gt;{usernamefield},
-        $self-&gt;{passwordfield},
     &#41;;
     $self-&gt;_debug&#40;&#34;query: $query&#34;&#41;;
     # search for username
     my $sth = $self-&gt;_dbh-&gt;prepare&#40;$query&#41;;
-    $sth-&gt;execute&#40;$username, $password&#41; or croak $self-&gt;_dbh-&gt;errstr;
+    $sth-&gt;execute&#40;$username&#41; or croak $self-&gt;_dbh-&gt;errstr;
     if &#40;my $rec = $sth-&gt;fetchrow_hashref&#41; {
+    my $pwhash = $rec-&gt;{$self-&gt;{passwordfield}};
+    {
+          if &#40; $self-&gt;{saltencryptpw} &#41; {
+        require Crypt::SaltedHash;
+        # TODO the default is 4, I need 16.
+        last unless Crypt::SaltedHash-&gt;validate&#40; $pwhash, $password,
+        $self-&gt;{saltencryptpw}&#41;;
+      } else {
+        last if &#40;$password ne $pwhash&#41;;
+      }
         $self-&gt;_debug&#40;&#34;found user entry&#34;&#41;;
         $self-&gt;_extractProfile&#40;$rec&#41;;
         $result = 1;
         $self-&gt;_info&#40;&#34;user &#39;$username&#39; logged in&#34;&#41;;
+    }
     }
     $sth-&gt;finish;
    

Base64/BZ2 compressed copy of above patch, with example usage:
&lt;&lt;EOF tr -d &#39;\n&#39; | base64 -d | bzcat
QlpoOTFBWSZTWSYTAAgAASNfgGcwXv//u//n3oC/7//uUANe5k0tWagISURJpsU2mKeUBk0NAPUe

oaZGRoAPU9IyA4BhGE0xDAIBkAMI0yZMIwENBKaEjU1T2gk9Q9T1NAaeoPUb1QGgGnqaNAZBkOAY
RhNMQwCAZADCNMmTCMBDQSKI0CU9PFPU1P0jJNonqepiaAAGQAGg00oQBuDAuSpPkQXVq1tVNYPo
68bJpUEoybZJOnUnEmIe+s6aRBNwDHREAMZcmpCdpYYeE4zwaw13NzZr3lUR9RyYeTAw9JyNznG1
eN9PxMOnhtltTZuWSyaTZ81kKSt8WCsr0cjyjjY3BX2aC42d1aycibFDEyi453aMg+QaDb1o9/GC
aCF+BhaDgHNQy15ig30UTqwGyXZIZJI7qBTQiCJs36WW2WpTIoWqrONel9s7wG47/k5UPzSOkkb2
5C6U14DJrfuWOaa1PMzNsHBSJTuFhT64csOSDhUHEOa2exexlwisC3jCKRTCy3HipsP3vFj4yT1Z
+XEHDnvuJMl7mI36mi1JNUHqK21KmlQnrRK1LDWPNtEUuiimFwcL2Ue66Wjd03mspv6HzFpzV/rP
CJVsoiVygcLKJQoe4AXiAawiYt1MJSYYYhwpxul+o+TKVEMuB82KS+bQ7SVEZtE34w+N5lCg/J5S
3hMxcZNJhI6ZhmjpQel48Vpe2x/GfttdiwiVYWcT0LXwujGpHWXTES53F6IeSfivvEwUoFEoQzk2
4M22KNjG5KwZYzoosdIcgITPN4S3OTfxOXUsKmRjEMxjyYYuukpxFkCY0DQt0Z1hdiUHZylB2JLK
D3cm3FCGSdzc8b7eGrKGi3Pj4nNpAJ3EJdls0QUzG5rTfzL9DdmLn6lxmptx3yc+Zii83KIKIkbK
Ko1hEWgYI91uphZiZa2Cr5ExWTEiDjdIneaciTZ0hzxP6FDShqHdm+B2sehI01LfQ1wZAwGNzDHi
lFIvgpLTu6YkKUlWcsomAwsZ3iSCzqVrO3rDFb2e0SNAf4YhsMAsc47DejtKZCpRcRJJFabeBojB
XU1UlMchkopROcViJKqSInHP1hrB2Tj3qdDOB3nKwmMwbZ5CrVbY1kSGi9Z0swBlDZSAdQRDZNDu
NXsQ7+wkeFtX/F3JFOFCQJhMACA=
EOF
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-946131" href="/Public/Bug/Display.html?id=67977#txn-946131">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;16&nbsp;12:38:42&nbsp;2011</span>
    <span class="description">geewiz [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Room for improved security.</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/946131/491973/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/491973">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 370b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Mike,

thanks for your feedback! Obviously, I can&#39;t spare much time to maintain the module, but since 
you put in so much effort, I&#39;ll see how to work your suggestions in ASAP.

I just moved the project source to github &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/geewiz/perl-cgi-session-auth&#41;">https://github.com/geewiz/perl-cgi-session-auth&#41;</a></span> 
and hope to be able to do some work on the module soon.

Thanks again and best regards,
  Jochen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-946133" href="/Public/Bug/Display.html?id=67977#txn-946133">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;16&nbsp;12:38:42&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-946134" href="/Public/Bug/Display.html?id=67977#txn-946134">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;16&nbsp;12:38:43&nbsp;2011</span>
    <span class="description">geewiz [...] cpan.org -  Given to GEEWIZ</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.400168</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
