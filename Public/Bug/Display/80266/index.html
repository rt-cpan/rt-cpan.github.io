<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #80266 for makepatch: patch fails if there&#39;s no patch, just file removal</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #80266 for makepatch: patch fails if there&#39;s no patch, just file removal</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/makepatch/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/makepatch/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/makepatch/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/makepatch/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/makepatch">makepatch CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">80266</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/makepatch/Active/">makepatch</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">jv [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
djerius [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-20276-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.04    </td>
  </tr>
  <tr id="CF-20277-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
2.05    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;18&nbsp;13:52:52&nbsp;2012</span>
    <span class="description">djerius [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch fails if there&#39;s no patch, just file removal</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza">If the makepatch generated patch does not actually patch anything, but simply removes files, the patch data is empty. applypatch still passes it to the patch command, which fails with (on Linux) with<br>

<br>

/usr/bin/patch: **** Only garbage was found in the patch input.<br>

Possible problems with &quot;patch -p0 -N -s&quot;, status = 512.<br>

<br>

and applypatch exits with error.&nbsp; <br>

<br>

I've attached a tar file with example orig and new directories , and a patch, new.patch, that goes from orig to new<br>

<br>

I've attached a patch which only invokes the patch command if there's actual patch data.<br>

<br>

Diab<br>

<br>
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> makepatch-2.04.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
# This is a patch for makepatch-2.04.orig to update it to makepatch-2.04
# 
# To apply this patch:
# STEP 1: Chdir to the source directory.
# STEP 2: Run the &#39;applypatch&#39; program with this patch file as input.
#
# If you do not have &#39;applypatch&#39;, it is part of the &#39;makepatch&#39; package
# that you can fetch from the Comprehensive Perl Archive Network:
# <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perl.com/CPAN/authors/Johan_Vromans/makepatch-x.y.tar.gz">http://www.perl.com/CPAN/authors/Johan_Vromans/makepatch-x.y.tar.gz</a></span>
# In the above URL, &#39;x&#39; should be 2 or higher.
#
# To apply this patch without the use of &#39;applypatch&#39;:
# STEP 1: Chdir to the source directory.
# STEP 2: Run the &#39;patch&#39; program with this file as input.
#
#### End of Preamble ####

#### Patch data follows ####
diff -c &#39;makepatch-2.04.orig/script/applypatch&#39; &#39;makepatch-2.04/script/applypatch&#39;
Index: ./script/applypatch
Prereq:  1.20 
*** ./script/applypatch	Sun Oct  8 09:07:07 2006
--- ./script/applypatch	Thu Oct 18 13:47:09 2012
***************
*** 377,402 ****
  
  }
  
  sub execute_patch &#40;&#41; {
!     my $p = new IO::File;
      print STDERR &#40;&#34;+ $patch\n&#34;&#41; if $trace;
-     $p-&gt;open&#40;&#34;|$patch&#34;&#41; || die &#40;&#34;Cannot open pipe to \&#34;$patch\&#34;: $!\n&#34;&#41;;
-     binmode&#40;$p&#41;;
      if &#40; $applypatch &#41; {
  	my $lines = 0;
  	while &#40; &lt;$tmpfile&gt; &#41; {
  	    chomp;
- 	    $lines++;
  	    print STDERR &#40;&#34;++ &#34;, $_, &#34;\n&#34;&#41; if $debug;
! 	    print $p &#40;$_, &#34;\n&#34;&#41;;
  	    last if $_ eq &#34;#### End of Patch data ####&#34;;
  	}
  	print STDERR &#40;&#34;+ $lines lines sent to \&#34;$patch\&#34;\n&#34;&#41; if $trace;
      }
      else {
! 	print $p &#40;$_&#41; while &lt;$tmpfile&gt;;
      }
!     $p-&gt;close || die &#40;&#34;Possible problems with \&#34;$patch\&#34;, status = $?.\n&#34;&#41;;
  }
  
  sub set_utime &#40;$$;$&#41; {
--- 377,419 ----
  
  }
  
+ 
+ sub _open_patch &#40;&#41; {
+ 
+ 	my $p = new IO::File;
+ 	$p-&gt;open&#40;&#34;|$patch&#34;&#41; || die &#40;&#34;Cannot open pipe to \&#34;$patch\&#34;: $!\n&#34;&#41;;
+ 	binmode&#40;$p&#41;;
+ 
+ 	return $p
+ }
+ 
+ 
  sub execute_patch &#40;&#41; {
! 
! 	my $p;
! 
      print STDERR &#40;&#34;+ $patch\n&#34;&#41; if $trace;
      if &#40; $applypatch &#41; {
  	my $lines = 0;
  	while &#40; &lt;$tmpfile&gt; &#41; {
  	    chomp;
  	    print STDERR &#40;&#34;++ &#34;, $_, &#34;\n&#34;&#41; if $debug;
! 	    next if $_ eq &#34;#### Patch data follows ####&#34;;
  	    last if $_ eq &#34;#### End of Patch data ####&#34;;
+ 	    $p = _open_patch&#40;&#41; unless $p;
+ 	    print $p &#40;$_, &#34;\n&#34;&#41;;
+ 	    $lines++;
  	}
  	print STDERR &#40;&#34;+ $lines lines sent to \&#34;$patch\&#34;\n&#34;&#41; if $trace;
      }
      else {
! 	    while &#40; &lt;$tmpfile&gt; &#41; {
! 		    $p = _open_patch&#40;&#41; unless $p;
! 		    print $p &#40;$_&#41;
! 	    }
      }
! 	defined $p and
! 	  $p-&gt;close || die &#40;&#34;Possible problems with \&#34;$patch\&#34;, status = $?.\n&#34;&#41;;
  }
  
  sub set_utime &#40;$$;$&#41; {
#### End of Patch data ####

#### ApplyPatch data follows ####
# Data version        : 1.0
# Date generated      : Thu Oct 18 13:48:22 2012
# Generated by        : makepatch 2.04
# Recurse directories : Yes
# Excluded files      : &#40;\A|/&#41;.*\~\Z
#                       &#40;\A|/&#41;.*\.a\Z
#                       &#40;\A|/&#41;.*\.bak\Z
#                       &#40;\A|/&#41;.*\.BAK\Z
#                       &#40;\A|/&#41;.*\.elc\Z
#                       &#40;\A|/&#41;.*\.exe\Z
#                       &#40;\A|/&#41;.*\.gz\Z
#                       &#40;\A|/&#41;.*\.ln\Z
#                       &#40;\A|/&#41;.*\.o\Z
#                       &#40;\A|/&#41;.*\.obj\Z
#                       &#40;\A|/&#41;.*\.olb\Z
#                       &#40;\A|/&#41;.*\.old\Z
#                       &#40;\A|/&#41;.*\.orig\Z
#                       &#40;\A|/&#41;.*\.rej\Z
#                       &#40;\A|/&#41;.*\.so\Z
#                       &#40;\A|/&#41;.*\.Z\Z
#                       &#40;\A|/&#41;\.del\-.*\Z
#                       &#40;\A|/&#41;\.make\.state\Z
#                       &#40;\A|/&#41;\.nse_depinfo\Z
#                       &#40;\A|/&#41;core\Z
#                       &#40;\A|/&#41;tags\Z
#                       &#40;\A|/&#41;TAGS\Z
# p &#39;script/applypatch&#39; 17302 1350582429 0100555
#### End of ApplyPatch data ####

#### End of Patch kit [created: Thu Oct 18 13:48:22 2012] ####
#### Patch checksum: 111 3120 852 ####
#### Checksum: 129 3813 58374 ####
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> example.tar</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;26&nbsp;15:58:11&nbsp;2012</span>
    <span class="description">jvromans [...] squirrel.nl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #80266] patch fails if there&#39;s no patch, just file  removal</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 26 Oct 2012 21:58:01 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-makepatch [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Johan Vromans &lt;jvromans [...] squirrel.nl&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[Quoting Diab Jerius via RT, on October 18 2012, 13:52, in &#34;[rt.cpan.org #80266]&#34;]
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve attached a patch which only invokes the patch command if
&gt; there&#39;s actual patch data.
</div>
Thanks, applied.
2.05 is on its way to CPAN.

-- Johan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;26&nbsp;15:58:12&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;26&nbsp;16:11:41&nbsp;2012</span>
    <span class="description">jv [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;26&nbsp;16:12:14&nbsp;2012</span>
    <span class="description">jv [...] cpan.org -  Given to JV</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;31&nbsp;10:24:28&nbsp;2012</span>
    <span class="description">jv [...] cpan.org -  Fixed in 2.05 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
