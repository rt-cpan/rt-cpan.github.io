<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #101092 for Archive-Zip: Creation of non-standard streamed zip file</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #101092 for Archive-Zip: Creation of non-standard streamed zip file</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Archive-Zip/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Archive-Zip/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Archive-Zip/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Archive-Zip/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Archive-Zip">Archive-Zip CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">101092</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Archive-Zip/Active/">Archive-Zip</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
pmqs [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-2540-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.39    </td>
  </tr>
  <tr id="CF-2541-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;22&nbsp;18:56:03&nbsp;2014</span>
    <span class="description">pmqs [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Creation of non-standard streamed zip file</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">When digging around #92205 I spotted that Archive::Zip created a non-standard local header when it process a zip file that already uses streaming. Here is the relevant part from appnote.txt that discusses streaming &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT&#41;">https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT&#41;</a></span>


 4.4.4 general purpose bit flag: &#40;2 bytes&#41;
        . . .
        Bit 3: If this bit is set, the fields crc-32, compressed 
               size and uncompressed size are set to zero in the 
               local header.  The correct values are put in the 
               data descriptor immediately following the compressed
               data.  &#40;Note: PKZIP version 2.04g for DOS only 
               recognizes this bit for method 8 compression, newer 
               versions of PKZIP recognize this bit for any 
               compression method.


The enclosed file, abc.zip, contains a single member &#34;fred&#34; that has been streamed. This is how I created it:

$ perl -MIO::Compress::Zip=zip -e &#39;zip \&#34;abc&#34; =&gt; &#34;abc.zip&#34;, Name =&gt; &#34;fred&#34;, Stream =&gt; 1, Method =&gt; 8&#39;

Here is a dump of the local headers section of the zip file

$ zipdetails abc.zip

0000 LOCAL HEADER #1       04034B50
0004 Extract Zip Spec      14 &#39;2.0&#39;
0005 Extract OS            00 &#39;MS-DOS&#39;
0006 General Purpose Flag  0008
     [Bits 1-2]            0 &#39;Normal Compression&#39;
     [Bit  3]              1 &#39;Streamed&#39;
0008 Compression Method    0008 &#39;Deflated&#39;
000A Last Mod Time         4596BBBD &#39;Mon Dec 22 23:29:58 2014&#39;
000E CRC                   00000000
0012 Compressed Length     00000000
0016 Uncompressed Length   00000000
001A Filename Length       0004
001C Extra Length          0000
001E Filename              &#39;fred&#39;
0022 PAYLOAD               KLJ..

0027 STREAMING DATA HEADER 08074B50
002B CRC                   352441C2
002F Compressed Length     00000005
0033 Uncompressed Length   00000003


Key points are the presence of the Streamed bit, and that CRC, Compressed length &#38; Uncompressed length are all zero in the local header, but populated in the Data Header.

I then got Archive::Zip to process the streamed zip file as follows

$ perl -MArchive::Zip -e &#39;my $z = Archive::Zip-&gt;new; $z-&gt;read&#40;shift&#41;; $z-&gt;writeToFileNamed&#40;&#34;out.zip&#34;&#41;;&#39; abc.zip

Here are the local headers from the new zip file

$ zipdetails out.zip 

0000 LOCAL HEADER #1       04034B50
0004 Extract Zip Spec      14 &#39;2.0&#39;
0005 Extract OS            00 &#39;MS-DOS&#39;
0006 General Purpose Flag  0008
     [Bits 1-2]            0 &#39;Normal Compression&#39;
     [Bit  3]              1 &#39;Streamed&#39;
0008 Compression Method    0008 &#39;Deflated&#39;
000A Last Mod Time         4596BBBD &#39;Mon Dec 22 23:29:58 2014&#39;
000E CRC                   352441C2
0012 Compressed Length     00000005
0016 Uncompressed Length   00000003
001A Filename Length       0004
001C Extra Length          0000
001E Filename              &#39;fred&#39;
0022 PAYLOAD               KLJ..

0027 STREAMING DATA HEADER 08074B50
002B CRC                   352441C2
002F Compressed Length     00000005
0033 Uncompressed Length   00000003

Note the Streaming bit is set but the values for CRC, Compressed length &#38; Uncompressed length are all populated in the Local Header with values that match the Streaming Data Header.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> abc.zip</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;28&nbsp;06:20:18&nbsp;2014</span>
    <span class="description">pmqs [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fix for this was quite straightforward, so created a patch.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 101092.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/MANIFEST b/MANIFEST
index 91c6e0c..8fa704a 100644
--- a/MANIFEST
+++ b/MANIFEST
@@ -49,6 +49,7 @@ t/13_bug_46303.t
 t/14_leading_separator.t
 t/15_decrypt.t
 t/16_decrypt.t
+t/17_101092.t
 t/badjpeg/expected.jpg
 t/badjpeg/source.zip
 t/common.pm
@@ -57,6 +58,7 @@ t/data/crypcomp.zip
 t/data/crypt.zip
 t/data/linux.zip
 t/data/perl.zip
+t/data/streamed.zip
 t/data/winzip.zip
 META.yml                                 Module YAML meta-data &#40;added by MakeMaker&#41;
 META.json                                Module JSON meta-data &#40;added by MakeMaker&#41;
diff --git a/lib/Archive/Zip/Member.pm b/lib/Archive/Zip/Member.pm
index 32912e9..105a95e 100644
--- a/lib/Archive/Zip/Member.pm
+++ b/lib/Archive/Zip/Member.pm
@@ -678,10 +678,16 @@ sub head {
       $self-&gt;versionNeededToExtract&#40;&#41;,
       $self-&gt;{&#39;bitFlag&#39;},
       $self-&gt;desiredCompressionMethod&#40;&#41;,
-      $self-&gt;lastModFileDateTime&#40;&#41;, $self-&gt;crc32&#40;&#41;, $mode
-      ? $self-&gt;_writeOffset&#40;&#41;       # compressed size
-      : $self-&gt;compressedSize&#40;&#41;,    # may need to be re-written later
-      $self-&gt;uncompressedSize&#40;&#41;,
+      $self-&gt;lastModFileDateTime&#40;&#41;, 
+      $self-&gt;hasDataDescriptor&#40;&#41; 
+        ? &#40;0,0,0&#41; # crc, compr &#38; uncompr all zero if data descriptor present
+        : &#40;
+            $self-&gt;crc32&#40;&#41;, 
+            $mode
+              ? $self-&gt;_writeOffset&#40;&#41;       # compressed size
+              : $self-&gt;compressedSize&#40;&#41;,    # may need to be re-written later
+            $self-&gt;uncompressedSize&#40;&#41;,
+          &#41;,
       length&#40;$self-&gt;fileName&#40;&#41;&#41;,
       length&#40;$self-&gt;localExtraField&#40;&#41;&#41;;
 }
diff --git a/t/common.pm b/t/common.pm
index cb40473..2679736 100644
--- a/t/common.pm
+++ b/t/common.pm
@@ -223,4 +223,33 @@ BEGIN {
     }
 }
 
+sub passthrough
+{
+    my $fromFile = shift ;
+    my $toFile = shift ;
+    my $keepTime = shift ;
+
+    my $z = Archive::Zip-&gt;new; 
+    $z-&gt;read&#40;$fromFile&#41;;
+    if &#40;$keepTime&#41;
+    {
+        for my $member&#40;$z-&gt;members&#40;&#41;&#41;
+        {
+            $member-&gt;setLastModFileDateTimeFromUnix&#40;$member-&gt;lastModTime&#40;&#41;&#41;;
+        }
+    }
+    $z-&gt;writeToFileNamed&#40;$toFile&#41;;
+}
+
+sub readFile
+{
+    my $name = shift ;
+    local $/;
+    open F, &#34;&lt;$name&#34;
+        or die &#34;Cannot open $name: $!\n&#34;;
+    my $data = &lt;F&gt;;
+    close F ;
+    return $data;
+}
+
 1;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 101092.tar</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;04&nbsp;23:46:24&nbsp;2015</span>
    <span class="description">PHRED [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Change applied for 1.40

Commit reference is <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/redhotpenguin/perl-Archive-Zip/commit/8c50bcc01b51d96bd29b1789ace04d34634f957c">https://github.com/redhotpenguin/perl-Archive-Zip/commit/8c50bcc01b51d96bd29b1789ace04d34634f957c</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;04&nbsp;23:46:24&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;04&nbsp;23:46:25&nbsp;2015</span>
    <span class="description">PHRED [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;05&nbsp;00:39:43&nbsp;2015</span>
    <span class="description">PHRED [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Missed a test and file - adding another commit.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
