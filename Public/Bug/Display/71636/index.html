<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #71636 for XML-Twig: Segfault with medium-sized document &#40;30k elements&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #71636 for XML-Twig: Segfault with medium-sized document &#40;30k elements&#41;</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=XML-Twig">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=XML-Twig">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=XML-Twig">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=XML-Twig">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-Twig">XML-Twig CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">71636</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=XML-Twig">XML-Twig</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
TEAM [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-37682-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
3.39    </td>
  </tr>
  <tr id="CF-37683-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




xmlbench.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/987077/513901/xmlbench.pl">
Wed Oct 12 16:11:46 2011 (431b) by TEAM [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=71636">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-987077" href="/Public/Bug/Display.html?id=71636#txn-987077">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;12&nbsp;16:11:46&nbsp;2011</span>
    <span class="description">TEAM [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Segfault with medium-sized document &#40;30k elements&#41;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/987077/513900/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/513900">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi there,

The attached code raises a segfault with perl-5.10.1 and perl-5.14.2. 

Seems fine for other XML parsers such as XML::LibXML::SAX and
XML::TreeBuilder, and in XML::Twig for smaller documents &#40;although
significantly slower than the other parsers&#41;.

Output of script on Linux/x64:

 $ perl xmlbench.pl
 Document is 1350062 chars
 Benchmark: timing 10 iterations of tree, twig...
      tree: 10.3706 wallclock secs &#40;10.09 usr +  0.27 sys = 10.36 CPU&#41; @
 0.97/s &#40;n=10&#41;
 Segmentation fault

perl -V output:

Summary of my perl5 &#40;revision 5 version 14 subversion 2&#41; configuration:
   
  Platform:
    osname=linux, osvers=2.6.35-30-generic, archname=x86_64-linux
    uname=&#39;linux roku 2.6.35-30-generic #56-ubuntu smp mon jul 11
20:01:08 utc 2011 x86_64 gnulinux &#39;
    config_args=&#39;-de -Dprefix=/home/tom/perl5/perlbrew/perls/perl-5.14.2&#39;
    hint=recommended, useposix=true, d_sigaction=define
    useithreads=undef, usemultiplicity=undef
    useperlio=define, d_sfio=undef, uselargefiles=define, usesocks=undef
    use64bitint=define, use64bitall=define, uselongdouble=undef
    usemymalloc=n, bincompat5005=undef
  Compiler:
    cc=&#39;cc&#39;, ccflags =&#39;-fno-strict-aliasing -pipe -fstack-protector
-I/usr/local/include -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64&#39;,
    optimize=&#39;-O2&#39;,
    cppflags=&#39;-fno-strict-aliasing -pipe -fstack-protector
-I/usr/local/include&#39;
    ccversion=&#39;&#39;, gccversion=&#39;4.4.5&#39;, gccosandvers=&#39;&#39;
    intsize=4, longsize=8, ptrsize=8, doublesize=8, byteorder=12345678
    d_longlong=define, longlongsize=8, d_longdbl=define, longdblsize=16
    ivtype=&#39;long&#39;, ivsize=8, nvtype=&#39;double&#39;, nvsize=8, Off_t=&#39;off_t&#39;,
lseeksize=8
    alignbytes=8, prototype=define
  Linker and Libraries:
    ld=&#39;cc&#39;, ldflags =&#39; -fstack-protector -L/usr/local/lib&#39;
    libpth=/usr/local/lib /lib/../lib /usr/lib/../lib /lib /usr/lib
/usr/lib/x86_64-linux-gnu /lib64 /usr/lib64
    libs=-lnsl -lgdbm -ldb -ldl -lm -lcrypt -lutil -lc -lgdbm_compat
    perllibs=-lnsl -ldl -lm -lcrypt -lutil -lc
    libc=/lib/libc-2.12.1.so, so=so, useshrplib=false, libperl=libperl.a
    gnulibc_version=&#39;2.12.1&#39;
  Dynamic Linking:
    dlsrc=dl_dlopen.xs, dlext=so, d_dlsymun=undef, ccdlflags=&#39;-Wl,-E&#39;
    cccdlflags=&#39;-fPIC&#39;, lddlflags=&#39;-shared -O2 -L/usr/local/lib
-fstack-protector&#39;


Characteristics of this binary &#40;from libperl&#41;: 
  Compile-time options: PERL_DONT_CREATE_GVSV PERL_MALLOC_WRAP
                        PERL_PRESERVE_IVUV USE_64_BIT_ALL USE_64_BIT_INT
                        USE_LARGE_FILES USE_PERLIO USE_PERL_ATOF
  Built under linux
  Compiled at Oct  3 2011 02:24:00
  %ENV:
   
PERL5LIB=&#34;/home/tom/.cpan:/home/tom/.cpan/lib:/home/tom/.cpan/lib/perl5:/home/tom/.cpan/lib/perl5/site_perl:/home/tom/.cpan/lib/perl5/5.10.0/i486-linux-gnu-thread-multi:&#34;
    PERLBREW_HOME=&#34;/home/tom/.perlbrew&#34;
   
PERLBREW_PATH=&#34;/home/tom/perl5/perlbrew/bin:/home/tom/perl5/perlbrew/perls/perl-5.14.2/bin&#34;
    PERLBREW_PERL=&#34;perl-5.14.2&#34;
    PERLBREW_ROOT=&#34;/home/tom/perl5/perlbrew&#34;
    PERLBREW_VERSION=&#34;0.29&#34;
    PERL_LWP_SSL_VERIFY_HOSTNAME=&#34;0&#34;
    PERL_MM_USE_DEFAULT=&#34;1&#34;
  @INC:
    /home/tom/.cpan
    /home/tom/.cpan/lib
    /home/tom/.cpan/lib/perl5
    /home/tom/.cpan/lib/perl5/site_perl
    /home/tom/.cpan/lib/perl5/5.10.0/i486-linux-gnu-thread-multi
   
/home/tom/perl5/perlbrew/perls/perl-5.14.2/lib/site_perl/5.14.2/x86_64-linux
    /home/tom/perl5/perlbrew/perls/perl-5.14.2/lib/site_perl/5.14.2
    /home/tom/perl5/perlbrew/perls/perl-5.14.2/lib/5.14.2/x86_64-linux
    /home/tom/perl5/perlbrew/perls/perl-5.14.2/lib/5.14.2

cheers,

Tom
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> xmlbench.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/987077/513901/xmlbench.pl">Download xmlbench.pl</a><br />
<span class="downloadcontenttype">text/x-perl 431b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl 
use strict;
use warnings;

use XML::Twig;
use XML::TreeBuilder;
use Benchmark qw&#40;:hireswallclock&#41;;

my $xml = q{
&lt;root&gt;
}; $xml .= q{
 &lt;child&gt;
  &lt;name&gt;test name&lt;/name&gt;
 &lt;/child&gt;
} for 0..30000;
$xml .= q{
&lt;/root&gt;
};
warn &#34;Document is &#34; . length&#40;$xml&#41; . &#34; chars\n&#34;;
timethese&#40;10, {
	twig	=&gt; sub {
		my $parsed = XML::Twig-&gt;parse&#40;$xml&#41;;
	},
	tree	=&gt; sub {
		my $parsed = XML::TreeBuilder-&gt;new-&gt;parse&#40;$xml&#41;;
	}
}&#41;;


</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-987334" href="/Public/Bug/Display.html?id=71636#txn-987334">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;13&nbsp;04:20:43&nbsp;2011</span>
    <span class="description">xmltwig [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #71636] Segfault with medium-sized document &#40;30k elements&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 13 Oct 2011 10:20:09 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mirod &lt;xmltwig [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/987334/513996/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/513996">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 5.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Interesting.

The problem kicks in around 18055 elements for me &#40;32-bit perl, gobs of 
memory on the machine&#41;. The trigger is not always the same BTW, 18054 
may or may not  cause it. The number of children seems to be the only 
important factor BTW, adding sub elements within the children does not 
change the trigger.

You don&#39;t need a loop, the segfault happens during the DESTROY phase.

The minimum test case I have found is below.


#!/usr/bin/perl
use strict;
use warnings;

use XML::Twig;

my $xml = q{&lt;root&gt;} . q{&lt;child&gt;&lt;name&gt;test name&lt;/name&gt;&lt;/child&gt;} x 20000 . 
q{&lt;/root&gt;};
warn &#34;Document is &#34; . length&#40;$xml&#41; . &#34; chars\n&#34;;

my $parsed = XML::Twig-&gt;new-&gt;parse&#40;$xml&#41;;
my $t= XML::Twig-&gt;new-&gt;parse&#40; &#39;&lt;d/&gt;&#39;&#41;;
warn &#34;done\n&#34;;
exit;


The problem occurs _after_ &#34;done&#34; is printed. So it&#39;s in the DESTROY 
phase, and it doesn&#39;t happen unless the second parse is done.
It also doesn&#39;t happen when I purge the twig as I create it &#40;ie if I add 
a handler on child that does $t-&gt;purge.

So at this point my guess is that either I messed up the cleanup of 
XML::Parser related objects, or its a bug in the layers below, either 
XML::Parser or perl itself.

I&#39;ll keep on investigating and let you know.

Thanks for the report.

-- 
mirod


On 10/12/2011 10:11 PM, Thomas Edward Alexander Molesworth via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Wed Oct 12 16:11:46 2011: Request 71636 was acted upon.
&gt; Transaction: Ticket created by TEAM
&gt;         Queue: XML-Twig
&gt;       Subject: Segfault with medium-sized document &#40;30k elements&#41;
&gt;     Broken in: 3.39
&gt;      Severity: &#40;no value&#41;
&gt;         Owner: Nobody
&gt;    Requestors: TEAM@cpan.org
&gt;        Status: new
&gt;   Ticket&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=71636">https://rt.cpan.org/Ticket/Display.html?id=71636</a></span>&gt;
&gt;
&gt;
&gt; Hi there,
&gt;
&gt; The attached code raises a segfault with perl-5.10.1 and perl-5.14.2.
&gt;
&gt; Seems fine for other XML parsers such as XML::LibXML::SAX and
&gt; XML::TreeBuilder, and in XML::Twig for smaller documents &#40;although
&gt; significantly slower than the other parsers&#41;.
&gt;
&gt; Output of script on Linux/x64:
&gt;
&gt;   $ perl xmlbench.pl
&gt;   Document is 1350062 chars
&gt;   Benchmark: timing 10 iterations of tree, twig...
&gt;        tree: 10.3706 wallclock secs &#40;10.09 usr +  0.27 sys = 10.36 CPU&#41; @
&gt;   0.97/s &#40;n=10&#41;
&gt;   Segmentation fault
&gt;
&gt; perl -V output:
&gt;
&gt; Summary of my perl5 &#40;revision 5 version 14 subversion 2&#41; configuration:
&gt;
&gt;    Platform:
&gt;      osname=linux, osvers=2.6.35-30-generic, archname=x86_64-linux
&gt;      uname=&#39;linux roku 2.6.35-30-generic #56-ubuntu smp mon jul 11
&gt; 20:01:08 utc 2011 x86_64 gnulinux &#39;
&gt;      config_args=&#39;-de -Dprefix=/home/tom/perl5/perlbrew/perls/perl-5.14.2&#39;
&gt;      hint=recommended, useposix=true, d_sigaction=define
&gt;      useithreads=undef, usemultiplicity=undef
&gt;      useperlio=define, d_sfio=undef, uselargefiles=define, usesocks=undef
&gt;      use64bitint=define, use64bitall=define, uselongdouble=undef
&gt;      usemymalloc=n, bincompat5005=undef
&gt;    Compiler:
&gt;      cc=&#39;cc&#39;, ccflags =&#39;-fno-strict-aliasing -pipe -fstack-protector
&gt; -I/usr/local/include -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64&#39;,
&gt;      optimize=&#39;-O2&#39;,
&gt;      cppflags=&#39;-fno-strict-aliasing -pipe -fstack-protector
&gt; -I/usr/local/include&#39;
&gt;      ccversion=&#39;&#39;, gccversion=&#39;4.4.5&#39;, gccosandvers=&#39;&#39;
&gt;      intsize=4, longsize=8, ptrsize=8, doublesize=8, byteorder=12345678
&gt;      d_longlong=define, longlongsize=8, d_longdbl=define, longdblsize=16
&gt;      ivtype=&#39;long&#39;, ivsize=8, nvtype=&#39;double&#39;, nvsize=8, Off_t=&#39;off_t&#39;,
&gt; lseeksize=8
&gt;      alignbytes=8, prototype=define
&gt;    Linker and Libraries:
&gt;      ld=&#39;cc&#39;, ldflags =&#39; -fstack-protector -L/usr/local/lib&#39;
&gt;      libpth=/usr/local/lib /lib/../lib /usr/lib/../lib /lib /usr/lib
&gt; /usr/lib/x86_64-linux-gnu /lib64 /usr/lib64
&gt;      libs=-lnsl -lgdbm -ldb -ldl -lm -lcrypt -lutil -lc -lgdbm_compat
&gt;      perllibs=-lnsl -ldl -lm -lcrypt -lutil -lc
&gt;      libc=/lib/libc-2.12.1.so, so=so, useshrplib=false, libperl=libperl.a
&gt;      gnulibc_version=&#39;2.12.1&#39;
&gt;    Dynamic Linking:
&gt;      dlsrc=dl_dlopen.xs, dlext=so, d_dlsymun=undef, ccdlflags=&#39;-Wl,-E&#39;
&gt;      cccdlflags=&#39;-fPIC&#39;, lddlflags=&#39;-shared -O2 -L/usr/local/lib
&gt; -fstack-protector&#39;
&gt;
&gt;
&gt; Characteristics of this binary &#40;from libperl&#41;:
&gt;    Compile-time options: PERL_DONT_CREATE_GVSV PERL_MALLOC_WRAP
&gt;                          PERL_PRESERVE_IVUV USE_64_BIT_ALL USE_64_BIT_INT
&gt;                          USE_LARGE_FILES USE_PERLIO USE_PERL_ATOF
&gt;    Built under linux
&gt;    Compiled at Oct  3 2011 02:24:00
&gt;    %ENV:
&gt;
&gt; PERL5LIB=&#34;/home/tom/.cpan:/home/tom/.cpan/lib:/home/tom/.cpan/lib/perl5:/home/tom/.cpan/lib/perl5/site_perl:/home/tom/.cpan/lib/perl5/5.10.0/i486-linux-gnu-thread-multi:&#34;
&gt;      PERLBREW_HOME=&#34;/home/tom/.perlbrew&#34;
&gt;
&gt; PERLBREW_PATH=&#34;/home/tom/perl5/perlbrew/bin:/home/tom/perl5/perlbrew/perls/perl-5.14.2/bin&#34;
&gt;      PERLBREW_PERL=&#34;perl-5.14.2&#34;
&gt;      PERLBREW_ROOT=&#34;/home/tom/perl5/perlbrew&#34;
&gt;      PERLBREW_VERSION=&#34;0.29&#34;
&gt;      PERL_LWP_SSL_VERIFY_HOSTNAME=&#34;0&#34;
&gt;      PERL_MM_USE_DEFAULT=&#34;1&#34;
&gt;    @INC:
&gt;      /home/tom/.cpan
&gt;      /home/tom/.cpan/lib
&gt;      /home/tom/.cpan/lib/perl5
&gt;      /home/tom/.cpan/lib/perl5/site_perl
&gt;      /home/tom/.cpan/lib/perl5/5.10.0/i486-linux-gnu-thread-multi
&gt;
&gt; /home/tom/perl5/perlbrew/perls/perl-5.14.2/lib/site_perl/5.14.2/x86_64-linux
&gt;      /home/tom/perl5/perlbrew/perls/perl-5.14.2/lib/site_perl/5.14.2
&gt;      /home/tom/perl5/perlbrew/perls/perl-5.14.2/lib/5.14.2/x86_64-linux
&gt;      /home/tom/perl5/perlbrew/perls/perl-5.14.2/lib/5.14.2
&gt;
&gt; cheers,
&gt;
&gt; Tom
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-987337" href="/Public/Bug/Display.html?id=71636#txn-987337">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;13&nbsp;04:20:44&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1007819" href="/Public/Bug/Display.html?id=71636#txn-1007819">#</a>      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;05&nbsp;09:45:32&nbsp;2011</span>
    <span class="description">vcizek [...] suse.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> vcizek [...] suse.cz</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1007819/525168/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/525168">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Oct 13 04:20:43 2011, xmltwig@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Interesting.
&gt; 
&gt; The problem kicks in around 18055 elements for me &#40;32-bit perl, gobs of 
&gt; memory on the machine&#41;. The trigger is not always the same BTW, 18054 
&gt; may or may not  cause it. The number of children seems to be the only 
&gt; important factor BTW, adding sub elements within the children does not 
&gt; change the trigger.
&gt; 
</div>
On my 64bit machine the treshold is around 18695.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; You don&#39;t need a loop, the segfault happens during the DESTROY phase.
&gt; 
&gt; The minimum test case I have found is below.
&gt; 
&gt; 
&gt; #!/usr/bin/perl
&gt; use strict;
&gt; use warnings;
&gt; 
&gt; use XML::Twig;
&gt; 
&gt; my $xml = q{&lt;root&gt;} . q{&lt;child&gt;&lt;name&gt;test name&lt;/name&gt;&lt;/child&gt;} x 20000 . 
&gt; q{&lt;/root&gt;};
&gt; warn &#34;Document is &#34; . length&#40;$xml&#41; . &#34; chars\n&#34;;
&gt; 
&gt; my $parsed = XML::Twig-&gt;new-&gt;parse&#40;$xml&#41;;
&gt; my $t= XML::Twig-&gt;new-&gt;parse&#40; &#39;&lt;d/&gt;&#39;&#41;;
&gt; warn &#34;done\n&#34;;
&gt; exit;
&gt; 
&gt; 
&gt; The problem occurs _after_ &#34;done&#34; is printed. So it&#39;s in the DESTROY 
&gt; phase, and it doesn&#39;t happen unless the second parse is done.
</div>
I can reproduce it without the second parse.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It also doesn&#39;t happen when I purge the twig as I create it &#40;ie if I add 
&gt; a handler on child that does $t-&gt;purge.
&gt; 
&gt; So at this point my guess is that either I messed up the cleanup of 
&gt; XML::Parser related objects, or its a bug in the layers below, either 
&gt; XML::Parser or perl itself.
&gt; 
</div>
A workaround that works for me is forcing the module not to use 
weak references. Eg. setting weakrefs = 0.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1008615" href="/Public/Bug/Display.html?id=71636#txn-1008615">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;06&nbsp;13:34:24&nbsp;2011</span>
    <span class="description">xmltwig [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #71636] Segfault with medium-sized document &#40;30k elements&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 06 Dec 2011 19:33:43 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mirod &lt;xmltwig [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1008615/525545/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/525545">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 12/05/2011 03:45 PM, Vita Cizek via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         Queue: XML-Twig
&gt;   Ticket&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=71636">https://rt.cpan.org/Ticket/Display.html?id=71636</a></span>&gt;
&gt;
&gt; On Thu Oct 13 04:20:43 2011, xmltwig@gmail.com wrote:
<div class="message-stanza open">&gt;&gt; Interesting.
&gt;&gt;
&gt;&gt; The problem kicks in around 18055 elements for me &#40;32-bit perl, gobs of
&gt;&gt; memory on the machine&#41;. The trigger is not always the same BTW, 18054
&gt;&gt; may or may not  cause it. The number of children seems to be the only
&gt;&gt; important factor BTW, adding sub elements within the children does not
&gt;&gt; change the trigger.
&gt;&gt;
</div>&gt;
&gt; On my 64bit machine the treshold is around 18695.
&gt;
<div class="message-stanza open">&gt;&gt; You don&#39;t need a loop, the segfault happens during the DESTROY phase.
&gt;&gt;
&gt;&gt; The minimum test case I have found is below.
&gt;&gt;
&gt;&gt;
&gt;&gt; #!/usr/bin/perl
&gt;&gt; use strict;
&gt;&gt; use warnings;
&gt;&gt;
&gt;&gt; use XML::Twig;
&gt;&gt;
&gt;&gt; my $xml = q{&lt;root&gt;} . q{&lt;child&gt;&lt;name&gt;test name&lt;/name&gt;&lt;/child&gt;} x 20000 .
&gt;&gt; q{&lt;/root&gt;};
&gt;&gt; warn &#34;Document is &#34; . length&#40;$xml&#41; . &#34; chars\n&#34;;
&gt;&gt;
&gt;&gt; my $parsed = XML::Twig-&gt;new-&gt;parse&#40;$xml&#41;;
&gt;&gt; my $t= XML::Twig-&gt;new-&gt;parse&#40; &#39;&lt;d/&gt;&#39;&#41;;
&gt;&gt; warn &#34;done\n&#34;;
&gt;&gt; exit;
&gt;&gt;
&gt;&gt;
&gt;&gt; The problem occurs _after_ &#34;done&#34; is printed. So it&#39;s in the DESTROY
&gt;&gt; phase, and it doesn&#39;t happen unless the second parse is done.
</div>&gt;
&gt; I can reproduce it without the second parse.
&gt;
<div class="message-stanza open">&gt;&gt; It also doesn&#39;t happen when I purge the twig as I create it &#40;ie if I add
&gt;&gt; a handler on child that does $t-&gt;purge.
&gt;&gt;
&gt;&gt; So at this point my guess is that either I messed up the cleanup of
&gt;&gt; XML::Parser related objects, or its a bug in the layers below, either
&gt;&gt; XML::Parser or perl itself.
&gt;&gt;
</div>&gt;
&gt; A workaround that works for me is forcing the module not to use
&gt; weak references. Eg. setting weakrefs = 0.
&gt;
</div>
Indeed this would work, since I believe the problem comes from a bug in 
weaken

The bug actually seems to be fixed in 5.15.5, so there is hope.

-- 
mirod
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1008719" href="/Public/Bug/Display.html?id=71636#txn-1008719">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;06&nbsp;17:05:51&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1008719/525612/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/525612">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Dec 06 13:34:24 2011, xmltwig@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 12/05/2011 03:45 PM, Vita Cizek via RT wrote:
<div class="message-stanza open">&gt; &gt;         Queue: XML-Twig
&gt; &gt;   Ticket&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=71636">https://rt.cpan.org/Ticket/Display.html?id=71636</a></span>&gt;
&gt; &gt;
&gt; &gt; On Thu Oct 13 04:20:43 2011, xmltwig@gmail.com wrote:
<div class="message-stanza open">&gt; &gt;&gt; Interesting.
&gt; &gt;&gt;
&gt; &gt;&gt; The problem kicks in around 18055 elements for me &#40;32-bit perl, gobs of
&gt; &gt;&gt; memory on the machine&#41;. The trigger is not always the same BTW, 18054
&gt; &gt;&gt; may or may not  cause it. The number of children seems to be the only
&gt; &gt;&gt; important factor BTW, adding sub elements within the children does not
&gt; &gt;&gt; change the trigger.
&gt; &gt;&gt;
</div>&gt; &gt;
&gt; &gt; On my 64bit machine the treshold is around 18695.
&gt; &gt;
<div class="message-stanza open">&gt; &gt;&gt; You don&#39;t need a loop, the segfault happens during the DESTROY phase.
&gt; &gt;&gt;
&gt; &gt;&gt; The minimum test case I have found is below.
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt; #!/usr/bin/perl
&gt; &gt;&gt; use strict;
&gt; &gt;&gt; use warnings;
&gt; &gt;&gt;
&gt; &gt;&gt; use XML::Twig;
&gt; &gt;&gt;
&gt; &gt;&gt; my $xml = q{&lt;root&gt;} . q{&lt;child&gt;&lt;name&gt;test name&lt;/name&gt;&lt;/child&gt;} x 20000 .
&gt; &gt;&gt; q{&lt;/root&gt;};
&gt; &gt;&gt; warn &#34;Document is &#34; . length&#40;$xml&#41; . &#34; chars\n&#34;;
&gt; &gt;&gt;
&gt; &gt;&gt; my $parsed = XML::Twig-&gt;new-&gt;parse&#40;$xml&#41;;
&gt; &gt;&gt; my $t= XML::Twig-&gt;new-&gt;parse&#40; &#39;&lt;d/&gt;&#39;&#41;;
&gt; &gt;&gt; warn &#34;done\n&#34;;
&gt; &gt;&gt; exit;
&gt; &gt;&gt;
&gt; &gt;&gt;
&gt; &gt;&gt; The problem occurs _after_ &#34;done&#34; is printed. So it&#39;s in the DESTROY
&gt; &gt;&gt; phase, and it doesn&#39;t happen unless the second parse is done.
</div>&gt; &gt;
&gt; &gt; I can reproduce it without the second parse.
&gt; &gt;
<div class="message-stanza open">&gt; &gt;&gt; It also doesn&#39;t happen when I purge the twig as I create it &#40;ie if I add
&gt; &gt;&gt; a handler on child that does $t-&gt;purge.
&gt; &gt;&gt;
&gt; &gt;&gt; So at this point my guess is that either I messed up the cleanup of
&gt; &gt;&gt; XML::Parser related objects, or its a bug in the layers below, either
&gt; &gt;&gt; XML::Parser or perl itself.
&gt; &gt;&gt;
</div>&gt; &gt;
&gt; &gt; A workaround that works for me is forcing the module not to use
&gt; &gt; weak references. Eg. setting weakrefs = 0.
&gt; &gt;
</div>&gt; 
&gt; Indeed this would work, since I believe the problem comes from a bug in 
&gt; weaken
&gt; 
&gt; The bug actually seems to be fixed in 5.15.5, so there is hope.
</div>
Do the nodes an an XML::Twig class have references to their siblings?  If so, this may be 
related to &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/rt3/Ticket/Display.html?id=44225">https://rt.perl.org/rt3/Ticket/Display.html?id=44225</a></span>&gt;, in which case turning off 
weak references only works by chance.  If that is the case, you could create a DESTROY 
method to break links between sub-nodes or even free them one-by-one, starting with the 
innermost, to work around the problem in 5.14 and earlier.  This is just a guess off the top of 
my head, without actually looking into the problem very far.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1142018" href="/Public/Bug/Display.html?id=71636#txn-1142018">#</a>      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;13&nbsp;05:41:38&nbsp;2012</span>
    <span class="description">MIROD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1142018/600593/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/600593">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 44b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is a Perl bug, fixed in 5.16+

__
mirod
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1142020" href="/Public/Bug/Display.html?id=71636#txn-1142020">#</a>      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;13&nbsp;05:41:39&nbsp;2012</span>
    <span class="description">MIROD [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.51149</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
