<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #54529 for Mail-Box: mishandling a 0-length multipart preamble</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #54529 for Mail-Box: mishandling a 0-length multipart preamble</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Mail-Box">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Mail-Box">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Mail-Box">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Mail-Box">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-Box">Mail-Box CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">54529</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Mail-Box">Mail-Box</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
JGMYERS [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-19874-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.082    </td>
  </tr>
  <tr id="CF-19875-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




Mail-Box-2.082-preamble.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/732476/378430/Mail-Box-2.082-preamble.diff">
Thu Feb 11 18:13:27 2010 (2k) by JGMYERS [...] cpan.org
</a>
</font></li>
</ul>


Mail-Box-2.082-preamble.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/739709/382329/Mail-Box-2.082-preamble.patch">
Fri Feb 26 13:03:12 2010 (5.4k) by JGMYERS [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=54529">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-732476" href="/Public/Bug/Display.html?id=54529#txn-732476">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;11&nbsp;18:13:27&nbsp;2010</span>
    <span class="description">JGMYERS [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> mishandling a 0-length multipart preamble</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/732476/378429/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/378429">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 286b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The multipart parser does not distinguish between a 0-length preamble
and an omitted preamble.  Reading in a multipart with a 0-length
preamble and then writing it out again causes the preamble to be
deleted, breaking any enclosing digital signature.

The attached patch contains a fix.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Mail-Box-2.082-preamble.diff</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/732476/378430/Mail-Box-2.082-preamble.diff">Download Mail-Box-2.082-preamble.diff</a><br />
<span class="downloadcontenttype">text/x-diff 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ru ./lib/Mail/Box/Parser/Perl.pm ../Mail-Box-2.082-2preamble/lib/Mail/Box/Parser/Perl.pm
--- ./lib/Mail/Box/Parser/Perl.pm	2010-02-03 17:25:45.000000000 -0800
+++ ../Mail-Box-2.082-2preamble/lib/Mail/Box/Parser/Perl.pm	2010-02-04 10:14:10.000000000 -0800
@@ -170,10 +170,17 @@
             push @$lines, $line;
         }
 
-        if&#40;@$lines &#38;&#38; $lines-&gt;[-1] =~ s/&#40;\r?\n&#41;\z//&#41;
-        {   $file-&gt;seek&#40;-length&#40;$1&#41;, 1&#41;;
-            pop @$lines if length&#40;$lines-&gt;[-1]&#41;==0;
-        }
+        if&#40;@$lines&#41;
+	{
+	    if &#40;$lines-&gt;[-1] =~ s/&#40;\r?\n&#41;\z//&#41;
+	    {   $file-&gt;seek&#40;-length&#40;$1&#41;, 1&#41;;
+		pop @$lines if length&#40;$lines-&gt;[-1]&#41;==0;
+	    }
+	}
+	else
+	{
+	    $lines = undef;
+	}
     }
     else # File without separators.
     {   $lines = ref $file eq &#39;Mail::Box::FastScalar&#39;
@@ -182,11 +189,11 @@
 
     my $bodyend = $file-&gt;tell;
 
-    if&#40;$self-&gt;{MBPP_strip_gt}&#41;
+    if&#40;$self-&gt;{MBPP_strip_gt} &#38;&#38; $lines&#41;
     {   map { s/^\&gt;&#40;\&gt;*From\s&#41;/$1/ } @$lines;
     }
   
-    unless&#40;$self-&gt;{MBPP_trusted}&#41; { s/\015$// for @$lines }
+    unless&#40;$self-&gt;{MBPP_trusted} || !$lines&#41; { s/\015$// for @$lines }
 #warn &#34;&#40;$bodyend, $msgend, &#34;.@$lines, &#34;&#41;\n&#34;;
 
     &#40;$bodyend, $lines, $msgend&#41;;
Only in ../Mail-Box-2.082-2preamble/lib/Mail/Box/Parser: Perl.pm~
diff -ru ./lib/Mail/Message/Body/Multipart.pm ../Mail-Box-2.082-2preamble/lib/Mail/Message/Body/Multipart.pm
--- ./lib/Mail/Message/Body/Multipart.pm	2010-02-03 17:25:44.000000000 -0800
+++ ../Mail-Box-2.082-2preamble/lib/Mail/Message/Body/Multipart.pm	2010-02-04 10:11:08.000000000 -0800
@@ -240,7 +240,7 @@
        -&gt;read&#40;$parser, $head&#41;;
 
     $self-&gt;{MMBM_preamble} = $preamble
-        if defined $preamble &#38;&#38; $preamble-&gt;nrLines &gt; 0;
+        if defined $preamble;
 
     # Get the parts.
 
@@ -265,7 +265,7 @@
         -&gt;read&#40;$parser, $head&#41;;
 
     $self-&gt;{MMBM_epilogue} = $epilogue
-        if defined $epilogue &#38;&#38; $epilogue-&gt;nrLines &gt; 0;
+        if defined $epilogue;
 
     my $end = defined $epilogue ? &#40;$epilogue-&gt;fileLocation&#41;[1]
             : @parts            ? &#40;$parts[-1]-&gt;fileLocation&#41;[1]
Only in ../Mail-Box-2.082-2preamble/lib/Mail/Message/Body: Multipart.pm~
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-732479" href="/Public/Bug/Display.html?id=54529#txn-732479">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;11&nbsp;18:18:45&nbsp;2010</span>
    <span class="description">solutions [...] overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #54529] mishandling a 0-length multipart preamble</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 12 Feb 2010 00:17:48 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> JGMYERS via RT &lt;bug-Mail-Box [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;solutions [...] overmeer.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/732479/378433/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/378433">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">* JGMYERS via RT &#40;bug-Mail-Box@rt.cpan.org&#41; [100211 23:13]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thu Feb 11 18:13:27 2010: Request 54529 was acted upon.
&gt; Transaction: Ticket created by JGMYERS
&gt;        Queue: Mail-Box
&gt;      Subject: mishandling a 0-length multipart preamble
&gt;    Broken in: 2.082
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54529">https://rt.cpan.org/Ticket/Display.html?id=54529</a></span> &gt;
&gt; 
&gt; The multipart parser does not distinguish between a 0-length preamble
&gt; and an omitted preamble.  Reading in a multipart with a 0-length
&gt; preamble and then writing it out again causes the preamble to be
&gt; deleted, breaking any enclosing digital signature.
</div>
If I remember well &#40;it was a long time ago that I read the specs&#41;
the content of the preamble is totally useless and without meaning.
So, probably it should not be included in the signing...

On the other hand, this also eases the path to take your patch,
because people cannot complain that the preamble changes.  Looks
a valid change.
-- 
Thanks for your contribution,

               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-732482" href="/Public/Bug/Display.html?id=54529#txn-732482">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;11&nbsp;18:18:50&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-732483" href="/Public/Bug/Display.html?id=54529#txn-732483">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;11&nbsp;18:26:57&nbsp;2010</span>
    <span class="description">solutions [...] overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #54529] mishandling a 0-length multipart preamble</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 12 Feb 2010 00:26:01 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> JGMYERS via RT &lt;bug-Mail-Box [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;solutions [...] overmeer.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/732483/378436/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/378436">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">* JGMYERS via RT &#40;bug-Mail-Box@rt.cpan.org&#41; [100211 23:13]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thu Feb 11 18:13:27 2010: Request 54529 was acted upon.
&gt; Transaction: Ticket created by JGMYERS
&gt;        Queue: Mail-Box
&gt;      Subject: mishandling a 0-length multipart preamble
&gt;    Broken in: 2.082
&gt;     Severity: Normal
&gt;        Owner: Nobody
&gt;   Requestors: JGMYERS@cpan.org
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=54529">https://rt.cpan.org/Ticket/Display.html?id=54529</a></span> &gt;
&gt; 
&gt; The multipart parser does not distinguish between a 0-length preamble
&gt; and an omitted preamble.  Reading in a multipart with a 0-length
&gt; preamble and then writing it out again causes the preamble to be
&gt; deleted, breaking any enclosing digital signature.
&gt; 
&gt; The attached patch contains a fix.
</div>
The patch produces crashes in the regression tests.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-732538" href="/Public/Bug/Display.html?id=54529#txn-732538">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;11&nbsp;20:36:01&nbsp;2010</span>
    <span class="description">JGMYERS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/732538/378468/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/378468">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 305b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The patch produces crashes in the regression tests.
</div>
Could you be more specific?  It&#39;s passing for me on 2.093 &#40;except for
55locking/90multi which fails even without the patch&#41;.  On 2.082, the
harness won&#39;t run at all even without the patch due to an apparent
failure to import TAP::Parser::Aggregator.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-739709" href="/Public/Bug/Display.html?id=54529#txn-739709">#</a>      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;26&nbsp;13:03:12&nbsp;2010</span>
    <span class="description">JGMYERS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/739709/382328/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/382328">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 240b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The patch needed more work in the handling of epilogues. It now handles
the difference between a 0-length and an omitted epilogue and changes
the default for new multiparts to have a 0-length epilogue &#40;which is
what it used to generate&#41;.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Mail-Box-2.082-preamble.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/739709/382329/Mail-Box-2.082-preamble.patch">Download Mail-Box-2.082-preamble.patch</a><br />
<span class="downloadcontenttype">text/x-diff 5.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ru ./lib/Mail/Box/Parser/Perl.pm ../Mail-Box-2.082-2preamble/lib/Mail/Box/Parser/Perl.pm
--- ./lib/Mail/Box/Parser/Perl.pm	2010-02-03 17:25:45.000000000 -0800
+++ ../Mail-Box-2.082-2preamble/lib/Mail/Box/Parser/Perl.pm	2010-02-04 10:14:10.000000000 -0800
@@ -170,10 +170,17 @@
             push @$lines, $line;
         }
 
-        if&#40;@$lines &#38;&#38; $lines-&gt;[-1] =~ s/&#40;\r?\n&#41;\z//&#41;
-        {   $file-&gt;seek&#40;-length&#40;$1&#41;, 1&#41;;
-            pop @$lines if length&#40;$lines-&gt;[-1]&#41;==0;
-        }
+        if&#40;@$lines&#41;
+	{
+	    if &#40;$lines-&gt;[-1] =~ s/&#40;\r?\n&#41;\z//&#41;
+	    {   $file-&gt;seek&#40;-length&#40;$1&#41;, 1&#41;;
+		pop @$lines if length&#40;$lines-&gt;[-1]&#41;==0;
+	    }
+	}
+	else
+	{
+	    $lines = undef;
+	}
     }
     else # File without separators.
     {   $lines = ref $file eq &#39;Mail::Box::FastScalar&#39;
@@ -182,11 +189,11 @@
 
     my $bodyend = $file-&gt;tell;
 
-    if&#40;$self-&gt;{MBPP_strip_gt}&#41;
+    if&#40;$self-&gt;{MBPP_strip_gt} &#38;&#38; $lines&#41;
     {   map { s/^\&gt;&#40;\&gt;*From\s&#41;/$1/ } @$lines;
     }
   
-    unless&#40;$self-&gt;{MBPP_trusted}&#41; { s/\015$// for @$lines }
+    unless&#40;$self-&gt;{MBPP_trusted} || !$lines&#41; { s/\015$// for @$lines }
 #warn &#34;&#40;$bodyend, $msgend, &#34;.@$lines, &#34;&#41;\n&#34;;
 
     &#40;$bodyend, $lines, $msgend&#41;;
Only in ../Mail-Box-2.082-2preamble/lib/Mail/Box/Parser: Perl.pm~
diff -ru ./lib/Mail/Message/Body/Multipart.pm ../Mail-Box-2.082-2preamble/lib/Mail/Message/Body/Multipart.pm
--- ./lib/Mail/Message/Body/Multipart.pm	2010-02-03 17:25:44.000000000 -0800
+++ ../Mail-Box-2.082-2preamble/lib/Mail/Message/Body/Multipart.pm	2010-02-25 09:21:19.000000000 -0800
@@ -44,6 +44,7 @@
        if defined $preamble &#38;&#38; ! ref $preamble;
     
     my $epilogue = $args-&gt;{epilogue};
+    $epilogue = &#39;&#39; unless exists&#40;$args-&gt;{epilogue}&#41;;
     $epilogue    = Mail::Message::Body-&gt;new&#40;data =&gt; $epilogue&#41;
        if defined $epilogue &#38;&#38; ! ref $epilogue;
     
@@ -92,7 +93,7 @@
 
 sub nrLines&#40;&#41;
 {   my $self = shift;
-    my $nr   = 1;     # trailing boundary
+    my $nr   = 0;
 
     if&#40;my $preamble = $self-&gt;preamble&#41;
     {   $nr += $preamble-&gt;nrLines;
@@ -104,7 +105,7 @@
         $nr++ if $part-&gt;body-&gt;endsOnNewline;
     }
 
-    if&#40;my $epilogue = $self-&gt;epilogue&#41; { $nr += $epilogue-&gt;nrLines }
+    if&#40;my $epilogue = $self-&gt;epilogue&#41; { $nr += $epilogue-&gt;nrLines + 1}
     $nr;
 }
 
@@ -112,13 +113,13 @@
 {   my $self   = shift;
     my $bbytes = length&#40;$self-&gt;boundary&#41; +4;  # \n--$b\n
 
-    my $bytes  = $bbytes +2;   # last boundary, \n--$b--\n
+    my $bytes  = $bbytes +1;   # last boundary, \n--$b--
     if&#40;my $preamble = $self-&gt;preamble&#41;
          { $bytes += $preamble-&gt;size }
     else { $bytes -= 1 }      # no leading \n
 
     $bytes += $bbytes + $_-&gt;size foreach $self-&gt;parts&#40;&#39;ACTIVE&#39;&#41;;
-    if&#40;my $epilogue = $self-&gt;epilogue&#41; { $bytes += $epilogue-&gt;size }
+    if&#40;my $epilogue = $self-&gt;epilogue&#41; { $bytes += $epilogue-&gt;size + 1}
 
     $bytes;
 }
@@ -145,9 +146,10 @@
     if&#40;!@lines&#41; { ; }
     elsif&#40;$lines[-1] =~ m/\n$/&#41; { push @lines, &#34;\n&#34; }
     else { $lines[-1] .= &#34;\n&#34; }
-    push @lines, &#34;--$boundary--\n&#34;;
+    push @lines, &#34;--$boundary--&#34;;
 
     my $epilogue = $self-&gt;epilogue;
+    $lines[-1] .= &#34;\n&#34; if $epilogue;
     push @lines, $epilogue-&gt;lines if $epilogue;
 
     wantarray ? @lines : \@lines;
@@ -180,7 +182,7 @@
             $part-&gt;print&#40;$out&#41;;
         }
         print $out &#34;\n&#34; if $count++;
-        print $out &#34;--$boundary--\n&#34;;
+        print $out &#34;--$boundary--&#34;;
     }
     else
     {   foreach my $part &#40;$self-&gt;parts&#40;&#39;ACTIVE&#39;&#41;&#41;
@@ -189,10 +191,10 @@
             $part-&gt;print&#40;$out&#41;;
         }
         $out-&gt;print&#40;&#34;\n&#34;&#41; if $count++;
-        $out-&gt;print&#40;&#34;--$boundary--\n&#34;&#41;;
+        $out-&gt;print&#40;&#34;--$boundary--&#34;&#41;;
     }
 
-    if&#40;my $epilogue = $self-&gt;epilogue&#41; { $epilogue-&gt;print&#40;$out&#41; }
+    if&#40;my $epilogue = $self-&gt;epilogue&#41; { $out-&gt;print&#40;&#34;\n&#34;&#41;; $epilogue-&gt;print&#40;$out&#41; }
 
     $self;
 }
@@ -240,7 +242,7 @@
        -&gt;read&#40;$parser, $head&#41;;
 
     $self-&gt;{MMBM_preamble} = $preamble
-        if defined $preamble &#38;&#38; $preamble-&gt;nrLines &gt; 0;
+        if defined $preamble;
 
     # Get the parts.
 
@@ -265,10 +267,10 @@
         -&gt;read&#40;$parser, $head&#41;;
 
     $self-&gt;{MMBM_epilogue} = $epilogue
-        if defined $epilogue &#38;&#38; $epilogue-&gt;nrLines &gt; 0;
+        if defined $epilogue;
 
     my $end = defined $epilogue ? &#40;$epilogue-&gt;fileLocation&#41;[1]
-            : @parts            ? &#40;$parts[-1]-&gt;fileLocation&#41;[1]
+            : @parts            ? &#40;$parts[-1]-&gt;body-&gt;fileLocation&#41;[1]
             : defined $preamble ? &#40;$preamble-&gt;fileLocation&#41;[1]
             :                      $begin;
 
Only in ../Mail-Box-2.082-2preamble/lib/Mail/Message/Body: Multipart.pm~
diff -ru ./lib/Mail/Message/Body/Multipart.pod ../Mail-Box-2.082-2preamble/lib/Mail/Message/Body/Multipart.pod
--- ./lib/Mail/Message/Body/Multipart.pod	2010-02-03 17:25:44.000000000 -0800
+++ ../Mail-Box-2.082-2preamble/lib/Mail/Message/Body/Multipart.pod	2010-02-25 09:24:03.000000000 -0800
@@ -85,7 +85,7 @@
  description        Mail::Message::Body  undef
  disposition        Mail::Message::Body  undef
  eol                Mail::Message::Body  &#39;NATIVE&#39;
- epilogue                            undef
+ epilogue                            &#39;&#39;
  file               Mail::Message::Body  undef
  log                Mail::Reporter   &#39;WARNINGS&#39;
  message            Mail::Message::Body  undef
Only in ../Mail-Box-2.082-2preamble/lib/Mail/Message/Body: Multipart.pod~
Only in ../Mail-Box-2.082-2preamble/: Makefile.old
Only in ../Mail-Box-2.082-2preamble/tests: msg-15830-1.txt
Only in ../Mail-Box-2.082-2preamble/tests: msg-19215-1.txt
Only in ./tests: msg-22165-1.txt
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-785778" href="/Public/Bug/Display.html?id=54529#txn-785778">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;03&nbsp;03:46:41&nbsp;2010</span>
    <span class="description">MARKOV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/785778/407050/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/407050">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 18b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">got fixed in 2.094
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-785780" href="/Public/Bug/Display.html?id=54529#txn-785780">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;03&nbsp;03:46:41&nbsp;2010</span>
    <span class="description">MARKOV [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.40521</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
