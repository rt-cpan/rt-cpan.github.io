<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #132378 for Struct-Dumb: Global Destruction not properly detected &#40;only?&#41; on Travis &#40;!?&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #132378 for Struct-Dumb: Global Destruction not properly detected &#40;only?&#41; on Travis &#40;!?&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Struct-Dumb/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Struct-Dumb/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Struct-Dumb/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Struct-Dumb/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Struct-Dumb">Struct-Dumb CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">132378</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Struct-Dumb/Active/">Struct-Dumb</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
corion [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-245274-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-245275-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;19&nbsp;07:51:41&nbsp;2020</span>
    <span class="description">corion [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Global Destruction not properly detected &#40;only?&#41; on Travis &#40;!?&#41;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Struct::Dumb is an optional upstream prerequisite of WWW::Mechanize::Chrome and it fails &#40;only on Travis&#41; a compile test, because there, Struct::Dumb tries to load Data::Dump::Filtered from the destructor, see the error message below.

This is really weird - the offending test merely loads the module to check it compiles, and that triggers the incorrect global destruction detection. It happens on Perl 5.22 through 5.30, but not on the system perl &#40;5.22 as well&#41;.

Maybe using 
    ${^GLOBAL_PHASE} eq &#34;DESTRUCT&#34;
is better, at least for Perl versions above 5.14 ?

A fairly reduced case to reproduce this is just loading Struct::Dumb:

package StructDumbDebug;
use strict;
#use IO::Async::Loop;
#use IO::Async::Stream;
use Struct::Dumb;

our $VERSION = &#39;0.48&#39;;

1;

If I can be of help here, please tell me - hopefully, the cause is obvious to you, because I&#39;m not sure what the difference between the Perl versions is that makes your detection of Global Destruction different from ${^GLOBAL_PHASE} and why this breaks now &#40;instead of earlier&#41;.

Thanks,
-max

<span class="clickylink"><a target="new" rel="nofollow" href="https://travis-ci.org/github/Corion/WWW-Mechanize-Chrome/jobs/676846818">https://travis-ci.org/github/Corion/WWW-Mechanize-Chrome/jobs/676846818</a></span>

# lib/StructDumbDebug.pm syntax OK
#       &#40;in cleanup&#41; Can&#39;t locate Data/Dump/Filtered.pm in @INC &#40;you may need to install the Data::Dump::Filtered module&#41; &#40;@INC contains: /home/travis/build/Corion/WWW-Mechanize-Chrome/blib/arch /home/travis/build/Corion/WWW-Mechanize-Chrome/blib/lib /home/travis/build/Corion/WWW-Mechanize-Chrome/lib /home/travis/build/Corion/WWW-Mechanize-Chrome/blib/lib /home/travis/build/Corion/WWW-Mechanize-Chrome/blib/arch /home/travis/perl5/perlbrew/perls/5.22.4/lib/site_perl/5.22.4/x86_64-linux /home/travis/perl5/perlbrew/perls/5.22.4/lib/site_perl/5.22.4 /home/travis/perl5/perlbrew/perls/5.22.4/lib/5.22.4/x86_64-linux /home/travis/perl5/perlbrew/perls/5.22.4/lib/5.22.4 .&#41; at /home/travis/perl5/perlbrew/perls/5.22.4/lib/site_perl/5.22.4/Struct/Dumb.pm line 364 during global destruction.
not ok 29 - lib/StructDumbDebug.pm
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;20&nbsp;07:13:12&nbsp;2020</span>
    <span class="description">haarg [...] haarg.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This will happen on any system that doesn&#39;t have Data::Dump installed.

Data::Dump seems to be a test prerequisite, but is not listed as such.

One easy fix for the module itself is checking that Data::Dump was actually loaded before trying to continue loading, rather than checking for global destruction.

{
   package Struct::Dumb::_DestroyWatch;
   sub DESTROY { ${$_[0]}-&gt;&#40;&#41; if $INC{&#34;Data/Dump.pm&#34;} }
}

Data::Dump should either be added to the test prerequisites, or the test using it should skip if it is not installed.

Everything regarding overloading in this module seems really questionable.  None of this would be required if you just let it be a normal object.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;20&nbsp;07:13:13&nbsp;2020</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;20&nbsp;18:59:02&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Apr 20 07:13:12 2020, haarg wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This will happen on any system that doesn&#39;t have Data::Dump installed.
&gt; 
&gt; Data::Dump seems to be a test prerequisite, but is not listed as such.
</div>
Oh oops. I&#39;m usually good at remembering to add &#34;Test::&#34; modules to the list, but I forgot to add this one.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; One easy fix for the module itself is checking that Data::Dump was
&gt; actually loaded before trying to continue loading, rather than
&gt; checking for global destruction.
&gt; 
&gt; {
&gt;    package Struct::Dumb::_DestroyWatch;
&gt;    sub DESTROY { ${$_[0]}-&gt;&#40;&#41; if $INC{&#34;Data/Dump.pm&#34;} }
&gt; }
</div>
Yeah that seems good.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Data::Dump should either be added to the test prerequisites, or the
&gt; test using it should skip if it is not installed.
</div>
Might as well just have it skip to be honest. No need to force it to be installed if the user isn&#39;t going to be using it. If they didn&#39;t have it installed they wouldn&#39;t need to check the filtering worked anyway :&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Everything regarding overloading in this module seems really
&gt; questionable.  None of this would be required if you just let it be a
&gt; normal object.
</div>
Well the point of overloading `@{}` is to forbid most other code from using these instances as if they were plain arrayrefs. It helps when replacing existing code that might have been using those, in case of some stray `$obj-&gt;[0]` style code sitting around. But then having done that, Data::Dump can&#39;t look into them any more, so I added the filter to put that back and at the same time neaten the output to match the construction function style.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;20&nbsp;19:08:53&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Apr 20 18:59:02 2020, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Data::Dump seems to be a test prerequisite, but is not listed as
&gt; &gt; such.
</div>&gt; 
&gt; Oh oops. I&#39;m usually good at remembering to add &#34;Test::&#34; modules to
&gt; the list, but I forgot to add this one.
</div>
Correction: It&#39;s right here

  <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/PEVANS/Struct-Dumb-0.11/Build.PL#L9">https://metacpan.org/source/PEVANS/Struct-Dumb-0.11/Build.PL#L9</a></span>

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Might as well just have it skip to be honest. No need to force it to
&gt; be installed if the user isn&#39;t going to be using it. If they didn&#39;t
&gt; have it installed they wouldn&#39;t need to check the filtering worked
&gt; anyway :&#41;
</div>
That said, it&#39;s not required other than to check if it works so I still might as well make it optional.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;21&nbsp;04:53:11&nbsp;2020</span>
    <span class="description">haarg [...] haarg.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Apr 20 19:08:53 2020, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Apr 20 18:59:02 2020, PEVANS wrote:
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; Data::Dump seems to be a test prerequisite, but is not listed as
&gt; &gt; &gt; such.
</div>&gt; &gt;
&gt; &gt; Oh oops. I&#39;m usually good at remembering to add &#34;Test::&#34; modules to
&gt; &gt; the list, but I forgot to add this one.
</div>&gt; 
&gt; Correction: It&#39;s right here
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/PEVANS/Struct-Dumb-0.11/Build.PL#L9">https://metacpan.org/source/PEVANS/Struct-Dumb-0.11/Build.PL#L9</a></span>
</div>
Oh woops, missed that.  Still, using filters requires version 1.16, so the checks should be adjusted to consider that.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt; &gt; Might as well just have it skip to be honest. No need to force it to
&gt; &gt; be installed if the user isn&#39;t going to be using it. If they didn&#39;t
&gt; &gt; have it installed they wouldn&#39;t need to check the filtering worked
&gt; &gt; anyway :&#41;
</div>&gt; 
&gt; That said, it&#39;s not required other than to check if it works so I
&gt; still might as well make it optional.
</div></div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
