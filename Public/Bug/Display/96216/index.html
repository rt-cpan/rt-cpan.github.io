<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #96216 for CGI-Application-Plugin-RateLimit: t/03complex.t fails under havy load</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #96216 for CGI-Application-Plugin-RateLimit: t/03complex.t fails under havy load</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=CGI-Application-Plugin-RateLimit">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=CGI-Application-Plugin-RateLimit">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=CGI-Application-Plugin-RateLimit">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=CGI-Application-Plugin-RateLimit">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/CGI-Application-Plugin-RateLimit">CGI-Application-Plugin-RateLimit CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">96216</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=CGI-Application-Plugin-RateLimit">CGI-Application-Plugin-RateLimit</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ppisar [...] redhat.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-39452-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.0    </td>
  </tr>
  <tr id="CF-39453-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




0001-Skip-some-test-if-run-time-execeeds-a-time-frame.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1388983/737605/0001-Skip-some-test-if-run-time-execeeds-a-time-frame.patch">
Mon Jul 21 11:15:00 2014 (5.9k) by ppisar [...] redhat.com
</a>
</font></li>
</ul>


CGI-Application-Plugin-RateLimit-1.0-Skip-some-test-if-run-time-execeeds-a-time-frame.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1372385/728679/CGI-Application-Plugin-RateLimit-1.0-Skip-some-test-if-run-time-execeeds-a-time-frame.patch">
Thu Jun 05 03:51:50 2014 (5.8k) by ppisar [...] redhat.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=96216">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1372039" href="/Public/Bug/Display.html?id=96216#txn-1372039">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;04&nbsp;10:47:01&nbsp;2014</span>
    <span class="description">ppisar [...] redhat.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> t/03complex.t fails under havy load</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1372039/728507/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/728507">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">t/03complex.t test sets various time limits into the tested application and then checks the application respects the limits. However if the test runs for longer time then the limits, the test will fail like this:

#   Failed test at t/03complex.t line 121.
#                   &#39;Content-Type: text/html; charset=ISO-8859-1
# 
# LOGIN&#39;
#     doesn&#39;t match &#39;&#40;?^:TOO FAST FOR failed_login&#41;&#39;
# Looks like you failed 1 test of 15.
t/03complex.t .. 
Dubious, test returned 1 &#40;wstat 256, 0x100&#41;
Failed

You can see this failure on &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://matrix.cpantesters.org/?dist=CGI-Application-Plugin-RateLimit+1.0">http://matrix.cpantesters.org/?dist=CGI-Application-Plugin-RateLimit+1.0</a></span>&gt; too.

E.g. the login failed limit s 3 seconds, so if the &#40;qw&#40;eenie meenie moe&#41;&#41; cycle runs longer, then the failure occurs. If you insert &#34;sleep 4;&#34; just before the qr/TOO FAST FOR failed_login/ test, you get reproducible failure.

I can see there is already a &#34;my $start = time;&#34; assignment, but the value is never checked. I guess each test compute consumed time and raise a failure only if the consumed time is within the set limit.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1372385" href="/Public/Bug/Display.html?id=96216#txn-1372385">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;05&nbsp;03:51:50&nbsp;2014</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1372385/728678/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/728678">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 606b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne St 04.čen.2014 10:47:01, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; t/03complex.t test sets various time limits into the tested
&gt; application and then checks the application respects the limits.
&gt; However if the test runs for longer time then the limits, the test
&gt; will fail like this:
&gt; 
&gt; #   Failed test at t/03complex.t line 121.
&gt; #                   &#39;Content-Type: text/html; charset=ISO-8859-1
&gt;  #
&gt; # LOGIN&#39;
&gt; #     doesn&#39;t match &#39;&#40;?^:TOO FAST FOR failed_login&#41;&#39;
&gt; # Looks like you failed 1 test of 15.
&gt;  t/03complex.t ..
&gt; Dubious, test returned 1 &#40;wstat 256, 0x100&#41;
&gt; Failed
&gt; 
</div>Attached patch fixes it.

-- Petr
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> CGI-Application-Plugin-RateLimit-1.0-Skip-some-test-if-run-time-execeeds-a-time-frame.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1372385/728679/CGI-Application-Plugin-RateLimit-1.0-Skip-some-test-if-run-time-execeeds-a-time-frame.patch">Download CGI-Application-Plugin-RateLimit-1.0-Skip-some-test-if-run-time-execeeds-a-time-frame.patch</a><br />
<span class="downloadcontenttype">text/x-diff 5.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 179def78f6adf6546dc2f4e8f9619fe8babf1d16 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Thu, 5 Jun 2014 09:43:10 +0200
Subject: [PATCH] Skip some test if run-time execeeds a time frame
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

If some test run longer than a limit set into the tested application,
the tests would fail. This patch skips these test in such case.

&lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=96216">https://rt.cpan.org/Public/Bug/Display.html?id=96216</a></span>&gt;

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 t/02simple.t  | 40 ++++++++++++++++++++++++++++------------
 t/03complex.t | 21 ++++++++++++++++-----
 2 files changed, 44 insertions&#40;+&#41;, 17 deletions&#40;-&#41;

diff --git a/t/02simple.t b/t/02simple.t
index 4a49a42..7251909 100644
--- a/t/02simple.t
+++ b/t/02simple.t
@@ -45,6 +45,7 @@ my &#40;$count&#41; = $dbh-&gt;selectrow_array&#40;&#39;SELECT COUNT&#40;*&#41; FROM rate_limit_hits&#39;&#41;;
 is&#40;$count, 0, &#39;fresh rate-limit DB created&#39;&#41;;
 
 # setup a test package which uses rate-limit
+my $one_timeframe = 3;
 {
 
     package TestApp;
@@ -58,7 +59,7 @@ is&#40;$count, 0, &#39;fresh rate-limit DB created&#39;&#41;;
         my $rate_limit = $self-&gt;rate_limit;
 
         $rate_limit-&gt;dbh&#40;$dbh&#41;;
-        $rate_limit-&gt;protected_modes&#40;one =&gt; {timeframe =&gt; &#39;3s&#39;,
+        $rate_limit-&gt;protected_modes&#40;one =&gt; {timeframe =&gt; &#34;${one_timeframe}s&#34;,
                                              max_hits  =&gt; 1
                                             },
                                      two =&gt; {timeframe =&gt; &#39;10s&#39;,
@@ -93,32 +94,47 @@ my $start = time;
 {
     my $query = CGI-&gt;new&#40;{rm =&gt; &#39;one&#39;}&#41;;
     my $app = TestApp-&gt;new&#40;QUERY =&gt; $query&#41;;
-    like&#40;$app-&gt;run&#40;&#41;, qr/TOO FAST FOR TestApp::one/&#41;;
+    SKIP: {
+        skip &#34;Test did not run less than $one_timeframe s&#34;, 2
+            unless &#40;time - $start &lt; $one_timeframe&#41;;
 
-    # should be a second row for it in the DB
-    &#40;$count&#41; = $dbh-&gt;selectrow_array&#40;&#39;SELECT COUNT&#40;*&#41; FROM rate_limit_hits&#39;&#41;;
-    is&#40;$count, 2, &#39;second hit recorded&#39;&#41;;
+        like&#40;$app-&gt;run&#40;&#41;, qr/TOO FAST FOR TestApp::one/&#41;;
+
+        # should be a second row for it in the DB
+        &#40;$count&#41; = $dbh-&gt;selectrow_array&#40;&#39;SELECT COUNT&#40;*&#41; FROM rate_limit_hits&#39;&#41;;
+        is&#40;$count, 2, &#39;second hit recorded&#39;&#41;;
+    }
 }
 
 # but a hit to run-mode two should be fine
+my $stop;
 {
     my $query = CGI-&gt;new&#40;{rm =&gt; &#39;two&#39;}&#41;;
     my $app = TestApp-&gt;new&#40;QUERY =&gt; $query&#41;;
     like&#40;$app-&gt;run&#40;&#41;, qr/TWO/&#41;;
 
-    # should be a row for it in the DB
-    &#40;$count&#41; = $dbh-&gt;selectrow_array&#40;&#39;SELECT COUNT&#40;*&#41; FROM rate_limit_hits&#39;&#41;;
-    is&#40;$count, 3, &#39;third hit recorded&#39;&#41;;
+    SKIP: {
+        $stop = time;
+        skip &#34;Test did not run less than $one_timeframe s&#34;, 1
+            unless &#40;$stop - $start &lt; $one_timeframe&#41;;
+        # should be a row for it in the DB
+        &#40;$count&#41; = $dbh-&gt;selectrow_array&#40;&#39;SELECT COUNT&#40;*&#41; FROM rate_limit_hits&#39;&#41;;
+        is&#40;$count, 3, &#39;third hit recorded&#39;&#41;;
+    }
 }
 
 # after 3 seconds we&#39;re clear
-sleep 3;
+sleep $one_timeframe;
 {
     my $query = CGI-&gt;new&#40;{rm =&gt; &#39;one&#39;}&#41;;
     my $app = TestApp-&gt;new&#40;QUERY =&gt; $query&#41;;
     like&#40;$app-&gt;run&#40;&#41;, qr/ONE/&#41;;
 
-    # should be a row for it in the DB
-    &#40;$count&#41; = $dbh-&gt;selectrow_array&#40;&#39;SELECT COUNT&#40;*&#41; FROM rate_limit_hits&#39;&#41;;
-    is&#40;$count, 4, &#39;fourth hit recorded&#39;&#41;;
+    SKIP: {
+        skip &#34;Previous test did not run less than $one_timeframe s&#34;, 1
+            unless &#40;$stop - $start &lt; $one_timeframe&#41;;
+        # should be a row for it in the DB
+        &#40;$count&#41; = $dbh-&gt;selectrow_array&#40;&#39;SELECT COUNT&#40;*&#41; FROM rate_limit_hits&#39;&#41;;
+        is&#40;$count, 4, &#39;fourth hit recorded&#39;&#41;;
+    }
 }
diff --git a/t/03complex.t b/t/03complex.t
index 45b9277..bf1c201 100644
--- a/t/03complex.t
+++ b/t/03complex.t
@@ -42,6 +42,8 @@ $dbh-&gt;do&#40;
 }&#41;;
 
 # setup a test package which uses rate-limit
+my $failed_login_timeframe = 3;
+my $one_timeframe = 3;
 {
 
     package TestApp;
@@ -55,13 +57,13 @@ $dbh-&gt;do&#40;
         my $rate_limit = $self-&gt;rate_limit;
 
         $rate_limit-&gt;dbh&#40;$dbh&#41;;
-        $rate_limit-&gt;protected_modes&#40;one =&gt; {timeframe =&gt; &#39;3s&#39;,
+        $rate_limit-&gt;protected_modes&#40;one =&gt; {timeframe =&gt; &#34;${one_timeframe}s&#34;,
                                              max_hits  =&gt; 1
                                             },
                                      two =&gt; {timeframe =&gt; &#39;10s&#39;,
                                              max_hits  =&gt; 2
                                             }&#41;;
-        $rate_limit-&gt;protected_actions&#40;failed_login =&gt; { timeframe =&gt; &#39;3s&#39;,
+        $rate_limit-&gt;protected_actions&#40;failed_login =&gt; { timeframe =&gt; &#34;${failed_login_timeframe}s&#34;,
                                                          max_hits  =&gt; 3 }&#41;;
         $rate_limit-&gt;violation_mode&#40;&#39;too_fast&#39;&#41;;
     }
@@ -93,8 +95,8 @@ $dbh-&gt;do&#40;
 }
 
 # try revoking a hit
-my $start = time;
 {
+    my $start = time;
     my $query = CGI-&gt;new&#40;{rm =&gt; &#39;one&#39;, revoke_me =&gt; 1}&#41;;
     my $app = TestApp-&gt;new&#40;QUERY =&gt; $query&#41;;
     like&#40;$app-&gt;run&#40;&#41;, qr/ONE/&#41;;
@@ -104,11 +106,16 @@ my $start = time;
     like&#40;$app-&gt;run&#40;&#41;, qr/ONE/&#41;;
 
     $app = TestApp-&gt;new&#40;QUERY =&gt; $query&#41;;
-    like&#40;$app-&gt;run&#40;&#41;, qr/TOO FAST/&#41;;
+    SKIP: {
+        skip &#34;Test did not run less than $one_timeframe s&#34;, 1
+            unless &#40;time - $start &lt; $one_timeframe&#41;;
+        like&#40;$app-&gt;run&#40;&#41;, qr/TOO FAST/&#41;;
+    }
 }
 
 # try a protected action, across a few users
 for my $user &#40;qw&#40;eenie meenie moe&#41;&#41; {
+    my $start = time;
     $ENV{REMOTE_USER} = $user;
     for &#40;1 .. 3&#41; {
         my $query = CGI-&gt;new&#40;{rm =&gt; &#39;login&#39;, failed =&gt; 1}&#41;;
@@ -118,5 +125,9 @@ for my $user &#40;qw&#40;eenie meenie moe&#41;&#41; {
 
     my $query = CGI-&gt;new&#40;{rm =&gt; &#39;login&#39;, failed =&gt; 1}&#41;;
     my $app = TestApp-&gt;new&#40;QUERY =&gt; $query&#41;;
-    like&#40;$app-&gt;run&#40;&#41;, qr/TOO FAST FOR failed_login/&#41;;
+    SKIP: {
+        skip &#34;Test did not run less than $failed_login_timeframe s&#34;, 1
+            unless &#40;time - $start &lt; $failed_login_timeframe&#41;;
+        like&#40;$app-&gt;run&#40;&#41;, qr/TOO FAST FOR failed_login/&#41;;
+    }
 }
-- 
1.9.3

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1388983" href="/Public/Bug/Display.html?id=96216#txn-1388983">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;21&nbsp;11:15:00&nbsp;2014</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1388983/737604/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/737604">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 764b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Čt 05.čen.2014 03:51:50, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dne St 04.čen.2014 10:47:01, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; t/03complex.t test sets various time limits into the tested
&gt; &gt; application and then checks the application respects the limits.
&gt; &gt; However if the test runs for longer time then the limits, the test
&gt; &gt; will fail like this:
&gt; &gt; 
&gt; &gt; #   Failed test at t/03complex.t line 121.
&gt; &gt; #                   &#39;Content-Type: text/html; charset=ISO-8859-1
&gt; &gt;  #
&gt; &gt; # LOGIN&#39;
&gt; &gt; #     doesn&#39;t match &#39;&#40;?^:TOO FAST FOR failed_login&#41;&#39;
&gt; &gt; # Looks like you failed 1 test of 15.
&gt; &gt;  t/03complex.t ..
&gt; &gt; Dubious, test returned 1 &#40;wstat 256, 0x100&#41;
&gt; &gt; Failed
&gt; &gt; 
</div>&gt; Attached patch fixes it.
&gt; 
</div>Actually the patch still have some races. Now-attached patch fixes it.

-- Petr
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Skip-some-test-if-run-time-execeeds-a-time-frame.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1388983/737605/0001-Skip-some-test-if-run-time-execeeds-a-time-frame.patch">Download 0001-Skip-some-test-if-run-time-execeeds-a-time-frame.patch</a><br />
<span class="downloadcontenttype">text/x-diff 5.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 9d16171dcccea3f4994a404f1780351e454bc018 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Thu, 5 Jun 2014 09:43:10 +0200
Subject: [PATCH] Skip some test if run-time execeeds a time frame
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

If some test run longer than a limit set into the tested application,
the tests would fail. This patch skips these test in such case.

&lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=96216">https://rt.cpan.org/Public/Bug/Display.html?id=96216</a></span>&gt;

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 t/02simple.t  | 41 +++++++++++++++++++++++++++++------------
 t/03complex.t | 23 ++++++++++++++++++-----
 2 files changed, 47 insertions&#40;+&#41;, 17 deletions&#40;-&#41;

diff --git a/t/02simple.t b/t/02simple.t
index 4a49a42..7c6bb5d 100644
--- a/t/02simple.t
+++ b/t/02simple.t
@@ -45,6 +45,7 @@ my &#40;$count&#41; = $dbh-&gt;selectrow_array&#40;&#39;SELECT COUNT&#40;*&#41; FROM rate_limit_hits&#39;&#41;;
 is&#40;$count, 0, &#39;fresh rate-limit DB created&#39;&#41;;
 
 # setup a test package which uses rate-limit
+my $one_timeframe = 3;
 {
 
     package TestApp;
@@ -58,7 +59,7 @@ is&#40;$count, 0, &#39;fresh rate-limit DB created&#39;&#41;;
         my $rate_limit = $self-&gt;rate_limit;
 
         $rate_limit-&gt;dbh&#40;$dbh&#41;;
-        $rate_limit-&gt;protected_modes&#40;one =&gt; {timeframe =&gt; &#39;3s&#39;,
+        $rate_limit-&gt;protected_modes&#40;one =&gt; {timeframe =&gt; &#34;${one_timeframe}s&#34;,
                                              max_hits  =&gt; 1
                                             },
                                      two =&gt; {timeframe =&gt; &#39;10s&#39;,
@@ -93,32 +94,48 @@ my $start = time;
 {
     my $query = CGI-&gt;new&#40;{rm =&gt; &#39;one&#39;}&#41;;
     my $app = TestApp-&gt;new&#40;QUERY =&gt; $query&#41;;
-    like&#40;$app-&gt;run&#40;&#41;, qr/TOO FAST FOR TestApp::one/&#41;;
+    my $output = $app-&gt;run&#40;&#41;;
+    SKIP: {
+        skip &#34;Test did not run less than $one_timeframe s&#34;, 2
+            unless &#40;time - $start &lt; $one_timeframe&#41;;
 
-    # should be a second row for it in the DB
-    &#40;$count&#41; = $dbh-&gt;selectrow_array&#40;&#39;SELECT COUNT&#40;*&#41; FROM rate_limit_hits&#39;&#41;;
-    is&#40;$count, 2, &#39;second hit recorded&#39;&#41;;
+        like&#40;$output, qr/TOO FAST FOR TestApp::one/&#41;;
+
+        # should be a second row for it in the DB
+        &#40;$count&#41; = $dbh-&gt;selectrow_array&#40;&#39;SELECT COUNT&#40;*&#41; FROM rate_limit_hits&#39;&#41;;
+        is&#40;$count, 2, &#39;second hit recorded&#39;&#41;;
+    }
 }
 
 # but a hit to run-mode two should be fine
+my $stop;
 {
     my $query = CGI-&gt;new&#40;{rm =&gt; &#39;two&#39;}&#41;;
     my $app = TestApp-&gt;new&#40;QUERY =&gt; $query&#41;;
     like&#40;$app-&gt;run&#40;&#41;, qr/TWO/&#41;;
 
-    # should be a row for it in the DB
-    &#40;$count&#41; = $dbh-&gt;selectrow_array&#40;&#39;SELECT COUNT&#40;*&#41; FROM rate_limit_hits&#39;&#41;;
-    is&#40;$count, 3, &#39;third hit recorded&#39;&#41;;
+    SKIP: {
+        $stop = time;
+        skip &#34;Test did not run less than $one_timeframe s&#34;, 1
+            unless &#40;$stop - $start &lt; $one_timeframe&#41;;
+        # should be a row for it in the DB
+        &#40;$count&#41; = $dbh-&gt;selectrow_array&#40;&#39;SELECT COUNT&#40;*&#41; FROM rate_limit_hits&#39;&#41;;
+        is&#40;$count, 3, &#39;third hit recorded&#39;&#41;;
+    }
 }
 
 # after 3 seconds we&#39;re clear
-sleep 3;
+sleep $one_timeframe;
 {
     my $query = CGI-&gt;new&#40;{rm =&gt; &#39;one&#39;}&#41;;
     my $app = TestApp-&gt;new&#40;QUERY =&gt; $query&#41;;
     like&#40;$app-&gt;run&#40;&#41;, qr/ONE/&#41;;
 
-    # should be a row for it in the DB
-    &#40;$count&#41; = $dbh-&gt;selectrow_array&#40;&#39;SELECT COUNT&#40;*&#41; FROM rate_limit_hits&#39;&#41;;
-    is&#40;$count, 4, &#39;fourth hit recorded&#39;&#41;;
+    SKIP: {
+        skip &#34;Previous test did not run less than $one_timeframe s&#34;, 1
+            unless &#40;$stop - $start &lt; $one_timeframe&#41;;
+        # should be a row for it in the DB
+        &#40;$count&#41; = $dbh-&gt;selectrow_array&#40;&#39;SELECT COUNT&#40;*&#41; FROM rate_limit_hits&#39;&#41;;
+        is&#40;$count, 4, &#39;fourth hit recorded&#39;&#41;;
+    }
 }
diff --git a/t/03complex.t b/t/03complex.t
index 45b9277..eb88681 100644
--- a/t/03complex.t
+++ b/t/03complex.t
@@ -42,6 +42,8 @@ $dbh-&gt;do&#40;
 }&#41;;
 
 # setup a test package which uses rate-limit
+my $failed_login_timeframe = 3;
+my $one_timeframe = 3;
 {
 
     package TestApp;
@@ -55,13 +57,13 @@ $dbh-&gt;do&#40;
         my $rate_limit = $self-&gt;rate_limit;
 
         $rate_limit-&gt;dbh&#40;$dbh&#41;;
-        $rate_limit-&gt;protected_modes&#40;one =&gt; {timeframe =&gt; &#39;3s&#39;,
+        $rate_limit-&gt;protected_modes&#40;one =&gt; {timeframe =&gt; &#34;${one_timeframe}s&#34;,
                                              max_hits  =&gt; 1
                                             },
                                      two =&gt; {timeframe =&gt; &#39;10s&#39;,
                                              max_hits  =&gt; 2
                                             }&#41;;
-        $rate_limit-&gt;protected_actions&#40;failed_login =&gt; { timeframe =&gt; &#39;3s&#39;,
+        $rate_limit-&gt;protected_actions&#40;failed_login =&gt; { timeframe =&gt; &#34;${failed_login_timeframe}s&#34;,
                                                          max_hits  =&gt; 3 }&#41;;
         $rate_limit-&gt;violation_mode&#40;&#39;too_fast&#39;&#41;;
     }
@@ -93,8 +95,8 @@ $dbh-&gt;do&#40;
 }
 
 # try revoking a hit
-my $start = time;
 {
+    my $start = time;
     my $query = CGI-&gt;new&#40;{rm =&gt; &#39;one&#39;, revoke_me =&gt; 1}&#41;;
     my $app = TestApp-&gt;new&#40;QUERY =&gt; $query&#41;;
     like&#40;$app-&gt;run&#40;&#41;, qr/ONE/&#41;;
@@ -104,11 +106,17 @@ my $start = time;
     like&#40;$app-&gt;run&#40;&#41;, qr/ONE/&#41;;
 
     $app = TestApp-&gt;new&#40;QUERY =&gt; $query&#41;;
-    like&#40;$app-&gt;run&#40;&#41;, qr/TOO FAST/&#41;;
+    my $output = $app-&gt;run&#40;&#41;;
+    SKIP: {
+        skip &#34;Test did not run less than $one_timeframe s&#34;, 1
+            unless &#40;time - $start &lt; $one_timeframe&#41;;
+        like&#40;$output, qr/TOO FAST/&#41;;
+    }
 }
 
 # try a protected action, across a few users
 for my $user &#40;qw&#40;eenie meenie moe&#41;&#41; {
+    my $start = time;
     $ENV{REMOTE_USER} = $user;
     for &#40;1 .. 3&#41; {
         my $query = CGI-&gt;new&#40;{rm =&gt; &#39;login&#39;, failed =&gt; 1}&#41;;
@@ -118,5 +126,10 @@ for my $user &#40;qw&#40;eenie meenie moe&#41;&#41; {
 
     my $query = CGI-&gt;new&#40;{rm =&gt; &#39;login&#39;, failed =&gt; 1}&#41;;
     my $app = TestApp-&gt;new&#40;QUERY =&gt; $query&#41;;
-    like&#40;$app-&gt;run&#40;&#41;, qr/TOO FAST FOR failed_login/&#41;;
+    my $output = $app-&gt;run&#40;&#41;;
+    SKIP: {
+        skip &#34;Test did not run less than $failed_login_timeframe s&#34;, 1
+            unless &#40;time - $start &lt; $failed_login_timeframe&#41;;
+        like&#40;$output, qr/TOO FAST FOR failed_login/&#41;;
+    }
 }
-- 
1.9.3

</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.339872</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
