<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #88783 for Dist-Zilla-Plugin-Test-Compile: generated test sometimes hangs on Windows</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #88783 for Dist-Zilla-Plugin-Test-Compile: generated test sometimes hangs on Windows</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Dist-Zilla-Plugin-Test-Compile/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Dist-Zilla-Plugin-Test-Compile/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Dist-Zilla-Plugin-Test-Compile/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Dist-Zilla-Plugin-Test-Compile/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Dist-Zilla-Plugin-Test-Compile">Dist-Zilla-Plugin-Test-Compile CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">88783</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Dist-Zilla-Plugin-Test-Compile/Active/">Dist-Zilla-Plugin-Test-Compile</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">ether [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
CHORNY [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-240084-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-240085-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
2.032    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;18&nbsp;10:10:22&nbsp;2013</span>
    <span class="description">CHORNY [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> generated test sometimes hangs on Windows</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">As I see from my cpantesters smokes, it hangs repeatedly in case some dependency is missing. Hangings when all dependencies are met are rare and not 100% repeatable.

-- 
Alexandr Ciornii, <span class="clickylink"><a target="new" rel="nofollow" href="http://chorny.net">http://chorny.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;18&nbsp;12:25:56&nbsp;2013</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2013-09-18 07:10:22, CHORNY wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; As I see from my cpantesters smokes, it hangs repeatedly in case some
&gt; dependency is missing. Hangings when all dependencies are met are rare
&gt; and not 100% repeatable.
</div>
Some sort of diagnostic information would be helpful. What distributions/versions are you seeing this problem with?  There was a version of the plugin out for a few days that was problematic on mswin32, but that issue has been resolved now, as far as I&#39;m aware.

When <span class="clickylink"><a target="new" rel="nofollow" href="http://grep.cpan.me/">http://grep.cpan.me/</a></span> is back up I can try to track down dists still using such versions &#40;there may be a few left after my last sweep a few weeks ago&#41;, but a reference to a dist that is still showing issues will be helpful.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;18&nbsp;12:25:56&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;18&nbsp;13:47:22&nbsp;2013</span>
    <span class="description">ether [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;18&nbsp;16:02:28&nbsp;2013</span>
    <span class="description">CHORNY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Sep 18 12:25:56 2013, ETHER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 2013-09-18 07:10:22, CHORNY wrote:
<div class="message-stanza open">&gt; &gt; As I see from my cpantesters smokes, it hangs repeatedly in case some
&gt; &gt; dependency is missing. Hangings when all dependencies are met are
&gt; &gt; rare
&gt; &gt; and not 100% repeatable.
</div>&gt; 
&gt; Some sort of diagnostic information would be helpful. What
&gt; distributions/versions are you seeing this problem with?  There was a
&gt; version of the plugin out for a few days that was problematic on
&gt; mswin32, but that issue has been resolved now, as far as I&#39;m aware.
</div>
Pinto-Action-Doc-0.001, 00-compile.t generated by version 2.027
1..2
binmode&#40;&#41; on unopened filehandle GEN0 at t/00-compile.t line 28.
&#40;hangs&#41;

MooseX-Role-Net-OpenSSH-0.001, 00-compile.t generated by version 2.030
1..1
&#40;hangs&#41;

test hangs on waitpid, I check pid manually, it belongs to cmd.exe and exists.


-- 
Alexandr Ciornii, <span class="clickylink"><a target="new" rel="nofollow" href="http://chorny.net">http://chorny.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;18&nbsp;19:56:10&nbsp;2013</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; test hangs on waitpid, I check pid manually, it belongs to cmd.exe and
&gt; exists.
</div>
I wonder if it would help to bypass the shell here. I&#39;m afraid my win32-fu is not that high...
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;19&nbsp;00:53:00&nbsp;2013</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I released 2.031 which bypasses the shell/cmd.exe by passing the command and args as separate list elements... but I expect it will be several days before we know if this helped.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;19&nbsp;11:13:40&nbsp;2013</span>
    <span class="description">CHORNY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Sep 19 00:53:00 2013, ETHER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I released 2.031 which bypasses the shell/cmd.exe by passing the
&gt; command and args as separate list elements... but I expect it will be
&gt; several days before we know if this helped.
</div>
I just used WWW-Shorten-SCK repository to test this by adding &#34;use No::Such::Module;&#34;. It does not help.

This solution works
if &#40;$^O eq &#39;MSWin32&#39; and !$ENV{AUTHOR_TESTING}&#41; {
      my $output = qx{$^X -Mblib -e&#34;require q[$lib]&#34; 2&gt;&#38;1 &lt;nul}; #&lt;nul will prevent witing input
      warn $output if $output;
}

It you need to drop output from STDOUT and get only output from STDERR, add &#34;&gt;nul&#34; to the end. qx can return list, so @warnings can be filled from it.

-- 
Alexandr Ciornii, <span class="clickylink"><a target="new" rel="nofollow" href="http://chorny.net">http://chorny.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;19&nbsp;11:15:41&nbsp;2013</span>
    <span class="description">CHORNY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I can submit a patch and test it, just need to know if STDOUT should be dropped.

-- 
Alexandr Ciornii, <span class="clickylink"><a target="new" rel="nofollow" href="http://chorny.net">http://chorny.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;19&nbsp;12:13:30&nbsp;2013</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #88783] generated test sometimes hangs on Windows</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 19 Sep 2013 09:13:14 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Alexandr Ciornii via RT &lt;bug-Dist-Zilla-Plugin-Test-Compile [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Karen Etheridge &lt;ether [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, Sep 19, 2013 at 11:13:40AM -0400, Alexandr Ciornii via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I just used WWW-Shorten-SCK repository to test this by adding &#34;use No::Such::Module;&#34;. It does not help.
</div>
Doh! :&#40;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This solution works
&gt; if &#40;$^O eq &#39;MSWin32&#39; and !$ENV{AUTHOR_TESTING}&#41; {
&gt;       my $output = qx{$^X -Mblib -e&#34;require q[$lib]&#34; 2&gt;&#38;1 &lt;nul}; #&lt;nul will prevent witing input
&gt;       warn $output if $output;
&gt; }
&gt; 
&gt; It you need to drop output from STDOUT and get only output from STDERR, add &#34;&gt;nul&#34; to the end. qx can return list, so @warnings can be filled from it.
</div>
Ok, I&#39;ll look at this tonight.  David Golden also graciously whipped up a
&#34;Capture::Tinier&#34; that I can embed into the test, which I&#39;ll also be
considering as a replacement -- <span class="clickylink"><a target="new" rel="nofollow" href="https://gist.github.com/dagolden/6618205">https://gist.github.com/dagolden/6618205</a></span>

thanks very much for your assistance debugging this!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;19&nbsp;19:26:31&nbsp;2013</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I just pushed this test branch -- <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/karenetheridge/dist-zilla-plugin-test-compile/tree/topic/win32_debugging">https://github.com/karenetheridge/dist-zilla-plugin-test-compile/tree/topic/win32_debugging</a></span>

If convenient, could you run &#39;perl test-compile.t&#39; and let me know what happens?

    git clone git@github.com:karenetheridge/dist-zilla-plugin-test-compile.git
    cd dist-zilla-plugin-test-compile
    git checkout topic/win32_debugging
    perl test-compile.t

This is using new code that has stdin reading from /dev/null, rather than using a gensym, so if the process tries to read from stdin it should not hang.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;19&nbsp;20:46:09&nbsp;2013</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Mithaldu was able to do some debugging, and made some very interesting discoveries:


    16:26 &lt;@ether&gt; Mithaldu: are you still awake?
    16:26 &lt; Mithaldu&gt; fsvo awake
    16:26 &lt;@ether&gt; I just pushed this test branch -- <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/karenetheridge/dist-zilla-plugin-test-compile/tree/topic/win32_debugging">https://github.com/karenetheridge/dist-zilla-plugin-test-compile/tree/topic/win32_debugging</a></span>
    16:26 &lt;+dipsy&gt; [ karenetheridge/dist-zilla-plugin-test-compile · GitHub ] 
    16:27 &lt;@ether&gt; or, copy/paste from the last message in <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=88783">https://rt.cpan.org/Ticket/Display.html?id=88783</a></span>
    16:27 &lt;+dipsy&gt; [ Bug #88783 for Dist-Zilla-Plugin-Test-Compile: generated test sometimes hangs on Windows ] 
    16:27 &lt; Mithaldu&gt; useful, thank you :&#41;
    16:29 &lt; Mithaldu&gt; ether: so which part of this is not supposed to be changed?
    16:29 &lt; Mithaldu&gt; also, it doesn&#39;t hang for me
    16:32 &lt; Mithaldu&gt; ether: ok wait
    16:32 &lt; Mithaldu&gt; so if i read your ticket comment right the issue happens when Foo.pm opens STDIN and tries to read from it until it gets EOF
    16:32 &lt; Mithaldu&gt; is that the right ballpark?
    16:32 &lt;@ether&gt; one commit back is the change I made that I hope will work
    16:33 &lt;@ether&gt; yes I think so
    16:33 &lt;@ether&gt; I didn&#39;t think that any processes woudl be reading from stdin, but apparently something is
    16:33 &lt; Mithaldu&gt; see, i need that code
    16:33 &lt; Mithaldu&gt; i need to test the hang
    16:33 &lt; Mithaldu&gt; on which modules does this happen?
    16:33 &lt; Mithaldu&gt; ok, i see
    16:34 &lt;@ether&gt; chorny said &#34;I just used WWW-Shorten-SCK repository to test this by adding &#34;use No::Such::Module;&#34;. It does not help. &#34;
    16:34 &lt;@ether&gt; so I suppose he just added that line to one of the modules in the dist?
    16:34 &lt;@ether&gt; which is what I&#39;m simulating with Foo.pm
    16:35 &lt; Mithaldu&gt; man, his information is really awkwardly unfocused
    16:36 &lt;@ether&gt; it doesn&#39;t seem like the failure is always repeatable, either :&#40;
    16:38 &lt; Mithaldu&gt; i&#39;m trying with the SCK thing he mentioned
    16:40 &lt;@xdg&gt; ether, read the second bullet in the &#34;BUGS&#34; section of perlfork
    16:42 &lt;@ether&gt; pseudo-processes being what we get in win32?
    16:42  * ether reads the doc from the beginning; ok, this is just about emulation, not normal forks, so yeah
    16:42 &lt; Mithaldu&gt; fork under windows gives you threads
    16:43 &lt; Mithaldu&gt; but open3 doesn&#39;t fork on windows i think
    16:43 &lt; Mithaldu&gt; so i don&#39;t understand why that&#39;s relevant
    16:43 &lt;@xdg&gt; ether, fork on windows does what the document describes and IPC::Open3 uses fork internally
    16:43 &lt;@xdg&gt; forks on windows are &#34;pseudo-threads&#34;
    16:43 &lt;@ether&gt; I could always just drop the idea of using separate processes for testing on windows -- it may generate different errors, and mask others, but at least it shouldn&#39;t go kaboom
    16:44 &lt;@xdg&gt; Capture::Tinier
    16:44 &lt;@ether&gt; if &#40;$^O eq &#39;MSWin32&#39;&#41; { use_module&#40;$_&#41; foreach @modules }
    16:44 &lt; Mithaldu&gt; xdg: open3 doesn&#39;t
    16:44 &lt;@ether&gt; xdg: or that. yes. :&#41;
    16:45 &lt; Mithaldu&gt; &#40;i know this because i actually see the child process&#41;
    16:47 &lt;@xdg&gt; ah.
    16:47 &lt; Mithaldu&gt; ether: i&#39;ll try to reproduce this with the two modules he pointed out
    16:47 &lt;@xdg&gt; In any case, Capture::Tiny&#40;ier&#41; doesn&#39;t try to read from a pipe, which simplifies the IPC
    16:47 &lt;@ether&gt; I just pushed an update, bypassing cmd.exe &#40;which I already released yesterday; I copied this test from a different build that was created before that change.&#41;
    16:48 &lt; Mithaldu&gt; well that&#39;s not gonna help me help you, because i can&#39;t reproduce the error case yet :P
    16:51 &lt; Mithaldu&gt; ok, reproduced
    16:51 &lt; Mithaldu&gt; awesome
    16:51 &lt;@xdg&gt; Mithaldu++
    16:51 &lt;@ether&gt; o/
    16:51 &lt; Mithaldu&gt; just downloaded this: <span class="clickylink"><a target="new" rel="nofollow" href="http://cpan.metacpan.org/authors/id/T/TR/TRCJR/MooseX-Role-Net-OpenSSH-0.001.tar.gz">http://cpan.metacpan.org/authors/id/T/TR/TRCJR/MooseX-Role-Net-OpenSSH-0.001.tar.gz</a></span>
    16:51 &lt;+dipsy&gt; urgh. long url. Try <span class="clickylink"><a target="new" rel="nofollow" href="http://tinyurl.com/mt3fvum">http://tinyurl.com/mt3fvum</a></span>
    16:51 &lt; Mithaldu&gt; and then make tested without having openssh
    16:52 &lt;@ether&gt; I smell some new unit tests that I should be adding :&#41;
    16:52 &lt; Mithaldu&gt; open my $stdin, &#39;&lt;&#39;, File::Spec-&gt;devnull or die $!;
    16:52 &lt; Mithaldu&gt; doesn&#39;t help
    16:53 &lt; Mithaldu&gt; interestingly
    16:53 &lt; Mithaldu&gt; perl -Ilib t\00-compile.t
    16:53 &lt;@ether&gt; it&#39;s frustrating having the extra step in between for testing - I can&#39;t just put up a -TRIAL dist and see what the smokers say - I have to wait until people actually use the plugin to build their dists, and then find out about it secondhand... so having a test that I can actually use myself to reproduce these issues will be VERY helpful
    16:53 &lt; Mithaldu&gt; ^- that works
    16:53 &lt; Mithaldu&gt; prove -l t/*
    16:53 &lt; Mithaldu&gt; ^- hangs
    16:53 &lt; Mithaldu&gt; so the issue is processes wrapping around further outside
    16:53 &lt; Mithaldu&gt; and i remember things like that
    16:53 &lt;@ether&gt; prove closes stdout, iirc
    16:54 &lt;@ether&gt; &#40;well, Test::Harness actually..&#41;
    16:54 &lt; Mithaldu&gt; but i don&#39;t remember any details
    16:54 &lt; Mithaldu&gt; it&#39;s more of a deja vu
    16:54 &lt; Mithaldu&gt; anyhow, i&#39;ll mess with this and see what happens
    16:54 &lt; Mithaldu&gt; xdg: where is tinier?
    16:54 &lt;@xdg&gt; ether, if that&#39;s true then Capture::Tinier might be too tiny
    16:54 &lt; Mithaldu&gt; ok, got tinier
    16:54 &lt; Mithaldu&gt; trying that
    16:55 &lt; Mithaldu&gt; ether: yes, i&#39;m working on that :&#41;
    16:55 &lt;@xdg&gt; Mithaldu, you got it?  If not: <span class="clickylink"><a target="new" rel="nofollow" href="https://gist.github.com/dagolden/6618205">https://gist.github.com/dagolden/6618205</a></span>
    16:55 &lt;@ether&gt; tinier:  <span class="clickylink"><a target="new" rel="nofollow" href="https://gist.github.com/dagolden/6618205">https://gist.github.com/dagolden/6618205</a></span>
    16:55 &lt;@ether&gt; too slow
    16:55 &lt;+dipsy&gt; [ 00-xdg-compile.t ] 
    16:55 &lt;+dipsy&gt; [ 00-xdg-compile.t ] 
    16:55 &lt;@xdg&gt; It was sort of a joke name, but with real intent
    16:56 &lt;@xdg&gt; It&#39;s Capture::Tiny stripped of all the tee-ing, layer mgmt, and dealing with weirdly modified existing handles
    16:56 &lt;@ether&gt; dammit, we should just get it into core :&#41;
    16:57 &lt;@xdg&gt; I do notice a line there about &#34;# WIN32 hangs on tee without STDIN copied&#34;
    16:57 &lt; Mithaldu&gt; xdg: yes got it
    16:57 &lt;@xdg&gt; shouldn&#39;t matter for Tinier, but it&#39;s indicative of the sort of problems we hit on Windows with process stuff
    16:58  * ether sees that Meerkat is a real thing ;&#41;
    16:58 &lt;@xdg&gt; it is now
    16:58 &lt;@xdg&gt; :-&#41;
    16:59 &lt; Mithaldu&gt; .... what the fuck
    17:00 &lt;@ether&gt; that sounds ominous
    17:00 &lt; Mithaldu&gt; deleting blib\arch\auto\MooseX\Role\Net\OpenSSH\.exists stops prove -l -v t/* from hanging
    17:01 &lt;@ether&gt; !
    17:01 &lt;@ether&gt; I didn&#39;t think anything at runtime looked at .exists files
    17:02 &lt; Mithaldu&gt; blib/arch/auto/MooseX/Role/Net/OpenSSH/.exists
    17:02 &lt;@xdg&gt; o_O
    17:02 &lt; Mithaldu&gt; blib/lib/MooseX/Role/Net/OpenSSH.pm
    17:02 &lt; Mithaldu&gt; t/00-compile.t
    17:02 &lt; Mithaldu&gt; i run
    17:02 &lt; Mithaldu&gt; prove -l -v t/*
    17:02 &lt; Mithaldu&gt; and it hangs
    17:02 &lt; Mithaldu&gt; i delete the .exists
    17:02 &lt; Mithaldu&gt; and the test doesn&#39;t hang
    17:02 &lt; Mithaldu&gt; let&#39;s see how many bits i can delete from OpenSSH.pm
    17:03 &lt;@xdg&gt; what is generating .exists?
    17:03 &lt; Mithaldu&gt; dzil
    17:03 &lt; Mithaldu&gt; or eumm
    17:03 &lt; Mithaldu&gt; unclear
    17:03 &lt;@xdg&gt; if it&#39;s in blib, it&#39;s not dzil
    17:03 &lt;@xdg&gt; eumm or a lib it&#39;s using to copy to blib
    17:03  * xdg chdirs
    17:04 &lt;@xdg&gt; eumm
    17:04 &lt;@xdg&gt; I&#39;m going to skim source
    17:04 &lt; Mithaldu&gt; thanks
    17:05 &lt;@xdg&gt; it&#39;s just getting touched by the makefile so it can have a dependency on the directory, which otherwise doesn&#39;t work well
    17:06 &lt;@xdg&gt; &#40;that&#39;s my tl;dr summary of a comment in the source&#41;
    17:08  * xdg afk
    17:09 &lt; Mithaldu&gt; aHA
    17:11 &lt; Mithaldu&gt; ether: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/wchristian/winhangtest">https://github.com/wchristian/winhangtest</a></span>
    17:11 &lt;+dipsy&gt; [ wchristian/winhangtest · GitHub ] 
    17:11 &lt; Mithaldu&gt; still making it smaller
    17:13 &lt;@ether&gt; if $stderr isn&#39;t an IO::Handle there isn&#39;t a problem? wut?
    17:13 &lt;@ether&gt; this is getting stranger and stranger
    17:14 &lt;@ether&gt; in the meantime I&#39;m whipping up a capture_tinier branch
    17:14 &lt; Mithaldu&gt; my &#40; $stdout, $stderr, $rc &#41; = capture { system&#40; qq{$^X -Mblib -e&#34;require q[MooseX/Role/Net/OpenSSH.pm]&#34;} &#41; };
    17:15 &lt; Mithaldu&gt; this don&#39;t freeze and prints all the right things
    17:15 &lt; Mithaldu&gt; so, tinier is the right path
    17:16 &lt; Mithaldu&gt; output of:
    17:16 &lt; Mithaldu&gt; warn &#34;\n$rc - $stdout - $stderr\n&#34;;
    17:16 &lt; Mithaldu&gt; 512 - - Can&#39;t locate Not/Exists.pm in @INC &#40;@
    17:16 &lt; Mithaldu&gt; etc.
    17:17 &lt;@ether&gt; woo
    17:18 &lt; Mithaldu&gt; and i got tinier working
    17:18 &lt; Mithaldu&gt; ether: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/wchristian/winhangtest/blob/master/t/00-compile.t">https://github.com/wchristian/winhangtest/blob/master/t/00-compile.t</a></span>
    17:18 &lt;+dipsy&gt; [ winhangtest/t/00-compile.t at master · wchristian/winhangtest · GitHub ] 
    17:18 &lt; Mithaldu&gt; enjoy
    17:18 &lt; Mithaldu&gt; also
    17:19 &lt; Mithaldu&gt; do test that on linux to see if it blows up :&#41;
    17:19 &lt; Mithaldu&gt; xdg: splendid work, thanks a bunch!
    17:19 &lt;@ether&gt; thank you so much to you both
    17:19 &lt; Mithaldu&gt; who needs sleep when he can make cpan happy? :D
    17:20 &lt;@ether&gt; so the &#34;ssh library doesn&#39;t exist&#34; issue was a red herring?
    17:20 &lt; Mithaldu&gt; totally
    17:20 &lt;@ether&gt; I&#39;m wondering if there&#39;s something I can put into a .pm file to be tested that will tickle the right error
    17:20 &lt; Mithaldu&gt; actually, let me try something dumb
    17:21 &lt; Mithaldu&gt; ok
    17:21 &lt; Mithaldu&gt; if i replace use Not::Exists; in OpenSSH.pm with &#34;die 1;&#34;, then it doesn&#39;t hang
    17:22 &lt; Mithaldu&gt; so this is some weird interaction between the child process failing to load a dep, and whatever prove invokes
    17:22 &lt; Mithaldu&gt; and the .exists file
    17:22 &lt; Mithaldu&gt; those are the three puzzle pieces
    17:23 &lt;@ether&gt; I do do a perl Makefile.PL; make from within my tests..
    17:23 &lt;@ether&gt; only right now I only have passing tests, because of the PITA that is Test::Tester
    17:23 &lt;@ether&gt; and using it might further alter the harness in undesirable ways
    17:24 &lt;@ether&gt; Mithaldu: thanks so much
    17:25 &lt; Mithaldu&gt; i&#39;m unclear on the implications of what you&#39;re saying
    17:25 &lt;@ether&gt; I&#39;d like to be able to have this particular type of test failure in the plugin&#39;s tests
    17:25 &lt;@ether&gt; so I can put up a -TRIAL release and see results right away
    17:25 &lt; Mithaldu&gt; yeah, that&#39;s gonna be tricky
    17:25 &lt;@ether&gt; but that means capturing the test results in a way that the thing doing the testing doesn&#39;t also fail
    17:25 &lt;@ether&gt; which generally implies Test::Tester
    17:26 &lt;@ether&gt; which I have fought with before, and mostly beaten into submission, but it does funny things with the harness so I don&#39;t trust it too much
    17:26 &lt; Mithaldu&gt; well
    17:26 &lt; Mithaldu&gt; a test failure is freezing
    17:26 &lt; Mithaldu&gt; that is dang hard to do anything with
    17:26 &lt; Mithaldu&gt; i wouldn&#39;t bother
    17:26 &lt; Mithaldu&gt; you&#39;re removing open3, which is the source of the immediate problem
    17:28 &lt; Mithaldu&gt; none of the code in my perl dir should even touch .exists
    17:28 &lt;@ether&gt; and hopefully the last &#40;ha ha!&#41; :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;19&nbsp;21:05:35&nbsp;2013</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">2.032 has been released, switching back from open3&#40;&#41; to capture&#40;&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;20&nbsp;15:38:40&nbsp;2013</span>
    <span class="description">CHORNY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Sep 19 21:05:35 2013, ETHER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2.032 has been released, switching back from open3&#40;&#41; to capture&#40;&#41;.
</div>
Although Dist-Zilla-Plugin-Test-Compile own tests fail on Windows &#40; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/cpan/report/c36e2df3-6bf9-1014-b43d-7f72db05e747">http://www.cpantesters.org/cpan/report/c36e2df3-6bf9-1014-b43d-7f72db05e747</a></span> &#41;, the generated test does not hang.

-- 
Alexandr Ciornii, <span class="clickylink"><a target="new" rel="nofollow" href="http://chorny.net">http://chorny.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;20&nbsp;15:38:40&nbsp;2013</span>
    <span class="description">CHORNY [...] cpan.org -  Fixed in 2.032 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;20&nbsp;18:24:39&nbsp;2013</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #88783] generated test sometimes hangs on Windows</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 20 Sep 2013 15:24:27 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Alexandr Ciornii via RT &lt;bug-Dist-Zilla-Plugin-Test-Compile [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Karen Etheridge &lt;ether [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Sep 20, 2013 at 03:38:40PM -0400, Alexandr Ciornii via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Although Dist-Zilla-Plugin-Test-Compile own tests fail on Windows &#40; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/cpan/report/c36e2df3-6bf9-1014-b43d-7f72db05e747">http://www.cpantesters.org/cpan/report/c36e2df3-6bf9-1014-b43d-7f72db05e747</a></span> &#41;, the generated test does not hang.
</div>
Ah yes, I haven&#39;t changed this dist yet to generate its own tests with the
version about to be released; I&#39;ll make that change tonight &#40;as well as
reverting to using open3 again, but with waitpid in the right place&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;20&nbsp;18:28:10&nbsp;2013</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2013-09-20 15:24:39, ETHER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri, Sep 20, 2013 at 03:38:40PM -0400, Alexandr Ciornii via RT
&gt; wrote:
<div class="message-stanza open">&gt; &gt; Although Dist-Zilla-Plugin-Test-Compile own tests fail on Windows &#40;
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/cpan/report/c36e2df3-6bf9-1014-b43d-">http://www.cpantesters.org/cpan/report/c36e2df3-6bf9-1014-b43d-</a></span>
&gt; &gt; 7f72db05e747 &#41;, the generated test does not hang.
</div>&gt; 
&gt; Ah yes, I haven&#39;t changed this dist yet to generate its own tests with
&gt; the
&gt; version about to be released
</div>
sorry, red herring; I did not look at the report closely enough.
But I will fix.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;23&nbsp;19:12:23&nbsp;2013</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am optimistically closing this as resolved, with much hope in my heart. :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;23&nbsp;19:12:24&nbsp;2013</span>
    <span class="description">ether [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
