<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #89400 for CryptX: Better primality testing in CryptX &#40;libtomcrypt/libtommath&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #89400 for CryptX: Better primality testing in CryptX &#40;libtomcrypt/libtommath&#41;</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=CryptX">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=CryptX">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=CryptX">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=CryptX">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/DCIT/perl-CryptX/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/CryptX">CryptX CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">89400</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=CryptX">CryptX</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
MIK [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">
DANAJ [...] cpan.org

<br />

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-249328-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-249329-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=89400">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1273456" href="/Public/Bug/Display.html?id=89400#txn-1273456">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;10&nbsp;17:02:40&nbsp;2013</span>
    <span class="description">MIK [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Better primality testing in CryptX &#40;libtomcrypt/libtommath&#41;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1273456/674448/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/674448">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This RT is based on Dana Jacobsen&#39;s comment in another RT:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; There are two issues.  One is doing only 8 tests, which doesn&#39;t bother
&gt; me quite so much as the next.  At 160 bits, 8 tests should give us a
&gt; better than 1e-15 chance of failure on random inputs &#40;using
&gt; DamgÃ¥rd/Landrock/Pomerance calculations, which based on their table 1
&gt; are conservative&#41;.  If the input is chosen by an adversary, then only
&gt; 1.5e-5.  That seems high to me.  But this is just being lax with the
&gt; probability, which I wouldn&#39;t claim is &#34;broken&#34;.
&gt; 
&gt; My main issue is that it uses the first k prime bases for its tests.
&gt; If I have a random number from 1 to 1M and ask you to guess it, your
&gt; chances are 1 in 1 million.  But if I never change my number, and
&gt; you&#39;re allowed to keep guessing and talk to everyone else who&#39;s
&gt; played, then the chances are no longer 1 in 1M, and once you know my
&gt; number then you can guess it every time.  That&#39;s essentially what
&gt; using a fixed set of bases is doing.  There are known numbers that
&gt; pass the first 168 prime bases.  Arnault in 1994 wrote a paper showing
&gt; how to construct numbers that pass many given bases.
&gt; 
&gt; This is a big issue if you&#39;re exposing the is-prime function to
&gt; anything that can select its number &#40;e.g. a user like Perl 6 does&#41;.
&gt; For DSA use it doesn&#39;t seem obviously as bad since the input numbers
&gt; are not user-chosen, but cryptography is a bad place to say &#34;I can&#39;t
&gt; think of how the known weakness can be exploited, so I guess it&#39;s ok.&#34;
&gt; 
&gt; We could:
&gt; 
&gt; - prove the primality.  Fantastic for security, but requires a non-
&gt; trivial implementation &#40;For Crypt::DSA::GMP I&#39;m using
&gt; Math::Prime::Util::GMP&#41; and is always going to be a performance
&gt; concern.  With MPU:GMP, it&#39;s almost free for &lt; 256-bit, but gets quite
&gt; noticeable after 1024 or so bits, and probably too slow for this
&gt; application once in the 4096-bit range.  WraithX has a nice APRCL
&gt; implementation that looks promising also.  Both are in GMP however,
&gt; and would be quite a bit of work to put in libtommath.
&gt; 
&gt; - BPSW + optional number of random [2, n-2] M-R bases.  In my opinion
&gt; the best solution, meets FIPS requirements, and good performance.
&gt; This is what I&#39;m doing in Crypt::DSA::GMP when not proving primality.
&gt; See next item.
&gt; 
&gt; - BPSW.  Requires adding a Lucas test to libtommath, which isn&#39;t too
&gt; hard &#40;~40-100 lines of code&#41;, but you have to get it integrated into
&gt; libtommath.  ltm is kind of built around the idea of multiple M-R
&gt; tests, which is a very 1980&#39;s way to do things.  By itself BPSW isn&#39;t
&gt; FIPS compliant, though it is what almost all math packages use now.
&gt; FIPS wants some extra M-R tests.
&gt; 
&gt; - M-R with random &#40;in range [2,n-2]&#41; bases.  FIPS compliant, though
&gt; they want a huge number of bases if you&#39;re not using a Lucas test.
&gt; 
&gt; 
&gt; While random bases prevent a lot of crytographic attacks, it makes
&gt; debugging more of a problem since you can&#39;t reproduce any failure.
&gt; Since the BPSW test has no known counterexamples, it&#39;s unlikely to
&gt; ever come up if you do that first.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1273469" href="/Public/Bug/Display.html?id=89400#txn-1273469">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;10&nbsp;17:26:53&nbsp;2013</span>
    <span class="description">MIK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1273469/674451/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/674451">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have put some ideas in a special branch at:
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/DCIT/perl-CryptX/tree/better-primes">https://github.com/DCIT/perl-CryptX/tree/better-primes</a></span>

The central point &#40;partly stolen from Math-Prime-Util-GMP&#41; is:
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/DCIT/perl-CryptX/blob/better-primes/src/ltm/bn_mp_prime_is_prime.c">https://github.com/DCIT/perl-CryptX/blob/better-primes/src/ltm/bn_mp_prime_is_prime.c</a></span>

I have newly added:
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/DCIT/perl-CryptX/blob/better-primes/src/ltm/bn_mp_prime_miller_rabin_random.c">https://github.com/DCIT/perl-CryptX/blob/better-primes/src/ltm/bn_mp_prime_miller_rabin_random.c</a></span>

The Lucas test is not implemented yet but should go to
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/DCIT/perl-CryptX/blob/better-primes/src/ltm/bn_mp_prime_lucas.c">https://github.com/DCIT/perl-CryptX/blob/better-primes/src/ltm/bn_mp_prime_lucas.c</a></span>

It it completely untested, just proof of concept to show the idea.

There are couple of things I am not sure about:

1/ we are testing &#40;in this order&#41; whether
    - A is a known prime &#40;we know the first N primes&#41; =&gt; then PRIME
    - A is divisible by any of the first N primes =&gt; then composite
    - A &lt; N-th-prime^2 =&gt; then PRIME &#40;here is a bug in code&#41;
    - one MR test with base 2 =&gt; on failure: composite
    - Lucas test =&gt; on failure: composite
    - several MR tests with random base from [2, A-2] =&gt; on failure: composite
    - if all tests pass =&gt; then PRIME
is it OK?

2/ As the same routine is used for generating RSA keys and DSA params it would be nice to determine the number of MR tests with random base from bit length of A. However FIPS.186-4 tables C.1, C.2 and C.3 are still a bit unclear to me.

3/ And of course Lucas implementation is missing.

Dana, I would appreciate any help with this issue.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1273476" href="/Public/Bug/Display.html?id=89400#txn-1273476">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;10&nbsp;17:37:52&nbsp;2013</span>
    <span class="description">MIK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1273476/674456/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/674456">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 112b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have granted you push priv to our perl-CryptX repo. Branch better-primes is open for any ideas/improvements :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1273548" href="/Public/Bug/Display.html?id=89400#txn-1273548">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;11&nbsp;01:14:08&nbsp;2013</span>
    <span class="description">dana.jacobsen [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #89400] Better primality testing in CryptX &#40;libtomcrypt/libtommath&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 10 Oct 2013 22:13:49 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CryptX [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dana Jacobsen &lt;dana.jacobsen [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1273548/674509/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/674509">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve got a bunch of other stuff I need to work on first, but I&#39;ll try to
make some time for this.  Right now I&#39;ll add an email with some thoughts.

I&#39;ll label the steps from your &#40;1&#41;:

  &#40;a&#41; A is a known prime &#40;we know the first N primes&#41; =&gt; then PRIME
  &#40;b&#41; A is divisible by any of the first N primes =&gt; then composite
  &#40;c&#41; A &lt; N-th-prime^2 =&gt; then PRIME &#40;here is a bug in code&#41;

Yes, step &#40;c&#41; doesn&#39;t look right:  Given the sizes involved, we should be
safe asking if A*A &lt; Pn where Pn is the Nth prime.  It should be mixed in
with &#40;b&#41;.

There are lots of ways of doing these steps, each with different
performance / readability tradeoffs.  MPU::GMP does them in a very simple
way, mostly because small values will typically go through the more
optimized native-integer methods from MPU.

  - GCD.  With GMP, doing a GCD with a primorial is typically the fastest
solution for large inputs.  I have no idea for libtommath if this would be
true.  Thjs is just a speedup over a simple trial division loop.

  - Steps &#40;b&#41;+&#40;c&#41; with &#40;a&#41; only for tiny values.  So something like:
  if &#40;A &lt; 11&#41; {  return &#40;n in &#40;2,3,5,7&#41;&#41; ? 2 : 0 }
  return 0 if A % 2 == 0 || A % 3 == 0 || A % 5 == 0;
  for each small prime p starting at 7 {
    return 1 if p*p &gt; A
    return 0 if A % p == 0;
  }
  return 1 if maxp * maxp &lt; A
  // note that if maxp goes over 65536 then we need to use isqrt&#40;A&#41; instead.

  - Use a bit array like MPU&#39;s util.c to handle step &#40;a&#41;.  This stores the
first 10,000 primes in 334 bytes.  Probably overkill for crypto use as we
don&#39;t need to shave a couple microseconds off the time for small primes.

  - Mix &#40;a&#41;, &#40;b&#41;, &#40;c&#41; together a little.  E.g. from MPU&#39;s primality.c:

  if &#40;n &lt; 11&#41; {
    if &#40;n == 2 || n == 3 || n == 5 || n == 7&#41;     return 2;
    else                                          return 0;
  }
  if &#40;!&#40;n%2&#41; || !&#40;n%3&#41; || !&#40;n%5&#41; || !&#40;n%7&#41;&#41;       return 0;
  if &#40;n &lt;  121&#41; /* 11*11 */                       return 2;
  if &#40;!&#40;n%11&#41; || !&#40;n%13&#41; || !&#40;n%17&#41; || !&#40;n%19&#41; ||
      !&#40;n%23&#41; || !&#40;n%29&#41; || !&#40;n%31&#41; || !&#40;n%37&#41; ||
      !&#40;n%41&#41; || !&#40;n%43&#41; || !&#40;n%47&#41; || !&#40;n%53&#41;&#41;   return 0;
  if &#40;n &lt; 3481&#41; /* 59*59 */                       return 2;

  This is slightly faster than the simple &#40;b&#41;+&#40;c&#41; but only if we&#39;re
counting cycles for native integers.

I guess we need to know what the goals are:
  - Fast for small inputs &#40;e.g. under 2^64&#41;
  - Fast for multi-hundred-digit inputs, especially next_prime
  - Adequate and simple code
Trying to speed everything up adds complication, especially when dealing
with multiple size scales.  I think just the simple &#40;b&#41;+&#40;c&#41; is best for now.


  &#40;d&#41; one MR test with base 2 =&gt; on failure: composite
  &#40;e&#41; Lucas test =&gt; on failure: composite

We have a choice of:
  - standard Lucas test, as shown in FIPS 186-4 C.3.3.  That implementation
is not very efficient, by the way.
  - strong Lucas test.  The false positives are a strict subset of the
standard test and it runs as fast as the standard test, so honestly there
is no reason not to use it.  Baillie and Wagstaff&#39;s paper recommends this.
  - extra strong Lucas test or &#34;almost extra strong&#34; Lucas test.  See
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.sti15.com/nt/pseudoprimes.html">http://www.sti15.com/nt/pseudoprimes.html</a></span>.  Typically faster and fewer
pseudoprimes.  The weaker version has been used by Pari for years.

There are no known pseudoprimes for any of them, and various math packages
use different versions.  We&#39;d be fine with the any of them, though I don&#39;t
see why one would use the non-strong test.  I chose the extra strong test
because it&#39;s faster than the standard and strong test, infinitesimally
slower than the almost-extra-strong test, and seems to have the strongest
result.

  &#40;f&#41; several MR tests with random base from [2, A-2] =&gt; on failure:
composite

We could put these here or after &#40;d&#41; -- it probably doesn&#39;t matter unless
the Lucas test is particularly slow relative to the MR test.

For the extra tests in MPU&#39;s is_prime I chose a number I thought was
appropriate based on some probabilities, and chosen not spend too much
time.  Some people make the argument that we shouldn&#39;t bother with any
extra tests until we find a BPSW counterexample, but I figured I&#39;d add
something.  For large inputs &#40;e.g. over 10k digits, so over 33k bits&#41; even
a single M-R test takes a noticeable amount of time.

For cryptographic purposes I think we shouldn&#39;t be quite so dismissive,
especially for keys.  You could look at what I did in Crypt::DSA::GMP where
I&#39;m trying to follow FIPS 186-4 appendix C &#40;for DSA, so table C.1&#41;.  Their
table for RSA isn&#39;t nearly as simple.  Usually I&#39;ve used a method like
B.3.1.A for random prime generation -- I&#39;ve never used B.3.1.B, which I
believe is trying to make sure p and q are strong primes.

Some thoughts:
  - Why step &#40;d&#41;?  Because it means any false positive must be a BPSW
counterexample.  If we had horrible luck with the random number generator
for the random bases, it still must pass base 2.  This is, however, my
opinion -- I don&#39;t think there is consensus on this.
  - What about duplicates in step &#40;f&#41;?  We could store the bases and make
sure we choose at least enough independent ones.  This is a problem if they
ask for 10M bases or something silly.  For large sizes it seems overkill
anyway, unless our PRNG is hacked.
  - The number of extra tests is based on the bit size and desired security
level.  The smaller the size or more security, the more tests.  Ideally
we&#39;d have a function that takes either A or log2&#40;A&#41; and returns a number of
extra tests, then verify that the return values are &gt;= the FIPS values.

  &#40;g&#41; if all tests pass =&gt; then PRIME


On Thu, Oct 10, 2013 at 2:26 PM, Karel Miko via RT
&lt;bug-CryptX@rt.cpan.org&gt;wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: CryptX
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=89400">https://rt.cpan.org/Ticket/Display.html?id=89400</a></span> &gt;
&gt;
&gt; I have put some ideas in a special branch at:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/DCIT/perl-CryptX/tree/better-primes">https://github.com/DCIT/perl-CryptX/tree/better-primes</a></span>
&gt;
&gt; The central point &#40;partly stolen from Math-Prime-Util-GMP&#41; is:
&gt;
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/DCIT/perl-CryptX/blob/better-primes/src/ltm/bn_mp_prime_is_prime.c">https://github.com/DCIT/perl-CryptX/blob/better-primes/src/ltm/bn_mp_prime_is_prime.c</a></span>
&gt;
&gt; I have newly added:
&gt;
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/DCIT/perl-CryptX/blob/better-primes/src/ltm/bn_mp_prime_miller_rabin_random.c">https://github.com/DCIT/perl-CryptX/blob/better-primes/src/ltm/bn_mp_prime_miller_rabin_random.c</a></span>
&gt;
&gt; The Lucas test is not implemented yet but should go to
&gt;
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/DCIT/perl-CryptX/blob/better-primes/src/ltm/bn_mp_prime_lucas.c">https://github.com/DCIT/perl-CryptX/blob/better-primes/src/ltm/bn_mp_prime_lucas.c</a></span>
&gt;
&gt; It it completely untested, just proof of concept to show the idea.
&gt;
&gt; There are couple of things I am not sure about:
&gt;
&gt; 1/ we are testing &#40;in this order&#41; whether
&gt;     - A is a known prime &#40;we know the first N primes&#41; =&gt; then PRIME
&gt;     - A is divisible by any of the first N primes =&gt; then composite
&gt;     - A &lt; N-th-prime^2 =&gt; then PRIME &#40;here is a bug in code&#41;
&gt;     - one MR test with base 2 =&gt; on failure: composite
&gt;     - Lucas test =&gt; on failure: composite
&gt;     - several MR tests with random base from [2, A-2] =&gt; on failure:
&gt; composite
&gt;     - if all tests pass =&gt; then PRIME
&gt; is it OK?
&gt;
&gt; 2/ As the same routine is used for generating RSA keys and DSA params it
&gt; would be nice to determine the number of MR tests with random base from bit
&gt; length of A. However FIPS.186-4 tables C.1, C.2 and C.3 are still a bit
&gt; unclear to me.
&gt;
&gt; 3/ And of course Lucas implementation is missing.
&gt;
&gt; Dana, I would appreciate any help with this issue.
&gt;
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1273548/674510/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/674510">with headers</a>
<br />
<span class="downloadcontenttype">text/html 9.1k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1273549" href="/Public/Bug/Display.html?id=89400#txn-1273549">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;11&nbsp;01:14:09&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1339525" href="/Public/Bug/Display.html?id=89400#txn-1339525">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;17&nbsp;17:24:18&nbsp;2014</span>
    <span class="description">MLEHMANN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1339525/710729/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/710729">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 401b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2013-10-11 01:14:08, dana.jacobsen@gmail.com wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#40;c&#41; A &lt; N-th-prime^2 =&gt; then PRIME &#40;here is a bug in code&#41;
&gt; 
&gt; Yes, step &#40;c&#41; doesn&#39;t look right:  Given the sizes involved, we should
</div>
Saw this by accident, it&#39;s late, and maybe I am a bit dense, but &#40;c&#41; looks
fine to me: if a number has no factors &lt;= q and is &lt;= q**2, then it must
be prime, as otherwise one of its factors would be &lt;= q.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1339533" href="/Public/Bug/Display.html?id=89400#txn-1339533">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;17&nbsp;18:12:43&nbsp;2014</span>
    <span class="description">DANAJ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1339533/710737/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/710737">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 631b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Mar 17 17:24:18 2014, MLEHMANN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 2013-10-11 01:14:08, dana.jacobsen@gmail.com wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; &#40;c&#41; A &lt; N-th-prime^2 =&gt; then PRIME &#40;here is a bug in code&#41;
&gt; &gt; 
&gt; &gt; Yes, step &#40;c&#41; doesn&#39;t look right:  Given the sizes involved, we should
</div>&gt; 
&gt; Saw this by accident, it&#39;s late, and maybe I am a bit dense, but &#40;c&#41; looks
&gt; fine to me: if a number has no factors &lt;= q and is &lt;= q**2, then it must
&gt; be prime, as otherwise one of its factors would be &lt;= q.
</div>
There was a defect in the code at that time, where it would return true if the variable was *equal* to P^2.  The Nov 13 code on that branch now does the &lt; comparison.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1339551" href="/Public/Bug/Display.html?id=89400#txn-1339551">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;17&nbsp;19:08:06&nbsp;2014</span>
    <span class="description">DANAJ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1339551/710747/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/710747">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 250b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">To make sure it&#39;s clear, the defect was in the test feature branch, not on any released code.

I also see that my October reply was very much a brain dump as I read through the code, and could have used more clarity.  I also need to get back to this.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.416227</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
