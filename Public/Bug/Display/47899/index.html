<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #47899 for XML-Bare: UTF8 mangling of parsed data</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #47899 for XML-Bare: UTF8 mangling of parsed data</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/XML-Bare/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/XML-Bare/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/XML-Bare/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/XML-Bare/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-Bare">XML-Bare CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">47899</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/XML-Bare/Active/">XML-Bare</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">cpan [...] codechild.com
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
nigel.metheringham [...] Dev.intechnology.co.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-43826-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.43    </td>
  </tr>
  <tr id="CF-43827-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.44    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;15&nbsp;06:16:26&nbsp;2009</span>
    <span class="description">nigel.metheringham [...] Dev.intechnology.co.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> UTF8 mangling of parsed data</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">UTF8 strings within XML come out as strings with the UTF8 flag set, but
set as individual bytes rather than utf8 codepoints.

Attached patch attempts to fix this and includes 2 test sets to
indicate the issue.

Tested on OS X 10.5.7 with perl 5.8.8 &#40;system perl&#41;.
However this appears to be portable :-&#41;
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> xml-base-utf8.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"> Bare.xs             |    9 +++++++++
 t/utf8-attributes.t |   50 ++++++++++++++++++++++++++++++++++++++++++++++++++
 t/utf8-values.t     |   51 +++++++++++++++++++++++++++++++++++++++++++++++++++
 3 files changed, 110 insertions&#40;+&#41;, 0 deletions&#40;-&#41;

diff --git a/Bare.xs b/Bare.xs
index 7189f1e..29d498a 100644
--- a/Bare.xs
+++ b/Bare.xs
@@ -39,6 +39,7 @@ SV *cxml2obj&#40;&#41; {
   if&#40; !length &#41; {
     if&#40; curnode-&gt;vallen &#41; {
       SV * sv = newSVpvn&#40; curnode-&gt;value, curnode-&gt;vallen &#41;;
+      SvUTF8_on &#40;sv&#41;;
       hv_store&#40; output, &#34;value&#34;, 5, sv, vhash &#41;;
       if&#40; curnode-&gt;type &#41; {
         SV *svi = newSViv&#40; 1 &#41;;
@@ -47,12 +48,14 @@ SV *cxml2obj&#40;&#41; {
     }
     if&#40; curnode-&gt;comlen &#41; {
       SV * sv = newSVpvn&#40; curnode-&gt;comment, curnode-&gt;comlen &#41;;
+      SvUTF8_on &#40;sv&#41;;
       hv_store&#40; output, &#34;comment&#34;, 7, sv, chash &#41;;
     }
   }
   else {
     if&#40; curnode-&gt;vallen &#41; {
       SV *sv = newSVpvn&#40; curnode-&gt;value, curnode-&gt;vallen &#41;;
+      SvUTF8_on &#40;sv&#41;;
       hv_store&#40; output, &#34;value&#34;, 5, sv, vhash &#41;;
       if&#40; curnode-&gt;type &#41; {
         SV *svi = newSViv&#40; 1 &#41;;
@@ -61,6 +64,7 @@ SV *cxml2obj&#40;&#41; {
     }
     if&#40; curnode-&gt;comlen &#41; {
       SV *sv = newSVpvn&#40; curnode-&gt;comment, curnode-&gt;comlen &#41;;
+      SvUTF8_on &#40;sv&#41;;
       hv_store&#40; output, &#34;comment&#34;, 7, sv, chash &#41;;
     }
     
@@ -126,6 +130,7 @@ SV *cxml2obj&#40;&#41; {
       hv_store&#40; output, curatt-&gt;name, curatt-&gt;namelen, atthref, 0 &#41;;
       
       attval = newSVpvn&#40; curatt-&gt;value, curatt-&gt;vallen &#41;;
+      SvUTF8_on &#40;attval&#41;;
       hv_store&#40; atth, &#34;value&#34;, 5, attval, vhash &#41;;
       attatt = newSViv&#40; 1 &#41;;
       hv_store&#40; atth, &#34;_att&#34;, 4, attatt, ahash &#41;;
@@ -146,6 +151,7 @@ SV *cxml2obj_simple&#40;&#41; {
   if&#40; &#40; length + numatts &#41; == 0 &#41; {
     if&#40; curnode-&gt;vallen &#41; {
       SV * sv = newSVpvn&#40; curnode-&gt;value, curnode-&gt;vallen &#41;;
+      SvUTF8_on &#40;sv&#41;;
       return sv;
     }
     return newSViv&#40; 1 &#41;; //&#38;PL_sv_undef;
@@ -158,6 +164,7 @@ SV *cxml2obj_simple&#40;&#41; {
     curnode = curnode-&gt;firstchild;
     for&#40; i = 0; i &lt; length; i++ &#41; {
       SV *namesv = newSVpvn&#40; curnode-&gt;name, curnode-&gt;namelen &#41;;
+      SvUTF8_on &#40;namesv&#41;;
       
       SV **cur = hv_fetch&#40; output, curnode-&gt;name, curnode-&gt;namelen, 0 &#41;;
       
@@ -209,6 +216,7 @@ SV *cxml2obj_simple&#40;&#41; {
           STRLEN len;
           char *ptr = SvPV&#40;*cur, len&#41;;
           SV *newsv = newSVpvn&#40; ptr, len &#41;;
+          SvUTF8_on &#40;newsv&#41;;
           
           av_push&#40; newarray, newsv &#41;;
           hv_delete&#40; output, curnode-&gt;name, curnode-&gt;namelen, 0 &#41;;
@@ -225,6 +233,7 @@ SV *cxml2obj_simple&#40;&#41; {
     curatt = curnode-&gt;firstatt;
     for&#40; i = 0; i &lt; numatts; i++ &#41; {
       attval = newSVpvn&#40; curatt-&gt;value, curatt-&gt;vallen &#41;;
+      SvUTF8_on &#40;attval&#41;;
       hv_store&#40; output, curatt-&gt;name, curatt-&gt;namelen, attval, 0 &#41;;
       if&#40; i != &#40; numatts - 1 &#41; &#41; curatt = curatt-&gt;next;
     }
diff --git a/t/utf8-attributes.t b/t/utf8-attributes.t
new file mode 100644
index 0000000..9dc09b2
--- /dev/null
+++ b/t/utf8-attributes.t
@@ -0,0 +1,50 @@
+#!/usr/bin/perl -w
+
+use strict;
+use warnings;
+
+# NB we have use utf8 here, but the source should be 7bit clean
+# however I need the utf8::is_utf8 and utf8::valid names which
+# are no longer exposed without the use line.
+use utf8;
+
+use Test::More qw&#40;no_plan&#41;;
+
+use_ok&#40;&#39;XML::Bare&#39;&#41;;
+
+my $data = {
+    hash   =&gt; &#34;#&#34;,
+    oo     =&gt; &#34;\x{f6}&#34;,
+    iso_a  =&gt; &#34;\x{c4}&#34;,
+    iso_oo =&gt; &#34;\x{d6}&#34;,
+    aa     =&gt; &#34;\x{e4}&#34;,
+    euro   =&gt; &#34;\x{20ac}&#34;,
+};
+
+# build XML string with UTF8 values
+my $xmldata = &#34;&lt;data&gt;\n&#34;;
+foreach &#40; keys %{$data} &#41; {
+    $xmldata .= &#34;  &lt;$_ char=\&#34;&#34; . $data-&gt;{$_} . &#34;\&#34; /&gt;\n&#34;;
+}
+$xmldata .= &#34;&lt;/data&gt;\n&#34;;
+
+# parse the provided XML
+my $obj = new XML::Bare&#40; text =&gt; $xmldata &#41;;
+my $root = $obj-&gt;parse;
+
+# convert back to XML from parse
+my $roundtrip = $obj-&gt;xml&#40;$root&#41;;
+
+## this isn&#39;t valid as order/spacing not preserved
+#is&#40; $roundtrip, $xmldata, &#39;Round trip XML identical&#39; &#41;;
+
+while &#40; my &#40; $name, $char &#41; = each %{$data} &#41; {
+    my $str = $root-&gt;{data}{$name}{char}{value};
+    ok&#40; $root-&gt;{data}{$name}{char}{_att}, &#34;$name has char attribute&#34; &#41;;
+    ok&#40; utf8::is_utf8&#40;$str&#41;, &#34;Character $name is correct encoding&#34; &#41;
+      if &#40; utf8::is_utf8&#40;$char&#41; &#41;;
+    ok&#40; utf8::valid&#40;$str&#41;, &#34;Character $name is Valid&#34; &#41;;
+    ok&#40; &#40; length&#40;$str&#41; == 1 &#41;, &#34;String returned for $name is 1 char long&#34; &#41;;
+
+    is&#40; $str, $char, &#34;Character $name OK&#34; &#41;;
+}
diff --git a/t/utf8-values.t b/t/utf8-values.t
new file mode 100644
index 0000000..94fad45
--- /dev/null
+++ b/t/utf8-values.t
@@ -0,0 +1,51 @@
+#!/usr/bin/perl -w
+
+use strict;
+use warnings;
+
+# NB we have use utf8 here, but the source should be 7bit clean
+# however I need the utf8::is_utf8 and utf8::valid names which
+# are no longer exposed without the use line.
+use utf8;
+
+use Test::More qw&#40;no_plan&#41;;
+
+use_ok&#40;&#39;XML::Bare&#39;&#41;;
+
+my $data = {
+    hash   =&gt; &#34;#&#34;,
+    oo     =&gt; &#34;\x{f6}&#34;,
+    iso_a  =&gt; &#34;\x{c4}&#34;,
+    iso_oo =&gt; &#34;\x{d6}&#34;,
+    aa     =&gt; &#34;\x{e4}&#34;,
+    euro   =&gt; &#34;\x{20ac}&#34;,
+};
+
+# build XML string with UTF8 values
+my $xmldata = &#34;&lt;data&gt;\n&#34;;
+foreach &#40; keys %{$data} &#41; {
+    $xmldata .= &#34;  &lt;$_&gt;&#34;;
+    $xmldata .= $data-&gt;{$_};
+    $xmldata .= &#34;&lt;/$_&gt;\n&#34;;
+}
+$xmldata .= &#34;&lt;/data&gt;\n&#34;;
+
+# parse the provided XML
+my $obj = new XML::Bare&#40; text =&gt; $xmldata &#41;;
+my $root = $obj-&gt;parse;
+
+# convert back to XML from parse
+my $roundtrip = $obj-&gt;xml&#40;$root&#41;;
+
+## this isn&#39;t valid as order/spacing not preserved
+#is&#40; $roundtrip, $xmldata, &#39;Round trip XML identical&#39; &#41;;
+
+while &#40; my &#40; $name, $char &#41; = each %{$data} &#41; {
+    my $str = $root-&gt;{data}{$name}{value};
+    ok&#40; utf8::is_utf8&#40;$str&#41;, &#34;Character $name is correct encoding&#34; &#41;
+      if &#40; utf8::is_utf8&#40;$char&#41; &#41;;
+    ok&#40; utf8::valid&#40;$str&#41;, &#34;Character $name is Valid&#34; &#41;;
+    ok&#40; &#40; length&#40;$str&#41; == 1 &#41;, &#34;String returned for $name is 1 char long&#34; &#41;;
+
+    is&#40; $str, $char, &#34;Character $name OK&#34; &#41;;
+}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;25&nbsp;15:07:44&nbsp;2009</span>
    <span class="description">cpan [...] codechild.com -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;25&nbsp;15:08:34&nbsp;2009</span>
    <span class="description">cpan [...] codechild.com -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;25&nbsp;15:16:04&nbsp;2009</span>
    <span class="description">cpan [...] codechild.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you very much for noting the need to mark created SVs as UTF8. I
did not realize that the problems people were having with UTF8 were
caused by that.

Note that that the parser does not function at all properly with UTF16.
In the near future I will likely write a new parser core that can handle
UTF16...

I have included your fixes and the additional test files you wrote in
the new 0.44 version of the module.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;25&nbsp;18:34:54&nbsp;2009</span>
    <span class="description">cpan [...] codechild.com -  Fixed in 0.44 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;25&nbsp;18:34:59&nbsp;2009</span>
    <span class="description">cpan [...] codechild.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
