<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #41655 for MIME-tools: RFC2231 strings decoded in MIME header string can corrupt it</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #41655 for MIME-tools: RFC2231 strings decoded in MIME header string can corrupt it</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/MIME-tools/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/MIME-tools/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/MIME-tools/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/MIME-tools/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/MIME-tools">MIME-tools CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">41655</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/MIME-tools/Active/">MIME-tools</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
SKA [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-21368-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
5.427    </td>
  </tr>
  <tr id="CF-21369-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;12&nbsp;10:44:19&nbsp;2008</span>
    <span class="description">SKA [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RFC2231 strings decoded in MIME header string can corrupt it</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached patch re-MIME::Words encode RFC2231 headers in order to 
preserve the structure of the header, e.g. if 8bit chars, spaces, 
quotes or quotes are embedded in the token.

Before re-encoding all parts are joined together, thus, if a 
multi-byte character had been split on two parts, it is returned in 
one string from decode_mimewords&#40;&#41;.

This would lead to a behaviour as if called decode&#40;&#41; on the MIME::Head 
object.

Furthermore, added &#34; and ; to encode_mimeword&#40;&#41; Q-mode in order to 
protect the token against MIME structure processing.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch_1_rfc2231.diff</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"># HG changeset patch
# User Steffen Kaiser
# Date 1228920577 -3600
# Node ID d6223803d86fb00cde6b054c1dd1992d1a97dffb
# Parent  07211c59ce82f5ee9cccd51a19c4a991c30255d1
add: RFC2231 encoding is re-encoded into MIME::Words

RFC2231 decoding breaks reconstruction of header and differs from the
fact that MIME::Words are left in the string

This patch re-encodes the strings into MIME::Words using the same
character set and the &#39;Q&#39;-encoding, but as _one_ MIME::Word.  This might
break the headers, too, because words longer than 64 characters may
happen and they are not separated by CRLF SPACE.

Before re-encoding all parts are joined together, thus, multi-byte
characters split over different parts are joined for easier MIME decoding
later on.

Though, embedded &#34; and ; characters won&#39;t effect parsing.

diff -r 07211c59ce82 -r d6223803d86f Field/ParamVal.pm
--- a/Field/ParamVal.pm	Mon Dec 01 11:42:32 2008 +0100
+++ b/Field/ParamVal.pm	Wed Dec 10 15:49:37 2008 +0100
@@ -69,6 +69,7 @@
 
 # Kit modules:
 use MIME::Tools qw&#40;:config :msgs&#41;;
+use MIME::Words;
 
 @ISA = qw&#40;Mail::Field&#41;;
 
@@ -146,6 +147,9 @@
 Supplying undef for a hashref, or an empty set of values, effectively
 clears the object.
 
+RFC2231 encoding is removed from the parameter values and replaced by
+MIME::Word encoding.
+
 The self object is returned.
 
 =cut
@@ -187,36 +191,11 @@
 
 =cut
 
-sub rfc2231decode {
-    my&#40;$val&#41; = @_;
-    my&#40;$enc, $lang, $rest&#41;;
-
-    if &#40;$val =~ m/^&#40;[^\&#39;]*&#41;\&#39;&#40;[^\&#39;]*&#41;\&#39;&#40;.*&#41;$/&#41; {
-	# SHOULD REALLY DO SOMETHING MORE INTELLIGENT WITH ENCODING!!!
-	$enc = $1;
-	$lang = $2;
-	$rest = $3;
-	$rest = rfc2231percent&#40;$rest&#41;;
-    } elsif &#40;$val =~ m/^&#40;[^\&#39;]*&#41;\&#39;&#40;[^\&#39;]*&#41;$/&#41; {
-	$enc = $1;
-	$rest = $2;
-	$rest = rfc2231percent&#40;$rest&#41;;
-    } else {
-	$rest = rfc2231percent&#40;$val&#41;;
-    }
-    return $rest;
-}
-
-sub rfc2231percent {
-    # Do percent-subsitution
-    my&#40;$str&#41; = @_;
-    $str =~ s/%&#40;[0-9a-fA-F]{2}&#41;/pack&#40;&#34;C&#34;, hex&#40;$1&#41;&#41;/ge;
-    return $str;
-}
-
 sub parse_params {
     my &#40;$self, $raw&#41; = @_;
     my %params = &#40;&#41;;
+    		# next hash contains &#34;charset&#34; for the encoding to apply
+    		#	&#34;decode&#34; a HASH ref of params to apply the charset to
     my %rfc2231params = &#40;&#41;;
     my $param;
     my $val;
@@ -234,51 +213,94 @@
     # Extract subsequent parameters.
     # No, we can&#39;t just &#34;split&#34; on semicolons: they&#39;re legal in quoted strings!
     while &#40;1&#41; {                     # keep chopping away until done...
-	$raw =~ m/\G$SPCZ\;$SPCZ/og or last;             # skip leading separator
-	$raw =~ m/\G&#40;$PARAMNAME&#41;\s*=\s*/og or last;      # give up if not a param
-	$param = lc&#40;$1&#41;;
-	$raw =~ m/\G&#40;\&#34;&#40;[^\&#34;]*&#41;\&#34;&#41;|\G&#40;$ENCTOKEN&#41;|\G&#40;$BADTOKEN&#41;|\G&#40;$TOKEN&#41;/g or last;   # give up if no value&#34;
-	my &#40;$qstr, $str, $enctoken, $badtoken, $token&#41; = &#40;$1, $2, $3, $4, $5&#41;;
-	if &#40;defined&#40;$badtoken&#41;&#41; {
-	    # Strip leading/trailing whitespace from badtoken
-	    $badtoken =~ s/^\s*//;
-	    $badtoken =~ s/\s*$//;
-	}
-	$val = defined&#40;$qstr&#41; ? $str :
-	    &#40;defined&#40;$enctoken&#41; ? $enctoken :
-	     &#40;defined&#40;$badtoken&#41; ? $badtoken : $token&#41;&#41;;
+		$raw =~ m/\G$SPCZ\;$SPCZ/og or last;             # skip leading separator
+		$raw =~ m/\G&#40;$PARAMNAME&#41;\s*=\s*/og or last;      # give up if not a param
+		$param = lc&#40;$1&#41;;
+		$raw =~ m/\G&#40;\&#34;&#40;[^\&#34;]*&#41;\&#34;&#41;|\G&#40;$ENCTOKEN&#41;|\G&#40;$BADTOKEN&#41;|\G&#40;$TOKEN&#41;/g or last;   # give up if no value&#34;
+		my &#40;$qstr, $str, $enctoken, $badtoken, $token&#41; = &#40;$1, $2, $3, $4, $5&#41;;
+		if &#40;defined&#40;$badtoken&#41;&#41; {
+			# Strip leading/trailing whitespace from badtoken
+			$badtoken =~ s/^\s*//;
+			$badtoken =~ s/\s*$//;
+		}
+		$val = defined&#40;$qstr&#41; ? $str :
+			&#40;defined&#40;$enctoken&#41; ? $enctoken :
+			 &#40;defined&#40;$badtoken&#41; ? $badtoken : $token&#41;&#41;;
 
-	# Do RFC 2231 processing
-	if &#40;$param =~ /\*/&#41; {
-	    my&#40;$name, $num&#41;;
-	    # Pick out the parts of the parameter
-	    if &#40;$param =~ m/^&#40;[^*]+&#41;\*&#40;[^*]+&#41;\*?$/&#41; {
-		# We have param*number* or param*number
-		$name = $1;
-		$num = $2;
-	    } else {
-		# Fake a part of zero... not sure how to handle this properly
-		$param =~ s/\*//g;
-		$name = $param;
-		$num = 0;
-	    }
-	    # Decode the value unless it was a quoted string
-	    if &#40;!defined&#40;$qstr&#41;&#41; {
-		$val = rfc2231decode&#40;$val&#41;;
-	    }
-	    $rfc2231params{$name}{$num} .= $val;
-	} else {
-	    # Make a fake &#34;part zero&#34; for non-RFC2231 params
-	    $rfc2231params{$param}{&#34;0&#34;} = $val;
-	}
+		# Do RFC 2231 processing
+		#  Variants:
+		#	1&#41; name=&#34;value value&#34;
+		#	2&#41; name=value
+		#	3&#41; name*=percent_encoded
+		#	4&#41; name*#=&#34;continuable value&#34;
+		#	5&#41; name*#*=continuable_value_percent_encoded
+		my $num;
+		if&#40;$param =~ s/&#40;\*+&#40;\d+&#41;&#41;&#40;\**&#41;$//&#41; {	# param := name of field
+			$num = defined&#40;$1&#41;? 0+$2: 0;
+			if&#40;length&#40;$3&#41;&#41; {	# decode this part
+				if&#40;$num == 0 &#38;&#38; $val =~ s/^&#40;[^\&#39;]*&#41;\&#39;&#40;[^\&#39;]*&#41;\&#39;//&#41; {
+						# the first field may contain encoding
+					$rfc2231params{$param}{charset} = $1;
+#not used!					$rfc2231params{$param}{language} = $2;
+				}
+					# percent decode the value
+					# per standard no $qstr &#40;quoted string&#41; should be here
+					# we just ignore it, previous implementation skipped
+					# decoding in this situation
+				$val =~ s/%&#40;[0-9a-fA-F]{2}&#41;/pack&#40;&#34;C&#34;, hex&#40;$1&#41;&#41;/ge;
+				$rfc2231params{$param}{decode}{$num} = 1;
+			}
+		} else {
+			$num = 0;	# neither \*\d+ nor \*$ =&gt; fake first part
+		}
+		$rfc2231params{$param}{$num} = $val;
     }
+
+    # RFC2231-encoded and non-encoded parts may follow
+    # each other in any order &#40;except that part number 0 MUST
+    # be encoded&#41;.
+
+    # Note: RFC2231 decoding breaks the further processing such
+    # that it is not reversable by MIME::Tools. Hence, we re-encode
+    # the string as proper MIME::Word and keep the character set
+    # that way. Also, because MIME::Word encoding is not removed
+    # in this function, there would be a different decoding of
+    # both encoding styles.
 
     # Extract reconstructed parameters
     foreach $param &#40;keys %rfc2231params&#41; {
-	foreach $part &#40;sort { $a &lt;=&gt; $b } keys %{$rfc2231params{$param}}&#41; {
-	    $params{$param} .= $rfc2231params{$param}{$part};
-	}
-	debug &#34;   field param &lt;$param&gt; = &lt;$params{$param}&gt;&#34;;
+    	$params{$param} = &#39;&#39;;
+    	my $charset = delete $rfc2231params{$param}{charset};
+    	my $decode = delete $rfc2231params{$param}{decode};
+    		# use empty %decode if no charset is to be applied
+    	$decode = { } if !defined&#40;$charset&#41; || !defined&#40;$decode&#41;;
+		for&#40;sort { $a &lt;=&gt; $b } keys %{$rfc2231params{$param}}&#41; {
+			my $part = delete $rfc2231params{$param}{$_};
+			unless&#40;exists $decode-&gt;{$_}&#41; {
+				$params{$param} .= $part;
+			} else {		# re-encode
+				# the resulting string should not exceed the 74 char limit
+				# Also encode ; and &#34; in order to keep the MIME header
+				# structure
+				$params{$param} .= MIME::Words::encode_mimeword&#40;$part, &#39;q&#39;, $charset&#41;;
+			}
+		}
+		my @parts = sort { $b &lt;=&gt; $a } keys %{$rfc2231params{$param}};	# others are parts
+		while&#40;defined&#40;my $first = pop @parts&#41;&#41; {
+			my $part = delete $rfc2231params{$param}{$first};
+			unless&#40;exists $decode-&gt;{$first}&#41; {
+				$params{$param} .= $part;
+				next;
+			}
+				# join successive parts
+			my $num = $first;
+			while&#40;scalar&#40;@parts&#41; &#38;&#38; $parts[$#parts] == ++$num&#41; {
+				pop @parts;
+				$part .= delete $rfc2231params{$param}{$num};
+			}
+			$params{$param} .= encode_mimewords&#40;$part, Charset =&gt; $charset&#41;;
+		}
+		debug &#34;   field param &lt;$param&gt; = &lt;$params{$param}&gt;&#34;;
     }
 
     # Done:
diff -r 07211c59ce82 -r d6223803d86f Words.pm
--- a/Words.pm	Mon Dec 01 11:42:32 2008 +0100
+++ b/Words.pm	Wed Dec 10 15:49:37 2008 +0100
@@ -114,9 +114,11 @@
 # _encode_Q STRING
 #     Private: used by _encode_header&#40;&#41; to decode &#34;Q&#34; encoding, which is
 #     almost, but not exactly, quoted-printable.  :-P
+#	Also encode ; and &#34; to drop their MIME header meaning.
 sub _encode_Q {
     my $str = shift;
-    $str =~ s{&#40;[ _\?\=$NONPRINT]&#41;}{sprintf&#40;&#34;=%02X&#34;, ord&#40;$1&#41;&#41;}eog;
+    $str =~ s{&#40;[;&#34;_\?\=$NONPRINT]&#41;}{sprintf&#40;&#34;=%02X&#34;, ord&#40;$1&#41;&#41;}eog;	# rule 1
+    $str =~ tr/ /_/;	# save 2 bytes per space					# rule 2
     $str;
 }
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;22&nbsp;13:29:46&nbsp;2010</span>
    <span class="description">dmo+pause [...] dmo.ca -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Any chance you&#39;ve got time to respin this against 5.428, and maybe add a
testcase or two?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;22&nbsp;13:29:53&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
