<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #128840 for grpc-xs: t/01-call_credentials.t crashes with &#34;double free or corruption &#40;fasttop&#41;&#34; on ppc64le, s390x, and armv7hl</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #128840 for grpc-xs: t/01-call_credentials.t crashes with &#34;double free or corruption &#40;fasttop&#41;&#34; on ppc64le, s390x, and armv7hl</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=grpc-xs">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=grpc-xs">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=grpc-xs">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=grpc-xs">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/grpc-xs">grpc-xs CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">128840</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=grpc-xs">grpc-xs</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ppisar [...] redhat.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-268700-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.20    </td>
  </tr>
  <tr id="CF-268701-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




grpc-xs-0.20-Adapt-to-plugin-credentials-API-change-in-gRPC.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1838238/988269/grpc-xs-0.20-Adapt-to-plugin-credentials-API-change-in-gRPC.patch">
Fri Mar 15 10:00:01 2019 (3.5k) by ppisar [...] redhat.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=128840">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1838225" href="/Public/Bug/Display.html?id=128840#txn-1838225">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;15&nbsp;04:57:55&nbsp;2019</span>
    <span class="description">ppisar [...] redhat.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> t/01-call_credentials.t crashes with &#34;double free or corruption
 &#40;fasttop&#41;&#34; on ppc64le, s390x, and armv7hl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1838225/988262/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/988262">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">t/01-call_credentials.t test crashes always on ppc64le, s390x, and armv7hl platforms with &#34;double free or corruption &#40;fasttop&#41;&#34;. It passes on x86_64, i686 and aarch64. I don&#39;t have a back trace yet, but a compiler warning seems to highlight a possible reason:

mv Grpc.xsc Grpc.c
[...]
gcc -c  -I. -D_REENTRANT -D_GNU_SOURCE -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mcpu=power8 -mtune=power8 -fasynchronous-unwind-tables -fstack-clash-protection -fwrapv -fno-strict-aliasing -I/usr/local/include -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64 -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mcpu=power8 -mtune=power8 -fasynchronous-unwind-tables -fstack-clash-protection   -DVERSION=\&#34;0.20\&#34; -DXS_VERSION=\&#34;0.20\&#34; -fPIC &#34;-I/usr/lib64/perl5/CORE&#34;  -DGRPC_VERSION_1_1 -DGRPC_VERSION_1_2 -DGRPC_VERSION_1_4 -DGRPC_RECV_STATUS_ON_CLIENT_HAS_ERROR_STRING -DGRPC_SSL_CREDENTIALS_HAS_4_ARGS Grpc.c
[...]
BUILDSTDERR: ./ext/call_credentials.xs: In function &#39;XS_Grpc__XS__CallCredentials_createFromPlugin&#39;:
BUILDSTDERR: ./ext/call_credentials.xs:19:25: warning: assignment to &#39;int &#40;*&#41;&#40;void *, grpc_auth_metadata_context,  void &#40;*&#41;&#40;void *, const grpc_metadata *, size_t,  grpc_status_code,  const char *&#41;, void *, grpc_metadata *, size_t *, grpc_status_code *, const char **&#41;&#39; {aka &#39;int &#40;*&#41;&#40;void *, struct &lt;anonymous&gt;,  void &#40;*&#41;&#40;void *, const struct grpc_metadata *, long unsigned int,  enum &lt;anonymous&gt;,  const char *&#41;, void *, struct grpc_metadata *, long unsigned int *, enum &lt;anonymous&gt; *, const char **&#41;&#39;} from incompatible pointer type &#39;void &#40;*&#41;&#40;void *, grpc_auth_metadata_context,  void &#40;*&#41;&#40;void *, const grpc_metadata *, size_t,  grpc_status_code,  const char *&#41;, void *&#41;&#39; {aka &#39;void &#40;*&#41;&#40;void *, struct &lt;anonymous&gt;,  void &#40;*&#41;&#40;void *, const struct grpc_metadata *, long unsigned int,  enum &lt;anonymous&gt;,  const char *&#41;, void *&#41;&#39;} [-Wincompatible-pointer-types]
BUILDSTDERR:    19 |     plugin.get_metadata = plugin_get_metadata;
BUILDSTDERR:       |                         ^

Although the warning presents on all platforms.

I have perl 5.28.1, gcc 9.0.1, glibc 2.29.9000, grpc 1.18.0.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1838235" href="/Public/Bug/Display.html?id=128840#txn-1838235">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;15&nbsp;07:56:36&nbsp;2019</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1838235/988265/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/988265">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Pá 15.bře.2019 04:57:55, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; t/01-call_credentials.t test crashes always on ppc64le, s390x, and
&gt; armv7hl platforms with &#34;double free or corruption &#40;fasttop&#41;&#34;.
</div>
The test prints:

1..28
ok 1 - use Grpc::XS::CallCredentials;
ok 2 - use Grpc::XS::Server;
ok 3 - use Grpc::XS::ChannelCredentials;
ok 4 - use Grpc::XS::ServerCredentials;
ok 5 - use Grpc::Constants;
ok 6 - call back func failed service_url
ok 7 - call back func failed method_name
double free or corruption &#40;fasttop&#41;
Aborted &#40;core dumped&#41;

A back trace is:

0x00007ffff7a12588 in __libc_signal_restore_set &#40;set=0x7fffffffd498&#41; at ../sysdeps/unix/sysv/linux/internal-signals.h:84
84        return INTERNAL_SYSCALL &#40;rt_sigprocmask, err, 4, SIG_SETMASK, set, NULL,
&#40;gdb&#41; bt
#0  0x00007ffff7a12588 in __libc_signal_restore_set &#40;set=0x7fffffffd498&#41; at ../sysdeps/unix/sysv/linux/internal-signals.h:84
#1  __GI_raise &#40;sig=&lt;optimized out&gt;&#41; at ../sysdeps/unix/sysv/linux/raise.c:48
#2  0x00007ffff79f4710 in __GI_abort &#40;&#41; at abort.c:79
#3  0x00007ffff7a5dbbc in __libc_message &#40;action=&lt;optimized out&gt;, fmt=&lt;optimized out&gt;&#41; at ../sysdeps/posix/libc_fatal.c:181
#4  0x00007ffff7a675c8 in malloc_printerr &#40;str=&lt;optimized out&gt;, str@entry=0x7ffff7b78640 &#34;double free or corruption &#40;fasttop&#41;&#34;&#41; at malloc.c:5352
#5  0x00007ffff7a69860 in _int_free &#40;av=0x7ffff7bd0dc0 &lt;main_arena&gt;, p=0x100acfa10, have_lock=&lt;optimized out&gt;&#41; at malloc.c:4274
#6  0x00007ffff71fe268 in gpr_free &#40;&#41; from /lib64/libgrpc.so.7
#7  0x00007ffff717f55c in grpc_plugin_credentials::get_request_metadata&#40;grpc_polling_entity*, grpc_auth_metadata_context, grpc_credentials_mdelem_array*, grpc_closure*, grpc_error**&#41;
    &#40;&#41; from /lib64/libgrpc.so.7
#8  0x00007ffff718c534 in ?? &#40;&#41; from /lib64/libgrpc.so.7
#9  0x00007ffff718c9b4 in ?? &#40;&#41; from /lib64/libgrpc.so.7
#10 0x00007ffff70e891c in grpc_call_next_op&#40;grpc_call_element*, grpc_transport_stream_op_batch*&#41; &#40;&#41; from /lib64/libgrpc.so.7
#11 0x00007ffff71fd268 in ?? &#40;&#41; from /lib64/libgrpc.so.7
#12 0x00007ffff71c69b0 in grpc_subchannel_call_process_op&#40;grpc_subchannel_call*, grpc_transport_stream_op_batch*&#41; &#40;&#41; from /lib64/libgrpc.so.7
#13 0x00007ffff71ac150 in ?? &#40;&#41; from /lib64/libgrpc.so.7
#14 0x00007ffff7106dc0 in grpc_core::ExecCtx::Flush&#40;&#41; &#40;&#41; from /lib64/libgrpc.so.7
#15 0x00007ffff70feb40 in ?? &#40;&#41; from /lib64/libgrpc.so.7
#16 0x00007ffff710538c in ?? &#40;&#41; from /lib64/libgrpc.so.7
#17 0x00007ffff710b280 in grpc_pollset_work&#40;grpc_pollset*, grpc_pollset_worker**, long&#41; &#40;&#41; from /lib64/libgrpc.so.7
#18 0x00007ffff7138a70 in ?? &#40;&#41; from /lib64/libgrpc.so.7
#19 0x00007ffff7138fa8 in grpc_completion_queue_pluck &#40;&#41; from /lib64/libgrpc.so.7
#20 0x00007ffff72aba90 in XS_Grpc__XS__Call_startBatch &#40;my_perl=0x100030260, cv=&lt;optimized out&gt;&#41; at ./ext/call.xs:266
#21 0x00007ffff7d0c274 in Perl_pp_entersub &#40;&#41; from /lib64/libperl.so.5.28
#22 0x00007ffff7d0020c in Perl_runops_standard &#40;&#41; from /lib64/libperl.so.5.28
#23 0x00007ffff7c5a7bc in perl_run &#40;&#41; from /lib64/libperl.so.5.28
#24 0x0000000100000ee0 in main &#40;argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;, env=&lt;optimized out&gt;&#41; at perlmain.c:122

So it crashes on gpr_free&#40;&#41; called from the end of grpc_plugin_credentials::get_request_metadata&#40;&#41; function. The function modifies gpr_free&#40;&#41;-d error_details pointer by this code:

    if &#40;!plugin_.get_metadata&#40;
            plugin_.state, context, plugin_md_request_metadata_ready, request,
            creds_md, &#38;num_creds_md, &#38;status, &#38;error_details&#41;&#41; {
       [...]
    }

This I believe this a mismatch on the plugin.get_metadata prototype and plugin_get_metadata&#40;&#41; function provided by grpc-xs in util.c as warned by the compiler. It manifests only on platforms where a calling convention passes clobbers the unspecified arguments like the final error_details.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1838238" href="/Public/Bug/Display.html?id=128840#txn-1838238">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;15&nbsp;10:00:00&nbsp;2019</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1838238/988268/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/988268">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 245b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Pá 15.bře.2019 07:56:36, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This I believe this a mismatch on the plugin.get_metadata prototype
&gt; and plugin_get_metadata&#40;&#41; function provided by grpc-xs in util.c as
&gt; warned by the compiler.
</div>
An attached patch fixes it.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> grpc-xs-0.20-Adapt-to-plugin-credentials-API-change-in-gRPC.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1838238/988269/grpc-xs-0.20-Adapt-to-plugin-credentials-API-change-in-gRPC.patch">Download grpc-xs-0.20-Adapt-to-plugin-credentials-API-change-in-gRPC.patch</a><br />
<span class="downloadcontenttype">text/x-diff 3.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 5a4288439361bc617b453435b048d9ea8d2b51a1 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Fri, 15 Mar 2019 13:29:49 +0100
Subject: [PATCH] Adapt to plugin credentials API change in gRPC
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

gRPC changed grpc_metadata_credentials_plugin.get_metadata callback
protype in 1.7.0 version with:

    commit 2caf021772ee241da3366e7dfd32aa4ee1134092
    Author: Mark D. Roth &lt;roth@google.com&gt;
    Date:   Fri Sep 1 15:04:13 2017 -0700

	Change plugin credentials API to support both sync and async modes.

That caused a mismatch between gRPC and grpc-xs and that triggered
crashes in t/01-call_credentials.t test on ppc64le, s390x, and armv7hl
platforms.

This patch fixes it.

CPAN RT#128840

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 Makefile.PL |  8 ++++++++
 util.c      | 12 ++++++++++++
 util.h      |  9 +++++++++
 3 files changed, 29 insertions&#40;+&#41;

diff --git a/Makefile.PL b/Makefile.PL
index 76a50d1..fb0ba82 100644
--- a/Makefile.PL
+++ b/Makefile.PL
@@ -62,6 +62,14 @@ exit&#40;0&#41;;
 EOT
 &#41; and &#40;$EXTRA_DEFINES .= &#34; -DGRPC_VERSION_1_4&#34;&#41;;
 
+check_lib&#40;
+    %CHECKLIB_ARGS,
+    header      =&gt; &#39;grpc/grpc_security.h&#39;,
+    function    =&gt; &lt;&lt;&#39;EOT&#39;,
+return !GRPC_METADATA_CREDENTIALS_PLUGIN_SYNC_MAX;
+EOT
+&#41; and &#40;$EXTRA_DEFINES .= &#34; -DGRPC_VERSION_1_7&#34;&#41;;
+
 check_lib&#40;
     %CHECKLIB_ARGS,
     function    =&gt; &lt;&lt;&#39;EOT&#39;,
diff --git a/util.c b/util.c
index 3127a69..498632c 100644
--- a/util.c
+++ b/util.c
@@ -235,9 +235,18 @@ bool create_metadata_array&#40;HV *hash, grpc_metadata_array *metadata&#41; {
 }
 
 /* Callback function for plugin creds API */
+#if defined&#40;GRPC_VERSION_1_7&#41;
+int plugin_get_metadata&#40;void *ptr, grpc_auth_metadata_context context,
+                        grpc_credentials_plugin_metadata_cb cb,
+                        void *user_data,
+                        grpc_metadata creds_md[GRPC_METADATA_CREDENTIALS_PLUGIN_SYNC_MAX],
+                        size_t *num_creds_md, grpc_status_code *status,
+                        const char **error_details&#41; {
+#else
 void plugin_get_metadata&#40;void *ptr, grpc_auth_metadata_context context,
                          grpc_credentials_plugin_metadata_cb cb,
                          void *user_data&#41; {
+#endif
   SV* callback = &#40;SV*&#41;ptr;
 
   dSP;
@@ -274,6 +283,9 @@ void plugin_get_metadata&#40;void *ptr, grpc_auth_metadata_context context,
 
   /* Pass control back to core */
   cb&#40;user_data, metadata.metadata, metadata.count, code, NULL&#41;;
+#if defined&#40;GRPC_VERSION_1_7&#41;
+  return 0;
+#endif
 }
 
 /* Cleanup function for plugin creds API */
diff --git a/util.h b/util.h
index 8955435..9037536 100644
--- a/util.h
+++ b/util.h
@@ -30,9 +30,18 @@ void perl_grpc_read_args_array&#40;HV *hash, grpc_channel_args *args&#41;;
 HV* grpc_parse_metadata_array&#40;grpc_metadata_array *metadata_array&#41;;
 bool create_metadata_array&#40;HV *hash, grpc_metadata_array *metadata&#41;;
 
+#if defined&#40;GRPC_VERSION_1_7&#41;
+int plugin_get_metadata&#40;void *ptr, grpc_auth_metadata_context context,
+                        grpc_credentials_plugin_metadata_cb cb,
+                        void *user_data,
+                        grpc_metadata creds_md[GRPC_METADATA_CREDENTIALS_PLUGIN_SYNC_MAX],
+                        size_t *num_creds_md, grpc_status_code *status,
+                        const char **error_details&#41;;
+#else
 void plugin_get_metadata&#40;void *ptr, grpc_auth_metadata_context context,
                          grpc_credentials_plugin_metadata_cb cb,
                          void *user_data&#41;;
+#endif
 
 void plugin_destroy_state&#40;void *ptr&#41;;
 
-- 
2.20.1

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1838318" href="/Public/Bug/Display.html?id=128840#txn-1838318">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;15&nbsp;18:10:26&nbsp;2019</span>
    <span class="description">joyrex2001 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #128840] t/01-call_credentials.t crashes with &#34;double free or corruption &#40;fasttop&#41;&#34; on ppc64le, s390x, and armv7hl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 15 Mar 2019 23:04:07 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Petr Pisar via RT &lt;bug-grpc-xs [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Vincent van Dam &lt;joyrex2001 [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1838318/988314/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/988314">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the fix! The fix has been added to 0.30.
Gr., Vincent

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 15 Mar 2019, at 15:00, Petr Pisar via RT &lt;bug-grpc-xs@rt.cpan.org&gt; wrote:
&gt; 
&gt;       Queue: grpc-xs
&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=128840">https://rt.cpan.org/Ticket/Display.html?id=128840</a></span> &gt;
&gt; 
&gt; Dne Pá 15.bře.2019 07:56:36, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt;&gt; This I believe this a mismatch on the plugin.get_metadata prototype
&gt;&gt; and plugin_get_metadata&#40;&#41; function provided by grpc-xs in util.c as
&gt;&gt; warned by the compiler.
</div>&gt; 
&gt; An attached patch fixes it.
&gt; 
&gt; 
&gt; From 5a4288439361bc617b453435b048d9ea8d2b51a1 Mon Sep 17 00:00:00 2001
&gt; From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
&gt; Date: Fri, 15 Mar 2019 13:29:49 +0100
&gt; Subject: [PATCH] Adapt to plugin credentials API change in gRPC
&gt; MIME-Version: 1.0
&gt; Content-Type: text/plain; charset=UTF-8
&gt; Content-Transfer-Encoding: 8bit
&gt; 
&gt; gRPC changed grpc_metadata_credentials_plugin.get_metadata callback
&gt; protype in 1.7.0 version with:
&gt; 
&gt;    commit 2caf021772ee241da3366e7dfd32aa4ee1134092
&gt;    Author: Mark D. Roth &lt;roth@google.com&gt;
&gt;    Date:   Fri Sep 1 15:04:13 2017 -0700
&gt; 
&gt;       Change plugin credentials API to support both sync and async modes.
&gt; 
&gt; That caused a mismatch between gRPC and grpc-xs and that triggered
&gt; crashes in t/01-call_credentials.t test on ppc64le, s390x, and armv7hl
&gt; platforms.
&gt; 
&gt; This patch fixes it.
&gt; 
&gt; CPAN RT#128840
&gt; 
&gt; Signed-off-by: Petr Písař &lt;ppisar@redhat.com&gt;
&gt; ---
&gt; Makefile.PL |  8 ++++++++
&gt; util.c      | 12 ++++++++++++
&gt; util.h      |  9 +++++++++
&gt; 3 files changed, 29 insertions&#40;+&#41;
&gt; 
&gt; diff --git a/Makefile.PL b/Makefile.PL
&gt; index 76a50d1..fb0ba82 100644
&gt; --- a/Makefile.PL
&gt; +++ b/Makefile.PL
&gt; @@ -62,6 +62,14 @@ exit&#40;0&#41;;
&gt; EOT
&gt; &#41; and &#40;$EXTRA_DEFINES .= &#34; -DGRPC_VERSION_1_4&#34;&#41;;
&gt; 
&gt; +check_lib&#40;
&gt; +    %CHECKLIB_ARGS,
&gt; +    header      =&gt; &#39;grpc/grpc_security.h&#39;,
&gt; +    function    =&gt; &lt;&lt;&#39;EOT&#39;,
&gt; +return !GRPC_METADATA_CREDENTIALS_PLUGIN_SYNC_MAX;
&gt; +EOT
&gt; +&#41; and &#40;$EXTRA_DEFINES .= &#34; -DGRPC_VERSION_1_7&#34;&#41;;
&gt; +
&gt; check_lib&#40;
&gt;     %CHECKLIB_ARGS,
&gt;     function    =&gt; &lt;&lt;&#39;EOT&#39;,
&gt; diff --git a/util.c b/util.c
&gt; index 3127a69..498632c 100644
&gt; --- a/util.c
&gt; +++ b/util.c
&gt; @@ -235,9 +235,18 @@ bool create_metadata_array&#40;HV *hash, grpc_metadata_array *metadata&#41; {
&gt; }
&gt; 
&gt; /* Callback function for plugin creds API */
&gt; +#if defined&#40;GRPC_VERSION_1_7&#41;
&gt; +int plugin_get_metadata&#40;void *ptr, grpc_auth_metadata_context context,
&gt; +                        grpc_credentials_plugin_metadata_cb cb,
&gt; +                        void *user_data,
&gt; +                        grpc_metadata creds_md[GRPC_METADATA_CREDENTIALS_PLUGIN_SYNC_MAX],
&gt; +                        size_t *num_creds_md, grpc_status_code *status,
&gt; +                        const char **error_details&#41; {
&gt; +#else
&gt; void plugin_get_metadata&#40;void *ptr, grpc_auth_metadata_context context,
&gt;                          grpc_credentials_plugin_metadata_cb cb,
&gt;                          void *user_data&#41; {
&gt; +#endif
&gt;   SV* callback = &#40;SV*&#41;ptr;
&gt; 
&gt;   dSP;
&gt; @@ -274,6 +283,9 @@ void plugin_get_metadata&#40;void *ptr, grpc_auth_metadata_context context,
&gt; 
&gt;   /* Pass control back to core */
&gt;   cb&#40;user_data, metadata.metadata, metadata.count, code, NULL&#41;;
&gt; +#if defined&#40;GRPC_VERSION_1_7&#41;
&gt; +  return 0;
&gt; +#endif
&gt; }
&gt; 
&gt; /* Cleanup function for plugin creds API */
&gt; diff --git a/util.h b/util.h
&gt; index 8955435..9037536 100644
&gt; --- a/util.h
&gt; +++ b/util.h
&gt; @@ -30,9 +30,18 @@ void perl_grpc_read_args_array&#40;HV *hash, grpc_channel_args *args&#41;;
&gt; HV* grpc_parse_metadata_array&#40;grpc_metadata_array *metadata_array&#41;;
&gt; bool create_metadata_array&#40;HV *hash, grpc_metadata_array *metadata&#41;;
&gt; 
&gt; +#if defined&#40;GRPC_VERSION_1_7&#41;
&gt; +int plugin_get_metadata&#40;void *ptr, grpc_auth_metadata_context context,
&gt; +                        grpc_credentials_plugin_metadata_cb cb,
&gt; +                        void *user_data,
&gt; +                        grpc_metadata creds_md[GRPC_METADATA_CREDENTIALS_PLUGIN_SYNC_MAX],
&gt; +                        size_t *num_creds_md, grpc_status_code *status,
&gt; +                        const char **error_details&#41;;
&gt; +#else
&gt; void plugin_get_metadata&#40;void *ptr, grpc_auth_metadata_context context,
&gt;                          grpc_credentials_plugin_metadata_cb cb,
&gt;                          void *user_data&#41;;
&gt; +#endif
&gt; 
&gt; void plugin_destroy_state&#40;void *ptr&#41;;
&gt; 
&gt; -- 
&gt; 2.20.1
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1838319" href="/Public/Bug/Display.html?id=128840#txn-1838319">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;15&nbsp;18:10:26&nbsp;2019</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.350541</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
