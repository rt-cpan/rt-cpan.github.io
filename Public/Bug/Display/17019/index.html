<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #4170 for Net-Ping: Net::Ping not multi-threadable</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #4170 for Net-Ping: Net::Ping not multi-threadable</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Net-Ping">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Net-Ping">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Net-Ping">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Net-Ping">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-Ping">Net-Ping CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">4170</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Net-Ping">Net-Ping</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
alexander.hartmaier [...] t-systems.at

<br />
bshreffler [...] dot.state.ny.us

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-23010-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.31    </td>
  </tr>
  <tr id="CF-23011-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




p<br />
<ul>


</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=4170">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-89983" href="/Public/Bug/Display.html?id=4170#txn-89983">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;20&nbsp;10:18:08&nbsp;2003</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net::Ping not multi-threadable</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/89983/12923/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/12923">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 428b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">module: Net::Ping 2.31
perl: perl 5.8.0 &#40;version included in redhat 8.0&#41;
os: Redhat 8.0

I need to ping multiple hosts &#40;at the moment ~470&#41; in a 1 minute interval.
To realize this i create 4 threads &#40;maybe more in the future&#41; and use Net::Ping to ping them &#40;as user root with icmp&#41;.

Most of the time the hosts are reported to be reachable although they aren&#39;t!
If I change the number of threads to 1 it works the way it should.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-89984" href="/Public/Bug/Display.html?id=4170#txn-89984">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;24&nbsp;16:35:10&nbsp;2003</span>
    <span class="description">bbb [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 24 Oct 2003 14:34:35 -0600 &#40;MDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Rob Brown &lt;bbb [...] cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Guest via RT &lt;bug-Net-Ping [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Rob Brown &lt;bbb [...] cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #4170] Net::Ping not multi-threadable </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/89984/13024/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/13024">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Why didn&#39;t you use the &#34;syn&#34; proto instead of
&#34;icmp&#34;?  It can do hundreds of remote hosts
simultanously by first sending out the SYN
packets.  Then it waits for the ACK packets.
One working demonstration using this is here:

<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~bbb/Net-Ping-2.31/demo/fping">http://search.cpan.org/~bbb/Net-Ping-2.31/demo/fping</a></span>

Unfortunately, it uses TCP protocol instead
of ICMP at the network layer.  If your routers
do not permit TCP or if this is too much
bandwidth, then this maybe not be appropriate
for you.  The nice thing is that you do not
need to be root to use tNet::Ping&#39;s &#34;syn&#34;
protocol.

Plus, I&#39;m not exactly clear what you mean by
changing from 1 to 4 threads and how that
affects the execution.

-- Rob

On Mon, 20 Oct 2003, Guest via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This message about Net-Ping was sent to you by guest &lt;&gt; via rt.cpan.org
&gt; 
&gt; Full context and any attached attachments can be found at:
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=4170">https://rt.cpan.org/Ticket/Display.html?id=4170</a></span> &gt;
&gt; 
&gt; module: Net::Ping 2.31
&gt; perl: perl 5.8.0 &#40;version included in redhat 8.0&#41;
&gt; os: Redhat 8.0
&gt; 
&gt; I need to ping multiple hosts &#40;at the moment ~470&#41; in a 1 minute interval.
&gt; To realize this i create 4 threads &#40;maybe more in the future&#41; and use Net::Ping to ping them &#40;as user root with icmp&#41;.
&gt; 
&gt; Most of the time the hosts are reported to be reachable although they aren&#39;t!
&gt; If I change the number of threads to 1 it works the way it should.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-89985" href="/Public/Bug/Display.html?id=4170#txn-89985">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;28&nbsp;04:37:44&nbsp;2003</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> alexander.hartmaier [...] t-systems.at</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/89985/13087/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/13087">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 751b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">@TCP SYN: If I use tcp syn packets the state tables of our firewalls 
are filled with new session entries which have a timeout of 2 hours. 
If I ping every minute that would result in 120 sessions PER HOST!!!
Additionally not every device I have to monitor has an open tcp port.

@ICMP: Why isn&#39;t an asyncronous way like it&#39;s with tcp syn/ack 
implemented for icmp too?

@THREADS: I create multiple threads. Every thread reads of a 
Thread::Queue the hostnames which should be pinged and writes the 
reply into a thread-shared hash.
If the thread count is one then the perl programm works the way it 
should. But if I increase the number of threads i always get reachable 
from the Net::Ping module regardless if the host is really responding 
or not.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-89986" href="/Public/Bug/Display.html?id=4170#txn-89986">#</a>      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;07&nbsp;12:18:09&nbsp;2003</span>
    <span class="description">bbb [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 7 Nov 2003 10:17:34 -0700 &#40;MST&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Rob Brown &lt;bbb [...] cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Guest via RT &lt;bug-Net-Ping [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #4170] Net::Ping not multi-threadable </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/89986/13410/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/13410">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, 28 Oct 2003, Guest via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; @TCP SYN: If I use tcp syn packets the state tables of our firewalls 
&gt; are filled with new session entries which have a timeout of 2 hours. 
&gt; If I ping every minute that would result in 120 sessions PER HOST!!!
&gt; Additionally not every device I have to monitor has an open tcp port.
</div>
Then use a port that is NOT listening on the remote target
host &#40;like 1&#41; in order to avoid filling up the firewall
with session timeouts in the NAT tables.  There has got to
be a common port on all your remote devices that does NOT
accept connections.  Your goal is to try to get that
&#34;Connection refused&#34; packet from each device.  i.e.:

$ telnet 10.0.0.47 1
Trying 10.0.0.47...
telnet: connect to address 10.0.0.47: Connection refused
$

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; @ICMP: Why isn&#39;t an asyncronous way like it&#39;s with tcp syn/ack 
&gt; implemented for icmp too?
</div>
ICMP is terrible because it require root access to create
the raw ICMP packets.  If you really do have root access,
then you can just use fping:

<span class="clickylink"><a target="new" rel="nofollow" href="http://www.fping.com/">http://www.fping.com/</a></span>

It does all that simultaneous multiplexing you want and
even uses ICMP protocol.

fping 10.0.0.2 10.0.0.3 10.0.0.47

Here is my favorite one because it installs suid fping
so even if you don&#39;t have root, you can still use it:

rpm -Uvh ftp://rpmfind.net/linux/Mandrake/9.2/contrib/i586/fping-2.4b2-5mdk.i586.rpm

But the biggest reason is because I am too unmotivated
and lazy to code up the ICMP multiplexer since I have
no use for that.  I&#39;m happy to accept your patches
though.  :-D

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; @THREADS: I create multiple threads. Every thread reads of a 
&gt; Thread::Queue the hostnames which should be pinged and writes the 
&gt; reply into a thread-shared hash.
&gt; If the thread count is one then the perl programm works the way it 
&gt; should. But if I increase the number of threads i always get reachable 
&gt; from the Net::Ping module regardless if the host is really responding 
&gt; or not.
</div>
I don&#39;t know what you mean by &#34;threads&#34; and I&#39;ve never
used Thread::Queue before, but that thread-shared hash
sounds dangerous to me.  I&#39;ve used IPC::ShareLite before
though.  Sorry for my ignorance.  Can you send me some
sample code that exploits the bugs?


-- Rob
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-89987" href="/Public/Bug/Display.html?id=4170#txn-89987">#</a>      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;03&nbsp;12:56:31&nbsp;2003</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> steinar [...] skjelanger.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/89987/14106/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/14106">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">[BBB - Fri Nov  7 12:18:09 2003]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Can you send me some sample code that exploits the bugs?
</div>
Hi!

This example demonstrates the problems with Net::Ping and
threads. A brief description of the code:

1. Create a Thread::Queue &#40;$pingQueue&#41;
2. Start two threads that blocks, waiting for ip addresses
   to appear in the $pingQueue. When an address is put on
   the queue, one of the threads uses Net::Ping to
   ping this address and print a success/failure message.
   When it&#39;s finished it blocks again, waiting for a new
   address.
3. Start a scheduler thread that puts four different ip
   addresses in the queue with $sleepTime seconds delay
   between them.

-----------------------------------------------------------
#!perl -w

use threads;
use Thread::Queue;
use Net::Ping;

my $pingQueue = Thread::Queue-&gt;new;
my $sleepTime = 5;

# Start ping threads
threads-&gt;new&#40;\&#38;pingThread&#41;;             # ping thread #1
threads-&gt;new&#40;\&#38;pingThread&#41;;             # ping thread #2

# Start scheduler thread
threads-&gt;new&#40;\&#38;pingScheduler&#41;;

# Idle main thread forever
while&#40;1&#41; {}

sub pingThread&#40;&#41; {
   my $thread_id = threads-&gt;tid&#40;&#41;;

   while &#40;$ip_address = $pingQueue-&gt;dequeue&#41; {
      $p = Net::Ping-&gt;new&#40;&#34;icmp&#34;&#41;;
      if &#40;&#40;$p-&gt;ping&#40;$ip_address&#41;&#41;&#41; {
         print &#34;&#40;$thread_id&#41; Ping test OK    : $ip_address\n&#34;;
      } else {
         print &#34;&#40;$thread_id&#41; Ping test FAILED: $ip_address\n&#34;;
      }
      undef&#40;$p&#41;;
      sleep&#40;1&#41;;
   }
}

sub pingScheduler&#40;&#41; {
   while&#40;1&#41; {
      $pingQueue-&gt;enqueue&#40;&#34;192.168.0.201&#34;&#41;;
      sleep&#40;$sleepTime&#41;;
      $pingQueue-&gt;enqueue&#40;&#34;192.168.0.202&#34;&#41;;     # should timeout
      sleep&#40;$sleepTime&#41;;
      $pingQueue-&gt;enqueue&#40;&#34;127.0.0.1&#34;&#41;;
      sleep&#40;$sleepTime&#41;;
      $pingQueue-&gt;enqueue&#40;&#34;192.168.0.203&#34;&#41;;     # should timeout
      sleep&#40;$sleepTime&#41;;
   }
}
-----------------------------------------------------------

On the computer I ran the tests below, the
1st and 3rd address were expected to return a reply, while
the 2nd and 4th should timeout because they don&#39;t exist on
this network. The numbers on the beginning of the lines are
the IDs of the thread performing the ping.

When $sleepTime is large enough &#40;e.g. 15&#41;, each ping is
guaranteed to have finished before the next one is started,
and the results are as expected:

D:\perlsrc&gt;perl pingfail.pl
&#40;1&#41; Ping test OK    : 192.168.0.201
&#40;2&#41; Ping test FAILED: 192.168.0.202
&#40;2&#41; Ping test OK    : 127.0.0.1
&#40;2&#41; Ping test FAILED: 192.168.0.203
&#40;1&#41; Ping test OK    : 192.168.0.201
&#40;2&#41; Ping test FAILED: 192.168.0.202
&#40;1&#41; Ping test OK    : 127.0.0.1
&#40;2&#41; Ping test FAILED: 192.168.0.203
&#40;1&#41; Ping test OK    : 192.168.0.201
Terminating on signal SIGINT&#40;2&#41;

With a $sleepTime of e.g. 5, things start to mess up:

D:\perlsrc&gt;perl pingfail.pl
&#40;1&#41; Ping test OK    : 192.168.0.201
&#40;1&#41; Ping test OK    : 127.0.0.1
&#40;2&#41; Ping test OK    : 192.168.0.202
&#40;2&#41; Ping test OK    : 192.168.0.201
&#40;1&#41; Ping test OK    : 192.168.0.203
&#40;1&#41; Ping test OK    : 127.0.0.1
&#40;2&#41; Ping test OK    : 192.168.0.202
&#40;2&#41; Ping test OK    : 192.168.0.201
&#40;1&#41; Ping test OK    : 192.168.0.203
&#40;1&#41; Ping test OK    : 127.0.0.1
&#40;2&#41; Ping test OK    : 192.168.0.202
Terminating on signal SIGINT&#40;2&#41;

As far as I can see &#40;from tracing the Ping.pm&#41;, this
is what happens:

1. First ping of .0.201 is finished OK before the
   second ping is started.
2. The second ping &#40;of .0.202&#41; starts and waits for a
   timeout.
3. The third ping &#40;of 127.0.0.1&#41; is started, receives
   an immediate reply which is accepted as a valid
   response to the packet sent. The result is printed.
4. The thread of the second ping also sees the packet
   from 127.0.0.1, and also accepts it as a valid
   response to _it&#39;s_ packet &#40;which it&#39;s clearly not&#41;.

The wait for a timeout for .0.203 is interrupted in
the same way when the next reply for .0.201 arrives.

I would also like to see this module thread safe, but
I&#39;m not sure what&#39;s the best way to do it. Using an
external program ping&#40;1&#41; or fping creates a lot of
overhead because of all the extra processes that will
be created and destroyed just to send a tiny packet?

Regards,

Steinar Skjelanger
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-89988" href="/Public/Bug/Display.html?id=4170#txn-89988">#</a>      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;04&nbsp;07:38:27&nbsp;2003</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> alexander.hartmaier [...] t-systems.at</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/89988/14136/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/14136">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 387b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fantastic Steinar!

That&#39;s exactly what seems to be the problem!

Because of this bug i now use python with my own implementation of async 
ping.
It uses an array where all sequence number of sent packets are stored 
and dropped when an answer is received.
I think the bug is in the receive code which should check the source ip, 
sequence number, id and checksum of the received packet.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-89989" href="/Public/Bug/Display.html?id=4170#txn-89989">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;24&nbsp;14:29:28&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Roy Evans</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/89989/20196/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/20196">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 713b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have also hit this problem.  

Start off a bunch of threads , then do a ping in each thread &#38; loop 
within each thread.  This is on an old Solaris machine , 5.7 or so.

in Ping.pm , I notice line 454

$nfound = mselect&#40;&#40;my $rout=$rbits&#41;, undef, undef, $timeout&#41;; # Wait 
for packet

- Which doesn&#39;t do what it says on the box, it doesn&#39;t wait 

and if I add a print onto the end of line 468 
 
&#40;$from_port, $from_ip&#41; = sockaddr_in&#40;$from_saddr&#41;; print &#34;Recv&#34;,$self-&gt;
{&#34;fh&#34;},&#38;time&#40;&#41;,&#38;inet_ntoa&#40;$ip&#41;,&#38;inet_ntoa&#40;$from_ip&#41;;

I get results like :

Recv    FileHandle=GLOB&#40;0x3afa930&#41;      1088099619.891  
10.191.253.33    10.182.253.50

ie, the read from the socket is picking up a ping response from another 
thread.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-89990" href="/Public/Bug/Display.html?id=4170#txn-89990">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;24&nbsp;15:26:58&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Roy Evans</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/89990/20201/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/20201">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 713b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have also hit this problem.  

Start off a bunch of threads , then do a ping in each thread &#38; loop 
within each thread.  This is on an old Solaris machine , 5.7 or so.

in Ping.pm , I notice line 454

$nfound = mselect&#40;&#40;my $rout=$rbits&#41;, undef, undef, $timeout&#41;; # Wait 
for packet

- Which doesn&#39;t do what it says on the box, it doesn&#39;t wait 

and if I add a print onto the end of line 468 
 
&#40;$from_port, $from_ip&#41; = sockaddr_in&#40;$from_saddr&#41;; print &#34;Recv&#34;,$self-&gt;
{&#34;fh&#34;},&#38;time&#40;&#41;,&#38;inet_ntoa&#40;$ip&#41;,&#38;inet_ntoa&#40;$from_ip&#41;;

I get results like :

Recv    FileHandle=GLOB&#40;0x3afa930&#41;      1088099619.891  
10.191.253.33    10.182.253.50

ie, the read from the socket is picking up a ping response from another 
thread.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-89991" href="/Public/Bug/Display.html?id=4170#txn-89991">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;04&nbsp;13:38:44&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> stephen a polinsky dt org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/89991/32065/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/32065">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Thu Jun 24 15:26:58 2004]:

I&#39;ve been working on fixing this in my own code for some time, and I
think I&#39;ve finally figured out what the problem is &#40;this applies to
using fork&#40;&#41; too&#41;.  What tipped me off is, even when creating ping
packets with fork&#40;&#41; and Net::Ping, all packet had the same IDENT field
in the ICMP header.

If you look at line 146, you&#39;ll see where the value for the
identification field that goes in the ICMP header is generated.  It&#39;s
based on the process ID of the calling process. 
 
   $self-&gt;{&#34;pid&#34;} = $$ &#38; 0xffff;      # Save lower 16 bits of pid

The identification field and the sequence number are used to associate
echo replies with requests.  Here&#39;s where it&#39;s done in line 479:

   if &#40;&#40;$from_pid == $self-&gt;{&#34;pid&#34;}&#41; &#38;&#38; .... 
      &#40;$from_seq == $self-&gt;{&#34;seq&#34;}&#41;&#41; {

So if all the identification fields in the echo requests are the same,
there&#39;s really no way to associate each echo response with the proper
request &#40;strangely, source IP is not used&#41;.  So we see inconsistent
reporting of results.

It finally occurred to me that since I was creating my instance of the
ping class in my main program &#40;not in the thread or child process&#41;, the
identification field would be the same for all packets.

So somewhere, you&#39;ve got a line like:

   $ping = Net::Ping-&gt;new&#40;&#39;icmp&#39;, 3&#41;;

Move this into the thread or forked child, and a different
identification field should be generated for each outbound echo request
packet.  This should solve the problem.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-89992" href="/Public/Bug/Display.html?id=4170#txn-89992">#</a>      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;31&nbsp;15:49:12&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jjk [...] skism.org</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/89992/46941/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/46941">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Fri Mar  4 13:38:44 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [guest - Thu Jun 24 15:26:58 2004]:
&gt; 
&gt; I&#39;ve been working on fixing this in my own code for some time, and I
&gt; think I&#39;ve finally figured out what the problem is &#40;this applies to
&gt; using fork&#40;&#41; too&#41;.  What tipped me off is, even when creating ping
&gt; packets with fork&#40;&#41; and Net::Ping, all packet had the same IDENT field
&gt; in the ICMP header.
&gt; 
&gt; If you look at line 146, you&#39;ll see where the value for the
&gt; identification field that goes in the ICMP header is generated.  It&#39;s
&gt; based on the process ID of the calling process. 
&gt;  
&gt;    $self-&gt;{&#34;pid&#34;} = $$ &#38; 0xffff;      # Save lower 16 bits of pid
&gt; 
&gt; The identification field and the sequence number are used to associate
&gt; echo replies with requests.  Here&#39;s where it&#39;s done in line 479:
&gt; 
&gt;    if &#40;&#40;$from_pid == $self-&gt;{&#34;pid&#34;}&#41; &#38;&#38; .... 
&gt;       &#40;$from_seq == $self-&gt;{&#34;seq&#34;}&#41;&#41; {
&gt; 
&gt; So if all the identification fields in the echo requests are the same,
&gt; there&#39;s really no way to associate each echo response with the proper
&gt; request &#40;strangely, source IP is not used&#41;.  So we see inconsistent
&gt; reporting of results.
&gt; 
&gt; It finally occurred to me that since I was creating my instance of the
&gt; ping class in my main program &#40;not in the thread or child process&#41;, the
&gt; identification field would be the same for all packets.
&gt; 
&gt; So somewhere, you&#39;ve got a line like:
&gt; 
&gt;    $ping = Net::Ping-&gt;new&#40;&#39;icmp&#39;, 3&#41;;
&gt; 
&gt; Move this into the thread or forked child, and a different
&gt; identification field should be generated for each outbound echo request
&gt; packet.  This should solve the problem.
</div>
Creating new class instances will not work with ithreads.  This hack
prepends the current thread id &#40;or 0 if not threaded&#41; to the process id
if the protocol is ICMP.  This patch will not work with perl 5.005 threads.


-Jeremy
</div></div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-89993" href="/Public/Bug/Display.html?id=4170#txn-89993">#</a>      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;31&nbsp;15:49:37&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jjk [...] skism.org</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/89993/46944/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/46944">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Fri Mar  4 13:38:44 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [guest - Thu Jun 24 15:26:58 2004]:
&gt; 
&gt; I&#39;ve been working on fixing this in my own code for some time, and I
&gt; think I&#39;ve finally figured out what the problem is &#40;this applies to
&gt; using fork&#40;&#41; too&#41;.  What tipped me off is, even when creating ping
&gt; packets with fork&#40;&#41; and Net::Ping, all packet had the same IDENT field
&gt; in the ICMP header.
&gt; 
&gt; If you look at line 146, you&#39;ll see where the value for the
&gt; identification field that goes in the ICMP header is generated.  It&#39;s
&gt; based on the process ID of the calling process. 
&gt;  
&gt;    $self-&gt;{&#34;pid&#34;} = $$ &#38; 0xffff;      # Save lower 16 bits of pid
&gt; 
&gt; The identification field and the sequence number are used to associate
&gt; echo replies with requests.  Here&#39;s where it&#39;s done in line 479:
&gt; 
&gt;    if &#40;&#40;$from_pid == $self-&gt;{&#34;pid&#34;}&#41; &#38;&#38; .... 
&gt;       &#40;$from_seq == $self-&gt;{&#34;seq&#34;}&#41;&#41; {
&gt; 
&gt; So if all the identification fields in the echo requests are the same,
&gt; there&#39;s really no way to associate each echo response with the proper
&gt; request &#40;strangely, source IP is not used&#41;.  So we see inconsistent
&gt; reporting of results.
&gt; 
&gt; It finally occurred to me that since I was creating my instance of the
&gt; ping class in my main program &#40;not in the thread or child process&#41;, the
&gt; identification field would be the same for all packets.
&gt; 
&gt; So somewhere, you&#39;ve got a line like:
&gt; 
&gt;    $ping = Net::Ping-&gt;new&#40;&#39;icmp&#39;, 3&#41;;
&gt; 
&gt; Move this into the thread or forked child, and a different
&gt; identification field should be generated for each outbound echo request
&gt; packet.  This should solve the problem.
</div>
Creating new class instances will not work with ithreads.  This hack
prepends the current thread id &#40;or 0 if not threaded&#41; to the process id
if the protocol is ICMP.  This patch will not work with perl 5.005 threads.


-Jeremy
</div></div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-89994" href="/Public/Bug/Display.html?id=4170#txn-89994">#</a>      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;31&nbsp;15:51:12&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jjk [...] skism.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/89994/46946/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/46946">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 821b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ooops!

Here is the patch

---cut---
--- /usr/share/perl/5.8.7/Net/Ping.pm.orig      2003-06-27
17:31:07.000000000 -0400
+++ /usr/share/perl/5.8.7/Net/Ping.pm   2005-12-31 10:46:37.000000000 -0500
@@ -143,7 +143,9 @@
     croak&#40;&#34;icmp ping requires root privilege&#34;&#41; if &#40;$&gt; and $^O ne &#39;VMS&#39;
and $^O ne &#39;cygwin&#39;&#41;;
     $self-&gt;{&#34;proto_num&#34;} = &#40;getprotobyname&#40;&#39;icmp&#39;&#41;&#41;[2] ||
       croak&#40;&#34;Can&#39;t get icmp protocol by name&#34;&#41;;
-    $self-&gt;{&#34;pid&#34;} = $$ &#38; 0xffff;           # Save lower 16 bits of pid
+    $self-&gt;{&#39;pid&#39;} = &#40; exists $::{&#39;threads::&#39;} &#38;&#38; threads-&gt;self-&gt;tid &#41;
? threads-&gt;self-&gt;tid : 0; # are we are threaded?
+    $self-&gt;{&#39;pid&#39;} = $self-&gt;{&#39;pid&#39;} &#38; 0xffff;
     $self-&gt;{&#34;fh&#34;} = FileHandle-&gt;new&#40;&#41;;
     socket&#40;$self-&gt;{&#34;fh&#34;}, PF_INET, SOCK_RAW, $self-&gt;{&#34;proto_num&#34;}&#41; ||
       croak&#40;&#34;icmp socket error - $!&#34;&#41;;

---cut---
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-154214" href="/Public/Bug/Display.html?id=4170#txn-154214">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;11&nbsp;10:50:48&nbsp;2006</span>
    <span class="description">Guest - Ticket #17019:  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> net::ping fails when used in conjunction with threads</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/154214/47402/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/47402">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 6.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">net::ping does not work properly when run in multiple threads when a large number of nodes that it tries to ping are unreachable.

In our network we have several thousand nodes of which about half are laptops and are typically not present on the network.

In my testing, the attached script works perfectly if all nodes are present or only a very small percentage are unreachable.  If however the list has a large number of unreachable nodes &#40;I gave it 100 unreachable nodes right at the start of the list&#41; then many reachable nodes are reported as unreachable.  In my test it reported approximately 60 &#40;reachable&#41; nodes as unreachable before it recovered.  

In larger tests with thousands of nodes, of which approximately half are unreachable, the program will report that only at 10-20% of the reachable node are actually reachable.   

C:\MSU&gt;perl -V
Summary of my perl5 &#40;revision 5 version 8 subversion 7&#41; configuration:
  Platform:
    osname=MSWin32, osvers=5.0, archname=MSWin32-x86-multi-thread
    uname=&#39;&#39;
    config_args=&#39;undef&#39;
    hint=recommended, useposix=true, d_sigaction=undef
    usethreads=define use5005threads=undef useithreads=define usemultiplicity=define
    useperlio=define d_sfio=undef uselargefiles=define usesocks=undef
    use64bitint=undef use64bitall=undef uselongdouble=undef
    usemymalloc=n, bincompat5005=undef
  Compiler:
    cc=&#39;cl&#39;, ccflags =&#39;-nologo -Gf -W3 -MD -Zi -DNDEBUG -O1 -DWIN32 -D_CONSOLE -DNO_STRICT -DHAVE_DE
S_FCRYPT -DNO_HASH_SEED -DUSE_SITECUSTOMIZE -DPERL_IMPLICIT_CONTEXT -DPERL_IMPLICIT_SYS -DUSE_PERLIO
 -DPERL_MSVCRT_READFIX&#39;,
    optimize=&#39;-MD -Zi -DNDEBUG -O1&#39;,
    cppflags=&#39;-DWIN32&#39;
    ccversion=&#39;12.00.8804&#39;, gccversion=&#39;&#39;, gccosandvers=&#39;&#39;
    intsize=4, longsize=4, ptrsize=4, doublesize=8, byteorder=1234
    d_longlong=undef, longlongsize=8, d_longdbl=define, longdblsize=10
    ivtype=&#39;long&#39;, ivsize=4, nvtype=&#39;double&#39;, nvsize=8, Off_t=&#39;__int64&#39;, lseeksize=8
    alignbytes=8, prototype=define
  Linker and Libraries:
    ld=&#39;link&#39;, ldflags =&#39;-nologo -nodefaultlib -debug -opt:ref,icf  -libpath:&#34;C:\Perl\lib\CORE&#34;  -ma
chine:x86&#39;
    libpth=\lib
    libs=  oldnames.lib kernel32.lib user32.lib gdi32.lib winspool.lib  comdlg32.lib advapi32.lib sh
ell32.lib ole32.lib oleaut32.lib  netapi32.lib uuid.lib ws2_32.lib mpr.lib winmm.lib  version.lib od
bc32.lib odbccp32.lib msvcrt.lib
    perllibs=  oldnames.lib kernel32.lib user32.lib gdi32.lib winspool.lib  comdlg32.lib advapi32.li
b shell32.lib ole32.lib oleaut32.lib  netapi32.lib uuid.lib ws2_32.lib mpr.lib winmm.lib  version.li
b odbc32.lib odbccp32.lib msvcrt.lib
    libc=msvcrt.lib, so=dll, useshrplib=yes, libperl=perl58.lib
    gnulibc_version=&#39;undef&#39;
  Dynamic Linking:
    dlsrc=dl_win32.xs, dlext=dll, d_dlsymun=undef, ccdlflags=&#39; &#39;
    cccdlflags=&#39; &#39;, lddlflags=&#39;-dll -nologo -nodefaultlib -debug -opt:ref,icf  -libpath:&#34;C:\Perl\lib
\CORE&#34;  -machine:x86&#39;


Characteristics of this binary &#40;from libperl&#41;:
  Compile-time options: MULTIPLICITY USE_ITHREADS USE_LARGE_FILES
                        USE_SITECUSTOMIZE PERL_IMPLICIT_CONTEXT
                        PERL_IMPLICIT_SYS
  Locally applied patches:
        ActivePerl Build 815 [211909]
        Iin_load_module moved for compatibility with build 806
        PerlEx support in CGI::Carp
        Less verbose ExtUtils::Install and Pod::Find
        instmodsh upgraded from ExtUtils-MakeMaker-6.25
        Patch for CAN-2005-0448 from Debian with modifications
        Upgrade to Time-HiRes-1.76
        25774 Keys of %INC always use forward slashes
        25747 Accidental interpolation of $@ in Pod::Html
        25362 File::Path::mkpath resets errno
        25181 Incorrect &#40;X&#41;HTML generated by Pod::Html
        24999 Avoid redefinition warning for MinGW
        24699 ICMP_UNREACHABLE handling in Net::Ping
        21540 Fix backward-compatibility issues in if.pm
  Built under MSWin32
  Compiled at Nov  2 2005 08:44:52
  @INC:
    C:/Perl/lib
    C:/Perl/site/lib


use Net::Ping;
use Net::Nslookup;
use threads;
use thread::queue;

#use strict;
#use warnings;

my @RemoteNodes;                # Array of remote node names to scan
my $RemoteNodes;                # Number of remote nodes to scan
my $RemoteMachine;              #
my $IP;                         #IP address of remote machine
my $threadcount = 4; # Number of threads for reading remote machine registries
my $countdown = $threadcount; #Used to keep track of threads shutting down

#Create queues
my $NodeQ = new Thread::Queue;  # Node names to be sacnned
my $DataQ = new Thread::Queue;  # Data structures returned by threads for output processing

    open &#40;NODELIST, &#34;$ARGV[0]&#34;&#41; || die &#34;Unable to open $ARGV[0]\n&#34;;

    @RemoteNodes=&lt;NODELIST&gt;;
    $RemoteNodes = @RemoteNodes;
    print &#34;Number of nodes to search = $RemoteNodes\n&#34;;
    close &#40;NODELIST&#41;;
    chomp&#40;@RemoteNodes&#41;;

# put all of the node names in the NodeQ
foreach $RemoteMachine &#40;@RemoteNodes&#41;
{
    $NodeQ-&gt;enqueue&#40;$RemoteMachine&#41;;
}
for &#40;my $i = 0; $i &lt;= $threadcount; $i++&#41;
{
    $NodeQ-&gt;enqueue&#40;&#34;ZZZZZZ&#34;&#41;;
}

#******************************************************************************
# Set up the threads that will read the remote machine registries
#******************************************************************************

        print &#34;Starting threads\n&#34;;
        my $thread1 = threads-&gt;create&#40;processNode, 1&#41;;
        my $thread2 = threads-&gt;create&#40;processNode, 2&#41;;
        my $thread3 = threads-&gt;create&#40;processNode, 3&#41;;
        my $thread4 = threads-&gt;create&#40;processNode, 4&#41;;

    while &#40;$countdown &gt; 0&#41;
    {
        # Get a node name from the queue
        $result = $DataQ-&gt;dequeue;
        print &#34;result $result\n&#34;;

        if &#40;$result eq &#34;ZZZZZZ&#34;&#41;
        {
            $countdown--;
            print &#34;ML thread has shutdown, count down = $countdown\n&#34;;
        }
    }
    print &#34;ML all queues have stopped\n&#34;;


sub processNode
{
    my $threadnum = $_[0];
    print &#34;In Thread $threadnum - processing\n&#34;;
    my $RemoteMachine=$NodeQ-&gt;dequeue;
    $RemoteMachine=~tr/a-z/A-Z/;
    #Setup main loop and loop until we are told to quit
    my $quit = 0;
    my $p = Net::Ping-&gt;new&#40;&#41;;
    if &#40;$RemoteMachine eq &#34;ZZZZZZ&#34;&#41;
    {
        $quit = 1;
    }
    while &#40;$quit == 0&#41;
    {
        if &#40;$p-&gt;ping&#40;$RemoteMachine&#41;&#41;  # if remote machine responds to PING then
        {
            $return = &#34;,answered ping,$threadnum&#34;;
        }
        else
        {
            $return = &#34;,did not respond to ping,$threadnum&#34;;
        }

        $DataQ-&gt;enqueue&#40;&#34;$RemoteMachine$return&#34;&#41;;
        $RemoteMachine = $NodeQ-&gt;dequeue;
        $RemoteMachine=~tr/a-z/A-Z/;
        if &#40;$RemoteMachine eq &#34;ZZZZZZ&#34;&#41;
        {
            $quit = 1;
            $DataQ-&gt;enqueue&#40;&#34;ZZZZZZ&#34;&#41;;
        }
    }
    $p-&gt;close&#40;&#41;;
    print &#34;exiting thread $threadnum\n&#34;;
}
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-159739" href="/Public/Bug/Display.html?id=4170#txn-159739">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;28&nbsp;00:07:49&nbsp;2006</span>
    <span class="description">Guest - Ticket #17019:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jjk [...] skism.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/159739/49634/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/49634">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 437b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jan 11 10:50:48 2006, guest wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; net::ping does not work properly when run in multiple threads when a
&gt;    large number of nodes that it tries to ping are unreachable.
&gt; 
&gt; In our network we have several thousand nodes of which about half are
&gt;    laptops and are typically not present on the network.
</div>[text snipped]
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     $p-&gt;close&#40;&#41;;
&gt;     print &#34;exiting thread $threadnum\n&#34;;
&gt; }
</div>
What version of Net::Ping are you using?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-159740" href="/Public/Bug/Display.html?id=4170#txn-159740">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;28&nbsp;00:07:49&nbsp;2006</span>
    <span class="description">The RT System itself - Ticket #17019:  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-212457" href="/Public/Bug/Display.html?id=4170#txn-212457">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;23&nbsp;16:28:17&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Carlos</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/212457/83621/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/83621">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 633b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi all,

I am having the same exact issue with NET::PING and multi-thread.

Any ideas in how to solve this problem?

Regards,
Carlos.
On Seg. Out. 20 10:18:08 2003, guest wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; module: Net::Ping 2.31
&gt; perl: perl 5.8.0 &#40;version included in redhat 8.0&#41;
&gt; os: Redhat 8.0
&gt; 
&gt; I need to ping multiple hosts &#40;at the moment ~470&#41; in a 1 minute
&gt; interval.
&gt; To realize this i create 4 threads &#40;maybe more in the future&#41; and use
&gt; Net::Ping to ping them &#40;as user root with icmp&#41;.
&gt; 
&gt; Most of the time the hosts are reported to be reachable although they
&gt; aren&#39;t!
&gt; If I change the number of threads to 1 it works the way it should.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-212458" href="/Public/Bug/Display.html?id=4170#txn-212458">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;23&nbsp;16:28:18&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-349870" href="/Public/Bug/Display.html?id=4170#txn-349870">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;31&nbsp;09:55:53&nbsp;2007</span>
    <span class="description">SMPETERS [...] cpan.org - Ticket #17019:  Merged into ticket #4170</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-349871" href="/Public/Bug/Display.html?id=4170#txn-349871">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;31&nbsp;09:55:54&nbsp;2007</span>
    <span class="description">SMPETERS [...] cpan.org -  Merged into ticket #4170</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-349922" href="/Public/Bug/Display.html?id=4170#txn-349922">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;31&nbsp;11:46:53&nbsp;2007</span>
    <span class="description">SMPETERS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/349922/157244/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/157244">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 621b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Oct 20 10:18:08 2003, guest wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; module: Net::Ping 2.31
&gt; perl: perl 5.8.0 &#40;version included in redhat 8.0&#41;
&gt; os: Redhat 8.0
&gt; 
&gt; I need to ping multiple hosts &#40;at the moment ~470&#41; in a 1 minute
&gt; interval.
&gt; To realize this i create 4 threads &#40;maybe more in the future&#41; and use
&gt; Net::Ping to ping them &#40;as user root with icmp&#41;.
&gt; 
&gt; Most of the time the hosts are reported to be reachable although they
&gt; aren&#39;t!
&gt; If I change the number of threads to 1 it works the way it should.
</div>
The patch in RT #17408 seems to resolve these problems.  I&#39;ll be testing
and should have another new release available today.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-351304" href="/Public/Bug/Display.html?id=4170#txn-351304">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;06&nbsp;09:11:26&nbsp;2007</span>
    <span class="description">SMPETERS [...] cpan.org -  Reference to ticket #17408 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-351306" href="/Public/Bug/Display.html?id=4170#txn-351306">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;06&nbsp;09:12:23&nbsp;2007</span>
    <span class="description">SMPETERS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/351306/157979/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/157979">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 786b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jul 31 11:46:53 2007, SMPETERS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Oct 20 10:18:08 2003, guest wrote:
<div class="message-stanza open">&gt; &gt; module: Net::Ping 2.31
&gt; &gt; perl: perl 5.8.0 &#40;version included in redhat 8.0&#41;
&gt; &gt; os: Redhat 8.0
&gt; &gt; 
&gt; &gt; I need to ping multiple hosts &#40;at the moment ~470&#41; in a 1 minute
&gt; &gt; interval.
&gt; &gt; To realize this i create 4 threads &#40;maybe more in the future&#41; and use
&gt; &gt; Net::Ping to ping them &#40;as user root with icmp&#41;.
&gt; &gt; 
&gt; &gt; Most of the time the hosts are reported to be reachable although they
&gt; &gt; aren&#39;t!
&gt; &gt; If I change the number of threads to 1 it works the way it should.
</div>&gt; 
&gt; The patch in RT #17408 seems to resolve these problems.  I&#39;ll be testing
&gt; and should have another new release available today.
</div>
This problem appears to have been resolved with release 2.33.  Thanks
for the reports!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-351309" href="/Public/Bug/Display.html?id=4170#txn-351309">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;06&nbsp;09:12:25&nbsp;2007</span>
    <span class="description">SMPETERS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-351352" href="/Public/Bug/Display.html?id=4170#txn-351352">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;06&nbsp;09:45:26&nbsp;2007</span>
    <span class="description">SMPETERS [...] cpan.org -  Reference by ticket #5861 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.927865</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
