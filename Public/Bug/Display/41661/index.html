<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #41661 for Mail-Box: UNKNOWN-encoded subjects are mis-study&#40;&#41;-ed</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #41661 for Mail-Box: UNKNOWN-encoded subjects are mis-study&#40;&#41;-ed</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Mail-Box/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Mail-Box/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Mail-Box/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Mail-Box/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-Box">Mail-Box CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">41661</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Mail-Box/Active/">Mail-Box</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
fschlich [...] cis.fu-berlin.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-19874-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.090    </td>
  </tr>
  <tr id="CF-19875-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;12&nbsp;12:58:40&nbsp;2008</span>
    <span class="description">fschlich [...] cis.fu-berlin.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> UNKNOWN-encoded subjects are mis-study&#40;&#41;-ed</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">if the subject is of =?UNKNOWN?Q? encoding, its contents are doubled
when calling $msg-&gt;study&#40;&#39;subject&#39;&#41;. On the attached files:

$ ./showsubj.pl example.mbox 
original subj is &#39;one =?UNKNOWN?Q?two?= three&#39;
 studied subj is &#39;one one =?UNKNOWN?Q?two_?= threethree&#39;
 decoded subj is &#39;one one =?UNKNOWN?Q?two_?= threethree&#39;

whereas I&#39;d expect the studied/decoded subject to be identical to the
original subject &#40;as printed by $msg-&gt;subject&#41;, or preferably be
converted to &#39;one two three&#39; &#40;that is, not decoded, but encoding markers
removed&#41;
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> example.mbox</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> showsubj.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w

use strict;
use diagnostics;

use Mail::Box::Manager;

my $mgr = Mail::Box::Manager-&gt;new; 

my $new_file = $ARGV[0];
my $new_folder = $mgr-&gt;open&#40;folder =&gt; $new_file, access =&gt; &#39;rw&#39;, extract =&gt; &#39;ALWAYS&#39;, cache_body =&gt; &#39;DELAY&#39;, cache_head =&gt; &#39;DELAY&#39;&#41; or die &#34;cannot open folder $new_file: $!\n&#34;;

my $msg = $new_folder-&gt;message&#40;0&#41;;

        
print &#34;original subj is &#39;&#34;, $msg-&gt;subject, &#34;&#39;\n&#34;;

# but I want pure UTF-8, no ?iso-88..? etc left
my $subject = $msg-&gt;study&#40;&#39;subject&#39;&#41;;

if &#40;$subject&#41; { # msg might not have a Subject: line at all....
    print &#34; studied subj is &#39;$subject&#39;\n&#34;;
    $subject = $subject-&gt;decodedBody&#40;&#41;;
    print &#34; decoded subj is &#39;$subject&#39;\n&#34;;


} else {
    print &#34;SUBJECT is FALSE &#40;no Subject: line?&#41;\n&#34;;
}
       
            

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;12&nbsp;15:42:16&nbsp;2008</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #41661] UNKNOWN-encoded subjects are mis-study&#40;&#41;-ed</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 12 Dec 2008 21:41:59 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Florian via RT &lt;bug-Mail-Box [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Florian via RT &#40;bug-Mail-Box@rt.cpan.org&#41; [081212 17:58]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Fri Dec 12 12:58:40 2008: Request 41661 was acted upon.
&gt; Transaction: Ticket created by fsfs
&gt;        Queue: Mail-Box
&gt;      Subject: UNKNOWN-encoded subjects are mis-study&#40;&#41;-ed
&gt;    Broken in: 2.086
&gt; 
&gt; if the subject is of =?UNKNOWN?Q? encoding, its contents are doubled
&gt; when calling $msg-&gt;study&#40;&#39;subject&#39;&#41;. On the attached files:
&gt; 
&gt; $ ./showsubj.pl example.mbox 
&gt; original subj is &#39;one =?UNKNOWN?Q?two?= three&#39;
&gt;  studied subj is &#39;one one =?UNKNOWN?Q?two_?= threethree&#39;
&gt;  decoded subj is &#39;one one =?UNKNOWN?Q?two_?= threethree&#39;
</div>
I am very pleased with your continued report of the problems, and the
very helpful examples you provide!

The fix for this is in Mail/Message/Field/Full.pm method decode&#40;&#41;
    $encoded =~ s/&#40;\=\?&#40;[^?\s]*&#41;\?&#40;[^?\s]*&#41;\?&#40;[^?\s]*&#41;\?\=\s*&#41;/
                  _decoder&#40;$2,$3,$4,$1&#41;/gse;

The fourth parameter of _decoder was the whole line, not just the
part to be decoded.
-- 
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;12&nbsp;15:42:17&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;17&nbsp;06:18:34&nbsp;2008</span>
    <span class="description">fschlich [...] cis.fu-berlin.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #41661] UNKNOWN-encoded subjects are mis-study&#40;&#41;-ed</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 17 Dec 2008 12:18:09 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Mark Overmeer via RT &lt;bug-Mail-Box [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Florian Schlichting &lt;fschlich [...] CIS.FU-Berlin.DE&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

thanks for your quick reply;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; $ ./showsubj.pl example.mbox 
&gt; &gt; original subj is &#39;one =?UNKNOWN?Q?two?= three&#39;
&gt; &gt;  studied subj is &#39;one one =?UNKNOWN?Q?two_?= threethree&#39;
&gt; &gt;  decoded subj is &#39;one one =?UNKNOWN?Q?two_?= threethree&#39;
</div></div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The fix for this is in Mail/Message/Field/Full.pm method decode&#40;&#41;
&gt;     $encoded =~ s/&#40;\=\?&#40;[^?\s]*&#41;\?&#40;[^?\s]*&#41;\?&#40;[^?\s]*&#41;\?\=\s*&#41;/
&gt;                   _decoder&#40;$2,$3,$4,$1&#41;/gse;
&gt; 
&gt; The fourth parameter of _decoder was the whole line, not just the
&gt; part to be decoded.
</div>
a lot better; but this results in:

$ ./showsubj.pl example.mbox
original subj is &#39;one =?UNKNOWN?Q?two?= three&#39;
 studied subj is &#39;one =?UNKNOWN?Q?two_?= three&#39;
 decoded subj is &#39;one =?UNKNOWN?Q?two_?= three&#39;

note the extra _ after &#34;two&#34; -- I think that&#39;s usually removed by
Encode, but of course not in the case where $whole is returned.

Also, in the case where no valid encoding can be found and thus no real
decoding can happen, I&#39;d prefer the encoding markers to be removed
instead of kept. &#40;The result is not perfect, but in the case of Western
languages where most of the letters are ASCII, it becomes almost
readable.&#41;

That is, _decode could return $encoded instead of $whole, but with the _
turned into a blank:

$ ./showsubj.pl example.mbox
original subj is &#39;one =?UNKNOWN?Q?two?= three&#39;
 studied subj is &#39;one two three&#39;
 decoded subj is &#39;one two three&#39;

Do you think that&#39;s possible? I don&#39;t really understand the intricacies
of MIME encodings, otherwise I&#39;d suggest to simply remove the fourth
parameter to _decode and define &#39;my $whole = $encoded; $whole =~ s/_/ /gs;&#39;

Florian
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;17&nbsp;06:29:45&nbsp;2008</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #41661] UNKNOWN-encoded subjects are mis-study&#40;&#41;-ed</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 17 Dec 2008 12:29:28 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Florian via RT &lt;bug-Mail-Box [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Florian via RT &#40;bug-Mail-Box@rt.cpan.org&#41; [081217 11:18]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Mail-Box
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=41661">https://rt.cpan.org/Ticket/Display.html?id=41661</a></span> &gt;
&gt; 
&gt; $ ./showsubj.pl example.mbox
&gt; original subj is &#39;one =?UNKNOWN?Q?two?= three&#39;
&gt;  studied subj is &#39;one =?UNKNOWN?Q?two_?= three&#39;
&gt;  decoded subj is &#39;one =?UNKNOWN?Q?two_?= three&#39;
</div>
The &#34;_&#34; fix is on a different line.  Already fixed in my prepared release,
added just above the changed line: change it into a blank.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Also, in the case where no valid encoding can be found and thus no real
&gt; decoding can happen, I&#39;d prefer the encoding markers to be removed
&gt; instead of kept. &#40;The result is not perfect, but in the case of Western
&gt; languages where most of the letters are ASCII, it becomes almost
&gt; readable.&#41;
</div>
No... it is a security hazard: I could decode in something binary.
By far most western charsets are already defined, so never UNKNOWN.
Some weird codesets will not map nicely on ASCII.

I have submitted a bugreport to Encode, to add all missing IANA charsets,
but no answer yet.  There is quite a lot missing.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;18&nbsp;08:04:27&nbsp;2008</span>
    <span class="description">fschlich [...] cis.fu-berlin.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #41661] UNKNOWN-encoded subjects are mis-study&#40;&#41;-ed</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 18 Dec 2008 14:04:11 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Mark Overmeer via RT &lt;bug-Mail-Box [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Florian Schlichting &lt;fschlich [...] CIS.FU-Berlin.DE&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Dec 17, 2008 at 06:29:45AM -0500, Mark Overmeer via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=41661">http://rt.cpan.org/Ticket/Display.html?id=41661</a></span> &gt;
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The &#34;_&#34; fix is on a different line.  Already fixed in my prepared release,
&gt; added just above the changed line: change it into a blank.
</div>
good; I&#39;ll test it one last time with that release

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Also, in the case where no valid encoding can be found and thus no real
&gt; &gt; decoding can happen, I&#39;d prefer the encoding markers to be removed
&gt; &gt; instead of kept. &#40;The result is not perfect, but in the case of Western
&gt; &gt; languages where most of the letters are ASCII, it becomes almost
&gt; &gt; readable.&#41;
</div>&gt; 
&gt; No... it is a security hazard: I could decode in something binary.
</div>
I don&#39;t understand: when removing the strings =?UNKNOWN?Q? and ?= &#40;and
perhaps a few _&#41;, the remainder wouldn&#39;t become something binary but
remains ASCII? I meant that &#34;n=E4chster&#34; is more readable than
&#34;=?UNKNOWN?Q?n=E4chster?=&#34;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; By far most western charsets are already defined, so never UNKNOWN.
&gt; Some weird codesets will not map nicely on ASCII.
</div>
I was thinking that it&#39;s too late for entirely non-ASCII scrips anyway,
but a little bit might still be gained for the almost-ASCII ones...


But I&#39;m not going to insist on this point, as it&#39;s rather minor, and you
could as well argue that a package such as yours shouldn&#39;t 

thanks for your continuing support and work on this package

Florain
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;18&nbsp;08:15:30&nbsp;2008</span>
    <span class="description">solutions [...] overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #41661] UNKNOWN-encoded subjects are mis-study&#40;&#41;-ed</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 18 Dec 2008 14:15:07 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Florian via RT &lt;bug-Mail-Box [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;solutions [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Florian via RT &#40;bug-Mail-Box@rt.cpan.org&#41; [081218 13:04]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Mail-Box
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=41661">http://rt.cpan.org/Ticket/Display.html?id=41661</a></span> &gt;
&gt; 
&gt; I don&#39;t understand: when removing the strings =?UNKNOWN?Q? and ?= &#40;and
&gt; perhaps a few _&#41;, the remainder wouldn&#39;t become something binary but
&gt; remains ASCII? I meant that &#34;n=E4chster&#34; is more readable than
&gt; &#34;=?UNKNOWN?Q?n=E4chster?=&#34;
</div>
I feel weak today: you convinced me ;-&#41;
Sorry that it took so long.   Too much on my mind.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;03&nbsp;06:44:08&nbsp;2009</span>
    <span class="description">MARKOV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">fixed in 2.087
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;03&nbsp;06:44:08&nbsp;2009</span>
    <span class="description">MARKOV [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;08&nbsp;03:53:58&nbsp;2009</span>
    <span class="description">fschlich [...] cis.fu-berlin.de -  Broken in 2.090 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;08&nbsp;03:53:59&nbsp;2009</span>
    <span class="description">fschlich [...] cis.fu-berlin.de -  Broken in 2.086 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;08&nbsp;03:53:59&nbsp;2009</span>
    <span class="description">fschlich [...] cis.fu-berlin.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry for leaving this untouched for such a long time, but there&#39;s one
minor thing remaining, I just noticed: When running the originally
attached skript/mbox with current Mail::Box: 2.090 I get:

$ perl showsubj.pl example.mbox
original subj is &#39;one =?UNKNOWN?Q?two?= three&#39;
 studied subj is &#39;one two_three&#39;
 decoded subj is &#39;one two_three&#39;
                        ^^^

What I think shouldn&#39;t be there is the underline &#40;&#39;_&#39;&#41; character between
&#39;two&#39; and &#39;three&#39;, where the original had a space. This is only an issue
for &#39;UNKNOWN&#39; encodings, and not fixed by using up-to-date Encode 2.33

thanks
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;08&nbsp;03:53:59&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;08&nbsp;05:23:01&nbsp;2009</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #41661] UNKNOWN-encoded subjects are mis-study&#40;&#41;-ed</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 8 Jun 2009 11:22:42 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Florian via RT &lt;bug-Mail-Box [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Florian via RT &#40;bug-Mail-Box@rt.cpan.org&#41; [090608 07:54]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Mail-Box
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=41661">https://rt.cpan.org/Ticket/Display.html?id=41661</a></span> &gt;
&gt; 
&gt; $ perl showsubj.pl example.mbox
&gt; original subj is &#39;one =?UNKNOWN?Q?two?= three&#39;
&gt;  studied subj is &#39;one two_three&#39;
&gt;  decoded subj is &#39;one two_three&#39;
&gt;                         ^^^
&gt; 
&gt; What I think shouldn&#39;t be there is the underline &#40;&#39;_&#39;&#41; character between
&gt; &#39;two&#39; and &#39;three&#39;, where the original had a space. This is only an issue
&gt; for &#39;UNKNOWN&#39; encodings, and not fixed by using up-to-date Encode 2.33
</div>
Should we declare that a bug in Encode?
The decoding &#40;the understanding whether it is a known charset&#41; is left
to Encode.  Apparently, when it does understand the charset, then it
decodes and replaces the &#39;_&#39;.  When it does not understand the charset,
it forgets to translate the &#39;_&#39;.  Am I right?
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;08&nbsp;07:52:25&nbsp;2009</span>
    <span class="description">fschlich [...] cis.fu-berlin.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> fschlich [...] cis.fu-berlin.de</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #41661] UNKNOWN-encoded subjects are mis-study&#40;&#41;-ed</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 8 Jun 2009 13:52:01 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Mark Overmeer via RT &lt;bug-Mail-Box [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Florian Schlichting &lt;fschlich [...] CIS.FU-Berlin.DE&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, Jun 08, 2009 at 05:23:02AM -0400, Mark Overmeer via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=41661">http://rt.cpan.org/Ticket/Display.html?id=41661</a></span> &gt;
&gt; 
&gt; * Florian via RT &#40;bug-Mail-Box@rt.cpan.org&#41; [090608 07:54]:
<div class="message-stanza open">&gt; &gt;        Queue: Mail-Box
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=41661">https://rt.cpan.org/Ticket/Display.html?id=41661</a></span> &gt;
&gt; &gt; 
&gt; &gt; $ perl showsubj.pl example.mbox
&gt; &gt; original subj is &#39;one =?UNKNOWN?Q?two?= three&#39;
&gt; &gt;  studied subj is &#39;one two_three&#39;
&gt; &gt;  decoded subj is &#39;one two_three&#39;
&gt; &gt;                         ^^^
&gt; &gt; 
&gt; &gt; What I think shouldn&#39;t be there is the underline &#40;&#39;_&#39;&#41; character between
&gt; &gt; &#39;two&#39; and &#39;three&#39;, where the original had a space. This is only an issue
&gt; &gt; for &#39;UNKNOWN&#39; encodings, and not fixed by using up-to-date Encode 2.33
</div>&gt; 
&gt; Should we declare that a bug in Encode?
&gt; The decoding &#40;the understanding whether it is a known charset&#41; is left
&gt; to Encode.  Apparently, when it does understand the charset, then it
&gt; decodes and replaces the &#39;_&#39;.  When it does not understand the charset,
&gt; it forgets to translate the &#39;_&#39;.  Am I right?
</div>
I was under the impression that in cases where Encode does not
understand the charset, it wouldn&#39;t touch the field at all, and that
it&#39;s a feature of Mail::Box that you were so kind to add after my
pestering earlier in this ticket to simply strip the decoding marks in
such cases. 

The bug would then be that decode&#40;&#41; in Mail::Message::Field::Full adds a
&#39;_&#39; as a kind of workaround for a problem in Encode &#40;or perhaps a
workaround for a problem in the regex in decode&#40;&#41;?&#41;, which doesn&#39;t get
removed if _decoder just returns the original $encoded.

perhaps _decoder should, if Encode::find_encoding&#40;$charset&#41; returns
false, not just return $encoded, but first do a s/_/ /g on $encoded, for
example as the first step in the following if-block? Like this:

--- Mail-Box-2.090/lib/Mail/Message/Field/Full.pm       2009-06-02 11:56:45.000000000 +0200
+++ perl/share/perl/5.8.8/Mail/Message/Field/Full.pm    2009-06-08 13:49:11.265069004 +0200
@@ -270,11 +270,14 @@
 sub _decoder&#40;$$$&#41;
 {   my &#40;$charset, $encoding, $encoded&#41; = @_;
     $charset   =~ s/\*[^*]+$//;   # language component not used
-    my $to_utf8 = Encode::find_encoding&#40;$charset || &#39;us-ascii&#39;&#41;
-        or return $encoded;
+    my $to_utf8 = Encode::find_encoding&#40;$charset || &#39;us-ascii&#39;&#41;; 
 
     my $decoded;
-    if&#40;$encoding !~ /\S/&#41;
+    if&#40;!$to_utf8&#41;
+    {   $encoded =~ s/_/ /g;
+        return $encoded;
+    }
+    elsif&#40;$encoding !~ /\S/&#41;
     {   $decoded = $encoded;
     }
     elsif&#40;lc&#40;$encoding&#41; eq &#39;q&#39;&#41;


and then there&#39;s also the last &#40;else&#41; block of that if cascade...


&#40;NB: in decode&#40;&#41;, it looks like you want to say &#39;if&#40;$is_text&#41;&#39; instead
of &#39;if&#40;defined...&#39;, for why else would you define $is_text in the
previous line?&#41;


@@ -298,7 +301,7 @@
 sub decode&#40;$@&#41;
 {   my &#40;$self, $encoded, %args&#41; = @_;
     my $is_text = defined $args{is_text} ? $args{is_text} : 1;
-    if&#40;defined $args{is_text} ? $args{is_text} : 1&#41;
+    if&#40;$is_text&#41;
     {  # in text, blanks between encoding must be removed, but otherwise kept :&#40;
        # little trick to get this done: add an explicit blank.
        $encoded =~ s/\?\=\s&#40;?!\s*\=\?|$&#41;/_?= /gs;


best,
Florian
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;08&nbsp;08:00:58&nbsp;2009</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #41661] UNKNOWN-encoded subjects are mis-study&#40;&#41;-ed</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 8 Jun 2009 14:00:34 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Florian via RT &lt;bug-Mail-Box [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Florian via RT &#40;bug-Mail-Box@rt.cpan.org&#41; [090608 11:52]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; perhaps _decoder should, if Encode::find_encoding&#40;$charset&#41; returns
&gt; false, not just return $encoded, but first do a s/_/ /g on $encoded, for
&gt; example as the first step in the following if-block? Like this:
</div>
Yes, simple solution.  Both changes included.
-- 
Thanks,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;06&nbsp;18:03:44&nbsp;2009</span>
    <span class="description">MARKOV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">just release 2.091 fixing this
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;06&nbsp;18:03:45&nbsp;2009</span>
    <span class="description">MARKOV [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
