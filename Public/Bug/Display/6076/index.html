<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #6076 for Cache-Cache: Cache::SharedMemoryCache fails when more than one instance runs on the same server</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #6076 for Cache-Cache: Cache::SharedMemoryCache fails when more than one instance runs on the same server</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Cache-Cache/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Cache-Cache/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Cache-Cache/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Cache-Cache/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Cache-Cache">Cache-Cache CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">6076</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Cache-Cache/Active/">Cache-Cache</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">dewitt [...] unto.net
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
thomas.acunzo [...] ubs.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-4846-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-4847-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;20&nbsp;11:20:08&nbsp;2004</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Cache::SharedMemoryCache fails when more than one instance runs
 on the same server</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
&#34;[Thu Apr 15 17:35:06 2004] [error] Can&#39;t call method &#34;fetch&#34; on an undefined value at .../cpan/5.8.0-2003.05/lib/Cache/SharedMemoryBackend.pm line 98.&#34;


Hi

If you start seeing this type of error and your application was running fine until this point, it could mean that another process chain is also using the Cache::SharedMemoryCache module on the same machine.

I&#39;m unsure as what is causing this error but I bet it has something to do with the Locking of IPC::ShareLite. 

Note: using a separate namespace does not help getting through the problem. Switching to FileCache will help as a work around.

The test program given below will traps errors to avoid getting the generic &#39;Internal Server&#39; message. The result should be that the 
system time is cache upon the first http request &#40;Apache Pid&#41;. 
All other http requests &#40;Apache Pids&#41; should also see this 
number. After 5 minutes has past the cache will clear itself 
and a new time will be cached for all pids until the next rotation. 

Load the sample once to see how it works normally. Load a 
second apache instance with the same code and see the error 
messages. Use netscape browser with &lt;shift&gt; &lt;click &#39;reload&#39;&gt;.

# Apache 1.3.27 conf &#40;requires mod-perl&#41;
# include lib path in your @INC
PerlModule testShareMemCache
&lt;Location /test&gt;
SetHandler perl-script 
PerlHandler testShareMemCache
&lt;/Location&gt;

# file testShareMemCache.pm
package testShareMemCache;
use lib qw&#40;../cpan/5.8.0-2003.05/lib&#41;;
use Cache::SharedMemoryCache;

my $cache = new Cache::SharedMemoryCache;
Apache-&gt;server-&gt;register_cleanup&#40;sub {$cache-&gt;clear;}&#41;;

my $pid = $$;
sub handler 
 {
 my $r = shift;
 my $time = eval{$cache-&gt;get&#40;&#39;TiMeStAmP&#39;&#41;};

  if &#40;!$time&#41; {
   $time = time;
    eval{$cache-&gt;set&#40;&#39;TiMeStAmP&#39;,$time,&#39;5 min&#39;&#41;};
              }
 print &#39;&lt;html&gt;&lt;head&gt;
         &lt;title&gt;Testing Cache::SharedMemoryCache&lt;/title&gt;
        &lt;/head&gt;&lt;body&gt;&#39;,
        &#34;Parent pid: $pid
        &lt;h3&gt;System Clock: $time Apache Pid: $$&lt;/h3&gt;
        $@&lt;/body&gt;&lt;/html&gt;&#34;;
 return OK; 
 }
1;


I was running on Perl 5.8.0 mod-perl 1.27 for apache 1.3.27 on Solaris 5.8
IPC::ShareLite v0.09
Cache::Cache v1.40
Cache::SharedMemoryCache v1.23
Cache::SharedMemoryBackend v1.7

If I could make a suggestion:
The problem may turn out to be a module dependency &#40;IPC&#41;.  It would better help the developer if the external error was trapped, like using an eval block or testing $p_ipc_identifier for a null value.

From error block SharedMemoryBackend:
sub _Restore_Shared_Hash_Ref
{
  my &#40; $p_ipc_identifier &#41; = Static_Params&#40; @_ &#41;;

  Assert_Defined&#40; $p_ipc_identifier &#41;;

  my $frozen_hash_ref = _Instantiate_Share&#40; $p_ipc_identifier &#41;-&gt;fetch&#40; &#41; or
    return { };

  return Thaw_Data&#40; $frozen_hash_ref &#41;;
}

If this turns out to be some platform limitation, please make a note of this in the perldocs. 

Regards
Tom Acunzo Ubs Investment Bank &#40;IMS Perot Systems&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;24&nbsp;10:51:00&nbsp;2004</span>
    <span class="description">dewitt [...] unto.net -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;24&nbsp;10:51:55&nbsp;2004</span>
    <span class="description">dewitt [...] unto.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Good bug report.  Accepting the bug, and will comment on it shortly.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;24&nbsp;10:51:57&nbsp;2004</span>
    <span class="description">dewitt [...] unto.net -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;24&nbsp;11:41:59&nbsp;2004</span>
    <span class="description">dewitt [...] unto.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">A few thoughts on this, then I am going to close the ticket.

1&#41; My official answer these days is to use FileCache instead of
SharedMemoryCache.  The reasons are many.  First, FileCache provides
equal or better performance in all cases that I&#39;ve been able to test. 
&#40;This is due to all modern OS&#39;s ability to buffer and cache file system
accesses very well.&#41;  Second, FileCache has no real limits on cached
object size or the number of cached objects, whereas the
SharedMemoryCache has limits, and rather low ones at that.  Third,
FileCache works well on every OS, wherease the SharedMemoryCache works
only on systems that support IPC::ShareLite.  And IPC::ShareLite is an
impressive effort -- but think about how hard it is to get shared memory
working properly on *one* system.  Now imagine writing a wrapper around
SM for many operating systems.

So the point of that is use FileCache instead.  You won&#39;t regret it.

2&#41; There were a few places in SharedMemoryBackend that I could do some
error checking, so I added that to the library.  I&#39;m not sure if it will
actually report what&#39;s going on &#40;because, as you described, the issues
lie in the IPC::ShareLite layer&#41;, but it is a start.  This has been
checked into the CVS version -- please visit the perl-cache page on
Sourceforge if you need this update ASAP.

3&#41; I&#39;m adding a comment to SharedMemoryCache to recommend using
FileCache instead.  I&#39;d remove SMC altogether, but I don&#39;t want to break
anyone&#39;s code.

Thanks again!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;24&nbsp;11:42:01&nbsp;2004</span>
    <span class="description">dewitt [...] unto.net -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;26&nbsp;12:53:58&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Very Cool! 
Thank you for your prompt response.


[DCLINTON - Sat Apr 24 11:41:59 2004]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; A few thoughts on this, then I am going to close the ticket.
&gt; 
&gt; 1&#41; My official answer these days is to use FileCache instead of
&gt; SharedMemoryCache.  The reasons are many.  First, FileCache provides
&gt; equal or better performance in all cases that I&#39;ve been able to test.
&gt; &#40;This is due to all modern OS&#39;s ability to buffer and cache file
&gt; system
&gt; accesses very well.&#41;  Second, FileCache has no real limits on cached
&gt; object size or the number of cached objects, whereas the
&gt; SharedMemoryCache has limits, and rather low ones at that.  Third,
&gt; FileCache works well on every OS, wherease the SharedMemoryCache works
&gt; only on systems that support IPC::ShareLite.  And IPC::ShareLite is an
&gt; impressive effort -- but think about how hard it is to get shared
&gt; memory
&gt; working properly on *one* system.  Now imagine writing a wrapper
&gt; around
&gt; SM for many operating systems.
&gt; 
&gt; So the point of that is use FileCache instead.  You won&#39;t regret it.
&gt; 
&gt; 2&#41; There were a few places in SharedMemoryBackend that I could do some
&gt; error checking, so I added that to the library.  I&#39;m not sure if it
&gt; will
&gt; actually report what&#39;s going on &#40;because, as you described, the issues
&gt; lie in the IPC::ShareLite layer&#41;, but it is a start.  This has been
&gt; checked into the CVS version -- please visit the perl-cache page on
&gt; Sourceforge if you need this update ASAP.
&gt; 
&gt; 3&#41; I&#39;m adding a comment to SharedMemoryCache to recommend using
&gt; FileCache instead.  I&#39;d remove SMC altogether, but I don&#39;t want to
&gt; break
&gt; anyone&#39;s code.
&gt; 
&gt; Thanks again!
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;26&nbsp;12:53:58&nbsp;2004</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;26&nbsp;12:57:14&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Mon Apr 26 12:53:58 2004]:

PLEASE CLOSE. 
Didn&#39;t mean to reopen this chain sorry.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Very Cool! 
&gt; Thank you for your prompt response.
&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;May&nbsp;26&nbsp;14:46:27&nbsp;2006</span>
    <span class="description">dewitt [...] unto.net -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
