<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #67700 for Variable-Magic: Segfault on 5.8.1/5.8.3 when used via namespace::clean</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #67700 for Variable-Magic: Segfault on 5.8.1/5.8.3 when used via namespace::clean</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Variable-Magic/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Variable-Magic/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Variable-Magic/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Variable-Magic/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Variable-Magic">Variable-Magic CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">67700</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Variable-Magic/Active/">Variable-Magic</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ribasushi [...] leporine.io

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Unimportant    </td>
  </tr>
  <tr id="CF-44686-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-44687-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;22&nbsp;11:31:39&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Segfault on 5.8.1/5.8.3 when used via namespace::clean</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This may be a bogus report unrelated to V::M, I am filing here
nevertheless as V::M is the only XS component in the failing library stack.

A diclaimer upfront - I am not expecting this bug to be solved, as it
manifests only on 5.8.1/5.8.3, which are understandably falling out of
favor. I am just collecting my current data here in case you are
interested and want to give it a poke. No hard feelings if this ticket
gets 0 attention :&#41;

The problem manifests itself when an exporter inject a cleaning trigger
into the importing package. The simplest manifestation is:

rabbit@Thesaurus:~/devel/dbic/dbgit$ perlbrew switch 5.8.3_dbg_thr
Switched to 5.8.3_dbg_thr
rabbit@Thesaurus:~/devel/dbic/dbgit$ git diff
diff --git a/lib/DBIx/Class/Carp.pm b/lib/DBIx/Class/Carp.pm
index 5f40094..3c29332 100644
--- a/lib/DBIx/Class/Carp.pm
+++ b/lib/DBIx/Class/Carp.pm
@@ -106,7 +106,7 @@ sub import {
     ## FIXME FIXME FIXME - something is tripping up V::M on 5.8.1/3,
leading
     # to segfaults. When n::c/B::H::EndOfScope is rewritten in terms of
tie&#40;&#41;
     # see if this starts working
-    unless DBIx::Class::_ENV_::BROKEN_NAMESPACE_CLEAN&#40;&#41;;
+#    unless DBIx::Class::_ENV_::BROKEN_NAMESPACE_CLEAN&#40;&#41;;
 }
 
 sub unimport {
rabbit@Thesaurus:~/devel/dbic/dbgit$ prove -l t/30dbicplain.t 
t/30dbicplain....dubious                                               
     
        Test returned status 0 &#40;wstat 11, 0xb&#41;
FAILED--1 test script could be run, alas--no output ever seen

rafl helped me obtain this trace:

rabbit@Thesaurus:~/devel/dbic/dbgit$ perl -MDevel::bt -Ilib t/30dbicplain.t 
#0  0xb78ac424 in __kernel_vsyscall &#40;&#41;
#1  0xb7814f23 in __waitpid_nocancel &#40;&#41; from /lib/i686/cmov/libpthread.so.0
#2  0xb74e82a5 in backtrace &#40;&#41; at bt.xs:183
#3  0xb74e82ce in signal_handler &#40;sig=11&#41; at bt.xs:190
#4  &lt;signal handler called&gt;
#5  0x080e0770 in S_hfreeentries &#40;my_perl=0x8960008, hv=0x8cb4530&#41; at
hv.c:1553
#6  0x080e05a1 in Perl_hv_clear &#40;my_perl=0x8960008, hv=0x8cb4530&#41; at
hv.c:1472
#7  0x0817383a in S_isa_lookup &#40;my_perl=0x8960008, stash=0x8cef278,
name=0x8cbc078 &#34;DBIx::Class::UTF8Columns&#34;, name_stash=0x0, len=24,
level=2&#41; at universal.c:72
#8  0x08173b0b in S_isa_lookup &#40;my_perl=0x8960008, stash=0x897b5c4,
name=0x8cbc078 &#34;DBIx::Class::UTF8Columns&#34;, name_stash=0x0, len=24,
level=1&#41; at universal.c:109
#9  0x08173b0b in S_isa_lookup &#40;my_perl=0x8960008, stash=0x8da6dec,
name=0x8cbc078 &#34;DBIx::Class::UTF8Columns&#34;, name_stash=0x0, len=24,
level=0&#41; at universal.c:109
#10 0x08173cc1 in Perl_sv_derived_from &#40;my_perl=0x8960008, sv=0x8cef3c8,
name=0x8cbc078 &#34;DBIx::Class::UTF8Columns&#34;&#41; at universal.c:159
#11 0x08174216 in XS_UNIVERSAL_isa &#40;my_perl=0x8960008, cv=0x8973220&#41; at
universal.c:237
#12 0x080f0f46 in Perl_pp_entersub &#40;my_perl=0x8960008&#41; at pp_hot.c:2840
#13 0x080cbacb in Perl_runops_debug &#40;my_perl=0x8960008&#41; at dump.c:1438
#14 0x08069cdd in S_call_body &#40;my_perl=0x8960008, myop=0xbfac6598,
is_eval=0&#41; at perl.c:2221
#15 0x0806984a in Perl_call_sv &#40;my_perl=0x8960008, sv=0x8da8938,
flags=6&#41; at perl.c:2139
#16 0x0806eb7f in S_call_list_body &#40;my_perl=0x8960008, cv=0x8da8938&#41; at
perl.c:4390
#17 0x0806e6a9 in Perl_call_list &#40;my_perl=0x8960008, oldscope=17,
paramList=0x8da8908&#41; at perl.c:4319
#18 0x080a6aca in Perl_newATTRSUB &#40;my_perl=0x8960008, floor=402,
o=0x8d77b20, proto=0x0, attrs=0x0, block=0x8d77af8&#41; at op.c:4373
#19 0x080a21e3 in Perl_utilize &#40;my_perl=0x8960008, aver=1, floor=402,
version=0x0, idop=0x8cb7be0, arg=0x8e4f388&#41; at op.c:2976
#20 0x08097af8 in Perl_yyparse &#40;my_perl=0x8960008&#41; at perly.y:414
#21 0x08136035 in S_doeval &#40;my_perl=0x8960008, gimme=0, startop=0x0,
outside=0x0, seq=3747&#41; at pp_ctl.c:2798
#22 0x0813864c in Perl_pp_require &#40;my_perl=0x8960008&#41; at pp_ctl.c:3295
#23 0x080cbacb in Perl_runops_debug &#40;my_perl=0x8960008&#41; at dump.c:1438
#24 0x08068d59 in S_run_body &#40;my_perl=0x8960008, oldscope=1&#41; at perl.c:1857
#25 0x080687b9 in perl_run &#40;my_perl=0x8960008&#41; at perl.c:1776
#26 0x08063486 in main &#40;argc=4, argv=0xbfac6d34, env=0xbfac6d48&#41; at
perlmain.c:86
Aborted

When less code is involved, the segfault is reduced to a warning, which
can easily be reproduced as:

perl -MCarp::Always -Ilib -MDBIx::Class::ResultSet -e &#39;1&#39;
Attempt to free unreferenced scalar: SV 0x8e7bd80 at
lib/DBIx/Class/ResultSet.pm line 8
        DBIx::Class::ResultSet::BEGIN&#40;&#41; called at
lib/DBIx/Class/ResultSetColumn.pm line 8
        eval {...} called at lib/DBIx/Class/ResultSetColumn.pm line 8
        require DBIx/Class/ResultSet.pm called at -e line 0
        main::BEGIN&#40;&#41; called at lib/DBIx/Class/ResultSetColumn.pm line 8
        eval {...} called at lib/DBIx/Class/ResultSetColumn.pm line 8


Cheers
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;23&nbsp;10:57:02&nbsp;2011</span>
    <span class="description">vpit [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">As discussed on IRC, this turned out to be the expression of the
internal bug of perl [rt.perl.org #27040]. It was fixed in 5.8.4 by

    commit dfa41748806263fb8b5d5fcb051bd36be96fe93c
    Author: Dave Mitchell &lt;davem@fdisolutions.com&gt;
    Date:   Fri Mar 26 13:05:50 2004 +0000

         [perl #27040] - hints hash was being double freed on scope exit
    
         p4raw-id: //depot/perl@22594

I&#39;m closing this report for now.


Vincent.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;23&nbsp;10:57:03&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;23&nbsp;10:57:03&nbsp;2011</span>
    <span class="description">vpit [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
