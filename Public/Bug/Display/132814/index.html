<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #132814 for Object-Pad: t/73mop-create-slot.t SEGV on perls 5.18 to 5.22</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #132814 for Object-Pad: t/73mop-create-slot.t SEGV on perls 5.18 to 5.22</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Object-Pad/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Object-Pad/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Object-Pad/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Object-Pad/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Object-Pad">Object-Pad CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">132814</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Object-Pad/Active/">Object-Pad</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
leonerd-cpan [...] leonerd.org.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-273988-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.26    </td>
  </tr>
  <tr id="CF-273989-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.34    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;12&nbsp;19:56:38&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> t/73mop-create-slot.t SEGV on perls 5.18 to 5.22</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Often seen in cpantesters matrix. 5.16, and 5.22 onwards seems to be fine.

Example:

<span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/cpan/report/b6ad6476-8847-11ea-ab2c-73181f24ea8f">http://www.cpantesters.org/cpan/report/b6ad6476-8847-11ea-ab2c-73181f24ea8f</a></span>

An initial gdb attempt showed:

ok 1 - $slotmeta-&gt;name
ok 2 - Failure from -&gt;add_slot undef
ok 3 - Failure from -&gt;add_slot on empty string
ok 4 - Failure from -&gt;add_slot without sigil
ok 5 - Failure from -&gt;add_slot duplicate

Program received signal SIGSEGV, Segmentation fault.
0x0000000000460538 in S_cv_clone &#40;&#41;
&#40;gdb&#41; bt
#0  0x0000000000460538 in S_cv_clone &#40;&#41;
#1  0x00000000004bbf18 in Perl_pp_anoncode &#40;&#41;
#2  0x000000000049eb73 in Perl_runops_standard &#40;&#41;
#3  0x00000000004356d7 in Perl_call_sv &#40;&#41;
#4  0x000000000043750e in Perl_call_list &#40;&#41;
#5  0x000000000041e90b in S_process_special_blocks &#40;&#41;
#6  0x000000000042fb24 in Perl_newATTRSUB_x &#40;&#41;
#7  0x000000000045fda2 in Perl_yyparse &#40;&#41;
#8  0x00000000004431dd in S_parse_recdescent_for_op &#40;&#41;
#9  0x000000000045cad4 in Perl_parse_stmtseq &#40;&#41;
#10 0x00007ffff7fca036 in my_keyword_plugin &#40;&#41;
   from /home/leo/src/perl/Object-Pad/blib/arch/auto/Object/Pad/Pad.so
#11 0x000000000044cfd4 in Perl_yylex &#40;&#41;
#12 0x000000000045da25 in Perl_yyparse &#40;&#41;
#13 0x000000000043af3d in perl_parse &#40;&#41;
#14 0x000000000041dde0 in main &#40;&#41;

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;13&nbsp;10:13:36&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Probably some uninitialised data somewhere, because if it fails simply repeating the test without changes may well make it pass.

Probably a good candidate for valgrind

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;17&nbsp;11:55:02&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Tut tut Perl...

$ perl5.20.3 --valgrind -Mblib t/01method.t 
==8178== Memcheck, a memory error detector
==8178== Copyright &#40;C&#41; 2002-2017, and GNU GPL&#39;d, by Julian Seward et al.
==8178== Using Valgrind-3.15.0 and LibVEX; rerun with -h for copyright info
==8178== Command: /home/leo/perl5/perlbrew/perls/perl-5.20.3/bin/perl5.20.3 -Mblib t/01method.t
==8178== 
ok 1 - method compiles OK
ok 2 - warning from redeclared $self comes from correct line
ok 3 - $p has refcount 1 initially
ok 4 - $p-&gt;where
ok 5 - $p has refcount 1 after method
ok 6 - anon method
==8178== Invalid read of size 8
==8178==    at 0x46052B: S_cv_clone &#40;in /home/leo/perl5/perlbrew/perls/perl-5.20.3/bin/perl5.20.3&#41;
==8178==    by 0x4BBF17: Perl_pp_anoncode &#40;in /home/leo/perl5/perlbrew/perls/perl-5.20.3/bin/perl5.20.3&#41;
==8178==    by 0x49EB72: Perl_runops_standard &#40;in /home/leo/perl5/perlbrew/perls/perl-5.20.3/bin/perl5.20.3&#41;
==8178==    by 0x4354B0: Perl_call_sv &#40;in /home/leo/perl5/perlbrew/perls/perl-5.20.3/bin/perl5.20.3&#41;
==8178==    by 0x65CE752: injected_constructor &#40;in /home/leo/src/perl/Object-Pad/blib/arch/auto/Object/Pad/Pad.so&#41;
==8178==    by 0x4A5D6F: Perl_pp_entersub &#40;in /home/leo/perl5/perlbrew/perls/perl-5.20.3/bin/perl5.20.3&#41;
==8178==    by 0x49EB72: Perl_runops_standard &#40;in /home/leo/perl5/perlbrew/perls/perl-5.20.3/bin/perl5.20.3&#41;
==8178==    by 0x43B9F8: perl_run &#40;in /home/leo/perl5/perlbrew/perls/perl-5.20.3/bin/perl5.20.3&#41;
==8178==    by 0x41DE64: main &#40;in /home/leo/perl5/perlbrew/perls/perl-5.20.3/bin/perl5.20.3&#41;
==8178==  Address 0x615dc48 is 8 bytes before a block of size 40 alloc&#39;d
==8178==    at 0x483677F: malloc &#40;vg_replace_malloc.c:309&#41;
==8178==    by 0x4847D4: Perl_safesysmalloc &#40;in /home/leo/perl5/perlbrew/perls/perl-5.20.3/bin/perl5.20.3&#41;
==8178==    by 0x65DF981: indirect_map_store &#40;in /home/leo/perl5/perlbrew/perls/perl-5.20.3/lib/site_perl/5.20.3/x86_64-linux/auto/indirect/indirect.so&#41;
==8178==    by 0x65DFD8D: indirect_ck_method &#40;in /home/leo/perl5/perlbrew/perls/perl-5.20.3/lib/site_perl/5.20.3/x86_64-linux/auto/indirect/indirect.so&#41;
==8178==    by 0x424D06: Perl_newUNOP &#40;in /home/leo/perl5/perlbrew/perls/perl-5.20.3/bin/perl5.20.3&#41;
==8178==    by 0x45E498: Perl_yyparse &#40;in /home/leo/perl5/perlbrew/perls/perl-5.20.3/bin/perl5.20.3&#41;
==8178==    by 0x43AF3C: perl_parse &#40;in /home/leo/perl5/perlbrew/perls/perl-5.20.3/bin/perl5.20.3&#41;
==8178==    by 0x41DDDF: main &#40;in /home/leo/perl5/perlbrew/perls/perl-5.20.3/bin/perl5.20.3&#41;
==8178== 
Variable &#34;$_genvalue&#34; is not available at t/01method.t line 49.
ok 7 - $obj-&gt;value from BUILD-generated anon method
1..7

At first glance this isn&#39;t even within any code I have written.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;17&nbsp;11:55:03&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;03&nbsp;12:51:16&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve decided to look into this a bit to at least understand where it comes from. Even though it seems only to affect perl 5.20 and earlier, it would be good to work out in case it&#39;s indicative of a more serious underlying problem that&#39;s still there.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;03&nbsp;16:46:31&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">By starting at:

ok 1 - $slotmeta-&gt;name
ok 2 - Failure from -&gt;add_slot undef
ok 3 - Failure from -&gt;add_slot on empty string
ok 4 - Failure from -&gt;add_slot without sigil
ok 5 - Failure from -&gt;add_slot duplicate
Variable &#34;$slot&#34; is not available at &#40;eval 10&#41; line 1.
...

That message is generated by:

  pad.c: static void S_unavailable&#40;&#41;

I haven&#39;t been able to make the script crash with gdb running it, but valgrind helps as well:

ok 5 - Failure from -&gt;add_slot duplicate
==4097345== Invalid read of size 8
==4097345==    at 0x1F4E6E: S_cv_clone_pad &#40;pad.c:2087&#41;
==4097345==    by 0x1F5D28: S_cv_clone &#40;pad.c:2194&#41;
==4097345==    by 0x1F5F0A: Perl_cv_clone &#40;pad.c:2231&#41;
...
==4097345==  Address 0x63ed260 is 8,272 bytes inside an unallocated block of size 1,986,000 in arena &#34;client&#34;
==4097345== 
Variable &#34;$slot&#34; is not available at &#40;eval 10&#41; line 1.

Looking in 5.20.3&#39;s source at pad.c:

2087            if &#40;!outpad || !&#40;sv = outpad[PARENT_PAD_INDEX&#40;namesv&#41;]&#41;
2088             || &#40;  SvPADSTALE&#40;sv&#41; &#38;&#38; !SvPAD_STATE&#40;namesv&#41;
2089                &#38;&#38; &#40;!outside || !CvDEPTH&#40;outside&#41;&#41;&#41;  &#41; {
2090                S_unavailable&#40;aTHX_ namesv&#41;;
2091                sv = NULL;
2092            }
2093            else 
2094                SvREFCNT_inc_simple_void_NN&#40;sv&#41;;

This would somehow seem to fit together. What I suspect is happening is that either `outpad` contains a silly junk value, or it&#39;s valid but not as big as the large index that `PARENT_PAD_INDEX&#40;namesv&#41;` is giving it.

I have had issues with that macro before, it feels familiar...

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;03&nbsp;16:53:02&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Inserted code into pad.c just above that section:

                warn&#40;&#34;D1: proto=%p cv=%p ix=%d outpad=%p PPI=%d\n&#34;,
                        proto, cv, ix, outpad, PARENT_PAD_INDEX&#40;namesv&#41;&#41;;

I now get output:

...
ok 3 - Failure from -&gt;add_slot on empty string
D1: proto=63e6bc0 cv=623e988 ix=1 outpad=6400300 PPI=1
D1: proto=63828b8 cv=63f3828 ix=14 outpad=63dc460 PPI=1
ok 4 - Failure from -&gt;add_slot without sigil
D1: proto=63e6f20 cv=6402528 ix=1 outpad=6400300 PPI=1
D1: proto=63828b8 cv=6382870 ix=14 outpad=63dc460 PPI=1
ok 5 - Failure from -&gt;add_slot duplicate
D1: proto=6402d20 cv=6403038 ix=3 outpad=642a840 PPI=4600
==4100688== Invalid read of size 8
==4100688==    at 0x1F502C: S_cv_clone_pad &#40;pad.c:2089&#41;
==4100688==    by 0x1F5EE6: S_cv_clone &#40;pad.c:2196&#41;

Looking at those values, it feels like outpad is correct, but PARENT_PAD_INDEX&#40;&#41; is indeed giving a silly value.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;04&nbsp;09:13:40&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">After much hunting, it turns out that the code was forgetting to clear PadnameOUTER&#40;&#41; while patching up the PARENT_PAD_INDEX&#40;&#41; fields, if the outside padname wasn&#39;t itself OUTER.

Unclear why newer perls didn&#39;t get upset about it, but never mind...

Fixed by attached patch.

-- 

Paul Evans
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rt132814.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">=== modified file &#39;hax/perl-additions.c.inc&#39;
--- old/hax/perl-additions.c.inc	2020-10-09 16:24:33 +0000
+++ new/hax/perl-additions.c.inc	2020-11-04 14:08:25 +0000
@@ -10,6 +10,13 @@
 #  define PadnameIsNULL&#40;pn&#41;  &#40;!&#40;pn&#41; || &#40;pn&#41; == &#38;PL_sv_undef&#41;
 #endif
 
+#if HAVE_PERL_VERSION&#40;5, 22, 0&#41;
+#  define PadnameOUTER_off&#40;pn&#41;  &#40;PadnameFLAGS&#40;pn&#41; &#38;= ~PADNAMEt_OUTER&#41;
+#else
+   /* PadnameOUTER is really the SvFAKE flag */
+#  define PadnameOUTER_off&#40;pn&#41;  SvFAKE_off&#40;pn&#41;
+#endif
+
 #define save_strndup&#40;s, l&#41;  S_save_strndup&#40;aTHX_ s, l&#41;
 static char *S_save_strndup&#40;pTHX_ char *s, STRLEN l&#41;
 {

=== modified file &#39;lib/Object/Pad.xs&#39;
--- old/lib/Object/Pad.xs	2020-11-02 18:21:05 +0000
+++ new/lib/Object/Pad.xs	2020-11-04 14:08:25 +0000
@@ -2086,6 +2086,8 @@
       PADNAME *outside_pn = PadnamelistARRAY&#40;outside_pnl&#41;[PARENT_PAD_INDEX&#40;pn&#41;];
 
       PARENT_PAD_INDEX_set&#40;pn, PARENT_PAD_INDEX&#40;outside_pn&#41;&#41;;
+      if&#40;!PadnameOUTER&#40;outside_pn&#41;&#41;
+        PadnameOUTER_off&#40;pn&#41;;
     }
 
     CvOUTSIDE&#40;PL_compcv&#41;     = CvOUTSIDE&#40;outside&#41;;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;04&nbsp;09:13:40&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;04&nbsp;17:01:33&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Released in 0.34

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;04&nbsp;17:01:33&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;04&nbsp;17:01:33&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Fixed in 0.34 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
