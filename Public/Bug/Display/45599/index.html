<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #45599 for Tk: Problem with SelectionGet</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #45599 for Tk: Problem with SelectionGet</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Tk/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Tk/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Tk/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Tk/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Tk">Tk CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">45599</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Tk/Active/">Tk</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
KWittrock [...] web.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-33610-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-33611-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;30&nbsp;11:14:08&nbsp;2009</span>
    <span class="description">KWittrock [...] web.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Problem with SelectionGet</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 30 Apr 2009 14:05:45 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-Tk [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;K. Wittrock&#34; &lt;KWittrock [...] web.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I type ctrl-C to bring a multiline Text to the clipboard and then use
    $sel = $mainwindow-&gt;SelectionGet&#40;-selection =&gt; &#39;CLIPBOARD&#39;&#41;;
to fetch it into my program. The retrieved Text is followed by some garbage characters. These consist of an ASCII NUL, followed by 
the last characters of the text. The number of garbage characters equals the number of newlines in the text.

I can remedy this by adding
    $sel =~ s/\0.*//s;
to my script, but I would prefer a solution within SelectionGet&#40;&#41;.

My software is Windows XP Home with SP3, ActivePerl version 5.8.8, and perl/Tk version 804.027.

Kind regards

Klaus Wittrock
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;13&nbsp;06:12:44&nbsp;2009</span>
    <span class="description">lamprecht [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">here is a patch against subversion

C:\devel\Tk\pTk\mTk\win\tkWinClipboard.c

Seems to work here &#40;Strawbwerry&#41; - all tests pass. 
Could anybody review and confirm?

Cheers, Christoph Lamprecht
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: tkWinClipboard.c
===================================================================
--- tkWinClipboard.c	&#40;revision 12718&#41;
+++ tkWinClipboard.c	&#40;working copy&#41;
@@ -146,23 +146,28 @@
     /*
      * Translate CR/LF to LF.
      */
-	
+
+    int string_length = 0;
+    
     data = destPtr = Tcl_DStringValue&#40;&#38;ds&#41;;
     while &#40;*data&#41; {
 	if &#40;data[0] == &#39;\r&#39; &#38;&#38; data[1] == &#39;\n&#39;&#41; {
 	    data++;
 	} else {
 	    *destPtr++ = *data++;
+            string_length ++;
 	}
     }
+    
+    Tcl_DStringTrunc&#40;&#38;ds, string_length&#41;;
+    
     *destPtr = &#39;\0&#39;;
 
     /*
      * Pass the data off to the selection procedure.
      */
-
     result = &#40;*proc&#41;&#40;clientData, interp, &#40;long *&#41; Tcl_DStringValue&#40;&#38;ds&#41;,
-                     Tcl_DStringLength&#40;&#38;ds&#41;,8,target,tkwin&#41;;
+                          Tcl_DStringLength&#40;&#38;ds&#41;,8,target,tkwin&#41;;
     Tcl_DStringFree&#40;&#38;ds&#41;;
     CloseClipboard&#40;&#41;;
     return result;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;13&nbsp;06:12:45&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;15&nbsp;11:12:02&nbsp;2009</span>
    <span class="description">KWittrock [...] web.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #45599] Problem with SelectionGet </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 15 May 2009 16:52:15 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-Tk [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;K. Wittrock&#34; &lt;KWittrock [...] web.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Christoph,

sorry, I don&#39;t have a C compiler. I really apologize.

Greetings

Klaus

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">----- Original Message ----- 
From: &#34;Lamprecht Christoph via RT&#34; &lt;bug-Tk@rt.cpan.org&gt;
To: &lt;KWittrock@web.de&gt;
Sent: Wednesday, May 13, 2009 12:12 PM
Subject: [rt.cpan.org #45599] Problem with SelectionGet 
 
<div class="message-stanza open">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=45599">https://rt.cpan.org/Ticket/Display.html?id=45599</a></span> &gt;
&gt; 
&gt; here is a patch against subversion
&gt; 
&gt; C:\devel\Tk\pTk\mTk\win\tkWinClipboard.c
&gt; 
&gt; Seems to work here &#40;Strawbwerry&#41; - all tests pass. 
&gt; Could anybody review and confirm?
&gt; 
&gt; Cheers, Christoph Lamprecht
&gt; 
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;17&nbsp;17:38:22&nbsp;2009</span>
    <span class="description">SREZIC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri May 15 11:12:02 2009, KWittrock@web.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hello Christoph,
&gt; 
&gt; sorry, I don&#39;t have a C compiler. I really apologize.
&gt; 
&gt; 
</div>
You can install Strawberry Perl for Windows. This one comes with a C
compiler bundled.

Regards,
    Slaven
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;02&nbsp;16:21:37&nbsp;2010</span>
    <span class="description">SREZIC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed May 13 06:12:44 2009, LAMPRECHT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; here is a patch against subversion
&gt; 
&gt; C:\devel\Tk\pTk\mTk\win\tkWinClipboard.c
&gt; 
&gt; Seems to work here &#40;Strawbwerry&#41; - all tests pass. 
&gt; Could anybody review and confirm?
&gt; 
&gt; Cheers, Christoph Lamprecht
</div>
Klaus or Christoph, can you describe exactly how to reproduce the
problem? I just tried it on a Windows XP system, with Strawberry Perl
and Tk 804.028_502, but cannot reproduce it.

Regards,
    Slaven
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;02&nbsp;16:21:41&nbsp;2010</span>
    <span class="description">SREZIC [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;05&nbsp;09:57:16&nbsp;2010</span>
    <span class="description">KWittrock [...] web.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #45599] Problem with SelectionGet</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 05 Feb 2010 14:53:50 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tk [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;K. Wittrock&#34; &lt;KWittrock [...] web.de&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">

Slaven_Rezic via RT schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=45599">https://rt.cpan.org/Ticket/Display.html?id=45599</a></span> &gt;
&gt; 
&gt; On Wed May 13 06:12:44 2009, LAMPRECHT wrote:
<div class="message-stanza open">&gt;&gt; here is a patch against subversion
&gt;&gt;
&gt;&gt; C:\devel\Tk\pTk\mTk\win\tkWinClipboard.c
&gt;&gt;
&gt;&gt; Seems to work here &#40;Strawbwerry&#41; - all tests pass. 
&gt;&gt; Could anybody review and confirm?
&gt;&gt;
&gt;&gt; Cheers, Christoph Lamprecht
</div>&gt; 
&gt; Klaus or Christoph, can you describe exactly how to reproduce the
&gt; problem? I just tried it on a Windows XP system, with Strawberry Perl
&gt; and Tk 804.028_502, but cannot reproduce it.
</div>
Please find attached a small test program. For best results, I suggest that you use a text with several short lines &#40;gives much garbage&#41;, followed by a long line &#40;gives a nearly correct newline count in the test, due to few newlines in the garbage&#41;. Usage: put the text to the clipboard, then start the test script.

For obvious reasons, this error doesn&#39;t exist on Linux.

HTH

Klaus
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;

use Tk;

my $mw = MainWindow-&gt;new;
my $sel = $mw-&gt;SelectionGet&#40;-selection =&gt; &#39;CLIPBOARD&#39;&#41;;

#=for test
print &#34;No. of Newlines &#40;incl. those in the garbage&#41; &#34;, $sel =~ tr/\n/\n/, &#34;\n&#34;;
print &#34;\nContents of selection +$sel+\n&#34;;
	printf &#34;Contents in hex:\n%v.2x\n&#34;, $sel;

# Remove garbage at end
$sel =~ s/\0.*//s;

print &#34;\n&#34;, &#39;Now removed garbage at end by $sel =~ s/\0.*//s;&#39;, &#34;\n&#34;;

#=for test
print &#34;\nContents of selection +$sel+\n&#34;;
	printf &#34;Contents in hex:\n%v.2x\n&#34;, $sel;

=cut

MainLoop;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;05&nbsp;09:57:16&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
