<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #87459 for DBIx-Timeout: [PATCH] sharing a dbh across a fork causes libmysql to hang</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #87459 for DBIx-Timeout: [PATCH] sharing a dbh across a fork causes libmysql to hang</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBIx-Timeout/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBIx-Timeout/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBIx-Timeout/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBIx-Timeout/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBIx-Timeout">DBIx-Timeout CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">87459</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBIx-Timeout/Active/">DBIx-Timeout</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
DSTERLING [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-40912-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
1.00</li>
<li>
1.01</li>
</ul>
    </td>
  </tr>
  <tr id="CF-40913-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;30&nbsp;15:49:12&nbsp;2013</span>
    <span class="description">DSTERLING [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] sharing a dbh across a fork causes libmysql to hang</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Forking and sharing a dbh in the child and parent can cause the libmysql code to hang.

This patch fixes the issue by accepting a new, optional dbh_callback argument, which is used by both the child and parent to get a new dbh. The parent then passes the thread id to the child, so it can kill the right thread.

The calling code should disconnect all open dbh handles before calling the call_with_timeout method.

This patch also includes the code for ticket #75279
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dbixtimeout-callback.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Only in DBIx-Timeout-1.01/lib/DBIx: ._Timeout.pm
diff -ru DBIx-Timeout-1.01.orig/lib/DBIx/Timeout.pm DBIx-Timeout-1.01/lib/DBIx/Timeout.pm
--- DBIx-Timeout-1.01.orig/lib/DBIx/Timeout.pm	2012-02-24 11:36:02.000000000 -0500
+++ DBIx-Timeout-1.01/lib/DBIx/Timeout.pm	2013-07-30 15:43:48.272371745 -0400
@@ -10,6 +10,7 @@
 use Params::Validate qw&#40;validate CODEREF&#41;;
 use Carp qw&#40;croak&#41;;
 use POSIX qw&#40;_exit&#41;;
+use IO::Pipe;
 
 our $TIMEOUT_EXIT_CODE = 29;
 
@@ -18,17 +19,20 @@
 
     my %args =
       validate&#40;@_,
-               {dbh     =&gt; {isa  =&gt; &#39;DBI::db&#39;},
+               {dbh     =&gt; { isa  =&gt; &#39;DBI::db&#39;, optional =&gt; 1 },
                 code    =&gt; {type =&gt; CODEREF},
-                timeout =&gt; 1
+                timeout =&gt; 1,
+                dbh_callback =&gt; { type =&gt; CODEREF, optional =&gt; 1 },
                }&#41;;
-    my &#40;$dbh, $code, $timeout&#41; = @args{&#40;&#39;dbh&#39;, &#39;code&#39;, &#39;timeout&#39;&#41;};
+    my &#40;$dbh, $code, $timeout, $dbh_callback&#41; =
+        @args{&#40;&#39;dbh&#39;, &#39;code&#39;, &#39;timeout&#39;, &#39;dbh_callback&#39;&#41;};
 
-    my $child_pid = $pkg-&gt;_fork_child&#40;$dbh, $timeout&#41;;
+    my $child_pid;
+    &#40;$child_pid, $dbh&#41; = $pkg-&gt;_fork_child&#40;$dbh, $timeout, $dbh_callback&#41;;
 
     # run code, trapping error since it may have come from the timeout
     # connection killing
-    eval { $code-&gt;&#40;&#41; };
+    eval { $code-&gt;&#40;$dbh&#41; };
     my $err = $@;
 
     # signal the child that processing is done - will wake up from
@@ -55,7 +59,7 @@
 
 # forks off the child process
 sub _fork_child {
-    my &#40;$pkg, $dbh, $timeout&#41; = @_;
+    my &#40;$pkg, $dbh, $timeout, $dbh_callback&#41; = @_;
 
     # pull a list of active handles for use after the fork
     my %drivers    = DBI-&gt;installed_drivers&#40;&#41;;
@@ -63,10 +67,28 @@
       grep { $_ and $_-&gt;isa&#40;&#39;DBI::db&#39;&#41; and $_-&gt;{Active} }
       map { @{$_-&gt;{ChildHandles}} } values %drivers;
 
-    # do the fork, return in the parent
+    # create pipe and fork
+    my $pipe = IO::Pipe-&gt;new&#40;&#41;;
     my $child_pid = fork&#40;&#41;;
     croak&#40;&#34;Failed to fork&#40;&#41;: $!&#34;&#41; unless defined $child_pid;
-    return $child_pid if $child_pid;
+
+    # in the parent, send the child the dbh thread id
+    if &#40;$child_pid&#41; {
+        # grab a dbh if we have a callback to do so
+        if &#40;$dbh_callback&#41; {
+            $dbh = $dbh_callback-&gt;&#40;&#41;;
+        }
+        my $thread_id = $dbh-&gt;{thread_id};
+        $pipe-&gt;writer&#40;&#41;;
+        print $pipe $thread_id, &#34;\n&#34;;
+        # return in the parent
+        return &#40;$child_pid, $dbh&#41;;
+    }
+
+    # in the child, grab the thread id
+    $pipe-&gt;reader&#40;&#41;;
+    my $thread_id = readline&#40;$pipe&#41;;
+    chomp&#40;$thread_id&#41;;
 
     # do the dance needed to keep open DBI connections from causing
     # errors when this child exits
@@ -81,12 +103,19 @@
     # now running in the child, sleep for $timeout seconds
     sleep $timeout;
 
+    # woke up, time to kill parent&#39;s thread
+
     # turn off USR1 handler, signalling now won&#39;t kill us in the
     # middle of killing the parent&#39;s thread
     $SIG{USR1} = &#39;IGNORE&#39;;
 
-    # woke up, time to kill parent&#39;s thread
-    $pkg-&gt;_kill_connection&#40;$dbh&#41;;
+    # grab a dbh if we have a callback to do so
+    if &#40;$dbh_callback&#41; {
+        $dbh = $dbh_callback-&gt;&#40;&#41;;
+    }
+
+    # kill
+    $pkg-&gt;_kill_connection&#40;$dbh, $thread_id&#41;;
 
     # tell the parent what happened &#40;use POSIX::_exit&#40;&#41; to make sure
     # the parent really gets the message - otherwise END blocks can
@@ -97,9 +126,11 @@
 
 # MySQL specific thread-killer
 sub _kill_connection {
-    my &#40;$self, $dbh&#41; = @_;
+    my &#40;$self, $dbh, $thread_id&#41; = @_;
 
-    my $thread_id = $dbh-&gt;{thread_id};
+    unless &#40;$thread_id&#41; {
+        $thread_id = $dbh-&gt;{thread_id};
+    }
 
     my $new_dbh = $dbh-&gt;clone&#40;&#41;;
     $new_dbh-&gt;{InactiveDestroy} = 0;
@@ -202,6 +233,24 @@
 either case the connection for C&lt;$dbh&gt; may be killed after this method
 returns.
 
+=head2 dbh callback
+
+Sharing a database handle across forked processes can confuse the database
+client library, so DBIx::Timeout can use a callback to grab a dbh instead:
+
+  $ok = DBIx::Timeout-&gt;call_with_timeout&#40;
+    dbh_callback =&gt; sub { get_my_dbh&#40;&#41; },
+    code    =&gt; sub { my $dbh = shift; $dbh-&gt;do&#40;&#39;LONG-RUNNING SQL HERE&#39;&#41; },
+    timeout =&gt; 300,
+  &#41;;
+
+When using this method, DBIx::Timeout forks first, then grabs a fresh dbh in
+both the parent and child. The parent then sends the thread id to kill to the
+child. The parent&#39;s dbh is provided as an argument to your callback code.
+
+When using this method, the calling code should disconnect all active
+database handles before calling C&lt;call_with_timeout&gt;.
+
 =head1 KNOWN ISSUES
 
 When the timeout fires a warning may occur that looks like:
Only in DBIx-Timeout-1.01/lib/DBIx: Timeout.pm~
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;30&nbsp;15:51:10&nbsp;2013</span>
    <span class="description">DSTERLING [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jul 30 15:49:12 2013, DSTERLING wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This patch also includes the code for ticket #75279
</div>
Whoops, no, this is wrong. We are using this code and the code from ticket #75279 in production; this patch builds on that patch but does not duplicate it.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
