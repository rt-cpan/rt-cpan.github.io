<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #64917 for Storable-AMF: Boolean support, TO_AMF hook</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #64917 for Storable-AMF: Boolean support, TO_AMF hook</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Storable-AMF/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Storable-AMF/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Storable-AMF/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Storable-AMF/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Storable-AMF">Storable-AMF CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">64917</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Storable-AMF/Active/">Storable-AMF</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
adam_lounds [...] hotmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-224652-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.88    </td>
  </tr>
  <tr id="CF-224653-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;19&nbsp;04:27:20&nbsp;2011</span>
    <span class="description">adam_lounds [...] hotmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Boolean support, TO_AMF hook</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Firstly, thank you so much for this module!

We are using booleans extensively for both JSON-RPC and AMF, so wanted a way to be able 
to roundtrip booleans in AMF. We also missed the TO_JSON functionality from JSON::XS.

I made a patch to implement these, it&#39;s pretty rough but works for our internal use.
 * Freezes &#39;boolean&#39; perl objects to AMF boolean
 * Freezes JSON::XS boolean objects to AMF boolean
 * calls TO_AMF method on an object if present as a freeze hook &#40;code based on JSON::XS&#41;
 * Thaws AMF boolean to JSON::XS boolean objects

The test suite now fails on two main points:

 * 01 fails as booleans are not thawing to 1/0 as expected &#40;they are JSON::XS booleans&#41;
 * 01, 46, 48 and 53 fail as they need to use JSON::XS.

I did not implement the changes for AMF3, only AMF0, and the creation of JSON::XS objects 
on thaw should really be an option.

Hope this helps anyone using this wonderful module.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> AMF.xs.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Storable-AMF-0.88/lib/Storable/AMF.xs	2010-11-27 20:02:57.000000000 +0000
+++ Storable-AMF-0.88_patch/lib/Storable/AMF.xs	2011-01-18 22:40:50.000000000 +0000
@@ -589,7 +589,31 @@
             ++io-&gt;RV_COUNT;
 
             if &#40;sv_isobject&#40;one&#41;&#41; {
-                if &#40;SvTYPE&#40;rv&#41; == SVt_PVHV&#41;{
+                GV *to_amf = gv_fetchmethod_autoload &#40;SvSTASH &#40;rv&#41;, &#34;TO_AMF&#34;, 0&#41;;
+                if &#40; to_amf &#41; {
+                  dSP;
+
+                  ENTER; SAVETMPS; PUSHMARK &#40;SP&#41;;
+                  XPUSHs &#40;sv_bless &#40;sv_2mortal &#40;newRV_inc &#40;rv&#41;&#41;, SvSTASH &#40;rv&#41;&#41;&#41;;
+
+                  // calling with G_SCALAR ensures that we always get a 1 return value
+                  PUTBACK;
+                  call_sv &#40;&#40;SV *&#41;GvCV &#40;to_amf&#41;, G_SCALAR&#41;;
+                  SPAGAIN;
+
+                  // catch this surprisingly common error
+                  if &#40;SvROK &#40;TOPs&#41; &#38;&#38; SvRV &#40;TOPs&#41; == rv&#41;
+                    croak &#40;&#34;%s::TO_AMF method returned same object as was passed instead of a new one&#34;, HvNAME &#40;SvSTASH &#40;rv&#41;&#41;&#41;;
+
+                  rv = POPs;
+                  PUTBACK;
+
+                  //--io-&gt;RV_COUNT;
+                  format_one&#40; aTHX_  io, rv&#41;;
+
+                  FREETMPS; LEAVE;
+                }
+                else if &#40;SvTYPE&#40;rv&#41; == SVt_PVHV&#41;{
                     format_typed_object&#40;aTHX_  io, &#40;HV *&#41; rv&#41;;
                 }
 		else if &#40; util_is_date&#40; rv &#41; &#41; {
@@ -597,6 +621,14 @@
 		    io_write_double&#40;aTHX_ io, util_date_time&#40; rv &#41;&#41;;
 		    io_write_s16&#40;aTHX_ io, 0 &#41;;
 		}
+                else if &#40;sv_isa&#40;one, &#34;boolean&#34;&#41;&#41; {
+                    io_write_marker&#40;aTHX_ io, MARKER0_BOOLEAN &#41;;
+                    io_write_u8&#40;aTHX_  io, SvIV&#40;SvRV&#40;one&#41;&#41;&#41;;
+                }
+                else if &#40;sv_isa&#40;one, &#34;JSON::XS::Boolean&#34;&#41;&#41; {
+                    io_write_marker&#40;aTHX_ io, MARKER0_BOOLEAN &#41;;
+                    io_write_u8&#40;aTHX_  io, SvIV&#40;SvRV&#40;one&#41;&#41;&#41;;
+                }
 		else {		    
                     // may be i has to format as undef
                     io_register_error&#40;io, ERR_BAD_OBJECT&#41;;
@@ -1285,7 +1317,33 @@
 STATIC_INLINE SV* parse_boolean&#40;pTHX_ struct io_struct * io&#41;{
     char marker;
     marker = io_read_marker&#40;io&#41;;
-    return newSViv&#40;marker == &#39;\000&#39; ? 0 :1&#41;;
+
+    int count;
+    SV *value = 0;
+    SAVETMPS;
+
+    dSP;
+
+    ENTER; SAVETMPS; PUSHMARK &#40;SP&#41;;
+    PUTBACK;
+    if &#40; marker == &#39;\000&#39; &#41; {
+        count = call_pv&#40;&#34;JSON::XS::false&#34;, G_SCALAR&#41;;
+    }
+    else {
+        count = call_pv&#40;&#34;JSON::XS::true&#34;, G_SCALAR&#41;;
+    }
+    SPAGAIN;
+    if &#40;count == 1&#41;
+        value = newSVsv&#40;POPs&#41;;
+
+    if &#40;count != 1 || !SvOK&#40;value&#41;&#41; {
+        // fallback, return 0/1
+        value = newSViv&#40; marker == &#39;\000&#39; ? 0 : 1 &#41;;
+    }
+
+    PUTBACK;
+    FREETMPS; LEAVE;
+    return value;
 }
 
 inline SV * amf3_parse_one&#40;pTHX_ struct io_struct *io&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;19&nbsp;09:05:33&nbsp;2011</span>
    <span class="description">0body1 [...] rambler.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #64917] Boolean support, TO_AMF hook</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 19 Jan 2011 17:05:20 +0300</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Storable-AMF [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Anatoliy Grishayev &lt;0body1 [...] rambler.ru&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">19.01.2011 12:27, adam_lounds@hotmail.com via RT пишет:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Wed Jan 19 04:27:20 2011: Request 64917 was acted upon.
&gt; Transaction: Ticket created by adam_lounds@hotmail.com
&gt;         Queue: Storable-AMF
&gt;       Subject: Boolean support, TO_AMF hook
&gt;     Broken in: 0.88
&gt;      Severity: Wishlist
&gt;         Owner: Nobody
&gt;    Requestors: adam_lounds@hotmail.com
&gt;        Status: new
&gt;   Ticket&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=64917">https://rt.cpan.org/Ticket/Display.html?id=64917</a></span>&gt;
&gt;
&gt;
&gt; Firstly, thank you so much for this module!
&gt;
&gt; We are using booleans extensively for both JSON-RPC and AMF, so wanted a way to be able
&gt; to roundtrip booleans in AMF. We also missed the TO_JSON functionality from JSON::XS.
&gt;
&gt; I made a patch to implement these, it&#39;s pretty rough but works for our internal use.
&gt;   * Freezes &#39;boolean&#39; perl objects to AMF boolean
&gt;   * Freezes JSON::XS boolean objects to AMF boolean
&gt;   * calls TO_AMF method on an object if present as a freeze hook &#40;code based on JSON::XS&#41;
&gt;   * Thaws AMF boolean to JSON::XS boolean objects
&gt;
&gt; The test suite now fails on two main points:
&gt;
&gt;   * 01 fails as booleans are not thawing to 1/0 as expected &#40;they are JSON::XS booleans&#41;
&gt;   * 01, 46, 48 and 53 fail as they need to use JSON::XS.
&gt;
&gt; I did not implement the changes for AMF3, only AMF0, and the creation of JSON::XS objects
&gt; on thaw should really be an option.
&gt;
&gt; Hope this helps anyone using this wonderful module.
</div>
Okay, but I have some questions about implementation
1&#41;  Did you have a test or tests  for your functionality?
2&#41; What a &#39;boolean&#39; object  you are using
3&#41; Are you never using tagged objects in AMF &#40; like typeid object string 
&#41; see parse_typed_object&#40;&#41;
4&#41; It easy add your functionality as option to thaw and freeze so It 
need a proper name for the option.

Best Regards, Anatoly
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;19&nbsp;09:05:34&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;19&nbsp;09:36:56&nbsp;2011</span>
    <span class="description">adam_lounds [...] hotmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> adam_lounds [...] hotmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Okay, but I have some questions about implementation
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 1&#41;  Did you have a test or tests  for your functionality?
</div>
I did write some during dev but not up to the same standard as yours

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2&#41; What a &#39;boolean&#39; object  you are using
</div>
The patch supports freezing of boolean.pm &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~ingy/boolean-">http://search.cpan.org/~ingy/boolean-</a></span>
0.25/lib/boolean.pm&#41; and JSON::XS &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~mlehmann/JSON-XS-2.3/&#41;">http://search.cpan.org/~mlehmann/JSON-XS-2.3/&#41;</a></span> 
objects, and thaws AMF0 boolean values to JSON::XS::true or JSON::XS::false.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 3&#41; Are you never using tagged objects in AMF &#40; like typeid object string &#41; see 
</div>parse_typed_object&#40;&#41;

Not at the moment, no. As I understand it any object without TO_AMF&#40;&#41; will fall through to 
the existing behaviour. make test still passes but I&#39;m not sure if there are any tests for tagged 
objects?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 4&#41; It easy add your functionality as option to thaw and freeze so It
&gt; need a proper name for the option.
</div> 
Sure. TBH we needed it internally &#38; the patch was more in case anyone else needed it.

I&#39;m pretty sure that the freezing of boolean/JSON::XS objects to AMF0 boolean is transparent 
- without thawing to JSON::XS they will end up as 1/0 as that&#39;s how AMF0 booleans currently 
thaw, so I don&#39;t think that freezing of booleans requires an option.

JSON::XS has a convert_blessed option which enables calling TO_JSON, mongodb has 
$MongoDB::BSON::use_boolean = 1 which enables thawing BSON bools as boolean.pm objects

The TO_AMF support could be $Storable::AMF::convert_blessed as per JSON::XS, and thawing 
to JSON::XS bools could be $Storable::AMF::use_json_xs &#40;or $Storable::AMF::use_boolean for 
thawing to boolean.pm bools&#41;

Also note that I did not touch the AMF3 parts of the code, so the new features do not 
currently work in AMF3 mode.

Thanks again,
-- 
Adam
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;20&nbsp;08:57:54&nbsp;2011</span>
    <span class="description">adam_lounds [...] hotmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> adam_lounds [...] hotmail.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ugh. Sorry about this - the original patch doesn&#39;t work if you have 
multiple true/false values, as booleans cannot be referenced as AMF 
objects.

I have refactored to avoid adding booleans to the HV_HASH and to avoid 
polluting HV_HASH with objects that have TO_AMF, but I&#39;m not entirely 
sure it&#39;s bug-free, and the TO_AMF code feels bad in that I&#39;m having to 
recurse and return.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> AMF.xs.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Storable-AMF-0.88/lib/Storable/AMF.xs	2010-11-27 20:02:57.000000000 +0000
+++ Storable-AMF-0.88_patch/lib/Storable/AMF.xs	2011-01-20 11:27:06.000000000 +0000
@@ -576,45 +576,90 @@
 
 inline void format_one&#40;pTHX_ struct io_struct *io, SV * one&#41;{
 
-    if &#40;SvROK&#40;one&#41;&#41;{
+    if &#40; SvROK&#40;one&#41; &#38;&#38; sv_isobject&#40;one&#41; &#41; {
         SV * rv = &#40;SV*&#41; SvRV&#40;one&#41;;
-        // test has stored
-        SV **OK = hv_fetch&#40;io-&gt;RV_HASH, &#40;char *&#41;&#40;&#38;rv&#41;, sizeof &#40;rv&#41;, 1&#41;;
-        if &#40;SvOK&#40;*OK&#41;&#41; {
-            format_reference&#40;aTHX_  io, *OK&#41;;
+        GV *to_amf = gv_fetchmethod_autoload &#40;SvSTASH &#40;rv&#41;, &#34;TO_AMF&#34;, 0&#41;;
+        if &#40; to_amf &#41; {
+            dSP;
+
+            ENTER; SAVETMPS; PUSHMARK &#40;SP&#41;;
+            XPUSHs &#40;sv_bless &#40;sv_2mortal &#40;newRV_inc &#40;rv&#41;&#41;, SvSTASH &#40;rv&#41;&#41;&#41;;
+            PUTBACK;
+
+            // calling with G_SCALAR ensures that we always get a 1 return value
+            call_sv &#40;&#40;SV *&#41;GvCV &#40;to_amf&#41;, G_SCALAR&#41;;
+            SPAGAIN;
+
+            // catch this surprisingly common error
+            if &#40;SvROK &#40;TOPs&#41; &#38;&#38; SvRV &#40;TOPs&#41; == rv&#41;
+                croak &#40;&#34;%s::TO_AMF method returned same object as was passed instead of a new one&#34;, HvNAME &#40;SvSTASH &#40;rv&#41;&#41;&#41;;
+
+            SV *newsv = POPs;
+            // recurse rather than carrying on as we need to freetmps etc
+            format_one&#40; aTHX_  io, newsv&#41;;
+            PUTBACK;
+            FREETMPS; LEAVE;
+            return;
         }
-        else {
-            int type = SvTYPE&#40;rv&#41;;
-            sv_setiv&#40;*OK, io-&gt;RV_COUNT&#41;;
-            ++io-&gt;RV_COUNT;
+    }
+
+    bool is_perl_ref = SvROK&#40;one&#41; ? 1 : 0;
+    bool is_perl_bool = 0;
+    if &#40; is_perl_ref &#38;&#38; sv_isobject&#40;one&#41; &#41; {
+        if &#40; sv_isa&#40;one, &#34;boolean&#34;&#41; &#41; {
+            is_perl_bool = 1;
+        }
+        else if &#40; sv_isa&#40;one, &#34;JSON::XS::Boolean&#34;&#41; &#41; {
+            is_perl_bool = 1;
+        }
+    }
 
-            if &#40;sv_isobject&#40;one&#41;&#41; {
-                if &#40;SvTYPE&#40;rv&#41; == SVt_PVHV&#41;{
-                    format_typed_object&#40;aTHX_  io, &#40;HV *&#41; rv&#41;;
+    if &#40; is_perl_ref &#41;{
+        // Bools cannot be referenced
+        if &#40; is_perl_bool &#41; {
+            io_write_marker&#40;aTHX_ io, MARKER0_BOOLEAN &#41;;
+            io_write_u8&#40;aTHX_  io, SvIV&#40;SvRV&#40;one&#41;&#41;&#41;;
+        }
+        else {
+            SV * rv = &#40;SV*&#41; SvRV&#40;one&#41;;
+            // test has stored
+            SV **OK = hv_fetch&#40;io-&gt;RV_HASH, &#40;char *&#41;&#40;&#38;rv&#41;, sizeof &#40;rv&#41;, 1&#41;;
+            if &#40;SvOK&#40;*OK&#41;&#41; {
+                format_reference&#40;aTHX_  io, *OK&#41;;
+            }
+            else {
+                int type = SvTYPE&#40;rv&#41;;
+                sv_setiv&#40;*OK, io-&gt;RV_COUNT&#41;;
+                ++io-&gt;RV_COUNT;
+
+                if &#40;sv_isobject&#40;one&#41;&#41; {
+                    if &#40;SvTYPE&#40;rv&#41; == SVt_PVHV&#41;{
+                        format_typed_object&#40;aTHX_  io, &#40;HV *&#41; rv&#41;;
+                    }
+                    else if &#40; util_is_date&#40; rv &#41; &#41; {
+                        io_write_marker&#40;aTHX_ io, MARKER0_DATE &#41;;
+                        io_write_double&#40;aTHX_ io, util_date_time&#40; rv &#41;&#41;;
+                        io_write_s16&#40;aTHX_ io, 0 &#41;;
+                    }
+                    else {		    
+                        // may be i has to format as undef
+                        io_register_error&#40;io, ERR_BAD_OBJECT&#41;;
+                    }
                 }
-		else if &#40; util_is_date&#40; rv &#41; &#41; {
-		    io_write_marker&#40;aTHX_ io, MARKER0_DATE &#41;;
-		    io_write_double&#40;aTHX_ io, util_date_time&#40; rv &#41;&#41;;
-		    io_write_s16&#40;aTHX_ io, 0 &#41;;
-		}
-		else {		    
-                    // may be i has to format as undef
+                else if &#40;SvTYPE&#40;rv&#41; == SVt_PVAV&#41; 
+                    format_strict_array&#40;aTHX_  io, &#40;AV*&#41; rv&#41;;
+                else if &#40;SvTYPE&#40;rv&#41; == SVt_PVHV&#41; {
+                    io_write_marker&#40;aTHX_  io, MARKER0_OBJECT&#41;;
+                    format_object&#40;aTHX_  io, &#40;HV*&#41; rv&#41;;
+                }
+                else if &#40; type != SVt_PVCV &#38;&#38; type !=  SVt_PVGV &#41; {
+                    format_scalar_ref&#40;aTHX_  io, &#40;SV*&#41; rv&#41;;
+                }
+                else {
+                    io-&gt;message = &#34;bad type of object in stream&#34;;
                     io_register_error&#40;io, ERR_BAD_OBJECT&#41;;
                 }
             }
-            else if &#40;SvTYPE&#40;rv&#41; == SVt_PVAV&#41; 
-                format_strict_array&#40;aTHX_  io, &#40;AV*&#41; rv&#41;;
-            else if &#40;SvTYPE&#40;rv&#41; == SVt_PVHV&#41; {
-                io_write_marker&#40;aTHX_  io, MARKER0_OBJECT&#41;;
-                format_object&#40;aTHX_  io, &#40;HV*&#41; rv&#41;;
-            }
-            else if &#40; type != SVt_PVCV &#38;&#38; type !=  SVt_PVGV &#41; {
-                format_scalar_ref&#40;aTHX_  io, &#40;SV*&#41; rv&#41;;
-            }
-            else {
-                io-&gt;message = &#34;bad type of object in stream&#34;;
-                io_register_error&#40;io, ERR_BAD_OBJECT&#41;;
-            }
         }
     }
     else {
@@ -1285,7 +1330,33 @@
 STATIC_INLINE SV* parse_boolean&#40;pTHX_ struct io_struct * io&#41;{
     char marker;
     marker = io_read_marker&#40;io&#41;;
-    return newSViv&#40;marker == &#39;\000&#39; ? 0 :1&#41;;
+
+    int count;
+    SV *value = 0;
+    SAVETMPS;
+
+    dSP;
+
+    ENTER; SAVETMPS; PUSHMARK &#40;SP&#41;;
+    PUTBACK;
+    if &#40; marker == &#39;\000&#39; &#41; {
+        count = call_pv&#40;&#34;JSON::XS::false&#34;, G_SCALAR&#41;;
+    }
+    else {
+        count = call_pv&#40;&#34;JSON::XS::true&#34;, G_SCALAR&#41;;
+    }
+    SPAGAIN;
+    if &#40;count == 1&#41;
+        value = newSVsv&#40;POPs&#41;;
+
+    if &#40;count != 1 || !SvOK&#40;value&#41;&#41; {
+        // fallback, return 0/1
+        value = newSViv&#40; marker == &#39;\000&#39; ? 0 : 1 &#41;;
+    }
+
+    PUTBACK;
+    FREETMPS; LEAVE;
+    return value;
 }
 
 inline SV * amf3_parse_one&#40;pTHX_ struct io_struct *io&#41;;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 66-boolean.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use ExtUtils::testlib;
use Storable::AMF0 qw&#40;parse_option freeze thaw new_amfdate&#41;;
use Data::Dumper;
use Devel::Peek;
use JSON::XS;
use boolean;

my $total = 13;
#*CORE::GLOBAL::caller = sub { CORE::caller&#40;$_[0] + $Carp::CarpLevel + 1&#41; }; 
use warnings;
eval &#34;use Test::More tests=&gt;$total;&#34;;
warn $@ if $@;
my $nop = parse_option&#40;&#39;prefer_number&#39;&#41;;
our $var;

# constants
ok&#40; !is_amf_boolean &#40; !!1 &#41;,    &#39;perl bool context not converted&#40;t&#41;&#39;&#41;;
ok&#40; !is_amf_boolean &#40; !!0 &#41;,    &#39;perl bool context not converted&#40;f&#41;&#39;&#41;;
ok&#40; is_amf_boolean &#40; true &#41;,   &#39;&#34;boolean&#34; true&#39;&#41;;
ok&#40; is_amf_boolean &#40; false &#41;,   &#39;&#34;boolean&#34; false&#39;&#41;;
ok&#40; is_amf_boolean &#40; JSON::XS::true &#41;,   &#39;JSON::XS::true&#39;&#41;;
ok&#40; is_amf_boolean &#40; JSON::XS::false &#41;,   &#39;JSON::XS::false&#39;&#41;;

# Vars
ok&#40; !is_amf_boolean &#40; $a = 4 &#41;,      &#39;int var&#39;&#41;;
ok&#40; !is_amf_boolean &#40; $a = 4.0 &#41;, &#39;double var&#39;&#41;;
ok&#40; !is_amf_boolean &#40; $a = &#34;4&#34; &#41;,     &#39;str var&#39;&#41;;
ok&#40; is_amf_boolean &#40;  $a = JSON::XS::true &#41;,  &#39;JSON::XS bool var&#39;&#41;;
ok&#40; is_amf_boolean &#40;  $a = true &#41;,  &#39;boolean var&#39;&#41;;

# booleans cannot be referenced in amf
my $object = {
    a =&gt; {a =&gt; 1},
    jxb1 =&gt; JSON::XS::true,
    jxb2 =&gt; JSON::XS::true,
    c =&gt; {a =&gt; 1, jxb3 =&gt; JSON::XS::true },
};
is_deeply&#40; amf_roundtrip&#40;$object&#41;, $object, &#34;roundtrip multi-bool&#34; &#41;;

is_deeply&#40; amf_roundtrip&#40; true &#41;, JSON::XS::true, &#39;&#34;boolean&#34; comes back as JSON::XS&#39; &#41;;

sub is_amf_boolean{
	ord&#40; freeze&#40; $_[0], $_[1]||0 &#41;&#41; == 1;
}
sub amf_roundtrip {
    my $src = shift;
    #use Data::Dumper;
    #print &#34;src: &#34;, Dumper&#40;$src&#41;;
	my $amf = freeze&#40; $src &#41;;
    #diag&#40; &#34;stored: $amf&#34; &#41;;
    #diag&#40; &#34;stored&#40;hex&#41;: &#34;, unpack&#40;&#34;H*&#34;, $amf&#41; &#41;;
    my $struct = thaw&#40;$amf&#41;;
    #diag&#40;Dumper&#40;$struct&#41;&#41;;
    return $struct;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;20&nbsp;09:43:49&nbsp;2011</span>
    <span class="description">adam_lounds [...] hotmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> adam_lounds [...] hotmail.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry, missed the test for TO_AMF
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 67-toamf.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use lib &#39;t&#39;;
use strict;
use warnings;
use ExtUtils::testlib;
use Storable::AMF0;
eval &#39;use Test::More tests =&gt; 4;&#39;;

sub serialize{
	my @values = Storable::AMF0::freeze&#40;$_[0]&#41;;
	if &#40;@values != 1&#41; {
		print STDERR &#34;many returned values\n&#34;;
	}
	return $values[0];
}
package Test::ToAMF;

sub new{
	bless {foo =&gt; &#39;bar&#39;};
}

sub TO_AMF {
    return { %{ $_[0] }, a =&gt; 1 };
}

package main;
sub MyDump{
	join &#34;&#34;, map { ord &gt;31 ? $_ : &#34;\\x&#34;. unpack &#34;H*&#34;, $_ }  split &#34;&#34;, $_[0];
}
my $obj = Test::ToAMF-&gt;new&#40;&#41;;
my $bank = serialize&#40;$obj&#41;;
my $newobj = Storable::AMF0::thaw&#40;$bank&#41;;
ok&#40;defined&#40;$bank&#41;, &#39;froze ok&#39; &#41;;
ok&#40;defined&#40;$newobj&#41;, &#39;thawed ok&#39; &#41;;

my $expected = { foo =&gt; &#39;bar&#39;, a =&gt; 1 };
is_deeply&#40; $newobj, $expected, &#39;thawed TO_AMF version&#39;&#41;;
is&#40;ref &#40;$newobj&#41;, &#39;HASH&#39;, &#39;TO_AMF version is unblessed&#39; &#41;;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;20&nbsp;11:06:07&nbsp;2011</span>
    <span class="description">0body1 [...] rambler.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #64917] Boolean support, TO_AMF hook</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 20 Jan 2011 19:05:57 +0300</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Storable-AMF [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Anatoliy Grishayev &lt;0body1 [...] rambler.ru&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">20.01.2011 17:43, adam_lounds@hotmail.com via RT пишет:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         Queue: Storable-AMF
&gt;   Ticket&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=64917">https://rt.cpan.org/Ticket/Display.html?id=64917</a></span>&gt;
&gt;
&gt; Sorry, missed the test for TO_AMF
&gt;
&gt;
</div>Thank you for all, especially for test, I will be add your patch a 
little latter, maybe at this weekend.

For now I am a little busy,  Sorry...

Anatoliy.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;21&nbsp;12:40:32&nbsp;2011</span>
    <span class="description">0body1 [...] rambler.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Alberto Reggiori &lt;areggiori [...] gmail.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #64917] Boolean support, TO_AMF hook</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 21 Jan 2011 20:39:58 +0300</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Storable-AMF [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Anatoliy Grishayev &lt;0body1 [...] rambler.ru&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">20.01.2011 19:06, Grian via RT пишет:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Added boolean.pm JSON::XS support. Code similiar to your patch with 
&gt; some modifications
</div>Usage :

use Storable::AMF0 0.89 qw&#40;freeze thaw&#41;;
use Storable::AMF0 0.89 qw&#40;parse_option&#41;; # For JSON::XS support
use boolean;
use JSON::XS;

$obj = {
        true =&gt; JSON::XS::true,
        false =&gt; boolean&#40; 0 &#41;,
};
freeze&#40; $obj, parse_option&#40; &#34;json_boolean&#34;&#41;&#41;;
thaw&#40;  $amf &#41;;


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks for tests, and code Anatoliy.
</div>
P.S. TO_AMF will add latter
P.S.S  add boolean AMF3 support.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;24&nbsp;07:56:48&nbsp;2011</span>
    <span class="description">0body1 [...] rambler.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #64917] Boolean support, TO_AMF hook</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 24 Jan 2011 15:56:36 +0300</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Storable-AMF [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Anatoliy Grishayev &lt;0body1 [...] rambler.ru&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">21.01.2011 20:40, Grian via RT пишет:

Added experimental TO_AMF support

Usage
use Storable::AMF::Mapper;
use Storable::AMF0 0.91 qw&#40;freeze thaw&#41;;

my $mapper = Storable::AMF::Mapper-&gt;new&#40; to_amf=&gt;1 &#41;;
my  $amf0 = freeze&#40; $obj, $mapper &#41;;


P.S. Need to change docs a little.
Mapper for now is not object, but may change  in future.

Best regards.
Anatoliy.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;24&nbsp;08:00:01&nbsp;2011</span>
    <span class="description">GRIAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed for now.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;24&nbsp;08:00:02&nbsp;2011</span>
    <span class="description">GRIAN [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
