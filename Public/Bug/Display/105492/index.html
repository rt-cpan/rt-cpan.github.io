<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #105492 for DBD-Pg: Poor performance with large amounts of placeholders.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #105492 for DBD-Pg: Poor performance with large amounts of placeholders.</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=DBD-Pg">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=DBD-Pg">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=DBD-Pg">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=DBD-Pg">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-Pg">DBD-Pg CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">105492</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=DBD-Pg">DBD-Pg</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">greg [...] turnstep.com
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mtyson [...] redhat.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10200-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10201-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




0001-DBD-Pg-Optimization-patch.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1653767/887500/0001-DBD-Pg-Optimization-patch.patch">
Fri Jul 29 11:17:42 2016 (32.5k) by ilmari+cpan [...] ilmari.org
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1560648/832941/0001-DBD-Pg-Optimization-patch.patch">
Thu Nov 19 22:59:12 2015 (32k) by mtyson [...] redhat.com
</a>
</font></li>
</ul>


0001-Optimize-DBD-Pg-for-queries-with-large-sets-of-place.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1511512/805945/0001-Optimize-DBD-Pg-for-queries-with-large-sets-of-place.patch">
Fri Jun 26 00:53:09 2015 (21.1k) by mtyson [...] redhat.com
</a>
</font></li>
</ul>


0002-Optimize-DBD-Pg-string-operations.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1512582/806549/0002-Optimize-DBD-Pg-string-operations.patch">
Sun Jun 28 19:56:41 2015 (9.4k) by mtyson [...] redhat.com
</a>
</font></li>
</ul>


0003-Optimize-DBD-Pg-string-operations-part-2.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1512586/806554/0003-Optimize-DBD-Pg-string-operations-part-2.patch">
Sun Jun 28 20:36:28 2015 (5.9k) by mtyson [...] redhat.com
</a>
</font></li>
</ul>


reproducer.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1511512/805946/reproducer.pl">
Fri Jun 26 00:53:09 2015 (492b) by mtyson [...] redhat.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=105492">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1511512" href="/Public/Bug/Display.html?id=105492#txn-1511512">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;26&nbsp;00:53:09&nbsp;2015</span>
    <span class="description">mtyson [...] redhat.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Poor performance with large amounts of placeholders.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 26 Jun 2015 14:52:53 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Pg [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Matt Tyson &lt;mtyson [...] redhat.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1511512/805944/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/805944">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 947b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I&#39;ve found a rather extreme case where our application will generate a
query with approx 20,000 &#39;?&#39; placeholders.

When DBD::Pg gets such a query, it spends a large amount of time &#40;3 - 5
seconds&#41; processing the query before dispatching it on to postgres.

I found this was due to the way placeholders are stored in linked lists.
 It essentially is a quadratic algorithm that becomes quite slow with
large lists.

I&#39;ve had a stab at optimizing the code to use an array and would like
your feedback on the patch.  It passes the test suite and I&#39;m not aware
of any changed behavior with the patch applied.

There&#39;s probably some more optimizing that can be done, however this is
a first pass.  The patch is against version 3.5.1

I&#39;ve attached a reproducer script that generates a query with 50,000
placeholders.

Without the patch, execution time is approx 20 seconds

With the patch, execution time is approx 900 milliseconds


Regards,
Matt.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1511512/805945/0001-Optimize-DBD-Pg-for-queries-with-large-sets-of-place.patch">Download 0001-Optimize-DBD-Pg-for-queries-with-large-sets-of-place.patch</a><br />
<span class="downloadcontenttype">text/x-diff 21.1k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1511512/805946/reproducer.pl">Download reproducer.pl</a><br />
<span class="downloadcontenttype">text/x-perl 492b</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1512582" href="/Public/Bug/Display.html?id=105492#txn-1512582">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;28&nbsp;19:56:41&nbsp;2015</span>
    <span class="description">mtyson [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #105492] AutoReply: Poor performance with large amounts of placeholders.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 29 Jun 2015 09:56:23 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Pg [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Matt Tyson &lt;mtyson [...] redhat.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1512582/806548/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/806548">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 632b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I&#39;ve made another pass and found another optimization that can be applied.

The way DBD::Pg builds the postgres version of the placeholder string
&#40;I.E $1, $2 etc&#41; is done using inefficient C string operations such as
using strcat and strchr.

I&#39;ve written a trivial string library that keeps track of where the end
of the string is, and the amount of memory that has been allocated.  It
will then append directly to the end of the string, and allocate more
memory as needed.

This roughly halves execution time again.  With both patches applied I
get approx 400 milliseconds run time for the reproducer script.

Regards,
Matt.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1512582/806549/0002-Optimize-DBD-Pg-string-operations.patch">Download 0002-Optimize-DBD-Pg-string-operations.patch</a><br />
<span class="downloadcontenttype">text/x-diff 9.4k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1512586" href="/Public/Bug/Display.html?id=105492#txn-1512586">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;28&nbsp;20:36:28&nbsp;2015</span>
    <span class="description">mtyson [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #105492] AutoReply: Poor performance with large amounts of placeholders.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 29 Jun 2015 10:36:14 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Pg [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Matt Tyson &lt;mtyson [...] redhat.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1512586/806553/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/806553">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 307b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

This applies the string optimization to the prepared statement creation.

The speedup here isn&#39;t as dramatic, maybe 50 milliseconds.  I didn&#39;t
notice this part of the code when I optimized strings the first time,
but I&#39;ve updated it to use the new string routines for completeness sake.

Regards
Matt.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1512586/806554/0003-Optimize-DBD-Pg-string-operations-part-2.patch">Download 0003-Optimize-DBD-Pg-string-operations-part-2.patch</a><br />
<span class="downloadcontenttype">text/x-diff 5.9k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1512595" href="/Public/Bug/Display.html?id=105492#txn-1512595">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;28&nbsp;20:58:47&nbsp;2015</span>
    <span class="description">greg [...] turnstep.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1512595/806560/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/806560">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 113b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">That is a lot of placeholders! Thanks for the work on this, I will take a look soon when I get a few more tuits.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1512596" href="/Public/Bug/Display.html?id=105492#txn-1512596">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;28&nbsp;20:58:48&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1512599" href="/Public/Bug/Display.html?id=105492#txn-1512599">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;28&nbsp;20:58:49&nbsp;2015</span>
    <span class="description">greg [...] turnstep.com -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1560648" href="/Public/Bug/Display.html?id=105492#txn-1560648">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;19&nbsp;22:59:12&nbsp;2015</span>
    <span class="description">mtyson [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #105492] Poor performance with large amounts of placeholders.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 20 Nov 2015 13:58:54 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Pg [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Matt Tyson &lt;mtyson [...] redhat.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1560648/832940/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/832940">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 459b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 29/06/15 10:58, Greg Sabino Mullane via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=105492">https://rt.cpan.org/Ticket/Display.html?id=105492</a></span> &gt;
&gt; 
&gt; That is a lot of placeholders! Thanks for the work on this, I will take a look soon when I get a few more tuits.
&gt; 
</div>
Hi Greg,

I&#39;ve updated the patch to apply to 3.5.3, and consolidated everything
into this one patch.

Please consider the previous patches obsolete.

If there&#39;s anything I can do to help, please let me know.

Regards,
Matt.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1560648/832941/0001-DBD-Pg-Optimization-patch.patch">Download 0001-DBD-Pg-Optimization-patch.patch</a><br />
<span class="downloadcontenttype">text/x-diff 32k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1653767" href="/Public/Bug/Display.html?id=105492#txn-1653767">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;29&nbsp;11:17:42&nbsp;2016</span>
    <span class="description">ilmari+cpan [...] ilmari.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1653767/887499/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/887499">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Matt,

On 2015-11-20 03:59:12, mtyson@redhat.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Greg,
&gt; 
&gt; I&#39;ve updated the patch to apply to 3.5.3, and consolidated everything
&gt; into this one patch.
</div>
Thank you very much for the patch, that&#39;s an impressive improvement.  However, it doesn&#39;t apply cleanly to git master &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/bucardo/dbdpg/&#41;">https://github.com/bucardo/dbdpg/&#41;</a></span> due to some nearby changes.

I&#39;ve applied it manually and adjusted a few things, please review the attached.  It might also be worth adding a comment noting that ph_array_append&#40;&#41; copies the ph_t it gets a pointer to, that threw me a bit when reading the loops adding placeholders.
  
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If there&#39;s anything I can do to help, please let me know.
</div>
I have a few issues wrt the string library that I didn&#39;t address myself:

1&#41; string_append_char&#40;&#41; can overflow if the appended string is longer than str-&gt;memory * 2 - str-&gt;length.

2&#41; It should use size_t for the lengths, not unsigned int &#40;I don&#39;t think PostgreSQL would accept a query &gt; 4GiB in length, but it&#39;s the principle of the thing ;&#41;
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Regards,
&gt; Matt.
</div>
Thanks,
Ilmari.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-DBD-Pg-Optimization-patch.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1653767/887500/0001-DBD-Pg-Optimization-patch.patch">Download 0001-DBD-Pg-Optimization-patch.patch</a><br />
<span class="downloadcontenttype">text/x-diff 32.5k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1654487" href="/Public/Bug/Display.html?id=105492#txn-1654487">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;01&nbsp;02:34:01&nbsp;2016</span>
    <span class="description">mtyson [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #105492] Poor performance with large amounts of placeholders.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 1 Aug 2016 16:33:48 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Pg [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Matt Tyson &lt;mtyson [...] redhat.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1654487/887900/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/887900">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Ilmari,

On 30/07/16 01:17, Dagfinn Ilmari Mannsaker via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=105492">https://rt.cpan.org/Ticket/Display.html?id=105492</a></span> &gt;
&gt; 
&gt; Hi Matt,
&gt; 
&gt; 
&gt; I have a few issues wrt the string library that I didn&#39;t address myself:
&gt; 
&gt; 1&#41; string_append_char&#40;&#41; can overflow if the appended string is longer than str-&gt;memory * 2 - str-&gt;length.
</div>
Can you provide a reproducer for this? I haven&#39;t been able to reproduce
it with a quick check of my own.  The logic for the if test makes me a
bit suspicious though.  I&#39;ll examine this in more detail when I get some
more time later this month.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2&#41; It should use size_t for the lengths, not unsigned int &#40;I don&#39;t think PostgreSQL would accept a query &gt; 4GiB in length, but it&#39;s the principle of the thing ;&#41;
</div>Not to mention the time spent on the network copying a query that large
:&#41;.  I&#39;ll fix that up in the next patch.


I personally wouldn&#39;t consider this patch &#39;complete&#39;.  It was intended
as a first pass to get some more feedback from someone more familiar
with the driver code.  I didn&#39;t get any reply until now, so I never
worked on it further after solving the immediate performance problem.

My memory is a bit fuzzy, but IIRC DBD::Pg &#40;sans-patch&#41; uses two linked
lists to do what&#39;s needed with placeholders.

My patch only replaces one of these linked lists with an array, as this
is where the performance bottleneck is.

My testing didn&#39;t show a performance problem with the other linked list,
but you&#39;re doing O&#40;N&#41; malloc&#40;&#41; and free&#40;&#41; operations rather than just
O&#40;1&#41; &#40;with the odd realloc&#40;&#41;&#41;.  Also as far as I&#39;m aware, the driver
doesn&#39;t do any insertions into the middle of the list, which is the main
use case of a linked list.

I&#39;d like to clean it up a bit more to be arrays only.  I can probably
take the existing array code and make it a bit more generic &#40;maybe&#41;.
Personally I think having a mix of an array and a linked list is a bit
messy.   What are your thoughts on this?

I don&#39;t have time to work on this right now, but I can get back to this
towards the end of August.

Cheers,
Matt.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1769492" href="/Public/Bug/Display.html?id=105492#txn-1769492">#</a>      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;04&nbsp;11:08:28&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1769492/952285/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/952285">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 58b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Either of you feel like giving this issue some attention?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1769594" href="/Public/Bug/Display.html?id=105492#txn-1769594">#</a>      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;04&nbsp;18:11:13&nbsp;2018</span>
    <span class="description">mtyson [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #105492] Poor performance with large amounts of placeholders.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 5 Feb 2018 09:10:58 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Pg [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Matt Tyson &lt;mtyson [...] redhat.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1769594/952344/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/952344">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 433b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I&#39;ve uploaded a new patch set onto github here:
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/bucardo/dbdpg/pull/21">https://github.com/bucardo/dbdpg/pull/21</a></span>

I don&#39;t believe this new patch set has been given an upstream review
yet.  I&#39;m happy to discuss and resolve any issues arising from a review.

Regards,
Matt.

On 05/02/18 02:08, Greg Sabino Mullane via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=105492">https://rt.cpan.org/Ticket/Display.html?id=105492</a></span> &gt;
&gt; 
&gt; Either of you feel like giving this issue some attention?
&gt; 
</div></div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.696132</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
