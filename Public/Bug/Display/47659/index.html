<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #47659 for Net-FTPSSL: Net-FTPSSL-0.09 ccc&#40;&#41; does not perform bidirection SSL shutdown</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #47659 for Net-FTPSSL: Net-FTPSSL-0.09 ccc&#40;&#41; does not perform bidirection SSL shutdown</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Net-FTPSSL">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Net-FTPSSL">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Net-FTPSSL">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Net-FTPSSL">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-FTPSSL">Net-FTPSSL CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">47659</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Net-FTPSSL">Net-FTPSSL</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
tj [...] castaglia.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-22628-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.09</li>
<li>
0.10</li>
</ul>
    </td>
  </tr>
  <tr id="CF-22629-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.11    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




05-ccc.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/629862/320722/05-ccc.t">
Wed Jul 08 00:05:19 2009 (8.4k) by CLEACH [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=47659">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-629571" href="/Public/Bug/Display.html?id=47659#txn-629571">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;07&nbsp;13:29:46&nbsp;2009</span>
    <span class="description">tj [...] castaglia.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net-FTPSSL-0.09 ccc&#40;&#41; does not perform bidirection SSL shutdown</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 7 Jul 2009 10:29:02 -0700 &#40;PDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-FTPSSL [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> TJ Saunders &lt;tj [...] castaglia.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/629571/320555/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/320555">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
The ccc&#40;&#41; method of Net::FTPSSL currently tells IO::Socket::SSL to skip 
the call to SSL_shutdown&#40;&#41; &#40;this is the recommended usage according to the 
IO::Socket::SSL docs&#41;.  However, this makes Net::FTPSSL not handle the CCC 
command properly.

Here&#39;s the example Perl code demonstrating the issue, and the expected 
behavior:

      my $user = &#39;proftpd&#39;;
      my $passwd = &#39;test&#39;;
      my $home_dir = &#39;/tmp&#39;;

      my $client_opts = {
        Encryption =&gt; &#39;E&#39;,
        Port =&gt; $port,
        Croak =&gt; 1,
      };

      if &#40;$ENV{TEST_VERBOSE}&#41; {
        $client_opts-&gt;{Debug} = 1;
      }

      my $client = Net::FTPSSL-&gt;new&#40;&#39;127.0.0.1&#39;, %$client_opts&#41;;

      unless &#40;$client&#41; {
        die&#40;&#34;Can&#39;t connect to FTPS server: &#34; . IO::Socket::SSL::errstr&#40;&#41;&#41;;
      }

      unless &#40;$client-&gt;login&#40;$user, $passwd&#41;&#41; {
        die&#40;&#34;Can&#39;t login: &#34; . $client-&gt;last_message&#40;&#41;&#41;;
      }

      $client-&gt;ccc&#40;&#41;;

      my $cwd = $client-&gt;pwd&#40;&#41;;
      $client-&gt;quit&#40;&#41;;

      $self-&gt;assert&#40;$home_dir eq $cwd&#41;;

When executing this against proftpd-1.3.2 compiled with mod_tls, the 
resulting Net:FTPSSL debug shows:

  SKT &lt;&lt;&lt; 220 ProFTPD 1.3.2 Server &#40;ProFTPD&#41; [127.0.0.1]
  SKT &gt;&gt;&gt; AUTH TLS
  SKT &lt;&lt;&lt; 234 AUTH TLS successful
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">  &gt;&gt;&gt; USER proftpd
</div>  &lt;&lt;&lt; 331 Password required for proftpd
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">  &gt;&gt;&gt; PASS *******
</div>  &lt;&lt;&lt; 230 User proftpd logged in
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">  &gt;&gt;&gt; PBSZ 0
</div>  &lt;&lt;&lt; 200 PBSZ 0 successful
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">  &gt;&gt;&gt; PROT P
</div>  &lt;&lt;&lt; 200 Protection set to Private
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">  &gt;&gt;&gt; CCC
</div>  &lt;&lt;&lt; 200 Clearing control channel protection
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">  &gt;&gt;&gt; PWD
</div>  &lt;&lt;&lt;  +&#41;.mleÄ›vt
  &lt;&lt;&lt; WD :zaÅ€^ntx=J0

After issuing the CCC command, the client should still be able to issue 
FTP commands such as PWD.  But the above shows that Net::FTPSSL is not 
parsing/handling the responses from proftpd, after the CCC, properly.

In the mod_tls log, with OpenSSL diagnostics enabled, for the above, I 
see:

  Jul 07 09:34:48 mod_tls/2.3[28335]: received CCC, clearing control channel protection
  Jul 07 09:34:48 mod_tls/2.3[28335]: [msg] sent TLSv1 warning &#39;close_notify&#39; Alert message &#40;2 bytes&#41;
  Jul 07 09:34:48 mod_tls/2.3[28335]: [info] writing: SSL/TLS alert warning: close notify
  Jul 07 09:34:48 mod_tls/2.3[28335]: [msg] sent message of unknown version &#40;22340&#41; &#40;2 bytes&#41;
  Jul 07 09:34:48 mod_tls/2.3[28335]: [info] writing: SSL/TLS alert fatal: protocol version
  Jul 07 09:34:48 mod_tls/2.3[28335]: SSL_shutdown error [1]: 
  &#40;1&#41; error:1408F10B:SSL routines:SSL3_GET_RECORD:wrong version number

This shows mod_tls &#40;via the OpenSSL SSL_shutdown&#40;&#41; call&#41; sending the 
close_notify alert to the client.  Notice, though, that the client does 
not send a close_notify alert in response.

However, if the following code in FTPSSL.pm is changed from:

   # Stop SSL, but leave the socket open!
   unless &#40; $self-&gt;stop_SSL &#40; SSL_no_shutdown =&gt; 1 &#41; &#41; {

to be:

   # Stop SSL, but leave the socket open!
   unless &#40; $self-&gt;stop_SSL &#40; SSL_no_shutdown =&gt; 0 &#41; &#41; {

and the test tried again, the Net::FTPSSL debug log shows:

  SKT &lt;&lt;&lt; 220 ProFTPD 1.3.2 Server &#40;ProFTPD&#41; [127.0.0.1]
  SKT &gt;&gt;&gt; AUTH TLS
  SKT &lt;&lt;&lt; 234 AUTH TLS successful
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">  &gt;&gt;&gt; USER proftpd
</div>  &lt;&lt;&lt; 331 Password required for proftpd
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">  &gt;&gt;&gt; PASS *******
</div>  &lt;&lt;&lt; 230 User proftpd logged in
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">  &gt;&gt;&gt; PBSZ 0
</div>  &lt;&lt;&lt; 200 PBSZ 0 successful
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">  &gt;&gt;&gt; PROT P
</div>  &lt;&lt;&lt; 200 Protection set to Private
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">  &gt;&gt;&gt; CCC
</div>  &lt;&lt;&lt; 200 Clearing control channel protection
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">  &gt;&gt;&gt; PWD
</div>  &lt;&lt;&lt; 257 &#34;/tmp&#34; is the current directory
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">  &gt;&gt;&gt; QUIT
</div>  &lt;&lt;&lt; 221 Goodbye.

Net::FTPSSL was able to parse/handle the PWD response this time.  And in 
the mod_tls logs, again with OpenSSL diagnostics enabled, I the following 
for the above modified Net::FTPSSL code:

  Jul 07 10:17:32 mod_tls/2.3[29361]: received CCC, clearing control channel protection
  Jul 07 10:17:32 mod_tls/2.3[29361]: [msg] sent TLSv1 warning &#39;close_notify&#39; Alert message &#40;2 bytes&#41;
  Jul 07 10:17:32 mod_tls/2.3[29361]: [info] writing: SSL/TLS alert warning: close notify
  Jul 07 10:17:32 mod_tls/2.3[29361]: [msg] received TLSv1 warning &#39;close_notify&#39; Alert message &#40;2 bytes&#41;
  Jul 07 10:17:32 mod_tls/2.3[29361]: [info] reading: SSL/TLS alert warning: close notify

This time, a full bidirectional shutdown of the SSL session occurred; the 
&#39;close_notify&#39; alerts were sent and received by both peers.  Section 12.3 
of RFC 4217 shows that a bidirectional shutdown of the SSL session on the 
control channel is the expected behavior.

Keep up the good work with the Net::FTPSSL module; I&#39;m enjoying using it 
for my proftpd/mod_tls development!

Cheers,
TJ

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

   Absence is to love what wind is to fire: it extinguishes the small, it
   enkindles the great.

        -Comte de Bussy-Rabutin

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-629658" href="/Public/Bug/Display.html?id=47659#txn-629658">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;07&nbsp;16:15:51&nbsp;2009</span>
    <span class="description">CLEACH [...] cpan.org -  Broken in 0.09 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-629659" href="/Public/Bug/Display.html?id=47659#txn-629659">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;07&nbsp;16:15:53&nbsp;2009</span>
    <span class="description">CLEACH [...] cpan.org -  Broken in 0.10 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-629660" href="/Public/Bug/Display.html?id=47659#txn-629660">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;07&nbsp;16:15:53&nbsp;2009</span>
    <span class="description">CLEACH [...] cpan.org -  Severity Important added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-629670" href="/Public/Bug/Display.html?id=47659#txn-629670">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;07&nbsp;17:05:44&nbsp;2009</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/629670/320610/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/320610">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi TJ,

Thank you very much for the report that ccc&#40;&#41; doesn&#39;t work against 
proftpd-1.3.2 and the patch you supplied.  I&#39;ll see about testing your 
patch against my FTPS server in the near future to see if it works 
there as well.  Hopefully it&#39;s not a brand of FTPS server issue where 
some servers require &#34;SSL_no_shutdown =&gt; 1&#34; while others 
require &#34;SSL_no_shutdown =&gt; 0&#34;.  &#40;I know the current code works for my 
non-proftpd servers.&#41;

But I&#39;m pretty swamped right now so v0.11 is going to be a while.  The 
current release of v0.10 has the same problem as v0.09 has with ccc&#40;&#41;.

In the mean time, can you please send me the versions of the following 
modules you are using?  I&#39;d also like to rule out it&#39;s not a 
dependancy on another module issue when I get to testing your patch.  
You can get the versions by running the following command.

perl -w -e &#34;use IO::Socket::SSL 99.0;&#34;
perl -w -e &#34;use Net::SSLeay 99.0;&#34;

I&#39;d also like what OS you are running your client code on as well as 
the Perl version.  This will greatly help me with preparing the next 
release.

Curtis
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-629671" href="/Public/Bug/Display.html?id=47659#txn-629671">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;07&nbsp;17:05:45&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-629698" href="/Public/Bug/Display.html?id=47659#txn-629698">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;07&nbsp;17:47:05&nbsp;2009</span>
    <span class="description">tj [...] castaglia.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #47659] Net-FTPSSL-0.09 ccc&#40;&#41; does not perform bidirection SSL shutdown </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 7 Jul 2009 14:46:27 -0700 &#40;PDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Curtis Leach via RT &lt;bug-Net-FTPSSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> TJ Saunders &lt;tj [...] castaglia.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/629698/320624/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/320624">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thank you very much for the report that ccc&#40;&#41; doesn&#39;t work against 
&gt; proftpd-1.3.2 and the patch you supplied.  I&#39;ll see about testing your 
&gt; patch against my FTPS server in the near future to see if it works 
&gt; there as well.  Hopefully it&#39;s not a brand of FTPS server issue where 
&gt; some servers require &#34;SSL_no_shutdown =&gt; 1&#34; while others 
&gt; require &#34;SSL_no_shutdown =&gt; 0&#34;.  &#40;I know the current code works for my 
&gt; non-proftpd servers.&#41;
</div>
What kind of test do you use for verifying ccc&#40;&#41; against a server?  The 
best test I&#39;ve found is to issue some normal FTP commands &#40;PWD, LIST, etc&#41; 
after the CCC, to make sure that both the client and the server process 
the commands as appropriate.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In the mean time, can you please send me the versions of the following 
&gt; modules you are using?  I&#39;d also like to rule out it&#39;s not a 
&gt; dependancy on another module issue when I get to testing your patch.  
&gt; You can get the versions by running the following command.
&gt; 
&gt; perl -w -e &#34;use IO::Socket::SSL 99.0;&#34;
</div>
familiar/tj&gt;perl -w -e &#39;use IO::Socket::SSL 99.0;&#39;
IO::Socket::SSL version 99 required--this is only version 1.24 at -e line 1.
BEGIN failed--compilation aborted at -e line 1.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; perl -w -e &#34;use Net::SSLeay 99.0;&#34;
</div>
familiar/tj&gt;perl -w -e &#39;use Net::SSLeay 99.0;&#39;
Net::SSLeay version 99 required--this is only version 1.35 at -e line 1.
BEGIN failed--compilation aborted at -e line 1.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;d also like what OS you are running your client code on as well as 
&gt; the Perl version.
</div>
OS: Ubuntu Linux 9.05, 32-bit

Perl:

familiar/tj&gt;perl -V
Summary of my perl5 &#40;revision 5 version 10 subversion 0&#41; configuration:
  Platform:
    osname=linux, osvers=2.6.24-19-server, 
archname=i486-linux-gnu-thread-multi
    uname=&#39;linux palmer 2.6.24-19-server #1 smp sat jul 12 00:40:01 utc 
2008 i686 gnulinux &#39;
    config_args=&#39;-Dusethreads -Duselargefiles -Dccflags=-DDEBIAN 
-Dcccdlflags=-fPIC -Darchname=i486-linux-gnu -Dprefix=/usr 
-Dprivlib=/usr/share/perl/5.10 -Darchlib=/usr/lib/perl/5.10 
-Dvendorprefix=/usr -Dvendorlib=/usr/share/perl5 
-Dvendorarch=/usr/lib/perl5 -Dsiteprefix=/usr/local 
-Dsitelib=/usr/local/share/perl/5.10.0 
-Dsitearch=/usr/local/lib/perl/5.10.0 -Dman1dir=/usr/share/man/man1 
-Dman3dir=/usr/share/man/man3 -Dsiteman1dir=/usr/local/man/man1 
-Dsiteman3dir=/usr/local/man/man3 -Dman1ext=1 -Dman3ext=3perl 
-Dpager=/usr/bin/sensible-pager -Uafs -Ud_csh -Ud_ualarm -Uusesfio -Uusenm 
-DDEBUGGING=-g -Doptimize=-O2 -Duseshrplib -Dlibperl=libperl.so.5.10.0 
-Dd_dosuid -des&#39;
    hint=recommended, useposix=true, d_sigaction=define
    useithreads=define, usemultiplicity=define
    useperlio=define, d_sfio=undef, uselargefiles=define, usesocks=undef
    use64bitint=undef, use64bitall=undef, uselongdouble=undef
    usemymalloc=n, bincompat5005=undef
  Compiler:
    cc=&#39;cc&#39;, ccflags =&#39;-D_REENTRANT -D_GNU_SOURCE -DDEBIAN -fno-strict-aliasing -pipe -I/usr/local/include -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64&#39;,
    optimize=&#39;-O2 -g&#39;,
    cppflags=&#39;-D_REENTRANT -D_GNU_SOURCE -DDEBIAN -fno-strict-aliasing -pipe -I/usr/local/include&#39;
    ccversion=&#39;&#39;, gccversion=&#39;4.3.3 20081217 &#40;prerelease&#41;&#39;, gccosandvers=&#39;&#39;
    intsize=4, longsize=4, ptrsize=4, doublesize=8, byteorder=1234
    d_longlong=define, longlongsize=8, d_longdbl=define, longdblsize=12
    ivtype=&#39;long&#39;, ivsize=4, nvtype=&#39;double&#39;, nvsize=8, Off_t=&#39;off_t&#39;, lseeksize=8
    alignbytes=4, prototype=define
  Linker and Libraries:
    ld=&#39;cc&#39;, ldflags =&#39; -L/usr/local/lib&#39;
    libpth=/usr/local/lib /lib /usr/lib /usr/lib64
    libs=-lgdbm -lgdbm_compat -ldb -ldl -lm -lpthread -lc -lcrypt
    perllibs=-ldl -lm -lpthread -lc -lcrypt
    libc=/lib/libc-2.9.so, so=so, useshrplib=true, libperl=libperl.so.5.10.0
    gnulibc_version=&#39;2.9&#39;
  Dynamic Linking:
    dlsrc=dl_dlopen.xs, dlext=so, d_dlsymun=undef, ccdlflags=&#39;-Wl,-E&#39;
    cccdlflags=&#39;-fPIC&#39;, lddlflags=&#39;-shared -O2 -g -L/usr/local/lib&#39;


Characteristics of this binary &#40;from libperl&#41;: 
  Compile-time options: MULTIPLICITY PERL_DONT_CREATE_GVSV
                        PERL_IMPLICIT_CONTEXT PERL_MALLOC_WRAP USE_ITHREADS
                        USE_LARGE_FILES USE_PERLIO USE_REENTRANT_API
  Built under linux
  Compiled at Jan  5 2009 19:47:06
  @INC:
    /etc/perl
    /usr/local/lib/perl/5.10.0
    /usr/local/share/perl/5.10.0
    /usr/lib/perl5
    /usr/share/perl5
    /usr/lib/perl/5.10
    /usr/share/perl/5.10
    /usr/local/lib/site_perl
    .

Cheers,
TJ

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

   Once more upon the waters! yet once more!
   And the waves bound beneath me as as a steed
   That knows his rider.

        -Lord Byron

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-629739" href="/Public/Bug/Display.html?id=47659#txn-629739">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;07&nbsp;19:34:49&nbsp;2009</span>
    <span class="description">tj [...] castaglia.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #47659] Net-FTPSSL-0.09 ccc&#40;&#41; does not perform bidirection SSL shutdown </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 7 Jul 2009 16:34:12 -0700 &#40;PDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Curtis Leach via RT &lt;bug-Net-FTPSSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> TJ Saunders &lt;tj [...] castaglia.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/629739/320642/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/320642">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 585b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=47659">https://rt.cpan.org/Ticket/Display.html?id=47659</a></span> &gt;
</div>
Just another minor nit: The perldoc for the ccc&#40;&#41; method mentions:

  &#34;Sends the clear command channel request to the SFTP server.&#34;

I think what is meant is &#34;FTPS server&#34;, not &#34;SFTP server&#34;.

Cheers,
TJ

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

   It is not our purpose to become each other; it is to recognize each other,
   to learn to see the other and honor him for what he is.

        -Hermann Hesse

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-629862" href="/Public/Bug/Display.html?id=47659#txn-629862">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;08&nbsp;00:05:19&nbsp;2009</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/629862/320719/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/320719">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi TJ,

Nice catch on the FPTS/SFTP typo and thanks for providing the Perl 
info your program is running against.

Per your request, attached is the test script I used to test out the 
ccc&#40;&#41; command added in version 0.09.  I should probably add it to 10-
compex.t, but I never got arround to it.  I hope I didn&#39;t introduce 
any typos when I took out some hard coded defaults to the main test 
server I used to test ccc&#40;&#41; against.  Just drop the script into the 
test directory with 10-compex.t and run it from there &#34;perl t/05-ccc.t&#34;

Now I have bad news about your patch.  I changed the value used for 
SSL_no_shudown from 1 to 0 and the patch hangs on my FTPS server.  So 
it looks like the fix will have to be a bit more complex than just a 
one line change.  Looks like some FTPS servers require it to be &#34;1&#34; 
and others require it to be &#34;0&#34; to work.

So I&#39;ll have to look at making this value configurable somehow.  
Either as an argument to the ccc&#40;&#41; command or as another option 
to &#34;new&#34;.  It&#39;s also possible that different versions of stop_SSL&#40;&#41; 
work differently, or it&#39;s a Perl 5.8.8 vs 5.10 issue.  We are using 
different versions of IO::Socket:SSL, v1.18 vs v1.24.  So more 
research is needed on my end.

Would you be willing to grant me temporary access to your FTPS server 
via a temporary account that Net::FTPSSL could use?  So that I can 
quickly rule out a few things?  So that I can verify the issue is 
strictly with your proftpd server and not our code differences.

If you are willing, we can exchange that info off line via personal 
email addresses.  Since I don&#39;t think you want that info floating 
around on a public site.  Otherwise we might have to exchange updates 
to FTPSSL.pm between us as we try to rule out all the various 
differences.

Thanks

Curtis
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/629862/320722/05-ccc.t">Download 05-ccc.t</a><br />
<span class="downloadcontenttype">text/x-perl 8.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"># Before `make install&#39; is performed this script should be runnable with
# `make test&#39;. After `make install&#39; it should work as `perl ./t/10-complex.t&#39;

#########################

# Goal here is to give as many success messagse as possible.
# Especially when not all FTP servers support all functions.
# So the logic here can be a bit convoluted.

use strict;

use Test::More tests =&gt; 14;

# plan tests =&gt; 40;  # Can&#39;t use due to BEGIN block

BEGIN { use_ok&#40;&#39;Net::FTPSSL&#39;&#41; }    # Test # 1

sleep &#40;1&#41;;  # So test 1 completes before the message prints!

diag&#40; &#34;\nYou can also perform a deeper test.&#34; &#41;;
diag&#40; &#34;Some information will be required for this test:&#34; &#41;;
diag&#40; &#34;A secure ftp server address, a user, a password and a directory&#34; &#41;;
diag&#40; &#34;where the user has permissions to read and write.&#34; &#41;;
my $more_test = ask_yesno&#40;&#34;Do you want to make a deeper test&#34;&#41;;

SKIP: {
    skip &#34;Deeper test skipped for some reason...&#34;, 40 unless $more_test;

    my&#40; $address, $server, $port, $user, $pass, $dir, $mode, $data, $encrypt_mode &#41;; 

    $address = ask&#40;&#34;Server address &#40; server.org[:port] &#41;&#34;&#41;;
    $address = &#34;server.org&#34; unless &#40;$address&#41;;

    $user = ask&#40;&#34;\tUser &#40;default &#39;anonymous&#39;&#41;&#34;&#41;;

    $pass = ask&#40;&#34;\tPassword &#40;default &#39;user\@localhost&#39;&#41;&#34;&#41;;

    $dir = ask&#40;&#34;\tDirectory &#40;default &lt;HOME&gt;&#41;&#34;&#41;;

    $mode = uc &#40;ask&#40;&#34;\tConnection mode &#40;I&#41;mplicit, &#40;E&#41;xplicit, or &#40;C&#41;lear. &#40;default &#39;E&#39;&#41;&#34;&#41;&#41;;

    if &#40; $mode eq CLR_CRYPT &#41; {
       $data = $encrypt_mode = &#34;&#34;;   # Make sure not undef ...
    } else {
       $data = uc &#40;ask&#40;&#34;\tData Connection mode &#40;C&#41;lear or &#40;P&#41;rotected. &#40;default &#39;P&#39;&#41;&#34;&#41;&#41;;

       $encrypt_mode = &#34;T&#34;;
    }

    &#40; $server, $port &#41; = split&#40; /:/, $address &#41;;

    # INET didn&#39;t support despite comments elsewhere.
    # my @svrs = split &#40;/,\s*/, $server&#41;;
    # if &#40;scalar &#40;@svrs&#41; &gt; 1&#41; { $server = \@svrs; }   # Requested list of servers

    # $port = 21 unless $port;   # Let FTPSSL provide the default port.
    $mode = EXP_CRYPT unless $mode =~ /^&#40;I|E|C|&#41;$/;
    $data = DATA_PROT_PRIVATE unless $data =~ /^&#40;C|S|E|P|&#41;$/;
    $user = &#39;anonymous&#39; unless $user;
    $pass = &#39;user@localhost&#39; unless $pass;
    $encrypt_mode = &#40;$encrypt_mode eq &#34;S&#34;&#41; ? 1 : 0;

    # The main copy of the log file ...
    my $log_file = &#34;./t/test_ccc_new.txt&#34;;

    # -----------------------------------------------------------
    # End of user interaction ...
    # -----------------------------------------------------------

    # This section initializes an unsupported feature to Net::FTPSSL.
    # Code is left here so that I can easily revisit it in the future if needed.
    # That&#39;s why option SSL_Advanced is commented out below but left uncommented
    # here.  Do not use this feature unless you absolutely have no choice!
    my %advanced_hash = &#40; SSL_version =&gt; &#40;$encrypt_mode ? &#34;SSLv23&#34; : &#34;TLSv1&#34;&#41;,
                          Timeout =&gt; 99 &#41;;
    # -----------------------------------------------------------

    my %callback_hash;

    # Delete test files from previous run
    unlink &#40;&#34;./t/test_file_new.tar.gz&#34;,
            &#34;./t/FTPSSL.pm_new.tst&#34;,
            $log_file&#41;;

    # So we can save the Debug trace in a file from this test.
    open &#40;OLDERR, &#34;&gt;&#38;STDERR&#34;&#41;;
    open &#40;STDERR, &#34;&gt; $log_file&#34;&#41;;

    print STDERR &#34;\nNet-FTPSSL Version: &#34; . $Net::FTPSSL::VERSION . &#34;\n\n&#34;;

    # Leave SSL_Advanced commented out ... Unsupported feature ...
    my $ftp = Net::FTPSSL-&gt;new&#40; $server, Port =&gt; $port, Encryption =&gt; $mode,
                                DataProtLevel =&gt; $data,
                                useSSL =&gt; $encrypt_mode,
                                # SSL_Advanced =&gt; \%advanced_hash,
                                PreserveTimestamp =&gt; 1,
                                Debug =&gt; 1, Trace =&gt; 1, Croak =&gt; 1 &#41;;

    isa_ok&#40; $ftp, &#39;Net::FTPSSL&#39;, &#39;Net::FTPSSL object creation&#39; &#41;;

    ok&#40; $ftp-&gt;login &#40;$user, $pass&#41;, &#34;Login to $server&#34; &#41;;

    $dir = $ftp-&gt;pwd&#40;&#41;  unless $dir;

    ok&#40; $ftp-&gt;cwd&#40; $dir &#41;, &#34;Changed the dir to $dir&#34; &#41;;
    my $pwd = $ftp-&gt;pwd&#40;&#41;;
    ok&#40; defined $pwd, &#34;Getting the directory: &#40;$pwd&#41;&#34; &#41;;
    $dir = $pwd  unless &#40;defined $pwd&#41;;  # Convert relative to absolute path.

    # Turning off croak now that our environment is correct!
    $ftp-&gt;set_croak &#40;0&#41;;

    ok&#40; $ftp-&gt;noop&#40;&#41;, &#34;Noop test&#34; &#41;;

    ok&#40; $ftp-&gt;binary &#40;&#41;, &#39;putting FTP in binry mode&#39; &#41;;
    ok&#40; $ftp-&gt;put&#40; &#39;./t/test_file.tar.gz&#39; &#41;, &#34;puting a test binary file on $dir&#34; &#41;;

    my @lst = $ftp-&gt;list &#40;&#41;;
    ok&#40; scalar @lst != 0, &#39;list&#40;&#41; command&#39; &#41;;
    print_result &#40;\@lst&#41;;

    # -----------------------------------------------
    # Now check out the CCC command ...
    # -----------------------------------------------
    ok&#40; $ftp-&gt;ccc &#40;&#41;, &#34;The CCC command&#34; &#41;;

    print STDERR &#34;CCC Command completed!\n&#34;;

    ok&#40; $ftp-&gt;pwd &#40;&#41;, &#34;The PWD command&#34; &#41;;

    @lst = $ftp-&gt;list &#40;&#41;;
    ok&#40; scalar @lst != 0, &#39;list&#40;&#41; command&#39; &#41;;
    print_result &#40;\@lst&#41;;

    ok&#40; $ftp-&gt;binary &#40;&#41;, &#39;putting FTP back in binary mode&#39; &#41;;
    ok&#40; $ftp-&gt;delete&#40; &#39;test_file.tar.gz&#39; &#41;, &#34;deleting the test bin file on $server&#34; &#41;;

    # -----------------------------------------
    # End put/get/rename/delete section ...
    # -----------------------------------------

    $ftp-&gt;quit&#40;&#41;;

    # Restore STDERR now that the tests are done!
    open &#40;STDERR, &#34;&gt;&#38;OLDERR&#34;&#41;;
    if &#40;1 == 2&#41; {
       print OLDERR &#34;\n&#34;;   # Perl gives warning if not present!  &#40;Not executed&#41;
    }
}

sub ask {
  my $question = shift;
  diag&#40;&#34;\n$question ? &#34;&#41;;

  my $answer = &lt;STDIN&gt;;
  chomp $answer;
  return $answer;
}

sub ask_yesno {

  my $question = shift;
  diag&#40;&#34;\n$question ? [y/N]&#34;&#41;;

  my $answer = &lt;STDIN&gt;;
  chomp $answer;
  return $answer =~ /^y&#40;es&#41;*$/i ? 1 : 0;
}

# Save the results from the list&#40;&#41; &#38; nlst&#40;&#41; calls.
# Remember that STDERR should be redirected to a log file by now.
sub print_result {
   my $lst = shift;

   # Tell the max number of entries you may print out.
   # Just in case the list is huge!
   my $cnt = 5;

   my $max = scalar &#40;@{$lst}&#41;;
   print STDERR &#34;------------- Found $max file&#40;s&#41; -----------------\n&#34;;
   foreach &#40;@{$lst}&#41; {
      if &#40;$cnt &lt;= 0&#41; {
         print STDERR &#34;...\n&#34;;
         print STDERR &#34;&#40;$lst-&gt;[-1]&#41;\n&#34;;
         last;
      }
      print STDERR &#34;&#40;$_&#41;\n&#34;;
      --$cnt;
   }
   print STDERR &#34;-----------------------------------------------\n&#34;;
}

# Testing out the call back functionality of v0.07 on ...
sub callback_func {
   my $ftps_function_name = shift;
   my $data_ref     = shift;      # The data to/from the data channel.
   my $data_len_ref = shift;      # The size of the data buffer.
   my $total_len    = shift;      # The number of bytes to date.
   my $callback_data_ref = shift; # The callback work space.

   if &#40; $ftps_function_name =~ m/:list$/ &#41; {
      ${$data_ref} =~ s/[a-z]/\U$&#38;/g;    # Convert to upper case!
      # Reformat #&#39;s Ex: 1234567 into 1,234,567.
      while &#40; ${$data_ref} =~ s/&#40;\d&#41;&#40;\d{3}\D&#41;/$1,$2/ &#41; { }
      ${$data_len_ref} = length &#40;${$data_ref}&#41;;  # May have changed data length!

   } elsif &#40; $ftps_function_name =~ m/:nlst$/ &#41; {
      ${$data_ref} =~ s/[a-z]/\U$&#38;/g;    # Convert to upper case!
      ${$data_ref} =~ s/^/[0]: /gm;      # Add a prefix per line.

      # Make the prefix unique per line ...
      my $cnt = ++$callback_data_ref-&gt;{counter};
      while &#40; ${$data_ref} =~ s/\[0\]/[$cnt]/&#41; {
         $cnt = ++$callback_data_ref-&gt;{counter};
      }

      # Fix so counter is correct for next time called!
      --$callback_data_ref-&gt;{counter};

      ${$data_len_ref} = length &#40;${$data_ref}&#41;;  # Changed length of data!

   } else {
      print STDERR &#34; *** Unexpected callback for $ftps_function_name! ***\n&#34;;
   }

   return &#40;&#41;;
}

# Testing out the end call back functionality of v0.07 on ...
sub end_callback_func {
   my $ftps_function_name = shift;
   my $total_len          = shift;   # The total number of bytes sent out
   my $callback_data_ref  = shift;   # The callback work space.

   my $tail;   # Additional data channel data to provide ...

   if &#40; $ftps_function_name =~ m/:nlst$/ &#41; {
      my $cnt;
      my $sep = &#34;&#34;;
      $tail = &#34;&#34;;
      foreach &#40;&#34;Junker&#34;, &#34;T-Bird&#34;, &#34;Coup&#34;, &#34;Model-T&#34;, &#34;Horse &#38; Buggy&#34;&#41; {
         $cnt = ++$callback_data_ref-&gt;{counter};
         $tail .= $sep . &#34;[$cnt]: $_!&#34;;
         $sep = &#34;\n&#34;;
      }

      # So the next nlst call will start counting all over again!
      delete &#40;$callback_data_ref-&gt;{counter}&#41;;
   }

   return &#40; $tail &#41;;
}

# vim:ft=perl:

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-632249" href="/Public/Bug/Display.html?id=47659#txn-632249">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;13&nbsp;12:34:55&nbsp;2009</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/632249/322016/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/322016">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 934b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi TJ,

I was finally able to upgrade my IO::Socket::SSL from v1.18 to v1.26 
and your patch still hangs on the call to stop_SSL&#40;&#41; when run against 
my local FTPS servers. &#40;you were at v1.24&#41;  But I don&#39;t have a proftpd 
FTPS server to test against, so I haven&#39;t been able to reproduce your 
success with your patch.

I have a couple more things to try out, but it&#39;s begining to look like 
I&#39;ll have to do an ugly solution to support you.  That it might be a 
case where different servers behave differently for the ccc&#40;&#41; command.

So I&#39;m currently considering adding a boolean flag to ccc&#40;&#41; or fix it 
to accept a hash so that any options can be overiden for stop_SSL&#40;&#41;.  
But I need to look at stop_SSL&#40;&#41;in IO:Socket::SSL a bit more closely 
to see if the hash solution makes any sense.

I&#39;ll keep you informed if I make any progress with your patch.

Also the ccc&#40;&#41; test will be in 10-complex.t in the next release, v0.11.

Curtis
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-632804" href="/Public/Bug/Display.html?id=47659#txn-632804">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;14&nbsp;11:42:22&nbsp;2009</span>
    <span class="description">tj [...] castaglia.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #47659] Net-FTPSSL-0.09 ccc&#40;&#41; does not perform bidirection SSL shutdown </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 14 Jul 2009 08:41:37 -0700 &#40;PDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Curtis Leach via RT &lt;bug-Net-FTPSSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> TJ Saunders &lt;tj [...] castaglia.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/632804/322335/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/322335">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I was finally able to upgrade my IO::Socket::SSL from v1.18 to v1.26 
&gt; and your patch still hangs on the call to stop_SSL&#40;&#41; when run against 
&gt; my local FTPS servers. &#40;you were at v1.24&#41;  But I don&#39;t have a proftpd 
&gt; FTPS server to test against, so I haven&#39;t been able to reproduce your 
&gt; success with your patch.
</div>
I was out of town for the past few days; you can contact me outside of RT 
for info for a temporary ProFTPD FTPS account that I will setup.

What FTP server are you using locally, for testing Net::FTPSSL&#39;s CCC 
functionality?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ll have to do an ugly solution to support you.  That it might be a 
&gt; case where different servers behave differently for the ccc&#40;&#41; command.
</div>
I&#39;m almost certain this is the case.  There are not many applications that 
shut down the SSL session on a TCP connection and yet keep the TCP 
connection up and use it afterwards; this means there are not many 
examples for how to do a proper bi-directional SSL session shutdown, on 
both client and server sides.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So I&#39;m currently considering adding a boolean flag to ccc&#40;&#41; or fix it 
&gt; to accept a hash so that any options can be overiden for stop_SSL&#40;&#41;.  
&gt; But I need to look at stop_SSL&#40;&#41;in IO:Socket::SSL a bit more closely 
&gt; to see if the hash solution makes any sense.
</div>
Do you know where the hang is occurring?  My initial unsubstantiated guess 
is that something &#40;perhaps in the client?&#41; is eventually calling 
SSL_read&#40;&#41;, which is expecting an SSL message, and not seeing it...

Cheers,
TJ

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

   Words are also actions, and actions are a kind of words.

     -Ralph Waldo Emerson

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-632883" href="/Public/Bug/Display.html?id=47659#txn-632883">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;14&nbsp;15:00:53&nbsp;2009</span>
    <span class="description">cleach [...] harrahs.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #47659] Net-FTPSSL-0.09 ccc&#40;&#41; does not perform bidirection SSL shutdown</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 14 Jul 2009 14:00:17 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-FTPSSL [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Curtis Leach&#34; &lt;cleach [...] harrahs.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/632883/322388/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/322388">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hopefully this won&#39;t post

cleach@cpan.org 

And no I haven&#39;t had the chance to drill down into the IO-Socket-SSL
code to see where it&#39;s hanging.

Curtis


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: TJ Saunders via RT [mailto:bug-Net-FTPSSL@rt.cpan.org] 
Sent: Tuesday, July 14, 2009 10:42 AM
Subject: Re: [rt.cpan.org #47659] Net-FTPSSL-0.09 ccc&#40;&#41; does not perform
bidirection SSL shutdown

       Queue: Net-FTPSSL
 Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=47659">http://rt.cpan.org/Ticket/Display.html?id=47659</a></span> &gt;


<div class="message-stanza open">&gt; I was finally able to upgrade my IO::Socket::SSL from v1.18 to v1.26 
&gt; and your patch still hangs on the call to stop_SSL&#40;&#41; when run against 
&gt; my local FTPS servers. &#40;you were at v1.24&#41;  But I don&#39;t have a proftpd
</div>
<div class="message-stanza open">&gt; FTPS server to test against, so I haven&#39;t been able to reproduce your 
&gt; success with your patch.
</div>
I was out of town for the past few days; you can contact me outside of
RT for info for a temporary ProFTPD FTPS account that I will setup.

What FTP server are you using locally, for testing Net::FTPSSL&#39;s CCC
functionality?

<div class="message-stanza open">&gt; I&#39;ll have to do an ugly solution to support you.  That it might be a 
&gt; case where different servers behave differently for the ccc&#40;&#41; command.
</div>
I&#39;m almost certain this is the case.  There are not many applications
that shut down the SSL session on a TCP connection and yet keep the TCP
connection up and use it afterwards; this means there are not many
examples for how to do a proper bi-directional SSL session shutdown, on
both client and server sides.

<div class="message-stanza open">&gt; So I&#39;m currently considering adding a boolean flag to ccc&#40;&#41; or fix it 
&gt; to accept a hash so that any options can be overiden for stop_SSL&#40;&#41;.
&gt; But I need to look at stop_SSL&#40;&#41;in IO:Socket::SSL a bit more closely 
&gt; to see if the hash solution makes any sense.
</div>
Do you know where the hang is occurring?  My initial unsubstantiated
guess is that something &#40;perhaps in the client?&#41; is eventually calling
SSL_read&#40;&#41;, which is expecting an SSL message, and not seeing it...

Cheers,
TJ

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~

   Words are also actions, and actions are a kind of words.

     -Ralph Waldo Emerson

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-632896" href="/Public/Bug/Display.html?id=47659#txn-632896">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;14&nbsp;15:26:40&nbsp;2009</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/632896/322398/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/322398">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 67b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Try cleach@cpan.org, it should reach me outside this chain.

Curtis
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-635427" href="/Public/Bug/Display.html?id=47659#txn-635427">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;20&nbsp;17:39:33&nbsp;2009</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/635427/323848/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/323848">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 111b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">TJ,

Thanks for your help off line.  This is to let you know that the patch 
has been applied to v0.11

Curtis
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-635430" href="/Public/Bug/Display.html?id=47659#txn-635430">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;20&nbsp;17:40:07&nbsp;2009</span>
    <span class="description">CLEACH [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-635432" href="/Public/Bug/Display.html?id=47659#txn-635432">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;20&nbsp;17:40:09&nbsp;2009</span>
    <span class="description">CLEACH [...] cpan.org -  Fixed in 0.11 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.725206</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
