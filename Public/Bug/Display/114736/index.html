<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #114736 for Data-Dump: Reference tracking does not handle temporaries causing random corruption</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #114736 for Data-Dump: Reference tracking does not handle temporaries causing random corruption</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Data-Dump/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Data-Dump/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Data-Dump/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Data-Dump/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Data-Dump">Data-Dump CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">114736</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Data-Dump/Active/">Data-Dump</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
erwhite99-cpan [...] yahoo.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-8998-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.23    </td>
  </tr>
  <tr id="CF-8999-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;26&nbsp;12:04:41&nbsp;2016</span>
    <span class="description">erwhite99-cpan [...] yahoo.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Reference tracking does not handle temporaries causing random
 corruption</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dist: Data-Dump-1.23
Perl v5.18.2 built for x86_64-linux-thread-multi
Uname: Linux 2.6.32-431.el6.x86_64 #1 SMP Sun Nov 10 22:19:54 EST 2013 x86_64 GNU/Linux

There is a feature in this distribution which attempts to track references but it does not play nicely with the filter feature which allows the user to replace visited objects with other objects that often have a temporary lifetime.

Also, the dump function itself forces creation of temporary scalar references for non-ref input which only has scope for the current function.

sub _dump
{
    my $ref  = ref $_[0];
    my $rval = $ref ? $_[0] : \$_[0];

The reason this all causes problems is that the reference tracking logic stashes away the address of the reference in a map which later is used to identify cases where references are encountered multiple times.

Perl&#39;s garbage collection logic it seems is fairly efficient and tries to re-use objects which have already been allocated previously but no longer in use for later created objects.

So, what happens I think is that the &#39;seen&#39; logic captures addresses of temporaries which are then de-allocated and resused for subsequent altogether different object.  But the &#39;seen&#39; logic thinks they are reference matches.

I&#39;ve attached a script that will reproduce the problem.  In this script I&#39;m basically splitting a string into tokens and returning an array ref with the tokens as items.  These are all &#39;temporaries&#39;.

Here is the input data structure:

my $test = {
    &#39;one&#39; =&gt; &#39;bg ha cc de af eg fa gw ik&#39;,
    &#39;two&#39; =&gt; &#39;cl jq nw tk jm ro qd rr apg&#39;,
    &#39;three&#39; =&gt; &#39;fw rs jy iu wt vv xx wz&#39;,
};

If you run the example on current versions without the fix you should see something like the following: 

do {
  my $a = {
    one   =&gt; [&#34;af&#34;, &#34;bg&#34;, &#34;cc&#34;, &#34;de&#34;, &#34;eg&#34;, &#34;fa&#34;, &#34;gw&#34;, &#34;ha&#34;, &#34;ik&#34;],
    three =&gt; [&#39;fix&#39;, &#39;fix&#39;, &#39;fix&#39;, &#39;fix&#39;, &#39;fix&#39;, &#39;fix&#39;, &#34;wz&#34;, &#34;xx&#34;],
    two   =&gt; [&#39;fix&#39;, &#39;fix&#39;, &#39;fix&#39;, &#39;fix&#39;, &#39;fix&#39;, &#34;qd&#34;, &#39;fix&#39;, &#34;rr&#34;, &#34;tk&#34;],
  };
  $a-&gt;{three}[0] = $a-&gt;{one}[3];
  $a-&gt;{three}[1] = $a-&gt;{one}[4];
  $a-&gt;{three}[2] = $a-&gt;{one}[5];
  $a-&gt;{three}[3] = $a-&gt;{one}[6];
  $a-&gt;{three}[4] = $a-&gt;{one}[7];
  $a-&gt;{three}[5] = $a-&gt;{one}[8];
  $a-&gt;{two}[0] = $a-&gt;{one}[6];
  $a-&gt;{two}[1] = $a-&gt;{one}[7];
  $a-&gt;{two}[2] = $a-&gt;{one}[8];
  $a-&gt;{two}[3] = $a-&gt;{three}[6];
  $a-&gt;{two}[4] = $a-&gt;{three}[7];
  $a-&gt;{two}[6] = $a-&gt;{one}[0];
  $a;
}

The correct output with the proposed fix is:

{
  one   =&gt; [&#34;af&#34;, &#34;bg&#34;, &#34;cc&#34;, &#34;de&#34;, &#34;eg&#34;, &#34;fa&#34;, &#34;gw&#34;, &#34;ha&#34;, &#34;ik&#34;],
  three =&gt; [&#34;fw&#34;, &#34;iu&#34;, &#34;jy&#34;, &#34;rs&#34;, &#34;vv&#34;, &#34;wt&#34;, &#34;wz&#34;, &#34;xx&#34;],
  two   =&gt; [&#34;apg&#34;, &#34;cl&#34;, &#34;jm&#34;, &#34;jq&#34;, &#34;nw&#34;, &#34;qd&#34;, &#34;ro&#34;, &#34;rr&#34;, &#34;tk&#34;],
}

The fix for this is really pretty simple.  We just need to keep the temporary references alive so the objects are not destroyed and re-used.  The easiest way to do that is to store the object references &#40;which may be temporaries&#41; in the seen map as one of the values.

Patch is attached, quick summary as follows for Dump.pm:181:

-       $seen{$id} = [$name, $idx];
+       $seen{$id} = [$name, $idx, $rval];
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> data-dump-bug.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/env perl
use warnings;
use strict;
use lib &#39;tt/Data-Dump-1.23/lib&#39;;

use Data::Dump::Filtered qw&#40;add_dump_filter&#41;;
use Data::Dump;

my $test = {
    &#39;one&#39; =&gt; &#39;bg ha cc de af eg fa gw ik&#39;,
    &#39;two&#39; =&gt; &#39;cl jq nw tk jm ro qd rr apg&#39;,
    &#39;three&#39; =&gt; &#39;fw rs jy iu wt vv xx wz&#39;,
};

add_dump_filter&#40; \&#38;filter_callback&#41;;
dd&#40;$test&#41;;

sub filter_callback {
    my&#40;$ctx, $object_ref&#41; = @_;

    if &#40;$ctx-&gt;is_scalar&#41; {
        my $line = ${$object_ref};

        my @lines = split&#40;/\s+/, $line&#41;;

        if &#40;@lines &gt; 1&#41; {
            return {object =&gt; [sort @lines]};
        } else {
            return {object =&gt; $lines[0]};
        }
    }
    return undef;
}
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dump.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Dump.pm	2016-05-26 11:58:12.680638000 -0400
+++ Dump.pm.new	2016-05-26 11:58:05.308304000 -0400
@@ -178,7 +178,7 @@
 	    return &#34;do{my \$fix}&#34; if @$idx &#38;&#38; $idx-&gt;[-1] eq &#39;$&#39;;
 	    return &#34;&#39;fix&#39;&#34;;
 	}
-	$seen{$id} = [$name, $idx];
+	$seen{$id} = [$name, $idx, $rval];
     }
 
     if &#40;$class&#41; {
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
