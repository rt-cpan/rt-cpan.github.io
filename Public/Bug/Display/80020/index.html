<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #80020 for CPAN2RT: Importing external bug tracker information into rt.cpan.org</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #80020 for CPAN2RT: Importing external bug tracker information into rt.cpan.org</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=CPAN2RT">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=CPAN2RT">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=CPAN2RT">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=CPAN2RT">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/CPAN2RT">CPAN2RT CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">80020</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=CPAN2RT">CPAN2RT</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
i.norton [...] shadowcat.co.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
mst [...] shadowcat.co.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-222388-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-222389-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




cpan2rt-external-bugtracker.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1133920/596690/cpan2rt-external-bugtracker.patch">
Sun Oct 28 07:37:32 2012 (6.4k) by IDN [...] cpan.org
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1126274/592508/cpan2rt-external-bugtracker.patch">
Fri Oct 05 06:08:52 2012 (6.1k) by IDN [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=80020">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1126274" href="/Public/Bug/Display.html?id=80020#txn-1126274">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;05&nbsp;06:08:52&nbsp;2012</span>
    <span class="description">IDN [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> mst [...] shadowcat.co.uk</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Importing external bug tracker information into rt.cpan.org</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1126274/592507/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/592507">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 663b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Peeps,

Please see the attached git diff for the addition of external bug
tracking information to the rt.cpan.org database.

Commit message as follows:

This patch adds the queue Attribute &#39;DistributionBugtracker&#39; which is
populated using data from the MetaCPAN API.

A two parse approach is taken, one to set or update the information from
MetaCPAN into the RT database and a second that removes the information
from queues that no longer require it.

It also includes a fix to correctly parse the skip options at the CLI.

Please let me know if you require any further information or changes.

This work has been sponsored by Shadowcat Systems.

Thanks, Ian.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> cpan2rt-external-bugtracker.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1126274/592508/cpan2rt-external-bugtracker.patch">Download cpan2rt-external-bugtracker.patch</a><br />
<span class="downloadcontenttype">text/x-diff 6.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/bin/cpan2rt b/bin/cpan2rt
index b334258..9cc172b 100755
--- a/bin/cpan2rt
+++ b/bin/cpan2rt
@@ -81,7 +81,7 @@ $commands{ $command }-&gt;&#40;&#41;;
 sub cmd_update {
     my %opt = &#40; sync =&gt; 1, force =&gt; 0, debug =&gt; 0, skip =&gt; [] &#41;;
     GetOptions&#40; \%opt, &#39;sync!&#39;, &#39;force!&#39;, &#39;debug!&#39;, &#39;home=s&#39;, &#39;datadir=s&#39;, &#39;mirror=s&#39;, &#39;skip=s@&#39; &#41;;
-    $opt{&#39;skip&#39;} = { map $_ =&gt; 1, @{$opt{&#39;skip&#39;}} };
+    $opt{&#39;skip&#39;} = { map { $_ =&gt; 1 } @{$opt{&#39;skip&#39;}} };
     my $importer = CPAN2RT-&gt;new&#40; %opt &#41;;
 
     $importer-&gt;sync_files&#40; $opt{&#39;mirror&#39;} &#41; if $opt{&#39;sync&#39;};
@@ -89,6 +89,7 @@ sub cmd_update {
     $importer-&gt;sync_distributions&#40; $opt{&#39;force&#39;} &#41; unless $opt{&#39;skip&#39;}{&#39;distributions&#39;};
     $importer-&gt;sync_versions&#40; $opt{&#39;force&#39;} &#41; unless $opt{&#39;skip&#39;}{&#39;versions&#39;};
     $importer-&gt;sync_maintainers&#40; $opt{&#39;force&#39;} &#41; unless $opt{&#39;skip&#39;}{&#39;maintainers&#39;};
+    $importer-&gt;sync_bugtracker&#40; $opt{&#39;force&#39;} &#41; unless $opt{&#39;skip&#39;}{&#39;bugtrackers&#39;};
 }
 
 sub usage {
diff --git a/lib/CPAN2RT.pm b/lib/CPAN2RT.pm
index 1f39c69..4262e4d 100644
--- a/lib/CPAN2RT.pm
+++ b/lib/CPAN2RT.pm
@@ -150,6 +150,82 @@ sub fetch_file {
     return 1;
 }
 
+=head2 fetch_bugtracker
+
+Retrieve bugtracker information from the meta CPAN API.
+
+=cut
+
+sub fetch_bugtracker {
+    my $self = shift;
+
+    my $url = &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://api.metacpan.org/v0/">http://api.metacpan.org/v0/</a></span>&#34;;
+    require MetaCPAN::API;
+    my $mcpan  = MetaCPAN::API-&gt;new&#40; 
+        base_url =&gt; $url,
+    &#41;;
+
+    # Pull the details of distribution bugtrackers
+    my $result = $mcpan-&gt;post&#40;
+        &#39;release/_search&#39;, {
+            query   =&gt; { match_all =&gt; {} },
+            size    =&gt; 5000,
+            fields  =&gt; [ &#34;distribution&#34; , &#34;resources.bugtracker&#34; ],
+            filter  =&gt; {
+                and =&gt; [{
+                    or =&gt; [
+                        { exists =&gt; { field =&gt; &#34;resources.bugtracker.email&#34; }},
+                        { exists =&gt; { field =&gt; &#34;resources.bugtracker.web&#34; }},
+                    ]},
+                    { term =&gt; { &#34;release.status&#34;   =&gt; &#34;latest&#34; }},
+                    { term =&gt; { &#34;release.maturity&#34; =&gt; &#34;released&#34; }},
+                ],
+            },
+        },
+    &#41;;
+
+    unless &#40; defined&#40;$result&#41; &#41; {
+        print STDERR &#34;Request to &#39;$url&#39; failed.\n&#34;;
+        return undef;
+    }
+
+    debug { &#34;Fetched &#39;$url&#39;\n&#34; };
+
+    my $data = {};
+
+    # Iterate the results from MetaCPAN
+    foreach my $dist &#40;@{$result-&gt;{hits}-&gt;{hits}}&#41; {
+        my $distribution = $dist-&gt;{fields}-&gt;{distribution};
+
+        # Email based alternative
+        if&#40;defined&#40;$dist-&gt;{&#34;fields&#34;}-&gt;{&#34;resources.bugtracker&#34;}-&gt;{&#34;email&#34;}&#41;&#41; {
+            my $email = $dist-&gt;{&#34;fields&#34;}-&gt;{&#34;resources.bugtracker&#34;}-&gt;{&#34;email&#34;};
+
+            # We don&#39;t care if this is rt.cpan.org
+            if&#40;$email =~ m/rt.cpan.org/&#41; {
+                next;
+            }
+
+            $data-&gt;{$distribution}-&gt;{&#34;email&#34;} = $email;
+        }
+
+        # Web based alternative
+        if&#40;defined&#40;$dist-&gt;{&#34;fields&#34;}-&gt;{&#34;resources.bugtracker&#34;}-&gt;{&#34;web&#34;}&#41;&#41; {
+            my $web = $dist-&gt;{&#34;fields&#34;}-&gt;{&#34;resources.bugtracker&#34;}-&gt;{&#34;web&#34;};
+
+            # We don&#39;t care if this is rt.cpan.org
+            if&#40;$web =~ m/rt.cpan.org/&#41; {
+                next;
+            }
+
+            $data-&gt;{$distribution}-&gt;{&#34;web&#34;} = $web;
+        }
+    }
+
+    return $data;
+}
+
+
 { my $cache;
 sub authors {
     my $self = shift;
@@ -293,6 +369,106 @@ sub sync_authors {
     return &#40;1&#41;;
 }
 
+sub sync_bugtracker {
+    my $self = shift;
+
+    my $data = $self-&gt;fetch_bugtracker&#40;&#41;;
+    $self-&gt;_sync_bugtracker_cpan2rt&#40;{ data =&gt; $data }&#41;;
+
+    $self-&gt;_sync_bugtracker_rt2cpan&#40;{ data =&gt; $data }&#41;;
+
+}
+
+=head2 _sync_bugtracker_cpan2rt
+
+Sync DistributionBugtracker info from CPAN to RT.
+This updates and adds to existing queues.
+
+=cut
+
+sub _sync_bugtracker_cpan2rt {
+    my $self = shift;
+    my $args = shift;
+
+    my $data = $args-&gt;{&#34;data&#34;};
+
+    # Iterate through the ditributions.
+    foreach my $dist &#40;keys&#40;%{$data}&#41;&#41; {
+        my $text = &#34;&#34;;
+
+        # Build the text to set in the queue attribute.
+        foreach my $method &#40;keys&#40;%{$data-&gt;{$dist}}&#41;&#41; {
+            my $uri = $data-&gt;{$dist}-&gt;{$method};
+
+            if&#40; $method eq &#34;email&#34; &#41; {
+                $text .= &#34;&lt;div&gt;Please email the &lt;a href=\&#34;mailto:$uri\&#34;&gt;alternative bug tracker&lt;/a&gt; to report your issue.&lt;/div&gt;&#34;;
+            }
+
+            elsif&#40; $method eq &#34;web&#34; &#41; {
+                $text .= &#34;&lt;div&gt;Please visit the &lt;a href=\&#34;$uri\&#34;&gt;alternative bug tracker&lt;/a&gt; to report your issue.&lt;/div&gt;&#34;;
+            }
+        }
+
+        # Fetch the queue
+        my $queue = $self-&gt;load_queue&#40; $dist &#41;;
+        unless&#40; $queue &#41; {
+            debug { &#34;No queue for dist &#39;$dist&#39;&#34; };
+            next;
+        }
+
+        my $name = &#34;DistributionBugtracker&#34;;
+
+        # Get the existing attribute from the queue and log if it&#39;s changing
+        my $attr = $queue-&gt;FirstAttribute&#40; $name &#41;;
+    
+        if&#40;defined&#40;$attr&#41;&#41; {
+            unless&#40;$attr-&gt;Content eq $text&#41; {
+                debug { &#34;Changing DistributionBugtracker for $dist from &#39;&#34; . $attr-&gt;Content . &#34;&#39; to &#39;$text&#39;\n&#34; };
+            }
+        }
+
+        else {
+            debug { &#34;Changing DistributionBugtracker for $dist from nothing to &#39;$text&#39;\n&#34; };
+        }
+
+        # Set the queue attribute
+        $queue-&gt;SetAttribute&#40;
+            Name    =&gt; $name,
+            Content =&gt; $text,
+        &#41;;
+    }
+}
+
+=head2 _sync_bugtracker_rt2cpan
+
+Sync DistributionBugtracker info from RT to CPAN.
+This deletes records that are no longer needed or missing in the source.
+
+=cut
+
+sub _sync_bugtracker_rt2cpan {
+    my $self = shift;
+    my $args = shift;
+
+    my $data = $args-&gt;{&#34;data&#34;};
+    my $name = &#34;DistributionBugtracker&#34;;
+
+    my $queues = RT::Queues-&gt;new&#40; $RT::SystemUser &#41;;
+    $queues-&gt;LimitAttribute&#40; NAME =&gt; $name &#41;;
+
+    # Iterate over queues from RT
+    while&#40;my $queue = $queues-&gt;Next&#40;&#41;&#41; {
+
+       my $dist = $queue-&gt;Name&#40;&#41;;
+
+       # Check that the source defines this queue as having an external tracker
+       unless&#40;defined&#40;$data-&gt;{$dist}&#41;&#41; {
+            # Delete the attribute, it&#39;s no longer needed.
+            $queue-&gt;DeleteAttribute&#40; $name &#41;;
+       }
+    }
+}
+
 sub sync_distributions {
     my $self = shift;
     my $force = shift;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1126284" href="/Public/Bug/Display.html?id=80020#txn-1126284">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;05&nbsp;06:19:25&nbsp;2012</span>
    <span class="description">IDN [...] cpan.org -  Dependency by ticket #79499 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1131100" href="/Public/Bug/Display.html?id=80020#txn-1131100">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;19&nbsp;19:22:03&nbsp;2012</span>
    <span class="description">trs [...] bestpractical.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #80020] Importing external bug tracker information into rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 19 Oct 2012 16:22:01 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CPAN2RT [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Thomas Sibley &lt;trs [...] bestpractical.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1131100/595128/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/595128">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 10/19/2012 04:02 PM, bug-CPAN2RT@rt.cpan.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Please see the attached git diff for the addition of external bug
&gt; tracking information to the rt.cpan.org database.
</div>
Thanks!  Overall this patch and your others for RT-BugTracker and
RT-BugTracker-Public look good.  I have a few notes below based on the
code, and if you could address those, that&#39;d be great.

The commit messages are much appreciated.  When applying your patches,
I&#39;ll likely break them up into a few more commits, just FYI.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; +=head2 fetch_bugtracker
&gt; +
&gt; +Retrieve bugtracker information from the meta CPAN API.
&gt; +
&gt; +=cut
&gt; +
&gt; +sub fetch_bugtracker {
&gt; +    my $self = shift;
&gt; +
&gt; +    my $url = &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://api.metacpan.org/v0/">http://api.metacpan.org/v0/</a></span>&#34;;
&gt; +    require MetaCPAN::API;
&gt; +    my $mcpan  = MetaCPAN::API-&gt;new&#40; 
&gt; +        base_url =&gt; $url,
</div>
Adding ua_args =&gt; [ agent =&gt; &#39;CPAN2RT&#39; ] here would be great.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; +    &#41;;
&gt; +
&gt; +    # Pull the details of distribution bugtrackers
&gt; +    my $result = $mcpan-&gt;post&#40;
&gt; +        &#39;release/_search&#39;, {
&gt; +            query   =&gt; { match_all =&gt; {} },
&gt; +            size    =&gt; 5000,
&gt; +            fields  =&gt; [ &#34;distribution&#34; , &#34;resources.bugtracker&#34; ],
&gt; +            filter  =&gt; {
&gt; +                and =&gt; [{
&gt; +                    or =&gt; [
&gt; +                        { exists =&gt; { field =&gt; &#34;resources.bugtracker.email&#34; }},
&gt; +                        { exists =&gt; { field =&gt; &#34;resources.bugtracker.web&#34; }},
&gt; +                    ]},
&gt; +                    { term =&gt; { &#34;release.status&#34;   =&gt; &#34;latest&#34; }},
&gt; +                    { term =&gt; { &#34;release.maturity&#34; =&gt; &#34;released&#34; }},
&gt; +                ],
&gt; +            },
&gt; +        },
&gt; +    &#41;;
</div>
1&#41; resources.bugtracker.email is spelled resources.bugtracker.mailto :&#41;

2&#41; Is it feasible to further limit returned results to those where .web
or .mailto lacks &#34;rt.cpan.org&#34;?

3&#41; What happens if there are more than 5000 distributions which have a
bugtracker defined?  There probably needs to be some pagination
happening. &#40;Scrolling in ES terms?&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; +=head2 _sync_bugtracker_cpan2rt
&gt; +
&gt; +Sync DistributionBugtracker info from CPAN to RT.
&gt; +This updates and adds to existing queues.
&gt; +
&gt; +=cut
&gt; +
&gt; +sub _sync_bugtracker_cpan2rt {
&gt; +    my $self = shift;
&gt; +    my $args = shift;
&gt; +
&gt; +    my $data = $args-&gt;{&#34;data&#34;};
&gt; +
&gt; +    # Iterate through the ditributions.
&gt; +    foreach my $dist &#40;keys&#40;%{$data}&#41;&#41; {
&gt; +        my $text = &#34;&#34;;
&gt; +
&gt; +        # Build the text to set in the queue attribute.
&gt; +        foreach my $method &#40;keys&#40;%{$data-&gt;{$dist}}&#41;&#41; {
&gt; +            my $uri = $data-&gt;{$dist}-&gt;{$method};
&gt; +
&gt; +            if&#40; $method eq &#34;email&#34; &#41; {
&gt; +                $text .= &#34;&lt;div&gt;Please email the &lt;a href=\&#34;mailto:$uri\&#34;&gt;alternative bug tracker&lt;/a&gt; to report your issue.&lt;/div&gt;&#34;;
&gt; +            }
&gt; +
&gt; +            elsif&#40; $method eq &#34;web&#34; &#41; {
&gt; +                $text .= &#34;&lt;div&gt;Please visit the &lt;a href=\&#34;$uri\&#34;&gt;alternative bug tracker&lt;/a&gt; to report your issue.&lt;/div&gt;&#34;;
&gt; +            }
&gt; +        }
</div>
The HTML really shouldn&#39;t be shoved into the attribute to be spit out
later.  RT::Attributes can contain arbitrary Perl data structures.  The
HTML rendering should be in /Dist/Elements/ShowBugtracker.

Note that this also opens up rt.cpan.org to XSS vulnerabilities because
$uri is unescaped.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; +
&gt; +        # Fetch the queue
&gt; +        my $queue = $self-&gt;load_queue&#40; $dist &#41;;
&gt; +        unless&#40; $queue &#41; {
&gt; +            debug { &#34;No queue for dist &#39;$dist&#39;&#34; };
&gt; +            next;
&gt; +        }
&gt; +
&gt; +        my $name = &#34;DistributionBugtracker&#34;;
&gt; +
&gt; +        # Get the existing attribute from the queue and log if it&#39;s changing
&gt; +        my $attr = $queue-&gt;FirstAttribute&#40; $name &#41;;
</div>
Use $queue-&gt;DistributionBugtracker and $queue-&gt;SetDistributionBugtracker
since you have those methods available.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; +        if&#40;defined&#40;$attr&#41;&#41; {
&gt; +            unless&#40;$attr-&gt;Content eq $text&#41; {
&gt; +                debug { &#34;Changing DistributionBugtracker for $dist from &#39;&#34; . $attr-&gt;Content . &#34;&#39; to &#39;$text&#39;\n&#34; };
&gt; +            }
&gt; +        }
&gt; +
&gt; +        else {
&gt; +            debug { &#34;Changing DistributionBugtracker for $dist from nothing to &#39;$text&#39;\n&#34; };
&gt; +        }
</div>
If the attribute is already the same, we should skip the update.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; +
&gt; +        # Set the queue attribute
&gt; +        $queue-&gt;SetAttribute&#40;
&gt; +            Name    =&gt; $name,
&gt; +            Content =&gt; $text,
&gt; +        &#41;;
&gt; +    }
&gt; +}
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1131103" href="/Public/Bug/Display.html?id=80020#txn-1131103">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;19&nbsp;19:22:04&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1133920" href="/Public/Bug/Display.html?id=80020#txn-1133920">#</a>      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;28&nbsp;07:37:32&nbsp;2012</span>
    <span class="description">IDN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1133920/596689/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/596689">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks!  Overall this patch and your others for RT-BugTracker and
&gt; RT-BugTracker-Public look good.  I have a few notes below based on the
&gt; code, and if you could address those, that&#39;d be great.
</div>
Cool, new patch attached here and on #79499.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; The commit messages are much appreciated.  When applying your patches,
&gt; I&#39;ll likely break them up into a few more commits, just FYI.
</div>
Sure.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 1&#41; resources.bugtracker.email is spelled resources.bugtracker.mailto
&gt; :&#41;
</div>
Whoops!  Corrected, also changed the variable name for consistency.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2&#41; Is it feasible to further limit returned results to those where
&gt; .web
&gt; or .mailto lacks &#34;rt.cpan.org&#34;?
</div>
Spoke to the metacpan guys on irc and seemingly it would be expensive to
do this server side.  Request submitted to have the fields added as full
text searchable - <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/CPAN-API/cpan-api/issues/238">https://github.com/CPAN-API/cpan-api/issues/238</a></span>
following a chat with clintongormley.  Once that&#39;s done then we can
improve this.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 3&#41; What happens if there are more than 5000 distributions which have a
&gt; bugtracker defined?  There probably needs to be some pagination
&gt; happening. &#40;Scrolling in ES terms?&#41;
</div>
Oh, that&#39;s a fail.  Switched to Elastic::Search as per the example on
the meta cpan site, I think this is correct now.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The HTML really shouldn&#39;t be shoved into the attribute to be spit out
&gt; later.  RT::Attributes can contain arbitrary Perl data structures.
&gt; The HTML rendering should be in /Dist/Elements/ShowBugtracker.
</div>
Yup, done that.  Also switched to using a hash for storage which means
we get both the mailto and the web rather than just the last one it sees.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Note that this also opens up rt.cpan.org to XSS vulnerabilities
&gt; because $uri is unescaped.
</div>
I&#39;ve added validation into the SetDistributionBugtracker sub in order to
check that both are correct using Email::Address &#40;this seems to be used
else where for similar&#41; and URI.  Is that good enough or do you have
something more specific in mind?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Use $queue-&gt;DistributionBugtracker and $queue-&gt;
&gt;SetDistributionBugtracker since you have those methods available.
</div>
Fair point, change made and additional validation added to the set function.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If the attribute is already the same, we should skip the update.
</div>
That&#39;s done now too.

Let me know if there are any further issues.

Regards, Ian.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> cpan2rt-external-bugtracker.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1133920/596690/cpan2rt-external-bugtracker.patch">Download cpan2rt-external-bugtracker.patch</a><br />
<span class="downloadcontenttype">text/x-diff 6.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/bin/cpan2rt b/bin/cpan2rt
index b334258..9cc172b 100755
--- a/bin/cpan2rt
+++ b/bin/cpan2rt
@@ -81,7 +81,7 @@ $commands{ $command }-&gt;&#40;&#41;;
 sub cmd_update {
     my %opt = &#40; sync =&gt; 1, force =&gt; 0, debug =&gt; 0, skip =&gt; [] &#41;;
     GetOptions&#40; \%opt, &#39;sync!&#39;, &#39;force!&#39;, &#39;debug!&#39;, &#39;home=s&#39;, &#39;datadir=s&#39;, &#39;mirror=s&#39;, &#39;skip=s@&#39; &#41;;
-    $opt{&#39;skip&#39;} = { map $_ =&gt; 1, @{$opt{&#39;skip&#39;}} };
+    $opt{&#39;skip&#39;} = { map { $_ =&gt; 1 } @{$opt{&#39;skip&#39;}} };
     my $importer = CPAN2RT-&gt;new&#40; %opt &#41;;
 
     $importer-&gt;sync_files&#40; $opt{&#39;mirror&#39;} &#41; if $opt{&#39;sync&#39;};
@@ -89,6 +89,7 @@ sub cmd_update {
     $importer-&gt;sync_distributions&#40; $opt{&#39;force&#39;} &#41; unless $opt{&#39;skip&#39;}{&#39;distributions&#39;};
     $importer-&gt;sync_versions&#40; $opt{&#39;force&#39;} &#41; unless $opt{&#39;skip&#39;}{&#39;versions&#39;};
     $importer-&gt;sync_maintainers&#40; $opt{&#39;force&#39;} &#41; unless $opt{&#39;skip&#39;}{&#39;maintainers&#39;};
+    $importer-&gt;sync_bugtracker&#40; $opt{&#39;force&#39;} &#41; unless $opt{&#39;skip&#39;}{&#39;bugtrackers&#39;};
 }
 
 sub usage {
diff --git a/lib/CPAN2RT.pm b/lib/CPAN2RT.pm
index 1f39c69..53597f2 100644
--- a/lib/CPAN2RT.pm
+++ b/lib/CPAN2RT.pm
@@ -150,6 +150,72 @@ sub fetch_file {
     return 1;
 }
 
+=head2 fetch_bugtracker
+
+Retrieve bugtracker information from the meta CPAN API.
+
+=cut
+
+sub fetch_bugtracker {
+    my $self = shift;
+
+    require ElasticSearch;
+    my $es = ElasticSearch-&gt;new&#40;
+        servers =&gt; &#39;api.metacpan.org&#39;,
+        no_refresh =&gt; 1,
+    &#41;;
+
+    # Pull the details of distribution bugtrackers
+    my $scroller = $es-&gt;scrolled_search&#40;
+        query       =&gt; { match_all =&gt; {} },
+        size        =&gt; 100,
+        search_type =&gt; &#39;scan&#39;,
+        scroll      =&gt; &#39;5m&#39;,
+        index       =&gt; &#39;v0&#39;,
+        type        =&gt; &#39;release&#39;,
+        fields  =&gt; [ &#34;distribution&#34; , &#34;resources.bugtracker&#34; ],
+        filter  =&gt; {
+            and =&gt; [{
+                or =&gt; [
+                    { exists =&gt; { field =&gt; &#34;resources.bugtracker.mailto&#34; }},
+                    { exists =&gt; { field =&gt; &#34;resources.bugtracker.web&#34; }},
+                ]},
+                { term =&gt; { &#34;release.status&#34;   =&gt; &#34;latest&#34; }},
+                { term =&gt; { &#34;release.maturity&#34; =&gt; &#34;released&#34; }},
+            ],
+        },
+    &#41;;
+
+    unless &#40; defined&#40;$scroller&#41; &#41; {
+        die&#40;&#34;Request to api.metacpan.org failed.\n&#34;&#41;;
+    }
+
+    debug { &#34;Fetched data from api.metacpan.org\n&#34; };
+
+    my $data = {};
+
+    # Iterate the results from MetaCPAN
+    while &#40; my $result = $scroller-&gt;next &#41; {
+
+        # Record data
+        my $distribution = $result-&gt;{&#34;fields&#34;}-&gt;{&#34;distribution&#34;};
+        my $mailto       = $result-&gt;{&#34;fields&#34;}-&gt;{&#34;resources.bugtracker&#34;}-&gt;{&#34;mailto&#34;};
+        my $web          = $result-&gt;{&#34;fields&#34;}-&gt;{&#34;resources.bugtracker&#34;}-&gt;{&#34;web&#34;};
+
+        # Email based alternative - we don&#39;t care if this is rt.cpan.org
+        if&#40;defined&#40;$mailto&#41; &#38;&#38; !&#40;$mailto =~ m/rt\.cpan\.org/&#41;&#41; {
+            $data-&gt;{$distribution}-&gt;{&#34;mailto&#34;} = $mailto;
+        }
+
+        # Web based alternative - we don&#39;t care if this is rt.cpan.org
+        if&#40;defined&#40;$web&#41; &#38;&#38; !&#40;$web =~ m/rt\.cpan\.org/&#41;&#41; {
+            $data-&gt;{$distribution}-&gt;{&#34;web&#34;} = $web;
+        }
+    }
+
+    return $data;
+}
+
 { my $cache;
 sub authors {
     my $self = shift;
@@ -293,6 +359,122 @@ sub sync_authors {
     return &#40;1&#41;;
 }
 
+sub sync_bugtracker {
+    my $self = shift;
+
+    my $data = $self-&gt;fetch_bugtracker&#40;&#41;;
+    $self-&gt;_sync_bugtracker_cpan2rt&#40;{ data =&gt; $data }&#41;;
+
+    $self-&gt;_sync_bugtracker_rt2cpan&#40;{ data =&gt; $data }&#41;;
+
+}
+
+=head2 _sync_bugtracker_cpan2rt
+
+Sync DistributionBugtracker info from CPAN to RT.
+This updates and adds to existing queues.
+
+=cut
+
+sub _sync_bugtracker_cpan2rt {
+    my $self = shift;
+    my $args = shift;
+
+    my $data = $args-&gt;{&#34;data&#34;};
+
+    # Iterate through the ditributions.
+    foreach my $dist &#40;keys&#40;%{$data}&#41;&#41; {
+        my $bugtracker = {};
+
+        # Build the text to set in the queue attribute.
+        foreach my $method &#40;keys&#40;%{$data-&gt;{$dist}}&#41;&#41; {
+            my $uri = $data-&gt;{$dist}-&gt;{$method};
+
+            if&#40; $method eq &#34;mailto&#34; || $method eq &#34;web&#34; &#41; {
+                $bugtracker-&gt;{$method} = $uri;
+            }
+        }
+
+        # Fetch the queue
+        my $queue = $self-&gt;load_queue&#40; $dist &#41;;
+        unless&#40; $queue &#41; {
+            debug { &#34;No queue for dist &#39;$dist&#39;&#34; };
+            next;
+        }
+
+        # Get the existing bugtracker from the queue and log if it&#39;s changing
+        my $attr = $queue-&gt;DistributionBugtracker&#40;&#41;;
+
+        # Set this if we need to update when we&#39;re done
+        my $update = 0;
+
+        # If the attr is defined, then check it hasn&#39;t changed.
+        if&#40;defined&#40;$attr&#41;&#41; {
+
+            debug { &#34;Bugtracker set for distribution &#39;$dist&#39;.  Has it changed?\n&#34; };
+
+            foreach my $method &#40;keys&#40;%{$bugtracker}&#41;&#41; {
+
+                if&#40;ref&#40;$attr&#41; eq &#34;REF&#34;&#41; {
+                    # If this method has changed, log it
+                    if&#40;defined&#40;$attr-&gt;{$method}&#41; &#38;&#38; $attr-&gt;{$method} ne $bugtracker-&gt;{$method}&#41; {
+                        debug { &#34;Changing DistributionBugtracker for $dist from &#39;&#34; . $attr-&gt;{$method} . &#34;&#39; to &#39;&#34; . $bugtracker-&gt;{$method} . &#34;&#39;\n&#34; };
+                        $update = 1;
+                    }
+                }
+
+                else {
+                    # Hmm, something odd happened.  Data in the db is wrong, fix it.
+                    $update = 1;
+                }
+            }
+        }
+
+        else {
+            debug { &#34;Setting DistributionBugtracker for $dist from nothing\n&#34; };
+            $update = 1;
+        }
+
+
+        if&#40;$update&#41; {
+            # Set the queue bugtracker
+            $queue-&gt;SetDistributionBugtracker&#40; $bugtracker &#41;;
+        }
+    }
+
+    return 1;
+}
+
+=head2 _sync_bugtracker_rt2cpan
+
+Sync DistributionBugtracker info from RT to CPAN.
+This deletes records that are no longer needed or missing in the source.
+
+=cut
+
+sub _sync_bugtracker_rt2cpan {
+    my $self = shift;
+    my $args = shift;
+
+    my $data = $args-&gt;{&#34;data&#34;};
+    my $name = &#34;DistributionBugtracker&#34;;
+
+    my $queues = RT::Queues-&gt;new&#40; $RT::SystemUser &#41;;
+    $queues-&gt;LimitAttribute&#40; NAME =&gt; $name &#41;;
+
+    # Iterate over queues from RT
+    while&#40;my $queue = $queues-&gt;Next&#40;&#41;&#41; {
+
+       my $dist = $queue-&gt;Name&#40;&#41;;
+
+       # Check that the source defines this queue as having an external tracker
+       unless&#40;defined&#40;$data-&gt;{$dist}&#41;&#41; {
+            # Delete the attribute, it&#39;s no longer needed.
+            $queue-&gt;DeleteAttribute&#40; $name &#41;;
+       }
+    }
+}
+
 sub sync_distributions {
     my $self = shift;
     my $force = shift;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1134697" href="/Public/Bug/Display.html?id=80020#txn-1134697">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;30&nbsp;15:14:09&nbsp;2012</span>
    <span class="description">trs [...] bestpractical.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #80020] Importing external bug tracker information into rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 30 Oct 2012 12:14:07 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CPAN2RT [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Thomas Sibley &lt;trs [...] bestpractical.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1134697/597116/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/597116">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 10/29/2012 11:19 AM, bug-CPAN2RT@rt.cpan.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; &gt; 2&#41; Is it feasible to further limit returned results to those where
&gt;&gt; &gt; .web or .mailto lacks &#34;rt.cpan.org&#34;?
</div>&gt; Spoke to the metacpan guys on irc and seemingly it would be expensive to
&gt; do this server side.  Request submitted to have the fields added as full
&gt; text searchable - <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/CPAN-API/cpan-api/issues/238">https://github.com/CPAN-API/cpan-api/issues/238</a></span>
&gt; following a chat with clintongormley.  Once that&#39;s done then we can
&gt; improve this.
</div>
Ah, thanks.  That&#39;s too bad we can&#39;t limit out of the gate.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Oh, that&#39;s a fail.  Switched to Elastic::Search as per the example on
&gt; the meta cpan site, I think this is correct now.
</div>
Great.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; &gt; Note that this also opens up rt.cpan.org to XSS vulnerabilities
&gt;&gt; &gt; because $uri is unescaped.
</div>&gt; I&#39;ve added validation into the SetDistributionBugtracker sub in order to
&gt; check that both are correct using Email::Address &#40;this seems to be used
&gt; else where for similar&#41; and URI.  Is that good enough or do you have
&gt; something more specific in mind?
</div>
++ for the Email::Address and URI validation, but there&#39;s another
underlying rendering issue: at display time you&#39;re including the &#34;|n&#34;
flag when interpolating the web/mailto URLs.  This tells Mason to not
apply it&#39;s default HTML escaping, which would allow third-party HTML
injection into rt.cpan.org.  Removing the |n is sufficient for that.

However, beyond just checking if .web parses with URI, we also need to
check that it&#39;s only a http or https URI.  Otherwise you can use other
schemes with security problems for a website &#40;data:, javascript:&#41;.

Otherwise, this round of patches looks good!  Thanks a lot for iterating
on this.  If you have the time, can you fix the security issues above?
If not, I&#39;ll wait to apply the patches until I have time to fix them as
well.

Cheers,
Thomas
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1193939" href="/Public/Bug/Display.html?id=80020#txn-1193939">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;22&nbsp;16:22:08&nbsp;2013</span>
    <span class="description">tsibley [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1193939/630011/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/630011">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ian,

Sorry for the long delay.  I&#39;ve applied your patches to CPAN2RT, RT-BugTracker, and RT-BugTracker-Public, with some minor tweaks here and there.  Each repo has an alternate-bugtracker branch.  The branches are on top of the rt4 branches in those extensions, which I&#39;m using as I prepare to upgrade rt.cpan.org to RT 4 from 3.8.  Eventually it&#39;ll all be merged down.

In testing it out, I&#39;ve noted that all of the alternate bugtracker data is loaded into memory from MetaCPAN.  This makes the cpan2rt importer take upwards of 500MB of memory from the MetaCPAN data alone &#40;skipping all other steps&#41;.  In the current and soon-to-be production environments, that&#39;s a no go to be running every two hours.  Hopefully down the road chewing through 500MB of RAM won&#39;t matter, but right now it does. :&#41;

I plan to rework it to be incremental and hence never load the entire dataset into memory, but I&#39;m going to focus on the RT 4 upgrade first and then roll out the alternate bugtracker data after.  This is just a status update for you.  If you have the cycles to make it incremental, that&#39;d be awesome and it would get rolled out that much sooner.

Cheers,
Thomas
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1197690" href="/Public/Bug/Display.html?id=80020#txn-1197690">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;02&nbsp;13:37:31&nbsp;2013</span>
    <span class="description">tsibley [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1197690/632195/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/632195">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 193b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Resolving.  These branches are merged into the rt4 branch, which will be deployed on rt.cpan.org during the RT upgrade.  The RT upgrade is currently in beta testing.

Thanks for your work, Ian!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1197693" href="/Public/Bug/Display.html?id=80020#txn-1197693">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;02&nbsp;13:37:42&nbsp;2013</span>
    <span class="description">tsibley [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.608125</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
