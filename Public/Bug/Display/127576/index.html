<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #127576 for Type-Tie: Doesn&#39;t work with Clone::clone</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #127576 for Type-Tie: Doesn&#39;t work with Clone::clone</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Type-Tie/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Type-Tie/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Type-Tie/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Type-Tie/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Type-Tie">Type-Tie CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">127576</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Type-Tie/Active/">Type-Tie</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
peter [...] morch.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-249732-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-249733-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;05&nbsp;06:36:55&nbsp;2018</span>
    <span class="description">peter [...] morch.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Doesn&#39;t work with Clone::clone</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 5 Nov 2018 12:36:28 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Type-Tie [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Valdemar Mørch &lt;peter [...] morch.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Clone::clone-ing a ttie-d variable causes an error when using it. I assume
because of the Inside-out object implementation.

Example:

#!/usr/bin/perl -w
use strict;
use Types::Standard qw&#40;-types&#41;;
use Type::Tie;
use Clone qw&#40;clone&#41;;
my %hash;
ttie %hash, Bool;
$hash{a} = 1;
my $clone = clone&#40;\%hash&#41;;
$clone-&gt;{a} = 1;

The last line dies with:
Can&#39;t use an undefined value as a subroutine reference at
/usr/share/perl5/Type/Tie.pm line 118.

Guesswork at analysis:

Type Type::Tie implementation makes use of Hash::Util::FieldHash for
inside-out-classes. And then it makes sense for clone not to work. And
indeed line 118 includes
    $check-&gt;&#40;$val&#41;
where $check is defined a few lines above as:
    my $check  = $CHECK{$self};
and $CHECK is a fieldhash.

So $self is cloned to a new object/ref, but new entries aren&#39;t put in
%TYPE, %COERCE and %CHECK.

&#40;It seems the Tie::* classes work fine with cloning and perldoc Clone shows
that it should also work for tied variables. So I don&#39;t think it is clone
per se.&#41;

It works if I just call
    ttie %$clone, Bool;
Before operating on $clone. But...

In reality, I&#39;m using it with Moo like so:

    {
        package MyTied;
        use Moo;
        use Types::Standard qw&#40;-types&#41;;
        use Type::Tie;
        has field =&gt; &#40;
            is =&gt; &#39;ro&#39;,
            default =&gt; sub {
                return ttie my %hash, Bool;
            }
        &#41;;
    }

    my $obj = MyTied-&gt;new&#40;&#41;;
    $obj-&gt;field-&gt;{foo} = 1;
    my $objclone = clone&#40;$obj&#41;;
    $objclone-&gt;field-&gt;{foo} = 1;

And so it would sorta break encapsulation if users of MyTied need to know
to do something special for MyTied objects.

Any suggestions on how to proceed, other than not clone-ing? Not being able
to clone otherwise pure Moo objects is nasty for us.

One workaround is to use Storable::dclone instead of Clone::clone and setup
the hooks correctly, but it seems like a lot of work, and still breaks for
Clone::clone &#40;and I don&#39;t necessarily control what my users are going to
use&#41;.

    #!/usr/bin/perl -w
    use strict;
    use Types::Standard qw&#40;-types&#41;;
    use Type::Tie;
    use Storable qw&#40;dclone thaw freeze&#41;;

    {
        package MyTied2;
        use Moo;
        use Types::Standard qw&#40;-types&#41;;
        use Type::Tie;
        use Storable;
        has field =&gt; &#40;
            is      =&gt; &#39;ro&#39;,
            default =&gt; sub {
                return ttie my %hash, Bool;
            }
        &#41;;

        sub STORABLE_freeze {
            my $self = shift;
            return Storable::freeze&#40;{ %$self }&#41;;
        }

        sub STORABLE_thaw {
            my &#40;$self, $cloning, $serialized&#41; = @_;
            my $selfRawHash = Storable::thaw&#40;$serialized&#41;;
            %$self = %$selfRawHash;
            ttie %{ $self-&gt;field }, Bool;
        }
    }

    my $obj = MyTied2-&gt;new&#40;&#41;;
    $obj-&gt;field-&gt;{foo} = 1;
    my $objclone = dclone&#40;$obj&#41;;
    $objclone-&gt;field-&gt;{foo} = 1;

I suggest that unless something can be done &#40;easily&#41; to let clone work,
then at least document this issue, so we know beforehand.

What do you think?

Peter
-- 
Peter Valdemar Mørch
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.morch.com">http://www.morch.com</a></span>
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;07&nbsp;14:21:14&nbsp;2018</span>
    <span class="description">perl [...] toby.ink -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Generally speaking, I&#39;d suggest replacing things like:

   my $objclone = clone&#40;$obj&#41;;

With this:

   my $objclone = $obj-&gt;clone;

Allowing the object to decide exactly how the cloning is performed. This would not only allow you to re-tie the cloned hash, but more generally allow objects more fine-grained control over how they&#39;re cloned.

For example, if you clone an Employee object which contains a reference to a Company object that the employee works at, you might not want the cloned employee to point to a cloned company, but instead to point to the original company, even if all the other data in the Employee object, you want to be deeply cloned.

I don&#39;t really want to change the inside-out objects used for Type::Tie, but I&#39;d happily accept a patch to make it behave better with Storable&#39;s dclone.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;07&nbsp;14:21:15&nbsp;2018</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;08&nbsp;07:51:17&nbsp;2018</span>
    <span class="description">peter [...] morch.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #127576] Doesn&#39;t work with Clone::clone</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 8 Nov 2018 13:50:32 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Type-Tie [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Valdemar Mørch &lt;peter [...] morch.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve created <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/tobyink/p5-type-tie/pull/1">https://github.com/tobyink/p5-type-tie/pull/1</a></span> as a suggestion
to get it working with Storable::dclone. What do you think?

Peter

On Wed, Nov 7, 2018 at 8:21 PM Toby Inkster via RT &lt;bug-Type-Tie@rt.cpan.org&gt;
wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=127576">https://rt.cpan.org/Ticket/Display.html?id=127576</a></span> &gt;
&gt;
&gt; Generally speaking, I&#39;d suggest replacing things like:
&gt;
&gt;    my $objclone = clone&#40;$obj&#41;;
&gt;
&gt; With this:
&gt;
&gt;    my $objclone = $obj-&gt;clone;
&gt;
&gt; Allowing the object to decide exactly how the cloning is performed. This
&gt; would not only allow you to re-tie the cloned hash, but more generally
&gt; allow objects more fine-grained control over how they&#39;re cloned.
&gt;
&gt; For example, if you clone an Employee object which contains a reference to
&gt; a Company object that the employee works at, you might not want the cloned
&gt; employee to point to a cloned company, but instead to point to the original
&gt; company, even if all the other data in the Employee object, you want to be
&gt; deeply cloned.
&gt;
&gt; I don&#39;t really want to change the inside-out objects used for Type::Tie,
&gt; but I&#39;d happily accept a patch to make it behave better with Storable&#39;s
&gt; dclone.
&gt;
</div>

-- 
Peter Valdemar Mørch
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.morch.com">http://www.morch.com</a></span>
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
