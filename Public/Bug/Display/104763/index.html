<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #104763 for Config-IniFiles: Importing config which is not written to file fails after re-reading</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #104763 for Config-IniFiles: Importing config which is not written to file fails after re-reading</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Config-IniFiles/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Config-IniFiles/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Config-IniFiles/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Config-IniFiles/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Config-IniFiles">Config-IniFiles CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">104763</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Config-IniFiles/Active/">Config-IniFiles</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
DBOOK [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-7712-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.86    </td>
  </tr>
  <tr id="CF-7713-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;29&nbsp;00:31:27&nbsp;2015</span>
    <span class="description">DBOOK [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Importing config which is not written to file fails after re-reading</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">When using the -import constructor option to import another Config::IniFiles object, any configuration that has not been written to a file is &#34;imported&#34; the first time the configuration is read from file, but is not imported if the configuration is reread.
I&#39;ve attached a test case to demonstrate this issue occurring in a few different ways.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> config-inifiles-import.t.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use warnings;
use Config::IniFiles;
use Test::More;
use File::Temp &#39;tempfile&#39;;

my $config_nofile = Config::IniFiles-&gt;new&#40;-allowempty =&gt; 1&#41;;
$config_nofile-&gt;newval&#40;&#39;section&#39;,&#39;param&#39;,1&#41;;

my &#40;$fh, $filename&#41; = tempfile;

## Import config, set filename, read config, then read again
my $config = Config::IniFiles-&gt;new&#40;-import =&gt; $config_nofile, -allowempty =&gt; 1&#41;;

ok&#40;$config-&gt;val&#40;&#39;section&#39;,&#39;param&#39;&#41;, &#39;Configuration is imported&#39;&#41;;

$config-&gt;SetFileName&#40;$filename&#41;;
$config-&gt;ReadConfig;
ok&#40;$config-&gt;val&#40;&#39;section&#39;,&#39;param&#39;&#41;, &#39;Configuration is still imported&#39;&#41;;

$config-&gt;ReadConfig;
ok&#40;$config-&gt;val&#40;&#39;section&#39;,&#39;param&#39;&#41;, &#39;Configuration is still imported&#39;&#41;; # fails

## Import config that has already been imported
$config = Config::IniFiles-&gt;new&#40;-import =&gt; $config_nofile, -allowempty =&gt; 1, -file =&gt; $filename&#41;;

ok&#40;$config-&gt;val&#40;&#39;section&#39;,&#39;param&#39;&#41;, &#39;Configuration is imported again&#39;&#41;; # fails

$config_nofile = Config::IniFiles-&gt;new;
$config_nofile-&gt;newval&#40;&#39;section&#39;,&#39;param&#39;,1&#41;;

## Import config and set filename in constructor, then read again
$config = Config::IniFiles-&gt;new&#40;-import =&gt; $config_nofile, -allowempty =&gt; 1, -file =&gt; $filename&#41;;

ok&#40;$config-&gt;val&#40;&#39;section&#39;,&#39;param&#39;&#41;, &#39;Configuration is imported&#39;&#41;;

$config-&gt;ReadConfig;
ok&#40;$config-&gt;val&#40;&#39;section&#39;,&#39;param&#39;&#41;, &#39;Configuration is still imported&#39;&#41;; # fails

## Import config that is written to file, but with parameters not written to file, then read again

my &#40;$fh2, $filename2&#41; = tempfile;
my $config_file = Config::IniFiles-&gt;new&#40;-allowempty =&gt; 1, -file =&gt; $filename2&#41;;
$config_file-&gt;newval&#40;&#39;section&#39;,&#39;param2&#39;,1&#41;;
$config_file-&gt;RewriteConfig;
$config_file-&gt;newval&#40;&#39;section&#39;,&#39;param&#39;,1&#41;;

$config = Config::IniFiles-&gt;new&#40;-import =&gt; $config_file, -allowempty =&gt; 1, -file =&gt; $filename&#41;;

ok&#40;$config-&gt;val&#40;&#39;section&#39;,&#39;param&#39;&#41;, &#39;Configuration is imported&#39;&#41;;

$config-&gt;ReadConfig;
ok&#40;$config-&gt;val&#40;&#39;section&#39;,&#39;param&#39;&#41;, &#39;Configuration is still imported&#39;&#41;; # fails

done_testing;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;29&nbsp;03:01:48&nbsp;2015</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri May 29 00:31:27 2015, DBOOK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; When using the -import constructor option to import another
&gt; Config::IniFiles object, any configuration that has not been written
&gt; to a file is &#34;imported&#34; the first time the configuration is read from
&gt; file, but is not imported if the configuration is reread.
&gt; I&#39;ve attached a test case to demonstrate this issue occurring in a few
&gt; different ways.
</div>
Hi Dan!

This is an acknowneldgement that I saw your test report, and will try to investigate it soon.

Regards,

-- Shlomi Fish
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;29&nbsp;03:01:49&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;10&nbsp;11:39:03&nbsp;2018</span>
    <span class="description">JJATRIA [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve looked at this a little bit and I&#39;ve identified the root of the problem.

The issue is with the &#39;firstload&#39; / re-load logic.

On the first call to $config-&gt;ReadConfig, the contents of {v} are cleared and then copied back from the imported $config_nofile. 

At the end of this call, $config-&gt;{firstload} is still true &#40;since we return before setting it to false, because $config has no filename&#41;.

Then we call $config-&gt;SetFilename.

Calling $config-&gt;ReadConfig again goes through the same process as before, except that this time, since we _do_ have a filename, we set $config-&gt;{firstload} to false and _then_ return.

The trap is set!

One of the first things that happens the next time $config-&gt;ReadConfig is called, is that $config-&gt;{v} is cleared.

Since $config has an import, and we just set $config-&gt;{firstload} to false, we call $config-&gt;{import}-&gt;ReadConfig &#40;which we haven&#39;t done before&#41;.

This clears {v} in the imported $config_nofile, and since that object has neither import or filename, it has nowhere to re-read its configuration from. When we return, {v} is still empty.

This is when we&#39;ve lost the data.

When $config tries to re-populate its {v} by copying it from the imported object &#40;with _deepcopy&#41;, all it gets is an empty hash.

In part because I&#39;m not that familiar with the distribution, I&#39;m not sure how much of this is expected behaviour. But this can be fixed pretty trivially by removing the line that sets &#39;firstload&#39; to false in ReadConfig.

I&#39;m assuming, however, that that logic is there for a reason.

If I can get a better idea of what is the expected behaviour in this case, I&#39;ll be happy to put together a pull request.

&#40;This was done as part of the CPAN pull request challenge&#41;.

On Fri May 29 03:01:48 2015, SHLOMIF wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri May 29 00:31:27 2015, DBOOK wrote:
<div class="message-stanza open">&gt; &gt; When using the -import constructor option to import another
&gt; &gt; Config::IniFiles object, any configuration that has not been written
&gt; &gt; to a file is &#34;imported&#34; the first time the configuration is read from
&gt; &gt; file, but is not imported if the configuration is reread.
&gt; &gt; I&#39;ve attached a test case to demonstrate this issue occurring in a
&gt; &gt; few
&gt; &gt; different ways.
</div>&gt; 
&gt; Hi Dan!
&gt; 
&gt; This is an acknowneldgement that I saw your test report, and will try
&gt; to investigate it soon.
&gt; 
&gt; Regards,
&gt; 
&gt; -- Shlomi Fish
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;10&nbsp;13:17:22&nbsp;2018</span>
    <span class="description">shlomif [...] shlomifish.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #104763] Importing config which is not written to file fails after re-reading</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 10 Mar 2018 19:55:34 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Config-IniFiles [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Shlomi Fish &lt;shlomif [...] shlomifish.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat, 10 Mar 2018 11:39:03 -0500
&#34;José Joaquín Atria via RT&#34; &lt;bug-Config-IniFiles@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Config-IniFiles
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=104763">https://rt.cpan.org/Ticket/Display.html?id=104763</a></span> &gt;
&gt; 
&gt; I&#39;ve looked at this a little bit and I&#39;ve identified the root of the problem.
&gt; 
&gt; The issue is with the &#39;firstload&#39; / re-load logic.
&gt; 
&gt; On the first call to $config-&gt;ReadConfig, the contents of {v} are cleared and
&gt; then copied back from the imported $config_nofile. 
&gt; 
&gt; At the end of this call, $config-&gt;{firstload} is still true &#40;since we return
&gt; before setting it to false, because $config has no filename&#41;.
&gt; 
&gt; Then we call $config-&gt;SetFilename.
&gt; 
&gt; Calling $config-&gt;ReadConfig again goes through the same process as before,
&gt; except that this time, since we _do_ have a filename, we set
&gt; $config-&gt;{firstload} to false and _then_ return.
&gt; 
&gt; The trap is set!
&gt; 
&gt; One of the first things that happens the next time $config-&gt;ReadConfig is
&gt; called, is that $config-&gt;{v} is cleared.
&gt; 
&gt; Since $config has an import, and we just set $config-&gt;{firstload} to false,
&gt; we call $config-&gt;{import}-&gt;ReadConfig &#40;which we haven&#39;t done before&#41;.
&gt; 
&gt; This clears {v} in the imported $config_nofile, and since that object has
&gt; neither import or filename, it has nowhere to re-read its configuration from.
&gt; When we return, {v} is still empty.
&gt; 
&gt; This is when we&#39;ve lost the data.
&gt; 
&gt; When $config tries to re-populate its {v} by copying it from the imported
&gt; object &#40;with _deepcopy&#41;, all it gets is an empty hash.
&gt; 
&gt; In part because I&#39;m not that familiar with the distribution, I&#39;m not sure how
&gt; much of this is expected behaviour. But this can be fixed pretty trivially by
&gt; removing the line that sets &#39;firstload&#39; to false in ReadConfig.
&gt; 
&gt; I&#39;m assuming, however, that that logic is there for a reason.
&gt; 
&gt; If I can get a better idea of what is the expected behaviour in this case,
&gt; I&#39;ll be happy to put together a pull request.
&gt; 
&gt; &#40;This was done as part of the CPAN pull request challenge&#41;.
&gt; 
</div>
Hi Jose!

If the change passes all existing tests and also allows the new tests to pass,
then I am fine with incorporating it. C::IF has gone through a lot of cruft, and
some of it makes no sense any more.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri May 29 03:01:48 2015, SHLOMIF wrote:
<div class="message-stanza open">&gt; &gt; On Fri May 29 00:31:27 2015, DBOOK wrote:  
<div class="message-stanza open">&gt; &gt; &gt; When using the -import constructor option to import another
&gt; &gt; &gt; Config::IniFiles object, any configuration that has not been written
&gt; &gt; &gt; to a file is &#34;imported&#34; the first time the configuration is read from
&gt; &gt; &gt; file, but is not imported if the configuration is reread.
&gt; &gt; &gt; I&#39;ve attached a test case to demonstrate this issue occurring in a
&gt; &gt; &gt; few
&gt; &gt; &gt; different ways.  
</div>&gt; &gt; 
&gt; &gt; Hi Dan!
&gt; &gt; 
&gt; &gt; This is an acknowneldgement that I saw your test report, and will try
&gt; &gt; to investigate it soon.
&gt; &gt; 
&gt; &gt; Regards,
&gt; &gt; 
&gt; &gt; -- Shlomi Fish  
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;15&nbsp;19:21:27&nbsp;2018</span>
    <span class="description">JJATRIA [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Great!

I&#39;ve just created <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/shlomif/perl-Config-IniFiles/pull/2">https://github.com/shlomif/perl-Config-IniFiles/pull/2</a></span> which should fix this. I&#39;ll be happy to receive comments about it.

On Sat Mar 10 13:17:22 2018, shlomif@shlomifish.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sat, 10 Mar 2018 11:39:03 -0500
&gt; &#34;José Joaquín Atria via RT&#34; &lt;bug-Config-IniFiles@rt.cpan.org&gt; wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; Queue: Config-IniFiles
&gt; &gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=104763">https://rt.cpan.org/Ticket/Display.html?id=104763</a></span> &gt;
&gt; &gt;
&gt; &gt; I&#39;ve looked at this a little bit and I&#39;ve identified the root of the
&gt; &gt; problem.
&gt; &gt;
&gt; &gt; The issue is with the &#39;firstload&#39; / re-load logic.
&gt; &gt;
&gt; &gt; On the first call to $config-&gt;ReadConfig, the contents of {v} are
&gt; &gt; cleared and
&gt; &gt;  then copied back from the imported $config_nofile.
&gt; &gt;
&gt; &gt; At the end of this call, $config-&gt;{firstload} is still true &#40;since we
&gt; &gt; return
&gt; &gt; before setting it to false, because $config has no filename&#41;.
&gt; &gt;
&gt; &gt; Then we call $config-&gt;SetFilename.
&gt; &gt;
&gt; &gt; Calling $config-&gt;ReadConfig again goes through the same process as
&gt; &gt; before,
&gt; &gt; except that this time, since we _do_ have a filename, we set
&gt; &gt; $config-&gt;{firstload} to false and _then_ return.
&gt; &gt;
&gt; &gt; The trap is set!
&gt; &gt;
&gt; &gt; One of the first things that happens the next time $config-
<div class="message-stanza open">&gt; &gt; &gt;ReadConfig is
</div>&gt; &gt; called, is that $config-&gt;{v} is cleared.
&gt; &gt;
&gt; &gt; Since $config has an import, and we just set $config-&gt;{firstload} to
&gt; &gt; false,
&gt; &gt; we call $config-&gt;{import}-&gt;ReadConfig &#40;which we haven&#39;t done before&#41;.
&gt; &gt;
&gt; &gt; This clears {v} in the imported $config_nofile, and since that object
&gt; &gt; has
&gt; &gt; neither import or filename, it has nowhere to re-read its
&gt; &gt; configuration from.
&gt; &gt; When we return, {v} is still empty.
&gt; &gt;
&gt; &gt; This is when we&#39;ve lost the data.
&gt; &gt;
&gt; &gt; When $config tries to re-populate its {v} by copying it from the
&gt; &gt; imported
&gt; &gt; object &#40;with _deepcopy&#41;, all it gets is an empty hash.
&gt; &gt;
&gt; &gt; In part because I&#39;m not that familiar with the distribution, I&#39;m not
&gt; &gt; sure how
&gt; &gt; much of this is expected behaviour. But this can be fixed pretty
&gt; &gt; trivially by
&gt; &gt; removing the line that sets &#39;firstload&#39; to false in ReadConfig.
&gt; &gt;
&gt; &gt; I&#39;m assuming, however, that that logic is there for a reason.
&gt; &gt;
&gt; &gt; If I can get a better idea of what is the expected behaviour in this
&gt; &gt; case,
&gt; &gt; I&#39;ll be happy to put together a pull request.
&gt; &gt;
&gt; &gt; &#40;This was done as part of the CPAN pull request challenge&#41;.
&gt; &gt;
</div>&gt; 
&gt; Hi Jose!
&gt; 
&gt; If the change passes all existing tests and also allows the new tests
&gt; to pass,
&gt; then I am fine with incorporating it. C::IF has gone through a lot of
&gt; cruft, and
&gt; some of it makes no sense any more.
&gt; 
&gt; 
<div class="message-stanza open">&gt; &gt; On Fri May 29 03:01:48 2015, SHLOMIF wrote:
<div class="message-stanza open">&gt; &gt; &gt; On Fri May 29 00:31:27 2015, DBOOK wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; When using the -import constructor option to import another
&gt; &gt; &gt; &gt; Config::IniFiles object, any configuration that has not been
&gt; &gt; &gt; &gt; written
&gt; &gt; &gt; &gt; to a file is &#34;imported&#34; the first time the configuration is read
&gt; &gt; &gt; &gt; from
&gt; &gt; &gt; &gt; file, but is not imported if the configuration is reread.
&gt; &gt; &gt; &gt; I&#39;ve attached a test case to demonstrate this issue occurring in
&gt; &gt; &gt; &gt; a
&gt; &gt; &gt; &gt; few
&gt; &gt; &gt; &gt;   different ways.
</div>&gt; &gt; &gt;
&gt; &gt; &gt; Hi Dan!
&gt; &gt; &gt;
&gt; &gt; &gt; This is an acknowneldgement that I saw your test report, and will
&gt; &gt; &gt; try
&gt; &gt; &gt; to investigate it soon.
&gt; &gt; &gt;
&gt; &gt; &gt; Regards,
&gt; &gt; &gt;
&gt; &gt; &gt; -- Shlomi Fish
</div></div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;16&nbsp;06:01:36&nbsp;2018</span>
    <span class="description">shlomif [...] shlomifish.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #104763] Importing config which is not written to file fails after re-reading</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 16 Mar 2018 12:01:16 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Config-IniFiles [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Shlomi Fish &lt;shlomif [...] shlomifish.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, 15 Mar 2018 19:21:27 -0400
&#34;José Joaquín Atria via RT&#34; &lt;bug-Config-IniFiles@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Config-IniFiles
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=104763">https://rt.cpan.org/Ticket/Display.html?id=104763</a></span> &gt;
&gt; 
&gt; Great!
&gt; 
&gt; I&#39;ve just created <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/shlomif/perl-Config-IniFiles/pull/2">https://github.com/shlomif/perl-Config-IniFiles/pull/2</a></span>
&gt; which should fix this. I&#39;ll be happy to receive comments about it.
&gt; 
</div>
thanks! I&#39;ll take a look.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sat Mar 10 13:17:22 2018, shlomif@shlomifish.org wrote:
<div class="message-stanza open">&gt; &gt; On Sat, 10 Mar 2018 11:39:03 -0500
&gt; &gt; &#34;José Joaquín Atria via RT&#34; &lt;bug-Config-IniFiles@rt.cpan.org&gt; wrote:
&gt; &gt;   
<div class="message-stanza open">&gt; &gt; &gt; Queue: Config-IniFiles
&gt; &gt; &gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=104763">https://rt.cpan.org/Ticket/Display.html?id=104763</a></span> &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; I&#39;ve looked at this a little bit and I&#39;ve identified the root of the
&gt; &gt; &gt; problem.
&gt; &gt; &gt;
&gt; &gt; &gt; The issue is with the &#39;firstload&#39; / re-load logic.
&gt; &gt; &gt;
&gt; &gt; &gt; On the first call to $config-&gt;ReadConfig, the contents of {v} are
&gt; &gt; &gt; cleared and
&gt; &gt; &gt;  then copied back from the imported $config_nofile.
&gt; &gt; &gt;
&gt; &gt; &gt; At the end of this call, $config-&gt;{firstload} is still true &#40;since we
&gt; &gt; &gt; return
&gt; &gt; &gt; before setting it to false, because $config has no filename&#41;.
&gt; &gt; &gt;
&gt; &gt; &gt; Then we call $config-&gt;SetFilename.
&gt; &gt; &gt;
&gt; &gt; &gt; Calling $config-&gt;ReadConfig again goes through the same process as
&gt; &gt; &gt; before,
&gt; &gt; &gt; except that this time, since we _do_ have a filename, we set
&gt; &gt; &gt; $config-&gt;{firstload} to false and _then_ return.
&gt; &gt; &gt;
&gt; &gt; &gt; The trap is set!
&gt; &gt; &gt;
&gt; &gt; &gt; One of the first things that happens the next time $config-  
<div class="message-stanza open">&gt; &gt; &gt; &gt;ReadConfig is  
</div>&gt; &gt; &gt; called, is that $config-&gt;{v} is cleared.
&gt; &gt; &gt;
&gt; &gt; &gt; Since $config has an import, and we just set $config-&gt;{firstload} to
&gt; &gt; &gt; false,
&gt; &gt; &gt; we call $config-&gt;{import}-&gt;ReadConfig &#40;which we haven&#39;t done before&#41;.
&gt; &gt; &gt;
&gt; &gt; &gt; This clears {v} in the imported $config_nofile, and since that object
&gt; &gt; &gt; has
&gt; &gt; &gt; neither import or filename, it has nowhere to re-read its
&gt; &gt; &gt; configuration from.
&gt; &gt; &gt; When we return, {v} is still empty.
&gt; &gt; &gt;
&gt; &gt; &gt; This is when we&#39;ve lost the data.
&gt; &gt; &gt;
&gt; &gt; &gt; When $config tries to re-populate its {v} by copying it from the
&gt; &gt; &gt; imported
&gt; &gt; &gt; object &#40;with _deepcopy&#41;, all it gets is an empty hash.
&gt; &gt; &gt;
&gt; &gt; &gt; In part because I&#39;m not that familiar with the distribution, I&#39;m not
&gt; &gt; &gt; sure how
&gt; &gt; &gt; much of this is expected behaviour. But this can be fixed pretty
&gt; &gt; &gt; trivially by
&gt; &gt; &gt; removing the line that sets &#39;firstload&#39; to false in ReadConfig.
&gt; &gt; &gt;
&gt; &gt; &gt; I&#39;m assuming, however, that that logic is there for a reason.
&gt; &gt; &gt;
&gt; &gt; &gt; If I can get a better idea of what is the expected behaviour in this
&gt; &gt; &gt; case,
&gt; &gt; &gt; I&#39;ll be happy to put together a pull request.
&gt; &gt; &gt;
&gt; &gt; &gt; &#40;This was done as part of the CPAN pull request challenge&#41;.
&gt; &gt; &gt;  
</div>&gt; &gt; 
&gt; &gt; Hi Jose!
&gt; &gt; 
&gt; &gt; If the change passes all existing tests and also allows the new tests
&gt; &gt; to pass,
&gt; &gt; then I am fine with incorporating it. C::IF has gone through a lot of
&gt; &gt; cruft, and
&gt; &gt; some of it makes no sense any more.
&gt; &gt; 
&gt; &gt;   
<div class="message-stanza open">&gt; &gt; &gt; On Fri May 29 03:01:48 2015, SHLOMIF wrote:  
<div class="message-stanza open">&gt; &gt; &gt; &gt; On Fri May 29 00:31:27 2015, DBOOK wrote:  
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; When using the -import constructor option to import another
&gt; &gt; &gt; &gt; &gt; Config::IniFiles object, any configuration that has not been
&gt; &gt; &gt; &gt; &gt; written
&gt; &gt; &gt; &gt; &gt; to a file is &#34;imported&#34; the first time the configuration is read
&gt; &gt; &gt; &gt; &gt; from
&gt; &gt; &gt; &gt; &gt; file, but is not imported if the configuration is reread.
&gt; &gt; &gt; &gt; &gt; I&#39;ve attached a test case to demonstrate this issue occurring in
&gt; &gt; &gt; &gt; &gt; a
&gt; &gt; &gt; &gt; &gt; few
&gt; &gt; &gt; &gt; &gt;   different ways.  
</div>&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Hi Dan!
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; This is an acknowneldgement that I saw your test report, and will
&gt; &gt; &gt; &gt; try
&gt; &gt; &gt; &gt; to investigate it soon.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Regards,
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; -- Shlomi Fish  
</div></div></div></div>


-- 
-----------------------------------------------------------------
Shlomi Fish       <span class="clickylink"><a target="new" rel="nofollow" href="http://www.shlomifish.org/">http://www.shlomifish.org/</a></span>
Summer Glau Facts - <span class="clickylink"><a target="new" rel="nofollow" href="http://shlom.in/sglau-facts">http://shlom.in/sglau-facts</a></span>

A man in love is incomplete until he is married.  Then he is finished.
    — Zsa Zsa Gabor, &#34;Newsweek&#34;

Please reply to list if it&#39;s a mailing list post - <span class="clickylink"><a target="new" rel="nofollow" href="http://shlom.in/reply">http://shlom.in/reply</a></span> .
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;18&nbsp;02:23:14&nbsp;2018</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Mar 15 19:21:27 2018, JJATRIA wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Great!
&gt; 
&gt; I&#39;ve just created <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/shlomif/perl-Config-">https://github.com/shlomif/perl-Config-</a></span>
&gt; IniFiles/pull/2 which should fix this. I&#39;ll be happy to receive
&gt; comments about it.
&gt; 
</div>
This pull-req was merged and is part of the 2.95 release. Resolving this ticket. Thanks all, and feel free to contribute more!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;18&nbsp;02:23:16&nbsp;2018</span>
    <span class="description">SHLOMIF [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
