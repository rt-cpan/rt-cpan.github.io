<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #95072 for POE: CPU pinned at 100% with POE::Component::Server::TCP and SSLify</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #95072 for POE: CPU pinned at 100% with POE::Component::Server::TCP and SSLify</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/POE/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/POE/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/POE/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/POE/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/POE">POE CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">95072</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/POE/Active/">POE</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jhuckaby [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-26342-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-26343-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;26&nbsp;12:21:04&nbsp;2014</span>
    <span class="description">jhuckaby [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> CPU pinned at 100% with POE::Component::Server::TCP and SSLify</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 26 Apr 2014 09:20:45 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Joseph Huckaby &lt;jhuckaby [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hey POE Team,

I believe I have found a bug using POE::Component::Server::TCP and SSLify.  I have a very simple HTTPS web server &#40;created using the cookbook example&#41;, which does nothing except serve up 300K of plain text for every incoming HTTPS GET request.  This works fine until it receives multiple requests at once.  Then it shoots up to 100% CPU and stays there indefinitely, long after the requests have completed.

Here is a snapshot of &#34;top&#34; on my server after sending in 10 simultaneous requests and allowing them to complete fully:

 PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
1365 root      20   0  191m  20m 4168 R 99.9  0.6   0:10.95 perl

The CPU stays at or around 99.9% indefinitely &#40;I have witnessed several days at least&#41;.  Also, something to note, even after the CPU is pinned at 100%, the server still accepts new incoming connections, and serves them.

Here is a ZIP file containing my script and sample SSL cert:
<span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug.zip">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug.zip</a></span>

Here are links to the individual files:
<span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/server.pl">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/server.pl</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.crt">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.crt</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.key">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/ssl.key</a></span>

I can reproduce the issue every time by sending in 10 simultaneous HTTPS GET requests from a shell script such as this:

#!/bin/sh
# Fetch URL 10 times simultaneously
curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;
curl --insecure &#34;$1&#34; &gt;/dev/null 2&gt;&#38;1 &#38;

The --insecure flag is to prevent curl from validating the cert &#40;which is self-signed&#41;.

I am running:
POE version 1.358
POE::Component::SSLify version 1.008

This is perl 5, version 16, subversion 3 &#40;v5.16.3&#41; built for x86_64-linux-thread-multi
Linux pvp.effectgames.com 3.4.82-69.112.amzn1.x86_64 #1 SMP Mon Feb 24 16:31:21 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux

openssl-perl-1.0.1g-1.69.amzn1.x86_64
openssl-1.0.1g-1.69.amzn1.x86_64

Other Notes: I cannot reproduce this without SSLify.  Meaning, if I strip out all the SSL code and just run a plain HTTP server, everything works fine.  Also note that I cannot seem to reproduce this on my local OS X machine hitting localhost, although I suspect that is because localhost is a virtual interface, and all the requests complete &#34;instantly&#34;.  This bug seems to require a slower network &#40;DSL to Amazon EC2 for example&#41; to occur.

If there is anything else you&#39;d like me to try, please let me know.  My server is at your disposal!

Thanks for your time!

- Joe
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;27&nbsp;12:36:06&nbsp;2014</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Apr 26 12:21:04 2014, jhuckaby@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hey POE Team,
&gt; 
&gt; I believe I have found a bug using POE::Component::Server::TCP and
&gt; SSLify.
</div>
Hi, Joe!

I&#39;ve run your test server and script here, and I&#39;m not seeing high CPU afterwards.  Of course I&#39;m using localhost on OS X, and you&#39;ve already said that doesn&#39;t reproduce the problem.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If there is anything else you&#39;d like me to try, please let me know.
&gt; My server is at your disposal!
</div>
Spinning can be caused by two things.  First, a filehandle is ready for action, but application &#40;or library&#41; code isn&#39;t handling the condition.  Second, something is posting messages just as fast as they&#39;re being consumed, forever.

An strace &#40;or equivalent&#41; report would quickly tell us what&#39;s going on under the hood.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;27&nbsp;12:36:07&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;27&nbsp;13:13:41&nbsp;2014</span>
    <span class="description">jhuckaby [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95072] CPU pinned at 100% with POE::Component::Server::TCP and SSLify</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 27 Apr 2014 10:13:24 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Joseph Huckaby &lt;jhuckaby [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hey Rocco!

Thanks for the quick reply!  Here is the strace you asked for.  I let it run for several seconds after 10 HTTPS requests completed, with CPU confirmed at 100%:

<span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/trace.out.gz">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/trace.out.gz</a></span>

Looks like it&#39;s getting stuck in some kind of date/time/select loop:

select&#40;16, [3 4 7 8 9 10 11 13], [7 8 9 10 11 13], [], {3599, 999931}&#41; = 6 &#40;out [7 8 9 10 11 13], left {3599, 999927}&#41;
gettimeofday&#40;{1398618191, 49675}, NULL&#41; = 0
gettimeofday&#40;{1398618191, 50301}, NULL&#41; = 0
gettimeofday&#40;{1398618191, 50370}, NULL&#41; = 0
gettimeofday&#40;{1398618191, 50438}, NULL&#41; = 0
select&#40;16, [3 4 7 8 9 10 11 13], [7 8 9 10 11 13], [], {3599, 999932}&#41; = 6 &#40;out [7 8 9 10 11 13], left {3599, 999929}&#41;
gettimeofday&#40;{1398618191, 50605}, NULL&#41; = 0
gettimeofday&#40;{1398618191, 51296}, NULL&#41; = 0
gettimeofday&#40;{1398618191, 51367}, NULL&#41; = 0
gettimeofday&#40;{1398618191, 51435}, NULL&#41; = 0
select&#40;16, [3 4 7 8 9 10 11 13], [7 8 9 10 11 13], [], {3599, 999932}&#41; = 6 &#40;out [7 8 9 10 11 13], left {3599, 999928}&#41;
gettimeofday&#40;{1398618191, 51604}, NULL&#41; = 0
gettimeofday&#40;{1398618191, 52235}, NULL&#41; = 0
gettimeofday&#40;{1398618191, 52304}, NULL&#41; = 0
gettimeofday&#40;{1398618191, 52372}, NULL&#41; = 0
select&#40;16, [3 4 7 8 9 10 11 13], [7 8 9 10 11 13], [], {3599, 999932}&#41; = 6 &#40;out [7 8 9 10 11 13], left {3599, 999928}&#41;
gettimeofday&#40;{1398618191, 52540}, NULL&#41; = 0
gettimeofday&#40;{1398618191, 53166}, NULL&#41; = 0
gettimeofday&#40;{1398618191, 53235}, NULL&#41; = 0
gettimeofday&#40;{1398618191, 53303}, NULL&#41; = 0

- Joe




On Apr 27, 2014, at 9:36 AM, &#34;Rocco Caputo via RT&#34; &lt;bug-POE@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95072">https://rt.cpan.org/Ticket/Display.html?id=95072</a></span> &gt;
&gt; 
&gt; On Sat Apr 26 12:21:04 2014, jhuckaby@gmail.com wrote:
<div class="message-stanza open">&gt;&gt; Hey POE Team,
&gt;&gt; 
&gt;&gt; I believe I have found a bug using POE::Component::Server::TCP and
&gt;&gt; SSLify.
</div>&gt; 
&gt; Hi, Joe!
&gt; 
&gt; I&#39;ve run your test server and script here, and I&#39;m not seeing high CPU afterwards.  Of course I&#39;m using localhost on OS X, and you&#39;ve already said that doesn&#39;t reproduce the problem.
&gt; 
<div class="message-stanza open">&gt;&gt; If there is anything else you&#39;d like me to try, please let me know.
&gt;&gt; My server is at your disposal!
</div>&gt; 
&gt; Spinning can be caused by two things.  First, a filehandle is ready for action, but application &#40;or library&#41; code isn&#39;t handling the condition.  Second, something is posting messages just as fast as they&#39;re being consumed, forever.
&gt; 
&gt; An strace &#40;or equivalent&#41; report would quickly tell us what&#39;s going on under the hood.
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;27&nbsp;13:48:00&nbsp;2014</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Apr 27 13:13:41 2014, jhuckaby@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Looks like it&#39;s getting stuck in some kind of date/time/select loop:
&gt; 
&gt; select&#40;16, [3 4 7 8 9 10 11 13], [7 8 9 10 11 13], [], {3599, 999931}&#41;
&gt; = 6 &#40;out [7 8 9 10 11 13], left {3599, 999927}&#41;
&gt; gettimeofday&#40;{1398618191, 49675}, NULL&#41; = 0
&gt; gettimeofday&#40;{1398618191, 50301}, NULL&#41; = 0
&gt; gettimeofday&#40;{1398618191, 50370}, NULL&#41; = 0
&gt; gettimeofday&#40;{1398618191, 50438}, NULL&#41; = 0
&gt; select&#40;16, [3 4 7 8 9 10 11 13], [7 8 9 10 11 13], [], {3599, 999932}&#41;
&gt; = 6 &#40;out [7 8 9 10 11 13], left {3599, 999929}&#41;
</div>
This illustrates the spin condition where file descriptors are ready but nothing is handling them.  There are no read, write, shutdown, or close calls to stop those descriptors from being ready forever.

I agree with you, it sounds like a race condition, and it may be easier to reproduce over a slower connection.  I&#39;ll pursue that to reproduce it here.

Meanwhile, try running the server with POE&#39;s assertions enabled:

POE_ASSERT_DEFAULT=1 perl ./server.pl

&#40;run the client&#41;
&#40;Does anything explode on the server side?&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;27&nbsp;14:43:18&nbsp;2014</span>
    <span class="description">jhuckaby [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95072] CPU pinned at 100% with POE::Component::Server::TCP and SSLify</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 27 Apr 2014 11:43:01 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Joseph Huckaby &lt;jhuckaby [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hey Rocco,

POE_ASSERT_DEFAULT doesn&#39;t seem to cause any server explosions.  It behaves exactly like it did before.

Update: I was finally able to reproduce the bug with the server script running on my Mac.  I just had to open a port in my router and hit it from the outside world &#40;i.e. that slow connection thing again&#41;.  OS X gets pinned to 100% CPU indefinitely just like my Linux server did.

I tried to find an strace alternative on OS X and found people talking about &#34;dtruss&#34;, but it doesn&#39;t seem to work properly for me.  The script exits after a few seconds before I even have a chance to send it any URLs.  I did try Apple&#39;s Activity Monitor and its &#34;Sample Process&#34; option.  I sampled it while pinned at 100% CPU and saved that report off as a text file if you want to see:

<span class="clickylink"><a target="new" rel="nofollow" href="https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/osx-sample-perl5.16.txt">https://dl.dropboxusercontent.com/u/201533/poe-tcp-sslify-bug/osx-sample-perl5.16.txt</a></span>

If you want me to grab any other debugging info on OS X, please provide instructions and I&#39;d be happy to do it.

- Joe




On Apr 27, 2014, at 10:48 AM, &#34;Rocco Caputo via RT&#34; &lt;bug-POE@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95072">https://rt.cpan.org/Ticket/Display.html?id=95072</a></span> &gt;
&gt; 
&gt; On Sun Apr 27 13:13:41 2014, jhuckaby@gmail.com wrote:
<div class="message-stanza open">&gt;&gt; 
&gt;&gt; Looks like it&#39;s getting stuck in some kind of date/time/select loop:
&gt;&gt; 
&gt;&gt; select&#40;16, [3 4 7 8 9 10 11 13], [7 8 9 10 11 13], [], {3599, 999931}&#41;
&gt;&gt; = 6 &#40;out [7 8 9 10 11 13], left {3599, 999927}&#41;
&gt;&gt; gettimeofday&#40;{1398618191, 49675}, NULL&#41; = 0
&gt;&gt; gettimeofday&#40;{1398618191, 50301}, NULL&#41; = 0
&gt;&gt; gettimeofday&#40;{1398618191, 50370}, NULL&#41; = 0
&gt;&gt; gettimeofday&#40;{1398618191, 50438}, NULL&#41; = 0
&gt;&gt; select&#40;16, [3 4 7 8 9 10 11 13], [7 8 9 10 11 13], [], {3599, 999932}&#41;
&gt;&gt; = 6 &#40;out [7 8 9 10 11 13], left {3599, 999929}&#41;
</div>&gt; 
&gt; This illustrates the spin condition where file descriptors are ready but nothing is handling them.  There are no read, write, shutdown, or close calls to stop those descriptors from being ready forever.
&gt; 
&gt; I agree with you, it sounds like a race condition, and it may be easier to reproduce over a slower connection.  I&#39;ll pursue that to reproduce it here.
&gt; 
&gt; Meanwhile, try running the server with POE&#39;s assertions enabled:
&gt; 
&gt; POE_ASSERT_DEFAULT=1 perl ./server.pl
&gt; 
&gt; &#40;run the client&#41;
&gt; &#40;Does anything explode on the server side?&#41;
&gt; 
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;07&nbsp;22:51:48&nbsp;2014</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Apr 27 14:43:18 2014, jhuckaby@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; POE_ASSERT_DEFAULT doesn&#39;t seem to cause any server explosions.  It
&gt; behaves exactly like it did before.
</div>
I&#39;ve seen this elsewhere recently.  It seems to be a race condition in POE::Component::SSLify, where the underlying I/O remains ready but attempts to read through that other module don&#39;t clear the condition.

I suppose something to check is whether the problem goes away when POE::Component::SSLify is removed from the stack.

I&#39;m not sure there&#39;s anything I can do on the POE level to remedy that.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;08&nbsp;01:59:08&nbsp;2014</span>
    <span class="description">jhuckaby [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95072] CPU pinned at 100% with POE::Component::Server::TCP and SSLify</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 7 Jul 2014 22:58:58 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Joseph Huckaby &lt;jhuckaby [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hey Rocco,

Confirmed, the bug does not occur without POE::Component::SSLify in the
stack.  I sent a ticket to the SSLify author several months ago, but no
reply, alas.  <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=95071">https://rt.cpan.org/Public/Bug/Display.html?id=95071</a></span>

Thanks for your time on this.

- Joe



On Mon, Jul 7, 2014 at 7:51 PM, Rocco Caputo via RT &lt;bug-POE@rt.cpan.org&gt;
wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95072">https://rt.cpan.org/Ticket/Display.html?id=95072</a></span> &gt;
&gt;
&gt; On Sun Apr 27 14:43:18 2014, jhuckaby@gmail.com wrote:
<div class="message-stanza open">&gt; &gt;
&gt; &gt; POE_ASSERT_DEFAULT doesn&#39;t seem to cause any server explosions.  It
&gt; &gt; behaves exactly like it did before.
</div>&gt;
&gt; I&#39;ve seen this elsewhere recently.  It seems to be a race condition in
&gt; POE::Component::SSLify, where the underlying I/O remains ready but attempts
&gt; to read through that other module don&#39;t clear the condition.
&gt;
&gt; I suppose something to check is whether the problem goes away when
&gt; POE::Component::SSLify is removed from the stack.
&gt;
&gt; I&#39;m not sure there&#39;s anything I can do on the POE level to remedy that.
&gt;
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;02&nbsp;15:44:19&nbsp;2015</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Resolving.  Confirmed not a bug in the POE distribution, and a bug was opened for the culprit.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;02&nbsp;15:44:26&nbsp;2015</span>
    <span class="description">RCAPUTO [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
