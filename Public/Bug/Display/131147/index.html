<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #131147 for PDF-API2: Bug with missing properties including patch</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #131147 for PDF-API2: Bug with missing properties including patch</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/PDF-API2/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/PDF-API2">PDF-API2 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">131147</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/PDF-API2/Active/">PDF-API2</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Klaus [...] Ethgen.ch

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-24958-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-24959-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
2.037    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;06&nbsp;13:02:11&nbsp;2019</span>
    <span class="description">Klaus [...] Ethgen.ch -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Bug with missing properties including patch</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 6 Dec 2019 18:30:14 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Klaus Ethgen &lt;Klaus [...] Ethgen.ch&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

the attached pdf will fail in importPageIntoForm as it does not have a
&#34;Rotate&#34; property.

The patch also attached will fix that.

Regards
   Klaus
-- 
Klaus Ethgen                                       <span class="clickylink"><a target="new" rel="nofollow" href="http://www.ethgen.ch/">http://www.ethgen.ch/</a></span>
pub  4096R/4E20AF1C 2011-05-16            Klaus Ethgen &lt;Klaus@Ethgen.ch&gt;
Fingerprint: 85D4 CA42 952C 949B 1753  62B3 79D0 B06F 4E20 AF1C
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;06&nbsp;19:02:11&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">1. Can you give some PDF::API2 code that shows the problem?

2. How does this compare to RT 130722? Might it be the same problem?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;06&nbsp;19:02:12&nbsp;2019</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;09&nbsp;09:41:13&nbsp;2019</span>
    <span class="description">futuramedium [...] yandex.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">There&#39;s &#34;Parent&#34; key in pages root with value of &#34;null&#34;. Failing code:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;perl -MPDF::API2 -e &#34;PDF::API2-&gt;new-&gt;importPageIntoForm&#40;PDF::API2-&gt;open&#40;&#39;gaforkarte_schweiz.pdf&#39;&#41;,1&#41;&#34;
</div>
With patch applied, e.g. adding a new page still fails:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;perl -MPDF::API2 -e &#34;PDF::API2-&gt;open&#40;&#39;gaforkarte_schweiz.pdf&#39;&#41;-&gt;page&#34;
</div>
Failing line number is in familiar from couple years ago method &#34;add_page&#34;, which I don&#39;t want to investigate again :&#41;

Further, there are nulls as values of properties of outline item in the file. This PDF producer seems to add nulls in unexpected places, hard to tell if any other PDF::API2 methods will fail. PDF is still valid, because the Reference says: 

&#34;Specifying the null object as the value of a dictionary entry ... is equivalent to omitting the entry entirely.&#34;

I&#39;d suggest patching with this in mind, i.e. ignore such entries on read and therefore don&#39;t preserve them on update. Replace line 480 &#40;version 2.036&#41; PDF/API2/Basic/PDF/File.pm:

#                $result-&gt;{$key} = $value;
                $result-&gt;{$key} = $value 
                    unless ref&#40;$value&#41; eq &#39;PDF::API2::Basic::PDF::Null&#39;;

Won&#39;t help in &#40;hypothetical&#41; case of &#34;null&#34; being value of indirect object, but such files are yet to be seen.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;16&nbsp;12:11:02&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Dec 09 09:41:13 2019, vadimr wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Failing line number is in familiar from couple years ago method
&gt; &#34;add_page&#34;, which I don&#39;t want to investigate again :&#41;
</div>Was that RT 121911 by any chance? That bug has been fixed in both API2 and Builder, so I&#39;m wondering &#40;if and&#41; how this one is related.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;d suggest patching with this in mind, i.e. ignore such entries on
&gt; read and therefore don&#39;t preserve them on update.
</div>Vadim, I applied your patch &#40;File.pm&#41; and it appears to fix the problem &#40;both Perl one-liners you gave above&#41;. It also doesn&#39;t break any t-tests or examples in PDF::Builder. Note that I did NOT add Klaus&#39;s patch to Pages.pm -- is his patch made unnecessary by yours? As he has not provided any test code, I can&#39;t be absolutely sure that your patch alone fixes the problem.

Per my earlier question about RT 130722, this patch does not seem to affect it.

If Klaus gives his blessing to your patch &#40;alone&#41;, I will release it in PDF::Builder. It&#39;s up to Steve as to what he wants to do with PDF::API2.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;16&nbsp;12:18:18&nbsp;2019</span>
    <span class="description">Klaus [...] Ethgen.ch -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #131147] Bug with missing properties including patch</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 16 Dec 2019 18:18:09 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;Phil M. Perry via RT&#34; &lt;bug-PDF-API2 [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Klaus Ethgen &lt;Klaus [...] Ethgen.ch&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Am Mo den 16. Dez 2019 um 18:11 schrieb Phil M. Perry via RT:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I&#39;d suggest patching with this in mind, i.e. ignore such entries on
&gt; &gt; read and therefore don&#39;t preserve them on update.
</div>&gt; Vadim, I applied your patch &#40;File.pm&#41; and it appears to fix the problem &#40;both Perl one-liners you gave above&#41;. It also doesn&#39;t break any t-tests or examples in PDF::Builder. Note that I did NOT add Klaus&#39;s patch to Pages.pm -- is his patch made unnecessary by yours? As he has not provided any test code, I can&#39;t be absolutely sure that your patch alone fixes the problem.
</div>
Hmm, didn&#39;t I provide a &#40;broken&#41; PDF? I thought I had.

I had the trouble in the following part:
  sub import_pdf
  {
     my $dest     = shift;
     my $source   = shift;
     my $urlprefs = shift;

     my $pages = $source-&gt;pages;
     for &#40;my $i = 1; $i &lt;= $pages; $i++&#41;
     {
        my $pref = {};
        $pref = $urlprefs-&gt;[0]  if exists&#40;$urlprefs-&gt;[0]&#41;;
        $pref = $urlprefs-&gt;[$i] if exists&#40;$urlprefs-&gt;[$i]&#41;;
        my $rot = $pref-&gt;{rotate} || 0;
        my $displayrot = $pref-&gt;{displayrotate} || $rot;
        my $trans = $transform{$rot} || [0, 0];

        my $page = $dest-&gt;page;
        $page-&gt;rotate&#40;$displayrot&#41;;
        my $gfx = $page-&gt;gfx;
        my $xo = $dest-&gt;importPageIntoForm&#40;$source, $i&#41;;
        $gfx-&gt;rotate&#40;$rot&#41;;
        $gfx-&gt;formimage&#40;$xo, $trans-&gt;[0] + &#40;$pref-&gt;{x} || 0&#41;, $trans-&gt;[1] + &#40;$pref-&gt;{y} || 0&#41;, $pref-&gt;{scale} || 1&#41;;
     } ## end for &#40;my $i = 1; $i &lt;= $pages...&#41;

     return $pages;
  } ## end sub import_pdf

It is part of a dirty hack to collect pdf as well as plain text or
images and put them together into a single pdf.

I will have a look at Vadims patch.

Regards
   Klaus
-- 
Klaus Ethgen                                       <span class="clickylink"><a target="new" rel="nofollow" href="http://www.ethgen.ch/">http://www.ethgen.ch/</a></span>
pub  4096R/4E20AF1C 2011-05-16            Klaus Ethgen &lt;Klaus@Ethgen.ch&gt;
Fingerprint: 85D4 CA42 952C 949B 1753  62B3 79D0 B06F 4E20 AF1C
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;16&nbsp;14:54:03&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Dec 16 12:18:18 2019, Klaus@Ethgen.ch wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hmm, didn&#39;t I provide a &#40;broken&#41; PDF? I thought I had.
</div>
You provided a PDF &#40;map of Switzerland&#41; that loads correctly. That&#39;s the one that Vadim used in his two one-line examples. You provided a patch, but I didn&#39;t see any example code showing the problem you&#39;re reporting. That&#39;s what I was asking to see.

Let me play with the code you just listed, with and without Vadim&#39;s patch, and perhaps with and without your patch, and see what happens.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;16&nbsp;15:54:06&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I added the following code to drive your import_pdf&#40;&#41; routine
----------------------------------------------------

use strict;
use warnings;
use PDF::Builder;

my @prefs; # array of hashes, one per page
    # rotate &#40;default 0&#41;
    # displayrotate  &#40;default &#39;rotate&#39; value&#41;
    # x &#40;default 0&#41;
    # y &#40;default 0&#41;
    # scale &#40;default 1&#41;
my $source = PDF::Builder-&gt;open&#40;&#39;gaforkarte_schweiz.pdf&#39;&#41;;
my $dest = PDF::Builder-&gt;new&#40;&#41;;
my %transform;
    # =&gt; rotate  &#40;default [0,0]&#41;

$dest-&gt;mediabox&#40;&#39;A4&#39;&#41;;

#$prefs[0] = {&#39;scale&#39; =&gt; 0.35};
$prefs[0] = {&#39;rotate&#39;=&gt;-90, &#39;x&#39;=&gt;-600,&#39;y&#39;=&gt;-100, &#39;scale&#39; =&gt; 0.35};

import_pdf&#40;$dest, $source, \@prefs&#41;;
$dest-&gt;saveas&#40;&#34;output.pdf&#34;&#41;;

----------------------------------------------
with Vadim&#39;s patch, and it seems to produce a good PDF. Without his patch I got the error about the missing &#39;find_prop&#39;.

rotate&#40;&#41; is CLOCKWISE and must be a multiple of +/-90 degrees. The x and
y offsets need to be adjusted to keep the image on the page.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;17&nbsp;06:33:59&nbsp;2019</span>
    <span class="description">futuramedium [...] yandex.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; How does this compare to RT 130722? Might it be the same problem?
&gt; Was that RT 121911 by any chance? ...how this one is related.
&gt; ...Klaus&#39;s patch to Pages.pm -- is his patch made unnecessary by yours? 
</div>
Phil, RT 130722 was about malformed PDF with broken pages tree, and I remain of the same opinion: no correction was required on PDF::API2 side; that RT can not &#40;and should not&#41; be compared to others concerning valid PDF files; error message and/or source line number being the same &#40;or close&#41; is co-incidental and of no importance.

Klaus&#39;s patch would fix the issue with &#34;importPageIntoForm&#34; with attached PDF, but my 2nd one-liner was to show that, following the route of applying a fix close to exposed line number, the 2nd patch would be required to fix failing &#34;page&#34; call, with line number somewhere close to RT 121911. That&#39;s the only reason I mentioned it. No other connection.

Instead, my idea was to find more universal solution. The suggested patch should practically work OK, but I think some considerations are to be documented at least. The &#34;null&#34; object itself is not a scarecrow, it&#39;s very common in, e.g., explicit destination arrays. But, as value of dictionary entry, the only place in the Reference I found is quoted above. Does it mean such entries can be safely discarded? Can any entry, which is strongly &#34;required&#34;, somehow finish having value &#34;null&#34;? I don&#39;t think so, but, what if, per quote above, we discard this entry, and &#34;required&#34; entry disappears from updated file? PDF ideology, which I agree with and which is NOT strictly adhered to by, e.g. PDF::API2, is don&#39;t touch entries you don&#39;t know what to do about. They can be from some future PDF specification :&#41;. I don&#39;t like the idea of throwing things away. But that&#39;s pure speculation.

Ideally, PDF::API2::Basic::PDF::Dict should access dict entries with e.g. &#34;key_exists&#34;, which checks if value of this key resolves to &#34;null&#34; and would return &#34;false&#34;, and a getter &#34;get_value&#34;, which similarly returns same value &#40;e.g. undef&#41; for non-existing keys or if value is &#34;null&#34;. In practice, it will never happen. Given the way PDF::API2 was designed to traverse pages tree, I think the cheapest &#40;and rather safe, regardless of what said above&#41; way to fix the present RT would be with my patch. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;17&nbsp;09:08:23&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Vadim, I asked about 130722, as both bugs were referencing &#39;find_prop&#39; in their error messages. It sounds like your opinion is that they are completely unrelated, and that 130722 is strictly due to corruption of the PDF produced by someone&#39;s editing of it. My invitation still stands for the OP to show that some commercial product produced the bad PDF, in which case it might be appropriate to put something in PDF::API2/Builder to deal with it. And of course, if PDF::API2/Builder created the corruption in the first place, it would have to be patched!

121911 was just a red herring &#40;&#34;scarecrow&#34;?&#41; in having a similar line number? I was thrown off the trail by your mentioning it.

If I read you correctly, you feel that your patch for this &#40;131147&#41; bug is more general than Klaus&#39;s patch, and there is no need to also apply his patch &#40;harmless but now superfluous&#41;. Is that correct, or should his patch also be applied for some reason? I should probably copy-paste your explanation into the documentation somewhere, while I&#39;m at it.

Finally, thank you to both of you for making the effort to track this down and create patches. Good job!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;18&nbsp;18:02:33&nbsp;2019</span>
    <span class="description">futuramedium [...] yandex.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If I read you correctly, you feel that your patch for this &#40;131147&#41; bug is more general than Klaus&#39;s patch, and there is no need to also apply his patch
</div>
Correct, mine can possibly address other issues &#40;unknown yet&#41;, and it&#39;s either of the two, but if you decide to choose more cautious way &#40;Klaus&#39;s patch&#41; rather than more radical, then _also_ search where to &#40;cautiously&#41; patch so that &#34;page&#34; call &#40;2nd one-liner&#41; won&#39;t fail. As to documentation, maybe a link to this RT in a comment in source is more than enough.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ...about 130722, as both bugs were referencing &#39;find_prop&#39; in their error messages. It sounds like your opinion is that they are completely unrelated
</div>
They are related in a sense that &#34;PDF::API2::Basic::PDF::Pages-&gt; find_prop&#34; method is called on object of unsuitable class -- PDF::API2::Basic::PDF::Objind &#40;130722&#41; or PDF::API2::Basic::PDF::Null &#40;131147&#41;. But objects became blessed into these classes for unrelated reasons. When PDF is broken &#40;130722&#41; we can&#39;t exclude possibility of similar mismatch anywhere. In fact, it&#39;s a good thing that PDF::API2 fails early and noisily. Acrobat doesn&#39;t report any issue, but when I try to import a new page in UI &#40;it was some time ago, IIRC insert one before the last... doesn&#39;t matter&#41; then there were bizarre results in both visual feedback &#40;&#34;Pages&#34; docker&#41; and cryptic error message. Though at first file was opened as valid! Returning to 131147, I think with my patch, PDF::API2::Basic::PDF::Null is prevented from appearing in pages tree when bubbling up from a leaf to root. As to my previous concerns &#40;is suggested patch too radical, can it break anything&#41;... After some thought, I can imagine only some weird steganography would be disrupted, if any is ever used in PDF :&#41; Otherwise, should be safe.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;19&nbsp;02:47:46&nbsp;2019</span>
    <span class="description">Klaus [...] Ethgen.ch -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #131147] Bug with missing properties including patch</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 19 Dec 2019 08:47:37 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Vadim Repin via RT &lt;bug-PDF-API2 [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Klaus Ethgen &lt;Klaus [...] Ethgen.ch&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Am Do den 19. Dez 2019 um  0:02 schrieb Vadim Repin via RT:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=131147">https://rt.cpan.org/Ticket/Display.html?id=131147</a></span> &gt;
&gt; 
<div class="message-stanza open">&gt; &gt; If I read you correctly, you feel that your patch for this &#40;131147&#41; bug is more general than Klaus&#39;s patch, and there is no need to also apply his patch
</div>&gt; 
&gt; Correct, mine can possibly address other issues &#40;unknown yet&#41;, and it&#39;s either of the two, but if you decide to choose more cautious way &#40;Klaus&#39;s patch&#41; rather than more radical, then _also_ search where to &#40;cautiously&#41; patch so that &#34;page&#34; call &#40;2nd one-liner&#41; won&#39;t fail. As to documentation, maybe a link to this RT in a comment in source is more than enough.
</div>
I have to say, preventing the Null value in the first place sounds
reasonable for me. But as Vadim told, there might still be situations
where the Null happens.

So another, maybe supplement patch would be to patch
PDF::API2::Basic::PDF::Null class to have NULL getters for several
methods &#40;maybe even done with autoload&#41;. That would mean to return
always undef &#40;or the class itself, depending on the logic&#41;. You can even
implement a warning here and a configurable switch to croak instead of
carp when that happens.

Regards
   Klaus
-- 
Klaus Ethgen                                       <span class="clickylink"><a target="new" rel="nofollow" href="http://www.ethgen.ch/">http://www.ethgen.ch/</a></span>
pub  4096R/4E20AF1C 2011-05-16            Klaus Ethgen &lt;Klaus@Ethgen.ch&gt;
Fingerprint: 85D4 CA42 952C 949B 1753  62B3 79D0 B06F 4E20 AF1C
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;05&nbsp;16:48:39&nbsp;2020</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Agreed with Vadim that dictionary entries with null values should be ignored, per the spec.  I&#39;ve updated the code accordingly.

As Vadim noted, neither his patch nor my version will handle a dictionary with an indirect object pointing to a null value, but I&#39;m okay with waiting for that particular case to come up, hopefully with an associated patch.

Thanks for the bug report and the patch.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;05&nbsp;16:48:40&nbsp;2020</span>
    <span class="description">steve [...] deefs.net -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;06&nbsp;13:55:10&nbsp;2020</span>
    <span class="description">steve [...] deefs.net -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;06&nbsp;13:55:11&nbsp;2020</span>
    <span class="description">steve [...] deefs.net -  Fixed in 2.037 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
