<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #16013 for Net-Packet: Error in packing 802.11Q VLAN ID</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #16013 for Net-Packet: Error in packing 802.11Q VLAN ID</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-Packet/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-Packet/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-Packet/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-Packet/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-Packet">Net-Packet CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">16013</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-Packet/Active/">Net-Packet</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">gomor [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
michael.s.wagner [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-22980-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.02    </td>
  </tr>
  <tr id="CF-22981-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;21&nbsp;15:44:59&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Error in packing 802.11Q VLAN ID</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Patrice -

I have been using the Net::Packet for sometime now to automate some ping tests through vlans.  What I noticed was that whenever I set the VLAN ID to anything greater than 16 Net::Packet would basically do a modulus of that number by 16.  So if I set it to 17 the VLAN ID would be 1, 18 it would be 2, and so on.

Anyways I dug into the code a little bit and found where it packs this value in VLAN.pm.

   my $pCfiId3 = packIntToNet&#40;$self-&gt;id,       &#39;v&#39;, 0, 12&#41;;

Basically what I found through testing is that since packIntToNet receives &#39;v&#39; it is using a 16 bit network number that gets shifted by 12 bits.  So if any information is stored in the upper 12 bits it would get shifted off leaving 4 bits or 2^4 combinations up to 16 valid IDs.

Anyways I looked at what packIntToNet was doing and fed it new parameters so that a 32 bit number is used and no data loss occurs.  Below is my change.

   my $pCfiId3 = packIntToNet&#40;$self-&gt;id,       &#39;N&#39;, 8, 12&#41;;

I have attached a new version of VLAN.pm with this line added plus some test lines after it commented out if you would like to double check and verify yourself the functionality between the two lines.  

Anyways I hope this is a small useful fix for you.  I also have new ICMPv4.pm and ARP.pm modules which will handle packets encapsulated by 802.11q so the -&gt;recv method for each will acknolwedge response to echo requests and arp requests using vlans if you are interested.

Thanks for the very useful module!
Mike Wagner
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">package Net::Packet::VLAN;

# $Date: 2005/02/03 22:33:50 $
# $Revision: 1.1.2.1 $

use strict;
use warnings;

require Net::Packet::Layer3;
require Class::Gomor::Hash;
our @ISA = qw&#40;Net::Packet::Layer3 Class::Gomor::Hash&#41;;

use Net::Packet qw&#40;$Env&#41;;
use Net::Packet::Consts qw&#40;:vlan :layer&#41;;
use Net::Packet::Utils  qw&#40;packIntToNet unpackIntFromNet&#41;;
require Net::Packet::Frame;

our $VERSION = $Net::Packet::VERSION;

our @AS = qw&#40;
   priority
   cfi
   id
   type
   frame
&#41;;

__PACKAGE__-&gt;buildAccessorsScalar&#40;\@AS&#41;;

sub new {
   my $self = shift-&gt;SUPER::new&#40;
      priority =&gt; 0,
      cfi      =&gt; 0,
      id       =&gt; 0,
      type     =&gt; NP_VLAN_TYPE_IPv4,
      @_,
   &#41;;

   $self;
}

sub getLength {
   my $self = shift;
   do { return length&#40;$self-&gt;frame&#41; + NP_VLAN_HDR_LEN } if $self-&gt;frame;
   NP_VLAN_HDR_LEN;
}

sub pack {
   my $self = shift;

   my $pCfiId1 = packIntToNet&#40;$self-&gt;priority, &#39;C&#39;, 2,  3&#41;;
   my $pCfiId2 = packIntToNet&#40;$self-&gt;cfi,      &#39;C&#39;, 6,  1&#41;;
   my $pCfiId3 = packIntToNet&#40;$self-&gt;id,       &#39;N&#39;, 8, 12&#41;;
   #my $check = substr&#40;unpack&#40;&#39;B*&#39;, pack&#40;&#39;n&#39;, $self-&gt;id&#41;&#41;, 4&#41;;
   #print &#34;CHECK &#34; . $check . &#34;\n&#34;;
   #my $c1 = substr&#40;unpack&#40;&#39;B*&#39;, pack&#40;&#39;N&#39;, 69632&#41;&#41;, 8, 12&#41;;
   #my $c2 = substr&#40;unpack&#40;&#39;B*&#39;, pack&#40;&#39;n&#39;, 15&#41;&#41;, 4&#41;;
   #my $c3 = substr&#40;unpack&#40;&#39;B*&#39;, pack&#40;&#39;n&#39;, 25&#41;&#41;, 4&#41;;
   #my $c4 = substr&#40;unpack&#40;&#39;B*&#39;, pack&#40;&#39;n&#39;, 35&#41;&#41;, 4&#41;;
   #print &#34;HERE &#34; . $c1 . &#34; &#34; . $c2 . &#34; &#34; . $c3 . &#34; &#34; . $c4 . &#34;\n&#34;;
      

  #print &#34;$pCfiId1 $pCfiId2 $pCfiId3\n&#34;;

   $self-&gt;raw&#40;
      $self-&gt;SUPER::pack&#40;&#39;B16na*&#39;,
         $pCfiId1. $pCfiId2. $pCfiId3,
         $self-&gt;type,
         $self-&gt;frame-&gt;raw,
      &#41;,
   &#41; or return undef;

   1;
}

sub unpack {
   my $self = shift;

   my &#40;$pCfiId, $type, $payload&#41; =
      $self-&gt;SUPER::unpack&#40;&#39;B16n a*&#39;, $self-&gt;raw&#41;
         or return undef;

#  print STDERR $pCfiId, &#34;\n&#34;;

   $self-&gt;priority&#40;unpackIntFromNet&#40;$pCfiId, &#39;C&#39;, 0, 5,  3&#41;&#41;;
   $self-&gt;cfi     &#40;unpackIntFromNet&#40;$pCfiId, &#39;C&#39;, 3, 7,  1&#41;&#41;;
   $self-&gt;id      &#40;unpackIntFromNet&#40;$pCfiId, &#39;n&#39;, 4, 4, 12&#41;&#41;;
   $self-&gt;type&#40;$type&#41;;

   $self-&gt;frame&#40;Net::Packet::Frame-&gt;new&#40;raw =&gt; $payload&#41;&#41;;

   1;
}

sub print {
   my $self = shift;

   my $l = $self-&gt;layer;
   my $i = $self-&gt;is;
   sprintf &#34;$l:+$i: priority:%d  cfi:%d  id:%d  type:0x%04x&#34;,
      $self-&gt;priority, $self-&gt;cfi, $self-&gt;id, $self-&gt;type;
}

#
# Helpers
#

sub _isType    { shift-&gt;type == shift&#40;&#41;                           }
sub isTypeArp  { shift-&gt;_isType&#40;NP_VLAN_TYPE_ARP&#41;                 }
sub isTypeIpv4 { shift-&gt;_isType&#40;NP_VLAN_TYPE_IPv4&#41;                }
sub isTypeIpv6 { shift-&gt;_isType&#40;NP_VLAN_TYPE_IPv6&#41;                }
sub isTypeIp   { my $self = shift; $self-&gt;isIpv4 || $self-&gt;isIpv6 }

1;

__END__

=head1 NAME

Net::Packet::VLAN - 802.1Q layer 3 object

=head1 SYNOPSIS

   use Net::Packet qw&#40;$Env&#41;;
   use Net::Packet::VLAN;

   # Load needed constants
   use Net::Packet::Consts qw&#40;:ipv4 :eth&#41;;

   # In order to avoid autocreation of Desc and Dump objects
   # Because VLAN is particuliar, we must do it manually
   use Net::Packet::DescL2;
   use Net::Packet::Dump;

   Net::Packet::DescL2-&gt;new;
   Net::Packet::Dump-&gt;new&#40;filter =&gt; &#39;vlan&#39;&#41;;

   # Another thing to note, do not send VLAN frames in a 
   # vlan interface, it would be encapsulated another time ;&#41;
   # Instead, send it to the parent interface

   # So, we will play an echo-request inside a vlan
   use Net::Packet::Frame;
   use Net::Packet::IPv4;
   use Net::Packet::ICMPv4;
   my $echo = Net::Packet::Frame-&gt;new&#40;
      l3 =&gt; Net::Packet::IPv4-&gt;new&#40;
         src      =&gt; $vlanSrcIp,
         dst      =&gt; $vlanDstIp,
         protocol =&gt; NP_IPv4_PROTOCOL_ICMPv4,
         doChecksum =&gt; 1, # Because system will not do it,
                          # at least under FreeBSD
         noFixLen   =&gt; 1, # Well, FreeBSD needs fixing, but not 
                          # when frames are injected into VLANs ;&#41;
      &#41;,
      l4 =&gt; Net::Packet::ICMPv4-&gt;new,
   &#41;;

   # Frame to inject is built, time to encapsulate it into a VLAN frame
   use Net::Packet::ETH;
   my $frame = Net::Packet::Frame-&gt;new&#40;
      l2 =&gt; Net::Packet::ETH-&gt;new&#40;
         dst  =&gt; $vlanDstMac,
         type =&gt; NP_ETH_TYPE_VLAN,
      &#41;,
      l3 =&gt; Net::Packet::VLAN-&gt;new&#40;
         frame =&gt; $echo,
      &#41;,
   &#41;;

   # Done !
   print $frame-&gt;l3-&gt;print, &#34;\n&#34;;
   print $frame-&gt;l3-&gt;frame-&gt;l3-&gt;print, &#34;\n&#34;;
   print $frame-&gt;l3-&gt;frame-&gt;l4-&gt;print, &#34;\n&#34;;
   $frame-&gt;send;

=head1 DESCRIPTION

This modules implements the encoding and decoding of the Virtual LAN/802.1Q layer.

See also B&lt;Net::Packet::Layer&gt; and B&lt;Net::Packet::Layer3&gt; for other attributes and methods.

=head1 ATTRIBUTES

=over 4

=item B&lt;priority&gt;

The priority field.

=item B&lt;cfi&gt;

The cfi field. It is only one bit long, so set it to 0 or 1.

=item B&lt;id&gt;

VLAN tag id. You&#39;ll love it.

=item B&lt;type&gt;

Which type the next encapsulated layer is.

=item B&lt;frame&gt;

This is a B&lt;Net::Packet::Frame&gt; object, built it like any other such frame. Just to mention that you should use B&lt;doChecksum&gt; attribute if you put in a B&lt;Net::Packet::IPv4&gt; layer, and maybe the B&lt;noFixLen&gt; attribute also.

=back

=head1 METHODS

=over 4

=item B&lt;new&gt;

Object constructor. You can pass attributes that will overwrite default ones. Default values:

priority: 0

cfi:      0

id:       0

type:     NP_VLAN_TYPE_IPv4

=item B&lt;pack&gt;

Packs all attributes into a raw format, in order to inject to network. Returns 1 on success, undef otherwise.

=item B&lt;unpack&gt;

Unpacks raw data from network and stores attributes into the object. Returns 1 on success, undef otherwise.

=back

=head1 CONSTANTS

Load them: use Net::Packet::Consts qw&#40;:vlan&#41;;

=over 4

=item B&lt;NP_VLAN_TYPE_ARP&gt;

=item B&lt;NP_VLAN_TYPE_IPv4&gt;

=item B&lt;NP_VLAN_TYPE_IPv6&gt;

Various supported encapsulated frame types.

=back

=head1 AUTHOR

Patrice E&lt;lt&gt;GomoRE&lt;gt&gt; Auffret

=head1 COPYRIGHT AND LICENSE

Copyright &#40;c&#41; 2004-2005, Patrice E&lt;lt&gt;GomoRE&lt;gt&gt; Auffret

You may distribute this module under the terms of the Artistic license.
See Copying file in the source distribution archive.

=head1 RELATED MODULES

L&lt;NetPacket&gt;, L&lt;Net::RawIP&gt;, L&lt;Net::RawSock&gt;

=cut
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;11&nbsp;13:43:24&nbsp;2006</span>
    <span class="description">gomor [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Take odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;11&nbsp;13:43:34&nbsp;2006</span>
    <span class="description">gomor [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;11&nbsp;14:24:11&nbsp;2006</span>
    <span class="description">gomor [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This problem is now solved. The bugfix will be included in Net::Packet 2.05.

Best regards, and the sorry for the loooonnnnnng delay.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;11&nbsp;14:24:13&nbsp;2006</span>
    <span class="description">gomor [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
