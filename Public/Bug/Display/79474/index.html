<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #79474 for Audio-TagLib: iconv_open failure patch</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #79474 for Audio-TagLib: iconv_open failure patch</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Audio-TagLib/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Audio-TagLib/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Audio-TagLib/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Audio-TagLib/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Audio-TagLib">Audio-TagLib CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">79474</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Audio-TagLib/Active/">Audio-TagLib</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">GLEACH [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
festushagen2002 [...] yahoo.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-3098-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.61    </td>
  </tr>
  <tr id="CF-3099-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.62    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;06&nbsp;00:02:09&nbsp;2012</span>
    <span class="description">festushagen2002 [...] yahoo.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> iconv_open failure patch</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 5 Sep 2012 21:01:59 -0700 &#40;PDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Audio-TagLib [...] rt.cpan.org&#34; &lt;bug-Audio-TagLib [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Festus Hagen &lt;festushagen2002 [...] yahoo.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Audio::TagLib v1.61

OS: Win32, FreeBSD tested. Should work for all.

Perl:: Should work for all.

iconv: ?? Should work for all.

Bug: iconv_open&#40;&#41; fails, incorrect character set names, iconv expects a hyphen in UTF names.

Patch also resolves: warning: deprecated conversion from string constant to &#39;char*&#39;

Changing where *fromcode is assigned it&#39;s value to a hyphenated version causes implications further down the line, including with Taglib.

So, My solution ...

diff -u -w -r -B --strip-trailing-cr Orig/tstring.xs Modded/tstring.xs
--- Orig/tstring.xs    2012-07-04 20:07:44.000000000 -0400
+++ Modded/tstring.xs    2012-09-05 17:59:24.000000000 -0400
@@ -14,7 +14,7 @@
 TagLib::String::new&#40;...&#41;
 PROTOTYPE: ;$$
 PREINIT:
-    char *encode, *fromcode;
+    const char *encode, *fromcode;
     enum TagLib::String::Type t;
     bool is_copy_from_string = TRUE;
     iconv_t codec;
@@ -131,7 +131,18 @@
             /* any other encodings converted to utf8 */
             //sv_dump&#40;ST&#40;1&#41;&#41;;
             //printf&#40;&#34;fromcode = %s\n&#34;, fromcode&#41;;
-            if&#40;!&#40;codec = iconv_open&#40;&#34;UTF8&#34;, fromcode&#41;&#41;&#41;
+             const char *from_code;
+                        if&#40;strncasecmp&#40;encode, &#34;UTF8&#34;, 4&#41; == 0&#41; {
+                            from_code = &#34;UTF-8&#34;;
+                        } else if&#40;strncasecmp&#40;encode, &#34;UTF16BE&#34;, 7&#41; == 0&#41; {
+                            from_code = &#34;UTF-16BE&#34;;
+                        } else if&#40;strncasecmp&#40;encode, &#34;UTF16LE&#34;, 7&#41; == 0&#41; {
+                            from_code = &#34;UTF-16LE&#34;;
+                        } else if&#40;strncasecmp&#40;encode, &#34;UTF16&#34;, 5&#41; == 0&#41; {
+                            from_code = &#34;UTF-16&#34;;
+                        } else
+                            from_code = fromcode;
+            if&#40;!&#40;codec = iconv_open&#40;&#34;UTF-8&#34;, from_code&#41;&#41;&#41;
                 croak&#40;&#34;iconv_open failed, check your encode&#34;&#41;;
             /* inlen MUST be the extract byte length of string */
             /* the terminal &#39;\0&#39; should NOT be included in length */


-Enjoy
fh :&#41;_~
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;06&nbsp;00:20:56&nbsp;2012</span>
    <span class="description">festushagen2002 [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #79474] AutoReply: iconv_open failure patch </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 5 Sep 2012 21:20:46 -0700 &#40;PDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Audio-TagLib [...] rt.cpan.org&#34; &lt;bug-Audio-TagLib [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Festus Hagen &lt;festushagen2002 [...] yahoo.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Whoops, pasted the wrong diff ... Arrrg!

Here is the correct one.

diff -u -w -r -B --strip-trailing-cr Orig/tstring.xs Modded/tstring.xs
--- Orig/tstring.xs    2012-07-04 20:07:44.000000000 -0400
+++ Modded/tstring.xs    2012-09-05 17:59:24.000000000 -0400
@@ -14,7 +14,7 @@
 TagLib::String::new&#40;...&#41;
 PROTOTYPE: ;$$
 PREINIT:
-    char *encode, *fromcode;
+    const char *encode, *fromcode;
     enum TagLib::String::Type t;
     bool is_copy_from_string = TRUE;
     iconv_t codec;
@@ -131,7 +131,18 @@
             /* any other encodings converted to utf8 */
             //sv_dump&#40;ST&#40;1&#41;&#41;;
             //printf&#40;&#34;fromcode = %s\n&#34;, fromcode&#41;;
-            if&#40;!&#40;codec = iconv_open&#40;&#34;UTF8&#34;, fromcode&#41;&#41;&#41;
+             const char *from_code;
+             if&#40;strncasecmp&#40;fromcode, &#34;UTF8&#34;, 4&#41; == 0&#41; {
+                 from_code = &#34;UTF-8&#34;;
+             } else if&#40;strncasecmp&#40;fromcode, &#34;UTF16BE&#34;, 7&#41; == 0&#41; {
+                 from_code = &#34;UTF-16BE&#34;;
+             } else if&#40;strncasecmp&#40;fromcode, &#34;UTF16LE&#34;, 7&#41; == 0&#41; {
+                 from_code = &#34;UTF-16LE&#34;;
+             } else if&#40;strncasecmp&#40;fromcode, &#34;UTF16&#34;, 5&#41; == 0&#41; {
+                 from_code = &#34;UTF-16&#34;;
+             } else
+                 from_code = fromcode;
+            if&#40;!&#40;codec = iconv_open&#40;&#34;UTF-8&#34;, from_code&#41;&#41;&#41;
                 croak&#40;&#34;iconv_open failed, check your encode&#34;&#41;;
             /* inlen MUST be the extract byte length of string */
             /* the terminal &#39;\0&#39; should NOT be included in length */


Sorry!

-Enjoy
fh :&#41;_~



<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">----- Original Message -----
From: Bugs in Audio-TagLib via RT &lt;bug-Audio-TagLib@rt.cpan.org&gt;
To: festushagen2002@yahoo.com
Cc: 
Sent: Thursday, September 6, 2012 12:02 AM
Subject: [rt.cpan.org #79474] AutoReply: iconv_open failure patch 


Greetings,

This message has been automatically generated in response to the
creation of a trouble ticket regarding:
    &#34;iconv_open failure patch&#34;, 
a summary of which appears below.

There is no need to reply to this message right now.  Your ticket has been
assigned an ID of [rt.cpan.org #79474].  Your ticket is accessible
on the web at:

    <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=79474">https://rt.cpan.org/Ticket/Display.html?id=79474</a></span>

Please include the string:

         [rt.cpan.org #79474]

in the subject line of all future correspondence about this issue. To do so, 
you may reply to this message.

                        Thank you,
                        bug-Audio-TagLib@rt.cpan.org

-------------------------------------------------------------------------
Audio::TagLib v1.61

OS: Win32, FreeBSD tested. Should work for all.

Perl:: Should work for all.

iconv: ?? Should work for all.

Bug: iconv_open&#40;&#41; fails, incorrect character set names, iconv expects a hyphen in UTF names.

Patch also resolves: warning: deprecated conversion from string constant to &#39;char*&#39;

Changing where *fromcode is assigned it&#39;s value to a hyphenated version causes implications further down the line, including with Taglib.

So, My solution ...

diff -u -w -r -B --strip-trailing-cr Orig/tstring.xs Modded/tstring.xs
--- Orig/tstring.xs    2012-07-04 20:07:44.000000000 -0400
+++ Modded/tstring.xs    2012-09-05 17:59:24.000000000 -0400
@@ -14,7 +14,7 @@
 TagLib::String::new&#40;...&#41;
 PROTOTYPE: ;$$
 PREINIT:
-    char *encode, *fromcode;
+    const char *encode, *fromcode;
     enum TagLib::String::Type t;
     bool is_copy_from_string = TRUE;
     iconv_t codec;
@@ -131,7 +131,18 @@
             /* any other encodings converted to utf8 */
             //sv_dump&#40;ST&#40;1&#41;&#41;;
             //printf&#40;&#34;fromcode = %s\n&#34;, fromcode&#41;;
-            if&#40;!&#40;codec = iconv_open&#40;&#34;UTF8&#34;, fromcode&#41;&#41;&#41;
+             const char *from_code;
+                        if&#40;strncasecmp&#40;encode, &#34;UTF8&#34;, 4&#41; == 0&#41; {
+                            from_code = &#34;UTF-8&#34;;
+                        } else if&#40;strncasecmp&#40;encode, &#34;UTF16BE&#34;, 7&#41; == 0&#41; {
+                            from_code = &#34;UTF-16BE&#34;;
+                        } else if&#40;strncasecmp&#40;encode, &#34;UTF16LE&#34;, 7&#41; == 0&#41; {
+                            from_code = &#34;UTF-16LE&#34;;
+                        } else if&#40;strncasecmp&#40;encode, &#34;UTF16&#34;, 5&#41; == 0&#41; {
+                            from_code = &#34;UTF-16&#34;;
+                        } else
+                            from_code = fromcode;
+            if&#40;!&#40;codec = iconv_open&#40;&#34;UTF-8&#34;, from_code&#41;&#41;&#41;
                 croak&#40;&#34;iconv_open failed, check your encode&#34;&#41;;
             /* inlen MUST be the extract byte length of string */
             /* the terminal &#39;\0&#39; should NOT be included in length */


-Enjoy
fh :&#41;_~
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;06&nbsp;12:52:00&nbsp;2012</span>
    <span class="description">festushagen2002 [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #79474] AutoReply: iconv_open failure patch </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 6 Sep 2012 09:51:49 -0700 &#40;PDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Audio-TagLib [...] rt.cpan.org&#34; &lt;bug-Audio-TagLib [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Festus Hagen &lt;festushagen2002 [...] yahoo.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Was going to include this in another patch, decided it was more appropriate with this one ...

diff -u -w -r --strip-trailing-cr Orig/stringiterator.xs Modded/stringiterator.xs
--- Orig/stringiterator.xs    2012-07-04 20:07:44.000000000 -0400
+++ Modded/stringiterator.xs    2012-09-01 17:40:01.000000000 -0400
@@ -50,7 +50,7 @@
 //USEWCHAR
     /* iterator for String */
     wchar_t &#38; data = **THIS;
-    iconv_t codec = iconv_open&#40;&#34;UTF8&#34;, &#34;WCHAR_T&#34;&#41;;
+    iconv_t codec = iconv_open&#40;&#34;UTF-8&#34;, &#34;WCHAR_T&#34;&#41;;
     if&#40;codec == &#40;iconv_t&#41;&#40;-1&#41;&#41;
         croak&#40;&#34;iconv_open failed&#34;&#41;;
     char *inbuf, *outbuf;

-Enjoy
fh :&#41;_~





<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">----- Original Message -----
From: Bugs in Audio-TagLib via RT &lt;bug-Audio-TagLib@rt.cpan.org&gt;
To: festushagen2002@yahoo.com
Cc: 
Sent: Thursday, September 6, 2012 12:02 AM
Subject: [rt.cpan.org #79474] AutoReply: iconv_open failure patch 


Greetings,

This message has been automatically generated in response to the
creation of a trouble ticket regarding:
    &#34;iconv_open failure patch&#34;, 
a summary of which appears below.

There is no need to reply to this message right now.  Your ticket has been
assigned an ID of [rt.cpan.org #79474].  Your ticket is accessible
on the web at:

    <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=79474">https://rt.cpan.org/Ticket/Display.html?id=79474</a></span>

Please include the string:

         [rt.cpan.org #79474]

in the subject line of all future correspondence about this issue. To do so, 
you may reply to this message.

                        Thank you,
                        bug-Audio-TagLib@rt.cpan.org

-------------------------------------------------------------------------
Audio::TagLib v1.61

OS: Win32, FreeBSD tested. Should work for all.

Perl:: Should work for all.

iconv: ?? Should work for all.

Bug: iconv_open&#40;&#41; fails, incorrect character set names, iconv expects a hyphen in UTF names.

Patch also resolves: warning: deprecated conversion from string constant to &#39;char*&#39;

Changing where *fromcode is assigned it&#39;s value to a hyphenated version causes implications further down the line, including with Taglib.

So, My solution ...

diff -u -w -r -B --strip-trailing-cr Orig/tstring.xs Modded/tstring.xs
--- Orig/tstring.xs    2012-07-04 20:07:44.000000000 -0400
+++ Modded/tstring.xs    2012-09-05 17:59:24.000000000 -0400
@@ -14,7 +14,7 @@
 TagLib::String::new&#40;...&#41;
 PROTOTYPE: ;$$
 PREINIT:
-    char *encode, *fromcode;
+    const char *encode, *fromcode;
     enum TagLib::String::Type t;
     bool is_copy_from_string = TRUE;
     iconv_t codec;
@@ -131,7 +131,18 @@
             /* any other encodings converted to utf8 */
             //sv_dump&#40;ST&#40;1&#41;&#41;;
             //printf&#40;&#34;fromcode = %s\n&#34;, fromcode&#41;;
-            if&#40;!&#40;codec = iconv_open&#40;&#34;UTF8&#34;, fromcode&#41;&#41;&#41;
+             const char *from_code;
+                        if&#40;strncasecmp&#40;encode, &#34;UTF8&#34;, 4&#41; == 0&#41; {
+                            from_code = &#34;UTF-8&#34;;
+                        } else if&#40;strncasecmp&#40;encode, &#34;UTF16BE&#34;, 7&#41; == 0&#41; {
+                            from_code = &#34;UTF-16BE&#34;;
+                        } else if&#40;strncasecmp&#40;encode, &#34;UTF16LE&#34;, 7&#41; == 0&#41; {
+                            from_code = &#34;UTF-16LE&#34;;
+                        } else if&#40;strncasecmp&#40;encode, &#34;UTF16&#34;, 5&#41; == 0&#41; {
+                            from_code = &#34;UTF-16&#34;;
+                        } else
+                            from_code = fromcode;
+            if&#40;!&#40;codec = iconv_open&#40;&#34;UTF-8&#34;, from_code&#41;&#41;&#41;
                 croak&#40;&#34;iconv_open failed, check your encode&#34;&#41;;
             /* inlen MUST be the extract byte length of string */
             /* the terminal &#39;\0&#39; should NOT be included in length */


-Enjoy
fh :&#41;_~
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;08&nbsp;17:29:19&nbsp;2012</span>
    <span class="description">GLEACH [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;08&nbsp;18:53:35&nbsp;2012</span>
    <span class="description">geoff [...] hughes.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #79474] AutoReply: iconv_open failure patch</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 08 Sep 2012 15:53:01 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Audio-TagLib [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Geoffrey Leach &lt;geoff [...] hughes.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Festus.

I&#39;ve applied &#40;I think&#41; your two iconv patches. Patched files are 
attached.  Kindly verify.

Did you know that your editor is inserting odd characters? Compile 
errors: ./xs/tstring.xs:140:1: error: stray ‘\302’ in program, etc.

The characters appear to be c2 &#40;LATIN CAPITAL LETTER A WITH 
CIRCUMFLEX&#41; and a0 &#40;NO-BREAK SPACE&#41; and are being used for space-
padding at the beginning of line. These are iso_8859-1 and are not 
accepted by g++ on Linux. Please let me know if you can suppress them, 
or I&#39;ll write a filter.
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;08&nbsp;18:53:37&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;08&nbsp;23:04:34&nbsp;2012</span>
    <span class="description">festushagen2002 [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #79474] AutoReply: iconv_open failure patch</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 8 Sep 2012 20:04:23 -0700 &#40;PDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Audio-TagLib [...] rt.cpan.org&#34; &lt;bug-Audio-TagLib [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Festus Hagen &lt;festushagen2002 [...] yahoo.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Just using Yahoo&#39;s web editor ... I have it set to plain text but their idea of plain text is far from mine!

stringiterator.xs looks good.

Don&#39;t know if Attachments get through, I&#39;ll try, Attached is your copy of tstring.xs, I cleaned up the alignment and moved the &#34;// end of Festus-02&#34; to the end of the changes, otherwise it looks good.

If it doesn&#39;t make it. I&#39;ll email it to you directly ...


It would not bother me at all to delete this whole mess and allow me to start over, it was the first submission on this system and I really made a mess of it ... O-wells, live and learn.

-Enjoy
fh :&#41;_~



<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">----- Original Message -----
From: &#34;geoff@hughes.net via RT&#34; &lt;bug-Audio-TagLib@rt.cpan.org&gt;
To: festushagen2002@yahoo.com
Cc: 
Sent: Saturday, September 8, 2012 6:53 PM
Subject: Re: [rt.cpan.org #79474] AutoReply: iconv_open failure patch

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=79474">https://rt.cpan.org/Ticket/Display.html?id=79474</a></span> &gt;

Hi Festus.

I&#39;ve applied &#40;I think&#41; your two iconv patches. Patched files are 
attached.  Kindly verify.

Did you know that your editor is inserting odd characters? Compile 
errors: ./xs/tstring.xs:140:1: error: stray ‘\302’ in program, etc.

The characters appear to be c2 &#40;LATIN CAPITAL LETTER A WITH 
CIRCUMFLEX&#41; and a0 &#40;NO-BREAK SPACE&#41; and are being used for space-
padding at the beginning of line. These are iso_8859-1 and are not 
accepted by g++ on Linux. Please let me know if you can suppress them, 
or I&#39;ll write a filter.
</div></div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;21&nbsp;12:54:09&nbsp;2012</span>
    <span class="description">GLEACH [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;21&nbsp;12:55:15&nbsp;2012</span>
    <span class="description">GLEACH [...] cpan.org -  Severity Normal added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;21&nbsp;12:55:18&nbsp;2012</span>
    <span class="description">GLEACH [...] cpan.org -  Broken in 1.61 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;21&nbsp;12:55:18&nbsp;2012</span>
    <span class="description">GLEACH [...] cpan.org -  Fixed in 1.62 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
