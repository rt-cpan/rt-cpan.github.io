<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #86638 for devel-nytprof: $SIG{__DIE__} Re: Core dump in NYTProf under mod_perl / Mason</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #86638 for devel-nytprof: $SIG{__DIE__} Re: Core dump in NYTProf under mod_perl / Mason</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=devel-nytprof">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=devel-nytprof">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=devel-nytprof">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=devel-nytprof">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/timbunce/devel-nytprof/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/devel-nytprof">devel-nytprof CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">86638</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=devel-nytprof">devel-nytprof</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Tim.Bunce [...] pobox.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-221012-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-221013-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=86638">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1231051" href="/Public/Bug/Display.html?id=86638#txn-1231051">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;02&nbsp;10:17:51&nbsp;2013</span>
    <span class="description">Tim.Bunce [...] pobox.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Tim.Bunce [...] pobox.com, bug-devel-nytprof [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> $SIG{__DIE__} Re: Core dump in NYTProf under mod_perl / Mason</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 2 Jul 2013 15:17:21 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Larry Bennett &lt;larry.bennett [...] photobox.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tim Bunce &lt;Tim.Bunce [...] pobox.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1231051/650498/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/650498">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 6.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Jul 02, 2013 at 02:23:55PM +0100, Larry Bennett wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;    Hi Tim,
&gt; 
&gt;    I work at PhotoBox alongside Zefram. I&#39;m setting up NYTProf to get some stats for our mod_perl /
&gt;    Mason-based front-end web servers. When we enable NYTProf, the Apache child processes are segfaulting.
&gt; 
&gt;    We&#39;ve managed to get a decent core dump from one of the crashes in live. I wonder if you could have a
&gt;    look and see if it rings any bells or suggests avenues to explore?
&gt; 
&gt;    The gdb backtrace from the core dump is below. I also printed out a couple key variables below the
&gt;    trace. The immediate cause of the crash is de-referencing a variable p that is copied from the
&gt;    subr_entry passed from Perl, which has an apparently unexpected NULL value in called_subpkg_pv.
&gt; 
&gt;    We are running NYTProf 5.03. We set the NYTPROF env variable to:
&gt;    file=/tmp/nytprof_scratch.out:endatexit=1:sigexit=1:libcexit=1:start=no
&gt; 
&gt;    &#40;That libcexit is in anticipation of Zefram&#39;s patch.&#41;
&gt;    The crash happens on our live servers but sadly never in our dev evironments. It takes about 30 seconds
&gt;    in live before the crashes start.
&gt; 
&gt;    If I should open an RT ticket or report this problem in some other location let me know.
</div>
I&#39;ve CC&#39;d this to RT - that should create a case.

The stack trace looks like die&#40;&#41; being called inside a $SIG{__DIE__} hook.
So printing $@ might be useful for yourselves.

Meanwhile I suspect we&#39;ll have to debug this by email round-trips.
See below.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;    Program terminated with signal 11, Segmentation fault.
&gt;    #0 0x00007f49d796bc56 in incr_sub_inclusive_time &#40;subr_entry=0x7f49e18dd5e0&#41; at NYTProf.xs:2060
&gt;    2060 while &#40;*p&#41;
&gt;    &#40;gdb&#41;
&gt;    &#40;gdb&#41;
&gt;    &#40;gdb&#41; bt
&gt;    #0 0x00007f49d796bc56 in incr_sub_inclusive_time &#40;subr_entry=0x7f49e18dd5e0&#41; at NYTProf.xs:2060
&gt;    #1 0x00007f49d82ff429 in Perl_leave_scope &#40;base=2872&#41; at scope.c:1134
&gt;    #2 0x00007f49d830e58f in Perl_die_unwind &#40;msv=&lt;value optimized out&gt;&#41; at pp_ctl.c:1765
&gt;    #3 0x00007f49d82b8db5 in Perl_croak_sv &#40;baseex=&lt;value optimized out&gt;&#41; at util.c:1683
&gt;    #4 0x00007f49d82b8dc9 in Perl_die_sv &#40;baseex=0x0&#41; at util.c:1616
&gt;    #5 0x00007f49d8321a98 in Perl_pp_die &#40;&#41; at pp_sys.c:510
&gt;    #6 0x00007f49d82d15a3 in Perl_runops_standard &#40;&#41; at run.c:41
&gt;    #7 0x00007f49d826e177 in Perl_call_sv &#40;sv=&lt;value optimized out&gt;, flags=6&#41; at perl.c:2690
&gt;    #8 0x00007f49d82b74d6 in S_invoke_exception_hook &#40;ex=&lt;value optimized out&gt;,
&gt;    Perl_warn=&lt;value optimized out&gt;&#41; at util.c:1594
&gt;    #9 0x00007f49d82b9620 in Perl_vcroak &#40;pat=&lt;value optimized out&gt;, args=&lt;value optimized out&gt;&#41;
&gt;    at util.c:1715
&gt;    #10 0x00007f49d82bc71d in Perl_die &#40;pat=0x0&#41; at util.c:1650
&gt;    #11 0x00007f49d82d2767 in Perl_pp_entersub &#40;&#41; at pp_hot.c:2606
&gt;    #12 0x00007f49d79729cc in pp_subcall_profiler &#40;is_slowop=0&#41; at NYTProf.xs:2615
&gt;    #13 0x00007f49d82d15a3 in Perl_runops_standard &#40;&#41; at run.c:41
&gt;    #14 0x00007f49d826e523 in Perl_call_sv &#40;sv=&lt;value optimized out&gt;, flags=10&#41; at perl.c:2705
&gt;    #15 0x00007f49d85ad8e7 in modperl_callback &#40;handler=0x7f49e105e780, p=0x7f49e0faa8b8,
&gt;    r=&lt;value optimized out&gt;, s=0x7f49e105f470, args=&lt;value optimized out&gt;&#41;
&gt;    at modperl_callback.c:101
&gt;    #16 0x00007f49d85ae0cb in modperl_callback_run_handlers &#40;idx=&lt;value optimized out&gt;, type=-80,
&gt;    r=&lt;value optimized out&gt;, c=&lt;value optimized out&gt;, s=&lt;value optimized out&gt;,
&gt;    pconf=&lt;value optimized out&gt;, plog=0x0, ptemp=0x0, run_mode=MP_HOOK_RUN_FIRST&#41;
&gt;    at modperl_callback.c:262
&gt;    #17 0x00007f49d85ae65f in modperl_callback_per_dir &#40;idx=0, r=&lt;value optimized out&gt;,
&gt;    run_mode=&lt;value optimized out&gt;&#41; at modperl_callback.c:369
&gt;    #18 0x00007f49d85a9bdb in modperl_response_handler_run &#40;r=0x7f49e0faa930&#41; at mod_perl.c:1000
&gt;    #19 0x00007f49d85a9d22 in modperl_response_handler_cgi &#40;r=0x7f49e0faa930&#41; at mod_perl.c:1099
&gt;    #20 0x00007f49dbf0a200 in ap_run_handler &#40;r=0x7f49e0faa930&#41; at config.c:158
&gt;    #21 0x00007f49dbf0dace in ap_invoke_handler &#40;r=0x7f49e0faa930&#41; at config.c:376
&gt;    #22 0x00007f49dbf1b3c8 in ap_process_request &#40;r=0x7f49e0faa930&#41; at http_request.c:282
&gt;    #23 0x00007f49dbf18278 in ap_process_http_connection &#40;c=0x7f49e124de70&#41; at http_core.c:190
&gt;    #24 0x00007f49dbf11d28 in ap_run_process_connection &#40;c=0x7f49e124de70&#41; at connection.c:43
&gt;    #25 0x00007f49dbf1fd87 in child_main &#40;child_num_arg=&lt;value optimized out&gt;&#41; at prefork.c:662
&gt;    #26 0x00007f49dbf2009a in make_child &#40;s=0x7f49dc89bb18, slot=2&#41; at prefork.c:758
&gt;    #27 0x00007f49dbf203cb in startup_children &#40;_pconf=&lt;value optimized out&gt;,
&gt;    plog=&lt;value optimized out&gt;, s=&lt;value optimized out&gt;&#41; at prefork.c:776
&gt;    #28 ap_mpm_run &#40;_pconf=&lt;value optimized out&gt;, plog=&lt;value optimized out&gt;, s=&lt;value optimized out&gt;&#41;
&gt;    at prefork.c:997
&gt;    #29 0x00007f49dbef6410 in main &#40;argc=5, argv=0x7fffd0f77018&#41; at main.c:740
&gt;    &#40;gdb&#41;
&gt;    &#40;gdb&#41;
&gt;    &#40;gdb&#41; p p
&gt;    $1 = 0x0
&gt;    &#40;gdb&#41;
&gt;    &#40;gdb&#41;
&gt;    &#40;gdb&#41; p *subr_entry
&gt;    $2 = {already_counted = 1, subr_prof_depth = 14, subr_call_seqn = 7797,
&gt;    prev_subr_entry_ix = 21488, initial_call_timeofday = {tv_sec = 23353010, tv_nsec = 450637351},
&gt;    initial_call_cputimes = {tms_utime = 0, tms_stime = 0, tms_cutime = 0, tms_cstime = 0},
&gt;    initial_overhead_ticks = 161933, initial_subr_ticks = 3454823, caller_fid = 131,
&gt;    caller_line = 112, caller_subpkg_pv = 0x7f49dfe5b060 &#34;HTML::Mason::Commands&#34;,
&gt;    caller_subnam_sv = 0x7f49e2024cd0, called_cv = 0x0, called_cv_depth = 0, called_is_xs = 0x0,
&gt;    called_subpkg_pv = 0x0, called_subnam_sv = 0x7f49e20292f0, hide_subr_call_time = 0}
&gt;    ================================================================================================
</div>
That looks reasonable, except for the null called_subpkg_pv.
The place to look is subr_entry_setup&#40;&#41;.
called_is_xs being null implies it took the
    if &#40;op_type == OP_ENTERSUB || op_type == OP_GOTO&#41;
branch, which is sane.

called_cv being null implies that resolve_sub_to_cv&#40;&#41; failed.
In which case we end up in

    else {
        subr_entry-&gt;called_subnam_sv = newSV&#40;0&#41;; /* see incr_sub_inclusive_time */
    }

which doesn&#39;t set subr_entry-&gt;called_subpkg_pv. Suspicious!

Per the comment I look in incr_sub_inclusive_time&#40;&#41; and see:

    if &#40;subr_entry-&gt;called_subnam_sv == &#38;PL_sv_undef&#41; {
        if &#40;trace_level&#41;
            logwarn&#40;&#34;Don&#39;t know name of called sub, assuming xsub/builtin exited via an exception &#40;which isn&#39;t handled yet&#41;\n&#34;&#41;;
        subr_entry-&gt;already_counted++;
    }
    if &#40;subr_entry-&gt;already_counted&#41; {
        subr_entry_destroy&#40;aTHX_ subr_entry&#41;;
        return;
    }

The warn message seems to fit the stack trace.
So I&#39;d *guess* that the right fix is to change the newSV&#40;0&#41; to &#38;PL_sv_undef.

Let me know if that works.

Tim.

p.s. Also, perhaps you or Zefram, could see if resolve_sub_to_cv&#40;&#41;
could be improved to handle this case.  Thanks!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1231079" href="/Public/Bug/Display.html?id=86638#txn-1231079">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;02&nbsp;11:37:46&nbsp;2013</span>
    <span class="description">zefram [...] fysh.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #86638] $SIG{__DIE__} Re: Core dump in NYTProf under mod_perl / Mason</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 2 Jul 2013 16:37:18 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Devel-NYTProf [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1231079/650512/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/650512">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Some more information that I garnered from examining the core dump,
and recipe to reproduce below.

Not only is called_subpkg_pv null, called_subnam_sv is undef &#40;but
not &#38;PL_sv_undef&#41;.  Looks like it comes from the newSV&#40;0&#41; case in
subr_entry_setup&#40;&#41;, but I can&#39;t confirm that.

The caller_* fields of subr_entry point at a piece of code in one of
our Mason components that goes like this:

        # eval block protects Apache dev boxes using threaded MPM &#40;which cannot run Apache2::SizeLimit&#41;
        eval {
                ...
                my &#40;$size, $shared&#41; = $Apache2::SizeLimit::HOW_BIG_IS_IT-&gt;&#40;&#41;;
                ...
        };
        if &#40;$@&#41;
        {
                Babel::FrontEnd::Log-&gt;log&#40;&#39;file&#39; =&gt; &#39;ProcessTuning&#39;,
                        &#39;msg&#39; =&gt; &#34;ERROR: $@&#34; &#41;;
                }
        }

$Apache2::SizeLimit::HOW_BIG_IS_IT is never set anywhere: neither in our
code nor in Apache2::SizeLimit itself.  Our code is buggy on this point,
but of course the eval block normally protects us from the the effects.
Indeed, the ProcessTuning log shows many entries such as

2013-07-01 13:27:56 pod0 - ERROR: Can&#39;t use string &#40;&#34;&#34;&#41; as a subroutine ref while &#34;strict refs&#34; in use at /opt/client/var/mason/obj/1978989512/public/autohandler.223805.obj line 112.

The caller_* fields of subr_entry point at the same line, line 112 of
the munged file.  *subr_entry has been created by D:NYTP operating on
the entersub op from that line; this corresponds to the pp_entersub&#40;&#41;
in C stack frame #11.

$SIG{__DIE__} &#40;PL_diehook&#41; is set to
\&#38;HTML::Mason::Exceptions::rethrow_exception, the source of which is

        sub rethrow_exception
        {
            my &#40;$err&#41; = @_;
            return unless $err;

            if &#40; UNIVERSAL::can&#40;$err, &#39;rethrow&#39;&#41; &#41; {
                $err-&gt;rethrow;
            }
            elsif &#40; ref $err &#41; {
                die $err;
            }
            HTML::Mason::Exception-&gt;throw&#40;error =&gt; $err&#41;;
        }

C stack frame #7 is calling this sub.  The pp_die&#40;&#41; in frame #5 must be
a die from something called by HTML::Mason::Exception-&gt;throw.

I can reproduce the crash in a couple of ways.  $SIG{__DIE__} can die&#40;&#41;,
or return &#40;causing resumption of standard die processing&#41;, or be entirely
absent.  The essential feature is the &#34;string as subroutine ref&#34; error
generated by the Perl core.  &#34;use strict&#34; is necessary to generate this:
without it you get a different error &#40;&#34;Undefined subroutine called&#34;&#41;
and no crash.

Here&#39;s my minimal reproduction:

$ /opt/perl/bin/perl -MDevel::NYTProf -lwe &#39;use strict; $x::z-&gt;&#40;&#41;;&#39;
Name &#34;x::z&#34; used only once: possible typo at -e line 1.
Use of uninitialized value in subroutine entry at -e line 1.
Use of uninitialized value in subroutine entry at -e line 1.
Use of uninitialized value in subroutine entry at -e line 1.
Can&#39;t use string &#40;&#34;&#34;&#41; as a subroutine ref while &#34;strict refs&#34; in use at -e line 1.
zsh: segmentation fault &#40;core dumped&#41;  /opt/perl/bin/perl -MDevel::NYTProf -lwe &#39;use strict; $x::z-&gt;&#40;&#41;;&#39;
$ gdb /opt/perl/bin/perl core                                                   
GNU gdb &#40;GDB&#41; 7.4.1-debian
Copyright &#40;C&#41; 2012 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://gnu.org/licenses/gpl.html">http://gnu.org/licenses/gpl.html</a></span>&gt;
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type &#34;show copying&#34;
and &#34;show warranty&#34; for details.
This GDB was configured as &#34;x86_64-linux-gnu&#34;.
For bug reporting instructions, please see:
&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.gnu.org/software/gdb/bugs/">http://www.gnu.org/software/gdb/bugs/</a></span>&gt;...
Reading symbols from /opt/perl-5.16.3/bin/perl...done.
[New LWP 11478]

warning: Can&#39;t read pathname for load map: Input/output error.
[Thread debugging using libthread_db enabled]
Using host libthread_db library &#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;.
Core was generated by `/opt/perl/bin/perl -MDevel::NYTProf -lwe use strict; $x::z-&gt;&#40;&#41;;&#39;.
Program terminated with signal 11, Segmentation fault.
#0  incr_sub_inclusive_time &#40;subr_entry=0xfb2070&#41; at NYTProf.xs:2066
2066            while &#40;*p&#41;
&#40;gdb&#41; bt
#0  incr_sub_inclusive_time &#40;subr_entry=0xfb2070&#41; at NYTProf.xs:2066
#1  0x00002ad166c65fe0 in Perl_leave_scope &#40;base=base@entry=0&#41; at scope.c:1134
#2  0x00002ad166bd645f in S_my_exit_jump &#40;&#41; at perl.c:4951
#3  0x00002ad166bdcb02 in Perl_my_failure_exit &#40;&#41; at perl.c:4936
#4  0x00002ad166c6f985 in Perl_die_unwind &#40;msv=msv@entry=0xf912b0&#41;
    at pp_ctl.c:1801
#5  0x00002ad166c1d438 in Perl_vcroak &#40;pat=&lt;optimized out&gt;, 
    args=args@entry=0x7fffe0f28af8&#41; at util.c:1716
#6  0x00002ad166c1d4fc in Perl_die &#40;
    pat=pat@entry=0x2ad166cd2e38 &#34;Can&#39;t use string &#40;\&#34;%-32p\&#34;%s&#41; as a subroutine ref while \&#34;strict refs\&#34; in use&#34;&#41; at util.c:1650
#7  0x00002ad166c3eabc in Perl_pp_entersub &#40;&#41; at pp_hot.c:2606
#8  0x00002ad167d8acaa in pp_subcall_profiler &#40;is_slowop=0&#41; at NYTProf.xs:2621
#9  0x00002ad166c375d3 in Perl_runops_standard &#40;&#41; at run.c:41
#10 0x00002ad166bdc9da in S_run_body &#40;oldscope=1&#41; at perl.c:2402
#11 perl_run &#40;my_perl=&lt;optimized out&gt;&#41; at perl.c:2320
#12 0x0000000000400edb in main &#40;argc=4, argv=0x7fffe0f290c8, 
    env=0x7fffe0f290f0&#41; at perlmain.c:120

This should be good enough as a test case.

-zefram
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1231080" href="/Public/Bug/Display.html?id=86638#txn-1231080">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;02&nbsp;11:37:46&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1231096" href="/Public/Bug/Display.html?id=86638#txn-1231096">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;02&nbsp;11:52:32&nbsp;2013</span>
    <span class="description">zefram [...] fysh.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #86638] $SIG{__DIE__} Re: Core dump in NYTProf under mod_perl / Mason</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 2 Jul 2013 16:52:06 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Devel-NYTProf [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1231096/650522/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/650522">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 348b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Changing called_subnam_sv to &#38;PL_sv_undef looks dubious.
pp_subcall_profiler&#40;&#41; has various cases of sv_setpv&#40;&#41; or sv_setpvf&#40;&#41;
on called_subnam_sv, which look like they&#39;re depending on it being a
fresh undef scalar rather than the global immutable undef.  Maybe you
need to make the opposite change: test SvOK&#40;&#41; rather than ==&#38;PL_sv_undef?

-zefram
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1231274" href="/Public/Bug/Display.html?id=86638#txn-1231274">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;02&nbsp;17:14:01&nbsp;2013</span>
    <span class="description">TIMB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1231274/650596/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/650596">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 50b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Agreed. Patched, with test case &#40;thanks for that!&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1231282" href="/Public/Bug/Display.html?id=86638#txn-1231282">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;02&nbsp;17:18:18&nbsp;2013</span>
    <span class="description">TIMB [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1231479" href="/Public/Bug/Display.html?id=86638#txn-1231479">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;03&nbsp;05:45:58&nbsp;2013</span>
    <span class="description">TIMB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1231479/650703/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/650703">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 22b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed in 5.05. Thanks!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1231482" href="/Public/Bug/Display.html?id=86638#txn-1231482">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;03&nbsp;05:45:58&nbsp;2013</span>
    <span class="description">TIMB [...] cpan.org -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.405208</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
