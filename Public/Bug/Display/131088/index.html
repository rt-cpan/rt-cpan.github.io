<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #85012 for File-KeePass: Endianness Bug in Module File::KeePass</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #85012 for File-KeePass: Endianness Bug in Module File::KeePass</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/File-KeePass/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/File-KeePass/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/File-KeePass/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/File-KeePass/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/File-KeePass">File-KeePass CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">85012</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/File-KeePass/Active/">File-KeePass</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
gmail [...] beyerscoetzee.com

<br />
joern.clausen [...] uni-bielefeld.de

<br />
peter.ohlerich [...] uni-bielefeld.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-233724-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.03    </td>
  </tr>
  <tr id="CF-233725-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;03&nbsp;03:04:10&nbsp;2013</span>
    <span class="description">peter.ohlerich [...] uni-bielefeld.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Endianness Bug in Module File::KeePass</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 03 May 2013 09:03:51 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-File-KeePass [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Ohlerich &lt;peter.ohlerich [...] uni-bielefeld.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Paul!

Yesterday I files a bug at Sourceforge for kpcli and Lester told me
the problem is not in kpcli, but in File::KeePass and requested me to
send this to you.
So here&#39;s my problem &#40;copied from [ kpcli-Bugs-3612469 ] &#41;:

I tried to open a KDBX-file with kpcli-1.7 under Solaris 10 Sparc and
got a signature error:
Couldn&#39;t load the file facebook_fvdmb.kdbx: File signature &#40;sig1&#41; did
not match &#40;x != y&#41;

When I converted both values to HEX I saw that the values were equal but
with wrong byte order. Can you please fix this?

With regards,

Peter.

-- 
----------------------------------------------------------------------
HRZ der Universitaet Bielefeld  Phone: +49 521 106-00
Dipl.-Inf. Peter Ohlerich      Email: Peter.Ohlerich@uni-bielefeld.de
P.O.Box 100131                   WWW: <span class="clickylink"><a target="new" rel="nofollow" href="http://www.uni-bielefeld.de/hrz/">http://www.uni-bielefeld.de/hrz/</a></span>
D-33501 Bielefeld &#40;Germany&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;21&nbsp;10:24:42&nbsp;2014</span>
    <span class="description">cpan.org [...] mavit.org.uk -  Broken in 2.03 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;21&nbsp;10:25:00&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;21&nbsp;10:28:00&nbsp;2014</span>
    <span class="description">cpan.org [...] mavit.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The attached patch got this working for me on Solaris 11 SPARC.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> big-endian.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/File-KeePass-2.03/lib/File/KeePass.pm b/File-KeePass/lib/File/KeePass.pm
index 3c414e5..9bcb2d0 100644
--- a/File-KeePass-2.03/lib/File/KeePass.pm
+++ b/File-KeePass/lib/File/KeePass.pm
@@ -122,7 +122,7 @@ sub parse_db {
 
 sub parse_header {
     my &#40;$self, $buffer&#41; = @_;
-    my &#40;$sig1, $sig2&#41; = unpack &#39;LL&#39;, $buffer;
+    my &#40;$sig1, $sig2&#41; = unpack &#39;VV&#39;, $buffer;
     die &#34;File signature &#40;sig1&#41; did not match &#40;$sig1 != &#34;.DB_SIG_1&#40;&#41;.&#34;&#41;\n&#34; if $sig1 != DB_SIG_1;
     return $self-&gt;_parse_v1_header&#40;$buffer&#41; if $sig2 eq DB_SIG_2_v1;
     return $self-&gt;_parse_v2_header&#40;$buffer&#41; if $sig2 eq DB_SIG_2_v2;
@@ -135,7 +135,7 @@ sub _parse_v1_header {
     die &#34;File was smaller than db header &#40;$size &lt; &#34;.DB_HEADSIZE_V1&#40;&#41;.&#34;&#41;\n&#34; if $size &lt; DB_HEADSIZE_V1;
     my %h = &#40;version =&gt; 1, header_size =&gt; DB_HEADSIZE_V1&#41;;
     my @f = qw&#40;sig1 sig2 flags ver seed_rand enc_iv n_groups n_entries checksum seed_key rounds&#41;;
-    my $t =   &#39;L    L    L     L   a16       a16    L        L         a32      a32      L&#39;;
+    my $t = &#39;&#40; L    L    L     L   a16       a16    L        L         a32      a32      L &#41;&lt;&#39;;
     @h{@f} = unpack $t, $buffer;
     die &#34;Unsupported file version &#40;$h{&#39;ver&#39;}&#41;.\n&#34; if $h{&#39;ver&#39;} &#38; 0xFFFFFF00 != DB_VER_DW_V1 &#38; 0xFFFFFF00;
     $h{&#39;enc_type&#39;} = &#40;$h{&#39;flags&#39;} &#38; DB_FLAG_RIJNDAEL&#41; ? &#39;rijndael&#39;
@@ -147,12 +147,12 @@ sub _parse_v1_header {
 sub _parse_v2_header {
     my &#40;$self, $buffer&#41; = @_;
     my %h = &#40;version =&gt; 2, enc_type =&gt; &#39;rijndael&#39;&#41;;
-    @h{qw&#40;sig1 sig2 ver&#41;} = unpack &#39;L3&#39;, $buffer;
+    @h{qw&#40;sig1 sig2 ver&#41;} = unpack &#39;V3&#39;, $buffer;
     die &#34;Unsupported file version2 &#40;$h{&#39;ver&#39;}&#41;.\n&#34; if $h{&#39;ver&#39;} &#38; 0xFFFF0000 &gt; 0x00020000 &#38; 0xFFFF0000;
     my $pos = 12;
 
     while &#40;1&#41; {
-        my &#40;$type, $size&#41; = unpack &#34;\@$pos CS&#34;, $buffer;
+        my &#40;$type, $size&#41; = unpack &#34;\@$pos Cv&#34;, $buffer;
         $pos += 3;
         my $val = substr $buffer, $pos, $size; # #my &#40;$val&#41; = unpack &#34;\@$pos a$size&#34;, $buffer;
         if &#40;!$type&#41; {
@@ -177,7 +177,7 @@ sub _parse_v2_header {
             warn &#34;Length of seed key was not 32\n&#34; if length&#40;$val&#41; != 32;
             $h{&#39;seed_key&#39;} = $val;
         } elsif &#40;$type == 6&#41; {
-            $h{&#39;rounds&#39;} = unpack &#39;L&#39;, $val;
+            $h{&#39;rounds&#39;} = unpack &#39;V&#39;, $val;
         } elsif &#40;$type == 7&#41; {
             warn &#34;Length of encryption IV was not 16\n&#34; if length&#40;$val&#41; != 16;
             $h{&#39;enc_iv&#39;} = $val;
@@ -761,7 +761,7 @@ sub _gen_v1_header {
     die &#34;Length of $_ was not 32 &#40;&#34;.length&#40;$head-&gt;{$_}&#41;.&#34;&#41;\n&#34; for grep {length&#40;$head-&gt;{$_}&#41; != 32} qw&#40;seed_key checksum&#41;;
     die &#34;Length of $_ was not 16 &#40;&#34;.length&#40;$head-&gt;{$_}&#41;.&#34;&#41;\n&#34; for grep {length&#40;$head-&gt;{$_}&#41; != 16} qw&#40;enc_iv seed_rand&#41;;
     my @f = qw&#40;sig1 sig2 flags ver seed_rand enc_iv n_groups n_entries checksum seed_key rounds&#41;;
-    my $t =   &#39;L    L    L     L   a16       a16    L        L         a32      a32      L&#39;;
+    my $t = &#39;&#40; L    L    L     L   a16       a16    L        L         a32      a32      L &#41;&lt;&#39;;
     my $header = pack $t, @$head{@f};
     die &#34;Invalid generated header\n&#34; if length&#40;$header&#41; != DB_HEADSIZE_V1;
     return $header;
@@ -1009,15 +1009,15 @@ sub _gen_v2_header {
     die &#34;Length of $_ was not 32 &#40;&#34;.length&#40;$head-&gt;{$_}&#41;.&#34;&#41;\n&#34; for grep {length&#40;$head-&gt;{$_}&#41; != 32} qw&#40;seed_rand seed_key protected_stream_key start_bytes&#41;;
     die &#34;Length of enc_iv was not 16\n&#34; if length&#40;$head-&gt;{&#39;enc_iv&#39;}&#41; != 16;
 
-    my $buffer = pack &#39;L3&#39;, @$head{qw&#40;sig1 sig2 ver&#41;};
+    my $buffer = pack &#39;V3&#39;, @$head{qw&#40;sig1 sig2 ver&#41;};
 
-    my $pack = sub { my &#40;$type, $str&#41; = @_; $buffer .= pack&#40;&#39;C S&#39;, $type, length&#40;$str&#41;&#41; . $str };
+    my $pack = sub { my &#40;$type, $str&#41; = @_; $buffer .= pack&#40;&#39;C v&#39;, $type, length&#40;$str&#41;&#41; . $str };
     $pack-&gt;&#40;1, $head-&gt;{&#39;comment&#39;}&#41; if defined&#40;$head-&gt;{&#39;comment&#39;}&#41; &#38;&#38; length&#40;$head-&gt;{&#39;comment&#39;}&#41;;
     $pack-&gt;&#40;2, &#34;\x31\xc1\xf2\xe6\xbf\x71\x43\x50\xbe\x58\x05\x21\x6a\xfc\x5a\xff&#34;&#41;; # aes cipher
     $pack-&gt;&#40;3, pack &#39;V&#39;, $head-&gt;{&#39;compression&#39;} ? 1 : 0&#41;;
     $pack-&gt;&#40;4, $head-&gt;{&#39;seed_rand&#39;}&#41;;
     $pack-&gt;&#40;5, $head-&gt;{&#39;seed_key&#39;}&#41;;
-    $pack-&gt;&#40;6, pack &#39;LL&#39;, $head-&gt;{&#39;rounds&#39;}, 0&#41;; # a little odd to be double the length but not used
+    $pack-&gt;&#40;6, pack &#39;VV&#39;, $head-&gt;{&#39;rounds&#39;}, 0&#41;; # a little odd to be double the length but not used
     $pack-&gt;&#40;7, $head-&gt;{&#39;enc_iv&#39;}&#41;;
     $pack-&gt;&#40;8, $head-&gt;{&#39;protected_stream_key&#39;}&#41;;
     $pack-&gt;&#40;9, $head-&gt;{&#39;start_bytes&#39;}&#41;;
@@ -1064,7 +1064,7 @@ sub unchunksum {
     my &#40;$self, $buffer&#41; = @_;
     my &#40;$new, $pos&#41; = &#40;&#39;&#39;, 0&#41;;
     while &#40;$pos &lt; length&#40;$buffer&#41;&#41; {
-        my &#40;$index, $hash, $size&#41; = unpack &#34;\@$pos L a32 i&#34;, $buffer;
+        my &#40;$index, $hash, $size&#41; = unpack &#34;&#40; \@$pos L a32 i &#41;&lt;&#34;, $buffer;
         $pos += 40;
         if &#40;$size == 0&#41; {
             warn &#34;Found mismatch for 0 chunksize\n&#34; if $hash ne &#34;\0&#34;x32;
@@ -1087,11 +1087,11 @@ sub chunksum {
     my $pos = 0;
     while &#40;$pos &lt; length&#40;$buffer&#41;&#41; {
         my $chunk = substr&#40;$buffer, $pos, $chunk_size&#41;;
-        $new .= pack &#34;L a32 i&#34;, $index++, sha256&#40;$chunk&#41;, length&#40;$chunk&#41;;
+        $new .= pack &#34;&#40; L a32 i &#41;&lt;&#34;, $index++, sha256&#40;$chunk&#41;, length&#40;$chunk&#41;;
         $new .= $chunk;
         $pos += length&#40;$chunk&#41;;
     }
-    $new .= pack &#34;L a32 i&#34;, $index++, &#34;\0&#34;x32, 0;
+    $new .= pack &#34;&#40; L a32 i &#41;&lt;&#34;, $index++, &#34;\0&#34;x32, 0;
     return $new;
 }
 
diff --git a/File-KeePass/t/06_sample.t b/File-KeePass/t/06_sample.t
new file mode 100644
index 0000000..9ecf92a
--- /dev/null
+++ b/File-KeePass/t/06_sample.t
@@ -0,0 +1,129 @@
+#!/usr/bin/perl
+
+=head1 NAME
+
+06_sample.t - Check interoperability with a sample database created by KeePass.
+
+=cut
+
+use strict;
+use warnings;
+use Test::More tests =&gt; 44;
+use File::Basename;
+
+if &#40;!eval {
+    require MIME::Base64;
+    require XML::Parser;
+    require Compress::Raw::Zlib;
+    require utf8;
+}&#41; {
+    diag &#34;Failed to load library: $@&#34;;
+  SKIP: { skip &#34;Missing necessary libraries.\n&#34;, 44 };
+    exit;
+}
+
+use_ok&#40;&#39;File::KeePass&#39;&#41;;
+
+my $pass = &#34;qwe123&#34;;
+my $filename = dirname&#40;__FILE__&#41;. &#34;/NewDatabase.kdbx&#34;;
+
+my $obj  = File::KeePass-&gt;new;
+ok&#40;$obj-&gt;load_db&#40;$filename, $pass&#41;, &#34;Database load&#34;&#41;;
+
+compare&#40;
+    &#39;group&#39;, [
+        {
+            &#39;title&#39; =&gt; &#39;NewDatabase&#39;,
+            &#39;icon&#39; =&gt; 49,
+            &#39;level&#39; =&gt; 0,
+        },
+        {
+            &#39;title&#39; =&gt; &#39;General&#39;,
+            &#39;icon&#39; =&gt; 48,
+            &#39;level&#39; =&gt; 1,
+        },
+        {
+            &#39;title&#39; =&gt; &#39;Windows&#39;,
+            &#39;icon&#39; =&gt; 38,
+            &#39;level&#39; =&gt; 1,
+        },
+        {
+            &#39;title&#39; =&gt; &#39;Network&#39;,
+            &#39;icon&#39; =&gt; 3,
+            &#39;level&#39; =&gt; 1,
+        },
+        {
+            &#39;title&#39; =&gt; &#39;Internet&#39;,
+            &#39;icon&#39; =&gt; 1,
+            &#39;level&#39; =&gt; 1,
+        },
+        {
+            &#39;title&#39; =&gt; &#39;eMail&#39;,
+            &#39;icon&#39; =&gt; 19,
+            &#39;level&#39; =&gt; 1,
+        },
+        {
+            &#39;title&#39; =&gt; &#39;Homebanking&#39;,
+            &#39;icon&#39; =&gt; 37,
+            &#39;level&#39; =&gt; 1,
+        },
+    ]
+&#41;;
+compare&#40;
+    &#39;entry&#39;,  [
+        {
+            &#39;title&#39; =&gt; &#39;Sample Entry&#39;,
+            &#39;icon&#39; =&gt; &#39;0&#39;,
+            &#39;username&#39; =&gt; &#39;User Name&#39;,
+            &#39;url&#39; =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://keepass.info/&#39;">http://keepass.info/&#39;</a></span>,
+            &#39;password&#39; =&gt; &#39;Password&#39;,
+        },
+        {
+            &#39;title&#39; =&gt; &#39;Sample Entry #2&#39;,
+            &#39;icon&#39; =&gt; &#39;0&#39;,
+            &#39;username&#39; =&gt; &#39;Michael321&#39;,
+            &#39;url&#39; =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://keepass.info/help/kb/testform.html&#39;">http://keepass.info/help/kb/testform.html&#39;</a></span>,
+            &#39;password&#39; =&gt; &#39;12345&#39;,
+        },
+    ]
+&#41;;
+
+sub compare {
+    my $type = shift;
+    my @expected_items = @{shift&#40;&#41;};
+    my $find_all_method = {
+        &#39;group&#39; =&gt; &#39;find_groups&#39;,
+        &#39;entry&#39; =&gt; &#39;find_entries&#39;,
+    }-&gt;{$type};
+    my $find_one_method = {
+        &#39;group&#39; =&gt; &#39;find_group&#39;,
+        &#39;entry&#39; =&gt; &#39;find_entry&#39;,
+    }-&gt;{$type};
+
+    my @items = $obj-&gt;$find_all_method&#40;{}&#41;;
+    is&#40;$#items, $#expected_items, &#34;\u$type count&#34;&#41;;
+
+    foreach my $expected_item &#40; @expected_items &#41; {
+        my $item = $obj-&gt;$find_one_method&#40;{
+            &#39;title&#39; =&gt; $expected_item-&gt;{&#39;title&#39;}
+        }&#41;;
+        ok&#40;$item, &#34;Found $type &#34;. $expected_item-&gt;{&#39;title&#39;}&#41;;
+        foreach my $property &#40; keys %$expected_item &#41; {
+            if &#40; $property eq &#39;password&#39; &#41; {
+                is&#40;
+                    $obj-&gt;locked_entry_password&#40;$item&#41;,
+                    $expected_item-&gt;{$property},
+                    &#39;Retrieved password&#39;
+                &#41;;
+            }
+            else {
+                is&#40;
+                    $item-&gt;{$property},
+                    $expected_item-&gt;{$property},
+                    &#34;\u$type &#34;. $expected_item-&gt;{&#39;title&#39;}.
+                    &#34; has expected $property&#34;
+                &#41;;
+            }
+        }
+    }
+}
diff --git a/File-KeePass/t/NewDatabase.kdbx b/File-KeePass/t/NewDatabase.kdbx
new file mode 100644
index 0000000000000000000000000000000000000000..3ca08a42f246b14bfcd94802f1578d5ccee0d77e
GIT binary patch
literal 2078
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
IPxc&gt;m`Ak&#38;z1poj5

literal 0
HcmV?d00001

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;04&nbsp;03:14:53&nbsp;2016</span>
    <span class="description">joern.clausen [...] uni-bielefeld.de - Ticket #116709:  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Endianess Bug in File::KeePass</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 04 Aug 2016 09:14:40 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-File-KeePass [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jörn Clausen &lt;joern.clausen [...] uni-bielefeld.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Paul!

I would like to follow up on Bug 85021, which my colleague Peter opened 
in 2013. I tried registering with Bitcard, but did not receive a 
confirmation mail.

I have tried the patch you attached to the bug report in 2014 and can 
confirm, that it allows reading 2.x KeePass files on Solaris 11/sparc. 
Trying to read a 1.x file results in

Couldn&#39;t load the file Database2.kdb: Group header offset is out of 
range. &#40;6, 1375731712&#41; at 
/opt/pkg-hrz/20160711/lib/perl5/vendor_perl/5.24.0/File/KeePass.pm line 
410.

I assume that the changes make the code work only on big endian and now 
break it on little endian, right? So it would be great if you could make 
the module work with both endianesses.

Best Regards,
    Joern

-- 
Jörn Clausen
Plattformen &#38; Serverdienste
Hochschulrechenzentrum

Universität Bielefeld
Universitätsstraße 25
33615 Bielefeld
Telefon: +49 521 106-12601
E-Mail: joern.clausen@uni-bielefeld.de

<span class="clickylink"><a target="new" rel="nofollow" href="http://www.uni-bielefeld.de/hrz">http://www.uni-bielefeld.de/hrz</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Create even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;26&nbsp;07:38:45&nbsp;2019</span>
    <span class="description">gmail [...] beyerscoetzee.com - Ticket #131088:  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Endianness Bug in File::KeePass - Followup</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 26 Nov 2019 14:10:25 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-File-KeePass [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Beyers Coetzee &lt;gmail [...] beyerscoetzee.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">In the last week or so I bumped my head against this selfsame bug, in 
trying to open KeePass databases generated on Red Hat on an IBM 
Mainframe architecture &#40;s390x - big-endian&#41; in Red Hat on a desktop 
architecture &#40;x86_64 little-endian&#41;. And vica-versa too, of course.

I had a look at the patch submitted in 2014, but it did not address 
KeePass v1 databases at all, and more importantly, it contained quite a 
lot of patching I couldn&#39;t figure out at all. So I generated this 
uber-simple patch that *only* addresses the endian problem, both for V1 
and V2 databases. All it does is to replace the template order/type 
specifiers for pack and unpack to little-endian specific ones:

L -&gt; V    &#40;Unsigned long value to unsigned long &#40;32-bit&#41; in 
little-endian order&#41;
S -&gt; v    &#40;Unsigned short value to unsigned short &#40;16-bit&#41; in 
little-endian order&#41;
i -&gt; V    &#40;signed integer value to unsigned long &#40;32-bit&#41; in 
little-endian order&#41;

The first two replacements should theoretically cause no problems that I 
am aware of. The integer replacement is a little worrying, as I am not 
sure why it was used in the first place. It leaves the implementation 
vulnerable to the integer length that was compiled into the operating 
system, at least according to my understanding.

I did not exhaustively test it for all control paths, only for 
generating- and parsing databases on the two architectures to my 
disposal, so no guarantees. I hope though that you will find it useful 
if you are faced with the same problem.
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;26&nbsp;13:52:45&nbsp;2019</span>
    <span class="description">ether [...] cpan.org - Ticket #116709:  Merged into ticket #85012</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;26&nbsp;13:52:45&nbsp;2019</span>
    <span class="description">ether [...] cpan.org -  Merged into ticket #85012</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;26&nbsp;13:52:57&nbsp;2019</span>
    <span class="description">ether [...] cpan.org - Ticket #131088:  Merged into ticket #85012</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;26&nbsp;13:52:57&nbsp;2019</span>
    <span class="description">ether [...] cpan.org -  Merged into ticket #85012</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;30&nbsp;23:12:07&nbsp;2019</span>
    <span class="description">paul [...] seamons.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #131088] Endianness Bug in File::KeePass - Followup</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 30 Nov 2019 20:50:25 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-File-KeePass [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Paul Seamons &lt;paul [...] seamons.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza"><div>I'll look at getting it applied this week</div>
<div><br><div>On Nov 26, 2019 5:38 AM, Beyers Coetzee via RT &lt;bug-File-KeePass@rt.cpan.org&gt; wrote:<br>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><blockquote>
<p dir="ltr">Tue Nov 26 07:38:45 2019: Request 131088 was acted upon.&#13;<br>

Transaction: Ticket created by gmail@beyerscoetzee.com&#13;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Queue: File-KeePass&#13;<br>

&nbsp;&nbsp;&nbsp;&nbsp; Subject: Endianness Bug in File::KeePass - Followup&#13;<br>

&nbsp;&nbsp; Broken in: (no value)&#13;<br>

&nbsp;&nbsp;&nbsp; Severity: (no value)&#13;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Owner: Nobody&#13;<br>

&nbsp; Requestors: gmail@beyerscoetzee.com&#13;<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Status: new&#13;<br>

 Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=131088">https://rt.cpan.org/Ticket/Display.html?id=131088</a></span> &gt;&#13;<br>

&#13;<br>

&#13;<br>

In the last week or so I bumped my head against this selfsame bug, in &#13;<br>

trying to open KeePass databases generated on Red Hat on an IBM &#13;<br>

Mainframe architecture (s390x - big-endian) in Red Hat on a desktop &#13;<br>

architecture (x86_64 little-endian). And vica-versa too, of course.&#13;<br>

&#13;<br>

I had a look at the patch submitted in 2014, but it did not address &#13;<br>

KeePass v1 databases at all, and more importantly, it contained quite a &#13;<br>

lot of patching I couldn't figure out at all. So I generated this &#13;<br>

uber-simple patch that *only* addresses the endian problem, both for V1 &#13;<br>

and V2 databases. All it does is to replace the template order/type &#13;<br>

specifiers for pack and unpack to little-endian specific ones:&#13;<br>

&#13;<br>

L -&gt; V&#160;&#160;&#160; (Unsigned long value to unsigned long (32-bit) in &#13;<br>

little-endian order)&#13;<br>

S -&gt; v&#160;&#160;&#160; (Unsigned short value to unsigned short (16-bit) in &#13;<br>

little-endian order)&#13;<br>

i -&gt; V&#160;&#160;&#160; (signed integer value to unsigned long (32-bit) in &#13;<br>

little-endian order)&#13;<br>

&#13;<br>

The first two replacements should theoretically cause no problems that I &#13;<br>

am aware of. The integer replacement is a little worrying, as I am not &#13;<br>

sure why it was used in the first place. It leaves the implementation &#13;<br>

vulnerable to the integer length that was compiled into the operating &#13;<br>

system, at least according to my understanding.&#13;<br>

&#13;<br>

I did not exhaustively test it for all control paths, only for &#13;<br>

generating- and parsing databases on the two architectures to my &#13;<br>

disposal, so no guarantees. I hope though that you will find it useful &#13;<br>

if you are faced with the same problem.&#13;<br>

&#13;<br>

&#13;<br>

&#13;<br>

</p>

</blockquote>
</div></div><br></div>
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
