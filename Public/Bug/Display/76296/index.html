<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #76296 for DBI: _install_method fails to set CvFILE correctly</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #76296 for DBI: _install_method fails to set CvFILE correctly</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=DBI">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=DBI">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=DBI">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=DBI">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBI">DBI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">76296</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=DBI">DBI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
&#39;spro^^*%*^6ut# [...] &#38;$%*c

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10328-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.618    </td>
  </tr>
  <tr id="CF-10329-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.619    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




open_qqPvVqas.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1058653/554175/open_qqPvVqas.txt">
Wed Apr 04 00:39:03 2012 (549b) by $_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=76296">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1058624" href="/Public/Bug/Display.html?id=76296#txn-1058624">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;03&nbsp;23:46:36&nbsp;2012</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> _install_method fails to set CvFILE correctly</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1058624/554154/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/554154">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">$ perl5.15.9 -MDBI -MDevel::Peek -le &#39;Dump +DBI::db-&gt;can&#40;&#34;FETCH&#34;&#41;&#39;
SV = IV&#40;0x834d0c&#41; at 0x834d10
  REFCNT = 1
  FLAGS = &#40;TEMP,ROK&#41;
  RV = 0x89b590
  SV = PVCV&#40;0x8a9ec0&#41; at 0x89b590
    REFCNT = 3
    FLAGS = &#40;ISXSUB&#41;
    COMP_STASH = 0x0
    XSUB = 0x1bc110
    XSUBANY = 2995200
    GVGV::GV = 0x89b580 &#34;DBI::common&#34; :: &#34;FETCH&#34;
    FILE = &#34;pan/build/namespace-clean-0.23-sEAgdO/blib/lib/Devel/Peek.pmc&#34;
    DEPTH = 0
    FLAGS = 0x8
    OUTSIDE_SEQ = 0
    PADLIST = 0x0
    OUTSIDE = 0x0 &#40;null&#41;

Notice that strange FILE string.

The documentation for newXS says:

I&lt;filename&gt; needs to be static storage, as it is used directly as CvFILE&#40;&#41;, without a copy being 
made.

But DBI is using the pv from inside the SV passed to _install_method.  So CvFILE ends up 
pointing to freed memory, which may get reused by the time CvFILE is looked at.

In perl 5.8.8 and earlier, the only way to fix this is to leak the file name, which is exactly what 
perl itself did for constant subs.  perl 5.8.1 has this on line 4436 of op.c:

    cv = newXS&#40;name, const_sv_xsub, savepv&#40;CopFILE&#40;PL_curcop&#41;&#41;&#41;;

Starting with 5.10.0 and 5.8.9, there is an undocumented newXS_flags function, used pretty 
much everywhere &#40;so thereâ€™s little chance it will change&#41;, whose signature is:

CV *
Perl_newXS_flags&#40;pTHX_ const char *name, XSUBADDR_t subaddr,
                 const char *const filename, const char *const proto,
                 U32 flags&#41;

One of the flags it accepts is XS_DYNAMIC_FILENAME, which tells it to copy the filename 
passed to it, and free it at the same time the CV itself is freed.

As currently written, _install_method might as well pass NULL for the filename, because its 
not accomplishing anything by passing a scalar about to be freed.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1058646" href="/Public/Bug/Display.html?id=76296#txn-1058646">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;04&nbsp;00:34:15&nbsp;2012</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1058646/554167/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/554167">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Apr 03 23:46:36 2012, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Starting with 5.10.0 and 5.8.9, there is an undocumented newXS_flags
&gt; function, used pretty
&gt; much everywhere &#40;so thereâ€™s little chance it will change&#41;, whose
&gt; signature is:
&gt; 
&gt; CV *
&gt; Perl_newXS_flags&#40;pTHX_ const char *name, XSUBADDR_t subaddr,
&gt;                  const char *const filename, const char *const proto,
&gt;                  U32 flags&#41;
&gt; 
&gt; One of the flags it accepts is XS_DYNAMIC_FILENAME, which tells it to
&gt; copy the filename
&gt; passed to it, and free it at the same time the CV itself is freed.
</div>
Alternatively, if you want a method that works in all versions, you can set SvPVX and SvLEN:

    file = savepv&#40;file&#41;;
    cv = newXS&#40;meth_name, XS_DBI_dispatch, file&#41;;
    SvPVX&#40;cv&#41; = file;
    SvLEN&#40;cv&#41; = 1; /* so that SvPVX is freed */

If such an XSUB is used as an AUTOLOAD sub, the file name will leak at that point 
&#40;XS_DYNAMIC_FILENAME itself has the same problem in 5.14 and earlier&#41;, but you can solve 
that by checking in XS_DBI_dispatch whether SvPVX&#40;cv&#41; == CvFILE&#40;cv&#41; and setting 
SvPVX/SvLEN again.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1058649" href="/Public/Bug/Display.html?id=76296#txn-1058649">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;04&nbsp;00:34:16&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1058650" href="/Public/Bug/Display.html?id=76296#txn-1058650">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;04&nbsp;00:35:34&nbsp;2012</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1058650/554170/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/554170">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Apr 04 00:34:15 2012, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Apr 03 23:46:36 2012, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; Starting with 5.10.0 and 5.8.9, there is an undocumented newXS_flags
&gt; &gt; function, used pretty
&gt; &gt; much everywhere &#40;so thereâ€™s little chance it will change&#41;, whose
&gt; &gt; signature is:
&gt; &gt;
&gt; &gt; CV *
&gt; &gt; Perl_newXS_flags&#40;pTHX_ const char *name, XSUBADDR_t subaddr,
&gt; &gt;                  const char *const filename, const char *const
</div>&gt; proto,
<div class="message-stanza open">&gt; &gt;                  U32 flags&#41;
&gt; &gt;
&gt; &gt; One of the flags it accepts is XS_DYNAMIC_FILENAME, which tells it
</div>&gt; to
<div class="message-stanza open">&gt; &gt; copy the filename
&gt; &gt; passed to it, and free it at the same time the CV itself is freed.
</div>&gt; 
&gt; Alternatively, if you want a method that works in all versions, you
&gt; can set SvPVX and SvLEN:
&gt; 
&gt;     file = savepv&#40;file&#41;;
&gt;     cv = newXS&#40;meth_name, XS_DBI_dispatch, file&#41;;
&gt;     SvPVX&#40;cv&#41; = file;
&gt;     SvLEN&#40;cv&#41; = 1; /* so that SvPVX is freed */
</div>
To avoid compiler warnings, those should be SvPVX&#40;&#40;SV *&#41;cv&#41; and SvLEN&#40;&#40;SV *&#41;cv&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; If such an XSUB is used as an AUTOLOAD sub, the file name will leak at
&gt; that point
&gt; &#40;XS_DYNAMIC_FILENAME itself has the same problem in 5.14 and earlier&#41;,
&gt; but you can solve
&gt; that by checking in XS_DBI_dispatch whether SvPVX&#40;cv&#41; == CvFILE&#40;cv&#41;
&gt; and setting
&gt; SvPVX/SvLEN again.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1058653" href="/Public/Bug/Display.html?id=76296#txn-1058653">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;04&nbsp;00:39:02&nbsp;2012</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1058653/554174/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/554174">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Apr 04 00:35:34 2012, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Apr 04 00:34:15 2012, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; On Tue Apr 03 23:46:36 2012, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; &gt; Starting with 5.10.0 and 5.8.9, there is an undocumented
</div></div>&gt; newXS_flags
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; function, used pretty
&gt; &gt; &gt; much everywhere &#40;so thereâ€™s little chance it will change&#41;, whose
&gt; &gt; &gt; signature is:
&gt; &gt; &gt;
&gt; &gt; &gt; CV *
&gt; &gt; &gt; Perl_newXS_flags&#40;pTHX_ const char *name, XSUBADDR_t subaddr,
&gt; &gt; &gt;                  const char *const filename, const char *const
</div>&gt; &gt; proto,
<div class="message-stanza open">&gt; &gt; &gt;                  U32 flags&#41;
&gt; &gt; &gt;
&gt; &gt; &gt; One of the flags it accepts is XS_DYNAMIC_FILENAME, which tells it
</div>&gt; &gt; to
<div class="message-stanza open">&gt; &gt; &gt; copy the filename
&gt; &gt; &gt; passed to it, and free it at the same time the CV itself is freed.
</div>&gt; &gt;
&gt; &gt; Alternatively, if you want a method that works in all versions, you
&gt; &gt; can set SvPVX and SvLEN:
&gt; &gt;
&gt; &gt;     file = savepv&#40;file&#41;;
&gt; &gt;     cv = newXS&#40;meth_name, XS_DBI_dispatch, file&#41;;
&gt; &gt;     SvPVX&#40;cv&#41; = file;
&gt; &gt;     SvLEN&#40;cv&#41; = 1; /* so that SvPVX is freed */
</div>&gt; 
&gt; To avoid compiler warnings, those should be SvPVX&#40;&#40;SV *&#41;cv&#41; and
&gt; SvLEN&#40;&#40;SV *&#41;cv&#41;.
</div>
Attached is that suggestion as a patch.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt; &gt;
&gt; &gt; If such an XSUB is used as an AUTOLOAD sub, the file name will leak
</div>&gt; at
<div class="message-stanza open">&gt; &gt; that point
&gt; &gt; &#40;XS_DYNAMIC_FILENAME itself has the same problem in 5.14 and
</div>&gt; earlier&#41;,
<div class="message-stanza open">&gt; &gt; but you can solve
&gt; &gt; that by checking in XS_DBI_dispatch whether SvPVX&#40;cv&#41; == CvFILE&#40;cv&#41;
&gt; &gt; and setting
&gt; &gt; SvPVX/SvLEN again.
</div></div>
These arenâ€™t ever used for AUTOLOAD, are they?
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> open_qqPvVqas.txt</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1058653/554175/open_qqPvVqas.txt">Download open_qqPvVqas.txt</a><br />
<span class="downloadcontenttype">text/plain 549b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -rup DBI-1.618-aha5Y2/DBI.xs DBI-1.618-aha5Y2-copy/DBI.xs
--- DBI-1.618-aha5Y2/DBI.xs	2012-04-03 21:37:46.000000000 -0700
+++ DBI-1.618-aha5Y2-copy/DBI.xs	2012-04-03 21:35:50.000000000 -0700
@@ -4573,7 +4573,10 @@ _install_method&#40;dbi_class, meth_name, fi
     }
     if &#40;trace_msg&#41;
         PerlIO_printf&#40;DBILOGFP,&#34;%s\n&#34;, SvPV_nolen&#40;trace_msg&#41;&#41;;
+    file = savepv&#40;file&#41;;
     cv = newXS&#40;meth_name, XS_DBI_dispatch, file&#41;;
+    SvPVX&#40;&#40;SV *&#41;cv&#41; = file;
+    SvLEN&#40;&#40;SV *&#41;cv&#41; = 1;
     CvXSUBANY&#40;cv&#41;.any_ptr = ima;
     ST&#40;0&#41; = &#38;PL_sv_yes;
     }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1069411" href="/Public/Bug/Display.html?id=76296#txn-1069411">#</a>      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;19&nbsp;04:04:57&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1069411/562417/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/562417">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 194b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Apr 04 00:39:02 2012, SPROUT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Attached is that suggestion as a patch.
</div>
Thanks, applied to subversion trunk and should be in next release.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1069414" href="/Public/Bug/Display.html?id=76296#txn-1069414">#</a>      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;19&nbsp;04:05:42&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1071271" href="/Public/Bug/Display.html?id=76296#txn-1071271">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;25&nbsp;04:07:35&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1071273" href="/Public/Bug/Display.html?id=76296#txn-1071273">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;25&nbsp;04:07:36&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Fixed in 1.619 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.525923</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
