<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #63087 for DBIx-Class: Unique constraint with null values</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #63087 for DBIx-Class: Unique constraint with null values</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBIx-Class/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBIx-Class">DBIx-Class CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">63087</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBIx-Class/Active/">DBIx-Class</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
MAROS [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-10410-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.08124    </td>
  </tr>
  <tr id="CF-10411-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;17&nbsp;10:16:42&nbsp;2010</span>
    <span class="description">MAROS [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Unique constraint with null values</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Find or create on an unique constraint with nullable values does not
seem to work. See attached testcase for more details

Cheers
Maroš
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> find_or_create_unique.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use warnings;

use Test::More;
use Test::Exception;

use lib qw&#40;t/lib&#41;;
use DBIC::SqlMakerTest;
use DBICTest;

my $schema = DBICTest-&gt;init_schema&#40;&#41;;

my $artist_rs = $schema-&gt;resultset &#40;&#39;Artist&#39;&#41;;

my $artist_ebony_bones1 = $artist_rs-&gt;create&#40;{
    name        =&gt; &#39;Ebony Bones&#39;,
    rank        =&gt; 666,
    charfield   =&gt; &#39;E&#39;,
}&#41;;

my $artist_ebony_bones2 = $artist_rs-&gt;find_or_create&#40;{
    name        =&gt; &#39;Ebony Bones&#39;,
    rank        =&gt; 666,
    charfield   =&gt; &#39;E&#39;,
},{
    key         =&gt; &#39;u_nullable&#39;,
}&#41;;

is&#40;$artist_ebony_bones1-&gt;artistid,$artist_ebony_bones2-&gt;artistid,&#39;Same artist&#39;&#41;;

my $artist_mia1 = $artist_rs-&gt;create&#40;{
    name        =&gt; &#39;M.I.A.&#39;,
    rank        =&gt; 555,
    charfield   =&gt; undef,
}&#41;;

my $artist_mia2 = $artist_rs-&gt;find_or_create&#40;{
    name        =&gt; &#39;M.I.A.&#39;,
    rank        =&gt; 555,
    charfield   =&gt; undef,
},{
    key         =&gt; &#39;u_nullable&#39;,
}&#41;;

is&#40;$artist_mia1-&gt;artistid,$artist_mia2-&gt;artistid,&#39;Same artist&#39;&#41;;

$artist_mia1-&gt;delete&#40;&#41;;

done_testing;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;17&nbsp;15:40:33&nbsp;2010</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Nov 17 10:16:42 2010, MAROS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Find or create on an unique constraint with nullable values does not
&gt; seem to work. See attached testcase for more details
</div>
I am not sure what the bugreport is about. The test case you attached
throws with the correct expected error. Can you elaborate why you think
this is not the desired behavior?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;17&nbsp;15:40:36&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;18&nbsp;06:36:54&nbsp;2010</span>
    <span class="description">MAROS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I am not sure what the bugreport is about. The test case you attached
&gt; throws with the correct expected error. Can you elaborate why you 
&gt; think this is not the desired behavior?
</div>
I have attached an updated test case that should make my point clearer.

The problem is that the test dies if i provide the key with &#34;charfield 
 =&gt; undef&#34;, which is a perfectly valid value and should translate to
NULL &#40;or &#39;IS NULL&#39;&#41; in the database. &#40;see &#39;M.I.A.&#39; test case&#41;.

According to my understanding of DBIC the &#39;M.I.A.&#39; and &#39;Robyn&#39; test
cases should behave the same &#40;of course the &#39;Robyn&#39; find_or_create
statement would produce an invalid sql in the create case&#41;

However it is also ok that an error is thrown if the key is not provided
at all &#40;see &#39;Santogold&#39; test case&#41;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> find_or_create_unique_updated.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use warnings;

use Test::More;
use Test::Exception;

use lib qw&#40;t/lib&#41;;
use DBIC::SqlMakerTest;
use DBICTest;

my $schema = DBICTest-&gt;init_schema&#40;&#41;;

my $artist_rs = $schema-&gt;resultset &#40;&#39;Artist&#39;&#41;;

# Test with charfield NOT NULL
{
    my &#40;$artist_ebony_bones1,$artist_ebony_bones2&#41;;
    
    $artist_ebony_bones1 = $artist_rs-&gt;create&#40;{
        name        =&gt; &#39;Ebony Bones&#39;,
        rank        =&gt; 666,
        charfield   =&gt; &#39;E&#39;,
    }&#41;;
    
    $artist_ebony_bones2 = $artist_rs-&gt;find_or_create&#40;{
        name        =&gt; &#39;Ebony Bones&#39;,
        rank        =&gt; 666,
        charfield   =&gt; &#39;E&#39;, # &lt;- Charfield provided - hence should not die
    },{
        key         =&gt; &#39;u_nullable&#39;,
    }&#41;;
    
    is&#40;$artist_ebony_bones1-&gt;artistid,$artist_ebony_bones2-&gt;artistid,&#39;Same artist&#39;&#41;;
    
    $artist_ebony_bones1-&gt;delete;
}

## Test with charfield NOT NULL and provided as undef
#{
#    my &#40;$artist_mia1,$artist_mia2&#41;;
#    
#    $artist_mia1 = $artist_rs-&gt;create&#40;{
#        name        =&gt; &#39;M.I.A.&#39;,
#        rank        =&gt; 555,
#        charfield   =&gt; undef,
#    }&#41;;
#    
#    $artist_mia2 = $artist_rs-&gt;find_or_create&#40;{
#        name        =&gt; &#39;M.I.A.&#39;,
#        rank        =&gt; 555,
#        charfield   =&gt; undef, # &lt;- Charfield provided - hence should not die
#    },{
#        key         =&gt; &#39;u_nullable&#39;,
#    }&#41;;
#    
#    is&#40;$artist_mia1-&gt;artistid,$artist_mia2-&gt;artistid,&#39;Same artist&#39;&#41;;
#    
#    $artist_mia1-&gt;delete&#40;&#41;;
#}

# Test with charfield NOT NULL and provided as NULL
{
    my &#40;$artist_robyn_1,$artist_robyn_2&#41;;
    
    $artist_robyn_1 = $artist_rs-&gt;create&#40;{
        name        =&gt; &#39;Robyn&#39;,
        rank        =&gt; 999,
        charfield   =&gt; \&#39;IS NULL&#39;,
    }&#41;;
    
    $artist_robyn_2 = $artist_rs-&gt;find_or_create&#40;{
        name        =&gt; &#39;Robyn&#39;,
        rank        =&gt; 999,
        charfield   =&gt; \&#39;IS NULL&#39;, # &lt;- Charfield provided - hence should not die
    },{
        key         =&gt; &#39;u_nullable&#39;, 
    }&#41;;
    
    is&#40;$artist_robyn_1-&gt;artistid,$artist_robyn_2-&gt;artistid,&#39;Same artist&#39;&#41;;
    
    $artist_robyn_1-&gt;delete&#40;&#41;;
}

# Test with charfield NULL and not provided
{
    my &#40;$artist_santogold1,$artist_santogold2&#41;;
    
    $artist_santogold1 = $artist_rs-&gt;create&#40;{
        name        =&gt; &#39;Santogold&#39;,
        rank        =&gt; 777,
        charfield   =&gt; undef,
    }&#41;;
    
    throws_ok {
        $artist_santogold2 = $artist_rs-&gt;find_or_create&#40;{
            name        =&gt; &#39;Santogold&#39;,
            rank        =&gt; 777,
            # &lt;- Charfield not provided - hence should die
        },{
            key         =&gt; &#39;u_nullable&#39;,
        }&#41;;
        
    } qr/Unable to satisfy requested constraint/;
    
    $artist_santogold1-&gt;delete&#40;&#41;;
}

done_testing;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;18&nbsp;06:54:56&nbsp;2010</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Nov 18 06:36:54 2010, MAROS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I am not sure what the bugreport is about. The test case you attached
&gt; &gt; throws with the correct expected error. Can you elaborate why you 
&gt; &gt; think this is not the desired behavior?
</div>&gt; 
&gt; I have attached an updated test case that should make my point clearer.
&gt; 
&gt; The problem is that the test dies if i provide the key with &#34;charfield 
&gt;  =&gt; undef&#34;, which is a perfectly valid value and should translate to
&gt; NULL &#40;or &#39;IS NULL&#39;&#41; in the database. &#40;see &#39;M.I.A.&#39; test case&#41;.
</div>
It is pretty far from valid. When you ask for a specific key =&gt;, you are
essentially saying &#34;satisfy this constraint uniquely&#34;, so DBIC does the
obvious checks to make sure that it has all the values to satisfy the
constraint. Considering that NULL != NULL, a null-containing constraint
is not unique by definition. So DBIC tells you that what you asked does
not match what you supplied.

Admittedly this was not visible in earlier versions, due to a naive
implementation bug. Let me know if this clears it up.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;27&nbsp;17:19:05&nbsp;2010</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Nov 17 10:16:42 2010, MAROS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Find or create on an unique constraint with nullable values does not
&gt; seem to work. See attached testcase for more details
&gt; 
&gt; Cheers
&gt; Maroš
</div>
I am closing this as a non-bug. If you still feel the current behavior
is incorrect - feel free to discuss it further &#40;or better yet pop into
irc.perl.org#dbix-class for a more interactive feedback&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;27&nbsp;17:19:06&nbsp;2010</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
