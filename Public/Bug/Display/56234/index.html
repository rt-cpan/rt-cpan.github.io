<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #56234 for Win32-Exe: Corruption of EXEs when setting Icons</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #56234 for Win32-Exe: Corruption of EXEs when setting Icons</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Win32-Exe/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Win32-Exe/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Win32-Exe/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Win32-Exe/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Win32-Exe">Win32-Exe CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">56234</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Win32-Exe/Active/">Win32-Exe</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
RPKELLY [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-35514-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.11    </td>
  </tr>
  <tr id="CF-35515-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




an.ico<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/757574/391780/an.ico">
Fri Apr 02 14:20:22 2010 (97.3k) by RPKELLY [...] cpan.org
</a>
</font></li>
</ul>


nm.ico<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/757574/391779/nm.ico">
Fri Apr 02 14:20:21 2010 (42.3k) by RPKELLY [...] cpan.org
</a>
</font></li>
</ul>


runner.exe<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/757574/391781/runner.exe">
Fri Apr 02 14:20:23 2010 (91.5k) by RPKELLY [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;02&nbsp;14:20:21&nbsp;2010</span>
    <span class="description">RPKELLY [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Corruption of EXEs when setting Icons</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sometimes, Win32::Exe will write back a corrupted EXE which cannot be
run when setting the icon files in the executable. Attached are two icon
files, and an exe. Using an.ico will not corrupt the executable, but
nm.ico will. Altering sub &#34;set_icons&#34; in Win32/Exe.pm to the following
fixes the issue:

sub set_icons {
    my &#40;$self, $icons&#41; = @_;

    my $rsrc = $self-&gt;resource_section;

    my @gicons = $rsrc-&gt;objects&#40;&#39;GroupIcon&#39;&#41;;
    foreach my $gicon &#40;@gicons&#41; {
        my $group = $self-&gt;require_class&#40;&#39;Resource::GroupIcon&#39;&#41;-&gt;new;
        $group-&gt;SetPathName&#40;$gicon-&gt;PathName&#41;;
        $group-&gt;set_parent&#40;$rsrc&#41;;
        $rsrc-&gt;insert&#40;$group-&gt;PathName, $group&#41;;

        $group-&gt;set_icons&#40;$icons&#41;;
        $group-&gt;refresh;
    }
}

Note that making this change will cause test #12 &#40;line 41&#41; in file
2-icon.t to fail because the size of the resulting executable is larger.

Thanks,
-Ryan Kelly
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> nm.ico</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/757574/391779/nm.ico">Download nm.ico</a><br />
<span class="downloadcontenttype">image/x-icon 42.3k</span>
</div>
<div class="messagebody">
<img alt="nm.ico" title="nm.ico" src="/Ticket/Attachment/757574/391779/" /></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> an.ico</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/757574/391780/an.ico">Download an.ico</a><br />
<span class="downloadcontenttype">image/x-icon 97.3k</span>
</div>
<div class="messagebody">
<img alt="an.ico" title="an.ico" src="/Ticket/Attachment/757574/391780/" /></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> runner.exe</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/757574/391781/runner.exe">Download runner.exe</a><br />
<span class="downloadcontenttype">application/octet-stream 91.5k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;28&nbsp;20:41:58&nbsp;2010</span>
    <span class="description">mdootson [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

The exec image produced by Win32::Exe using nm.ico and runner.exe is not 
corrupted. After updating you can see the icon images for the executable 
in explorer, you can view the version information etc etc.

The issue is that originally, runner.exe has three icon resources named 
IDI_APPICON, IDI_DOCUMENT and #32512

Within the runner.exe code attempts are probably made to load the 
resource named IDI_APPICON, which fail and give the spurious &#39;not a 
valid application&#39; messages.

Your code change replaces all existing icon resources with a copy of 
nm.ico, but keeps the original names. This happens to work for 
runner.exe but is a big change in behaviour for the method set_icons.

The Windows resource loading methods are inconsistent &#40;clearly&#41;. It 
would appear that when a resource with id IDI_APPICON is requested, IF 
this is not present Windows defaults to the first GROUPICON and must 
find an icon of the requested type in there. If, however, IDI_APPICON is 
found, Windows is not so fussy about finding the exact type in it and 
will convert the nearest compatible type. Hence, existing Win32::Exe 
code works with  an.ico, which has necessary 32 bit images, but not with  
nm.ico. If, however, a resource with IDI_APPICON is created, it 
apparently does not matter what gets stuffed in there.

Anyhow, I would think if you are changing the icons of an application 
that expects certain things at certain id&#39;s, that is going to be 
application specific and not something that can or should be dealt with 
by the generic &#39;set_icons&#39; method.

I shall use your code as the basis for adding a few methods

&#39;list_groupicon_names&#39;
&#39;replace_group_icon&#39; &#40;takes a groupicon name and an iconfile&#41;
&#39;remove_group_icon&#39; &#40; takes a groupicon name &#41;

so that if you know what you want to do, it is possible without having 
to write the raw code.

Thanks

Mark


On Fri Apr 02 14:20:21 2010, RPKELLY wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sometimes, Win32::Exe will write back a corrupted EXE which cannot be
&gt; run when setting the icon files in the executable. Attached are two 
</div>icon
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; files, and an exe. Using an.ico will not corrupt the executable, but
&gt; nm.ico will. Altering sub &#34;set_icons&#34; in Win32/Exe.pm to the following
&gt; fixes the issue:
&gt; 
&gt; sub set_icons {
&gt;     my &#40;$self, $icons&#41; = @_;
&gt; 
&gt;     my $rsrc = $self-&gt;resource_section;
&gt; 
&gt;     my @gicons = $rsrc-&gt;objects&#40;&#39;GroupIcon&#39;&#41;;
&gt;     foreach my $gicon &#40;@gicons&#41; {
&gt;         my $group = $self-&gt;require_class&#40;&#39;Resource::GroupIcon&#39;&#41;-&gt;new;
&gt;         $group-&gt;SetPathName&#40;$gicon-&gt;PathName&#41;;
&gt;         $group-&gt;set_parent&#40;$rsrc&#41;;
&gt;         $rsrc-&gt;insert&#40;$group-&gt;PathName, $group&#41;;
&gt; 
&gt;         $group-&gt;set_icons&#40;$icons&#41;;
&gt;         $group-&gt;refresh;
&gt;     }
&gt; }
&gt; 
&gt; Note that making this change will cause test #12 &#40;line 41&#41; in file
&gt; 2-icon.t to fail because the size of the resulting executable is 
</div>larger.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Thanks,
&gt; -Ryan Kelly
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;28&nbsp;20:41:59&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;28&nbsp;20:41:59&nbsp;2010</span>
    <span class="description">mdootson [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
