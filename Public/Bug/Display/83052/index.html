<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #83052 for DBD-DB2: Connecting to database using different codepage results in double free</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #83052 for DBD-DB2: Connecting to database using different codepage results in double free</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-DB2/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-DB2/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-DB2/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-DB2/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-DB2">DBD-DB2 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">83052</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-DB2/Active/">DBD-DB2</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
merijnb [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-10084-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
1.84</li>
<li>
1.85</li>
</ul>
    </td>
  </tr>
  <tr id="CF-10085-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;30&nbsp;12:02:22&nbsp;2013</span>
    <span class="description">merijnb [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Connecting to database using different codepage results in double
 free</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

When using a database that was created using a big5 code set, I see a
warning at program exit: 

DBD::MSDB2::db disconnect failed: Free HENV Failed at testdb2.pl line 59.
DBD::MSDB2::db disconnect failed: Free HENV Failed at testdb2.pl line 59.

Tracing the problem, this is because the DB2CODEPAGE was not set in the
environment. If I export DB2CODEPAGE=950 before, this works without the
free failing warning message. 

Debugging the code in dbdimp.c I see in method dbd_db_connect the ret
value after the following line:

  ret = SQLDriverConnect&#40;imp_dbh-&gt;hdbc,
&#40;SQLHWND&#41;NULL,dbname,SQL_NTS,NULL,0,NULL,SQL_DRIVER_NOPROMPT&#41;;

being set to 1, which in sqlcli.h is defined: 

#define  SQL_SUCCESS_WITH_INFO   1

and the next line does CHECK_ERROR, which is defined in dbdimp.h and
thus calls diagnoseError. In here SQL_SUCCESS_WITH_INFO is treated as an
error, and when the code returns, it still is and a goto exit is followed. 

At this exit: label, the ret value is checked, and if it is not
SQL_SUCCESS, cleanup code is run. So in this case the hdbc and henv
handles are both freed. This is the root cause of the problem.

Then the code returns this ret value to the caller, which is in
dbd_db_login2. Here the return code is checked using EOI:

        ret = dbd_db_connect&#40; dbh,
                        imp_dbh,
                        &#40;SQLCHAR*&#41;dbname,
                        &#40;SQLCHAR*&#41;uid,
                        &#40;SQLCHAR*&#41;pwd,
                        attr &#41;;
        EOI&#40;ret&#41;;

This check is defined as: 

#define EOI&#40;x&#41;  if &#40;x &lt; 0 || x == SQL_NO_DATA&#41; return &#40;FALSE&#41;

since SQL_SUCCESS_WITH_INFO is equal to 1, this does not return false
and the code carries on, registering the handler and returning true for
a successful connect. But the connect actually had info and since it was
considered an error, the handles were cleaned up. 

Later, at disconnect time, the code in dbd_db_disconnect will call
SQLFreeHandle and this will then fail. We see the warning twice since
the DESTROY phase does this again.

The SQL_SUCCESS_WITH_INFO that is returned yields this warning: 

DB2/LINUXX8664] SQL0863W  A successful connection was made, but only
single byte characters should be used.  SQLSTATE=01539

which is a fair warning. But since the dbd_db_login2 does not return
FALSE, the Perl code does not get told about any error having occurred.

The obvious immediate solution would be to change EOI to say x &gt; 1, so 
SQL_SUCCESS_WITH_INFO is considered an error like it is in
dbd_db_connect. However, this macro is used all over the place, so that
might have unintended consequences. So perhaps only in dbd_db_login2
this with-info code should be checked for and return false and
consequently the connect call would fail at the DBI level and the user
would be made aware of the error. 

The other option would be not to clean up the handle at all, and
continue regardless in case of SQL_SUCCESS_WITH_INFO, ignoring the 
diagnostic error about the single byte characters. 

However, the best solution would be to use the W methods instead:

<span class="clickylink"><a target="new" rel="nofollow" href="http://pic.dhe.ibm.com/infocenter/db2luw/v9r7/topic/com.ibm.db2.luw.apdv.cli.doc/doc/c0006840.html">http://pic.dhe.ibm.com/infocenter/db2luw/v9r7/topic/com.ibm.db2.luw.apdv.cli.doc/doc/c0006840.html</a></span>

like the python ibm_db driver does, with translation from UCS-2 to UTF8.
But that would be an extensive reworking of the code.

This issue can be seen outside of Perl with the db2 command line tool. 

$ db2 connect to testbig5

   Database Connection Information

 Database server        = DB2/LINUXX8664 9.5.9
 SQL authorization ID   = XXXX
 Local database alias   = XX010002

SQL0863W  A successful connection was made, but only single byte
characters should be used.  SQLSTATE=01539
$ echo $?
2
$ db2 terminate
DB20000I  The TERMINATE command completed successfully.
$ export DB2CODEPAGE=950
$ db2 connect to testbig5

   Database Connection Information

 Database server        = DB2/LINUXX8664 9.5.9
 SQL authorization ID   = XXXX
 Local database alias   = XX010002

$ echo $?
0

but here the return codes show that there is a problem.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
