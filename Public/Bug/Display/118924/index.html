<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #118924 for Net-IDN-Encode: encode_punycode heap overflow</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #118924 for Net-IDN-Encode: encode_punycode heap overflow</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-IDN-Encode/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-IDN-Encode/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-IDN-Encode/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-IDN-Encode/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-IDN-Encode">Net-IDN-Encode CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">118924</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">10 min

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-IDN-Encode/Active/">Net-IDN-Encode</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">CFAERBER [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
alexander.bluhm [...] gmx.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-22720-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
2.300</li>
<li>
2.301</li>
</ul>
    </td>
  </tr>
  <tr id="CF-22721-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
2.399_20161227    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;23&nbsp;12:21:47&nbsp;2016</span>
    <span class="description">alexander.bluhm [...] gmx.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> encode_punycode heap overflow</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">When running the tests of Net-IDN-Encode-2.300 on OpenBSD with
additional malloc&#40;3&#41; checks, Perl crashes.

This happens during test t/uts46_to_ascii-trans.t:

t/uts46_encode_utf8.t ..... ok
perl&#40;92732&#41; in free&#40;&#41;: chunk canary corrupted 0x17858bb94100 0x65@0x65
t/uts46_to_ascii-trans.t .. 
Failed 3600/3770 subtests 
        &#40;2 TODO tests unexpectedly succeeded&#41;
t/uts46_to_ascii.t ........ ok

Subtest 171 seems to trigger the heap overflow:

ok 170 - to_ascii&#40;&#39;xn--53h&#39;&#41; [data/IdnaTest.txt:275]
perl&#40;4839&#41; in free&#40;&#41;: chunk canary corrupted 0x1d2e5083ce80 0x65@0x65
Abort trap 

Here is the man page snippet that describes what is going on:

     ``chunk canary corrupted address offset@length&#39;&#39;
             A byte after the requested size has been overwritten, indicating
             a heap overflow.  The offset at which corruption was detected is
             printed before the @, and the requested length of the allocation
             after the @.

I have looked at the XS code and only the length of the input string
is checked.  The size of the output string is increased from time
to time, but not always when the output pointer is moved forward.

So I have put the realloc in a function grow_string&#40;&#41; and call it
every time before a value is written to *re_p.  This patch fixes the
test.

--- lib/Net/IDN/Punycode.xs.orig        Fri Jul 17 21:10:51 2015
+++ lib/Net/IDN/Punycode.xs     Tue Nov 22 14:34:09 2016
@@ -49,6 +49,20 @@ static int adapt&#40;int delta, int numpoints, int first&#41; 
   return k + &#40;&#40;&#40;BASE-TMIN+1&#41; * delta&#41; / &#40;delta+SKEW&#41;&#41;;
 };
 
+static void
+grow_string&#40;SV *const sv, char **start, char **current, char **end, STRLEN add&#41;
+{
+  STRLEN len;
+
+  if&#40;*current + add &lt;= *end&#41;
+    return;
+
+  len = &#40;*current - *start + add + 15&#41; &#38; ~15;
+  *start = SvGROW&#40;sv, len&#41;;
+  *current = *start + len;
+  *end = *start + SvLEN&#40;sv&#41;;
+}
+
 MODULE = Net::IDN::Punycode PACKAGE = Net::IDN::Punycode
 
 SV*
@@ -81,15 +95,20 @@ encode_punycode&#40;input&#41;
 
                /* copy basic code points */
                while&#40;in_p &lt; in_e&#41; {
-                 if&#40; isBASE&#40;*in_p&#41; &#41; 
+                 if&#40; isBASE&#40;*in_p&#41; &#41;  {
+                   grow_string&#40;RETVAL, &#38;re_s, &#38;re_p, &#38;re_e, 1&#41;;
                    *re_p++ = *in_p;
+                 }
                  in_p++;
                }
 
                h = re_p - re_s;
 
                /* add DELIM if needed */       
-               if&#40;h&#41; *re_p++ = DELIM;
+               if&#40;h&#41; {
+                 grow_string&#40;RETVAL, &#38;re_s, &#38;re_p, &#38;re_e, 1&#41;;
+                 *re_p++ = DELIM;
+               }
 
                for&#40;;;&#41; {
                  /* find smallest code point not yet handled */
@@ -138,20 +157,14 @@ encode_punycode&#40;input&#41;
                      q = delta;
 
                      for&#40;k = BASE;; k += BASE&#41; {
-                       if&#40;re_p &gt;= re_e&#41; {
-                         length_guess = re_e - re_s + 16;
-                         re_e = SvGROW&#40;RETVAL, length_guess&#41;;
-                         re_p = re_e + &#40;re_p - re_s&#41;;
-                         re_s = re_e;
-                         re_e = re_s + SvLEN&#40;RETVAL&#41;;
-                       }
-
                        t = TMIN_MAX&#40;k - bias&#41;;
                        if&#40;q &lt; t&#41; break;
+                       grow_string&#40;RETVAL, &#38;re_s, &#38;re_p, &#38;re_e, 1&#41;;
                        *re_p++ = enc_digit[t + &#40;&#40;q-t&#41; % &#40;BASE-t&#41;&#41;];
                        q = &#40;q-t&#41; / &#40;BASE-t&#41;;
                      }
                      if&#40;q &gt; BASE&#41; croak&#40;&#34;input exceeds punycode limit&#34;&#41;;
+                     grow_string&#40;RETVAL, &#38;re_s, &#38;re_p, &#38;re_e, 1&#41;;
                      *re_p++ = enc_digit[q];
                      bias = adapt&#40;delta, h+1, first&#41;;
                       delta = first = 0;
@@ -162,6 +175,7 @@ encode_punycode&#40;input&#41;
                  ++delta;
                  ++n;
                }
+               grow_string&#40;RETVAL, &#38;re_s, &#38;re_p, &#38;re_e, 1&#41;;
                *re_p = 0;
                SvCUR_set&#40;RETVAL, re_p - re_s&#41;;
                ST&#40;0&#41; = RETVAL;
@@ -201,6 +215,7 @@ decode_punycode&#40;input&#41;
                  c = *in_p;                                    /* we don&#39;t care whether it&#39;s UTF-8 */
                  if&#40;!isBASE&#40;c&#41;&#41; croak&#40;&#34;non-base character in input for decode_punycode&#34;&#41;;
                  if&#40;c == DELIM&#41; skip_p = in_p;
+                 grow_string&#40;RETVAL, &#38;re_s, &#38;re_p, &#38;re_e, 1&#41;;
                  *re_p++ = c;                                  /* copy it */
                }
 
@@ -236,18 +251,11 @@ decode_punycode&#40;input&#41;
 
                  u8 = UNISKIP&#40;n&#41;;                              /* how many bytes we need */
 
-                 if&#40;re_p + u8 &gt;= re_e&#41; {
-                   length_guess = re_e - re_p + u8 + 16;
-                   re_e = SvGROW&#40;RETVAL, length_guess&#41;;
-                   re_p = re_e + &#40;re_p - re_s&#41;;
-                   re_s = re_e;
-                   re_e = re_s + SvLEN&#40;RETVAL&#41;;
-                 }
-
                  j = i;
                  for&#40;skip_p = re_s; j &gt; 0; j--&#41;                /* find position in UTF-8 */
                    skip_p+=UTF8SKIP&#40;skip_p&#41;;
 
+                 grow_string&#40;RETVAL, &#38;re_s, &#38;re_p, &#38;re_e, u8&#41;;
                  if&#40;skip_p &lt; re_p&#41;                             /* move succeeding chars */
                    Move&#40;skip_p, skip_p + u8, re_p - skip_p, char&#41;; 
                  re_p += u8;
@@ -255,6 +263,7 @@ decode_punycode&#40;input&#41;
                }
 
                if&#40;!first&#41; SvUTF8_on&#40;RETVAL&#41;;                   /* UTF-8 chars have been inserted */
+               grow_string&#40;RETVAL, &#38;re_s, &#38;re_p, &#38;re_e, 1&#41;;
                *re_p = 0;
                SvCUR_set&#40;RETVAL, re_p - re_s&#41;;
                ST&#40;0&#41; = RETVAL;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;03&nbsp;06:47:36&nbsp;2016</span>
    <span class="description">CFAERBER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">10 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you for reporting this. It&#39;s interesting that this bug has not been noticed so far. I&#39;ll release a new version shortly.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;03&nbsp;06:47:37&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;03&nbsp;06:47:37&nbsp;2016</span>
    <span class="description">CFAERBER [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;03&nbsp;06:47:37&nbsp;2016</span>
    <span class="description">CFAERBER [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;03&nbsp;06:47:49&nbsp;2016</span>
    <span class="description">CFAERBER [...] cpan.org -  Ticket deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;03&nbsp;06:47:50&nbsp;2016</span>
    <span class="description">CFAERBER [...] cpan.org -  Status changed from &#39;deleted&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;03&nbsp;06:48:22&nbsp;2016</span>
    <span class="description">CFAERBER [...] cpan.org -  Severity Critical added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;03&nbsp;06:48:22&nbsp;2016</span>
    <span class="description">CFAERBER [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;04&nbsp;07:06:36&nbsp;2016</span>
    <span class="description">paul [...] city-fan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> paul [...] city-fan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Dec 03 06:47:36 2016, CFAERBER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thank you for reporting this. It&#39;s interesting that this bug has not
&gt; been noticed so far. I&#39;ll release a new version shortly.
</div>
I&#39;m now seeing crashes on x86_32 builds on some perls:

$ ./Build test
t/00use.t ................. ok
t/10pod.t ................. ok
t/11pod_cover.t ........... ok
t/domain_to_ascii.t ....... ok
t/domain_to_unicode.t ..... ok
t/encode_bytes.t .......... ok
t/encode_utf8.t ........... ok
t/punycode_vec-pp.t ....... ok
t/punycode_vec-xs.t ....... ok
t/uts46_api_call.t ........ ok
t/uts46_encode_bytes.t .... ok
t/uts46_encode_utf8.t ..... ok
*** glibc detected *** /usr/bin/perl: free&#40;&#41;: invalid next size &#40;normal&#41;: 0x08d2d420 ***
======= Backtrace: =========
/lib/libc.so.6[0xf73903a4]
/lib/libc.so.6[0xf7393e46]
/lib/libc.so.6&#40;realloc+0x106&#41;[0xf7394c86]
/usr/lib/perl5/5.10.0/i386-linux-thread-multi/CORE/libperl.so&#40;Perl_safesysrealloc+0x8a&#41;[0xf75fb7aa]
/usr/lib/perl5/5.10.0/i386-linux-thread-multi/CORE/libperl.so&#40;Perl_sv_grow+0x7d&#41;[0xf76527fd]
/builddir/build/BUILD/Net-IDN-Encode-2.301/blib/arch/auto/Net/IDN/Punycode/Punycode.so[0xf709c34e]
/builddir/build/BUILD/Net-IDN-Encode-2.301/blib/arch/auto/Net/IDN/Punycode/Punycode.so[0xf709d075]
/usr/lib/perl5/5.10.0/i386-linux-thread-multi/CORE/libperl.so&#40;Perl_pp_entersub+0xb29&#41;[0xf76267b9]
/usr/lib/perl5/5.10.0/i386-linux-thread-multi/CORE/libperl.so&#40;Perl_runops_debug+0x153&#41;[0xf75e7f53]
/usr/lib/perl5/5.10.0/i386-linux-thread-multi/CORE/libperl.so&#40;perl_run+0x274&#41;[0xf7620904]
/usr/bin/perl&#40;main+0x10e&#41;[0x8048a2e]
/lib/libc.so.6&#40;__libc_start_main+0xe5&#41;[0xf73376e5]
/usr/bin/perl[0x8048881]
======= Memory map: ========
08048000-08049000 r-xp 00000000 00:2a 126137650                          /usr/bin/perl
08049000-0804a000 rw-p 00000000 00:2a 126137650                          /usr/bin/perl
089cf000-09428000 rw-p 00000000 00:00 0                                  [heap]
f6e00000-f6e21000 rw-p 00000000 00:00 0 
f6e21000-f6f00000 ---p 00000000 00:00 0 
f6fcf000-f6fdc000 r-xp 00000000 00:2a 126138418                          /lib/libgcc_s-4.3.2-20081105.so.1
f6fdc000-f6fdd000 rw-p 0000c000 00:2a 126138418                          /lib/libgcc_s-4.3.2-20081105.so.1
f6fdd000-f709b000 rw-p 00000000 00:00 0 
f709b000-f70a0000 r-xp 00000000 00:2a 126136495                          /builddir/build/BUILD/Net-IDN-Encode-2.301/blib/arch/auto/Net/IDN/Punycode/Punycode.so
f70a0000-f70a1000 rw-p 00004000 00:2a 126136495                          /builddir/build/BUILD/Net-IDN-Encode-2.301/blib/arch/auto/Net/IDN/Punycode/Punycode.so
f70a1000-f70cb000 r-xp 00000000 00:2a 126142185                          /usr/lib/perl5/5.10.0/i386-linux-thread-multi/auto/Unicode/Normalize/Normalize.so
f70cb000-f70ec000 rw-p 00029000 00:2a 126142185                          /usr/lib/perl5/5.10.0/i386-linux-thread-multi/auto/Unicode/Normalize/Normalize.so
f70ec000-f7109000 r-xp 00000000 00:2a 126142221                          /usr/lib/perl5/5.10.0/i386-linux-thread-multi/auto/Storable/Storable.so
f7109000-f710a000 rw-p 0001d000 00:2a 126142221                          /usr/lib/perl5/5.10.0/i386-linux-thread-multi/auto/Storable/Storable.so
f710a000-f710d000 r-xp 00000000 00:2a 126142444                          /usr/lib/perl5/5.10.0/i386-linux-thread-multi/auto/Fcntl/Fcntl.so
f710d000-f710e000 rw-p 00003000 00:2a 126142444                          /usr/lib/perl5/5.10.0/i386-linux-thread-multi/auto/Fcntl/Fcntl.so
f710e000-f7113000 r-xp 00000000 00:2a 126142424                          /usr/lib/perl5/5.10.0/i386-linux-thread-multi/auto/IO/IO.so
f7113000-f7114000 rw-p 00005000 00:2a 126142424                          /usr/lib/perl5/5.10.0/i386-linux-thread-multi/auto/IO/IO.so
f7114000-f711f000 r-xp 00000000 00:2a 126142419                          /usr/lib/perl5/5.10.0/i386-linux-thread-multi/auto/List/Util/Util.so
f711f000-f7120000 rw-p 0000a000 00:2a 126142419                          /usr/lib/perl5/5.10.0/i386-linux-thread-multi/auto/List/Util/Util.so
f7120000-f7320000 r--p 00000000 00:2a 126143014                          /usr/lib/locale/locale-archive
f7320000-f7321000 rw-p 00000000 00:00 0 
f7321000-f748f000 r-xp 00000000 00:2a 126138410                          /lib/libc-2.9.so
f748f000-f7491000 r--p 0016e000 00:2a 126138410                          /lib/libc-2.9.so
f7491000-f7492000 rw-p 00170000 00:2a 126138410                          /lib/libc-2.9.so
f7492000-f7495000 rw-p 00000000 00:00 0 
f7495000-f74ab000 r-xp 00000000 00:2a 126138386                          /lib/libpthread-2.9.so
f74ab000-f74ac000 r--p 00015000 00:2a 126138386                          /lib/libpthread-2.9.so
f74ac000-f74ad000 rw-p 00016000 00:2a 126138386                          /lib/libpthread-2.9.so
f74ad000-f74af000 rw-p 00000000 00:00 0 
f74af000-f74b1000 r-xp 00000000 00:2a 126138378                          /lib/libutil-2.9.so
f74b1000-f74b2000 r--p 00001000 00:2a 126138378                          /lib/libutil-2.9.so
f74b2000-f74b3000 rw-p 00002000 00:2a 126138378                          /lib/libutil-2.9.so
f74b3000-f74b4000 rw-p 00000000 00:00 0 
f74b4000-f74be000 r-xp 00000000 00:2a 126138406                          /lib/libcrypt-2.9.so
f74be000-f74bf000 r--p 00009000 00:2a 126138406                          /lib/libcrypt-2.9.so
f74bf000-f74c0000 rw-p 0000a000 00:2a 126138406                          /lib/libcrypt-2.9.so
f74c0000-f74e7000 rw-p 00000000 00:00 0 
f74e7000-f750e000 r-xp 00000000 00:2a 126138402                          /lib/libm-2.9.so
f750e000-f750f000 r--p 00026000 00:2a 126138402                          /lib/libm-2.9.so
f750f000-f7510000 rw-p 00027000 00:2a 126138402                          /lib/libm-2.9.so
f7510000-f7513000 r-xp 00000000 00:2a 126138404                          /lib/libdl-2.9.so
f7513000-f7514000 r--p 00002000 00:2a 126138404                          /lib/libdl-2.9.so
f7514000-f7515000 rw-p 00003000 00:2a 126138404                          /lib/libdl-2.9.so
f7515000-f752b000 r-xp 00000000 00:2a 126138400                          /lib/libnsl-2.9.so
f752b000-f752c000 r--p 00016000 00:2a 126138400                          /lib/libnsl-2.9.so
f752c000-f752d000 rw-p 00017000 00:2a 126138400                          /lib/libnsl-2.9.so
f752d000-f752f000 rw-p 00000000 00:00 0 
f752f000-f7542000 r-xp 00000000 00:2a 126138384                          /lib/libresolv-2.9.so
f7542000-f7543000 r--p 00012000 00:2a 126138384                          /lib/libresolv-2.9.so
f7543000-f7544000 rw-p 00013000 00:2a 126138384                          /lib/libresolv-2.9.so
f7544000-f7546000 rw-p 00000000 00:00 0 
f7549000-f77b2000 r-xp 00000000 00:2a 126142629                          /usr/lib/perl5/5.10.0/i386-linux-thread-multi/CORE/libperl.so
f77b2000-f77b7000 rw-p 00269000 00:2a 126142629                          /usr/lib/perl5/5.10.0/i386-linux-thread-multi/CORE/libperl.so
f77b7000-f77d7000 r-xp 00000000 00:2a 126103465                          /lib/ld-2.9.so
f77d7000-f77d8000 rw-p 00000000 00:00 0 
f77d8000-f77d9000 r--p 00020000 00:2a 126103465                          /lib/ld-2.9.so
f77d9000-f77da000 rw-p 00021000 00:2a 126103465                          /lib/ld-2.9.so
ff7cf000-ff9de000 rw-p 00000000 00:00 0                                  [stack]
t/uts46_to_ascii-trans.t .. 
Failed 3600/3770 subtests 
        &#40;less 2 skipped subtests: 168 okay&#41;
t/uts46_to_ascii.t ........ ok
t/uts46_to_unicode.t ...... ok
t/xtra_pp.t ............... ok
Test Summary Report
-------------------
t/uts46_to_ascii-trans.t &#40;Wstat: 134 Tests: 170 Failed: 0&#41;
  Non-zero wait status: 134
  Parse errors: Bad plan.  You planned 3770 tests but ran 170.
t/uts46_to_ascii.t      &#40;Wstat: 0 Tests: 3770 Failed: 0&#41;
  TODO passed:   765, 1124, 1197, 1215, 1581, 1631, 1733-1734
                1938-1941, 1984-1991, 2474-2475, 2501-2502
                2614, 2771-2772, 2946, 3226, 3334-3338
                3561, 3563-3564, 3716
t/uts46_to_unicode.t    &#40;Wstat: 0 Tests: 5026 Failed: 0&#41;
  TODO passed:   955-956, 1430, 1535-1536, 1564, 2069-2070
                2134-2135, 2264-2265, 2543-2546, 2600-2607
                3242-3243, 3282-3283, 3434, 3663-3664, 3891
                4264, 4416-4420, 4736, 4738-4739, 4953
Files=16, Tests=9181,  3 wallclock secs &#40; 0.63 usr  0.03 sys +  2.65 cusr  0.07 csys =  3.38 CPU&#41;
Result: FAIL
Failed 1/16 test programs. 0/9181 subtests failed.

I&#39;m not sure what&#39;s wrong with the current code that causes this, but looking at the previous version &#40;which did not result in crashes for me&#41;, it seems to me that the return value of SvGROW was being treated as an end pointer rather than a start pointer, which might possibly account for the reporter&#39;s heap overflow?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;04&nbsp;07:08:51&nbsp;2016</span>
    <span class="description">paul [...] city-fan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> paul [...] city-fan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Dec 04 07:06:36 2016, paul@city-fan.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sat Dec 03 06:47:36 2016, CFAERBER wrote:
<div class="message-stanza open">&gt; &gt; Thank you for reporting this. It&#39;s interesting that this bug has not
&gt; &gt; been noticed so far. I&#39;ll release a new version shortly.
</div>&gt; 
&gt; I&#39;m now seeing crashes on x86_32 builds on some perls:
&gt; 
&gt; $ ./Build test
&gt; t/00use.t ................. ok
&gt; t/10pod.t ................. ok
&gt; t/11pod_cover.t ........... ok
&gt; t/domain_to_ascii.t ....... ok
&gt; t/domain_to_unicode.t ..... ok
&gt; t/encode_bytes.t .......... ok
&gt; t/encode_utf8.t ........... ok
&gt; t/punycode_vec-pp.t ....... ok
&gt; t/punycode_vec-xs.t ....... ok
&gt; t/uts46_api_call.t ........ ok
&gt; t/uts46_encode_bytes.t .... ok
&gt; t/uts46_encode_utf8.t ..... ok
&gt; *** glibc detected *** /usr/bin/perl: free&#40;&#41;: invalid next size
&gt; &#40;normal&#41;: 0x08d2d420 ***
&gt; ======= Backtrace: =========
&gt; /lib/libc.so.6[0xf73903a4]
&gt; /lib/libc.so.6[0xf7393e46]
&gt; /lib/libc.so.6&#40;realloc+0x106&#41;[0xf7394c86]
&gt; /usr/lib/perl5/5.10.0/i386-linux-thread-
&gt; multi/CORE/libperl.so&#40;Perl_safesysrealloc+0x8a&#41;[0xf75fb7aa]
&gt; /usr/lib/perl5/5.10.0/i386-linux-thread-
&gt; multi/CORE/libperl.so&#40;Perl_sv_grow+0x7d&#41;[0xf76527fd]
&gt; /builddir/build/BUILD/Net-IDN-Encode-
&gt; 2.301/blib/arch/auto/Net/IDN/Punycode/Punycode.so[0xf709c34e]
&gt; /builddir/build/BUILD/Net-IDN-Encode-
&gt; 2.301/blib/arch/auto/Net/IDN/Punycode/Punycode.so[0xf709d075]
&gt; /usr/lib/perl5/5.10.0/i386-linux-thread-
&gt; multi/CORE/libperl.so&#40;Perl_pp_entersub+0xb29&#41;[0xf76267b9]
&gt; /usr/lib/perl5/5.10.0/i386-linux-thread-
&gt; multi/CORE/libperl.so&#40;Perl_runops_debug+0x153&#41;[0xf75e7f53]
&gt; /usr/lib/perl5/5.10.0/i386-linux-thread-
&gt; multi/CORE/libperl.so&#40;perl_run+0x274&#41;[0xf7620904]
&gt; /usr/bin/perl&#40;main+0x10e&#41;[0x8048a2e]
&gt; /lib/libc.so.6&#40;__libc_start_main+0xe5&#41;[0xf73376e5]
&gt; /usr/bin/perl[0x8048881]
&gt; ======= Memory map: ========
&gt; 08048000-08049000 r-xp 00000000 00:2a 126137650
&gt; /usr/bin/perl
&gt; 08049000-0804a000 rw-p 00000000 00:2a 126137650
&gt; /usr/bin/perl
&gt; 089cf000-09428000 rw-p 00000000 00:00 0
&gt; [heap]
&gt;  f6e00000-f6e21000 rw-p 00000000 00:00 0
&gt;  f6e21000-f6f00000 ---p 00000000 00:00 0
&gt; f6fcf000-f6fdc000 r-xp 00000000 00:2a 126138418
&gt; /lib/libgcc_s-4.3.2-20081105.so.1
&gt; f6fdc000-f6fdd000 rw-p 0000c000 00:2a 126138418
&gt; /lib/libgcc_s-4.3.2-20081105.so.1
&gt;  f6fdd000-f709b000 rw-p 00000000 00:00 0
&gt; f709b000-f70a0000 r-xp 00000000 00:2a 126136495
&gt; /builddir/build/BUILD/Net-IDN-Encode-
&gt; 2.301/blib/arch/auto/Net/IDN/Punycode/Punycode.so
&gt; f70a0000-f70a1000 rw-p 00004000 00:2a 126136495
&gt; /builddir/build/BUILD/Net-IDN-Encode-
&gt; 2.301/blib/arch/auto/Net/IDN/Punycode/Punycode.so
&gt; f70a1000-f70cb000 r-xp 00000000 00:2a 126142185
&gt; /usr/lib/perl5/5.10.0/i386-linux-thread-
&gt; multi/auto/Unicode/Normalize/Normalize.so
&gt; f70cb000-f70ec000 rw-p 00029000 00:2a 126142185
&gt; /usr/lib/perl5/5.10.0/i386-linux-thread-
&gt; multi/auto/Unicode/Normalize/Normalize.so
&gt; f70ec000-f7109000 r-xp 00000000 00:2a 126142221
&gt; /usr/lib/perl5/5.10.0/i386-linux-thread-
&gt; multi/auto/Storable/Storable.so
&gt; f7109000-f710a000 rw-p 0001d000 00:2a 126142221
&gt; /usr/lib/perl5/5.10.0/i386-linux-thread-
&gt; multi/auto/Storable/Storable.so
&gt; f710a000-f710d000 r-xp 00000000 00:2a 126142444
&gt; /usr/lib/perl5/5.10.0/i386-linux-thread-multi/auto/Fcntl/Fcntl.so
&gt; f710d000-f710e000 rw-p 00003000 00:2a 126142444
&gt; /usr/lib/perl5/5.10.0/i386-linux-thread-multi/auto/Fcntl/Fcntl.so
&gt; f710e000-f7113000 r-xp 00000000 00:2a 126142424
&gt; /usr/lib/perl5/5.10.0/i386-linux-thread-multi/auto/IO/IO.so
&gt; f7113000-f7114000 rw-p 00005000 00:2a 126142424
&gt; /usr/lib/perl5/5.10.0/i386-linux-thread-multi/auto/IO/IO.so
&gt; f7114000-f711f000 r-xp 00000000 00:2a 126142419
&gt; /usr/lib/perl5/5.10.0/i386-linux-thread-multi/auto/List/Util/Util.so
&gt; f711f000-f7120000 rw-p 0000a000 00:2a 126142419
&gt; /usr/lib/perl5/5.10.0/i386-linux-thread-multi/auto/List/Util/Util.so
&gt; f7120000-f7320000 r--p 00000000 00:2a 126143014
&gt; /usr/lib/locale/locale-archive
&gt;  f7320000-f7321000 rw-p 00000000 00:00 0
&gt; f7321000-f748f000 r-xp 00000000 00:2a 126138410
&gt; /lib/libc-2.9.so
&gt; f748f000-f7491000 r--p 0016e000 00:2a 126138410
&gt; /lib/libc-2.9.so
&gt; f7491000-f7492000 rw-p 00170000 00:2a 126138410
&gt; /lib/libc-2.9.so
&gt;  f7492000-f7495000 rw-p 00000000 00:00 0
&gt; f7495000-f74ab000 r-xp 00000000 00:2a 126138386
&gt; /lib/libpthread-2.9.so
&gt; f74ab000-f74ac000 r--p 00015000 00:2a 126138386
&gt; /lib/libpthread-2.9.so
&gt; f74ac000-f74ad000 rw-p 00016000 00:2a 126138386
&gt; /lib/libpthread-2.9.so
&gt;  f74ad000-f74af000 rw-p 00000000 00:00 0
&gt; f74af000-f74b1000 r-xp 00000000 00:2a 126138378
&gt; /lib/libutil-2.9.so
&gt; f74b1000-f74b2000 r--p 00001000 00:2a 126138378
&gt; /lib/libutil-2.9.so
&gt; f74b2000-f74b3000 rw-p 00002000 00:2a 126138378
&gt; /lib/libutil-2.9.so
&gt;  f74b3000-f74b4000 rw-p 00000000 00:00 0
&gt; f74b4000-f74be000 r-xp 00000000 00:2a 126138406
&gt; /lib/libcrypt-2.9.so
&gt; f74be000-f74bf000 r--p 00009000 00:2a 126138406
&gt; /lib/libcrypt-2.9.so
&gt; f74bf000-f74c0000 rw-p 0000a000 00:2a 126138406
&gt; /lib/libcrypt-2.9.so
&gt;  f74c0000-f74e7000 rw-p 00000000 00:00 0
&gt; f74e7000-f750e000 r-xp 00000000 00:2a 126138402
&gt; /lib/libm-2.9.so
&gt; f750e000-f750f000 r--p 00026000 00:2a 126138402
&gt; /lib/libm-2.9.so
&gt; f750f000-f7510000 rw-p 00027000 00:2a 126138402
&gt; /lib/libm-2.9.so
&gt; f7510000-f7513000 r-xp 00000000 00:2a 126138404
&gt; /lib/libdl-2.9.so
&gt; f7513000-f7514000 r--p 00002000 00:2a 126138404
&gt; /lib/libdl-2.9.so
&gt; f7514000-f7515000 rw-p 00003000 00:2a 126138404
&gt; /lib/libdl-2.9.so
&gt; f7515000-f752b000 r-xp 00000000 00:2a 126138400
&gt; /lib/libnsl-2.9.so
&gt; f752b000-f752c000 r--p 00016000 00:2a 126138400
&gt; /lib/libnsl-2.9.so
&gt; f752c000-f752d000 rw-p 00017000 00:2a 126138400
&gt; /lib/libnsl-2.9.so
&gt;  f752d000-f752f000 rw-p 00000000 00:00 0
&gt; f752f000-f7542000 r-xp 00000000 00:2a 126138384
&gt; /lib/libresolv-2.9.so
&gt; f7542000-f7543000 r--p 00012000 00:2a 126138384
&gt; /lib/libresolv-2.9.so
&gt; f7543000-f7544000 rw-p 00013000 00:2a 126138384
&gt; /lib/libresolv-2.9.so
&gt;  f7544000-f7546000 rw-p 00000000 00:00 0
&gt; f7549000-f77b2000 r-xp 00000000 00:2a 126142629
&gt; /usr/lib/perl5/5.10.0/i386-linux-thread-multi/CORE/libperl.so
&gt; f77b2000-f77b7000 rw-p 00269000 00:2a 126142629
&gt; /usr/lib/perl5/5.10.0/i386-linux-thread-multi/CORE/libperl.so
&gt; f77b7000-f77d7000 r-xp 00000000 00:2a 126103465
&gt; /lib/ld-2.9.so
&gt;  f77d7000-f77d8000 rw-p 00000000 00:00 0
&gt; f77d8000-f77d9000 r--p 00020000 00:2a 126103465
&gt; /lib/ld-2.9.so
&gt; f77d9000-f77da000 rw-p 00021000 00:2a 126103465
&gt; /lib/ld-2.9.so
&gt; ff7cf000-ff9de000 rw-p 00000000 00:00 0
&gt; [stack]
&gt;  t/uts46_to_ascii-trans.t ..
&gt;  Failed 3600/3770 subtests
&gt;         &#40;less 2 skipped subtests: 168 okay&#41;
&gt; t/uts46_to_ascii.t ........ ok
&gt; t/uts46_to_unicode.t ...... ok
&gt; t/xtra_pp.t ............... ok
&gt; Test Summary Report
&gt; -------------------
&gt; t/uts46_to_ascii-trans.t &#40;Wstat: 134 Tests: 170 Failed: 0&#41;
&gt;   Non-zero wait status: 134
&gt;   Parse errors: Bad plan.  You planned 3770 tests but ran 170.
&gt; t/uts46_to_ascii.t      &#40;Wstat: 0 Tests: 3770 Failed: 0&#41;
&gt;   TODO passed:   765, 1124, 1197, 1215, 1581, 1631, 1733-1734
&gt;                 1938-1941, 1984-1991, 2474-2475, 2501-2502
&gt;                 2614, 2771-2772, 2946, 3226, 3334-3338
&gt;                 3561, 3563-3564, 3716
&gt; t/uts46_to_unicode.t    &#40;Wstat: 0 Tests: 5026 Failed: 0&#41;
&gt;   TODO passed:   955-956, 1430, 1535-1536, 1564, 2069-2070
&gt;                 2134-2135, 2264-2265, 2543-2546, 2600-2607
&gt;                 3242-3243, 3282-3283, 3434, 3663-3664, 3891
&gt;                 4264, 4416-4420, 4736, 4738-4739, 4953
&gt; Files=16, Tests=9181,  3 wallclock secs &#40; 0.63 usr  0.03 sys +  2.65
&gt; cusr  0.07 csys =  3.38 CPU&#41;
&gt; Result: FAIL
&gt; Failed 1/16 test programs. 0/9181 subtests failed.
&gt; 
&gt; I&#39;m not sure what&#39;s wrong with the current code that causes this, but
&gt; looking at the previous version &#40;which did not result in crashes for
&gt; me&#41;, it seems to me that the return value of SvGROW was being treated
&gt; as an end pointer rather than a start pointer, which might possibly
&gt; account for the reporter&#39;s heap overflow?
</div>
Never mind that last comment, I see what you were doing now. I&#39;m still getting crashes with 2.301 though.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;04&nbsp;09:23:19&nbsp;2016</span>
    <span class="description">CFAERBER [...] cpan.org -  Broken in 2.301 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;04&nbsp;09:23:19&nbsp;2016</span>
    <span class="description">CFAERBER [...] cpan.org -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;04&nbsp;15:10:14&nbsp;2016</span>
    <span class="description">CFAERBER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Is it possible that these systems have sizeof&#40;char&#41; &gt; 1?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;04&nbsp;17:55:37&nbsp;2016</span>
    <span class="description">CFAERBER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Is it possible that these systems have sizeof&#40;char&#41; &gt; 1?
</div>Disregard this, it guaranteed to be 1 in C.

I&#39;m wondering whether it&#39;s easier to start from scratch than trying to find the bug.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;07&nbsp;09:52:49&nbsp;2016</span>
    <span class="description">paul [...] city-fan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> paul [...] city-fan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Dec 04 17:55:37 2016, CFAERBER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Is it possible that these systems have sizeof&#40;char&#41; &gt; 1?
</div>&gt; Disregard this, it guaranteed to be 1 in C.
&gt; 
&gt; I&#39;m wondering whether it&#39;s easier to start from scratch than trying to
&gt; find the bug.
</div>
Got it. grow_string was not updating the &#34;current&#34; pointer correctly. This change fixes it:

--- lib/Net/IDN/Punycode.xs                           
+++ lib/Net/IDN/Punycode.xs                           
@@ -53,14 +53,16 @@ static void                        
 grow_string&#40;SV *const sv, char **start, char **current, char **end, STRLEN add&#41;
 {                                                     
   STRLEN len;                                         
+  char *new_start;

   if&#40;*current + add &lt;= *end&#41;
     return;

   len = &#40;*current - *start + add + 15&#41; &#38; ~15;         
-  *start = SvGROW&#40;sv, len&#41;;                           
-  *current = *start + len;                            
-  *end = *start + SvLEN&#40;sv&#41;;                          
+  new_start = SvGROW&#40;sv, len&#41;;                        
+  *current = new_start + &#40;*current - *start&#41;;         
+  *start = new_start;                                 
+  *end = new_start + SvLEN&#40;sv&#41;;                       
 }

 MODULE = Net::IDN::Punycode PACKAGE = Net::IDN::Punycode
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;07&nbsp;10:12:25&nbsp;2016</span>
    <span class="description">alexander.bluhm [...] gmx.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> alexander.bluhm [...] gmx.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 07 09:52:49 2016, paul@city-fan.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sun Dec 04 17:55:37 2016, CFAERBER wrote:
&gt; Got it. grow_string was not updating the &#34;current&#34; pointer correctly.
</div>
Oh yes, how could I miss this?  All my tests pass with this fix.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;07&nbsp;10:44:32&nbsp;2016</span>
    <span class="description">alexander.bluhm [...] gmx.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> alexander.bluhm [...] gmx.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This patch would also work.  It is shorter and closer to my intension
what I wanted to do with the len variable.

--- lib/Net/IDN/Punycode.xs.orig        Sat Dec  3 13:00:06 2016
+++ lib/Net/IDN/Punycode.xs     Wed Dec  7 16:39:07 2016
@@ -57,8 +57,8 @@ grow_string&#40;SV *const sv, char **start, char **current
   if&#40;*current + add &lt;= *end&#41;
     return;
 
-  len = &#40;*current - *start + add + 15&#41; &#38; ~15;
-  *start = SvGROW&#40;sv, len&#41;;
+  len = &#40;*current - *start&#41;;
+  *start = SvGROW&#40;sv, &#40;len + add + 15&#41; &#38; ~15&#41;;
   *current = *start + len;
   *end = *start + SvLEN&#40;sv&#41;;
 }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;07&nbsp;12:57:43&nbsp;2016</span>
    <span class="description">CFAERBER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks! I did not see this bug, either, and was just about rewriting the entire memory management. I&#39;ve just uploaded version 2.302, which includes this fix.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;07&nbsp;12:57:49&nbsp;2016</span>
    <span class="description">CFAERBER [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;07&nbsp;13:34:43&nbsp;2016</span>
    <span class="description">alexander.bluhm [...] gmx.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> alexander.bluhm [...] gmx.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 07 12:57:43 2016, CFAERBER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve just uploaded version 2.302, which includes this fix.
</div>
Thanks.  All my tests pass with this version.  There is an unused
variable char* new_start left in the code, but that is not an issue.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;08&nbsp;05:48:02&nbsp;2016</span>
    <span class="description">paul [...] city-fan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> paul [...] city-fan.org</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 07 13:34:43 2016, bluhm wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Dec 07 12:57:43 2016, CFAERBER wrote:
<div class="message-stanza open">&gt; &gt; I&#39;ve just uploaded version 2.302, which includes this fix.
</div>&gt; 
&gt; Thanks.  All my tests pass with this version.  There is an unused
&gt; variable char* new_start left in the code, but that is not an issue.
</div>
There&#39;s a double-dereference introduced by the new macro for utf8_to_uvchr_buf on older perls. It&#39;s also casting in_p to U8* both in the macro definition and when calling the macro. Attached patch fixes these and also removes the unused new_start variable.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net-IDN-Encode-2.302-fix.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- lib/Net/IDN/Punycode.xs
+++ lib/Net/IDN/Punycode.xs
@@ -21,7 +21,7 @@
 #define TMIN_MAX&#40;t&#41;  &#40;&#40;&#40;t&#41; &lt; TMIN&#41; ? &#40;TMIN&#41; : &#40;&#40;t&#41; &gt; TMAX&#41; ? &#40;TMAX&#41; : &#40;t&#41;&#41;
 
 #ifndef utf8_to_uvchr_buf
-#define utf8_to_uvchr_buf&#40;in_p,in_e,u8&#41; utf8_to_uvchr&#40;&#40;U8*&#41;in_p, &#38;u8&#41;;
+#define utf8_to_uvchr_buf&#40;in_p,in_e,u8&#41; utf8_to_uvchr&#40;in_p,u8&#41;;
 #endif
 
 static char enc_digit[BASE] = {
@@ -57,7 +57,6 @@ static void
 grow_string&#40;SV *const sv, char **start, char **current, char **end, STRLEN add&#41;
 {
   STRLEN len;
-  char* new_start;
 
   if&#40;*current + add &lt;= *end&#41;
     return;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;11&nbsp;10:04:12&nbsp;2016</span>
    <span class="description">paul [...] city-fan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> paul [...] city-fan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Dec 08 05:48:02 2016, paul@city-fan.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Dec 07 13:34:43 2016, bluhm wrote:
<div class="message-stanza open">&gt; &gt; On Wed Dec 07 12:57:43 2016, CFAERBER wrote:
<div class="message-stanza open">&gt; &gt; &gt; I&#39;ve just uploaded version 2.302, which includes this fix.
</div>&gt; &gt;
&gt; &gt; Thanks.  All my tests pass with this version.  There is an unused
&gt; &gt; variable char* new_start left in the code, but that is not an issue.
</div>&gt; 
&gt; There&#39;s a double-dereference introduced by the new macro for
&gt; utf8_to_uvchr_buf on older perls. It&#39;s also casting in_p to U8* both
&gt; in the macro definition and when calling the macro. Attached patch
&gt; fixes these and also removes the unused new_start variable.
</div>

Looks good in 2.303 now, thanks.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;01&nbsp;07:18:04&nbsp;2017</span>
    <span class="description">CFAERBER [...] cpan.org -  Fixed in 2.399_20161227 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;01&nbsp;07:18:04&nbsp;2017</span>
    <span class="description">CFAERBER [...] cpan.org -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
