<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #117184 for PDF-API2: Unable to write an opened PDF containing cross-reference streams</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #117184 for PDF-API2: Unable to write an opened PDF containing cross-reference streams</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/PDF-API2/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/PDF-API2">PDF-API2 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">117184</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/PDF-API2/Active/">PDF-API2</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dietrich.streifert [...] googlemail.com

<br />
profires [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-24958-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-24959-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




File.diff.190403.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1841907/990032/File.diff.190403.txt">
Mon Apr 08 17:59:57 2019 (5.1k) by futuramedium [...] yandex.ru
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1840875/989584/File.diff.190403.txt">
Wed Apr 03 12:53:41 2019 (5.1k) by futuramedium [...] yandex.ru
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1840810/989557/File.diff.190403.txt">
Tue Apr 02 22:13:42 2019 (4.8k) by futuramedium [...] yandex.ru
</a>
</font></li>
</ul>


hybrid.pdf<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1848271/993195/hybrid.pdf">
Sat May 11 17:56:56 2019 (79k) by david-dot-warring [...] gmail.org
</a>
</font></li>
</ul>


sample.pdf<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1608820/860730/sample.pdf">
Thu Mar 17 12:33:25 2016 (5.2k) by profires [...] gmail.com
</a>
</font></li>
</ul>


sampleMod.pdf<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1608820/860731/sampleMod.pdf">
Thu Mar 17 12:33:25 2016 (9.3k) by profires [...] gmail.com
</a>
</font></li>
</ul>


test.pdf<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1661409/891777/test.pdf">
Wed Aug 24 05:06:45 2016 (26.5k) by dietrich.streifert [...] googlemail.com
</a>
</font></li>
</ul>


test.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1661409/891778/test.pl">
Wed Aug 24 05:06:45 2016 (146b) by dietrich.streifert [...] googlemail.com
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1608820/860732/test.pl">
Thu Mar 17 12:33:25 2016 (452b) by profires [...] gmail.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;11&nbsp;11:03:10&nbsp;2016</span>
    <span class="description">profires [...] gmail.com - Ticket #112932:  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Can&#39;t call method &#34;outobjdeep&#34; in 2.026</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I&#39;m using the library on a simple script to update the info structure of pdf files.
References:
Perl version: strawberry version 5.18.2
OS: Windows 7 Enterprise

PDF input files are produced by a java program with PDF version 1.4 &#40;and I never had problem with these&#41;.

The issue happens sometimes, when users add annotation with Acrobat Reader and this implies that the PDF version becomes 1.7 &#40;according to the Acrobat Reader that they use&#41;

After this modification we get the known old bug #48683, as we are using PDF-API2-2.021

I&#39;ve just tried the new released PDF-API2-2.026 to check actual evolution and I obtain a new error message:
&lt;&lt;
Can&#39;t call method &#34;outobjdeep&#34; on an undefined value at D:/tm_programs/perl_portable_pdf/perl/site/lib/PDF/API2/Basic/PDF/Objind.pm line 170.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&gt;
</div>
Below an extract from my sample script:
&lt;&lt;
my $pdf = PDF::API2-&gt;open&#40;$source&#41; or die &#34;Can&#39;t open PDF file $source: $!&#34;;
my $nowDate     = strftime&#40; &#34;%Y%m%d%H%M%S&#34;, localtime&#40;&#41;&#41;;

my  %h = $pdf-&gt;info&#40;
        &#39;CreationDate&#39; =&gt; $nowDate,
    &#41;;
$pdf-&gt;saveas&#40;$source&#41;;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&gt;
</div>
As this is my first time reporting a bug, please apologize for any mistake.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;15&nbsp;15:07:43&nbsp;2016</span>
    <span class="description">steve [...] deefs.net - Ticket #112932:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Are you able to attach a PDF that demonstrates this problem?  If you&#39;d rather it not be publicly visible, you can instead send one to me privately.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;15&nbsp;15:07:43&nbsp;2016</span>
    <span class="description">The RT System itself - Ticket #112932:  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;17&nbsp;12:33:25&nbsp;2016</span>
    <span class="description">profires [...] gmail.com - Ticket #112932:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #112932] Can&#39;t call method &#34;outobjdeep&#34; in 2.026</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 17 Mar 2016 16:33:03 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Francesco Fiorentino &lt;profires [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">In attachment a sample.pdf where the attached perl script &#40;test.pl&#41; works
correctly and a modified one &#40;sampleMod.pdf&#41; where I have the listed error
message.
The sampleMod is obtained adding an highlight with Adobe Reader XI and
saving it.


On Tue, 15 Mar 2016 at 20:08 Steve Simms via RT &lt;bug-PDF-API2@rt.cpan.org&gt;
wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=112932">https://rt.cpan.org/Ticket/Display.html?id=112932</a></span> &gt;
&gt;
&gt; Are you able to attach a PDF that demonstrates this problem?  If you&#39;d
&gt; rather it not be publicly visible, you can instead send one to me privately.
&gt;
</div></div></div>

<div class="messagebody">
</div>
</div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1608820/860730/sample.pdf">Download sample.pdf</a><br />
<span class="downloadcontenttype">application/pdf 5.2k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1608820/860731/sampleMod.pdf">Download sampleMod.pdf</a><br />
<span class="downloadcontenttype">application/pdf 9.3k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;26&nbsp;04:07:46&nbsp;2016</span>
    <span class="description">profires [...] gmail.com - Ticket #112932:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #112932] Can&#39;t call method &#34;outobjdeep&#34; in 2.026</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 26 Apr 2016 08:07:25 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Francesco Fiorentino &lt;profires [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

with the 2.027 released, I see that the error message is no more present,
but, using the same input attached previously, it produces an unreadable
file.

Thanks,
Francesco

On Thu, 17 Mar 2016 at 17:33 Francesco Fiorentino &lt;profires@gmail.com&gt;
wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In attachment a sample.pdf where the attached perl script &#40;test.pl&#41; works
&gt; correctly and a modified one &#40;sampleMod.pdf&#41; where I have the listed error
&gt; message.
&gt; The sampleMod is obtained adding an highlight with Adobe Reader XI and
&gt; saving it.
&gt;
&gt;
&gt; On Tue, 15 Mar 2016 at 20:08 Steve Simms via RT &lt;bug-PDF-API2@rt.cpan.org&gt;
&gt; wrote:
&gt;
<div class="message-stanza open">&gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=112932">https://rt.cpan.org/Ticket/Display.html?id=112932</a></span> &gt;
&gt;&gt;
&gt;&gt; Are you able to attach a PDF that demonstrates this problem?  If you&#39;d
&gt;&gt; rather it not be publicly visible, you can instead send one to me privately.
&gt;&gt;
</div>&gt;
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;01&nbsp;10:12:24&nbsp;2016</span>
    <span class="description">profires [...] gmail.com - Ticket #112932:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #112932] Can&#39;t call method &#34;outobjdeep&#34; in 2.026</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 01 Jun 2016 14:12:03 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Francesco Fiorentino &lt;profires [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Any feedback about that?

On Tue, 26 Apr 2016 at 10:07 Francesco Fiorentino &lt;profires@gmail.com&gt;
wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt;
&gt; with the 2.027 released, I see that the error message is no more present,
&gt; but, using the same input attached previously, it produces an unreadable
&gt; file.
&gt;
&gt; Thanks,
&gt; Francesco
&gt;
&gt;
&gt; On Thu, 17 Mar 2016 at 17:33 Francesco Fiorentino &lt;profires@gmail.com&gt;
&gt; wrote:
&gt;
<div class="message-stanza open">&gt;&gt; In attachment a sample.pdf where the attached perl script &#40;test.pl&#41;
&gt;&gt; works correctly and a modified one &#40;sampleMod.pdf&#41; where I have the listed
&gt;&gt; error message.
&gt;&gt; The sampleMod is obtained adding an highlight with Adobe Reader XI and
&gt;&gt; saving it.
&gt;&gt;
&gt;&gt;
&gt;&gt; On Tue, 15 Mar 2016 at 20:08 Steve Simms via RT &lt;bug-PDF-API2@rt.cpan.org&gt;
&gt;&gt; wrote:
&gt;&gt;
<div class="message-stanza open">&gt;&gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=112932">https://rt.cpan.org/Ticket/Display.html?id=112932</a></span> &gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Are you able to attach a PDF that demonstrates this problem?  If you&#39;d
&gt;&gt;&gt; rather it not be publicly visible, you can instead send one to me privately.
&gt;&gt;&gt;
</div>&gt;&gt;
</div></div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;02&nbsp;09:55:22&nbsp;2016</span>
    <span class="description">steve [...] deefs.net - Ticket #112932:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jun 01 10:12:24 2016, profires@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Any feedback about that?
</div>
I suspect that it&#39;s the same issue as ticket #113293.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;07&nbsp;15:00:48&nbsp;2016</span>
    <span class="description">MELMOTHX [...] cpan.org - Ticket #112932:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jun 02 09:55:22 2016, SSIMMS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Jun 01 10:12:24 2016, profires@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; Any feedback about that?
</div>&gt; 
&gt; I suspect that it&#39;s the same issue as ticket #113293.
</div>
Actually, the issue seems unrelated. End of the modified PDF:


startxref
116
%%EOF
8 0 obj &lt;&lt; /CreationDate &#40;20160607205416&#41; /Creator &#40;Apache FOP Version 1.1&#41; /ModDate &#40;D:20160317171139+01&#39;00&#39;&#41; /PDFVersion &#40;1.4&#41; /Producer &#40;Apache FOP Version 1.1&#41; &gt;&gt; endobj
xref
0 1
0000000000 65535 f 
8 1
0000009549 00000 n 
trailer
&lt;&lt; /Type /XRef /DecodeParms &lt;&lt; /Columns 4 /Predictor 12 &gt;&gt; /Filter /FlateDecode /ID [ &lt;951086a159fa774291c81f007ad52c0e&gt; &lt;d0fd218e4aa35740b313e56bfd43b2db&gt; ] /Index [ 9 18 ] /Info 8 0 R /Length 60 /Prev 116 /Root 10 0 R /Size 1 /W [ 1 2 1 ] &gt;&gt;
startxref
9723
%%EOF


It looks like the code just appends this code and keeps the original PDF verbatim, at first glance, hence the breakage.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;24&nbsp;05:06:45&nbsp;2016</span>
    <span class="description">dietrich.streifert [...] googlemail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Simply opening and saving a multipage PDF file corrupts the file</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 24 Aug 2016 11:06:30 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dietrich Streifert &lt;dietrich.streifert [...] googlemail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is for perl 5.16 on centos 7.2 using a simple test file &#40;filename 
&#34;test.pdf&#34; &#41; with four pages:

The following code

my $pdf   = PDF::API2-&gt;open&#40;&#34;test.pdf&#34;&#41;;
$pdf-&gt;saveas&#40;&#34;test-mod.pdf&#34;&#41;;
$pdf-&gt;end;

generates a corrupt file &#34;test-mod.pdf&#34; which is not readable any more 
by e.g. Acrobat Reader, which reports that the document can not be 
opened &#40;code 14&#41;.

This behaviour makes PDF::API2 unusable for even the simplest modifications.

I&#39;ve attached both the perl code and the test file &#40;don&#39;t know if this 
gets through the email bug submission at rt.cpan.org&#41;
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1661409/891777/test.pdf">Download test.pdf</a><br />
<span class="downloadcontenttype">application/pdf 26.5k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;24&nbsp;10:13:02&nbsp;2016</span>
    <span class="description">philperry [...] hvc.rr.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #117184]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 24 Aug 2016 10:12:45 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Phil M Perry &lt;philperry [...] hvc.rr.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I see that the original test.pdf is PDF version 1.5. Maybe there&#39;s 
something in there that got corrupted when reading into PDF::API2. Is it 
possible to create your test.pdf in version 1.4 or even 1.3? Admittedly 
that&#39;s not a great solution -- PDF::API2 needs to be brought into the 
21st century and handle up to version 1.7 correctly -- but it may do for 
the time being.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;24&nbsp;10:13:02&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;24&nbsp;10:27:59&nbsp;2016</span>
    <span class="description">dietrich.streifert [...] googlemail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #117184]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 24 Aug 2016 16:27:45 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dietrich Streifert &lt;dietrich.streifert [...] googlemail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">You&#39;re right! It works if I convert test.pdf to PDF-Version 1.4.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;06&nbsp;23:34:09&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Subject changed from &#39;Simply opening and saving a multipage PDF file corrupts the file&#39; to &#39;Unable to write an opened PDF containing cross-reference streams&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;06&nbsp;23:34:09&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Severity Wishlist added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;06&nbsp;23:42:42&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">PDF::API2 got support for reading files with cross-reference streams in version 2.026, but it doesn&#39;t yet support writing those files.

The easiest way to implement this would be to convert the object stream to regular objects and save the file normally.  That would eliminate the need to teach PDF::API2 how to write a cross-reference stream, though that&#39;s the other option.  Doing so will typically produce a file that&#39;s a little smaller, but it isn&#39;t necessary.

As a workaround until someone adds that support, you can use importPageIntoForm to copy each page into a new PDF file, or use other copy methods to get the data from the original file to a new one.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;07&nbsp;00:21:57&nbsp;2016</span>
    <span class="description">steve [...] deefs.net - Ticket #112932:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jun 02 09:55:22 2016, SSIMMS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Jun 01 10:12:24 2016, profires@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; Any feedback about that?
</div>&gt; 
&gt; I suspect that it&#39;s the same issue as ticket #113293.
</div>
Ok, not #113293, but it does appear to be the same as #117184.  sampleMod.pdf contains a cross-reference stream.  PDF::API2 can read them as of version 2.026, but it doesn&#39;t know how to write a cross-reference stream yet, nor how to convert from a cross-reference stream to a cross-reference table &#40;which would likely be the easier of the two to implement&#41;.

A potential solution and a workaround are given in ticket #117184.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;07&nbsp;00:22:50&nbsp;2016</span>
    <span class="description">steve [...] deefs.net - Ticket #112932:  Merged into ticket #117184</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;07&nbsp;00:22:50&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Merged into ticket #117184</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;02&nbsp;23:45:57&nbsp;2017</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Possible solution in ticket 121832.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;01&nbsp;11:44:37&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ticket 121832 is marked as fixed &#40;resolved&#41;, but I don&#39;t think Vadim&#39;s code was put in, and I don&#39;t think the current PDF::API2 &#40;nor PDF::Builder&#41; can deal with writing back out a PDF 1.5 cross-reference stream. I don&#39;t know for sure what was &#34;fixed&#34; in that ticket. Perhaps it would be a good time to take another look at either writing out a cross-reference stream or converting it to a classic xref table. 

In PDF::Builder, the cross-reference stream output would automatically bump the PDF version to 1.5 &#40;simply reading in such a PDF in the first place will also do so&#41;. I have no problems with doing that -- on the other hand, is there a strong argument for converting to an xref table, to stay at PDF 1.4? Cross-reference streams, once read in, seem to be causing more and more trouble, so it would be good to deal with them once and for all.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;02&nbsp;22:13:42&nbsp;2019</span>
    <span class="description">futuramedium [...] yandex.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Phil,

I have better alternative than patch &#40;hack&#41; from #121832. To please Acrobat/Reader, incremental update can append either classical Xref Table or compressed Xref Stream. The new patch seems to be working. The test PDF file is from this thread. 

1&#41; Producing &#34;hybrid files&#34; to ensure &#34;compatibility with older applications&#34; is not implemented &#40;was not even contemplated -- I don&#39;t think it&#39;s important anymore&#41;. 

2&#41; No support &#40;with this patch, but would not be difficult in general&#41; for files &gt; ~4 Gb. 

3&#41; Somewhat lousy compression &#40;because of no prediction&#41; if someone updates unusually large number of objects -- i.e. generally unlikely&#41;.

4&#41; Of course, updated objects are not stuffed into streams, and furthermore this patch does nothing to &#34;use modern compression&#34; when file is clean-output &#40;IIRC, PDF::API2 can&#39;t do it anyway&#41;.

5&#41; Important -- this patch also applies changes &#40;2 topmost changes&#41; as per #121911.

In fact, fixes are very minimal, existing code is mostly re-used to collect updates made to XRef Table &#40;instead of writing them as they come&#41; and then apply them appropriately in either of 2 modes.

+ One &#40;minor&#41; digression: documentation could be more clear that after calling &#34;saveas&#34; an instance becomes unusable -- to prevent someone writing scripts e.g. such as with commented fragment below.


use warnings;
use strict;
use feature &#39;say&#39;;

use PDF::API2;

my $pdf = PDF::API2-&gt; open&#40; &#34;test.pdf&#34; &#41;;
$pdf-&gt; page;
$pdf-&gt; page;
$pdf-&gt; page;

$pdf-&gt; saveas&#40; &#34;test-mod.pdf&#34; &#41;;

# $pdf-&gt; page;
# $pdf-&gt; page;
# $pdf-&gt; saveas&#40; &#34;test-mod++.pdf&#34; &#41;;

__END__
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> File.diff.190403.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- PDF\API2\Basic\PDF\File.old	Fri Jul  7 04:53:59 2017
+++ PDF\API2\Basic\PDF\File.pm	Wed Apr  3 04:01:26 2019
@@ -522,6 +522,7 @@
 
         if &#40;defined $result-&gt;{&#39;Type&#39;} and defined $types{$result-&gt;{&#39;Type&#39;}-&gt;val}&#41; {
             bless $result, $types{$result-&gt;{&#39;Type&#39;}-&gt;val};
+            $result-&gt; {&#39; outto&#39;} = [ $self ];
         }
         # gdj: FIXME: if any of the ws chars were crs, then the whole
         # string might not have been read.
@@ -540,7 +541,7 @@
         }
         $result-&gt;{&#39; parent&#39;} = $self;
         weaken $result-&gt;{&#39; parent&#39;};
-        $result-&gt;{&#39; realised&#39;} = 0;
+#??        $result-&gt;{&#39; realised&#39;} = 0;
         # gdj: FIXME: if any of the ws chars were crs, then the whole
         # string might not have been read.
     }
@@ -1282,7 +1283,7 @@
     $tdict-&gt;{&#39;Size&#39;} = PDFNum&#40;$self-&gt;{&#39; maxobj&#39;}&#41;;
 
     my $tloc = $fh-&gt;tell&#40;&#41;;
-    $fh-&gt;print&#40;&#34;xref\n&#34;&#41;;
+    my @out;
 
     my @xreflist = sort { $self-&gt;{&#39; objects&#39;}{$a-&gt;uid}[0] &lt;=&gt; $self-&gt;{&#39; objects&#39;}{$b-&gt;uid}[0] } &#40;@{$self-&gt;{&#39; printed&#39;} || []}, @{$self-&gt;{&#39; free&#39;} || []}&#41;;
 
@@ -1314,25 +1315,25 @@
 #            $fh-&gt;printf&#40;&#34;0 1\n%010d 65535 f \n&#34;, $ff&#41;;
 #        }
         if &#40;$i &gt; $#xreflist || $self-&gt;{&#39; objects&#39;}{$xreflist[$i]-&gt;uid}[0] != $j + 1&#41; {
-            $fh-&gt;print&#40;&#40;$first == -1 ? &#34;0 &#34; : &#34;$self-&gt;{&#39; objects&#39;}{$xreflist[$first]-&gt;uid}[0] &#34;&#41; . &#40;$i - $first&#41; . &#34;\n&#34;&#41;;
+            push @out, &#40;$first == -1 ? &#34;0 &#34; : &#34;$self-&gt;{&#39; objects&#39;}{$xreflist[$first]-&gt;uid}[0] &#34;&#41; . &#40;$i - $first&#41; . &#34;\n&#34;;
             if &#40;$first == -1&#41; {
-                $fh-&gt;printf&#40;&#34;%010d 65535 f \n&#34;, defined $freelist[$k] ? $self-&gt;{&#39; objects&#39;}{$freelist[$k]-&gt;uid}[0] : 0&#41;;
+                push @out, sprintf&#40;&#34;%010d 65535 f \n&#34;, defined $freelist[$k] ? $self-&gt;{&#39; objects&#39;}{$freelist[$k]-&gt;uid}[0] : 0&#41;;
                 $first = 0;
             }
             for &#40;$j = $first; $j &lt; $i; $j++&#41; {
                 my $xref = $xreflist[$j];
                 if &#40;defined $freelist[$k] &#38;&#38; defined $xref &#38;&#38; &#34;$freelist[$k]&#34; eq &#34;$xref&#34;&#41; {
                     $k++;
-                    $fh-&gt;print&#40;pack&#40;&#34;A10AA5A4&#34;,
+                    push @out, pack&#40;&#34;A10AA5A4&#34;,
                                     sprintf&#40;&#34;%010d&#34;, &#40;defined $freelist[$k] ?
                                                       $self-&gt;{&#39; objects&#39;}{$freelist[$k]-&gt;uid}[0] : 0&#41;&#41;, &#34; &#34;,
                                     sprintf&#40;&#34;%05d&#34;, $self-&gt;{&#39; objects&#39;}{$xref-&gt;uid}[1] + 1&#41;,
-                                    &#34; f \n&#34;&#41;&#41;;
+                                    &#34; f \n&#34;&#41;;
                 }
                 else {
-                    $fh-&gt;print&#40;pack&#40;&#34;A10AA5A4&#34;, sprintf&#40;&#34;%010d&#34;, $self-&gt;{&#39; locs&#39;}{$xref-&gt;uid}&#41;, &#34; &#34;,
+                    push @out, pack&#40;&#34;A10AA5A4&#34;, sprintf&#40;&#34;%010d&#34;, $self-&gt;{&#39; locs&#39;}{$xref-&gt;uid}&#41;, &#34; &#34;,
                             sprintf&#40;&#34;%05d&#34;, $self-&gt;{&#39; objects&#39;}{$xref-&gt;uid}[1]&#41;,
-                            &#34; n \n&#34;&#41;&#41;;
+                            &#34; n \n&#34;&#41;;
                 }
             }
             $first = $i;
@@ -1342,9 +1343,48 @@
             $j++;
         }
     }
-    $fh-&gt;print&#40;&#34;trailer\n&#34;&#41;;
-    $tdict-&gt;outobjdeep&#40;$fh, $self&#41;;
-    $fh-&gt;print&#40;&#34;\nstartxref\n$tloc\n%%EOF\n&#34;&#41;;
+    if &#40; exists $tdict-&gt; { Type } and $tdict-&gt; { Type }-&gt; val eq &#39;XRef&#39; &#41; {
+
+        my &#40; @index, @stream &#41;;
+        my $len = 2;                                # 2 or 4 will do
+        for &#40; @out &#41; {
+            $_ = [ split ];
+            die      if $_-&gt; [ 0 ] &gt;= 0xFFFFFFFF;   # extremely unlikely, but better &#40;any?&#41; message would help
+            $len = 4 if $_-&gt; [ 0 ] &gt;= 0xFFFF;
+            @$_ == 2 ? push @index, @$_ : push @stream, $_
+        } 
+        my $c = $len == 2 ? &#39;n&#39; : &#39;N&#39;;
+        my $stream = join &#39;&#39;, map {
+            pack &#34;C${c}C&#34;, $_-&gt; [ 2 ] eq &#39;n&#39; ? 1 : 0, @{ $_ }[ 0 .. 1 ]
+        } @stream;
+        
+        $i = $self-&gt;{ &#39; maxobj&#39; } ++;
+        $self-&gt; add_obj&#40; $tdict, $i, 0 &#41;;
+        $self-&gt; out_obj&#40; $tdict &#41;;
+
+        push @index, $i, 1;
+        $stream .= pack &#34;C${c}C&#34;,  1, $tloc, 0;
+
+        $tdict-&gt; { Size }   = PDFNum&#40; ++ $i &#41;;
+        $tdict-&gt; { Index }  = PDFArray&#40; map PDFNum&#40; $_ &#41;, @index &#41;;
+        $tdict-&gt; { W }      = PDFArray&#40; map PDFNum&#40; $_ &#41;, 1, $len, 1 &#41;;
+        $tdict-&gt; { Filter } = PDFName&#40; &#39;FlateDecode&#39; &#41;;
+        
+        delete $tdict-&gt; { DecodeParms };    # For such streams, prediction improves compression hugely,
+                                            # but &#34;outfilt&#34; just can&#39;t do it, alas.
+        
+        $stream = PDF::API2::Basic::PDF::Filter::FlateDecode-&gt; new-&gt; outfilt&#40; $stream, 1 &#41;;
+        $tdict-&gt; { &#39; stream&#39; } = $stream;
+        $tdict-&gt; { &#39; nofilt&#39; } = 1;
+        delete $tdict-&gt; { Length };
+        $self-&gt; ship_out;
+    }
+    else {
+        $fh-&gt;print&#40;&#34;xref\n&#34;, @out, &#34;trailer\n&#34;&#41;;
+        $tdict-&gt;outobjdeep&#40;$fh, $self&#41;;
+        $fh-&gt;print&#40;&#34;\n&#34;&#41;;
+    }
+    $fh-&gt;print&#40;&#34;startxref\n$tloc\n%%EOF\n&#34;&#41;;
 }
 
 

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;03&nbsp;12:53:41&nbsp;2019</span>
    <span class="description">futuramedium [...] yandex.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Should have chosen offset length &#40;2 or 4 bytes&#41; based on $tloc only. Fixed. Also, added filtering to XRef stream. Raw &#40;uncompressed&#41; stream length will grow up to 25% &#40;as with file being tested&#41; because of prepended byte per &#34;row&#34;, but for any substantial changes to PDF file, compression ratio will improve significantly. E.g., if, in example script, 6 instead of 3 pages are appended, compressed stream length already becomes 42 vs. 44 bytes for filtered/unfiltered data. 

One concern may be that gennum is limited to 1 byte, but, in reality, they haven&#39;t been used &#40;and objnums re-used&#41; for a long time. In test file, and all &#34;modern&#34; &#40;with XRef stream&#41; files I&#39;ve seen, 1st XRef Table entry is &#34;0 0 f&#34;. IIRC PDF 2.0 says gennum is always 0.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> File.diff.190403.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- PDF\API2\Basic\PDF\File.old	Fri Jul  7 04:53:59 2017
+++ PDF\API2\Basic\PDF\File.pm	Wed Apr  3 19:27:37 2019
@@ -522,6 +522,7 @@
 
         if &#40;defined $result-&gt;{&#39;Type&#39;} and defined $types{$result-&gt;{&#39;Type&#39;}-&gt;val}&#41; {
             bless $result, $types{$result-&gt;{&#39;Type&#39;}-&gt;val};
+            $result-&gt; {&#39; outto&#39;} = [ $self ];
         }
         # gdj: FIXME: if any of the ws chars were crs, then the whole
         # string might not have been read.
@@ -540,7 +541,7 @@
         }
         $result-&gt;{&#39; parent&#39;} = $self;
         weaken $result-&gt;{&#39; parent&#39;};
-        $result-&gt;{&#39; realised&#39;} = 0;
+#??        $result-&gt;{&#39; realised&#39;} = 0;
         # gdj: FIXME: if any of the ws chars were crs, then the whole
         # string might not have been read.
     }
@@ -1282,7 +1283,7 @@
     $tdict-&gt;{&#39;Size&#39;} = PDFNum&#40;$self-&gt;{&#39; maxobj&#39;}&#41;;
 
     my $tloc = $fh-&gt;tell&#40;&#41;;
-    $fh-&gt;print&#40;&#34;xref\n&#34;&#41;;
+    my @out;
 
     my @xreflist = sort { $self-&gt;{&#39; objects&#39;}{$a-&gt;uid}[0] &lt;=&gt; $self-&gt;{&#39; objects&#39;}{$b-&gt;uid}[0] } &#40;@{$self-&gt;{&#39; printed&#39;} || []}, @{$self-&gt;{&#39; free&#39;} || []}&#41;;
 
@@ -1314,25 +1315,25 @@
 #            $fh-&gt;printf&#40;&#34;0 1\n%010d 65535 f \n&#34;, $ff&#41;;
 #        }
         if &#40;$i &gt; $#xreflist || $self-&gt;{&#39; objects&#39;}{$xreflist[$i]-&gt;uid}[0] != $j + 1&#41; {
-            $fh-&gt;print&#40;&#40;$first == -1 ? &#34;0 &#34; : &#34;$self-&gt;{&#39; objects&#39;}{$xreflist[$first]-&gt;uid}[0] &#34;&#41; . &#40;$i - $first&#41; . &#34;\n&#34;&#41;;
+            push @out, &#40;$first == -1 ? &#34;0 &#34; : &#34;$self-&gt;{&#39; objects&#39;}{$xreflist[$first]-&gt;uid}[0] &#34;&#41; . &#40;$i - $first&#41; . &#34;\n&#34;;
             if &#40;$first == -1&#41; {
-                $fh-&gt;printf&#40;&#34;%010d 65535 f \n&#34;, defined $freelist[$k] ? $self-&gt;{&#39; objects&#39;}{$freelist[$k]-&gt;uid}[0] : 0&#41;;
+                push @out, sprintf&#40;&#34;%010d 65535 f \n&#34;, defined $freelist[$k] ? $self-&gt;{&#39; objects&#39;}{$freelist[$k]-&gt;uid}[0] : 0&#41;;
                 $first = 0;
             }
             for &#40;$j = $first; $j &lt; $i; $j++&#41; {
                 my $xref = $xreflist[$j];
                 if &#40;defined $freelist[$k] &#38;&#38; defined $xref &#38;&#38; &#34;$freelist[$k]&#34; eq &#34;$xref&#34;&#41; {
                     $k++;
-                    $fh-&gt;print&#40;pack&#40;&#34;A10AA5A4&#34;,
+                    push @out, pack&#40;&#34;A10AA5A4&#34;,
                                     sprintf&#40;&#34;%010d&#34;, &#40;defined $freelist[$k] ?
                                                       $self-&gt;{&#39; objects&#39;}{$freelist[$k]-&gt;uid}[0] : 0&#41;&#41;, &#34; &#34;,
                                     sprintf&#40;&#34;%05d&#34;, $self-&gt;{&#39; objects&#39;}{$xref-&gt;uid}[1] + 1&#41;,
-                                    &#34; f \n&#34;&#41;&#41;;
+                                    &#34; f \n&#34;&#41;;
                 }
                 else {
-                    $fh-&gt;print&#40;pack&#40;&#34;A10AA5A4&#34;, sprintf&#40;&#34;%010d&#34;, $self-&gt;{&#39; locs&#39;}{$xref-&gt;uid}&#41;, &#34; &#34;,
+                    push @out, pack&#40;&#34;A10AA5A4&#34;, sprintf&#40;&#34;%010d&#34;, $self-&gt;{&#39; locs&#39;}{$xref-&gt;uid}&#41;, &#34; &#34;,
                             sprintf&#40;&#34;%05d&#34;, $self-&gt;{&#39; objects&#39;}{$xref-&gt;uid}[1]&#41;,
-                            &#34; n \n&#34;&#41;&#41;;
+                            &#34; n \n&#34;&#41;;
                 }
             }
             $first = $i;
@@ -1342,9 +1343,53 @@
             $j++;
         }
     }
-    $fh-&gt;print&#40;&#34;trailer\n&#34;&#41;;
-    $tdict-&gt;outobjdeep&#40;$fh, $self&#41;;
-    $fh-&gt;print&#40;&#34;\nstartxref\n$tloc\n%%EOF\n&#34;&#41;;
+    if &#40; exists $tdict-&gt; { Type } and $tdict-&gt; { Type }-&gt; val eq &#39;XRef&#39; &#41; {
+        
+        my &#40; @index, @stream &#41;;
+        for &#40; @out &#41; {
+            my @a = split;
+            @a == 2 ? push @index, @a : push @stream, \@a
+        } 
+        $i = $self-&gt;{ &#39; maxobj&#39; } ++;
+        $self-&gt; add_obj&#40; $tdict, $i, 0 &#41;;
+        $self-&gt; out_obj&#40; $tdict &#41;;
+
+        push @index, $i, 1;
+        push @stream, [ $i, 0, &#39;n&#39; ];
+
+        my $len = $tloc &gt; 0xFFFF ? 4 : 2;           # don&#39;t expect files &gt; 4 Gb
+        my $tpl = $tloc &gt; 0xFFFF ? &#39;CNC&#39; : &#39;CnC&#39;;   # don&#39;t expect gennum &gt; 255, it&#39;s absurd.
+                                                    # Adobe doesn&#39;t use them anymore anyway
+        my $stream = &#39;&#39;; 
+        my @prev   = &#40; 0 &#41; x &#40; $len + 2 &#41;;
+        for &#40; @stream &#41; {
+            my @line = unpack &#39;C*&#39;, pack $tpl, $_-&gt; [ 2 ] eq &#39;n&#39; ? 1 : 0, @{ $_ }[ 0 .. 1 ];
+
+            $stream .= pack &#39;C*&#39;, 2,                # prepend filtering method, &#34;PNG Up&#34;
+                map {&#40; $line[ $_ ] - $prev[ $_ ] + 256 &#41; % 256 } 0 .. $#line;
+            @prev    = @line;
+        }
+        $tdict-&gt; { Size }   = PDFNum&#40; $i + 1 &#41;;
+        $tdict-&gt; { Index }  = PDFArray&#40; map PDFNum&#40; $_ &#41;, @index &#41;;
+        $tdict-&gt; { W }      = PDFArray&#40; map PDFNum&#40; $_ &#41;, 1, $len, 1 &#41;;
+        $tdict-&gt; { Filter } = PDFName&#40; &#39;FlateDecode&#39; &#41;;
+        
+        $tdict-&gt; { DecodeParms } = PDFDict;
+        $tdict-&gt; { DecodeParms }-&gt; val-&gt; { Predictor } = PDFNum&#40; 12 &#41;;
+        $tdict-&gt; { DecodeParms }-&gt; val-&gt; { Columns }   = PDFNum&#40; $len + 2 &#41;;
+
+        $stream = PDF::API2::Basic::PDF::Filter::FlateDecode-&gt; new-&gt; outfilt&#40; $stream, 1 &#41;;
+        $tdict-&gt; { &#39; stream&#39; } = $stream;
+        $tdict-&gt; { &#39; nofilt&#39; } = 1;
+        delete $tdict-&gt; { Length };
+        $self-&gt; ship_out;
+    }
+    else {
+        $fh-&gt;print&#40;&#34;xref\n&#34;, @out, &#34;trailer\n&#34;&#41;;
+        $tdict-&gt;outobjdeep&#40;$fh, $self&#41;;
+        $fh-&gt;print&#40;&#34;\n&#34;&#41;;
+    }
+    $fh-&gt;print&#40;&#34;startxref\n$tloc\n%%EOF\n&#34;&#41;;
 }
 
 

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;03&nbsp;13:38:35&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Wow! That&#39;s quite a bit of work you&#39;ve put in -- thank you. It&#39;s complicated enough that I want to go over it very carefully &#40;and of course, test it thoroughly&#41; before putting it in PDF::Builder. I can&#39;t even yet ask any questions about it! I hope to get it in for release 3.014, unless there are complications, in which case it may slide to 3.015 this summer.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;08&nbsp;17:59:57&nbsp;2019</span>
    <span class="description">futuramedium [...] yandex.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Found minor issues: though harmless, they&#39;d better be fixed. I hope that&#39;s final version, sorry for the mess.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> File.diff.190403.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- PDF\API2\Basic\PDF\File.old	Fri Jul  7 04:53:59 2017
+++ PDF\API2\Basic\PDF\File.pm	Tue Apr  9 00:46:42 2019
@@ -522,6 +522,8 @@
 
         if &#40;defined $result-&gt;{&#39;Type&#39;} and defined $types{$result-&gt;{&#39;Type&#39;}-&gt;val}&#41; {
             bless $result, $types{$result-&gt;{&#39;Type&#39;}-&gt;val};
+            $result-&gt; {&#39; outto&#39;} = [ $self ];
+            weaken $_ for @{$result-&gt;{&#39; outto&#39;}};
         }
         # gdj: FIXME: if any of the ws chars were crs, then the whole
         # string might not have been read.
@@ -540,7 +542,7 @@
         }
         $result-&gt;{&#39; parent&#39;} = $self;
         weaken $result-&gt;{&#39; parent&#39;};
-        $result-&gt;{&#39; realised&#39;} = 0;
+#??        $result-&gt;{&#39; realised&#39;} = 0;
         # gdj: FIXME: if any of the ws chars were crs, then the whole
         # string might not have been read.
     }
@@ -1282,7 +1284,7 @@
     $tdict-&gt;{&#39;Size&#39;} = PDFNum&#40;$self-&gt;{&#39; maxobj&#39;}&#41;;
 
     my $tloc = $fh-&gt;tell&#40;&#41;;
-    $fh-&gt;print&#40;&#34;xref\n&#34;&#41;;
+    my @out;
 
     my @xreflist = sort { $self-&gt;{&#39; objects&#39;}{$a-&gt;uid}[0] &lt;=&gt; $self-&gt;{&#39; objects&#39;}{$b-&gt;uid}[0] } &#40;@{$self-&gt;{&#39; printed&#39;} || []}, @{$self-&gt;{&#39; free&#39;} || []}&#41;;
 
@@ -1314,25 +1316,25 @@
 #            $fh-&gt;printf&#40;&#34;0 1\n%010d 65535 f \n&#34;, $ff&#41;;
 #        }
         if &#40;$i &gt; $#xreflist || $self-&gt;{&#39; objects&#39;}{$xreflist[$i]-&gt;uid}[0] != $j + 1&#41; {
-            $fh-&gt;print&#40;&#40;$first == -1 ? &#34;0 &#34; : &#34;$self-&gt;{&#39; objects&#39;}{$xreflist[$first]-&gt;uid}[0] &#34;&#41; . &#40;$i - $first&#41; . &#34;\n&#34;&#41;;
+            push @out, &#40;$first == -1 ? &#34;0 &#34; : &#34;$self-&gt;{&#39; objects&#39;}{$xreflist[$first]-&gt;uid}[0] &#34;&#41; . &#40;$i - $first&#41; . &#34;\n&#34;;
             if &#40;$first == -1&#41; {
-                $fh-&gt;printf&#40;&#34;%010d 65535 f \n&#34;, defined $freelist[$k] ? $self-&gt;{&#39; objects&#39;}{$freelist[$k]-&gt;uid}[0] : 0&#41;;
+                push @out, sprintf&#40;&#34;%010d 65535 f \n&#34;, defined $freelist[$k] ? $self-&gt;{&#39; objects&#39;}{$freelist[$k]-&gt;uid}[0] : 0&#41;;
                 $first = 0;
             }
             for &#40;$j = $first; $j &lt; $i; $j++&#41; {
                 my $xref = $xreflist[$j];
                 if &#40;defined $freelist[$k] &#38;&#38; defined $xref &#38;&#38; &#34;$freelist[$k]&#34; eq &#34;$xref&#34;&#41; {
                     $k++;
-                    $fh-&gt;print&#40;pack&#40;&#34;A10AA5A4&#34;,
+                    push @out, pack&#40;&#34;A10AA5A4&#34;,
                                     sprintf&#40;&#34;%010d&#34;, &#40;defined $freelist[$k] ?
                                                       $self-&gt;{&#39; objects&#39;}{$freelist[$k]-&gt;uid}[0] : 0&#41;&#41;, &#34; &#34;,
                                     sprintf&#40;&#34;%05d&#34;, $self-&gt;{&#39; objects&#39;}{$xref-&gt;uid}[1] + 1&#41;,
-                                    &#34; f \n&#34;&#41;&#41;;
+                                    &#34; f \n&#34;&#41;;
                 }
                 else {
-                    $fh-&gt;print&#40;pack&#40;&#34;A10AA5A4&#34;, sprintf&#40;&#34;%010d&#34;, $self-&gt;{&#39; locs&#39;}{$xref-&gt;uid}&#41;, &#34; &#34;,
+                    push @out, pack&#40;&#34;A10AA5A4&#34;, sprintf&#40;&#34;%010d&#34;, $self-&gt;{&#39; locs&#39;}{$xref-&gt;uid}&#41;, &#34; &#34;,
                             sprintf&#40;&#34;%05d&#34;, $self-&gt;{&#39; objects&#39;}{$xref-&gt;uid}[1]&#41;,
-                            &#34; n \n&#34;&#41;&#41;;
+                            &#34; n \n&#34;&#41;;
                 }
             }
             $first = $i;
@@ -1342,9 +1344,53 @@
             $j++;
         }
     }
-    $fh-&gt;print&#40;&#34;trailer\n&#34;&#41;;
-    $tdict-&gt;outobjdeep&#40;$fh, $self&#41;;
-    $fh-&gt;print&#40;&#34;\nstartxref\n$tloc\n%%EOF\n&#34;&#41;;
+    if &#40; exists $tdict-&gt; { Type } and $tdict-&gt; { Type }-&gt; val eq &#39;XRef&#39; &#41; {
+        
+        my &#40; @index, @stream &#41;;
+        for &#40; @out &#41; {
+            my @a = split;
+            @a == 2 ? push @index, @a : push @stream, \@a
+        } 
+        my $i = $self-&gt;{ &#39; maxobj&#39; } ++;
+        $self-&gt; add_obj&#40; $tdict, $i, 0 &#41;;
+        $self-&gt; out_obj&#40; $tdict &#41;;
+
+        push @index, $i, 1;
+        push @stream, [ $tloc, 0, &#39;n&#39; ];
+
+        my $len = $tloc &gt; 0xFFFF ? 4 : 2;           # don&#39;t expect files &gt; 4 Gb
+        my $tpl = $tloc &gt; 0xFFFF ? &#39;CNC&#39; : &#39;CnC&#39;;   # don&#39;t expect gennum &gt; 255, it&#39;s absurd.
+                                                    # Adobe doesn&#39;t use them anymore anyway
+        my $stream = &#39;&#39;; 
+        my @prev   = &#40; 0 &#41; x &#40; $len + 2 &#41;;
+        for &#40; @stream &#41; {
+            my @line = unpack &#39;C*&#39;, pack $tpl, $_-&gt; [ 2 ] eq &#39;n&#39; ? 1 : 0, @{ $_ }[ 0 .. 1 ];
+
+            $stream .= pack &#39;C*&#39;, 2,                # prepend filtering method, &#34;PNG Up&#34;
+                map {&#40; $line[ $_ ] - $prev[ $_ ] + 256 &#41; % 256 } 0 .. $#line;
+            @prev    = @line;
+        }
+        $tdict-&gt; { Size }   = PDFNum&#40; $i + 1 &#41;;
+        $tdict-&gt; { Index }  = PDFArray&#40; map PDFNum&#40; $_ &#41;, @index &#41;;
+        $tdict-&gt; { W }      = PDFArray&#40; map PDFNum&#40; $_ &#41;, 1, $len, 1 &#41;;
+        $tdict-&gt; { Filter } = PDFName&#40; &#39;FlateDecode&#39; &#41;;
+        
+        $tdict-&gt; { DecodeParms } = PDFDict;
+        $tdict-&gt; { DecodeParms }-&gt; val-&gt; { Predictor } = PDFNum&#40; 12 &#41;;
+        $tdict-&gt; { DecodeParms }-&gt; val-&gt; { Columns }   = PDFNum&#40; $len + 2 &#41;;
+
+        $stream = PDF::API2::Basic::PDF::Filter::FlateDecode-&gt; new-&gt; outfilt&#40; $stream, 1 &#41;;
+        $tdict-&gt; { &#39; stream&#39; } = $stream;
+        $tdict-&gt; { &#39; nofilt&#39; } = 1;
+        delete $tdict-&gt; { Length };
+        $self-&gt; ship_out;
+    }
+    else {
+        $fh-&gt;print&#40;&#34;xref\n&#34;, @out, &#34;trailer\n&#34;&#41;;
+        $tdict-&gt;outobjdeep&#40;$fh, $self&#41;;
+        $fh-&gt;print&#40;&#34;\n&#34;&#41;;
+    }
+    $fh-&gt;print&#40;&#34;startxref\n$tloc\n%%EOF\n&#34;&#41;;
 }
 
 

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;23&nbsp;22:50:02&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Vadim,

It looks like it&#39;s almost there. I did encounter one error message while running your test.pl code: Character in &#39;C&#39; format wrapped in pack at .../File.pm line 1507. That line is after for &#40;@stream&#41; { :

my @line = unpack &#39;C*&#39;, pack $tpl, $_-&gt;[2] eq &#39;n&#39;...

Any ideas? I&#39;m running PDF::Builder on Perl 5.26, if you tested at an earlier version. I applied only the changes in your last posting of the diffs to File.pm &#40;they appeared to be cumulative&#41;. The old code produced an unloadable corrupted PDF, but the new File.pm code produced a working PDF. It&#39;s the original PDF 1.5 input with some new stuff, including a cross reference stream, added after the %%EOF, if that&#39;s the correct result. I note that some objects have the same number as those found earlier in the input -- I take it they override &#40;replace&#41; the earlier object of the same number?

Should this cross reference stream output be seen ONLY if the file read in was PDF 1.5 or higher, with a cross reference stream? That is, nothing at PDF 1.4 or lower in PDF::Builder should cause a cross reference stream to be output? If something can cause it, I will need to add a line of code to force a minimum of PDF 1.5 output level.

Finally, I looked at your complaint about &#39;saveas&#40;&#41;&#39; not permitting further updates. Indeed, after saveas&#40;&#41;, $pdf is still defined and is still a hash, but $pdf-&gt;page&#40;&#41; blows up &#40;can&#39;t call method new_obj on an undefined value&#41;. Could you look at RT 81530 and see if it sounds related? Possibly $pdf should be marked as unusable, or even be undefined, once save&#40;&#41;, saveas&#40;&#41;, or stringify&#40;&#41; is called? At the least, I can expand the documentation to warn about this.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;24&nbsp;15:13:43&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think I may have solved the first problem &#40;&#39;wrapped&#39; warning&#41;, but I&#39;d like your opinion on it. After the line

        for &#40;@stream&#41; {

and before

            my @line = unpack &#39;C*&#39;, pack $tpl, $_-&gt;[ 2 ] eq &#39;n&#39;? 1 : 0, @{ $_ }[ 0 .. 1 ];

I added

            $_-&gt;[1] &#38;= 0x00FF;

to ensure that the value was in the range 0..255. Apparently, packing with C will do the same thing, but now issues a &#34;wrapped&#34; warning. Anyway, it seems to work. Was this value, which was 65535 in @stream, the one you referred to as &#34;don&#39;t expect gennum &gt; 255, it&#39;s absurd.&#34; or was that the other value? 

$tloc was 27173, $len was 2, $tpl was &#39;CnC&#39;. The first @stream was 0000000000 65535 f &#40;I assume the 0&#39;s collapse to integer 0&#41; and the result was 0 0 0 255 &#40;xFFFF trimmed to xFF&#41;. The second @stream was 27173 0 n &#40;x6A25&#41; which gave a result of 1 106 37 0 &#40;x6A x25&#41;. It&#39;s the same result as the original code, without the nasty warning.

By the way, I was concerned about both $stream and @stream being used together, so I renamed $stream to $sstream to eliminate any possibility of one being used for the other.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;24&nbsp;18:25:51&nbsp;2019</span>
    <span class="description">futuramedium [...] yandex.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">My test script didn&#39;t have shebang line with a &#34;-w&#34;, that&#39;s why I didn&#39;t see this warning! As you already found, the issue is with generation number 65535 of 0th object, i.e. what would be &#34;0000000000 65535 f&#34; line in classic table. I&#39;d put the following at exact location where you suggested:

$_-&gt; [ 1 ] = 0 if $_-&gt; [ 2 ] eq &#39;f&#39; and 
                  $_-&gt; [ 1 ] == 65535;

Examples in the Reference show, that gennum 65535 can be used to mark objects as &#34;not to be re-used&#34;, i.e. in theory, objects other than 0th can have it, too. In practice, apart from 65535 for object 0, my &#34;absurd&#34; comment was that probably no PDF file has ever had such long and twisted history of incremental updates, that gennum of any object is more than a dozen at most!

Further, as implementation note 16 in the Reference says, &#34;Acrobat 6.0 and later do not use the free list to recycle object numbers; new objects are assigned new numbers.&#34; That&#39;s in accordance with my observation that 0th object &#40;1st entry&#41; in XRef stream has gennum of 0 in PDF files I&#39;ve seen.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; original PDF 1.5 input with some new stuff, including a cross reference stream, added after the %%EOF, if that&#39;s the correct result.
</div>
That was the whole point -- to allow incremental update for files that are using Xref stream, so that Acrobat is OK with result. As I said earlier elsewhere, other viewers don&#39;t mind if update with classic XRef table is appended to file with Xref stream.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I note that some objects have the same number as those found earlier in the input -- I take it they override &#40;replace&#41; the earlier object of the same number? 
</div>
That&#39;s correct, it&#39;s how incremental update mechanism is described in the Reference.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Should this cross reference stream output be seen ONLY if the file read in was PDF 1.5 or higher, with a cross reference stream?
</div>
Correct -- in my patch, the presence of &#34;Type&#34; entry in $tdict and its value being &#34;XRef&#34; are checked. Based on that, either classic or stream Xref information is written. I believe it&#39;s robust enough &#40;maybe some other check would be better? A flag set when file was read?&#41; I think we should only expect well-formed PDFs, which have correct version if they use Xref stream. But, it&#39;s possible that file&#39;s version would be 1.5 and above, but, for any reason, it has classic table. Then, my patch will append classic table. 

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Could you look at RT 81530 and see if it sounds related?
</div>
Ah, so it&#39;s old issue, and better documentation is on its way :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;24&nbsp;20:36:38&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Apr 24 18:25:51 2019, vadimr wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; My test script didn&#39;t have shebang line with a &#34;-w&#34;, that&#39;s why I
&gt; didn&#39;t see this warning!
</div>That&#39;ll learn ya! :&#41; I make it a habit to start each .pl with use strict; and use warnings;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; $_-&gt; [ 1 ] = 0 if $_-&gt; [ 2 ] eq &#39;f&#39; and
&gt;                  $_-&gt; [ 1 ] == 65535;
&gt; 
&gt; Examples in the Reference show, that gennum 65535 can be used to mark
&gt; objects as &#34;not to be re-used&#34;, i.e. in theory, objects other than 0th
&gt; can have it, too. In practice, apart from 65535 for object 0, my
&gt; &#34;absurd&#34; comment was that probably no PDF file has ever had such long
&gt; and twisted history of incremental updates, that gennum of any object
&gt; is more than a dozen at most!
&gt; 
&gt; Further, as implementation note 16 in the Reference says, &#34;Acrobat 6.0
&gt; and later do not use the free list to recycle object numbers; new
&gt; objects are assigned new numbers.&#34; That&#39;s in accordance with my
&gt; observation that 0th object &#40;1st entry&#41; in XRef stream has gennum of 0
&gt; in PDF files I&#39;ve seen.
</div>
OK, you explain it&#39;s OK to 0 out this particular 16-bit value &#40;xFFFF&#41;,
as no Reader that handles cross reference streams pays attention to the value anyway. Is that the only place that a value greater than xFF is ever
going to show up? If it&#39;s documented that Readers don&#39;t care what the gennum value is in this case, that&#39;s fine, but I&#39;m leery of &#34;observations&#34; that it always works that way -- there might be oddball Readers out there that /do/ care about this value.

I could imagine someone constantly updating a PDF file for some reason, perhaps &#34;saving&#34; instead of &#34;quitting&#34; a Reader. I saw this back in the early days of JPEG file usage -- a co-worker was complaining that his JPEG images were slowing rotting away. I had to explain to him that he was saving the image each time he wanted to quit the viewer, so the image was losing more high frequency data each time! Anyway, it&#39;s not impossible that the gennum could end up &gt; 255 in some strange situations.

Since $_-&gt;[1] is going to be packed with &#39;C&#39;, I think it would be a good idea to stay with my fix of clearing high bits to ensure that it&#39;s in the 0..255 range. If someone /does/ get a gennum &gt; 255, cycling back to 0 might cause problems, but that&#39;s life. At least they won&#39;t get a &#34;wrapped&#34; warning. If a cross reference stream is always going to handle it as a single byte, it can&#39;t be allowed to exceed 255, whatever its purpose. Should we consider treating it as 16-bits, if the standard permits?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; original PDF 1.5 input with some new stuff, including a cross
&gt; &gt; reference stream, added after the %%EOF, if that&#39;s the correct
&gt; &gt; result.
</div>&gt; 
&gt; That was the whole point
</div>Let me rephrase my question, then -- is the correct result to output the original, unchanged &#40;almost&#41; PDF, and then tack on these new and replacement objects, and maybe a cross reference stream, after the original %%EOF? You seem to have said &#34;yes&#34;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Could you look at RT 81530 and see if it sounds related?
</div>&gt; 
&gt; Ah, so it&#39;s old issue, and better documentation is on its way :&#41;
</div>I promise, I /will/ put something in, at least in the POD for save, saveas, and stringify!

Unless you have any further updates or strong objections to something, I think I will put out PDF::Builder 3.014 this weekend, with this ticket closed.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;25&nbsp;07:02:10&nbsp;2019</span>
    <span class="description">futuramedium [...] yandex.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;use warnings;
</div>
But I always do, I swear! It&#39;s File.pm who doesn&#39;t! And lexically scoped &#34;use warnings;&#34; in my .pl can&#39;t help. OTOH, &#34;-w&#34; switch on command &#40;shebang&#41; line sets global $^W. A bit further off topic, CAM::PDF does &#34;use warnings;&#34;, and when I modified it, in quite similar way, for internal use, to write XRef streams some years ago, the case with 65535 was caught. &#34;Transferring&#34; that patch to PDF::API2, I just forgot to zero gennum of 0th object. Sorry. If only I didn&#39;t forget, I hadn&#39;t to write all of the following :&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;Let me rephrase my question, then -- is the correct result to output the original, unchanged &#40;almost&#41; PDF, and then tack on these new and replacement objects, and maybe a cross reference stream, after the original %%EOF? You seem to have said &#34;yes&#34;.
</div>
Yes. I&#39;ll try to clarify further, sorry if it may sound primitive. For performance reasons, many file formats allow incremental updates, with changes appended to intact original. &#40;Not &#34;almost&#34;, but 100% intact.&#41; In GUIs, it&#39;s usually &#34;Save&#34; for incremental update, and &#34;SaveAs&#34; for clean re-write, not necessarily to another filename. It&#39;s same difference in CAM::PDF&#39;s methods &#34;output&#34; and &#34;cleanoutput&#34;. 

With &#34;cleanoutput&#34;, all objects are re-numbered consecutively, getting fresh gennum of &#34;0&#34;, and &#34;holes&#34; of ranges of free objects are eliminated. PDF::API2 simply can&#39;t do &#34;cleanoutput&#34;. If file is opened and then saved, it&#39;s always incremental update, however confusing method&#39;s name &#34;saveas&#34; is. Even if all objects were changed and original content becomes useless, it&#39;s stored intact as it was, and new content is appended.

My patch in #121832 was an attempt to teach PDF::API2 to &#34;cleanoutput&#34;. Now I think it&#39;s not worth it, since it can only output old-fashioned 1.4 classical XRef table, it tries complex and possibly fragile not-tested-enough things &#40;as opposed to simple patch discussed in this thread&#41;, and nobody seems interested.

New patch only serves one purpose: users now can modify &#34;modern&#34; PDF files without necessity to downgrade them to 1.4 as preliminary step, and worrying why Reader can&#39;t read their files and whether PDF::API2 works at all, or not. But it&#39;s same old incremental update.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;Is that the only place that a value greater than xFF is ever going to show up? 
</div>
OK, consider this. For gennum to become &gt; 255, PDF file has to be updated at least 510 times. This minimum of 510 is possible if pattern of updates is strictly that each odd save removes an object &#40;objnum marked free on save&#41;, and some info &#40;completely new indirect object&#41; is added on each even save &#40;objnum re-used, gennum increased&#41;. If this pattern is not strict, gennum ever gets to &gt; 255 after more, possibly much more number of updates. Multiply probability of such scenario by chance that people torturing this file never get worried about file size bloat, so they don&#39;t reset the progression by issuing &#34;SaveAs&#34; command somewhere in the middle.

Note, all of the above still happens in 1.4 era, with classical XRef table. If file gets to PDF::API2 in this state with any gennum &gt;255 -- fine, it&#39;s not an issue for patch discussed.

If this file is updated to 1.5 before getting to PDF::API2 -- fine too, it was a clean &#34;SaveAs&#34;, all gennums reset and never touched again by Acrobat/Reader.

That&#39;s why my suggestion was to set gennum to 0 instead of 255 -- it would be same &#34;0&#34; as in files saved with Reader. But in the end it&#39;s probably not so important.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;Should we consider treating it as 16-bits, if the standard permits
</div>
Is there any software that still tracks free list and re-uses objnums and increases gennums, even in Xref streams, and regardless of Adobe&#39;s own stance? I don&#39;t know! Have never heard of. I&#39;d solve problems when &#40;and if&#41; they come: if anyone files a bug report and we see that it&#39;s because we &#40;wrongly, it will appear&#41; assumed gennums always zero &#40;well, less than 255&#41; in XRef streams -- fine, we&#39;ll know how to fix -- i.e. to use &#39;Cnn&#39; &#40;&#39;CNn&#39;&#41; template. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;26&nbsp;12:59:34&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Both set special case &#39;0 65535 f&#39; to &#39;0 0 f&#39;, and added warning and reduction of any generation number in excess of 255 &#40;because it is packed with &#39;C&#39; code&#41;. Closing RT 117184 for PDF::Builder, and fix will appear in today&#39;s 3.014 release. Again, thank you Vadim for your work on this. Please consider issuing a Pull Request for PDF::API2.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;11&nbsp;17:56:56&nbsp;2019</span>
    <span class="description">david-dot-warring [...] gmail.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve attached a hybrid PDF. Since they&#39;ve been mentioned. These *ARENT&#39;T* breaking under update and don&#39;t need special handling.
- david
On Tue Apr 02 22:13:42 2019, vadimr wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Phil,
&gt; 
&gt; I have better alternative than patch &#40;hack&#41; from #121832. To please
&gt; Acrobat/Reader, incremental update can append either classical Xref
&gt; Table or compressed Xref Stream. The new patch seems to be working.
&gt; The test PDF file is from this thread.
&gt; 
&gt; 1&#41; Producing &#34;hybrid files&#34; to ensure &#34;compatibility with older
&gt; applications&#34; is not implemented &#40;was not even contemplated -- I don&#39;t
&gt; think it&#39;s important anymore&#41;.
&gt; 
&gt; 2&#41; No support &#40;with this patch, but would not be difficult in general&#41;
&gt; for files &gt; ~4 Gb.
&gt; 
&gt; 3&#41; Somewhat lousy compression &#40;because of no prediction&#41; if someone
&gt; updates unusually large number of objects -- i.e. generally unlikely&#41;.
&gt; 
&gt; 4&#41; Of course, updated objects are not stuffed into streams, and
&gt; furthermore this patch does nothing to &#34;use modern compression&#34; when
&gt; file is clean-output &#40;IIRC, PDF::API2 can&#39;t do it anyway&#41;.
&gt; 
&gt; 5&#41; Important -- this patch also applies changes &#40;2 topmost changes&#41; as
&gt; per #121911.
&gt; 
&gt; In fact, fixes are very minimal, existing code is mostly re-used to
&gt; collect updates made to XRef Table &#40;instead of writing them as they
&gt; come&#41; and then apply them appropriately in either of 2 modes.
&gt; 
&gt; + One &#40;minor&#41; digression: documentation could be more clear that after
&gt; calling &#34;saveas&#34; an instance becomes unusable -- to prevent someone
&gt; writing scripts e.g. such as with commented fragment below.
&gt; 
&gt; 
&gt; use warnings;
&gt; use strict;
&gt; use feature &#39;say&#39;;
&gt; 
&gt; use PDF::API2;
&gt; 
&gt; my $pdf = PDF::API2-&gt; open&#40; &#34;test.pdf&#34; &#41;;
&gt; $pdf-&gt; page;
&gt; $pdf-&gt; page;
&gt; $pdf-&gt; page;
&gt; 
&gt; $pdf-&gt; saveas&#40; &#34;test-mod.pdf&#34; &#41;;
&gt; 
&gt; # $pdf-&gt; page;
&gt; # $pdf-&gt; page;
&gt; # $pdf-&gt; saveas&#40; &#34;test-mod++.pdf&#34; &#41;;
&gt; 
&gt; __END__
</div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> hybrid.pdf</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1848271/993195/hybrid.pdf">Download hybrid.pdf</a><br />
<span class="downloadcontenttype">application/pdf 79k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;13&nbsp;07:40:17&nbsp;2019</span>
    <span class="description">futuramedium [...] yandex.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for testing, David. To handle hybrid files, this patch needs yet another tweak :-&#40;. 


my $pdf = PDF::API2-&gt; open&#40; &#39;hybrid.pdf&#39; &#41;;

#delete $pdf-&gt; { pdf }{ XRefStm };

$pdf-&gt; openpage&#40; 1 &#41;-&gt; rotate&#40; 180 &#41;;
$pdf-&gt; saveas&#40; &#39;hybrid+.pdf&#39; &#41;;

$pdf = PDF::API2-&gt; open&#40; &#39;hybrid+.pdf&#39; &#41;;
$pdf-&gt; page;
$pdf-&gt; saveas&#40; &#39;hybrid++.pdf&#39; &#41;;


1st page reverts to unrotated state -- because, according to the Reference, the &#34;XRefStm&#34; must be consulted first, before descending the &#34;Prev&#34;&#39;s chain &#40;alas, Chrome is broken&#41;. So this entry should be deleted in trailers of appended sections. I.e.

delete $tdict-&gt; { XRefStm };

inserted into &#34;else&#34; clause of the above patch.

Further &#40;NOT related to patch discussed, but revealed because of &#34;hybrid.pdf&#34;&#41;, PDF::API2 appends new content quite literally: &#34;%%EOF3 0 obj &lt;&lt; /Type /Page ...&#34; etc. Though offset for object 3 is correct and no applications seem to complain, it&#39;s ugly and I doubt it&#39;s valid syntax, really, and better be fixed, i.e., ensure newline before appending.

These changes aren&#39;t urgent, documented for the future.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;13&nbsp;16:52:14&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Vadim,

Yeah, I caught the run-on %%EOF problem and fixed it yesterday &#40;in PDF::Builder&#41; by ensuring that an opened PDF ends with an EOL beyond the original final %%EOF &#40;since new code will be appended&#41;.

As for the rest of this stuff, I&#39;m a bit confused. Do you anticipate having to patch PDF::API2 &#38; Builder to do something with XRefStm in new trailers? How critical is this -- should I delay 3.015 release until the new patch? 

Is this only something that affects the Chrome PDF reader, or does it affect Acrobat Reader &#40;and many other readers&#41; too?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;14&nbsp;06:08:12&nbsp;2019</span>
    <span class="description">futuramedium [...] yandex.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #117184]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 14 May 2019 13:06:05 +0300</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-pdf-api2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> vadim repin &lt;futuramedium [...] yandex.ru&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza"><div>Phil, actually it's new and unrelated issue that can affect hybrid files. Perhaps not very critical, as it always was there. As example shows, it is easy to modify a file so that XRefStm points to outdated information. This key simply must not be preserved. To fix, single line of code can be added immediately after &quot;else&quot; line. I mentioned Chrome just as a fun fact, it does not follow specification strictly, which appears to &quot;cancel out&quot; the issue and possibly adds to confusion.</div>


</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;14&nbsp;10:45:59&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">OK, so

+ else { 
+     $fh-&gt;print&#40;&#34;xref\n&#34;, @out, &#34;trailer\n&#34;&#41;; 
+     $tdict-&gt;outobjdeep&#40;$fh, $self&#41;; 
+     $fh-&gt;print&#40;&#34;\n&#34;&#41;; 
+ } 
+ $fh-&gt;print&#40;&#34;startxref\n$tloc\n%%EOF\n&#34;&#41;; 
}

should become 

+ else { 
+     delete $tdict-&gt;{&#39;XRefStm&#39;};
+     $fh-&gt;print&#40;&#34;xref\n&#34;, @out, &#34;trailer\n&#34;&#41;; 
+     $tdict-&gt;outobjdeep&#40;$fh, $self&#41;; 
+     $fh-&gt;print&#40;&#34;\n&#34;&#41;; 
+ } 
+ $fh-&gt;print&#40;&#34;startxref\n$tloc\n%%EOF\n&#34;&#41;; 
}

? Does this assume there is already a XRefStm entry in the existing PDF &#40;that we want to use&#41;? Should there be a check added that there is, before deleting the new one, or is it safe to assume there always is an existing one?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;14&nbsp;18:15:28&nbsp;2019</span>
    <span class="description">futuramedium [...] yandex.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The code change is correct. *Maybe* &#40;I now think&#41; it would be better to move this line into sub&#39;s caller, where $tdict is created by copying the existing trailer dictionary, and just get rid of XRefStm unconditionally. 

Of course not every PDF contains &#34;XRefStm&#34;! Deleting non-existent hash elements is safe and a no-op. If &#40;from maintenance POV?&#41; you&#39;d prefer &#34;delete something{foo} if exists something{foo}&#34; -- OK, write it so. For me it&#39;s more effort to read and tautology, in a sense. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;15&nbsp;09:17:26&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue May 14 18:15:28 2019, vadimr wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The code change is correct. *Maybe* &#40;I now think&#41; it would be better
&gt; to move this line into sub&#39;s caller, where $tdict is created by
&gt; copying the existing trailer dictionary, and just get rid of XRefStm
&gt; unconditionally.
</div>Code efficiency improvement, or change of behavior?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Of course not every PDF contains &#34;XRefStm&#34;! Deleting non-existent hash
&gt; elements is safe and a no-op. If &#40;from maintenance POV?&#41; you&#39;d prefer
&gt; &#34;delete something{foo} if exists something{foo}&#34; -- OK, write it so.
&gt; For me it&#39;s more effort to read and tautology, in a sense.
</div>My point &#40;which I guess I didn&#39;t make clearly enough&#41; was that if the existing PDF we&#39;re appending to did NOT already have an XRefStm, what is lost &#40;or gained&#41; by unconditionally NOT putting in a new one? If the existing PDF did not have one, and we add a cross reference stream but no XRefStm, what are the consequences? If it DID have one, what are the consequences of adding a second one? I just want to be clear in my mind on all these angles before I make your code change.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;16&nbsp;08:08:04&nbsp;2019</span>
    <span class="description">futuramedium [...] yandex.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #117184]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 16 May 2019 15:05:50 +0300</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-pdf-api2 &lt;bug-pdf-api2 [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> vadim repin &lt;futuramedium [...] yandex.ru&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza"><div>&gt; Code efficiency improvement, or change of behavior?<br><br>Neither, just keeping related things close together, for coherence/ease of maintenance. Decisions about content of trailer of new section, including what entries from existing trailer to keep, are made very near $tdict creation at line 341 (<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/release/PDF-API2/source/lib/PDF/API2/Basic/PDF/File.pm#L341&#41;">https://metacpan.org/release/PDF-API2/source/lib/PDF/API2/Basic/PDF/File.pm#L341&#41;</a></span>. No reason to delete XRefStm 1000+ LOCs away. But it's not very important.<br><br>Reference:<br><br>"Note: Table 3.17 defines an additional entry, XRefStm, that appears _only_ in the trailer of hybrid-reference files, described in Compatibility with Applications That Do Not Support PDF 1.5 on page 109."<br><br>1.4-compatible consumer doesn't know about "only" (nor, of course, what to do with XRefStm), but:<br><br>"The added trailer contains _all_ the entries (perhaps modified) from the previous trailer, as well as a Prev entry giving the location of the previous cross-reference section..."<br><br>PDF::API2 is 1.5-consumer, _and_ it can't save hybrid files, therefore neither "old" XRefStm is kept in appended sections (see rotated page example), nor "new" one is added. That "hybrid" was bad design idea, on Adobe side, anyway, but that's too much off topic. I hope the above quotes answer your other questions. Just consider how pdf-reader follows xrefs sections chain, looking for /Prev in trailers and (since it's 1.5-compatible) for /XrefStm, too -- /XRefStm is checked first before descending further, if object wasn't found yet.</div>
<div></div>
<div>That original section remains to be "hybrid". What we are appending is "classic". If original was not "hybrid" but pure "1.5 xref stream", then we are appending pure "xref stream" section and XRefStm is not required.</div>
<div><br></div>
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
