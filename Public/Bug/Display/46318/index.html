<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #46318 for Catalyst-Plugin-Session: Session fixation vulnerability</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #46318 for Catalyst-Plugin-Session: Session fixation vulnerability</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Catalyst-Plugin-Session/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Catalyst-Plugin-Session/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Catalyst-Plugin-Session/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Catalyst-Plugin-Session/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Catalyst-Plugin-Session">Catalyst-Plugin-Session CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">46318</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Catalyst-Plugin-Session/Active/">Catalyst-Plugin-Session</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">bobtfish [...] bobtfish.net
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
kmx [...] volny.cz

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-5260-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-5261-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;23&nbsp;17:50:08&nbsp;2009</span>
    <span class="description">kmx [...] volny.cz -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Session fixation vulnerability</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 23 May 2009 23:49:28 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Catalyst-Plugin-Authentication [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I guess that the current implementation of
Catalyst-Plugin-Authentication &#40;or maybe Catalyst-Plugin-Session&#41; does
not prevent Session fixation attack because it does not force generation
of new sessionid &#40;=cookie&#41; during authenticate&#40;&#41; and logout&#40;&#41;.

It could be handled by some additional code in the cat application:

[LOGIN]
if &#40;$c-&gt;authenticate&#40; { username =&gt; $user, password =&gt; $pass } &#41;&#41; {
  $c-&gt;create_session_id&#40;&#41;;
  ...
}
...

note: it probably is also not optimal as create_session_id&#40;&#41; is declared
to be an internal method of &#34;Catalyst::Plugin::Session&#34; &#40;it probably
means something like &#34;could be changed without notice&#34;&#41;

[LOGOUT]
sub logout :Global :Args&#40;0&#41; {
  my &#40; $self, $c &#41; = @_;

  if &#40;$c-&gt;user_exists&#41; {
    $c-&gt;delete_session&#40;&#34;logout&#34;&#41;;
    $c-&gt;logout&#40;&#41;;
    ...    
  }
...

However in my opinion the framework itself should prevent session
fixation attack.

My proposal is to force sessionid change &#40;new id&#41; during both discussed
calls:
- authenticate&#40;&#41;
- logout&#40;&#41;

The problem might occur with applications that first uses the session in
&#34;anonymous phase&#34; &#40;e.g. user is adding goods into cart before login&#41;,
then let user log in and want to keep his/her session data for
&#34;authenticated phase&#34; &#40;to finish the order and pay for it&#41;. To prevent
session fixation in this scenarion it is necessary to give the user a
new sessionid and make a copy of session data.

Patching logout&#40;&#41; method seems to be quite straightforward - something
like this:

--- Authentication.pm ---
sub logout {
    my $c = shift;

+    if &#40;$c-&gt;can&#40;&#39;session&#39;&#41; and
$c-&gt;config-&gt;{&#39;Plugin::Authentication&#39;}{&#39;use_session&#39;} &#41; {
+      $c-&gt;delete_session&#40;&#34;logout&#34;&#41;
+    }

    $c-&gt;user&#40;undef&#41;;
---

Little bit tricky is authenticate&#40;&#41; as we have to handle two modes:
1&#41; we want the complete reset and clean new session
2&#41; we want just to chage sessionid but keep session data
I would propose a new authenticate&#40;&#41; parameter &#34;keepsessiondata&#34; that
will indicate the mode.

What I have no idea how to do is copying the session data in case we
want to keep them. The interface of Catalyst::Plugin::Session does not
help much - I am afraid that it might require to implement some
additional method for &#34;cloning/copying&#34; existing session data.

Any idea?

--
kmx
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;23&nbsp;18:11:50&nbsp;2009</span>
    <span class="description">bobtfish [...] bobtfish.net -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;23&nbsp;18:17:04&nbsp;2009</span>
    <span class="description">bobtfish [...] bobtfish.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi.

After we discussed this, I thought that the correct approach is probably
to write some failing tests for either -Authentication or -Session

I wrote a trivial test for the session code already:

<span class="clickylink"><a target="new" rel="nofollow" href="http://dev.catalyst.perl.org/svnweb/Catalyst/revision?rev=10246">http://dev.catalyst.perl.org/svnweb/Catalyst/revision?rev=10246</a></span>

I&#39;ll try to write some more tests for this issue - but I think that this
shows it isn&#39;t present for the simple case, do you agree?

Have you actually observed this bug for real? And if so, could you
provide some sets of HTTP request and response headers which demonstrate?

I&#39;m moving this bug into the queue for the Plugin::Session dist for the
moment, but I may move it back if that proves appropriate later ;&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;23&nbsp;18:17:04&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;23&nbsp;18:17:32&nbsp;2009</span>
    <span class="description">bobtfish [...] bobtfish.net -  Queue changed from Catalyst-Plugin-Authentication to Catalyst-Plugin-Session</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;24&nbsp;06:21:53&nbsp;2009</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #46318] Session fixation vulnerability</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 24 May 2009 12:21:18 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Catalyst-Plugin-Session [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

here comes my &#34;real story&#34; with Catalyst application:

1&#41; start new browser &#40;=without any cookie for CatApp&#41;

2&#41; go to: <span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/publicaction">http://localhost/publicaction</a></span>
- anonymous access at this moment
- the action saves some session variable =&gt; it causes new sessionid
&#40;cookie&#41; to be generrated
- in Dump&#40;$c-&gt;session&#41; I see: {anonymous1}= &#34;test&#34;;
- it generates sessionid for example &#34;sess111111111111&#34;

3&#41; go to: <span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/showsessionvars">http://localhost/showsessionvars</a></span>
- still anonymous
- if I print in this action $c-&gt;session has I see: {anonymous1}= &#34;test1&#34;;
- sessionid = &#34;sess111111111111&#34;

4&#41; go to: <span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/login">http://localhost/login</a></span>
- at some point it calls $c-&gt;authenticate&#40; { username =&gt; $user, password
=&gt; $pass } &#41;
- but it DOES NOT force my browser to change sessionid cookie

5&#41; go to: <span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/showsessionvars">http://localhost/showsessionvars</a></span>
- now I am authenticated
- in Dump&#40;$c-&gt;session&#41; I see: {anonymous1}= &#34;test&#34;;
- I have still the same sessionid = &#34;sess111111111111&#34;

6&#41; go to: <span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/authaction">http://localhost/authaction</a></span>
- authenticated access at this moment
- the action saves some session variable, for example
$c-&gt;session-&gt;{auth1}= &#34;test2&#34;;
- as expected I have still the same sessionid = &#34;sess111111111111&#34;

4&#41; access to: <span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/logout">http://localhost/logout</a></span>
- at some point it calls $c-&gt;logout&#40;&#41;
- but it DOES NOT force my browser to change sessionid cookie

6&#41; access to: <span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/showsessionvars">http://localhost/showsessionvars</a></span>
- now I am anonymous again
- in Dump&#40;$c-&gt;session&#41; I see:  {anonymous1}= &#34;test1&#34;; {auth1}= &#34;test2&#34;;
&#40;session vars were NOT CLEARED&#41;
- I have still the same sessionid = &#34;sess111111111111&#34;

I see generally 2 problems:
1&#41; session ID should definitely change during authenticate&#40;&#41; and logout&#40;&#41;
2&#41; it is a question whether also to clear session data during
authenticate&#40;&#41; and logout&#40;&#41; - or at least add a new parameter to these
functions &#40;e.g. &#34;keepsessiondata&#34;&#41; that allows a developer to decide
whether he needs to keep session data or not

In Catalyst-Plugin-Session there should be tests at least for:
1&#41; sessionid change during authenticate&#40;&#41;
2&#41; sessionid change during logout&#40;&#41;
3&#41; if I come with completely unknown cookie CatApp should not accept it
and generate complete new one &#40;this already works fine&#41;

Your test added to rev=10246 tests the case 3&#41; - and as I have said it
works with current release well.

The test for persistence of session data during authenticate&#40;&#41; and
logout&#40;&#41; should probably go to Catalyst-Plugin-Authentication.

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;24&nbsp;06:41:53&nbsp;2009</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #46318] Session fixation vulnerability</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 24 May 2009 12:39:01 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Catalyst-Plugin-Session [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here is an example of attack scenario:

1&#41; Let us have an e-shop CatApp with some anonymous part &#40;filling your
cart with goods&#41; and authenticated part &#40;order, payment&#41;

2&#41; I will go to e-shop and browse just the anonymous part - tha catApp
gives me sessionid &#34;sess11111&#34;

3&#41; I will try to play on you &#40;your browser&#41; for example
<span class="clickylink"><a target="new" rel="nofollow" href="http://en.wikipedia.org/wiki/Cross-site_cooking">http://en.wikipedia.org/wiki/Cross-site_cooking</a></span> and insert sessionid
cookie for CatApp into your browser &#40;value &#34;sess11111&#34;&#41; - for example
you visit my malicious web forum where I put some ugly Javascript that
tries to abuse some vulnerability in you browser to insert the above
mentioned cookie

4&#41; now you will go to the same e-shop as I in point 2&#41; - you pick up
some goods and login &#40;to pay for it&#41;

5&#41; after your login you still have sessionid &#34;sess11111&#34; that is also
known to me =&gt; I can enter your session and do whatever the application
allows me

--
kmx
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;24&nbsp;06:54:55&nbsp;2009</span>
    <span class="description">bobtfish [...] bobtfish.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #46318] Session fixation vulnerability</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 24 May 2009 11:53:36 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Catalyst-Plugin-Session [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tomas Doran &lt;bobtfish [...] bobtfish.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">kmx via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Here is an example of attack scenario:
</div>
Thanks for the extensive clarification :&#41;

I mostly worked through that in my head myself before I got to sleep 
last night, but having it written down is like that is extremely clear.

As you noted, -Session isn&#39;t vulnerable to the simple case, but 
-Authentication should force session ID change as suggested.

I&#39;ll move the ticket back into that queue then ;&#41;

Cheers
t0m
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;24&nbsp;10:48:11&nbsp;2009</span>
    <span class="description">jayk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">A session fixation vulnerability is specifically the ability to force a
specific session id, and then attack the user&#39;s account by accessing the
site using the forced session id.

This problem does not exist as far as I can tell and the test provided
demonstrates that this does not work.

The other attack scenarios provided demonstrate access to the legitimate
users machine in some way - &#40;cross site scripting, etc&#41;  after a session
id has been provided.

There is no way to prevent that attack.  If session id is changed at
login / logout, it simply moves the point at which cross-site scripting
attack needs to be done to sometime between the login and logout.

The auth system already de-authenticates the session when logout takes
place so a session post logout is not useful to an attacker. 

It is not appropriate for the Catalyst Auth plugin to wipe the session
variables that it did not put there.  

Also - the session plugin already supports a delete_session&#40;&#41; method
which you can place where you like to destroy any session data that may
exist.  

IF you desire the &#39;kill the session&#39; or &#39;migrate the session&#39; options
you can delete the sessions prior to the authenticate call and after
logout and you will get the same functionality. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;24&nbsp;10:48:12&nbsp;2009</span>
    <span class="description">jayk [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;24&nbsp;12:40:15&nbsp;2009</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #46318] Session fixation vulnerability</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 24 May 2009 18:39:40 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Catalyst-Plugin-Session [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;The other attack scenarios provided demonstrate access to the legitimate
&gt;users machine in some way - &#40;cross site scripting, etc&#41; after a session
&gt;id has been provided.
</div>No, I am absolutely sure that the second scenario simply is session
fixation attack. See:
<span class="clickylink"><a target="new" rel="nofollow" href="http://en.wikipedia.org/wiki/Session_fixation#Attack_using_server_generated_SID">http://en.wikipedia.org/wiki/Session_fixation#Attack_using_server_generated_SID</a></span>
or see OWASP: <span class="clickylink"><a target="new" rel="nofollow" href="http://www.owasp.org/index.php/Session_Fixation">http://www.owasp.org/index.php/Session_Fixation</a></span>

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;There is no way to prevent that attack. If session id is changed at
&gt;login / logout, it simply moves the point at which cross-site scripting
&gt;attack needs to be done to sometime between the login and logout.
</div>It is not true as the attacker is not able to get the new sessionid I
will get after authenticate&#40;&#41;. The original problem was that in
described scenario the victim is using sessionid value that the server
originally generated for attacker that is able to insert cookie into my
browser - however this ability is not enough for entering authenticated
session if authenticate&#40;&#41; will change the sessionid.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;IF you desire the &#39;kill the session&#39; or &#39;migrate the session&#39; options
&gt;you can delete the sessions prior to the authenticate call and after
&gt;logout and you will get the same functionality.
</div>OK, I generally agree.

However in my opinion switching sessionid &#40;and keeping the data&#41; during
authenticate&#40;&#41; is something that should be recommended as &#34;catalyst
secure coding best-practice&#34; and it would be wise to use in 99% cases
&#40;it prevents session fixation and doesn&#39;t not harm anything - when
keeping the session data&#41;. If it is good for nearly everybody why not to
do it framework? The other thing is that with current C::P::Session it
is not so easy to implement sessionid switch on my own as there is not
any handy method for that in C::P::Session.

It was just idea - if you still think that &#34;this problem does not
exist&#34;, leave it.

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;24&nbsp;12:40:17&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;24&nbsp;13:41:17&nbsp;2009</span>
    <span class="description">jayk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun May 24 12:40:15 2009, kmx@volny.cz wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; No, I am absolutely sure that the second scenario simply is session
&gt; fixation attack. See:
&gt;
</div><span class="clickylink"><a target="new" rel="nofollow" href="http://en.wikipedia.org/wiki/Session_fixation#Attack_using_server_generated_SID">http://en.wikipedia.org/wiki/Session_fixation#Attack_using_server_generated_SID</a></span>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; or see OWASP: <span class="clickylink"><a target="new" rel="nofollow" href="http://www.owasp.org/index.php/Session_Fixation">http://www.owasp.org/index.php/Session_Fixation</a></span>
</div>
I have read this.  The fact is that if the attacker can override the
SID, then no session process is secure.

Let&#39;s examine the process... since Catalyst will not accept an
externally generated session that does not exist already, the only
option available is for Malory to access site, generate a session, and
then inject that into Alice&#39;s cookie somehow.  First off, since a
session is not created unless there is something to store in it, the
only time this will work is if Malory already logs in, or the site
stores session information prior to login.

Regardless, if Malory has access to the cookies on the Alice&#39;s machine,
then Malory could obtain the regenerated session ID post login as well.
 Since logout removes authenticated status from the session already, the
only attack possible is if the following things happen:

a&#41; Malory generates a legitimate session and gets it into Alice&#39;s cookies
b&#41; Alice logs in to site to perform some action
c&#41; Malory figures out when Alice is logged in and attacks before
d&#41; Alice logs out.

If Alice logs out a few minutes after she logs in, it&#39;s unlikely Malory
can perform any illicit activity.  If Alice does not, Malory can likely
use cross-site-scripting to obtain Alice&#39;s SID cookie anyway.  

Adding a session id change after login simply time-shifts the required
cross-site-scripting attack. The fix proposed gives a false sense of
security in that respect. 

Furthermore, this is a session problem, not an Authentication plugin
problem, so the fix, if there is one, should be within the session
plugin.  There is no guarantee the user is using only the Authentication
plugin for user storage, and there is no guarantee that the session is
not being used to store sensitive data without a user being
authenticated.  Finally, the Authentication plugin uses session for user
persistence only by default.  There is no hard tie to the session plugin
and thus incorporating in the Auth module a hard-tie to the session
plugin to kill this session error is inappropriate.  

There are too many variations.  If this is a concern, I think the
appropriate action is to note the possibility in the session
documentation and how to handle it in your login / logout code... but
again that doesn&#39;t solve the above issue.  

The other option is to create a Session::State module that rotates the
session id every X number of requests.  This would be much more
effective in preventing any form of attack on the session id.

Let me be clear, I am supportive of a method to change the session id
and retain the information stored in the session, but I do not believe
this should be done automatically.  If it&#39;s created as a rotating
plugin, then the developer, if concerned about this, can use it and have
faith that it will actually solve the problem.

Jay
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;24&nbsp;16:34:48&nbsp;2009</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #46318] Session fixation vulnerability</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 24 May 2009 22:34:10 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Catalyst-Plugin-Session [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;... the only attack possible is if the following things happen:
&gt;
&gt;a&#41; Malory generates a legitimate session and gets it into Alice&#39;s cookies
&gt;b&#41; Alice logs in to site to perform some action
&gt;c&#41; Malory figures out when Alice is logged in and attacks before
&gt;d&#41; Alice logs out.
&gt;
</div>Agree:
- that is pretty similar to my example with e-shop &#40;see my post above&#41;
- it perfectly fits OWASP and Wikipedia definition
- you might not agree but it simply is session fixation
To sum up: CatApp using pure &#34;authenticate&#40;&#41;&#34; without any additional
session &#34;magic&#34; is vulnerable to session fixation. I am saying &#34;magic&#34;
as there is no ready-to-use method like
$c-&gt;change_sessionid_while_keeping_session_data&#40;&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;If Alice logs out a few minutes after she logs in, it&#39;s unlikely Malory
&gt;can perform any illicit activity.  If Alice does not, Malory can likely
&gt;use cross-site-scripting to obtain Alice&#39;s SID cookie anyway. 
&gt;
&gt;Adding a session id change after login simply time-shifts the required
&gt;cross-site-scripting attack. The fix proposed gives a false sense of
&gt;security in that respect.
</div>The described session fixation does not require any XSS in CatApp.
Steeling the cookie via XSS is a sort of session hijacking attack and it
is slightly different issue. I am not saying that my proposal is the
only optimal solution, I am just saying the session fixation issue is
there and I am objecting your opinion &#34;this problem does not exists&#34;.

&lt;off topic&gt;
BTW: stealing the session cookie by Javascript &#40;e.g. the mentioned XSS&#41;
could be made significantly harder if the cookie has HTTPOnly flag set -
more info see for example <span class="clickylink"><a target="new" rel="nofollow" href="http://www.owasp.org/index.php/HTTPOnly">http://www.owasp.org/index.php/HTTPOnly</a></span>
However Catalyst::Plugin::Session::State::Cookie does not play with this
flag. I know that it does not concern this module.
&lt;/off topic&gt;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;Furthermore, this is a session problem, not an Authentication plugin
&gt;problem, so the fix, if there is one, should be within the session
&gt;plugin.  There is no guarantee the user is using only the Authentication
&gt;plugin for user storage, and there is no guarantee that the session is
&gt;not being used to store sensitive data without a user being
&gt;authenticated.  Finally, the Authentication plugin uses session for user
&gt;persistence only by default.  There is no hard tie to the session plugin
&gt;and thus incorporating in the Auth module a hard-tie to the session
&gt;plugin to kill this session error is inappropriate. 
</div>Agree but be aware of the fact that many security vulnerabilities are
quite complex and goes through many parts of the application/system.
These vulnerabilities does not care how it is organised inside the Catalyst.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;There are too many variations.  If this is a concern, I think the
&gt;appropriate action is to note the possibility in the session
&gt;documentation and how to handle it in your login / logout code... but
&gt;again that doesn&#39;t solve the above issue. 
</div>OK - let us say you will put in doc 2 possibilities:
1&#41; use just &#34;authenticate&#40;&#41;&#34; and be vulnerable to session fixation
2&#41; use &#34;authenticate&#40;&#41;&#34; + &#34;something&#40;&#41;&#34; + &#34;maybesomethingelse&#40;&#41;&#34; and be
proof against session fixation
Who will be interested in option 1&#41; ? &#40;I cannot think of any side
effects when changing just sessiocookie name&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;Let me be clear, I am supportive of a method to change the session id
&gt;and retain the information stored in the session, but I do not believe
&gt;this should be done automatically.
</div>I understand. I am not insisting on my proposal. It was just idea.

In the end it is your package :&#41;

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;03&nbsp;04:21:00&nbsp;2009</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #46318] Session fixation vulnerability</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 03 Jun 2009 10:20:36 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Catalyst-Plugin-Session [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

to sum up we have two scenarios &#40;in fact not so different&#41;

SCENARIO 1:
1&#41; the hacker takes any random sessionid value
2&#41; hacker inserts &#40;somehow&#41; this values into a cookie in victim&#39;s browser
3&#41; after the victim logs into WebApp the hacker can enter his/her session
&#40;this does not work with Catalyst Application - it is handled by
Plugin::Session&#41;

SCENARIO 2:
1&#41; the hacker goes to WebApp and gets a real sessionid &#40;just by browsing
anonymous part of WebApp&#41;
2&#41; hacker inserts &#40;somehow&#41; this values into a cookie in victim&#39;s browser
3&#41; after the victim logs into WebApp the hacker can enter his/her session
&#40;this DOES WORK with Catalyst Application using pure &#34;authenticate&#40;&#41;&#34;&#41;

As a minimum I would recommend to add a note into a doc &#40;probably to
Plugin::Authetication&#41; saying that preventing session fixation
&#40;scenarion 2&#41; can be achieved by using login action like this &#40;I have
not found out anything better&#41;:

sub login {
  my &#40; $self, $c &#41; = @_; 
...
  if &#40;$c-&gt;authenticate&#40; { username =&gt; $user, password =&gt; $pass } &#41;&#41; {
    # login OK
    $c-&gt;create_session_id&#40;&#41;;
    ...
  } else {
    # login FAILED
    ...
  }
}

It seems to be approximately what we needed. It creates a new session
with a copy of data from old session &#40;I have tested just with
State::Cookie&#41;; however the function create_session_id&#40;...&#41; is declared
as internal &#40;probably not intended to be used from outside
Plugin::Session&#41; and I am not sure if the behaviour in this case is not
more side effect than a feature. Apart from that there is a remaining
issue that after calling create_session_id&#40;...&#41; the old session is not
invalidated &#40;if I switch cookie value back the old session still works
but just with old [=pre-authenticate] session data - that is basically
no threat&#41;.

Has anybody more familiar with Plugin::Session a better idea how to
&#34;change session id and keep session data&#34; during authentication?

Thanks.

--
kmx
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;07&nbsp;18:08:53&nbsp;2009</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #46318] Session fixation vulnerability</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 08 Jul 2009 00:08:31 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Catalyst-Plugin-Session [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

would you at least agree with adding a new method into
Catalyst-Plugin-Session that can be called in order to force the
sessionid change while keeping all session data?

I have prepared my proposal as a SVN branche &#40;incl. doc + test&#41; here:

<span class="clickylink"><a target="new" rel="nofollow" href="http://dev.catalystframework.org/svnweb/Catalyst/log/Catalyst-Plugin-Session/0.00/branches/paranoid_session_fixation_protection/">http://dev.catalystframework.org/svnweb/Catalyst/log/Catalyst-Plugin-Session/0.00/branches/paranoid_session_fixation_protection/</a></span>

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;08&nbsp;17:54:04&nbsp;2009</span>
    <span class="description">bobtfish [...] bobtfish.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Branch merged. Released to CPAN as 0.25.

Thanks as always for the patches :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;08&nbsp;17:54:06&nbsp;2009</span>
    <span class="description">bobtfish [...] bobtfish.net -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
