<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #8109 for WWW-Mechanize: WWW::Mechanize back&#40;&#41; broken after reload&#40;&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #8109 for WWW-Mechanize: WWW::Mechanize back&#40;&#41; broken after reload&#40;&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/WWW-Mechanize/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/WWW-Mechanize/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/WWW-Mechanize/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/WWW-Mechanize/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/libwww-perl/WWW-Mechanize/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/WWW-Mechanize">WWW-Mechanize CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">8109</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/WWW-Mechanize/Active/">WWW-Mechanize</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">MARKSTOS [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
perlbug20041024.z.jp [...] xoxy.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-36214-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-36215-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;24&nbsp;19:34:05&nbsp;2004</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> WWW::Mechanize back&#40;&#41; broken after reload&#40;&#41;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">According to the WWW::Mechanize documentation, $mech-&gt;back&#40;&#41; is ``the
equivalent of hitting the &#34;back&#34; button in a browser.&#39;&#39; Now, in a
browser, hitting Reload doesn&#39;t affect the history.  But calling                $mech-&gt;reload&#40;&#41; *does* affect the history: it pushes the current page on
to the history stack again.  So if you press Reload followed by Back in
a browser, it takes you to the previous page.  But if you call 
$mech-&gt;reload&#40;&#41; followed by $mech-&gt;back&#40;&#41;, you stay at the same page.
The test program below demonstrates this.

Either 1&#41; the documentation for $mech-&gt;back&#40;&#41; should be updated to 
reflect this anomaly, or 2&#41; the code should be changed so that 
WWW::Mechanize behaves more like a browser. I prefer option 2&#41;.

#!/usr/bin/perl
use WWW::Mechanize;
my $mech = WWW::Mechanize-&gt;new&#40;&#41;;
$mech-&gt;get&#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.yahoo.com">http://www.yahoo.com</a></span>&#34;&#41;;
$mech-&gt;get&#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.google.com">http://www.google.com</a></span>&#34;&#41;;
$mech-&gt;reload&#40;&#41;;
$mech-&gt;back&#40;&#41;;
print $mech-&gt;title, &#34;\n&#34;; # should print Yahoo!, but prints Google instead
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;24&nbsp;21:10:41&nbsp;2004</span>
    <span class="description">MARKSTOS [...] cpan.org -  Severity Normal added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;24&nbsp;21:13:18&nbsp;2004</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> www-mechanize-development [...] lists.sourceforge.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Sun Oct 24 19:34:05 2004]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; According to the WWW::Mechanize documentation, $mech-&gt;back&#40;&#41; is ``the
&gt; equivalent of hitting the &#34;back&#34; button in a browser.&#39;&#39; Now, in a
&gt; browser, hitting Reload doesn&#39;t affect the history.  But calling
&gt; $mech-&gt;reload&#40;&#41; *does* affect the history: it pushes the current page
&gt; on
&gt; to the history stack again.  So if you press Reload followed by Back
&gt; in
&gt; a browser, it takes you to the previous page.  But if you call
&gt; $mech-&gt;reload&#40;&#41; followed by $mech-&gt;back&#40;&#41;, you stay at the same page.
&gt; The test program below demonstrates this.
&gt; 
&gt; Either 1&#41; the documentation for $mech-&gt;back&#40;&#41; should be updated to
&gt; reflect this anomaly, or 2&#41; the code should be changed so that
&gt; WWW::Mechanize behaves more like a browser. I prefer option 2&#41;.
&gt; 
&gt; #!/usr/bin/perl
&gt; use WWW::Mechanize;
&gt; my $mech = WWW::Mechanize-&gt;new&#40;&#41;;
&gt; $mech-&gt;get&#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.yahoo.com">http://www.yahoo.com</a></span>&#34;&#41;;
&gt; $mech-&gt;get&#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.google.com">http://www.google.com</a></span>&#34;&#41;;
&gt; $mech-&gt;reload&#40;&#41;;
&gt; $mech-&gt;back&#40;&#41;;
&gt; print $mech-&gt;title, &#34;\n&#34;; # should print Yahoo!, but prints Google
&gt; instead
</div>
I agree the this sounds like a bug, and I&#39;m in favor of the code rather
than the docs being update. You can submit a patch yourself &#40;preferably
updating the test suite as well&#41;, or another Mech user/developer will
get to it eventually. 

  Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;25&nbsp;13:19:05&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here&#39;s another serious problem with $mech-&gt;back&#40;&#41;: after using
it even once, Mech no longer uses cookies. In fact, its cookie_jar
object has been undefined, as shown by this test script:               
                        
                                                                       
        
#!/usr/bin/perl -w                                                     
        
use strict;                                                            
        
use WWW::Mechanize;                                                    
        
my $mech = WWW::Mechanize-&gt;new&#40;cookie_jar =&gt; {}&#41;;                      
        
$mech-&gt;get&#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.yahoo.com">http://www.yahoo.com</a></span>&#34;&#41;;                                    
        
$mech-&gt;get&#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.google.com">http://www.google.com</a></span>&#34;&#41;;                                   
        
print &#34;before=$mech-&gt;{&#39;cookie_jar&#39;}\n&#34;;                                
        
$mech-&gt;back&#40;&#41;;                                                         
        
print &#34;after=$mech-&gt;{&#39;cookie_jar&#39;}\n&#34;;                                 
        
                                                                       
        
# One would expect that the cookie jar would be the same before and
after       
# $mech-&gt;back&#40;&#41; is called.  But instead, it prints:                    
        
#    before=HTTP::Cookies=HASH&#40;0x8166d88&#41;                              
        
#    Use of uninitialized value in concatenation &#40;.&#41; or string at mtest
line 9. 
#    after=
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;02&nbsp;07:35:05&nbsp;2004</span>
    <span class="description">dom [...] idealx.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 02 Nov 2004 13:37:16 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dominique Quatravaux &lt;dom [...] idealx.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-www-mechanize [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [cpan #8109] back&#40;&#41; reload&#40;&#41;ed!</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Dear Mechanists,

Here&#39;s the patch that closes #8109: the back&#40;&#41; button in Mech now
behaves according to expectation, documentation and testation.

Best of everything,

- --
Dominique QUATRAVAUX                           Ingénieur senior
01 44 42 00 08                                 IDEALX

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.2.4 &#40;GNU/Linux&#41;
Comment: Using GnuPG with Thunderbird - <span class="clickylink"><a target="new" rel="nofollow" href="http://enigmail.mozdev.org">http://enigmail.mozdev.org</a></span>

iD8DBQFBh398MJAKAU3mjcsRAncnAJ4yQerI7vJpgt9vODEw36s9v5xsDgCePuhd
qfRYmz7UFWGecx1bLWta6jI=
=LyVJ
-----END PGP SIGNATURE-----
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -Nr -U3 --exclude=CVS www-mechanize.WALK-TREE-CONTEXT/lib/WWW/Mechanize.pm www-mechanize/lib/WWW/Mechanize.pm
--- www-mechanize.WALK-TREE-CONTEXT/lib/WWW/Mechanize.pm	Tue Nov  2 13:24:48 2004
+++ www-mechanize/lib/WWW/Mechanize.pm	Tue Nov  2 13:29:44 2004
@@ -325,7 +325,7 @@
 =head2 $mech-&gt;reload&#40;&#41;
 
 Acts like the reload button in a browser: Reperforms the current
-request.
+request. The history &#40;as per the L&lt;/back&gt; method&#41; is not altered.
 
 Returns the L&lt;HTTP::Response&gt; object from the reload, or C&lt;undef&gt;
 if there&#39;s no current request.
@@ -337,7 +337,8 @@
 
     return unless $self-&gt;{req};
 
-    return $self-&gt;request&#40; $self-&gt;{req} &#41;;
+	local $self-&gt;{inhibit_page_stack} = 1;
+    return $self-&gt;request&#40; $self-&gt;{req}&#41;;
 }
 
 =head2 $mech-&gt;back&#40;&#41;
@@ -2024,12 +2222,19 @@
 sub _push_page_stack {
     my $self = shift;
 
+	# Hook for reload&#40;&#41; and maybe future code &#40;e.g. 302 chasing,
+	# frames&#41; that may want to fetch stuff without altering the history.
+	return 1 if $self-&gt;{inhibit_page_stack};
     # Don&#39;t push anything if it&#39;s a virgin object
     if &#40; $self-&gt;{res} &#41; {
         my $save_stack = $self-&gt;{page_stack};
         $self-&gt;{page_stack} = [];
 
-        push&#40; @$save_stack, $self-&gt;clone &#41;;
+		my $clone = $self-&gt;clone;
+		# Huh, LWP::UserAgent-&gt;clone&#40;&#41; ditches cookie_jar? Copy it over now.
+		$clone-&gt;{cookie_jar} = $self-&gt;cookie_jar;
+        push&#40; @$save_stack, $clone &#41;;
+
         if &#40; $self-&gt;stack_depth &gt; 0 &#41; {
             while &#40; @$save_stack &gt; $self-&gt;stack_depth &#41; {
                 shift @$save_stack;
@@ -2043,6 +2248,10 @@
 
 sub _pop_page_stack {
     my $self = shift;
+
+	# Hook for reload&#40;&#41; and maybe future code &#40;e.g. 302 chasing,
+	# frames&#41; that may want to fetch stuff without altering the history.
+	return 1 if $self-&gt;{inhibit_page_stack};
 
     if &#40;@{$self-&gt;{page_stack}}&#41; {
         my $popped = pop @{$self-&gt;{page_stack}};
diff -Nr -U3 --exclude=CVS www-mechanize.WALK-TREE-CONTEXT/t/local/back.t www-mechanize/t/local/back.t
--- www-mechanize.WALK-TREE-CONTEXT/t/local/back.t	Thu Jan  1 01:00:00 1970
+++ www-mechanize/t/local/back.t	Tue Nov  2 12:38:39 2004
@@ -0,0 +1,168 @@
+#!perl
+
+use strict;
+use Test::More tests =&gt; 38;
+use lib &#39;t/local&#39;;
+use LocalServer;
+use HTTP::Daemon;
+use HTTP::Response;
+
+=head1 NAME
+
+=head1 SYNOPSIS
+
+This tests Mech&#39;s Back &#34;button&#34;. Tests were converted from t/live/back.t,
+and subsequently enriched to deal with RT ticket #8109.
+
+=cut
+
+BEGIN {
+    use_ok&#40; &#39;WWW::Mechanize&#39; &#41;;
+	delete @ENV{ qw&#40; http_proxy HTTP_PROXY PATH IFS
+					 CDPATH ENV BASH_ENV&#41; };
+
+}
+
+my $mech = WWW::Mechanize-&gt;new&#40;cookie_jar =&gt; {}&#41;;
+isa_ok&#40; $mech, &#34;WWW::Mechanize&#34; &#41;;
+ok&#40;defined&#40;$mech-&gt;cookie_jar&#40;&#41;&#41;,
+   &#39;this $mech starts with a cookie jar&#39;&#41;;
+
+isa_ok&#40;&#40;my $server = LocalServer-&gt;spawn&#40;html =&gt; &lt;&lt;&#39;HTML&#39;&#41;&#41;, &#34;LocalServer&#34;&#41;;
+&lt;html&gt;
+&lt;head&gt;&lt;title&gt;%s&lt;/title&gt;&lt;/head&gt;
+&lt;body&gt;Whatever.
+&lt;a href=&#34;images/&#34;&gt;Images&lt;/a&gt;
+&lt;a href=&#34;/scripts&#34;&gt;Scripts&lt;/a&gt;
+&lt;a href=&#34;/ports/&#34;&gt;Ports&lt;/a&gt;
+&lt;a href=&#34;modules/&#34;&gt;Modules&lt;/a&gt;
+&lt;form action=&#34;/search.cgi&#34;&gt;
+&lt;input type=&#34;text&#34; name=&#34;q&#34;&gt;
+&lt;input type=&#34;submit&#34;&gt;
+&lt;/form&gt;
+&lt;/body&gt;
+&lt;/html&gt;
+HTML
+
+$mech-&gt;get&#40;$server-&gt;url&#41;;
+ok&#40; $mech-&gt;success, &#39;Fetched OK&#39; &#41;;
+
+my $first_base = $mech-&gt;base;
+my $title = $mech-&gt;title;
+
+$mech-&gt;follow_link&#40; n=&gt;2 &#41;;
+ok&#40; $mech-&gt;success, &#39;Followed OK&#39; &#41;;
+
+$mech-&gt;back&#40;&#41;;
+is&#40; $mech-&gt;base, $first_base, &#34;Did the base get set back?&#34; &#41;;
+is&#40; $mech-&gt;title, $title, &#34;Title set back?&#34; &#41;;
+
+$mech-&gt;follow&#40; &#34;Images&#34; &#41;;
+ok&#40; $mech-&gt;success, &#39;Followed OK&#39; &#41;;
+
+$mech-&gt;back&#40;&#41;;
+is&#40; $mech-&gt;base, $first_base, &#34;Did the base get set back?&#34; &#41;;
+is&#40; $mech-&gt;title, $title, &#34;Title set back?&#34; &#41;;
+
+is&#40; scalar @{$mech-&gt;{page_stack}}, 0, &#34;Pre-search check&#34; &#41;;
+$mech-&gt;submit_form&#40;
+    fields =&gt; { &#39;q&#39; =&gt; &#34;perl&#34; },
+&#41;;
+ok&#40; $mech-&gt;success, &#34;Searched for Perl&#34; &#41;;
+like&#40; $mech-&gt;title, qr/search.cgi/, &#34;Right page title&#34; &#41;;
+is&#40; scalar @{$mech-&gt;{page_stack}}, 1, &#34;POST is in the stack&#34; &#41;;
+
+$mech-&gt;head&#40; $server-&gt;url &#41;;
+ok&#40; $mech-&gt;success, &#34;HEAD succeeded&#34; &#41;;
+is&#40; scalar @{$mech-&gt;{page_stack}}, 1, &#34;HEAD is not in the stack&#34; &#41;;
+
+$mech-&gt;back&#40;&#41;;
+ok&#40; $mech-&gt;success, &#34;Back&#34; &#41;;
+is&#40; $mech-&gt;base, $first_base, &#34;Did the base get set back?&#34; &#41;;
+is&#40; $mech-&gt;title, $title, &#34;Title set back?&#34; &#41;;
+is&#40; scalar @{$mech-&gt;{page_stack}}, 0, &#34;Post-search check&#34; &#41;;
+
+=head2 Back and misc. internal fields
+
+RT ticket #8109 reported that back&#40;&#41; is broken after reload&#40;&#41;, and
+that the cookie_jar was also damaged by back&#40;&#41;. We test for that:
+reload&#40;&#41; should not alter the back&#40;&#41; stack, and the cookie jar should
+not be versioned &#40;once a cookie is set, hitting the back button in a
+browser does not cause it to go away&#41;.
+
+=cut
+
+$mech-&gt;follow&#40; &#34;Images&#34; &#41;;
+$mech-&gt;reload&#40;&#41;;
+$mech-&gt;back&#40;&#41;;
+is&#40;$mech-&gt;title, $title, &#34;reload&#40;&#41; does not push page to stack&#34; &#41;;
+
+ok&#40;defined&#40;$mech-&gt;cookie_jar&#40;&#41;&#41;,
+   &#39;$mech still has a cookie jar after a number of back&#40;&#41;&#39;&#41;;
+
+# Now some other weird stuff. Start with a fresh history by recreating
+# $mech.
+SKIP: {
+    eval &#34;use Test::Memory::Cycle&#34;;
+    skip &#34;Test::Memory::Cycle not installed&#34;, 1 if $@;
+
+    memory_cycle_ok&#40; $mech, &#34;No memory cycles found&#34; &#41;;
+}
+
+$mech = WWW::Mechanize-&gt;new&#40;&#41;;
+isa_ok&#40; $mech, &#34;WWW::Mechanize&#34; &#41;;
+$mech-&gt;get&#40; $server-&gt;url &#41;;
+ok&#40; $mech-&gt;success, &#39;Got root URL&#39; &#41;;
+
+my @links = qw&#40;
+    /scripts
+    /ports/
+    modules/
+&#41;;
+
+is&#40; scalar @{$mech-&gt;{page_stack}}, 0, &#34;Pre-404 check&#34; &#41;;
+
+my $server404 = HTTP::Daemon-&gt;new or die;
+
+die &#34;Cannot fork&#34; if &#40;! defined &#40;my $pid404 = fork&#40;&#41;&#41;&#41;;
+END {
+	local $?;
+	kill KILL =&gt; $pid404; # Extreme prejudice intended, because we do not
+	# want the global cleanup to be done twice.
+}
+
+if &#40;! $pid404&#41; { # Fake HTTP server code: a true 404-compliant server!
+	while&#40;my $c = $server404-&gt;accept&#40;&#41;&#41; {
+		while&#40;$c-&gt;get_request&#40;&#41;&#41; {
+			$c-&gt;send_response&#40;new HTTP::Response&#40;404&#41;&#41;;
+			$c-&gt;close&#40;&#41;;
+		}
+	}
+}
+
+$mech-&gt;get&#40;$server404-&gt;url&#41;;
+is&#40; $mech-&gt;status, 404 , &#34;404 check&#34;&#41;;
+
+is&#40; scalar @{$mech-&gt;{page_stack}}, 1, &#34;Even 404s get on the stack&#34; &#41;;
+
+$mech-&gt;back&#40;&#41;;
+is&#40; $mech-&gt;uri, $server-&gt;url, &#34;Back from the 404&#34; &#41;;
+is&#40; scalar @{$mech-&gt;{page_stack}}, 0, &#34;Post-404 check&#34; &#41;;
+
+for my $link &#40; @links &#41; {
+    $mech-&gt;get&#40; $link &#41;;
+	warn $mech-&gt;status&#40;&#41; if &#40;! $mech-&gt;success&#40;&#41;&#41;;
+    is&#40; $mech-&gt;status, 200, &#34;Get $link&#34; &#41;;
+
+    $mech-&gt;back&#40;&#41;;
+    is&#40; $mech-&gt;uri, $server-&gt;url, &#34;Back from $link&#34; &#41;;
+}
+
+SKIP: {
+    eval &#34;use Test::Memory::Cycle&#34;;
+    skip &#34;Test::Memory::Cycle not installed&#34;, 1 if $@;
+
+    memory_cycle_ok&#40; $mech, &#34;No memory cycles found&#34; &#41;;
+}
+
+
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;02&nbsp;11:27:58&nbsp;2004</span>
    <span class="description">dom [...] idealx.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 02 Nov 2004 17:30:16 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dominique Quatravaux &lt;dom [...] idealx.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-www-mechanize [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [cpan #8109] back&#40;&#41; reload&#40;&#41;ed, sans inhibition</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Hello,

Here is my renewed patch on the same issue, please ignore the previous
one. I&#39;ve taken Andy&#39;s comment into account, by removing the
- -&gt;{inhibit_page_stack} flag and refactoring -&gt;request&#40;&#41; into
- -&gt;_push_page_stack&#40;&#41; followed by -&gt;_update_page&#40;&#41; &#40;new method&#41;.

Best regards,


- --
Dominique QUATRAVAUX                           Ingénieur senior
01 44 42 00 08                                 IDEALX

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.2.4 &#40;GNU/Linux&#41;
Comment: Using GnuPG with Thunderbird - <span class="clickylink"><a target="new" rel="nofollow" href="http://enigmail.mozdev.org">http://enigmail.mozdev.org</a></span>

iD8DBQFBh7YYMJAKAU3mjcsRAmXjAJ9BDj/OkdEVKLn9wC9n7EcOf/MVuwCfS37n
Rh/UQcvkIZW8aHrh7B4wpIU=
=gvXY
-----END PGP SIGNATURE-----
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -Nr -U3 --exclude=CVS www-mechanize.WALK-TREE-CONTEXT/lib/WWW/Mechanize.pm www-mechanize/lib/WWW/Mechanize.pm
--- www-mechanize.WALK-TREE-CONTEXT/lib/WWW/Mechanize.pm	Tue Nov  2 13:24:48 2004
+++ www-mechanize/lib/WWW/Mechanize.pm	Tue Nov  2 17:09:24 2004
@@ -324,8 +320,8 @@
 
 =head2 $mech-&gt;reload&#40;&#41;
 
-Acts like the reload button in a browser: Reperforms the current
-request.
+Acts like the reload button in a browser: reperforms the current
+request. The history &#40;as per the L&lt;/back&gt; method&#41; is not altered.
 
 Returns the L&lt;HTTP::Response&gt; object from the reload, or C&lt;undef&gt;
 if there&#39;s no current request.
@@ -335,9 +331,9 @@
 sub reload {
     my $self = shift;
 
-    return unless $self-&gt;{req};
+    return unless defined&#40;my $request = $self-&gt;{req}&#41;;
 
-    return $self-&gt;request&#40; $self-&gt;{req} &#41;;
+	$self-&gt;_update_page&#40;$request, $self-&gt;_make_request&#40; $request, @_ &#41;&#41;;
 }
 
 =head2 $mech-&gt;back&#40;&#41;
@@ -1686,35 +1866,8 @@
         $self-&gt;_push_page_stack&#40;&#41;;
     }
 
-    $self-&gt;{req} = $request;
-    $self-&gt;{redirected_uri} = $request-&gt;uri-&gt;as_string;
-
-    my $res = $self-&gt;{res} = $self-&gt;_make_request&#40; $request, @_ &#41;;
-
-    # These internal hash elements should be dropped in favor of
-    # the accessors soon. -- 1/19/03
-    $self-&gt;{status}  = $res-&gt;code;
-    $self-&gt;{base}    = $res-&gt;base;
-    $self-&gt;{ct}      = $res-&gt;content_type || &#34;&#34;;
-
-    if &#40; $res-&gt;is_success &#41; {
-        $self-&gt;{uri} = $self-&gt;{redirected_uri};
-        $self-&gt;{last_uri} = $self-&gt;{uri};
-    } else {
-        if &#40; $self-&gt;{autocheck} &#41; {
-            $self-&gt;die&#40; &#34;Error &#34;, $request-&gt;method, &#34;ing &#34;, $request-&gt;uri, &#34;: &#34;, $res-&gt;message &#41;;
-        }
-    }
-
-	$self-&gt;_reset_page;
-	if &#40;$self-&gt;is_html&#41; {
-		$self-&gt;update_html&#40;$res-&gt;content&#41;;
-	} else {
-		$self-&gt;{content} = $res-&gt;content;
-	}
-
-    return $res;
-} # request
+	$self-&gt;_update_page&#40;$request, $self-&gt;_make_request&#40; $request, @_ &#41;&#41;;
+}
 
 =head2 $mech-&gt;update_html&#40; $html &#41;
 
@@ -1926,6 +2103,48 @@
     return;
 }
 
+=head2 $mech-&gt;_update_page&#40;$request, $response&#41;
+
+Updates all internal variables in $mech as if $request was just
+performed, and returned $response. The page stack is B&lt;not&gt; altered by
+this method, it is up to caller &#40;e.g. L&lt;/request&gt;&#41; to do that.
+
+=cut
+
+sub _update_page {
+	my &#40;$self, $request, $res&#41; = @_;
+
+    $self-&gt;{req} = $request;
+    $self-&gt;{redirected_uri} = $request-&gt;uri-&gt;as_string;
+
+	$self-&gt;{res} = $res;
+
+    # These internal hash elements should be dropped in favor of
+    # the accessors soon. -- 1/19/03
+    $self-&gt;{status}  = $res-&gt;code;
+    $self-&gt;{base}    = $res-&gt;base;
+    $self-&gt;{ct}      = $res-&gt;content_type || &#34;&#34;;
+
+    if &#40; $res-&gt;is_success &#41; {
+        $self-&gt;{uri} = $self-&gt;{redirected_uri};
+        $self-&gt;{last_uri} = $self-&gt;{uri};
+    } else {
+        if &#40; $self-&gt;{autocheck} &#41; {
+            $self-&gt;die&#40; &#34;Error &#34;, $request-&gt;method, &#34;ing &#34;, $request-&gt;uri, &#34;: &#34;, $res-&gt;message &#41;;
+        }
+    }
+
+	$self-&gt;_reset_page;
+	if &#40;$self-&gt;is_html&#41; {
+		$self-&gt;update_html&#40;$res-&gt;content&#41;;
+	} else {
+		$self-&gt;{content} = $res-&gt;content;
+	}
+
+    return $res;
+} # _update_state
+
+
 =head2 $mech-&gt;_extract_links&#40;&#41;
 
 Extracts links from the content of a webpage, and populates the C&lt;{links}&gt;
@@ -2029,7 +2248,11 @@
         my $save_stack = $self-&gt;{page_stack};
         $self-&gt;{page_stack} = [];
 
-        push&#40; @$save_stack, $self-&gt;clone &#41;;
+		my $clone = $self-&gt;clone;
+		# Huh, LWP::UserAgent-&gt;clone&#40;&#41; ditches cookie_jar? Copy it over now.
+		$clone-&gt;{cookie_jar} = $self-&gt;cookie_jar;
+        push&#40; @$save_stack, $clone &#41;;
+
         if &#40; $self-&gt;stack_depth &gt; 0 &#41; {
             while &#40; @$save_stack &gt; $self-&gt;stack_depth &#41; {
                 shift @$save_stack;
diff -Nr -U3 --exclude=CVS www-mechanize.WALK-TREE-CONTEXT/t/local/back.t www-mechanize/t/local/back.t
--- www-mechanize.WALK-TREE-CONTEXT/t/local/back.t	Thu Jan  1 01:00:00 1970
+++ www-mechanize/t/local/back.t	Tue Nov  2 12:38:39 2004
@@ -0,0 +1,168 @@
+#!perl
+
+use strict;
+use Test::More tests =&gt; 38;
+use lib &#39;t/local&#39;;
+use LocalServer;
+use HTTP::Daemon;
+use HTTP::Response;
+
+=head1 NAME
+
+=head1 SYNOPSIS
+
+This tests Mech&#39;s Back &#34;button&#34;. Tests were converted from t/live/back.t,
+and subsequently enriched to deal with RT ticket #8109.
+
+=cut
+
+BEGIN {
+    use_ok&#40; &#39;WWW::Mechanize&#39; &#41;;
+	delete @ENV{ qw&#40; http_proxy HTTP_PROXY PATH IFS
+					 CDPATH ENV BASH_ENV&#41; };
+
+}
+
+my $mech = WWW::Mechanize-&gt;new&#40;cookie_jar =&gt; {}&#41;;
+isa_ok&#40; $mech, &#34;WWW::Mechanize&#34; &#41;;
+ok&#40;defined&#40;$mech-&gt;cookie_jar&#40;&#41;&#41;,
+   &#39;this $mech starts with a cookie jar&#39;&#41;;
+
+isa_ok&#40;&#40;my $server = LocalServer-&gt;spawn&#40;html =&gt; &lt;&lt;&#39;HTML&#39;&#41;&#41;, &#34;LocalServer&#34;&#41;;
+&lt;html&gt;
+&lt;head&gt;&lt;title&gt;%s&lt;/title&gt;&lt;/head&gt;
+&lt;body&gt;Whatever.
+&lt;a href=&#34;images/&#34;&gt;Images&lt;/a&gt;
+&lt;a href=&#34;/scripts&#34;&gt;Scripts&lt;/a&gt;
+&lt;a href=&#34;/ports/&#34;&gt;Ports&lt;/a&gt;
+&lt;a href=&#34;modules/&#34;&gt;Modules&lt;/a&gt;
+&lt;form action=&#34;/search.cgi&#34;&gt;
+&lt;input type=&#34;text&#34; name=&#34;q&#34;&gt;
+&lt;input type=&#34;submit&#34;&gt;
+&lt;/form&gt;
+&lt;/body&gt;
+&lt;/html&gt;
+HTML
+
+$mech-&gt;get&#40;$server-&gt;url&#41;;
+ok&#40; $mech-&gt;success, &#39;Fetched OK&#39; &#41;;
+
+my $first_base = $mech-&gt;base;
+my $title = $mech-&gt;title;
+
+$mech-&gt;follow_link&#40; n=&gt;2 &#41;;
+ok&#40; $mech-&gt;success, &#39;Followed OK&#39; &#41;;
+
+$mech-&gt;back&#40;&#41;;
+is&#40; $mech-&gt;base, $first_base, &#34;Did the base get set back?&#34; &#41;;
+is&#40; $mech-&gt;title, $title, &#34;Title set back?&#34; &#41;;
+
+$mech-&gt;follow&#40; &#34;Images&#34; &#41;;
+ok&#40; $mech-&gt;success, &#39;Followed OK&#39; &#41;;
+
+$mech-&gt;back&#40;&#41;;
+is&#40; $mech-&gt;base, $first_base, &#34;Did the base get set back?&#34; &#41;;
+is&#40; $mech-&gt;title, $title, &#34;Title set back?&#34; &#41;;
+
+is&#40; scalar @{$mech-&gt;{page_stack}}, 0, &#34;Pre-search check&#34; &#41;;
+$mech-&gt;submit_form&#40;
+    fields =&gt; { &#39;q&#39; =&gt; &#34;perl&#34; },
+&#41;;
+ok&#40; $mech-&gt;success, &#34;Searched for Perl&#34; &#41;;
+like&#40; $mech-&gt;title, qr/search.cgi/, &#34;Right page title&#34; &#41;;
+is&#40; scalar @{$mech-&gt;{page_stack}}, 1, &#34;POST is in the stack&#34; &#41;;
+
+$mech-&gt;head&#40; $server-&gt;url &#41;;
+ok&#40; $mech-&gt;success, &#34;HEAD succeeded&#34; &#41;;
+is&#40; scalar @{$mech-&gt;{page_stack}}, 1, &#34;HEAD is not in the stack&#34; &#41;;
+
+$mech-&gt;back&#40;&#41;;
+ok&#40; $mech-&gt;success, &#34;Back&#34; &#41;;
+is&#40; $mech-&gt;base, $first_base, &#34;Did the base get set back?&#34; &#41;;
+is&#40; $mech-&gt;title, $title, &#34;Title set back?&#34; &#41;;
+is&#40; scalar @{$mech-&gt;{page_stack}}, 0, &#34;Post-search check&#34; &#41;;
+
+=head2 Back and misc. internal fields
+
+RT ticket #8109 reported that back&#40;&#41; is broken after reload&#40;&#41;, and
+that the cookie_jar was also damaged by back&#40;&#41;. We test for that:
+reload&#40;&#41; should not alter the back&#40;&#41; stack, and the cookie jar should
+not be versioned &#40;once a cookie is set, hitting the back button in a
+browser does not cause it to go away&#41;.
+
+=cut
+
+$mech-&gt;follow&#40; &#34;Images&#34; &#41;;
+$mech-&gt;reload&#40;&#41;;
+$mech-&gt;back&#40;&#41;;
+is&#40;$mech-&gt;title, $title, &#34;reload&#40;&#41; does not push page to stack&#34; &#41;;
+
+ok&#40;defined&#40;$mech-&gt;cookie_jar&#40;&#41;&#41;,
+   &#39;$mech still has a cookie jar after a number of back&#40;&#41;&#39;&#41;;
+
+# Now some other weird stuff. Start with a fresh history by recreating
+# $mech.
+SKIP: {
+    eval &#34;use Test::Memory::Cycle&#34;;
+    skip &#34;Test::Memory::Cycle not installed&#34;, 1 if $@;
+
+    memory_cycle_ok&#40; $mech, &#34;No memory cycles found&#34; &#41;;
+}
+
+$mech = WWW::Mechanize-&gt;new&#40;&#41;;
+isa_ok&#40; $mech, &#34;WWW::Mechanize&#34; &#41;;
+$mech-&gt;get&#40; $server-&gt;url &#41;;
+ok&#40; $mech-&gt;success, &#39;Got root URL&#39; &#41;;
+
+my @links = qw&#40;
+    /scripts
+    /ports/
+    modules/
+&#41;;
+
+is&#40; scalar @{$mech-&gt;{page_stack}}, 0, &#34;Pre-404 check&#34; &#41;;
+
+my $server404 = HTTP::Daemon-&gt;new or die;
+
+die &#34;Cannot fork&#34; if &#40;! defined &#40;my $pid404 = fork&#40;&#41;&#41;&#41;;
+END {
+	local $?;
+	kill KILL =&gt; $pid404; # Extreme prejudice intended, because we do not
+	# want the global cleanup to be done twice.
+}
+
+if &#40;! $pid404&#41; { # Fake HTTP server code: a true 404-compliant server!
+	while&#40;my $c = $server404-&gt;accept&#40;&#41;&#41; {
+		while&#40;$c-&gt;get_request&#40;&#41;&#41; {
+			$c-&gt;send_response&#40;new HTTP::Response&#40;404&#41;&#41;;
+			$c-&gt;close&#40;&#41;;
+		}
+	}
+}
+
+$mech-&gt;get&#40;$server404-&gt;url&#41;;
+is&#40; $mech-&gt;status, 404 , &#34;404 check&#34;&#41;;
+
+is&#40; scalar @{$mech-&gt;{page_stack}}, 1, &#34;Even 404s get on the stack&#34; &#41;;
+
+$mech-&gt;back&#40;&#41;;
+is&#40; $mech-&gt;uri, $server-&gt;url, &#34;Back from the 404&#34; &#41;;
+is&#40; scalar @{$mech-&gt;{page_stack}}, 0, &#34;Post-404 check&#34; &#41;;
+
+for my $link &#40; @links &#41; {
+    $mech-&gt;get&#40; $link &#41;;
+	warn $mech-&gt;status&#40;&#41; if &#40;! $mech-&gt;success&#40;&#41;&#41;;
+    is&#40; $mech-&gt;status, 200, &#34;Get $link&#34; &#41;;
+
+    $mech-&gt;back&#40;&#41;;
+    is&#40; $mech-&gt;uri, $server-&gt;url, &#34;Back from $link&#34; &#41;;
+}
+
+SKIP: {
+    eval &#34;use Test::Memory::Cycle&#34;;
+    skip &#34;Test::Memory::Cycle not installed&#34;, 1 if $@;
+
+    memory_cycle_ok&#40; $mech, &#34;No memory cycles found&#34; &#41;;
+}
+
+
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;03&nbsp;20:43:56&nbsp;2004</span>
    <span class="description">MARKSTOS [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;03&nbsp;22:26:17&nbsp;2004</span>
    <span class="description">MARKSTOS [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;09&nbsp;13:29:00&nbsp;2004</span>
    <span class="description">dom [...] idealx.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 09 Nov 2004 19:31:35 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dominique Quatravaux &lt;dom [...] idealx.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-www-mechanize [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [cpan #8109] back&#40;&#41; reload&#40;&#41;ed, sans inhibition</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Dear Mechanists,

Here is the new-and-improved patch that takes Andy&#39;s comment into
account: $mech-&gt;{inhibit_page_stack} is gone, and a new refactored
function appears.

Please apply to CVS HEAD. &#40;Off-topic note: I just spent some time
installing svk and this is just another insanely cool Perl package! It
made my keeping track of pending patches much easier. Well worth a try
for all folks working concurrently on lots of FOSS projects IMHO&#41;

Regards,

- --
Dominique QUATRAVAUX                           Ingénieur senior
01 44 42 00 08                                 IDEALX

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.2.4 &#40;GNU/Linux&#41;
Comment: Using GnuPG with Thunderbird - <span class="clickylink"><a target="new" rel="nofollow" href="http://enigmail.mozdev.org">http://enigmail.mozdev.org</a></span>

iD8DBQFBkQ0HMJAKAU3mjcsRAvIHAJ92+ZLT9Sfgwmar1uDcwlS2MZCkRwCffxP4
aGFogppkEDkHw2XS3e2Ra1Q=
=j70l
-----END PGP SIGNATURE-----
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;09&nbsp;13:29:01&nbsp;2004</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;09&nbsp;13:31:54&nbsp;2004</span>
    <span class="description">dom [...] idealx.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 09 Nov 2004 19:34:30 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dominique Quatravaux &lt;dom [...] idealx.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-www-mechanize [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [cpan #8109] back&#40;&#41; reload&#40;&#41;ed, sans inhibition</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Yeah, I know, the attachment :-/...


- --
Dominique QUATRAVAUX                           Ingénieur senior
01 44 42 00 08                                 IDEALX

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.2.4 &#40;GNU/Linux&#41;
Comment: Using GnuPG with Thunderbird - <span class="clickylink"><a target="new" rel="nofollow" href="http://enigmail.mozdev.org">http://enigmail.mozdev.org</a></span>

iD8DBQFBkQ21MJAKAU3mjcsRAq3vAJ9hn0tdip1U8ssHnPEyYiF/yJPktwCfUb9J
oLfqDiyi8/oEZ+Doj+gTRaw=
=/wVV
-----END PGP SIGNATURE-----
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">=== lib/WWW/Mechanize.pm
==================================================================
--- lib/WWW/Mechanize.pm  &#40;revision 389&#41;
+++ lib/WWW/Mechanize.pm  &#40;revision 390&#41;
@@ -324,7 +324,7 @@
 
 =head2 $mech-&gt;reload&#40;&#41;
 
-Acts like the reload button in a browser: Reperforms the current
+Acts like the reload button in a browser: reperforms the current
 request. The history &#40;as per the L&lt;back&gt; method&#41; is not altered.
 
 Returns the L&lt;HTTP::Response&gt; object from the reload, or C&lt;undef&gt;
@@ -337,8 +337,8 @@
 
     return unless $self-&gt;{req};
 
-    local $self-&gt;{inhibit_page_stack} = 1;
-    return $self-&gt;request&#40; $self-&gt;{req}&#41;;
+    return unless defined&#40;my $request = $self-&gt;{req}&#41;;
+	$self-&gt;_update_page&#40;$request, $self-&gt;_make_request&#40; $request, @_ &#41;&#41;;
 }
 
 =head2 $mech-&gt;back&#40;&#41;
@@ -1568,36 +1568,9 @@
         $self-&gt;_push_page_stack&#40;&#41;;
     }
 
-    $self-&gt;{req} = $request;
-    $self-&gt;{redirected_uri} = $request-&gt;uri-&gt;as_string;
+	$self-&gt;_update_page&#40;$request, $self-&gt;_make_request&#40; $request, @_ &#41;&#41;;
+}
 
-    my $res = $self-&gt;{res} = $self-&gt;_make_request&#40; $request, @_ &#41;;
-
-    # These internal hash elements should be dropped in favor of
-    # the accessors soon. -- 1/19/03
-    $self-&gt;{status}  = $res-&gt;code;
-    $self-&gt;{base}    = $res-&gt;base;
-    $self-&gt;{ct}      = $res-&gt;content_type || &#34;&#34;;
-
-    if &#40; $res-&gt;is_success &#41; {
-        $self-&gt;{uri} = $self-&gt;{redirected_uri};
-        $self-&gt;{last_uri} = $self-&gt;{uri};
-    } else {
-        if &#40; $self-&gt;{autocheck} &#41; {
-            $self-&gt;die&#40; &#34;Error &#34;, $request-&gt;method, &#34;ing &#34;, $request-&gt;uri, &#34;: &#34;, $res-&gt;message &#41;;
-        }
-    }
-
-    $self-&gt;_reset_page;
-    if &#40; $self-&gt;is_html &#41; {
-        $self-&gt;update_html&#40; $res-&gt;content &#41;;
-    } else {
-        $self-&gt;{content} = $res-&gt;content;
-    }
-
-    return $res;
-} # request
-
 =head2 $mech-&gt;update_html&#40; $html &#41;
 
 Allows you to replace the HTML that the mech has found.  Updates the
@@ -1661,6 +1634,48 @@
     return;
 }
 
+=head2 $mech-&gt;_update_page&#40;$request, $response&#41;
+
+Updates all internal variables in $mech as if $request was just
+performed, and returned $response. The page stack is B&lt;not&gt; altered by
+this method, it is up to caller &#40;e.g. L&lt;/request&gt;&#41; to do that.
+
+=cut
+
+sub _update_page {
+    my &#40;$self, $request, $res&#41; = @_;
+
+    $self-&gt;{req} = $request;
+    $self-&gt;{redirected_uri} = $request-&gt;uri-&gt;as_string;
+
+    $self-&gt;{res} = $res;
+
+    # These internal hash elements should be dropped in favor of
+    # the accessors soon. -- 1/19/03
+    $self-&gt;{status}  = $res-&gt;code;
+    $self-&gt;{base}    = $res-&gt;base;
+    $self-&gt;{ct}      = $res-&gt;content_type || &#34;&#34;;
+
+    if &#40; $res-&gt;is_success &#41; {
+        $self-&gt;{uri} = $self-&gt;{redirected_uri};
+        $self-&gt;{last_uri} = $self-&gt;{uri};
+    } else {
+        if &#40; $self-&gt;{autocheck} &#41; {
+            $self-&gt;die&#40; &#34;Error &#34;, $request-&gt;method, &#34;ing &#34;, $request-&gt;uri, &#34;: &#34;, $res-&gt;message &#41;;
+        }
+    }
+
+    $self-&gt;_reset_page;
+    if &#40;$self-&gt;is_html&#41; {
+        $self-&gt;update_html&#40;$res-&gt;content&#41;;
+    } else {
+        $self-&gt;{content} = $res-&gt;content;
+    }
+
+    return $res;
+} # _update_page
+
+
 =head2 $mech-&gt;_modify_request&#40; $req &#41;
 
 Modifies the request according to all the internal header mangling.
@@ -1943,10 +1958,6 @@
 sub _push_page_stack {
     my $self = shift;
 
-    # Hook for reload&#40;&#41; and maybe future code &#40;e.g. 302 chasing,
-    # frames&#41; that may want to fetch stuff without altering the history.
-    return 1 if $self-&gt;{inhibit_page_stack};
-
     # Don&#39;t push anything if it&#39;s a virgin object
     if &#40; $self-&gt;{res} &#41; {
         my $save_stack = $self-&gt;{page_stack};
@@ -1971,10 +1982,6 @@
 sub _pop_page_stack {
     my $self = shift;
 
-    # Hook for reload&#40;&#41; and maybe future code &#40;e.g. 302 chasing,
-    # frames&#41; that may want to fetch stuff without altering the history.
-    return 1 if $self-&gt;{inhibit_page_stack};
-
     if &#40;@{$self-&gt;{page_stack}}&#41; {
         my $popped = pop @{$self-&gt;{page_stack}};
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;09&nbsp;14:20:21&nbsp;2004</span>
    <span class="description">mark [...] summersault.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 9 Nov 2004 14:21:14 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Stosberg &lt;mark [...] summersault.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;dom [...] idealx.com via RT&#34; &lt;bug-WWW-Mechanize [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #8109] back&#40;&#41; reload&#40;&#41;ed, sans inhibition</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Nov 09, 2004 at 01:29:01PM -0500, dom@idealx.com via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; This message about WWW-Mechanize was sent to you by dom@idealx.com &lt;dom@idealx.com&gt; via rt.cpan.org
&gt; 
&gt; Full context and any attached attachments can be found at:
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=8109">https://rt.cpan.org/Ticket/Display.html?id=8109</a></span> &gt;
&gt; 
&gt; Dear Mechanists,
&gt; 
&gt; Here is the new-and-improved patch that takes Andy&#39;s comment into
&gt; account: $mech-&gt;{inhibit_page_stack} is gone, and a new refactored
&gt; function appears.
</div>
Thanks. I&#34;ll take a look.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Please apply to CVS HEAD. &#40;Off-topic note: I just spent some time
&gt; installing svk and this is just another insanely cool Perl package! It
&gt; made my keeping track of pending patches much easier. Well worth a try
&gt; for all folks working concurrently on lots of FOSS projects IMHO&#41;
</div>
Good to here. I know Andy is a Subversion fan, and I prefer darcs. 
I was actually going to recommend &#39;darcs&#39; to you, once I figured out how
to setup a CVS &lt;-&gt; darcs gateway for Mech. It sounds like you have a
solution you like, though. 

 From what I&#39;ve seen, svk is partially inspired by the command set of
darcs.

I would like to play with svk more myself sometime. 

&#40; BTW, darcs just turned 1.0 yesterday: <span class="clickylink"><a target="new" rel="nofollow" href="http://www.darcs.net/">http://www.darcs.net/</a></span> &#41;.

        Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;09&nbsp;21:36:33&nbsp;2004</span>
    <span class="description">MARKSTOS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
