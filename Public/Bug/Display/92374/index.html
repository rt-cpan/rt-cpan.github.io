<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #92374 for Mail-Box: Mail::Message::Body::File corrupts binary files</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #92374 for Mail-Box: Mail::Message::Body::File corrupts binary files</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Mail-Box/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Mail-Box/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Mail-Box/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Mail-Box/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-Box">Mail-Box CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">92374</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Mail-Box/Active/">Mail-Box</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
JSTROM [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-19874-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.110    </td>
  </tr>
  <tr id="CF-19875-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
2.111    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;22&nbsp;13:03:33&nbsp;2014</span>
    <span class="description">JSTROM [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Mail::Message::Body::File corrupts binary files</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The attached error.pl creates an example binary file and prints a hex dump of the result.  The final 0D0A is lost.

There are two issues: Mail::Message::Body::File fails to set binmode before reading/writing files as appropriate and Mail::Message::Body::init&#40;&#41; doesn&#39;t resolve the mime_type &#40;and know if the file is binary or not&#41; before acquiring the file data.

The attached patches are a somewhat brute-force approach I took just to get it working temporarily, but may be useful to illustrate the issue.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Mail-Message-Body-File.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- C:\strawberry\perl\site\lib\Mail\Message\Body\File.pm	Sun Jan 05 12:51:19 2014
+++ \home\rse\lib\mail\message\body\file.pm	Wed Jan 22 12:39:23 2014
@@ -37,6 +36,11 @@
         return;
     }
 
+    if&#40; $self-&gt;mimeType-&gt;isBinary &#41; {
+        binmode IN;
+        binmode OUT;
+    }
+
     my $nrlines = 0;
     while&#40;&lt;IN&gt;&#41; { print OUT; $nrlines++ }
 
@@ -153,8 +157,10 @@
 
     my $size = eval { -s $self-&gt;tempFilename };
 
-    $size   -= $self-&gt;nrLines
-        if $Mail::Message::crlf_platform;   # remove count for extra CR&#39;s
+    unless&#40; $self-&gt;mimeType-&gt;isBinary &#41; {
+        $size   -= $self-&gt;nrLines
+            if $Mail::Message::crlf_platform;   # remove count for extra CR&#39;s
+    }
 
     $self-&gt;{MMBF_size} = $size;
 }
@@ -169,6 +175,10 @@
     open IN, &#39;&lt;&#39;, $file
         or die &#34;Cannot read from $file: $!\n&#34;;
 
+    if&#40; $self-&gt;mimeType-&gt;isBinary &#41; {
+        binmode IN;
+    }
+
     my $return = join &#39;&#39;, &lt;IN&gt;;
     close IN;
 
@@ -184,6 +194,10 @@
     open IN, &#39;&lt;&#39;, $file
         or die &#34;Cannot read from $file: $!\n&#34;;
 
+    if&#40; $self-&gt;mimeType-&gt;isBinary &#41; {
+        binmode IN;
+    }
+
     my @r = &lt;IN&gt;;
     close IN;
 
@@ -192,7 +206,15 @@
 }
 
 sub file&#40;&#41;
-{   open my $tmp, &#39;&lt;&#39;, shift-&gt;tempFilename;
+{
+    my $self = shift;
+    
+    open my $tmp, &#39;&lt;&#39;, $self-&gt;tempFilename;
+
+    if&#40; $self-&gt;mimeType-&gt;isBinary &#41; {
+        binmode $tmp;
+    }
+
     $tmp;
 }
 
@@ -207,6 +229,10 @@
     open IN, &#39;&lt;&#39;, $file
         or croak &#34;Cannot read from $file: $!\n&#34;;
 
+    if&#40; $self-&gt;mimeType-&gt;isBinary &#41; {
+        binmode IN;
+    }
+    
     if&#40;ref $fh eq &#39;GLOB&#39;&#41; {print $fh $_ while &lt;IN&gt;}
     else                  {$fh-&gt;print&#40;$_&#41; while &lt;IN&gt;}
     close IN;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Mail-Message-Body.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- C:\strawberry\perl\site\lib\Mail\Message\Body.pm	Sun Jan 05 12:51:19 2014
+++ \home\rse\lib\mail\message\body.pm	Wed Jan 22 12:31:46 2014
@@ -63,44 +63,13 @@
 
     $self-&gt;{MMB_modified} = $args-&gt;{modified} || 0;
 
-    my $filename;
-    if&#40;defined&#40;my $file = $args-&gt;{file}&#41;&#41;
-    {
-        if&#40;!ref $file&#41;
-        {   $self-&gt;_data_from_filename&#40;$file&#41; or return;
-            $filename = $file;
-        }
-        elsif&#40;ref $file eq &#39;GLOB&#39;&#41;
-        {   $self-&gt;_data_from_glob&#40;$file&#41; or return }
-        elsif&#40;$file-&gt;isa&#40;&#39;IO::Handle&#39;&#41;&#41;
-        {   $self-&gt;_data_from_filehandle&#40;$file&#41; or return }
-        else
-        {   croak &#34;message body: illegal datatype `&#34;.ref&#40;$file&#41;.&#34;&#39; for file option&#34; }
-    }
-    elsif&#40;defined&#40;my $data = $args-&gt;{data}&#41;&#41;
-    {
-        if&#40;!ref $data&#41;
-        {   my @lines = split /^/, $data;
-            $self-&gt;_data_from_lines&#40;\@lines&#41;
-        }
-        elsif&#40;ref $data eq &#39;ARRAY&#39;&#41;
-        {   $self-&gt;_data_from_lines&#40;$data&#41; or return;
-        }
-        else
-        {   croak &#34;message body: illegal datatype `&#34;.ref&#40;$data&#41;.&#34;&#39; for data option&#34; }
-    }
-    elsif&#40;! $self-&gt;isMultipart &#38;&#38; ! $self-&gt;isNested&#41;
-    {   # Neither &#39;file&#39; nor &#39;data&#39;, so empty body.
-        $self-&gt;_data_from_lines&#40; [] &#41; or return;
-    }
-
     # Set the content info
 
     my &#40;$mime, $transfer, $disp, $charset, $descr, $cid&#41; = @$args{
        qw/mime_type transfer_encoding disposition charset
           description content_id/ }; 
 
-    if&#40;defined $filename&#41;
+    if&#40;defined&#40;my $filename = $args-&gt;{file}&#41;&#41;
     {   $disp = Mail::Message::Field-&gt;new
            &#40;&#39;Content-Disposition&#39; =&gt; &#40;-T $filename ? &#39;inline&#39;:&#39;attachment&#39;&#41;
            , filename =&gt; basename&#40;$filename&#41;
@@ -144,6 +113,35 @@
     $self-&gt;type&#40;$mime&#41;;
 
     $self-&gt;{MMB_eol}   = $args-&gt;{eol} || &#39;NATIVE&#39;;
+    
+    if&#40;defined&#40;my $file = $args-&gt;{file}&#41;&#41;
+    {
+        if&#40;!ref $file&#41;
+        {   $self-&gt;_data_from_filename&#40;$file&#41; or return; }
+        elsif&#40;ref $file eq &#39;GLOB&#39;&#41;
+        {   $self-&gt;_data_from_glob&#40;$file&#41; or return }
+        elsif&#40;$file-&gt;isa&#40;&#39;IO::Handle&#39;&#41;&#41;
+        {   $self-&gt;_data_from_filehandle&#40;$file&#41; or return }
+        else
+        {   croak &#34;message body: illegal datatype `&#34;.ref&#40;$file&#41;.&#34;&#39; for file option&#34; }
+    }
+    elsif&#40;defined&#40;my $data = $args-&gt;{data}&#41;&#41;
+    {
+        if&#40;!ref $data&#41;
+        {   my @lines = split /^/, $data;
+            $self-&gt;_data_from_lines&#40;\@lines&#41;
+        }
+        elsif&#40;ref $data eq &#39;ARRAY&#39;&#41;
+        {   $self-&gt;_data_from_lines&#40;$data&#41; or return;
+        }
+        else
+        {   croak &#34;message body: illegal datatype `&#34;.ref&#40;$data&#41;.&#34;&#39; for data option&#34; }
+    }
+    elsif&#40;! $self-&gt;isMultipart &#38;&#38; ! $self-&gt;isNested&#41;
+    {   # Neither &#39;file&#39; nor &#39;data&#39;, so empty body.
+        $self-&gt;_data_from_lines&#40; [] &#41; or return;
+    }
+
 
     # Set message where the body belongs to.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> error.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use Mail::Message;

$test = &#34;\xFF\x0a\xFF\x0d\xFF\x0a\x0d\xFF\x0d\x0a\xFF&#34;;

open OUT, &#39;&gt;&#39;, &#39;example.dat&#39;;
binmode OUT;
print OUT $test;
close OUT;

$mail = Mail::Message-&gt;build&#40;
    From =&gt; &#39;me@example.com&#39;,
    To =&gt; &#39;you@example.com&#39;,
    Subject =&gt; &#39;Bug in Mail::Message::Body::File&#39;,
    data =&gt; [&#39;See attached file&#39;]
&#41;;

$body = $mail-&gt;body;
$body = $body-&gt;attach&#40; Mail::Message::Body-&gt;new&#40;
    file =&gt; &#39;example.dat&#39;,
    mime_type =&gt; &#39;application/octet-stream&#39;
&#41; &#41;;
$mail-&gt;body&#40;$body&#41;;


open OUT, &#39;&gt;&#39;, &#39;example.mail&#39;;
$mail-&gt;print&#40; \*OUT &#41;;
close OUT;

open IN, &#39;&lt;&#39;, &#39;example.mail&#39;;
$newmail = Mail::Message-&gt;read&#40; \*IN &#41;;
close IN;

@parts = $newmail-&gt;parts;

print &#34;- - - - - - - - - - - - - - - - -\n&#34;;
for &#40;@parts&#41; {
    $data = $_-&gt;decoded&#40;&#41;;
    hexdump&#40; $data &#41;;
    print &#34;- - - - - - - - - - - - - - - - -\n&#34;;
}
hexdump&#40;$test&#41;;

sub hexdump {
    my $data = shift;

    while&#40; length $data &#41; {
        $line = substr $data, 0, 16, &#39;&#39;;
        $hex  = unpack &#39;H*&#39;, $line;
        $line =~ tr/\x20-\x7e/./c;
        printf &#34;%-32s | %s\n&#34;, $hex, $line;
    }
}

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;23&nbsp;03:35:53&nbsp;2014</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #92374] Mail::Message::Body::File corrupts binary files</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 23 Jan 2014 09:35:39 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Joseph Strom via RT &lt;bug-Mail-Box [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Joseph Strom via RT &#40;bug-Mail-Box@rt.cpan.org&#41; [140122 18:03]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Wed Jan 22 13:03:33 2014: Request 92374 was acted upon.
&gt; Transaction: Ticket created by JSTROM
&gt;        Queue: Mail-Box
&gt;      Subject: Mail::Message::Body::File corrupts binary files
&gt; 
&gt; There are two issues: Mail::Message::Body::File fails to
&gt; set binmode before reading/writing files as appropriate and
&gt; Mail::Message::Body::init&#40;&#41; doesn&#39;t resolve the mime_type &#40;and know if
&gt; the file is binary or not&#41; before acquiring the file data.
</div>
I have not encounted this problem before.  I never use Windows, so have
no idea about its quircks reading files...

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The attached patches are a somewhat brute-force approach I took just
&gt; to get it working temporarily, but may be useful to illustrate the issue.
</div>
In stead of binmode, I think we can do with opening &lt;:raw / &gt;:raw
everywhere.  The file is used as message body, so treating it as bytes
seems ok in any situation.  What do you think?
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;23&nbsp;03:35:53&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;23&nbsp;10:20:55&nbsp;2014</span>
    <span class="description">j-strom [...] verizon.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #92374] Mail::Message::Body::File corrupts binary files</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 23 Jan 2014 09:30:38 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-Box [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> j-strom [...] verizon.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; In stead of binmode, I think we can do with opening &lt;:raw / &gt;:raw
&gt; everywhere.  The file is used as message body, so treating it as bytes
&gt; seems ok in any situation.  What do you think?
&gt; -- 
</div>
That seems more elegant than my quick fix.

The question is will it be OK for text files not to have their line-endings
converted.  Tracing through the code, it looks like line-endings are left to
Net::Cmd to handle.  And it can accept either CRLF or LF and produce
the correct output &#40;though possibly not for CR-only input; there are some
odd checks in Net::Cmd that may be relevant to a CR-only environment,
but I don&#39;t know enough to say&#41;.

-js
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;23&nbsp;11:27:15&nbsp;2014</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #92374] Mail::Message::Body::File corrupts binary files</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 23 Jan 2014 17:26:57 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;j-strom [...] verizon.net via RT&#34; &lt;bug-Mail-Box [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* j-strom@verizon.net via RT &#40;bug-Mail-Box@rt.cpan.org&#41; [140123 15:21]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Mail-Box
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=92374">https://rt.cpan.org/Ticket/Display.html?id=92374</a></span> &gt;
&gt; 
<div class="message-stanza open">&gt; &gt; In stead of binmode, I think we can do with opening &lt;:raw / &gt;:raw
&gt; &gt; everywhere.  The file is used as message body, so treating it as bytes
&gt; &gt; seems ok in any situation.  What do you think?
</div>&gt; 
&gt; That seems more elegant than my quick fix.
&gt; 
&gt; The question is will it be OK for text files not to have their line-endings
&gt; converted.  Tracing through the code, it looks like line-endings are left to
&gt; Net::Cmd to handle.  And it can accept either CRLF or LF and produce
&gt; the correct output &#40;though possibly not for CR-only input; there are some
&gt; odd checks in Net::Cmd that may be relevant to a CR-only environment,
&gt; but I don&#39;t know enough to say&#41;.
</div>
The Net::Cmd only cares about protocol lines, but does not look at the
content of email messages.  The RFCs only speak about CRLF at the end
of MIME Header lines, and MailBox takes care of that.  Nothing about
the body... email clients and/or applications needs to be aware about
the CRLF/CR/LF problem... this is not always the case.

The FTP protocol has this text/binary switch, where text gets actively
translated, but email implementations are usually ignoring the fact.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;23&nbsp;22:38:15&nbsp;2014</span>
    <span class="description">j-strom [...] verizon.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #92374] Mail::Message::Body::File corrupts binary files</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 23 Jan 2014 22:31:48 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-Box [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> j-strom [...] verizon.net</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; From: &#34;Mark Overmeer via RT&#34; &lt;bug-Mail-Box@rt.cpan.org&gt;
&gt; To:   JSTROM@cpan.org
&gt; Date: Thu Jan 23 11:27:16 2014
&gt;
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=92374">https://rt.cpan.org/Ticket/Display.html?id=92374</a></span> &gt;
&gt; 
&gt; * j-strom@verizon.net via RT &#40;bug-Mail-Box@rt.cpan.org&#41; [140123 15:21]:
<div class="message-stanza open">&gt; &gt;        Queue: Mail-Box
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=92374">https://rt.cpan.org/Ticket/Display.html?id=92374</a></span> &gt;
&gt; &gt; 
<div class="message-stanza open">&gt; &gt; &gt; In stead of binmode, I think we can do with opening &lt;:raw / &gt;:raw
&gt; &gt; &gt; everywhere.  The file is used as message body, so treating it as bytes
&gt; &gt; &gt; seems ok in any situation.  What do you think?
</div>&gt; &gt; 
</div></div>
Tested using :raw whenever a file is opened by Mail::Message::Body::File.
The example.dat round-tripped without change.
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- C:\strawberry\perl\site\lib\Mail\Message\Body\File.pm	Sun Jan 05 12:51:19 2014
+++ File.pm	Thu Jan 23 22:23:58 2014
@@ -25,14 +25,14 @@
     local $_;
     local &#40;*IN, *OUT&#41;;
 
-    unless&#40;open IN, &#39;&lt;&#39;, $filename&#41;
+    unless&#40;open IN, &#39;&lt; :raw&#39;, $filename&#41;
     {   $self-&gt;log&#40;ERROR =&gt;
             &#34;Unable to read file $filename for message body file: $!&#34;&#41;;
         return;
     }
 
     my $file   = $self-&gt;tempFilename;
-    unless&#40;open OUT, &#39;&gt;&#39;, $file&#41;
+    unless&#40;open OUT, &#39;&gt; :raw&#39;, $file&#41;
     {   $self-&gt;log&#40;ERROR =&gt; &#34;Cannot write to temporary body file $file: $!&#34;&#41;;
         return;
     }
@@ -54,7 +54,7 @@
 
     local *OUT;
 
-    unless&#40;open OUT, &#39;&gt;&#39;, $file&#41;
+    unless&#40;open OUT, &#39;&gt; :raw&#39;, $file&#41;
     {   $self-&gt;log&#40;ERROR =&gt; &#34;Cannot write to temporary body file $file: $!&#34;&#41;;
         return;
     }
@@ -77,7 +77,7 @@
     local $_;
     local *OUT;
 
-    unless&#40;open OUT, &#39;&gt;&#39;, $file&#41;
+    unless&#40;open OUT, &#39;&gt; :raw&#39;, $file&#41;
     {   $self-&gt;log&#40;ERROR =&gt; &#34;Cannot write to temporary body file $file: $!&#34;&#41;;
         return;
     }
@@ -98,7 +98,7 @@
 
     local *OUT;
 
-    unless&#40;open OUT, &#39;&gt;&#39;, $file&#41;
+    unless&#40;open OUT, &#39;&gt; :raw&#39;, $file&#41;
     {   $self-&gt;log&#40;ERROR =&gt; &#34;Cannot write to $file: $!&#34;&#41;;
         return;
     }
@@ -134,7 +134,7 @@
     local $_;
     local *IN;
 
-    open IN, &#39;&lt;&#39;, $file
+    open IN, &#39;&lt; :raw&#39;, $file
         or die &#34;Cannot read from $file: $!\n&#34;;
 
     $nrlines++ while &lt;IN&gt;;
@@ -166,7 +166,7 @@
 
     local *IN;
 
-    open IN, &#39;&lt;&#39;, $file
+    open IN, &#39;&lt; :raw&#39;, $file
         or die &#34;Cannot read from $file: $!\n&#34;;
 
     my $return = join &#39;&#39;, &lt;IN&gt;;
@@ -181,7 +181,7 @@
     my $file = $self-&gt;tempFilename;
 
     local *IN;
-    open IN, &#39;&lt;&#39;, $file
+    open IN, &#39;&lt; :raw&#39;, $file
         or die &#34;Cannot read from $file: $!\n&#34;;
 
     my @r = &lt;IN&gt;;
@@ -192,7 +192,7 @@
 }
 
 sub file&#40;&#41;
-{   open my $tmp, &#39;&lt;&#39;, shift-&gt;tempFilename;
+{   open my $tmp, &#39;&lt; :raw&#39;, shift-&gt;tempFilename;
     $tmp;
 }
 
@@ -204,7 +204,7 @@
     local $_;
     local *IN;
 
-    open IN, &#39;&lt;&#39;, $file
+    open IN, &#39;&lt; :raw&#39;, $file
         or croak &#34;Cannot read from $file: $!\n&#34;;
 
     if&#40;ref $fh eq &#39;GLOB&#39;&#41; {print $fh $_ while &lt;IN&gt;}
@@ -220,7 +220,7 @@
 
     local *OUT;
 
-    open OUT, &#39;&gt;&#39;, $file
+    open OUT, &#39;&gt; :raw&#39;, $file
         or die &#34;Cannot write to $file: $!.\n&#34;;
 
     &#40;my $begin, my $end, $self-&gt;{MMBF_nrlines}&#41; = $parser-&gt;bodyAsFile&#40;\*OUT,@_&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;17&nbsp;03:56:52&nbsp;2015</span>
    <span class="description">MARKOV [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;17&nbsp;03:56:53&nbsp;2015</span>
    <span class="description">MARKOV [...] cpan.org -  Fixed in 2.111 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
