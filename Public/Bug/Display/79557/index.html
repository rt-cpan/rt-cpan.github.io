<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #79557 for Socket: Spurrious &#34;addr is not a string&#34; error</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #79557 for Socket: Spurrious &#34;addr is not a string&#34; error</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Socket">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Socket">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Socket">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Socket">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Socket">Socket CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">79557</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Socket">Socket</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dolmen [...] cpan.org

<br />
IKEGAMI [...] cpan.org

<br />
tlhackque [...] yahoo.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-29154-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.006    </td>
  </tr>
  <tr id="CF-29155-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
2.018    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




rt79557.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1462246/778182/rt79557.patch">
Tue Feb 10 07:04:23 2015 (929b) by leonerd-cpan [...] leonerd.org.uk
</a>
</font></li>
</ul>


taint.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1325626/703036/taint.pl">
Wed Feb 12 10:00:44 2014 (593b) by leonerd-cpan [...] leonerd.org.uk
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=79557">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1118597" href="/Public/Bug/Display.html?id=79557#txn-1118597">#</a>      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;10&nbsp;17:21:56&nbsp;2012</span>
    <span class="description">tlhackque [...] yahoo.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Spurrious &#34;addr is not a string&#34; error</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1118597/588446/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/588446">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This problem caused me quite some headaches, but I understand if you
don&#39;t care...

On a system still running 5.8.8 / 2.6.17-1.2142_FC4 &#40;and yes, it is 
scheduled to upgrade, but...&#41;, I installed Socket 2.006 for some IPV6 
work.

A small chunk of code calls getnameinfo with the output of getaddrinfo.

It works standalone, but fails under apache httpd.  The very same 
inputs.  This is quite strange.

In Socket.xs, we have:
    if&#40;!SvPOK&#40;addr&#41;&#41;
                croak&#40;&#34;addr is not a string&#34;&#41;;

I have no clue why we hit this croak.  I put a fair bit of diagnostic 
code into the xs, and tested for refs, arrays, hashs - in fact 
everything.  addr wasn&#39;t any of those.  I dumped addr from the perl
side and verified that yes, what was being passed is in fact a valid
adddress string.  I tried various things: passing the string in a 
scalar, introducing a subroutine.  Nothing worked.  BUT, remember that
the same code works stand-alone...

Finally, I simply commented-out the test, and everything &#34;works&#34; - in 
that the correct data is returned for a few hundred test cases.

I know 5.8.8 is old, but worry that the issue may appear under more 
recent versions.  I&#39;m not an XS expert, but it has the feel of an
incorrect reference count or some such.  So I thought I should report 
it.

Here is the code.  It is passed an IP address &#40;V4 or V6&#41; as a string.
It returns the corresponding host name, or an empty string.

The eval is only to catch this error &#40;since Socket is supplying and 
consuming the data, it &#34;shouldn&#39;t happen&#34;.&#41;

One other thing - what&#39;s supposed to happen with an address that has
multiple names?  getnameinfo doesn&#39;t seem to suppor this.  
gethostbyaddr did - and it&#39;s not uncommon for one address to have
multiple PTR records in IPV4...

Thanks.

#!/usr/bin/perl -d
use strict;
use warnings;
use Socket qw&#40; :addrinfo inet_ntoa inet_aton SOCK_RAW PF_INET 
PF_INET6 &#41;;

sub getHostFromAddr&#40;$&#41; {
    my $addr = shift;

    my&#40; $error, @addrs &#41; = getaddrinfo&#40; $addr, 0, { flags =&gt; 
AI_NUMERICHOST } &#41;;
    return &#39;&#39; if&#40; $error &#41;;

    my $name;
    eval {
        &#40;$error, $name, undef&#41; = getnameinfo&#40; $addrs[0]-&gt;{addr}, 
NI_NAMEREQD, NIx_NOSERV &#41;;
    }; return &#39;&#39; if&#40; $@ &#41;;
    return &#39;&#39; if&#40; $error &#41;;

    return $name;
}

my $x = &#39;192.168.148.108&#39;;
print getHostFromAddr&#40;$x&#41;;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1157150" href="/Public/Bug/Display.html?id=79557#txn-1157150">#</a>      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;19&nbsp;13:21:04&nbsp;2012</span>
    <span class="description">tlhackque [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> getnameinfo fails in taint mode &#40;data from getaddrinfo&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> tlhackque [...] yahoo.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1157150/608529/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/608529">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have finally tracked this down.  It still exists in V2.007, and with 
Perl Version 5.14.3.  And this time I think everyone shoud care.

The problem arises when getaddrinfo is passed a tainted name.

When this happens, the @results[n]-&gt;{addr} data is tainted.

getnameinfo checks this argument, and finds &#40;as previously reported, 
but not understood&#41; that SvPOK is false.  It croaks with the highly 
misleading &#34;addr is not a string&#34;.

This is confirmed with the diagnostic code shown below, which reports 
the data as tainted.  And the croak disappears if the data is untainted 
going in to getaddrinfo.

Issues:
   * I did not find mention in the documentation that tainted data 
causes SvPOK to be turned off.  SvPOK is documented to mean &#34;variable 
contains a string.  Tainted or not, it does contain a string...

   * It&#39;s not obvious &#40;or documented&#41; that either function is sensitive 
to taint mode.  At a minimum, this needs to be documented.

   * Since getnameinfo doesn&#39;t eval or do anything dangerous with the 
string, why not allow this call to succeed?  Tainting the output would 
be acceptable.

   * If it is deemed desirable to disallow tainted input, please 
incorporate something like the diagnostic code shown below.  &#34;Insecure 
dependency&#34; or &#34;Argument is tainted&#34; are the conventional flags - and 
that would have saved me many, many hours of debugging.  &#40;Yes, it&#39;s 
obvious in hindsight...&#41;

I have updated the reproducer to make it clear that it runs -T and that 
the input comes from a CGI.

My diagnostic patch follows.

Thanks.


--- Socket.xs~  2012-12-16 13:24:00.000000000 -0500
+++ Socket.xs   2012-12-19 13:12:07.124222787 -0500
@@ -529,13 +529,16 @@
                xflags = SvIV&#40;ST&#40;2&#41;&#41;;

        want_host = !&#40;xflags &#38; NIx_NOHOST&#41;;
        want_serv = !&#40;xflags &#38; NIx_NOSERV&#41;;

-       if&#40;!SvPOK&#40;addr&#41;&#41;
-               croak&#40;&#34;addr is not a string&#34;&#41;;
-
+       if&#40;!SvPOK&#40;addr&#41;&#41; {
+                if&#40; SvTAINTED&#40;addr&#41; &#41;
+                        croak&#40; &#34;Insecure dependency: addr is 
tainted.&#34; &#41;;
+                else
+                        croak&#40;&#34;addr is not a string&#34;&#41;;
+        }
        addr_len = SvCUR&#40;addr&#41;;

        /* We need to ensure the sockaddr is aligned, because a random 
SvPV might
         * not be due to SvOOK */
        Newx&#40;sa, addr_len, char&#41;;

On Mon Sep 10 17:21:56 2012, tlhackque wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This problem caused me quite some headaches, but I understand if you
&gt; don&#39;t care...
&gt; 
&gt; On a system still running 5.8.8 / 2.6.17-1.2142_FC4 &#40;and yes, it is 
&gt; scheduled to upgrade, but...&#41;, I installed Socket 2.006 for some IPV6 
&gt; work.
&gt; 
&gt; A small chunk of code calls getnameinfo with the output of 
</div>getaddrinfo.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; It works standalone, but fails under apache httpd.  The very same 
&gt; inputs.  This is quite strange.
&gt; 
&gt; In Socket.xs, we have:
&gt;     if&#40;!SvPOK&#40;addr&#41;&#41;
&gt;                 croak&#40;&#34;addr is not a string&#34;&#41;;
&gt; 
&gt; I have no clue why we hit this croak.  I put a fair bit of diagnostic 
&gt; code into the xs, and tested for refs, arrays, hashs - in fact 
&gt; everything.  addr wasn&#39;t any of those.  I dumped addr from the perl
&gt; side and verified that yes, what was being passed is in fact a valid
&gt; adddress string.  I tried various things: passing the string in a 
&gt; scalar, introducing a subroutine.  Nothing worked.  BUT, remember that
&gt; the same code works stand-alone...
&gt; 
&gt; Finally, I simply commented-out the test, and everything &#34;works&#34; - in 
&gt; that the correct data is returned for a few hundred test cases.
&gt; 
&gt; I know 5.8.8 is old, but worry that the issue may appear under more 
&gt; recent versions.  I&#39;m not an XS expert, but it has the feel of an
&gt; incorrect reference count or some such.  So I thought I should report 
&gt; it.
&gt; 
&gt; Here is the code.  It is passed an IP address &#40;V4 or V6&#41; as a string.
&gt; It returns the corresponding host name, or an empty string.
&gt; 
&gt; The eval is only to catch this error &#40;since Socket is supplying and 
&gt; consuming the data, it &#34;shouldn&#39;t happen&#34;.&#41;
&gt; 
&gt; One other thing - what&#39;s supposed to happen with an address that has
&gt; multiple names?  getnameinfo doesn&#39;t seem to suppor this.  
&gt; gethostbyaddr did - and it&#39;s not uncommon for one address to have
&gt; multiple PTR records in IPV4...
&gt; 
&gt; Thanks.
&gt; 
&gt; #!/usr/bin/perl -dT
&gt; use strict;
&gt; use warnings;
&gt; use Socket qw&#40; :addrinfo inet_ntoa inet_aton SOCK_RAW PF_INET 
&gt; PF_INET6 &#41;;
&gt; 
&gt; sub getHostFromAddr&#40;$&#41; {
&gt;     my $addr = shift;
&gt; 
&gt;     my&#40; $error, @addrs &#41; = getaddrinfo&#40; $addr, 0, { flags =&gt; 
&gt; AI_NUMERICHOST } &#41;;
&gt;     return &#39;&#39; if&#40; $error &#41;;
&gt; 
&gt;     my $name;
&gt;     eval {
&gt;       &#40;$error, $name, undef&#41; = getnameinfo&#40; $addrs[0]-&gt;{addr}, 
&gt; NI_NAMEREQD, NIx_NOSERV &#41;;
&gt;     }; return &#39;&#39; if&#40; $@ &#41;;
&gt;     return &#39;&#39; if&#40; $error &#41;;
&gt; 
&gt;     return $name;
&gt; }
&gt; 
&gt; my $x = $query-&gt;param&#40;&#39;address&#39;&#41;; # Value eq &#39;192.168.148.108&#39;;
&gt; print getHostFromAddr&#40;$x&#41;;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1325626" href="/Public/Bug/Display.html?id=79557#txn-1325626">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;12&nbsp;10:00:44&nbsp;2014</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1325626/703035/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/703035">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 828b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 19 13:21:04 2012, tlhackque wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have finally tracked this down.  It still exists in V2.007, and with 
&gt; Perl Version 5.14.3.  And this time I think everyone shoud care.
&gt; 
&gt; The problem arises when getaddrinfo is passed a tainted name.
&gt; 
&gt; When this happens, the @results[n]-&gt;{addr} data is tainted.
&gt; 
&gt; getnameinfo checks this argument, and finds &#40;as previously reported, 
&gt; but not understood&#41; that SvPOK is false.  It croaks with the highly 
&gt; misleading &#34;addr is not a string&#34;.
</div>
This still sounds like a weird cornercase. I can&#39;t reproduce it though - it appears to obey taint mode just fine for me:

$ perl -T taint.pl 
gethostbyaddr&#40;untaint&#41; =&gt; untaint
getnameinfo&#40;untaint&#41; =&gt; untaint
gethostbyaddr&#40;TAINT&#41; =&gt; TAINT
getnameinfo&#40;TAINT&#41; =&gt; TAINT

[find attached]

See if it works for you.

-- 

Paul Evans
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> taint.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1325626/703036/taint.pl">Download taint.pl</a><br />
<span class="downloadcontenttype">text/x-perl 593b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -T

use Socket qw&#40; pack_sockaddr_in inet_aton getnameinfo &#41;;
use Taint::Util qw&#40; taint tainted &#41;;

sub taintstr { tainted&#40;$_[0]&#41; ? &#34;TAINT&#34; : &#34;untaint&#34; }

foreach my $taint &#40; 0, 1 &#41; {
    my $addr = pack_sockaddr_in 0, inet_aton&#40;&#34;192.168.42.2&#34;&#41;;
    my $taddr = $addr;

    taint $taddr if $taint;

    my $host = gethostbyaddr $taddr, Socket::AF_INET;

    printf &#34;gethostbyaddr&#40;%s&#41; =&gt; %s\n&#34;, taintstr&#40;$taddr&#41;, taintstr&#40;$host&#41;;

    my &#40; $err, $hname &#41; = getnameinfo&#40; $taddr &#41;;
    die $err if $err;

    printf &#34;getnameinfo&#40;%s&#41; =&gt; %s\n&#34;, taintstr&#40;$taddr&#41;, taintstr&#40;$hname&#41;;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1325627" href="/Public/Bug/Display.html?id=79557#txn-1325627">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;12&nbsp;10:00:45&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1325666" href="/Public/Bug/Display.html?id=79557#txn-1325666">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;12&nbsp;11:28:38&nbsp;2014</span>
    <span class="description">tlhackque [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #79557] Spurrious &#34;addr is not a string&#34; error</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 12 Feb 2014 11:28:24 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Socket [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> tlhackque &lt;tlhackque [...] yahoo.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1325666/703059/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/703059">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 9.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 12-Feb-14 10:00, Paul Evans via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=79557">https://rt.cpan.org/Ticket/Display.html?id=79557</a></span> &gt;
&gt;
&gt; On Wed Dec 19 13:21:04 2012, tlhackque wrote:
<div class="message-stanza open">&gt;&gt; I have finally tracked this down.  It still exists in V2.007, and with
&gt;&gt; Perl Version 5.14.3.  And this time I think everyone shoud care.
&gt;&gt;
&gt;&gt; The problem arises when getaddrinfo is passed a tainted name.
&gt;&gt;
&gt;&gt; When this happens, the @results[n]-&gt;{addr} data is tainted.
&gt;&gt;
&gt;&gt; getnameinfo checks this argument, and finds &#40;as previously reported,
&gt;&gt; but not understood&#41; that SvPOK is false.  It croaks with the highly
&gt;&gt; misleading &#34;addr is not a string&#34;.
</div>&gt; This still sounds like a weird cornercase. I can&#39;t reproduce it though - it appears to obey taint mode just fine for me:
&gt;
&gt; $ perl -T taint.pl
&gt; gethostbyaddr&#40;untaint&#41; =&gt; untaint
&gt; getnameinfo&#40;untaint&#41; =&gt; untaint
&gt; gethostbyaddr&#40;TAINT&#41; =&gt; TAINT
&gt; getnameinfo&#40;TAINT&#41; =&gt; TAINT
&gt;
&gt; [find attached]
&gt;
&gt; See if it works for you.
&gt;
</div>Thanks for looking at this.  Your test case fails for me.

Here&#39;s what I get:

    |perl -T taint.pl|||
    |||gethostbyaddr&#40;untaint&#41; =&gt; untaint|||
    |||getnameinfo&#40;untaint&#41; =&gt; untaint|||
    |||gethostbyaddr&#40;TAINT&#41; =&gt; TAINT|||
    |||addr is not a string at taint.pl line 18.|||
    ||||
    |||perl --version|||
    ||||
    |||This is perl 5, version 14, subversion 3 &#40;v5.14.3&#41; built for
    x86_64-linux-thread-multi|||
    ||||
    |||cat /proc/sys/kernel/osrelease|||
    |||3.7.3-101.fc17.x86_64|||
    cat /etc/redhat-release
    Fedora release 17 &#40;Beefy Miracle&#41;
      perl -MSocket -e&#39;print $Socket::VERSION&#39;
    2.001
    ||

I then made a slight change to your code, replacing lines 18/19 with:

    |    my&#40; $err, $hname &#41;;
         eval {
             &#40; $err, $hname &#41; = getnameinfo&#40; $taddr &#41;;
             die &#34;ERROR:$err&#34; if $err;
         }; if&#40; $@ &#41; {
             print &#34;EXCEPTION: $@&#34;;
             exit;
         }

       ./taint.pl
    gethostbyaddr&#40;untaint&#41; =&gt; untaint
    getnameinfo&#40;untaint&#41; =&gt; untaint
    gethostbyaddr&#40;TAINT&#41; =&gt; TAINT
    EXCEPTION: addr is not a string at ./taint.pl line 20.|

This reconfirms that the error is coming from inside getnameinfo, and 
being reported as an exception, not your die.

I upgraded to Socket 2.013 from cpan, no change.

When I last looked into this issue, I patched Socket to debug this and 
discovered that SvPOK was returning false for the failing case. It was 
rather painful.  I don&#39;t know enough Perl internals to understand why 
SvPOK is behaving this way.  I&#39;ve learned to untaint arguments to avoid 
the issue, but this isn&#39;t the right fix.

Below is the list of installed packages on the system I just tested.

Anything else I can do to help?

    |yum list installed | grep -P &#39;^perl&#39;|||
    |||perl.x86_64 4:5.14.3-219.fc17         @updates||
    pperl-AnyEvent.noarch                5.27-7.fc17 @anaconda-0|||
    |||perl-AnyEvent-AIO.noarch 1.1-8.fc17                @anaconda-0|||
    |||perl-AnyEvent-BDB.noarch 1.1-7.fc17                @anaconda-0|||
    |||perl-Async-MergePoint.noarch 0.03-7.fc17               @anaconda-0|||
    |||perl-BDB.x86_64 1.88-5.fc17               @anaconda-0|||
    |||perl-BSD-Resource.x86_64 1.29.04-9.fc17            @anaconda-0|||
    |||perl-CGI.noarch 3.52-218.fc17             @updates|||
    |||perl-CPAN.noarch 1.9600.01-219.fc17        @updates|||
    |||perl-Carp.noarch 1.22-2.fc17               @anaconda-0|||
    |||perl-Class-ISA.noarch 0.36-1007.fc17            @anaconda-0|||
    |||perl-Compress-Raw-Bzip2.x86_64 2.052-1.fc17             
    @anaconda-0|||
    |||perl-Compress-Raw-Zlib.x86_64 2.052-1.fc17             
    @anaconda-0|||
    |||perl-Coro.x86_64 6.07-3.fc17               @anaconda-0|||
    |||perl-Curses.x86_64 1.28-5.fc17               @anaconda-0|||
    |||perl-DBD-SQLite.x86_64 1.35-2.fc17               @fedora|||
    |||perl-DBI.x86_64 1.617-1.fc17              @anaconda-0|||
    |||perl-Date-Manip.noarch 6.30-1.fc17               @anaconda-0|||
    |||perl-Digest.noarch 1.17-2.fc17               @anaconda-0|||
    |||perl-Digest-MD5.x86_64 2.51-219.fc17             @updates|||
    |||perl-Digest-SHA.x86_64 1:5.61-219.fc17           @updates|||
    |||perl-EV.x86_64 4.03-8.fc17               @anaconda-0|||
    |||perl-Encode-Locale.noarch 1.02-5.fc17               @anaconda-0|||
    |||perl-Error.noarch 1:0.17016-7.fc17          @anaconda-0|||
    |||perl-Event.x86_64 1.20-1.fc17               @anaconda-0|||
    |||perl-Event-Lib.x86_64 1.03-16.fc17              @anaconda-0|||
    |||perl-ExtUtils-Install.noarch 1.56-219.fc17             @updates|||
    |||perl-ExtUtils-MakeMaker.noarch 6.62-2.fc17              
    @anaconda-0|||
    |||perl-ExtUtils-Manifest.noarch 1.60-1.fc17              
    @anaconda-0|||
    |||perl-ExtUtils-ParseXS.noarch 1:2.2210-219.fc17         @updates|||
    |||perl-FCGI.x86_64 1:0.74-2.fc17             @anaconda-0|||
    |||perl-File-Listing.noarch 6.03-2.fc17               @anaconda-0|||
    |||perl-Git.noarch 1.7.11.7-2.fc17           @updates|||
    |||perl-Glib.x86_64 1.241-2.fc17              @anaconda-0|||
    |||perl-Guard.x86_64 1.022-1.fc17              @anaconda-0|||
    |||perl-HTML-Parser.x86_64 3.69-3.fc17               @anaconda-0|||
    |||perl-HTML-Tagset.noarch 3.20-10.fc17              @anaconda-0|||
    |||perl-HTTP-Cookies.noarch 6.00-4.fc17               @anaconda-0|||
    |||perl-HTTP-Daemon.noarch 6.00-4.fc17               @anaconda-0|||
    |||perl-HTTP-Date.noarch 6.00-3.fc17               @anaconda-0|||
    |||perl-HTTP-Message.noarch 6.03-1.fc17               @anaconda-0|||
    |||perl-HTTP-Negotiate.noarch 6.00-4.fc17               @anaconda-0|||
    |||perl-HTTP-Tiny.noarch 0.012-219.fc17            @updates|||
    |||perl-Heap.noarch 0.80-10.fc17              @anaconda-0|||
    |||perl-IO-AIO.x86_64 4.15-1.fc17               @anaconda-0|||
    |||perl-IO-Async.noarch 0.29-7.fc17               @anaconda-0|||
    |||perl-IO-Compress.noarch 2.052-1.fc17              @anaconda-0|||
    |||perl-IO-Socket-INET6.noarch 2.69-1.fc17               @fedora|||
    |||perl-IO-Socket-IP.noarch 0.14-1.fc17               @updates|||
    |||perl-IO-Socket-SSL.noarch 1.66-1.fc17               @anaconda-0|||
    |||perl-IO-Tty.x86_64 1.10-8.fc17               @updates|||
    |||perl-LWP-MediaTypes.noarch 6.01-4.fc17               @anaconda-0|||
    |||perl-Linux-Pid.x86_64 0.04-14.fc17              @anaconda-0|||
    |||perl-Locale-Codes.noarch 3.24-1.fc17               @updates|||
    |||perl-Module-Pluggable.noarch 1:3.90-219.fc17           @updates|||
    |||perl-Net-HTTP.noarch 6.02-2.fc17               @anaconda-0|||
    |||perl-Net-LibIDN.x86_64 0.12-8.fc17               @anaconda-0|||
    |||perl-Net-SSLeay.x86_64 1.48-1.fc17               @anaconda-0|||
    |||perl-Newt.x86_64 1.08-31.fc17              @anaconda-0|||
    |||perl-POE.noarch 1.350-2.fc17              @anaconda-0|||
    |||perl-PathTools.x86_64 3.33-219.fc17             @updates|||
    |||perl-PathTools-debuginfo.x86_64 3.33-5.fc17              
    @fedora-debuginfo|||
    |||perl-Pod-Escapes.noarch 1:1.04-219.fc17           @updates|||
    |||perl-Pod-Perldoc.noarch 3.17-2.fc17               @updates|||
    |||perl-Pod-Plainer.noarch 1.03-1.fc17               @anaconda-0|||
    |||perl-Pod-Simple.noarch 1:3.16-219.fc17           @updates|||
    |||perl-SGMLSpm.noarch 1.03ii-27.fc17            @anaconda-0|||
    |||perl-Scalar-List-Utils.x86_64 1.25-1.fc17              
    @anaconda-0|||
    |||perl-Scalar-List-Utils-debuginfo.x86_64|||
    |||perl-Socket.x86_64 2.001-1.fc17              @fedora|||
    |||perl-Socket-GetAddrInfo.x86_64 0.19-1.fc17              
    @anaconda-0|||
    |||perl-Socket6.x86_64 0.23-8.fc17               @anaconda-0|||
    |||perl-Sys-CPU.x86_64 0.51-8.fc17               @anaconda-0|||
    |||perl-Sys-MemInfo.x86_64 0.91-1.fc17               @anaconda-0|||
    |||perl-TermReadKey.x86_64 2.30-14.fc17              @anaconda-0|||
    |||perl-TermReadKey-debuginfo.x86_64 2.30-14.fc17             
    @fedora-debuginfo|||
    |||perl-Test-Harness.noarch 3.23-219.fc17             @updates|||
    |||perl-Test-Simple.noarch 0.98-219.fc17             @updates|||
    |||perl-TimeDate.noarch 1:1.20-6.fc17             @anaconda-0|||
    |||perl-URI.noarch 1.60-1.fc17               @anaconda-0|||
    |||perl-WWW-RobotRules.noarch 6.01-4.fc17               @anaconda-0|||
    |||perl-XML-Parser.x86_64 2.41-4.fc17               @anaconda-0|||
    |||perl-YAML.noarch 0.81-2.fc17               @fedora|||
    |||perl-YAML-Syck.x86_64 1.17-4.fc17               @fedora|||
    |||perl-common-sense.noarch 3.5-1.fc17                @anaconda-0|||
    |||perl-debuginfo.x86_64 4:5.14.3-219.fc17         @updates-debuginfo|||
    |||perl-devel.x86_64 4:5.14.3-219.fc17         @updates|||
    |||perl-libs.x86_64 4:5.14.3-219.fc17         @updates|||
    |||perl-libwww-perl.noarch 6.03-2.fc17               @anaconda-0|||
    |||perl-macros.x86_64 4:5.14.3-219.fc17         @updates|||
    |||perl-parent.noarch 1:0.225-219.fc17          @updates|||
    |||perl-threads.x86_64 1.86-2.fc17               @anaconda-0|||
    |||perl-threads-shared.x86_64 1.40-2.fc17               @anaconda-0|||
    ||

    |cpan[1]&gt; i Socket|||
    |||Database was generated on Mon, 10 Feb 2014 22:25:01 GMT|||
    |||Module id = Socket|||
    |||    DESCRIPTION  Defines socket-related constants|||
    |||    CPAN_USERID  PEVANS &#40;Paul Evans &lt;leonerd@leonerd.org.uk&gt;&#41;|||
    |||    CPAN_VERSION 2.013|||
    |||    CPAN_FILE P/PE/PEVANS/Socket-2.013.tar.gz|||
    |||    DSLIP_STATUS Smcfp
    &#40;standard,mailing-list,C,functions,Standard-Perl&#41;|||
    |||    MANPAGE      C&lt;Socket&gt; - networking constants and support
    functions|||
    |||    INST_FILE /usr/lib64/perl5/vendor_perl/Socket.pm|||
    |||    INST_VERSION 2.001|||
    ||||&#40;I installed 2.013 and retested.&#41;
    ||

-- 
This communication may not represent my employer&#39;s views,
if any, on the matters discussed.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1325666/703060/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/703060">with headers</a>
<br />
<span class="downloadcontenttype">text/html 19.6k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1457908" href="/Public/Bug/Display.html?id=79557#txn-1457908">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;28&nbsp;16:48:30&nbsp;2015</span>
    <span class="description">IKEGAMI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1457908/775723/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/775723">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Sep 10 17:21:56 2012, tlhackque wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In Socket.xs, we have:
&gt;     if&#40;!SvPOK&#40;addr&#41;&#41;
&gt;                 croak&#40;&#34;addr is not a string&#34;&#41;;
&gt; 
&gt; I have no clue why we hit this croak.
</div>
Socket.xs forgot to account for magic.

    addr = ST&#40;0&#41;;

should be

    addr = ST&#40;0&#41;;
    SvGETMAGIC&#40;addr&#41;

Demo:

    $ perl -E&#39;
       use strict;
       use warnings;

       use IO::Socket::IP qw&#40; &#41;;
       use Socket         qw&#40; getnameinfo &#41;;

       sub _chomp { my &#40;$s&#41; = @_; chomp&#40;$s&#41;; $s }

       my $socket = IO::Socket::IP-&gt;new&#40; PeerHost =&gt; &#34;www.google.com:80&#34; &#41;
          or die $@;

       my &#40;$err, $hostname, $servicename&#41; = eval { getnameinfo&#40;$socket-&gt;peername&#41; };
       say $err || _chomp&#40;$@&#41; || $hostname;

       $socket-&gt;peername =~ /&#40;.*&#41;/s;

       &#40;$err, $hostname, $servicename&#41; = eval { getnameinfo&#40;$1&#41; };
       say $err || _chomp&#40;$@&#41; || $hostname;

       { no warnings &#34;void&#34;; &#34;$1&#34;; }

       &#40;$err, $hostname, $servicename&#41; = eval { getnameinfo&#40;$1&#41; };
       say $err || _chomp&#40;$@&#41; || $hostname;
    &#39;
    sea15s02-in-f4.1e100.net
    addr is not a string at -e line 18.
    sea15s02-in-f4.1e100.net
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1462013" href="/Public/Bug/Display.html?id=79557#txn-1462013">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;09&nbsp;14:59:32&nbsp;2015</span>
    <span class="description">IKEGAMI [...] cpan.org -  Requestor ikegami added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1462103" href="/Public/Bug/Display.html?id=79557#txn-1462103">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;09&nbsp;22:30:03&nbsp;2015</span>
    <span class="description">IKEGAMI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1462103/778086/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/778086">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 584b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jan 28 16:48:30 2015, ikegami wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Sep 10 17:21:56 2012, tlhackque wrote:
<div class="message-stanza open">&gt; &gt; In Socket.xs, we have:
&gt; &gt;     if&#40;!SvPOK&#40;addr&#41;&#41;
&gt; &gt;                 croak&#40;&#34;addr is not a string&#34;&#41;;
&gt; &gt;
&gt; &gt; I have no clue why we hit this croak.
</div>&gt; 
&gt; Socket.xs forgot to account for magic.
&gt; 
&gt; addr = ST&#40;0&#41;;
&gt; 
&gt; should be
&gt; 
&gt; addr = ST&#40;0&#41;;
&gt; SvGETMAGIC&#40;addr&#41;
</div>
I don&#39;t use taint -- just boring use of LWP::UserAgent -- and I intermittently suffer from this problem.

As I previously shown, the fix is dead simple &#40;just add &#34;SvGETMAGIC&#40;addr&#41;&#34;&#41;. I look forward to a release with this fix.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1462246" href="/Public/Bug/Display.html?id=79557#txn-1462246">#</a>      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;10&nbsp;07:04:23&nbsp;2015</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1462246/778181/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/778181">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 33b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed with test.

-- 

Paul Evans
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rt79557.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1462246/778182/rt79557.patch">Download rt79557.patch</a><br />
<span class="downloadcontenttype">text/x-diff 929b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">=== modified file &#39;Socket.xs&#39;
--- Socket.xs	2014-05-31 17:17:43 +0000
+++ Socket.xs	2015-02-10 12:03:49 +0000
@@ -530,6 +530,7 @@
 	SP -= items;
 
 	addr = ST&#40;0&#41;;
+	SvGETMAGIC&#40;addr&#41;;
 
 	if&#40;items &lt; 2&#41;
 		flags = 0;

=== modified file &#39;t/getnameinfo.t&#39;
--- t/getnameinfo.t	2014-10-08 20:43:15 +0000
+++ t/getnameinfo.t	2015-02-10 12:03:49 +0000
@@ -1,6 +1,6 @@
 use strict;
 use warnings;
-use Test::More tests =&gt; 12;
+use Test::More tests =&gt; 13;
 
 use Socket qw&#40;:addrinfo AF_INET pack_sockaddr_in inet_aton&#41;;
 
@@ -32,3 +32,8 @@
 cmp_ok&#40; $err, &#34;==&#34;, 0, &#39;$err == 0 for {family=AF_INET,port=80,sinaddr=127.0.0.1}/NI_NUMERICHOST&#39; &#41;;
 
 ok&#40; length $service, &#39;$service is nonzero length for NH&#39; &#41;;
+
+# RT79557
+pack_sockaddr_in&#40; 80, inet_aton&#40; &#34;127.0.0.1&#34; &#41; &#41; =~ m/^&#40;.*&#41;$/s;
+&#40; $err, $host, $service &#41; = getnameinfo&#40; $1, NI_NUMERICHOST|NI_NUMERICSERV &#41;;
+cmp_ok&#40; $err, &#34;==&#34;, 0, &#39;$err == 0 for $1&#39; &#41; or diag&#40; &#39;$err was: &#39; . $err &#41;;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1462249" href="/Public/Bug/Display.html?id=79557#txn-1462249">#</a>      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;10&nbsp;07:04:25&nbsp;2015</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1462413" href="/Public/Bug/Display.html?id=79557#txn-1462413">#</a>      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;10&nbsp;14:45:44&nbsp;2015</span>
    <span class="description">IKEGAMI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1462413/778289/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/778289">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 9b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1462757" href="/Public/Bug/Display.html?id=79557#txn-1462757">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;11&nbsp;07:34:42&nbsp;2015</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1462757/778499/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/778499">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 116b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Seems this isn&#39;t working. The test now fails on all perls 5.16 and earlier, but works fine on 5.18+

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1462760" href="/Public/Bug/Display.html?id=79557#txn-1462760">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;11&nbsp;07:34:44&nbsp;2015</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1462792" href="/Public/Bug/Display.html?id=79557#txn-1462792">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;11&nbsp;09:47:48&nbsp;2015</span>
    <span class="description">dolmen [...] cpan.org -  Requestor DOLMEN added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1462798" href="/Public/Bug/Display.html?id=79557#txn-1462798">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;11&nbsp;10:39:07&nbsp;2015</span>
    <span class="description">dolmen [...] cpan.org -  Dependency by ticket #102042 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1462820" href="/Public/Bug/Display.html?id=79557#txn-1462820">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;11&nbsp;13:34:58&nbsp;2015</span>
    <span class="description">IKEGAMI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1462820/778537/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/778537">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 169b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Feb 11 07:34:42 2015, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Seems this isn&#39;t working. The test now fails on all perls 5.16 and
&gt; earlier, but works fine on 5.18+
</div>
Will look at it today
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1462849" href="/Public/Bug/Display.html?id=79557#txn-1462849">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;11&nbsp;15:42:43&nbsp;2015</span>
    <span class="description">IKEGAMI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1462849/778549/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/778549">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Feb 11 13:34:58 2015, ikegami wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Feb 11 07:34:42 2015, PEVANS wrote:
<div class="message-stanza open">&gt; &gt; Seems this isn&#39;t working. The test now fails on all perls 5.16 and
&gt; &gt; earlier, but works fine on 5.18+
</div>&gt; 
&gt; Will look at it today
</div>
The test fails with and without SvGETMAGIC because only pPOK is set, not POK.

Before SvGETMAGIC &#40;5.16.3&#41;:

SV = PVMG&#40;0xb2f170&#41; at 0xbcf670
  REFCNT = 1
  FLAGS = &#40;GMG,SMG,pPOK&#41;
  IV = 0
  NV = 0
  PV = 0xa85600 &#34;$&#34;\0
  CUR = 1
  LEN = 16
  MAGIC = 0xbde710
    MG_VIRTUAL = &#38;PL_vtbl_sv
    MG_TYPE = PERL_MAGIC_sv&#40;\0&#41;
    MG_OBJ = 0xbcf658
    MG_LEN = 1
    MG_PTR = 0xbde340 &#34;1&#34;

After SvGETMAGIC &#40;5.16.3&#41;:

SV = PVMG&#40;0xb2f170&#41; at 0xbcf670
  REFCNT = 1
  FLAGS = &#40;GMG,SMG,pPOK&#41;
  IV = 0
  NV = 0
  PV = 0xa85600 &#34;\2\0\0P\177\0\0\1\0\0\0\0\0\0\0\0&#34;\0
  CUR = 16
  LEN = 24
  MAGIC = 0xbde710
    MG_VIRTUAL = &#38;PL_vtbl_sv
    MG_TYPE = PERL_MAGIC_sv&#40;\0&#41;
    MG_OBJ = 0xbcf658
    MG_LEN = 1
    MG_PTR = 0xbde340 &#34;1&#34;

Before SvGETMAGIC &#40;5.20.1&#41;:

SV = PVMG&#40;0x13b6240&#41; at 0x1487228
  REFCNT = 1
  FLAGS = &#40;GMG,SMG,POK,pPOK&#41;
  IV = 0
  NV = 0
  PV = 0x12d07f0 &#34;$&#34;\0
  CUR = 1
  LEN = 10
  MAGIC = 0x1498230
    MG_VIRTUAL = &#38;PL_vtbl_sv
    MG_TYPE = PERL_MAGIC_sv&#40;\0&#41;
    MG_OBJ = 0x1487210
    MG_LEN = 1

After SvGETMAGIC &#40;5.20.1&#41;:

SV = PVMG&#40;0x13b6240&#41; at 0x1487228
  REFCNT = 1
  FLAGS = &#40;GMG,SMG,POK,pPOK&#41;
  IV = 0
  NV = 0
  PV = 0x12d07f0 &#34;\2\0\0P\177\0\0\1\0\0\0\0\0\0\0\0&#34;\0
  CUR = 16
  LEN = 24
  MAGIC = 0x1498230
    MG_VIRTUAL = &#38;PL_vtbl_sv
    MG_TYPE = PERL_MAGIC_sv&#40;\0&#41;
    MG_OBJ = 0x1487210
    MG_LEN = 1

Looks like the correct check is SvPOKp rather than SvPOK. Tested.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1462852" href="/Public/Bug/Display.html?id=79557#txn-1462852">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;11&nbsp;15:50:06&nbsp;2015</span>
    <span class="description">IKEGAMI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1462852/778552/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/778552">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 402b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Feb 11 15:42:43 2015, ikegami wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Looks like the correct check is SvPOKp rather than SvPOK. Tested.
</div>
What I would actually use:

        SV* addr;
        char* addr_pv;
        STRLEN addr_len;

        addr = ST&#40;0&#41;;
        SvGETMAGIC&#40;addr&#41;;

        addr_pv = SvPVbyte&#40;addr, addr_len&#41;;
        if &#40;addr_len != sizeof&#40;struct sockaddr&#41;&#41;
                croak&#40;&#34;Incorrect value for addr&#34;&#41;;

        Newx&#40;sa, addr_len, char&#41;;
        Copy&#40;addr_pv, sa, addr_len, char&#41;;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1463328" href="/Public/Bug/Display.html?id=79557#txn-1463328">#</a>      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;13&nbsp;09:00:54&nbsp;2015</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1463328/778834/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/778834">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 49b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed in 2.018 by using SvPOKp&#40;&#41;

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1463331" href="/Public/Bug/Display.html?id=79557#txn-1463331">#</a>      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;13&nbsp;09:00:57&nbsp;2015</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1463333" href="/Public/Bug/Display.html?id=79557#txn-1463333">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;13&nbsp;09:00:59&nbsp;2015</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Fixed in 2.018 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.748569</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
