<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #7457 for MIME-tools: binary data incorrectly encoded into quoted-printable</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #7457 for MIME-tools: binary data incorrectly encoded into quoted-printable</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/MIME-tools/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/MIME-tools/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/MIME-tools/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/MIME-tools/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/MIME-tools">MIME-tools CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">7457</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/MIME-tools/Active/">MIME-tools</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ak2 [...] smr.ru

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-21368-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
6.200_02    </td>
  </tr>
  <tr id="CF-21369-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
5.416    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;24&nbsp;09:30:06&nbsp;2004</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> binary data incorrectly encoded into quoted-printable</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">MIME::Body produces incorrect quoted-printable encoding if the body is non-text data.

According to RFC2045 &#40;rule 4&#41; \015 and \012 bytes &#40;CR and LF&#41; of non-text data should be encoded as all other nonprintable bytes &#40;=0D, =0A&#41;, but input data encoded as a text chunk - leaving &#34;\n&#34; untouched.

It leads to data corruption when encoding on Unix binary data aimed to Win
for example. Byte \012 from the source data stream will be two byte sequence at the destination.

We&#39;ve encountered such a case on a real mail after mimedefang processing, using MIME-tools, which in turn uses MIME::Base64

Actually it&#39;s rather a MIME::Base64 issue. I posted it there too &#40;#7456&#41;.

IMHO the easiest solution is always encoding input as a binary stream.
It should work fine for both text and binary data, but actually such a approach is not thoroughly RFC-compliant.
In this case there is no need to modify MIME-tools modules.

I guess that to perfectly adhere to the RFC 2045, text and non-text input data should be processed in different ways &#40;rule 4&#41;, so another parameter indicating data type is necessary when making actual encoding&#40;i think that guessing data type in the module is not the right thing&#41;.
In this case some MIME-tools modules should be modified too.

Suggested patch is attached. In this case encode_qp &#40;from MIME::Base64&#41; will get up to 3 input parameters: data, eol, and flag indicating whether the input data stream is a text.
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;25&nbsp;07:38:23&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ak2 [...] smr.ru</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">MIME::Base64 has been corrected &#40;binmode.patch&#41;. 
encode_qp since version 3.02 takes up 3 args. Third arg is a flag indicating binary mode.
Since the flag meaning is inverted comparing to the MIME::Base64 patch suggested originally,
the corresponding MIME-tools patch should be modified also.
Attached is corrected MIME-tools patch.
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -u -r MIME-tools-6.200_02.orig/lib/MIME/Decoder/QuotedPrint.pm MIME-tools-6.200_02/lib/MIME/Decoder/QuotedPrint.pm
--- MIME-tools-6.200_02.orig/lib/MIME/Decoder/QuotedPrint.pm	Wed Jun  4 22:54:02 2003
+++ MIME-tools-6.200_02/lib/MIME/Decoder/QuotedPrint.pm	Wed Aug 25 16:30:52 2004
@@ -71,7 +71,7 @@
 # grow beyond 76 characters!
 #
 sub encode_qp_really {
-    my $enc = encode_qp&#40;$_[0]&#41;;
+    my $enc = encode_qp&#40;shift, undef, not shift&#41;;
     if &#40;length&#40;$enc&#41; &lt; 74&#41; {
 	$enc =~ s/^\.$/=2E/g;         # force encoding of /^\.$/
 	$enc =~ s/^From /=46rom /g;   # force encoding of /^From /
@@ -98,11 +98,11 @@
 # encode_it IN, OUT
 #
 sub encode_it {
-    my &#40;$self, $in, $out&#41; = @_;
+    my &#40;$self, $in, $out, $textual_type&#41; = @_;
     local&#40;$_&#41;;
 
     while &#40;defined&#40;$_ = $in-&gt;getline&#41;&#41; {
-	$out-&gt;print&#40;encode_qp_really&#40;$_&#41;&#41;;
+	$out-&gt;print&#40;encode_qp_really&#40;$_, $textual_type&#41;&#41;;
     }
     1;
 }
diff -u -r MIME-tools-6.200_02.orig/lib/MIME/Decoder.pm MIME-tools-6.200_02/lib/MIME/Decoder.pm
--- MIME-tools-6.200_02.orig/lib/MIME/Decoder.pm	Sat Jun  7 04:41:38 2003
+++ MIME-tools-6.200_02/lib/MIME/Decoder.pm	Tue Aug 24 16:37:20 2004
@@ -248,14 +248,14 @@
 =cut
 
 sub encode {
-    my &#40;$self, $in, $out&#41; = @_;
+    my &#40;$self, $in, $out, $textual_type&#41; = @_;
     
     ### Coerce old-style filehandles to legit objects, and do it!
     $in  = wraphandle&#40;$in&#41;;
     $out = wraphandle&#40;$out&#41;;
 
     ### Invoke back-end method to do the work:
-    $self-&gt;encode_it&#40;$in, $out&#41; || 
+    $self-&gt;encode_it&#40;$in, $out, $self-&gt;encoding eq &#39;quoted-printable&#39; ? &#40;$textual_type&#41; : &#40;&#41;&#41; || 
 	die &#34;&#34;.$self-&gt;encoding.&#34; encoding failed\n&#34;;
 }
 
diff -u -r MIME-tools-6.200_02.orig/lib/MIME/Entity.pm MIME-tools-6.200_02/lib/MIME/Entity.pm
--- MIME-tools-6.200_02.orig/lib/MIME/Entity.pm	Fri Jun 27 22:54:30 2003
+++ MIME-tools-6.200_02/lib/MIME/Entity.pm	Tue Aug 24 16:55:08 2004
@@ -1935,7 +1935,7 @@
 
     ### Output the body:
     my $IO = $self-&gt;open&#40;&#34;r&#34;&#41;     || die &#34;open body: $!&#34;;
-    $decoder-&gt;encode&#40;$IO, $out&#41;   || die &#34;encoding failed\n&#34;;
+    $decoder-&gt;encode&#40;$IO, $out, textual_type&#40;$self-&gt;head-&gt;mime_type&#41; ? 1 : 0&#41;   || die &#34;encoding failed\n&#34;;
     $IO-&gt;close;
     1;
 }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;29&nbsp;17:16:24&nbsp;2007</span>
    <span class="description">dmo+pause [...] dmo.ca -  Fixed in 5.416 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;29&nbsp;17:16:34&nbsp;2007</span>
    <span class="description">dmo+pause [...] dmo.ca -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
