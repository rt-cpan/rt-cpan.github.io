<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #20959 for Test-Simple: patch to make noplan safer</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #20959 for Test-Simple: patch to make noplan safer</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Test-Simple/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Test-Simple/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Test-Simple/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Test-Simple/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="http://github.com/Test-More/test-more/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Test-Simple">Test-Simple CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">20959</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Test-Simple/Active/">Test-Simple</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
gam3-pause [...] gam3.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-31590-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-31591-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;12&nbsp;08:21:07&nbsp;2006</span>
    <span class="description">gam3-pause [...] gam3.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is a patch that adds a plan that is simular to no_plan, called
plan_at_end.

The only difference between this plan and no_plan is that a funtion
called end_of_tests&#40;&#41; must be called at the end of the test or the test
will fail.

The no_plan plan has the problem that exit&#40;0&#41; will allow the test to
pass even if not all the test have been run.  This plan overcomes this
problem.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;20&nbsp;05:33:04&nbsp;2006</span>
    <span class="description">gam3-pause [...] gam3.net -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;20&nbsp;05:43:20&nbsp;2006</span>
    <span class="description">gam3-pause [...] gam3.net -  Subject changed from &#40;no value&#41; to &#39;patch yo make noplan safer&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;20&nbsp;05:43:20&nbsp;2006</span>
    <span class="description">gam3-pause [...] gam3.net -  Status changed from &#39;open&#39; to &#39;new&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;20&nbsp;05:43:53&nbsp;2006</span>
    <span class="description">gam3-pause [...] gam3.net -  Subject changed from &#39;patch yo make noplan safer&#39; to &#39;patch to make noplan safer&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;22&nbsp;12:51:46&nbsp;2006</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Aug 12 08:21:07 2006, GAM wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This is a patch that adds a plan that is simular to no_plan, called
&gt; plan_at_end.
&gt; 
&gt; The only difference between this plan and no_plan is that a funtion
&gt; called end_of_tests&#40;&#41; must be called at the end of the test or the test
&gt; will fail.
&gt; 
&gt; The no_plan plan has the problem that exit&#40;0&#41; will allow the test to
&gt; pass even if not all the test have been run.  This plan overcomes this
&gt; problem.
</div>
I applaud this design.

This was discussed some PerlMonks recently. It seems the primary reason
to maintain a test count is to know if you died in the middle, and thus
some tests were missed. 

I had proposed basically the same thing on PerlMonks a few days ago:
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.perlmonks.org/?node_id=566523">http://www.perlmonks.org/?node_id=566523</a></span>

This design allows you to have the convenience of no_plan, with the
benefit of knowing if all tests have been run.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;22&nbsp;12:51:48&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;05&nbsp;13:07:03&nbsp;2006</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think I like this.  I&#39;m just always hesitant to add more functions to
Test::More so I need some convincing on the name.

Also, please rework the patch so that $self-&gt;{No_Plan} isn&#39;t a big snarl
of numeric modes.  The flags are true or false, I&#39;m not going to
remember what magic is associated with $self-&gt;{No_Plan} == 3.  No, don&#39;t
use constants.  Add a $self-&gt;{Plan_At_End} flag instead.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;26&nbsp;12:44:18&nbsp;2007</span>
    <span class="description">gam3-pause [...] gam3.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> GAM [...] cpan.org</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Nov 05 13:07:03 2006, MSCHWERN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think I like this.  I&#39;m just always hesitant to add more functions to
&gt; Test::More so I need some convincing on the name.
&gt; 
&gt; Also, please rework the patch so that $self-&gt;{No_Plan} isn&#39;t a big snarl
&gt; of numeric modes.  The flags are true or false, I&#39;m not going to
&gt; remember what magic is associated with $self-&gt;{No_Plan} == 3.  No, don&#39;t
&gt; use constants.  Add a $self-&gt;{Plan_At_End} flag instead.
</div>
Here is a new patch.  It uses plan&#40;&#41; at end rather than the
end_of_tests&#40;&#41; function.  I cleaned up the flags and made it so that a
number could be supplied with the plan&#40;&#41; at end.

There are three tests.

I cleaned up the flags and added some documentation.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -rNu Test-Simple-0.67.orig/lib/Test/Builder.pm Test-Simple-0.67/lib/Test/Builder.pm
--- Test-Simple-0.67.orig/lib/Test/Builder.pm	2007-01-22 16:28:15.000000000 -0500
+++ Test-Simple-0.67/lib/Test/Builder.pm	2007-01-26 12:20:32.000000000 -0500
@@ -180,6 +180,8 @@
     $self-&gt;{Test_Died}    = 0;
     $self-&gt;{Have_Plan}    = 0;
     $self-&gt;{No_Plan}      = 0;
+    $self-&gt;{Plan_At_End}  = 0;
+    $self-&gt;{Tests_Done}   = 0;
     $self-&gt;{Original_Pid} = $$;
 
     share&#40;$self-&gt;{Curr_Test}&#41;;
@@ -232,6 +234,7 @@
 =item B&lt;plan&gt;
 
   $Test-&gt;plan&#40;&#39;no_plan&#39;&#41;;
+  $Test-&gt;plan&#40;&#39;plan_at_end&#39;&#41;;
   $Test-&gt;plan&#40; skip_all =&gt; $reason &#41;;
   $Test-&gt;plan&#40; tests =&gt; $num_tests &#41;;
 
@@ -245,10 +248,14 @@
 sub plan {
     my&#40;$self, $cmd, $arg&#41; = @_;
 
-    return unless $cmd;
-
     local $Level = $Level + 1;
 
+    if &#40;$self-&gt;{Plan_At_End}&#41; {
+	return $self-&gt;end_of_tests&#40;$cmd&#41;;
+    }
+
+    return unless $cmd;
+
     if&#40; $self-&gt;{Have_Plan} &#41; {
         $self-&gt;croak&#40;&#34;You tried to plan twice&#34;&#41;;
     }
@@ -256,6 +263,9 @@
     if&#40; $cmd eq &#39;no_plan&#39; &#41; {
         $self-&gt;no_plan;
     }
+    elsif&#40; $cmd eq &#39;plan_at_end&#39; &#41; {
+        $self-&gt;plan_at_end;
+    }
     elsif&#40; $cmd eq &#39;skip_all&#39; &#41; {
         return $self-&gt;skip_all&#40;$arg&#41;;
     }
@@ -321,11 +331,63 @@
     $self-&gt;{Have_Plan} = 1;
 }
 
+=item B&lt;plan_at_end&gt;
+
+  $plan = $Test-&gt;plan_at_end
+
+Declares that this test will run an indeterminate # of tests and then call C&lt;end_of_tests&#40;&#41;&gt;.
+
+=cut
+
+sub plan_at_end {
+    my $self = shift;
+
+    $self-&gt;{Plan_At_End} = 1;
+    $self-&gt;{Have_Plan}   = 1;
+}
+
+=item B&lt;end_of_tests&gt;
+
+  $Test-&gt;end_of_tests
+
+Declares that no more tests will be run.
+
+=cut
+
+
+sub end_of_tests {
+    my $self = shift;
+    my $tests = shift;
+
+    local $Level = $Level + 1;
+
+    if &#40;defined $tests &#38;&#38; !$tests&#41; {
+        $self-&gt;croak&#40;&#34;Plan called with bad value &#34; . $tests&#41;;
+    }
+    $tests ||= $self-&gt;{Curr_Test};
+
+    if &#40;$self-&gt;{No_Plan} == 1&#41; {
+        $self-&gt;croak&#40;&#34;Us plan_at_end in place of no_plan if you want to do this.&#34;&#41;;
+    }
+    if &#40;$self-&gt;{Tests_Done}&#41; {
+        $self-&gt;carp&#40;&#34;You called plan more than once after end of tests.&#34;&#41;;
+    }
+    if &#40;$self-&gt;{Expected_Tests}&#41; {
+        $self-&gt;croak&#40;&#34;You have a plan, you don&#39;t call plan at end.&#34;&#41;;
+    } else {
+        $self-&gt;{Expected_Tests} = $tests;
+    }
+    $self-&gt;{Tests_Done}++;
+}
+
 =item B&lt;has_plan&gt;
 
   $plan = $Test-&gt;has_plan
 
-Find out whether a plan has been defined. $plan is either C&lt;undef&gt; &#40;no plan has been set&#41;, C&lt;no_plan&gt; &#40;indeterminate # of tests&#41; or an integer &#40;the number of expected tests&#41;.
+Find out whether a plan has been defined. $plan is either C&lt;undef&gt; &#40;no
+plan has been set&#41;, C&lt;no_plan&gt; &#40;indeterminate # of tests&#41;,
+C&lt;plan_at_end&gt; &#40;no tests after end_of_tests called&#41; or an integer &#40;the
+number of expected tests&#41;.
 
 =cut
 
@@ -333,6 +395,7 @@
     my $self = shift;
 
     return&#40;$self-&gt;{Expected_Tests}&#41; if $self-&gt;{Expected_Tests};
+    return&#40;&#39;plan_at_end&#39;&#41; if $self-&gt;{Plan_At_End};
     return&#40;&#39;no_plan&#39;&#41; if $self-&gt;{No_Plan};
     return&#40;undef&#41;;
 };
@@ -1357,6 +1420,9 @@
 sub _plan_check {
     my $self = shift;
 
+    if&#40; $self-&gt;{Plan_At_End} &#38;&#38; $self-&gt;{Tests_Done} &#41; {
+        $self-&gt;croak&#40;&#34;You tried to run a test after the end of the tests.&#34;&#41;;
+    }
     unless&#40; $self-&gt;{Have_Plan} &#41; {
         local $Level = $Level + 2;
         $self-&gt;croak&#40;&#34;You tried to run a test without a plan&#34;&#41;;
@@ -1651,6 +1717,9 @@
             $self-&gt;_print&#40;&#34;1..$self-&gt;{Curr_Test}\n&#34;&#41; unless $self-&gt;no_header;
             $self-&gt;{Expected_Tests} = $self-&gt;{Curr_Test};
         }
+        if&#40; $self-&gt;{Plan_At_End} &#41; {
+            $self-&gt;_print&#40;&#34;1..$self-&gt;{Expected_Tests}\n&#34;&#41; unless $self-&gt;no_header;
+        }
 
         # Auto-extended arrays and elements which aren&#39;t explicitly
         # filled in with a shared reference will puke under 5.8.0
@@ -1697,6 +1766,12 @@
 
             _my_exit&#40; 255 &#41; &#38;&#38; return;
         }
+        if&#40; $self-&gt;{Plan_At_End} &#38;&#38; !$self-&gt;{Tests_Done} &#41; {
+            $self-&gt;diag&#40;&lt;&lt;&#34;FAIL&#34;&#41;;
+Either your test exited early or you forgot to include end_of_test&#40;&#41; at the end of your test.
+FAIL
+            $num_failed = 254;
+        }
 
         my $exit_code;
         if&#40; $num_failed &#41; {
diff -rNu Test-Simple-0.67.orig/lib/Test/More.pm Test-Simple-0.67/lib/Test/More.pm
--- Test-Simple-0.67.orig/lib/Test/More.pm	2007-01-22 16:28:15.000000000 -0500
+++ Test-Simple-0.67/lib/Test/More.pm	2007-01-26 11:41:20.000000000 -0500
@@ -45,6 +45,8 @@
   # or
   use Test::More qw&#40;no_plan&#41;;
   # or
+  use Test::More qw&#40;plan_at_end&#41;;
+  # or
   use Test::More skip_all =&gt; $reason;
 
   BEGIN { use_ok&#40; &#39;Some::Module&#39; &#41;; }
@@ -91,6 +93,10 @@
   # UNIMPLEMENTED!!!
   my @status = Test::More::status;
 
+  # if plan is plan_at_end
+  plan&#40;&#41;
+  #or
+  plan&#40;$no_of_tests&#41;;
 
 =head1 DESCRIPTION
 
@@ -124,6 +130,17 @@
 B&lt;NOTE&gt;: using no_plan requires a Test::Harness upgrade else it will
 think everything has failed.  See L&lt;CAVEATS and NOTES&gt;&#41;.
 
+You can also use the plan_at_end to help when you don&#39;t know the
+number of tests you are going to run. This will catch some errors that
+no_plan will let through, but you need to be carful that tests are not
+being skipped.
+
+  use Test::More qw&#40;plan_at_end&#41;;
+
+  pass&#40;&#39;test&#39;&#41;;
+
+  plan&#40;1&#41;;
+
 In some cases, you&#39;ll want to completely skip an entire testing script.
 
   use Test::More skip_all =&gt; $skip_reason;
@@ -154,6 +171,15 @@
       plan tests =&gt; 42;
   }
 
+=over 4
+
+=item B&lt;end_of_tests&gt;
+
+If your plan is I&lt;plan_at_end&gt; you must call end_of_tests&#40;&#41; after all tests
+have been run.
+
+=back
+
 =cut
 
 sub plan {
@@ -162,7 +188,6 @@
     $tb-&gt;plan&#40;@_&#41;;
 }
 
-
 # This implements &#34;use Test::More &#39;no_diag&#39;&#34; but the behavior is
 # deprecated.
 sub import_extra {
@@ -997,7 +1022,7 @@
     unless&#40; defined $how_many &#41; {
         # $how_many can only be avoided when no_plan is in use.
         _carp &#34;skip&#40;&#41; needs to know \$how_many tests are in the block&#34;
-          unless $tb-&gt;has_plan eq &#39;no_plan&#39;;
+          unless $tb-&gt;has_plan eq &#39;no_plan&#39; or $tb-&gt;has_plan eq &#39;plan_at_end&#39;;
         $how_many = 1;
     }
 
@@ -1083,7 +1108,7 @@
     unless&#40; defined $how_many &#41; {
         # $how_many can only be avoided when no_plan is in use.
         _carp &#34;todo_skip&#40;&#41; needs to know \$how_many tests are in the block&#34;
-          unless $tb-&gt;has_plan eq &#39;no_plan&#39;;
+          unless $tb-&gt;has_plan eq &#39;no_plan&#39; or $tb-&gt;has_plan eq &#39;plan_at_end&#39;;
         $how_many = 1;
     }
 
diff -rNu Test-Simple-0.67.orig/t/lib/Test/Simple/Catch.pm Test-Simple-0.67/t/lib/Test/Simple/Catch.pm
--- Test-Simple-0.67.orig/t/lib/Test/Simple/Catch.pm	2006-08-31 01:24:17.000000000 -0400
+++ Test-Simple-0.67/t/lib/Test/Simple/Catch.pm	2007-01-26 11:41:20.000000000 -0500
@@ -8,7 +8,7 @@
 my $err = tie *$err_fh, &#39;TieOut&#39;;
 
 use Test::Builder;
-my $t = Test::Builder-&gt;new;
+our $t = Test::Builder-&gt;new;
 $t-&gt;output&#40;$out_fh&#41;;
 $t-&gt;failure_output&#40;$err_fh&#41;;
 $t-&gt;todo_output&#40;$err_fh&#41;;
diff -rNu Test-Simple-0.67.orig/t/plan_is_plan_at_end.t Test-Simple-0.67/t/plan_is_plan_at_end.t
--- Test-Simple-0.67.orig/t/plan_is_plan_at_end.t	1969-12-31 19:00:00.000000000 -0500
+++ Test-Simple-0.67/t/plan_is_plan_at_end.t	2007-01-26 12:10:57.000000000 -0500
@@ -0,0 +1,60 @@
+BEGIN {
+    if&#40; $ENV{PERL_CORE} &#41; {
+        chdir &#39;t&#39;;
+        @INC = &#40;&#39;../lib&#39;, &#39;lib&#39;&#41;;
+    }
+    else {
+        unshift @INC, &#39;t/lib&#39;;
+    }
+}
+
+# Can&#39;t use Test.pm, that&#39;s a 5.005 thing.
+package My::Test;
+
+print &#34;1..2\n&#34;;
+
+my $test_num = 1;
+# Utility testing functions.
+sub ok &#40;$;$&#41; {
+    my&#40;$test, $name&#41; = @_;
+    my $ok = &#39;&#39;;
+    $ok .= &#34;not &#34; unless $test;
+    $ok .= &#34;ok $test_num&#34;;
+    $ok .= &#34; - $name&#34; if defined $name;
+    $ok .= &#34;\n&#34;;
+    print $ok;
+    $test_num++;
+}
+
+
+package main;
+
+require Test::Simple;
+
+require Test::Simple::Catch;
+my&#40;$out, $err&#41; = Test::Simple::Catch::caught&#40;&#41;;
+
+my $t;
+if &#40;$Test::Simple::Catch::t&#41; {
+    $t = $Test::Simple::Catch::t;
+}
+
+$t-&gt;plan&#40;&#39;plan_at_end&#39;&#41;;
+
+$t-&gt;ok&#40;1, &#39;foo&#39;&#41;;
+$t-&gt;ok&#40;2, &#39;bar&#39;&#41;;
+
+$t-&gt;plan&#40;&#41;;
+
+END {
+    My::Test::ok&#40;$$out eq &lt;&lt;OUT&#41;;
+ok 1 - foo
+ok 2 - bar
+1..2
+OUT
+    My::Test::ok&#40;$$err eq &lt;&lt;ERR&#41;;
+ERR
+
+    # Prevent Test::Simple from exiting with non zero
+    exit 0;
+}
diff -rNu Test-Simple-0.67.orig/t/plan_is_plan_at_end_2.t Test-Simple-0.67/t/plan_is_plan_at_end_2.t
--- Test-Simple-0.67.orig/t/plan_is_plan_at_end_2.t	1969-12-31 19:00:00.000000000 -0500
+++ Test-Simple-0.67/t/plan_is_plan_at_end_2.t	2007-01-26 12:10:33.000000000 -0500
@@ -0,0 +1,60 @@
+BEGIN {
+    if&#40; $ENV{PERL_CORE} &#41; {
+        chdir &#39;t&#39;;
+        @INC = &#40;&#39;../lib&#39;, &#39;lib&#39;&#41;;
+    }
+    else {
+        unshift @INC, &#39;t/lib&#39;;
+    }
+}
+
+# Can&#39;t use Test.pm, that&#39;s a 5.005 thing.
+package My::Test;
+
+print &#34;1..2\n&#34;;
+
+my $test_num = 1;
+# Utility testing functions.
+sub ok &#40;$;$&#41; {
+    my&#40;$test, $name&#41; = @_;
+    my $ok = &#39;&#39;;
+    $ok .= &#34;not &#34; unless $test;
+    $ok .= &#34;ok $test_num&#34;;
+    $ok .= &#34; - $name&#34; if defined $name;
+    $ok .= &#34;\n&#34;;
+    print $ok;
+    $test_num++;
+}
+
+
+package main;
+
+require Test::Simple;
+
+require Test::Simple::Catch;
+my&#40;$out, $err&#41; = Test::Simple::Catch::caught&#40;&#41;;
+
+my $t;
+if &#40;$Test::Simple::Catch::t&#41; {
+    $t = $Test::Simple::Catch::t;
+}
+
+$t-&gt;plan&#40;&#39;plan_at_end&#39;&#41;;
+
+$t-&gt;ok&#40;1, &#39;foo&#39;&#41;;
+$t-&gt;ok&#40;2, &#39;bar&#39;&#41;;
+
+$t-&gt;plan&#40;2&#41;;
+
+END {
+    My::Test::ok&#40;$$out eq &lt;&lt;OUT&#41;;
+ok 1 - foo
+ok 2 - bar
+1..2
+OUT
+    My::Test::ok&#40;$$err eq &lt;&lt;ERR&#41;;
+ERR
+
+    # Prevent Test::Simple from exiting with non zero
+    exit 0;
+}
diff -rNu Test-Simple-0.67.orig/t/plan_is_plan_at_end_3.t Test-Simple-0.67/t/plan_is_plan_at_end_3.t
--- Test-Simple-0.67.orig/t/plan_is_plan_at_end_3.t	1969-12-31 19:00:00.000000000 -0500
+++ Test-Simple-0.67/t/plan_is_plan_at_end_3.t	2007-01-26 12:16:11.000000000 -0500
@@ -0,0 +1,61 @@
+BEGIN {
+    if&#40; $ENV{PERL_CORE} &#41; {
+        chdir &#39;t&#39;;
+        @INC = &#40;&#39;../lib&#39;, &#39;lib&#39;&#41;;
+    }
+    else {
+        unshift @INC, &#39;t/lib&#39;;
+    }
+}
+
+# Can&#39;t use Test.pm, that&#39;s a 5.005 thing.
+package My::Test;
+
+print &#34;1..2\n&#34;;
+
+my $test_num = 1;
+# Utility testing functions.
+sub ok &#40;$;$&#41; {
+    my&#40;$test, $name&#41; = @_;
+    my $ok = &#39;&#39;;
+    $ok .= &#34;not &#34; unless $test;
+    $ok .= &#34;ok $test_num&#34;;
+    $ok .= &#34; - $name&#34; if defined $name;
+    $ok .= &#34;\n&#34;;
+    print $ok;
+    $test_num++;
+}
+
+
+package main;
+
+require Test::Simple;
+
+require Test::Simple::Catch;
+my&#40;$out, $err&#41; = Test::Simple::Catch::caught&#40;&#41;;
+
+my $t;
+if &#40;$Test::Simple::Catch::t&#41; {
+    $t = $Test::Simple::Catch::t;
+}
+
+$t-&gt;plan&#40;&#39;plan_at_end&#39;&#41;;
+
+$t-&gt;ok&#40;1, &#39;foo&#39;&#41;;
+$t-&gt;ok&#40;2, &#39;bar&#39;&#41;;
+
+$t-&gt;plan&#40;3&#41;;
+
+END {
+    My::Test::ok&#40;$$out eq &lt;&lt;OUT&#41;;
+ok 1 - foo
+ok 2 - bar
+1..3
+OUT
+    My::Test::ok&#40;$$err eq &lt;&lt;ERR&#41;;
+# Looks like you planned 3 tests but only ran 2.
+ERR
+
+    # Prevent Test::Simple from exiting with non zero
+    exit 0;
+}
diff -rNu Test-Simple-0.67.orig/t/sm.t Test-Simple-0.67/t/sm.t
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;06&nbsp;19:38:48&nbsp;2007</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> MSCHWERN [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jan 26 12:44:18 2007, GAM wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Here is a new patch.  It uses plan&#40;&#41; at end rather than the
&gt; end_of_tests&#40;&#41; function.  I cleaned up the flags and made it so that a
&gt; number could be supplied with the plan&#40;&#41; at end.
</div>
+ use Test::More qw&#40;plan_at_end&#41;;
+
+ pass&#40;&#39;test&#39;&#41;;
+
+ plan&#40;1&#41;;

So I&#39;m clear, this is so you can put in the number of expected tests at
the end like if you have a flexible number of tests you can build up the
number and set it at the end?  Ok, handy, but that still requires
counting.  Taking that further, it would be great to have a way to add
to the existing total so you can total them up.

I also liked the &#34;until I say I&#39;m done&#34; variant of no_plan where you
don&#39;t have to count at all.  I would like to see that back.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;03&nbsp;20:49:43&nbsp;2009</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">A similar feature has been implemented as done_testing&#40;&#41;.  See
<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/schwern/test-more/commit/5cd0ad7c09187fd9244a0153e1fe0545acfe454e">http://github.com/schwern/test-more/commit/5cd0ad7c09187fd9244a0153e1fe0545acfe454e</a></span>

Unlike the patch here, it does not require any sort of predeclaration. 
So this works fine:

  use Test::More;

  pass&#40;&#41;;
  done_testing&#40;1&#41;;

After experimenting I found the predeclaration artificial and added
little but more typing.

Please give my version a review, I feel like I haven&#39;t caught all the
edge cases.  In particular the way done_testing&#40;&#41; fails and how it
interacts with an existing plan needs review.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;03&nbsp;20:49:44&nbsp;2009</span>
    <span class="description">mschwern [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
