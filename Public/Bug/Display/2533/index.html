<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #2533 for Net-DNS: [PATCH] DHCP nameserver not found on Win2K server</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #2533 for Net-DNS: [PATCH] DHCP nameserver not found on Win2K server</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-DNS/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-DNS">Net-DNS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">2533</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-DNS/Active/">Net-DNS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">rt-cpan [...] triv.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jand [...] ActiveState.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-22454-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.34    </td>
  </tr>
  <tr id="CF-22455-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;07&nbsp;19:24:46&nbsp;2003</span>
    <span class="description">JDB [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] DHCP nameserver not found on Win2K server</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On my Win2K Server box, Net::DNS::Resolver doesn&#39;t pick up the nameservers.  The attached patch makes it look at the DhcpNameServer field in addition to just the NameServer field in the registry.  This patch is probably only relevant for Win2K and WinXP.
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- .backup~/Resolver.pm~	Tue Feb 18 13:22:33 2003
+++ Resolver.pm	Wed May 07 16:05:41 2003
@@ -248,6 +248,8 @@
 				my $type;
 				$regiface-&gt;QueryValueEx&#40;&#34;NameServer&#34;, $type, $ns&#41;;
 				$nameservers .= &#34; $ns&#34; if $ns;
+				$regiface-&gt;QueryValueEx&#40;&#34;DhcpNameServer&#34;, $type, $ns&#41;;
+				$nameservers .= &#34; $ns&#34; if $ns;
 			}
 		}
 	}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;07&nbsp;20:24:26&nbsp;2003</span>
    <span class="description">JDB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jdb</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[JDB - Wed May  7 19:24:46 2003]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On my Win2K Server box, Net::DNS::Resolver doesn&#39;t pick up the
&gt;    nameservers.  The attached patch makes it look at the
&gt;    DhcpNameServer field in addition to just the NameServer field in
&gt;    the registry.  This patch is probably only relevant for Win2K and
&gt;    WinXP.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;07&nbsp;20:26:19&nbsp;2003</span>
    <span class="description">JDB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jdb</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[JDB - Wed May  7 19:24:46 2003]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On my Win2K Server box, Net::DNS::Resolver doesn&#39;t pick up the
&gt;    nameservers.  The attached patch makes it look at the
&gt;    DhcpNameServer field in addition to just the NameServer field in
&gt;    the registry.  This patch is probably only relevant for Win2K and
&gt;    WinXP.
</div>
[Sorry for the empty comment; RT was acting up on me.]

Please don&#39;t apply the patch just yet; I&#39;ll try to enhance it to 
address the issues of bug #2465 &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/NoAuth/Bug.html">https://rt.cpan.org/NoAuth/Bug.html</a></span>?
id=2465&#41; as well.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;07&nbsp;21:35:13&nbsp;2003</span>
    <span class="description">JDB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> JDB</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[JDB - Wed May  7 20:26:19 2003]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Please don&#39;t apply the patch just yet; I&#39;ll try to enhance it to 
&gt; address the issues of bug #2465 &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/NoAuth/Bug.html">https://rt.cpan.org/NoAuth/Bug.html</a></span>?
&gt; id=2465&#41; as well.
</div>
Ok, the &#40;attached&#41; updated patch should solve bug #2465 and enable 
Net::DNS to find the nameservers on Windows 95/98/Me &#40;later part is 
untested, but I did verify that 
SYSTEM\CurrentControlSet\Services\VxD\MSTCP exists and contains the 
relevant information on 95 and Me&#41;.

This patch correctly decodes the DNSServerAddresses value of the 
DNSRegisteredAdapters key.  It now also enumerates *all* interfaces, 
instead of just the ones that are also listed under 
DNSRegisteredAdapters.  That change should fix bug @2465.

This patch includes my earlier one.
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Resolver.orig	Tue Feb 18 13:22:33 2003
+++ Resolver.pm	Wed May 07 18:22:54 2003
@@ -196,21 +196,14 @@
 
 sub res_init_microsoft {
 	my &#40;$resobj, %keys&#41;;
-	
-	# This will *not* work on win95/98/ME...OTOH, who cares?
-	# Ok, so some do...simplest is probably to parse output
-	# of: &#40;these are best guesses - no such systems to test on&#41;
-	# &#40;on 95&#41; &#39;winipcfg /all /batch&#39;
-	# &#40;on 98 &#38; ME&#41; &#39;ipconfig /all /batch&#39;
-	# There might be the required data resident under .../VxD/MSTCP in 
-	# the registry on those machines but this is hearsay
-	# Actually, the trick of parsing &#39;ipconfig&#39; could be applied
-	# to NT/W2K/XP too for some insulation...
-	
-	my $root = &#39;SYSTEM\CurrentControlSet\Services\Tcpip\Parameters&#39;;
 
-	$main::HKEY_LOCAL_MACHINE-&gt;Open&#40;$root, $resobj&#41;
-		or Carp::croak &#34;can&#39;t read registry: $!&#34;;
+	my $root = &#39;SYSTEM\CurrentControlSet\Services\Tcpip\Parameters&#39;;
+	unless &#40;$main::HKEY_LOCAL_MACHINE-&gt;Open&#40;$root, $resobj&#41;&#41; {
+		# Didn&#39;t work, maybe we are on 95/98/Me?
+		$root = &#39;SYSTEM\CurrentControlSet\Services\VxD\MSTCP&#39;;
+		$main::HKEY_LOCAL_MACHINE-&gt;Open&#40;$root, $resobj&#41;
+			or Carp::croak &#34;can&#39;t read registry: $!&#34;;
+	}
 
 	$resobj-&gt;GetValues&#40;\%keys&#41;
 		or Carp::croak &#34;can&#39;t read registry values: $!&#34;;
@@ -234,12 +227,29 @@
 	# opt to silently fail if something isn&#39;t ok &#40;maybe we&#39;re on NT4&#41;
 	# drop any duplicates later
 	my $dnsadapters;
-	my $interfaces;
 	$resobj-&gt;Open&#40;&#34;DNSRegisteredAdapters&#34;, $dnsadapters&#41;;
+	if &#40;$dnsadapters&#41; {
+		my @adapters;
+		$dnsadapters-&gt;GetKeys&#40;\@adapters&#41;;
+		foreach my $adapter &#40;@adapters&#41; {
+			my $regadapter;
+			$dnsadapters-&gt;Open&#40;$adapter, $regadapter&#41;;
+			if &#40;$regadapter&#41; {
+				my&#40;$type,$ns&#41;;
+				$regadapter-&gt;QueryValueEx&#40;&#34;DNSServerAddresses&#34;, $type, $ns&#41;;
+				while &#40;length&#40;$ns&#41; &gt;= 4&#41; {
+					my $addr = join&#40;&#39;.&#39;, unpack&#40;&#34;C4&#34;, substr&#40;$ns,0,4,&#34;&#34;&#41;&#41;&#41;;
+					$nameservers .= &#34; $addr&#34;;
+				}
+			}
+		}
+	}
+
+	my $interfaces;
 	$resobj-&gt;Open&#40;&#34;Interfaces&#34;, $interfaces&#41;;
-	if &#40;$dnsadapters and $interfaces&#41; {
+	if &#40;$interfaces&#41; {
 		my @ifacelist;
-		$dnsadapters-&gt;GetKeys&#40;\@ifacelist&#41;;
+		$interfaces-&gt;GetKeys&#40;\@ifacelist&#41;;
 		foreach my $iface &#40;@ifacelist&#41; {
 			my $regiface;
 			$interfaces-&gt;Open&#40;$iface, $regiface&#41;;
@@ -247,6 +257,8 @@
 				my $ns;
 				my $type;
 				$regiface-&gt;QueryValueEx&#40;&#34;NameServer&#34;, $type, $ns&#41;;
+				$nameservers .= &#34; $ns&#34; if $ns;
+				$regiface-&gt;QueryValueEx&#40;&#34;DhcpNameServer&#34;, $type, $ns&#41;;
 				$nameservers .= &#34; $ns&#34; if $ns;
 			}
 		}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;08&nbsp;02:58:26&nbsp;2003</span>
    <span class="description">rt-cpan [...] triv.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[JDB - Wed May  7 21:35:13 2003]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Ok, the &#40;attached&#41; updated patch should solve bug #2465 and enable
&gt; Net::DNS to find the nameservers on Windows 95/98/Me &#40;later part is
&gt; untested, but I did verify that
&gt; SYSTEM\CurrentControlSet\Services\VxD\MSTCP exists and contains the
&gt; relevant information on 95 and Me&#41;.
&gt; 
&gt; This patch correctly decodes the DNSServerAddresses value of the
&gt; DNSRegisteredAdapters key.  It now also enumerates *all* interfaces,
&gt; instead of just the ones that are also listed under
&gt; DNSRegisteredAdapters.  That change should fix bug @2465.
&gt; 
&gt; This patch includes my earlier one.
</div>
Thanks, applied.

-- 
Chris Reinhardt
ctriv@dyndns.org
Systems Architect
Dynamic DNS Network Services
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.dyndns.org/">http://www.dyndns.org/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Give even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;08&nbsp;02:58:27&nbsp;2003</span>
    <span class="description">rt-cpan [...] triv.org -  Given to CREIN</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;May&nbsp;08&nbsp;02:58:27&nbsp;2003</span>
    <span class="description">rt-cpan [...] triv.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
