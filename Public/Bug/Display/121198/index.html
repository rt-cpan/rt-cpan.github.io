<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #121198 for MikroTik-API: Moose, slow initialisation</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #121198 for MikroTik-API: Moose, slow initialisation</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/MikroTik-API/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/MikroTik-API/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/MikroTik-API/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/MikroTik-API/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/MikroTik-API">MikroTik-API CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">121198</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/MikroTik-API/Active/">MikroTik-API</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">MARTINGO [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dhe [...] syrex.co

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-262430-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-262431-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
2.0.0    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




image001.png<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1720088/924651/image001.png">
Tue Apr 18 09:20:47 2017 (28.8k) by dhe [...] syrex.co
</a>
</font></li>
</ul>


image002.png<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1720088/924652/image002.png">
Tue Apr 18 09:20:47 2017 (41.3k) by dhe [...] syrex.co
</a>
</font></li>
</ul>


image003.png<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1720088/924653/image003.png">
Tue Apr 18 09:20:47 2017 (29.8k) by dhe [...] syrex.co
</a>
</font></li>
</ul>


image004.png<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1720088/924654/image004.png">
Tue Apr 18 09:20:47 2017 (32.9k) by dhe [...] syrex.co
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;17&nbsp;02:20:45&nbsp;2017</span>
    <span class="description">dhe [...] syrex.co -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Moose, slow initialisation</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 17 Apr 2017 05:48:29 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-MikroTik-API [...] rt.cpan.org&#34; &lt;bug-MikroTik-API [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> David Herselman &lt;dhe [...] syrex.co&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Firstly a massive thank you for releasing your Perl Mikrotik API to CPAN. We are successfully using it to monitor BGP sessions as RouterOS doesn&#39;t provide BGP SNMP monitoring capabilities.

Our NMS &#40;Zabbix&#41; triggers a &#39;call&#39; for each item we monitor &#40;9 &#40;admin &#38; operational states, status, uptime, prefix count, withdrawns sent &#38; received and updates sent &#38; received&#41;&#41; for each BGP peer on each router.

The Mikrotik API however unfortunately takes 0.5 seconds to initialise the big Moose library and very quickly generates a massive load on our Zabbix server when we set monitoring to 60 second intervals.

I&#39;ve adapted our script to use locking and caching retrieved API values but the Moose library continues to be a massive lumbering animal.

Disclaimer: I&#39;m really not a programmer but recommendations on PerlMonks were to try replacing Moose with Mouse.

Are you still actively maintaining the API? Would it be possible to wish list replacing Moose with a faster/leaner library?

PS: I can gladly share our script, if it&#39;s of use...


Regards
David Herselman
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;17&nbsp;20:22:18&nbsp;2017</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2017-04-16 23:20:45, dhe@syrex.co wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Disclaimer: I&#39;m really not a programmer but recommendations on
&gt; PerlMonks were to try replacing Moose with Mouse.
</div>
What post was that? It must have been very old -- I would recommend looking at Moo instead.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;17&nbsp;20:22:19&nbsp;2017</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;18&nbsp;09:20:47&nbsp;2017</span>
    <span class="description">dhe [...] syrex.co -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #121198] Moose, slow initialisation</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 18 Apr 2017 10:45:41 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-MikroTik-API [...] rt.cpan.org&#34; &lt;bug-MikroTik-API [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> David Herselman &lt;dhe [...] syrex.co&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Karen,



Herewith the link to the PerlMonks node where I understood the Moose include to be the major delay in running Perl scripts which utilise your MikroTik API:

<span class="clickylink"><a target="new" rel="nofollow" href="http://www.perlmonks.org/?node_id=1186845">http://www.perlmonks.org/?node_id=1186845</a></span>





If I create a virtually empty script file, only including libraries that the MikroTik API includes itself and test with Perl&#39;s DProf, I obtain the following:



[admin@zabbix externalscripts]# cat test.pl:

#!/usr/bin/perl

use strict;

use warnings;

use Moose;

use namespace::autoclean;

use Digest::MD5;

use IO::Socket::INET;

use IO::Socket::SSL;

use Time::Out qw{ timeout };





[admin@zabbix externalscripts]# perl -d:DProf ./test.pl; dprofpp

Total Elapsed Time =     0.43 Seconds

  User+System Time =     0.41 Seconds

Exclusive Times

%Time ExclSec CumulS #Calls sec/call Csec/c  Name

9.76   0.040  0.040   1606   0.0000 0.0000  Package::Stash::PP::_deconstruct_variable_name

4.88   0.020  0.410     11   0.0018 0.0373  main::BEGIN

4.88   0.020  0.270     24   0.0008 0.0113  Moose::BEGIN

4.88   0.020  0.060   1107   0.0000 0.0001  Package::Stash::PP::get_symbol

4.88   0.020  0.030    139   0.0001 0.0002  Class::MOP::Class::__ANON__

4.88   0.020  0.030     18   0.0011 0.0017  Moose::Meta::Class::BEGIN

4.88   0.020  0.020    116   0.0002 0.0002  Class::MOP::Method::Generated::_eval_closure

2.44   0.010  0.010      3   0.0033 0.0033  Moose::Deprecated::BEGIN

2.44   0.010  0.010     32   0.0003 0.0003  strict::unimport

2.44   0.010  0.050     15   0.0007 0.0033  Class::MOP::BEGIN

2.44   0.010  0.040     53   0.0002 0.0008  base::import

2.44   0.010  0.030     17   0.0006 0.0018  Class::MOP::Class::BEGIN

2.44   0.010  0.020     14   0.0007 0.0014  Package::Stash::PP::BEGIN

2.44   0.010  0.010     74   0.0001 0.0001  Package::Stash::PP::new

2.44   0.010  0.010    459   0.0000 0.0000  Package::Stash::PP::_valid_for_type



If I comment out ‘Moose’ and ‘namespace:autoclean’:

[admin@zabbix externalscripts]# perl -d:DProf ./test.pl; dprofpp

Total Elapsed Time = 0.059172 Seconds

  User+System Time = 0.059172 Seconds

Exclusive Times

%Time ExclSec CumulS #Calls sec/call Csec/c  Name

33.8   0.020  0.059      7   0.0028 0.0085  main::BEGIN

16.9   0.010  0.010     10   0.0010 0.0010  vars::import

16.9   0.010  0.010      4   0.0025 0.0025  Socket6::BEGIN

16.9   0.010  0.010     11   0.0009 0.0009  strict::unimport

16.9   0.010  0.010      6   0.0017 0.0016  IO::Socket::INET::BEGIN

0.00   0.000  0.000      1   0.0000 0.0000  Net::SSLeay::VERIFY_NONE

0.00   0.000  0.000      1   0.0000 0.0000  Net::SSLeay::VERIFY_PEER

0.00   0.000  0.000      1   0.0000 0.0000  Net::SSLeay::VERIFY_FAIL_IF_NO_PEER_CERT

0.00   0.000  0.000      1   0.0000 0.0000  Net::SSLeay::VERIFY_CLIENT_ONCE

0.00   0.000  0.000      1   0.0000 0.0000  Config::launcher

0.00   0.000  0.000      1   0.0000 0.0000  AutoLoader::AUTOLOAD

0.00   0.000  0.000      1   0.0000 0.0000  Net::SSLeay::randomize

0.00   0.000  0.000      1   0.0000 0.0000  Net::SSLeay::ERROR_WANT_READ

0.00   0.000  0.000      1   0.0000 0.0000  Net::SSLeay::ERROR_WANT_WRITE

0.00       - -0.000      1        -      -  Config::AUTOLOAD



PS: System’s own load influences the difference between ‘total elapsed time’ and ‘user+system time’





For what it’s worth, you can gladly include the following Zabbix MikroTik BGP session monitoring script as part of your public examples. The script supports JSON discovery, locking and value caching to avoid the API being called too often or concurrently:

#!/usr/bin/perl

use strict;

use warnings;

use MikroTik::API;      # <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~martingo/MikroTik-API/lib/MikroTik/API/Examples.pm">http://search.cpan.org/~martingo/MikroTik-API/lib/MikroTik/API/Examples.pm</a></span>

use Fcntl qw&#40;:flock&#41;;

use Storable qw&#40;lock_store lock_nstore lock_retrieve&#41;;



my &#40;$router, $api_user, $api_passwd, $command, $peer, $key&#41; = @ARGV;

if &#40;not defined $router&#41; { print STDERR &#34;Need router FQDN or IP, as first parameter.\n&#34;; exit 3 };

if &#40;not defined $api_user&#41; { print STDERR &#34;Need MikroTik API username, as second parameter.\n&#34;; exit 4 };

if &#40;not defined $api_passwd&#41; { print STDERR &#34;Need MikroTik API password, as third parameter.\n&#34;; exit 5 };

my $cache_ttl = 595;

my $cachefile = &#39;/tmp/mtapi.&#39;.$router.&#39;.cache&#39;;



sub mtdate {

  my $hdate = shift;

  my &#40;$years, $weeks, $days, $hours, $minutes, $seconds&#41; = &#40;0&#41; x 7;

  if &#40;$hdate =~ /^\d+y/&#41; { &#40;$years = $hdate&#41; =~ s/^&#40;\d+&#41;y.*/$1/ };

  if &#40;$hdate =~ /&#40;^|[y]&#41;\d+w/&#41; { &#40;$weeks = $hdate&#41; =~ s/.*?&#40;\d+&#41;w.*/$1/ };

  if &#40;$hdate =~ /&#40;^|[yw]&#41;\d+d/&#41; { &#40;$days = $hdate&#41; =~ s/.*?&#40;\d+&#41;d.*/$1/ };

  if &#40;$hdate =~ /&#40;^|[ywd]&#41;\d+h/&#41; { &#40;$hours = $hdate&#41; =~ s/.*?&#40;\d+&#41;h.*/$1/ };

  if &#40;$hdate =~ /&#40;^|[ywdh]&#41;\d+m/&#41; { &#40;$minutes = $hdate&#41; =~ s/.*?&#40;\d+&#41;m.*/$1/ };

  if &#40;$hdate =~ /&#40;^|[ywdhm]&#41;\d+s/&#41; { &#40;$seconds = $hdate&#41; =~ s/.*?&#40;\d+&#41;s.*/$1/ };

  return &#40;$years*31536000&#41;+&#40;$weeks*604800&#41;+&#40;$days*86400&#41;+&#40;$hours*3600&#41;+&#40;$minutes*60&#41;+$seconds;

}



my $api = MikroTik::API-&gt;new &#40;

  {

    host        =&gt; $router,

    username    =&gt; $api_user,

    password    =&gt; $api_passwd,

    use_ssl     =&gt; 1,

    autoconnect =&gt; 0,

  }

&#41;;



my %bgp_peer;

my $cached = 0;

my $modified = &#40;stat&#40;$cachefile&#41;&#41;[9];

open our $lockfile, &#39;&lt;&#39;, $0 || die $!;

if &#40;defined $modified&#41; {

  if &#40;&#40;$modified &gt;= &#40;time-$cache_ttl&#41;&#41; || &#40;!flock $lockfile, LOCK_EX | LOCK_NB&#41;&#41; {

    if &#40;%bgp_peer = %{lock_retrieve&#40;$cachefile&#41;}&#41; { $cached = 1 };

  }

}

if &#40;$cached == 0&#41; {

  if &#40;!flock $lockfile, LOCK_EX | LOCK_NB&#41; { print STDERR &#34;Another process is already using MikroTik API.\n&#34;; exit 6 };

  $api-&gt;connect&#40;&#41;;

  $api-&gt;login&#40;&#41;;

  %bgp_peer = $api-&gt;get_by_key&#40;&#39;/routing/bgp/peer/print&#39;, &#39;name&#39;&#41;;

  $api-&gt;logout&#40;&#41;;

  lock_nstore \%bgp_peer, $cachefile;

  chmod 0660, $cachefile;

  flock $lockfile, LOCK_UN;

}



if &#40;$command =~ /^&#40;-d|--discover&#41;$/&#41; {

  print &#34;{\n\t\&#34;data\&#34;: [\n&#34;;

  my $first = 1;

  foreach my $peer &#40; sort keys %bgp_peer &#41; {

    if &#40;$first == 0&#41; { print &#34;,\n&#34; };

    print &#34;\t\t{ \&#34;{#BGPPEER}\&#34;: \&#34;&#34;, $peer, &#34;\&#34; }&#34;;

    $first = 0;

  }

  print &#34;\n\t]\n}\n&#34;;

}

elsif &#40;$command =~ /^&#40;-c|--croak&#41;$/&#41; {

  foreach my $peer &#40; sort keys %bgp_peer &#41; {

    print &#34;peer: &#34;, $peer, &#34;\n  &#34;, join&#40;&#34;\n  &#34;, sort map{qq{$_=$bgp_peer{$peer}-&gt;{$_}}} keys %{$bgp_peer{$peer}}, &#34;\n&#34; &#41;, &#34;\n&#34;;

  }

}

elsif &#40;$command =~ /^&#40;-t|--table&#41;$/&#41; {

  printf &#40;&#34;%-25s %-7s %9s %15s %9s %18.18s %s\n&#34;, &#34;Peer&#34;, &#34;Active&#34;, &#34;Prefixes&#34;, &#34;Remote IP&#34;, &#34;Remote AS&#34;, &#34;Uptime&#34;, &#34;State&#34;&#41;;

  foreach my $peer &#40; sort keys %bgp_peer &#41; {

    printf &#40;&#34;%-25.25s %-7.7s %9.9s %15.15s %9.9s %18.18s %s\n&#34;, $peer, $bgp_peer{$peer}-&gt;{&#39;disabled&#39;} eq &#39;true&#39; ? &#39;no&#39; : &#39;yes&#39;, $bgp_peer{$peer}-&gt;{&#39;prefix-count&#39;}, $bgp_peer{$peer}-&gt;{&#39;remote-address&#39;}, $bgp_peer{$peer}-&gt;{&#39;remote-as&#39;}, $bgp_peer{$peer}-&gt;{&#39;uptime&#39;}, $bgp_peer{$peer}-&gt;{&#39;state&#39;} &#41;;

  }

}

elsif &#40;$command =~ /^&#40;-g|--get&#41;$/&#41; {

  if &#40;not defined $peer&#41; { print STDERR &#34;No peer specified.\n&#34;; exit 8 };

  if &#40;not defined $key&#41; { print STDERR &#34;No key specified.\n&#34;; exit 9 };

  if &#40;defined $bgp_peer{$peer}-&gt;{$key}&#41; {

    if &#40;$key =~ /^uptime$/&#41; {

      print &#38;mtdate&#40;$bgp_peer{$peer}-&gt;{$key}&#41;,&#34;\n&#34;;

    }

    elsif &#40;$key =~ /^disabled$/&#41; {

      print $bgp_peer{$peer}-&gt;{$key} eq &#34;true&#34; ? 2 : 1,&#34;\n&#34;;

    }

    elsif &#40;$key =~ /^&#40;as-override|as4-capability|established|multihop|passive|refresh-capability|remove-private-as|route-reflect|use-bfd&#41;$/&#41; {

      print $bgp_peer{$peer}-&gt;{$key} eq &#34;true&#34; ? 1 : 2,&#34;\n&#34;;

    }

    else { print &#34;$bgp_peer{$peer}-&gt;{$key}\n&#34; }

  }

  else {

    print STDERR &#34;MikroTik API response does not contain \$bgp_peer{&#39;$peer&#39;}-&gt;{&#39;$key&#39;}.\n&#34;;

    exit 10;

  }

}

else {

  print STDERR &lt;&lt;EOF;

Missing or invalid command. Usage $0 &lt;router&gt; &lt;api username&gt; &lt;api password&gt; &lt;command&gt; [&lt;peer&gt;] :

  -d|--discover         Zabbix LLD &#40;low level discovery&#41;. In JSON format.

  -c|--croak            Dumps all available data. Usable as \$bgp_peer{&#39;\$peer&#39;}-&gt;{&#39;key&#39;}

  -t|--table            Displays tabled overview

  -g|--get &lt;peer&gt; &lt;key&gt; example: -g \&#34;Syrex - Primary\&#34; state



  Examples:

    Discovery   : $0 10.0.0.1 syrexnms \&#34;FakeP\@ssw0rd\&#34; -d

    Sample      : {

                    \&#34;data\&#34;: [

                      { \&#34;{#BGPPEER}\&#34;: \&#34;Syrex - Primary\&#34; },

                      { \&#34;{#BGPPEER}\&#34;: \&#34;Syrex - Secondary\&#34; }

                    ]

                  }



    Get item    : $0 10.0.0.1 syrexnms \&#34;FakeP\@ssw0rd\&#34; \&#34;Syrex - Primary\&#34; state

    Sample      : established

EOF

  exit 7;

}



exit 0;



PS: I’ll gladly export and provide our Zabbix template, so that the script can easily be used by others…





Sample text table output:

[admin@zabbix externalscripts]# ./mikrotik-api-bgp_status.pl zatjnb01-pe01.syrex.co.za syrexnms ‘FakeP@ssw0rd&#39; -t

Peer                      Active   Prefixes       Remote IP Remote AS             Uptime State

ECN                       yes             2   172.37.17.205     36968      2w1d15h37m26s established

Google                    yes           401     41.79.22.65     15169         3d7h48m30s established

NAPAfrica - Collector     yes             0      196.60.9.1     37186        1w5d10h4m8s established

NAPAfrica - Primary       yes         45604      196.60.9.2     37195        1w5d10h4m9s established

NAPAfrica - Secondary     yes         45531      196.60.9.3     37195        1w5d10h4m9s established

Seacom                    yes             1    105.22.33.33     37100      2w1d15h37m26s established

Spamhaus                  yes          1420  94.228.136.140     65190         3d7h16m42s established

Syrex - zatjnb01-rr01     yes          1118      41.79.22.6     37314      2w1d15h37m13s established

Syrex - zatjnb01-rr02     yes          1118      41.79.22.7     37314      2w1d15h37m19s established

Team Cymru - Bogons       yes          3797    38.229.66.20     65332           22h6m32s established

Team Cymru - UTRS         yes            54   154.35.32.141     64496        2d16h17m29s established

Telkom                    yes           103   196.25.155.41      5713      2w1d15h37m26s established

XConnect                  yes             3   41.242.227.66     37105      2w1d15h37m27s established

iOnline                   yes            24   198.19.28.106    327909      2w1d15h37m26s established



Zabbix – Establishment graph:

[cid:image001.png@01D2B83F.42A78150]



Zabbix – BGP prefix activity graph:

[cid:image002.png@01D2B83F.42A78150]



Zabbix – BGP prefix count graph:

[cid:image003.png@01D2B840.31212840]



Zabbix – BGP session uptime graph:

[cid:image004.png@01D2B840.31212840]





Regards

David Herselman





<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Karen Etheridge via RT [mailto:bug-MikroTik-API@rt.cpan.org]
Sent: Tuesday, 18 April 2017 2:22 AM
To: David Herselman &lt;dhe@syrex.co&gt;
Subject: [rt.cpan.org #121198] Moose, slow initialisation



&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=121198">https://rt.cpan.org/Ticket/Display.html?id=121198</a></span> &gt;



On 2017-04-16 23:20:45, dhe@syrex.co&lt;mailto:dhe@syrex.co&gt; wrote:



<div class="message-stanza open">&gt; Disclaimer: I&#39;m really not a programmer but recommendations on
</div>
<div class="message-stanza open">&gt; PerlMonks were to try replacing Moose with Mouse.
</div>


What post was that? It must have been very old -- I would recommend looking at Moo instead.
</div></div></div>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1720088/924651/image001.png">Download image001.png</a><br />
<span class="downloadcontenttype">image/png 28.8k</span>
</div>
<div class="messagebody">
<img alt="image001.png" title="image001.png" src="/Ticket/Attachment/1720088/924651/" /></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1720088/924652/image002.png">Download image002.png</a><br />
<span class="downloadcontenttype">image/png 41.3k</span>
</div>
<div class="messagebody">
<img alt="image002.png" title="image002.png" src="/Ticket/Attachment/1720088/924652/" /></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1720088/924653/image003.png">Download image003.png</a><br />
<span class="downloadcontenttype">image/png 29.8k</span>
</div>
<div class="messagebody">
<img alt="image003.png" title="image003.png" src="/Ticket/Attachment/1720088/924653/" /></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1720088/924654/image004.png">Download image004.png</a><br />
<span class="downloadcontenttype">image/png 32.9k</span>
</div>
<div class="messagebody">
<img alt="image004.png" title="image004.png" src="/Ticket/Attachment/1720088/924654/" /></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;17&nbsp;07:22:28&nbsp;2018</span>
    <span class="description">MARTINGO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you for reporting. Did not have a look at the issue tracker for a while :&#41;
I know, Moose causes high delays. For my needs &#40;permanently running with Catalyst&#41; this is no real problem although having a few hundred calls per minute. Considered this high compile time during my design decisions &#40;see POD&#41;. I know there will be much faster ways but for me comfort had priority over performance. This is also no build from scratch but simply an OO layer over other guys work.
I guess you are the author of the changed API2.pm in the mikrotik forum? So you already have a solution?
Currently there is no need for me, so no plans for changing the libs within the next months.
Perhaps anytime or when someone else creates a pull request on github.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;17&nbsp;07:22:29&nbsp;2018</span>
    <span class="description">MARTINGO [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;17&nbsp;07:22:29&nbsp;2018</span>
    <span class="description">MARTINGO [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;26&nbsp;08:18:18&nbsp;2019</span>
    <span class="description">MARTINGO [...] cpan.org -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;26&nbsp;10:07:20&nbsp;2019</span>
    <span class="description">MARTINGO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">replaced Moose with Moo; shold be notably faster.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;26&nbsp;10:07:20&nbsp;2019</span>
    <span class="description">MARTINGO [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;26&nbsp;10:07:21&nbsp;2019</span>
    <span class="description">MARTINGO [...] cpan.org -  Fixed in 2.0.0 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
