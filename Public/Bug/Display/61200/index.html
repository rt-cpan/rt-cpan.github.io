<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #61200 for HTTP-Server-Simple: FEATURE REQUEST: Support IP v6</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #61200 for HTTP-Server-Simple: FEATURE REQUEST: Support IP v6</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=HTTP-Server-Simple">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=HTTP-Server-Simple">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=HTTP-Server-Simple">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=HTTP-Server-Simple">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/HTTP-Server-Simple">HTTP-Server-Simple CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">61200</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=HTTP-Server-Simple">HTTP-Server-Simple</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jeremiah [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-16414-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-16415-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




0003-support-ipv6.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1004855/523625/0003-support-ipv6.patch">
Mon Nov 28 02:06:41 2011 (5.6k) by dkg [...] fifthhorseman.net
</a>
</font></li>
</ul>


61200.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1054169/551404/61200.patch">
Sat Mar 24 02:33:00 2012 (10.1k) by dkg [...] fifthhorseman.net
</a>
</font></li>
</ul>


signature.asc<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1006633/524546/signature.asc">
Thu Dec 01 19:29:50 2011 (836b) by gregoa [...] debian.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=61200">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-828896" href="/Public/Bug/Display.html?id=61200#txn-828896">#</a>      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;09&nbsp;07:48:12&nbsp;2010</span>
    <span class="description">jeremiah [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> FEATURE REQUEST: Support IP v6</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/828896/429399/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/429399">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 47b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">It would be nice is this module supported IP v6
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-850105" href="/Public/Bug/Display.html?id=61200#txn-850105">#</a>      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;01&nbsp;22:16:48&nbsp;2010</span>
    <span class="description">spang [...] mit.edu -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> mats.andersson [...] gisladisker.se</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/850105/440117/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/440117">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 324b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Sep 09 07:48:12 2010, jeremiah wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It would be nice is this module supported IP v6
</div>
Hi,

Someone&#39;s submitted a patch for IPv6 support in the Debian bugtracking 
system. Can a maintainer take a look at it and see if it&#39;s suitable for 
inclusion?

<span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=596176">http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=596176</a></span>

Christine
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-850109" href="/Public/Bug/Display.html?id=61200#txn-850109">#</a>      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;01&nbsp;22:16:49&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1004855" href="/Public/Bug/Display.html?id=61200#txn-1004855">#</a>      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;28&nbsp;02:06:41&nbsp;2011</span>
    <span class="description">dkg [...] fifthhorseman.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> mats.andersson [...] gisladisker.se, 596176-submitter [...] bugs.debian.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #61200] IPv6 support for HTTP::Server::Simple</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 28 Nov 2011 02:06:58 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> 596176 [...] bugs.debian.org, bug-HTTP-Server-Simple [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Daniel Kahn Gillmor &lt;dkg [...] fifthhorseman.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1004855/523624/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/523624">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 918b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The original IPv6 patch for HTTP::Server::Simple proposed by Mats [0]
produces the following warnings:

Subroutine HTTP::Server::Simple::pack_sockaddr_in6 redefined at /usr/share/perl/5.14/Exporter.pm line 67.
 at /usr/share/perl5/HTTP/Server/Simple.pm line 7
Subroutine HTTP::Server::Simple::unpack_sockaddr_in6 redefined at /usr/share/perl/5.14/Exporter.pm line 67.
 at /usr/share/perl5/HTTP/Server/Simple.pm line 7
Subroutine HTTP::Server::Simple::sockaddr_in6 redefined at /usr/share/perl/5.14/Exporter.pm line 67.
 at /usr/share/perl5/HTTP/Server/Simple.pm line 7

The attached patch avoids those warnings while still enabling IPv6
support.

I can confirm that this patch provides a baseline of IPv6 support for
HTTP::Server::Simple.  Please adopt it, or provide an alternate IPv6
implementation for this package.

Thanks for maintaining HTTP::Server::Simple!

       --dkg

[0] <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/596176#10">http://bugs.debian.org/596176#10</a></span>
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1004855/523625/0003-support-ipv6.patch">Download 0003-support-ipv6.patch</a><br />
<span class="downloadcontenttype">text/x-diff 5.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Description: Upgrade the module to accept IPv6.
 The contructor and the listener methods are extended to allow
 a domain parameter.  A new method, family&#40;&#41;, mediates in deciding
 between AF_INET and AF_INET6.
 .
 The request processing method detects the correct domain for an
 incoming socket.
Author: Mats Erik Andersson &lt;debian@gisladisker.se&gt;
Forwarded: no
Last-Update: 2010-10-28
Bug-Debian: <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/cgi-bin/bugreport-cgi?bug=596176">http://bugs.debian.org/cgi-bin/bugreport-cgi?bug=596176</a></span>

--- libhttp-server-simple-perl-0.43.debian/lib/HTTP/Server/Simple.pm
+++ libhttp-server-simple-perl-0.43/lib/HTTP/Server/Simple.pm
@@ -4,6 +4,7 @@
 package HTTP::Server::Simple;
 use FileHandle;
 use Socket;
+use Socket6 qw&#40;in6addr_any&#41;;
 use Carp;
 use IO::Select;
 
@@ -125,15 +126,17 @@
 
 =head1 METHODS
 
-=head2 HTTP::Server::Simple-&gt;new&#40;$port&#41;
+=head2 HTTP::Server::Simple-&gt;new&#40;$port, $family&#41;
 
 API call to start a new server.  Does not actually start listening
-until you call C&lt;-E&lt;gt&gt;run&#40;&#41;&gt;.  If omitted, C&lt;$port&gt; defaults to 8080.
+until you call C&lt;-E&lt;gt&gt;run&#40;&#41;&gt;.  If omitted, C&lt;$port&gt; defaults to 8080,
+and C&lt;$family&gt; defaults to L&lt;Socket::AF_INET&gt;.
+The alternative domain is L&lt;Socket::AF_INET6&gt;.
 
 =cut
 
 sub new {
-    my &#40; $proto, $port &#41; = @_;
+    my &#40; $proto, $port, $family &#41; = @_;
     my $class = ref&#40;$proto&#41; || $proto;
 
     if &#40; $class eq __PACKAGE__ &#41; {
@@ -144,6 +147,7 @@ sub new {
     my $self = {};
     bless&#40; $self, $class &#41;;
     $self-&gt;port&#40; $port || &#39;8080&#39; &#41;;
+    $self-&gt;family&#40; $family || AF_INET &#41;;
 
     return $self;
 }
@@ -152,7 +156,7 @@
 =head2 lookup_localhost
 
 Looks up the local host&#39;s IP address, and returns it.  For most hosts,
-this is C&lt;127.0.0.1&gt;.
+this is C&lt;127.0.0.1&gt;, or possibly C&lt;::1&gt;.
 
 =cut
 
@@ -160,9 +164,14 @@ sub lookup_localhost {
     my $self = shift;
 
     my $local_sockaddr = getsockname&#40; $self-&gt;stdio_handle &#41;;
-    my &#40; undef, $localiaddr &#41; = sockaddr_in&#40;$local_sockaddr&#41;;
-    $self-&gt;host&#40; gethostbyaddr&#40; $localiaddr, AF_INET &#41; || &#34;localhost&#34;&#41;;
-    $self-&gt;{&#39;local_addr&#39;} = inet_ntoa&#40;$localiaddr&#41; || &#34;127.0.0.1&#34;;
+    my $local_family = sockaddr_family&#40;$local_sockaddr&#41;;
+    my &#40; undef, $localiaddr &#41; =
+        &#40;$local_family == AF_INET6&#41; ? sockaddr_in6&#40;$local_sockaddr&#41;
+                                    : sockaddr_in&#40;$local_sockaddr&#41;;
+
+    $self-&gt;host&#40; gethostbyaddr&#40; $localiaddr, $local_family &#41; || &#34;localhost&#34;&#41;;
+    $self-&gt;{&#39;local_addr&#39;} = Socket::inet_ntop&#40;$local_family, $localiaddr&#41;
+                            || &#40;&#40;$local_family == AF_INET6&#41; ? &#34;::1&#34; : &#34;127.0.0.1&#34;&#41;;
 }
 
 
@@ -181,6 +190,31 @@
 
 }
 
+=head2 family [NUMBER]
+
+Takes an optional address family for this server to use.  Valid values
+are Socket::AF_INET and Socket::AF_INET6.  All other values are silently
+changed into Socket::AF_INET for backwards compatibility with previous
+versions of the module.
+
+Returns the address family of the present listening socket.  &#40;Defaults to
+Socket::AF_INET.&#41;
+
+=cut
+
+sub family {
+    my $self = shift;
+    if &#40;@_&#41; {
+        if &#40;$_[0] == AF_INET || $_[0] == AF_INET6&#41; {
+            $self-&gt;{&#39;family&#39;} = shift;
+        } else {
+            $self-&gt;{&#39;family&#39;} = AF_INET;
+        }
+    }
+    return &#40; $self-&gt;{&#39;family&#39;} &#41;;
+
+}
+
 =head2 host [address]
 
 Takes an optional host address for this server to bind to.
@@ -384,8 +418,15 @@ sub _process_request {
         # &#40; <span class="clickylink"><a target="new" rel="nofollow" href="http://dev.catalyst.perl.org/changeset/5195">http://dev.catalyst.perl.org/changeset/5195</a></span>, 5221 &#41;
         
         my $remote_sockaddr = getpeername&#40; $self-&gt;stdio_handle &#41;;
-        my &#40; $iport, $iaddr &#41; = $remote_sockaddr ? sockaddr_in&#40;$remote_sockaddr&#41; : &#40;undef,undef&#41;;
-        my $peeraddr = $iaddr ? &#40; inet_ntoa&#40;$iaddr&#41; || &#34;127.0.0.1&#34; &#41; : &#39;127.0.0.1&#39;;
+        my $family = sockaddr_family&#40;$remote_sockaddr&#41;;
+
+        my &#40; $iport, $iaddr &#41; = $remote_sockaddr 
+                                ? &#40; &#40;$family == AF_INET6&#41; ? sockaddr_in6&#40;$remote_sockaddr&#41;
+                                                          : sockaddr_in&#40;$remote_sockaddr&#41; &#41;
+                                : &#40;undef,undef&#41;;
+
+        my $loopback = &#40;$family == AF_INET6&#41; ? &#34;::1&#34; : &#34;127.0.0.1&#34;;
+        my $peeraddr = $iaddr ? &#40; Socket::inet_ntop&#40;$family, $iaddr&#41; || $loopback &#41; : $loopback;
         
         my &#40; $method, $request_uri, $proto &#41; = $self-&gt;parse_request;
         
@@ -685,18 +726,32 @@ sub setup_listener {
     my $self = shift;
 
     my $tcp = getprotobyname&#40;&#39;tcp&#39;&#41;;
-    socket&#40; HTTPDaemon, PF_INET, SOCK_STREAM, $tcp &#41; or croak &#34;socket: $!&#34;;
+    my $sockaddr;
+    socket&#40; HTTPDaemon, $self-&gt;{&#39;family&#39;}, SOCK_STREAM, $tcp &#41;
+        or croak &#34;socket: $!&#34;;
     setsockopt&#40; HTTPDaemon, SOL_SOCKET, SO_REUSEADDR, pack&#40; &#34;l&#34;, 1 &#41; &#41;
         or warn &#34;setsockopt: $!&#34;;
-    bind&#40; HTTPDaemon,
-        sockaddr_in&#40;
-            $self-&gt;port&#40;&#41;,
-            &#40;   $self-&gt;host
-                ? inet_aton&#40; $self-&gt;host &#41;
-                : INADDR_ANY
-            &#41;
-        &#41;
-        &#41;
+
+    if &#40;$self-&gt;host&#41; { # Explicit listening address
+        my @res = getaddrinfo&#40;$self-&gt;host, $self-&gt;port, $self-&gt;{&#39;family&#39;}, SOCK_STREAM&#41;;
+        while &#40;scalar&#40;@res&#41; &gt;= 5&#41; {
+            my &#40;$af, undef, undef, $tmp, undef&#41; = splice&#40;@res, 0, 5&#41;;
+            # Be certain on the address family.
+            # TODO Accept AF_UNSPEC, reject SITE-LOCAL
+            next unless &#40;$self-&gt;{&#39;family&#39;} == $af&#41;;
+
+            # Use the first plausible address.
+            $sockaddr = $tmp;
+            last;
+        }
+    }
+    else { # Use the wildcard address
+        $sockaddr = &#40;$self-&gt;{&#39;family&#39;} == AF_INET6&#41;
+                        ? sockaddr_in6&#40;$self-&gt;port&#40;&#41;, in6addr_any&#41;
+                        : sockaddr_in&#40;$self-&gt;port&#40;&#41;, INADDR_ANY&#41;;
+    }
+
+    bind&#40; HTTPDaemon, $sockaddr&#41;
         or croak &#34;bind to @{[$self-&gt;host||&#39;*&#39;]}:@{[$self-&gt;port]}: $!&#34;;
     listen&#40; HTTPDaemon, SOMAXCONN &#41; or croak &#34;listen: $!&#34;;
 }
</div></div>
</div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1004855/523626/">Download &#40;untitled&#41;</a><br />
<span class="downloadcontenttype">application/pgp-signature 965b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1006633" href="/Public/Bug/Display.html?id=61200#txn-1006633">#</a>      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;01&nbsp;19:29:50&nbsp;2011</span>
    <span class="description">gregoa [...] debian.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> bug-HTTP-Server-Simple [...] rt.cpan.org, mats.andersson [...] gisladisker.se, 596176-submitter [...] bugs.debian.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: Bug#596176: [rt.cpan.org #61200] IPv6 support for HTTP::Server::Simple</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 2 Dec 2011 01:29:35 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Daniel Kahn Gillmor &lt;dkg [...] fifthhorseman.net&gt;, 596176 [...] bugs.debian.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> gregor herrmann &lt;gregoa [...] debian.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1006633/524545/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/524545">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 657b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, 28 Nov 2011 02:06:58 -0500, Daniel Kahn Gillmor wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I can confirm that this patch provides a baseline of IPv6 support for
&gt; HTTP::Server::Simple.  Please adopt it, or provide an alternate IPv6
&gt; implementation for this package.
</div>
I haven&#39;t tested it yet, but the patch looks good IMO, and having
IPv6 support for HTTP::Server::Simple would indeed be nice.
 

Cheers,
gregor

-- 
 .&#39;&#39;`.   Homepage: <span class="clickylink"><a target="new" rel="nofollow" href="http://info.comodo.priv.at/">http://info.comodo.priv.at/</a></span> - OpenPGP key ID: 0x8649AA06
 : :&#39; :  Debian GNU/Linux user, admin, &#38; developer - <span class="clickylink"><a target="new" rel="nofollow" href="http://www.debian.org/">http://www.debian.org/</a></span>
 `. `&#39;   Member of VIBE!AT &#38; SPI, fellow of Free Software Foundation Europe
   `-    NP: The Doors: Soul Kitchen
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1006633/524546/signature.asc">Download signature.asc</a><br />
<span class="downloadcontenttype">application/pgp-signature 836b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1014586" href="/Public/Bug/Display.html?id=61200#txn-1014586">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;23&nbsp;11:03:09&nbsp;2011</span>
    <span class="description">jesse [...] fsck.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #61200] IPv6 support for HTTP::Server::Simple</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 23 Dec 2011 08:23:09 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-HTTP-Server-Simple [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jesse Vincent &lt;jesse [...] fsck.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1014586/529013/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/529013">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 7.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hiya,

This has been sitting in my inbox for about a month. I&#39;m sorry for the delay in my reply. The killer for me here is that Socket6 isn&#39;t in core. HTTP::Server::Simple has a firm no-non-core-dependencies policy. I believe that it should be possible to use the IPv6 support in modern versions of Socket.pm if it&#39;s available rather than depending on an external module. Additionally, I&#39;m leery of adding new functionality without also adding at least basic tests for the new feature. 

If you can resolve these issues, I&#39;d be thrilled to apply a patch and get an HSS with IPv6 support out.

Best,
Jesse

On Nov 28, 2011, at 2:06 AM, Daniel Kahn Gillmor via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       Queue: HTTP-Server-Simple
&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=61200">https://rt.cpan.org/Ticket/Display.html?id=61200</a></span> &gt;
&gt; 
&gt; The original IPv6 patch for HTTP::Server::Simple proposed by Mats [0]
&gt; produces the following warnings:
&gt; 
&gt; Subroutine HTTP::Server::Simple::pack_sockaddr_in6 redefined at /usr/share/perl/5.14/Exporter.pm line 67.
&gt; at /usr/share/perl5/HTTP/Server/Simple.pm line 7
&gt; Subroutine HTTP::Server::Simple::unpack_sockaddr_in6 redefined at /usr/share/perl/5.14/Exporter.pm line 67.
&gt; at /usr/share/perl5/HTTP/Server/Simple.pm line 7
&gt; Subroutine HTTP::Server::Simple::sockaddr_in6 redefined at /usr/share/perl/5.14/Exporter.pm line 67.
&gt; at /usr/share/perl5/HTTP/Server/Simple.pm line 7
&gt; 
&gt; The attached patch avoids those warnings while still enabling IPv6
&gt; support.
&gt; 
&gt; I can confirm that this patch provides a baseline of IPv6 support for
&gt; HTTP::Server::Simple.  Please adopt it, or provide an alternate IPv6
&gt; implementation for this package.
&gt; 
&gt; Thanks for maintaining HTTP::Server::Simple!
&gt; 
&gt;       --dkg
&gt; 
&gt; [0] <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/596176#10">http://bugs.debian.org/596176#10</a></span>
&gt; 
&gt; 
&gt; Description: Upgrade the module to accept IPv6.
&gt; The contructor and the listener methods are extended to allow
&gt; a domain parameter.  A new method, family&#40;&#41;, mediates in deciding
&gt; between AF_INET and AF_INET6.
&gt; .
&gt; The request processing method detects the correct domain for an
&gt; incoming socket.
&gt; Author: Mats Erik Andersson &lt;debian@gisladisker.se&gt;
&gt; Forwarded: no
&gt; Last-Update: 2010-10-28
&gt; Bug-Debian: <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/cgi-bin/bugreport-cgi?bug=596176">http://bugs.debian.org/cgi-bin/bugreport-cgi?bug=596176</a></span>
&gt; 
&gt; --- libhttp-server-simple-perl-0.43.debian/lib/HTTP/Server/Simple.pm
&gt; +++ libhttp-server-simple-perl-0.43/lib/HTTP/Server/Simple.pm
&gt; @@ -4,6 +4,7 @@
&gt; package HTTP::Server::Simple;
&gt; use FileHandle;
&gt; use Socket;
&gt; +use Socket6 qw&#40;in6addr_any&#41;;
&gt; use Carp;
&gt; use IO::Select;
&gt; 
&gt; @@ -125,15 +126,17 @@
&gt; 
&gt; =head1 METHODS
&gt; 
&gt; -=head2 HTTP::Server::Simple-&gt;new&#40;$port&#41;
&gt; +=head2 HTTP::Server::Simple-&gt;new&#40;$port, $family&#41;
&gt; 
&gt; API call to start a new server.  Does not actually start listening
&gt; -until you call C&lt;-E&lt;gt&gt;run&#40;&#41;&gt;.  If omitted, C&lt;$port&gt; defaults to 8080.
&gt; +until you call C&lt;-E&lt;gt&gt;run&#40;&#41;&gt;.  If omitted, C&lt;$port&gt; defaults to 8080,
&gt; +and C&lt;$family&gt; defaults to L&lt;Socket::AF_INET&gt;.
&gt; +The alternative domain is L&lt;Socket::AF_INET6&gt;.
&gt; 
&gt; =cut
&gt; 
&gt; sub new {
&gt; -    my &#40; $proto, $port &#41; = @_;
&gt; +    my &#40; $proto, $port, $family &#41; = @_;
&gt;     my $class = ref&#40;$proto&#41; || $proto;
&gt; 
&gt;     if &#40; $class eq __PACKAGE__ &#41; {
&gt; @@ -144,6 +147,7 @@ sub new {
&gt;     my $self = {};
&gt;     bless&#40; $self, $class &#41;;
&gt;     $self-&gt;port&#40; $port || &#39;8080&#39; &#41;;
&gt; +    $self-&gt;family&#40; $family || AF_INET &#41;;
&gt; 
&gt;     return $self;
&gt; }
&gt; @@ -152,7 +156,7 @@
&gt; =head2 lookup_localhost
&gt; 
&gt; Looks up the local host&#39;s IP address, and returns it.  For most hosts,
&gt; -this is C&lt;127.0.0.1&gt;.
&gt; +this is C&lt;127.0.0.1&gt;, or possibly C&lt;::1&gt;.
&gt; 
&gt; =cut
&gt; 
&gt; @@ -160,9 +164,14 @@ sub lookup_localhost {
&gt;     my $self = shift;
&gt; 
&gt;     my $local_sockaddr = getsockname&#40; $self-&gt;stdio_handle &#41;;
&gt; -    my &#40; undef, $localiaddr &#41; = sockaddr_in&#40;$local_sockaddr&#41;;
&gt; -    $self-&gt;host&#40; gethostbyaddr&#40; $localiaddr, AF_INET &#41; || &#34;localhost&#34;&#41;;
&gt; -    $self-&gt;{&#39;local_addr&#39;} = inet_ntoa&#40;$localiaddr&#41; || &#34;127.0.0.1&#34;;
&gt; +    my $local_family = sockaddr_family&#40;$local_sockaddr&#41;;
&gt; +    my &#40; undef, $localiaddr &#41; =
&gt; +        &#40;$local_family == AF_INET6&#41; ? sockaddr_in6&#40;$local_sockaddr&#41;
&gt; +                                    : sockaddr_in&#40;$local_sockaddr&#41;;
&gt; +
&gt; +    $self-&gt;host&#40; gethostbyaddr&#40; $localiaddr, $local_family &#41; || &#34;localhost&#34;&#41;;
&gt; +    $self-&gt;{&#39;local_addr&#39;} = Socket::inet_ntop&#40;$local_family, $localiaddr&#41;
&gt; +                            || &#40;&#40;$local_family == AF_INET6&#41; ? &#34;::1&#34; : &#34;127.0.0.1&#34;&#41;;
&gt; }
&gt; 
&gt; 
&gt; @@ -181,6 +190,31 @@
&gt; 
&gt; }
&gt; 
&gt; +=head2 family [NUMBER]
&gt; +
&gt; +Takes an optional address family for this server to use.  Valid values
&gt; +are Socket::AF_INET and Socket::AF_INET6.  All other values are silently
&gt; +changed into Socket::AF_INET for backwards compatibility with previous
&gt; +versions of the module.
&gt; +
&gt; +Returns the address family of the present listening socket.  &#40;Defaults to
&gt; +Socket::AF_INET.&#41;
&gt; +
&gt; +=cut
&gt; +
&gt; +sub family {
&gt; +    my $self = shift;
&gt; +    if &#40;@_&#41; {
&gt; +        if &#40;$_[0] == AF_INET || $_[0] == AF_INET6&#41; {
&gt; +            $self-&gt;{&#39;family&#39;} = shift;
&gt; +        } else {
&gt; +            $self-&gt;{&#39;family&#39;} = AF_INET;
&gt; +        }
&gt; +    }
&gt; +    return &#40; $self-&gt;{&#39;family&#39;} &#41;;
&gt; +
&gt; +}
&gt; +
&gt; =head2 host [address]
&gt; 
&gt; Takes an optional host address for this server to bind to.
&gt; @@ -384,8 +418,15 @@ sub _process_request {
&gt;         # &#40; <span class="clickylink"><a target="new" rel="nofollow" href="http://dev.catalyst.perl.org/changeset/5195">http://dev.catalyst.perl.org/changeset/5195</a></span>, 5221 &#41;
&gt; 
&gt;         my $remote_sockaddr = getpeername&#40; $self-&gt;stdio_handle &#41;;
&gt; -        my &#40; $iport, $iaddr &#41; = $remote_sockaddr ? sockaddr_in&#40;$remote_sockaddr&#41; : &#40;undef,undef&#41;;
&gt; -        my $peeraddr = $iaddr ? &#40; inet_ntoa&#40;$iaddr&#41; || &#34;127.0.0.1&#34; &#41; : &#39;127.0.0.1&#39;;
&gt; +        my $family = sockaddr_family&#40;$remote_sockaddr&#41;;
&gt; +
&gt; +        my &#40; $iport, $iaddr &#41; = $remote_sockaddr 
&gt; +                                ? &#40; &#40;$family == AF_INET6&#41; ? sockaddr_in6&#40;$remote_sockaddr&#41;
&gt; +                                                          : sockaddr_in&#40;$remote_sockaddr&#41; &#41;
&gt; +                                : &#40;undef,undef&#41;;
&gt; +
&gt; +        my $loopback = &#40;$family == AF_INET6&#41; ? &#34;::1&#34; : &#34;127.0.0.1&#34;;
&gt; +        my $peeraddr = $iaddr ? &#40; Socket::inet_ntop&#40;$family, $iaddr&#41; || $loopback &#41; : $loopback;
&gt; 
&gt;         my &#40; $method, $request_uri, $proto &#41; = $self-&gt;parse_request;
&gt; 
&gt; @@ -685,18 +726,32 @@ sub setup_listener {
&gt;     my $self = shift;
&gt; 
&gt;     my $tcp = getprotobyname&#40;&#39;tcp&#39;&#41;;
&gt; -    socket&#40; HTTPDaemon, PF_INET, SOCK_STREAM, $tcp &#41; or croak &#34;socket: $!&#34;;
&gt; +    my $sockaddr;
&gt; +    socket&#40; HTTPDaemon, $self-&gt;{&#39;family&#39;}, SOCK_STREAM, $tcp &#41;
&gt; +        or croak &#34;socket: $!&#34;;
&gt;     setsockopt&#40; HTTPDaemon, SOL_SOCKET, SO_REUSEADDR, pack&#40; &#34;l&#34;, 1 &#41; &#41;
&gt;         or warn &#34;setsockopt: $!&#34;;
&gt; -    bind&#40; HTTPDaemon,
&gt; -        sockaddr_in&#40;
&gt; -            $self-&gt;port&#40;&#41;,
&gt; -            &#40;   $self-&gt;host
&gt; -                ? inet_aton&#40; $self-&gt;host &#41;
&gt; -                : INADDR_ANY
&gt; -            &#41;
&gt; -        &#41;
&gt; -        &#41;
&gt; +
&gt; +    if &#40;$self-&gt;host&#41; { # Explicit listening address
&gt; +        my @res = getaddrinfo&#40;$self-&gt;host, $self-&gt;port, $self-&gt;{&#39;family&#39;}, SOCK_STREAM&#41;;
&gt; +        while &#40;scalar&#40;@res&#41; &gt;= 5&#41; {
&gt; +            my &#40;$af, undef, undef, $tmp, undef&#41; = splice&#40;@res, 0, 5&#41;;
&gt; +            # Be certain on the address family.
&gt; +            # TODO Accept AF_UNSPEC, reject SITE-LOCAL
&gt; +            next unless &#40;$self-&gt;{&#39;family&#39;} == $af&#41;;
&gt; +
&gt; +            # Use the first plausible address.
&gt; +            $sockaddr = $tmp;
&gt; +            last;
&gt; +        }
&gt; +    }
&gt; +    else { # Use the wildcard address
&gt; +        $sockaddr = &#40;$self-&gt;{&#39;family&#39;} == AF_INET6&#41;
&gt; +                        ? sockaddr_in6&#40;$self-&gt;port&#40;&#41;, in6addr_any&#41;
&gt; +                        : sockaddr_in&#40;$self-&gt;port&#40;&#41;, INADDR_ANY&#41;;
&gt; +    }
&gt; +
&gt; +    bind&#40; HTTPDaemon, $sockaddr&#41;
&gt;         or croak &#34;bind to @{[$self-&gt;host||&#39;*&#39;]}:@{[$self-&gt;port]}: $!&#34;;
&gt;     listen&#40; HTTPDaemon, SOMAXCONN &#41; or croak &#34;listen: $!&#34;;
&gt; }
&gt; &lt;Mail Attachment&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1054169" href="/Public/Bug/Display.html?id=61200#txn-1054169">#</a>      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;24&nbsp;02:33:00&nbsp;2012</span>
    <span class="description">dkg [...] fifthhorseman.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Bug#596176: [rt.cpan.org #61200] IPv6 support for HTTP::Server::Simple</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 24 Mar 2012 02:32:33 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> 596176 [...] bugs.debian.org, 596176-submitter [...] bugs.debian.org, bug-HTTP-Server-Simple [...] rt.cpan.org, Jesse Vincent &lt;jesse [...] fsck.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Daniel Kahn Gillmor &lt;dkg [...] fifthhorseman.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1054169/551403/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/551403">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 908b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached is a a patch for HTTP::Server::Simple that i believe implements
proper IPv6 support without adding any non-core dependencies.  It keeps
the same interface changes as the original patch by Mats &#40;optional
$family argument to new&#40;&#41;, new family&#40;&#41; method on the object, all
defaulting to AF_INET&#41;.

The patch also modifies the test suite to perform IPv4 and IPv6 tests.

I&#39;ve tested it and it works against perl 5.14 &#40;i think that&#39;s Socket
1.94&#41;, but it fails against perl 5.10 &#40;Socket 1.82, afaict&#41;.  I can&#39;t
find the full history of Socket to figure out where the relevant symbols
&#40;Socket::IN6ADDR_ANY and Socket::getaddrinfo&#41; were added.

Maybe you want to also make the &#34;use Socket;&#34; line have a version number
if you know the correct cutoff.

Please let me know if you have any trouble or concerns with it, or if
you need me to modify it some way to consider accepting it.

Regards,

        --dkg
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1054169/551404/61200.patch">Download 61200.patch</a><br />
<span class="downloadcontenttype">text/x-diff 10.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/lib/HTTP/Server/Simple.pm b/lib/HTTP/Server/Simple.pm
index 50479ae..5905d55 100755
--- a/lib/HTTP/Server/Simple.pm
+++ b/lib/HTTP/Server/Simple.pm
@@ -124,15 +124,17 @@ could kill the server.
 
 =head1 METHODS
 
-=head2 HTTP::Server::Simple-&gt;new&#40;$port&#41;
+=head2 HTTP::Server::Simple-&gt;new&#40;$port, $family&#41;
 
 API call to start a new server.  Does not actually start listening
-until you call C&lt;-E&lt;gt&gt;run&#40;&#41;&gt;.  If omitted, C&lt;$port&gt; defaults to 8080.
+until you call C&lt;-E&lt;gt&gt;run&#40;&#41;&gt;.  If omitted, C&lt;$port&gt; defaults to 8080,
+and C&lt;$family&gt; defaults to L&lt;Socket::AF_INET&gt;.
+The alternative domain is L&lt;Socket::AF_INET6&gt;.
 
 =cut
 
 sub new {
-    my &#40; $proto, $port &#41; = @_;
+    my &#40; $proto, $port, $family &#41; = @_;
     my $class = ref&#40;$proto&#41; || $proto;
 
     if &#40; $class eq __PACKAGE__ &#41; {
@@ -143,6 +145,7 @@ sub new {
     my $self = {};
     bless&#40; $self, $class &#41;;
     $self-&gt;port&#40; $port || &#39;8080&#39; &#41;;
+    $self-&gt;family&#40; $family || AF_INET &#41;;
 
     return $self;
 }
@@ -151,7 +154,7 @@ sub new {
 =head2 lookup_localhost
 
 Looks up the local host&#39;s IP address, and returns it.  For most hosts,
-this is C&lt;127.0.0.1&gt;.
+this is C&lt;127.0.0.1&gt;, or possibly C&lt;::1&gt;.
 
 =cut
 
@@ -159,9 +162,14 @@ sub lookup_localhost {
     my $self = shift;
 
     my $local_sockaddr = getsockname&#40; $self-&gt;stdio_handle &#41;;
-    my &#40; undef, $localiaddr &#41; = sockaddr_in&#40;$local_sockaddr&#41;;
-    $self-&gt;host&#40; gethostbyaddr&#40; $localiaddr, AF_INET &#41; || &#34;localhost&#34;&#41;;
-    $self-&gt;{&#39;local_addr&#39;} = inet_ntoa&#40;$localiaddr&#41; || &#34;127.0.0.1&#34;;
+    my $local_family = sockaddr_family&#40;$local_sockaddr&#41;;
+    my &#40; undef, $localiaddr &#41; =
+        &#40;$local_family == AF_INET6&#41; ? sockaddr_in6&#40;$local_sockaddr&#41;
+                                    : sockaddr_in&#40;$local_sockaddr&#41;;
+
+    $self-&gt;host&#40; gethostbyaddr&#40; $localiaddr, $local_family &#41; || &#34;localhost&#34;&#41;;
+    $self-&gt;{&#39;local_addr&#39;} = Socket::inet_ntop&#40;$local_family, $localiaddr&#41;
+                            || &#40;&#40;$local_family == AF_INET6&#41; ? &#34;::1&#34; : &#34;127.0.0.1&#34;&#41;;
 }
 
 
@@ -180,6 +188,31 @@ sub port {
 
 }
 
+=head2 family [NUMBER]
+
+Takes an optional address family for this server to use.  Valid values
+are Socket::AF_INET and Socket::AF_INET6.  All other values are silently
+changed into Socket::AF_INET for backwards compatibility with previous
+versions of the module.
+
+Returns the address family of the present listening socket.  &#40;Defaults to
+Socket::AF_INET.&#41;
+
+=cut
+
+sub family {
+    my $self = shift;
+    if &#40;@_&#41; {
+        if &#40;$_[0] == AF_INET || $_[0] == AF_INET6&#41; {
+            $self-&gt;{&#39;family&#39;} = shift;
+        } else {
+            $self-&gt;{&#39;family&#39;} = AF_INET;
+        }
+    }
+    return &#40; $self-&gt;{&#39;family&#39;} &#41;;
+
+}
+
 =head2 host [address]
 
 Takes an optional host address for this server to bind to.
@@ -359,8 +392,15 @@ sub _process_request {
         # &#40; <span class="clickylink"><a target="new" rel="nofollow" href="http://dev.catalyst.perl.org/changeset/5195">http://dev.catalyst.perl.org/changeset/5195</a></span>, 5221 &#41;
         
         my $remote_sockaddr = getpeername&#40; $self-&gt;stdio_handle &#41;;
-        my &#40; $iport, $iaddr &#41; = $remote_sockaddr ? sockaddr_in&#40;$remote_sockaddr&#41; : &#40;undef,undef&#41;;
-        my $peeraddr = $iaddr ? &#40; inet_ntoa&#40;$iaddr&#41; || &#34;127.0.0.1&#34; &#41; : &#39;127.0.0.1&#39;;
+        my $family = sockaddr_family&#40;$remote_sockaddr&#41;;
+
+        my &#40; $iport, $iaddr &#41; = $remote_sockaddr 
+                                ? &#40; &#40;$family == AF_INET6&#41; ? sockaddr_in6&#40;$remote_sockaddr&#41;
+                                                          : sockaddr_in&#40;$remote_sockaddr&#41; &#41;
+                                : &#40;undef,undef&#41;;
+
+        my $loopback = &#40;$family == AF_INET6&#41; ? &#34;::1&#34; : &#34;127.0.0.1&#34;;
+        my $peeraddr = $iaddr ? &#40; Socket::inet_ntop&#40;$family, $iaddr&#41; || $loopback &#41; : $loopback;
         
         my &#40; $method, $request_uri, $proto &#41; = $self-&gt;parse_request;
         
@@ -650,18 +690,34 @@ sub setup_listener {
     my $self = shift;
 
     my $tcp = getprotobyname&#40;&#39;tcp&#39;&#41;;
-    socket&#40; HTTPDaemon, PF_INET, SOCK_STREAM, $tcp &#41; or croak &#34;socket: $!&#34;;
+    my $sockaddr;
+    socket&#40; HTTPDaemon, $self-&gt;{&#39;family&#39;}, SOCK_STREAM, $tcp &#41;
+        or croak &#34;socket: $!&#34;;
     setsockopt&#40; HTTPDaemon, SOL_SOCKET, SO_REUSEADDR, pack&#40; &#34;l&#34;, 1 &#41; &#41;
         or warn &#34;setsockopt: $!&#34;;
-    bind&#40; HTTPDaemon,
-        sockaddr_in&#40;
-            $self-&gt;port&#40;&#41;,
-            &#40;   $self-&gt;host
-                ? inet_aton&#40; $self-&gt;host &#41;
-                : INADDR_ANY
-            &#41;
-        &#41;
-        &#41;
+
+    if &#40;$self-&gt;host&#41; { # Explicit listening address
+        my &#40;$err, @res&#41; = Socket::getaddrinfo&#40;$self-&gt;host, $self-&gt;port, { family =&gt; $self-&gt;{&#39;family&#39;}, socktype =&gt; SOCK_STREAM } &#41;;
+        warn &#34;$err!&#34;
+          if &#40;$err&#41;;
+        # we&#39;re binding only to the first returned address in the requested family.
+        while &#40;$a = shift&#40;@res&#41;&#41; {
+            # Be certain on the address family.
+            # TODO Accept AF_UNSPEC, reject SITE-LOCAL
+            next unless &#40;$self-&gt;{&#39;family&#39;} == $a-&gt;{&#39;family&#39;}&#41;;
+
+            # Use the first plausible address.
+            $sockaddr = $a-&gt;{&#39;addr&#39;};
+            last;
+        }
+    }
+    else { # Use the wildcard address
+        $sockaddr = &#40;$self-&gt;{&#39;family&#39;} == AF_INET6&#41;
+                        ? sockaddr_in6&#40;$self-&gt;port&#40;&#41;, Socket::IN6ADDR_ANY&#41;
+                        : sockaddr_in&#40;$self-&gt;port&#40;&#41;, INADDR_ANY&#41;;
+    }
+
+    bind&#40; HTTPDaemon, $sockaddr&#41;
         or croak &#34;bind to @{[$self-&gt;host||&#39;*&#39;]}:@{[$self-&gt;port]}: $!&#34;;
     listen&#40; HTTPDaemon, SOMAXCONN &#41; or croak &#34;listen: $!&#34;;
 }
diff --git a/t/01live.t b/t/01live.t
index 4d0587d..cd58b98 100644
--- a/t/01live.t
+++ b/t/01live.t
@@ -1,7 +1,7 @@
 # -*- perl -*-
 
 use Socket;
-use Test::More tests =&gt; 14;
+use Test::More tests =&gt; 34;
 use strict;
 
 # This script assumes that `localhost&#39; will resolve to a local IP
@@ -31,33 +31,34 @@ my $DEBUG = 1 if @ARGV;
 my @pids    = &#40;&#41;;
 my @classes = &#40;qw&#40;HTTP::Server::Simple SlowServer&#41;&#41;;
 for my $class &#40;@classes&#41; {
-    run_server_tests&#40;$class&#41;;
+    run_server_tests&#40;$class, AF_INET&#41;;
+    run_server_tests&#40;$class, AF_INET6&#41;;
     $PORT++; # don&#39;t reuse the port incase your bogus os doesn&#39;t release in time
 }
 
 
-
-{
-    my $s=HTTP::Server::Simple::CGI-&gt;new&#40;$PORT&#41;;
+for my $fam &#40; AF_INET, AF_INET6 &#41; {
+    my $s=HTTP::Server::Simple::CGI-&gt;new&#40;$PORT, $fam&#41;;
+    is&#40;$fam, $s-&gt;family&#40;&#41;, &#39;family OK&#39;&#41;;
     $s-&gt;host&#40;&#34;localhost&#34;&#41;;
     my $pid=$s-&gt;background&#40;&#41;;
     diag&#40;&#34;started server PID=&#39;$pid&#39;&#34;&#41; if &#40;$ENV{&#39;TEST_VERBOSE&#39;}&#41;;
     like&#40;$pid, &#39;/^-?\d+$/&#39;, &#39;pid is numeric&#39;&#41;;
     select&#40;undef,undef,undef,0.2&#41;; # wait a sec
-    my $content=fetch&#40;&#34;GET / HTTP/1.1&#34;, &#34;&#34;&#41;;
+    my $content=fetch&#40;$fam, &#34;GET / HTTP/1.1&#34;, &#34;&#34;&#41;;
     like&#40;$content, &#39;/Congratulations/&#39;, &#34;Returns a page&#34;&#41;;
 
     eval {
-	like&#40;fetch&#40;&#34;GET a bogus request&#34;&#41;, 
+	like&#40;fetch&#40;$fam, &#34;GET a bogus request&#34;&#41;, 
 	     &#39;/bad request/i&#39;,
 	     &#34;knows what a request isn&#39;t&#34;&#41;;
     };
     fail&#40;&#34;got exception in client: $@&#34;&#41; if $@;
 
-    like&#40;fetch&#40;&#34;GET / HTTP/1.1&#34;, &#34;&#34;&#41;, &#39;/Congratulations/&#39;,
+    like&#40;fetch&#40;$fam, &#34;GET / HTTP/1.1&#34;, &#34;&#34;&#41;, &#39;/Congratulations/&#39;,
 	 &#34;HTTP/1.1 request&#34;&#41;;
 
-    like&#40;fetch&#40;&#34;GET /&#34;&#41;, &#39;/Congratulations/&#39;,
+    like&#40;fetch&#40;$fam, &#34;GET /&#34;&#41;, &#39;/Congratulations/&#39;,
 	 &#34;HTTP/0.9 request&#34;&#41;;
 
     is&#40;kill&#40;9,$pid&#41;,1,&#39;Signaled 1 process successfully&#39;&#41;;
@@ -68,29 +69,43 @@ is&#40; kill&#40; 9, $_ &#41;, 1, &#34;Killed PID: $_&#34; &#41; for @pids;
 # this function may look excessive, but hopefully will be very useful
 # in identifying common problems
 sub fetch {
+    my $family = shift;
     my $hostname = &#34;localhost&#34;;
     my $port = $PORT;
     my $message = join &#34;&#34;, map { &#34;$_\015\012&#34; } @_;
-    my $timeout = 5;    
-    my $response;        
-    
+    my $timeout = 5;
+    my $response;
+    my $proto = getprotobyname&#40;&#39;tcp&#39;&#41; || die &#34;getprotobyname: $!&#34;;
+    my $socktype = SOCK_STREAM;
+
     eval {
         local $SIG{ALRM} = sub { die &#34;early exit - SIGALRM caught&#34; };
         alarm $timeout*2; #twice longer than timeout used later by select&#40;&#41;  
- 
-        my $iaddr = inet_aton&#40;$hostname&#41; || die &#34;inet_aton: $!&#34;;
-        my $paddr = sockaddr_in&#40;$port, $iaddr&#41; || die &#34;sockaddr_in: $!&#34;;
-        my $proto = getprotobyname&#40;&#39;tcp&#39;&#41; || die &#34;getprotobyname: $!&#34;;
-        socket&#40;SOCK, PF_INET, SOCK_STREAM, $proto&#41; || die &#34;socket: $!&#34;;
+
+        my $paddr;
+        my &#40;$err, @res&#41; = Socket::getaddrinfo&#40;$hostname, $port, { family =&gt; $family,
+                                                                  socktype =&gt; $socktype,
+                                                                  protocol =&gt; $proto }&#41;;
+        die &#34;getaddrinfo: $err&#34;
+          if &#40;$err&#41;;
+        while &#40;$a = shift&#40;@res&#41;&#41; {
+          next unless &#40;$family == $a-&gt;{&#39;family&#39;}&#41;;
+          next unless &#40;$proto == $a-&gt;{&#39;protocol&#39;}&#41;;
+          next unless &#40;$socktype == $a-&gt;{&#39;socktype&#39;}&#41;;
+
+          $paddr = $a-&gt;{&#39;addr&#39;};
+          last
+        }
+        socket&#40;SOCK, $family, $socktype, $proto&#41; || die &#34;socket: $!&#34;;
         connect&#40;SOCK, $paddr&#41; || die &#34;connect: $!&#34;;
         &#40;send SOCK, $message, 0&#41; || die &#34;send: $!&#34;;
-        
+
         my $rvec = &#39;&#39;;
         vec&#40;$rvec, fileno&#40;SOCK&#41;, 1&#41; = 1;
-        die &#34;vec&#40;&#41;: $!&#34; unless $rvec; 
+        die &#34;vec&#40;&#41;: $!&#34; unless $rvec;
 
         $response = &#39;&#39;;
-        for &#40;;;&#41; {        
+        for &#40;;;&#41; {
             my $r = select&#40;$rvec, undef, undef, $timeout&#41;;
             die &#34;select: timeout - no data to read from server&#34; unless &#40;$r &gt; 0&#41;;
             my $l = sysread&#40;SOCK, $response, 1024, length&#40;$response&#41;&#41;;
@@ -100,18 +115,20 @@ sub fetch {
         $response =~ s/\015\012/\n/g; 
         &#40;close SOCK&#41; || die &#34;close&#40;&#41;: $!&#34;;
         alarm 0;
-    }; 
+    };
     if &#40;$@&#41; {
       	return &#34;[ERROR] $@&#34;;
     }
     else {
         return $response;
-    }    
+    }
 }
 
 sub run_server_tests {
     my $class = shift;
-    my $s = $class-&gt;new&#40;$PORT&#41;;
+    my $fam = shift;
+    my $s = $class-&gt;new&#40;$PORT, $fam&#41;;
+    is&#40;$s-&gt;family&#40;&#41;, $fam, &#39;constructor set family properly&#39;&#41;;
     is&#40;$s-&gt;port&#40;&#41;,$PORT,&#34;Constructor set port correctly&#34;&#41;;
 
     my $pid=$s-&gt;background&#40;&#41;;
@@ -119,7 +136,7 @@ sub run_server_tests {
 
     like&#40;$pid, &#39;/^-?\d+$/&#39;, &#39;pid is numeric&#39;&#41;;
 
-    my $content=fetch&#40;&#34;GET / HTTP/1.1&#34;, &#34;&#34;&#41;;
+    my $content=fetch&#40;$fam, &#34;GET / HTTP/1.1&#34;, &#34;&#34;&#41;;
 
     like&#40;$content, &#39;/Congratulations/&#39;, &#34;Returns a page&#34;&#41;;
     push @pids, $pid;
diff --git a/t/04cgi.t b/t/04cgi.t
index 1b6a5e1..55567d2 100644
--- a/t/04cgi.t
+++ b/t/04cgi.t
@@ -1,3 +1,5 @@
+# -*- perl -*-
+
 use Test::More;
 use Socket;
 use strict;
</div></div>
</div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1054169/551405/">Download &#40;untitled&#41;</a><br />
<span class="downloadcontenttype">application/pgp-signature 965b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1079820" href="/Public/Bug/Display.html?id=61200#txn-1079820">#</a>      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;20&nbsp;18:15:24&nbsp;2012</span>
    <span class="description">jesse [...] fsck.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: Bug#596176: [rt.cpan.org #61200] IPv6 support for HTTP::Server::Simple</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 20 May 2012 18:15:15 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Daniel Kahn Gillmor via RT &lt;bug-HTTP-Server-Simple [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jesse Vincent &lt;jesse [...] fsck.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1079820/568250/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/568250">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 11.9k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1459472" href="/Public/Bug/Display.html?id=61200#txn-1459472">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;02&nbsp;10:52:18&nbsp;2015</span>
    <span class="description">cpan [...] jibsheet.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> 596176 [...] bugs.debian.org, dkg [...] fifthhorseman.net, 596176-submitter [...] bugs.debian.org,
 gregoa [...] debian.org, mats.andersson [...] gisladisker.se</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1459472/776596/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/776596">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 338b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun May 20 18:15:24 2012, jesse@fsck.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I&#39;m sorry it took me so damn long, but I&#39;ve just pushed 0.45_02 to
&gt; cpan
&gt; iwth this patch.
</div>
0.50, containing this change + a number of fixes to work on Strawberry perl and to pass tests on machines which don&#39;t call their IPv6 loopback &#39;localhost&#39; has been shipped to CPAN.

-kevin
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1459477" href="/Public/Bug/Display.html?id=61200#txn-1459477">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;02&nbsp;10:52:56&nbsp;2015</span>
    <span class="description">cpan [...] jibsheet.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.756723</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
