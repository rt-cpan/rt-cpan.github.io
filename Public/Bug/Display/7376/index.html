<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #7376 for Spreadsheet-ParseExcel: Warnings during parsing of excel sheet &#40;Unicode issue&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #7376 for Spreadsheet-ParseExcel: Warnings during parsing of excel sheet &#40;Unicode issue&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Spreadsheet-ParseExcel/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Spreadsheet-ParseExcel/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Spreadsheet-ParseExcel/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Spreadsheet-ParseExcel/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="http://github.com/runrig/spreadsheet-parseexcel/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Spreadsheet-ParseExcel">Spreadsheet-ParseExcel CPAN distribution</a>.</p>


<h3>Maintainer&#40;s&#41;&#39; notes</h3>

<p><b>If you are reporting a bug in Spreadsheet::ParseExcel here are some pointers</b>
<p>
1) State the issues as clearly and as concisely as possible. A simple program or Excel test file (see below) will often explain the issue better than a lot of text.
<p>
2) Provide information on your system, version of perl and module versions. The following program will generate everything that is required. Put this information in your bug report.
<pre>
    #!/usr/bin/perl -w

    print "\n    Perl version   : $]";
    print "\n    OS name        : $^O";
    print "\n    Module versions: (not all are required)\n";

    my @modules = qw(
                      Spreadsheet::ParseExcel
                      Scalar::Util
                      Unicode::Map
                      Spreadsheet::WriteExcel
                      Parse::RecDescent
                      File::Temp
                      OLE::Storage_Lite
                      IO::Stringy
                    );

    for my $module (@modules) {
        my $version;
        eval "require $module";

        if (not $@) {
            $version = $module-&gt;VERSION;
            $version = '(unknown)' if not defined $version;
        }
        else {
            $version = '(not installed)';
        }

        printf "%21s%-24s\t%s\n", "", $module, $version;
    }

    __END__
</pre>
<p>
3) Upgrade to the latest version of Spreadsheet::ParseExcel (or at least test on a system with an upgraded version). The issue you are reporting may already have been fixed.
<p>
4) Create a small example program that demonstrates your problem. The program should be as small as possible. A few lines of codes are worth tens of lines of text when trying to describe a bug.
<p>
5) <b>Supply an Excel file that demonstrates the problem</b>. This is very important. If the file is big, or contains confidential information, try to reduce it down to the smallest Excel file that represents the issue. If you don't wish to post a file here then send it to me directly: jmcnamara@cpan.org
<p>
6) Say if the test file was created by Excel, OpenOffice, Gnumeric or something else. Say which version of that application you used.
<p>
7) If you are submitting a patch you should check with the maintainer whether the issue has already been patched or if a fix is in the works. Patches should be accompanied by test cases.
<p>
<b>Asking a question</b>
<p>
If you would like to ask a more general question there is the <a href="http://groups.google.com/group/spreadsheet-parseexcel">Spreadsheet::ParseExcel Google Group</a>.
<p></p>



<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">7376</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Spreadsheet-ParseExcel/Active/">Spreadsheet-ParseExcel</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
SREZIC [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Unimportant    </td>
  </tr>
  <tr id="CF-29454-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.2603    </td>
  </tr>
  <tr id="CF-29455-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;17&nbsp;06:33:12&nbsp;2004</span>
    <span class="description">SREZIC [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Warnings during parsing of excel sheet</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On occasion I get the following warning when parsing excel sheets:

Character in &#34;C&#34; format wrapped at /usr/local/lib/perl5/site_perl/5.8.0/Spreadsheet/ParseExcel/FmtDefault.pm line 68.

The parsed data looks OK though. I guess it has something to do with Unicode characters in the excel sheet. Replacing the line 68 with

    return pack&#40;&#39;U*&#39;, unpack&#40;&#39;n*&#39;, $sTxt&#41;&#41;;

seems to remove the warnings.

Regards,
    Slaven
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;15&nbsp;14:58:51&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ernst [...] cron-it.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[SREZIC - Tue Aug 17 06:33:12 2004]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On occasion I get the following warning when parsing excel sheets:
&gt; &#40;...&#41;
&gt; Replacing the line 68 with
&gt; &#40;...&#41;
&gt; seems to remove the warnings.
</div>
Nice. I wonder what side-effects this has.

I get a couple of other similar warnings:

Character in &#39;c&#39; format wrapped in pack at
/usr/lib/perl5/vendor_perl/5.8.6/Spreadsheet/ParseExcel.pm line 1790.
Character in &#39;c&#39; format wrapped in pack at
/usr/lib/perl5/vendor_perl/5.8.6/Spreadsheet/ParseExcel.pm line 1789.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;12&nbsp;11:00:04&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> afwest</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Fri Jul 15 14:58:51 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; [ Change unpack&#40;&#34;C*&#34;,... to unpack&#40;&#34;U*&#34;,...
</div>&gt; Nice. I wonder what side-effects this has.
</div>
It seems to me that Excel encodes extended characters in UTF-8, so this 
will correctly parse extended characters into a Unicode string.  &#40;I 
noticed this with several characters, suprisingly including the Euro 
symbol.&#41;  This could potentially mess up calling code which is 
expecting a string containing ASCII characters, but it seems fine in 
the context of the module itself.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I get a couple of other similar warnings:
&gt; 
&gt; Character in &#39;c&#39; format wrapped in pack at
&gt; /usr/lib/perl5/vendor_perl/5.8.6/Spreadsheet/ParseExcel.pm line 1790.
&gt; Character in &#39;c&#39; format wrapped in pack at
&gt; /usr/lib/perl5/vendor_perl/5.8.6/Spreadsheet/ParseExcel.pm line 1789.
</div>
These warnings are because the module is trying to mask off the last 
two bits of a character by unpacking it to a *signed* number and then 
masking 0xFC and then repacking it as a singed number.  But, the &#38; 0xFC 
operation seems to remove the sign.  So, I made this change to those 
two lines:
&lt;         substr&#40;$sWk, 3, 1&#41; &#38;=  pack&#40;&#39;c&#39;, unpack&#40;&#34;c&#34;,substr&#40;$sWk, 3, 
1&#41;&#41; &#38; 0xFC&#41;; 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         substr&#40;$sWk, 3, 1&#41; &#38;=  pack&#40;&#39;C&#39;, unpack&#40;&#34;C&#34;,substr&#40;$sWk, 3, 
</div>1&#41;&#41; &#38; 0xFC&#41;; 

&lt;         substr&#40;$lWk, 0, 1&#41; &#38;=  pack&#40;&#39;c&#39;, unpack&#40;&#34;c&#34;,substr&#40;$lWk, 0, 
1&#41;&#41; &#38; 0xFC&#41;; 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         substr&#40;$lWk, 0, 1&#41; &#38;=  pack&#40;&#39;C&#39;, unpack&#40;&#34;C&#34;,substr&#40;$lWk, 0, 
</div>1&#41;&#41; &#38; 0xFC&#41;; 


which does the same operation, but uses an unsigned integer.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;12&nbsp;11:02:31&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> afwest</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Fri Jul 15 14:58:51 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; [ Change unpack&#40;&#34;C*&#34;,... to unpack&#40;&#34;U*&#34;,...
</div>&gt; Nice. I wonder what side-effects this has.
</div>
It seems to me that Excel encodes extended characters in UTF-8, so this 
will correctly parse extended characters into a Unicode string.  &#40;I 
noticed this with several characters, suprisingly including the Euro 
symbol.&#41;  This could potentially mess up calling code which is 
expecting a string containing ASCII characters, but it seems fine in 
the context of the module itself.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I get a couple of other similar warnings:
&gt; 
&gt; Character in &#39;c&#39; format wrapped in pack at
&gt; /usr/lib/perl5/vendor_perl/5.8.6/Spreadsheet/ParseExcel.pm line 1790.
&gt; Character in &#39;c&#39; format wrapped in pack at
&gt; /usr/lib/perl5/vendor_perl/5.8.6/Spreadsheet/ParseExcel.pm line 1789.
</div>
These warnings are because the module is trying to mask off the last 
two bits of a character by unpacking it to a *signed* number and then 
masking 0xFC and then repacking it as a singed number.  But, the &#38; 0xFC 
operation seems to remove the sign.  So, I made this change to those 
two lines:
&lt;         substr&#40;$sWk, 3, 1&#41; &#38;=  pack&#40;&#39;c&#39;, unpack&#40;&#34;c&#34;,substr&#40;$sWk, 3, 
1&#41;&#41; &#38; 0xFC&#41;; 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         substr&#40;$sWk, 3, 1&#41; &#38;=  pack&#40;&#39;C&#39;, unpack&#40;&#34;C&#34;,substr&#40;$sWk, 3, 
</div>1&#41;&#41; &#38; 0xFC&#41;; 

&lt;         substr&#40;$lWk, 0, 1&#41; &#38;=  pack&#40;&#39;c&#39;, unpack&#40;&#34;c&#34;,substr&#40;$lWk, 0, 
1&#41;&#41; &#38; 0xFC&#41;; 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         substr&#40;$lWk, 0, 1&#41; &#38;=  pack&#40;&#39;C&#39;, unpack&#40;&#34;C&#34;,substr&#40;$lWk, 0, 
</div>1&#41;&#41; &#38; 0xFC&#41;; 


which does the same operation, but uses an unsigned integer.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;28&nbsp;11:12:10&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Warnings during parsing of excel sheet   - correct patch</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Sergio Freire</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">So,
is the correct patch something like changing these lines?
Can anyone validate this and if its ok include it in the module for a
future release?

Line 68 of FmtDefault.pm:
------------------------

    #return pack&#40;&#39;C*&#39;, unpack&#40;&#39;n*&#39;, $sTxt&#41;&#41;;
    return pack&#40;&#39;U*&#39;, unpack&#40;&#39;n*&#39;, $sTxt&#41;&#41;;


Lines 1789,1790 of ParseExcel.pm:
-----------------------------------

#substr&#40;$sWk, 3, 1&#41; &#38;=  pack&#40;&#39;c&#39;, unpack&#40;&#34;c&#34;,substr&#40;$sWk, 3, 1&#41;&#41; &#38; 0xFC&#41;;
#substr&#40;$lWk, 0, 1&#41; &#38;=  pack&#40;&#39;c&#39;, unpack&#40;&#34;c&#34;,substr&#40;$lWk, 0, 1&#41;&#41; &#38; 0xFC&#41;;
# changed accordingly with
<span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Public/Bug/Display.html?id=7376">http://rt.cpan.org/Public/Bug/Display.html?id=7376</a></span>
substr&#40;$sWk, 3, 1&#41; &#38;=  pack&#40;&#39;C&#39;, unpack&#40;&#34;C&#34;,substr&#40;$sWk, 3, 1&#41;&#41; &#38; 0xFC&#41;;
substr&#40;$lWk, 0, 1&#41; &#38;=  pack&#40;&#39;C&#39;, unpack&#40;&#34;C&#34;,substr&#40;$lWk, 0, 1&#41;&#41; &#38; 0xFC&#41;;



Regards,
Sergio Freire




On Fri Aug 12 11:02:31 2005, guest wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [guest - Fri Jul 15 14:58:51 2005]:
&gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; [ Change unpack&#40;&#34;C*&#34;,... to unpack&#40;&#34;U*&#34;,...
</div>&gt; &gt; Nice. I wonder what side-effects this has.
</div>&gt; 
&gt; It seems to me that Excel encodes extended characters in UTF-8, so this 
&gt; will correctly parse extended characters into a Unicode string.  &#40;I 
&gt; noticed this with several characters, suprisingly including the Euro 
&gt; symbol.&#41;  This could potentially mess up calling code which is 
&gt; expecting a string containing ASCII characters, but it seems fine in 
&gt; the context of the module itself.
&gt; 
<div class="message-stanza open">&gt; &gt; I get a couple of other similar warnings:
&gt; &gt; 
&gt; &gt; Character in &#39;c&#39; format wrapped in pack at
&gt; &gt; /usr/lib/perl5/vendor_perl/5.8.6/Spreadsheet/ParseExcel.pm line 1790.
&gt; &gt; Character in &#39;c&#39; format wrapped in pack at
&gt; &gt; /usr/lib/perl5/vendor_perl/5.8.6/Spreadsheet/ParseExcel.pm line 1789.
</div>&gt; 
&gt; These warnings are because the module is trying to mask off the last 
&gt; two bits of a character by unpacking it to a *signed* number and then 
&gt; masking 0xFC and then repacking it as a singed number.  But, the &#38; 0xFC 
&gt; operation seems to remove the sign.  So, I made this change to those 
&gt; two lines:
&gt; &lt;         substr&#40;$sWk, 3, 1&#41; &#38;=  pack&#40;&#39;c&#39;, unpack&#40;&#34;c&#34;,substr&#40;$sWk, 3, 
&gt; 1&#41;&#41; &#38; 0xFC&#41;; 
<div class="message-stanza open">&gt; &gt;         substr&#40;$sWk, 3, 1&#41; &#38;=  pack&#40;&#39;C&#39;, unpack&#40;&#34;C&#34;,substr&#40;$sWk, 3, 
</div>&gt; 1&#41;&#41; &#38; 0xFC&#41;; 
&gt; 
&gt; &lt;         substr&#40;$lWk, 0, 1&#41; &#38;=  pack&#40;&#39;c&#39;, unpack&#40;&#34;c&#34;,substr&#40;$lWk, 0, 
&gt; 1&#41;&#41; &#38; 0xFC&#41;; 
<div class="message-stanza open">&gt; &gt;         substr&#40;$lWk, 0, 1&#41; &#38;=  pack&#40;&#39;C&#39;, unpack&#40;&#34;C&#34;,substr&#40;$lWk, 0, 
</div>&gt; 1&#41;&#41; &#38; 0xFC&#41;; 
&gt; 
&gt; 
&gt; which does the same operation, but uses an unsigned integer.
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;28&nbsp;11:12:11&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;02&nbsp;10:43:17&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Warnings during parsing of excel sheet &#40;substr outside of string&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mark [...] summersault.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I got a different warning:

substr outside of string at
/usr/local/lib/perl5/site_perl/5.8.0/Spreadsheet/ParseExcel.pm line 1558.

It means: &#34;You tried to reference a substr that pointed outside of a
string. That is, the absolute value of the offset was larger than the
length of the string&#34;. 

A check on the string length before the substr is attempted would
resolve that. 

That was with 0.2602, but the Changes file doesn&#39;t indicate this changed
in the most recent release. 

  Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;02&nbsp;10:53:40&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mark [...] summersault.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Mar 02 10:43:17 2006, guest wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I got a different warning:
&gt; 
&gt; substr outside of string at
&gt; /usr/local/lib/perl5/site_perl/5.8.0/Spreadsheet/ParseExcel.pm line 1558.
&gt; 
&gt; It means: &#34;You tried to reference a substr that pointed outside of a
&gt; string. That is, the absolute value of the offset was larger than the
&gt; length of the string&#34;. 
</div>
BTW, I got this error when trying parse a file that my system identified
as a &#34;Microsoft Excel Worksheet&#34;. When the same data was provided in a
format identified as a &#34;Microsoft Office Document&#34;, it worked. 

I didn&#39;t create these files, so I don&#39;t know exactly how they were created. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;11&nbsp;07:42:25&nbsp;2006</span>
    <span class="description">SZABGAB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> SZABGAB [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Aug 17 06:33:12 2004, SREZIC wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On occasion I get the following warning when parsing excel sheets:
&gt; 
&gt; Character in &#34;C&#34; format wrapped at
&gt; /usr/local/lib/perl5/site_perl/5.8.0/Spreadsheet/ParseExcel/FmtDefault.pm
&gt; line 68.
&gt; 
&gt;     return pack&#40;&#39;U*&#39;, unpack&#40;&#39;n*&#39;, $sTxt&#41;&#41;;
</div>
this fix has been applied to version 0.27_01
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;13&nbsp;04:04:32&nbsp;2006</span>
    <span class="description">MARSCHAP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bitcard [...] adpm.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

On Mon Sep 11 07:42:25 2006, SZABGAB wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Aug 17 06:33:12 2004, SREZIC wrote:
<div class="message-stanza open">&gt; &gt; On occasion I get the following warning when parsing excel sheets:
&gt; &gt; 
&gt; &gt; Character in &#34;C&#34; format wrapped at
</div>&gt; 
&gt; /usr/local/lib/perl5/site_perl/5.8.0/Spreadsheet/ParseExcel/FmtDefault.pm
<div class="message-stanza open">&gt; &gt; line 68.
&gt; &gt; 
&gt; &gt;     return pack&#40;&#39;U*&#39;, unpack&#40;&#39;n*&#39;, $sTxt&#41;&#41;;
</div>&gt; 
&gt; this fix has been applied to version 0.27_01
</div>
This change might increase the Perl version required for 
Spreadsheet::ParseExcel.

I don&#39;t know if the &#39;U&#39; option for pack&#40;&#41; was there before Perl 5.6 
&#40;or even later&#41;

Maybe wrapping it in an alternative à la

  return pack&#40;&#40;$] &gt;= 5.006&#41; ? &#39;U*&#39; : &#39;C*&#39;&#41;, unpack&#40;&#39;n*&#39;, $sTxt&#41;&#41;

might do the trick.

Alternatively make Spreadsheet::ParseExcel require Perl 5.7 &#40;with all 
the unicode stuff in place&#41;.

I prefer the latter.

Regards
Peter
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;14&nbsp;04:26:35&nbsp;2009</span>
    <span class="description">jmcnamara [...] cpan.org -  Subject changed from &#39;Warnings during parsing of excel sheet&#39; to &#39;Warnings during parsing of excel sheet &#40;Unicode issue&#41;&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;05&nbsp;09:26:40&nbsp;2011</span>
    <span class="description">JEB [...] cpan.org -  Reference by ticket #70035 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;07&nbsp;15:56:02&nbsp;2014</span>
    <span class="description">DOUGW [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Aug 17 06:33:12 2004, SREZIC wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; return pack&#40;&#39;U*&#39;, unpack&#40;&#39;n*&#39;, $sTxt&#41;&#41;;
</div>
This seems to have been done long ago.
Let&#39;s close this ticket.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;07&nbsp;15:56:03&nbsp;2014</span>
    <span class="description">DOUGW [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
