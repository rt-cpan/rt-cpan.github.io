<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #114468 for Thread-Queue: 07_lock.t leaks temp files, and other bad things</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #114468 for Thread-Queue: 07_lock.t leaks temp files, and other bad things</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Thread-Queue/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Thread-Queue/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Thread-Queue/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Thread-Queue/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Thread-Queue">Thread-Queue CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">114468</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Thread-Queue/Active/">Thread-Queue</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
exodist7 [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-220700-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-220701-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
3.11    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;18&nbsp;12:02:06&nbsp;2016</span>
    <span class="description">exodist7 [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 07_lock.t leaks temp files, and other bad things</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/JDHEDDEN/Thread-Queue-3.09/t/07_lock.t">https://metacpan.org/source/JDHEDDEN/Thread-Queue-3.09/t/07_lock.t</a></span>

This test detaches a thread and lets the parent thread end before the detached thread. This causes perl to skip global destruction. Without global destruction you get some nasty things like temp file and SHM leaks.

Changing the test so that it does not detach, but instead eventually joins, will allow global destruction to take place and things don&#39;t leak anymore.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;18&nbsp;12:46:43&nbsp;2016</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2016-05-18 12:02:06, EXODIST wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This test detaches a thread and lets the parent thread end before the
&gt; detached thread.
</div>
I don&#39;t think that is the case.  The detached thread locks the queue that is being tested &#40;line 34&#41;.  This lock is not released until the thread exits its subroutine at which point is will start to be destroyed.

Meanwhile, the main thread is blocked from reading the queue until the lock is released &#40;line 46&#41;.  Following that it does one more yield &#40;line 48&#41; to allow for the thread to be destroyed before itself exiting.

Do you have any evidence that indicates the main thread exits before the detached thread is destroyed?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This [main thread exiting with detached threads] causes perl to skip global
&gt; destruction.
</div>
I am not aware that this is the case.  Can you provide documentation/evidence regarding this?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;18&nbsp;12:46:44&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;18&nbsp;12:56:05&nbsp;2016</span>
    <span class="description">exodist7 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed May 18 09:46:43 2016, JDHEDDEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 2016-05-18 12:02:06, EXODIST wrote:
<div class="message-stanza open">&gt; &gt; This test detaches a thread and lets the parent thread end before the
&gt; &gt; detached thread.
</div>&gt; 
&gt; I don&#39;t think that is the case.  The detached thread locks the queue
&gt; that is being tested &#40;line 34&#41;.  This lock is not released until the
&gt; thread exits its subroutine at which point is will start to be
&gt; destroyed.
&gt; 
&gt; Meanwhile, the main thread is blocked from reading the queue until the
&gt; lock is released &#40;line 46&#41;.  Following that it does one more yield
&gt; &#40;line 48&#41; to allow for the thread to be destroyed before itself
&gt; exiting.
&gt; 
&gt; Do you have any evidence that indicates the main thread exits before
&gt; the detached thread is destroyed?
&gt; 
<div class="message-stanza open">&gt; &gt; This [main thread exiting with detached threads] causes perl to skip
&gt; &gt; global
&gt; &gt; destruction.
</div>&gt; 
&gt; I am not aware that this is the case.  Can you provide
&gt; documentation/evidence regarding this?
</div>

Add the following to your test just above the exit&#40;0&#41;

{
    package foo;
    sub DESTROY {
        print &#34;Global Destruction thread: &#34; . threads-&gt;tid . &#34;\n&#34;;
    };  
}
our $foo = bless {}, &#39;foo&#39;;

The message will never print. However if you change the test so that you save the thread, and call -&gt;join on it before the exit, then the message will print.


Yesterday on #p5p several of us were discussing it. We noticed the problem because the perl test suite was not cleaning up all its temp files, this test is one of the culprits. Eventually we had to dive into thread code and confirm there is &#40;intentional!!&#41; code to block global destruction if there are running detached threads.

When we change this test to join on the thread instead of detach the leak stops.

Test2 &#40;the new Test-Simple&#41; uses temp files for threaded code, and we noticed it&#39;s destruction never occurred for this test, which is why there are temp files being left behind.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;18&nbsp;12:58:43&nbsp;2016</span>
    <span class="description">exodist7 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">It is important to note that the speed of the computer matters, this is racey, sometimes the detahced thread does finish first, but sometimes it does not.

You locking works for making the threads both wait till the end, but at the end they both race to shut-down first.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;18&nbsp;13:01:10&nbsp;2016</span>
    <span class="description">exodist7 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here is a snippet of the detective work:

&lt;haarg&gt; [14:45:07] 5.8 sometimes it works, sometimes it segfaults, sometimes it complains about 2 threads running at exit
&lt;haarg&gt; [14:45:40] and the other various things that threads always do
&lt;haarg&gt; [14:46:42] monkeypatching threads is really ugly, but as far as i can tell there isn&#39;t any other way to get the information needed
&lt;haarg&gt; [14:47:07] so it would need some other workaround
&lt;hobbs&gt; [14:52:25] github.com/Perl/perl5/commit/ae3fba3defe4ed89f6b20b720860824178f77f52
&lt;hobbs&gt; [14:52:30] <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/Perl/perl5/commit/ae3fba3defe4ed89f6b20b720860824178f77f52">https://github.com/Perl/perl5/commit/ae3fba3defe4ed89f6b20b720860824178f77f52</a></span>
&lt;dipsy&gt; [14:52:31] [ further refinement to #29796 &#40;cleanup veto&#41; · Perl/perl5@ae3fba3 · GitHub ] 
&lt;hobbs&gt; [14:53:31] <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/Perl/perl5/commit/e9a908c9e8acd172c6c36d6cd556432b4821c691">https://github.com/Perl/perl5/commit/e9a908c9e8acd172c6c36d6cd556432b4821c691</a></span> &#40;this is &#34;29796&#34;&#41;
&lt;dipsy&gt; [14:53:32] [ unfreed threads should trigger cleanup veto · Perl/perl5@e9a908c · GitHub ] 
&lt;Exodist&gt; [14:54:12] wow. it is intentional behavior
&lt;hobbs&gt; [14:54:21] &#34;The thread pool struct is allocated in the main interpreter, so don&#39;t clean that up if any threads remain, regardless of what state they are in&#34;
&lt;hobbs&gt; [14:56:11] between 5.9.4 and 5.9.5, so haarg hit the mark
&lt;haarg&gt; [14:59:17] well, &#34;intentional&#34;
&lt;hobbs&gt; [15:00:10] yeah, more of a cop-out than a fix
&lt;hobbs&gt; [15:00:14] I mean, segfaults are bad and all
* Exodist [15:01:31] wonders how many things out there will actually detach a thread and let it hang while the main thread exits.
&lt;hobbs&gt; [15:02:13] it seems less than useful, since the detached thread will just unexpectedly terminate anyway
&lt;Exodist&gt; [15:02:19] yeah.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;18&nbsp;13:12:38&nbsp;2016</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #114468] 07_lock.t leaks temp files, and other bad things</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 18 May 2016 13:11:52 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Thread-Queue [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Jerry D. Hedden&#34; &lt;jdhedden [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Wow.  This is something that needs to be documented in the &#39;threads&#39; POD.
Thanks for the info.  I&#39;ll handle both in the next few days.

On Wed, May 18, 2016 at 1:01 PM, Chad Granum via RT &lt;
bug-Thread-Queue@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Thread-Queue
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=114468">https://rt.cpan.org/Ticket/Display.html?id=114468</a></span> &gt;
&gt;
&gt; Here is a snippet of the detective work:
&gt;
&gt; &lt;haarg&gt; [14:45:07] 5.8 sometimes it works, sometimes it segfaults,
&gt; sometimes it complains about 2 threads running at exit
&gt; &lt;haarg&gt; [14:45:40] and the other various things that threads always do
&gt; &lt;haarg&gt; [14:46:42] monkeypatching threads is really ugly, but as far as i
&gt; can tell there isn&#39;t any other way to get the information needed
&gt; &lt;haarg&gt; [14:47:07] so it would need some other workaround
&gt; &lt;hobbs&gt; [14:52:25]
&gt; github.com/Perl/perl5/commit/ae3fba3defe4ed89f6b20b720860824178f77f52
&gt; &lt;hobbs&gt; [14:52:30]
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/Perl/perl5/commit/ae3fba3defe4ed89f6b20b720860824178f77f52">https://github.com/Perl/perl5/commit/ae3fba3defe4ed89f6b20b720860824178f77f52</a></span>
&gt; &lt;dipsy&gt; [14:52:31] [ further refinement to #29796 &#40;cleanup veto&#41; ·
&gt; Perl/perl5@ae3fba3 · GitHub ]
&gt; &lt;hobbs&gt; [14:53:31]
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/Perl/perl5/commit/e9a908c9e8acd172c6c36d6cd556432b4821c691">https://github.com/Perl/perl5/commit/e9a908c9e8acd172c6c36d6cd556432b4821c691</a></span>
&gt; &#40;this is &#34;29796&#34;&#41;
&gt; &lt;dipsy&gt; [14:53:32] [ unfreed threads should trigger cleanup veto ·
&gt; Perl/perl5@e9a908c · GitHub ]
&gt; &lt;Exodist&gt; [14:54:12] wow. it is intentional behavior
&gt; &lt;hobbs&gt; [14:54:21] &#34;The thread pool struct is allocated in the main
&gt; interpreter, so don&#39;t clean that up if any threads remain, regardless of
&gt; what state they are in&#34;
&gt; &lt;hobbs&gt; [14:56:11] between 5.9.4 and 5.9.5, so haarg hit the mark
&gt; &lt;haarg&gt; [14:59:17] well, &#34;intentional&#34;
&gt; &lt;hobbs&gt; [15:00:10] yeah, more of a cop-out than a fix
&gt; &lt;hobbs&gt; [15:00:14] I mean, segfaults are bad and all
&gt; * Exodist [15:01:31] wonders how many things out there will actually
&gt; detach a thread and let it hang while the main thread exits.
&gt; &lt;hobbs&gt; [15:02:13] it seems less than useful, since the detached thread
&gt; will just unexpectedly terminate anyway
&gt; &lt;Exodist&gt; [15:02:19] yeah.
&gt;
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;18&nbsp;13:15:56&nbsp;2016</span>
    <span class="description">haarg [...] haarg.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed May 18 12:46:43 2016, JDHEDDEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 2016-05-18 12:02:06, EXODIST wrote:
<div class="message-stanza open">&gt; &gt; This test detaches a thread and lets the parent thread end before the
&gt; &gt; detached thread.
</div>&gt; 
&gt; I don&#39;t think that is the case.  The detached thread locks the queue
&gt; that is being tested &#40;line 34&#41;.  This lock is not released until the
&gt; thread exits its subroutine at which point is will start to be
&gt; destroyed.
&gt; 
&gt; Meanwhile, the main thread is blocked from reading the queue until the
&gt; lock is released &#40;line 46&#41;.  Following that it does one more yield
&gt; &#40;line 48&#41; to allow for the thread to be destroyed before itself
&gt; exiting.
&gt; 
&gt; Do you have any evidence that indicates the main thread exits before
&gt; the detached thread is destroyed?
&gt; 
<div class="message-stanza open">&gt; &gt; This [main thread exiting with detached threads] causes perl to skip
&gt; &gt; global
&gt; &gt; destruction.
</div>&gt; 
&gt; I am not aware that this is the case.  Can you provide
&gt; documentation/evidence regarding this?
</div>
Attached is a script that demonstrates the issue with global destruction and detached threads.  Depending on the timing, you can get 2 or 0 messages.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> thread-detach-gd.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use warnings;
use threads;

sub ShowDestroy::DESTROY {
  warn &#34;destroyed in thread &#34; . threads-&gt;tid;
}
our $guff = bless {}, &#39;ShowDestroy&#39;;
threads-&gt;create&#40;sub{ 1 }&#41;-&gt;detach;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;22&nbsp;07:29:41&nbsp;2016</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2016-05-18 12:02:06, EXODIST wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/JDHEDDEN/Thread-Queue-3.09/t/07_lock.t">https://metacpan.org/source/JDHEDDEN/Thread-Queue-3.09/t/07_lock.t</a></span>
&gt; 
&gt; This test detaches a thread and lets the parent thread end before the
&gt; detached thread. This causes perl to skip global destruction. Without
&gt; global destruction you get some nasty things like temp file and SHM
&gt; leaks.
&gt; 
&gt; Changing the test so that it does not detach, but instead eventually
&gt; joins, will allow global destruction to take place and things don&#39;t
&gt; leak anymore.
</div>
Fixed in v3.11.   Thanks.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;22&nbsp;07:29:50&nbsp;2016</span>
    <span class="description">jdhedden [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;May&nbsp;22&nbsp;07:29:51&nbsp;2016</span>
    <span class="description">jdhedden [...] cpan.org -  Fixed in 3.11 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
