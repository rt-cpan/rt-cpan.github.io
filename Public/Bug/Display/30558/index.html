<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #30558 for DBD-SQLite: INSERT After PK Failure Also Fails Using Prepared</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #30558 for DBD-SQLite: INSERT After PK Failure Also Fails Using Prepared</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-SQLite/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-SQLite">DBD-SQLite CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">30558</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-SQLite/Active/">DBD-SQLite</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
claco [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-10248-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
1.13</li>
<li>
1.14</li>
</ul>
    </td>
  </tr>
  <tr id="CF-10249-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.12    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




30558.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/381729/174758/30558.patch">
Sat Nov 10 14:43:16 2007 (564b) by ntyni [...] iki.fi
</a>
</font></li>
</ul>


signature.asc<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/382343/175123/signature.asc">
Mon Nov 12 10:07:47 2007 (187b) by claco [...] chrislaco.com
</a>
</font></li>
</ul>


test.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/380365/174020/test.pl">
Wed Nov 07 14:50:00 2007 (690b) by claco [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;07&nbsp;14:49:59&nbsp;2007</span>
    <span class="description">claco [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> INSERT After PK Failure Also Fails Using Prepared</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Using prepared statements/bind params, an INSERT with a duplicate pk
value in the database fails do to a PK violation with the following error:

DBD::SQLite::st execute failed: column id is not unique&#40;19&#41; at dbdimp.c
line 403

This is of course, expected. However, the very next INSERT statement
using a unique pk value executed on the same statement handle also fails
with the following, slightly different error:

DBD::SQLite::st execute failed: column id is not unique&#40;21&#41; at dbdimp.c
line 376

This does not happen if one uses regular sql statements using $dbh-&gt;do
instead of the prepared statement. On win32, this only happens in
1.13/1.14 and worked fine in 1.12. One some other platforms, rather than
an error, a core dump might happen instead.

Attached is the test script containing a bare bones example of the issue.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -wT
use strict;
use warnings;
use DBI;

unlink &#39;test.db&#39;;

my $dbh = DBI-&gt;connect&#40;&#39;dbi:SQLite:test.db&#39;, undef, undef, {
    AutoCommit =&gt; 1,
    PrintError =&gt; 0,
    PrintWarn =&gt; 0,
    RaiseError =&gt; 1
}&#41;;

$dbh-&gt;do&#40;&#39;CREATE TABLE test &#40;id VARCHAR&#40;10&#41; NOT NULL, name VARCHAR&#40;20&#41; NOT NULL, PRIMARY KEY&#40;id&#41;&#41;;&#39;&#41;;
$dbh-&gt;do&#40;&#39;INSERT INTO test &#40;id, name&#41; VALUES &#40;\&#39;1\&#39;, \&#39;a\&#39;&#41;;&#39;&#41;;

my $sth = $dbh-&gt;prepare&#40;&#39;INSERT INTO test &#40;id, name&#41; VALUES &#40;?, ?&#41;&#39;&#41;;
eval {
    $sth-&gt;execute&#40;&#39;1&#39;, &#39;a&#39;&#41;;
};
warn $@;

## the following line barfs on win32 1.13/1.14 with:
## DBD::SQLite::st execute failed: column id is not unique&#40;21&#41; at dbdimp.c line 376 at test.pl line 26
$sth-&gt;execute&#40;&#39;2&#39;, &#39;b&#39;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;10&nbsp;14:43:15&nbsp;2007</span>
    <span class="description">ntyni [...] iki.fi -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ntyni [...] iki.fi</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Nov 07 14:49:59 2007, CLACO wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Using prepared statements/bind params, an INSERT with a duplicate pk
&gt; value in the database fails do to a PK violation with the following error:
&gt; 
&gt; DBD::SQLite::st execute failed: column id is not unique&#40;19&#41; at dbdimp.c
&gt; line 403
&gt; 
&gt; This is of course, expected. However, the very next INSERT statement
&gt; using a unique pk value executed on the same statement handle also fails
&gt; with the following, slightly different error:
&gt; 
&gt; DBD::SQLite::st execute failed: column id is not unique&#40;21&#41; at dbdimp.c
&gt; line 376
</div>
Hi,

the same issue &#40;with a crash&#41; has been reported as Debian bug #450744:
<span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/450744">http://bugs.debian.org/450744</a></span> . The reporter, Kevin Ryde, writes:

-- clip --

I suspect that when sqlite_st_execute gets an &#34;insert&#34; error like this
it ends up freeing the underlying &#34;sqlite3_stmt&#34; object, so that a
further execute of it bombs.  I think the free is done by the following
line in sqlite_st_execute &#40;the first one, at &#34;return -5&#34;&#41;,

    /* There are bug reports that say this should be sqlite3_reset&#40;&#41; */
    sqlite3_finalize&#40;imp_sth-&gt;stmt&#41;;

I think the comment is right, under gdb you can see the stmt pointer
value getting used again on the next execute of the same perl-level
$sth.  Actually I saw that stmt space getting overwritten with the error
message string &#34;column x is not unique ...&#34;, which made me wonder if was
some sort of pointer juggling mixup, but I think it&#39;s just coincidence
that it&#39;s related data ending up there after the space has been free&#40;&#41;ed
and then handed out by malloc&#40;&#41; again.  &#40;Results vary if for instance
you turn on $dbh-&gt;trace&#40;&#41;s.&#41;

-- clip --

I can verify that the attached patch &#40;against 1.14&#41; fixes the crash. The
test suite still passes with the change. Looking at the SQLite API docs,
it looks pretty clear to me that sqlite3_reset&#40;&#41; is the right thing to do.

Cheers,
-- 
Niko Tyni / Debian Perl Group
ntyni@iki.fi
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/dbdimp.c b/dbdimp.c
index 8dcab51..1ed8ebd 100644
--- a/dbdimp.c
+++ b/dbdimp.c
@@ -398,8 +398,7 @@ sqlite_st_execute &#40;SV *sth, imp_sth_t *imp_sth&#41;
             if &#40;imp_sth-&gt;retval == SQLITE_ROW&#41; {
                 continue;
             }
-            /* There are bug reports that say this should be sqlite3_reset&#40;&#41; */
-            sqlite3_finalize&#40;imp_sth-&gt;stmt&#41;;
+            sqlite3_reset&#40;imp_sth-&gt;stmt&#41;;
             sqlite_error&#40;sth, &#40;imp_xxh_t*&#41;imp_sth, imp_sth-&gt;retval, &#40;char*&#41;sqlite3_errmsg&#40;imp_dbh-&gt;db&#41;&#41;;
             return -5;
         }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;10&nbsp;14:43:19&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;12&nbsp;10:07:43&nbsp;2007</span>
    <span class="description">claco [...] chrislaco.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #30558] INSERT After PK Failure Also Fails Using Prepared</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 12 Nov 2007 10:05:38 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-SQLite [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Christopher H. Laco&#34; &lt;claco [...] chrislaco.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I can confirm that the mentioned patch does fix things for me.

I guess the funny part is the fact that the source already contains:

/* There are bug reports that say this should be sqlite3_reset&#40;&#41; */

In fact, the current patch only catches one instance of this issue. Line
422 has the same comment.

-=Chris
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/382343/175123/signature.asc">Download signature.asc</a><br />
<span class="downloadcontenttype">application/pgp-signature 187b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;02&nbsp;12:18:37&nbsp;2008</span>
    <span class="description">MLAWREN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Nov 12 10:07:43 2007, claco@chrislaco.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I can confirm that the mentioned patch does fix things for me.
</div>
+1 for me on:

a&#41; being caught by this

b&#41; the patch fixing things for me

c&#41; having spent *way* too many hours hunting this problem down, through
everyone reporting different scenarios and me not being able to find the
right keywords with google.

Matt, are you listening? Likely to be a new release anytime soon? If you
need someone to help test and/or patch please let me know. You don&#39;t
have a mailing list for this module but I hang out on dbi-users.

There are quite few old bugs in RT that need attention &#40;cleaning out&#41;
which I&#39;d also be happy to work on.

Cheers,
Mark.
-- 
Mark Lawrence
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;03&nbsp;22:34:26&nbsp;2009</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">To the best of my knowledge, this now works in 1.19_07.

Please investigate and confirm.

If anyone wants to get more involved with maintaining DBD::SQLite,
please let me know and I&#39;ll get you commit access.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;03&nbsp;22:34:28&nbsp;2009</span>
    <span class="description">adamk [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
