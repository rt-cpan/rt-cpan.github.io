<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #116346 for Net-SSLeay: Under mod_perl, first client connection fails in CTX_new, but subsequent connections work</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #116346 for Net-SSLeay: Under mod_perl, first client connection fails in CTX_new, but subsequent connections work</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-SSLeay/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-SSLeay">Net-SSLeay CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">116346</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-SSLeay/Active/">Net-SSLeay</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ivan-pause [...] 420.am

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-44414-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
1.65</li>
<li>
1.66</li>
<li>
1.67</li>
<li>
1.68</li>
<li>
1.69</li>
<li>
1.70</li>
<li>
1.71</li>
<li>
1.72</li>
<li>
1.73</li>
<li>
1.74</li>
</ul>
    </td>
  </tr>
  <tr id="CF-44415-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;20&nbsp;15:58:57&nbsp;2016</span>
    <span class="description">ivan-pause [...] 420.am -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Under mod_perl, first client connection fails in CTX_new, but
 subsequent connections work</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Running in a &#40;preforking&#41; mod_perl context, the first client conneciton
attempted &#40;during each process lifetime&#41; fails.  Subsequent connections work.

Occurs in Debian stable &#40;v8&#41; with and in Debian unstable &#40;using a mod_perl 2.0.9 prerelease / Apache 2.4.10 and mod_perl 2.0.9 / Apache 2.4.23, respectively&#41;.  Have not attempted other OSes or versions yet.

Example script:

  #!/usr/bin/perl
  use Net::SSLeay qw&#40;post_https make_form&#41;;
  $Net::SSLeay::trace = 0;

  my $host = &#39;secure.authorize.net&#39;;

  my &#40;$page, $response, %reply_headers&#41; = post_https&#40;$host, 443, &#39;/&#39;, &#39;&#39;, make_form&#40;var1 =&gt; &#39;one&#39;, var2 =&gt; &#39;two&#39; &#41;&#41;;
  print &#34;response $response\n&#34;;

  #again, it&#39;ll work...
  &#40;$page, $response, %reply_headers&#41; = post_https&#40;$host, 443, &#39;/&#39;, &#39;&#39;, make_form&#40;var1 =&gt; &#39;one&#39;, var2 =&gt; &#39;two&#39; &#41;&#41;;
  print &#34;response $response\n&#34;;

Example Apache config:

  AddHandler perl-script .cgi
  PerlHandler ModPerl::Registry
  Options +ExecCGI

In a non-mod_perl context, this returns &#40;e.g., depending on $host&#41;:

  ivan@fleetpaw:/var/www/html$ perl testssl.cgi 
  response HTTP/1.1 303 See Other
  response HTTP/1.1 303 See Other

In a mod_perl context, the first time this is called in a process &#40;i.e. after a
restart&#41;, this returns:

  response HTTP/1.0 900 NET OR SSL ERROR

  CTX_new 30723: 1 - error:0906D06C:PEM routines:PEM_read_bio:no start line
  CTX_new 30723: 2 - error:0906D06C:PEM routines:PEM_read_bio:no start line

  response HTTP/1.1 303 See Other

Full trace of failing connection:

  do_httpx3&#40;POST,1,secure.authorize.net:443&#41; at blib/lib/Net/SSLeay.pm &#40;autosplit into blib/lib/auto/Net/SSLeay/do_httpx3.al&#41; line 1318. &#40;blib/lib/Net/SSLeay.pm &#40;autosplit into blib/lib/auto/Net/SSLeay/do_httpx3.al&#41;:1318&#41;
  httpx_cat: usessl=1 &#40;secure.authorize:443&#41; at blib/lib/Net/SSLeay.pm &#40;autosplit into blib/lib/auto/Net/SSLeay/httpx_cat.al&#41; line 1227. &#40;blib/lib/Net/SSLeay.pm &#40;autosplit into blib/lib/auto/Net/SSLeay/httpx_cat.al&#41;:1227&#41;
  Opening connection to secure.authorize.net:443 &#40;64.94.118.32&#41; at blib/lib/Net/SSLeay.pm &#40;autosplit into blib/lib/auto/Net/SSLeay/open_tcp_connection.al&#41; line 486. &#40;blib/lib/Net/SSLeay.pm &#40;autosplit into blib/lib/auto/Net/SSLeay/open_tcp_connection.al&#41;:486&#41;
  next connect at blib/lib/Net/SSLeay.pm &#40;autosplit into blib/lib/auto/Net/SSLeay/open_tcp_connection.al&#41; line 491. &#40;blib/lib/Net/SSLeay.pm &#40;autosplit into blib/lib/auto/Net/SSLeay/open_tcp_connection.al&#41;:491&#41;
  connected to secure.authorize.net, 443 at blib/lib/Net/SSLeay.pm &#40;autosplit into blib/lib/auto/Net/SSLeay/open_tcp_connection.al&#41; line 494. &#40;blib/lib/Net/SSLeay.pm &#40;autosplit into blib/lib/auto/Net/SSLeay/open_tcp_connection.al&#41;:494&#41;
  Creating SSL 0 context... &#40;blib/lib/Net/SSLeay.pm &#40;autosplit into blib/lib/auto/Net/SSLeay/https_cat.al&#41;:1126&#41;
  CTX_new 30717: 1 - error:0906D06C:PEM routines:PEM_read_bio:no start line &#40;/usr/lib/x86_64-linux-gnu/perl5/5.22/Net/SSLeay.pm:422&#41;
  CTX_new 30717: 2 - error:0906D06C:PEM routines:PEM_read_bio:no start line &#40;/usr/lib/x86_64-linux-gnu/perl5/5.22/Net/SSLeay.pm:422&#41;

Changing $host between connections has no effect, so it isn&#39;t a per-host
failure/cache.  Changing $ssl_version has no effect.  This does not appear to
be specific to ModPerl::Registry &#40;originally observed in an HTML::Mason app&#41;.

As a workaround, I&#39;m using the following code per-process to trigger the
one-time context creation error so all subsequent real connections work:

  {
    use Net::SSLeay;
    package Net::SSLeay;
    initialize&#40;&#41;;
    my $bad_ctx = new_x_ctx&#40;&#41;;
    while &#40; ERR_get_error&#40;&#41; &#41; {}; #print_errs&#40;&#39;CTX_new&#39;&#41;;
    CTX_free&#40;$bad_ctx&#41;;
  }

Oddly, retrieving the errors is necessary to make this work.

ref <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/830152">http://bugs.debian.org/830152</a></span>

-- 
Ivan Kohler
President and Head Geek, Freeside Internet Services, Inc.  <span class="clickylink"><a target="new" rel="nofollow" href="http://freeside.biz/">http://freeside.biz/</a></span>
Debian GNU/Linux developer  |  CPAN author  |  cat person  |  ski addict
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;21&nbsp;22:41:35&nbsp;2016</span>
    <span class="description">mikem [...] airspayce.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #116346] Under mod_perl, first client connection fails in CTX_new, but  subsequent connections work</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 22 Jul 2016 12:41:17 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] airspayce.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Ivan,

thanks for your report.

I havent been able to reproduce this on OpenSuse 13.2, but have not tried yet 
on Debian.

Would it be possible to get a dump of the environment variables that are 
passed your perl test script?

Cheers.

On Wednesday, July 20, 2016 03:58:58 PM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Wed Jul 20 15:58:57 2016: Request 116346 was acted upon.
&gt; Transaction: Ticket created by IVAN
&gt;        Queue: Net-SSLeay
&gt;      Subject: Under mod_perl, first client connection fails in CTX_new, but
&gt;  subsequent connections work
&gt;    Broken in: 1.65, 1.66, 1.67, 1.68, 1.69, 1.70, 1.71, 1.72, 1.73, 1.74
&gt;     Severity: Important
&gt;        Owner: Nobody
&gt;   Requestors: ivan-pause@420.am
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=116346">https://rt.cpan.org/Ticket/Display.html?id=116346</a></span> &gt;
&gt; 
&gt; 
&gt; Running in a &#40;preforking&#41; mod_perl context, the first client conneciton
&gt; attempted &#40;during each process lifetime&#41; fails.  Subsequent connections
&gt; work.
&gt; 
&gt; Occurs in Debian stable &#40;v8&#41; with and in Debian unstable &#40;using a mod_perl
&gt; 2.0.9 prerelease / Apache 2.4.10 and mod_perl 2.0.9 / Apache 2.4.23,
&gt; respectively&#41;.  Have not attempted other OSes or versions yet.
&gt; 
&gt; Example script:
&gt; 
&gt;   #!/usr/bin/perl
&gt;   use Net::SSLeay qw&#40;post_https make_form&#41;;
&gt;   $Net::SSLeay::trace = 0;
&gt; 
&gt;   my $host = &#39;secure.authorize.net&#39;;
&gt; 
&gt;   my &#40;$page, $response, %reply_headers&#41; = post_https&#40;$host, 443, &#39;/&#39;, &#39;&#39;,
&gt; make_form&#40;var1 =&gt; &#39;one&#39;, var2 =&gt; &#39;two&#39; &#41;&#41;; print &#34;response $response\n&#34;;
&gt; 
&gt;   #again, it&#39;ll work...
&gt;   &#40;$page, $response, %reply_headers&#41; = post_https&#40;$host, 443, &#39;/&#39;, &#39;&#39;,
&gt; make_form&#40;var1 =&gt; &#39;one&#39;, var2 =&gt; &#39;two&#39; &#41;&#41;; print &#34;response $response\n&#34;;
&gt; 
&gt; Example Apache config:
&gt; 
&gt;   AddHandler perl-script .cgi
&gt;   PerlHandler ModPerl::Registry
&gt;   Options +ExecCGI
&gt; 
&gt; In a non-mod_perl context, this returns &#40;e.g., depending on $host&#41;:
&gt; 
&gt;   ivan@fleetpaw:/var/www/html$ perl testssl.cgi
&gt;   response HTTP/1.1 303 See Other
&gt;   response HTTP/1.1 303 See Other
&gt; 
&gt; In a mod_perl context, the first time this is called in a process &#40;i.e.
&gt; after a restart&#41;, this returns:
&gt; 
&gt;   response HTTP/1.0 900 NET OR SSL ERROR
&gt; 
&gt;   CTX_new 30723: 1 - error:0906D06C:PEM routines:PEM_read_bio:no start line
&gt;   CTX_new 30723: 2 - error:0906D06C:PEM routines:PEM_read_bio:no start line
&gt; 
&gt;   response HTTP/1.1 303 See Other
&gt; 
&gt; Full trace of failing connection:
&gt; 
&gt;   do_httpx3&#40;POST,1,secure.authorize.net:443&#41; at blib/lib/Net/SSLeay.pm
&gt; &#40;autosplit into blib/lib/auto/Net/SSLeay/do_httpx3.al&#41; line 1318.
&gt; &#40;blib/lib/Net/SSLeay.pm &#40;autosplit into
&gt; blib/lib/auto/Net/SSLeay/do_httpx3.al&#41;:1318&#41; httpx_cat: usessl=1
&gt; &#40;secure.authorize:443&#41; at blib/lib/Net/SSLeay.pm &#40;autosplit into
&gt; blib/lib/auto/Net/SSLeay/httpx_cat.al&#41; line 1227. &#40;blib/lib/Net/SSLeay.pm
&gt; &#40;autosplit into blib/lib/auto/Net/SSLeay/httpx_cat.al&#41;:1227&#41; Opening
&gt; connection to secure.authorize.net:443 &#40;64.94.118.32&#41; at
&gt; blib/lib/Net/SSLeay.pm &#40;autosplit into
&gt; blib/lib/auto/Net/SSLeay/open_tcp_connection.al&#41; line 486.
&gt; &#40;blib/lib/Net/SSLeay.pm &#40;autosplit into
&gt; blib/lib/auto/Net/SSLeay/open_tcp_connection.al&#41;:486&#41; next connect at
&gt; blib/lib/Net/SSLeay.pm &#40;autosplit into
&gt; blib/lib/auto/Net/SSLeay/open_tcp_connection.al&#41; line 491.
&gt; &#40;blib/lib/Net/SSLeay.pm &#40;autosplit into
&gt; blib/lib/auto/Net/SSLeay/open_tcp_connection.al&#41;:491&#41; connected to
&gt; secure.authorize.net, 443 at blib/lib/Net/SSLeay.pm &#40;autosplit into
&gt; blib/lib/auto/Net/SSLeay/open_tcp_connection.al&#41; line 494.
&gt; &#40;blib/lib/Net/SSLeay.pm &#40;autosplit into
&gt; blib/lib/auto/Net/SSLeay/open_tcp_connection.al&#41;:494&#41; Creating SSL 0
&gt; context... &#40;blib/lib/Net/SSLeay.pm &#40;autosplit into
&gt; blib/lib/auto/Net/SSLeay/https_cat.al&#41;:1126&#41; CTX_new 30717: 1 -
&gt; error:0906D06C:PEM routines:PEM_read_bio:no start line
&gt; &#40;/usr/lib/x86_64-linux-gnu/perl5/5.22/Net/SSLeay.pm:422&#41; CTX_new 30717: 2 -
&gt; error:0906D06C:PEM routines:PEM_read_bio:no start line
&gt; &#40;/usr/lib/x86_64-linux-gnu/perl5/5.22/Net/SSLeay.pm:422&#41;
&gt; 
&gt; Changing $host between connections has no effect, so it isn&#39;t a per-host
&gt; failure/cache.  Changing $ssl_version has no effect.  This does not appear
&gt; to be specific to ModPerl::Registry &#40;originally observed in an HTML::Mason
&gt; app&#41;.
&gt; 
&gt; As a workaround, I&#39;m using the following code per-process to trigger the
&gt; one-time context creation error so all subsequent real connections work:
&gt; 
&gt;   {
&gt;     use Net::SSLeay;
&gt;     package Net::SSLeay;
&gt;     initialize&#40;&#41;;
&gt;     my $bad_ctx = new_x_ctx&#40;&#41;;
&gt;     while &#40; ERR_get_error&#40;&#41; &#41; {}; #print_errs&#40;&#39;CTX_new&#39;&#41;;
&gt;     CTX_free&#40;$bad_ctx&#41;;
&gt;   }
&gt; 
&gt; Oddly, retrieving the errors is necessary to make this work.
&gt; 
&gt; ref <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/830152">http://bugs.debian.org/830152</a></span>
</div>
-- 
Mike McCauley           VK4AMM                   mikem@airspayce.com
Airspayce Pty Ltd 9 Bulbul Place Currumbin Waters QLD 4223 Australia   
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.airspayce.com">http://www.airspayce.com</a></span>
Phone +61 7 5598-7474
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;21&nbsp;22:41:37&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;22&nbsp;05:39:24&nbsp;2016</span>
    <span class="description">mikem [...] airspayce.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #116346] Under mod_perl, first client connection fails in CTX_new, but  subsequent connections work</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 22 Jul 2016 19:39:02 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] airspayce.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello again.

Tested your sample code OK on 8.5 Jessie with

mod-perl2 2.0.9 and default apache

My request for environment variables stands

Cheers.

On Friday, July 22, 2016 12:41:17 PM Mike McCauley wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hello Ivan,
&gt; 
&gt; thanks for your report.
&gt; 
&gt; I havent been able to reproduce this on OpenSuse 13.2, but have not tried
&gt; yet on Debian.
&gt; 
&gt; Would it be possible to get a dump of the environment variables that are
&gt; passed your perl test script?
&gt; 
&gt; Cheers.
&gt; 
&gt; On Wednesday, July 20, 2016 03:58:58 PM you wrote:
<div class="message-stanza open">&gt; &gt; Wed Jul 20 15:58:57 2016: Request 116346 was acted upon.
&gt; &gt; Transaction: Ticket created by IVAN
&gt; &gt; 
&gt; &gt;        Queue: Net-SSLeay
&gt; &gt;      
&gt; &gt;      Subject: Under mod_perl, first client connection fails in CTX_new,
&gt; &gt;      but
&gt; &gt;  
&gt; &gt;  subsequent connections work
&gt; &gt;  
&gt; &gt;    Broken in: 1.65, 1.66, 1.67, 1.68, 1.69, 1.70, 1.71, 1.72, 1.73, 1.74
&gt; &gt;    
&gt; &gt;     Severity: Important
&gt; &gt;     
&gt; &gt;        Owner: Nobody
&gt; &gt;   
&gt; &gt;   Requestors: ivan-pause@420.am
&gt; &gt;   
&gt; &gt;       Status: new
&gt; &gt;  
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=116346">https://rt.cpan.org/Ticket/Display.html?id=116346</a></span> &gt;
&gt; &gt; 
&gt; &gt; Running in a &#40;preforking&#41; mod_perl context, the first client conneciton
&gt; &gt; attempted &#40;during each process lifetime&#41; fails.  Subsequent connections
&gt; &gt; work.
&gt; &gt; 
&gt; &gt; Occurs in Debian stable &#40;v8&#41; with and in Debian unstable &#40;using a mod_perl
&gt; &gt; 2.0.9 prerelease / Apache 2.4.10 and mod_perl 2.0.9 / Apache 2.4.23,
&gt; &gt; respectively&#41;.  Have not attempted other OSes or versions yet.
&gt; &gt; 
&gt; &gt; Example script:
&gt; &gt;   #!/usr/bin/perl
&gt; &gt;   use Net::SSLeay qw&#40;post_https make_form&#41;;
&gt; &gt;   $Net::SSLeay::trace = 0;
&gt; &gt;   
&gt; &gt;   my $host = &#39;secure.authorize.net&#39;;
&gt; &gt;   
&gt; &gt;   my &#40;$page, $response, %reply_headers&#41; = post_https&#40;$host, 443, &#39;/&#39;, &#39;&#39;,
&gt; &gt; 
&gt; &gt; make_form&#40;var1 =&gt; &#39;one&#39;, var2 =&gt; &#39;two&#39; &#41;&#41;; print &#34;response $response\n&#34;;
&gt; &gt; 
&gt; &gt;   #again, it&#39;ll work...
&gt; &gt;   &#40;$page, $response, %reply_headers&#41; = post_https&#40;$host, 443, &#39;/&#39;, &#39;&#39;,
&gt; &gt; 
&gt; &gt; make_form&#40;var1 =&gt; &#39;one&#39;, var2 =&gt; &#39;two&#39; &#41;&#41;; print &#34;response $response\n&#34;;
&gt; &gt; 
&gt; &gt; Example Apache config:
&gt; &gt;   AddHandler perl-script .cgi
&gt; &gt;   PerlHandler ModPerl::Registry
&gt; &gt;   Options +ExecCGI
&gt; &gt; 
&gt; &gt; In a non-mod_perl context, this returns &#40;e.g., depending on $host&#41;:
&gt; &gt;   ivan@fleetpaw:/var/www/html$ perl testssl.cgi
&gt; &gt;   response HTTP/1.1 303 See Other
&gt; &gt;   response HTTP/1.1 303 See Other
&gt; &gt; 
&gt; &gt; In a mod_perl context, the first time this is called in a process &#40;i.e.
&gt; &gt; 
&gt; &gt; after a restart&#41;, this returns:
&gt; &gt;   response HTTP/1.0 900 NET OR SSL ERROR
&gt; &gt;   
&gt; &gt;   CTX_new 30723: 1 - error:0906D06C:PEM routines:PEM_read_bio:no start
&gt; &gt;   line
&gt; &gt;   CTX_new 30723: 2 - error:0906D06C:PEM routines:PEM_read_bio:no start
&gt; &gt;   line
&gt; &gt;   
&gt; &gt;   response HTTP/1.1 303 See Other
&gt; &gt; 
&gt; &gt; Full trace of failing connection:
&gt; &gt;   do_httpx3&#40;POST,1,secure.authorize.net:443&#41; at blib/lib/Net/SSLeay.pm
&gt; &gt; 
&gt; &gt; &#40;autosplit into blib/lib/auto/Net/SSLeay/do_httpx3.al&#41; line 1318.
&gt; &gt; &#40;blib/lib/Net/SSLeay.pm &#40;autosplit into
&gt; &gt; blib/lib/auto/Net/SSLeay/do_httpx3.al&#41;:1318&#41; httpx_cat: usessl=1
&gt; &gt; &#40;secure.authorize:443&#41; at blib/lib/Net/SSLeay.pm &#40;autosplit into
&gt; &gt; blib/lib/auto/Net/SSLeay/httpx_cat.al&#41; line 1227. &#40;blib/lib/Net/SSLeay.pm
&gt; &gt; &#40;autosplit into blib/lib/auto/Net/SSLeay/httpx_cat.al&#41;:1227&#41; Opening
&gt; &gt; connection to secure.authorize.net:443 &#40;64.94.118.32&#41; at
&gt; &gt; blib/lib/Net/SSLeay.pm &#40;autosplit into
&gt; &gt; blib/lib/auto/Net/SSLeay/open_tcp_connection.al&#41; line 486.
&gt; &gt; &#40;blib/lib/Net/SSLeay.pm &#40;autosplit into
&gt; &gt; blib/lib/auto/Net/SSLeay/open_tcp_connection.al&#41;:486&#41; next connect at
&gt; &gt; blib/lib/Net/SSLeay.pm &#40;autosplit into
&gt; &gt; blib/lib/auto/Net/SSLeay/open_tcp_connection.al&#41; line 491.
&gt; &gt; &#40;blib/lib/Net/SSLeay.pm &#40;autosplit into
&gt; &gt; blib/lib/auto/Net/SSLeay/open_tcp_connection.al&#41;:491&#41; connected to
&gt; &gt; secure.authorize.net, 443 at blib/lib/Net/SSLeay.pm &#40;autosplit into
&gt; &gt; blib/lib/auto/Net/SSLeay/open_tcp_connection.al&#41; line 494.
&gt; &gt; &#40;blib/lib/Net/SSLeay.pm &#40;autosplit into
&gt; &gt; blib/lib/auto/Net/SSLeay/open_tcp_connection.al&#41;:494&#41; Creating SSL 0
&gt; &gt; context... &#40;blib/lib/Net/SSLeay.pm &#40;autosplit into
&gt; &gt; blib/lib/auto/Net/SSLeay/https_cat.al&#41;:1126&#41; CTX_new 30717: 1 -
&gt; &gt; error:0906D06C:PEM routines:PEM_read_bio:no start line
&gt; &gt; &#40;/usr/lib/x86_64-linux-gnu/perl5/5.22/Net/SSLeay.pm:422&#41; CTX_new 30717: 2
&gt; &gt; -
&gt; &gt; error:0906D06C:PEM routines:PEM_read_bio:no start line
&gt; &gt; &#40;/usr/lib/x86_64-linux-gnu/perl5/5.22/Net/SSLeay.pm:422&#41;
&gt; &gt; 
&gt; &gt; Changing $host between connections has no effect, so it isn&#39;t a per-host
&gt; &gt; failure/cache.  Changing $ssl_version has no effect.  This does not appear
&gt; &gt; to be specific to ModPerl::Registry &#40;originally observed in an HTML::Mason
&gt; &gt; app&#41;.
&gt; &gt; 
&gt; &gt; As a workaround, I&#39;m using the following code per-process to trigger the
&gt; &gt; 
&gt; &gt; one-time context creation error so all subsequent real connections work:
&gt; &gt;   {
&gt; &gt;   
&gt; &gt;     use Net::SSLeay;
&gt; &gt;     package Net::SSLeay;
&gt; &gt;     initialize&#40;&#41;;
&gt; &gt;     my $bad_ctx = new_x_ctx&#40;&#41;;
&gt; &gt;     while &#40; ERR_get_error&#40;&#41; &#41; {}; #print_errs&#40;&#39;CTX_new&#39;&#41;;
&gt; &gt;     CTX_free&#40;$bad_ctx&#41;;
&gt; &gt;   
&gt; &gt;   }
&gt; &gt; 
&gt; &gt; Oddly, retrieving the errors is necessary to make this work.
&gt; &gt; 
&gt; &gt; ref <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/830152">http://bugs.debian.org/830152</a></span>
</div></div>
-- 
Mike McCauley           VK4AMM                   mikem@airspayce.com
Airspayce Pty Ltd 9 Bulbul Place Currumbin Waters QLD 4223 Australia   
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.airspayce.com">http://www.airspayce.com</a></span>
Phone +61 7 5598-7474
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;22&nbsp;16:57:21&nbsp;2016</span>
    <span class="description">ivan-pause [...] 420.am -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jul 21 22:41:35 2016, mikem@airspayce.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Would it be possible to get a dump of the environment variables 
&gt; that are passed your perl test script?
</div>
Here are the environment variables in a successful, command-line run:

$ENV{XDG_SESSION_DESKTOP}: KDE
$ENV{XAUTHORITY}: /tmp/xauth-1000-_0
$ENV{QT_LINUX_ACCESSIBILITY_ALWAYS_ON}: 1
$ENV{XCURSOR_THEME}: oxy-oxygen
$ENV{XDG_CURRENT_DESKTOP}: KDE
$ENV{USER}: ivan
$ENV{KDE_FULL_SESSION}: true
$ENV{XDG_SESSION_TYPE}: x11
$ENV{COLORFGBG}: 0;15
$ENV{TERM}: xterm
$ENV{KDE_SESSION_VERSION}: 5
$ENV{KDE_MULTIHEAD}: false
$ENV{SSH_AUTH_SOCK}: /tmp/ssh-NnejOw4evFyf/agent.3424
$ENV{DEBFULLNAME}: Ivan Kohler
$ENV{DISPLAY}: :0
$ENV{XDG_SESSION_COOKIE}: &#40;redacted&#41;
$ENV{GTK_RC_FILES}: /etc/gtk/gtkrc:/home/ivan/.gtkrc:/home/ivan/.config/gtkrc
$ENV{_}: /usr/bin/perl
$ENV{KDE_SESSION_UID}: 1000
$ENV{HOME}: /home/ivan
$ENV{SHELL_SESSION_ID}: 6db9b5daa5534000a1f0e665e8a5d556
$ENV{DESKTOP_SESSION}: /usr/share/xsessions/plasma
$ENV{XDG_SESSION_CLASS}: user
$ENV{LANGUAGE}: 
$ENV{PROFILEHOME}: 
$ENV{KONSOLE_DBUS_SERVICE}: :1.45
$ENV{LOGNAME}: ivan
$ENV{PATH}: /usr/local/bin:/usr/bin:/bin:/usr/games
$ENV{KONSOLE_PROFILE_NAME}: Shell
$ENV{PWD}: /var/www/html
$ENV{XDG_RUNTIME_DIR}: /run/user/1000
$ENV{DBIMON_PAGER}: less -X
$ENV{XDG_VTNR}: 7
$ENV{EDITOR}: vim
$ENV{XDG_SESSION_ID}: 6
$ENV{XDG_SESSION_PATH}: /org/freedesktop/DisplayManager/Session1
$ENV{GS_LIB}: /home/ivan/.fonts
$ENV{OLDPWD}: /var/www/html
$ENV{XCURSOR_SIZE}: 0
$ENV{DBUS_SESSION_BUS_ADDRESS}: unix:abstract=/tmp/dbus-XAFtFBIdnW,guid=6455bbd8d110296137b4cd795771e3b6
$ENV{QT_ACCESSIBILITY}: 1
$ENV{SHELL}: /bin/zsh
$ENV{WINDOWID}: 39847836
$ENV{XDG_DATA_DIRS}: /usr/share:/usr/share:/usr/local/share
$ENV{KONSOLE_DBUS_WINDOW}: /Windows/231
$ENV{PAGER}: /usr/bin/less
$ENV{GTK2_RC_FILES}: /etc/gtk-2.0/gtkrc:/home/ivan/.gtkrc-2.0:/home/ivan/.config/gtkrc-2.0
$ENV{PAM_KWALLET5_LOGIN}: /tmp/kwallet5_ivan.socket
$ENV{PS1}: %n@%m:%~%&#40;#.#.$&#41; 
$ENV{KONSOLE_DBUS_SESSION}: /Sessions/231
$ENV{SSH_AGENT_PID}: 3468
$ENV{XDG_SEAT}: seat0
$ENV{XDG_SEAT_PATH}: /org/freedesktop/DisplayManager/Seat0
$ENV{LANG}: en_US.UTF-8
$ENV{DEBEMAIL}: ivan-debian@420.am
$ENV{SESSION_MANAGER}: local/fleetpaw:@/tmp/.ICE-unix/3540,unix/fleetpaw:/tmp/.ICE-unix/3540
$ENV{SHLVL}: 1


Here are the environment variables from a problematic run under mod_perl:

$ENV{HTTP_ACCEPT_LANGUAGE}: en-US,en;q=0.5
$ENV{SERVER_PROTOCOL}: HTTP/1.1
$ENV{SERVER_ADMIN}: webmaster@localhost
$ENV{HTTP_CACHE_CONTROL}: max-age=0
$ENV{HTTP_COOKIE}: FS::AuthCookieHandler24_Freeside=oNQ9w7TUXAU2k9IxadW1vqW4hoKKwRH38dAhlwpp; org.cups.sid=890ba63851f3b66347d8e24063075765
$ENV{REQUEST_SCHEME}: http
$ENV{SERVER_NAME}: localhost
$ENV{CONTEXT_PREFIX}: 
$ENV{SCRIPT_NAME}: /testssl.cgi
$ENV{HTTP_CONNECTION}: keep-alive
$ENV{CONTEXT_DOCUMENT_ROOT}: /var/www/html
$ENV{SCRIPT_FILENAME}: /var/www/html/testssl.cgi
$ENV{MOD_PERL}: mod_perl/2.0.9
$ENV{SERVER_SOFTWARE}: Apache/2.4.23 &#40;Debian&#41;
$ENV{MOD_PERL_API_VERSION}: 2
$ENV{HTTP_ACCEPT_ENCODING}: gzip, deflate
$ENV{PATH}: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
$ENV{GATEWAY_INTERFACE}: CGI/1.1
$ENV{HTTP_ACCEPT}: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
$ENV{REMOTE_PORT}: 59040
$ENV{SERVER_PORT}: 80
$ENV{DOCUMENT_ROOT}: /var/www/html
$ENV{REMOTE_ADDR}: 127.0.0.1
$ENV{HTTP_REFERER}: <span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/">http://localhost/</a></span>
$ENV{REQUEST_METHOD}: GET
$ENV{HTTP_HOST}: localhost
$ENV{HTTP_USER_AGENT}: Mozilla/5.0 &#40;X11; Linux x86_64; rv:45.0&#41; Gecko/20100101 Firefox/45.0
$ENV{REQUEST_URI}: /testssl.cgi
$ENV{QUERY_STRING}: 
$ENV{SERVER_ADDR}: 127.0.0.1
$ENV{SERVER_SIGNATURE}: &lt;address&gt;Apache/2.4.23 &#40;Debian&#41; Server at localhost Port 80&lt;/address&gt;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;22&nbsp;17:31:56&nbsp;2016</span>
    <span class="description">mikem [...] airspayce.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #116346] Under mod_perl, first client connection fails in CTX_new, but subsequent connections work</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 23 Jul 2016 07:31:38 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] airspayce.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Ivan,

thanks, nothing there to explain your problem.

Given that your test case works ok on OpenSuSE and Debian 8.5, Im inclined to 
think the problem you are seeing is due to some other difference in your test 
OS. Perhaps one of these has changes in your OS that account for it:

OpenSSL
Perl
mod_perl
OS socket IO system

of those I would think the likely one is Perl, but maybe OpenSSL

Are the versions of those different in your case to say Debian 8.5?

Cheers.

On Friday, July 22, 2016 04:57:22 PM Ivan Kohler via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=116346">https://rt.cpan.org/Ticket/Display.html?id=116346</a></span> &gt;
&gt; 
&gt; On Thu Jul 21 22:41:35 2016, mikem@airspayce.com wrote:
<div class="message-stanza open">&gt; &gt; Would it be possible to get a dump of the environment variables
&gt; &gt; that are passed your perl test script?
</div>&gt; 
&gt; Here are the environment variables in a successful, command-line run:
&gt; 
&gt; $ENV{XDG_SESSION_DESKTOP}: KDE
&gt; $ENV{XAUTHORITY}: /tmp/xauth-1000-_0
&gt; $ENV{QT_LINUX_ACCESSIBILITY_ALWAYS_ON}: 1
&gt; $ENV{XCURSOR_THEME}: oxy-oxygen
&gt; $ENV{XDG_CURRENT_DESKTOP}: KDE
&gt; $ENV{USER}: ivan
&gt; $ENV{KDE_FULL_SESSION}: true
&gt; $ENV{XDG_SESSION_TYPE}: x11
&gt; $ENV{COLORFGBG}: 0;15
&gt; $ENV{TERM}: xterm
&gt; $ENV{KDE_SESSION_VERSION}: 5
&gt; $ENV{KDE_MULTIHEAD}: false
&gt; $ENV{SSH_AUTH_SOCK}: /tmp/ssh-NnejOw4evFyf/agent.3424
&gt; $ENV{DEBFULLNAME}: Ivan Kohler
&gt; $ENV{DISPLAY}: :0
&gt; $ENV{XDG_SESSION_COOKIE}: &#40;redacted&#41;
&gt; $ENV{GTK_RC_FILES}:
&gt; /etc/gtk/gtkrc:/home/ivan/.gtkrc:/home/ivan/.config/gtkrc $ENV{_}:
&gt; /usr/bin/perl
&gt; $ENV{KDE_SESSION_UID}: 1000
&gt; $ENV{HOME}: /home/ivan
&gt; $ENV{SHELL_SESSION_ID}: 6db9b5daa5534000a1f0e665e8a5d556
&gt; $ENV{DESKTOP_SESSION}: /usr/share/xsessions/plasma
&gt; $ENV{XDG_SESSION_CLASS}: user
&gt; $ENV{LANGUAGE}:
&gt; $ENV{PROFILEHOME}:
&gt; $ENV{KONSOLE_DBUS_SERVICE}: :1.45
&gt; $ENV{LOGNAME}: ivan
&gt; $ENV{PATH}: /usr/local/bin:/usr/bin:/bin:/usr/games
&gt; $ENV{KONSOLE_PROFILE_NAME}: Shell
&gt; $ENV{PWD}: /var/www/html
&gt; $ENV{XDG_RUNTIME_DIR}: /run/user/1000
&gt; $ENV{DBIMON_PAGER}: less -X
&gt; $ENV{XDG_VTNR}: 7
&gt; $ENV{EDITOR}: vim
&gt; $ENV{XDG_SESSION_ID}: 6
&gt; $ENV{XDG_SESSION_PATH}: /org/freedesktop/DisplayManager/Session1
&gt; $ENV{GS_LIB}: /home/ivan/.fonts
&gt; $ENV{OLDPWD}: /var/www/html
&gt; $ENV{XCURSOR_SIZE}: 0
&gt; $ENV{DBUS_SESSION_BUS_ADDRESS}:
&gt; unix:abstract=/tmp/dbus-XAFtFBIdnW,guid=6455bbd8d110296137b4cd795771e3b6
&gt; $ENV{QT_ACCESSIBILITY}: 1
&gt; $ENV{SHELL}: /bin/zsh
&gt; $ENV{WINDOWID}: 39847836
&gt; $ENV{XDG_DATA_DIRS}: /usr/share:/usr/share:/usr/local/share
&gt; $ENV{KONSOLE_DBUS_WINDOW}: /Windows/231
&gt; $ENV{PAGER}: /usr/bin/less
&gt; $ENV{GTK2_RC_FILES}:
&gt; /etc/gtk-2.0/gtkrc:/home/ivan/.gtkrc-2.0:/home/ivan/.config/gtkrc-2.0
&gt; $ENV{PAM_KWALLET5_LOGIN}: /tmp/kwallet5_ivan.socket
&gt; $ENV{PS1}: %n@%m:%~%&#40;#.#.$&#41;
&gt; $ENV{KONSOLE_DBUS_SESSION}: /Sessions/231
&gt; $ENV{SSH_AGENT_PID}: 3468
&gt; $ENV{XDG_SEAT}: seat0
&gt; $ENV{XDG_SEAT_PATH}: /org/freedesktop/DisplayManager/Seat0
&gt; $ENV{LANG}: en_US.UTF-8
&gt; $ENV{DEBEMAIL}: ivan-debian@420.am
&gt; $ENV{SESSION_MANAGER}:
&gt; local/fleetpaw:@/tmp/.ICE-unix/3540,unix/fleetpaw:/tmp/.ICE-unix/3540
&gt; $ENV{SHLVL}: 1
&gt; 
&gt; 
&gt; Here are the environment variables from a problematic run under mod_perl:
&gt; 
&gt; $ENV{HTTP_ACCEPT_LANGUAGE}: en-US,en;q=0.5
&gt; $ENV{SERVER_PROTOCOL}: HTTP/1.1
&gt; $ENV{SERVER_ADMIN}: webmaster@localhost
&gt; $ENV{HTTP_CACHE_CONTROL}: max-age=0
&gt; $ENV{HTTP_COOKIE}:
&gt; FS::AuthCookieHandler24_Freeside=oNQ9w7TUXAU2k9IxadW1vqW4hoKKwRH38dAhlwpp;
&gt; org.cups.sid=890ba63851f3b66347d8e24063075765 $ENV{REQUEST_SCHEME}: http
&gt; $ENV{SERVER_NAME}: localhost
&gt; $ENV{CONTEXT_PREFIX}:
&gt; $ENV{SCRIPT_NAME}: /testssl.cgi
&gt; $ENV{HTTP_CONNECTION}: keep-alive
&gt; $ENV{CONTEXT_DOCUMENT_ROOT}: /var/www/html
&gt; $ENV{SCRIPT_FILENAME}: /var/www/html/testssl.cgi
&gt; $ENV{MOD_PERL}: mod_perl/2.0.9
&gt; $ENV{SERVER_SOFTWARE}: Apache/2.4.23 &#40;Debian&#41;
&gt; $ENV{MOD_PERL_API_VERSION}: 2
&gt; $ENV{HTTP_ACCEPT_ENCODING}: gzip, deflate
&gt; $ENV{PATH}: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
&gt; $ENV{GATEWAY_INTERFACE}: CGI/1.1
&gt; $ENV{HTTP_ACCEPT}:
&gt; text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
&gt; $ENV{REMOTE_PORT}: 59040
&gt; $ENV{SERVER_PORT}: 80
&gt; $ENV{DOCUMENT_ROOT}: /var/www/html
&gt; $ENV{REMOTE_ADDR}: 127.0.0.1
&gt; $ENV{HTTP_REFERER}: <span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/">http://localhost/</a></span>
&gt; $ENV{REQUEST_METHOD}: GET
&gt; $ENV{HTTP_HOST}: localhost
&gt; $ENV{HTTP_USER_AGENT}: Mozilla/5.0 &#40;X11; Linux x86_64; rv:45.0&#41;
&gt; Gecko/20100101 Firefox/45.0 $ENV{REQUEST_URI}: /testssl.cgi
&gt; $ENV{QUERY_STRING}:
&gt; $ENV{SERVER_ADDR}: 127.0.0.1
&gt; $ENV{SERVER_SIGNATURE}: &lt;address&gt;Apache/2.4.23 &#40;Debian&#41; Server at localhost
&gt; Port 80&lt;/address&gt;
</div>
-- 
Mike McCauley           VK4AMM                   mikem@airspayce.com
Airspayce Pty Ltd 9 Bulbul Place Currumbin Waters QLD 4223 Australia   
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.airspayce.com">http://www.airspayce.com</a></span>
Phone +61 7 5598-7474
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;22&nbsp;17:59:04&nbsp;2016</span>
    <span class="description">ivan-pause [...] 420.am -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jul 22 17:31:56 2016, mikem@airspayce.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Ivan,
&gt; 
&gt; thanks, nothing there to explain your problem.
&gt; 
&gt; Given that your test case works ok on OpenSuSE and Debian 8.5,
</div>
I don&#39;t think &#34;works ok on Debian 8.5&#34; is accurate.  The test case fails for me on Debian 8 &#40;8.5&#41; as well as Debian unstable.  It seems unlikely that the failure is a result of a one-off non-OS modification to a single system.  I believe there must be something else that is preventing you from reproducing the problem.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  Im
&gt; inclined to
&gt; think the problem you are seeing is due to some other difference in
&gt; your test
&gt; OS. Perhaps one of these has changes in your OS that account for it:
&gt; 
&gt; OpenSSL
&gt; Perl
&gt; mod_perl
&gt; 
&gt; of those I would think the likely one is Perl, but maybe OpenSSL
&gt; 
&gt; Are the versions of those different in your case to say Debian 8.5?
</div>
I am using the standard versions of all of these from the OS.  I did not install them separately from .  I have reproduced the failure on Debian 8 as well as Debian unstable so far and the versions of Apache and mod_perl in each were reported in the original bug report.  OpenSSL versions are 1.0.1t-1+deb8u2 in Debian 8 and 1.0.2h-1 in Debian unstable.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; OS socket IO system
</div>
I don&#39;t know what you mean by &#34;OS socket IO system&#34;, specifically.  I don&#39;t believe anything was changed from OS defaults, and the failure was reproduced on separate systems running Debian 8 and unstable so far.


-- 
Ivan Kohler
President and Head Geek, Freeside Internet Services, Inc.  <span class="clickylink"><a target="new" rel="nofollow" href="http://freeside.biz/">http://freeside.biz/</a></span>
Debian GNU/Linux developer  |  CPAN author  |  cat person  |  ski addict
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;22&nbsp;18:11:21&nbsp;2016</span>
    <span class="description">ivan-pause [...] 420.am -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I believe I may have found something that may help you reproduce this.  The problem only occurs if mod_ssl is enabled &#40;Debian: a2enmod ssl; service apache restart&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;22&nbsp;18:16:29&nbsp;2016</span>
    <span class="description">ivan-pause [...] 420.am -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jul 22 18:11:21 2016, IVAN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I believe I may have found something that may help you reproduce this.
&gt; The problem only occurs if mod_ssl is enabled &#40;Debian: a2enmod ssl;
&gt; service apache restart&#41;
</div>
That should of course be &#34;service apache2 restart&#34;.  :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;22&nbsp;20:09:00&nbsp;2016</span>
    <span class="description">mikem [...] airspayce.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #116346] Under mod_perl, first client connection fails in CTX_new, but subsequent connections work</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 23 Jul 2016 10:08:44 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] airspayce.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Ivan,

interesting suggestion, but I have now tried that and still its working fine 
from the first attempt.

Cheers.

On Friday, July 22, 2016 06:16:29 PM Ivan Kohler via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=116346">https://rt.cpan.org/Ticket/Display.html?id=116346</a></span> &gt;
&gt; 
&gt; On Fri Jul 22 18:11:21 2016, IVAN wrote:
<div class="message-stanza open">&gt; &gt; I believe I may have found something that may help you reproduce this.
&gt; &gt; The problem only occurs if mod_ssl is enabled &#40;Debian: a2enmod ssl;
&gt; &gt; service apache restart&#41;
</div>&gt; 
&gt; That should of course be &#34;service apache2 restart&#34;.  :&#41;
</div>
-- 
Mike McCauley           VK4AMM                   mikem@airspayce.com
Airspayce Pty Ltd 9 Bulbul Place Currumbin Waters QLD 4223 Australia   
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.airspayce.com">http://www.airspayce.com</a></span>
Phone +61 7 5598-7474
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;11&nbsp;21:14:23&nbsp;2016</span>
    <span class="description">ivan-pause [...] 420.am -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jul 22 20:09:00 2016, mikem@airspayce.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Ivan,
&gt; 
&gt; interesting suggestion, but I have now tried that and still its
&gt; working fine
&gt; from the first attempt.
</div>
I haven&#39;t yet been able to narrow down the issue to a more specific test case that I can give you to reproduce.  I&#39;ll keep working on that as time permits and see what I can do.

I did want to let you know that this is an issue we saw with our Perl application &#34;in the wild&#34; on multiple customer production machines as well as our development testbed, not an isolated one-off.  The workaround indicated earlier did fix it.  I&#39;ll reiterate that we&#39;re using the Perl and OpenSSL components from Debian stable &#40;not anything unusual or self-built&#41;, 

Thanks for taking the time to correspond with me concerning this.  If anything at all about the detail I provided earlier &#40;trace, error message, workaround&#41; provides any hints as to what the problem might be, or if they suggest any further detail as to where I could continue to look into this, please do let me know.

-- 
Ivan Kohler
President and Head Geek, Freeside Internet Services, Inc. <span class="clickylink"><a target="new" rel="nofollow" href="http://freeside.biz/">http://freeside.biz/</a></span>
Debian GNU/Linux developer | CPAN author | cat person | ski addict
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;12&nbsp;01:05:00&nbsp;2016</span>
    <span class="description">mikem [...] airspayce.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #116346] Under mod_perl, first client connection fails in CTX_new, but subsequent connections work</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 12 Sep 2016 07:04:29 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] airspayce.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Ivan

Thanks

I&#39;m travelling at the moment and won&#39;t be able to look at this again until mid October 

Cheers

Sent from my iPhone

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 12 Sep 2016, at 3:14 AM, Ivan Kohler via RT &lt;bug-Net-SSLeay@rt.cpan.org&gt; wrote:
&gt; 
&gt;       Queue: Net-SSLeay
&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=116346">https://rt.cpan.org/Ticket/Display.html?id=116346</a></span> &gt;
&gt; 
<div class="message-stanza open">&gt;&gt; On Fri Jul 22 20:09:00 2016, mikem@airspayce.com wrote:
&gt;&gt; Hi Ivan,
&gt;&gt; 
&gt;&gt; interesting suggestion, but I have now tried that and still its
&gt;&gt; working fine
&gt;&gt; from the first attempt.
</div>&gt; 
&gt; I haven&#39;t yet been able to narrow down the issue to a more specific test case that I can give you to reproduce.  I&#39;ll keep working on that as time permits and see what I can do.
&gt; 
&gt; I did want to let you know that this is an issue we saw with our Perl application &#34;in the wild&#34; on multiple customer production machines as well as our development testbed, not an isolated one-off.  The workaround indicated earlier did fix it.  I&#39;ll reiterate that we&#39;re using the Perl and OpenSSL components from Debian stable &#40;not anything unusual or self-built&#41;, 
&gt; 
&gt; Thanks for taking the time to correspond with me concerning this.  If anything at all about the detail I provided earlier &#40;trace, error message, workaround&#41; provides any hints as to what the problem might be, or if they suggest any further detail as to where I could continue to look into this, please do let me know.
&gt; 
&gt; -- 
&gt; Ivan Kohler
&gt; President and Head Geek, Freeside Internet Services, Inc. <span class="clickylink"><a target="new" rel="nofollow" href="http://freeside.biz/">http://freeside.biz/</a></span>
&gt; Debian GNU/Linux developer | CPAN author | cat person | ski addict
&gt; 
</div></div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
