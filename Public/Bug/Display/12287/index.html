<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #12287 for Net-Server-POP3proxy: nice to have more control of looper</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #12287 for Net-Server-POP3proxy: nice to have more control of looper</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-Server-POP3proxy/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-Server-POP3proxy/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-Server-POP3proxy/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-Server-POP3proxy/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-Server-POP3proxy">Net-Server-POP3proxy CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">12287</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-Server-POP3proxy/Active/">Net-Server-POP3proxy</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
barborak [...] basikgroup.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-23156-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.1    </td>
  </tr>
  <tr id="CF-23157-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;14&nbsp;11:13:52&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> nice to have more control of looper</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is a very nice module. To allow more customization, it would be nice if the looper method allowed you to set the select timeout and if it returned a status indicating if there was any activity during the last loop or not. For example,

sub looper {
    my $self = shift;
    my $timeout = shift;

...

    my &#40;$toread, $towrite&#41; = IO::Select-&gt;select&#40;$self-&gt;{read_sockets}, $self-&gt;{write_sockets},undef, $timeout&#41;;    
    
    my $activity = $#$toread + $#$towrite &gt; -2 ? 1 : undef;

...

    return $activity;
}

The reason for doing this can be see in the attached script that uses this module as the basis for a SpamAssassin proxy. This script is based on the pop3proxy.pl script and includes its exit port technique. It also supports an HTTP interface at localhost:8800 to the Bayesian learning system. By having better control of the looper method, I can support these extra features better. The activity return allows me to play a sound on receiving some ham.

Thanks again for a great module,
Mike

P.S. To setup the attached script, follow the pop3proxy.pl instructions except there is no hostmap needed.
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use Getopt::Long;
use Mail::SpamAssassin;
use Win32::Sound;
use Net::Server::POP3proxy;
use IO::Socket;
use IO::Select;
use FindBin;


my $logfile = &#39;pop3proxy.log&#39;;
my $run_learning_interface = 1;
my $exit_port = 9625;
my $maxscan = 250000;
my $helpflag = 0;

usage&#40;&#41; unless GetOptions&#40;
		&#34;logfile:s&#34; =&gt; \$logfile,
		&#34;maxscan=i&#34; =&gt; \$max_scan_size,
		&#34;exitport=i&#34; =&gt; \$exit_port,
		&#34;help&#34; =&gt; \$helpflag,
		&#34;learn&#34; =&gt; \$run_learning_interface,
	&#41;;

usage&#40;&#41; if $helpflag;

chdir &#34;$FindBin::RealBin&#34;;

# Prevent concurrent proxies - kill any previous instance
#

if &#40; IO::Socket::INET-&gt;new &#40; 
	PeerAddr =&gt; &#39;localhost&#39;,
	PeerPort =&gt; $exit_port,
	Proto    =&gt; &#34;tcp&#34;,
	Type     =&gt; SOCK_STREAM &#41; &#41;
{
	sleep &#40; 10 &#41;;
	warn &#34;WARNING: Existing proxy killed\n&#34;;
}

if &#40; $logfile &#41;
{
  # Redirect stdout and stderr to logfile if specified.

  # Windows strangeness - you can&#39;t reopen STDOUT/STDERR successfully
  # under wperl.exe unless you&#39;ve already closed it.  Go figure.
  close STDOUT;
  close STDERR;

  open&#40;STDOUT, &#34;&gt; $logfile&#34;&#41; or die &#34;Can&#39;t redirect stdout: $!&#34;;
  open&#40;STDERR, &#34;&gt;&#38;STDOUT&#34;&#41;   or die &#34;Can&#39;t dup stdout: $!&#34;;
}

$| = 1;

my $spamtest = Mail::SpamAssassin-&gt;new &#40;
	{
	  userprefs_filename =&gt; &#39;./user_prefs&#39;,
	  dont_copy_prefs =&gt; 1
	} &#41;;
$spamtest-&gt;init_learner &#40; &#41;;

my $readable = IO::Select-&gt;new;
my $writeable = IO::Select-&gt;new;

# Create the &#34;exit socket&#34; - any connection on this socket from
# localhost will cause us to exit.
#

my $exit_socket;
if &#40; $exit_port &#41;
{
  $exit_socket = IO::Socket::INET-&gt;new&#40;LocalPort =&gt; $exit_port, Listen =&gt; 1, Reuse =&gt; 1&#41;;
  $readable-&gt;add &#40; $exit_socket &#41;;
}

my @hamQueue;
my $learning_port = 8800;
my $learning_socket;
my %URLESCAPE_MAP;
if &#40; $run_learning_interface &#41;
{
  require HTTP::Daemon;
  require HTTP::Status;
  require HTTP::Response;
  require URI::Escape;
  
  $HTTP::Status::RC_FORBIDDEN = $HTTP::Status::RC_FORBIDDEN;
  $HTTP::Status::RC_OK = $HTTP::Status::RC_OK;

  $learning_socket = HTTP::Daemon-&gt;new &#40; LocalPort =&gt; $learning_port &#41; || die &#34;cannot start the learning interface: $!&#34;;
  $readable-&gt;add &#40; $learning_socket &#41;;
}

my $popproxy = new Net::Server::POP3proxy &#40;
#	Port   =&gt; $port,
	Debug  =&gt; sub { print &#40;$_[0]&#41; . &#34;\n&#34;; }, 
	Action =&gt; sub { filterAction &#40; $_[0] &#41;; },
	Error  =&gt; sub { die &#40; $_[0] &#41;; },
	MaxSize =&gt; $maxscan
&#41; or die &#40; &#34;Cannot init POP3 proxy server&#34; &#41;;
	
my $ding = undef;
my $dingGrace = 5;

while &#40; 1 &#41;
{
	my $activity = $popproxy-&gt;looper &#40; 1 &#41;;
	
	if &#40; $activity &lt; 0 &#41;
	{
		last;
	}

	if &#40; $ding &#41;
	{
		if &#40; ! $activity &#41;
		{
			$dingGrace--;
		}
		else
		{
			$dingGrace = 5;
		}
		
		if &#40; ! $dingGrace &#41;
		{
			Win32::Sound::Play &#40; &#34;/winnt/media/notify.wav&#34; &#41;;
			$ding = undef;
		}
	}

	my &#40; $toread &#41; = IO::Select-&gt;select &#40; $readable, undef, undef, 0 &#41;; 
	
	foreach my $socket &#40; @$toread &#41; 
	{
		if &#40; $socket == $exit_socket &#41; 
		{
			all_done &#40; $socket &#41;;
			next;
		}
		
		if &#40; $socket-&gt;sockport == $learning_port &#41;
		{
			handleLearningRequest &#40; $socket &#41;;
			next;
		}
		
        unless &#40;$socket &#38;&#38; $socket-&gt;connected&#40;&#41;&#41; {
            undef $socket;
        }
	}
	
    # cleanup
    undef $toread;
}
	
my @mail;

sub filterAction
{
  my $mailMsg = shift;
  
  my $bytecount = length $mailMsg;

  $mailMsg =~ s/\012\.\./\012\./g; # un-byte-stuff

  @mail = split /^/, $mailMsg;

  my $response = shift @mail;

  # SpamAssassin::NoMailAudit adds a Unix mbox From_ line, unless
  # you construct your NoMailAudit message with the &#40;ahem,
  # undocumented&#41; add_From_line param set to false.  That From_
  # kinda breaks the protocol - the client isn&#39;t expecting mbox,
  # he&#39;s expecting raw 822 mail - so we leave it out.
  my $message = Mail::SpamAssassin::Message-&gt;new&#40;{message =&gt; \@mail}&#41;;
  my $status = $spamtest-&gt;check&#40;$message&#41;;

  my $id = $message-&gt;get_pristine_header&#40;&#39;Message-id&#39;&#41; || &#39;*none*&#39;;
  print &#34;$bytecount bytes, &#34;, $status-&gt;is_spam&#40;&#41; ? &#39;SPAM&#39; : &#39;NOT spam&#39;, &#34;, Message-id: $id\n&#34;;
  
  if &#40; ! $status-&gt;is_spam&#40;&#41; &#41;
  {
    $ding = 1; # Notify ham reception.
    
    if &#40; $id ne &#39;*none*&#39; &#41;
    {
      if &#40; $#hamQueue + 1 &gt;= 50 &#41;
      {
        my $oldMessage = shift @hamQueue;
        $oldMessage-&gt;finish &#40; &#41;;
      }
      
      # Save the ham for learning.
      push @hamQueue, $message;
    }
  }
  else
  {
    # learn it as spam
    $spamtest-&gt;learn &#40; $message, undef, 1, undef &#41;;
  }

  print $status-&gt;get_report&#40;&#41;;
  my $rewritten = $status-&gt;rewrite_mail&#40;&#41;;

  $mailMsg = $response;
  $mailMsg .= $rewritten;
  $mailMsg =~ s|&#40;?&lt;!\015&#41;\012|\015\012|g;
    
  $status-&gt;finish&#40;&#41;;
  $mailMsg =~ s/\012\./\012\.\./g; # byte-stuff
  
  return $mailMsg;
}


sub handleLearningRequest
{
	my $socket = shift;
	
      if &#40; $socket == $learning_socket &#41; 
      {
        my $client = $learning_socket-&gt;accept;
        if &#40; ! $client &#41;
        {
          $learning_socket-&gt;close;
          $readable-&gt;remove&#40;$learning_socket&#41;;
          $learning_socket = HTTP::Daemon-&gt;new &#40; LocalPort =&gt; $learning_port &#41; || die &#34;cannot restart the learning interface: $!&#34;;
          $readable-&gt;add&#40;$learning_socket&#41;;
        }
        else
        {
          $readable-&gt;add &#40; $client &#41;;
        }
      }
      else
      {
        if &#40; my $request = $socket-&gt;get_request &#41; 
        {
          if &#40; $request-&gt;method eq &#39;GET&#39; and $request-&gt;url-&gt;path =~ &#34;/learn_ham&#40;/&#40;ham|spam&#41;&#41;{0,1}&#34; &#41; 
          {
            my $command = $2;
            
            my $response = HTTP::Response-&gt;new &#40; $HTTP::Status::RC_OK &#41;;
            $response-&gt;header &#40; &#39;Content-type&#39; =&gt; &#39;text/html&#39; &#41;;
            
            my $content = &#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Ham Learner&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&#34;;
            
            if &#40; $command eq &#34;ham&#34; || $command eq &#34;spam&#34; &#41;
            {
              my $id = $request-&gt;url-&gt;query;
              
              if &#40; $id =~ /id=&#40;.*&#41;$/ &#41;
              {
                $id = URI::Escape::uri_unescape &#40; $1 &#41;;
                
                foreach &#40; my $index = 0; $index &lt;= $#hamQueue; $index++ &#41;
                {
                  my $message = $hamQueue [ $index ];
                  my $msgId = $message-&gt;get_pristine_header &#40; &#39;Message-id&#39; &#41;;
                  
                  if &#40; $msgId eq $id &#41;
                  {
                    my $status = $spamtest-&gt;learn &#40; $message, undef, $command eq &#34;ham&#34; ? undef : 1, undef &#41;;
                    if &#40; $status-&gt;did_learn &#40; &#41; &#41;
                    {
                      $content .= &#34;Marking message \&#34;&#34; . $message-&gt;get_pristine_header&#40; &#39;Subject&#39; &#41; . &#34;\&#34; as $command.&lt;br /&gt;&lt;br /&gt;&#34;;
                    }
                    else
                    {
                      $content .= &#34;The message \&#34;&#34; . $message-&gt;get_pristine_header&#40; &#39;Subject&#39; &#41; . &#34;\&#34; was not learned.&lt;br /&gt;&lt;br /&gt;&#34;;
                    }
                    $status-&gt;finish &#40; &#41;;

                    $message-&gt;finish &#40; &#41;;
                    splice @hamQueue, $index, 1;
                  }
                }
              }
            }
            
            if &#40; $#hamQueue &lt; 0 &#41;
            {
              $content .= &#34;There is no more ham to rate.&#34;;
            }
            else
            {
              $content .= &#34;&lt;table cellpadding=\&#34;3\&#34;&gt;&#34;;
              $content .= &#34;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td bgcolor=\&#34;#CCCCCC\&#34;&gt;&lt;b&gt;From&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;b&gt;Subject&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&#34;;
              
              foreach my $message &#40; @hamQueue &#41;
              {
                my $id = $message-&gt;get_pristine_header &#40; &#39;Message-id&#39; &#41; || next;
                $id = URI::Escape::uri_escape &#40; $id &#41;;
              
                $content .= &#34;&lt;tr&gt;&lt;td bgcolor=\&#34;#00CC00\&#34;&gt;&lt;a href=\&#34;/learn_ham/ham?id=$id\&#34;&gt;HAM&lt;/a&gt;&lt;/td&gt;&lt;td bgcolor=\&#34;#CC0000\&#34;&gt;&lt;a href=\&#34;/learn_ham/spam?id=$id\&#34;&gt;SPAM&lt;/a&gt;&lt;/td&gt;&lt;td bgcolor=\&#34;#CCCCCC\&#34;&gt;&#34; . $message-&gt;get_pristine_header&#40; &#39;From&#39; &#41; . &#34;&lt;/td&gt;&lt;td&gt;&#34; . $message-&gt;get_pristine_header&#40; &#39;Subject&#39; &#41; . &#34;&lt;/td&gt;&lt;/tr&gt;&#34;;
              }
              
              $content .= &#34;&lt;/table&gt;&#34;;
            }
            
            $content .= &#34;&lt;/body&gt;&lt;/html&gt;&#34;;
            $response-&gt;content &#40; $content &#41;;
            $socket-&gt;send_response &#40; $response &#41;;
          }
          else 
          {
            $socket-&gt;send_error &#40; $HTTP::Status::RC_FORBIDDEN &#41;
          }
        }
        else
        {
		  $readable-&gt;remove&#40;$socket&#41;;
		  $socket-&gt;close;
        }
      }
}





sub usage 
{
	print &lt;&lt;EOT;
Usage: $0 [options]
Options include:
  --logfile filename
      Use filename as the log file.  Default is pop3proxy.log.  If the
      filename is omitted, log to STDOUT.
  --maxscan bytes
      Messages which exceed this size will not be scanned for spam.  The
      default is 250000.  Setting this to zero disables this behavior.
  --exitport port
      Any connection from localhost on this port will cause us to exit.
      The default is 9625.  Setting this to zero disables this behavior.
  --learn
      Run the spam learning interface.
EOT

	exit;
}

sub all_done {
  my $socket = shift;
  my $new_sock = $socket-&gt;accept;
  if &#40;$new_sock-&gt;peerhost eq &#39;127.0.0.1&#39;&#41; {
    print &#34;Connection on exit socket, exiting\n&#34;;
    exit;
  } else {
    print &#34;Connection on exit socket from non-local host!\n&#34;;
    $new_sock-&gt;close;
  }
  
  cleanup &#40; &#41;;
}

sub cleanup
{
	if &#40; $popproxy &#41;
	{
        $popproxy-&gt;cleanup &#40; &#41;;

        # run last buffers - with a grace of 50
        # communications for the rest buffer
        
        my $gracecounter = 50;
        while &#40;$popproxy-&gt;looper&#40;&#41; &#38;&#38; $gracecounter &#41; { $gracecounter--; }

        $popproxy-&gt;cleanup &#40; 1 &#41;;
	}
}

</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
