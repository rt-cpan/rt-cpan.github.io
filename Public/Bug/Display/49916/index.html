<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #49916 for Devel-Cover: Devel::Cover doesn&#39;t like code that changes EUID</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #49916 for Devel-Cover: Devel::Cover doesn&#39;t like code that changes EUID</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Devel-Cover/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Devel-Cover/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Devel-Cover/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Devel-Cover/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/pjcj/Devel--Cover/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Devel-Cover">Devel-Cover CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">49916</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Devel-Cover/Active/">Devel-Cover</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
PIOTO [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-11022-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.59</li>
<li>
0.64</li>
<li>
0.65</li>
</ul>
    </td>
  </tr>
  <tr id="CF-11023-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;22&nbsp;14:33:07&nbsp;2009</span>
    <span class="description">PIOTO [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Devel::Cover doesn&#39;t like code that changes EUID</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I was looking to do some coverage on code which does part of its work by
forking and changing its EUID. However, the restrictive permissions
which are placed on the cover_db directory and things under it seem to
cause problems.

t/run_as_user.....ok 1/11Can&#39;t mkdir /home/mike/foo/cover_db/runs:
Permission denied
 at t/run_as_user.t line 0

I&#39;m not sure if there&#39;s a straightforward solution to this or not.

If it would help helpful, I can try to create a reduced test case to
demonstrate this.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;11&nbsp;12:49:19&nbsp;2010</span>
    <span class="description">PJCJ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

Producing a test case would be helpful, but I wonder whether the easiest 
and possibly the best solution would be to specify the location of the 
directory somewhere where your program would have permissions to write to 
it?  Would that work for you?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;11&nbsp;12:49:20&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;12&nbsp;00:54:30&nbsp;2010</span>
    <span class="description">PIOTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Apr 11 12:49:19 2010, PJCJ wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hello,
&gt; 
&gt; Producing a test case would be helpful, but I wonder whether the easiest 
&gt; and possibly the best solution would be to specify the location of the 
&gt; directory somewhere where your program would have permissions to write to 
&gt; it?  Would that work for you?
</div>
Yeah, that would mostly cover it, except for the chmods that are in
there with the mkdirs. If I could just specify some other path, and have
it not try to mess with the permissions, that would work.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;12&nbsp;06:34:09&nbsp;2010</span>
    <span class="description">PJCJ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve removed the chmods which should hopefully fix your problem.  They 
were only in there to fix a problem with perl5.6.x which I don&#39;t seem to 
be able to reproduce any more anyway, so we&#39;ll see if any 5.6.x uses 
shout.

If set the status to resolved and this will be in the next release, but 
please reopen the ticket if there are still problems.

Thanks, 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;12&nbsp;06:34:10&nbsp;2010</span>
    <span class="description">PJCJ [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;12&nbsp;14:56:03&nbsp;2010</span>
    <span class="description">PIOTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Apr 12 06:34:09 2010, PJCJ wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve removed the chmods which should hopefully fix your problem.  They
&gt; were only in there to fix a problem with perl5.6.x which I don&#39;t seem
&gt; to be able to reproduce any more anyway, so we&#39;ll see if any 5.6.x
&gt; uses shout.
&gt; 
&gt; If set the status to resolved and this will be in the next release,
&gt; but please reopen the ticket if there are still problems.
</div>
If this commit is the purported fix:

 
<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/pjcj/Devel--Cover/commit/8b26a6ffee8be0c33f492d715feef5bf2ae09aba">http://github.com/pjcj/Devel--Cover/commit/8b26a6ffee8be0c33f492d715feef5bf2ae09aba</a></span>

I think you may have misunderstood me. The issue isn&#39;t the chmod&#40;&#41;
specifically, it&#39;s the fact that you&#39;re specifying such a restrictive
mask on the mkdir, too. This means that, when my child processes start
to do stuff as non-root, they won&#39;t be able to write to the coverage
directory. The mkdir pod suggests that you&#39;d be better off not
specifying the mask at all:

  In general, it is better to create directories with permissive MASK,
  and let the user modify that with their &#34;umask&#34;, than it is to supply
  a restrictive MASK and give the user no way to be more permissive.

I don&#39;t really think there&#39;s anything inherently private about the
coverage database, though I could be wrong. If not, then I think that
simply removing the mask as well should help address my issue.

Thanks.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;12&nbsp;14:56:05&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;01&nbsp;03:06:10&nbsp;2010</span>
    <span class="description">ifomichev [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have solved this issue with a monkey patch :&#41; But I double the request 
to make the umask in mkdir configurable from outside or at least remove 
it at all.

Here is my startup.pl with a monkey patch for mod_perl2

  #!/usr/bin/perl
  use strict;
  use warnings;

  use Apache2::Directive &#40;&#41;;

  BEGIN {
      # Devel::Cover database must be writable by worker processes
      my $conftree = Apache2::Directive::conftree-&gt;as_hash;
      my $name = $conftree-&gt;{User}
          or die &#34;couldn&#39;t find user in Apache config&#34;;
      print &#34;user=$name\n&#34;;

      my $uid = getpwnam&#40;$name&#41;;
      defined $uid
          or die &#34;couldn&#39;t determine uid by name&#34;;

      no warnings &#39;redefine&#39;;
      local $&gt; = $uid;

      require Devel::Cover;

      my $old_report = \&#38;Devel::Cover::report;
      *Devel::Cover::report =
          sub { local $&gt; = $uid; $old_report-&gt;&#40;@_&#41; };

      Devel::Cover-&gt;import;
  }

  1;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;22&nbsp;12:12:14&nbsp;2011</span>
    <span class="description">john [...] nixnuts.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The patch that we&#39;re using to address this bug is attached.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Add-loose_perms-option-to-Devel-Cover.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From aaeeafb5f7c8d72f275fcb8f7747e0b6a102f315 Mon Sep 17 00:00:00 2001
From: John Lightsey &lt;jd@cpanel.net&gt;
Date: Thu, 22 Sep 2011 10:27:01 -0500
Subject: [PATCH] Add -loose_perms option to Devel::Cover.

RT 49916: Test code that changes EUID before exiting cannot write to the cover
db directory by default due to restrictive file/directory permissions. This is
corrected with an option to give all cover DB directories 777 permisisons.
---
 lib/Devel/Cover.pm                |   14 +++++++++++++-
 lib/Devel/Cover/DB.pm             |    3 +++
 lib/Devel/Cover/DB/IO/JSON.pm     |    1 +
 lib/Devel/Cover/DB/IO/Storable.pm |    1 +
 lib/Devel/Cover/DB/Structure.pm   |    3 +++
 5 files changed, 21 insertions&#40;+&#41;, 1 deletions&#40;-&#41;

diff --git a/lib/Devel/Cover.pm b/lib/Devel/Cover.pm
index ab56f18..6a94a49 100755
--- a/lib/Devel/Cover.pm
+++ b/lib/Devel/Cover.pm
@@ -54,6 +54,7 @@ my $Summary        = 1;                  # Output coverage summary.
 my $Subs_only      = 0;                  # Coverage only for sub bodies.
 my $Self_cover;                          # Coverage of Devel::Cover.
 my $Self_cover_run = 0;                  # Covering Devel::Cover now.
+my $Loose_perms    = 0;                  # Use loose permissions in the cover DB
 
 my @Ignore;                              # Packages to ignore.
 my @Inc;                                 # Original @INC to ignore.
@@ -284,6 +285,7 @@ sub import
         /^-silent/      &#38;&#38; do { $Silent      = shift @o; next };
         /^-dir/         &#38;&#38; do { $Dir         = shift @o; next };
         /^-db/          &#38;&#38; do { $DB          = shift @o; next };
+        /^-loose_perms/ &#38;&#38; do { $Loose_perms = shift @o; next };
         /^-merge/       &#38;&#38; do { $Merge       = shift @o; next };
         /^-summary/     &#38;&#38; do { $Summary     = shift @o; next };
         /^-blib/        &#38;&#38; do { $blib        = shift @o; next };
@@ -331,6 +333,9 @@ sub import
     {
         mkdir $DB, 0700 or die &#34;Can&#39;t mkdir $DB: $!&#34;;
     }
+    if &#40;$Loose_perms&#41; {
+        chmod 0777, $DB;
+    }
     $DB = $1 if abs_path&#40;$DB&#41; =~ /&#40;.*&#41;/;
     Devel::Cover::DB-&gt;delete&#40;$DB&#41; unless $Merge;
 
@@ -665,7 +670,7 @@ sub _report
     chdir $Dir or die __PACKAGE__ . &#34;: Can&#39;t chdir $Dir: $!\n&#34;;
 
     $Run{collected} = \@collected;
-    $Structure      = Devel::Cover::DB::Structure-&gt;new&#40;base =&gt; $DB&#41;;
+    $Structure      = Devel::Cover::DB::Structure-&gt;new&#40;base =&gt; $DB, loose_perms =&gt; $Loose_perms&#41;;
     $Structure-&gt;read_all;
     $Structure-&gt;add_criteria&#40;@collected&#41;;
     # print STDERR &#34;Start structure: &#34;, Dumper $Structure;
@@ -725,6 +730,7 @@ sub _report
         base      =&gt; $DB,
         runs      =&gt; { $run =&gt; \%Run },
         structure =&gt; $Structure,
+        loose_perms =&gt; $Loose_perms,
     &#41;;
 
     my $dbrun = &#34;$DB/runs&#34;;
@@ -732,6 +738,9 @@ sub _report
     {
         mkdir $dbrun, 0700 or croak &#34;Can&#39;t mkdir $dbrun: $!\n&#34;;
     }
+    if &#40;$Loose_perms&#41; {
+        chmod 0777, $dbrun;
+    }
     $dbrun .= &#34;/$run&#34;;
 
     print OUT __PACKAGE__, &#34;: Writing coverage database to $dbrun\n&#34;
@@ -1378,6 +1387,9 @@ if the tests fail and you would like nice output telling you why.
  +ignore RE          - Append to REs of files to ignore.
  -inc path           - Set prefixes of files to ignore &#40;default @INC&#41;.
  +inc path           - Append to prefixes of files to ignore.
+ -loose_perms val    - Use loose permissions on all files and directories in
+                       the coverage db so that code changing EUID can still
+                       write coverage information &#40;default off&#41;.
  -merge val          - Merge databases, for multiple test benches &#40;default on&#41;.
  -select RE          - Set REs of files to select &#40;default none&#41;.
  +select RE          - Append to REs of files to select.
diff --git a/lib/Devel/Cover/DB.pm b/lib/Devel/Cover/DB.pm
index 3fed6ac..8a5f397 100644
--- a/lib/Devel/Cover/DB.pm
+++ b/lib/Devel/Cover/DB.pm
@@ -83,6 +83,9 @@ sub write
     {
         mkdir $self-&gt;{db}, 0700 or croak &#34;Can&#39;t mkdir $self-&gt;{db}: $!\n&#34;;
     }
+    if &#40;$self-&gt;{loose_perms}&#41; {
+        chmod 0777, $self-&gt;{db};
+    }
     $self-&gt;validate_db;
 
     my $db = { runs =&gt; $self-&gt;{runs} };
diff --git a/lib/Devel/Cover/DB/IO/JSON.pm b/lib/Devel/Cover/DB/IO/JSON.pm
index f1d305d..a6a26e1 100644
--- a/lib/Devel/Cover/DB/IO/JSON.pm
+++ b/lib/Devel/Cover/DB/IO/JSON.pm
@@ -42,6 +42,7 @@ sub write
 
     my $json = JSON::PP-&gt;new-&gt;utf8;
     $json-&gt;ascii-&gt;pretty-&gt;canonical if $self-&gt;{options} =~ /\bpretty\b/i;
+    unlink $file;
     open my $fh, &#34;&gt;&#34;, $file or die &#34;Can&#39;t open $file: $!&#34;;
     flock&#40;$fh, LOCK_EX&#41; or die &#34;Cannot lock file: $!\n&#34;;
     print $fh $json-&gt;encode&#40;$data&#41;;
diff --git a/lib/Devel/Cover/DB/IO/Storable.pm b/lib/Devel/Cover/DB/IO/Storable.pm
index 0608b7e..a24b97e 100644
--- a/lib/Devel/Cover/DB/IO/Storable.pm
+++ b/lib/Devel/Cover/DB/IO/Storable.pm
@@ -34,6 +34,7 @@ sub write
     my $self = shift;
     my &#40;$data, $file&#41; = @_;
 
+    unlink $file;
     Storable::lock_nstore&#40;$data, $file&#41;;
     $self
 }
diff --git a/lib/Devel/Cover/DB/Structure.pm b/lib/Devel/Cover/DB/Structure.pm
index d7dc13c..b128285 100644
--- a/lib/Devel/Cover/DB/Structure.pm
+++ b/lib/Devel/Cover/DB/Structure.pm
@@ -274,6 +274,9 @@ sub write
     {
         mkdir $dir, 0700 or croak &#34;Can&#39;t mkdir $dir: $!\n&#34;;
     }
+    if &#40;$self-&gt;{loose_perms}&#41; {
+        chmod 0777, $dir;
+    }
     for my $file &#40;sort keys %{$self-&gt;{f}}&#41;
     {
         $self-&gt;{f}{$file}{file} = $file;
-- 
1.7.5

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;01&nbsp;18:28:28&nbsp;2012</span>
    <span class="description">TODDR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This patch works well for my needs too.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;02&nbsp;11:49:56&nbsp;2012</span>
    <span class="description">PJCJ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Is this still a problem?  A couple of months ago I made the change in 
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/pjcj/Devel--Cover/commit/97a6340">https://github.com/pjcj/Devel--Cover/commit/97a6340</a></span> which removed the 
explicit 0700 directory permissions.  Does anything else need to be done?

John&#39;s patch contains a couple of unlinks.  I imagine they&#39;re not 
necessary anymore.  Or are they?

If anyone has a test case for this, or at least a set of instructions to 
reproduce it, I&#39;d be grateful.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;13&nbsp;06:36:15&nbsp;2013</span>
    <span class="description">PJCJ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">In the absence of any further information I&#39;m going to assume that this is now fixed and close the ticket.

If there is still a problem, please feel free to reopen the ticket.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;13&nbsp;06:36:15&nbsp;2013</span>
    <span class="description">PJCJ [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
