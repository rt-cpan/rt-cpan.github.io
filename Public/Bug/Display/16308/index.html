<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #16308 for Coro: Coro doesn&#39;t compile on 5.6.1</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #16308 for Coro: Coro doesn&#39;t compile on 5.6.1</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Coro/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Coro/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Coro/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Coro/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Coro">Coro CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">16308</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Coro/Active/">Coro</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
SAMV [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-8142-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.5    </td>
  </tr>
  <tr id="CF-8143-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;05&nbsp;18:36:53&nbsp;2005</span>
    <span class="description">SAMV [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Coro doesn&#39;t compile on 5.6.1</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Coro doesn&#39;t build against older Perls.

Attached is a patch to get it to work for Perl 5.6.1 and later; ppport.h supports earlier versions, but I don&#39;t think it&#39;s worth backporting to versions you don&#39;t intend testing on.

As 5.6.1 is now the earliest version supported, there is no reason not to just &#34;use warnings&#34; directly, rather than use the BEGIN { } block that tried to do that inside eval { }, presumably for backwards compatibility.

Note the ppport.h file is delivered by &#34;h2xs&#34;.
</div></div>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;05&nbsp;18:51:26&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rt.cpan.org [...] plan9.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[SAMV - Mon Dec  5 18:36:53 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Attached is a patch to get it to work for Perl 5.6.1 and later;
&gt;    ppport.h supports earlier versions, but I don&#39;t think it&#39;s worth
&gt;    backporting to versions you don&#39;t intend testing on.
</div>
I don&#39;t intend to actively support 5.6 either. It&#39;s too buggy to be
useful to me under any circumstances, so it would add considerable
maintainance burden. If you wanted to keep an eye on it, though, and the
changes aren&#39;t too invasive, I wouldn&#39;t mind applying patches to the effect.

Some question about the patch, though:

+use warnings;
+no warnings &#34;uninitialized&#34;;

I do not intend to enable warnings by default.

+# this is slightly PL_dirty &#40;should expose a c-level api&#41;

This seems to be the result of a straight search and replace on the
code. It seesm these and similar changes are, too:

-  COP *curcop;
+  COP *PL_curcop;

Or are they really necessary? They uglify the code quite a bit, and I am
sure it&#39;ll break on some platforms.

-#if PATCHLEVEL &lt; 6
+#if PERL_VERSION &lt; 6

applied in any case.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; As 5.6.1 is now the earliest version supported, there is no reason not
&gt;    to just &#34;use warnings&#34; directly, rather than use the BEGIN { }
</div>
I already started doing that in 1.5 &#40;which was the reason for the
&#34;compatibility cruft&#34; changelog line&#41;. No need to change working code,
though.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;05&nbsp;19:25:20&nbsp;2005</span>
    <span class="description">SAMV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> SAMV [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Attached is a patch to get it to work for Perl 5.6.1 and later;
&gt; &gt;    ppport.h supports earlier versions, but I don&#39;t think it&#39;s worth
&gt; &gt;    backporting to versions you don&#39;t intend testing on.
</div>&gt; I don&#39;t intend to actively support 5.6 either. It&#39;s too buggy to be
&gt; useful to me under any circumstances, so it would add considerable
&gt; maintainance burden. If you wanted to keep an eye on it, though, and 
&gt; the changes aren&#39;t too invasive, I wouldn&#39;t mind applying patches to
&gt; the effect.
</div>
Yes, what I&#39;ll do is share my 5.6.1 compat patches while I am using it
on that Perl, which probably won&#39;t be for more than a year.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Some question about the patch, though:
&gt; 
&gt; +use warnings;
&gt; +no warnings &#34;uninitialized&#34;;
&gt; 
&gt; I do not intend to enable warnings by default.
</div>
OK, this means I misread the intent of what you were doing.  It was just
to avoid a &#34;use of bareword &#39;warnings&#39; may conflict with future reserved
word...&#34; warning.  Turning on &#34;use strict&#34; should sort that out - the
bareword will be considered illegal.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; +# this is slightly PL_dirty &#40;should expose a c-level api&#41;
&gt; This seems to be the result of a straight search and replace on the
&gt; code. It seesm these and similar changes are, too:
&gt; -  COP *curcop;
&gt; +  COP *PL_curcop;
&gt; Or are they really necessary? They uglify the code quite a bit, and I
&gt; am sure it&#39;ll break on some platforms.
</div>
I ran the ppport.h against the distribution, and applied the patch it
recommended.  Perhaps some of the substitutions it suggested were based
on sloppy regexes and are not necessary.

Here are the exact steps I used to create the patch &#40;other than manual
editing for the &#34;use warnings&#34; bit&#41;:

  h2xs -n Foo -A -b5.6.1
  cp Foo/ppport.h Coro-1.5/
  cd Coro-1.5
  perl ppport.h --patch=backport --compat-version=5.6.1
  patch -p0 &lt; backport
  find Coro Event -type f | xargs grep -l ppport \
       | perl -npi~ -e &#39;s{ppport.h}{../ppport.h}&#39;

I guess I could go through the patch and find the minimal set of changes
that are actually required for it to compile on 5.6.  Do you want me to
do this?

As far as portability goes, AIUI the ppport.h script suggests code
changes that makes the module use functions that are considered &#34;best
practice&#34;, then uses macros to make the older perls support this newer
best practice.  So, they should enhance portability between platforms,
not reduce it.

Just one more piece I missed before; for some reason the test suite
spits out an error during global destruction in t/09_timer.t:

&#40;in cleanup&#41; Can&#39;t call method &#34;cancel&#34; on an undefined value at
blib/lib/Coro/Timer.pm line 79.

Without digging into the possible causes of this, given all that method
is doing is breaking circular refs, it&#39;s probably worth just adding a
guard to it:

--- Coro-1.5.orig/Coro/Timer.pm Tue Nov 29 12:35:50 2005
+++ Coro-1.5.backport/Coro/Timer.pm     Tue Dec  6 00:08:50 2005
@@ -75,7 +76,7 @@
 }
 
 sub DESTROY { 
-   ${${$_[0]}}-&gt;cancel;
+   ${${$_[0]}}-&gt;cancel if ${${$_[0]}};
    undef ${${$_[0]}}; # without this it leaks like hell. breaks the
circular reference inside the closure
 }
 
ps. you can log into rt.cpan.org with your PAUSE ID and password rather
than use guest.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;29&nbsp;09:09:03&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  sub DESTROY {
&gt; -   ${${$_[0]}}-&gt;cancel;
&gt; +   ${${$_[0]}}-&gt;cancel if ${${$_[0]}};
&gt;     undef ${${$_[0]}}; # without this it leaks like hell. breaks the
&gt; circular reference inside the closure
&gt;  }
</div>
Thanks, I applied this defensively &#40;while still objecting the stupid
broken gc run&#41;, it will be in coro &gt; 1.7

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ps. you can log into rt.cpan.org with your PAUSE ID and password
&gt;    rather
&gt; than use guest.
</div>
If rt.cpan.org wouldn&#39;t be so slow and horribly ugly to use, I&#39;d
seriously consider this :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;05&nbsp;19:31:55&nbsp;2006</span>
    <span class="description">MLEHMANN [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
