<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #46264 for CGI-Session: failure to clean up in CGI::Session:Driver::DBI routines</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #46264 for CGI-Session: failure to clean up in CGI::Session:Driver::DBI routines</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/CGI-Session/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/CGI-Session/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/CGI-Session/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/CGI-Session/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/CGI-Session">CGI-Session CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">46264</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/CGI-Session/Active/">CGI-Session</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
eponymousalias [...] yahoo.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-5872-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-5873-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;21&nbsp;00:51:15&nbsp;2009</span>
    <span class="description">eponymousalias [...] yahoo.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> failure to clean up in CGI::Session:Driver::DBI routines</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 20 May 2009 21:50:49 -0700 &#40;PDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI-Session [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> eponymous alias &lt;eponymousalias [...] yahoo.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
The CGI-Session-4.00_08/Session/Driver/DBI.pm routines do not
properly close out their statement handles before returning.
This results in resources needlessly held for the duration of
the session, and in error messages when the database handle
is ultimately closed.  For instance, the code needs the
following change:

    --- DBI.pm.orig Fri Feb 11 00:18:27 2005
    +++ DBI.pm      Wed May 20 21:35:27 2009
    @@ -57,6 +57,7 @@
         $sth-&gt;execute&#40; $sid &#41; or return $self-&gt;set_error&#40; &#34;retrieve&#40;&#41;: \$sth-&gt;execute failed with error message &#34; . $dbh-&gt;errstr&#41;;
     
         my &#40;$row&#41; = $sth-&gt;fetchrow_array&#40;&#41;;
    +    $sth-&gt;finish;
         return 0 unless $row;
         return $row;
     }

As an example of what the present construction causes, we see
the following message continually in the Apache error logs:

    DBI::db=HASH&#40;0x2439990&#41;-&gt;disconnect invalidates 1 active
        statement handle &#40;either destroy statement handles or
        call finish on them before disconnecting&#41;

due to the particular missing cleanup noted above.

That kind of fix &#40;adding $sth-&gt;finish; calls&#41; applies not just
to the retrieve routine, but also to most other routines in
the DBI.pm file.  Every time a local statement handle is
created in such a routine, it should be destroyed with a
$sth-&gt;finish; call before the routine is exited, no matter
what code path is followed.



      
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;21&nbsp;03:43:19&nbsp;2009</span>
    <span class="description">eponymousalias [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #46264] AutoReply: failure to clean up in CGI::Session:Driver::DBI routines</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 21 May 2009 00:42:59 -0700 &#40;PDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI-Session [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> eponymous alias &lt;eponymousalias [...] yahoo.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Just after I posted this bug report, I found
the latest release of CGI::Session, and I see
it is fixed in that release.  Sorry for the
noise.

--- On Wed, 5/20/09, Bugs in CGI-Session via RT &lt;bug-CGI-Session@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; From: Bugs in CGI-Session via RT &lt;bug-CGI-Session@rt.cpan.org&gt;
&gt; Subject: [rt.cpan.org #46264] AutoReply: failure to clean up in CGI::Session:Driver::DBI routines
&gt; To: eponymousalias@yahoo.com
&gt; Date: Wednesday, May 20, 2009, 9:51 PM
&gt; 
&gt; Greetings,
&gt; 
&gt; This message has been automatically generated in response
&gt; to the
&gt; creation of a trouble ticket regarding:
&gt;     &#34;failure to clean up in
&gt; CGI::Session:Driver::DBI routines&#34;, 
&gt; a summary of which appears below.
&gt; 
&gt; There is no need to reply to this message right now. 
&gt; Your ticket has been
&gt; assigned an ID of [rt.cpan.org #46264].  Your ticket
&gt; is accessible
&gt; on the web at:
&gt; 
&gt;     <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=46264">http://rt.cpan.org/Ticket/Display.html?id=46264</a></span>
&gt; 
&gt; Please include the string:
&gt; 
&gt;          [rt.cpan.org
&gt; #46264]
&gt; 
&gt; in the subject line of all future correspondence about this
&gt; issue. To do so, 
&gt; you may reply to this message.
&gt; 
&gt;                
&gt;         Thank you,
&gt;                
&gt;         bug-CGI-Session@rt.cpan.org
&gt; 
&gt; -------------------------------------------------------------------------
&gt; 
&gt; The CGI-Session-4.00_08/Session/Driver/DBI.pm routines do
&gt; not
&gt; properly close out their statement handles before
&gt; returning.
&gt; This results in resources needlessly held for the duration
&gt; of
&gt; the session, and in error messages when the database
&gt; handle
&gt; is ultimately closed.  For instance, the code needs
&gt; the
&gt; following change:
&gt; 
&gt;     --- DBI.pm.orig Fri Feb 11 00:18:27 2005
&gt;     +++ DBI.pm      Wed May 20
&gt; 21:35:27 2009
&gt;     @@ -57,6 +57,7 @@
&gt;          $sth-&gt;execute&#40;
&gt; $sid &#41; or return $self-&gt;set_error&#40; &#34;retrieve&#40;&#41;:
&gt; \$sth-&gt;execute failed with error message &#34; .
&gt; $dbh-&gt;errstr&#41;;
&gt;      
&gt;          my &#40;$row&#41; =
&gt; $sth-&gt;fetchrow_array&#40;&#41;;
&gt;     +    $sth-&gt;finish;
&gt;          return 0 unless
&gt; $row;
&gt;          return $row;
&gt;      }
&gt; 
&gt; As an example of what the present construction causes, we
&gt; see
&gt; the following message continually in the Apache error
&gt; logs:
&gt; 
&gt;     DBI::db=HASH&#40;0x2439990&#41;-&gt;disconnect
&gt; invalidates 1 active
&gt;         statement handle &#40;either
&gt; destroy statement handles or
&gt;         call finish on them before
&gt; disconnecting&#41;
&gt; 
&gt; due to the particular missing cleanup noted above.
&gt; 
&gt; That kind of fix &#40;adding $sth-&gt;finish; calls&#41; applies
&gt; not just
&gt; to the retrieve routine, but also to most other routines
&gt; in
&gt; the DBI.pm file.  Every time a local statement handle
&gt; is
&gt; created in such a routine, it should be destroyed with a
&gt; $sth-&gt;finish; call before the routine is exited, no
&gt; matter
&gt; what code path is followed.
&gt; 
&gt; 
&gt; 
&gt;       
&gt; 
&gt; 
</div>

      
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;30&nbsp;23:25:14&nbsp;2009</span>
    <span class="description">RSAVAGE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m setting this to Resolved because the submitter has noticed that code
had been fixed already.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;30&nbsp;23:25:16&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;30&nbsp;23:25:20&nbsp;2009</span>
    <span class="description">RSAVAGE [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
