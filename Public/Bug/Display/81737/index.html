<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #81737 for Spreadsheet-ParseExcel: $cell-&gt;unformatted&#40;&#41; does not handle UTF-8 correctly</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #81737 for Spreadsheet-ParseExcel: $cell-&gt;unformatted&#40;&#41; does not handle UTF-8 correctly</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Spreadsheet-ParseExcel/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Spreadsheet-ParseExcel/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Spreadsheet-ParseExcel/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Spreadsheet-ParseExcel/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="http://github.com/runrig/spreadsheet-parseexcel/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Spreadsheet-ParseExcel">Spreadsheet-ParseExcel CPAN distribution</a>.</p>


<h3>Maintainer&#40;s&#41;&#39; notes</h3>

<p><b>If you are reporting a bug in Spreadsheet::ParseExcel here are some pointers</b>
<p>
1) State the issues as clearly and as concisely as possible. A simple program or Excel test file (see below) will often explain the issue better than a lot of text.
<p>
2) Provide information on your system, version of perl and module versions. The following program will generate everything that is required. Put this information in your bug report.
<pre>
    #!/usr/bin/perl -w

    print "\n    Perl version   : $]";
    print "\n    OS name        : $^O";
    print "\n    Module versions: (not all are required)\n";

    my @modules = qw(
                      Spreadsheet::ParseExcel
                      Scalar::Util
                      Unicode::Map
                      Spreadsheet::WriteExcel
                      Parse::RecDescent
                      File::Temp
                      OLE::Storage_Lite
                      IO::Stringy
                    );

    for my $module (@modules) {
        my $version;
        eval "require $module";

        if (not $@) {
            $version = $module-&gt;VERSION;
            $version = '(unknown)' if not defined $version;
        }
        else {
            $version = '(not installed)';
        }

        printf "%21s%-24s\t%s\n", "", $module, $version;
    }

    __END__
</pre>
<p>
3) Upgrade to the latest version of Spreadsheet::ParseExcel (or at least test on a system with an upgraded version). The issue you are reporting may already have been fixed.
<p>
4) Create a small example program that demonstrates your problem. The program should be as small as possible. A few lines of codes are worth tens of lines of text when trying to describe a bug.
<p>
5) <b>Supply an Excel file that demonstrates the problem</b>. This is very important. If the file is big, or contains confidential information, try to reduce it down to the smallest Excel file that represents the issue. If you don't wish to post a file here then send it to me directly: jmcnamara@cpan.org
<p>
6) Say if the test file was created by Excel, OpenOffice, Gnumeric or something else. Say which version of that application you used.
<p>
7) If you are submitting a patch you should check with the maintainer whether the issue has already been patched or if a fix is in the works. Patches should be accompanied by test cases.
<p>
<b>Asking a question</b>
<p>
If you would like to ask a more general question there is the <a href="http://groups.google.com/group/spreadsheet-parseexcel">Spreadsheet::ParseExcel Google Group</a>.
<p></p>



<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">81737</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Spreadsheet-ParseExcel/Active/">Spreadsheet-ParseExcel</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ovid [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-29454-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-29455-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




utf8.xls<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1151537/605586/utf8.xls">
Thu Dec 06 04:19:36 2012 (5.5k) by ovid [...] cpan.org
</a>
</font></li>
</ul>


xls.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1151537/605585/xls.pl">
Thu Dec 06 04:19:36 2012 (1k) by ovid [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;06&nbsp;04:19:36&nbsp;2012</span>
    <span class="description">ovid [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> $cell-&gt;unformatted&#40;&#41; does not handle UTF-8 correctly</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Problem:

$cell-&gt;value&#40;&#41; correctly handles UTF-8 data but $cell-&gt;unformatted&#40;&#41; 
does not.

Steps to reproduce:

1. Create a spreadsheet and in cell A1 enter the following text: &#34;мой 
первый медиаплана&#34; &#40;without the quotes&#41;. Save it as utf8.xls

2. Read this spreadsheet with the following program:

    use 5.10.0;                                                                                                                                         
    use warnings;
    binmode STDOUT, &#39;:encoding&#40;UTF-8&#41;&#39;;    # or use utf8::all
    use Spreadsheet::ParseExcel;

    my $workbook = Spreadsheet::ParseExcel-&gt;new-&gt;parse&#40;&#39;utf8.xls&#39;&#41;;

    my @worksheets = $workbook-&gt;worksheets;
    my $cell = $worksheets[0]-&gt;get_cell&#40; 0, 0 &#41;;
    say &#34;Value       = &#34;, $cell-&gt;value&#40;&#41;;
    say &#34;Unformatted = &#34;, $cell-&gt;unformatted&#40;&#41;;

The output on my machine is as follows:

    Value       = мой первый медиаплана
    Unformatted = &lt;&gt;9 ?5@2K9 &lt;5480?;0=0

Extra information:

I have a workaround for this, but I&#39;ve attached a test script and an 
Excel file which demonstrates the problem. The Excel file was created 
with LibreOffice Calc, but I&#39;ve observed this behavior with spreadsheets 
created with Microsoft Excel.

Also:

    Perl version   : 5.012002
    OS name        : linux
    Module versions:
        Spreadsheet::ParseExcel    0.59
        Scalar::Util               1.23
        Unicode::Map               0.112
        Spreadsheet::WriteExcel    2.37
        Parse::RecDescent          1.967006
        File::Temp                 0.22
        OLE::Storage_Lite          0.19
        IO::Stringy                2.110

Cheers,
Ovid
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> xls.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">    use 5.10.0;
    use warnings;
    binmode STDOUT, &#39;:encoding&#40;UTF-8&#41;&#39;;    # or use utf8::all
    use Spreadsheet::ParseExcel;

    my $workbook = Spreadsheet::ParseExcel-&gt;new-&gt;parse&#40;&#39;utf8.xls&#39;&#41;;

    my @worksheets = $workbook-&gt;worksheets;
    my $cell = $worksheets[0]-&gt;get_cell&#40; 0, 0 &#41;;
    say &#34;Value       = &#34;, $cell-&gt;value&#40;&#41;;
    say &#34;Unformatted = &#34;, $cell-&gt;unformatted&#40;&#41;;

    say &#34;Perl version   : $]&#34;;
    say &#34;OS name        : $^O&#34;;
    say &#34;Module versions: &#40;not all are required&#41;\n&#34;;

    my @modules = qw&#40;
      Spreadsheet::ParseExcel
      Scalar::Util
      Unicode::Map
      Spreadsheet::WriteExcel
      Parse::RecDescent
      File::Temp
      OLE::Storage_Lite
      IO::Stringy
    &#41;;

    for my $module &#40;@modules&#41; {
        my $version;
        eval &#34;require $module&#34;;

        if &#40; not $@ &#41; {
            $version = $module-&gt;VERSION;
            $version = &#39;&#40;unknown&#41;&#39; if not defined $version;
        }
        else {
            $version = &#39;&#40;not installed&#41;&#39;;
        }

        printf &#34;%21s%-24s\t%s\n&#34;, &#34;&#34;, $module, $version;
    }
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> utf8.xls</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1151537/605586/utf8.xls">Download utf8.xls</a><br />
<span class="downloadcontenttype">application/vnd.ms-excel 5.5k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;06&nbsp;05:01:34&nbsp;2012</span>
    <span class="description">jmcnamara [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Dec 06 04:19:36 2012, OVID wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; $cell-&gt;value&#40;&#41; correctly handles UTF-8 data but $cell-&gt;unformatted&#40;&#41;
&gt; does not.
</div>
Hi Ovid,

Thanks for the detailed bug report.

This is expected behaviour &#40;although clearly you didn&#39;t expected it&#41;.

The unformatted function returns the raw data stored in Excel. It is 
used 99% of the time to get unformatted numeric data but for strings it 
returns the raw byte stream. In your case that is most likely UTF8-16LE 
but there are also some other, rarer, far-east encodings that the 
original author was interested in.

I should probably update the docs on the unformatted method to explain 
the behaviour with strings.


I&#39;ve I&#39;ve missed the issue here or if you have any other issues let me 
know.

Regards,

John.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;06&nbsp;05:01:36&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;11&nbsp;06:33:03&nbsp;2013</span>
    <span class="description">EDAVIS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This isn&#39;t really expected behaviour from the documentation, which says
&#40;in Spreadsheet::ParseExcel::Cell&#41;

    In general Spreadsheet::ParseExcel will return all character strings
    in UTF-8 regardless of the encoding used by Excel.

Then the documentation for unformatted&#40;&#41; says only that it &#34;returns the
cell value without a numeric format&#34;.

If it is really intended that unformatted&#40;&#41; should return raw bytes, it
would be better to call it unformatted_bytes&#40;&#41; or something like that.
It would also be useful to have an unformatted_chars&#40;&#41; method which
does what the documentation currently says: return the value of the cell
without numeric formatting applied, as a character string in UTF-8.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;06&nbsp;12:10:36&nbsp;2014</span>
    <span class="description">DOUGW [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Feb 11 06:33:03 2013, EDAVIS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This isn&#39;t really expected behaviour from the documentation, which says
&gt; &#40;in Spreadsheet::ParseExcel::Cell&#41;
&gt; 
&gt;     In general Spreadsheet::ParseExcel will return all character strings
&gt;     in UTF-8 regardless of the encoding used by Excel.
&gt; 
&gt; Then the documentation for unformatted&#40;&#41; says only that it &#34;returns the
&gt; cell value without a numeric format&#34;.
&gt; 
&gt; If it is really intended that unformatted&#40;&#41; should return raw bytes, it
&gt; would be better to call it unformatted_bytes&#40;&#41; or something like that.
&gt; It would also be useful to have an unformatted_chars&#40;&#41; method which
&gt; does what the documentation currently says: return the value of the cell
&gt; without numeric formatting applied, as a character string in UTF-8.
</div>
My $0.02 is that yes, unformatted&#40;&#41; should have been called something else, perhaps unencoded&#40;&#41; or raw&#40;&#41; &#40;and maybe I&#39;ll make an alias to that effect&#41;, but the original author probably thought of encoding as part of formatting &#40;after all the routine that does the conversion from raw bytes to encoded characters is called TextFmt, and it didn&#39;t even handle unicode correctly until recently&#41;.

I, like many others, use this module just to scrape data, so I understand the hassle of having to go to value&#40;&#41; for the text &#40;although I often go to unformatted&#40;&#41; for everything since I don&#39;t get much unicode&#41;, and unformatted&#40;&#41; for the numbers, and using ExcelFmt&#40;&#41; on numbers that are dates &#40;or depending on the unpredictable format you get from value&#40;&#41;&#41;...it would be nice to have one method that gives you the encoded text, unformatted number, and a date in a standard date format &#40;e.g. YYYY-MM-DD HH::MM::SS.FFF, and maybe just YYYY-MM-DD for numbers w/o a decimal part&#41;. Since distinguishing between number and date is somewhat of a guess, we can expect to get that wrong in some corner case, but I think it should be okay most of the time. I propose a new cell method data&#40;&#41; for this...and leaving everything else as is, but improving the documentation as to what value&#40;&#41; and unformatted&#40;&#41; mean.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
