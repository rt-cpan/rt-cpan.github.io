<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #33258 for HOP-Stream: Streams of array refs do not work properly</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #33258 for HOP-Stream: Streams of array refs do not work properly</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/HOP-Stream/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/HOP-Stream/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/HOP-Stream/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/HOP-Stream/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/HOP-Stream">HOP-Stream CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">33258</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/HOP-Stream/Active/">HOP-Stream</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
pauloscustodio [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-15430-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.01    </td>
  </tr>
  <tr id="CF-15431-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;14&nbsp;10:06:21&nbsp;2008</span>
    <span class="description">pauloscustodio [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Streams of array refs do not work properly</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Ovid,

HOP-Sream is great, but it fails on the last stream element when the
stream is composed of array refs, because tail [a,b] is b, even if [a,b]
is the last stream element, and not a node.

The attached solution blesses nodes into package, and checks if an
element is a node in head, tail and list_to_stream. 

The change to list_to_stream allows the call 
  $stream = list_to_stream&#40; 1 .. 10 &#41; 
to work, which is more intuitive than the originaly recommended
  $stream = list_to_stream&#40; 1 .. 9, node&#40;10, undef&#41; &#41;;

I have also added an append function to return a stream to concatenate
the input streams, and added test cases to verify the introduced changes.

Please feel free to comment on these changes and maybe incorporate in
them the next HOP::Stream version.

Best Regards,
Paulo Custodio

P.S.

Perl:
This is perl, v5.8.8 built for MSWin32-x86-multi-thread
&#40;with 50 registered patches, see perl -V for more detail&#41;

Copyright 1987-2006, Larry Wall

Binary build 820 [274739] provided by ActiveState <span class="clickylink"><a target="new" rel="nofollow" href="http://www.ActiveState.com">http://www.ActiveState.com</a></span>
Built Jan 23 2007 15:57:46

OS:
Microsoft Windows XP SP2
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> HOP-Stream-patch-0.01-0.01a.txt</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -rc HOP-Stream-0.01/lib/HOP/Stream.pm HOP-Stream-0.01a/lib/HOP/Stream.pm
*** HOP-Stream-0.01/lib/HOP/Stream.pm	Thu Oct 27 19:12:19 2005
--- HOP-Stream-0.01a/lib/HOP/Stream.pm	Sun Sep 23 11:06:56 2007
***************
*** 12,17 ****
--- 12,18 ----
    insert
    iterator_to_stream
    list_to_stream
+   append
    merge
    node
    promise
***************
*** 30,40 ****
  
  =head1 VERSION
  
! Version 0.01
  
  =cut
  
! our $VERSION = &#39;0.01&#39;;
  
  =head1 SYNOPSIS
  
--- 31,41 ----
  
  =head1 VERSION
  
! Version 0.01a
  
  =cut
  
! our $VERSION = &#39;0.01a&#39;;
  
  =head1 SYNOPSIS
  
***************
*** 75,80 ****
--- 76,83 ----
  
  =item * list_to_stream
  
+ =item * append
+ 
  =item * merge
  
  =item * node
***************
*** 108,114 ****
  
  sub node {
      my &#40; $h, $t &#41; = @_;
!     [ $h, $t ];
  }
  
  ##############################################################################
--- 111,117 ----
  
  sub node {
      my &#40; $h, $t &#41; = @_;
!     bless [ $h, $t ], __PACKAGE__;
  }
  
  ##############################################################################
***************
*** 124,129 ****
--- 127,133 ----
  
  sub head {
      my &#40;$s&#41; = @_;
+     return undef unless is_node&#40;$s&#41;;
      $s-&gt;[0];
  }
  
***************
*** 139,144 ****
--- 143,150 ----
  
  sub tail {
      my &#40;$s&#41; = @_;
+     return undef unless is_node&#40;$s&#41;;
+     
      if &#40; is_promise&#40; $s-&gt;[1] &#41; &#41; {
          $s-&gt;[1] = $s-&gt;[1]-&gt;&#40;&#41;;
      }
***************
*** 147,152 ****
--- 153,175 ----
  
  ##############################################################################
  
+ =head2 is_node
+ 
+   if &#40; is_node&#40;$tail&#41; &#41; {
+      ...
+   }
+ 
+ Returns true if the tail of a node is a node. Generally this function is
+ used internally.
+ 
+ =cut
+ 
+ sub is_node {
+     UNIVERSAL::isa&#40; $_[0], __PACKAGE__ &#41;;
+ }
+ 
+ ##############################################################################
+ 
  =head2 is_promise
  
    if &#40; is_promise&#40;$tail&#41; &#41; {
***************
*** 284,289 ****
--- 307,334 ----
  
  ##############################################################################
  
+ =head2 append
+ 
+   my $merged_stream = append&#40; $stream1, $stream2 &#41;;
+ 
+ This function takes a list of streams and attaches them together head-to-tail
+ into a new stream.
+ 
+ =cut
+ 
+ sub append {
+     my &#40; @streams &#41; = @_;
+     
+     while &#40; @streams &#41; {
+ 		my $h = drop&#40;$streams[0]&#41;;
+ 		return node&#40; $h, promise { append&#40; @streams &#41; } &#41; if defined&#40;$h&#41;;
+ 		shift @streams;
+ 	}
+ 	return undef;
+ }
+ 
+ ##############################################################################
+ 
  =head2 list_to_stream
  
    my $stream = list_to_stream&#40;@list&#41;;
***************
*** 300,305 ****
--- 345,352 ----
  
  sub list_to_stream {
      my $node = pop;
+ 	$node = node&#40;$node&#41; unless is_node&#40;$node&#41;;    
+ 
      while &#40;@_&#41; {
          my $item = pop;
          $node = node&#40; $item, $node &#41;;
diff -rc HOP-Stream-0.01/t/10-streams.t HOP-Stream-0.01a/t/10-streams.t
*** HOP-Stream-0.01/t/10-streams.t	Thu Oct 27 19:12:19 2005
--- HOP-Stream-0.01a/t/10-streams.t	Sun Sep 23 11:05:41 2007
***************
*** 2,9 ****
  use warnings;
  use strict;
  
! #use Test::More tests =&gt; 21;
! use Test::More &#39;no_plan&#39;;
  
  use lib &#39;lib/&#39;, &#39;../lib/&#39;;
  
--- 2,9 ----
  use warnings;
  use strict;
  
! use Test::More tests =&gt; 61;
! #use Test::More &#39;no_plan&#39;;
  
  use lib &#39;lib/&#39;, &#39;../lib/&#39;;
  
***************
*** 19,24 ****
--- 19,25 ----
    insert
    iterator_to_stream
    list_to_stream
+   append
    merge
    node
    promise
***************
*** 110,115 ****
--- 111,131 ----
  is_deeply \@numbers, [ 2, 4, 6, 8, 10 ],
    &#39;... which should return the numbers we expect&#39;;
  
+ # append
+ 
+ my $stream1 = upto&#40;4, 7&#41;;
+ my $stream2 = upto&#40;12, 15&#41;;
+ my $stream3 = upto&#40;25, 28&#41;;
+ ok $stream = append&#40;$stream1, $stream2, $stream3&#41;,
+ 	&#34;append&#40;&#41; should return a stream&#34;;
+ 
+ @numbers = &#40;&#41;;
+ while &#40; defined&#40; my $num = drop&#40;$stream&#41; &#41; &#41; {
+     push @numbers, $num;
+ }
+ is_deeply \@numbers, [ 4..7, 12..15, 25..28 ],
+   &#39;... and the stream should return all of the numbers&#39;;
+ 
  # merge
  
  sub scale {
***************
*** 168,173 ****
--- 184,199 ----
  }
  is_deeply \@numbers, [ 1 .. 10 ], &#39;... and create the numbers one to ten&#39;;
  
+ # list_to_stream, final node computed internally
+ 
+ ok $list = list_to_stream&#40; 1 .. 10 &#41;,
+   &#39;list_to_stream&#40;&#41; should return a stream&#39;;
+ @numbers = &#40;&#41;;
+ while &#40; defined&#40; my $num = drop&#40;$list&#41; &#41; &#41; {
+     push @numbers, $num;
+ }
+ is_deeply \@numbers, [ 1 .. 10 ], &#39;... and create the numbers one to ten&#39;;
+ 
  # insert
  
  my @list = qw/seventeen three one/;                # sorted by descending length
***************
*** 176,178 ****
--- 202,246 ----
  is_deeply \@list, [qw/seventeen three four one/],
    &#39;insert&#40;&#41; should be able to insert items according to our sort criteria&#39;;
  
+ # 
+ # streams of array refs do not work properly, because tail [a,b] is b, even if [a,b] is
+ # the last stream element, and not a node
+ # Solution: bless nodes, check is_node in head, tail, list_to_stream
+ #
+ $stream = list_to_stream&#40; [A =&gt; 1], [B =&gt; 2] &#41;;
+ is_deeply $stream, 
+ 	bless&#40;[	[A =&gt; 1], 
+ 			bless&#40;[	[B =&gt; 2], 
+ 					undef ],
+ 				&#39;HOP::Stream&#39;&#41;],
+ 		&#39;HOP::Stream&#39;&#41;, &#34;stream of array refs&#34;;
+ is_deeply head&#40;$stream&#41;, [A =&gt; 1], &#34;... head is array ref&#34;;
+ is_deeply tail&#40;$stream&#41;, 
+ 	bless&#40;[	[B =&gt; 2], 
+ 			undef ],
+ 		&#39;HOP::Stream&#39;&#41;, &#34;... tail is stream&#34;;
+ 
+ drop&#40;$stream&#41;;
+ is_deeply $stream, 
+ 	bless&#40;[	[B =&gt; 2], 
+ 			undef ],
+ 		&#39;HOP::Stream&#39;&#41;, &#34;stream of array refs, dropped 1&#34;;
+ is_deeply head&#40;$stream&#41;, [B =&gt; 2], &#34;... head is array ref&#34;;
+ is_deeply tail&#40;$stream&#41;, undef, &#34;... tail is stream&#34;;
+ 
+ drop&#40;$stream&#41;;
+ is_deeply $stream, undef, &#34;stream of array refs, dropped 2&#34;;
+ is_deeply head&#40;$stream&#41;, undef, &#34;... head is undef&#34;;
+ is_deeply tail&#40;$stream&#41;, undef, &#34;... tail is undef&#34;;
+ 
+ drop&#40;$stream&#41;;
+ is_deeply $stream, undef, &#34;stream of array refs, dropped 3&#34;;
+ is_deeply head&#40;$stream&#41;, undef, &#34;... head is undef&#34;;
+ is_deeply tail&#40;$stream&#41;, undef, &#34;... tail is undef&#34;;
+ 
+ # 
+ # use a non-stream as stream
+ #
+ $stream = [1, [2, [3]]];
+ is head&#40;$stream&#41;, undef, &#34;no head of non-stream&#34;;
+ is tail&#40;$stream&#41;, undef, &#34;no head of non-stream&#34;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;19&nbsp;02:49:58&nbsp;2008</span>
    <span class="description">ovid [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Feb 14 10:06:21 2008, pauloscustodio@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hello Ovid,
&gt; 
&gt; HOP-Sream is great, but it fails on the last stream element when the
&gt; stream is composed of array refs, because tail [a,b] is b, even if [a,b]
&gt; is the last stream element, and not a node.
</div>
Patch accepted and applied.  Thanks Paulo!

Cheers,
Ovid
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;19&nbsp;02:50:00&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;19&nbsp;02:50:01&nbsp;2008</span>
    <span class="description">ovid [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
