<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #716 for Crypt-CBC: CBC fixes for oneandzeroes and compatibility</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #716 for Crypt-CBC: CBC fixes for oneandzeroes and compatibility</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Crypt-CBC/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Crypt-CBC/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Crypt-CBC/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Crypt-CBC/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Crypt-CBC">Crypt-CBC CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">716</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Crypt-CBC/Active/">Crypt-CBC</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">LDS [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
swaters [...] amicus.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-8356-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-8357-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;06&nbsp;10:16:23&nbsp;2002</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> CBC fixes for oneandzeroes and compatibility</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixes &#40;in order of diff&#41;: 

1. parse buffer into blocks only if buffer is greater than blocksize
since -&gt;finish will do pad/encrypt stuff for 1 block. 

2. the code ---- . &#34;a*&#34; ---- in the unpack was causing an extra byte to
be added to strings which evenly divide into blocks. 

3. code formatting inside an if statement 

4. oneandzeroes fix. basically, the bit string was being truncated
incorrectly. I made it a hex string and truncate /80+$/ &#40;i.e., 0x80 is
the 1 plus any zeros&#41; 

Tested: 

Perl v5.6.1 built for powerpc-linux
Perl v5.6.1 built for i386-linux

oneandzeroes padding with Crypt::Rijndael 

With this patch, Crypt::CBC works out of the box with Cryptix 3.2.0 and
Crypt::Rijndael::MODE_CBC.

-s
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- CBC.pm	Tue Jun  4 15:48:04 2002
+++ CBC.pm.new	Wed Jun  5 13:34:45 2002
@@ -174,27 +174,23 @@
 
      my $bs = $self-&gt;{&#39;blocksize&#39;};
 
-     return $result unless &#40;length&#40;$self-&gt;{&#39;buffer&#39;}&#41; &gt;= $bs&#41;;
+     return $result unless &#40;length&#40;$self-&gt;{&#39;buffer&#39;}&#41; &gt; $bs&#41;;
 
     # split into blocksize chunks
-    # used to be:
-    # my @blocks = $self-&gt;{&#39;buffer&#39;}=~/&#40;.{1,$bs}&#41;/ogs;
-    # but this is a little faster &#40;about 1.5 times&#41;
-    my @blocks = unpack&#40;&#34;a$bs &#34;x&#40;int&#40;length&#40;$self-&gt;{&#39;buffer&#39;}&#41;/$bs&#41;&#41; . &#34;a*&#34;, $self-&gt;{&#39;buffer&#39;}&#41;;
-    $self-&gt;{&#39;buffer&#39;} = &#39;&#39;;
-
-    if &#40;$d&#41; {  # when decrypting, always leave a free block at the end
-      $self-&gt;{&#39;buffer&#39;} = length&#40;$blocks[-1]&#41; &lt; $bs ? join &#39;&#39;,splice&#40;@blocks,-2&#41; : pop&#40;@blocks&#41;;
+    my $bcnt = int&#40;length&#40;$self-&gt;{&#39;buffer&#39;}&#41;/$bs&#41;;
+    my @blocks = unpack&#40;&#34;a$bs &#34;x $bcnt, $self-&gt;{&#39;buffer&#39;}&#41;;
+    if &#40;length&#40;$self-&gt;{&#39;buffer&#39;}&#41; % $bs == 0&#41; {
+      $self-&gt;{&#39;buffer&#39;} = pop @blocks; 
     } else {
-      $self-&gt;{&#39;buffer&#39;} = pop @blocks if length&#40;$blocks[-1]&#41; &lt; $bs;  # what&#39;s left over
+      $self-&gt;{&#39;buffer&#39;} = substr&#40;$self-&gt;{&#39;buffer&#39;}, $bcnt * $bs&#41;;
     }
 
     foreach my $block &#40;@blocks&#41; {
       if &#40;$d&#41; { # decrypting
-	$result .= $iv ^ $self-&gt;{&#39;crypt&#39;}-&gt;decrypt&#40;$block&#41;;
-	$iv = $block;
+	  $result .= $iv ^ $self-&gt;{&#39;crypt&#39;}-&gt;decrypt&#40;$block&#41;;
+	  $iv = $block;
       } else { # encrypting
-	$result .= $iv = $self-&gt;{&#39;crypt&#39;}-&gt;encrypt&#40;$iv ^ $block&#41;;
+	  $result .= $iv = $self-&gt;{&#39;crypt&#39;}-&gt;encrypt&#40;$iv ^ $block&#41;;
       }
     }
     $self-&gt;{&#39;civ&#39;} = $iv;	        # remember the iv
@@ -280,14 +276,10 @@
   my $decrypt = shift;
 	
   if &#40;$decrypt eq &#39;d&#39;&#41; {	# decrypting
-    my $bitstring = unpack&#40;&#34;B*&#34;, $block&#41;;
-    $bitstring =~ s/10*$//s;
-    while &#40;length&#40;$bitstring&#41;%8&#41; {
-      # this shouldn&#39;t be the case, but let&#39;s make stuff full bytes...
-      $bitstring .= &#39;0&#39;;
-    }
-    $block = pack&#40;&#34;B*&#34;, $bitstring&#41;;
-  } else {
+    my $hex = unpack&#40;&#34;H*&#34;, $block&#41;;
+    $hex =~ s/80+$//s;
+    $block = pack&#40;&#34;H*&#34;, $hex&#41;;
+  } elsif &#40;length&#40;$block&#41; &lt; $bs&#41; {
     $block .= pack&#40;&#34;H2&#34;, &#34;80&#34;&#41;;
     $block = pack&#40;&#34;a$bs&#34;, $block&#41;;
   }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;08&nbsp;14:17:37&nbsp;2002</span>
    <span class="description">lstein [...] cshl.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Lincoln Stein &lt;lstein [...] cshl.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Crypt-CBC [...] rt.cpan.org, &#34;&#39;AdminCc of cpan Ticket #716&#39;&#34;: ;;,
	 [...] fontina.cshl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #716] CBC fixes for oneandzeroes and compatibility</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 8 Jun 2002 14:17:30 -0400</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Whoever, sent this, please send me the patch directly.  rt.cpan.org *does not* 
work -- at least not whenever I try it.

Lincoln

On Thursday 06 June 2002 10:16, Guest via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This message about Crypt-CBC was sent to you by guest via rt.cpan.org
&gt;
&gt; Full context and any attached attachments can be found at:
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=716">https://rt.cpan.org/Ticket/Display.html?id=716</a></span> &gt;
&gt;
&gt; Fixes &#40;in order of diff&#41;:
&gt;
&gt; 1. parse buffer into blocks only if buffer is greater than blocksize
&gt; since -&gt;finish will do pad/encrypt stuff for 1 block.
&gt;
&gt; 2. the code ---- . &#34;a*&#34; ---- in the unpack was causing an extra byte to
&gt; be added to strings which evenly divide into blocks.
&gt;
&gt; 3. code formatting inside an if statement
&gt;
&gt; 4. oneandzeroes fix. basically, the bit string was being truncated
&gt; incorrectly. I made it a hex string and truncate /80+$/ &#40;i.e., 0x80 is
&gt; the 1 plus any zeros&#41;
&gt;
&gt; Tested:
&gt;
&gt; Perl v5.6.1 built for powerpc-linux
&gt; Perl v5.6.1 built for i386-linux
&gt;
&gt; oneandzeroes padding with Crypt::Rijndael
&gt;
&gt; With this patch, Crypt::CBC works out of the box with Cryptix 3.2.0 and
&gt; Crypt::Rijndael::MODE_CBC.
&gt;
&gt; -s
</div>
-- 
========================================================================
Lincoln D. Stein                           Cold Spring Harbor Laboratory
lstein@cshl.org                                   Cold Spring Harbor, NY
========================================================================
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;08&nbsp;14:17:55&nbsp;2002</span>
    <span class="description">lstein [...] cshl.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Lincoln Stein &lt;lstein [...] cshl.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Crypt-CBC [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #716] CBC fixes for oneandzeroes and compatibility</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 8 Jun 2002 14:17:49 -0400</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Whoever, sent this, please send me the patch directly.  rt.cpan.org *does not* 
work -- at least not whenever I try it.

Lincoln

On Thursday 06 June 2002 10:16, Guest via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This message about Crypt-CBC was sent to you by guest via rt.cpan.org
&gt;
&gt; Full context and any attached attachments can be found at:
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=716">https://rt.cpan.org/Ticket/Display.html?id=716</a></span> &gt;
&gt;
&gt; Fixes &#40;in order of diff&#41;:
&gt;
&gt; 1. parse buffer into blocks only if buffer is greater than blocksize
&gt; since -&gt;finish will do pad/encrypt stuff for 1 block.
&gt;
&gt; 2. the code ---- . &#34;a*&#34; ---- in the unpack was causing an extra byte to
&gt; be added to strings which evenly divide into blocks.
&gt;
&gt; 3. code formatting inside an if statement
&gt;
&gt; 4. oneandzeroes fix. basically, the bit string was being truncated
&gt; incorrectly. I made it a hex string and truncate /80+$/ &#40;i.e., 0x80 is
&gt; the 1 plus any zeros&#41;
&gt;
&gt; Tested:
&gt;
&gt; Perl v5.6.1 built for powerpc-linux
&gt; Perl v5.6.1 built for i386-linux
&gt;
&gt; oneandzeroes padding with Crypt::Rijndael
&gt;
&gt; With this patch, Crypt::CBC works out of the box with Cryptix 3.2.0 and
&gt; Crypt::Rijndael::MODE_CBC.
&gt;
&gt; -s
</div>
-- 
========================================================================
Lincoln D. Stein                           Cold Spring Harbor Laboratory
lstein@cshl.org                                   Cold Spring Harbor, NY
========================================================================
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;08&nbsp;14:22:24&nbsp;2002</span>
    <span class="description">LDS [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;08&nbsp;14:23:34&nbsp;2002</span>
    <span class="description">LDS [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
