<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #35931 for Win32-Process-Info: Programm crashes while using Win32::Process::Info</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #35931 for Win32-Process-Info: Programm crashes while using Win32::Process::Info</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Win32-Process-Info/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Win32-Process-Info/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Win32-Process-Info/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Win32-Process-Info/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Win32-Process-Info">Win32-Process-Info CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">35931</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">stalled</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Win32-Process-Info/Active/">Win32-Process-Info</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
KES [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-35702-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.011    </td>
  </tr>
  <tr id="CF-35703-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;16&nbsp;03:40:40&nbsp;2008</span>
    <span class="description">KES [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Programm crashes while using Win32::Process::Info</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Programm need to work 24 hours 7 days per week but it can not... it
crashes after 5-6 hours =&#40;

I am calculating memory usage and this code is runned every 5 seconds
The daemon runned as service with help of module: Win32::Daemon

sub updateMemoryUsageStat {
  my&#40; $context &#41;= @_;

  my $pi = Win32::Process::Info-&gt;new&#40;&#41;;

  foreach my $task &#40; @{ $context-&gt;{tasks} } &#41; {  
   my $usage= {
     VirtualPeak =&gt; 0,
     PhysicalPeak =&gt; 0,
     };

   my $children= $pi-&gt;Subprocesses&#40; $task-&gt;{PID} &#41;;
   my @procList= subprocessesList&#40; $task-&gt;{PID}, $children &#41;;
   my @procsInfo= $pi-&gt;GetProcInfo&#40; @procList &#41;;

   for my $procInfo &#40; @procsInfo &#41; {
    $usage-&gt;{VirtualPeak}+= $procInfo-&gt;{PeakVirtualSize};
    $usage-&gt;{PhysicalPeak}+= $procInfo-&gt;{PeakWorkingSetSize};
    }


   $usage-&gt;{VirtualPeak}/=1024*1024;
   $usage-&gt;{PhysicalPeak}/=1024*1024;
 }

sub subprocessesList {
  my&#40; $currPid, $children &#41;= @_;

  my @processes= &#40; $currPid &#41;;
  foreach my $pid &#40; @{ $children-&gt;{$currPid} } &#41; {
   push @processes, subprocessesList&#40; $pid, $children &#41;;
   }

  return @processes;
  }



sub Callback_Running {
  my&#40; $event, $context &#41; = @_;

    #if&#40; SERVICE_RUNNING == Win32::Daemon::State&#40;&#41; &#41; {#Perl 5.8
    if&#40; $event == 4128 &#41; { #Perl 5.10
        updateMemoryUsageStat&#40; $context &#41;;
      }

  return undef;
  }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;16&nbsp;13:28:51&nbsp;2008</span>
    <span class="description">wyant [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Win32::Process::Info has three possible &#39;back ends&#39; to gather its
information. The default is &#39;WMI&#39;, for historical reasons. But this is
known to leak memory because of unresolved problems in Win32::OLE, and I
recommend that the &#39;WMI&#39; variant not be used for daemons.

Unfortunately, the &#39;NT&#39; variant does not return the information you
want. Under the assumption that the problem is memory leaking from
Win32::OLE, the problem can be minimized &#40;but NOT eliminated&#41; by
changing your

my @procsInfo= $pi-&gt;GetProcInfo&#40; @procList &#41;;

to

my @procsInfo= $pi-&gt;GetProcInfo&#40; {no_user_info =&gt; 1}, @procList &#41;;

If the problem is that Win32::OLE leaks memory then this will still
crash eventually, but maybe it will run long enough. It prevents the
username and SID from being returned, but your script does not appear to
use these, and that is where the worst leakage is.

Since I have no control over Win32::OLE, this may end up being turned
into an enhancement request to add the information you need to the &#39;NT&#39;
variant. I am not sure how quickly this can be responded to, since I am
not in the position to do Windows development that I was when this
module was written. The first step would be a documentation search to
see if there is a documented source for these other than WMI -- there
was not when I wrote the module.

Please let me know whether the recommended change affects the problem.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;16&nbsp;13:28:52&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;19&nbsp;08:55:55&nbsp;2008</span>
    <span class="description">KES [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I modify my code in next way: 

I create $pi object only once when service is started then reuse it:
sub Callback_Start {
  my&#40; $event, $context &#41; = @_;
  ...
  $context-&gt;{ProcInfo} = Win32::Process::Info-&gt;new&#40;&#41;;
   ...
  }


Then I add logging to my subroutine:

sub updateMemoryUsageStat {
  my&#40; $context &#41;= @_;

  foreach my $task &#40; @{ $context-&gt;{tasks} } &#41; {
   my $usage= {
     VirtualPeak =&gt; 0,
     PhysicalPeak =&gt; 0,
     };

   msgLog&#40; $context-&gt;{logFile}, localtime&#40;&#41;. &#34; START&#34; &#41;   if $DEBUG &gt;= 5;
   my $children= $context-&gt;{ProcInfo}-&gt;Subprocesses&#40; $task-&gt;{PID} &#41;;
   msgLog&#40; $context-&gt;{logFile}, localtime&#40;&#41;. &#34; Subprocesses completed&#34; &#41;
  if $DEBUG &gt;= 5;
   my @procList= subprocessesList&#40; $task-&gt;{PID}, $children &#41;;
   msgLog&#40; $context-&gt;{logFile}, localtime&#40;&#41;. &#34; List completed&#34; &#41;   if
$DEBUG &gt;= 5;
   my @procsInfo= $context-&gt;{ProcInfo}-&gt;GetProcInfo&#40; @procList &#41;;
   msgLog&#40; $context-&gt;{logFile}, localtime&#40;&#41;. &#34; ProcInfo completed&#34; &#41;  
if $DEBUG &gt;= 5;

   msgLog&#40; $context-&gt;{logFile}, localtime&#40;&#41;. Dumper&#40; @procsInfo &#41; &#41;   if
$DEBUG &gt;= 5;

   for my $procInfo &#40; @procsInfo &#41; {
    $usage-&gt;{VirtualPeak}+= $procInfo-&gt;{PeakVirtualSize};
    $usage-&gt;{PhysicalPeak}+= $procInfo-&gt;{PeakWorkingSetSize};
    }


   $usage-&gt;{VirtualPeak}/=1024*1024;
   $usage-&gt;{PhysicalPeak}/=1024*1024;
  }

Now daemon runs longer but also crashes &#40;&#40;
It crashes while calling to &#39;Subprocesses&#39; and not to GetProcInfo

Any sugggestions?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;19&nbsp;17:16:10&nbsp;2008</span>
    <span class="description">wyant [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon May 19 08:55:55 2008, KES wrote:

&lt;snip /&gt;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Now daemon runs longer but also crashes &#40;&#40;
&gt; It crashes while calling to &#39;Subprocesses&#39; and not to GetProcInfo
&gt; 
&gt; Any sugggestions?
</div>
None of the sort you would really want to hear, or that I would want to
give you.

I would like to recommend that you move to the NT variant, but
unfortunately only the WMI variant gives you the data you need. I am not
in a position to enhance the NT variant at the moment, nor am I able to
make the WMI variant more reliable since the problem is in Win32::OLE.

All I can think of is either to try to live with the problem, or look
into one of the other packages under &#34;RELATED MODULES&#34; in the
documentation. I have not looked at any of these recently, but memory
says that Win32::PerfLib is more likely to have the memory usage;
whether it has the subprocesses I do not remember, but I _do_ remember
that the interface looks like a pain.

If I were to try to live with the limitations to Win32::Process::Info, I
think I would try to find a way to get it restarted periodically,
preserving the information you had gathered. I would probably use YAML
for a little data, or YAML::Syck for a lot, but Storable and
Data::Dumper are reasonable alternatives. A reasonably modern Windows
will restart a failed service if you request this, so a cheap
alternative would be just to detect when the service has been running
long enough &#40;say, two hours&#41;, have it dump its data and then die. When
Windows restarts the service it can reload the dumped data and resume
its function. The question here is how long it will take Windows to
notice that the service has died. If it is too long, I might try making
the service into a watchdog that spawns the data collection code into a
subprocess, watches for its exit using the Win32::Process module, and
restarts it.

My apologies for not having a better response for you.

Tom Wyant
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;20&nbsp;03:42:41&nbsp;2008</span>
    <span class="description">KES [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think I would live with it.
Now I spawn new process from service and do all job there. Service just
check child to exist and respawn it when it dies.
Seems this fit all problem I want to resolve
Thx for support. hope it will be fixed. bye
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;02&nbsp;21:13:02&nbsp;2008</span>
    <span class="description">wyant [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Because I can not do anything about the Win32::OLE behaviour, I am going
to change this to a &#34;wishlist&#34; item. My intent, eventually, is to try to
add the desired functionality to the &#34;NT&#34; variant, which avoids the OLE
weirdness.

I am also going to mark it &#34;Stalled&#34;, until I acquire a means to work on it.

Sorry not to have a better answer.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;02&nbsp;21:13:04&nbsp;2008</span>
    <span class="description">wyant [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;02&nbsp;21:13:19&nbsp;2008</span>
    <span class="description">wyant [...] cpan.org -  Severity Critical changed to Wishlist</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
