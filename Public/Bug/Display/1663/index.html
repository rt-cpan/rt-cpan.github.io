<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #1663 for POE-Component-Pcap: &#34;make test&#34; fails</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #1663 for POE-Component-Pcap: &#34;make test&#34; fails</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=POE-Component-Pcap">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=POE-Component-Pcap">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=POE-Component-Pcap">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=POE-Component-Pcap">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/POE-Component-Pcap">POE-Component-Pcap CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">1663</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">15 min

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=POE-Component-Pcap">POE-Component-Pcap</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
RCAPUTO [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-26556-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-26557-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




Pcap.pm<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/74053/7303/Pcap.pm">
Tue Jan 07 16:45:55 2003 (9.7k) by 
</a>
</font></li>
</ul>


perl-v.text<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/74050/6550/perl-v.text">
Mon Oct 14 15:45:33 2002 (1.9k) by alex.leites2 [...] esca.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=1663">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-74050" href="/Public/Bug/Display.html?id=1663#txn-74050">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;14&nbsp;15:45:33&nbsp;2002</span>
    <span class="description">RCAPUTO [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> &#34;make test&#34; fails</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/74050/6549/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/6549">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 994b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">3&#41; eyrie:~/.cpanplus/build/POE-Component-Pcap-0.03# make test

PERL_DL_NONLAZY=1 /usr/bin/perl -Iblib/arch -Iblib/lib \
-I/usr/local/perl-561-single/lib/i386-freebsd \
-I/usr/local/perl-561-single/lib -e \
&#39;use Test::Harness qw&#40;&#38;runtests $verbose&#41;; $verbose=0; \
runtests @ARGV;&#39; t/*.t
t/01basic....ok 1/2
## Waiting for one ARP packet on rl0. . .
Can&#39;t use an undefined value as a symbol reference at blib/lib/POE/Component/Pcap.pm line 174.
t/01basic....dubious
        Test returned status 22 &#40;wstat 5632, 0x1600&#41;
DIED. FAILED test 2
        Failed 1/2 tests, 50.00% okay
Failed Test Stat Wstat Total Fail  Failed  List of Failed
-------------------------------------------------------------------------------
t/01basic.t   22  5632     2    1  50.00%  2
Failed 1/1 test scripts, 0.00% okay. 1/2 subtests failed, 50.00% okay.
*** Error code 2

Stop in /root/.cpanplus/build/POE-Component-Pcap-0.03.

... perl -V output attached.

-- Rocco Caputo / troc@pobox.com / poe.perl.org / poe.sf.net
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/74050/6550/perl-v.text">Download perl-v.text</a><br />
<span class="downloadcontenttype">text/plain 1.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Summary of my perl5 &#40;revision 5.0 version 6 subversion 1&#41; configuration:
  Platform:
    osname=freebsd, osvers=4.3-rc, archname=i386-freebsd
    uname=&#39;freebsd eyrie.homenet 4.3-rc freebsd 4.3-rc #0: wed apr 11 01:15:54 edt 2001 troc@eyrie.homenet:usrobjusrsrcsysrc20010411 i386 &#39;
    config_args=&#39;&#39;
    hint=recommended, useposix=true, d_sigaction=define
    usethreads=undef use5005threads=undef useithreads=undef usemultiplicity=undef
    useperlio=undef d_sfio=undef uselargefiles=define usesocks=undef
    use64bitint=undef use64bitall=undef uselongdouble=undef
  Compiler:
    cc=&#39;cc&#39;, ccflags =&#39;-DDEBUGGING -fno-strict-aliasing -I/usr/local/include&#39;,
    optimize=&#39;-O2 -g&#39;,
    cppflags=&#39;-DDEBUGGING -fno-strict-aliasing -I/usr/local/include&#39;
    ccversion=&#39;&#39;, gccversion=&#39;2.95.3 [FreeBSD] 20010315 &#40;release&#41;&#39;, gccosandvers=&#39;&#39;
    intsize=4, longsize=4, ptrsize=4, doublesize=8, byteorder=1234
    d_longlong=define, longlongsize=8, d_longdbl=define, longdblsize=12
    ivtype=&#39;long&#39;, ivsize=4, nvtype=&#39;double&#39;, nvsize=8, Off_t=&#39;off_t&#39;, lseeksize=8
    alignbytes=4, usemymalloc=n, prototype=define
  Linker and Libraries:
    ld=&#39;cc&#39;, ldflags =&#39;-Wl,-E  -L/usr/local/lib&#39;
    libpth=/usr/lib /usr/local/lib
    libs=-lm -lc -lcrypt -liconv -lutil
    perllibs=-lm -lc -lcrypt -liconv -lutil
    libc=, so=so, useshrplib=false, libperl=libperl.a
  Dynamic Linking:
    dlsrc=dl_dlopen.xs, dlext=so, d_dlsymun=undef, ccdlflags=&#39; &#39;
    cccdlflags=&#39;-DPIC -fpic&#39;, lddlflags=&#39;-shared  -L/usr/local/lib&#39;


Characteristics of this binary &#40;from libperl&#41;: 
  Compile-time options: DEBUGGING USE_LARGE_FILES
  Built under freebsd
  Compiled at Apr 16 2001 12:18:12
  %ENV:
    PERL5LIB=&#34;/home/troc/perl/poe&#34;
  @INC:
    /home/troc/perl/poe
    /usr/local/perl-561-single/lib/i386-freebsd
    /usr/local/perl-561-single/lib
    /usr/local/perl-561-single/site-lib/i386-freebsd
    /usr/local/perl-561-single/site-lib
    /usr/local/perl-561-single/site-lib
    .
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-74051" href="/Public/Bug/Display.html?id=1663#txn-74051">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;07&nbsp;16:20:50&nbsp;2003</span>
    <span class="description">fletch+cpan [...] phydeaux.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/74051/7300/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/7300">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 182b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ooop, guess I need to poke around PAUSE more frequently.

Hrmm, duplicated on my 4.5 FreeBSD box.  Poking further.
Need to do a release to clean up deprecated _signal states
anyhow.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-74052" href="/Public/Bug/Display.html?id=1663#txn-74052">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;07&nbsp;16:40:45&nbsp;2003</span>
    <span class="description">fletch+cpan [...] phydeaux.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-74053" href="/Public/Bug/Display.html?id=1663#txn-74053">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;07&nbsp;16:45:55&nbsp;2003</span>
    <span class="description">fletch+cpan [...] phydeaux.org -  Correspondence added</span>
    <span class="time-taken">15 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> New version of Pcap.pm</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/74053/7302/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/7302">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 639b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Try the attached version which basically replaces:

=pod

  ## Need an IO::Handle to $kernel-&gt;select_read&#40;&#41; upon
  $heap-&gt;{fdh} = IO::Handle-&gt;new_from_fd&#40; $heap-&gt;{fd}, &#34;&lt;+&#34; &#41;;

=cut

With this using open/gensym instead:


  $heap-&gt;{fdh} = gensym;
  open&#40; $heap-&gt;{fdh}, &#34;&lt;&#38;&#34;.$heap-&gt;{fd} &#41;
    or die &#34;Can&#39;t dup handle from pcap fd: $!\n&#34;;


For some reason the IO::Handle doesn&#39;t want to get created and I wasn&#39;t
checking for failure there &#40;bad programmer, no skittles!&#41; and that undef
was getting passed on into the call to $kernel-&gt;select_read&#40;&#41; furhter
on.  Once I clean up the _signal state stuff I&#39;ll package up a 0.04 if
this works.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/74053/7303/Pcap.pm">Download Pcap.pm</a><br />
<span class="downloadcontenttype">text/x-perl 9.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
##
## $Id: Pcap.pm,v 1.2 2001/03/05 16:25:52 fletch Exp $
##
package POE::Component::Pcap;

use strict;
use Carp qw&#40; croak carp &#41;;

$POE::Component::Pcap::VERSION = q{0.03};

use POE;

use Symbol qw&#40; gensym &#41;;

use IO::Handle;
use Fcntl qw&#40; F_GETFL F_SETFL O_NONBLOCK &#41;;

use Net::Pcap;

##
## POE::Component::Pcap-&gt;spawn&#40;
##			       [ Alias =&gt; &#39;pcap&#39; ],
##			       [ Device =&gt; &#39;eth0&#39; ],
##			       [ Filter =&gt; &#39;pcap filter&#39; ],
##			       [ Dispatch =&gt; dispatch_state ],
##			       [ Session =&gt; dispatch_session ],
##			      &#41;
##
sub spawn {
  my $class = shift;
  my %args = @_;

  ## Set default alias if none was given
  $args{ Alias } ||= &#39;pcap&#39;;

  POE::Session-&gt;create&#40;
		       inline_states =&gt; {
					 _start =&gt; \&#38;_start,
					 _stop =&gt; \&#38;_stop,
#					 _signal =&gt; \&#38;_signal,
					 open_live =&gt; \&#38;open_live,
					 set_filter =&gt; \&#38;set_filter,
					 set_dispatch =&gt; \&#38;set_dispatch,
					 run =&gt; \&#38;run,
					 pause =&gt; \&#38;pause,
					 _dispatch =&gt; \&#38;_dispatch,
					 shutdown =&gt; \&#38;shutdown,
					},
		       args =&gt; [
				$args{Alias},	# ARG0
				$args{Filter},	# ARG1
				$args{Session}, # ARG2
				$args{Dispatch},# ARG3
				$args{Device},	# ARG4
			       ],
		      &#41;;

  return $args{ Alias };
}

sub _start {
  my &#40;$kernel, $heap, $session,
      $alias, $filter, $target_session, $target_state, $device &#41;
    = @_[ KERNEL, HEAP, SESSION, ARG0..ARG4 ];

#  print &#34;In state_start for sid &#34;, $session-&gt;ID, &#34;, alias $alias\n&#34;;

  ## Set alias for ourselves and remember it
  $kernel-&gt;alias_set&#40; $alias &#41;;
  $heap-&gt;{Alias} = $alias;


  ## Set dispatch target session and state if it was given
  if&#40; defined&#40; $target_state &#41; &#41; {
    $heap-&gt;{&#39;target_session&#39;} = $target_session;
    $heap-&gt;{&#39;target_state&#39;} = $target_state;
  }

  ## Post an open_live event if device was passed
  $kernel-&gt;post&#40; $session =&gt; open_live =&gt; $device &#41;
    if defined&#40; $device &#41;;

  ## Set filter if it was given
  $kernel-&gt;post&#40; $session =&gt; set_filter =&gt; $filter &#41;
    if defined&#40; $filter &#41;;

#  print &#34;Out state_start for sid &#34;, $session-&gt;ID, &#34;, alias $alias\n&#34;;
}

##
## $kernel-&gt;post&#40; pcap =&gt; open_live =&gt;
##		  [device], [snaplen], [promisc?], [timeout] &#41;
##
sub open_live {
  my &#40; $kernel, $heap,
       $device, $snaplen, $promisc, $timeout,
     &#41; = @_[ KERNEL, HEAP, ARG0..ARG3 ];

  my $err;

  ## Lookup default device if undef was passed
  unless&#40; $device &#41; {
    $device = Net::Pcap::lookupdev&#40; \$err &#41;
      or croak &#34;Can&#39;t lookupdev: $err\n&#34;;
  }

  ## Set `reasonable&#39; defaults for other values
  $snaplen = 80 unless defined&#40; $snaplen &#41;;
  $promisc = 1 unless defined&#40; $promisc &#41;;
  $timeout = 100 unless defined&#40; $timeout &#41;;

  $heap-&gt;{&#39;pcap_t&#39;} = Net::Pcap::open_live&#40; $device, $snaplen,
					    $promisc, $timeout, \$err &#41;
    or croak &#34;Can&#39;t Net::Pcap::open_live $device: $err\n&#34;;

  @{$heap}{ qw/device snaplen
	       promisc timeout fd/ } =
		 &#40;
		  $device, $snaplen, $promisc,
		  $timeout,
		  Net::Pcap::fileno&#40; $heap-&gt;{&#39;pcap_t&#39;} &#41;,
		 &#41;;

=pod

  ## Need an IO::Handle to $kernel-&gt;select_read&#40;&#41; upon
  $heap-&gt;{fdh} = IO::Handle-&gt;new_from_fd&#40; $heap-&gt;{fd}, &#34;r&#34; &#41;
    or die &#34;Can&#39;t create IO::Handle from pcap fd: $!\n&#34;;

=cut

  $heap-&gt;{fdh} = gensym;
  open&#40; $heap-&gt;{fdh}, &#34;&lt;&#38;&#34;.$heap-&gt;{fd} &#41;
    or die &#34;Can&#39;t dup handle from pcap fd: $!\n&#34;;

  1;
}

sub set_filter {
  my &#40; $kernel, $heap, $filter &#41; = @_[ KERNEL, HEAP, ARG0 ];

  croak &#34;open must be called before set_filter \n&#34;
    unless exists $heap-&gt;{&#39;pcap_t&#39;};

  my&#40; $net, $netmask, $err &#41;;
  Net::Pcap::lookupnet&#40; $heap-&gt;{&#39;device&#39;}, \$net, \$netmask, \$err &#41;;

  my $filter_t;
  Net::Pcap::compile&#40; $heap-&gt;{&#39;pcap_t&#39;},
		      \$filter_t, $filter, 1, $netmask &#41; == 0
			or die &#34;Can&#39;t compile filter `$filter&#39;\n&#34;;

  Net::Pcap::setfilter&#40; $heap-&gt;{&#39;pcap_t&#39;}, $filter_t &#41;;
}

##
## $kernel-&gt;post&#40; pcap =&gt; set_dispatch =&gt;
##		  &#39;target_state&#39;, &#39;target_session&#39; &#41;
##
sub set_dispatch {
  my &#40; $heap, $sender, $target_state, $target_session &#41;
    = @_[ HEAP, SENDER, ARG0, ARG1 ];

  ## Target session defaults to the sender
  $target_session ||= $sender;

  if&#40; defined&#40; $target_state &#41; &#41; {
    ## Remember whom to forward packets to
    $heap-&gt;{&#39;target_session&#39;} = $target_session;
    $heap-&gt;{&#39;target_state&#39;} = $target_state;
  } else {
    ## Clear target
    delete $heap-&gt;{&#39;target_session&#39;};
    delete $heap-&gt;{&#39;target_state&#39;};
  }
}

sub run {
  my &#40; $kernel, $heap &#41; = @_[ KERNEL, HEAP ];

  my $flags;

  ## Can&#39;t run unless we&#39;ve got a pcap_t to work with
  croak &#34;open must be called before run \n&#34;
    unless exists $heap-&gt;{&#39;pcap_t&#39;};

  ## XXX Need to save off flags for OpenBSD
  if&#40; $^O eq &#39;openbsd&#39; &#41; {
    $flags = fcntl&#40;$heap-&gt;{fdh}, F_GETFL, 0&#41;
      or croak &#34;fcntl fails with F_GETFL: $!\n&#34;;
  }

  $kernel-&gt;select_read&#40; $heap-&gt;{fdh} =&gt; &#39;_dispatch&#39; &#41;;

  ## XXX OpenBSD&#39;s pcap / bpf devices don&#39;t like being set to
  ## non-blocking for some reason, so restore the saved flags
  if&#40; $^O eq &#39;openbsd&#39; &#41; {
    $flags = fcntl&#40;$heap-&gt;{fdh}, F_SETFL, $flags &#41;
      or croak &#34;fcntl fails with F_SETFL: $!\n&#34;;
  }

}

sub _dispatch {
  my &#40; $kernel, $heap &#41; = @_[ KERNEL, HEAP ];

  if&#40; exists $heap-&gt;{&#39;target_session&#39;} &#41; {
    my @pending;

    ## Get Pcap to pass us any pending packets
    Net::Pcap::dispatch&#40; $heap-&gt;{&#39;pcap_t&#39;}, -1,
			 sub {
			   push @{$_[0]}, [ @_[1,2] ]
			 },
			 \@pending
		       &#41;;

    $kernel-&gt;post&#40; $heap-&gt;{&#39;target_session&#39;},
		   $heap-&gt;{&#39;target_state&#39;},
		   \@pending,
		 &#41;;
  }
}

sub pause {
  ## Remove read select on pcap handle
  $_[KERNEL]-&gt;select_read&#40; $_[HEAP]-&gt;{fdh} &#41; if exists $_[HEAP]-&gt;{fdh};
}

sub shutdown {
  my &#40; $kernel, $heap &#41; = @_[ KERNEL, HEAP ];

  ## Remove read select on pcap handle
  $kernel-&gt;select_read&#40; $heap-&gt;{fdh} &#41; if exists $heap-&gt;{fdh};

  ## Get Net::Pcap to shut down pcap_t
  if&#40; exists $heap-&gt;{&#39;pcap_t&#39;} &#41; {
    Net::Pcap::close&#40; $heap-&gt;{&#39;pcap_t&#39;} &#41;;
    delete @{$heap}{qw/pcap_t fd fdh/}
  }

  $kernel-&gt;alias_remove&#40; $heap-&gt;{Alias} &#41;;
}

sub _stop {
  my &#40; $kernel, $heap, $session &#41; = @_[ KERNEL, HEAP, SESSION ];
  my $alias = $heap-&gt;{Alias};

#  print &#34;In state_stop for sid &#34;, $session-&gt;ID, &#34;, alias $alias\n&#34;;

#  print &#34;Out state_stop for sid &#34;, $session-&gt;ID, &#34;, alias $alias\n&#34;;
}

sub _signal {
  my &#40; $kernel, $heap, $session &#41; = @_[ KERNEL, HEAP, SESSION ];

#  print &#34;Got signal &#34;, $_[ARG0], &#34;\n&#34;;

  return 1;
}

1;

__END__

=head1 NAME

POE::Component::Pcap - POE Interface to Net::Pcap

=head1 SYNOPSIS

  use POE::Component::Pcap;

  POE::Component::Pcap-&gt;spawn&#40;
			      Alias =&gt; &#39;pcap&#39;,
			      Device =&gt; &#39;eth0&#39;,
			      Filter =&gt; &#39;host fooble or host blort&#39;,
			      Dispatch =&gt; &#39;got_packet&#39;,
			      Session =&gt; $my_session_id,
			     &#41;;

  $poe_kernel-&gt;post&#40; pcap =&gt; open_live =&gt;
		     &#39;eth0&#39;, 80, 1, 100 &#41;;

  $poe_kernel-&gt;post&#40; pcap =&gt; set_filter =&gt; &#39;arp or host zooble&#39; &#41;;

  $poe_kernel-&gt;post&#40; pcap =&gt; set_dispatch =&gt; &#39;target_state&#39; &#41;;

  $poe_kernel-&gt;post&#40; pcap =&gt; &#39;run&#39; &#41;;

  $poe_kernel-&gt;post&#40; pcap =&gt; &#39;shutdown&#39; &#41;;

=head1 DESCRIPTION

POE::Component::Pcap provides a wrapper for using the Net::Pcap module
from POE programs.  The component creates a separate session which
posts events to a specified session and state when packets are
available.

=head2 ARGUMENTS

=over 4

=item Alias

The alias for the Pcap session.  Used to post events such as C&lt;run&gt;
and C&lt;shutdown&gt; to control the component.  Defaults to C&lt;pcap&gt; if not
specified.

=item Device

As a shortcut, the device for Net::Pcap to watch may be specified when
creating the component.  If this argument is used,
Net::Pcap::open_live will be called with a snaplen of 80 octets, a
timeout of 100ms, and the interface will be put in promiscuous mode.
If these values are not suitable, post an C&lt;open_live&gt; event instead.

=item Filter

Another shortcut, calls Net::Pcap::compile and Net::Pcap::setfilter to
set a packet filter.  This can only be used if the B&lt;Device&gt; argument
is also given; otherwise a C&lt;set_filter&gt; event should be posted after
an C&lt;open_live&gt; event &#40;since Net::Pcap must have a C&lt;pcap_t&gt;
descriptor to work with&#41;.

=item Dispatch

=item Session

These specify the session and state to which events should be posted
when packets are received.

=back

=head2 EVENTS

The following examples assume that the component&#39;s alias has been set
to the default value of B&lt;pcap&gt;.

=over 4

=item open_live

  $_[KERNEL]-&gt;post&#40; pcap =&gt; open_live
		    =&gt; &#39;device&#39;, [snaplen], [promsic?], [timeout] &#41;;

Calls Net::Pcap::open_live.  The device name must be specified.  The
snaplen, promiscuous, and timeout parameters default to 80, 1, and 100
respectively.  This event must be posted &#40;or the B&lt;Device&gt; argument
must have been passed to spawn&#40;&#41;&#41; before anything else can be done
with the component.

=item set_filter

  $_[KERNEL]-&gt;post&#40; pcap =&gt; set_filter
		    =&gt; &#39;host fooble or host blort&#39; &#41;

Sets the Net::Pcap capture filter.  See tcpdump&#40;8&#41; for details on the
filter language used by pcap&#40;3&#41;.

=item set_dispatch

  $_[KERNEL]-&gt;post&#40; pcap =&gt; set_dispatch
		    =&gt; &#39;target_state&#39;, &#39;target_session&#39; &#41;;

Sets the state and session to which events are sent when packets are
recevied.  The target session will default to the sender of the event
if not specified.

The event posted will have a single argument &#40;available as B&lt;ARG0&gt;&#41;
which will be an array reference containing the C&lt;$hdr&gt; and C&lt;$pkt&gt;
parameters from Net::Pcap.  See the Net::Pcap&#40;3&#41; documentation for
more details.

=item run

  $_[KERNEL]-&gt;post&#40; pcap =&gt; &#39;run&#39; &#41;;

Causes the component to register a select_read and start watching for
packets.

=item shutdown

  $_[KERNEL]-&gt;post&#40; pcap =&gt; &#39;shutdown&#39; &#41;;

Shuts the component down.  Causes Net::Pcap::close to be called.

=back

=head1 SEE ALSO

Net::Pcap&#40;3&#41;, pcap&#40;3&#41;, tcpdump&#40;8&#41;, POE&#40;3&#41;, POE::Component&#40;3&#41;

=head1 AUTHOR

Mike Fletcher, &lt;fletch@phydeaux.org&gt;

=head1 COPYRIGHT

Copyright 2000-2001, Mike Fletcher.  All Rights Reserved.  This is
free software; you may redistribute it and/or modify it under the same
terms as Perl itself.

=cut
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-74055" href="/Public/Bug/Display.html?id=1663#txn-74055">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;08&nbsp;12:51:13&nbsp;2003</span>
    <span class="description">fletch+cpan [...] phydeaux.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-74056" href="/Public/Bug/Display.html?id=1663#txn-74056">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;08&nbsp;12:51:13&nbsp;2003</span>
    <span class="description">fletch+cpan [...] phydeaux.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/74056/10122/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/10122">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 25b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Put version 0.04 on CPAN.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.485065</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
