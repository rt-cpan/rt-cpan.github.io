<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #95452 for IO-Socket-SSL: dh initialization at BEGIN time breaks perlcc and other perl code compilers.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #95452 for IO-Socket-SSL: dh initialization at BEGIN time breaks perlcc and other perl code compilers.</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/IO-Socket-SSL/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/IO-Socket-SSL/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/IO-Socket-SSL/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/IO-Socket-SSL/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/IO-Socket-SSL">IO-Socket-SSL CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">95452</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/IO-Socket-SSL/Active/">IO-Socket-SSL</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
TODDR [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-17228-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.958    </td>
  </tr>
  <tr id="CF-17229-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;07&nbsp;17:49:40&nbsp;2014</span>
    <span class="description">TODDR [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dh initialization at BEGIN time breaks perlcc and other perl code
 compilers.</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry for the slow report. This broke in 1.958. When you re-run a program with a frozen handle on a new process, it causes a segfault. Patch coming shortly.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;07&nbsp;17:55:40&nbsp;2014</span>
    <span class="description">TODDR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/noxxi/p5-io-socket-ssl/pull/13">https://github.com/noxxi/p5-io-socket-ssl/pull/13</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;07&nbsp;18:08:39&nbsp;2014</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed May 07 17:49:40 2014, TODDR wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sorry for the slow report. This broke in 1.958. When you re-run a
&gt; program with a frozen handle on a new process, it causes a segfault.
&gt; Patch coming shortly.
</div>

Sorry, but I don&#39;t understand what you mean with &#34;re-run a program with a frozen handle on a new process&#34;. Can you provide some code to reproduce the problem?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;07&nbsp;18:08:39&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;07&nbsp;18:17:28&nbsp;2014</span>
    <span class="description">TODDR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sorry, but I don&#39;t understand what you mean with &#34;re-run a program
&gt; with a frozen handle on a new process&#34;. Can you provide some code to
&gt; reproduce the problem?
</div>
perlcc allows you to build a binary with a frozen state of the program as of the BEGIN block. This allows for very fast program execution, allowing you to run perl programs via CGI you wouldn&#39;t normally be able to do. 

This is the original reported issue to perlcc or B::C, which is the module.

<span class="clickylink"><a target="new" rel="nofollow" href="https://code.google.com/p/perl-compiler/issues/detail?id=317">https://code.google.com/p/perl-compiler/issues/detail?id=317</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;07&nbsp;18:32:04&nbsp;2014</span>
    <span class="description">rurban [...] x-ray.at -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rurban [...] x-ray.at</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">In detail, to reproduce it, force install perlcc &#40;B::C&#41; and do

perlcc -S -O3 -r -e&#39;use Net::SSLeay&#40;&#41;;
  use IO::Socket::SSL&#40;&#41;;
  Net::SSLeay::OpenSSL_add_ssl_algorithms&#40;&#41;; 
  my $ssl_ctx = IO::Socket::SSL::SSL_Context-&gt;new&#40;SSL_server =&gt; 1&#41;; print q&#40;ok&#41;&#39;

$dh in %DEFAULT_SSL_SERVER_ARGS will be a random handle to the memory location of the Net::SSLeay library, and this handle needs to be initialized at run-time, not compile-time.

Basically the same issue as [cpan #94069] with Net::DNS and Encode, using Encode XS handles at compile-time.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;08&nbsp;14:18:17&nbsp;2014</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed May 07 18:32:04 2014, rurban@x-ray.at wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In detail, to reproduce it, force install perlcc &#40;B::C&#41; and do
&gt; 
&gt; perlcc -S -O3 -r -e&#39;use Net::SSLeay&#40;&#41;;
&gt;   use IO::Socket::SSL&#40;&#41;;
&gt;    Net::SSLeay::OpenSSL_add_ssl_algorithms&#40;&#41;;
&gt;   my $ssl_ctx = IO::Socket::SSL::SSL_Context-&gt;new&#40;SSL_server =&gt; 1&#41;;
&gt; print q&#40;ok&#41;&#39;
&gt; 
&gt; $dh in %DEFAULT_SSL_SERVER_ARGS will be a random handle to the memory
&gt; location of the Net::SSLeay library, and this handle needs to be
&gt; initialized at run-time, not compile-time.
</div>
Hi,
as far as I understand your problem it boils down to using non-perl Code &#40;e.g. XS module&#41; and perlcc fails to freeze the state of this code and restore it later. In this case I don&#39;t think that the issue can be solved for IO::Socket::SSL. It could be resolved for the special case of the SSL_dh parameter, but there are other initializations in the code which cannot be fixed this way:
- when loading IO::Socket::SSL it will run various initialization, e.g. to add algorithms, load error strings etc. 
- According to Net::SSLeay &#40;see the part about threading&#41; these kind of initializations should be done in the main program, and not in each thread in the case of multithreaded programs. Otherwise this might lead to strange crashes &#40;and I&#39;ve seen such crashes when people try to require IO::Socket::SSL per thread&#41;.
- so just doing these initializations on first use, like you do with the SSL_dh parameter, is not an option, because the first use might not be in the main thread.

So currently I see no way to solve the problem in a way which does not introduce worse problems. And just fixing the SSL_dh case and leaving the other problems in also not an option for me, because it only fixes part of the problem, but obscures the rest so it might make it even harder too debug.

That&#39;s why I will set this bug for now at rejected, but if you have a good idea, how the whole issue can be resolved without creating new problems feel free to reopen it.

Sorry for not being that helpful,
Steffen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;08&nbsp;14:18:18&nbsp;2014</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;11&nbsp;10:19:08&nbsp;2014</span>
    <span class="description">RURBAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu May 08 14:18:17 2014, SULLR wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed May 07 18:32:04 2014, rurban@x-ray.at wrote:
<div class="message-stanza open">&gt; &gt; In detail, to reproduce it, force install perlcc &#40;B::C&#41; and do
&gt; &gt;
&gt; &gt; perlcc -S -O3 -r -e&#39;use Net::SSLeay&#40;&#41;;
&gt; &gt;   use IO::Socket::SSL&#40;&#41;;
&gt; &gt;    Net::SSLeay::OpenSSL_add_ssl_algorithms&#40;&#41;;
&gt; &gt;   my $ssl_ctx = IO::Socket::SSL::SSL_Context-&gt;new&#40;SSL_server =&gt; 1&#41;;
&gt; &gt; print q&#40;ok&#41;&#39;
&gt; &gt;
&gt; &gt; $dh in %DEFAULT_SSL_SERVER_ARGS will be a random handle to the memory
&gt; &gt; location of the Net::SSLeay library, and this handle needs to be
&gt; &gt; initialized at run-time, not compile-time.
</div>&gt; 
&gt; Hi,
&gt; as far as I understand your problem it boils down to using non-perl
&gt; Code &#40;e.g. XS module&#41; and perlcc fails to freeze the state of this
&gt; code and restore it later. In this case I don&#39;t think that the issue
&gt; can be solved for IO::Socket::SSL. It could be resolved for the
&gt; special case of the SSL_dh parameter, but there are other
&gt; initializations in the code which cannot be fixed this way:
&gt;  - when loading IO::Socket::SSL it will run various initialization,
&gt; e.g. to add algorithms, load error strings etc.
&gt; - According to Net::SSLeay &#40;see the part about threading&#41; these kind
&gt; of initializations should be done in the main program, and not in each
&gt; thread in the case of multithreaded programs. Otherwise this might
&gt; lead to strange crashes &#40;and I&#39;ve seen such crashes when people try to
&gt; require IO::Socket::SSL per thread&#41;.
&gt; - so just doing these initializations on first use, like you do with
&gt; the SSL_dh parameter, is not an option, because the first use might
&gt; not be in the main thread.
&gt; 
&gt; So currently I see no way to solve the problem in a way which does not
&gt; introduce worse problems. And just fixing the SSL_dh case and leaving
&gt; the other problems in also not an option for me, because it only fixes
&gt; part of the problem, but obscures the rest so it might make it even
&gt; harder too debug.
&gt; 
&gt; That&#39;s why I will set this bug for now at rejected, but if you have a
&gt; good idea, how the whole issue can be resolved without creating new
&gt; problems feel free to reopen it.
&gt; 
&gt; Sorry for not being that helpful,
&gt; Steffen
</div>
&lt;rant&gt;I really start wondering now why most germans are so unhelpful and don&#39;t understand the simple technical issues and solutions behind.&lt;/rant&gt;

Only the compile-time dh handle is a problem, not any other Net::SSLeay handles. And only IO::Socket::SSL is to blame, not any other causes.

For people running into this problem &#40;creating a compiled IO::Socket::SSL server&#41;, please use our dropin fork cPanel::IO::Socket::SSL.

-- 
Reini Urban
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;11&nbsp;13:43:06&nbsp;2014</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;rant&gt;I really start wondering now why most germans are so unhelpful
&gt; and don&#39;t understand the simple technical issues and solutions
&gt; behind.&lt;/rant&gt;
</div>
I feel sorry for you that you have this kind of experiences. 
These germans must be really terrible.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Only the compile-time dh handle is a problem, not any other
&gt; Net::SSLeay handles. And only IO::Socket::SSL is to blame, not any
&gt; other causes.
</div>
I will try to illustrate my point with a simple code:

   use IO::Socket::SSL; 
   my $cl = IO::Socket::SSL-&gt;new&#40;&#34;www.google.de:443&#34;&#41; or die &#34;$!,$SSL_ERROR&#34;; 
   print $cl-&gt;peer_certificate&#40;&#34;subject&#34;&#41;;

This code connects to google and prints the certificate information. It works fine with plain perl, e.g. without perlcc. It also compiles without problems with perlcc but the compiled program will not work. It will not crash &#40;there is is SSL_dh* on the client side, so it is not affected by the issue&#41; but it will not be able to SSL connect to google.

But, if you add Net::SSLeay::add_ssl_algorithms&#40;&#41; before trying to connect, the compiled version will work too because this function initializes the internal OpenSSL structures. And while these structures already got initialized by calling this function inside IO::Socket::SSL during compile time, the initialization got lost during compilation with perlcc because it is inside a C library and not in Perl variables.

With the argumentation from <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/noxxi/p5-io-socket-ssl/pull/13">https://github.com/noxxi/p5-io-socket-ssl/pull/13</a></span> one should move the OpenSSL initialization from compile time to run time, i.e. do it on first use like done with SSL_dh in this patch. But inside a multithreaded program the first use might not happen in the main thread, which might cause the application to crash &#40;see thread safety documentation for Net::SSLeay and OpenSSL&#41;.

So a safe place might be to do any such initialization but before run time, so that it will be the first thing the compiled binary does, i.e. before executing any user code which depends on the finished initialization. From experiments with perlcc it looks like, that INIT would be the correct place to do this, am I right? In this case I could reopen the bug and try to move all the initialization into INIT.

Regards,
the terrible german.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;11&nbsp;17:52:01&nbsp;2014</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; From experiments with perlcc it looks like, that INIT
&gt; would be the correct place to do this, am I right? In this case I
&gt; could reopen the bug and try to move all the initialization into INIT.
</div>
fixed in 1.995 by moving the relevant parts into INIT section. This fixes both the problem with SSL_dh and additionally it is no longer needed to explicitly call Net::SSLeay::add_ssl_algorithms&#40;&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;11&nbsp;17:52:02&nbsp;2014</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Status changed from &#39;rejected&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;12&nbsp;07:48:13&nbsp;2014</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; fixed in 1.995 by moving the relevant parts into INIT section. This
&gt; fixes both the problem with SSL_dh and additionally it is no longer
&gt; needed to explicitly call Net::SSLeay::add_ssl_algorithms&#40;&#41;.
</div>
Unfortunately this breaks if IO::Socket::SSL is not included with &#39;use&#39; but &#39;require&#39;, with and without perlcc. So with 1.996 there is a separate function init which is called at compile time and need to be called explicitly if the module is included with &#39;use&#39; and perlcc is used. This behavior is also documented.

If perlcc would make a variable available, so that one could detect if the code running from a compiled binary one could probable remove this workaround. At the moment one could compare the process ids from the BEGIN block with the INIT block, but this only works in most cases and fails if the pid of perlcc matches the pid of the process if executed later.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;12&nbsp;13:29:27&nbsp;2014</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If perlcc would make a variable available, so that one could detect if
&gt; the code running from a compiled binary one could probable remove this
&gt; workaround. At the moment one could compare the process ids from the
&gt; BEGIN block with the INIT block, but this only works in most cases and
&gt; fails if the pid of perlcc matches the pid of the process if executed
&gt; later.
</div>
Fortunatly I&#39;ve found out that for all supported version of Net::SSLeay library_init&#40;&#41; returns if the initialization was needed or not and does this based on a variable in C-code. This makes it possible to encapsulate the support for perlcc completly inside IO::Socket::SSL, i.e. no more workarounds needed for a user of perlcc. It also does not need to explicitly call Net::SSLeay::OpenSSL_add_ssl_algorithms with perlcc, like still needed by cPanel::IO::Socket::SSL.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
