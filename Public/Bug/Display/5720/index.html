<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #5720 for Module-Build: Module::Build doesn&#39;t work well with version.pm</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #5720 for Module-Build: Module::Build doesn&#39;t work well with version.pm</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Module-Build">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Module-Build">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Module-Build">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Module-Build">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Module-Build">Module-Build CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">5720</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Module-Build">Module-Build</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
trevor.schellhorn-perl [...] marketingtips.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-21558-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.24    </td>
  </tr>
  <tr id="CF-21559-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




module-build-use-version.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/99933/22693/module-build-use-version.patch">
Mon Sep 20 14:34:41 2004 (6.3k) by 
</a>
</font></li>
</ul>


version.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/99925/17364/version.patch">
Thu Mar 18 22:49:23 2004 (819b) by 
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/99924/17361/version.patch">
Thu Mar 18 20:28:46 2004 (433b) by 
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=5720">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-99924" href="/Public/Bug/Display.html?id=5720#txn-99924">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;18&nbsp;20:28:46&nbsp;2004</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Module::Build doesn&#39;t work well with version.pm</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/99924/17360/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/17360">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 526b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">We have started to use Module::Build for building our module.  Unfortunately, we have run into a problem in regards to determining the version from our modules.  Our $VERSION is determined using the version module.  The method that determines the $VERSION from the module creates a package.  It does not load any other modules.  To determine the version from our modules, the following patch was used to fix the bug/feature of Module::Build.

We are using the latest version of Module::Build on perl 5.8.0 on Redhat Linux 8.0.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/99924/17361/version.patch">Download version.patch</a><br />
<span class="downloadcontenttype">text/x-diff 433b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- lib/Module/Build/Base.pm	2004-02-25 13:57:59.000000000 -0800
+++ lib/Module/Build/Base.pm	2004-03-18 17:19:26.000000000 -0800
@@ -477,6 +477,7 @@
   my $match = qr/&#40;[\$*]&#41;&#40;&#40;[\w\:\&#39;]*&#41;\bVERSION&#41;\b.*\=/;
   my &#40;$v_line, $sigil, $var&#41; = $self-&gt;_next_code_line&#40;$fh, $match&#41; or return undef;
 
+  eval { require version };
   my $eval = qq{q#  Hide from _packages_inside&#40;&#41;
 		 #; package Module::Build::Base::_version;
 		 no strict;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-99925" href="/Public/Bug/Display.html?id=5720#txn-99925">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;18&nbsp;22:49:23&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> trevor.schellhorn-perl [...] marketingtips.com</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/99925/17363/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/17363">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 760b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Thu Mar 18 20:28:46 2004]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; We have started to use Module::Build for building our module.
&gt;    Unfortunately, we have run into a problem in regards to determining
&gt;    the version from our modules.  Our $VERSION is determined using the
&gt;    version module.  The method that determines the $VERSION from the
&gt;    module creates a package.  It does not load any other modules.  To
&gt;    determine the version from our modules, the following patch was
&gt;    used to fix the bug/feature of Module::Build.
&gt; 
&gt; We are using the latest version of Module::Build on perl 5.8.0 on
&gt;    Redhat Linux 8.0.
</div>

I have updated the patch to handle something that I didn&#39;t catch in the
first round.  This now gets the proper version string instead of a
version object.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/99925/17364/version.patch">Download version.patch</a><br />
<span class="downloadcontenttype">text/x-diff 819b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- lib/Module/Build/Base.pm.orig	2004-03-18 19:38:02.000000000 -0800
+++ lib/Module/Build/Base.pm	2004-03-18 19:37:39.000000000 -0800
@@ -477,6 +477,9 @@
   my $match = qr/&#40;[\$*]&#41;&#40;&#40;[\w\:\&#39;]*&#41;\bVERSION&#41;\b.*\=/;
   my &#40;$v_line, $sigil, $var&#41; = $self-&gt;_next_code_line&#40;$fh, $match&#41; or return undef;
 
+  # Load the version module if it is installed
+  eval { require version };
+
   my $eval = qq{q#  Hide from _packages_inside&#40;&#41;
 		 #; package Module::Build::Base::_version;
 		 no strict;
@@ -489,6 +492,12 @@
   local $^W;
   my $result = eval $eval;
   warn &#34;Error evaling version line &#39;$eval&#39; in $file: $@\n&#34; if $@;
+
+  # Check if the result is blessed in the version class.
+  if&#40; ref&#40; $result &#41; eq &#39;version&#39; &#41; {
+    # Get the value out of the version object
+    $result = &#34;$result&#34;;
+  }
   return $result;
 }
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-99926" href="/Public/Bug/Display.html?id=5720#txn-99926">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;12&nbsp;23:17:10&nbsp;2004</span>
    <span class="description">kwilliams [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/99926/22474/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/22474">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 484b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Trevor,

Sorry to seem like an obstacle on this, but I think the first part of the patch, always loading 
version.pm if it&#39;s installed, is probably a bad idea.  There are cases when authors don&#39;t 
expect version.pm to be loaded, and sometimes their code will break if it is &#40;as happened 
when I did it for Module::Build itself&#41;.

Can you think of any other way to resolve this?  Maybe just try to load version.pm if the 
version-finding code doesn&#39;t compile the first time?

 -Ken
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-99927" href="/Public/Bug/Display.html?id=5720#txn-99927">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;12&nbsp;23:17:11&nbsp;2004</span>
    <span class="description">kwilliams [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-99928" href="/Public/Bug/Display.html?id=5720#txn-99928">#</a>      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;14&nbsp;19:53:35&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> trevor.schellhorn-perl [...] marketingtips.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/99928/22530/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/22530">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">[KWILLIAMS - Sun Sep 12 23:17:10 2004]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Trevor,
&gt; 
&gt; Sorry to seem like an obstacle on this, but I think the first part of
&gt; the patch, always loading
&gt; version.pm if it&#39;s installed, is probably a bad idea.  There are cases
&gt; when authors don&#39;t
&gt; expect version.pm to be loaded, and sometimes their code will break if
&gt; it is &#40;as happened
&gt; when I did it for Module::Build itself&#41;.
&gt; 
&gt; Can you think of any other way to resolve this?  Maybe just try to
&gt; load version.pm if the
&gt; version-finding code doesn&#39;t compile the first time?
&gt; 
&gt;  -Ken
</div>

Hey Ken,

I have been thinking about this for a couple days now.  We could remove
that autoloading of the &#39;version&#39; module until it fails.  The problem I
see with this is if the first module that it tries to check the version
of uses the &#39;version&#39; module, it will then be loaded.  After that, any
modules that are not expecting it to be loaded will have no choice.  As
far as I am aware, there is no way to &#39;unload&#39; a module from memory.

Let me know what you think of this.  It might need to be put up for
discussion on the mailing list for Module::Build or even for something
higher up.  This kind of a change will also impact the
ExtUtils::MakeMaker routines too.

Trevor
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-99929" href="/Public/Bug/Display.html?id=5720#txn-99929">#</a>      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;15&nbsp;09:03:06&nbsp;2004</span>
    <span class="description">kwilliams [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/99929/22551/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/22551">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 765b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hey Trevor,

Your comment about &#34;unloading a module&#34; made me think of something.  Try the following 
patch.  I&#39;d be willing to put it in if it works, as it&#39;s less invasive:

=================================
--- lib/Module/Build/Base.pm    12 Sep 2004 03:09:44 -0000      1.331
+++ lib/Module/Build/Base.pm    15 Sep 2004 13:02:06 -0000
@@ -528,8 +528,15 @@
                 }; \$$var
                };
   local $^W;
+  local *UNIVERSAL::VERSION = \&#38;UNIVERSAL::VERSION;
+  eval {require version};
+
   my $result = eval $eval;
   warn &#34;Error evaling version line &#39;$eval&#39; in $file: $@\n&#34; if $@;
+
+  # Unbless it if it&#39;s a version.pm object
+  $result = &#34;$result&#34; if UNIVERSAL::isa&#40; $result, &#39;version&#39; &#41;;
+
   return $result;
 }
 
=================================
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-99931" href="/Public/Bug/Display.html?id=5720#txn-99931">#</a>      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;16&nbsp;18:01:12&nbsp;2004</span>
    <span class="description">kwilliams [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/99931/22609/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/22609">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 658b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">[trevor.schellhorn-perl@marketingtips.com - Wed Sep 15 13:39:27 2004]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Ken,
&gt; 
&gt; I applied the patch and it worked with perl 5.8.3.  It doesn&#39;t work
&gt; with perl 5.8.0.  In our environment, we are still using perl 5.8.0.
&gt; I am not sure where the issue arises with perl 5.8.0 as two test 
</div>cases
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; cause a Segmentation Fault.  They are t/basic.t and t/manifypods.t.
&gt; It happens just after test 6 in basic.t and just after test 14 in
&gt; manifypods.t.
</div>
Yowch!  If this is purely a 5.8.0 issue, then maybe we just change the 
important line to 

 local *UNIVERSAL::VERSION = \&#38;UNIVERSAL::VERSION unless $] == 5.008;

Does that eliminate the segfault?

 -Ken
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-99932" href="/Public/Bug/Display.html?id=5720#txn-99932">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;17&nbsp;00:36:53&nbsp;2004</span>
    <span class="description">kwilliams [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/99932/22619/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/22619">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Looks like this crashes on 5.6.1 too.  I think the problem is local&#40;&#41; - let&#39;s try the following 
patch instead:

Index: lib/Module/Build/Base.pm
=========================================================
==========
RCS file: /cvsroot/module-build/Module-Build/lib/Module/Build/Base.pm,v
retrieving revision 1.331
diff -u -r1.331 Base.pm
--- lib/Module/Build/Base.pm    12 Sep 2004 03:09:44 -0000      1.331
+++ lib/Module/Build/Base.pm    17 Sep 2004 04:33:38 -0000
@@ -528,8 +528,20 @@
                 }; \$$var
                };
   local $^W;
+
+  # version.pm will change the -&gt;VERSION method, so we mitigate the
+  # potential effects here.  Unfortunately local&#40;*UNIVERSAL::VERSION&#41;
+  # will crash perl &lt; 5.8.1.
+
+  my $old_version = \&#38;UNIVERSAL::VERSION;
+  eval {require version};
   my $result = eval $eval;
+  *UNIVERSAL::VERSION = $old_version;
   warn &#34;Error evaling version line &#39;$eval&#39; in $file: $@\n&#34; if $@;
+
+  # Unbless it if it&#39;s a version.pm object
+  $result = &#34;$result&#34; if UNIVERSAL::isa&#40; $result, &#39;version&#39; &#41;;
+
   return $result;
 }
 
=========================================================
==========
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-99933" href="/Public/Bug/Display.html?id=5720#txn-99933">#</a>      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;20&nbsp;14:34:41&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> DGOLDEN</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/99933/22692/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/22692">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I just ran into this myself and am coming up to speed on the issue.  Is
there a reason why Module::Build can&#39;t use version.pm itself internally?

I&#39;ve tried some quick hacks on 0.25_03 to add &#34;use version&#34; at the top
of Base.pm and then some modifications of the version_from_file&#40;&#41;
routine to use version.pm to parse whatever it finds in the VERSION line
in the file under examination.

The major things that appear to break in the test scripts are the
distribution directory naming scheme and the metadata generation.

The former can be fixed by numifying the version object, though this
somewhat defeats the purpose of using version.  It would be nice if
$VERSION=version-&gt;new&#40;&#34;0.25_3&#34;&#41; generated a distribution like
&#34;module-0.250_003.tar.gz&#34;

The latter seems to break because it uses &#34;$build-&gt;VERSION&#34; in the test
script &#40;after version.pm replaces VERSION&#41;, but Base.pm always uses
&#34;$Module::Build::VERSION&#34; which isn&#39;t a version object.  Having
Module::Build define its version with version.pm fixes that.

The major backward incompatibilities would appear to be in the
numification of versions for use in naming distribution
directories/tarfiles.  &#40;I.e. version-&gt;new&#40;0.01&#41; becomes &#34;0.010&#34;&#41;  But
then, if the version numbering direction for perl 5.10 goes forward,
then this hurdle will have to be addressed sooner rather than later. 
Perhaps a change could be made with a flag for backwards compatible
numbering of distributions.

The attached patch passes the current Module::Build test suite &#40;with one
change to a single test&#41; &#40;at least on perl 5.8.3 on linux&#41;.  This was
some quick and dirty hacking, so I don&#39;t suggest taking it verbatim, but
it suggests what few changes could be considered to utilize version.pm
without resorting to local UNIVERSAL::VERSION adjustments.  It also
works for a module I&#39;m working on that defines
$VERSION=version-&gt;new&#40;&#34;0.2.1&#34;&#41; and it correctly converts that to
0.002001 for creating a distribution name, etc.

Offered in the hope of stimulating discussion -- let me know if I can
help in some way to take this forward.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/99933/22693/module-build-use-version.patch">Download module-build-use-version.patch</a><br />
<span class="downloadcontenttype">text/x-diff 6.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: t/Sample/META.yml
===================================================================
--- t/Sample/META.yml	&#40;revision 7&#41;
+++ t/Sample/META.yml	&#40;revision 9&#41;
@@ -13,4 +13,4 @@
     version: 0.01
   Sample::NoPod:
     file: lib/Sample/NoPod.pm
-generated_by: Module::Build version 0.25_03
+generated_by: Module::Build version 0.250_030
Index: t/basic.t
===================================================================
--- t/basic.t	&#40;revision 7&#41;
+++ t/basic.t	&#40;revision 9&#41;
@@ -2,6 +2,7 @@
 
 use strict;
 use Test;
+use version;
 BEGIN { plan tests =&gt; 37 }
 use Module::Build;
 ok&#40;1&#41;;
@@ -64,7 +65,7 @@
   # Make sure check_installed_status&#40;&#41; works as a class method
   my $info = Module::Build-&gt;check_installed_status&#40;&#39;File::Spec&#39;, 0&#41;;
   ok $info-&gt;{ok}, 1;
-  ok $info-&gt;{have}, $File::Spec::VERSION;
+  ok $info-&gt;{have}, File::Spec-&gt;VERSION;
 
   # Make sure check_installed_status&#40;&#41; works with an advanced spec
   $info = Module::Build-&gt;check_installed_status&#40;&#39;File::Spec&#39;, &#39;&gt; 0&#39;&#41;;
Index: lib/Module/Build/Base.pm
===================================================================
--- lib/Module/Build/Base.pm	&#40;revision 7&#41;
+++ lib/Module/Build/Base.pm	&#40;revision 9&#41;
@@ -11,6 +11,7 @@
 use File::Compare &#40;&#41;;
 use Data::Dumper &#40;&#41;;
 use IO::File &#40;&#41;;
+use version &#40;&#41;;
 
 #################### Constructors ###########################
 sub new {
@@ -42,7 +43,7 @@
 	 &#34;   but we are now using &#39;$perl&#39;.\n&#34;&#41;;
   }
   
-  my $mb_version = $Module::Build::VERSION;
+  my $mb_version = Module::Build-&gt;VERSION;
   die&#40;&#34; * ERROR: Configuration was initially created with Module::Build version &#39;$self-&gt;{properties}{mb_version}&#39;,\n&#34;.
       &#34;   but we are now using version &#39;$mb_version&#39;.  Please re-run the Build.PL or Makefile.PL script.\n&#34;&#41;
     unless $mb_version eq $self-&gt;{properties}{mb_version};
@@ -89,7 +90,7 @@
 				   recommends      =&gt; {},
 				   build_requires  =&gt; {},
 				   conflicts       =&gt; {},
-				   mb_version      =&gt; $Module::Build::VERSION,
+				   mb_version      =&gt; Module::Build-&gt;VERSION,
 				   build_elements  =&gt; [qw&#40; PL support pm xs pod script &#41;],
 				   installdirs     =&gt; &#39;site&#39;,
 				   install_path    =&gt; {},
@@ -463,7 +464,7 @@
   
   my $version_from = File::Spec-&gt;catfile&#40; split &#39;/&#39;, $p-&gt;{dist_version_from} &#41;;
   
-  return $p-&gt;{dist_version} = $self-&gt;version_from_file&#40;$version_from&#41;;
+  return $p-&gt;{dist_version} = 0 + $self-&gt;version_from_file&#40;$version_from&#41;-&gt;numify;
 }
 
 sub dist_author   { shift-&gt;_pod_parse&#40;&#39;author&#39;&#41;   }
@@ -517,20 +518,11 @@
 
   my $match = qr/&#40;[\$*]&#41;&#40;&#40;[\w\:\&#39;]*&#41;\bVERSION&#41;\b.*\=/;
   my &#40;$v_line, $sigil, $var&#41; = $self-&gt;_next_code_line&#40;$fh, $match&#41; or return undef;
-
-  my $eval = qq{q#  Hide from _packages_inside&#40;&#41;
-		 #; package Module::Build::Base::_version;
-		 no strict;
-		    
-		 local $sigil$var;
-		 \$$var=undef; do {
-		   $v_line
-		 }; \$$var
-		};
   local $^W;
-  my $result = eval $eval;
-  warn &#34;Error evaling version line &#39;$eval&#39; in $file: $@\n&#34; if $@;
-  return $result;
+  my &#40;$v_set&#41; = $v_line =~ /VERSION\b.*?=&#40;.*&#41;/;
+  my $v_val = eval $v_set;
+  warn &#34;Error getting version from &#39;$v_val&#39; in $file: $@\n&#34; if $@;
+  return version-&gt;new&#40; &#34;$v_val&#34; &#41;;
 }
 
 sub _persistent_hash_write {
@@ -733,16 +725,9 @@
   # Check the current perl interpreter
   # It&#39;s much more convenient to use $] here than $^V, but &#39;man
   # perlvar&#39; says I&#39;m not supposed to.  Bloody tyrant.
-  return $^V ? $self-&gt;perl_version_to_float&#40;sprintf &#34;%vd&#34;, $^V&#41; : $];
+  return version-&gt;new&#40; &#34;$]&#34; &#41;;
 }
 
-sub perl_version_to_float {
-  my &#40;$self, $version&#41; = @_;
-  $version =~ s/\./../;
-  $version =~ s/\.&#40;\d+&#41;/sprintf &#39;%03d&#39;, $1/eg;
-  return $version;
-}
-
 sub _parse_conditions {
   my &#40;$self, $spec&#41; = @_;
 
@@ -760,7 +745,7 @@
   if &#40;$modname eq &#39;perl&#39;&#41; {
     $status{have} = $self-&gt;perl_version;
   
-  } elsif &#40;eval { no strict; $status{have} = ${&#34;${modname}::VERSION&#34;} }&#41; {
+  } elsif &#40;eval { no strict; $status{have} = $modname-&gt;VERSION }&#41; {
     # Don&#39;t try to load if it&#39;s already loaded
     
   } else {
@@ -783,7 +768,7 @@
     my &#40;$op, $version&#41; = /^\s*  &#40;&lt;=?|&gt;=?|==|!=&#41;  \s*  &#40;[\w.]+&#41;  \s*$/x
       or die &#34;Invalid prerequisite condition &#39;$_&#39; for $modname&#34;;
     
-    $version = $self-&gt;perl_version_to_float&#40;$version&#41;
+    $version = version-&gt;new&#40;&#34;$version&#34;&#41;
       if $modname eq &#39;perl&#39;;
     
     next if $op eq &#39;&gt;=&#39; and !$version;  # Module doesn&#39;t have to actually define a $VERSION
@@ -801,11 +786,7 @@
 sub compare_versions {
   my $self = shift;
   my &#40;$v1, $op, $v2&#41; = @_;
-
-  # for alpha versions - this doesn&#39;t cover all cases, but should work for most:
-  $v1 =~ s/_&#40;\d+&#41;\z/$1/;
-  $v2 =~ s/_&#40;\d+&#41;\z/$1/;
-
+  $_ = version-&gt;new&#40;$_&#41; for &#40;$v1, $v2&#41;;
   my $eval_str = &#34;\$v1 $op \$v2&#34;;
   my $result   = eval $eval_str;
   warn &#34;error comparing versions: &#39;$eval_str&#39; $@&#34; if $@;
@@ -2044,7 +2025,7 @@
 @{[ join &#34;\n&#34;, map &#34;  - $_&#34;, @{$self-&gt;dist_author} ]}
 abstract: @{[ $self-&gt;dist_abstract ]}
 license: $p-&gt;{license}
-generated_by: Module::Build version $Module::Build::VERSION, without YAML.pm
+generated_by: Module::Build version $p-&gt;{mb_version}, without YAML.pm
 END_OF_META
 
   $fh-&gt;close&#40;&#41;;
@@ -2098,10 +2079,10 @@
   $node-&gt;{dynamic_config} = $p-&gt;{dynamic_config} if exists $p-&gt;{dynamic_config};
   $node-&gt;{provides} = $self-&gt;find_dist_packages;
 
-  $node-&gt;{generated_by} = &#34;Module::Build version $Module::Build::VERSION&#34;;
+  $node-&gt;{generated_by} = &#34;Module::Build version $p-&gt;{mb_version}&#34;;
   
   # YAML API changed after version 0.30
-  my $yaml_sub = $YAML::VERSION le &#39;0.30&#39; ? \&#38;YAML::StoreFile : \&#38;YAML::DumpFile;
+  my $yaml_sub = YAML-&gt;VERSION le &#39;0.30&#39; ? \&#38;YAML::StoreFile : \&#38;YAML::DumpFile;
   return $self-&gt;{wrote_metadata} = $yaml_sub-&gt;&#40;$self-&gt;{metafile}, $node &#41;;
 }
 
@@ -2140,7 +2121,7 @@
     
     foreach my $package &#40;$self-&gt;_packages_inside&#40;$localfile&#41;&#41; {
       $out{$package}{file} = $dist_files{$file};
-      $out{$package}{version} = $version if defined $version;
+      $out{$package}{version} = 0+$version-&gt;numify if defined $version;
     }
   }
   return \%out;
Index: lib/Module/Build.pm
===================================================================
--- lib/Module/Build.pm	&#40;revision 7&#41;
+++ lib/Module/Build.pm	&#40;revision 9&#41;
@@ -10,12 +10,12 @@
 use File::Spec &#40;&#41;;
 use File::Path &#40;&#41;;
 use File::Basename &#40;&#41;;
-
+use version;
 use Module::Build::Base;
 
 use vars qw&#40;$VERSION @ISA&#41;;
 @ISA = qw&#40;Module::Build::Base&#41;;
-$VERSION = &#39;0.25_03&#39;;
+$VERSION = version-&gt;new&#40;&#39;0.25_03&#39;&#41;;
 
 # Okay, this is the brute-force method of finding out what kind of
 # platform we&#39;re on.  I don&#39;t know of a systematic way.  These values
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-99935" href="/Public/Bug/Display.html?id=5720#txn-99935">#</a>      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;22&nbsp;00:07:51&nbsp;2004</span>
    <span class="description">kwilliams [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/99935/22771/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/22771">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 487b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi David,

I think that at least for this release, we don&#39;t want to convert the Module::Build version-
handling code to version.pm, though it&#39;s possible we&#39;ll want to do so later.  The main 
problem with doing so is that it may/will change people&#39;s $VERSION variables &#40;or rather, the 
reporting of them&#41; in ways they don&#39;t anticipate.  For now, I&#39;m comfortable with the final 
patch I referenced in this thread.

Thanks for your patch, it may be helpful later as we revisit this.

 -Ken
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-99936" href="/Public/Bug/Display.html?id=5720#txn-99936">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;22&nbsp;00:07:52&nbsp;2004</span>
    <span class="description">kwilliams [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.506492</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
