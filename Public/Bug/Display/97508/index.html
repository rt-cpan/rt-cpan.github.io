<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #97508 for Tie-Cache: Tie::Cache together with threads crashes perl</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #97508 for Tie-Cache: Tie::Cache together with threads crashes perl</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Tie-Cache/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Tie-Cache/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Tie-Cache/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Tie-Cache/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Tie-Cache">Tie-Cache CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">97508</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Tie-Cache/Active/">Tie-Cache</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Ralf.Neubauer [...] wido.bv.aok.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-32798-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-32799-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.21    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;25&nbsp;14:15:21&nbsp;2014</span>
    <span class="description">Ralf.Neubauer [...] wido.bv.aok.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Tie::Cache together with threads crashes perl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 25 Jul 2014 18:15:06 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Tie-Cache [...] rt.cpan.org&#34; &lt;bug-Tie-Cache [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Neubauer, Ralf&#34; &lt;ralf.neubauer [...] wido.bv.aok.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi.

This sometimes crashes perl under Linux &#40;debian 7.6 i386, packages perl 5.14.2-21+deb7u1 and libtie-cache-perl 0.17-4&#41;:
perl -e &#34;use threads; use Tie::Cache; tie %c, &#39;Tie::Cache&#39;, 100000; $c{$_} = 1 for 1..21825; &#40;async { print &#39;Hallo&#39; }&#41;-&gt;join;&#34;
Speicherzugriffsfehler &#40;&#34;memory access error&#34;, may be the translation of &#34;segmentation fault&#34;&#41;.

And this always crashes:
perl -e &#34;use threads; use Tie::Cache; tie %c, &#39;Tie::Cache&#39;, 100000; $c{$_} = 1 for 1..30000; &#40;async { print &#39;Hallo&#39; }&#41;-&gt;join;&#34;


This crashes perl under Windows 7 64bit &#40;Tie::Cache 0.21 with the stable strawberry-perl-5.18.2.2-64bit.msi and Tie::Cache 0.19 with ActivePerl 32 bit v5.14.2 build 1402&#41;:
perl -e &#34;use threads; use Tie::Cache; tie %c, &#39;Tie::Cache&#39;, 100000; $c{$_} = 1 for 1..4784; &#40;async { print &#39;Hallo&#39; }&#41;-&gt;join;&#34;

Problemsignatur:
  Problemereignisname:  APPCRASH
  Anwendungsname:       perl.exe
  Anwendungsversion:    5.18.2.2
  Anwendungszeitstempel:        534d2a2b
  Fehlermodulname:      ntdll.dll
  Fehlermodulversion:   6.1.7601.18247
  Fehlermodulzeitstempel:       521eaf24
  Ausnahmecode: c00000fd
  Ausnahmeoffset:       0000000000026062
  Betriebsystemversion: 6.1.7601.2.1.0.256.48
  Gebietsschema-ID:     1031
  Zusatzinformation 1:  87c3
  Zusatzinformation 2:  87c3633f67ee1f0fe9a9859875d91123
  Zusatzinformation 3:  e9ed
  Zusatzinformation 4:  e9ed7338a06dde530f696acafd450751

But with one hash entry less it works:

perl -e &#34;use threads; use Tie::Cache; tie %c, &#39;Tie::Cache&#39;, 100000; $c{$_} = 1 for 1..4783; &#40;async { print &#39;Hallo&#39; }&#41;-&gt;join;&#34;


As Tie::Cache is pure perl, this may be a bug in perl&#39;s memory manager, but I only encountered it with Tie::Cache so far.


Ralf
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;25&nbsp;15:15:25&nbsp;2014</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2014-07-25 14:15:21, Ralf.Neubauer@wido.bv.aok.de wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; As Tie::Cache is pure perl, this may be a bug in perl&#39;s memory
&gt; manager, but I only encountered it with Tie::Cache so far.
</div>
The issue is that Tie::Cache is not threads safe.  See &#39;perldoc threads&#39; for more info.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;25&nbsp;15:15:25&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;25&nbsp;15:19:58&nbsp;2014</span>
    <span class="description">CHAMAS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> Ralf.Neubauer [...] wido.bv.aok.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I agree there is a bug here.  Sadly I suspect you are right that it is mostly likely in perl&#39;s memory management with threads, which I suspect since the segfault gets clear as the range in this line increases:

$c{$_} = 1 for 1..30000

30000 seems to be the number that drives this.  At 10000 and 20000 I was able to run this fine.  Internally the memory use and structures of the Tie::Cache grow as this 30000 range increases and more of the Tie::Cache gets used.

Interestingly enough if the size of the Tie::Cache is constrained to smaller size, this code runs:

perl -e &#34;use threads; use Tie::Cache; tie %c, &#39;Tie::Cache&#39;, 10000; for&#40;1..30000&#41; { \$c{\$_} = 1 }; &#40;async { print &#39;Hallo&#39; }&#41;-&gt;join;&#34;

So the Tie::Cache object in this case cannot grow past 10000 elements, so 30000 writes to it does not increase it to 30000 elements.  This points further to some thread size memory management issue.

I suspect this has to do with a thread stack size running out of space.  However I could not prove this, as when I tried to increase thread stack size the problem was not fixed.  If its the case, then Tie::Cache might be using upwards of 1K per entry in threaded mode so it seems this is not a good solution under perl threads.



On Fri Jul 25 14:15:21 2014, Ralf.Neubauer@wido.bv.aok.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi.
&gt; 
&gt; This sometimes crashes perl under Linux &#40;debian 7.6 i386, packages
&gt; perl 5.14.2-21+deb7u1 and libtie-cache-perl 0.17-4&#41;:
&gt; perl -e &#34;use threads; use Tie::Cache; tie %c, &#39;Tie::Cache&#39;, 100000;
&gt; $c{$_} = 1 for 1..21825; &#40;async { print &#39;Hallo&#39; }&#41;-&gt;join;&#34;
&gt; Speicherzugriffsfehler &#40;&#34;memory access error&#34;, may be the translation
&gt; of &#34;segmentation fault&#34;&#41;.
&gt; 
&gt; And this always crashes:
&gt; perl -e &#34;use threads; use Tie::Cache; tie %c, &#39;Tie::Cache&#39;, 100000;
&gt; $c{$_} = 1 for 1..30000; &#40;async { print &#39;Hallo&#39; }&#41;-&gt;join;&#34;
&gt; 
&gt; 
&gt; This crashes perl under Windows 7 64bit &#40;Tie::Cache 0.21 with the
&gt; stable strawberry-perl-5.18.2.2-64bit.msi and Tie::Cache 0.19 with
&gt; ActivePerl 32 bit v5.14.2 build 1402&#41;:
&gt; perl -e &#34;use threads; use Tie::Cache; tie %c, &#39;Tie::Cache&#39;, 100000;
&gt; $c{$_} = 1 for 1..4784; &#40;async { print &#39;Hallo&#39; }&#41;-&gt;join;&#34;
&gt; 
&gt; Problemsignatur:
&gt;   Problemereignisname:  APPCRASH
&gt;   Anwendungsname:       perl.exe
&gt;   Anwendungsversion:    5.18.2.2
&gt;   Anwendungszeitstempel:        534d2a2b
&gt;   Fehlermodulname:      ntdll.dll
&gt;   Fehlermodulversion:   6.1.7601.18247
&gt;   Fehlermodulzeitstempel:       521eaf24
&gt;   Ausnahmecode: c00000fd
&gt;   Ausnahmeoffset:       0000000000026062
&gt;   Betriebsystemversion: 6.1.7601.2.1.0.256.48
&gt;   Gebietsschema-ID:     1031
&gt;   Zusatzinformation 1:  87c3
&gt;   Zusatzinformation 2:  87c3633f67ee1f0fe9a9859875d91123
&gt;   Zusatzinformation 3:  e9ed
&gt;   Zusatzinformation 4:  e9ed7338a06dde530f696acafd450751
&gt; 
&gt; But with one hash entry less it works:
&gt; 
&gt; perl -e &#34;use threads; use Tie::Cache; tie %c, &#39;Tie::Cache&#39;, 100000;
&gt; $c{$_} = 1 for 1..4783; &#40;async { print &#39;Hallo&#39; }&#41;-&gt;join;&#34;
&gt; 
&gt; 
&gt; As Tie::Cache is pure perl, this may be a bug in perl&#39;s memory
&gt; manager, but I only encountered it with Tie::Cache so far.
&gt; 
&gt; 
&gt; Ralf
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;25&nbsp;16:56:49&nbsp;2014</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2014-07-25 15:15:25, JDHEDDEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 2014-07-25 14:15:21, Ralf.Neubauer@wido.bv.aok.de wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; As Tie::Cache is pure perl, this may be a bug in perl&#39;s memory
&gt; &gt; manager, but I only encountered it with Tie::Cache so far.
</div>&gt; 
&gt; The issue is that Tie::Cache is not threads safe.  See &#39;perldoc
&gt; threads&#39; for more info.
</div>
My error.  This is an out-of-memory issue; not a threads safe issue.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;25&nbsp;20:53:28&nbsp;2014</span>
    <span class="description">CHAMAS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jul 25 16:56:49 2014, JDHEDDEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 2014-07-25 15:15:25, JDHEDDEN wrote:
<div class="message-stanza open">&gt; &gt; On 2014-07-25 14:15:21, Ralf.Neubauer@wido.bv.aok.de wrote:
&gt; &gt; 
<div class="message-stanza open">&gt; &gt; &gt; As Tie::Cache is pure perl, this may be a bug in perl&#39;s memory
&gt; &gt; &gt; manager, but I only encountered it with Tie::Cache so far.
</div>&gt; &gt; 
&gt; &gt; The issue is that Tie::Cache is not threads safe.  See &#39;perldoc
&gt; &gt; threads&#39; for more info.
</div>&gt; 
&gt; My error.  This is an out-of-memory issue; not a threads safe issue.
</div>
I believe this is a thread + memory problem...

This program runs fine for me outside of a thread context with a larger cache:

perl -e &#34;use Tie::Cache; tie %c, &#39;Tie::Cache&#39;, 200000; for&#40;1..1000000&#41; { \$c{\$_} = 1 }; &#34;

But there is no thread stack size issue in this case.  Do note that the memory overhead here is significant and the program used around 100M memory for 200K has size.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;26&nbsp;04:39:44&nbsp;2014</span>
    <span class="description">ralf [...] strcmp.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #97508] trying to simplify...</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 26 Jul 2014 10:36:10 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tie-Cache [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ralf Neubauer &lt;ralf [...] strcmp.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I tried to simplify the test case.

I started with:

perl -e &#39;use threads; use Tie::Cache; tie %c, &#34;Tie::Cache&#34;, 200000; for&#40;1..30000&#41; { $c{$_} = 1 }; &#40;async { print qq{Hello\n} }&#41;-&gt;join&#39;
Segmentation fault

But with a my &#40;note %c is in scope in the async block&#41;:

perl -e &#39;use threads; use Tie::Cache; my %c; tie %c, &#34;Tie::Cache&#34;, 200000; for&#40;1..30000&#41; { $c{$_} = 1 }; &#40;async { print qq{Hello\n} }&#41;-&gt;join&#39;
Hello

Extracting just the Tie::Cache variable and &#34;unblessing&#34;:
 
perl -e &#39;use Storable; use Tie::Cache; $t; { tie my %c, &#34;Tie::Cache&#34;, 200000; for&#40;1..30000&#41; { $c{$_} = 1 }; $t = { %{tied %c}, class =&gt; undef }; } print $t; store $t, &#34;/tmp/tiecache.dump&#34; and print qq{Ok\n}&#39;
HASH&#40;0xa3b42d0&#41;Ok

perl -e &#39;use Storable; my $t = retrieve &#34;/tmp/tiecache.dump&#34;;&#39;
Segmentation fault

But:

perl -e &#39;use Storable; use Tie::Cache; $t; { tie my %c, &#34;Tie::Cache&#34;, 200000; for&#40;1..20000&#41; { $c{$_} = 1 }; $t = { %{tied %c}, class =&gt; undef }; } print $t; store $t, &#34;/tmp/tiecache.dump&#34; and print qq{Ok\n}&#39;
HASH&#40;0x90a9a78&#41;Ok

perl -e &#39;use Storable; my $t = retrieve &#34;/tmp/tiecache.dump&#34;; print qq{Ok\n}&#39;
Ok

I tried to use Data::Dump or Data::Dumper instead of Storable, but with element counts as big as 20000 i only get out of memory errors. With 20 the data structure looks fine, though.

Note there is no reference to threads in the last test. Tie::Cache created the structure, but there is no reference to Tie::Cache in the dump file -- it is just a boring perl data structure. Of course this could simply be a bug in Storable. Why does threads crash with the same data size as Storable? Does threads use Storable internally?

The next step would be to create the hash+doubly linked list in a simple loop without using any modules and test starting threads or retrieving this simplified structure.

Ralf
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;26&nbsp;05:00:44&nbsp;2014</span>
    <span class="description">ralf [...] strcmp.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #97508] simplified even more</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 26 Jul 2014 10:57:20 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tie-Cache [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ralf Neubauer &lt;ralf [...] strcmp.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">perl -e &#39;my @a = map [ $_, 0, 1, undef, undef ], 0..30000; for &#40;0..$#a-1&#41; { $a[$_+1][3] = $a[$_]; $a[$_][4] = $a[$_+1] }; my %h = map +&#40;$_-&gt;[0] =&gt; $_&#41;, @a; %c = &#40;node =&gt; \%h, head =&gt; $a[0], tail =&gt; $a[$#a]&#41;; use threads; &#40;async { print qq{Hello\n} }&#41;-&gt;join&#39;
Segmentation fault

perl -e &#39;my @a = map [ $_, 0, 1, undef, undef ], 0..20000; for &#40;0..$#a-1&#41; { $a[$_+1][3] = $a[$_]; $a[$_][4] = $a[$_+1] }; my %h = map +&#40;$_-&gt;[0] =&gt; $_&#41;, @a; %c = &#40;node =&gt; \%h, head =&gt; $a[0], tail =&gt; $a[$#a]&#41;; use threads; &#40;async { print qq{Hello\n} }&#41;-&gt;join&#39;
Hello


perl -e &#39;my @a = map [ $_, 0, 1, undef, undef ], 0..30000; for &#40;0..$#a-1&#41; { $a[$_+1][3] = $a[$_]; $a[$_][4] = $a[$_+1] }; my %h = map +&#40;$_-&gt;[0] =&gt; $_&#41;, @a; %c = &#40;node =&gt; \%h, head =&gt; $a[0], tail =&gt; $a[$#a]&#41;; use Storable qw&#40;dclone&#41;; dclone \%c; print qq{Hello\n}&#39;
Segmentation fault

perl -e &#39;my @a = map [ $_, 0, 1, undef, undef ], 0..20000; for &#40;0..$#a-1&#41; { $a[$_+1][3] = $a[$_]; $a[$_][4] = $a[$_+1] }; my %h = map +&#40;$_-&gt;[0] =&gt; $_&#41;, @a; %c = &#40;node =&gt; \%h, head =&gt; $a[0], tail =&gt; $a[$#a]&#41;; use Storable qw&#40;dclone&#41;; dclone \%c; print qq{Hello\n}&#39;
Hello


This is with the rather ancient perl 5.14.2-21+deb7u1 i386 on debian.

With perl 5.18.2-2ubuntu1 amd64 on ubuntu I get:

perl -e &#39;my @a = map [ $_, 0, 1, undef, undef ], 0..20000; for &#40;0..$#a-1&#41; { $a[$_+1][3] = $a[$_]; $a[$_][4] = $a[$_+1] }; my %h = map +&#40;$_-&gt;[0] =&gt; $_&#41;, @a; %c = &#40;node =&gt; \%h, head =&gt; $a[0], tail =&gt; $a[$#a]&#41;; use Storable qw&#40;dclone&#41;; dclone \%c; print qq{Hello\n}&#39;
Hello

perl -e &#39;my @a = map [ $_, 0, 1, undef, undef ], 0..30000; for &#40;0..$#a-1&#41; { $a[$_+1][3] = $a[$_]; $a[$_][4] = $a[$_+1] }; my %h = map +&#40;$_-&gt;[0] =&gt; $_&#41;, @a; %c = &#40;node =&gt; \%h, head =&gt; $a[0], tail =&gt; $a[$#a]&#41;; use Storable qw&#40;dclone&#41;; dclone \%c; print qq{Hello\n}&#39;
Segmentation fault &#40;core dumped&#41;

perl -e &#39;my @a = map [ $_, 0, 1, undef, undef ], 0..30000; for &#40;0..$#a-1&#41; { $a[$_+1][3] = $a[$_]; $a[$_][4] = $a[$_+1] }; my %h = map +&#40;$_-&gt;[0] =&gt; $_&#41;, @a; %c = &#40;node =&gt; \%h, head =&gt; $a[0], tail =&gt; $a[$#a]&#41;; use threads; &#40;async { print qq{Hello\n} }&#41;-&gt;join&#39;
Hello

perl -e &#39;my @a = map [ $_, 0, 1, undef, undef ], 0..40000; for &#40;0..$#a-1&#41; { $a[$_+1][3] = $a[$_]; $a[$_][4] = $a[$_+1] }; my %h = map +&#40;$_-&gt;[0] =&gt; $_&#41;, @a; %c = &#40;node =&gt; \%h, head =&gt; $a[0], tail =&gt; $a[$#a]&#41;; use threads; &#40;async { print qq{Hello\n} }&#41;-&gt;join&#39;
Segmentation fault &#40;core dumped&#41;

Note I had to raise the number of elements a bit for the last test.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;26&nbsp;05:18:46&nbsp;2014</span>
    <span class="description">ralf [...] strcmp.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #97508] simplified even more...</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 26 Jul 2014 11:16:13 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tie-Cache [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ralf Neubauer &lt;ralf [...] strcmp.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">perl 5.18.2-2ubuntu1 amd64:

perl -e &#39;my @a = map [ undef, undef ], 0..40000; for &#40;0..$#a-1&#41; { $a[$_+1][0] = $a[$_]; $a[$_][1] = $a[$_+1] }; use Storable qw&#40;dclone&#41;; dclone $a[0]; print qq{Hello\n}&#39;
Segmentation fault &#40;core dumped&#41;

perl -e &#39;my @a = map [ undef, undef ], 0..20000; for &#40;0..$#a-1&#41; { $a[$_+1][0] = $a[$_]; $a[$_][1] = $a[$_+1] }; use Storable qw&#40;dclone&#41;; dclone $a[0]; print qq{Hello\n}&#39;
Hello

perl -e &#39;use threads; my @a = map [ undef, undef ], 0..40000; for &#40;0..$#a-1&#41; { $a[$_+1][0] = $a[$_]; $a[$_][1] = $a[$_+1] }; &#40;async { print qq{Hello\n} }&#41;-&gt;join&#39;
Segmentation fault &#40;core dumped&#41;

perl -e &#39;use threads; my @a = map [ undef, undef ], 0..20000; for &#40;0..$#a-1&#41; { $a[$_+1][0] = $a[$_]; $a[$_][1] = $a[$_+1] }; &#40;async { print qq{Hello\n} }&#41;-&gt;join&#39;
Hello

So it&#39;s not a genuine bug in Tie::Cache, but how and where can this bug be reassigned? Is it a memory management bug or just a bug in the copying routines? The data structure is not _that_ uncommon -- if it&#39;s not a linear list but a more complicated graph, you can&#39;t emulate it with arrays.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;26&nbsp;06:46:38&nbsp;2014</span>
    <span class="description">ralf [...] strcmp.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #97508] shorter...</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 26 Jul 2014 12:43:44 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tie-Cache [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ralf Neubauer &lt;ralf [...] strcmp.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">$ perl -e &#39;use threads; $t = $t-&gt;[1] = [$t] for 1..40000; &#40;async { print qq{Hello\n} }&#41;-&gt;join&#39;
Segmentation fault &#40;core dumped&#41;
$ perl -e &#39;use Storable qw&#40;dclone&#41;; $t = $t-&gt;[1] = [$t] for 1..40000; dclone $t&#39;
Segmentation fault &#40;core dumped&#41;
$ perl -e &#39;use Clone qw&#40;clone&#41;; $t = $t-&gt;[1] = [$t] for 1..40000; clone $t&#39; 
Segmentation fault &#40;core dumped&#41;
$ ulimit -s
8192
$ ulimit -s 16384
$ perl -e &#39;use Clone qw&#40;clone&#41;; $t = $t-&gt;[1] = [$t] for 1..40000; clone $t&#39;
$ perl -e &#39;use Clone qw&#40;clone&#41;; $t = $t-&gt;[1] = [$t] for 1..80000; clone $t&#39;
Segmentation fault &#40;core dumped&#41;


If for some reason no non-recursive algorithm is possible, an error message &#39;clone: out of memory&#39; or &#39;recursion limit reached&#39; would be much nicer than a segfault, which gives no hint about which part of the program crashed &#40;took a while to find out the async {} in a big program crashed because of some object I allocated and filled somewhere completely else&#41;.

Ok, this is completely off topic for Tie::Cache... Just wanted to write this down for whoever is interested in this bug.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;26&nbsp;09:19:59&nbsp;2014</span>
    <span class="description">ralf [...] strcmp.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #97508] even shorter...</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 26 Jul 2014 15:16:41 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tie-Cache [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ralf Neubauer &lt;ralf [...] strcmp.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">$ perl -e &#39;use Clone qw&#40;clone&#41;; $t = [$t] for 1..40000; clone $t&#39;
Segmentation fault &#40;core dumped&#41;
$ perl -e &#39;use Storable qw&#40;dclone&#41;; $t = [$t] for 1..30000; dclone $t&#39;
Segmentation fault &#40;core dumped&#41;
$ perl -e &#39;use threads; $t = [$t] for 1..30000; &#40;async {}&#41;-&gt;join&#39;
Segmentation fault &#40;core dumped&#41;

I only wonder why I never encountered this before...
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;14&nbsp;20:27:04&nbsp;2018</span>
    <span class="description">CHAMAS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This old bug report seems to be resolved with more recent versions of perl!  No longer and issue, and not a bug with Tie::Cache in any case as was documented in bug report.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;14&nbsp;20:27:05&nbsp;2018</span>
    <span class="description">CHAMAS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;14&nbsp;20:27:05&nbsp;2018</span>
    <span class="description">CHAMAS [...] cpan.org -  Fixed in 0.21 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
