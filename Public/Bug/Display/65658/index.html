<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #65658 for Net-LDAP-Class: Performing batch add/remove of users on a group object fails</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #65658 for Net-LDAP-Class: Performing batch add/remove of users on a group object fails</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-LDAP-Class/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-LDAP-Class/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-LDAP-Class/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-LDAP-Class/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-LDAP-Class">Net-LDAP-Class CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">65658</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-LDAP-Class/Active/">Net-LDAP-Class</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">karman [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dekimsey [...] ufl.edu

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-222882-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.25    </td>
  </tr>
  <tr id="CF-222883-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;11&nbsp;17:09:44&nbsp;2011</span>
    <span class="description">http://dekimsey.myopenid.com/ -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Performing batch add/remove of users on a group object fails</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Performing multiple add_user/remove_user on a group object and then 
performing a $group-&gt;update fails to properly update the group membership. 
Specifically each add_user/remove_user invocation resets the internal 
users list. 

Attached is a test that demonstrates the issue as well as a patch I 
believe address the issue.

Additionally, the action_for_update appears to have a side-effect in how 
it manipulates the internal users list which can mask the behavior. The 
attached files do not address this possible issue.

Thanks, if you require any further information please let me know.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> batch-add-remove.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use Test::More tests =&gt; 46;
use strict;

use_ok&#40;&#39;Net::LDAP::Class&#39;&#41;;
use_ok&#40;&#39;Net::LDAP::Class::User::AD&#39;&#41;;
use_ok&#40;&#39;Net::LDAP::Class::Group::AD&#39;&#41;;

use lib &#39;t/lib&#39;;
use Net::LDAP;
use Data::Dump qw&#40; dump &#41;;
use LDAPTestAD;

ok&#40; my $server = LDAPTestAD::spawn_server&#40;&#41;, &#34;spawn server&#34; &#41;;
ok&#40; my $ldap = Net::LDAP-&gt;new&#40;
        LDAPTestAD::server_host&#40;&#41;, port =&gt; LDAPTestAD::server_port&#40;&#41;
    &#41;,
    &#34;connect to server&#34;
&#41;;

{

    package MyLDAPUser;
    use base &#39;Net::LDAP::Class::User::AD&#39;;

    __PACKAGE__-&gt;metadata-&gt;setup&#40;
        base_dn           =&gt; &#39;dc=test,dc=local&#39;,
        attributes        =&gt; __PACKAGE__-&gt;AD_attributes,
        unique_attributes =&gt; __PACKAGE__-&gt;AD_unique_attributes,
    &#41;;

    sub init_group_class {&#39;MyLDAPGroup&#39;}

}

{

    package MyLDAPGroup;
    use base &#39;Net::LDAP::Class::Group::AD&#39;;

    __PACKAGE__-&gt;metadata-&gt;setup&#40;
        base_dn           =&gt; &#39;dc=test,dc=local&#39;,
        attributes        =&gt; __PACKAGE__-&gt;AD_attributes,
        unique_attributes =&gt; __PACKAGE__-&gt;AD_unique_attributes,
    &#41;;

    sub init_user_class {&#39;MyLDAPUser&#39;}
}

ok&#40; $ldap-&gt;bind, &#34;bind to server&#34; &#41;;

ok&#40; my $group = MyLDAPGroup-&gt;new&#40;
        cn   =&gt; &#39;foogroup&#39;,
        ldap =&gt; $ldap,
    &#41;,
    &#34;new group&#34;
&#41;;

ok&#40; $group-&gt;create, &#34;create $group&#34; &#41;;

### Test of removing multiple users.
my $R = 3;
for my $n &#40; 1 .. $R &#41; {
    ok&#40; my $u = MyLDAPUser-&gt;new&#40;
            sAMAccountName =&gt; $n,
            ldap           =&gt; $ldap,
            groups         =&gt; [$group],
            cn             =&gt; $n,
        &#41;,
        &#34;new user $n&#34;
    &#41;;
    ok&#40; $u-&gt;create, &#34;create user $u&#34; &#41;;
}

ok&#40; $group-&gt;read, &#34;group update ok&#34; &#41;;

for my $n &#40; 1 .. $R &#41;{
    ok&#40; my $u = MyLDAPUser-&gt;new&#40; ldap =&gt; $ldap, username =&gt; $n &#41;-&gt;read, &#34;user $n read ok&#34;&#41;;
    ok&#40; $group-&gt;has_user&#40;$u&#41;, &#34;group has user $n&#34;&#41;;
}

for my $n &#40; 1 .. $R &#41;{
    my $u = MyLDAPUser-&gt;new&#40; ldap =&gt; $ldap, username =&gt; $n &#41;;
    ok&#40; $group-&gt;remove_user&#40; $u &#41;, &#34;removed user ok&#34; &#41;;
}

ok&#40; $group-&gt;update, &#34;group update succeded&#34; &#41;;

for my $n &#40; 1 .. $R &#41;{
    ok&#40; my $u = MyLDAPUser-&gt;new&#40; ldap =&gt; $ldap, username =&gt; $n &#41;-&gt;read, &#34;$n read ok&#34;&#41;;
    ok&#40; ! $group-&gt;has_user&#40;$u&#41;, &#34;group doesn&#39;t have user $n&#34;&#41;;
}

### Test of adding multiple users.
ok&#40; my $group2 = MyLDAPGroup-&gt;new&#40;
        cn   =&gt; &#39;bargroup&#39;,
        ldap =&gt; $ldap,
    &#41;,
    &#34;new group2&#34;
&#41;;

ok&#40; $group2-&gt;create, &#34;group2 create ok&#34; &#41;;

for my $n &#40; 1 .. $R &#41;{
    ok&#40; my $u = MyLDAPUser-&gt;new&#40; ldap =&gt; $ldap, username =&gt; $n &#41;-&gt;read, &#34;user $n read ok&#34;&#41;;
    ok&#40; $group2-&gt;add_user&#40; $u &#41;, &#34;added user $u ok&#34;&#41;;
}

ok&#40; $group2-&gt;update, &#34;group2 update ok&#34;&#41;;

for my $n &#40; 1 .. $R &#41;{
    ok&#40; my $u = MyLDAPUser-&gt;new&#40; ldap =&gt; $ldap, username =&gt; $n &#41;-&gt;read, &#34;user $n read ok&#34;&#41;;
    ok&#40; $group2-&gt;has_user&#40; $u &#41;, &#34;has post-update user $u ok&#34;&#41;;
}



</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> batch-user.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/lib/Net/LDAP/Class/Group/AD.pm b/lib/Net/LDAP/Class/Group/AD.pm
index c76bf47..117b0a9 100644
--- a/lib/Net/LDAP/Class/Group/AD.pm
+++ b/lib/Net/LDAP/Class/Group/AD.pm
@@ -390,12 +390,15 @@ sub add_user {
         croak
             &#34;User object must have at least a username before adding to group $self&#34;;
     }
-    for my $u &#40; $self-&gt;secondary_users &#41; {
+    if&#40; not defined $self-&gt;{users} &#41;{
+        $self-&gt;{users} = $self-&gt;secondary_users;
+    }
+    my @users = @{ $self-&gt;{users} };
+    for my $u &#40; @users &#41; {
         if &#40; &#34;$u&#34; eq &#34;$user&#34; &#41; {
             croak &#34;User $user is already a member of group $self&#34;;
         }
     }
-    my @users = $self-&gt;secondary_users;
     push&#40; @users, $user &#41;;
     $self-&gt;{users} = \@users;
 }
@@ -418,7 +421,11 @@ sub remove_user {
         croak
             &#34;User object must have at least a username before removing from group $self&#34;;
     }
-    my %users = map { $_-&gt;username =&gt; $_ } @{ $self-&gt;secondary_users };
+    if&#40; not defined $self-&gt;{users} &#41;{
+        $self-&gt;{users} = $self-&gt;secondary_users;
+    }
+    my @users = @{ $self-&gt;{users} };
+    my %users = map { $_-&gt;username =&gt; $_ } @users;
     if &#40; !exists $users{ $user-&gt;username } &#41; {
         croak &#34;User $user is not a member of group $self&#34;;
     }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;15&nbsp;23:29:23&nbsp;2011</span>
    <span class="description">karman [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;15&nbsp;23:29:49&nbsp;2011</span>
    <span class="description">karman [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks. Applied as <span class="clickylink"><a target="new" rel="nofollow" href="https://trac.msi.umn.edu/trac/sw/changeset/672">https://trac.msi.umn.edu/trac/sw/changeset/672</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;15&nbsp;23:29:50&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;15&nbsp;23:29:50&nbsp;2011</span>
    <span class="description">karman [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
