<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #132337 for Object-Pad: Instance slot confusion via eval</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #132337 for Object-Pad: Instance slot confusion via eval</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Object-Pad/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Object-Pad/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Object-Pad/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Object-Pad/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Object-Pad">Object-Pad CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">132337</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Object-Pad/Active/">Object-Pad</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
TEAM [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-273988-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-273989-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.21    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;13&nbsp;18:56:12&nbsp;2020</span>
    <span class="description">TEAM [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Instance slot confusion via eval</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Easiest to demonstrate with an example:

 $ perl -le&#39;use Object::Pad; class Parent { has $thing = 2; } package Child; Object::Pad-&gt;import_into&#40;&#34;Child&#34;&#41;; eval &#34;package Child; class Child extends Parent;&#34;; has $other = 3; method other { return $other } print Child-&gt;new-&gt;other&#39;
 ARGH: instance does not have a slot at index 1 at -e line 1.

Use-case here is some code which tries to provide Object::Pad support via a pragma - `package Child; use some_pragma; has $data; method data { $data }`
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;14&nbsp;12:35:20&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Apr 13 18:56:12 2020, TEAM wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; $ perl -le&#39;use Object::Pad; class Parent { has $thing = 2; } package
&gt; Child; Object::Pad-&gt;import_into&#40;&#34;Child&#34;&#41;; eval &#34;package Child; class
&gt; Child extends Parent;&#34;; has $other = 3; method other { return $other }
&gt; print Child-&gt;new-&gt;other&#39;
</div>
A number of issues here in both Object::Pad and your example.

First problem is that the -&gt;import_into and eval only happen at runtime, which is too late to influence the `has` and `method`. But due to a bug in the way compclassmeta is implemented the previous one from Parent has leaked out; so that is actually the one still in effect there.

With that bug fixed &#40;see attached patch&#41;, the mistake in the example becomes clear:

$ cat rt132337.pl
#!/usr/bin/perl

use Object::Pad;

class Parent { has $thing = 2; }

package Child;
Object::Pad-&gt;import_into&#40;&#34;Child&#34;&#41;;
eval &#34;package Child; class Child extends Parent;&#34;;
has $other = 3;
method other { return $other }

print Child-&gt;new-&gt;other


$ perl -Mblib rt132337.pl 
Cannot &#39;has&#39; outside of &#39;class&#39; at rt132337.pl line 10.

Could now fix that by BEGIN-wrapping these two lines, but currently that makes no difference. I suspect a better fix is to arrange for compclassmeta to be restored at &#34;end of block&#34; time in the open &#40;&#34;class Foo;&#34;&#41; case, rather than rely on the save stack which would get unwound at the end of the BEGIN block.

-- 

Paul Evans
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rt132337-part1.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">=== modified file &#39;lib/Object/Pad.xs&#39;
--- old/lib/Object/Pad.xs	2020-04-12 12:53:01 +0000
+++ new/lib/Object/Pad.xs	2020-04-14 16:32:07 +0000
@@ -154,10 +154,30 @@
 
 /* The metadata on the currently-compiling class */
 #ifdef MULTIPLICITY
-#  define compclassmeta  \
-    &#40;*&#40;&#40;ClassMeta **&#41;hv_fetchs&#40;PL_modglobal, &#34;Object::Pad/compclassmeta&#34;, GV_ADD&#41;&#41;&#41;
-#  define have_compclassmeta  \
-    &#40;!!hv_fetchs&#40;PL_modglobal, &#34;Object::Pad/compclassmeta&#34;, 0&#41;&#41;
+#  define compclassmeta       &#40;*S_compclassmetaptr&#40;aTHX&#41;&#41;
+static ClassMeta **S_compclassmetaptr&#40;pTHX&#41;
+{
+  SV *sv = *hv_fetchs&#40;PL_modglobal, &#34;Object::Pad/compclassmeta&#34;, GV_ADD&#41;;
+  if&#40;!SvOK&#40;sv&#41;&#41;
+    sv_setiv&#40;sv, 0&#41;;
+  /* Abuse the IV field as a struct pointer; we know it should be OK because
+   * IV has to be big enough to store a pointer */
+  void *ivptr = &#38;&#40;SvIVX&#40;sv&#41;&#41;;
+  return ivptr;
+}
+
+#  define have_compclassmeta  S_have_compclassmeta&#40;aTHX&#41;
+static bool S_have_compclassmeta&#40;pTHX&#41;
+{
+  SV **svp = hv_fetchs&#40;PL_modglobal, &#34;Object::Pad/compclassmeta&#34;, 0&#41;;
+  if&#40;!svp || !*svp&#41;
+    return false;
+
+  if&#40;SvOK&#40;*svp&#41; &#38;&#38; SvIV&#40;*svp&#41;&#41;
+    return true;
+
+  return false;
+}
 #else
 /* without MULTIPLICITY there&#39;s only one, so we might as well just store it
  * in a static
@@ -771,9 +791,7 @@
   import_pragma&#40;&#34;experimental&#34;, &#34;signatures&#34;&#41;;
 #endif
 
-  if&#40;have_compclassmeta&#41; {
-    SAVEVPTR&#40;compclassmeta&#41;;
-  }
+  SAVEVPTR&#40;compclassmeta&#41;;
 
   ClassMeta *meta;
   Newx&#40;meta, 1, ClassMeta&#41;;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;14&nbsp;12:35:21&nbsp;2020</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;14&nbsp;14:42:10&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Apr 14 12:35:20 2020, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Could now fix that by BEGIN-wrapping these two lines, but currently
&gt; that makes no difference. I suspect a better fix is to arrange for
&gt; compclassmeta to be restored at &#34;end of block&#34; time in the open
&gt; &#40;&#34;class Foo;&#34;&#41; case, rather than rely on the save stack which would
&gt; get unwound at the end of the BEGIN block.
</div>
Turns out that even that doesn&#39;t help; the same block-level safety in normal operation also shields the contents of the string eval&#40;&#41; from having any effect on its caller.

I believe the time may now be set to start considering some dynamic API to do these things, as an alternative to using the keyword syntax. Hypothetically then your example would become

package Child;
BEGIN {
   Object::Pad-&gt;import_into&#40;&#34;Child&#34;&#41;;
   Object::Pad-&gt;begin_class&#40;&#34;Child&#34;, extends =&gt; &#34;Parent&#34;&#41;;
}
...

to avoid the string eval.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;14&nbsp;16:25:07&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Current code as of bzr -r176 &#40;the diff is rather large&#41; now permits:

$ cat rt132337.pl 
#!/usr/bin/perl

{
   use Object::Pad;

   class Parent { has $thing = 2; }
}

{
   package Child;
   BEGIN {
      Object::Pad-&gt;import_into&#40;&#34;Child&#34;&#41;;
      Object::Pad-&gt;begin_class&#40;&#34;Child&#34;, extends =&gt; &#34;Parent&#34;&#41;;
   }
   has $other = 3;
   method other { return $other }
}

print Child-&gt;new-&gt;other, &#34;\n&#34;;

$ perl -Mblib rt132337.pl
3


This interface remains entirely undocumented and doubly-experimental, though it is at least unit-tested. It should hopefully stablise and gain some actual MOP-like methods and documentation, once we&#39;ve had more of a chance to experiment with it and work out what those might look like.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;16&nbsp;08:36:47&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Now released in 0.21

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;16&nbsp;08:36:47&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;16&nbsp;08:36:47&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Fixed in 0.21 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
