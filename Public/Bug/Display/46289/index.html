<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #46289 for DBD-SQLite: potential bug with transactions / locking</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #46289 for DBD-SQLite: potential bug with transactions / locking</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=DBD-SQLite">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=DBD-SQLite">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=DBD-SQLite">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=DBD-SQLite">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-SQLite">DBD-SQLite CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">46289</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=DBD-SQLite">DBD-SQLite</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
skhurst [...] clusterresources.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10248-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10249-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=46289">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-608742" href="/Public/Bug/Display.html?id=46289#txn-608742">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;21&nbsp;16:33:42&nbsp;2009</span>
    <span class="description">skhurst [...] clusterresources.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> potential bug with transactions / locking</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 21 May 2009 14:33:29 -0600 &#40;MDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-dbd-sqlite [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Steve K. Hurst&#34; &lt;skhurst [...] clusterresources.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/608742/308640/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/308640">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi!

I think I&#39;ve encountered a bug in DBD::SQLite that allows a second process to try and access the db when another is in a transaction.  It occurs when I have something like:

begin
  write write write ... fetch ... write ...
commit

the &#39;fetch&#39; inside the transaction seems to be what provokes the problem.

The smallest code I found that recreates the problem &#40;child dies with db locked error&#41;:



#!/usr/bin/perl -w 

use strict;

my $pid = fork&#40;&#41;;

if &#40; $pid &#41;
  {
  # parent
  write_db&#40;&#41;;
  }
elsif &#40; defined $pid &#41;
  {
  # child
  sleep 1;
  write_db&#40;&#41;;
  exit&#40;0&#41;;
  }

waitpid&#40;$pid, 0&#41;;

exit&#40;0&#41;;




sub write_db
  {

  require DBI;
  require DBD::SQLite;

  my $dbh = DBI-&gt;connect&#40;&#34;dbi:SQLite:dbname=test.db&#34;,&#34;&#34;,&#34;&#34;&#41;;

  $dbh-&gt;{RaiseError} = 1;

  $dbh-&gt;do&#40;&#39;CREATE TABLE IF NOT EXISTS test  &#40;id  text,text  text&#41;&#39;&#41;;
  $dbh-&gt;do&#40;&#39;CREATE TABLE IF NOT EXISTS test2 &#40;id2 text,text2 text&#41;&#39;&#41;;

  $dbh-&gt;begin_work&#40;&#41;;

  # comment the select, and I no longer break
  $dbh-&gt;do&#40;&#39;SELECT * from test2&#39;&#41;;
  $dbh-&gt;do&#40;&#34;INSERT INTO test VALUES &#40;$$, &#39;this is a test&#39;&#41;&#34;&#41;;

  sleep 2;

  $dbh-&gt;commit&#40;&#41;;

  }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-608788" href="/Public/Bug/Display.html?id=46289#txn-608788">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;21&nbsp;22:02:41&nbsp;2009</span>
    <span class="description">ishigaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/608788/308666/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/308666">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This looks like a limitation/bug of sqlite itself, not of DBD::SQLite. 
I confirmed the same lock message after the second insert when I 
invoked two sqlite3 commands and issued the same statements one by one 
for both of them. Visit sqlite.org or its mailing list for more 
information or help.
 

On Thu May 21 16:33:42 2009, skhurst@clusterresources.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi!
&gt; 
&gt; I think I&#39;ve encountered a bug in DBD::SQLite that allows a second
&gt; process to try and access the db when another is in a transaction.  It
&gt; occurs when I have something like:
&gt; 
&gt; begin
&gt;   write write write ... fetch ... write ...
&gt; commit
&gt; 
&gt; the &#39;fetch&#39; inside the transaction seems to be what provokes the
&gt; problem.
&gt; 
&gt; The smallest code I found that recreates the problem &#40;child dies with
&gt; db locked error&#41;:
&gt; 
&gt; 
&gt; 
&gt; #!/usr/bin/perl -w
&gt; 
&gt; use strict;
&gt; 
&gt; my $pid = fork&#40;&#41;;
&gt; 
&gt; if &#40; $pid &#41;
&gt;   {
&gt;   # parent
&gt;   write_db&#40;&#41;;
&gt;   }
&gt; elsif &#40; defined $pid &#41;
&gt;   {
&gt;   # child
&gt;   sleep 1;
&gt;   write_db&#40;&#41;;
&gt;   exit&#40;0&#41;;
&gt;   }
&gt; 
&gt; waitpid&#40;$pid, 0&#41;;
&gt; 
&gt; exit&#40;0&#41;;
&gt; 
&gt; 
&gt; 
&gt; 
&gt; sub write_db
&gt;   {
&gt; 
&gt;   require DBI;
&gt;   require DBD::SQLite;
&gt; 
&gt;   my $dbh = DBI-&gt;connect&#40;&#34;dbi:SQLite:dbname=test.db&#34;,&#34;&#34;,&#34;&#34;&#41;;
&gt; 
&gt;   $dbh-&gt;{RaiseError} = 1;
&gt; 
&gt;   $dbh-&gt;do&#40;&#39;CREATE TABLE IF NOT EXISTS test  &#40;id  text,text  text&#41;&#39;&#41;;
&gt;   $dbh-&gt;do&#40;&#39;CREATE TABLE IF NOT EXISTS test2 &#40;id2 text,text2 text&#41;&#39;&#41;;
&gt; 
&gt;   $dbh-&gt;begin_work&#40;&#41;;
&gt; 
&gt;   # comment the select, and I no longer break
&gt;   $dbh-&gt;do&#40;&#39;SELECT * from test2&#39;&#41;;
&gt;   $dbh-&gt;do&#40;&#34;INSERT INTO test VALUES &#40;$$, &#39;this is a test&#39;&#41;&#34;&#41;;
&gt; 
&gt;   sleep 2;
&gt; 
&gt;   $dbh-&gt;commit&#40;&#41;;
&gt; 
&gt;   }
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-608789" href="/Public/Bug/Display.html?id=46289#txn-608789">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;21&nbsp;22:02:42&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-608792" href="/Public/Bug/Display.html?id=46289#txn-608792">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;21&nbsp;22:02:44&nbsp;2009</span>
    <span class="description">ishigaki [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-608973" href="/Public/Bug/Display.html?id=46289#txn-608973">#</a>      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;22&nbsp;10:45:42&nbsp;2009</span>
    <span class="description">skhurst [...] clusterresources.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #46289] potential bug with transactions / locking</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 22 May 2009 08:45:39 -0600 &#40;MDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-SQLite [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Steve K. Hurst&#34; &lt;skhurst [...] clusterresources.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/608973/308766/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/308766">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Kenichi,  thanks for the quick response.


I think the sqlite3 command line tool defualts to a 0 timeout - so if it isn&#39;t changed it correctly immediately returns a locked error. If you set the timeout in the second process to 30000 &#40;as DBD::SQLite does when it starts a connection&#41;,  It correctly waits for 30 seconds before returning the locked error.

A small C program that does the same thing as the perl program below also behaves correctly &#40;second process doesn&#39;t error - waits up to the timeout value before returning an error&#41;.

Thanks - 
Steve










<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">----- Original Message -----
From: &#34;Kenichi Ishigaki via RT&#34; &lt;bug-DBD-SQLite@rt.cpan.org&gt;
To: skhurst@clusterresources.com
Sent: Thursday, May 21, 2009 8:02:43 PM GMT -07:00 US/Canada Mountain
Subject: [rt.cpan.org #46289] potential bug with transactions / locking 

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=46289">https://rt.cpan.org/Ticket/Display.html?id=46289</a></span> &gt;

This looks like a limitation/bug of sqlite itself, not of DBD::SQLite. 
I confirmed the same lock message after the second insert when I 
invoked two sqlite3 commands and issued the same statements one by one 
for both of them. Visit sqlite.org or its mailing list for more 
information or help.
 

On Thu May 21 16:33:42 2009, skhurst@clusterresources.com wrote:
<div class="message-stanza open">&gt; Hi!
&gt; 
&gt; I think I&#39;ve encountered a bug in DBD::SQLite that allows a second
&gt; process to try and access the db when another is in a transaction.  It
&gt; occurs when I have something like:
&gt; 
&gt; begin
&gt;   write write write ... fetch ... write ...
&gt; commit
&gt; 
&gt; the &#39;fetch&#39; inside the transaction seems to be what provokes the
&gt; problem.
&gt; 
&gt; The smallest code I found that recreates the problem &#40;child dies with
&gt; db locked error&#41;:
&gt; 
&gt; 
&gt; 
&gt; #!/usr/bin/perl -w
&gt; 
&gt; use strict;
&gt; 
&gt; my $pid = fork&#40;&#41;;
&gt; 
&gt; if &#40; $pid &#41;
&gt;   {
&gt;   # parent
&gt;   write_db&#40;&#41;;
&gt;   }
&gt; elsif &#40; defined $pid &#41;
&gt;   {
&gt;   # child
&gt;   sleep 1;
&gt;   write_db&#40;&#41;;
&gt;   exit&#40;0&#41;;
&gt;   }
&gt; 
&gt; waitpid&#40;$pid, 0&#41;;
&gt; 
&gt; exit&#40;0&#41;;
&gt; 
&gt; 
&gt; 
&gt; 
&gt; sub write_db
&gt;   {
&gt; 
&gt;   require DBI;
&gt;   require DBD::SQLite;
&gt; 
&gt;   my $dbh = DBI-&gt;connect&#40;&#34;dbi:SQLite:dbname=test.db&#34;,&#34;&#34;,&#34;&#34;&#41;;
&gt; 
&gt;   $dbh-&gt;{RaiseError} = 1;
&gt; 
&gt;   $dbh-&gt;do&#40;&#39;CREATE TABLE IF NOT EXISTS test  &#40;id  text,text  text&#41;&#39;&#41;;
&gt;   $dbh-&gt;do&#40;&#39;CREATE TABLE IF NOT EXISTS test2 &#40;id2 text,text2 text&#41;&#39;&#41;;
&gt; 
&gt;   $dbh-&gt;begin_work&#40;&#41;;
&gt; 
&gt;   # comment the select, and I no longer break
&gt;   $dbh-&gt;do&#40;&#39;SELECT * from test2&#39;&#41;;
&gt;   $dbh-&gt;do&#40;&#34;INSERT INTO test VALUES &#40;$$, &#39;this is a test&#39;&#41;&#34;&#41;;
&gt; 
&gt;   sleep 2;
&gt; 
&gt;   $dbh-&gt;commit&#40;&#41;;
&gt; 
&gt;   }
&gt; 
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-608974" href="/Public/Bug/Display.html?id=46289#txn-608974">#</a>      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;22&nbsp;10:45:43&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-609942" href="/Public/Bug/Display.html?id=46289#txn-609942">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;25&nbsp;22:51:46&nbsp;2009</span>
    <span class="description">adamkennedybackup [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #46289] potential bug with transactions / locking</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 26 May 2009 12:51:27 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-SQLite [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Adam Kennedy &lt;adamkennedybackup [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/609942/309317/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/309317">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">In fact, as I read the documentation for BEGIN TRANSACTION, this is
actually intended.

It seems that the default transaction mode allows for two transactions
running at the same time to hit each other, and one dies &#40;rather than
wait for the previous transaction to complete&#41;.

Rather than -&gt;begin_work, you might want to experiment with the
different transaction mode settings and see if you can replicate the
problem with one &#40;but not with the other&#41;.

Adam K

2009/5/22 Kenichi Ishigaki via RT &lt;bug-DBD-SQLite@rt.cpan.org&gt;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Â  Â  Â  Queue: DBD-SQLite
&gt; Â Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=46289">https://rt.cpan.org/Ticket/Display.html?id=46289</a></span> &gt;
&gt;
&gt; This looks like a limitation/bug of sqlite itself, not of DBD::SQLite.
&gt; I confirmed the same lock message after the second insert when I
&gt; invoked two sqlite3 commands and issued the same statements one by one
&gt; for both of them. Visit sqlite.org or its mailing list for more
&gt; information or help.
&gt;
&gt;
&gt; On Thu May 21 16:33:42 2009, skhurst@clusterresources.com wrote:
<div class="message-stanza open">&gt;&gt; Hi!
&gt;&gt;
&gt;&gt; I think I&#39;ve encountered a bug in DBD::SQLite that allows a second
&gt;&gt; process to try and access the db when another is in a transaction. Â It
&gt;&gt; occurs when I have something like:
&gt;&gt;
&gt;&gt; begin
&gt;&gt; Â  write write write ... fetch ... write ...
&gt;&gt; commit
&gt;&gt;
&gt;&gt; the &#39;fetch&#39; inside the transaction seems to be what provokes the
&gt;&gt; problem.
&gt;&gt;
&gt;&gt; The smallest code I found that recreates the problem &#40;child dies with
&gt;&gt; db locked error&#41;:
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; #!/usr/bin/perl -w
&gt;&gt;
&gt;&gt; use strict;
&gt;&gt;
&gt;&gt; my $pid = fork&#40;&#41;;
&gt;&gt;
&gt;&gt; if &#40; $pid &#41;
&gt;&gt; Â  {
&gt;&gt; Â  # parent
&gt;&gt; Â  write_db&#40;&#41;;
&gt;&gt; Â  }
&gt;&gt; elsif &#40; defined $pid &#41;
&gt;&gt; Â  {
&gt;&gt; Â  # child
&gt;&gt; Â  sleep 1;
&gt;&gt; Â  write_db&#40;&#41;;
&gt;&gt; Â  exit&#40;0&#41;;
&gt;&gt; Â  }
&gt;&gt;
&gt;&gt; waitpid&#40;$pid, 0&#41;;
&gt;&gt;
&gt;&gt; exit&#40;0&#41;;
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; sub write_db
&gt;&gt; Â  {
&gt;&gt;
&gt;&gt; Â  require DBI;
&gt;&gt; Â  require DBD::SQLite;
&gt;&gt;
&gt;&gt; Â  my $dbh = DBI-&gt;connect&#40;&#34;dbi:SQLite:dbname=test.db&#34;,&#34;&#34;,&#34;&#34;&#41;;
&gt;&gt;
&gt;&gt; Â  $dbh-&gt;{RaiseError} = 1;
&gt;&gt;
&gt;&gt; Â  $dbh-&gt;do&#40;&#39;CREATE TABLE IF NOT EXISTS test Â &#40;id Â text,text Â text&#41;&#39;&#41;;
&gt;&gt; Â  $dbh-&gt;do&#40;&#39;CREATE TABLE IF NOT EXISTS test2 &#40;id2 text,text2 text&#41;&#39;&#41;;
&gt;&gt;
&gt;&gt; Â  $dbh-&gt;begin_work&#40;&#41;;
&gt;&gt;
&gt;&gt; Â  # comment the select, and I no longer break
&gt;&gt; Â  $dbh-&gt;do&#40;&#39;SELECT * from test2&#39;&#41;;
&gt;&gt; Â  $dbh-&gt;do&#40;&#34;INSERT INTO test VALUES &#40;$$, &#39;this is a test&#39;&#41;&#34;&#41;;
&gt;&gt;
&gt;&gt; Â  sleep 2;
&gt;&gt;
&gt;&gt; Â  $dbh-&gt;commit&#40;&#41;;
&gt;&gt;
&gt;&gt; Â  }
&gt;&gt;
</div>&gt;
&gt;
&gt;
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-756298" href="/Public/Bug/Display.html?id=46289#txn-756298">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;31&nbsp;02:26:06&nbsp;2010</span>
    <span class="description">ishigaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/756298/391052/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/391052">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi. A new &#34;sqlite_use_immediate_transaction&#34; dbh attribute introduced 
in DBD::SQLite 1.30_02 would fix your issue. This deadlock issue is 
explained in &#34;The Definitive Guide to SQLite&#34; &#40;Apress&#41;, and http://
www.sqlite.org/lockingv3.html to some extent. If you still have the 
same issue &#40;even with the above attribute or issuing &#34;BEGIN 
IMMEDIATE&#34; &#40;or &#34;BEGIN EXCLUSIVE&#34;&#41; transaction&#41;, please reopen this 
ticket with a failing test/script. Thanks.

On 2009-5-21 Thu 16:33:42, skhurst@clusterresources.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi!
&gt; 
&gt; I think I&#39;ve encountered a bug in DBD::SQLite that allows a second
&gt; process to try and access the db when another is in a transaction.  It
&gt; occurs when I have something like:
&gt; 
&gt; begin
&gt;   write write write ... fetch ... write ...
&gt; commit
&gt; 
&gt; the &#39;fetch&#39; inside the transaction seems to be what provokes the
&gt; problem.
&gt; 
&gt; The smallest code I found that recreates the problem &#40;child dies with
&gt; db locked error&#41;:
&gt; 
&gt; 
&gt; 
&gt; #!/usr/bin/perl -w
&gt; 
&gt; use strict;
&gt; 
&gt; my $pid = fork&#40;&#41;;
&gt; 
&gt; if &#40; $pid &#41;
&gt;   {
&gt;   # parent
&gt;   write_db&#40;&#41;;
&gt;   }
&gt; elsif &#40; defined $pid &#41;
&gt;   {
&gt;   # child
&gt;   sleep 1;
&gt;   write_db&#40;&#41;;
&gt;   exit&#40;0&#41;;
&gt;   }
&gt; 
&gt; waitpid&#40;$pid, 0&#41;;
&gt; 
&gt; exit&#40;0&#41;;
&gt; 
&gt; 
&gt; 
&gt; 
&gt; sub write_db
&gt;   {
&gt; 
&gt;   require DBI;
&gt;   require DBD::SQLite;
&gt; 
&gt;   my $dbh = DBI-&gt;connect&#40;&#34;dbi:SQLite:dbname=test.db&#34;,&#34;&#34;,&#34;&#34;&#41;;
&gt; 
&gt;   $dbh-&gt;{RaiseError} = 1;
&gt; 
&gt;   $dbh-&gt;do&#40;&#39;CREATE TABLE IF NOT EXISTS test  &#40;id  text,text  text&#41;&#39;&#41;;
&gt;   $dbh-&gt;do&#40;&#39;CREATE TABLE IF NOT EXISTS test2 &#40;id2 text,text2 text&#41;&#39;&#41;;
&gt; 
&gt;   $dbh-&gt;begin_work&#40;&#41;;
&gt; 
&gt;   # comment the select, and I no longer break
&gt;   $dbh-&gt;do&#40;&#39;SELECT * from test2&#39;&#41;;
&gt;   $dbh-&gt;do&#40;&#34;INSERT INTO test VALUES &#40;$$, &#39;this is a test&#39;&#41;&#34;&#41;;
&gt; 
&gt;   sleep 2;
&gt; 
&gt;   $dbh-&gt;commit&#40;&#41;;
&gt; 
&gt;   }
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-756301" href="/Public/Bug/Display.html?id=46289#txn-756301">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;31&nbsp;02:26:08&nbsp;2010</span>
    <span class="description">ishigaki [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.41924</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
