<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #36486 for Net-Google-Calendar: Namespace and when fix</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #36486 for Net-Google-Calendar: Namespace and when fix</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-Google-Calendar/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-Google-Calendar/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-Google-Calendar/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-Google-Calendar/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-Google-Calendar">Net-Google-Calendar CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">36486</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-Google-Calendar/Active/">Net-Google-Calendar</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jshirley+cpan [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-39308-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.94    </td>
  </tr>
  <tr id="CF-39309-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;05&nbsp;14:46:17&nbsp;2008</span>
    <span class="description">jshirley+cpan [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Namespace and when fix</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The namespace gets dropped from critical elements in the &lt;gd:...&gt;
namespace, which results in Google simply dropping them.  The underlying
problem is the SUPER::_initialize call, which isn&#39;t populating the
$self-&gt;{_gd_ns} array.

I would have liked to have isolated the cause of that further, but time
is not on my side and would rather just alert you to the issue.

The other issue is a revamp of the &#34;when&#34; method, which now allows
better support for all the other options &#40;single day events without
having to unnecessarily add hours on to $end&#41;
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> when_ns.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">=== lib/Net/Google/Calendar/Entry.pm
==================================================================
--- lib/Net/Google/Calendar/Entry.pm	&#40;revision 8581&#41;
+++ lib/Net/Google/Calendar/Entry.pm	&#40;local&#41;
@@ -54,6 +54,10 @@
 	$self-&gt;SUPER::_initialize&#40;&#41;;
     $self-&gt;category&#40;{ scheme =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://schemas.google.com/g/2005#kind&#39;">http://schemas.google.com/g/2005#kind&#39;</a></span>, term =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://schemas.google.com/g/2005#event&#39;">http://schemas.google.com/g/2005#event&#39;</a></span> } &#41;;
     $self-&gt;set_attr&#40;&#39;xmlns:gd&#39;, &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://schemas.google.com/g/2005&#39;&#41;">http://schemas.google.com/g/2005&#39;&#41;</a></span>;
+    unless &#40; $self-&gt;{_gd_ns} &#41; {
+        my $ns = XML::Atom::Namespace-&gt;new&#40;gd =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://schemas.google.com/g/2005&#39;&#41;">http://schemas.google.com/g/2005&#39;&#41;</a></span>;
+        $self-&gt;{_gd_ns} = $ns;
+    }
 }
 
 =head2 id [id]
@@ -180,36 +184,61 @@
 
 =head2 when [&lt;start&gt; &lt;end&gt; [allday]]
 
-Get or set the start and end time as supplied as DateTime objects. 
-End must be more than start.
+The when method has multiple behaviors based upon the parameters being passed in
 
-You may optionally pass a paramter in designating if this is an all day event or not.
+For full reference, please see L&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://code.google.com/apis/gdata/elements.html#gdWhen&gt;">http://code.google.com/apis/gdata/elements.html#gdWhen&gt;</a></span>
 
-Returns two DateTime objects depicting the start and end. 
+The default behavior is to pass in a start and end date, and an optional
+allday parameter &#40;true value as the third arguemnt&#41;.
 
+If start and end times are the same, with the allday flag, it is a one-day event
 
+Get or set the start and end time as supplied as DateTime objects. 
+End must be more than start if specified.  If end is not specified, it is a 
+zero-time occurrence.
+
+Returns up to two DateTime objects depicting the start and end. 
+
 =cut
 
 sub when {
     my $self = shift;
 
-    if &#40;@_&#41; {
+    if &#40; @_ &gt;= 2 &#41; {
         my &#40;$start, $end, $allday&#41; = @_;
         $allday = 0 unless defined $allday;
-        unless &#40;$end&gt;$start&#41; {
-            $@ = &#34;End is not less than start&#34;;
+        my $cmp = DateTime-&gt;compare&#40; $start, $end &#41;;
+        # If they&#39;re the same, it must be all day, or $end must be greater than
+        # start
+        if &#40; &#40; $cmp == 0 and not $allday &#41; or $cmp &gt; 0 &#41; {
+            $@ = &#34;End time must be after start time&#34;;
             return undef;
-        }
+        }    
         $start-&gt;set_time_zone&#40;&#39;UTC&#39;&#41;;
         $end-&gt;set_time_zone&#40;&#39;UTC&#39;&#41;;
         
         my $format = $allday ? &#34;%F&#34; : &#34;%FT%TZ&#34;;
 
+        if &#40; $cmp == 0 &#41; {
+            $self-&gt;set&#40;$self-&gt;{_gd_ns}, &#34;when&#34;,  &#39;&#39;, { 
+                startTime =&gt; $start-&gt;strftime&#40;$format&#41;,
+            }&#41;;
+        } else {
+            $self-&gt;set&#40;$self-&gt;{_gd_ns}, &#34;when&#34;,  &#39;&#39;, { 
+                startTime =&gt; $start-&gt;strftime&#40;$format&#41;,
+                endTime   =&gt; $end-&gt;strftime&#40;$format&#41;,
+            }&#41;;
+        }
+    }
+    # Single date, is a zero duration event
+    elsif &#40; @_ == 1 &#41; {
+        my &#40; $start &#41; = @_;
+        $start-&gt;set_time_zone&#40;&#39;UTC&#39;&#41;;
         $self-&gt;set&#40;$self-&gt;{_gd_ns}, &#34;when&#34;,  &#39;&#39;, { 
-            startTime =&gt; $start-&gt;strftime&#40;$format&#41;,
-            endTime   =&gt; $end-&gt;strftime&#40;$format&#41;,
-        }&#41;;        
+            startTime =&gt; $start-&gt;strftime&#40;&#34;%FTTZ&#34;&#41;,
+        }&#41;;
     }
+
     my $start = $self-&gt;_attribute_get&#40;$self-&gt;{_gd_ns}, &#39;when&#39;, &#39;startTime&#39;&#41;;
     my $end   = $self-&gt;_attribute_get&#40;$self-&gt;{_gd_ns}, &#39;when&#39;, &#39;endTime&#39;&#41;;
     my @rets;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;28&nbsp;19:34:57&nbsp;2008</span>
    <span class="description">simon [...] thegestalt.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #36486] Namespace and when fix</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 29 Jul 2008 00:34:33 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;J. Shirley via RT&#34; &lt;bug-Net-Google-Calendar [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Simon Wistow &lt;simon [...] thegestalt.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, Jun 05, 2008 at 02:46:19PM -0400, J. Shirley via RT said:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The other issue is a revamp of the &#34;when&#34; method, which now allows
&gt; better support for all the other options &#40;single day events without
&gt; having to unnecessarily add hours on to $end&#41;
</div>
Gah, I&#39;ve been inexcusably crap about applying this.

It&#39;s now in SVN at

<span class="clickylink"><a target="new" rel="nofollow" href="http://svn.unixbeard.net/simon/Net-Google-Calendar">http://svn.unixbeard.net/simon/Net-Google-Calendar</a></span>

if you could test it and let me know if it works for you then that would 
be awesome. Some test cases &#40;either as a .t file or just as some 
expected behaviours&#41; would be awesome but it&#39;s a bit cheeky of me to ask 
so if you&#39;re too busy then it&#39;s absolutely fine.

Simon
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;28&nbsp;19:35:00&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;01&nbsp;06:30:50&nbsp;2008</span>
    <span class="description">simonw [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
