<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #122707 for Net-IMAP-Simple: getfh&#40;&#41; issues</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #122707 for Net-IMAP-Simple: getfh&#40;&#41; issues</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-IMAP-Simple/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-IMAP-Simple/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-IMAP-Simple/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-IMAP-Simple/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-IMAP-Simple">Net-IMAP-Simple CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">122707</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-IMAP-Simple/Active/">Net-IMAP-Simple</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
tlhackque [...] yahoo.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22730-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22731-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;04&nbsp;09:00:54&nbsp;2017</span>
    <span class="description">tlhackque [...] yahoo.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> getfh&#40;&#41; issues</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">N:I:S v 1.2209

getfh&#40;&#41; and the methods that it calls have several issues and need attention.

1&#41; if new_tmpfile fails, no error is returned.
    my $file = IO::File-&gt;new_tmpfile;
should be
    my $file = IO::File-&gt;new_tmpfile or return;

The call can fail if the file can&#39;t be created; e.g. out of inodes; disk full; permission issue; etc.

2&#41; &#39;final&#39; does a seek, but does not check for errors.
   final =&gt; sub { seek $file, 0, 0; $file },
should be
    final =&gt; sub { seek $file, 0, SEEK_SET or return; $file },

It is unlikely that seek will fail, but it has been known to happen - e.g. if the file gets inadvertently closed or the file handle corrupted.

Also, although SEEK_SET is documented 0, it&#39;s better to use the constant &#40;use Fcntl qw/:seek/&#41;.

3&#41; memory use

   getfh&#40;&#41; executes a FETCH; _process_cmd calls _read_multiline, which buffers the entire message in an array.  Only after the entire message is buffered does _process_cmd call the process method - once for each line.

This means that a large message - e.g. one with large attachments - has to allocate memory for the entire message, which can be 10s of MB.  &#40;People e-mail photos, large documents...&#41;

The code should be re-worked so that the temporary file is written as the data comes in.

Since the temporary file is seekable, if necessary, the end handling can be done by recording the start of the last few lines &#40;with tell&#41; in an array &#38; truncating the temporary file as needed.  But that&#39;s probably not necessary.

4&#41; The print to the temporary file should check for errors and cause getfh to return an error if one occurs.  print can fail due to a hardware error - or a simple disk full.

5&#41; read_multiline can _seterrstr - but doesn&#39;t signal _process_cmd that an error has occurred, so the error isn&#39;t passed up to the caller.

6&#41; getfh - in fact all the commands - break if $/ isn&#39;t \n.  This can easily happen in the caller; e.g. if it slurps a file into memory for put.  In this case, the getline&#40;&#41; calls on the socket all hang.  The easiest fix is to add
     local $/ = &#34;\n&#34;;
at the entry of all public methods.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;10&nbsp;14:25:17&nbsp;2017</span>
    <span class="description">jettero [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m aware of several bugs with get&#40;&#41; that I haven&#39;t gotten around to fixing. I&#39;m in the &#34;works for me&#34; mindset as I&#39;m quite busy at work.

If you&#39;d like to attempt a patch or two, shoot me a PR on github.

  <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/jettero/net--imap--simple">https://github.com/jettero/net--imap--simple</a></span>

Otherwise, I&#39;ll try to get to it when I can.

On Fri Aug 04 09:00:54 2017, tlhackque wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; N:I:S v 1.2209
&gt; 
&gt; getfh&#40;&#41; and the methods that it calls have several issues and need
&gt; attention.
&gt; 
&gt; 1&#41; if new_tmpfile fails, no error is returned.
&gt;     my $file = IO::File-&gt;new_tmpfile;
&gt; should be
&gt;     my $file = IO::File-&gt;new_tmpfile or return;
&gt; 
&gt; The call can fail if the file can&#39;t be created; e.g. out of inodes;
&gt; disk full; permission issue; etc.
&gt; 
&gt; 2&#41; &#39;final&#39; does a seek, but does not check for errors.
&gt;    final =&gt; sub { seek $file, 0, 0; $file },
&gt; should be
&gt;     final =&gt; sub { seek $file, 0, SEEK_SET or return; $file },
&gt; 
&gt; It is unlikely that seek will fail, but it has been known to happen -
&gt; e.g. if the file gets inadvertently closed or the file handle
&gt; corrupted.
&gt; 
&gt; Also, although SEEK_SET is documented 0, it&#39;s better to use the
&gt; constant &#40;use Fcntl qw/:seek/&#41;.
&gt; 
&gt; 3&#41; memory use
&gt; 
&gt; getfh&#40;&#41; executes a FETCH; _process_cmd calls _read_multiline, which
&gt; buffers the entire message in an array.  Only after the entire message
&gt; is buffered does _process_cmd call the process method - once for each
&gt; line.
&gt; 
&gt; This means that a large message - e.g. one with large attachments -
&gt; has to allocate memory for the entire message, which can be 10s of MB.
&gt; &#40;People e-mail photos, large documents...&#41;
&gt; 
&gt; The code should be re-worked so that the temporary file is written as
&gt; the data comes in.
&gt; 
&gt; Since the temporary file is seekable, if necessary, the end handling
&gt; can be done by recording the start of the last few lines &#40;with tell&#41;
&gt; in an array &#38; truncating the temporary file as needed.  But that&#39;s
&gt; probably not necessary.
&gt; 
&gt; 4&#41; The print to the temporary file should check for errors and cause
&gt; getfh to return an error if one occurs.  print can fail due to a
&gt; hardware error - or a simple disk full.
&gt; 
&gt; 5&#41; read_multiline can _seterrstr - but doesn&#39;t signal _process_cmd
&gt; that an error has occurred, so the error isn&#39;t passed up to the
&gt; caller.
&gt; 
&gt; 6&#41; getfh - in fact all the commands - break if $/ isn&#39;t \n.  This can
&gt; easily happen in the caller; e.g. if it slurps a file into memory for
&gt; put.  In this case, the getline&#40;&#41; calls on the socket all hang.  The
&gt; easiest fix is to add
&gt;      local $/ = &#34;\n&#34;;
&gt; at the entry of all public methods.
</div>

-- 
If riding in an airplane is flying, then riding in a boat is swimming.
116 jumps, 48.6 minutes of freefall, 92.9 freefall miles.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;10&nbsp;14:25:18&nbsp;2017</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
