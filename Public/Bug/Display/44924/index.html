<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #44924 for File-Temp: Relative &#39;CLEANUP&#39; doesn&#39;t work after chdir&#40;&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #44924 for File-Temp: Relative &#39;CLEANUP&#39; doesn&#39;t work after chdir&#40;&#41;</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=File-Temp">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=File-Temp">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=File-Temp">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=File-Temp">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/File-Temp">File-Temp CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">44924</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=File-Temp">File-Temp</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
KENTNL [...] cpan.org

<br />
leonerd-cpan [...] leonerd.org.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-13198-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.20    </td>
  </tr>
  <tr id="CF-13199-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




directory_reap.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1160644/610253/directory_reap.t">
Sun Dec 30 15:08:33 2012 (2k) by KENTNL [...] cpan.org
</a>
</font></li>
</ul>


test.plx<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/874416/452832/test.plx">
Tue Dec 28 21:02:55 2010 (305b) by mschwern [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=44924">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-589619" href="/Public/Bug/Display.html?id=44924#txn-589619">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;10&nbsp;12:11:39&nbsp;2009</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Relative &#39;CLEANUP&#39; doesn&#39;t work after chdir&#40;&#41;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/589619/298499/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/298499">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 473b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The not-entirely-unreasonable sequence of

 use File::Temp qw&#40; tempdir &#41;;
 my $tempdir = tempdir&#40; &#34;something.XXXXXX&#34;, CLEANUP =&gt; 1 &#41;;
 chdir&#40; $tempdir &#41;;
 .... do stuff

doesn&#39;t clean up the directory afterwards, presumably because of the
relative path no longer being found.

I find a workaround is to

 use Cwd qw&#40; cwd &#41;;
 my $tempdir = tempdir&#40; cwd&#40;&#41; . &#34;/something.XXXXXX&#34;, CLEANUP =&gt; 1 &#41;;

but perhaps this is something File::Temp should do internally?

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-874416" href="/Public/Bug/Display.html?id=44924#txn-874416">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;28&nbsp;21:02:55&nbsp;2010</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/874416/452831/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/452831">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 424b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I was just bitten by this and had to spend a few minutes puzzling out
why my temp directories weren&#39;t being cleaned up.

I feel File::Temp should deal with this and turn relative dirs into
absolute ones.  I can&#39;t see any sane reason why you&#39;d want otherwise, or
be relying on the current behavior, that&#39;s more important than this bug
generator.  If it&#39;s important, add an option to turn off the rel2abs code.

Test attached.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test.plx</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/874416/452832/test.plx">Download test.plx</a><br />
<span class="downloadcontenttype">application/octet-stream 305b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-874419" href="/Public/Bug/Display.html?id=44924#txn-874419">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;28&nbsp;21:02:56&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-874498" href="/Public/Bug/Display.html?id=44924#txn-874498">#</a>      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;29&nbsp;00:56:02&nbsp;2010</span>
    <span class="description">TJENNESS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/874498/452869/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/452869">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 580b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve put a fix for this &#40;and also RT #44924&#41; on github &#40;git://github.com/timj/perl-File-Temp.git&#41; 
and also fixed up the tempfile.t tests so that they reall test directory removal. The only downside 
of all this is that we are now pretty much guaranteed to fail when taint mode is enabled because 
there are now many cases were File::Spec-&gt;rel2abs is called and this returns a tainted result &#40;via 
Cwd::getcwd&#41;.

Any thoughts? Presumably if untainting getcwd was easy &#40;by verifying that the directory does 
exist and contains no odd characters&#41; then Cwd would already be doing it.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1047729" href="/Public/Bug/Display.html?id=44924#txn-1047729">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;08&nbsp;14:46:12&nbsp;2012</span>
    <span class="description">EDAVIS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1047729/547573/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/547573">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 999b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">It is right for the current directory to be tainted since it is
something that comes from the environment.  You certainly want a warning
for code like

    my $dir = getcwd&#40;&#41;;
    system &#34;echo $dir&#34;;

since it has all sorts of string interpolation bugs.  However, that does
not mean that it is automatically unsafe to use the directory name
returned.  On Unix-like systems a path can contain almost any character,
is returned without comment from getcwd&#40;&#41;, and works fine in chdir&#40;&#41;. 
If you are calling perl&#39;s chdir&#40;&#41; builtin you do not need to worry about
whether the path contains funny characters - only that it is the correct
path.

Therefore I propose that File::Temp should, just before the final
chdir&#40;&#41; on cleanup, untaint the directory name.  Taint checking will
still be in place for any other uses of that string.

There is the question of whether File::Temp should reject temporary
directory names containing funny characters in order to shield user
code.  But that is a separate issue.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1050989" href="/Public/Bug/Display.html?id=44924#txn-1050989">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;16&nbsp;10:50:09&nbsp;2012</span>
    <span class="description">EDAVIS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1050989/549520/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/549520">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 124b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I suggest using fastcwd&#40;&#41; instead of cwd&#40;&#41;.  The latter runs the external
&#39;cwd&#39; program, which could be causing the trouble.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1051151" href="/Public/Bug/Display.html?id=44924#txn-1051151">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;16&nbsp;18:55:46&nbsp;2012</span>
    <span class="description">TJENNESS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #44924] Relative &#39;CLEANUP&#39; doesn&#39;t work after chdir&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 16 Mar 2012 12:55:33 -1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-File-Temp [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tim Jenness &lt;tjenness [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1051151/549611/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/549611">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 558b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Doesn&#39;t help because Cwd.xs explicitly turns on taint for fastcwd.

This fails:

use Cwd;
use File::Spec;
use Devel::Peek;

my $cwd = Cwd::fastcwd&#40;&#41;;

print &#34;CWD = $cwd\n&#34;;
my $path = File::Spec-&gt;catfile&#40;$cwd, &#34;xxx&#34; &#41;;
open &#40;my $fh, &#34;&gt;&#34;, $path &#41;;

On Fri, Mar 16, 2012 at 4:50 AM, EDAVIS via RT
&lt;bug-File-Temp@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Â  Â  Â  Queue: File-Temp
&gt; Â Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=44924">https://rt.cpan.org/Ticket/Display.html?id=44924</a></span> &gt;
&gt;
&gt; I suggest using fastcwd&#40;&#41; instead of cwd&#40;&#41;. Â The latter runs the external
&gt; &#39;cwd&#39; program, which could be causing the trouble.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1160630" href="/Public/Bug/Display.html?id=44924#txn-1160630">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;30&nbsp;13:55:52&nbsp;2012</span>
    <span class="description">KENTNL [...] cpan.org -  Requestor KENTNL added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1160631" href="/Public/Bug/Display.html?id=44924#txn-1160631">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;30&nbsp;13:59:06&nbsp;2012</span>
    <span class="description">KENTNL [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1160631/610243/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/610243">with headers</a>
<br />
<span class="downloadcontenttype">text/html 574b</span>
</div>
<div class="messagebody">
<div class="message-stanza"><p>Theres some extra fun things you can do, and if you're malicious, presently you can trick File::Temp into deleting the wrong directory.</p>

<p>&nbsp;</p>

<p>Of course, its mostly a theoretical problem, I&nbsp;doubt you'd see it &quot;in the wild&quot;</p>

<p>&nbsp;</p>

<p>my $tempdir = tempdir('TEMPLATE.XXXXX', CLEANUP&nbsp;=&gt; 1 );</p>

<p>chdir&nbsp;&quot;somewhere/else&quot;;</p>

<p>mkdir &quot;somewhere/else/$tempdir&quot;;</p>

<p>exit </p>

<p>&nbsp;</p>

<p>And this cleans up the wrong temporary directory.  =) </p>

<p>Looking forward to seeing this fixed. </p>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1160644" href="/Public/Bug/Display.html?id=44924#txn-1160644">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;30&nbsp;15:08:32&nbsp;2012</span>
    <span class="description">KENTNL [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1160644/610252/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/610252">with headers</a>
<br />
<span class="downloadcontenttype">text/html 699b</span>
</div>
<div class="messagebody">
<div class="message-stanza"><p>Considering testing this might be a bit difficult, I&nbsp;did manage to work out how to test for this case with a bit of fork() magic.</p>

<p>&nbsp;</p>

<p>It still needs to be tested for portability&nbsp; and skip the tests on platforms it can't work on, but at least on linux this test works.<br>

<br>

Here's a link to the tests source in case you wish to review it in your browser:&nbsp; <span class="clickylink"><a target="new" rel="nofollow" href="https://gist.github.com/4414787">https://gist.github.com/4414787</a></span></p>

<p>&nbsp;</p>

<p>Basically, it leverages the fact that reap happens at exit(), and creates the tempdir in a fork, prints the name of the created directory over the pipe to the parent process, and then exits, and the parent then sees if cleanup happened or not. </p>
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> directory_reap.t</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1160644/610253/directory_reap.t">Download directory_reap.t</a><br />
<span class="downloadcontenttype">text/x-perl 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w

use warnings &#39;all&#39;;
use strict;

use File::Temp qw&#40; tempdir &#41;;
use File::Path qw&#40; make_path &#41;;
use File::Spec;
use IO::Pipe;
use Cwd;

sub _cwd { File::Spec-&gt;rel2abs&#40;Cwd::cwd&#41; }

use Test::More;

my &#40;@tests&#41; = &#40;
	{
		make_tempdir_in =&gt; &#39;/base/&#39;,
		exit_in         =&gt; &#39;/base/&#39;,
		label           =&gt; &#39;no chdir&#39;,
	},
	{ 
		make_tempdir_in =&gt; &#39;/parent/base/&#39;,
		exit_in         =&gt; &#39;/parent/&#39;,
		label           =&gt; &#39;parent dir&#39;,
	},
	{
		make_tempdir_in =&gt; &#39;/base/&#39;,
		exit_in         =&gt; &#39;/sibling/&#39;,
		label           =&gt; &#39;sibling dir&#39;,
	},
	{
		make_tempdir_in =&gt; &#39;/base/&#39;,
		exit_in         =&gt; &#39;/base/nephew/&#39;,
		label           =&gt; &#39;nephew dir&#39;,
	},
&#41;;

for my $test &#40; @tests &#41; {
	for my $file &#40; run_test&#40; $test &#41; &#41; { 
		ok&#40; ! -e $file , &#39;$file should be gone in &#39; . $test-&gt;{label} . &#39; case&#39;&#41;;
	}
}


sub _make_test { 
	my &#40; $config &#41; = @_ ; 
	my $label = $config-&gt;{label};
	my $tempdir = tempdir&#40;&#34;test.${label}.XXXX&#34;, DIR =&gt; _cwd , CLEANUP =&gt; 1 &#41;;
	my $outconfig = {
		make_tempdir_in =&gt; File::Spec-&gt;catdir&#40; $tempdir , $config-&gt;{make_tempdir_in} &#41;,
		exit_in         =&gt; File::Spec-&gt;catdir&#40; $tempdir , $config-&gt;{exit_in} &#41;,
	};
	make_path&#40; $outconfig-&gt;{make_tempdir_in} , { verbose =&gt; 0 } &#41;;
	make_path&#40; $outconfig-&gt;{exit_in}         , { verbose =&gt; 0 } &#41;;
	return $outconfig;
}

sub child { 
	my &#40; $test_config , $write_pipe &#41; = @_;
	chdir $test_config-&gt;{make_tempdir_in};
	note sprintf &#34;child in %s\n&#34;, _cwd;
	my $tempdir = tempdir&#40;  &#34;THISWILLNOTDIE.XXXXX&#34;, CLEANUP =&gt; 1 &#41;;
	note sprintf &#34;child made %s\n&#34;,  File::Spec-&gt;catdir&#40; Cwd::cwd , $tempdir &#41;;
	$write_pipe-&gt;printf&#40; &#34;%s\n&#34;, File::Spec-&gt;catdir&#40; Cwd::cwd , $tempdir &#41;&#41;;
	chdir $test_config-&gt;{exit_in};
	note sprintf &#34;child exiting in %s\n&#34; , _cwd;
	exit;
}

sub run_test { 
	my &#40; $config &#41; = @_; 
	my $real_config = _make_test&#40; $config &#41;;
	my $pipe = IO::Pipe-&gt;new&#40;&#41;;
	my $pid = fork;
	if&#40; not $pid &#41;{ 
		child&#40; $real_config, $pipe-&gt;writer &#41;;
		exit 255;
	}
	my $read = $pipe-&gt;reader&#40;&#41;;
	my &#40;@files&#41; = map { chomp $_;$_ } &lt;$read&gt;;
	waitpid $pid, 0;
	return @files;
}

done_testing;


</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1160726" href="/Public/Bug/Display.html?id=44924#txn-1160726">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;30&nbsp;23:22:00&nbsp;2012</span>
    <span class="description">TJENNESS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #44924] Relative &#39;CLEANUP&#39; doesn&#39;t work after chdir&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 30 Dec 2012 21:21:47 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Per Friberg &lt;bug-File-Temp [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tim Jenness &lt;tjenness [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1160726/610300/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/610300">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Does this still fail in the repository version on github?

I store the full path of the temp directory in that version. Haven&#39;t
released it as I&#39;m bogged down in the fact that the patch breaks taint mode.


On Sun, Dec 30, 2012 at 1:08 PM, Kent Fredric via RT &lt;
bug-File-Temp@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: File-Temp
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=44924">https://rt.cpan.org/Ticket/Display.html?id=44924</a></span> &gt;
&gt;
&gt; Considering testing this might be a bit difficult, I did manage to work
&gt; out how
&gt; to test for this case with a bit of fork&#40;&#41; magic.
&gt;
&gt; It still needs to be tested for portability and skip the tests on
&gt; platforms it
&gt; can&#39;t work on, but at least on linux this test works.
&gt;
&gt; Here&#39;s a link to the tests source in case you wish to review it in your
&gt; browser: <span class="clickylink"><a target="new" rel="nofollow" href="https://gist.github.com/4414787">https://gist.github.com/4414787</a></span>
&gt;
&gt; Basically, it leverages the fact that reap happens at exit&#40;&#41;, and creates
&gt; the
&gt; tempdir in a fork, prints the name of the created directory over the pipe
&gt; to
&gt; the parent process, and then exits, and the parent then sees if cleanup
&gt; happened or not.
&gt;
&gt;
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1160726/610301/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/610301">with headers</a>
<br />
<span class="downloadcontenttype">text/html 1.5k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1160728" href="/Public/Bug/Display.html?id=44924#txn-1160728">#</a>      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;31&nbsp;00:40:18&nbsp;2012</span>
    <span class="description">KENTNL [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1160728/610303/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/610303">with headers</a>
<br />
<span class="downloadcontenttype">text/html 386b</span>
</div>
<div class="messagebody">
<div class="message-stanza">On 2012-12-31 17:22:00, TJENNESS wrote: <br>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Does this still fail in the repository version on github? <br>

&gt;  <br>

&gt; I store the full path of the temp directory in that version. Haven't <br>

&gt; released it as I'm bogged down in the fact that the patch breaks taint mode. <br>
</div><p>&nbsp;</p>

<p>Yep. The test as above works and passes 4/4 =)&nbsp;<br>

&nbsp;</p>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1178186" href="/Public/Bug/Display.html?id=44924#txn-1178186">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;06&nbsp;20:18:22&nbsp;2013</span>
    <span class="description">dagolden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1178186/621507/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/621507">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 132b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attaching some related discussion as a reminder for later:

<span class="clickylink"><a target="new" rel="nofollow" href="http://www.nntp.perl.org/group/perl.perl5.porters/2012/07/msg189786.html">http://www.nntp.perl.org/group/perl.perl5.porters/2012/07/msg189786.html</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1178252" href="/Public/Bug/Display.html?id=44924#txn-1178252">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;06&nbsp;21:00:35&nbsp;2013</span>
    <span class="description">dagolden [...] cpan.org -  Severity Normal changed to Important</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1178389" href="/Public/Bug/Display.html?id=44924#txn-1178389">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;07&nbsp;04:13:26&nbsp;2013</span>
    <span class="description">dagolden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1178389/621616/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/621616">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 288b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On reflection, I think the right thing to do is use abs_path on the
created directory and detaint the result.  Any damage is already done --
the directory has been created &#40;assuming sufficient permissions&#41;, so
knowing its full name &#40;with symlinks resolved&#41; doesn&#39;t have any further
risk.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1178392" href="/Public/Bug/Display.html?id=44924#txn-1178392">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;07&nbsp;04:51:25&nbsp;2013</span>
    <span class="description">dagolden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1178392/621619/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/621619">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 100b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">See
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/Perl-Toolchain-Gang/File-Temp/commit/4764e356ef51ac6e1d59c455354c6e87db0f6264">https://github.com/Perl-Toolchain-Gang/File-Temp/commit/4764e356ef51ac6e1d59c455354c6e87db0f6264</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1178395" href="/Public/Bug/Display.html?id=44924#txn-1178395">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;07&nbsp;04:51:26&nbsp;2013</span>
    <span class="description">dagolden [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1178406" href="/Public/Bug/Display.html?id=44924#txn-1178406">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;07&nbsp;06:25:25&nbsp;2013</span>
    <span class="description">dagolden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1178406/621629/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/621629">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 130b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Subsequent commits are safer, with relative pathnames being given to
users and the absolute untainted path stored internally only.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1178409" href="/Public/Bug/Display.html?id=44924#txn-1178409">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;07&nbsp;06:25:26&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1178410" href="/Public/Bug/Display.html?id=44924#txn-1178410">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;07&nbsp;06:25:50&nbsp;2013</span>
    <span class="description">dagolden [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1613794" href="/Public/Bug/Display.html?id=44924#txn-1613794">#</a>      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;02&nbsp;07:13:01&nbsp;2016</span>
    <span class="description">dagolden [...] cpan.org -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.877053</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
