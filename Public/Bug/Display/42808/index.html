<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #42808 for AnyEvent-XMPP: SRV-Support from Net::XMPP2::Connection missed</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #42808 for AnyEvent-XMPP: SRV-Support from Net::XMPP2::Connection missed</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/AnyEvent-XMPP/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/AnyEvent-XMPP/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/AnyEvent-XMPP/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/AnyEvent-XMPP/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/AnyEvent-XMPP">AnyEvent-XMPP CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">42808</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/AnyEvent-XMPP/Active/">AnyEvent-XMPP</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">elmex [...] ta-sa.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cpan [...] pennewiss.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-225334-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.2    </td>
  </tr>
  <tr id="CF-225335-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.3    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;26&nbsp;11:34:06&nbsp;2009</span>
    <span class="description">cpan [...] pennewiss.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> SRV-Support from Net::XMPP2::Connection missed</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This patch adds SRV-Support from Net::XMPP2::Connection &#40;0.14&#41; to
AnyEvent::XMPP::Connection
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Connection.pm.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- /usr/lib/perl5/vendor_perl/5.8.8/AnyEvent/XMPP/Connection.pm	2009-01-26 16:59:30.647720000 +0100
+++ Connection.pm	2009-01-26 16:55:14.539813905 +0100
@@ -2,6 +2,7 @@
 use strict;
 use AnyEvent;
 use IO::Socket::INET;
+use Net::DNS::Resolver;
 use AnyEvent::XMPP::Parser;
 use AnyEvent::XMPP::Writer;
 use AnyEvent::XMPP::Util qw/split_jid join_jid simxml/;
@@ -285,10 +286,18 @@
    return $self;
 }
 
-=item B&lt;connect &#40;&#41;&gt;
+=item B&lt;connect &#40;$no_srv_rr&#41;&gt;
 
 Try to connect &#40;non blocking&#41; to the domain and port passed in C&lt;new&gt;.
 
+A SRV RR lookup will be performed on the domain to discover
+the host and port to use. If you don&#39;t want this set C&lt;$no_srv_rr&gt;
+to a true value. C&lt;$no_srv_rr&gt; is false by default.
+
+As the SRV RR lookup might return multiple host and you fail to
+connect to one you might just call this function again to try a
+different host.
+
 The connection is performed non blocking, so this method will just
 trigger the connection process. The event C&lt;connect&gt; will be emitted
 when the connection was successfully established.
@@ -302,9 +311,30 @@
 =cut
 
 sub connect {
-   my &#40;$self&#41; = @_;
+   my &#40;$self, $no_srv_rr&#41; = @_;
 
    my &#40;$host, $port&#41; = &#40;$self-&gt;{domain}, defined $self-&gt;{port} ? $self-&gt;{port} : 5222&#41;;
+   if &#40;$self-&gt;{override_host}&#41; {
+      $host = $self-&gt;{override_host};
+
+   } else {
+      unless &#40;$no_srv_rr&#41; {
+         my $res = Net::DNS::Resolver-&gt;new;
+         my $p   = $res-&gt;query &#40;&#39;_xmpp-client._tcp.&#39;.$host, &#39;SRV&#39;&#41;;
+         if &#40;$p&#41; {
+            my @srvs = grep { $_-&gt;type eq &#39;SRV&#39; } $p-&gt;answer;
+            if &#40;@srvs&#41; {
+               @srvs = sort { $a-&gt;priority &lt;=&gt; $b-&gt;priority } @srvs;
+               @srvs = sort { $b-&gt;weight &lt;=&gt; $a-&gt;weight } @srvs; # TODO
+               $port = $srvs[0]-&gt;port;
+               $host = $srvs[0]-&gt;target;
+            }
+         }
+      }
+   }
+
+   $port = $self-&gt;{override_port} if defined $self-&gt;{override_port};
+
    $self-&gt;SUPER::connect &#40;$host, $port, $self-&gt;{connect_timeout}&#41;;
 }
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;26&nbsp;12:10:36&nbsp;2009</span>
    <span class="description">elmex [...] ta-sa.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jan 26 11:34:06 2009, mape2k wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This patch adds SRV-Support from Net::XMPP2::Connection &#40;0.14&#41; to
&gt; AnyEvent::XMPP::Connection
</div>
Why did you re implement SRV? AnyEvent::XMPP uses AnyEvent::Socket
to do DNS SRV records, like I wrote in the Changes:

         - Using the better tested AnyEvent::Handle and
           AnyEvent::Socket for DNS resolution, TCP connect and TLS now.

Did you have any problems with DNS SRV?
Could you try the latest version from the git repository if you
experienced any DNS SRV problems?

Greetings,
   Robin
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;26&nbsp;12:10:37&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;26&nbsp;12:17:56&nbsp;2009</span>
    <span class="description">elmex [...] ta-sa.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;26&nbsp;13:15:28&nbsp;2009</span>
    <span class="description">cpan [...] pennewiss.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> cpan [...] pennewiss.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mo. 26. Jan. 2009, 12:10:36, ELMEX wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Why did you re implement SRV? AnyEvent::XMPP uses AnyEvent::Socket
&gt; to do DNS SRV records, like I wrote in the Changes:
&gt; 
&gt;          - Using the better tested AnyEvent::Handle and
&gt;            AnyEvent::Socket for DNS resolution, TCP connect and TLS now.
</div>

hmm, i did not read it accurate enough, sorry ;&#41;
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Did you have any problems with DNS SRV?
</div>
In version 0.2 it dit now work.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Could you try the latest version from the git repository if you
&gt; experienced any DNS SRV problems?
</div>
Works perfectly. i think the bug is fixed with your commit of 2009-01-14.

THX for your work.

Marcel
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;26&nbsp;14:56:28&nbsp;2009</span>
    <span class="description">elmex [...] ta-sa.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #42808] SRV-Support from Net::XMPP2::Connection missed</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 26 Jan 2009 20:39:18 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Marcel Pennewiß via RT &lt;bug-AnyEvent-XMPP [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Robin Redeker &lt;elmex [...] ta-sa.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi!

On Mon, Jan 26, 2009 at 01:15:29PM -0500, Marcel Pennewiß via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: AnyEvent-XMPP
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=42808">https://rt.cpan.org/Ticket/Display.html?id=42808</a></span> &gt;
&gt; 
&gt; On Mo. 26. Jan. 2009, 12:10:36, ELMEX wrote:
<div class="message-stanza open">&gt; &gt; Why did you re implement SRV? AnyEvent::XMPP uses AnyEvent::Socket
&gt; &gt; to do DNS SRV records, like I wrote in the Changes:
&gt; &gt; 
&gt; &gt;          - Using the better tested AnyEvent::Handle and
&gt; &gt;            AnyEvent::Socket for DNS resolution, TCP connect and TLS now.
</div>&gt; 
&gt; 
&gt; hmm, i did not read it accurate enough, sorry ;&#41;
&gt;  
<div class="message-stanza open">&gt; &gt; Did you have any problems with DNS SRV?
</div>&gt; 
&gt; In version 0.2 it dit now work.
&gt; 
<div class="message-stanza open">&gt; &gt; Could you try the latest version from the git repository if you
&gt; &gt; experienced any DNS SRV problems?
</div>&gt; 
&gt; Works perfectly. i think the bug is fixed with your commit of 2009-01-14.
&gt; 
&gt; THX for your work.
&gt; 
</div>
Thats great, thanks for testing the git version. I&#39;ll release
it soon. Many people already stumbled over the brokeness in 0.2 :&#41;

Greetings,
   Robin

-- 
Robin Redeker                         | Deliantra, the free code+content MORPG
elmex@ta-sa.org / r.redeker@gmail.com | <span class="clickylink"><a target="new" rel="nofollow" href="http://www.deliantra.net">http://www.deliantra.net</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.ta-sa.org/">http://www.ta-sa.org/</a></span>                 |
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;29&nbsp;05:03:02&nbsp;2009</span>
    <span class="description">elmex [...] ta-sa.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Version 0.3 is now released.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;29&nbsp;05:03:03&nbsp;2009</span>
    <span class="description">elmex [...] ta-sa.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;29&nbsp;05:03:22&nbsp;2009</span>
    <span class="description">elmex [...] ta-sa.org -  Fixed in 0.3 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
