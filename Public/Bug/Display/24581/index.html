<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #24581 for Tangram: Tangram::Storage.pm,Schema.pod patch - adding object propagation to make_id</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #24581 for Tangram: Tangram::Storage.pm,Schema.pod patch - adding object propagation to make_id</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Tangram/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Tangram/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Tangram/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Tangram/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Tangram">Tangram CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">24581</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">stalled</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">10 min

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Tangram/Active/">Tangram</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
pt [...] tchorbadjiev.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-30728-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-30729-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;25&nbsp;18:04:02&nbsp;2007</span>
    <span class="description">pt [...] tchorbadjiev.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Tangram::Storage.pm,Schema.pod patch - adding object propagation to make_id</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 26 Jan 2007 01:02:12 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tangram [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Assen Tchorbadjiev &lt;pt [...] tchorbadjiev.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Hello,

its not a bug :&#41;, its a feature that I find useful.

Here&#39;s the case:
The current make_id&#40;&#41; call, when inserting objects into the storage,
does not propagate the $o[bject] to be inserted.
Some applications &#40;as mine does&#41; might find it useful to have this
instance when they define/generate custom ids for the backend.

Regards,
Assen
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/lib/Tangram/Schema.pod b/lib/Tangram/Schema.pod
index 1f9319d..568d7fc 100644
--- a/lib/Tangram/Schema.pod
+++ b/lib/Tangram/Schema.pod
@@ -179,10 +179,11 @@ Sequences are emulated on pretend databa
 This is a I&lt;closure&gt; that is expected to return an unique ID.  It is
 called like this:
 
-   $make_id-&gt;&#40;$class_id, $storage&#41;
+   $make_id-&gt;&#40;$class_id, $storage, $object&#41;
 
 Where C&lt;$class_id&gt; is the Class identifier for_the newly created
 object, and C&lt;$storage&gt; is the B&lt;Tangram::Storage&gt; object.
+The C&lt;$object&gt; is the instance of the object to be inserted.
 
 =item * cid
 
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/lib/Tangram/Storage.pm b/lib/Tangram/Storage.pm
index 842451b..45d9175 100644
--- a/lib/Tangram/Storage.pm
+++ b/lib/Tangram/Storage.pm
@@ -311,7 +311,7 @@ sub prepare
 # XXX - lots of options here not tested by test suite
 sub make_id
   {
-    my &#40;$self, $class_id&#41; = @_;
+    my &#40;$self, $class_id, $o&#41; = @_;
 
     # see if the class has its own ID generator
     my $cname = $self-&gt;{id2class}{$class_id};
@@ -319,7 +319,7 @@ sub make_id
 
     my $id;
     if &#40; $classdef-&gt;{make_id} &#41; {
-	$id = $classdef-&gt;{make_id}-&gt;&#40;$class_id, $self&#41;;
+	$id = $classdef-&gt;{make_id}-&gt;&#40;$class_id, $self, $o&#41;;
 	print $Tangram::TRACE &#34;Tangram: custom per-class &#40;$cname&#41; make ID function returned &#34;.&#40;pretty&#40;$id&#41;&#41;.&#34;\n&#34; if $Tangram::TRACE;
     } elsif &#40; $classdef-&gt;{oid_sequence} &#41; {
 	eval { $id = $self-&gt;get_sequence&#40;$classdef-&gt;{oid_sequence}&#41; };
@@ -328,7 +328,7 @@ sub make_id
 
     # maybe the entire schema has its own ID generator
     if &#40; !defined&#40;$id&#41; and $self-&gt;{schema}{sql}{make_id} &#41; {
-	$id = $self-&gt;{schema}{sql}{make_id}-&gt;&#40;$class_id, $self&#41;;
+	$id = $self-&gt;{schema}{sql}{make_id}-&gt;&#40;$class_id, $self, $o&#41;;
 	print $Tangram::TRACE &#34;Tangram: custom schema make ID function returned &#34;
 	    .&#40;pretty&#40;$id&#41;&#41;.&#34;\n&#34; if $Tangram::TRACE;
     } elsif &#40; !defined&#40;$id&#41; &#38;&#38;
@@ -655,7 +655,7 @@ sub _insert
 
     my $class = $self-&gt;{schema}-&gt;classdef&#40;$class_name&#41;;
 
-    my $id = $self-&gt;make_id&#40;$classId&#41;;
+    my $id = $self-&gt;make_id&#40;$classId, $obj&#41;;
 
     $self-&gt;welcome&#40;$obj, $id&#41;;
     $self-&gt;tx_on_rollback&#40; sub { $self-&gt;goodbye&#40;$obj, $id&#41; } &#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;28&nbsp;21:56:42&nbsp;2007</span>
    <span class="description">SAMV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">10 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> t2-users [...] lists.utsl.gen.nz</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks Assen, this looks like a good change and very useful to some people.

My only reservation is that people might use it to work around the lack
of decent primary key support in Tangram.  Let me explain a bit more. 
Quite often you want to mark a particular object property or group of
properties as the primary key, and then the &#34;id&#34; property becomes a
surrogate, and a nuisance.  In this instance you want Tangram to treat
the marked columns as the ID, and combine the data in the primary keys
and the type into an &#34;oid&#34;.

The limiting factors are the classes that perform associations, such as
the Tangram::Type::Abstract::Coll related classes and
Tangram::Type::Ref::* - as well as various other assumptions that the
combined &#40;id + type&#41; tuple can be expressed as an integer.  I don&#39;t
think that these problems are insurmountable, though.

Thanks for your contribution,
Sam.

On Thu Jan 25 18:04:02 2007, pt@tchorbadjiev.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Hello,
&gt; 
&gt; its not a bug :&#41;, its a feature that I find useful.
&gt; 
&gt; Here&#39;s the case:
&gt; The current make_id&#40;&#41; call, when inserting objects into the storage,
&gt; does not propagate the $o[bject] to be inserted.
&gt; Some applications &#40;as mine does&#41; might find it useful to have this
&gt; instance when they define/generate custom ids for the backend.
&gt; 
&gt; Regards,
&gt; Assen
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;28&nbsp;21:56:43&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;09&nbsp;10:29:17&nbsp;2013</span>
    <span class="description">daveh [...] hodgkinson.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
