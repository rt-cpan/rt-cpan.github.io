<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #132937 for Finance-Quote: FQ 1.49 TSP bug</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #132937 for Finance-Quote: FQ 1.49 TSP bug</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Finance-Quote">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Finance-Quote">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Finance-Quote">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Finance-Quote">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Finance-Quote">Finance-Quote CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">132937</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Finance-Quote">Finance-Quote</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
rclar.in.dc [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-13576-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-13577-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




TSP.pm<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1905083/1020771/TSP.pm">
Sun Jul 12 16:17:07 2020 (5.9k) by quinn.baker [...] gmail.com
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1904706/1020603/TSP.pm">
Wed Jul 08 11:06:44 2020 (5.9k) by quinn.baker [...] gmail.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=132937">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1904300" href="/Public/Bug/Display.html?id=132937#txn-1904300">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;03&nbsp;14:28:06&nbsp;2020</span>
    <span class="description">rclar.in.dc [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> FQ 1.49 TSP bug</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 3 Jul 2020 14:27:50 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Finance-Quote [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rclar &lt;rclar.in.dc [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1904300/1020414/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1020414">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Since &#40;I think&#41; upgrading to FQ 1.49, TSP quotes fail; and I don&#39;t know
enough perl to help much beyond that.

rclar@corona ~/bin % gnc-fq-dump -v tsp CFUND
TSP data table not recognised at /usr/share/perl5/Finance/Quote/TSP.pm line
103.

rclar@corona ~/bin % gnc-fq-dump -v alphavantage IBM
Finance::Quote fields Gnucash uses:
    symbol: IBM                  &lt;=== required
      date: 07/02/2020           &lt;=== recommended
  currency: USD                  &lt;=== required
      last: 119.7000             &lt;=\
       nav:                      &lt;=== one of these
     price:                      &lt;=/
  timezone:                      &lt;=== optional

All fields returned by Finance::Quote for stock IBM

stock           field  value
-----           -----  -----
IBM             close: 119.7000
IBM          currency: USD
IBM        currency_set_by_fq: 1
IBM              date: 07/02/2020
IBM              high: 121.4200
IBM           isodate: 2020-07-02
IBM              last: 119.7000
IBM               low: 119.2600
IBM            method: alphavantage
IBM              open: 119.6900
IBM           success: 1
IBM            symbol: IBM
IBM            volume: 3732768
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1904300/1020415/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1020415">with headers</a>
<br />
<span class="downloadcontenttype">text/html 1.5k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1904700" href="/Public/Bug/Display.html?id=132937#txn-1904700">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;08&nbsp;09:40:23&nbsp;2020</span>
    <span class="description">quinn.baker [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1904700/1020594/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1020594">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 426b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Same problem here.
I suspect this has to do with TSP having added several new target-date funds last week. The table format on the price history web page how has several extra columns now, so the indexes and labels in the perl script need to be updated. The code has a comment that the index system should be re-written to handle these kinds of changes. The short-term fix is probably to add the new funds into the index list?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1904701" href="/Public/Bug/Display.html?id=132937#txn-1904701">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;08&nbsp;09:40:24&nbsp;2020</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1904704" href="/Public/Bug/Display.html?id=132937#txn-1904704">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;08&nbsp;10:06:45&nbsp;2020</span>
    <span class="description">rclar.in.dc [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #132937] FQ 1.49 TSP bug</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 8 Jul 2020 10:06:25 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Finance-Quote [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rclar &lt;rclar.in.dc [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1904704/1020598/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1020598">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 836b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Yeah, I hadn&#39;t seen that. It would appear that they did away with the 2020
fund, and introduced a bunch of half decade lifecycle ones....

Grrrr...

Thanks - I&#39;ll go with the short term fix for now, since that is within my
perl abilities!

On Wed, Jul 8, 2020 at 9:40 AM Quinn Baker via RT &lt;
bug-Finance-Quote@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=132937">https://rt.cpan.org/Ticket/Display.html?id=132937</a></span> &gt;
&gt;
&gt; Same problem here.
&gt; I suspect this has to do with TSP having added several new target-date
&gt; funds last week. The table format on the price history web page how has
&gt; several extra columns now, so the indexes and labels in the perl script
&gt; need to be updated. The code has a comment that the index system should be
&gt; re-written to handle these kinds of changes. The short-term fix is probably
&gt; to add the new funds into the index list?
&gt;
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1904704/1020599/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1020599">with headers</a>
<br />
<span class="downloadcontenttype">text/html 1.2k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1904706" href="/Public/Bug/Display.html?id=132937#txn-1904706">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;08&nbsp;11:06:44&nbsp;2020</span>
    <span class="description">quinn.baker [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1904706/1020602/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1020602">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 336b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Added the new funds in the attached version.
I also fixed an error in the script that was giving 1-day-old quotes.
It was taking the date from the first data row, but giving quote values from the next row down. I think the author didn&#39;t account for the header row being discarded automatically when they call HTML::TableExtract-&gt;new&#40;&#41;.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> TSP.pm</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1904706/1020603/TSP.pm">Download TSP.pm</a><br />
<span class="downloadcontenttype">text/x-perl 5.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w
#
#    Copyright &#40;C&#41; 1998, Dj Padzensky &lt;djpadz@padz.net&gt;
#    Copyright &#40;C&#41; 1998, 1999 Linas Vepstas &lt;linas@linas.org&gt;
#    Copyright &#40;C&#41; 2000, Yannick LE NY &lt;y-le-ny@ifrance.com&gt;
#    Copyright &#40;C&#41; 2000, Paul Fenwick &lt;pjf@cpan.org&gt;
#    Copyright &#40;C&#41; 2000, Brent Neal &lt;brentn@users.sourceforge.net&gt;
#    Copyright &#40;C&#41; 2001, Rob Sessink &lt;rob_ses@users.sourceforge.net&gt;
#    Copyright &#40;C&#41; 2004, Frank Mori Hess &lt;fmhess@users.sourceforge.net&gt;
#                        Trent Piepho &lt;xyzzy@spekeasy.org&gt;
#
#    This program is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 2 of the License, or
#    &#40;at your option&#41; any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program; if not, write to the Free Software
#    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
#    02111-1307, USA
#
#
# This code is derived from version 0.9 of the AEX.pm module.

require 5.005;

use strict;

package Finance::Quote::TSP;

use vars qw&#40; $TSP_URL $TSP_MAIN_URL %TSP_FUND_COLUMNS %TSP_FUND_NAMES&#41;;

use LWP::UserAgent;
use HTTP::Request::Common;
use HTML::TableExtract;

our $VERSION = &#39;1.49&#39;; # VERSION

# URLs of where to obtain information

$TSP_URL = &#39;<span class="clickylink"><a target="new" rel="nofollow" href="https://www.tsp.gov/InvestmentFunds/FundPerformance/index.html&#39;">https://www.tsp.gov/InvestmentFunds/FundPerformance/index.html&#39;</a></span>;
$TSP_MAIN_URL=&#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.tsp.gov">http://www.tsp.gov</a></span>&#34;&#41;;

# ENHANCE-ME: The decade target funds like 2020 appear and disappear.
# Better not to hard code them.
#
%TSP_FUND_COLUMNS = &#40;
    LINCOME =&gt; &#34;L INCOME&#34;,
    L2025   =&gt; &#34;L 2025&#34;,
    L2030   =&gt; &#34;L 2030&#34;,
    L2035   =&gt; &#34;L 2035&#34;,
    L2040   =&gt; &#34;L 2040&#34;,
    L2045   =&gt; &#34;L 2045&#34;,
    L2050   =&gt; &#34;L 2050&#34;,
    L2055   =&gt; &#34;L 2055&#34;,
    L2060   =&gt; &#34;L 2060&#34;,
    L2065   =&gt; &#34;L 2065&#34;,
    G       =&gt; &#34;G FUND&#34;,
    F       =&gt; &#34;F FUND&#34;,
    C       =&gt; &#34;C FUND&#34;,
    S       =&gt; &#34;S FUND&#34;,
    I       =&gt; &#34;I FUND&#34; &#41;;

%TSP_FUND_NAMES = &#40;
    LINCOME  =&gt; &#39;Lifecycle Income Fund&#39;,
    L2025    =&gt; &#39;Lifecycle 2025 Fund&#39;,
    L2030    =&gt; &#39;Lifecycle 2030 Fund&#39;,
    L2035    =&gt; &#39;Lifecycle 2035 Fund&#39;,
    L2040    =&gt; &#39;Lifecycle 2040 Fund&#39;,
    L2045    =&gt; &#39;Lifecycle 2045 Fund&#39;,
    L2050    =&gt; &#39;Lifecycle 2050 Fund&#39;,
    L2055    =&gt; &#39;Lifecycle 2055 Fund&#39;,
    L2060    =&gt; &#39;Lifecycle 2060 Fund&#39;,
    L2065    =&gt; &#39;Lifecycle 2065 Fund&#39;,
    G        =&gt; &#39;Government Securities Investment Fund&#39;,
    F        =&gt; &#39;Fixed Income Index Investment Fund&#39;,
    C        =&gt; &#39;Common Stock Index Investment Fund&#39;,
    S        =&gt; &#39;Small Capitalization Stock Index Investment Fund&#39;,
    I        =&gt; &#39;International Stock Index Investment Fund&#39; &#41;;

sub methods { return &#40;tsp =&gt; \&#38;tsp&#41; }

{
  my @labels = qw/name date isodate currency close/;
  sub labels { return &#40;tsp =&gt; \@labels&#41;; }
}

# ==============================================================================
sub tsp {
  my $quoter = shift;
  my @symbols = @_;

  return unless @symbols;

  my&#40;%info, %fundrows&#41;;
  my&#40;$ua, $reply, $row, $te, $ts, $first_row&#41;;

  $ua = $quoter-&gt;user_agent;
  $reply = $ua-&gt;request&#40;GET $TSP_URL&#41;;
  return unless &#40;$reply-&gt;is_success&#41;;
  $te = HTML::TableExtract-&gt;new&#40; headers =&gt;
      [&#34;Date&#34;, values %TSP_FUND_COLUMNS] &#41;;

  $te-&gt;parse&#40;$reply-&gt;content&#41;;

  # First row is newest data, older data follows, maybe there
  # should be some way to get it &#40;in addition to the second_row &#34;close&#34;&#41;
  $ts = $te-&gt;first_table_found
    || die &#39;TSP data table not recognised&#39;;
  $first_row = $ts-&gt;row&#40;0&#41;;

  # Make a hash that maps the order the columns are in
  for&#40;my $i=1; my $key = each %TSP_FUND_COLUMNS ; $i++&#41; {
    $fundrows{$key} = $i;
  }
  
  foreach &#40;@symbols&#41; {
    my $symbol = uc $_;

    if&#40;exists $fundrows{$symbol}&#41; {
      $info{$_, &#39;success&#39;} = 1;
      $info{$_, &#39;name&#39;} = $TSP_FUND_NAMES{$symbol};
      $quoter-&gt;store_date&#40;\%info, $_, {usdate =&gt; $$first_row[0]}&#41;;
      &#40;$info{$_, &#39;last&#39;} = $first_row-&gt;[$fundrows{$symbol}]&#41; =~ s/[^0-9]*&#40;[0-9.,]+&#41;.*/$1/s;
      $info{$_, &#39;currency&#39;} = &#39;USD&#39;;
      $info{$_, &#39;method&#39;} = &#39;tsp&#39;;
      $info{$_, &#39;source&#39;} = $TSP_MAIN_URL;
      $info{$_, &#39;symbol&#39;} = $_;
    } 
    else {
      $info{$_, &#39;success&#39;} = 0;
      $info{$_, &#39;errormsg&#39;} = &#34;Fund name unknown&#34;;
    }
  }
  return %info if wantarray;
  return \%info;
}
1;

=head1 NAME

Finance::Quote::TSP Obtain fund prices for US Federal Government Thrift Savings Plan

=head1 SYNOPSIS

    use Finance::Quote;

    $q = Finance::Quote-&gt;new;

    %info = Finance::Quote-&gt;fetch&#40;&#34;tsp&#34;,&#34;c&#34;&#41;; #get value of C &#34;Common Stock Index Investment&#34; Fund

=head1 DESCRIPTION

This module fetches fund information from the &#34;Thrift Savings Plan&#34;

    <span class="clickylink"><a target="new" rel="nofollow" href="http://www.tsp.gov">http://www.tsp.gov</a></span>

using its fund prices page

    <span class="clickylink"><a target="new" rel="nofollow" href="https://www.tsp.gov/investmentfunds/shareprice/sharePriceHistory.shtml">https://www.tsp.gov/investmentfunds/shareprice/sharePriceHistory.shtml</a></span>

The quote symbols are

    C          common stock fund
    F          fixed income fund
    G          government securities fund
    I          international stock fund
    S          small cap stock fund
    L2025      lifecycle fund year 2025
    L2030      lifecycle fund year 2030
    L2035      lifecycle fund year 2035
    L2040      lifecycle fund year 2040
    L2045      lifecycle fund year 2045
    L2050      lifecycle fund year 2050
    L2055      lifecycle fund year 2055
    L2060      lifecycle fund year 2060
    L2065      lifecycle fund year 2065
    LINCOME    lifecycle income fund

=head1 LABELS RETURNED

The following labels may be returned by Finance::Quote::TSP :

    name        eg. &#34;Lifecycle 2050 Fund&#34;
    date        latest date, eg. &#34;21/02/10&#34;
    isodate     latest date, eg. &#34;2010-02-21&#34;
    last        latest available price, eg. &#34;16.1053&#34;
    currency    &#34;USD&#34;
    method      &#34;tsp&#34;
    source      TSP URL

=head1 SEE ALSO

Thrift Savings Plan, <span class="clickylink"><a target="new" rel="nofollow" href="http://www.tsp.gov">http://www.tsp.gov</a></span>

=cut
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1905083" href="/Public/Bug/Display.html?id=132937#txn-1905083">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;12&nbsp;16:17:07&nbsp;2020</span>
    <span class="description">quinn.baker [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1905083/1020770/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1020770">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 101b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Of course TSP went and did a re-design of their website.
This version seems to work for me. For now.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> TSP.pm</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1905083/1020771/TSP.pm">Download TSP.pm</a><br />
<span class="downloadcontenttype">text/x-perl 5.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w
#
#    Copyright &#40;C&#41; 1998, Dj Padzensky &lt;djpadz@padz.net&gt;
#    Copyright &#40;C&#41; 1998, 1999 Linas Vepstas &lt;linas@linas.org&gt;
#    Copyright &#40;C&#41; 2000, Yannick LE NY &lt;y-le-ny@ifrance.com&gt;
#    Copyright &#40;C&#41; 2000, Paul Fenwick &lt;pjf@cpan.org&gt;
#    Copyright &#40;C&#41; 2000, Brent Neal &lt;brentn@users.sourceforge.net&gt;
#    Copyright &#40;C&#41; 2001, Rob Sessink &lt;rob_ses@users.sourceforge.net&gt;
#    Copyright &#40;C&#41; 2004, Frank Mori Hess &lt;fmhess@users.sourceforge.net&gt;
#                        Trent Piepho &lt;xyzzy@spekeasy.org&gt;
#
#    This program is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 2 of the License, or
#    &#40;at your option&#41; any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program; if not, write to the Free Software
#    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
#    02111-1307, USA
#
#
# This code is derived from version 0.9 of the AEX.pm module.

require 5.005;

use strict;

package Finance::Quote::TSP;

use vars qw&#40; $TSP_URL $TSP_MAIN_URL %TSP_FUND_COLUMNS %TSP_FUND_NAMES&#41;;

use LWP::UserAgent;
use HTTP::Request::Common;
use HTML::TableExtract;

our $VERSION = &#39;1.49&#39;; # VERSION

# URLs of where to obtain information

$TSP_URL = &#39;<span class="clickylink"><a target="new" rel="nofollow" href="https://secure.tsp.gov/components/CORS/getSharePrices.html?Lfunds=1&#38;InvFunds=1&#39;">https://secure.tsp.gov/components/CORS/getSharePrices.html?Lfunds=1&#38;InvFunds=1&#39;</a></span>;
$TSP_MAIN_URL=&#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://secure.tsp.gov">http://secure.tsp.gov</a></span>&#34;&#41;;

# ENHANCE-ME: The decade target funds like 2020 appear and disappear.
# Better not to hard code them.
#
%TSP_FUND_COLUMNS = &#40;
    LINCOME =&gt; &#34;L INCOME&#34;,
    L2025   =&gt; &#34;L 2025&#34;,
    L2030   =&gt; &#34;L 2030&#34;,
    L2035   =&gt; &#34;L 2035&#34;,
    L2040   =&gt; &#34;L 2040&#34;,
    L2045   =&gt; &#34;L 2045&#34;,
    L2050   =&gt; &#34;L 2050&#34;,
    L2055   =&gt; &#34;L 2055&#34;,
    L2060   =&gt; &#34;L 2060&#34;,
    L2065   =&gt; &#34;L 2065&#34;,
    G       =&gt; &#34;G FUND&#34;,
    F       =&gt; &#34;F FUND&#34;,
    C       =&gt; &#34;C FUND&#34;,
    S       =&gt; &#34;S FUND&#34;,
    I       =&gt; &#34;I FUND&#34; &#41;;

%TSP_FUND_NAMES = &#40;
    LINCOME  =&gt; &#39;Lifecycle Income Fund&#39;,
    L2025    =&gt; &#39;Lifecycle 2025 Fund&#39;,
    L2030    =&gt; &#39;Lifecycle 2030 Fund&#39;,
    L2035    =&gt; &#39;Lifecycle 2035 Fund&#39;,
    L2040    =&gt; &#39;Lifecycle 2040 Fund&#39;,
    L2045    =&gt; &#39;Lifecycle 2045 Fund&#39;,
    L2050    =&gt; &#39;Lifecycle 2050 Fund&#39;,
    L2055    =&gt; &#39;Lifecycle 2055 Fund&#39;,
    L2060    =&gt; &#39;Lifecycle 2060 Fund&#39;,
    L2065    =&gt; &#39;Lifecycle 2065 Fund&#39;,
    G        =&gt; &#39;Government Securities Investment Fund&#39;,
    F        =&gt; &#39;Fixed Income Index Investment Fund&#39;,
    C        =&gt; &#39;Common Stock Index Investment Fund&#39;,
    S        =&gt; &#39;Small Capitalization Stock Index Investment Fund&#39;,
    I        =&gt; &#39;International Stock Index Investment Fund&#39; &#41;;

sub methods { return &#40;tsp =&gt; \&#38;tsp&#41; }

{
  my @labels = qw/name date isodate currency close/;
  sub labels { return &#40;tsp =&gt; \@labels&#41;; }
}

# ==============================================================================
sub tsp {
  my $quoter = shift;
  my @symbols = @_;

  return unless @symbols;

  my&#40;%info, %fundrows&#41;;
  my&#40;$ua, $reply, $row, $te, $ts, $first_row&#41;;

  $ua = $quoter-&gt;user_agent;
  $reply = $ua-&gt;request&#40;GET $TSP_URL&#41;;
  return unless &#40;$reply-&gt;is_success&#41;;
  $te = HTML::TableExtract-&gt;new&#40; headers =&gt;
      [&#34;Date&#34;, values %TSP_FUND_COLUMNS] &#41;;

  $te-&gt;parse&#40;$reply-&gt;content&#41;;

  # First row is newest data, older data follows, maybe there
  # should be some way to get it &#40;in addition to the second_row &#34;close&#34;&#41;
  $ts = $te-&gt;first_table_found
    || die &#39;TSP data table not recognised&#39;;
  $first_row = $ts-&gt;row&#40;0&#41;;

  # Make a hash that maps the order the columns are in
  for&#40;my $i=1; my $key = each %TSP_FUND_COLUMNS ; $i++&#41; {
    $fundrows{$key} = $i;
  }
  
  foreach &#40;@symbols&#41; {
    my $symbol = uc $_;

    if&#40;exists $fundrows{$symbol}&#41; {
      $info{$_, &#39;success&#39;} = 1;
      $info{$_, &#39;name&#39;} = $TSP_FUND_NAMES{$symbol};
      $quoter-&gt;store_date&#40;\%info, $_, {usdate =&gt; $$first_row[0]}&#41;;
      &#40;$info{$_, &#39;last&#39;} = $first_row-&gt;[$fundrows{$symbol}]&#41; =~ s/[^0-9]*&#40;[0-9.,]+&#41;.*/$1/s;
      $info{$_, &#39;currency&#39;} = &#39;USD&#39;;
      $info{$_, &#39;method&#39;} = &#39;tsp&#39;;
      $info{$_, &#39;source&#39;} = $TSP_MAIN_URL;
      $info{$_, &#39;symbol&#39;} = $_;
    } 
    else {
      $info{$_, &#39;success&#39;} = 0;
      $info{$_, &#39;errormsg&#39;} = &#34;Fund name unknown&#34;;
    }
  }
  return %info if wantarray;
  return \%info;
}
1;

=head1 NAME

Finance::Quote::TSP Obtain fund prices for US Federal Government Thrift Savings Plan

=head1 SYNOPSIS

    use Finance::Quote;

    $q = Finance::Quote-&gt;new;

    %info = Finance::Quote-&gt;fetch&#40;&#34;tsp&#34;,&#34;c&#34;&#41;; #get value of C &#34;Common Stock Index Investment&#34; Fund

=head1 DESCRIPTION

This module fetches fund information from the &#34;Thrift Savings Plan&#34;

    <span class="clickylink"><a target="new" rel="nofollow" href="http://www.tsp.gov">http://www.tsp.gov</a></span>

using its fund prices page

    <span class="clickylink"><a target="new" rel="nofollow" href="https://www.tsp.gov/investmentfunds/shareprice/sharePriceHistory.shtml">https://www.tsp.gov/investmentfunds/shareprice/sharePriceHistory.shtml</a></span>

The quote symbols are

    C          common stock fund
    F          fixed income fund
    G          government securities fund
    I          international stock fund
    S          small cap stock fund
    L2025      lifecycle fund year 2025
    L2030      lifecycle fund year 2030
    L2035      lifecycle fund year 2035
    L2040      lifecycle fund year 2040
    L2045      lifecycle fund year 2045
    L2050      lifecycle fund year 2050
    L2055      lifecycle fund year 2055
    L2060      lifecycle fund year 2060
    L2065      lifecycle fund year 2065
    LINCOME    lifecycle income fund

=head1 LABELS RETURNED

The following labels may be returned by Finance::Quote::TSP :

    name        eg. &#34;Lifecycle 2050 Fund&#34;
    date        latest date, eg. &#34;21/02/10&#34;
    isodate     latest date, eg. &#34;2010-02-21&#34;
    last        latest available price, eg. &#34;16.1053&#34;
    currency    &#34;USD&#34;
    method      &#34;tsp&#34;
    source      TSP URL

=head1 SEE ALSO

Thrift Savings Plan, <span class="clickylink"><a target="new" rel="nofollow" href="http://www.tsp.gov">http://www.tsp.gov</a></span>

=cut
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1912868" href="/Public/Bug/Display.html?id=132937#txn-1912868">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;25&nbsp;10:20:45&nbsp;2020</span>
    <span class="description">brad [...] crochet.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1912868/1024562/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1024562">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 467b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Jul 12 16:17:07 2020, quinn.baker@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Of course TSP went and did a re-design of their website.
&gt; This version seems to work for me. For now.
</div>

Perhaps it is time to move this to using CSV, and not try to scrape?

<span class="clickylink"><a target="new" rel="nofollow" href="https://secure.tsp.gov/components/CORS/getSharePrices.html?startdate=20200826&#38;enddate=20200925&#38;Lfunds=1&#38;InvFunds=1&#38;format=CSV&#38;download=1">https://secure.tsp.gov/components/CORS/getSharePrices.html?startdate=20200826&#38;enddate=20200925&#38;Lfunds=1&#38;InvFunds=1&#38;format=CSV&#38;download=1</a></span>

That&#39;s a valid URL. If I have some time, I will attempt to rewrite the module to utilize this.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1912871" href="/Public/Bug/Display.html?id=132937#txn-1912871">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;25&nbsp;10:32:44&nbsp;2020</span>
    <span class="description">brad [...] crochet.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1912871/1024565/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1024565">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 615b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Sep 25 10:20:45 2020, brad@crochet.net wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sun Jul 12 16:17:07 2020, quinn.baker@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; Of course TSP went and did a re-design of their website.
&gt; &gt; This version seems to work for me. For now.
</div>&gt; 
&gt; 
&gt; Perhaps it is time to move this to using CSV, and not try to scrape?
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://secure.tsp.gov/components/CORS/getSharePrices.html?startdate=20200826&#38;enddate=20200925&#38;Lfunds=1&#38;InvFunds=1&#38;format=CSV&#38;download=1">https://secure.tsp.gov/components/CORS/getSharePrices.html?startdate=20200826&#38;enddate=20200925&#38;Lfunds=1&#38;InvFunds=1&#38;format=CSV&#38;download=1</a></span>
&gt; 
&gt; That&#39;s a valid URL. If I have some time, I will attempt to rewrite the
&gt; module to utilize this.
</div>
Never mind. I see that the latest code has been updated. Ignore me. :&#41;
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.514043</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
