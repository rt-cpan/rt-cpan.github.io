<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #128194 for Compress-Raw-Lzma: t/050interop-xz.t may fail &#40;memory leak?&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #128194 for Compress-Raw-Lzma: t/050interop-xz.t may fail &#40;memory leak?&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Compress-Raw-Lzma/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Compress-Raw-Lzma/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Compress-Raw-Lzma/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Compress-Raw-Lzma/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Compress-Raw-Lzma">Compress-Raw-Lzma CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">128194</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Compress-Raw-Lzma/Active/">Compress-Raw-Lzma</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
SREZIC [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-230202-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.084    </td>
  </tr>
  <tr id="CF-230203-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
2.085    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;07&nbsp;16:13:37&nbsp;2019</span>
    <span class="description">SREZIC [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> t/050interop-xz.t may fail &#40;memory leak?&#41;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On a few of my smokers the test suite fails like in this report:
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/cpan/report/ba2d8f26-11ca-11e9-b3e9-cc477c15f8a6">http://www.cpantesters.org/cpan/report/ba2d8f26-11ca-11e9-b3e9-cc477c15f8a6</a></span>

What&#39;s strange here: apparently system&#40;&#34;xz ...&#34;&#41; did not return 0, but $? is zero, as the diag&#40;&#41; output following the system&#40;&#41; call shows.

I could not reproduce the failure outside of CPAN.pm, e.g. using &#34;perl -Mblib t/050interop-xz.t&#34; or &#34;make test&#34;. But I could reproduce it with &#34;cpan -t .&#34;. An strace log shows the following line:

    19814 20:48:51.556543 clone&#40;child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD, child_tidptr=0x7f2d96c5e590&#41; = -1 ENOMEM &#40;Cannot allocate memory&#41; &lt;0.027514&gt;

So this would explain why it only fails under CPAN.pm: with CPAN.pm some ~350MB are already consumed and not available anymore &#40;this is a Debian/stretch VM with 1.6GB RAM&#41;.

For further debugging I put a process memory calculation function into the test script &#40; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/eserte/srezic-repository/blob/master/perl/currmem#L14">https://github.com/eserte/srezic-repository/blob/master/perl/currmem#L14</a></span> &#41; and this is the output:

t/050interop-xz.t .... 1/1006 151035904,107311104 at t/050interop-xz.t line 205.
151175168,107450368 at t/050interop-xz.t line 205.
117620736,73895936 at t/050interop-xz.t line 205.
151175168,107450368 at t/050interop-xz.t line 205.
151175168,107450368 at t/050interop-xz.t line 205.
151175168,107450368 at t/050interop-xz.t line 205.
168226816,124502016 at t/050interop-xz.t line 205.
t/050interop-xz.t .... 54/1006 168226816,124502016 at t/050interop-xz.t line 205.
168226816,124502016 at t/050interop-xz.t line 205.
168226816,124502016 at t/050interop-xz.t line 205.
134672384,90947584 at t/050interop-xz.t line 205.
134672384,90947584 at t/050interop-xz.t line 205.
168226816,124502016 at t/050interop-xz.t line 205.
168226816,124502016 at t/050interop-xz.t line 205.
168226816,124502016 at t/050interop-xz.t line 205.
101113856,57389056 at t/050interop-xz.t line 205.
101113856,57389056 at t/050interop-xz.t line 205.
101113856,57389056 at t/050interop-xz.t line 205.
101113856,57389056 at t/050interop-xz.t line 205.
134672384,90947584 at t/050interop-xz.t line 205.
168226816,124502016 at t/050interop-xz.t line 205.
168226816,124502016 at t/050interop-xz.t line 205.
294866944,251142144 at t/050interop-xz.t line 205.
487804928,444080128 at t/050interop-xz.t line 205.
806572032,762847232 at t/050interop-xz.t line 205.
# &#39;/usr/bin/xz -dc -F xz&#39; failed: 0

#     Failed test &#40;t/050interop-xz.t at line 207&#41;

#     Failed test &#40;t/050interop-xz.t at line 208&#41;

... &#40;etc&#41; ...

I assume that a fork &#40;or clone&#41; requires the same amount of memory as already used, so another ~800MB to the existing ~800MB is needed here. And it looks like there&#39;s a lot of memory consumption before the first test failure.

&#40;Another question is: why doesn&#39;t system&#40;&#41; return -1 in this situation?&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;07&nbsp;16:55:59&nbsp;2019</span>
    <span class="description">SREZIC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2019-01-07 16:13:37, SREZIC wrote:
[...]
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; What&#39;s strange here: apparently system&#40;&#34;xz ...&#34;&#41; did not return 0, but
&gt; $? is zero, as the diag&#40;&#41; output following the system&#40;&#41; call shows.
</div>[...]
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#40;Another question is: why doesn&#39;t system&#40;&#41; return -1 in this
&gt; situation?&#41;
</div>
Nonsense, system&#40;&#41; returned -1 in this situation. But if this happens then $? is meaningless, and $! has to be investigated. If the diag&#40;&#41; line is changed, e.g. like this

-    diag &#34;&#39;$comp&#39; failed: $?&#34;;
+    diag &#34;&#39;$comp&#39; failed: \$?=$? \$!=$!&#34;;

then the following is printed:

# &#39;/usr/bin/xz -dc -F xz&#39; failed: $?=0 $!=Cannot allocate memory
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;08&nbsp;03:53:29&nbsp;2019</span>
    <span class="description">pmqs [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Interesting. 

I knew that xz &#40;and lzma in general&#41; are very memory hungry, but this is surprising. Presumably running under cpan has almost, but not quite, exceeded the memory available on the box by the time it gets to that test. The interoperability tests then just push it over the edge.

I should be able catch the &#34;Cannot allocate memory&#34; errors when system is invoked, and output a better error message. Means the smoke will still be flagged a failing, but I don&#39;t think there is much I can about that.

thanks
Paul
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;08&nbsp;03:53:29&nbsp;2019</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;12&nbsp;08:35:28&nbsp;2019</span>
    <span class="description">SREZIC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2019-01-08 03:53:29, PMQS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Interesting.
&gt; 
&gt; I knew that xz &#40;and lzma in general&#41; are very memory hungry, but this
&gt; is surprising. Presumably running under cpan has almost, but not
&gt; quite, exceeded the memory available on the box by the time it gets to
&gt; that test. The interoperability tests then just push it over the edge.
&gt; 
&gt; I should be able catch the &#34;Cannot allocate memory&#34; errors when system
&gt; is invoked, and output a better error message. Means the smoke will
&gt; still be flagged a failing, but I don&#39;t think there is much I can
&gt; about that.
</div>
What probably does help here: doing &#34;undef $x&#34; in the compressWith&#40;&#41; subroutine, somewhere between writeFile&#40;&#41; and readWithXz&#40;&#41;. This would free memory allocated in the Compress::Raw::Lzma object before system&#40;&#41; is called, and the saving might be quite large, especially with preset=9. If I do this, then the currmem&#40;&#41; call shows relatively low allocated memory before the system&#40;&#41; call.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;12&nbsp;17:25:11&nbsp;2019</span>
    <span class="description">pmqs [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">...
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; What probably does help here: doing &#34;undef $x&#34; in the compressWith&#40;&#41;
&gt; subroutine, somewhere between writeFile&#40;&#41; and readWithXz&#40;&#41;. This would
&gt; free memory allocated in the Compress::Raw::Lzma object before
&gt; system&#40;&#41; is called, and the saving might be quite large, especially
&gt; with preset=9. If I do this, then the currmem&#40;&#41; call shows relatively
&gt; low allocated memory before the system&#40;&#41; call.
</div>

Just tried that on my setup along with your currmem function. It does seem to make a good difference.

Uploaded version 2.085 to CPAN. Will see how that gets on.

Thnaks again
Paul
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;13&nbsp;06:54:33&nbsp;2019</span>
    <span class="description">SREZIC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2019-01-12 17:25:11, PMQS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ...
<div class="message-stanza open">&gt; &gt;
&gt; &gt; What probably does help here: doing &#34;undef $x&#34; in the compressWith&#40;&#41;
&gt; &gt; subroutine, somewhere between writeFile&#40;&#41; and readWithXz&#40;&#41;. This
&gt; &gt; would
&gt; &gt; free memory allocated in the Compress::Raw::Lzma object before
&gt; &gt; system&#40;&#41; is called, and the saving might be quite large, especially
&gt; &gt; with preset=9. If I do this, then the currmem&#40;&#41; call shows relatively
&gt; &gt; low allocated memory before the system&#40;&#41; call.
</div>&gt; 
&gt; 
&gt; Just tried that on my setup along with your currmem function. It does
&gt; seem to make a good difference.
&gt; 
&gt; Uploaded version 2.085 to CPAN. Will see how that gets on.
&gt; 
</div>
Looks good now!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;13&nbsp;06:54:34&nbsp;2019</span>
    <span class="description">SREZIC [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;13&nbsp;06:54:34&nbsp;2019</span>
    <span class="description">SREZIC [...] cpan.org -  Fixed in 2.085 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
