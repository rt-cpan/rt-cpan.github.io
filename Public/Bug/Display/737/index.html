<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #737 for Data-UUID: Incorrect time based UUID</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #737 for Data-UUID: Incorrect time based UUID</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Data-UUID">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Data-UUID">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Data-UUID">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Data-UUID">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/rjbs/Data-UUID/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Data-UUID">Data-UUID CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">737</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Data-UUID">Data-UUID</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
rpb [...] hybyte.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-9410-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-9411-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




UUID.xs<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/70769/3591/UUID.xs">
Wed Jun 12 14:03:19 2002 (11.6k) by 
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=737">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-70769" href="/Public/Bug/Display.html?id=737#txn-70769">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;12&nbsp;14:03:19&nbsp;2002</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Incorrect time based UUID</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/70769/3590/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/3590">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 518b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Data::UUID version 0.06
Perl 5.6.0 for i586-linux
RedHat Linux 2.4.7-10

The timestamp encoded in the time based UUID is always within 214 seconds of 1970-01-01 00:00:00.

The code following the gettimeofday call is not casting one of the intermediate values correctly. 

I&#39;m not sure if the code I have replaced it with &#40;see attachment&#41; is efficient, but it appears to work.

This bug appears in the documentation - 4162f712-1dd2-11b2-b17e converts to a time very close to 1970-01-01 00:00:00.

Thanks for the module!
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/70769/3591/UUID.xs">Download UUID.xs</a><br />
<span class="downloadcontenttype">text/x-csrc 11.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#include &#34;EXTERN.h&#34;
#include &#34;perl.h&#34;
#include &#34;XSUB.h&#34;
#include &#34;UUID.h&#34;

static  uuid_t NameSpace_DNS = { /* 6ba7b810-9dad-11d1-80b4-00c04fd430c8 */
   0x6ba7b810,
   0x9dad,
   0x11d1,
   0x80, 0xb4, { 0x00, 0xc0, 0x4f, 0xd4, 0x30, 0xc8 }
};

static  uuid_t NameSpace_URL = { /* 6ba7b811-9dad-11d1-80b4-00c04fd430c8 */
   0x6ba7b811,
   0x9dad,
   0x11d1,
   0x80, 0xb4, { 0x00, 0xc0, 0x4f, 0xd4, 0x30, 0xc8 }
};

static  uuid_t NameSpace_OID = { /* 6ba7b812-9dad-11d1-80b4-00c04fd430c8 */
   0x6ba7b812,
   0x9dad,
   0x11d1,
   0x80, 0xb4, { 0x00, 0xc0, 0x4f, 0xd4, 0x30, 0xc8 }
};

uuid_t NameSpace_X500 = { /* 6ba7b814-9dad-11d1-80b4-00c04fd430c8 */
   0x6ba7b814,
   0x9dad,
   0x11d1,
   0x80, 0xb4, { 0x00, 0xc0, 0x4f, 0xd4, 0x30, 0xc8 }
};

static void format_uuid_v1&#40;
   uuid_t     *uuid, 
   unsigned16  clock_seq, 
   uuid_time_t timestamp, 
   uuid_node_t node
&#41; {
   uuid-&gt;time_low = &#40;unsigned long&#41;&#40;timestamp &#38; 0xFFFFFFFF&#41;;
   uuid-&gt;time_mid = &#40;unsigned short&#41;&#40;&#40;timestamp &gt;&gt; 32&#41; &#38; 0xFFFF&#41;;
   uuid-&gt;time_hi_and_version = &#40;unsigned short&#41;&#40;&#40;timestamp &gt;&gt; 48&#41; &#38;
      0x0FFF&#41;;

   uuid-&gt;time_hi_and_version |= &#40;1 &lt;&lt; 12&#41;;
   uuid-&gt;clock_seq_low = clock_seq &#38; 0xFF;
   uuid-&gt;clock_seq_hi_and_reserved = &#40;clock_seq &#38; 0x3F00&#41; &gt;&gt; 8;
   uuid-&gt;clock_seq_hi_and_reserved |= 0x80;
   memcpy&#40;&#38;uuid-&gt;node, &#38;node, sizeof uuid-&gt;node&#41;;
}

static void get_current_time&#40;uuid_time_t * timestamp&#41; {
   uuid_time_t        time_now;
   static uuid_time_t time_last;
   static unsigned16  uuids_this_tick;
   static int         inited = 0;

   if &#40;!inited&#41; {
      get_system_time&#40;&#38;time_now&#41;;
      uuids_this_tick = UUIDS_PER_TICK;
      inited = 1;
   };
   while &#40;1&#41; {
      get_system_time&#40;&#38;time_now&#41;;

      if &#40;time_last != time_now&#41; {
         uuids_this_tick = 0;
         break;
      };
      if &#40;uuids_this_tick &lt; UUIDS_PER_TICK&#41; {
         uuids_this_tick++;
         break;
      };
   };
   *timestamp = time_now + uuids_this_tick;
}

static unsigned16 true_random&#40;void&#41; {
   static int  inited = 0;
   uuid_time_t time_now;

   if &#40;!inited&#41; {
      get_system_time&#40;&#38;time_now&#41;;
      time_now = time_now/UUIDS_PER_TICK;
      srand&#40;&#40;unsigned int&#41;&#40;&#40;&#40;time_now &gt;&gt; 32&#41; ^ time_now&#41;&#38;0xffffffff&#41;&#41;;
      inited = 1;
    };
    return &#40;rand&#40;&#41;&#41;;
}

static void format_uuid_v3&#40;
   uuid_t        *uuid, 
   unsigned char  hash[16]
&#41; {
   memcpy&#40;uuid, hash, sizeof&#40;uuid_t&#41;&#41;;

   uuid-&gt;time_low            = ntohl&#40;uuid-&gt;time_low&#41;;
   uuid-&gt;time_mid            = ntohs&#40;uuid-&gt;time_mid&#41;;
   uuid-&gt;time_hi_and_version = ntohs&#40;uuid-&gt;time_hi_and_version&#41;;

   uuid-&gt;time_hi_and_version &#38;= 0x0FFF;
   uuid-&gt;time_hi_and_version |= &#40;3 &lt;&lt; 12&#41;;
   uuid-&gt;clock_seq_hi_and_reserved &#38;= 0x3F;
   uuid-&gt;clock_seq_hi_and_reserved |= 0x80;
}

static void get_system_time&#40;uuid_time_t *uuid_time&#41; {
#if defined __CYGWIN__
   ULARGE_INTEGER time;

   GetSystemTimeAsFileTime&#40;&#40;FILETIME *&#41;&#38;time&#41;;
   time.QuadPart +=
      &#40;unsigned __int64&#41; &#40;1000*1000*10&#41; * 
      &#40;unsigned __int64&#41; &#40;60 * 60 * 24&#41; * 
      &#40;unsigned __int64&#41; &#40;17+30+31+365*18+5&#41;;

   *uuid_time = time.QuadPart;
#else
   struct timeval tp;

   gettimeofday&#40;&#38;tp, &#40;struct timezone *&#41;0&#41;;
	*uuid_time = tp.tv_sec;
	*uuid_time *= 10000000;
	*uuid_time += tp.tv_usec * 10;
        *uuid_time += I64&#40;0x01B21DD213814000&#41;;
#endif
}

static void get_random_info&#40;unsigned char seed[16]&#41; {
   MD5_CTX c;
#if defined __CYGWIN__
   typedef struct {
      MEMORYSTATUS  m;
      SYSTEM_INFO   s;
      FILETIME      t;
      LARGE_INTEGER pc;
      DWORD         tc;
      DWORD         l;
      char          hostname[MAX_COMPUTERNAME_LENGTH + 1];
   } randomness;
#else
   typedef struct {
      long           hostid;
      struct timeval t;
      char           hostname[257];
   } randomness;
#endif
   randomness r;

   MD5Init&#40;&#38;c&#41;;

#if defined __CYGWIN__
   GlobalMemoryStatus&#40;&#38;r.m&#41;;
   GetSystemInfo&#40;&#38;r.s&#41;;
   GetSystemTimeAsFileTime&#40;&#38;r.t&#41;;
   QueryPerformanceCounter&#40;&#38;r.pc&#41;;
   r.tc = GetTickCount&#40;&#41;;
   r.l = MAX_COMPUTERNAME_LENGTH + 1;
   GetComputerName&#40;r.hostname, &#38;r.l &#41;;
#else
   r.hostid = gethostid&#40;&#41;;
   gettimeofday&#40;&#38;r.t, &#40;struct timezone *&#41;0&#41;;
   gethostname&#40;r.hostname, 256&#41;;
#endif

   MD5Update&#40;&#38;c, &#40;unsigned char*&#41;&#38;r, sizeof&#40;randomness&#41;&#41;;
   MD5Final&#40;seed, &#38;c&#41;;
}

SV* make_ret&#40;const uuid_t u, int type&#41; {
   char           buf[BUFSIZ];
   unsigned char *from, *to;
   STRLEN         len;
   int            i;

   memset&#40;buf, 0x00, BUFSIZ&#41;;
   switch&#40;type&#41; {
   case F_BIN:
      memcpy&#40;buf, &#40;void*&#41;&#38;u, sizeof&#40;uuid_t&#41;&#41;;
      len = sizeof&#40;uuid_t&#41;;
      break;
   case F_STR:
      sprintf&#40;buf, &#34;%8.8X-%4.4X-%4.4X-%2.2X%2.2X-&#34;, &#40;unsigned int&#41;u.time_low, u.time_mid,
	 u.time_hi_and_version, u.clock_seq_hi_and_reserved, u.clock_seq_low&#41;;
      for&#40;i = 0; i &lt; 6; i++ &#41; 
	 sprintf&#40;buf+strlen&#40;buf&#41;, &#34;%2.2X&#34;, u.node[i]&#41;;
      len = strlen&#40;buf&#41;;
      break;
   case F_HEX:
      sprintf&#40;buf, &#34;0x%8.8X%4.4X%4.4X%2.2X%2.2X&#34;, &#40;unsigned int&#41;u.time_low, u.time_mid,
	 u.time_hi_and_version, u.clock_seq_hi_and_reserved, u.clock_seq_low&#41;;
      for&#40;i = 0; i &lt; 6; i++ &#41; 
	 sprintf&#40;buf+strlen&#40;buf&#41;, &#34;%2.2X&#34;, u.node[i]&#41;;
      len = strlen&#40;buf&#41;;
      break;
   case F_B64:
      for&#40;from = &#40;unsigned char*&#41;&#38;u, to = &#40;unsigned char*&#41;buf, i = sizeof&#40;u&#41;; 
	  i &gt; 0; i -= 3, from += 3&#41; {
         *to++ = base64[from[0]&gt;&gt;2];
         switch&#40;i&#41; {
	 case 1:
	    *to++ = base64[&#40;from[0]&#38;0x03&#41;&lt;&lt;4];
	    *to++ = &#39;=&#39;;
	    *to++ = &#39;=&#39;;
	     break;
         case 2:
	    *to++ = base64[&#40;&#40;from[0]&#38;0x03&#41;&lt;&lt;4&#41; | &#40;&#40;from[1]&#38;0xF0&#41;&gt;&gt;4&#41;];
	    *to++ = base64[&#40;from[1]&#38;0x0F&#41;&lt;&lt;2];
	    *to++ = &#39;=&#39;;
	     break;
         default:
	    *to++ = base64[&#40;&#40;from[0]&#38;0x03&#41;&lt;&lt;4&#41; | &#40;&#40;from[1]&#38;0xF0&#41;&gt;&gt;4&#41;];
	    *to++ = base64[&#40;&#40;from[1]&#38;0x0F&#41;&lt;&lt;2&#41; | &#40;&#40;from[2]&#38;0xC0&#41;&gt;&gt;6&#41;];
	    *to++ = base64[&#40;from[2]&#38;0x3F&#41;];
         }
      }	    
      len = strlen&#40;buf&#41;;
      break;
   default:
      croak&#40;&#34;invalid type: %d\n&#34;, type&#41;;
      break;
   }
   return sv_2mortal&#40;newSVpv&#40;buf,len&#41;&#41;;
}
      
MODULE = Data::UUID		PACKAGE = Data::UUID		

PROTOTYPES: DISABLE

void
constant&#40;sv,arg&#41;
PREINIT:
   STRLEN  len;
   char   *pv;
INPUT:
   SV   *sv
   char *s = SvPV&#40;sv, len&#41;;
PPCODE:
   pv = 0; len = sizeof&#40;uuid_t&#41;;
   if &#40;strEQ&#40;s,&#34;NameSpace_DNS&#34;&#41;&#41;
      pv = &#40;char*&#41;&#38;NameSpace_DNS;
   if &#40;strEQ&#40;s,&#34;NameSpace_URL&#34;&#41;&#41;
      pv = &#40;char*&#41;&#38;NameSpace_URL;
   if &#40;strEQ&#40;s,&#34;NameSpace_X500&#34;&#41;&#41;
      pv = &#40;char*&#41;&#38;NameSpace_X500;
   if &#40;strEQ&#40;s,&#34;NameSpace_OID&#34;&#41;&#41;
      pv = &#40;char*&#41;&#38;NameSpace_OID;
   ST&#40;0&#41; = sv_2mortal&#40;newSVpv&#40;pv, len&#41;&#41;;
   XSRETURN&#40;1&#41;;

uuid_context_t*
new&#40;class&#41;
   char *class;
PREINIT:
   FILE          *fd;
   unsigned char  seed[16];
   uuid_time_t    timestamp;
   mode_t         mask;
CODE:
   Newz&#40;0,RETVAL,1,uuid_context_t&#41;;
   if &#40;&#40;fd = fopen&#40;UUID_STATE_NV_STORE, &#34;rb&#34;&#41;&#41;&#41; {
      fread&#40;&#38;&#40;RETVAL-&gt;state&#41;, sizeof&#40;uuid_state_t&#41;, 1, fd&#41;;
      fclose&#40;fd&#41;;
      get_current_time&#40;&#38;timestamp&#41;;
      RETVAL-&gt;next_save = timestamp;
   }
   if &#40;&#40;fd = fopen&#40;UUID_NODEID_NV_STORE, &#34;rb&#34;&#41;&#41;&#41; {
      fread&#40;&#38;&#40;RETVAL-&gt;nodeid&#41;, sizeof&#40;uuid_node_t&#41;, 1, fd &#41;;
      fclose&#40;fd&#41;;
   } else {
      get_random_info&#40;seed&#41;;
      seed[0] |= 0x80;
      memcpy&#40;&#38;&#40;RETVAL-&gt;nodeid&#41;, seed, sizeof&#40;uuid_node_t&#41;&#41;;
      mask = umask&#40;0&#41;;
      if &#40;&#40;fd = fopen&#40;UUID_NODEID_NV_STORE, &#34;wb&#34;&#41;&#41;&#41; {
         fwrite&#40;&#38;&#40;RETVAL-&gt;nodeid&#41;, sizeof&#40;uuid_node_t&#41;, 1, fd&#41;;
         fclose&#40;fd&#41;;
      };
      umask&#40;mask&#41;;
   }
   errno = 0; 
OUTPUT:
   RETVAL

void
create&#40;self&#41;
   uuid_context_t *self;
ALIAS:
   Data::UUID::create_bin = F_BIN
   Data::UUID::create_str = F_STR
   Data::UUID::create_hex = F_HEX
   Data::UUID::create_b64 = F_B64
PREINIT:
   uuid_time_t  timestamp;
   unsigned16   clockseq;
   uuid_t       uuid;
   FILE        *fd;
   mode_t       mask;
PPCODE:
   clockseq = self-&gt;state.cs;
   get_current_time&#40;&#38;timestamp&#41;;
   if &#40; self-&gt;state.ts == I64&#40;0&#41; ||
      memcmp&#40;&#38;&#40;self-&gt;nodeid&#41;, &#38;&#40;self-&gt;state.node&#41;, sizeof&#40;uuid_node_t&#41;&#41;&#41;
      clockseq = true_random&#40;&#41;;
   else if &#40;timestamp &lt; self-&gt;state.ts&#41;
      clockseq++;

   format_uuid_v1&#40;&#38;uuid, clockseq, timestamp, self-&gt;nodeid&#41;;
   self-&gt;state.node = self-&gt;nodeid;
   self-&gt;state.ts   = timestamp;
   self-&gt;state.cs   = clockseq;
   if &#40;timestamp &gt; self-&gt;next_save &#41; {
      mask = umask&#40;0&#41;;
      if&#40;&#40;fd = fopen&#40;UUID_STATE_NV_STORE, &#34;wb&#34;&#41;&#41;&#41; {
	 LOCK&#40;fd&#41;;
         fwrite&#40;&#38;&#40;self-&gt;state&#41;, sizeof&#40;uuid_state_t&#41;, 1, fd&#41;;
	 UNLOCK&#40;fd&#41;;
         fclose&#40;fd&#41;;
      }
      umask&#40;mask&#41;;
      self-&gt;next_save = timestamp + &#40;10 * 10 * 1000 * 1000&#41;;
   }
   ST&#40;0&#41; = make_ret&#40;uuid, ix&#41;;
   XSRETURN&#40;1&#41;;

void
create_from_name&#40;self,nsid,name&#41;
   uuid_context_t *self;
   uuid_t         *nsid;
   char           *name;
ALIAS:
   Data::UUID::create_from_name_bin = F_BIN
   Data::UUID::create_from_name_str = F_STR
   Data::UUID::create_from_name_hex = F_HEX
   Data::UUID::create_from_name_b64 = F_B64
PREINIT:
   MD5_CTX       c;
   unsigned char hash[16];
   uuid_t        net_nsid; 
   uuid_t        uuid;
PPCODE:
   net_nsid = *nsid;
   net_nsid.time_low            = htonl&#40;net_nsid.time_low&#41;;
   net_nsid.time_mid            = htons&#40;net_nsid.time_mid&#41;;
   net_nsid.time_hi_and_version = htons&#40;net_nsid.time_hi_and_version&#41;;

   MD5Init&#40;&#38;c&#41;;
   MD5Update&#40;&#38;c, &#40;unsigned char*&#41;&#38;net_nsid, sizeof&#40;uuid_t&#41;&#41;;
   MD5Update&#40;&#38;c, &#40;unsigned char*&#41;name, strlen&#40;name&#41;&#41;;
   MD5Final&#40;hash, &#38;c&#41;;

   format_uuid_v3&#40;&#38;uuid, hash&#41;;
   ST&#40;0&#41; = make_ret&#40;uuid, ix&#41;;
   XSRETURN&#40;1&#41;;

int 
compare&#40;self,u1,u2&#41;
   uuid_context_t *self;
   uuid_t         *u1; 
   uuid_t         *u2;
PREINIT:
   int i;
CODE:
   RETVAL = 0;
   CHECK&#40;u1-&gt;time_low, u2-&gt;time_low&#41;;
   CHECK&#40;u1-&gt;time_mid, u2-&gt;time_mid&#41;;
   CHECK&#40;u1-&gt;time_hi_and_version, u2-&gt;time_hi_and_version&#41;;
   CHECK&#40;u1-&gt;clock_seq_hi_and_reserved, u2-&gt;clock_seq_hi_and_reserved&#41;;
   CHECK&#40;u1-&gt;clock_seq_low, u2-&gt;clock_seq_low&#41;;
   for &#40;i = 0; i &lt; 6; i++&#41; {
      if &#40;u1-&gt;node[i] &lt; u2-&gt;node[i]&#41;
         RETVAL = -1;
      if &#40;u1-&gt;node[i] &gt; u2-&gt;node[i]&#41;
         RETVAL =  1;
   }
OUTPUT:
   RETVAL

void
to_string&#40;self,uuid&#41;
   uuid_context_t *self;
   uuid_t         *uuid;
ALIAS:
   Data::UUID::to_hexstring = F_HEX
   Data::UUID::to_b64string = F_B64
PPCODE:
   ST&#40;0&#41; = make_ret&#40;*uuid, ix ? ix : F_STR&#41;;
   XSRETURN&#40;1&#41;;

void
from_string&#40;self,str&#41; 
   uuid_context_t *self;
   char           *str;
ALIAS:
   Data::UUID::from_hexstring = F_HEX
   Data::UUID::from_b64string = F_B64
PREINIT:
   uuid_t         uuid;
   char          *from, *to;
   int            i, c;
   unsigned char  buf[4];
PPCODE:
   switch&#40;ix&#41; {
   case F_BIN:
   case F_STR:
   case F_HEX:
      from = str;
      memset&#40;&#38;uuid, 0x00, sizeof&#40;uuid_t&#41;&#41;;
      if &#40; from[0] == &#39;0&#39; &#38;&#38; from[1] == &#39;x&#39; &#41;
         from += 2;
      for &#40;i = 0; i &lt; sizeof&#40;uuid_t&#41;; i++&#41; {
         if &#40;*from == &#39;-&#39;&#41;
	    from++; 
         if &#40;sscanf&#40;from, &#34;%2x&#34;, &#38;c&#41; != 1&#41; 
	    croak&#40;&#34;from_string&#40;%s&#41; failed...\n&#34;, str&#41;;
         &#40;&#40;unsigned char*&#41;&#38;uuid&#41;[i] = &#40;unsigned char&#41;c;
         from += 2;
      }
      uuid.time_low            = ntohl&#40;uuid.time_low&#41;;
      uuid.time_mid            = ntohs&#40;uuid.time_mid&#41;;
      uuid.time_hi_and_version = ntohs&#40;uuid.time_hi_and_version&#41;;
      break;
   case F_B64:
      from = str; to = &#40;char*&#41;&#38;uuid;
      while&#40;from &lt; &#40;str + strlen&#40;str&#41;&#41;&#41; {
	 i = 0; memset&#40;buf, 254, 4&#41;;
	 do {
	    c = index64[&#40;int&#41;*from++];
	    if &#40;c != 255&#41; buf[i++] = &#40;unsigned char&#41;c;
	    if &#40;from == &#40;str + strlen&#40;str&#41;&#41;&#41; 
	       break;
         } while &#40;i &lt; 4&#41;;

	 if &#40;buf[0] == 254 || buf[1] == 254&#41; 
	    break;
         *to++ = &#40;buf[0] &lt;&lt; 2&#41; | &#40;&#40;buf[1] &#38; 0x30&#41; &gt;&gt; 4&#41;;

	 if &#40;buf[2] == 254&#41; break;
	 *to++ = &#40;&#40;buf[1] &#38; 0x0F&#41; &lt;&lt; 4&#41; | &#40;&#40;buf[2] &#38; 0x3C&#41; &gt;&gt; 2&#41;;

	 if &#40;buf[3] == 254&#41; break;
	 *to++ = &#40;&#40;buf[2] &#38; 0x03&#41; &lt;&lt; 6&#41; | buf[3];
      }
      break;
   default:
      croak&#40;&#34;invalid type %d\n&#34;, ix&#41;;
      break;
   }
   ST&#40;0&#41; = make_ret&#40;uuid, F_BIN&#41;;
   XSRETURN&#40;1&#41;;

void
DESTROY&#40;self&#41;
   uuid_context_t *self;
PREINIT:
   FILE           *fd;
CODE:
   if &#40;&#40;fd = fopen&#40;UUID_STATE_NV_STORE, &#34;wb&#34;&#41;&#41;&#41; {
      LOCK&#40;fd&#41;;
      fwrite&#40;&#38;&#40;self-&gt;state&#41;, sizeof&#40;uuid_state_t&#41;, 1, fd&#41;;
      UNLOCK&#40;fd&#41;;
      fclose&#40;fd&#41;;
   };
   Safefree&#40;self&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-70770" href="/Public/Bug/Display.html?id=737#txn-70770">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;12&nbsp;14:45:17&nbsp;2002</span>
    <span class="description">golomshtok_alexander [...] jpmorgan.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #737] Incorrect time based UUID</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Data-UUID [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> golomshtok_alexander [...] jpmorgan.com</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 12 Jun 2002 14:45:11 -0400</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/70770/3592/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/3592">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
thank you....will make sure i include your fix in the new release &#40;in a
coupla weeks&#41;...
regards,
alex g





bug-Data-UUID@rt.cpan.org on 06/12/2002 02:03:20 PM

Please respond to bug-Data-UUID@rt.cpan.org

To:    &#34;&#39;AdminCc of cpan Ticket #737&#39;&#34;: ;:;@
cc:
Subject:    [cpan #737] Incorrect time based UUID




This message about Data-UUID was sent to you by guest via rt.cpan.org

Full context and any attached attachments can be found at:
&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=737">https://rt.cpan.org/Ticket/Display.html?id=737</a></span> &gt;

Data::UUID version 0.06
Perl 5.6.0 for i586-linux
RedHat Linux 2.4.7-10

The timestamp encoded in the time based UUID is always within 214 seconds
of 1970-01-01 00:00:00.

The code following the gettimeofday call is not casting one of the
intermediate values correctly.

I&#39;m not sure if the code I have replaced it with &#40;see attachment&#41; is
efficient, but it appears to work.

This bug appears in the documentation - 4162f712-1dd2-11b2-b17e converts to
a time very close to 1970-01-01 00:00:00.

Thanks for the module!







This communication is for informational purposes only.  It is not intended as
an offer or solicitation for the purchase or sale of any financial instrument
or as an official confirmation of any transaction. All market prices, data
and other information are not warranted as to completeness or accuracy and
are subject to change without notice. Any comments or statements made herein
do not necessarily reflect those of J.P. Morgan Chase &#38; Co., its
subsidiaries and affiliates.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-70771" href="/Public/Bug/Display.html?id=737#txn-70771">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;14&nbsp;11:58:31&nbsp;2002</span>
    <span class="description">rpb [...] hybyte.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Rodger Bagnall&#34; &lt;rpb [...] hybyte.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-Data-UUID [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #737] AutoReply: Incorrect time based UUID</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 14 Jun 2002 16:58:25 +0100</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/70771/3662/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/3662">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 49b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Version 0.07 fixes this bug. Please close 737.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-177474" href="/Public/Bug/Display.html?id=737#txn-177474">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;16&nbsp;18:56:25&nbsp;2006</span>
    <span class="description">rjbs [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.305199</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
