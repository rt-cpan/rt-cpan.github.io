<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #100551 for SQL-Statement: The output of the conv&#40;&#41; function does not contain significant trailing zeros</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #100551 for SQL-Statement: The output of the conv&#40;&#41; function does not contain significant trailing zeros</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/SQL-Statement/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/SQL-Statement/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/SQL-Statement/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/SQL-Statement/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/SQL-Statement">SQL-Statement CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">100551</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/SQL-Statement/Active/">SQL-Statement</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
wyant [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-29588-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-29589-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.406_002    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;25&nbsp;12:52:05&nbsp;2014</span>
    <span class="description">wyant [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> The output of the conv&#40;&#41; function does not contain significant
 trailing zeros</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">An example of this is the fact that
  select conv&#40;&#39;16&#39;, 10, 16&#41;
produces &#39;1&#39;, not &#39;10&#39;

The problem seems to be that SQL::Statement::Functions-&gt;SQL_FUNCTION_CONV&#40;&#41; never produces trailing zeros when converting integers, execpt maybe for the degenerate case where the input and output radix are the same. A patch against commit 08b12032b34126d00e4246e1ce595257e3e3bbd1 &#40;the latest as of about 2014-11-25 16:00 GMT&#41; is attached, because I am not Git-savvy enough to generate a pull request, and don&#39;t have a GITHUB account anyway, I&#39;m afraid. Sorry.

This behavior of the conv&#40;&#41; function appears to have a number of causes:

1&#41; The &#34;Final cleanup&#34; code at about line 594 removes all leading zeros, even if it leaves an empty string.

2&#41; The short-circuit code at or about line 542 of the module is not executed, because line 489 &#40;or thereabouts&#41; forces $use_big to be true. So the generic output conversion code is always used.

3&#41; The output conversion code at and after about line 564 &#40;the &#39;while&#39; loop&#41; works left-to-right through the number to be converted. As coded, this loop exits whenever the unconverted number is found to be 0, without provision for appending any needed trailing zeroes.

The patch contains proposed fixes as follows:

1&#41; Alter the regular expressions to leave a zero before the end of the string or a decimal point.

2&#41; No action. I ran &#39;git blame&#39; on the module, and the code that forces $use_big true is the same commit as the rest of the method. Since I did not have relevant history on why this line is there, I left it alone.

3&#41; Alter the condition of the &#39;while&#39; loop so that it requires both $i &gt;= 0 and $dnum == 0 for loop exit.

I have added a couple tests to t/06virtual.t to test these changes. All of t/06virtual.t passes under my builds of Perl 5.8.9 and 5.20.1.

There is actually something else going on in this method which I have been unable to run to earth. If I understand the intent of the conv&#40;&#41; function, &#34;select conv&#40;&#39;16.1&#39;, 10, 16&#41;&#34; should produce &#39;10.1&#39;. In fact, it produces &#39;A1&#39;. The patches do not affect this behavior.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> SQL-Statement-Functions.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/lib/SQL/Statement/Functions.pm b/lib/SQL/Statement/Functions.pm
index 813c1a5..9c7c8c9 100644
--- a/lib/SQL/Statement/Functions.pm
+++ b/lib/SQL/Statement/Functions.pm
@@ -561,7 +561,7 @@ sub SQL_FUNCTION_CONV
           &#41;-&gt;bfloor&#40;&#41;-&gt;bstr&#40;&#41;
           : int&#40; log&#40;$dnum&#41; / log&#40;$ebase&#41; &#41;;
 
-        while &#40; $dnum != 0 &#38;&#38; length&#40;$new&#41; &lt; 255 &#41;
+        while &#40; &#40; $dnum != 0 || $i &gt;= 0 &#41; &#38;&#38; length&#40;$new&#41; &lt; 255 &#41;
         {
             if &#40; $i == -1 &#41;
             {     # time to go pro...
@@ -591,8 +591,8 @@ sub SQL_FUNCTION_CONV
     }
 
     # Final cleanup
-    $new =~ s/^&#40;-?&#41;0+/$1/ if &#40; $ebase &lt;= 62 &#41;;
-    $new =~ s/^&#40;-?&#41;A+/$1/ if &#40; $ebase &gt; 62 &#41;;
+    $new =~ s/^&#40;-?&#41;&#40;?:0&#40;?!&#40;?:\.|\z&#41;&#41;&#41;+/$1/ if &#40; $ebase &lt;= 62 &#41;;
+    $new =~ s/^&#40;-?&#41;&#40;?:A&#40;?!&#40;?:\.|\z&#41;&#41;&#41;+/$1/ if &#40; $ebase &gt; 62 &#41;;
     $new =~ s/0+$//       if &#40; $ebase &lt;= 62 &#38;&#38; $is_dec &#41;;
     $new =~ s/A+$//       if &#40; $ebase &gt; 62 &#38;&#38; $is_dec &#41;;
 
diff --git a/t/06virtual.t b/t/06virtual.t
index 72c6c87..d285ab2 100644
--- a/t/06virtual.t
+++ b/t/06virtual.t
@@ -528,6 +528,21 @@ foreach my $test_dbd &#40;@test_dbds&#41;
            sql    =&gt; &#34;SELECT CONV&#40;&#39;1AF.EQO0000000000000000000000000000&#39;, 32, 8&#41;&#34;,
            result =&gt; [ [2517.3553] ],
         },
+	{
+           test   =&gt; &#39;conv 10-&gt;16 integer with trailing 0&#39;,
+	   sql    =&gt; &#34;select conv&#40;&#39;16&#39;, 10, 16&#41;&#34;,
+	   result =&gt; [ [&#39;10&#39;] ],
+	},
+	{
+           test   =&gt; &#39;conv 10-&gt;16 float with trailing 0 in integer part&#39;,
+	   sql    =&gt; &#34;select conv&#40;&#39;16.1&#39;, 10, 16&#41;&#34;,
+	   result =&gt; [ [&#39;10.1&#39;] ],
+	},
+	{
+           test   =&gt; &#39;conv 10-&gt;16 integer 0&#39;,
+	   sql    =&gt; &#34;select conv&#40;&#39;0&#39;, 10, 16&#41;&#34;,
+	   result =&gt; [ [&#39;0&#39;] ],
+	},
         {
            test =&gt; &#39;decode&#39;,
            sql =&gt;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;25&nbsp;12:55:29&nbsp;2014</span>
    <span class="description">wyant [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Correction to the patch, which contained one test too many. The corrected patch is attached. Sorry about that.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> SQL-Statement-Functions.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/lib/SQL/Statement/Functions.pm b/lib/SQL/Statement/Functions.pm
index 813c1a5..9c7c8c9 100644
--- a/lib/SQL/Statement/Functions.pm
+++ b/lib/SQL/Statement/Functions.pm
@@ -561,7 +561,7 @@ sub SQL_FUNCTION_CONV
           &#41;-&gt;bfloor&#40;&#41;-&gt;bstr&#40;&#41;
           : int&#40; log&#40;$dnum&#41; / log&#40;$ebase&#41; &#41;;
 
-        while &#40; $dnum != 0 &#38;&#38; length&#40;$new&#41; &lt; 255 &#41;
+        while &#40; &#40; $dnum != 0 || $i &gt;= 0 &#41; &#38;&#38; length&#40;$new&#41; &lt; 255 &#41;
         {
             if &#40; $i == -1 &#41;
             {     # time to go pro...
@@ -591,8 +591,8 @@ sub SQL_FUNCTION_CONV
     }
 
     # Final cleanup
-    $new =~ s/^&#40;-?&#41;0+/$1/ if &#40; $ebase &lt;= 62 &#41;;
-    $new =~ s/^&#40;-?&#41;A+/$1/ if &#40; $ebase &gt; 62 &#41;;
+    $new =~ s/^&#40;-?&#41;&#40;?:0&#40;?!&#40;?:\.|\z&#41;&#41;&#41;+/$1/ if &#40; $ebase &lt;= 62 &#41;;
+    $new =~ s/^&#40;-?&#41;&#40;?:A&#40;?!&#40;?:\.|\z&#41;&#41;&#41;+/$1/ if &#40; $ebase &gt; 62 &#41;;
     $new =~ s/0+$//       if &#40; $ebase &lt;= 62 &#38;&#38; $is_dec &#41;;
     $new =~ s/A+$//       if &#40; $ebase &gt; 62 &#38;&#38; $is_dec &#41;;
 
diff --git a/t/06virtual.t b/t/06virtual.t
index 72c6c87..9b93f73 100644
--- a/t/06virtual.t
+++ b/t/06virtual.t
@@ -528,6 +528,16 @@ foreach my $test_dbd &#40;@test_dbds&#41;
            sql    =&gt; &#34;SELECT CONV&#40;&#39;1AF.EQO0000000000000000000000000000&#39;, 32, 8&#41;&#34;,
            result =&gt; [ [2517.3553] ],
         },
+	{
+           test   =&gt; &#39;conv 10-&gt;16 integer with trailing 0&#39;,
+	   sql    =&gt; &#34;select conv&#40;&#39;16&#39;, 10, 16&#41;&#34;,
+	   result =&gt; [ [&#39;10&#39;] ],
+	},
+	{
+           test   =&gt; &#39;conv 10-&gt;16 integer 0&#39;,
+	   sql    =&gt; &#34;select conv&#40;&#39;0&#39;, 10, 16&#41;&#34;,
+	   result =&gt; [ [&#39;0&#39;] ],
+	},
         {
            test =&gt; &#39;decode&#39;,
            sql =&gt;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;26&nbsp;03:52:19&nbsp;2014</span>
    <span class="description">REHSACK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Tom,

first: thanks for the hint. At the moment I have no clue what ANSI SQL defines - and I fear I don&#39;t have time next few weeks to prove &#40;missing trailing zeros is a bug, however - no questions about that&#41;.

You&#39;re patch looks as a very good fundament to continuesly work on. If you want be credited for, feel free to send the patch also as Pull Request via GitHub. Otherwise I will commit it using your mail address as author.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;26&nbsp;03:52:20&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;26&nbsp;03:42:33&nbsp;2015</span>
    <span class="description">REHSACK [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;May&nbsp;26&nbsp;03:42:34&nbsp;2015</span>
    <span class="description">REHSACK [...] cpan.org -  Fixed in 1.406_002 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
