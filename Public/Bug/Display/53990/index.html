<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #53990 for Mail-IMAPClient: connection closes while waiting for folder lock</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #53990 for Mail-IMAPClient: connection closes while waiting for folder lock</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Mail-IMAPClient">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Mail-IMAPClient">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Mail-IMAPClient">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Mail-IMAPClient">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-IMAPClient">Mail-IMAPClient CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">53990</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Mail-IMAPClient">Mail-IMAPClient</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">PLOBBES [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
MARKLE [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-19960-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
3.22    </td>
  </tr>
  <tr id="CF-19961-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




imap_debug.mail_imapclient_bug.t.log<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/724694/374278/imap_debug.mail_imapclient_bug.t.log">
Mon Jan 25 22:02:39 2010 (12.2k) by MARKLE [...] cpan.org
</a>
</font></li>
</ul>


mail_imapclient_bug.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/724694/374277/mail_imapclient_bug.t">
Mon Jan 25 22:02:39 2010 (5k) by MARKLE [...] cpan.org
</a>
</font></li>
</ul>


plock.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/725070/374496/plock.t">
Tue Jan 26 17:19:11 2010 (2.1k) by phil [...] perkpartners.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=53990">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-724694" href="/Public/Bug/Display.html?id=53990#txn-724694">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;25&nbsp;22:02:39&nbsp;2010</span>
    <span class="description">MARKLE [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> connection closes while waiting for folder lock</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/724694/374276/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/374276">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 998b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi.  I seem to have found a problem.

Using dovecot 1.2.9 on CentOS 5.3 with Perl 5.8.8.

I run `lockfile -ml` and then access my mail via IMAP with Thunderbird
&#40;Icedove&#41;.  It sits there waiting while accessing the mail.  When I run
`lockfile -mu` on the server, Thunderbird continues fine and downloads
the messages on the same connection.  So, I do not think this is a
problem with dovecot 1.2.9, though it might be, I will ask on the list.

With Mail::IMAPClient, the same process fails.  message_string&#40;&#41; returns
undef.  body_string&#40;&#41; completely borks.  

This used to work in my more complicated test scripts.  So I don&#39;t know,
maybe it is something that changed in dovecot or the dovecot options,
but I&#39;m having trouble figuring out what.  Perl in CentOS often behaves
strangely.

I wrote a test script to demonstrate this, attached, as well as debug
info.  The test script only works in unix/linux with an imap server set
to respect dotlock files.  Does it happen for you?

Thanks!  --mark--
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> mail_imapclient_bug.t</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/724694/374277/mail_imapclient_bug.t">Download mail_imapclient_bug.t</a><br />
<span class="downloadcontenttype">text/x-perl 5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

# this test demonstrates a bug in Mail::IMAPClient without use of any DeSpam modules

use strict;
use warnings FATAL =&gt; &#39;all&#39;;
use English &#39;-no_match_vars&#39;;

use FindBin;
my $imap_logfile = &#34;/tmp/imap_debug.$FindBin::Script.log&#34;;

use Test::More;
use YAML;
use IO::File;

#exit&#40;0&#41;;

$ENV{PATH} = &#39;/sbin:/usr/sbin:/bin:/usr/bin&#39;;

use Mail::Sendmail;
use Mail::IMAPClient;
use User::pwent;
use File::Slurp;
use Term::ReadLine;
use POSIX;

#plan skip_all =&gt; &#39;Unimplemented&#39;;
plan tests =&gt; 6;

my $pw = getpwuid&#40;$REAL_USER_ID&#41;;
my $username = $pw-&gt;name;

verify_continue&#40;&#41;;

my $inbox_file = &#34;/var/spool/mail/$username&#34;;
diag&#40;&#34;inbox: $inbox_file&#34;&#41;;
clear_mailbox&#40;$inbox_file&#41;;

use Mail::Sendmail;
sendmail&#40;
    To          =&gt; &#34;$username\@localhost&#34;,
    From        =&gt; &#34;$username\@localhost&#34;,
    Subject     =&gt; &#34;test message&#34;,
    Message     =&gt; &#34;foobar\n&#34;,
&#41; || die &#34;cannot send test mail: $Mail::Sendmail::error\n&#34;;

do { diag&#40;&#34;sleeping for delivery...&#34;&#41;; sleep 2 } until -s $inbox_file;

my $inbox = read_file&#40;$inbox_file&#41; || die &#34;could not read test mail: $OS_ERROR\n&#34;;

#diag&#40;$inbox&#41;;

# here&#39;s how we check if the message is right:
my $patmatch = qr{ ^ Subject: \s+ test \s+ message \r?\n .* ^ foobar \r?\n }mxs;

ok&#40; $inbox =~ $patmatch, &#39;test message arrived&#39; &#41;;

# get imap connection, try to connect while inbox is not locked
my $imap = get_mail_imapclient&#40;$username&#41;;

# can we read the mail?
$imap-&gt;select&#40;&#39;INBOX&#39;&#41;;
my @msg_uids = $imap-&gt;messages&#40;&#41;;
diag&#40;&#34;message uids in box: \n&#34;.Dump&#40;\@msg_uids&#41;&#41;;
my $try_1 = $imap-&gt;message_string&#40;$msg_uids[0]&#41;;
ok&#40; $try_1 =~ $patmatch, &#39;try 1 matches message&#39; &#41;;
$imap-&gt;close;
$imap-&gt;logout;
undef $imap;

# lock inbox
system&#40;&#34;lockfile -ml&#34;&#41; == 0 || die &#34;cannot `lockfile -ml`: $OS_ERROR\n&#34;;
ok&#40;-e &#34;$inbox_file.lock&#34;, &#39;lockfile present after `lockfile -ml`&#39;&#41;;

# install a sig handler to remove it nicely if we bail:
install_handler&#40;&#41;;

# while inbox is locked, try connection, setting alarm to remove lockfile.
local $SIG{ALRM} = sub {
    system&#40;&#34;lockfile -mu&#34;&#41; == 0 || die &#34;cannot `lockfile -mu`: $OS_ERROR\n&#34;;
    ok&#40;!-e &#34;$inbox_file.lock&#34;, &#39;alarmsub lock gone after `lockfile -mu`&#39;&#41;;
};
diag&#40;&#34;setting alarm to remove lockfile in 4 seconds...&#34;&#41;;
alarm 4;

# get imap connection, try to connect while inbox is locked
$imap = get_mail_imapclient&#40;$username&#41;;

# can we read the mail?
$imap-&gt;select&#40;&#39;INBOX&#39;&#41;;
@msg_uids = $imap-&gt;messages&#40;&#41;;
diag&#40;&#34;message uids in box: \n&#34;.Dump&#40;\@msg_uids&#41;&#41;;

diag&#40;&#34;when alarm is triggered, read should continue here.&#34;&#41;;
diag&#40;&#34;it does not, message_string is undefined and body_string causes error.&#34;&#41;;
my $try_2 = $imap-&gt;message_string&#40;$msg_uids[0]&#41;;
ok&#40; $try_2 &#38;&#38; $try_2 =~ $patmatch, &#39;try 2 matches message&#39; &#41;;
my $body_try = $imap-&gt;body_string&#40;$msg_uids[0]&#41;;
ok&#40; $body_try &#38;&#38; $body_try =~ m{ foobar }mxs, &#39;get something from body_string too&#39; &#41;;
$imap-&gt;close;
$imap-&gt;logout;
undef $imap;


exit&#40;0&#41;;

#####################

sub get_mail_imapclient {
    my &#40;$username&#41; = @_;
    diag&#40;&#34;opening $imap_logfile&#34;&#41;;
    my $imap = Mail::IMAPClient-&gt;new&#40;
        Server      =&gt; &#39;localhost&#39;,
        User        =&gt; $username,
        Password    =&gt; get_password&#40;&#41;,
        Uid         =&gt; 1,
        Debug       =&gt; 1,
        Timeout     =&gt; 60,
        Debug_fh    =&gt; IO::File-&gt;new&#40;&#34;&gt;&gt;$imap_logfile&#34;&#41; 
                    || die &#34;cannot open $imap_logfile: $OS_ERROR&#34;,
    &#41;;
    return $imap;
}

my $password;
sub get_password {
    my $term = Term::ReadLine-&gt;new&#40;$PROGRAM_NAME&#41;;
    my $attribs = $term-&gt;Attribs;
    $attribs-&gt;{redisplay_function} = $attribs-&gt;{shadow_redisplay};
    
    ENTER_PASS:
    while &#40;1&#41; {
        last ENTER_PASS if $password;
        print &#34;Enter password for this account:\n&#34;;
        chomp&#40; $password = $term-&gt;readline&#40;&#34;password &gt; &#34;&#41; &#41;;
    }

    return $password;
}

sub verify_continue {
    print &#34;# this will completely erase your account&#39;s mail.  continue? [y/N] &#34;;
    chomp&#40;my $answ = &lt;STDIN&gt;&#41;;
    exit if !$answ || lc $answ ne &#39;y&#39;;

    print &#34;# no really, it will clear the inbox for user &#39;$username&#39; on this system.\n&#34;;
    print &#34;# continue? [y/N] &#34;;
    chomp&#40;my $answ2 = &lt;STDIN&gt;&#41;;
    exit if !$answ2 || lc $answ2 ne &#39;y&#39;;
    
    return;
}

# install the sig handler AFTER getting the lock file
sub unlock {
    my $signame = shift;
    warn &#34;caught signal SIG$signame, exiting...\n&#34; if $signame;
    system&#40;&#34;lockfile -mu&#34;&#41; == 0 || die &#34;cannot `lockfile -mu`: $OS_ERROR\n&#34;;
}

sub install_handler {
    my $sigset = POSIX::SigSet-&gt;new&#40;&#41;;
    my $action = POSIX::SigAction-&gt;new&#40;
        &#39;unlock&#39;,
        $sigset,
        &#38;POSIX::SA_NODEFER,
    &#41;;
    POSIX::sigaction&#40;$_, $action&#41; for   # see `man 7 signal`
        &#38;POSIX::SIGHUP,     # kill -1
        &#38;POSIX::SIGINT,     # types ctl-c
        &#38;POSIX::SIGQUIT,    # types something &#40;??&#41;
        &#38;POSIX::SIGKILL,    # doesn&#39;t trap this one &#40;-9&#41; or output is lost
        &#38;POSIX::SIGABRT,    # &#40;??&#41;
        &#38;POSIX::SIGPIPE,    # broken pipe - bad rsync ipc?
        &#38;POSIX::SIGTERM,    # regular kill &#40;-15&#41;
        ;
}

sub clear_mailbox {
    my &#40;$file&#41; = @_;
    open my $fh, &#39;&gt;&#39;, $file || die &#34;cannot clear $file: $OS_ERROR\n&#34;;
    close $file;
}
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> imap_debug.mail_imapclient_bug.t.log</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/724694/374278/imap_debug.mail_imapclient_bug.t.log">Download imap_debug.mail_imapclient_bug.t.log</a><br />
<span class="downloadcontenttype">text/x-log 12.2k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-724697" href="/Public/Bug/Display.html?id=53990#txn-724697">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;25&nbsp;22:05:03&nbsp;2010</span>
    <span class="description">MARKLE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/724697/374281/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/374281">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 58b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
son of a ...

I guess I&#39;ll be changing my password.

Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-724700" href="/Public/Bug/Display.html?id=53990#txn-724700">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;25&nbsp;22:05:04&nbsp;2010</span>
    <span class="description">MARKLE [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-724751" href="/Public/Bug/Display.html?id=53990#txn-724751">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;25&nbsp;23:01:11&nbsp;2010</span>
    <span class="description">PLOBBES [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-724769" href="/Public/Bug/Display.html?id=53990#txn-724769">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;25&nbsp;23:21:21&nbsp;2010</span>
    <span class="description">PLOBBES [...] cpan.org -  Severity Important changed to Normal</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-724770" href="/Public/Bug/Display.html?id=53990#txn-724770">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;25&nbsp;23:21:22&nbsp;2010</span>
    <span class="description">PLOBBES [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/724770/374329/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/374329">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Looking at the log, I would argue this is a bug with the test program.

It appears that a FETCH is attempted by the call to message_string in line 96 of 
mail_imapclient_bug.t:

Sending: 5 UID FETCH 11 BODY[]
Sent 23 bytes

But that operation times out after 60 seconds &#40;the Timeout value you specified&#41;.  
Resulting in the following error:

ERROR: error waiting 60s for data from server: No such file or directory

The test case code ignores the fact that an error has occurred and continues to try 
and do things with the IMAP connection that is no longer in a good state.  
Resulting in another error because of a call to body_string at line 98 of 
mail_imapclient_bug.t:

ERROR: Error sending &#39;6 UID FETCH 11 BODY[TEXT]&#39;: NO not connected

That cycle continues until the end of the test is reached.

If it worked before, it was perhaps because you were using an old version of the 
library that failed to honor Timeout.  In 3.17&#40;_01&#41; we had these related changes 
&#40;fix&#41;:

        - _read_more&#40;&#41; improperly initialized vector causing select
          errors, thus timeouts were not working properly &#40;now they
          work...&#41;
        - *change default timeout 30s =&gt; 600s: 30s seems too short in
           practice

I believe if you just use Timeout =&gt; 0 then you&#39;ll block until the lock is freed or 
some other error condition occurs.  You could also use a large enough timeout that 
lets you avoid this as well but either way you will want to start checking for 
error conditions and handling them appropriately.

I&#39;ll close this bug as rejected, but if you feel that I&#39;m missing something please 
feel free to reopen and let me know.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-724773" href="/Public/Bug/Display.html?id=53990#txn-724773">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;25&nbsp;23:21:29&nbsp;2010</span>
    <span class="description">PLOBBES [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-724776" href="/Public/Bug/Display.html?id=53990#txn-724776">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;26&nbsp;00:23:58&nbsp;2010</span>
    <span class="description">MARKLE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/724776/374332/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/374332">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jan 25 23:21:22 2010, PLOBBES wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ll close this bug as rejected, but if you feel that I&#39;m missing
&gt; something please feel free to reopen and let me know.
</div>
Try running the script in a test account.

While the file is locked with `lockfile -ml`, $imap connects, selects
INBOX, and calls $imap-&gt;message_string&#40;&#41; without any delay, and then
hangs in that function.

It only hangs for 4 seconds, the time set for the alarm.  When the alarm
goes off after 4 seconds, then the lockfile is removed and
message_string&#40;&#41; returns undef without error.

If you omit message_string&#40;&#41; and use body_string&#40;&#41; instead, the same
timing happens - body_string&#40;&#41; call succeeds, hangs 4 seconds, the alarm
removes the lockfile, but then it spits up that stack trace.

So it seems like something else is wrong... it does not wait Timeout
seconds.

The comparison is to try the same thing manually with Thunderbird using
IMAP - it opens the connection, and the progress bar sits there waiting,
then you remove the lock on the server after waiting 5 seconds or so,
and Thunderbird immediately continues from that point and downloads the
messages.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-724779" href="/Public/Bug/Display.html?id=53990#txn-724779">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;26&nbsp;00:23:59&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;rejected&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-725070" href="/Public/Bug/Display.html?id=53990#txn-725070">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;26&nbsp;17:19:10&nbsp;2010</span>
    <span class="description">phil [...] perkpartners.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #53990] connection closes while waiting for folder lock </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 26 Jan 2010 17:18:41 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-IMAPClient [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Phil Pearl &#40;Lobbes&#41; &lt;phil [...] perkpartners.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/725070/374495/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/374495">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Mark,

This test case you provided is horribly broken, please read on...

Mark Hedges via RT &lt;bug-Mail-IMAPClient@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Mail-IMAPClient
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=53990">https://rt.cpan.org/Ticket/Display.html?id=53990</a></span> &gt;
&gt; 
&gt; On Mon Jan 25 23:21:22 2010, PLOBBES wrote:
<div class="message-stanza open">&gt; &gt; I&#39;ll close this bug as rejected, but if you feel that I&#39;m missing
&gt; &gt; something please feel free to reopen and let me know.
</div>&gt; 
&gt; Try running the script in a test account.
&gt; 
&gt; While the file is locked with `lockfile -ml`, $imap connects, selects
&gt; INBOX, and calls $imap-&gt;message_string&#40;&#41; without any delay, and then
&gt; hangs in that function.
&gt; 
&gt; It only hangs for 4 seconds, the time set for the alarm.  When the alarm
&gt; goes off after 4 seconds, then the lockfile is removed and
&gt; message_string&#40;&#41; returns undef without error.
&gt; 
&gt; If you omit message_string&#40;&#41; and use body_string&#40;&#41; instead, the same
&gt; timing happens - body_string&#40;&#41; call succeeds, hangs 4 seconds, the alarm
&gt; removes the lockfile, but then it spits up that stack trace.
&gt; 
&gt; So it seems like something else is wrong... it does not wait Timeout
&gt; seconds.
&gt; 
&gt; The comparison is to try the same thing manually with Thunderbird using
&gt; IMAP - it opens the connection, and the progress bar sits there waiting,
&gt; then you remove the lock on the server after waiting 5 seconds or so,
&gt; and Thunderbird immediately continues from that point and downloads the
&gt; messages.
</div>
This test case is horribly broken because the SIGALRM interrupts the
ongoing system call inside Mail::IMAPClient &#40;a select&#41; thus the Timeout
does not come into play.  The SIGALRM handler also trashes $! there by
making the ERROR: ... more interesting &#40;No such file vs Interrupted
system call&#41;.

At the moment I am of the opinion that proper signal handling &#40;and/or
proper coding&#41; in cases like this is the responsibility of the caller.
Feel free to try and convince me otherwise, I&#39;m all ears.

The code also fails to do error handling as required by
Mail::IMAPClient.  Unfortunately the API is old and has some rough edges
and the documentation is probably far too wordy, but the following
section should be of particular interest:

<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/dist/Mail-IMAPClient/lib/Mail/IMAPClient.pod#OBJECT_METHODS">http://search.cpan.org/dist/Mail-IMAPClient/lib/Mail/IMAPClient.pod#OBJECT_METHODS</a></span>

Here&#39;s the highlight:

As a general rule, mailbox control methods return undef on failure and
something besides undef when they succeed. This rule is modified in the
case of methods that return search results. When called in a list
context, searches that do not find matching results return an empty
list. When called in a scalar context, searches with no hits return
&#39;undef&#39; instead of an array reference. If you want to know why you
received no hits, you should check &#34;LastError&#34; or $@, which will be
empty if the search was successful but had no matching results but
populated with an error message if the search encountered a problem
&#40;such as invalid parameters&#41;.

This was probably an unfortunate design decision by one of my
predecessors.  The reason being is that when calling a number of methods
in list context when you hit an error many times you&#39;ll get a list that
looks like this:

  &#40; undef &#41;

So when you get that, you need to check if the first element of the list
is undef and if it is, an error likely occured that you will need to
handle that appropriately.

In general, I recommend using scalar instead of list context that way
you&#39;ll get an undef on error or an arrayref on success &#40;typically&#41;.

Regardless, if you choose to not check LastError / $@ then all the
safeguards in the world will not help you, so please start checking
these.

Attached is what I would consider a more valid &#40;but still not great&#41;
test case which works fine with 3.22 -- and probably with 3.21 and I
would guess it is valid all the way back to 3.17 or so.  In the future,
I would also suggest that you try to pare down your test cases to the
absolute minimum to avoid these types of problems.

Sincerely,
Phil
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/725070/374496/plock.t">Download plock.t</a><br />
<span class="downloadcontenttype">text/x-perl 2.1k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-725132" href="/Public/Bug/Display.html?id=53990#txn-725132">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;26&nbsp;19:40:29&nbsp;2010</span>
    <span class="description">MARKLE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/725132/374527/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/374527">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 993b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This test case is horribly broken because the SIGALRM interrupts the
&gt; ongoing system call inside Mail::IMAPClient &#40;a select&#41; thus the
&gt; Timeout
&gt; does not come into play.  The SIGALRM handler also trashes $! there by
&gt; making the ERROR: ... more interesting &#40;No such file vs Interrupted
&gt; system call&#41;.
&gt; 
&gt; Attached is what I would consider a more valid &#40;but still not great&#41;
&gt; test case which works fine with 3.22 -- and probably with 3.21 and I
&gt; would guess it is valid all the way back to 3.17 or so.  
</div>
You are awesome! Thank you!

It is strange that it appeared to work before, but I guess it was not
working.

Spawning a background process to remove the lock works, of course.  I
guess I thought alarm&#40;&#41; did something way more complicated like ran the
subref in a thread or something... when my original test started working
way back when, I assumed I was doing the right thing.

So, thank you for fixing whatever bug was fixed along the line that used
to make this work!  --mark--
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-725135" href="/Public/Bug/Display.html?id=53990#txn-725135">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;26&nbsp;19:40:30&nbsp;2010</span>
    <span class="description">MARKLE [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.564262</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
