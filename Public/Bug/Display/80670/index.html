<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #80670 for Net-HTTP: Net::HTTP chunk handling broken for non-blocking sockets</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #80670 for Net-HTTP: Net::HTTP chunk handling broken for non-blocking sockets</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-HTTP/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-HTTP/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-HTTP/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-HTTP/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-HTTP">Net-HTTP CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">80670</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-HTTP/Active/">Net-HTTP</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Steffen_Ullrich [...] genua.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-237444-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-237445-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;06&nbsp;15:09:54&nbsp;2012</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net::HTTP chunk handling broken for non-blocking sockets</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,
the chunk handling of Net::HTTP&#40;::Methods&#41; is broken for non-blocking sockets.
This affects LWP with IO::Socket::SSL as https backend. 
Net::SSL as https backend is not affected because it explicitly disables non-blocking support, and http is not affected either, because it overrides 
sysread to be blocking even if the socket is non-blocking.

Details:
in Net::HTTP::Methods::read_entity_body we have


472     if &#40;defined $chunked&#41; {
473         # The state encoded in $chunked is:
474         #   $chunked == 0:   read CRLF after chunk, then chunk header
475         #   $chunked == -1:  read chunk header
476         #   $chunked &gt; 0:    bytes left in current chunk to read
477 
478         if &#40;$chunked &lt;= 0&#41; {
479             my $line = my_readline&#40;$self, &#39;Entity body&#39;&#41;;
...
513         my $n = $chunked;
514         $n = $size if $size &#38;&#38; $size &lt; $n;
515         $n = my_read&#40;$self, $$buf_ref, $n&#41;;
516         return undef unless defined $n;
517 
518         ${*$self}{&#39;http_chunked&#39;} = $chunked - $n;


if $chunked was &lt;=0 in line 478 it will try to read the end of the last chunk &#40;only if chunked==0&#41; followed by the reading of the next chunk header 
to determine the size. It will then set $chunked to the size of the next chunk.
If everything was successful, it will try to read the next chunk in line 515. 
For blocking sockets this will block until some data are read &#40;or fatal error occurs&#41; and then it will continue in line 518 and update the 
http_chunked attribute of $self with the number of bytes still to read.
But for non-blocking sockets the read might fail. In this case the method will return in line 516 without updating the http_chunked attribute, so 
that it will later retry to read the chunk header starting in line 478.

Thus the fix should be: 

        $n = my_read&#40;$self, $$buf_ref, $n&#41;;
+       ${*$self}{&#39;http_chunked&#39;} = $chunked - $n||0;
        return undef unless defined $n;

-       ${*$self}{&#39;http_chunked&#39;} = $chunked - $n;

Doing only this patch would result in an busy loop calling read_entity_body until data are available.
Thus the rest of the patch fixes my_read to wait until socket timeout or until data are available, but at most 0.1 seconds &#40;similar to the code in 
my_readline&#41;. Of course this is only a work around the caller, which should check the return code and not busy wait.

Regards,
Steffen
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net-HTTP-Methods.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- /home/work/perl5/perlbrew/perls/perl-5.12.4/lib/site_perl/5.12.4/Net/HTTP/Methods.pm	2012-02-15 20:42:03.000000000 +0100
+++ lib/Net/HTTP/Methods.pm	2012-11-06 20:46:46.622621468 +0100
@@ -233,7 +233,17 @@
 	    return length&#40;$_[0]&#41;;
 	}
 	else {
-	    return $self-&gt;sysread&#40;$_[0], $len&#41;;
+	    { # wait for data, socket might by non-blocking
+		my $n = $self-&gt;sysread&#40;$_[0], $len&#41;;
+		redo if $!{EINTR};
+		if &#40;$!{EAGAIN}&#41; {
+		    my $mask = &#39;&#39;;
+		    vec&#40;$mask,$self-&gt;fileno,1&#41; = 1;
+		    select&#40;$mask,undef,undef, ${*$self}{io_socket_timeout} || 0.1&#41;;
+		    redo;
+		}
+		return $n;
+	    }
 	}
     }
 }
@@ -513,9 +523,9 @@
 	my $n = $chunked;
 	$n = $size if $size &#38;&#38; $size &lt; $n;
 	$n = my_read&#40;$self, $$buf_ref, $n&#41;;
+	${*$self}{&#39;http_chunked&#39;} = $chunked - $n||0;
 	return undef unless defined $n;
 
-	${*$self}{&#39;http_chunked&#39;} = $chunked - $n;
 
 	if &#40;$n &gt; 0&#41; {
 	    if &#40;my $transforms = ${*$self}{&#39;http_te2&#39;}&#41; {
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;06&nbsp;17:07:18&nbsp;2012</span>
    <span class="description">DOUGW [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Nov 06 15:09:54 2012, SULLR wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; the chunk handling of Net::HTTP&#40;::Methods&#41; is broken for non-blocking
&gt; sockets.
</div>
Patch fixes issue for me. &#40;Issue originally reported at
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=80591&#41;">https://rt.cpan.org/Ticket/Display.html?id=80591&#41;</a></span>.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;06&nbsp;17:07:19&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;08&nbsp;14:30:28&nbsp;2012</span>
    <span class="description">GAAS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza">&nbsp;There was already changes in 6.04 tobe that I think fixes the same issue. &nbsp;I've now uploaded 6.04 to CPAN. &nbsp;Can you check if you still have this issue with it?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;08&nbsp;16:51:36&nbsp;2012</span>
    <span class="description">DOUGW [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Nov 08 14:30:28 2012, GAAS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Can you check if you still have this issue
&gt; with it?
</div>
That fixes it. Thank you.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;09&nbsp;00:55:59&nbsp;2012</span>
    <span class="description">GAAS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
