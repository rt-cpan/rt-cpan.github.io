<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #57945 for CGI: Charset is only added to text/* types</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #57945 for CGI: Charset is only added to text/* types</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/CGI/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/CGI/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/CGI/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/CGI/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/leejo/CGI.pm/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/CGI">CGI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">57945</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/CGI/Active/">CGI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
gerv-cpan [...] gerv.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Unimportant    </td>
  </tr>
  <tr id="CF-230860-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-230861-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;28&nbsp;06:07:40&nbsp;2010</span>
    <span class="description">http://www.gerv.net/ -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Charset is only added to text/* types</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">When you set a charset in CGI.pm, e.g. using $self-&gt;charset&#40;&#41;, it is
only appended to the end of the Content-Type header if the type is a
text/* type. 

Test program attached. Output:

Status: 200
Content-Type: application/json

Content Types which are not text/* but which benefit from a charset include:
application/xml
application/json
image/svg+xml

Failure to add a charset means that clients may interpret the data using
the HTTP standard fallback charset of ISO-8859-1. Given that much data
today is in UTF-8, this could lead to dataloss.

Related bug: <span class="clickylink"><a target="new" rel="nofollow" href="https://bugzilla.mozilla.org/show_bug.cgi?id=568503">https://bugzilla.mozilla.org/show_bug.cgi?id=568503</a></span>

perl -v:  This is perl, v5.10.1 &#40;*&#41; built for i486-linux-gnu-thread-multi
uname -a: Linux kitten 2.6.32-22-generic #33-Ubuntu SMP Wed Apr 28
13:27:30 UTC 2010 i686 GNU/Linux

Gerv
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w
use CGI;
my $cgi = new CGI;
$cgi-&gt;charset&#40;&#39;UTF-8&#39;&#41;;
print $cgi-&gt;header&#40;-type =&gt; &#39;application/json&#39;,
                   -status =&gt; &#39;200&#39;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;28&nbsp;06:09:15&nbsp;2010</span>
    <span class="description">http://www.gerv.net/ -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">print $cgi-&gt;header&#40;-type =&gt; &#39;application/json&#39;,
                   -status =&gt; &#39;200&#39;,
                   -charset =&gt; &#39;UTF-8&#39;&#41;;

The above form does work.

Gerv
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;28&nbsp;06:09:16&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;28&nbsp;08:37:50&nbsp;2010</span>
    <span class="description">mark [...] summersault.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #57945] Charset is only added to text/* types</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 28 May 2010 08:37:40 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI.pm [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Stosberg &lt;mark [...] summersault.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; When you set a charset in CGI.pm, e.g. using $self-&gt;charset&#40;&#41;, it is
&gt; only appended to the end of the Content-Type header if the type is a
&gt; text/* type. 
&gt; 
&gt; Test program attached. Output:
&gt; 
&gt; Status: 200
&gt; Content-Type: application/json
&gt; 
&gt; Content Types which are not text/* but which benefit from a charset include:
&gt; application/xml
&gt; application/json
&gt; image/svg+xml
&gt; 
&gt; Failure to add a charset means that clients may interpret the data using
&gt; the HTTP standard fallback charset of ISO-8859-1. Given that much data
&gt; today is in UTF-8, this could lead to dataloss.
</div>
Thanks for the report, Gerv. 

Could you review the related RFCs for us to review what they have to
say when charsets should or should not be added to content-type headers?

    Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;08&nbsp;08:20:21&nbsp;2010</span>
    <span class="description">http://www.gerv.net/ -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri May 28 08:37:50 2010, mark@summersault.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks for the report, Gerv.
&gt; 
&gt; Could you review the related RFCs for us to review what they have to
&gt; say when charsets should or should not be added to content-type
&gt; headers?
</div>
Hmm. Sorry for the delay. I don&#39;t get email on changes &#40;having used
OpenID&#41; and I can&#39;t see a &#34;profile&#34; or similar link in RT where I can
add an email address...

Here are some bits of relevant text:

RFC 2616 &#40;HTTP&#41;, section 3.4.1:
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec3.html">http://www.w3.org/Protocols/rfc2616/rfc2616-sec3.html</a></span>

&#34;3.4.1 Missing Charset

Some HTTP/1.0 software has interpreted a Content-Type header without
charset parameter incorrectly to mean &#34;recipient should guess.&#34; Senders
wishing to defeat this behavior MAY include a charset parameter even
when the charset is ISO-8859-1 and SHOULD do so when it is known that it
will not confuse the recipient.

Unfortunately, some older HTTP/1.0 clients did not deal properly with an
explicit charset parameter. HTTP/1.1 recipients MUST respect the charset
label provided by the sender; and those user agents that have a
provision to &#34;guess&#34; a charset MUST use the charset from the
content-type field if they support that charset, rather than the
recipient&#39;s preference, when initially displaying a document. See
section 3.7.1.&#34;

Section 3.7.1 states, in part:

&#34;The &#34;charset&#34; parameter is used with some media types to define the
character set &#40;section 3.4&#41; of the data. When no explicit charset
parameter is provided by the sender, media subtypes of the &#34;text&#34; type
are defined to have a default charset value of &#34;ISO-8859-1&#34; when
received via HTTP. Data in character sets other than &#34;ISO-8859-1&#34; or its
subsets MUST be labeled with an appropriate charset value.&#34;

RFC 4627 &#40;JSON&#41; says:
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.ietf.org/rfc/rfc4627.txt">http://www.ietf.org/rfc/rfc4627.txt</a></span>

&#34;JSON text SHALL be encoded in Unicode.  The default encoding is UTF-8.&#34;

It then talks about sniffing the stream to be able to tell if other
encodings have, in fact, been used. Ick.

So one could argue:

&#34;Types other than text types are supposed to have a canonical
representation defined when they are registered. For JSON, the canonical
representation is &#34;Unicode&#34;, and the defined method of determining the
character set is by sniffing the first four bytes of the stream.&#34;

Or one could argue:

&#34;My word, that&#39;s horrible. Add a charset parameter, for the love of Pete!&#34;

As for XML, the situation is more clear. RFC 3023 says:
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.rfc-editor.org/rfc/rfc3023.txt">http://www.rfc-editor.org/rfc/rfc3023.txt</a></span>

&#34;3.2 Application/xml Registration

   MIME media type name: application
   MIME subtype name: xml
   Mandatory parameters: none
   Optional parameters: charset

      Although listed as an optional parameter, the use of the charset
      parameter is STRONGLY RECOMMENDED, ...&#34;

So that&#39;s at least one non-text type where a charset should be added.

In general, I suspect most XML MIME types &#40;and there are _a_lot_&#41; have
this attitude to charsets. People need to be able to set this parameter.

Do you need more from me here?

Gerv
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;14&nbsp;16:42:15&nbsp;2010</span>
    <span class="description">mark [...] summersault.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #57945] Charset is only added to text/* types</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 14 Jun 2010 16:42:05 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI.pm [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Stosberg &lt;mark [...] summersault.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Do you need more from me here?
</div>
That&#39;s been very helpful, thanks.

Yanick, feel free to jump here with comments or action. 

   Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;16&nbsp;10:06:12&nbsp;2010</span>
    <span class="description">yanick+cpan [...] babyl.dyndns.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jun 14 16:42:15 2010, mark@summersault.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Yanick, feel free to jump here with comments or action. 
</div>
Aye, aye, sir. :-&#41;

I&#39;ll look more closely at it when I have a few minutes to myself, but
I&#39;m thinking that the fix could be to change at CGI.pm ~ line 1561

    if &#40;defined $charset&#41; {
      $self-&gt;charset&#40;$charset&#41;;
    } else {
      $charset = $self-&gt;charset if $type =~ /^text\//;
    }

for

    if &#40;defined $charset&#41; {
      $self-&gt;charset&#40;$charset&#41;;
    } else {
      $charset = $self-&gt;charset;
    }


In other words, adopt the chartset if it has been configured, no matter
what the type is.  The logic being that if somebody doesn&#39;t want the
charset to be specified, he or she would not set it to any value in the
first place.


Anyway, I&#39;ll try to come with a patch and some tests for it soonishly.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;16&nbsp;10:12:53&nbsp;2010</span>
    <span class="description">mark [...] summersault.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #57945] Charset is only added to text/* types</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 16 Jun 2010 10:12:43 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI.pm [...] rt.cpan.org, lstein [...] cshl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Stosberg &lt;mark [...] summersault.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m thinking that the fix could be to change at CGI.pm ~ line 1561
&gt; 
&gt;     if &#40;defined $charset&#41; {
&gt;       $self-&gt;charset&#40;$charset&#41;;
&gt;     } else {
&gt;       $charset = $self-&gt;charset if $type =~ /^text\//;
&gt;     }
&gt; 
&gt; for
&gt; 
&gt;     if &#40;defined $charset&#41; {
&gt;       $self-&gt;charset&#40;$charset&#41;;
&gt;     } else {
&gt;       $charset = $self-&gt;charset;
&gt;     }
&gt; 
&gt; 
&gt; In other words, adopt the chartset if it has been configured, no matter
&gt; what the type is.  The logic being that if somebody doesn&#39;t want the
&gt; charset to be specified, he or she would not set it to any value in the
&gt; first place.
&gt;
&gt; Anyway, I&#39;ll try to come with a patch and some tests for it soonishly.
</div>
Thanks. That seems reasonable to me. 

Lincoln, would you like to review this change requeset and weigh in?

    Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;17&nbsp;20:29:56&nbsp;2010</span>
    <span class="description">yanick [...] babyl.dyndns.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #57945] Charset is only added to text/* types</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 17 Jun 2010 20:30:07 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI.pm [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Yanick Champoux &lt;yanick [...] babyl.dyndns.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
        Changes committed to <span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/yanick/CGI.pm/tree/charset">http://github.com/yanick/CGI.pm/tree/charset</a></span>

        The only thing I&#39;m afraid of is apps that might freak upon receiving 
charsets for some mimetypes.

        Reading the HTTP specs at <span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/Protocols/rfc2616/rfc2616-">http://www.w3.org/Protocols/rfc2616/rfc2616-</a></span>
sec3.html, we have &#40;as was quoted by Gerv&#41;

=head1 SPECS

 Some HTTP/1.0 software has interpreted a Content-Type header without charset 
parameter incorrectly to mean &#34;recipient should guess.&#34; Senders wishing to 
defeat this behavior MAY include a charset parameter even when the charset is 
ISO-8859-1 and SHOULD do so when it is known that it will not confuse the 
recipient.

Unfortunately, some older HTTP/1.0 clients did not deal properly with an 
explicit charset parameter. HTTP/1.1 recipients MUST respect the charset label 
provided by the sender; and those user agents that have a provision to &#34;guess&#34; 
a charset MUST use the charset from the content-type field if they support 
that charset, rather than the recipient&#39;s preference, when initially 
displaying a document. See section 3.7.1. 

=cut

        The first paragraph seems to advocate the explicit mention of the charset 
&#40;yay!&#41;, but the second one warns that some clients can indeed not like it.  
        
        Now, new code can easily circumvent that problem by calling 

                header&#40; -charset =&gt; &#39;&#39; &#41;;

        but old code will suddenly behave differently than it did before.  Does 
anyone think that this could be an issue for someone out there?

`/anick
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;18&nbsp;09:27:37&nbsp;2010</span>
    <span class="description">mark [...] summersault.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #57945] Charset is only added to text/* types</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 18 Jun 2010 09:27:27 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI.pm [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Stosberg &lt;mark [...] summersault.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       but old code will suddenly behave differently than it did before.  Does 
&gt; anyone think that this could be an issue for someone out there?
</div>
Thanks for the review, Yanick.

To answer your question, I&#39;ll say: &#34;Yes.&#34;

Generally, I like the philosophy of leaving CGI.pm alone unless there
is clearly a bug. Any change potentially effects thousands of users.
For things that are enhancements or maybe-bugs, I think it&#39;s reasonable
that at least a couple independent parties feel strongly that the
behavior should be changed. 

In this case, it seems like there is a reasonable workaround: an
explicit charset can be set if you don&#39;t like the default. 

   Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;24&nbsp;20:14:56&nbsp;2010</span>
    <span class="description">yanick [...] babyl.dyndns.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #57945] Charset is only added to text/* types</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 24 Jun 2010 20:15:37 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI.pm [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Yanick Champoux &lt;yanick [...] babyl.dyndns.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On June 18, 2010 09:27:38 am mark@summersault.com via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt;     but old code will suddenly behave differently than it did before.  Does
&gt; &gt; anyone think that this could be an issue for someone out there?
</div>&gt; 
&gt; To answer your question, I&#39;ll say: &#34;Yes.&#34;
&gt; 
&gt; Generally, I like the philosophy of leaving CGI.pm alone unless there
&gt; is clearly a bug. Any change potentially effects thousands of users.
&gt; For things that are enhancements or maybe-bugs, I think it&#39;s reasonable
&gt; that at least a couple independent parties feel strongly that the
&gt; behavior should be changed.
</div>
        Sounds very reasonable, very prudent. I whole-heartily agree. 

Joy,
`/anick
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;25&nbsp;12:25:35&nbsp;2010</span>
    <span class="description">MARKSTOS [...] cpan.org -  Severity Normal changed to Unimportant</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;25&nbsp;12:28:06&nbsp;2010</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Gerv,

So the summary for now is that we don&#39;t plan to modify CGI.pm immediately 
for this. If more of consensus arises that this should be changed-- and 
doing so would be more spec-compliant or real-world-compliant, we&#39;ll 
consider revisiting it. 

We&#39;ll leave the ticket open so that others might find it, and you can 
also promote the change others to gather support for it if you&#39;d like.

Thanks again for the feedback on CGI.pm.

   Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;20&nbsp;00:07:33&nbsp;2010</span>
    <span class="description">http://www.gerv.net/ -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Mark,

I think you have slightly misunderstood this bug. This bug is not about
sending a charset when one is not set, it&#39;s about the fact that I want
to send a charset and I can&#39;t!

If Perl code &#40;like mine&#41; explicitly calls:
$self-&gt;charset&#40;&#34;UTF-8&#34;&#41;
then I want CGI.pm to do what I&#39;ve explicitly said and send the
charset=UTF-8 parameter on the content type. Is that really a change
that will break backwards compatibility?

The only old code which will behave differently is code which sets a
charset but didn&#39;t notice it wasn&#39;t actually being sent, and is actually
talking to a very &#40;very very&#41; old HTTP/1.0 server which breaks when one
_is_ sent. In other words, code which actually finally gets what it asks
for, but turns out not to want it.

If no charset if specified, keep not sending one. I&#39;m fine with that.

Can someone ping me with future updates? Having logged in with an
OpenID, I don&#39;t get mail. gerv@gerv.net. Thanks :-&#41;

Gerv
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;20&nbsp;19:25:44&nbsp;2010</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> gerv [...] gerv.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jul 20 00:07:33 2010, <span class="clickylink"><a target="new" rel="nofollow" href="http://www.gerv.net/">http://www.gerv.net/</a></span> wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Mark,
&gt; 
&gt; I think you have slightly misunderstood this bug. This bug is not 
</div>about
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; sending a charset when one is not set, it&#39;s about the fact that I want
&gt; to send a charset and I can&#39;t!
</div>
I see. In that case, Yanick&#39;s proposed fix is the same thing that I 
would recommend. I&#39;ve added some more tests for charset&#40;&#41; now and merged  
and pushed Yanick&#39;s work. 

It should be in our next release. 

   Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;20&nbsp;19:25:46&nbsp;2010</span>
    <span class="description">MARKSTOS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;23&nbsp;20:45:35&nbsp;2011</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch released for CGI.pm</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the bug report. A patch for it appeared in 3.51, if not 
sooner. 

Resolving. 

   Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;23&nbsp;20:45:36&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;23&nbsp;20:45:37&nbsp;2011</span>
    <span class="description">MARKSTOS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;15&nbsp;22:38:38&nbsp;2012</span>
    <span class="description">MARKSTOS [...] cpan.org -  Reference by ticket #67100 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;May&nbsp;23&nbsp;14:29:35&nbsp;2014</span>
    <span class="description">The RT System itself -  Queue changed from CGI.pm to CGI</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
