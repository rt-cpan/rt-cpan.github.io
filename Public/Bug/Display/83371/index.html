<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #83371 for Mail-Box: Header gets screwed up when fetching mail from an IMAP server</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #83371 for Mail-Box: Header gets screwed up when fetching mail from an IMAP server</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Mail-Box/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Mail-Box/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Mail-Box/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Mail-Box/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-Box">Mail-Box CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">83371</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Mail-Box/Active/">Mail-Box</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
rotkraut [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-19874-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.107    </td>
  </tr>
  <tr id="CF-19875-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;16&nbsp;10:21:16&nbsp;2013</span>
    <span class="description">rotkraut [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Header gets screwed up when fetching mail from an IMAP server</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Problem description
===================

When reading Mails from an IMAP server with Mail::Box::IMAP4, the
header of the mail gets screwed up.  Example: I have the following
mail at the server &#40;slightly edited&#41;:

  Return-Path: &lt;rotkraut@cpan.org&gt;
  Received: from mail.example.org &#40;[unix socket]&#41;
         by mail &#40;Cyrus v2.3.11&#41; with LMTPA;
         Wed, 30 Jan 2013 14:35:09 +0100
  X-Sieve: CMU Sieve 2.3
  Received: from x1.develooper.com &#40;x1.develooper.com [207.171.7.70]&#41;
        by mail.example.org &#40;8.14.3/8.14.3/SuSE Linux 0.8&#41; with SMTP id
r0UDZ0nv013870
        for &lt;user@example.org&gt;; Wed, 30 Jan 2013 14:35:00 +0100
  Received: &#40;qmail 20353 invoked by uid 225&#41;; 30 Jan 2013 13:34:59 -0000
  Delivered-To: rotkraut@cpan.org
  Received: &#40;qmail 20347 invoked by uid 103&#41;; 30 Jan 2013 13:34:58 -0000
  Received: from xx1.dev &#40;10.0.100.115&#41;
    by x1.dev with QMQP; 30 Jan 2013 13:34:58 -0000
  Received: from localhost &#40;HELO xx1.develooper.com&#41; &#40;127.0.0.1&#41;
      by xx1.develooper.com &#40;qpsmtpd/0.84/v0.84-36-g0b0e4e9&#41; with ESMTP;
Wed, 30 Jan 2013 05:34:58 -0800
  Received: from xx1.develooper.com &#40;xx1.develooper.com [127.0.0.1]&#41;
        by localhost &#40;Postfix&#41; with SMTP id B466611F640
        for &lt;rotkraut@cpan.org&gt;; Wed, 30 Jan 2013 05:34:58 -0800 &#40;PST&#41;
  Received: from mail.example.org &#40;mail.example.org [203.0.113.202]&#41;
        by xx1.develooper.com &#40;Postfix&#41; with ESMTP id 81B7511F650
        for &lt;rotkraut@cpan.org&gt;; Wed, 30 Jan 2013 05:34:56 -0800 &#40;PST&#41;
  Received: from mail.example.org &#40;localhost [127.0.0.1]&#41;
        by mail.example.org &#40;8.14.3/8.14.3/SuSE Linux 0.8&#41; with SMTP id
r0UDYDwx013863
        for &lt;rotkraut@cpan.org&gt;; Wed, 30 Jan 2013 14:34:35 +0100
  Message-Id: &lt;201301301334.r0UDYDwx013863@mail.example.org&gt;
  From: Rolf Krahl &lt;rotkraut@cpan.org&gt;
  To: Rolf Krahl &lt;rotkraut@cpan.org&gt;
  Subject: Test
  Date: Wed, 30 Jan 2013 14:33:18 +0100
  User-Agent: telnet
  MIME-Version: 1.0
  Content-Transfer-Encoding: quoted-printable
  Content-Type: text/plain; charset=&#34;utf-8&#34;
  
  Test.
  
  Sending a testmail to myself to demonstrate problems with accessing
  IMAP folders with Mail::Box.
  
  Add some more blind text =E2=80=93 bla bla bla =E2=
  =80=93 blind text =E2=80=93 bla bla bla =E2=80=93 blind text =E2=80=93 bl=
  a bla bla =E2=80=93=
   blind text =E2=80=93 bla bla bla =E2=80=93 blind text

When i download this mail using the following script:

  #! /usr/bin/perl
  
  use Mail::Box::IMAP4;
  
  my $imaphost = &#39;mail.example.org&#39;;
  my $imapuser = &#39;USER&#39;;
  my $imappass = &#39;PASS&#39;;
  my $mailbox = &#39;INBOX.test&#39;;
  
  my $folder= new Mail::Box::IMAP4&#40;server_name =&gt; $imaphost, 
                                   starttls =&gt; 1,
                                   username =&gt; $imapuser, 
                                   password =&gt; $imappass, 
                                   folder =&gt; $mailbox&#41;;
  
  my @msgs = $folder-&gt;messages;
  my $msg = pop @msgs;
  
  my $msgstr = $msg-&gt;string&#40;&#41;;
  $msgstr =~ s/\r\n/\n/g;
  print &#34;$msgstr&#34;;

I get the following result:

  MIME-Version: 1.0
  X-Sieve: CMU Sieve 2.3
  Content-Type: text/plain; charset=&#34;utf-8&#34;
  Received: from mail.example.org &#40;[unix socket]&#41;        by mail &#40;Cyrus
v2.3.11&#41;
   with LMTPA;   Wed, 30 Jan 2013 14:35:09 +0100
  Received: from x1.develooper.com &#40;x1.develooper.com [207.171.7.70]&#41;   by
   mail.example.org &#40;8.14.3/8.14.3/SuSE Linux 0.8&#41; with SMTP id
   r0UDZ0nv013870       for &lt;user@example.org&gt;; Wed, 30 Jan 2013
14:35:00 +0100
  Received: &#40;qmail 20353 invoked by uid 225&#41;; 30 Jan 2013 13:34:59 -0000
  Received: &#40;qmail 20347 invoked by uid 103&#41;; 30 Jan 2013 13:34:58 -0000
  Received: from xx1.dev &#40;10.0.100.115&#41;  by x1.dev with QMQP;
   30 Jan 2013 13:34:58 -0000
  Received: from localhost &#40;HELO xx1.develooper.com&#41; &#40;127.0.0.1&#41;    by
   xx1.develooper.com &#40;qpsmtpd/0.84/v0.84-36-g0b0e4e9&#41; with ESMTP; Wed,
   30 Jan 2013 05:34:58 -0800
  Received: from xx1.develooper.com &#40;xx1.develooper.com [127.0.0.1]&#41;    by
   localhost &#40;Postfix&#41; with SMTP id B466611F640 for &lt;rotkraut@cpan.org&gt;;
Wed,
   30 Jan 2013 05:34:58 -0800 &#40;PST&#41;
  Received: from mail.example.org &#40;mail.example.org [203.0.113.202]&#41;    by
   xx1.develooper.com &#40;Postfix&#41; with ESMTP id 81B7511F650       for
   &lt;rotkraut@cpan.org&gt;; Wed, 30 Jan 2013 05:34:56 -0800 &#40;PST&#41;
  Received: from mail.example.org &#40;localhost [127.0.0.1]&#41;       by
   mail.example.org &#40;8.14.3/8.14.3/SuSE Linux 0.8&#41; with SMTP id
   r0UDYDwx013863       for &lt;rotkraut@cpan.org&gt;; Wed, 30 Jan 2013
14:34:35 +0100
  Delivered-To: rotkraut@cpan.org
  Subject: Test
  User-Agent: telnet
  Return-Path: &lt;rotkraut@cpan.org&gt;
  Date: Wed, 30 Jan 2013 14:33:18 +0100
  Message-Id: &lt;201301301334.r0UDYDwx013863@mail.example.org&gt;
  To: Rolf Krahl &lt;rotkraut@cpan.org&gt;
  Content-Transfer-Encoding: quoted-printable
  From: Rolf Krahl &lt;rotkraut@cpan.org&gt;
  
  Test.
  
  Sending a testmail to myself to demonstrate problems with accessing
  IMAP folders with Mail::Box.
  
  Add some more blind text =E2=80=93 bla bla bla =E2=
  =80=93 blind text =E2=80=93 bla bla bla =E2=80=93 blind text =E2=80=93 bl=
  a bla bla =E2=80=93=
   blind text =E2=80=93 bla bla bla =E2=80=93 blind text

The order of the headers lines is mixed up and the folding is altered.
The same thing happens when the mail is copied to a local folder.  If
I download the mail using Mail::IMAPClient::message_string directly, I
get the original mail unmodified.


Analysis &#38; Discussion
=====================

The invocation of $msg-&gt;string&#40;&#41; fetches header and body of the mail
separately using Mail::IMAPClient::parse_headers and
Mail::IMAPClient::message_string respectively.  parse_headers returns
a hash with the field names of the header as keys and an array of the
unfolded field bodies of the respective field as value.  The original
order of the header lines as well as the original folding is lost at
this point.

I guess, there is no easy and quick solution to the problem.
Apparently, Mail::IMAPClient::parse_headers is intended to fetch
single header lines, but it is simply not suitable to fetch the entire
header.  Unfortunately, if I didn&#39;t miss something, there is no other
method in Mail::IMAPClient besides message_string that is capable to
fetch an intact message header.  Using message_string to fetch just
the header is probably not a good idea as this might significantly
hurt the performance  of any program that needs just the headers and
not the bodies.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
