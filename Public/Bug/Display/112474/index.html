<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #112474 for DBD-SQLite: FTS3 custom tokenizers disabled by default in SQLite 3.11.0</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #112474 for DBD-SQLite: FTS3 custom tokenizers disabled by default in SQLite 3.11.0</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-SQLite/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-SQLite">DBD-SQLite CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">112474</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-SQLite/Active/">DBD-SQLite</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Stromeko [...] NexGo.DE

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10248-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10249-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;27&nbsp;06:00:23&nbsp;2016</span>
    <span class="description">Stromeko [...] NexGo.DE -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> FTS3 custom tokenizers disabled by default in SQLite 3.11.0</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 27 Feb 2016 11:59:59 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-SQLite [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Achim Gratz &lt;Stromeko [...] nexgo.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Starting with SQLite version 3.11.0 the FTS3 custom tokenizer is
disabled due to security concerns unless SQLITE_ENABLE_FTS3_TOKENIZER is
defined during compilation.  The following patch skips the FTS3 tests in
this case since they don&#39;t work if the custom tokenizer can&#39;t be
registered:

--8&lt;---------------cut here---------------start-------------&gt;8---
--- origsrc/DBD-SQLite-1.50/t/43_fts3.t 2015-02-17 07:57:49.000000000 +0100
+++ src/DBD-SQLite-1.50/t/43_fts3.t     2016-02-27 11:55:34.715375700 +0100
@@ -30,9 +30,12 @@ BEGIN {
        if &#40;$] &lt; 5.008005&#41; {
                plan skip_all =&gt; &#39;Unicode is not supported before 5.8.5&#39;;
        }
-       if &#40;!grep /ENABLE_FTS3/, DBD::SQLite::compile_options&#40;&#41;&#41; {
+       unless &#40;grep /ENABLE_FTS3/, DBD::SQLite::compile_options&#40;&#41;&#41; {
                plan skip_all =&gt; &#39;FTS3 is disabled for this DBD::SQLite&#39;;
        }
+       unless &#40;has_sqlite&#40;&#39;3.11.0&#39;&#41; and grep /ENABLE_FTS3_TOKENIZER/, DBD::SQLite::compile_options&#40;&#41;&#41; {
+               plan skip_all =&gt; &#39;FTS3 custom tokenizers are disabled for this DBD::SQLite&#39;;
+       }
 }
 use Test::NoWarnings;
 
--8&lt;---------------cut here---------------end---------------&gt;8---


Regards,
Achim.
-- 
+&lt;[Q+ Matrix-12 WAVE#46+305 Neuron microQkb Andromeda XTk Blofeld]&gt;+

Wavetables for the Waldorf Blofeld:
<span class="clickylink"><a target="new" rel="nofollow" href="http://Synth.Stromeko.net/Downloads.html#BlofeldUserWavetables">http://Synth.Stromeko.net/Downloads.html#BlofeldUserWavetables</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;27&nbsp;07:00:21&nbsp;2016</span>
    <span class="description">ishigaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Feb 27 20:00:23 2016, Stromeko@NexGo.DE wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Starting with SQLite version 3.11.0 the FTS3 custom tokenizer is
&gt; disabled due to security concerns unless SQLITE_ENABLE_FTS3_TOKENIZER
&gt; is
&gt; defined during compilation.  The following patch skips the FTS3 tests
&gt; in
&gt; this case since they don&#39;t work if the custom tokenizer can&#39;t be
&gt; registered:
&gt; 
&gt; --8&lt;---------------cut here---------------start-------------&gt;8---
&gt; --- origsrc/DBD-SQLite-1.50/t/43_fts3.t 2015-02-17 07:57:49.000000000
&gt; +0100
&gt; +++ src/DBD-SQLite-1.50/t/43_fts3.t     2016-02-27 11:55:34.715375700
&gt; +0100
&gt; @@ -30,9 +30,12 @@ BEGIN {
&gt;         if &#40;$] &lt; 5.008005&#41; {
&gt;                 plan skip_all =&gt; &#39;Unicode is not supported before
&gt; 5.8.5&#39;;
&gt;         }
&gt; -       if &#40;!grep /ENABLE_FTS3/, DBD::SQLite::compile_options&#40;&#41;&#41; {
&gt; +       unless &#40;grep /ENABLE_FTS3/, DBD::SQLite::compile_options&#40;&#41;&#41; {
&gt;                 plan skip_all =&gt; &#39;FTS3 is disabled for this
&gt; DBD::SQLite&#39;;
&gt;         }
&gt; +       unless &#40;has_sqlite&#40;&#39;3.11.0&#39;&#41; and grep /ENABLE_FTS3_TOKENIZER/,
&gt; DBD::SQLite::compile_options&#40;&#41;&#41; {
&gt; +               plan skip_all =&gt; &#39;FTS3 custom tokenizers are disabled
&gt; for this DBD::SQLite&#39;;
&gt; +       }
&gt;  }
&gt;  use Test::NoWarnings;
&gt; 
&gt; --8&lt;---------------cut here---------------end---------------&gt;8---
&gt; 
&gt; 
&gt; Regards,
&gt; Achim.
</div>
Thanks, but that&#39;s already been there since 1.51_01 :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;27&nbsp;07:00:28&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;27&nbsp;07:00:32&nbsp;2016</span>
    <span class="description">ishigaki [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;23&nbsp;14:26:07&nbsp;2016</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne So 27.úno.2016 07:00:21, ISHIGAKI napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sat Feb 27 20:00:23 2016, Stromeko@NexGo.DE wrote:
<div class="message-stanza open">&gt; &gt; 
&gt; &gt; Starting with SQLite version 3.11.0 the FTS3 custom tokenizer is
&gt; &gt; disabled due to security concerns unless SQLITE_ENABLE_FTS3_TOKENIZER
&gt; &gt; is
&gt; &gt; defined during compilation.
</div></div>[...]
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks, but that&#39;s already been there since 1.51_01 :&#41;
</div>
I will hijack this bug report, because with the current code, the t/43_fts3.t fails if compiled against sqlite 3.7.17:

PERL_DL_NONLAZY=1 &#34;/opt/rh/rh-perl524/root/usr/bin/perl&#34; &#34;-MExtUtils::Command::MM&#34; &#34;-MTest::Harness&#34; &#34;-e&#34; &#34;undef *Test::Harness::Switches; test_harness&#40;0, &#39;blib/lib&#39;, &#39;blib/arch&#39;&#41;&#34; t/*.t t/**/*.t
# $DBI::VERSION=1.636
# Compile Options:
#   DISABLE_DIRSYNC
#   ENABLE_COLUMN_METADATA
#   ENABLE_FTS3
#   ENABLE_RTREE
#   ENABLE_UNLOCK_NOTIFY
#   SECURE_DELETE
#   TEMP_STORE=1
#   THREADSAFE=1
t/01_compile.t ........................................ ok
# sqlite_version=3.7.17
t/02_logon.t .......................................... ok
[...]
t/42_primary_key_info.t ............................... ok
DBD::SQLite::db do failed: unknown tokenizer: perl at t/43_fts3.t line 90.
#   Failed test &#39;no warnings&#39;
#   at /opt/rh/rh-perl524/root/usr/share/perl5/vendor_perl/Test/Builder.pm line 135.
# There were 1 warning&#40;s&#41;
#       Previous test 1 &#39;An object of class &#39;DBI::db&#39; isa &#39;DBI::db&#39;&#39;
#       DBD::SQLite::db do failed: unknown tokenizer: perl at t/43_fts3.t line 90.
#  at t/43_fts3.t line 90.
#
# Looks like your test exited with 255 just after 2.
t/43_fts3.t ...........................................
Dubious, test returned 255 &#40;wstat 65280, 0xff00&#41;
Failed 34/35 subtests

The reason is the FT3 tokenizer tests are skipped like this:

    if &#40;$DBD::SQLite::sqlite_version_number &gt;= 3011000 and !grep /ENABLE_FTS3_TOKENIZER/, DBD::SQLite::compile_options&#40;&#41;&#41; {
        plan skip_all =&gt; &#39;FTS3 tokenizer is disabled for this DBD::SQLite&#39;;
    }

But DBD-SQLite does not register the perl tokenizer by default:

static int
register_fts3_perl_tokenizer&#40;dbh&#41;
    SV *dbh
    ALIAS:
        DBD::SQLite::db::sqlite_register_fts3_perl_tokenizer = 1
    CODE:
#if SQLITE_ENABLE_FTS3_TOKENIZER
        RETVAL = sqlite_db_register_fts3_perl_tokenizer&#40;aTHX_ dbh&#41;;
#else   
        RETVAL = 0;
#endif
    OUTPUT:
        RETVAL

So the DBD-SQLite code does not support the tokenizer and the test does not find sqlite &gt;= 3.11.0, so it proceeds with the tests and then the tests fail on unknown perl tokenizer because the code did not register it.

I don&#39;t know how to fix the test properly. We cannot check for the keyword in the compile options unconditionally because older sqlite does have the keyword even if it supports the tokenizer.

Either the Makefile.PL could propagate the SQLITE_ENABLE_FTS3_TOKENIZER environment variable to the tests, or maybe better one as dbdimp.c condition the struct perl_tokenizer by:

#if SQLITE_VERSION_NUMBER &lt; 3011000 || SQLITE_ENABLE_FTS3_TOKENIZER

the SQLite.xs should do the same instead of current:

#if SQLITE_ENABLE_FTS3_TOKENIZER

Any ideas?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;24&nbsp;07:27:02&nbsp;2016</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne So 23.čec.2016 14:26:07, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I will hijack this bug report, because with the current code, the
&gt; t/43_fts3.t fails if compiled against sqlite 3.7.17:
</div>[...]
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; or maybe better one as dbdimp.c condition the struct perl_tokenizer by:
&gt; 
&gt; #if SQLITE_VERSION_NUMBER &lt; 3011000 || SQLITE_ENABLE_FTS3_TOKENIZER
&gt; 
&gt; the SQLite.xs should do the same instead of current:
&gt; 
&gt; #if SQLITE_ENABLE_FTS3_TOKENIZER
&gt; 
</div>I went this way. See attached patch. It works with sqlite 3.13.0 as well as with 3.7.17.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> DBD-SQLite-1.51_05-Always-register-perl-FTS3-tokenizer-with-sqlite-befo.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 5687040e291c06a7e49cae9cfae0f2be96b05ef3 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Sun, 24 Jul 2016 11:15:52 +0200
Subject: [PATCH] Always register perl FTS3 tokenizer with sqlite before 3.11.0
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Disabling perl FTS3 tokenizer by default caused t/43_fts3.t failures
if building against sqlite &lt; 3.11.0. That was caused by assymetry
between enabling the support &#40;purely on SQLITE_ENABLE_FTS3_TOKENIZER
environemnt variable&#41; and skipping the tests &#40;on version and
ENABLE_FTS3_TOKENIZER compile option&#41;.

CPAN RT#112474

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 SQLite.xs | 2 +-
 1 file changed, 1 insertion&#40;+&#41;, 1 deletion&#40;-&#41;

diff --git a/SQLite.xs b/SQLite.xs
index f20e511..06fc425 100644
--- a/SQLite.xs
+++ b/SQLite.xs
@@ -288,7 +288,7 @@ register_fts3_perl_tokenizer&#40;dbh&#41;
     ALIAS:
         DBD::SQLite::db::sqlite_register_fts3_perl_tokenizer = 1
     CODE:
-#if SQLITE_ENABLE_FTS3_TOKENIZER
+#if SQLITE_VERSION_NUMBER &lt; 3011000 || SQLITE_ENABLE_FTS3_TOKENIZER
         RETVAL = sqlite_db_register_fts3_perl_tokenizer&#40;aTHX_ dbh&#41;;
 #else
         RETVAL = 0;
-- 
2.5.5

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;26&nbsp;15:48:26&nbsp;2016</span>
    <span class="description">ishigaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Jul 24 20:27:02 2016, ppisar wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dne So 23.čec.2016 14:26:07, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; I will hijack this bug report, because with the current code, the
&gt; &gt; t/43_fts3.t fails if compiled against sqlite 3.7.17:
</div>&gt; [...]
<div class="message-stanza open">&gt; &gt; or maybe better one as dbdimp.c condition the struct perl_tokenizer
&gt; &gt; by:
&gt; &gt;
&gt; &gt; #if SQLITE_VERSION_NUMBER &lt; 3011000 || SQLITE_ENABLE_FTS3_TOKENIZER
&gt; &gt;
&gt; &gt; the SQLite.xs should do the same instead of current:
&gt; &gt;
&gt; &gt; #if SQLITE_ENABLE_FTS3_TOKENIZER
&gt; &gt;
</div>&gt; I went this way. See attached patch. It works with sqlite 3.13.0 as
&gt; well as with 3.7.17.
</div>
Hi, sorry for the delayed reply.

Apparently you must have patched your Makefile.PL &#40;because DBD::SQLite doesn&#39;t support older versions of sqlite library by default, right?&#41;, it&#39;s up to you to patch whatever you think is necessary for your users :&#41;

Joking apart, we actually need to consider more to fix the real problem here. It&#39;s not only the version of SQLite, but the result of sqlite_db_config&#40;&#41; &#40;which is not yet supported in DBD::SQLite, but should be&#41; may matter, either &#40;or not, depending on the way to write tests&#41;.

So, what do you think is the best possible scenario? I&#39;m happy to support/apply anything, as long as that doesn&#39;t break other important modules. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;23&nbsp;21:45:14&nbsp;2016</span>
    <span class="description">ishigaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jul 27 04:48:26 2016, ISHIGAKI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sun Jul 24 20:27:02 2016, ppisar wrote:
<div class="message-stanza open">&gt; &gt; Dne So 23.čec.2016 14:26:07, ppisar napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; &gt; I will hijack this bug report, because with the current code, the
&gt; &gt; &gt; t/43_fts3.t fails if compiled against sqlite 3.7.17:
</div>&gt; &gt; [...]
<div class="message-stanza open">&gt; &gt; &gt; or maybe better one as dbdimp.c condition the struct perl_tokenizer
&gt; &gt; &gt; by:
&gt; &gt; &gt;
&gt; &gt; &gt; #if SQLITE_VERSION_NUMBER &lt; 3011000 || SQLITE_ENABLE_FTS3_TOKENIZER
&gt; &gt; &gt;
&gt; &gt; &gt; the SQLite.xs should do the same instead of current:
&gt; &gt; &gt;
&gt; &gt; &gt; #if SQLITE_ENABLE_FTS3_TOKENIZER
&gt; &gt; &gt;
</div>&gt; &gt; I went this way. See attached patch. It works with sqlite 3.13.0 as
&gt; &gt; well as with 3.7.17.
</div>&gt; 
&gt; Hi, sorry for the delayed reply.
&gt; 
&gt; Apparently you must have patched your Makefile.PL &#40;because DBD::SQLite
&gt; doesn&#39;t support older versions of sqlite library by default, right?&#41;,
&gt; it&#39;s up to you to patch whatever you think is necessary for your users
&gt; :&#41;
&gt; 
&gt; Joking apart, we actually need to consider more to fix the real
&gt; problem here. It&#39;s not only the version of SQLite, but the result of
&gt; sqlite_db_config&#40;&#41; &#40;which is not yet supported in DBD::SQLite, but
&gt; should be&#41; may matter, either &#40;or not, depending on the way to write
&gt; tests&#41;.
&gt; 
&gt; So, what do you think is the best possible scenario? I&#39;m happy to
&gt; support/apply anything, as long as that doesn&#39;t break other important
&gt; modules.
</div>

Fixed this issue by calling sqlite_db_config. Thanks.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;23&nbsp;21:45:15&nbsp;2016</span>
    <span class="description">ishigaki [...] cpan.org -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
