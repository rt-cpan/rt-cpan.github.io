<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #69326 for Encode: Wrong encode_utf8 result for utf8 string</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #69326 for Encode: Wrong encode_utf8 result for utf8 string</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Encode/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Encode/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Encode/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Encode/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Encode">Encode CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">69326</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Encode/Active/">Encode</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
marbuga [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-12062-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.43    </td>
  </tr>
  <tr id="CF-12063-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;06&nbsp;22:41:29&nbsp;2011</span>
    <span class="description">marbuga [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Wrong encode_utf8 result for utf8 string</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello.



Detailed info about modules&#39;, perl&#39;s and OSs&#39; versions are below.



Short description of the issue:

$a = &#34;äöüéà&#34;; # is the utf8 string with non English letters in source code
Encode::encode_utf8&#40; $a &#41;; # returns wrong result

Please take a look on the following info to ensure.



Full description of the issue:

I am using the perl script written in utf8 encoding with predefined non
English variables. I.e. all predefined non English strings have non
English characters in utf8 charset.

For example,

$a = &#34;äöüéà&#34;;

i.e. it&#39;s the same as

$a = &#34;\x{c3}\x{a4}\x{c3}\x{b6}\x{c3}\x{bc}\x{c3}\x{a9}\x{c3}\x{a0}&#34;;

i.e. it&#39;s really a &#34;äöüéà&#34; in utf8 charset ;&#41;



To ensure that this script will work on the &#34;non utf8&#34; system &#40;for
example, on latin1, i.e. ISO-8859-1&#41; and to send correct data via
network, I encode the predefined variable to utf8 by Encode::encode_utf8.

And the result string is not a utf8 string. I.e. the result differs from
the predefined string in utf8 source code.

I.e. &#34;äöüéà&#34; is encoded to &#34;Ã¤Ã¶Ã¼Ã©Ã &#34; ;&#41;
I.e. &#34;\x{c3}\x{a4}\x{c3}\x{b6}\x{c3}\x{bc}\x{c3}\x{a9}\x{c3}\x{a0}&#34; &#40;10
bytes&#41; becomes
&#34;\x{c3}\x{83}\x{c2}\x{a4}\x{c3}\x{83}\x{c2}\x{b6}\x{c3}\x{83}\x{c2}\x{bc}\x{c3}\x{83}\x{c2}\x{a9}\x{c3}\x{83}\x{c2}\x{a0}&#34;
&#40;20 bytes&#41;
But the result of Encode::encode_utf8 should be the same.
I.e. &#34;äöüéà&#34; should be encoded to &#34;äöüéà&#34;.

Please let me know if I should explain this &#40;i.e. why utf8 string should
be not changed after encoding to utf8&#41;.



Could you please correct this issue. Or please let me know if you need
more info about it.



Thank you



P.S. I am adding the perl script and it&#39;s log to illustrate this issue.


P.P.S. Here is the detailed info for investigation:



Module version:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">cpan&gt; i Encode
</div>Module id = Encode
... &#40;missed&#41;
    CPAN_VERSION 2.43
... &#40;missed&#41;
    INST_VERSION 2.39



Reproduced on OS &#40;uname -a&#41;:

Oracle Enterprise Linux 5.4 x86_64
Linux ... 2.6.18-164.0.0.0.1.el5 #1 SMP Thu Sep 3 00:21:28 EDT 2009
x86_64 x86_64 x86_64 GNU/Linux

Fedora 14 Linux x86_64
Linux ... 2.6.35.13-92.fc14.x86_64 #1 SMP Sat May 21 17:26:25 UTC 2011
x86_64 x86_64 x86_64 GNU/Linux

Fedora 14 Linux i386
Linux ... 2.6.35.13-92.fc14.i686 #1 SMP Sat May 21 17:39:42 UTC 2011
i686 i686 i386 GNU/Linux



Perl version &#40;i.e. perl -v&#41;:

on Oracle Enterprise Linux 5.4 x86_64:
This is perl, v5.8.8 built for x86_64-linux-thread-multi

on Fedora 14 Linux x86_64:
This is perl 5, version 12, subversion 3 &#40;v5.12.3&#41; built for
x86_64-linux-thread-multi

on Fedora 14 Linux i386:
This is perl 5, version 12, subversion 3 &#40;v5.12.3&#41; built for
i386-linux-thread-multi



Please note, that locale returns utf8 too:

$ locale
LANG=en_US.utf8
LC_CTYPE=&#34;en_US.utf8&#34;
LC_NUMERIC=&#34;en_US.utf8&#34;
LC_TIME=&#34;en_US.utf8&#34;
LC_COLLATE=&#34;en_US.utf8&#34;
LC_MONETARY=&#34;en_US.utf8&#34;
LC_MESSAGES=&#34;en_US.utf8&#34;
LC_PAPER=&#34;en_US.utf8&#34;
LC_NAME=&#34;en_US.utf8&#34;
LC_ADDRESS=&#34;en_US.utf8&#34;
LC_TELEPHONE=&#34;en_US.utf8&#34;
LC_MEASUREMENT=&#34;en_US.utf8&#34;
LC_IDENTIFICATION=&#34;en_US.utf8&#34;
LC_ALL=
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> utf8_to_utf8.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use strict;
use Encode;
use bytes; # to show length in bytes &#40;i.e. not in characters&#41;

sub fcStringShow {
	my $v = shift;

	print &#34;String: {{&#34; . $v . &#34;}}\n&#34;;
	print &#34;\tlength = &#34; . length&#40; $v &#41; . &#34;\n&#34;;

	print &#34;\t&#34;; my $i = 0; while &#40; $i &lt; length&#40; $v &#41; &#41; {
		printf &#34;\\x{%.2x}&#34; , ord&#40; substr&#40; $v , $i &#41; &#41;;
		$i = $i + 1;
	} print &#34;\n&#34;;
}

sub fcTest {
	my $a = shift;

	print &#34;Not encoded string is: &#34; . $a . &#34;\n&#34;;
	fcStringShow&#40; $a &#41;;

	my $b = Encode::encode_utf8&#40; $a &#41;;
	print &#34;Encoded string is: &#34; . $b . &#34;\n&#34;;
	fcStringShow&#40; $b &#41;;

	print &#34;\n&#34;;
}

fcTest&#40; &#34;abcde&#34; &#41;;
fcTest&#40; &#34;Ã¤Ã¶Ã¼Ã©Ã &#34; &#41;;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> utf8_to_utf8.log</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;06&nbsp;22:57:18&nbsp;2011</span>
    <span class="description">marbuga [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> marbuga [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think that the following information can help you to find the root of
the issue.

I use the iconv &#40;on c++&#41; to convert &#34;äöüéà&#34; string. And I think, that
the reason of Encode::encode_utf8 wrong conversion is the fact:

Encode::encode_utf8 &#34;thinks&#34; that utf8 &#34;äöüéà&#34; string is a latin1 &#40;i.e.
ISO-8859-1&#41; string and that&#39;s why it converts it to wrong utf8 string
&#40;i.e. not to &#34;äöüéà&#34;&#41;.

Please take a look on the following info to ensure:


Start conversion from UTF-8 charset to UTF-8 charset ...
String &#40;which must be converted&#41;: äöüéà
String &#40;which must be converted&#41; - hex data: 0xC3 , 0xA4 , 0xC3 , 0xB6 ,
0xC3 , 0xBC , 0xC3 , 0xA9 , 0xC3 , 0xA0 ,  &#40;10 bytes&#41;
i.e. in decimal: 195 , 164 , 195 , 182 , 195 , 188 , 195 , 169 , 195 ,
160 ,  &#40;10 bytes&#41;
i.e. perl string:
\x{c3}\x{a4}\x{c3}\x{b6}\x{c3}\x{bc}\x{c3}\x{a9}\x{c3}\x{a0} &#40;10 bytes&#41;
This is a REVERSIBLE conversion !!!
Result string is: äöüéà
Result string - hex data: 0xC3 , 0xA4 , 0xC3 , 0xB6 , 0xC3 , 0xBC , 0xC3
, 0xA9 , 0xC3 , 0xA0 ,  &#40;10 bytes&#41;
i.e. in decimal: 195 , 164 , 195 , 182 , 195 , 188 , 195 , 169 , 195 ,
160 ,  &#40;10 bytes&#41;
i.e. perl string:
\x{c3}\x{a4}\x{c3}\x{b6}\x{c3}\x{bc}\x{c3}\x{a9}\x{c3}\x{a0} &#40;10 bytes&#41;


Start conversion from UTF-8 charset to ISO-8859-1 charset ...
String &#40;which must be converted&#41;: äöüéà
String &#40;which must be converted&#41; - hex data: 0xC3 , 0xA4 , 0xC3 , 0xB6 ,
0xC3 , 0xBC , 0xC3 , 0xA9 , 0xC3 , 0xA0 ,  &#40;10 bytes&#41;
i.e. in decimal: 195 , 164 , 195 , 182 , 195 , 188 , 195 , 169 , 195 ,
160 ,  &#40;10 bytes&#41;
i.e. perl string:
\x{c3}\x{a4}\x{c3}\x{b6}\x{c3}\x{bc}\x{c3}\x{a9}\x{c3}\x{a0} &#40;10 bytes&#41;
This is a REVERSIBLE conversion !!!
Result string is: ����
Result string - hex data: 0xE4 , 0xF6 , 0xFC , 0xE9 , 0xE0 ,  &#40;5 bytes&#41;
i.e. in decimal: 228 , 246 , 252 , 233 , 224 ,  &#40;5 bytes&#41;
i.e. perl string: \x{e4}\x{f6}\x{fc}\x{e9}\x{e0} &#40;5 bytes&#41;


Start conversion from ISO-8859-1 charset to UTF-8 charset ...
String &#40;which must be converted&#41;: äöüéà
String &#40;which must be converted&#41; - hex data: 0xC3 , 0xA4 , 0xC3 , 0xB6 ,
0xC3 , 0xBC , 0xC3 , 0xA9 , 0xC3 , 0xA0 ,  &#40;10 bytes&#41;
i.e. in decimal: 195 , 164 , 195 , 182 , 195 , 188 , 195 , 169 , 195 ,
160 ,  &#40;10 bytes&#41;
i.e. perl string:
\x{c3}\x{a4}\x{c3}\x{b6}\x{c3}\x{bc}\x{c3}\x{a9}\x{c3}\x{a0} &#40;10 bytes&#41;
This is a REVERSIBLE conversion !!!
Result string is: Ã¤Ã¶Ã¼Ã©Ã 
Result string - hex data: 0xC3 , 0x83 , 0xC2 , 0xA4 , 0xC3 , 0x83 , 0xC2
, 0xB6 , 0xC3 , 0x83 , 0xC2 , 0xBC , 0xC3 , 0x83 , 0xC2 , 0xA9 , 0xC3 ,
0x83 , 0xC2 , 0xA0 ,  &#40;20 bytes&#41;
i.e. in decimal: 195 , 131 , 194 , 164 , 195 , 131 , 194 , 182 , 195 ,
131 , 194 , 188 , 195 , 131 , 194 , 169 , 195 , 131 , 194 , 160 ,  &#40;20
bytes&#41;
i.e. perl string:
\x{c3}\x{83}\x{c2}\x{a4}\x{c3}\x{83}\x{c2}\x{b6}\x{c3}\x{83}\x{c2}\x{bc}\x{c3}\x{83}\x{c2}\x{a9}\x{c3}\x{83}\x{c2}\x{a0}
&#40;20 bytes&#41;


Sincerely, Maryan Bahnyuk &#40;AKA marbug&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;07&nbsp;01:16:54&nbsp;2011</span>
    <span class="description">DANKOGAI [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;07&nbsp;02:28:43&nbsp;2011</span>
    <span class="description">marbuga [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> marbuga [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry.
Forgot to note:

Reproduced on 2.43 too

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">cpan&gt; i Encode
</div>...&#40;missed&#41;
    CPAN_VERSION 2.43
...&#40;missed&#41;
    INST_VERSION 2.43



Sincerely,
Maryan Bahnyuk
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;07&nbsp;02:28:43&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;07&nbsp;06:01:22&nbsp;2011</span>
    <span class="description">marbuga [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> marbuga [...] gmail.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I use the iconv &#40;on c++&#41; to convert &#34;äöüéà&#34; string.
</div>
Here is the same on perl. Files are attached.


Sincerely, Maryan Bahnyuk &#40;AKA marbug&#41;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> iconv.log</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> iconv.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use Text::Iconv;
use strict;


my $a = &#34;Ã¤Ã¶Ã¼Ã©Ã &#34;;

sub fcStringShow {
	my $v = shift;

	print &#34;String: {{&#34; . $v . &#34;}}\n&#34;;
	print &#34;\tlength = &#34; . length&#40; $v &#41; . &#34;\n&#34;;

	print &#34;\t&#34;; my $i = 0; while &#40; $i &lt; length&#40; $v &#41; &#41; {
		printf &#34;\\x{%.2x}&#34; , ord&#40; substr&#40; $v , $i &#41; &#41;;
		$i = $i + 1;
	} print &#34;\n&#34;;
}

fcStringShow&#40; $a &#41;;

print &#34;\nUTF-8 to UTF8\n&#34;;
my $converter = Text::Iconv-&gt;new&#40; &#34;UTF-8&#34;, &#34;UTF-8&#34; &#41;;
my $v = $converter-&gt;convert&#40; $a &#41;;
fcStringShow&#40; $v &#41;;

print &#34;\nUTF-8 to Latin1 &#40;ISO-8859-1&#41;\n&#34;;
my $converter = Text::Iconv-&gt;new&#40; &#34;UTF-8&#34; , &#34;ISO-8859-1&#34; &#41;;
my $v = $converter-&gt;convert&#40; $a &#41;;
fcStringShow&#40; $v &#41;;

print &#34;\nLatin1 &#40;ISO-8859-1&#41; to UTF-8\n&#34;;
my $converter = Text::Iconv-&gt;new&#40; &#34;ISO-8859-1&#34; , &#34;UTF-8&#34; &#41;;
my $v = $converter-&gt;convert&#40; $a &#41;;
fcStringShow&#40; $v &#41;;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;07&nbsp;06:06:24&nbsp;2011</span>
    <span class="description">marbuga [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> marbuga [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I use the iconv &#40;on c++&#41; to convert &#34;äöüéà&#34; string.
</div>&gt; 
&gt; Here is the same on perl. Files are attached.
</div>
Also I&#39;d like to note, that I am familiar with docs:

CAVEAT: When you run $octets = encode&#40;&#34;utf8&#34;, $string&#41; , then $octets
may not be equal to $string. Though they both contain the same data, the
UTF8 flag for $octets is always off.

Sorry, but this statement looks very &#34;strange&#34; and &#34;wrong&#34;, because the
results are unexpected.


Sincerely, Maryan Bahnyuk &#40;AKA marbug&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;07&nbsp;06:21:41&nbsp;2011</span>
    <span class="description">marbuga [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> marbuga [...] gmail.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">As I see my files are corrupted after download.
Here is their archived copies.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> utf8_to_utf8.zip</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> iconv.tar.gz</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> iconv.zip</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> utf8_to_utf8.tar.gz</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;07&nbsp;19:33:15&nbsp;2011</span>
    <span class="description">marbuga [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> marbuga [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; CAVEAT: When you run $octets = encode&#40;&#34;utf8&#34;, $string&#41; , then $octets
&gt; may not be equal to $string. Though they both contain the same data, the
&gt; UTF8 flag for $octets is always off.
&gt; 
&gt; Sorry, but this statement looks very &#34;strange&#34; and &#34;wrong&#34;, because the
&gt; results are unexpected.
</div>
Let&#39;s take a look on more details.

Then I try to read/write perl variable from/to file or send/receive it
via network without your Encode::encode method, all data is passed s it
is. I.e. perl use the current data from source code. I.e. if source code
is in utf8 charset, the variable contains utf8 bytes. If source code is
not utf8 - it &#40;i.e. perl variable&#41; contains corresponding data.
I.e. &#34;internal&#34; perl characters depends on the system locale.

Please correct me if I am wrong.

In such case, if I understand your Encode::encode method correctly, it
should check &#34;perl&#34; charset first and if &#34;perl&#34; &#40;i.e. variable&#41; charset
is utf8, Encode::encode_utf8 should return the same data.

Am I wrong?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;07&nbsp;19:43:26&nbsp;2011</span>
    <span class="description">marbuga [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> marbuga [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In such case, if I understand your Encode::encode method correctly, it
&gt; should check &#34;perl&#34; charset first and if &#34;perl&#34; &#40;i.e. variable&#41; charset
&gt; is utf8, Encode::encode_utf8 should return the same data.
</div>
Theoretically your methods may not check variable encoding &#40;if it is
quite hard&#41;. They may use perl&#39;s locale methods &#40;i.e. &#34;man perllocale&#34;&#41;
to define current variables charset or may have something like
Encode::set_default_charset&#40; &#39;utf8&#39; &#41; to define current charset.

In such case all your methods can use it&#39;s value for conversion.

I.e. if Encode::set_default_charset sets utf8, Encode::encode_utf8 will
return the same variable.

Don&#39;t you think that in such case &#40;i.e. with Encode::set_default_charset
or perllocale&#41; it will be more correct to work with your methods?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;07&nbsp;19:59:56&nbsp;2011</span>
    <span class="description">marbuga [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> marbuga [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I.e. if Encode::set_default_charset sets utf8, Encode::encode_utf8
</div>will return the same variable.

I think, that in such case anyone can use your decode method to convert
predefined variables from source code charset to perl&#39;s current charset.
I.e. anyone will not need to convert all source code to local charset.

I.e. the source code, written in utf8 charset, can be run without
modifications on system with &#40;for example&#41; latin1 charset.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;12&nbsp;04:49:50&nbsp;2011</span>
    <span class="description">marbuga [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> marbuga [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello.
As I see this question is not interesting for you.
Could you please close this ticket.
Thanks and good luck.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;12&nbsp;07:03:22&nbsp;2011</span>
    <span class="description">chansen [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Maryan,

I&#39;m not sure what you are proposing, but the output of your utf8_to_utf8.pl
script is expected.

Perl has two different representations of strings:

use Encode     qw[]; 
use Test::More tests =&gt; 3;

my $string1 = &#34;\xE5\xE4\xF6&#34;;
my $string2 = Encode::decode&#40;&#39;ISO-8859-1&#39;, $string1&#41;;

ok&#40;utf8::is_utf8&#40;$string1&#41; ne utf8::is_utf8&#40;$string2&#41;, &#34;strings use different internal 
representations&#34;&#41;;

is&#40;$string1, $string2, &#34;strings are equal regardless of internal character representation&#34;&#41;;

my $octets1 = Encode::encode_utf8&#40;$string1&#41;;
my $octets2 = Encode::encode_utf8&#40;$string2&#41;;

is&#40;$octets1, $octets2, &#34;encoded strings are equal regardless of internal character 
representation&#34;&#41;;

Perl&#39;s internal character representation is a internal matter. Either make 
your program character aware or use octets, mixing characters with octets 
isn&#39;t a good idea. decode early and encode late.

--
chansen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;22&nbsp;20:50:00&nbsp;2011</span>
    <span class="description">marbuga [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> marbuga [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dear Chansen

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m not sure what you are proposing, but the output of your
&gt; utf8_to_utf8.pl script is expected.
</div>
Sorry. Looks like I have low explanation skills. Can we check my
conclusions step-by-step please. In my humble opinion this might help.



First could you please take a look on the following simple examples and
confirm that the issue &#34;is&#34; or &#34;is not&#34; present.



vvvvvvvvvvvvvvv test1.pl

#!/usr/bin/perl

$a = &#34;äöüéà&#34;;
$l = length&#40; $a &#41;;
printf&#40; &#34;length of \$a is &#34; . $l . &#34;\n&#34; &#41;;

$i = 0;
while &#40; $i &lt; $l &#41; {
    printf &#34;\\x{%.2x}&#34; , ord&#40; substr&#40; $a , $i &#41; &#41;;
    $i++;
}
print &#34;\n&#34;;

^^^^^^^^^^^^^^^ test1.pl



This source code is written in UTF8 charset and its output is the following:

vvvvvvvvvvvvvvv test1.pl output

length of $a is 10
\x{c3}\x{a4}\x{c3}\x{b6}\x{c3}\x{bc}\x{c3}\x{a9}\x{c3}\x{a0}

^^^^^^^^^^^^^^^ test1.pl output

I.e. $a variable value is already present as octets. Am I right?

Please take a look on test1.png to ensure.




Let&#39;s take a look on the same script which has been &#40;a little bit&#41;
modified to use encode_utf8:

vvvvvvvvvvvvvvv test2.pl

#!/usr/bin/perl

use Encode qw[];

sub show {
    my $t = shift;
    printf&#40; &#34;value: &#34; . $t . &#34;\n&#34; &#41;;

    my $l = length&#40; $t &#41;;
    printf&#40; &#34;length of $t is &#34; . $l . &#34;\n&#34; &#41;;

    $i = 0;
    while &#40; $i &lt; $l &#41; {
        printf &#34;\\x{%.2x}&#34; , ord&#40; substr&#40; $t , $i &#41; &#41;;
        $i++;
    }
    print &#34;\n&#34;;
}

$a = &#34;äöüéà&#34;;
show&#40; $a &#41;;

$o = Encode::encode_utf8&#40; $a &#41;;
show&#40; $o &#41;;

^^^^^^^^^^^^^^^ test2.pl



The output is the following:

vvvvvvvvvvvvvvv test2.pl output

value: äöüéà
length of äöüéà is 10
\x{c3}\x{a4}\x{c3}\x{b6}\x{c3}\x{bc}\x{c3}\x{a9}\x{c3}\x{a0}
value: Ã¤Ã¶Ã¼Ã©Ã 
length of Ã¤Ã¶Ã¼Ã©Ã  is 20
\x{c3}\x{83}\x{c2}\x{a4}\x{c3}\x{83}\x{c2}\x{b6}\x{c3}\x{83}\x{c2}\x{bc}\x{c3}\x{83}\x{c2}\x{a9}\x{c3}\x{83}\x{c2}\x{a0}

^^^^^^^^^^^^^^^ test2.pl output



I.e. encode_utf8 makes the unexpected action: it converts already
present octets to another &#34;strange&#34; octets. Is this correct?

Let&#39;s take a look on the same script with the following additional line:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Encode::_utf8_on&#40; $a &#41;;
</div>to ensure:



vvvvvvvvvvvvvvv test3.pl

#!/usr/bin/perl

use Encode qw[];

sub show {
    my $t = shift;
    printf&#40; &#34;value: &#34; . $t . &#34;\n&#34; &#41;;

    my $l = length&#40; $t &#41;;
    printf&#40; &#34;length of $t is &#34; . $l . &#34;\n&#34; &#41;;

    $i = 0;
    while &#40; $i &lt; $l &#41; {
        printf &#34;\\x{%.2x}&#34; , ord&#40; substr&#40; $t , $i &#41; &#41;;
        $i++;
    }
    print &#34;\n&#34;;
}

$a = &#34;äöüéà&#34;;
show&#40; $a &#41;;

Encode::_utf8_on&#40; $a &#41;;
$o = Encode::encode_utf8&#40; $a &#41;;
show&#40; $o &#41;;

^^^^^^^^^^^^^^^ test3.pl



Now the output is correct:

vvvvvvvvvvvvvvv test3.pl output

value: äöüéà
length of äöüéà is 10
\x{c3}\x{a4}\x{c3}\x{b6}\x{c3}\x{bc}\x{c3}\x{a9}\x{c3}\x{a0}
value: äöüéà
length of äöüéà is 10
\x{c3}\x{a4}\x{c3}\x{b6}\x{c3}\x{bc}\x{c3}\x{a9}\x{c3}\x{a0}

^^^^^^^^^^^^^^^ test3.pl output

Could you please let me know:
1&#41; if utf8 flag absence for UTF8 STRING is a correct behavior
2&#41; should I handle utf8 flag for utf8 strings before calling encode_utf8?
I think that both answers are &#34;NO&#34; but I might be wrong.
Please correct me.



<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Perl&#39;s internal character representation is a internal matter.
</div>
Surely I agree with this.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; mixing characters with octets isn&#39;t a good idea. 
&gt; decode early and encode late
</div>
Do you mean that encode_utf8 returns the internal data, which should be
used only for passing to decode_utf8 and vice versa?

Now I can&#39;t imagine how to use these wrong &#34;octets&#34; &#40;i.e. octets which
are returned by encode_utf8&#41; for another purpose. Could you please give
some examples if I am wrong.



<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; CAVEAT: When you run $octets = encode&#40;&#34;utf8&#34;, $string&#41; ,
&gt; then $octets may not be equal to $string. Though they both
&gt; contain the same data, the UTF8 flag for $octets is always off.
</div>
These words looks like a misprint because:


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; $octets may not be equal to $string
</div>
1&#41; any utf8 string with non English characters after conversion to
$octets will be ALWAYS not equal to $string &#40;see my examples&#41;


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Though they both contain the same data
</div>
2&#41; if $string has the non English characters then $string and $octets
will NOT contain the same data IN ANY CASE &#40;because utf8 flag is not set&#41;

Am I wrong?



I hope that my explanation is clear and that I have not irritate you by
such &#34;robotized&#34; language.



Sincerely,
Maryan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;22&nbsp;20:51:46&nbsp;2011</span>
    <span class="description">marbuga [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> marbuga [...] gmail.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dear Chansen

My examples from the previous post are in the attach

Sincerely,
Maryan
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> examples.tar.gz</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;23&nbsp;09:26:16&nbsp;2011</span>
    <span class="description">chansen [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Maryan,

Vid Tue, 22 Nov 2011 kl. 20.50.00, skrev marbug:
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; vvvvvvvvvvvvvvv test1.pl output
&gt; 
&gt; length of $a is 10
&gt; \x{c3}\x{a4}\x{c3}\x{b6}\x{c3}\x{bc}\x{c3}\x{a9}\x{c3}\x{a0}
&gt; 
&gt; ^^^^^^^^^^^^^^^ test1.pl output
&gt; 
&gt; I.e. $a variable value is already present as octets. Am I right?
</div>
Yes, $a is a octet string encoded in UTF-8 encoding form.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; vvvvvvvvvvvvvvv test2.pl output
&gt; 
&gt; value: äöüéà
&gt; length of äöüéà is 10
&gt; \x{c3}\x{a4}\x{c3}\x{b6}\x{c3}\x{bc}\x{c3}\x{a9}\x{c3}\x{a0}
&gt; value: Ã¤Ã¶Ã¼Ã©Ã 
&gt; length of Ã¤Ã¶Ã¼Ã©Ã  is 20
&gt; \x{c3}\x{83}\x{c2}\x{a4}\x{c3}\x{83}\x{c2}\x{b6}\x{c3}\x{83}\x{c2}\x{bc}\x{c3}\x{83}\x{c2}\x{a9}\x{c3}\x{83}\x{c2}\x{a0}
&gt; 
&gt; ^^^^^^^^^^^^^^^ test2.pl output
</div>

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I.e. encode_utf8 makes the unexpected action: it converts already
&gt; present octets to another &#34;strange&#34; octets. Is this correct?
</div>
Yes it&#39;s correct. In my previous reply I mentioned that Perl has two different internal representations for strings. SvUTF8 indicates which one is used, if it&#39;s off ISO-
8859-1 &#40;aka Latin1&#41; is assumed.

$a = &#34;äöüéà&#34;;
$o = Encode::encode_utf8&#40;$a&#41;;

in this case it&#39;s equivalent to:

$o = Encode::encode_utf8&#40;Encode::decode&#40;&#39;ISO-8859-1&#39;, $a&#41;&#41;;


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Let&#39;s take a look on the same script with the following additional
&gt; line:
<div class="message-stanza open">&gt; &gt; Encode::_utf8_on&#40; $a &#41;;
</div>&gt; to ensure:
&gt;
&gt; Now the output is correct:
&gt; 
&gt; vvvvvvvvvvvvvvv test3.pl output
&gt; 
&gt; value: äöüéà
&gt; length of äöüéà is 10
&gt; \x{c3}\x{a4}\x{c3}\x{b6}\x{c3}\x{bc}\x{c3}\x{a9}\x{c3}\x{a0}
&gt; value: äöüéà
&gt; length of äöüéà is 10
&gt; \x{c3}\x{a4}\x{c3}\x{b6}\x{c3}\x{bc}\x{c3}\x{a9}\x{c3}\x{a0}
&gt; 
&gt; ^^^^^^^^^^^^^^^ test3.pl output
&gt; 
&gt; Could you please let me know:
&gt; 1&#41; if utf8 flag absence for UTF8 STRING is a correct behavior
</div>
Yes, encode_utf8&#40;&#41; expects a character string and returns a octet string.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2&#41; should I handle utf8 flag for utf8 strings before calling
&gt; encode_utf8?
</div>
No, you should decode your data as early as possible and encode it as late as possible.

$string = Encode::decode_utf8&#40;$input&#41;;
# ↓
# process your data
# ↓
$output = Encode::encode_utf8&#40;$string&#41;;


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Perl&#39;s internal character representation is a internal matter.
</div>&gt; 
&gt; Surely I agree with this.
&gt; 
<div class="message-stanza open">&gt; &gt; mixing characters with octets isn&#39;t a good idea.
&gt; &gt; decode early and encode late
</div>&gt; 
&gt; Do you mean that encode_utf8 returns the internal data, which should
&gt; be
&gt; used only for passing to decode_utf8 and vice versa?
</div>
No, encode_utf8&#40;&#41; returns a octet string in UTF-8 encoding form and decode_utf8&#40;&#41; decodes a octet string in UTF-8 encoding form.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Now I can&#39;t imagine how to use these wrong &#34;octets&#34; &#40;i.e. octets which
&gt; are returned by encode_utf8&#41; for another purpose. Could you please
&gt; give
&gt; some examples if I am wrong.
</div>
while &#40;&lt;STDIN&gt;&#41; {
    $string = Encode::decode_utf8&#40;$_&#41;; # input
    $string = lc $string; # process
    print Encode::encode_utf8&#40;$string&#41;; # output
}

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 
<div class="message-stanza open">&gt; &gt; CAVEAT: When you run $octets = encode&#40;&#34;utf8&#34;, $string&#41; ,
&gt; &gt; then $octets may not be equal to $string. Though they both
&gt; &gt; contain the same data, the UTF8 flag for $octets is always off.
</div>&gt; 
&gt; These words looks like a misprint because:
&gt; 
&gt; 
<div class="message-stanza open">&gt; &gt; $octets may not be equal to $string
</div>&gt; 
&gt; 1&#41; any utf8 string with non English characters after conversion to
&gt; $octets will be ALWAYS not equal to $string &#40;see my examples&#41;
</div>
Correct.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Though they both contain the same data
</div>&gt; 
&gt; 2&#41; if $string has the non English characters then $string and $octets
&gt; will NOT contain the same data IN ANY CASE &#40;because utf8 flag is not
&gt; set&#41;
</div>
perhaps s/contain/represent/ would make it clearer, but I think it should be removed from documentation.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Am I wrong?
</div>
No.

--
chansen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;24&nbsp;18:12:31&nbsp;2011</span>
    <span class="description">marbuga [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> marbuga [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dear Chansen


First of all I&#39;d like to thank you for patience.



Second ...

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I.e. encode_utf8 makes the unexpected action: it converts already
&gt; &gt; present octets to another &#34;strange&#34; octets. Is this correct?
</div>&gt; 
&gt; Yes it&#39;s correct. In my previous reply I mentioned that Perl has two
&gt; different internal representations for strings. SvUTF8 indicates which
&gt; one is used, if it&#39;s off ISO-8859-1 &#40;aka Latin1&#41; is assumed.
</div>
Thank you. I tried to explain this in one of my previous messages. But
as I see my try has been unsuccessful in cause of my low explanation skills.



<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; $a = &#34;äöüéà&#34;;
&gt; $o = Encode::encode_utf8&#40;$a&#41;;
&gt; 
&gt; in this case it&#39;s equivalent to:
&gt; 
&gt; $o = Encode::encode_utf8&#40;Encode::decode&#40;&#39;ISO-8859-1&#39;, $a&#41;&#41;;
</div>
I tried to explain that ISO-8859-1 should not be used here because the
source code uses UTF8 charset. I.e. it&#39;s the root of the issue: Encode
module assumes that ISO-8859-1 is a default charset but it&#39;s not
correct... IMHO

I tried to explain this but there was no success.



In other words this root of the issue causes the following errors: some
developers users this default &#39;ISO-8859-1&#39; charset for double conversion
in SOAP requests.

I understand that it&#39;s not a question to your module, but your module
allows this because it assumes &#39;ISO-8859-1&#39; charset as default.



Could you please explain why ISO-8859-1 is used when it has no relation
to any object or setting or etc?

Surely I do not expect the explanation of perl&#39;s internals. I just main
the main purpose of Encode module.

Should Encode module just convert data between charsets or should it
ignore the utf8 flag and assume that string&#39;s charset is &#39;ISO-8859-1&#39;
when the string&#39;s charset is &#39;utf8&#39;?



I just mean that UTF-8 charset of sourse code should assume that

$a = &#34;äöüéà&#34;;
$o = Encode::encode_utf8&#40;$a&#41;;

code should return $o = $a = &#34;äöüéà&#34;;

when source code&#39;s charset is UTF-8.

I.e. could you please explain the relation of &#39;ISO-8859-1&#39; charset to
this &#39;encoding&#39;?



I hope that I have shown the main idea of my previous messages.

If not - please close this ticket.

I don&#39;t what to irritate you by my bad English and my bad explanation
skills.



Thank you. And good luck.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;24&nbsp;19:49:32&nbsp;2011</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Dec 24 18:12:31 2011, marbug wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dear Chansen
&gt; 
&gt; 
&gt; First of all I&#39;d like to thank you for patience.
&gt; 
&gt; 
&gt; 
&gt; Second ...
&gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; I.e. encode_utf8 makes the unexpected action: it converts already
&gt; &gt; &gt; present octets to another &#34;strange&#34; octets. Is this correct?
</div>&gt; &gt; 
&gt; &gt; Yes it&#39;s correct. In my previous reply I mentioned that Perl has two
&gt; &gt; different internal representations for strings. SvUTF8 indicates which
&gt; &gt; one is used, if it&#39;s off ISO-8859-1 &#40;aka Latin1&#41; is assumed.
</div>&gt; 
&gt; Thank you. I tried to explain this in one of my previous messages. But
&gt; as I see my try has been unsuccessful in cause of my low explanation skills.
&gt; 
&gt; 
&gt; 
<div class="message-stanza open">&gt; &gt; $a = &#34;äöüéà&#34;;
&gt; &gt; $o = Encode::encode_utf8&#40;$a&#41;;
&gt; &gt; 
&gt; &gt; in this case it&#39;s equivalent to:
&gt; &gt; 
&gt; &gt; $o = Encode::encode_utf8&#40;Encode::decode&#40;&#39;ISO-8859-1&#39;, $a&#41;&#41;;
</div>&gt; 
&gt; I tried to explain that ISO-8859-1 should not be used here because the
&gt; source code uses UTF8 charset. I.e. it&#39;s the root of the issue: Encode
&gt; module assumes that ISO-8859-1 is a default charset but it&#39;s not
&gt; correct... IMHO
&gt; 
&gt; I tried to explain this but there was no success.
&gt; 
&gt; 
&gt; 
&gt; In other words this root of the issue causes the following errors: some
&gt; developers users this default &#39;ISO-8859-1&#39; charset for double conversion
&gt; in SOAP requests.
&gt; 
&gt; I understand that it&#39;s not a question to your module, but your module
&gt; allows this because it assumes &#39;ISO-8859-1&#39; charset as default.
&gt; 
&gt; 
&gt; 
&gt; Could you please explain why ISO-8859-1 is used when it has no relation
&gt; to any object or setting or etc?
&gt; 
&gt; Surely I do not expect the explanation of perl&#39;s internals. I just main
&gt; the main purpose of Encode module.
&gt; 
&gt; Should Encode module just convert data between charsets or should it
&gt; ignore the utf8 flag and assume that string&#39;s charset is &#39;ISO-8859-1&#39;
&gt; when the string&#39;s charset is &#39;utf8&#39;?
</div>
The encode_utf8 and decode_utf8 functions don’t convert between octet encodings.  They 
convert between raw utf8 byte sequences and Unicode strings.

By raw utf8 byte sequences, I mean that, if $a contains ā, length&#40;$a&#41; will give 2, and ord&#40;$a&#41; 
will give 0xc4, because $a contains two octets &#40;i.e., &#34;\xc4\x81&#34;&#41; to represent that Unicode 
character.

By Unicode strings, I mean that length&#40;$a&#41; will give 1 and ord&#40;$a&#41; will return 257, because 
that character is one logical unit in the string.

encode_utf8 converts from the latter format to the former.  So if you feed it &#34;\xc4\x81&#34;, it 
can only assume you mean the Unicode characters U+00C4 and U+0081.  So it produces 
‘double’ encoding.

encode_utf8 appears to be assuming ISO-8859-1, only as a side effect of the first 256 
Unicode characters being identical to ISO-8859-1.

So using encode_utf8 on a string that is already in an octet encoding &#40;i.e., a sequence of 
octets&#41; is almost always wrong.

A couple of examples &#40;assume these scripts are in utf8&#41;:

#!perl
use Encode;
$x = &#39;ā&#39;; # equivalent to &#34;\xc4\x81&#34;
# encode_utf8&#40;&#41; and encode&#40;&#41; *always* take Unicode
# arguments, so &#34;\xc4\x81&#34; is treated as U+00C4 U+0081.
$y = encode_utf8 $x; # wrong
# $y is now &#34;\xC3\x84\xC2\x81&#34;

&#40;I.e., $x is already encoded in utf8, so you don’t have to do anything to it.&#41;

#!perl
use Encode;
use utf8; # Now Perl decodes the script itself
$x = &#39;ā&#39;; # equivalent to &#34;\x{101}&#34;
$y = encode_utf8 $x; # treated as U+0101 
# $y is now &#34;\xc4\x81&#34;

Does that make things clear?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 
&gt; 
&gt; I just mean that UTF-8 charset of sourse code should assume that
&gt; 
&gt; $a = &#34;äöüéà&#34;;
&gt; $o = Encode::encode_utf8&#40;$a&#41;;
&gt; 
&gt; code should return $o = $a = &#34;äöüéà&#34;;
&gt; 
&gt; when source code&#39;s charset is UTF-8.
</div>
Did you ‘use utf8’?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
</div></div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
