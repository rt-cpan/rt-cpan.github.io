<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #122820 for File-Temp: Change in tempdir behavior requires change in documentation</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #122820 for File-Temp: Change in tempdir behavior requires change in documentation</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/File-Temp/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/File-Temp/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/File-Temp/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/File-Temp/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/File-Temp">File-Temp CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">122820</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/File-Temp/Active/">File-Temp</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jkeenan [...] pobox.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-13198-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-13199-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;16&nbsp;10:39:19&nbsp;2017</span>
    <span class="description">jkeenan [...] pobox.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Change in tempdir behavior requires change in documentation</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 16 Aug 2017 10:39:01 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-File-Temp [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> James E Keenan &lt;jkeenan [...] pobox.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Summary:  Because of a change in the behavior of File::Path::rmtree&#40;&#41; 
for security reasons, the behavior of File::Temp::tempdir&#40;&#41; has also 
changed.  This change of behavior should be documented and illustrated 
with tests.

A.  Why Is File::Temp Affected by a Security Vulnerability in File::Path?

File::Temp::tempdir&#40;&#41;&#39;s &#39;CLEANUP =&gt; 1&#39; option is implemented with 
internal calls to File::Path::rmtree&#40;&#41; 
&#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/DAGOLDEN/File-Temp-0.2304/lib/File/Temp.pm&#41;">https://metacpan.org/source/DAGOLDEN/File-Temp-0.2304/lib/File/Temp.pm&#41;</a></span>:

#####
eval { rmtree&#40;$dir, $DEBUG, 0&#41;; };
# line 784
eval { rmtree&#40;$self-&gt;{REALNAME}, $File::Temp::DEBUG, 0&#41;; };
# line 1616
#####

The Perl-false value in the third positional argument means, in effect, 
&#34;Do everything you can to remove all directories under the temporary 
directory, including directories on which you don&#39;t have normal 
permissions.&#34;  The &#34;everything you can&#34; includes a lot of filesystem 
checks and attempts to chmod directories with fairly exotic permissions 
such as 0000 and 0200 -- directories on which the user lacks both &#39;read&#39; 
and &#39;execute&#39; permissions.

This stands in contrast to a rmtree&#40;&#41; call with a Perl-true value in the 
third parameter:

#####
eval { rmtree&#40;$self-&gt;{REALNAME}, $File::Temp::DEBUG, 1&#41;; };
#####

In this case, rmtree&#40;&#41; is documented to &#34;skip the files for which the 
process lacks the required privileges needed to delete files ....  In 
other words, the code will make no attempt to alter file permissions.&#34; 
&#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/File::Path&#41;">https://metacpan.org/pod/File::Path&#41;</a></span>  In practice, this means that 
rmtree&#40;&#41; with a true value in the third parameter will not remove a 
directory unless its permissions are something like 0700.

Unfortunately, the hoops which rmtree&#40;&#41; must internally jump through to 
remove directories regardless of permissions require many filesystem 
checks which introduce the possibility of &#34;Time of Check to Time of Use&#34; 
&#40;TOCTTOU: <span class="clickylink"><a target="new" rel="nofollow" href="https://en.wikipedia.org/wiki/Time_of_check_to_time_of_use&#41;">https://en.wikipedia.org/wiki/Time_of_check_to_time_of_use&#41;</a></span> 
situations which, in turn, introduce security vulnerabilities due to 
race conditions.  These vulnerabilities are sufficiently serious that a 
CVE has been filed and the behavior of rmtree&#40;&#41; in File::Path versions 
2.14 and later has been changed 
&#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=121951&#41;">https://rt.cpan.org/Ticket/Display.html?id=121951&#41;</a></span>.  &#40;These changes 
have been merged into Perl 5 blead.&#41;

The practical impact of this change is that rmtree&#40;&#41; will no longer be 
able to directly remove directories on which the user lacks both &#39;read&#39; 
and &#39;execute&#39; permissions.  Any code, including File::Temp::tempdir&#40;&#41;, 
which uses rmtree&#40;&#41; for recursive removal of directories will be 
similarly affected.  Hence, the need to modify File::Temp::tempdir&#40;&#41;&#39;s 
documentation.

B. Example of Change in tempdir&#40;&#41;&#39;s Behavior and How to Address

An example of such code would be:

#####
     my $tdir = tempdir&#40;CLEANUP =&gt; 1&#41;;
     my $subdir = File::Spec-&gt;catdir&#40;$tdir, &#39;abc&#39;&#41;;
     mkdir $subdir;
     chmod 0000, $subdir;
     ... # do something with $subdir
     # CLEANUP triggered, making internal call to File::Path::rmtree&#40;&#41;
#####

Up through File::Path version 2.12 -- or up through perl-5.26.0 -- 
&#39;CLEANUP&#39; would remove $subdir even though the user no longer has any 
permissions on it.  Very convenient, but &#40;as discussed above&#41; performed 
via filesystem checks which open up security vulnerabilities.

 From File::Path version 2.14 forward -- or from perl 5.27.3 forward -- 
the rmtree&#40;&#41; call inside the &#39;CLEANUP&#39; option will no longer remove 
$subdir.  The user will get warnings like this:

#####
cannot chdir to child for /tmp/caIID_gLXE/abc: Permission denied at 
/home/jkeenan/testing/blead/lib/perl5/5.27.3/File/Temp.pm line 784.
cannot remove directory for /tmp/caIID_gLXE: Directory not empty at 
/home/jkeenan/testing/blead/lib/perl5/5.27.3/File/Temp.pm line 784.
#####

Manual inspection of /tmp shows that access was denied to the 
second-level temporary directory, preventing its removal and the removal 
of its parent directory.

#####
$ ls -ld /tmp/caIID_gLXE/
drwx------ 3 jkeenan jkeenan 4096 Aug 16 09:40 /tmp/caIID_gLXE/
$ ls -l /tmp/caIID_gLXE/
total 4
d--------- 2 jkeenan jkeenan 4096 Aug 16 09:40 abc
$ ls -l /tmp/caIID_gLXE/abc
ls: cannot open directory &#39;/tmp/caIID_gLXE/abc&#39;: Permission denied
#####

But the code sample can easily be modified to restore reasonable 
permissions before tempdir&#40;&#41; triggers cleanup.  Under File::Path 2.14 
&#40;and perl 5.27.3&#41; and later, we call:

#####
     my $tdir = tempdir&#40;CLEANUP =&gt; 1&#41;;
     my $subdir = File::Spec-&gt;catdir&#40;$tdir, &#39;abc&#39;&#41;;
     mkdir $subdir;
     chmod 0000, $subdir;
     ... # do something with $subdir
     chmod 0700, $subdir;
     # CLEANUP triggered, making internal call to File::Path::rmtree&#40;&#41;
#####

$subdir&#39;s permissions now permit File::Path::rmtree&#40;&#41; to remove it. 
This in turns permit&#39;s tempdir&#40;&#41;&#39;s &#39;CLEANUP&#39; option to remove it.  All 
the tempdirs are removed and the user is no longer presented with warnings.

&#40;See attachments &#39;tempdir-cleanup.pl&#39; and &#39;adjusted-tempdir-cleanup.pl&#39; 
for program exemplars.&#41;

C.  Scope of Impact

I anticipate that the maintainers and users of File::Temp will have 
concerns about this change in tempdir&#40;&#41;&#39;s behavior.  tempdir&#40;&#41; is 
undoubtedly used extensively in production code, but since we have no 
access to such code, we have to treat the entirety of Perl code on CPAN 
as a proxy.  Over the past several weeks, I conducted a two-stage study 
to address these concerns.

1.  I grepped CPAN for code which creates directories without both 
&#39;read&#39; and &#39;execute&#39; permissions or so modifies permissions.  That 
includes code like this:

#####
     mkdir $some_directory, 0000
     mkdir $some_directory, 0200
     mkdir $some_directory, 0
     chmod 0000, $some_directory, $some_other_directory
     chmod 0200, $some_directory, $some_other_directory
     chmod 0, $some_directory, $some_other_directory
     File::Path::mkpath&#40;&#39;foo/bar/baz&#39;, &#39;/zug/zwang&#39;, { verbose =&gt; 1, 
mode =&gt; 0000 }&#41;
     File::Path::mkpath&#40;&#39;/foo/bar/baz&#39;, 1, 0000&#41;
     File::Path::make_path&#40;&#39;foo/bar/baz&#39;, &#39;/zug/zwang&#39;, { mode =&gt; 0000 }
#####

While I make no claim that this search was exhaustive, I located enough 
examples to have confidence in my inferences. &#40;See 
<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/JKEENAN/Regexp-Functions-chmod_et_al-0.02/t/002-chmod-et-al.t">https://metacpan.org/source/JKEENAN/Regexp-Functions-chmod_et_al-0.02/t/002-chmod-et-al.t</a></span> 
for the full list of code strings searched for&#41;.

2.  I then grepped the files identified in step #1 for &#39;tempdir&#39; and 
&#39;newdir&#39;.  &#40;In File::Temp&#39;s object-oriented interface $t-&gt;newdir is 
equivalent to &#39;tempdir&#40;CLEANUP =&gt; 1&#41;&#39;.&#41;  I manually inspected those 
files for locations where the function calls discussed in step #1 fell 
within the scope of tempdir&#40;&#41;.  In all of CPAN I could locate only six 
files which needed patching.  I created and submitted patches or pull 
requests for all six.

#####
G/GR/GRAY|IO-AIO-Util-0.09.tar.gz|t/01_mkpath.t
M/MA/MANWAR|Filesys-DiskUsage-0.10.tar.gz|t/02.warnings.t
P/PE/PERLANCAR|File-MoreUtil-0.61.tar.gz|t/01-basics.t
P/PE/PETDANCE|ack-2.18.tar.gz|t/ack-s.t
S/SN/SNOWHARE|Tie-DB_File-SplitHash-1.05.tar.gz|t/01_Tie-DB_File-SplitHash.t
X/XA/XAN|Archive-Tar-Builder-2.5002.tar.gz|t/lib-Archive-Tar-Builder.t
#####

I am fairly confident that this substantially addresses the problem, as 
six is one more than the number of problematic files separately 
identified by experienced CPAN tester Slaven Rezic earlier this year 
&#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=122255#txn-1735608&#41;">https://rt.cpan.org/Ticket/Display.html?id=122255#txn-1735608&#41;</a></span>.

D. Next Steps

I can prepare a pull request for &#40;a&#41; changes in File::Path&#39;s 
documentation discussing this change in behavior; and &#40;b&#41; additional 
unit tests illustrating the change in behavior.  But I would like to get 
some feedback from File::Temp&#39;s maintainers first.

Thank you very much.
Jim Keenan
&#40;maintainer of File::Path&#41;
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
