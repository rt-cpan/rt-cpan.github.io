<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #74578 for Win32-API: Win32::API::Struct alignment wrong</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #74578 for Win32-API: Win32::API::Struct alignment wrong</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Win32-API">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Win32-API">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Win32-API">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Win32-API">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Win32-API">Win32-API CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">74578</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">1 hour (60 min)

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Win32-API">Win32-API</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">cosimo [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
DOUGW [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-35436-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.64    </td>
  </tr>
  <tr id="CF-35437-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




Struct.diff.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1033079/539056/Struct.diff.txt">
Sun Feb 05 14:10:04 2012 (2.6k) by DOUGW [...] cpan.org
</a>
</font></li>
</ul>


Struct.pm.diff.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1037189/541471/Struct.pm.diff.txt">
Mon Feb 13 15:32:15 2012 (2.4k) by DOUGW [...] cpan.org
</a>
</font></li>
</ul>


Struct_diff.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1032596/538812/Struct_diff.txt">
Fri Feb 03 19:09:56 2012 (2.7k) by DOUGW [...] cpan.org
</a>
</font></li>
</ul>


Win32-API-0.66.tar.gz<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1037263/541512/Win32-API-0.66.tar.gz">
Mon Feb 13 16:52:04 2012 (337.2k) by cosimo [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=74578">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1030949" href="/Public/Bug/Display.html?id=74578#txn-1030949">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;31&nbsp;18:22:54&nbsp;2012</span>
    <span class="description">DOUGW [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1030949/537765/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/537765">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
&lt;p&gt;
When using Win32::API::Struct on 64bit, I get extraneous &#34;x&#34; &#40;null
bytes&#41; in the pack/unpack templates.
When I do a straight unpack without the x&#39;s, I get the data correctly.
&lt;/p&gt;
&lt;p&gt;
Or if I remove the &#39;align&#39; logic in Win32::API::Struct::getPack&#40;&#41; and
getUnpack&#40;&#41;, I also get a correct result.
Is this a bug or is there something else I should be doing?
&lt;/p&gt;

&lt;pre&gt;
  $Win32::API::DEBUG = 1;

  Win32::API::Struct-&gt;typedef&#40;&#39;DLXSTRUCT&#39;, qw&#40;
    CHAR    VarName[12];
    LONG32  StartDate;
    LONG32  EndDate;
    INT32   NumberObs;
    INT32   Frequency;
    ULONG32 DateTimeMod;
    INT32   Magnitude;
    INT32   DecPrecision;
    INT32   DifType;
    INT32   AggType;
    CHAR  DataType[8];
    CHAR  Group[4];
    CHAR  Source[6];
    CHAR  Geography1[8];
    CHAR  Geography2[8];
    CHAR  Descriptor[82];
    CHAR  ShortSource[10];
    CHAR  LongSource[70];
  &#41;&#41; or die &#34;Err&#34;;

  # &#39;PPS&#39; when using the Struct above
  # &#39;PPP&#39; when using the buffer below
  my $GetInfo = Win32::API-&gt;new&#40;
  #  $dll, &#39;DLXGetInfo&#39;, &#39;PPP&#39;, &#39;I&#39;,
    $dll, &#39;DLXGetInfo&#39;, &#39;PPS&#39;, &#39;I&#39;,
  &#41; or die &#34;Err: $!&#34;;

  # When using &#39;PPP&#39; above
  #my $dlx = &#34; &#34; x 246;


  # Character fields missing first 3 characters, number fields are garbage
  my $info_result = $get_info-&gt;Call&#40;&#39;&#39;, $field, $dlx&#41;;
  # Debug output:
  # &#40;PM&#41;Struct::getPack: DLXSTRUCT&#40;buffer&#41; =
pack&#40;a12xlxxliiLiiiia8a4a6a8a8a82a10a71, 48&#41;
  # &#40;PM&#41;Struct::getUnpack&#40;DLXSTRUCT&#41;:
unpack&#40;Z12xlxxliiLiiiiZ8Z4Z6Z8Z8Z82Z10Z71, ...field names&#41;

  # For &#39;PPP&#39; call above
  # Everything ok
  #my &#40;$name, $start, $end, $n_obs, $freq, $dt_mod, $mag, $prec,
  #    $diftype, $agg_type, $data_type, $group, $source, $geo1, $geo2,
$desc, $short_source, $long_source&#41;
  # = unpack&#40;&#39;Z12 l l i i L i i i i Z8 Z4 Z6 Z8 Z8 Z82 Z10 Z70&#39;, $dlx&#41;;
&lt;/pre&gt;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1031018" href="/Public/Bug/Display.html?id=74578#txn-1031018">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;31&nbsp;20:09:47&nbsp;2012</span>
    <span class="description">DOUGW [...] cpan.org -  Subject changed from &#40;no value&#41; to &#39;Win32::API::Struct not aligned on 64 bit&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1031054" href="/Public/Bug/Display.html?id=74578#txn-1031054">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;02:15:26&nbsp;2012</span>
    <span class="description">cosimo [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1031054/537835/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/537835">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 203b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Doug, thanks for filing this.

Unfortunately, packing and unpacking of structs is buggy, especially in 
64 bits builds.

What do to about it?
Not sure, other than CC&#39;ing libwin32@perl.org as you did.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1031057" href="/Public/Bug/Display.html?id=74578#txn-1031057">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;02:15:27&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1031269" href="/Public/Bug/Display.html?id=74578#txn-1031269">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;11:27:36&nbsp;2012</span>
    <span class="description">DOUGW [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1031269/537998/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/537998">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Feb 01 02:15:26 2012, COSIMO wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Doug, thanks for filing this.
&gt; 
&gt; What do to about it?
&gt; Not sure, other than CC&#39;ing libwin32@perl.org as you did.
</div>
Cool, I didn&#39;t know RT cc&#39;d the mailing list &#40;maybe someone else will
know what to do&#41;. What I&#39;ve done is hack Struct.pm getPack&#40;&#41; and
getUnpack&#40;&#41;:

in getPack&#40;&#41;:
            $type_align = &#40;&#40;$packed_size + $type_size&#41; % $type_size&#41;;
#            $packing .= &#34;x&#34; x $type_align . $type;
            $packing .= $type;
            $packed_size += $type_size;
#            $packed_size += $type_size + $type_align;
        }

in getUnpack&#40;&#41;:
            $type_align = &#40;&#40;$packed_size + $type_size&#41; % $type_size&#41;;
#           $packing .= &#34;x&#34; x $type_align . $type;
            $packing .= $type;
#           $packed_size += $type_size + $type_align;
            $packed_size += $type_size;

            push&#40;@items, $name&#41;;
        }

Perhaps if this change were wrapped in is_64bit&#40;&#41; type logic, then it
would work everywhere? I don&#39;t know enough about this to really know for
sure, and I&#39;m not even sure if I haven&#39;t broken something else. And if
this change is headed in the right direction, there should probably be
some changes to the align&#40;&#41; and sizeof&#40;&#41; methods.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1031942" href="/Public/Bug/Display.html?id=74578#txn-1031942">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;02&nbsp;11:55:59&nbsp;2012</span>
    <span class="description">rurban [...] cpanel.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> libwin32 [...] perl.org, Douglas Wilson via RT &lt;bug-Win32-API [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #74578] Win32::API::Struct not aligned on 64 bit </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 2 Feb 2012 08:26:55 -0600</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Cosimo Streppone &lt;cosimo [...] streppone.it&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Reini Urban &lt;rurban [...] cpanel.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1031942/538416/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/538416">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am 01.02.2012 um 11:00 schrieb Cosimo Streppone:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This is RT#74578 about Win32::API structs packing/unpacking.
&gt; Can you help us?
&gt; 
&gt; ------- Forwarded message -------
&gt; From: &#34;Douglas Wilson via RT&#34; &lt;bug-Win32-API@rt.cpan.org&gt;
&gt; Subject: [rt.cpan.org #74578] Win32::API::Struct not aligned on 64 bit
&gt; Date: Wed, 01 Feb 2012 17:27:37 +0100
&gt; 
&gt;        Queue: Win32-API
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=74578">https://rt.cpan.org/Ticket/Display.html?id=74578</a></span> &gt;
&gt; 
&gt; On Wed Feb 01 02:15:26 2012, COSIMO wrote:
<div class="message-stanza open">&gt;&gt; Hi Doug, thanks for filing this.
&gt;&gt; 
&gt;&gt; What do to about it?
&gt;&gt; Not sure, other than CC&#39;ing libwin32@perl.org as you did.
</div>&gt; 
&gt; Cool, I didn&#39;t know RT cc&#39;d the mailing list &#40;maybe someone else will
&gt; know what to do&#41;. What I&#39;ve done is hack Struct.pm getPack&#40;&#41; and
&gt; getUnpack&#40;&#41;:
&gt; 
&gt; in getPack&#40;&#41;:
&gt;             $type_align = &#40;&#40;$packed_size + $type_size&#41; % $type_size&#41;;
&gt; #            $packing .= &#34;x&#34; x $type_align . $type;
&gt;             $packing .= $type;
&gt;             $packed_size += $type_size;
&gt; #            $packed_size += $type_size + $type_align;
&gt;         }
&gt; 
&gt; in getUnpack&#40;&#41;:
&gt;           $type_align = &#40;&#40;$packed_size + $type_size&#41; % $type_size&#41;;
&gt; #         $packing .= &#34;x&#34; x $type_align . $type;
&gt;           $packing .= $type;
&gt; #         $packed_size += $type_size + $type_align;
&gt;           $packed_size += $type_size;
&gt; 
&gt;             push&#40;@items, $name&#41;;
&gt;         }
&gt; 
</div>

I&#39;m pretty sure deleting type_align on 64bit is wrong. There must be an error in the 
size calculation for 8 byte sizes, which will result in the needed type_align=0.

I have got no win64 bit vm &#40;yet&#41;, but I will try to study it today.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Perhaps if this change were wrapped in is_64bit&#40;&#41; type logic, then it
&gt; would work everywhere? I don&#39;t know enough about this to really know for
&gt; sure, and I&#39;m not even sure if I haven&#39;t broken something else. And if
&gt; this change is headed in the right direction, there should probably be
&gt; some changes to the align&#40;&#41; and sizeof&#40;&#41; methods.
</div>

Reini
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1032585" href="/Public/Bug/Display.html?id=74578#txn-1032585">#</a>      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;03&nbsp;18:35:45&nbsp;2012</span>
    <span class="description">DOUGW [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1032585/538801/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/538801">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 507b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">FYI, I just realized that while I&#39;m using a 64-bit machine, the perl I
was using is a 32-bit perl. Under a 64-bit perl, the dll I&#39;m trying to
use gives &#34;%1 is not a valid Win32 Application&#34;.

That said, Win32::API::getPack&#40;&#41; and the calls to it are wrong. It
returns a scalar, array, scalar, but in the calls to it, the last scalar
will be slurped into the array. Easiest thing to do is probably
rearrange the return values and return both scalars before the array,
and adjust all the calls to the function.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1032588" href="/Public/Bug/Display.html?id=74578#txn-1032588">#</a>      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;03&nbsp;18:36:54&nbsp;2012</span>
    <span class="description">DOUGW [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1032588/538804/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/538804">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 177b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Feb 03 18:35:45 2012, DOUGW wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; That said, Win32::API::getPack&#40;&#41; and the calls to it are wrong. It
</div>
I mean Win32::API::Struct::getUnpack. Sorry for the confusion.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1032596" href="/Public/Bug/Display.html?id=74578#txn-1032596">#</a>      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;03&nbsp;19:09:56&nbsp;2012</span>
    <span class="description">DOUGW [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1032596/538811/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/538811">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 657b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Feb 03 18:36:54 2012, DOUGW wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Feb 03 18:35:45 2012, DOUGW wrote:
<div class="message-stanza open">&gt; &gt; 
&gt; &gt; That said, Win32::API::getPack&#40;&#41; and the calls to it are wrong. It
</div>&gt; 
&gt; I mean Win32::API::Struct::getUnpack. Sorry for the confusion.
</div>
I have a patch for this pack/unpack issue &#40;the align is still off&#41;. I&#39;m
using the struct as the basis for the unpack via getUnpack&#40;&#41; to get the
size and unpack template. Unfortunately, I&#39;ve switched from AS perl to
Strawberry, and upgraded to 5.14. Now the program works ok, but I get
&#34;Free to wrong pool&#34; when the program exits. I&#39;ll try re-installing
Win32::API.

Or I&#39;m going to see what happens when I use AS perl again.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Struct_diff.txt</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1032596/538812/Struct_diff.txt">Download Struct_diff.txt</a><br />
<span class="downloadcontenttype">text/plain 2.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Struct_orig.pm	2012-02-03 15:39:35 -0800
+++ Struct.pm	2012-02-03 15:52:38 -0800
@@ -200,9 +200,10 @@
             $packing .= $subpacking;
             $packed_size += $subpacksize;
         } else {
+            my $repeat = 1;
             if&#40;$type =~ /\w\*&#40;\d+&#41;/&#41; {
-                my $size = $1;
-                $type = &#34;a$size&#34;;
+                $repeat = $1;
+                $type = &#34;a$repeat&#34;;
             }
             
             DEBUG &#34;&#40;PM&#41;Struct::getPack&#40;$self-&gt;{__typedef__}&#41; ++ $type\n&#34;; 
@@ -215,9 +216,9 @@
             }
             push&#40;@recipients, $self&#41;;
             $type_size = Win32::API::Type::sizeof&#40;$orig&#41;;
-            $type_align = &#40;&#40;$packed_size + $type_size&#41; % $type_size&#41;;
+            $type_align = &#40;&#40;$packed_size + &#40;$type_size*$repeat&#41;&#41; % $type_size&#41;;
             $packing .= &#34;x&#34; x $type_align . $type;
-            $packed_size += $type_size + $type_align;
+            $packed_size += &#40;$type_size*$repeat&#41; + $type_align;
         }
     }
 
@@ -253,32 +254,33 @@
     foreach my $member &#40;@{ $self-&gt;{typedef} }&#41; {
         &#40;$name, $type, $orig&#41; = @$member;
         if&#40;$type eq &#39;&gt;&#39;&#41; {
-            my&#40;$subpacking, @subitems, $subpacksize&#41; = $self-&gt;{$name}-&gt;getUnpack&#40;&#41;;            
+            my&#40;$subpacking, $subpacksize, @subitems&#41; = $self-&gt;{$name}-&gt;getUnpack&#40;&#41;;            
             DEBUG &#34;&#40;PM&#41;Struct::getUnpack&#40;$self-&gt;{__typedef__}&#41; ++ $subpacking\n&#34;;
             $packing .= $subpacking;
             $packed_size += $subpacksize;	    
             push&#40;@items, @subitems&#41;;
         } else {
+            my $repeat = 1;
             if&#40;$type =~ /\w\*&#40;\d+&#41;/&#41; {
-                my $size = $1;
-                $type = &#34;Z$size&#34;;
+                my $repeat = $1;
+                $type = &#34;Z$repeat&#34;;
             }          
 	    DEBUG &#34;&#40;PM&#41;Struct::getUnpack&#40;$self-&gt;{__typedef__}&#41; ++ $type\n&#34;;
 	    $type_size = Win32::API::Type::sizeof&#40;$orig&#41;;
-	    $type_align = &#40;&#40;$packed_size + $type_size&#41; % $type_size&#41;;
+	    $type_align = &#40;&#40;$packed_size + &#40; $type_size * $repeat &#41;&#41; % $type_size&#41;;
 	    $packing .= &#34;x&#34; x $type_align . $type;
-	    $packed_size += $type_size + $type_align;
+	    $packed_size += &#40; $type_size * $repeat &#41; + $type_align;
 
             push&#40;@items, $name&#41;;
         }
     }
     DEBUG &#34;&#40;PM&#41;Struct::getUnpack&#40;$self-&gt;{__typedef__}&#41;: unpack&#40;$packing, @items&#41;\n&#34;;
-    return&#40;$packing, @items, $packed_size&#41;;
+    return&#40;$packing, $packed_size, @items&#41;;
 }
 
 sub Unpack {
     my $self = shift;
-    my&#40;$packing, @items&#41; = $self-&gt;getUnpack&#40;&#41;;
+    my&#40;$packing, undef, @items&#41; = $self-&gt;getUnpack&#40;&#41;;
     my @itemvalue = unpack&#40;$packing, $self-&gt;{buffer}&#41;;
     DEBUG &#34;&#40;PM&#41;Struct::Unpack: unpack&#40;$packing, buffer&#41; = @itemvalue\n&#34;;
     foreach my $i &#40;0..$#items&#41; {
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1032616" href="/Public/Bug/Display.html?id=74578#txn-1032616">#</a>      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;03&nbsp;19:36:37&nbsp;2012</span>
    <span class="description">DOUGW [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1032616/538827/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/538827">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 495b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Feb 03 19:09:56 2012, DOUGW wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Feb 03 18:36:54 2012, DOUGW wrote:
<div class="message-stanza open">&gt; &gt; On Fri Feb 03 18:35:45 2012, DOUGW wrote:
<div class="message-stanza open">&gt; &gt; &gt; 
&gt; &gt; &gt; That said, Win32::API::getPack&#40;&#41; and the calls to it are wrong. It
</div>&gt; &gt; 
&gt; &gt; I mean Win32::API::Struct::getUnpack. Sorry for the confusion.
</div>&gt; 
&gt; I have a patch for this pack/unpack issue &#40;the align is still off&#41;. 
</div>
Grr, the second &#34;my $repeat&#34; in the patch should just be &#34;$repeat&#34;. No
more free to wrong pool error. Still have same old align problem.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1032619" href="/Public/Bug/Display.html?id=74578#txn-1032619">#</a>      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;03&nbsp;20:51:26&nbsp;2012</span>
    <span class="description">rurban [...] x-ray.at -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> libwin32 [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #74578] Win32::API::Struct not aligned on 64 bit</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 3 Feb 2012 19:51:15 -0600</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Win32-API [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Reini Urban &lt;rurban [...] x-ray.at&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1032619/538830/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/538830">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Patch looks good. Aldo wanted to have that repeat bit fixed for a long time.
Thanks.

Now if you can repro the w64 align problem and send the output with
debugging info, please?

On Fri, Feb 3, 2012 at 6:36 PM, Douglas Wilson via RT
&lt;bug-Win32-API@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Fri Feb 03 19:36:37 2012: Request 74578 was acted upon.
&gt; Transaction: Correspondence added by DOUGW
&gt;       Queue: Win32-API
&gt;     Subject: Win32::API::Struct not aligned on 64 bit
&gt;   Broken in: 0.64
&gt;    Severity: Normal
&gt;       Owner: Nobody
&gt;  Requestors: DOUGW@cpan.org
&gt;      Status: open
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=74578">https://rt.cpan.org/Ticket/Display.html?id=74578</a></span> &gt;
&gt;
&gt;
&gt; On Fri Feb 03 19:09:56 2012, DOUGW wrote:
<div class="message-stanza open">&gt;&gt; On Fri Feb 03 18:36:54 2012, DOUGW wrote:
<div class="message-stanza open">&gt;&gt; &gt; On Fri Feb 03 18:35:45 2012, DOUGW wrote:
<div class="message-stanza open">&gt;&gt; &gt; &gt;
&gt;&gt; &gt; &gt; That said, Win32::API::getPack&#40;&#41; and the calls to it are wrong. It
</div>&gt;&gt; &gt;
&gt;&gt; &gt; I mean Win32::API::Struct::getUnpack. Sorry for the confusion.
</div>&gt;&gt;
&gt;&gt; I have a patch for this pack/unpack issue &#40;the align is still off&#41;.
</div>&gt;
&gt; Grr, the second &#34;my $repeat&#34; in the patch should just be &#34;$repeat&#34;. No
&gt; more free to wrong pool error. Still have same old align problem.
</div>


-- 
Reini Urban
<span class="clickylink"><a target="new" rel="nofollow" href="http://cpanel.net/">http://cpanel.net/</a></span>   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perl-compiler.org/">http://www.perl-compiler.org/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1033078" href="/Public/Bug/Display.html?id=74578#txn-1033078">#</a>      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;05&nbsp;13:59:35&nbsp;2012</span>
    <span class="description">DOUGW [...] cpan.org -  Subject changed from &#39;Win32::API::Struct not aligned on 64 bit&#39; to &#39;Win32::API::Struct alignment wrong&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1033079" href="/Public/Bug/Display.html?id=74578#txn-1033079">#</a>      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;05&nbsp;14:10:04&nbsp;2012</span>
    <span class="description">DOUGW [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1033079/539055/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/539055">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 927b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Feb 03 20:51:26 2012, rurban@x-ray.at wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Patch looks good. Aldo wanted to have that repeat bit fixed for a long
</div>time.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks.
&gt; 
&gt; Now if you can repro the w64 align problem and send the output with
&gt; debugging info, please?
</div>
Like I said before, I don&#39;t think 64-bit had anything to do with this
bug, as I was using a 32-bit perl and dll. I&#39;ve been reading up on Win32
alignment and finally completely understand what needs to be done. My
test structure was suppose to start off with a char[10] and I thought it
was just a typo in the docs...now I see that it should have &#34;xx&#34; after
it in the pack/unpack. Attached is an updated patch, which correctly
fixes the repeat logic, and also I believe fixes the alignment of the
elements in the Struct &#40;on closer look, the repeat logic is why the
alignments were wrong&#41;. It looks good just from calling getPack and
getUnpack. I&#39;ll test it with the actual dll on Monday.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Struct.diff.txt</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1033079/539056/Struct.diff.txt">Download Struct.diff.txt</a><br />
<span class="downloadcontenttype">text/plain 2.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Struct.pm	2012-02-03 15:39:35 -0800
+++ Struct.pm	2012-02-03 15:52:38 -0800
@@ -200,9 +200,10 @@
             $packing .= $subpacking;
             $packed_size += $subpacksize;
         } else {
+            my $repeat = 1;
             if&#40;$type =~ /\w\*&#40;\d+&#41;/&#41; {
-                my $size = $1;
-                $type = &#34;a$size&#34;;
+                $repeat = $1;
+                $type = &#34;a$repeat&#34;;
             }
             
             DEBUG &#34;&#40;PM&#41;Struct::getPack&#40;$self-&gt;{__typedef__}&#41; ++ $type\n&#34;; 
@@ -215,9 +216,9 @@
             }
             push&#40;@recipients, $self&#41;;
             $type_size = Win32::API::Type::sizeof&#40;$orig&#41;;
-            $type_align = &#40;&#40;$packed_size + $type_size&#41; % $type_size&#41;;
+            $type_align = &#40;&#40;$packed_size + $type_size&#41; % $type_size&#41;;
             $packing .= &#34;x&#34; x $type_align . $type;
-            $packed_size += $type_size + $type_align;
+            $packed_size += &#40;$type_size*$repeat&#41; + $type_align;
         }
     }
 
@@ -253,32 +254,33 @@
     foreach my $member &#40;@{ $self-&gt;{typedef} }&#41; {
         &#40;$name, $type, $orig&#41; = @$member;
         if&#40;$type eq &#39;&gt;&#39;&#41; {
-            my&#40;$subpacking, @subitems, $subpacksize&#41; = $self-&gt;{$name}-&gt;getUnpack&#40;&#41;;            
+            my&#40;$subpacking, $subpacksize, @subitems&#41; = $self-&gt;{$name}-&gt;getUnpack&#40;&#41;;            
             DEBUG &#34;&#40;PM&#41;Struct::getUnpack&#40;$self-&gt;{__typedef__}&#41; ++ $subpacking\n&#34;;
             $packing .= $subpacking;
             $packed_size += $subpacksize;	    
             push&#40;@items, @subitems&#41;;
         } else {
+            my $repeat = 1;
             if&#40;$type =~ /\w\*&#40;\d+&#41;/&#41; {
-                my $size = $1;
-                $type = &#34;Z$size&#34;;
+                $repeat = $1;
+                $type = &#34;Z$repeat&#34;;
             }          
 	    DEBUG &#34;&#40;PM&#41;Struct::getUnpack&#40;$self-&gt;{__typedef__}&#41; ++ $type\n&#34;;
 	    $type_size = Win32::API::Type::sizeof&#40;$orig&#41;;
-	    $type_align = &#40;&#40;$packed_size + $type_size&#41; % $type_size&#41;;
+	    $type_align = &#40;&#40;$packed_size + $type_size&#41; % $type_size&#41;;
 	    $packing .= &#34;x&#34; x $type_align . $type;
-	    $packed_size += $type_size + $type_align;
+	    $packed_size += &#40; $type_size * $repeat &#41; + $type_align;
 
             push&#40;@items, $name&#41;;
         }
     }
     DEBUG &#34;&#40;PM&#41;Struct::getUnpack&#40;$self-&gt;{__typedef__}&#41;: unpack&#40;$packing, @items&#41;\n&#34;;
-    return&#40;$packing, @items, $packed_size&#41;;
+    return&#40;$packing, $packed_size, @items&#41;;
 }
 
 sub Unpack {
     my $self = shift;
-    my&#40;$packing, @items&#41; = $self-&gt;getUnpack&#40;&#41;;
+    my&#40;$packing, undef, @items&#41; = $self-&gt;getUnpack&#40;&#41;;
     my @itemvalue = unpack&#40;$packing, $self-&gt;{buffer}&#41;;
     DEBUG &#34;&#40;PM&#41;Struct::Unpack: unpack&#40;$packing, buffer&#41; = @itemvalue\n&#34;;
     foreach my $i &#40;0..$#items&#41; {
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1033461" href="/Public/Bug/Display.html?id=74578#txn-1033461">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;06&nbsp;11:34:46&nbsp;2012</span>
    <span class="description">DOUGW [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1033461/539263/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/539263">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 354b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Feb 05 14:10:04 2012, DOUGW wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; alignments were wrong&#41;. It looks good just from calling getPack and
&gt; getUnpack. I&#39;ll test it with the actual dll on Monday.
</div>
Tested and works fine. Sorry for the w64 red herring. I think I assumed
it must have been a w64 issue because code that had been around this
long couldn&#39;t have these sort of bugs :-&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1033478" href="/Public/Bug/Display.html?id=74578#txn-1033478">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;06&nbsp;12:14:07&nbsp;2012</span>
    <span class="description">DOUGW [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1033478/539273/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/539273">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 493b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Feb 06 11:34:46 2012, DOUGW wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sun Feb 05 14:10:04 2012, DOUGW wrote:
&gt; 
&gt; Tested and works fine. Sorry for the w64 red herring. I think I assumed
&gt; it must have been a w64 issue because code that had been around this
&gt; long couldn&#39;t have these sort of bugs :-&#41;
</div>
Also, it would be nice if all of the .pm files were run through perltidy
&#40;preferably in a release with no other changes&#41;. Mixing tabs and spaces
in the same line of indentation was really throwing me off at times.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1035355" href="/Public/Bug/Display.html?id=74578#txn-1035355">#</a>      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;10&nbsp;06:43:35&nbsp;2012</span>
    <span class="description">cosimo [...] streppone.it -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #74578] Win32::API::Struct alignment wrong </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 10 Feb 2012 12:42:41 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Win32-API [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Cosimo Streppone&#34; &lt;cosimo [...] streppone.it&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1035355/540442/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/540442">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun, 05 Feb 2012 20:10:05 +0100, Douglas Wilson via RT  
&lt;bug-Win32-API@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Feb 03 20:51:26 2012, rurban@x-ray.at wrote:
<div class="message-stanza open">&gt;&gt; Patch looks good. Aldo wanted to have that repeat bit fixed for a long
&gt;&gt; time. Thanks.
&gt;&gt;
&gt;&gt; Now if you can repro the w64 align problem and send the output with
&gt;&gt; debugging info, please?
</div>&gt;
&gt; Like I said before, I don&#39;t think 64-bit had anything to do with this
&gt; bug, as I was using a 32-bit perl and dll. I&#39;ve been reading up on Win32
&gt; alignment and finally completely understand what needs to be done. My
&gt; test structure was suppose to start off with a char[10] and I thought it
&gt; was just a typo in the docs...now I see that it should have &#34;xx&#34; after
&gt; it in the pack/unpack. Attached is an updated patch, which correctly
&gt; fixes the repeat logic, and also I believe fixes the alignment of the
&gt; elements in the Struct &#40;on closer look, the repeat logic is why the
&gt; alignments were wrong&#41;. It looks good just from calling getPack and
&gt; getUnpack. I&#39;ll test it with the actual dll on Monday.
</div>
Thanks everyone involved, Douglas and Reini.

I&#39;m going to release this patch to CPAN
during the weekend.

-- 
Cosimo
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1037189" href="/Public/Bug/Display.html?id=74578#txn-1037189">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;13&nbsp;15:32:14&nbsp;2012</span>
    <span class="description">DOUGW [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1037189/541470/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/541470">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 247b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Feb 10 06:43:35 2012, cosimo@streppone.it wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I&#39;m going to release this patch to CPAN
&gt; during the weekend.
&gt; 
</div>
I see you perltidy&#39;d everything. Here&#39;s a patch against version 0.65 in
case you want to just use the &#39;patch&#39; command.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Struct.pm.diff.txt</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1037189/541471/Struct.pm.diff.txt">Download Struct.pm.diff.txt</a><br />
<span class="downloadcontenttype">text/plain 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Struct.pm	Sun Feb 12 06:39:26 2012
+++ Struct.pm	Mon Feb 13 12:22:16 2012
@@ -212,9 +212,10 @@
             $packed_size += $subpacksize;
         }
         else {
+            my $repeat = 1;
             if &#40;$type =~ /\w\*&#40;\d+&#41;/&#41; {
-                my $size = $1;
-                $type = &#34;a$size&#34;;
+                $repeat = $1;
+                $type = &#34;a$repeat&#34;;
             }
 
             DEBUG &#34;&#40;PM&#41;Struct::getPack&#40;$self-&gt;{__typedef__}&#41; ++ $type\n&#34;;
@@ -230,7 +231,7 @@
             $type_size  = Win32::API::Type::sizeof&#40;$orig&#41;;
             $type_align = &#40;&#40;$packed_size + $type_size&#41; % $type_size&#41;;
             $packing .= &#34;x&#34; x $type_align . $type;
-            $packed_size += $type_size + $type_align;
+            $packed_size += &#40; $type_size * $repeat &#41; + $type_align;
         }
     }
 
@@ -267,7 +268,7 @@
     foreach my $member &#40;@{$self-&gt;{typedef}}&#41; {
         &#40;$name, $type, $orig&#41; = @$member;
         if &#40;$type eq &#39;&gt;&#39;&#41; {
-            my &#40;$subpacking, @subitems, $subpacksize&#41; = $self-&gt;{$name}-&gt;getUnpack&#40;&#41;;
+            my &#40;$subpacking, $subpacksize, @subitems&#41; = $self-&gt;{$name}-&gt;getUnpack&#40;&#41;;
             DEBUG &#34;&#40;PM&#41;Struct::getUnpack&#40;$self-&gt;{__typedef__}&#41; ++ $subpacking\n&#34;;
             $packing .= $subpacking;
             $packed_size += $subpacksize;
@@ -274,26 +275,27 @@
             push&#40;@items, @subitems&#41;;
         }
         else {
+            my $repeat = 1;
             if &#40;$type =~ /\w\*&#40;\d+&#41;/&#41; {
-                my $size = $1;
-                $type = &#34;Z$size&#34;;
+                $repeat = $1;
+                $type = &#34;Z$repeat&#34;;
             }
             DEBUG &#34;&#40;PM&#41;Struct::getUnpack&#40;$self-&gt;{__typedef__}&#41; ++ $type\n&#34;;
             $type_size  = Win32::API::Type::sizeof&#40;$orig&#41;;
             $type_align = &#40;&#40;$packed_size + $type_size&#41; % $type_size&#41;;
             $packing .= &#34;x&#34; x $type_align . $type;
-            $packed_size += $type_size + $type_align;
+            $packed_size += &#40; $type_size * $repeat &#41; + $type_align;
 
             push&#40;@items, $name&#41;;
         }
     }
     DEBUG &#34;&#40;PM&#41;Struct::getUnpack&#40;$self-&gt;{__typedef__}&#41;: unpack&#40;$packing, @items&#41;\n&#34;;
-    return &#40;$packing, @items, $packed_size&#41;;
+    return &#40;$packing, $packed_size, @items&#41;;
 }
 
 sub Unpack {
     my $self = shift;
-    my &#40;$packing, @items&#41; = $self-&gt;getUnpack&#40;&#41;;
+    my &#40;$packing, undef, @items&#41; = $self-&gt;getUnpack&#40;&#41;;
     my @itemvalue = unpack&#40;$packing, $self-&gt;{buffer}&#41;;
     DEBUG &#34;&#40;PM&#41;Struct::Unpack: unpack&#40;$packing, buffer&#41; = @itemvalue\n&#34;;
     foreach my $i &#40;0 .. $#items&#41; {
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1037263" href="/Public/Bug/Display.html?id=74578#txn-1037263">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;13&nbsp;16:52:04&nbsp;2012</span>
    <span class="description">cosimo [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">60 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> libwin32 [...] perl.org, cosimo [...] streppone.it, rurban [...] x-ray.at</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1037263/541511/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/541511">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 550b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks Douglas and Reini. I included Douglas fix on structs alignment in 
v0.66 and uploaded it right now to the CPAN, also pushed it to github 
&#40;github.com/cosimo/perl5-win32-api&#41;.

I&#39;m trying to get in touch with #msopensource again to get a Windows test 
machine. I&#39;m feel embarrassed in maintaining Win32::API without a test 
installation of Windows where to test code. I couldn&#39;t put together a 
test case for the new bug fix. I&#39;m trying to do something about it...

In the meantime, enjoy 0.66 on CPAN.
If there&#39;s problems, please let me know.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Win32-API-0.66.tar.gz</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1037263/541512/Win32-API-0.66.tar.gz">Download Win32-API-0.66.tar.gz</a><br />
<span class="downloadcontenttype">application/x-gzip 337.2k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1037268" href="/Public/Bug/Display.html?id=74578#txn-1037268">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;13&nbsp;16:52:06&nbsp;2012</span>
    <span class="description">cosimo [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1037270" href="/Public/Bug/Display.html?id=74578#txn-1037270">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;13&nbsp;16:52:06&nbsp;2012</span>
    <span class="description">cosimo [...] cpan.org -  Given to COSIMO</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.976252</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
