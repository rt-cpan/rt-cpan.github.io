<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #22036 for DBD-mysql: Multi-result set bugs</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #22036 for DBD-mysql: Multi-result set bugs</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-mysql/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-mysql/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-mysql/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-mysql/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-mysql">DBD-mysql CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">22036</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-mysql/Active/">DBD-mysql</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jeroen [...] transactgroup.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10170-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10171-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;11&nbsp;13:26:19&nbsp;2006</span>
    <span class="description">jeroen [...] transactgroup.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Multi-result set bugs</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 11 Oct 2006 18:40:59 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-mysql [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jeroen van den Oever &lt;jeroen [...] transactgroup.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I was trying to get multi-result sets working &#40;patched as of 3.0007_1&#41;,
and I noticed it won&#39;t work unless &#40;??&#41; you put the stored procedure
definition in front of your multi-result sets retrieval loop.

Let me demonstrate; run this first &#40;it will be successful, results as
you expect, multiple result sets&#41;:
--------snip
# Mostly cut &#38; paste from DBD::mysql 3.0007_1
use DBI;
use strict;
use warnings;
my $connect_string = &#39;DBI:mysql:database=AWSM;host=localhost;port=3306&#39;;
my $username = &#39;root&#39;;
my $password = &#39;password&#39;;
my $attributes = {};
my $dbh = DBI-&gt;connect&#40;$connect_string, $username,
                       $password, $attributes&#41; || die $DBI::errstr;

# Execute this AT LEAST once so the stored procedure someproc&#40;&#41; exists
# at least
$dbh-&gt;do&#40;&#34;drop procedure if exists someproc&#34;&#41; or print $DBI::errstr;

# Comment this out to reproduce the bug
$dbh-&gt;do&#40;&#34;create procedure someproc&#40;&#41; deterministic begin &#34;.
         &#34;declare a,b,c,d int; set a=1; set b=2; set c=3; set d=4; &#34;.
         &#34;select a, b, c, d; select d, c, b, a; select b, a, c, d; &#34;.
         &#34;select c, b, d, a; end&#34;&#41; or print $DBI::errstr;
my $sth=$dbh-&gt;prepare&#40;&#39;call someproc&#40;&#41;&#39;&#41; || die $DBI::errstr;
$sth-&gt;execute || die $DBI::errstr;
my $i = 0;
do {
   print &#34;\nRowset &#34;.++$i.&#34;\n---------------------------------------\n
\n&#34;;
   foreach my $colno &#40;0..$sth-&gt;{NUM_OF_FIELDS}&#41;
   {
      print $sth-&gt;{NAME}-&gt;[$colno].&#34;\t&#34; if
&#40;defined&#40;$sth-&gt;{NAME}-&gt;[$colno]&#41;&#41;;
   }
   print &#34;\n&#34;;
   while &#40;my @row= $sth-&gt;fetchrow_array&#40;&#41;&#41;
   {
      foreach my $field &#40;0..$#row&#41;
      {
         print $row[$field].&#34;\t&#34;;
      }
      print &#34;\n&#34;;
   }
} until &#40;!$sth-&gt;more_results&#40;&#41;&#41;;
--------snip

Now, if you run the same script with a few comments added &#40;commented out
the &#34;drop procedure&#34;&#41;, it will still work, albeit with a warning about
the stored procedure existing:

--------snip
# Mostly cut &#38; paste from DBD::mysql 3.0007_1
use DBI;
use strict;
use warnings;
my $connect_string = &#39;DBI:mysql:database=AWSM;host=localhost;port=3306&#39;;
my $username = &#39;root&#39;;
my $password = &#39;password&#39;;
my $attributes = {};
my $dbh = DBI-&gt;connect&#40;$connect_string, $username,
                       $password, $attributes&#41; || die $DBI::errstr;

# Execute this AT LEAST once so the stored procedure someproc&#40;&#41; exists
# at least
#$dbh-&gt;do&#40;&#34;drop procedure if exists someproc&#34;&#41; or print $DBI::errstr;

# Comment this out to reproduce the bug
$dbh-&gt;do&#40;&#34;create procedure someproc&#40;&#41; deterministic begin &#34;.
         &#34;declare a,b,c,d int; set a=1; set b=2; set c=3; set d=4; &#34;.
         &#34;select a, b, c, d; select d, c, b, a; select b, a, c, d; &#34;.
         &#34;select c, b, d, a; end&#34;&#41; or print $DBI::errstr;
my $sth=$dbh-&gt;prepare&#40;&#39;call someproc&#40;&#41;&#39;&#41; || die $DBI::errstr;
$sth-&gt;execute || die $DBI::errstr;
my $i = 0;
do {
   print &#34;\nRowset &#34;.++$i.&#34;\n---------------------------------------\n
\n&#34;;
   foreach my $colno &#40;0..$sth-&gt;{NUM_OF_FIELDS}&#41;
   {
      print $sth-&gt;{NAME}-&gt;[$colno].&#34;\t&#34; if
&#40;defined&#40;$sth-&gt;{NAME}-&gt;[$colno]&#41;&#41;;
   }
   print &#34;\n&#34;;
   while &#40;my @row= $sth-&gt;fetchrow_array&#40;&#41;&#41;
   {
      foreach my $field &#40;0..$#row&#41;
      {
         print $row[$field].&#34;\t&#34;;
      }
      print &#34;\n&#34;;
   }
} until &#40;!$sth-&gt;more_results&#40;&#41;&#41;;
--------snip

HOWEVER, you now comment out the &#34;create procedure&#34;, the whole thing
STOPS working:

--------snip
# Mostly cut &#38; paste from DBD::mysql 3.0007_1
use DBI;
use strict;
use warnings;
my $connect_string = &#39;DBI:mysql:database=AWSM;host=localhost;port=3306&#39;;
my $username = &#39;root&#39;;
my $password = &#39;password&#39;;
my $attributes = {};
my $dbh = DBI-&gt;connect&#40;$connect_string, $username,
                       $password, $attributes&#41; || die $DBI::errstr;

# Execute this AT LEAST once so the stored procedure someproc&#40;&#41; exists
# at least
#$dbh-&gt;do&#40;&#34;drop procedure if exists someproc&#34;&#41; or print $DBI::errstr;

# Comment this out to reproduce the bug
#$dbh-&gt;do&#40;&#34;create procedure someproc&#40;&#41; deterministic begin &#34;.
#         &#34;declare a,b,c,d int; set a=1; set b=2; set c=3; set d=4; &#34;.
#         &#34;select a, b, c, d; select d, c, b, a; select b, a, c, d; &#34;.
#         &#34;select c, b, d, a; end&#34;&#41; or print $DBI::errstr;
my $sth=$dbh-&gt;prepare&#40;&#39;call someproc&#40;&#41;&#39;&#41; || die $DBI::errstr;
$sth-&gt;execute || die $DBI::errstr;
my $i = 0;
do {
   print &#34;\nRowset &#34;.++$i.&#34;\n---------------------------------------\n
\n&#34;;
   foreach my $colno &#40;0..$sth-&gt;{NUM_OF_FIELDS}&#41;
   {
      print $sth-&gt;{NAME}-&gt;[$colno].&#34;\t&#34; if
&#40;defined&#40;$sth-&gt;{NAME}-&gt;[$colno]&#41;&#41;;
   }
   print &#34;\n&#34;;
   while &#40;my @row= $sth-&gt;fetchrow_array&#40;&#41;&#41;
   {
      foreach my $field &#40;0..$#row&#41;
      {
         print $row[$field].&#34;\t&#34;;
      }
      print &#34;\n&#34;;
   }
} until &#40;!$sth-&gt;more_results&#40;&#41;&#41;;
--------snip

Guess that&#39;s a bug. And explains why multi-result sets don&#39;t work in my
code.

Minor stuff about your example:

&#34;create procedure somproc&#34;
Missing &#39;e&#39;, should be &#34;someproc&#34;

&#34;...; $rowset=0;&#34;
Variable &#39;$rowset&#39; is used, but later you use &#39;$i&#39; which is not declared
&#40;I presume you mean ++$rowset later, not &#34;++$i&#34;&#41;

&#34;foreach $colno&#34;
fails with &#34;use strict&#34; &#40;should be &#34;foreach my $colno&#34;&#41;

&#34;while &#40;@row=...&#34;
fails with &#34;use strict&#34; &#40;should be &#34;while &#40;my @row=...&#34;&#41;

&#34;foreach $field&#34;
fails with &#34;use strict&#34; &#40;should be &#34;foreach my $field&#34;&#41;

&#34;print $sth-&gt;{NAME}-&gt;[$colno].&#34;\t&#34;&#34;
warns with &#34;use warnings&#34; &#40;append &#34; if
&#40;defined&#40;$sth-&gt;{NAME}-&gt;[$colno]&#41;&#41;;&#34;&#41;

My Environment:

Above is tested on:

Gentoo Linux 2.6.14 r5, SMP x86_64 Intel Xeon
Perl 5.8.8 x86_64 threaded
MySQL 5.0.18, DBD 3.0007_2

-- and --

SUSE Linux 9.0 2.6.13-15.8 SMP i686 Intel Pentium 4
Perl 5.8.7 i586 threaded
MySQL 5.0.24a, DBD 3.0007_2

both platforms produce the same results. Hope that helps

-- Jeroen van den Oever
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;03&nbsp;22:59:23&nbsp;2007</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This has been fixed in the latest release, 4.00. The big part of the
problem was not toggling to emulated prepared properly when using stored
procedures.

Prepared statements have been turned off by default in the latest
DBD::mysql, as other MySQL connectors have been done until issues in the
prepared statement API have been resolved. By using emulated mode, you
should not have any problems using stored procedures.

Thanks for the report!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;03&nbsp;22:59:24&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;03&nbsp;22:59:25&nbsp;2007</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
