<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #30329 for Games-WoW-Armory: Croak in search_character for low level characters</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #30329 for Games-WoW-Armory: Croak in search_character for low level characters</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Games-WoW-Armory/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Games-WoW-Armory/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Games-WoW-Armory/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Games-WoW-Armory/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Games-WoW-Armory">Games-WoW-Armory CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">30329</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Games-WoW-Armory/Active/">Games-WoW-Armory</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dekimsey [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-42836-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.0.7    </td>
  </tr>
  <tr id="CF-42837-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;28&nbsp;21:42:58&nbsp;2007</span>
    <span class="description">dekimsey [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Croak in search_character for low level characters</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">For reference the issue is with Kundari of Gorgonnash, L17 US server.

The API croaks during a -&gt;search_character&#40;&#41;.  Specifically, in the 
get_heroic_access subcall.
Line 482, &#39;Can&#39;t use string &#40;&#34;Alliance&#34;&#41; as a HASH ref while &#34;strict 
refs&#34; in use at cpan/lib/Games/WoW/Armory.pm line 482.&#39;

The module appears to be attempting to de-referencing the character-
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;reputation-&gt;{$rep}-&gt;{$fac}-&gt;{&#39;faction&#39;} when $rep is pointing to a 
</div>scalar, and not a hash-ref.  Examination of other successful searches, 
indicates the data structure isn&#39;t being built properly.

A working character&#39;s data structure is :
{
  reputation =&gt; {
    factionCategory =&gt; {
      &#34;$FactionGroupName1&#34; =&gt; { ... },
      &#34;$FactionGroupName2&#34; =&gt; { ... },
      etc.
    }
  },
}
The invalid case that I&#39;m running into looks more like:
{
  reputation =&gt; {
    factionCategory =&gt; {
      name =&gt; &#39;Alliance&#39;,
      faction =&gt; { ... },
      key =&gt; &#39;alliance&#39;,
    }
  },
}
Essentially, in the first &#40;working&#41; example, there is an Alliance 
faction *group* and it is properly formed in a sub-hash, in the non-
working case, this Alliance faction is at the root of the 
factionCategory hash structure.

The problem appears to be that the armory does not list the factions in 
groups if the player has yet to run into a faction that is not of their 
main group, ie Alliance/Horde.  This makes sense given that this 
character is only lvl 17 and hasn&#39;t battleground or performed any 
goblinesque quests.

A solution might be just to hack on a group name if there is no listed 
group name, as there should only be two cases, Alliance or Horde.

Dumper output of the entire WoW::Armory object just before the 
get_heroic_access&#40;&#41; call is attached.

Thanks for your time.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dumper_kudari_gorgonnash_us_20071028.txt</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;28&nbsp;22:26:45&nbsp;2007</span>
    <span class="description">dekimsey [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dekimsey [...] gmail.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">An attempt at a patch, appears to work.  But I&#39;m not certain if the 
logic is in the correct place, or if there are other possible ways for 
the same code to break.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Armory.pm.org	2007-10-28 22:06:38.395064500 -0400
+++ Armory.pm	2007-10-28 22:04:47.760150250 -0400
@@ -311,6 +311,21 @@
 
     my $reputation = $self-&gt;{ data }{ characterInfo }{ reputationTab };
 
+    # patch for rt#30329
+    my $workaround = $reputation-&gt;{ &#39;factionCategory&#39; };
+    if&#40; exists $workaround-&gt;{ &#39;name&#39; } &#41; {
+        # this is an invalid data structure.
+        delete $workaround-&gt;{&#39;name&#39;};
+        my $newhash = $workaround;
+        # lazy titlecasing of {&#39;key&#39;}
+        my $key = &#39;Alliance&#39;;
+        if &#40; $workaround-&gt;{&#39;key&#39;} eq &#39;horde&#39; &#41; {
+            $key = &#39;Horde&#39;;
+        }
+        $reputation-&gt;{&#39;factionCategory&#39;} = { $key =&gt; $newhash };
+    }
+    # /patch for rt#30329
+
     $self-&gt;character-&gt;reputation&#40; $reputation &#41;;
     $self-&gt;get_heroic_access;
 }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;28&nbsp;23:57:28&nbsp;2007</span>
    <span class="description">dekimsey [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dekimsey [...] gmail.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Errr... don&#39;t look at that previous patch... I ditzed out and 
completely forgot about ucfirst and wrote some pretty stupid code to 
deal with the fact.  sigh.


On Sun Oct 28 22:26:45 2007, dekimsey wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; An attempt at a patch, appears to work.  But I&#39;m not certain if the 
&gt; logic is in the correct place, or if there are other possible ways 
</div>for 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; the same code to break.
</div></div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Armory.pm.org	2007-10-28 22:06:38.395064500 -0400
+++ Armory.pm	2007-10-28 22:04:47.760150250 -0400
@@ -311,6 +311,21 @@
 
     my $reputation = $self-&gt;{ data }{ characterInfo }{ reputationTab };
 
+    # patch for rt#30329
+    my $workaround = $reputation-&gt;{ &#39;factionCategory&#39; };
+    if&#40; exists $workaround-&gt;{ &#39;name&#39; } &#41; {
+        # this is an invalid data structure.
+        delete $workaround-&gt;{&#39;name&#39;};
+        my $newhash = $workaround;
+        # lazy titlecasing of {&#39;key&#39;}
+        my $key = ucfirst $workaround-&gt;{&#39;key&#39;};
+        $reputation-&gt;{&#39;factionCategory&#39;} = { $key =&gt; $newhash };
+    }
+    # /patch for rt#30329
+
     $self-&gt;character-&gt;reputation&#40; $reputation &#41;;
     $self-&gt;get_heroic_access;
 }
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
