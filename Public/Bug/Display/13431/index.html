<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #13431 for Quota: rpc.quotad authorize patch</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #13431 for Quota: rpc.quotad authorize patch</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Quota/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Quota/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Quota/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Quota/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Quota">Quota CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">13431</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Quota/Active/">Quota</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ingwar [...] aster.pl

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-27492-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.5.0    </td>
  </tr>
  <tr id="CF-27493-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;27&nbsp;04:06:58&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rpc.quotad authorize patch</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I had i problem with Quota.pm because on FreeBSD &#40;and probably on Linux too&#41; rpc.rquotad checkd if authentification uid send by rpc is the same as uid of rpc.rquotad.
In our network quota deamons are owned by root &#40;probably as always&#41; but i dont want to run programs that check quota witch by root permissions.
So i wrote a little patch that allow setting of uid, gid and hostname thru  authunix_create function.

From user site new function is enabled

Quota::rpcauth&#40;uid=getuid&#40;&#41;,gid=getgid&#40;&#41;,hostname=NULL&#41;

If hostneme is NULL the gethostname is used to set hostname.

Patch was tested on Quota 1.5.0 on Perl 5.8.0 on FreeBSD 4.9 and on Perl 5.8.4  on Linux 2.6.11.8.

Best regards,
Karol Lassak 
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ur Quota-1.5.0/Quota.pm Quota-1.5.0+auth/Quota.pm
--- Quota-1.5.0/Quota.pm	Sun Nov 21 13:19:47 2004
+++ Quota-1.5.0+auth/Quota.pm	Mon May 30 15:48:33 2005
@@ -127,6 +127,8 @@
     Quota::rpcquery&#40;$host, $path [,$uid]&#41;;
 
     Quota::rpcpeer&#40;[$port [,$use_tcp [,timeout]]]&#41;;
+    
+    Quota::rpcauth&#40;[$uid [,$gid [,$hostname]]]&#41;;
 
     Quota::setqlim&#40;$dev, $uid, $block_soft, $block_hard,
 		   $inode_soft, $inode_hard [,$tlo [,isgrp]]&#41;;
@@ -244,6 +246,12 @@
 optional.  By default the portmapper on the remote host is used
 &#40;i.e. default port is 0, protocol is UDP&#41;  The default timeout is
 4 seconds.
+
+=item I&lt;Quota::rpcauth&#40;$uid,$gid,$hostname&#41;&gt;
+
+Configure authorization parameters for subsequent RPC queries; 
+all parameters are optional. By default uid and gid are taken from 
+owner of the process and hostname is the host name of current machine.
 
 =item I&lt;$arg = Quota::getqcarg&#40;$path&#41;&gt;
 
diff -ur Quota-1.5.0/Quota.xs Quota-1.5.0+auth/Quota.xs
--- Quota-1.5.0/Quota.xs	Sun Nov 21 13:25:25 2004
+++ Quota-1.5.0+auth/Quota.xs	Mon May 30 15:46:11 2005
@@ -47,6 +47,13 @@
   unsigned        timeout;
 } quota_rpc_cfg = {FALSE, 0, 4000};
 
+static struct
+{
+    int           uid;
+    int           gid;
+    char          hostname[MAX_MACHINE_NAME + 1];
+} quota_rpc_auth = {-1, -1, NULL};
+
 /*
  * fetch quotas from remote host
  */
@@ -93,8 +100,16 @@
 
   if &#40;client == NULL&#41;
     return &#40;&#40;int&#41; rpc_createerr.cf_stat&#41;;
-
-  client-&gt;cl_auth = authunix_create_default&#40;&#41;;
+  
+  /* 
+   *  Authorization 
+   */
+  if &#40;quota_rpc_auth.uid &gt; -1 &#38;&#38; quota_rpc_auth.gid &gt; -1&#41; {
+    client-&gt;cl_auth = authunix_create&#40;quota_rpc_auth.hostname, quota_rpc_auth.uid, quota_rpc_auth.gid, 0, 0&#41;;
+  }
+  else {
+    client-&gt;cl_auth = authunix_create_default&#40;&#41;;
+  }
 
   /*
    *  Call remote server
@@ -623,6 +638,23 @@
 	  quota_rpc_cfg.port = port;
 	  quota_rpc_cfg.use_tcp = use_tcp;
 	  quota_rpc_cfg.timeout = timeout;
+#endif
+	}
+
+void
+rpcauth&#40;uid=getuid&#40;&#41;,gid=getgid&#40;&#41;,hostname=NULL&#41;
+	int uid
+	int gid
+	char * hostname
+	PPCODE:
+	{
+#ifndef NO_RPC
+	  quota_rpc_auth.uid = uid;
+	  quota_rpc_auth.gid = gid;
+	   if &#40;hostname == NULL&#41;
+	     gethostname&#40;quota_rpc_auth.hostname, MAX_MACHINE_NAME&#41;;
+	   else 
+	     strncpy&#40;quota_rpc_auth.hostname, hostname, MAX_MACHINE_NAME&#41;;
 #endif
 	}
 
diff -ur Quota-1.5.0/README Quota-1.5.0+auth/README
--- Quota-1.5.0/README	Sun Nov 21 13:19:47 2004
+++ Quota-1.5.0+auth/README	Mon May 30 15:59:30 2005
@@ -174,6 +174,12 @@
          the remote host is used &#40;i.e. default port is 0,
          protocol is UDP&#41;  The default timeout is 4 seconds.
 
+     Quota::rpcauth&#40;$uid,$gid,$hostname&#41;
+        Configure authorization parameters for subsequent 
+        RPC queries; all parameters are optional. By default 
+        uid and gid are taken from owner of the process and 
+        hostname is the host name of current machine.
+    
      $arg = Quota::getqcarg&#40;$path&#41;
          Get the required $dev argument for Quota::query and
          Quota::setqlim for the file system you want to operate
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;17&nbsp;06:00:38&nbsp;2005</span>
    <span class="description">tomzo [...] users.sourceforge.net -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
