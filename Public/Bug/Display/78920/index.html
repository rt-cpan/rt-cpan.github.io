<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #78920 for libwww-perl: high cpu usage when waiting for data on the destination socket</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #78920 for libwww-perl: high cpu usage when waiting for data on the destination socket</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=libwww-perl">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=libwww-perl">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=libwww-perl">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=libwww-perl">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/libwww-perl">libwww-perl CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">78920</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=libwww-perl">libwww-perl</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
aardbeiplantje [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
victor [...] vsespb.ru

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-18330-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
6.04    </td>
  </tr>
  <tr id="CF-18331-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=78920">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1108293" href="/Public/Bug/Display.html?id=78920#txn-1108293">#</a>      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;12&nbsp;07:15:03&nbsp;2012</span>
    <span class="description">aardbeiplantje [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> high cpu usage when waiting for data on the destination socket</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1108293/582705/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/582705">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Information:
   libwww-perl-6.04
   perl v5.12.2 on x86_64-linux-gnu-thread-multi 
   Linux wihiie 3.2.0-2-amd64 #1 SMP Sun Mar 4 22:48:17 UTC 2012 x86_64 
GNU/Linux

When using LWP::UserAgent to connect to a http&#40;s&#41; webserver, the cpu 
usage goes to 100% &#40;per core fcourse&#41; when waiting for data on that 
socket. It&#39;s in fact an infinite loop that only quits when the socket 
has an error.

Sample script:

  use strict; use warnings;

  use LWP::UserAgent;

  my $u = LWP::UserAgent-&gt;new&#40;
      ssl_opts =&gt; {verify_hostname =&gt; 0},
  &#41;;
  $u-&gt;get&#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="https://127.0.0.1:1443/BIGFILE">https://127.0.0.1:1443/BIGFILE</a></span>&#34;, &#39;:content_cb&#39; =&gt; sub {}&#41;;


This can be checked with strace, it loops only this:
    
     read&#40;3, 0x13c5ff3, 5&#41; = -1 EAGAIN &#40;Resource temporarily 
unavailable&#41;

This is easily testable by using socat and use it as a TCP proxy &#40;event 
for HTTPS/SSL&#41;. One starts a socat and background it while a sample 
script is downloading data. This is of course not a real world situation  
as normally, networking is ok these days. The problem is that sometimes 
networking isnt&#39; great and, morover, when the data doesn&#39;t come in *fast 
enough* it also consumes too much cpu cycles. Also, a loop like that 
makes that the timeout parameters are impossible to implement and 
enforce.

I&#39;ve found multiple of those infinite like loops:
   IO::Socket::SSL has one in readline&#40;&#41; &#40;even multiple copy-pasted 
ones&#41;
   Net::HTTP has one which does a select+timeout infinite loop while 
waiting for http response headers on a persistent chunked connection.

This particular one is in LWP::Protocol::http:

409       READ:
410     {
411         $n = $socket-&gt;read_entity_body&#40;$buf, $size&#41;;
412             unless &#40;defined $n&#41; {
413                 redo READ if $!{EINTR} || $!{EAGAIN};
414                 die &#34;read failed: $!&#34;;
415             }
416         redo READ if $n == -1;
417     }


Net::HTTP::Methods&#39; read_entity_body&#40;&#41; does a nonblocking read and here 
it&#39;s unchecked with select&#40;&#41;.

I must admit that this might be difficult to fix in LWP::UserAgent as 
this module isn&#39;t probably ment to do stuff like that. Probably because 
it&#39;s next to impossible to have an eventloop like AnyEvent in 
LWP::UserAgent. With AnyEvent::HTTP this is next to perfect - however, 
that lacks a few other things compared to LWP::UserAgent.

It is possible to have at least all read/write&#39;s banked with a decent 
select&#40;&#41; with a correct bitmask: the fd is known there. Even adding the 
timeout var is perfectly possible. Same for Net::HTTP&#39;s select+timeout 
call.
   

  
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1300508" href="/Public/Bug/Display.html?id=78920#txn-1300508">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;10&nbsp;17:08:13&nbsp;2013</span>
    <span class="description">victor [...] vsespb.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1300508/689020/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/689020">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Can&#39;t reproduce.

strace shows

read&#40;3, &#34;\32&#38;Z\323L\201|&#41;&gt;`J\34\2\243\251\35\334\373\226&gt;Z\357\307\250\22p\v&#41;Ux&#39;x&#34;..., 4096&#41; = 4096
select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179, 999999}&#41;
read&#40;3, &#34;\&#34;\207%&#40;\227\1\247\377\0009`\0264\374\211\243\232\257G\\8\240\223DyV@q\277\266\10\300&#34;..., 4096&#41; = 4096
select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179, 999999}&#41;
read&#40;3, &#34;S\247z\341\347/\347j\247\242\252\347\350,_\216wm\234t:\232\306\266\22I\363\6\245\310Z\310&#34;..., 4096&#41; = 4096
select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179, 999999}&#41;
read&#40;3, &#34;\6\215\321:v\234\264&#39;@\320P\311\247\34\245\227\356E\371\375huU\27\20\16\342~\223p8\346&#34;..., 4096&#41; = 4096
select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179, 999999}&#41;
read&#40;3, &#34;f\347\31\363=^w\330\10r\215\230\3629\242\0\2633\252\326\350\317\276$-\371\271\21x7lv&#34;..., 4096&#41; = 4096
select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179, 999999}&#41;
read&#40;3, &#34;3\32571L\\C3\216 \21\314\245\35\331\322\203\23\227\247X\255\5&#41;\315\\vK\302\345\204&lt;&#34;..., 4096&#41; = 4096
select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179, 999999}&#41;
read&#40;3, &#34;Gu\244\210\2110\230~\371]\330\306,\352\357\202xZ\267\377\33\31\32\241r\207\f\344\260g\306O&#34;..., 4096&#41; = 4096
select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179, 999999}&#41;
read&#40;3, &#34;\345\306\f\276\265\\\327\247\0043\303\247P\325^6\4F\316w4\0230l\33`\10&lt;@%![&#34;..., 4096&#41; = 4096
select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179, 999998}&#41;
read&#40;3, &#34;\5r\301c\322Ax\311&#39;]\2479\226 \252\6i\20#\254\350\313\322\312d\224\237\242\24\252/\177&#34;..., 4096&#41; = 4096
select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179, 999999}&#41;
read&#40;3, &#34;\325\346\356\1\270\34\\\323V\215.\214\324.\24&#39;\361\373&#38;E\207\nCh\337\334l\5zg\241\213&#34;..., 4096&#41; = 4096


for big file hosted on localhost &#40;nginx&#41;

HTTP mode, lwp 6.05, linux


On Sun Aug 12 15:15:03 2012, CowboyTim wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Information:
&gt;    libwww-perl-6.04
&gt;    perl v5.12.2 on x86_64-linux-gnu-thread-multi 
&gt;    Linux wihiie 3.2.0-2-amd64 #1 SMP Sun Mar 4 22:48:17 UTC 2012 x86_64 
&gt; GNU/Linux
&gt; 
&gt; When using LWP::UserAgent to connect to a http&#40;s&#41; webserver, the cpu 
&gt; usage goes to 100% &#40;per core fcourse&#41; when waiting for data on that 
&gt; socket. It&#39;s in fact an infinite loop that only quits when the socket 
&gt; has an error.
&gt; 
&gt; Sample script:
&gt; 
&gt;   use strict; use warnings;
&gt; 
&gt;   use LWP::UserAgent;
&gt; 
&gt;   my $u = LWP::UserAgent-&gt;new&#40;
&gt;       ssl_opts =&gt; {verify_hostname =&gt; 0},
&gt;   &#41;;
&gt;   $u-&gt;get&#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="https://127.0.0.1:1443/BIGFILE">https://127.0.0.1:1443/BIGFILE</a></span>&#34;, &#39;:content_cb&#39; =&gt; sub {}&#41;;
&gt; 
&gt; 
&gt; This can be checked with strace, it loops only this:
&gt;     
&gt;      read&#40;3, 0x13c5ff3, 5&#41; = -1 EAGAIN &#40;Resource temporarily 
&gt; unavailable&#41;
&gt; 
&gt; This is easily testable by using socat and use it as a TCP proxy &#40;event 
&gt; for HTTPS/SSL&#41;. One starts a socat and background it while a sample 
&gt; script is downloading data. This is of course not a real world situation  
&gt; as normally, networking is ok these days. The problem is that sometimes 
&gt; networking isnt&#39; great and, morover, when the data doesn&#39;t come in *fast 
&gt; enough* it also consumes too much cpu cycles. Also, a loop like that 
&gt; makes that the timeout parameters are impossible to implement and 
&gt; enforce.
&gt; 
&gt; I&#39;ve found multiple of those infinite like loops:
&gt;    IO::Socket::SSL has one in readline&#40;&#41; &#40;even multiple copy-pasted 
&gt; ones&#41;
&gt;    Net::HTTP has one which does a select+timeout infinite loop while 
&gt; waiting for http response headers on a persistent chunked connection.
&gt; 
&gt; This particular one is in LWP::Protocol::http:
&gt; 
&gt; 409       READ:
&gt; 410     {
&gt; 411         $n = $socket-&gt;read_entity_body&#40;$buf, $size&#41;;
&gt; 412             unless &#40;defined $n&#41; {
&gt; 413                 redo READ if $!{EINTR} || $!{EAGAIN};
&gt; 414                 die &#34;read failed: $!&#34;;
&gt; 415             }
&gt; 416         redo READ if $n == -1;
&gt; 417     }
&gt; 
&gt; 
&gt; Net::HTTP::Methods&#39; read_entity_body&#40;&#41; does a nonblocking read and here 
&gt; it&#39;s unchecked with select&#40;&#41;.
&gt; 
&gt; I must admit that this might be difficult to fix in LWP::UserAgent as 
&gt; this module isn&#39;t probably ment to do stuff like that. Probably because 
&gt; it&#39;s next to impossible to have an eventloop like AnyEvent in 
&gt; LWP::UserAgent. With AnyEvent::HTTP this is next to perfect - however, 
&gt; that lacks a few other things compared to LWP::UserAgent.
&gt; 
&gt; It is possible to have at least all read/write&#39;s banked with a decent 
&gt; select&#40;&#41; with a correct bitmask: the fd is known there. Even adding the 
&gt; timeout var is perfectly possible. Same for Net::HTTP&#39;s select+timeout 
&gt; call.
&gt;    
&gt; 
&gt;   
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1300509" href="/Public/Bug/Display.html?id=78920#txn-1300509">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;10&nbsp;17:08:13&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1300513" href="/Public/Bug/Display.html?id=78920#txn-1300513">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;10&nbsp;17:10:04&nbsp;2013</span>
    <span class="description">victor [...] vsespb.ru -  Cc vsespb added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1300539" href="/Public/Bug/Display.html?id=78920#txn-1300539">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;10&nbsp;17:41:49&nbsp;2013</span>
    <span class="description">aardbeiplantje [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #78920] high cpu usage when waiting for data on the destination socket</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 10 Dec 2013 23:41:37 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-libwww-perl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tim Aerts &lt;aardbeiplantje [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1300539/689041/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/689041">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">your destination keeps providing data, the cpu usage is normal then. It&#39;s
also not yet fixed in 6.05. If you want to test/verify this: run e.g. a
server in foreground mode and while it is transferring data, background it
with ctrl-Z. The client process will go to 100% cpu.


2013/12/10 Victor Efimov via RT &lt;bug-libwww-perl@rt.cpan.org&gt;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=78920">https://rt.cpan.org/Ticket/Display.html?id=78920</a></span> &gt;
&gt;
&gt; Can&#39;t reproduce.
&gt;
&gt; strace shows
&gt;
&gt; read&#40;3,
&gt; &#34;\32&#38;Z\323L\201|&#41;&gt;`J\34\2\243\251\35\334\373\226&gt;Z\357\307\250\22p\v&#41;Ux&#39;x&#34;...,
&gt; 4096&#41; = 4096
&gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179, 999999}&#41;
&gt; read&#40;3,
&gt; &#34;\&#34;\207%&#40;\227\1\247\377\0009`\0264\374\211\243\232\257G\\8\240\223DyV@q\277\266\10\300&#34;...,
&gt; 4096&#41; = 4096
&gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179, 999999}&#41;
&gt; read&#40;3,
&gt; &#34;S\247z\341\347/\347j\247\242\252\347\350,_\216wm\234t:\232\306\266\22I\363\6\245\310Z\310&#34;...,
&gt; 4096&#41; = 4096
&gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179, 999999}&#41;
&gt; read&#40;3, &#34;\6\215\321:v\234\264&#39;@\320P\311\247\34\245\227\356E\371\375huU\27\20\16\342~\223p8\346&#34;...,
&gt; 4096&#41; = 4096
&gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179, 999999}&#41;
&gt; read&#40;3,
&gt; &#34;f\347\31\363=^w\330\10r\215\230\3629\242\0\2633\252\326\350\317\276$-\371\271\21x7lv&#34;...,
&gt; 4096&#41; = 4096
&gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179, 999999}&#41;
&gt; read&#40;3, &#34;3\32571L\\C3\216
&gt; \21\314\245\35\331\322\203\23\227\247X\255\5&#41;\315\\vK\302\345\204&lt;&#34;...,
&gt; 4096&#41; = 4096
&gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179, 999999}&#41;
&gt; read&#40;3,
&gt; &#34;Gu\244\210\2110\230~\371]\330\306,\352\357\202xZ\267\377\33\31\32\241r\207\f\344\260g\306O&#34;...,
&gt; 4096&#41; = 4096
&gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179, 999999}&#41;
&gt; read&#40;3,
&gt; &#34;\345\306\f\276\265\\\327\247\0043\303\247P\325^6\4F\316w4\0230l\33`\10&lt;@%![&#34;...,
&gt; 4096&#41; = 4096
&gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179, 999998}&#41;
&gt; read&#40;3, &#34;\5r\301c\322Ax\311&#39;]\2479\226
&gt; \252\6i\20#\254\350\313\322\312d\224\237\242\24\252/\177&#34;..., 4096&#41; = 4096
&gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179, 999999}&#41;
&gt; read&#40;3,
&gt; &#34;\325\346\356\1\270\34\\\323V\215.\214\324.\24&#39;\361\373&#38;E\207\nCh\337\334l\5zg\241\213&#34;...,
&gt; 4096&#41; = 4096
&gt;
&gt;
&gt; for big file hosted on localhost &#40;nginx&#41;
&gt;
&gt; HTTP mode, lwp 6.05, linux
&gt;
&gt;
&gt;
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1300539/689042/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/689042">with headers</a>
<br />
<span class="downloadcontenttype">text/html 2.8k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1300566" href="/Public/Bug/Display.html?id=78920#txn-1300566">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;10&nbsp;18:12:47&nbsp;2013</span>
    <span class="description">victor [...] vsespb.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1300566/689057/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/689057">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I ran server

socat TCP-LISTEN:8001,crlf SYSTEM:&#34;echo HTTP/1.0 200; echo Content-Type\: text/plain; echo; cat /home/somehugefile&#34;

then ran client &#40;i.e. code you posted&#41; with strace.

then I Ctrl-Z server. Client just stopped. I brought server to foreground. Client continue execution. Don&#39;t see an issue.

On Wed Dec 11 02:41:49 2013, CowboyTim wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; your destination keeps providing data, the cpu usage is normal then.
&gt; It&#39;s
&gt; also not yet fixed in 6.05. If you want to test/verify this: run e.g.
&gt; a
&gt; server in foreground mode and while it is transferring data,
&gt; background it
&gt; with ctrl-Z. The client process will go to 100% cpu.
&gt; 
&gt; 
&gt; 2013/12/10 Victor Efimov via RT &lt;bug-libwww-perl@rt.cpan.org&gt;
&gt; 
<div class="message-stanza open">&gt; &gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=78920">https://rt.cpan.org/Ticket/Display.html?id=78920</a></span> &gt;
&gt; &gt;
&gt; &gt; Can&#39;t reproduce.
&gt; &gt;
&gt; &gt; strace shows
&gt; &gt;
&gt; &gt; read&#40;3,
&gt; &gt; &#34;\32&#38;Z\323L\201|&#41;&gt;`J\34\2\243\251\35\334\373\226&gt;Z\357\307\250\22p\v&#41;Ux&#39;x&#34;...,
&gt; &gt; 4096&#41; = 4096
&gt; &gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179,
&gt; &gt; 999999}&#41;
&gt; &gt; read&#40;3,
&gt; &gt; &#34;\&#34;\207%&#40;\227\1\247\377\0009`\0264\374\211\243\232\257G\\8\240\223DyV@q\277\266\10\300&#34;...,
&gt; &gt; 4096&#41; = 4096
&gt; &gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179,
&gt; &gt; 999999}&#41;
&gt; &gt; read&#40;3,
&gt; &gt; &#34;S\247z\341\347/\347j\247\242\252\347\350,_\216wm\234t:\232\306\266\22I\363\6\245\310Z\310&#34;...,
&gt; &gt; 4096&#41; = 4096
&gt; &gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179,
&gt; &gt; 999999}&#41;
&gt; &gt; read&#40;3,
&gt; &gt; &#34;\6\215\321:v\234\264&#39;@\320P\311\247\34\245\227\356E\371\375huU\27\20\16\342~\223p8\346&#34;...,
&gt; &gt; 4096&#41; = 4096
&gt; &gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179,
&gt; &gt; 999999}&#41;
&gt; &gt; read&#40;3,
&gt; &gt; &#34;f\347\31\363=^w\330\10r\215\230\3629\242\0\2633\252\326\350\317\276$-
&gt; &gt; \371\271\21x7lv&#34;...,
&gt; &gt; 4096&#41; = 4096
&gt; &gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179,
&gt; &gt; 999999}&#41;
&gt; &gt; read&#40;3, &#34;3\32571L\\C3\216
&gt; &gt; \21\314\245\35\331\322\203\23\227\247X\255\5&#41;\315\\vK\302\345\204&lt;&#34;...,
&gt; &gt; 4096&#41; = 4096
&gt; &gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179,
&gt; &gt; 999999}&#41;
&gt; &gt; read&#40;3,
&gt; &gt; &#34;Gu\244\210\2110\230~\371]\330\306,\352\357\202xZ\267\377\33\31\32\241r\207\f\344\260g\306O&#34;...,
&gt; &gt; 4096&#41; = 4096
&gt; &gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179,
&gt; &gt; 999999}&#41;
&gt; &gt; read&#40;3,
&gt; &gt; &#34;\345\306\f\276\265\\\327\247\0043\303\247P\325^6\4F\316w4\0230l\33`\10&lt;@%![&#34;...,
&gt; &gt; 4096&#41; = 4096
&gt; &gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179,
&gt; &gt; 999998}&#41;
&gt; &gt; read&#40;3, &#34;\5r\301c\322Ax\311&#39;]\2479\226
&gt; &gt; \252\6i\20#\254\350\313\322\312d\224\237\242\24\252/\177&#34;..., 4096&#41; =
&gt; &gt; 4096
&gt; &gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179,
&gt; &gt; 999999}&#41;
&gt; &gt; read&#40;3,
&gt; &gt; &#34;\325\346\356\1\270\34\\\323V\215.\214\324.\24&#39;\361\373&#38;E\207\nCh\337\334l\5zg\241\213&#34;...,
&gt; &gt; 4096&#41; = 4096
&gt; &gt;
&gt; &gt;
&gt; &gt; for big file hosted on localhost &#40;nginx&#41;
&gt; &gt;
&gt; &gt; HTTP mode, lwp 6.05, linux
&gt; &gt;
&gt; &gt;
&gt; &gt;
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1300875" href="/Public/Bug/Display.html?id=78920#txn-1300875">#</a>      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;11&nbsp;18:35:05&nbsp;2013</span>
    <span class="description">aardbeiplantje [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #78920] high cpu usage when waiting for data on the destination socket</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 12 Dec 2013 00:34:54 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-libwww-perl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tim Aerts &lt;aardbeiplantje [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1300875/689253/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/689253">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">You&#39;re right the strace is ok too &#40;shouldn&#39;ve noticed it immediately&#41;. This
problem is actually fixed in Net::HTTP 6.04 onwards. The loop without a
select&#40;&#41; was in Net::HTTP 6.03. So the error wasn&#39;t in libwww-perl itself,
but in the Net::HTTP::Methods read_entity_biody&#40;&#41;. The rt ticket can be
closed.


2013/12/11 Victor Efimov via RT &lt;bug-libwww-perl@rt.cpan.org&gt;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=78920">https://rt.cpan.org/Ticket/Display.html?id=78920</a></span> &gt;
&gt;
&gt; I ran server
&gt;
&gt; socat TCP-LISTEN:8001,crlf SYSTEM:&#34;echo HTTP/1.0 200; echo Content-Type\:
&gt; text/plain; echo; cat /home/somehugefile&#34;
&gt;
&gt; then ran client &#40;i.e. code you posted&#41; with strace.
&gt;
&gt; then I Ctrl-Z server. Client just stopped. I brought server to foreground.
&gt; Client continue execution. Don&#39;t see an issue.
&gt;
&gt; On Wed Dec 11 02:41:49 2013, CowboyTim wrote:
<div class="message-stanza open">&gt; &gt; your destination keeps providing data, the cpu usage is normal then.
&gt; &gt; It&#39;s
&gt; &gt; also not yet fixed in 6.05. If you want to test/verify this: run e.g.
&gt; &gt; a
&gt; &gt; server in foreground mode and while it is transferring data,
&gt; &gt; background it
&gt; &gt; with ctrl-Z. The client process will go to 100% cpu.
&gt; &gt;
&gt; &gt;
&gt; &gt; 2013/12/10 Victor Efimov via RT &lt;bug-libwww-perl@rt.cpan.org&gt;
&gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=78920">https://rt.cpan.org/Ticket/Display.html?id=78920</a></span> &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; Can&#39;t reproduce.
&gt; &gt; &gt;
&gt; &gt; &gt; strace shows
&gt; &gt; &gt;
&gt; &gt; &gt; read&#40;3,
&gt; &gt; &gt;
</div></div>&gt; &#34;\32&#38;Z\323L\201|&#41;&gt;`J\34\2\243\251\35\334\373\226&gt;Z\357\307\250\22p\v&#41;Ux&#39;x&#34;...,
<div class="message-stanza open">&gt; &gt; &gt; 4096&#41; = 4096
&gt; &gt; &gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179,
&gt; &gt; &gt; 999999}&#41;
&gt; &gt; &gt; read&#40;3,
&gt; &gt; &gt; &#34;\&#34;\207%&#40;\227\1\247\377\0009`\0264\374\211\243\232\257G\\8\240\223DyV@q
</div>&gt; \277\266\10\300&#34;...,
<div class="message-stanza open">&gt; &gt; &gt; 4096&#41; = 4096
&gt; &gt; &gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179,
&gt; &gt; &gt; 999999}&#41;
&gt; &gt; &gt; read&#40;3,
&gt; &gt; &gt;
</div>&gt; &#34;S\247z\341\347/\347j\247\242\252\347\350,_\216wm\234t:\232\306\266\22I\363\6\245\310Z\310&#34;...,
<div class="message-stanza open">&gt; &gt; &gt; 4096&#41; = 4096
&gt; &gt; &gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179,
&gt; &gt; &gt; 999999}&#41;
&gt; &gt; &gt; read&#40;3,
&gt; &gt; &gt; &#34;\6\215\321:v\234\264&#39;@
</div>&gt; \320P\311\247\34\245\227\356E\371\375huU\27\20\16\342~\223p8\346&#34;...,
<div class="message-stanza open">&gt; &gt; &gt; 4096&#41; = 4096
&gt; &gt; &gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179,
&gt; &gt; &gt; 999999}&#41;
&gt; &gt; &gt; read&#40;3,
&gt; &gt; &gt; &#34;f\347\31\363=^w\330\10r\215\230\3629\242\0\2633\252\326\350\317\276$-
&gt; &gt; &gt; \371\271\21x7lv&#34;...,
&gt; &gt; &gt; 4096&#41; = 4096
&gt; &gt; &gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179,
&gt; &gt; &gt; 999999}&#41;
&gt; &gt; &gt; read&#40;3, &#34;3\32571L\\C3\216
&gt; &gt; &gt; \21\314\245\35\331\322\203\23\227\247X\255\5&#41;\315\\vK\302\345\204&lt;&#34;...,
&gt; &gt; &gt; 4096&#41; = 4096
&gt; &gt; &gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179,
&gt; &gt; &gt; 999999}&#41;
&gt; &gt; &gt; read&#40;3,
&gt; &gt; &gt;
</div>&gt; &#34;Gu\244\210\2110\230~\371]\330\306,\352\357\202xZ\267\377\33\31\32\241r\207\f\344\260g\306O&#34;...,
<div class="message-stanza open">&gt; &gt; &gt; 4096&#41; = 4096
&gt; &gt; &gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179,
&gt; &gt; &gt; 999999}&#41;
&gt; &gt; &gt; read&#40;3,
&gt; &gt; &gt;
</div>&gt; &#34;\345\306\f\276\265\\\327\247\0043\303\247P\325^6\4F\316w4\0230l\33`\10&lt;@%![&#34;...,
<div class="message-stanza open">&gt; &gt; &gt; 4096&#41; = 4096
&gt; &gt; &gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179,
&gt; &gt; &gt; 999998}&#41;
&gt; &gt; &gt; read&#40;3, &#34;\5r\301c\322Ax\311&#39;]\2479\226
&gt; &gt; &gt; \252\6i\20#\254\350\313\322\312d\224\237\242\24\252/\177&#34;..., 4096&#41; =
&gt; &gt; &gt; 4096
&gt; &gt; &gt; select&#40;8, [3], NULL, NULL, {180, 0}&#41;    = 1 &#40;in [3], left {179,
&gt; &gt; &gt; 999999}&#41;
&gt; &gt; &gt; read&#40;3,
&gt; &gt; &gt;
</div>&gt; &#34;\325\346\356\1\270\34\\\323V\215.\214\324.\24&#39;\361\373&#38;E\207\nCh\337\334l\5zg\241\213&#34;...,
<div class="message-stanza open">&gt; &gt; &gt; 4096&#41; = 4096
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; for big file hosted on localhost &#40;nginx&#41;
&gt; &gt; &gt;
&gt; &gt; &gt; HTTP mode, lwp 6.05, linux
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt;
</div>&gt;
&gt;
&gt;
&gt;
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1300875/689254/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/689254">with headers</a>
<br />
<span class="downloadcontenttype">text/html 4.7k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1353967" href="/Public/Bug/Display.html?id=78920#txn-1353967">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;23&nbsp;14:26:59&nbsp;2014</span>
    <span class="description">MITHALDU [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1353967/718538/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/718538">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This issue still exists, and is, to make it worse, a heisenbug. Meaning reproduction of the issue will not be possible with simple methods.

When making requests with certain parameters, LWP::Protocol::http still falls into an endless loop when trying to retrieve data after the the response has already been fully downloaded, getting EAGAIN endlessly from a sysread call.

In my case i have the following situation:

- Windows 7
- ActivePerl
- SOAP::Lite
- SOAP server with SSL connection
- VPN connection that is rather slow
- 3970 byte response &#40;3309 body + headers&#41; from SOAP server

Since this happened on linux as well i am fairly sure the first two factors can be ruled out. It is however important to note that they wildly differ from the original report, putting the fault here squarely on the network handling in perl, instead of the system environment.

Further, SOAP::Lite might be a factor. However if it is, i request assistance in pinpointing what it is doing wrong.

SSL might be a factor, since it increases the CPU needs overall.

The VPN connection, or rather, its low speed, is definitely a factor. This is based on the fact that the exact same code worked perfectly fine when run on a machine that was on the same network as the server.

The response size is also definitely an issue, since smaller responses with an otherwise identical configuration did not cause an endless loop.

My local hack to fix the situation is embodied in this diff:


diff --git a/lib/LWP/Protocol/http.pm b/lib/LWP/Protocol/http.pm
index a75e147..01157f6 100644
--- a/lib/LWP/Protocol/http.pm
+++ b/lib/LWP/Protocol/http.pm
@@ -453,6 +453,7 @@ sub request
        my $n;
       READ:
        {
+            select&#40;undef, undef, undef, 0.25&#41;;
            $n = $socket-&gt;read_entity_body&#40;$buf, $size&#41;;
             unless &#40;defined $n&#41; {
                 redo READ if $!{EINTR} || $!{EAGAIN} || $!{ENOTTY};


There are two notable things about this change:

1. The sleep has to occur before the read. Putting it on the line directly after the read_entity_body line still results in an endless loop, though one that does not hammer the CPU. Higher sleep time values there do not help, even a 10 second sleep after the read_entity_body line causes an endless loop. So it must come before it.

2. On my system smaller values for the sleep did not suffice. With a sleep time of 0.1 the endless loop still occurred, just with less CPU usage. The value of 0.25 was necessary on my machine to gain reliability.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1357161" href="/Public/Bug/Display.html?id=78920#txn-1357161">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;30&nbsp;17:24:18&nbsp;2014</span>
    <span class="description">mitch [...] cgarbs.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #78920] twirssi suffers from this</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 30 Apr 2014 23:18:00 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-libwww-perl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Christian Garbs &lt;mitch [...] cgarbs.de&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1357161/720274/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/720274">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 905b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">As this bug has been called &#34;Heisenbug&#34; and hard to reproduce:
The twitter-plugin &#34;twirssi&#34; for the irssi IRC client suffers from
this, see this bug report:  <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/zigdon/twirssi/issues/75">https://github.com/zigdon/twirssi/issues/75</a></span>

On my box I sometimes get multiple endless loops per day while on
other days everything is peaceful.

The constellation here is always:

 - HTTPS/SSL
 - connections to *.twitter.com - connections can be slow or sluggish ;-&#41;

System:

 - Linux &#40;Debian stable&#41;
 - libwww-perl 6.04
 - Net::Twitter &#40;current version from CPAN&#41;

Regards
Christian
-- 
....Christian.Garbs.....................................<span class="clickylink"><a target="new" rel="nofollow" href="http://www.cgarbs.de">http://www.cgarbs.de</a></span>

           n   -on         8c       Noch mehr       lde.alt.rec.ascii-art
    &#40;&#41;.    cc&#34;-/7       __/~\__     abstrakte       l
   &#40;O &#41;o    &#34;c__&#41;      &#40;&#40;&#40;\_/&#41;&#41;&#41;   Gummihühner   .&#39;&#34;l .&#39;&#34;l l&#34;&#39;.&#39;&#34;l _ .&#39;&#34;l
    &#40;&#40; &#41;Oo. ,-&#34;&lt;_  cgmm  _&#41; &#40;_      gibt&#39;s in    `._l `._l l  `._l   `._l
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1444333" href="/Public/Bug/Display.html?id=78920#txn-1444333">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;19&nbsp;17:34:20&nbsp;2014</span>
    <span class="description">xenic [...] basen.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #78920]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 19 Dec 2014 22:33:56 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-libwww-perl [...] rt.cpan.org&#34; &lt;bug-libwww-perl [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilkka Kaakkola &lt;xenic [...] basen.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1444333/767894/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/767894">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Hit this bug on a Raspberry running: Linux pirouter 3.12.28+ #709 PREEMPT Mon Sep 8 15:28:00 BST 2014 armv6l GNU/Linux

My client is doing multiple HTTPS PUTs to a remote server and &#40;rough guesstimate&#41; one in five of them gets stuck in a busy loop:

root@pirouter:~# strace -v -p 17160
Process 17160 attached - interrupt to quit
read&#40;4, 0x192ae53, 5&#41;                   = -1 EAGAIN &#40;Resource temporarily unavailable&#41;
read&#40;4, 0x192ae53, 5&#41;                   = -1 EAGAIN &#40;Resource temporarily unavailable&#41;
read&#40;4, 0x192ae53, 5&#41;                   = -1 EAGAIN &#40;Resource temporarily unavailable&#41;
read&#40;4, 0x192ae53, 5&#41;                   = -1 EAGAIN &#40;Resource temporarily unavailable&#41;
read&#40;4, 0x192ae53, 5&#41;                   = -1 EAGAIN &#40;Resource temporarily unavailable&#41;
read&#40;4, 0x192ae53, 5&#41;                   = -1 EAGAIN &#40;Resource temporarily unavailable&#41;
read&#40;4, 0x192ae53, 5&#41;                   = -1 EAGAIN &#40;Resource temporarily unavailable&#41;

This seems to clear after a moment &#40;20-30seconds&#41;, but constantly happens again on a subsequent request.


If I change from HTTPS to HTTP this does not happen &#40;keeping everything else the same&#41;.

I&#39;m able to constantly reproduce this &#40;over reboots of the linux box in question&#41; and can provide additional debug information if someone is able to direct me.




Perl version:

root@pirouter:~# perl -v

This is perl 5, version 14, subversion 2 &#40;v5.14.2&#41; built for arm-linux-gnueabihf-thread-multi-64int

libwww version:

root@pirouter:~# dpkg --status libwww-perl
Package: libwww-perl
Status: install ok installed
Priority: optional
Section: perl
Installed-Size: 412
Maintainer: Debian Perl Group &lt;pkg-perl-maintainers@lists.alioth.debian.org&gt;
Architecture: all
Version: 6.04-1
Depends: perl, ca-certificates, libencode-locale-perl, libfile-listing-perl, libhtml-parser-perl, libhtml-tagset-perl, libhtml-tree-perl, libhttp-cookies-perl, libhttp-date-perl, libhttp-message-perl, libhttp-negotiate-perl, liblwp-mediatypes-perl, liblwp-protocol-https-perl, libnet-http-perl, liburi-perl, libwww-robotrules-perl, netbase
Recommends: libhtml-form-perl, libhtml-format-perl, libhttp-daemon-perl, libmailtools-perl
Suggests: libauthen-ntlm-perl
Breaks: fusioninventory-agent &#40;&lt;&lt; 2.1.8-2&#41;, gsutil &#40;&lt;&lt; 3.1-1&#41;, libfrontier-rpc-perl &#40;&lt;&lt; 0.07b4-6&#41;, libhttp-daemon-ssl-perl &#40;&lt;&lt; 1.04-3&#41;, libhttp-proxy-perl &#40;&lt;&lt; 0.24-2&#41;, libhttp-request-ascgi-perl &#40;&lt;&lt; 1.2-2&#41;, libhttp-request-params-perl &#40;&lt;&lt; 1.01-6&#41;, libjson-rpc-perl &#40;&lt;&lt; 0.96-3&#41;, libpoe-perl &#40;&lt;&lt; 2:1.2990-2&#41;, librpc-xml-perl &#40;&lt;&lt; 0.74-2&#41;, libsoap-lite-perl &#40;&lt;&lt; 0.7.12-3&#41;, libwww-mechanize-formfiller-perl &#40;&lt;&lt; 0.10-2&#41;, libwww-mechanize-perl &#40;&lt;&lt; 1.66-2&#41;, satutils &#40;&lt;= 0.6&#41;, tidy-proxy &#40;&lt;&lt; 0.97-4&#41;
Description: simple and consistent interface to the world-wide web
 libwww-perl &#40;also known as LWP&#41; is a collection of Perl modules that provide
 a simple and consistent programming interface &#40;API&#41; to the World-Wide Web.
 The main focus of the library is to provide classes and functions that allow
 you to write WWW clients. It also contains general purpose modules, as well
 as a simple HTTP/1.1-compatible server implementation.
Homepage: <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/dist/libwww-perl/">http://search.cpan.org/dist/libwww-perl/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1445200" href="/Public/Bug/Display.html?id=78920#txn-1445200">#</a>      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;22&nbsp;06:41:04&nbsp;2014</span>
    <span class="description">mirq-boogs [...] rere.qmqm.pl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #78920]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 22 Dec 2014 12:35:46 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-libwww-perl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Michał Mirosław &lt;mirq-boogs [...] rere.qmqm.pl&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1445200/768386/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/768386">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 241b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I also tripped on this bug on latest Debian wheezy. Maybe it&#39;s IO::Socket::SSL at fault?
I worked aroud the problem by adding following to the script&#39;s environment:

PERL_NET_HTTPS_SSL_SOCKET_CLASS=Net::SSL

Best Regards,
Michał Mirosław
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1445203" href="/Public/Bug/Display.html?id=78920#txn-1445203">#</a>      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;22&nbsp;06:43:42&nbsp;2014</span>
    <span class="description">mirq-boogs [...] rere.qmqm.pl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #78920]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 22 Dec 2014 12:35:46 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-libwww-perl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Michał Mirosław &lt;mirq-boogs [...] rere.qmqm.pl&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1445203/768389/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/768389">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 241b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I also tripped on this bug on latest Debian wheezy. Maybe it&#39;s IO::Socket::SSL at fault?
I worked aroud the problem by adding following to the script&#39;s environment:

PERL_NET_HTTPS_SSL_SOCKET_CLASS=Net::SSL

Best Regards,
Michał Mirosław
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1714693" href="/Public/Bug/Display.html?id=78920#txn-1714693">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;31&nbsp;15:04:25&nbsp;2017</span>
    <span class="description">olaf [...] wundersolutions.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1714693/921578/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/921578">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 82b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ticket migrated to github as <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/libwww-perl/libwww-perl/issues/228">https://github.com/libwww-perl/libwww-perl/issues/228</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1714696" href="/Public/Bug/Display.html?id=78920#txn-1714696">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;31&nbsp;15:04:31&nbsp;2017</span>
    <span class="description">olaf [...] wundersolutions.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.594416</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
