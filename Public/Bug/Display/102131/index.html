<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #102131 for Net-DNS: calling &#34;tsig&#34; method on resolver object results in error</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #102131 for Net-DNS: calling &#34;tsig&#34; method on resolver object results in error</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-DNS/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-DNS">Net-DNS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">102131</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-DNS/Active/">Net-DNS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
nrittner [...] atlas-brb.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22454-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22455-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;15&nbsp;08:11:35&nbsp;2015</span>
    <span class="description">nrittner [...] atlas-brb.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> calling &#34;tsig&#34; method on resolver object results in error</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 15 Feb 2015 14:11:05 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Nico Rittner &lt;nrittner [...] atlas-brb.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">hello,

recently the linux-distribution i use &#40;recent gentoo&#41;
upgraded the net-dns package to version 0.74 &#40;from 0.6xx&#41;.
from this time signing queries and updates
does not work anymore. former i used:

$resolver = Net::DNS::Resolver-&gt;new&#40;...&#41;;

$resolver-&gt;tsig&#40; $keyname, $key &#41;;
&#40;$key as base64 representation&#41;

        or

$resolver-&gt;tsig&#40; Net::DNS::RR-&gt;new&#40; &#34;$keyname TSIG $key&#34; &#41; &#41;;

calling tsig now results in an expeption:
&#34;zone file representation not defined for TSIG at /usr/lib/perl5/vendor_perl/5.18.2/i686-linux/Net/DNS/RR.pm line 683.&#34;

according to <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~nlnetlabs/Net-DNS-0.74/lib/Net/DNS/Resolver.pm#tsig">http://search.cpan.org/~nlnetlabs/Net-DNS-0.74/lib/Net/DNS/Resolver.pm#tsig</a></span>

my usage of tsig&#40;&#41; should be correct.

using another way of pre-creating the tsig RR-Object with:

my $tsig = Net::DNS::RR-&gt;new&#40; type =&gt; &#34;TSIG&#34;, name =&gt; &#34;KEYNAME&#34;, key =&gt; &#34;KEY&#34; &#41;;
$resolver-&gt;tsig&#40;$tsig&#41;;

results in BADSIG Errors in BIND at server side.

using $tsig for signing update packets only with:

my $update = Net::DNS::Update-&gt;new&#40; ... &#41;;
$update-&gt;sign_tsig&#40;$tsig&#41;;

also does not work.

What is the correct way to use tsig for both
query and update packets in Net::DNS &gt;= V0.74 ?

Perl Version is 5.18.2 .

thanks a lot for your hints.

Nico
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;17&nbsp;22:36:05&nbsp;2015</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Feb 15 08:11:35 2015, nrittner@atlas-brb.net wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; recently the linux-distribution i use &#40;recent gentoo&#41;
&gt; upgraded the net-dns package to version 0.74 &#40;from 0.6xx&#41;.
</div>
The world has moved on a long way since then!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; $resolver-&gt;tsig&#40; $keyname, $key &#41;;
</div>
 use Net::DNS;
 my $resolver = new Net::DNS::Resolver&#40; debug =&gt; 1, nameservers =&gt; [&#39;127.0.0.1&#39;] &#41;;

 $resolver-&gt;tsig&#40; &#39;hmac-md5.example.&#39;, &#39;ARDJZgtuTDzAWeSGYPAu9uJUkX0=&#39; &#41;;

 my $query = new Net::DNS::Packet&#40; &#39;www.example.com&#39;, &#39;A&#39; &#41;;
 my $reply = $resolver-&gt;send&#40;$query&#41;;
 my $verified = $reply-&gt;verify&#40;$query&#41;;
 print &#34;*** reply &#34;, $verified ? &#34;verified&#34; : &#34;not verified&#34;, &#34; ***\n&#34;;

This is the historical way of doing things and still works. Unfortunately, MD5 is the only algorithm available with this method.

If this does not work for you, the most likely reason is incorrect specification of the key in BIND.

The config file should contain something like:

 key hmac-md5.example {
        algorithm HMAC-MD5;
        secret &#34;ARDJZgtuTDzAWeSGYPAu9uJUkX0=&#34;;
 };


  
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; $resolver-&gt;tsig&#40; Net::DNS::RR-&gt;new&#40; &#34;$keyname TSIG $key&#34; &#41; &#41;;
</div>
If you read the documentation for the TSIG RR, you will see that there is a create&#40;&#41; method.  There is now no string representation of TSIG records. The old format had no means of specifying the signing algorithm, which these days is almost never MD5.

The exception is raised in RR-&gt;new, not in Resolver-&gt;tsig.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; according to <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~nlnetlabs/Net-DNS-">http://search.cpan.org/~nlnetlabs/Net-DNS-</a></span>
&gt; 0.74/lib/Net/DNS/Resolver.pm#tsig
</div>You will need to read the documentation for Net::DNS::Packet and Net::DNS::RR::TSIG to understand how this works.

 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; using another way of pre-creating the tsig RR-Object with:
&gt; 
&gt; my $tsig = Net::DNS::RR-&gt;new&#40; type =&gt; &#34;TSIG&#34;, name =&gt; &#34;KEYNAME&#34;, key
&gt; =&gt; &#34;KEY&#34; &#41;;
&gt; $resolver-&gt;tsig&#40;$tsig&#41;;
&gt; 
&gt; results in BADSIG Errors in BIND at server side.
&gt; 
&gt; using $tsig for signing update packets only with:
&gt; 
&gt; my $update = Net::DNS::Update-&gt;new&#40; ... &#41;;
&gt; $update-&gt;sign_tsig&#40;$tsig&#41;;
&gt; 
</div>These probably fail because the key is not properly defined in the BIND config file.  But this is a needlessly difficult way of getting your query packets or updates signed.

 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; What is the correct way to use tsig for both
&gt; query and update packets in Net::DNS &gt;= V0.74 ?
</div>
There is rarely any need to handle TSIG records directly.  The resolver-&gt;tsig method now accepts the filename of a key generated using the dnssec-keygen program which comes with BIND.

 use Net::DNS;
 my $resolver = new Net::DNS::Resolver&#40; debug =&gt; 1, nameservers =&gt; [&#39;127.0.0.1&#39;] &#41;;

 my $key = &#39;keypath/Khmac-sha1.example.+161+39562.private&#39;;
 $resolver-&gt;tsig&#40;$key&#41;;

 my $query = new Net::DNS::Packet&#40; &#39;www.example.com&#39;, &#39;A&#39; &#41;;
 my $reply = $resolver-&gt;send&#40;$query&#41;;
 my $verified = $reply-&gt;verify&#40;$query&#41;;
 print &#34;*** reply &#34;, $verified ? &#34;verified&#34; : &#34;not verified&#34;, &#34; ***\n&#34;;

It is _very_ important that the filename created by dnssec-keygen is not changed.

The examples above have been tested using Net::DNS 0.75 and later. There is no support for automatic signing in 0.74 and earlier. The latest version is 0.82.

--Dick
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;17&nbsp;22:36:06&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;18&nbsp;01:36:12&nbsp;2015</span>
    <span class="description">nrittner [...] layer23.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #102131] calling &#34;tsig&#34; method on resolver object results in error</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 18 Feb 2015 07:35:47 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Nico Rittner &lt;nrittner [...] layer23.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am 18.02.2015 um 04:36 schrieb Dick Franks via RT:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The world has moved on a long way since then!
</div>
hello,

after upgrading to version 0.82 everything works
as expected &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://dict.leo.org/#/search=expected&#38;searchLoc=0&#38;resultOrder=basic&#38;multiwordShowSingle=on&gt;">http://dict.leo.org/#/search=expected&#38;searchLoc=0&#38;resultOrder=basic&#38;multiwordShowSingle=on&gt;</a></span>. see this thread on stackoverflow:

<span class="clickylink"><a target="new" rel="nofollow" href="http://stackoverflow.com/questions/28538858/perl-module-netdns-calling-tsig-method-on-resolver-object-results-in-error">http://stackoverflow.com/questions/28538858/perl-module-netdns-calling-tsig-method-on-resolver-object-results-in-error</a></span>

thanks a lot!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;18&nbsp;06:09:50&nbsp;2015</span>
    <span class="description">NLNETLABS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
