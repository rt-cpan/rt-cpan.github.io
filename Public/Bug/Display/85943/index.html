<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #85943 for Wx: utf8 handling bug</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #85943 for Wx: utf8 handling bug</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Wx/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Wx/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Wx/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Wx/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Wx">Wx CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">85943</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Wx/Active/">Wx</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jiri [...] pavlovsky.eu

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-36684-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-36685-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;07&nbsp;05:09:50&nbsp;2013</span>
    <span class="description">jiri [...] pavlovsky.eu -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> utf8 handling bug</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 07 Jun 2013 11:09:26 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Wx [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jiří Pavlovský &lt;jiri [...] pavlovsky.eu&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I had a following problem:

I pass an array of object with stringification overload. Combobox
displays stringified values and returns selected object. Works great
unless the stringified value contains accented characters.  Then the
displayed value is messed up.

I thought I located the problem to a bug in stringification/utf8 and
reported it to perl-bug.

But I got a reply suggesting it&#39;s a bug in Wx::Perl. See for details below:

I think this is a bug in Wx::Perl.

I just downloaded Wx-0.9922 from CPAN and did a quick scan. 
cpp/helpers.cpp contains this, which I assume is a utility function used
by various parts of Wx::Perl:

#if wxUSE_UNICODE
static wxChar* wxPli_copy_string&#40; SV* scalar, wxChar** &#41;
{
    dTHX;
    STRLEN length;
    wxWCharBuffer tmp = &#40; SvUTF8&#40; scalar &#41; &#41; ?
      wxConvUTF8.cMB2WX&#40; SvPVutf8&#40; scalar, length &#41; &#41; :
      wxWCharBuffer&#40; wxString&#40; SvPV&#40; scalar, length &#41;,
                               wxConvLocal &#41;.wc_str&#40;&#41; &#41;;
    
    wxChar* buffer = new wxChar[length + 1];
    memcpy&#40; buffer, tmp.data&#40;&#41;, length * sizeof&#40;wxChar&#41; &#41;;
    buffer[length] = wxT&#40;&#39;\0&#39;&#41;;
    return buffer;
}
#endif

Checking SvUTF8&#40;scalar&#41; before any stringification is incorrect.  What
it should be doing is something like this:

    dTHX;
    STRLEN length;
    char * const s = SvPV&#40; scalar, length &#41;;
    wxWCharBuffer tmp = &#40; SvUTF8&#40; scalar &#41; &#41; ?
      wxConvUTF8.cMB2WX&#40; s &#41; :
      wxWCharBuffer&#40; wxString&#40; s,
                               wxConvLocal &#41;.wc_str&#40;&#41; &#41;;

I don’t know what the wxConvLocal does, but if it does anything other
than treat the string as Latin1, then that is also incorrect, and this
would be better:

    dTHX;
    STRLEN length;
    wxWCharBuffer tmp =
      wxConvUTF8.cMB2WX&#40; SvPVutf8&#40; scalar, length &#41; &#41;;


This aspect of SvUTF8 is nothing new, as has been documented since 2006
&#40;commit cd028baaa4&#41;:

       SvUTF8  Returns a U32 value indicating the UTF-8 status of an SV.  If
               things are set-up properly, this indicates whether or not the
               SV contains UTF-8 encoded data.  You should use this after a
               call to SvPV&#40;&#41; or one of its variants, in case any call to
               string overloading updates the internal flag.

&#40;The current wording is of recent provenance and comes from commit
fd1423831.&#41;

I don’t know enough about Wx to write a test case, so could you report
this to bug-Wx@rt.cpan.org?



-- 
Jiří Pavlovský
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;07&nbsp;09:44:56&nbsp;2013</span>
    <span class="description">mdootson [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #85943] utf8 handling bug</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 07 Jun 2013 14:44:26 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Wx [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mdootson &lt;mdootson [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Thanks for the report.
wxPli_copy_string is used in one place only and that is parsing command 
line arguments during wxWidgets initialisation.

So, unless you are passing in your values on the command line, this 
particular helper function cannot be your problem.

Recently I did look at some of the wxPerl utf8 handling and after some 
help on the wxPerl mailing list implemented a change for Wx 0.9922. One 
thing that was made clear during the process is that the Perl docs 
concerning utf8 handling are confused and in some places simply wrong.

That being the case, I think I need clear test cases to demonstrate any 
utf8 related bug that I can then test / fix.

For information, the code that converts your text for use by wxWidgets 
is the macro WXSTRING_INPUT which is in  cpp/helpers.h at line
78 or 109 in the Wx 0.9922 source.

Note that this changed for version Wx 0.9922. In previous versions the 
code looked more like your example from wxPli_copy_string.

If I understand your report, are you saying that if an array of values 
passed to a Wx::ComboBox constructor contains members with valid UTF-8 
and multi-byte characters, these characters are displayed incorrectly?

If yes, I can construct my own test case for this. If not, I&#39;ll probably 
need some code from you that demonstrates the problem.

Regards

Mark

On 07/06/2013 10:09, Jiří Pavlovský via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Fri Jun 07 05:09:50 2013: Request 85943 was acted upon.
&gt; Transaction: Ticket created by jiri@pavlovsky.eu
&gt;         Queue: Wx
&gt;       Subject: utf8 handling bug
&gt;     Broken in: &#40;no value&#41;
&gt;      Severity: &#40;no value&#41;
&gt;         Owner: Nobody
&gt;    Requestors: jiri@pavlovsky.eu
&gt;        Status: new
&gt;   Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=85943">https://rt.cpan.org/Ticket/Display.html?id=85943</a></span> &gt;
&gt;
&gt;
&gt; Hi,
&gt;
&gt; I had a following problem:
&gt;
&gt; I pass an array of object with stringification overload. Combobox
&gt; displays stringified values and returns selected object. Works great
&gt; unless the stringified value contains accented characters.  Then the
&gt; displayed value is messed up.
&gt;
&gt; I thought I located the problem to a bug in stringification/utf8 and
&gt; reported it to perl-bug.
&gt;
&gt; But I got a reply suggesting it&#39;s a bug in Wx::Perl. See for details below:
&gt;
&gt; I think this is a bug in Wx::Perl.
&gt;
&gt; I just downloaded Wx-0.9922 from CPAN and did a quick scan.
&gt; cpp/helpers.cpp contains this, which I assume is a utility function used
&gt; by various parts of Wx::Perl:
&gt;
&gt; #if wxUSE_UNICODE
&gt; static wxChar* wxPli_copy_string&#40; SV* scalar, wxChar** &#41;
&gt; {
&gt;      dTHX;
&gt;      STRLEN length;
&gt;      wxWCharBuffer tmp = &#40; SvUTF8&#40; scalar &#41; &#41; ?
&gt;        wxConvUTF8.cMB2WX&#40; SvPVutf8&#40; scalar, length &#41; &#41; :
&gt;        wxWCharBuffer&#40; wxString&#40; SvPV&#40; scalar, length &#41;,
&gt;                                 wxConvLocal &#41;.wc_str&#40;&#41; &#41;;
&gt;
&gt;      wxChar* buffer = new wxChar[length + 1];
&gt;      memcpy&#40; buffer, tmp.data&#40;&#41;, length * sizeof&#40;wxChar&#41; &#41;;
&gt;      buffer[length] = wxT&#40;&#39;\0&#39;&#41;;
&gt;      return buffer;
&gt; }
&gt; #endif
&gt;
&gt; Checking SvUTF8&#40;scalar&#41; before any stringification is incorrect.  What
&gt; it should be doing is something like this:
&gt;
&gt;      dTHX;
&gt;      STRLEN length;
&gt;      char * const s = SvPV&#40; scalar, length &#41;;
&gt;      wxWCharBuffer tmp = &#40; SvUTF8&#40; scalar &#41; &#41; ?
&gt;        wxConvUTF8.cMB2WX&#40; s &#41; :
&gt;        wxWCharBuffer&#40; wxString&#40; s,
&gt;                                 wxConvLocal &#41;.wc_str&#40;&#41; &#41;;
&gt;
&gt; I don’t know what the wxConvLocal does, but if it does anything other
&gt; than treat the string as Latin1, then that is also incorrect, and this
&gt; would be better:
&gt;
&gt;      dTHX;
&gt;      STRLEN length;
&gt;      wxWCharBuffer tmp =
&gt;        wxConvUTF8.cMB2WX&#40; SvPVutf8&#40; scalar, length &#41; &#41;;
&gt;
&gt;
&gt; This aspect of SvUTF8 is nothing new, as has been documented since 2006
&gt; &#40;commit cd028baaa4&#41;:
&gt;
&gt;         SvUTF8  Returns a U32 value indicating the UTF-8 status of an SV.  If
&gt;                 things are set-up properly, this indicates whether or not the
&gt;                 SV contains UTF-8 encoded data.  You should use this after a
&gt;                 call to SvPV&#40;&#41; or one of its variants, in case any call to
&gt;                 string overloading updates the internal flag.
&gt;
&gt; &#40;The current wording is of recent provenance and comes from commit
&gt; fd1423831.&#41;
&gt;
&gt; I don’t know enough about Wx to write a test case, so could you report
&gt; this to bug-Wx@rt.cpan.org?
&gt;
&gt;
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;07&nbsp;09:44:56&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
