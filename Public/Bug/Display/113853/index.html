<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #113853 for Unix-Uptime: Race condition in t/003-load.t</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #113853 for Unix-Uptime: Race condition in t/003-load.t</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Unix-Uptime">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Unix-Uptime">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Unix-Uptime">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Unix-Uptime">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Unix-Uptime">Unix-Uptime CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">113853</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Unix-Uptime">Unix-Uptime</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
SREZIC [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-225056-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.4000    </td>
  </tr>
  <tr id="CF-225057-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




0001-avoid-race-condition-in-load-average-test-RT-113853.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1618592/866606/0001-avoid-race-condition-in-load-average-test-RT-113853.patch">
Mon Apr 18 03:37:41 2016 (1.4k) by SREZIC [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=113853">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1618589" href="/Public/Bug/Display.html?id=113853#txn-1618589">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;18&nbsp;03:33:42&nbsp;2016</span>
    <span class="description">SREZIC [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Race condition in t/003-load.t</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1618589/866601/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/866601">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 816b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">One of my smoker machines reported the following failure:

#   Failed test at t/003-load.t line 19.
#          got: &#39;3.16&#39;
#     expected: &#39;3.06&#39;

#   Failed test at t/003-load.t line 20.
#          got: &#39;6.00&#39;
#     expected: &#39;5.94&#39;
# Looks like you failed 2 tests of 9.
t/003-load.t .......... 
Dubious, test returned 2 &#40;wstat 512, 0x200&#41;
Failed 2/9 subtests 

Looking at CPAN Testers results, it seems that this failure happens occasionally also on other systems: <span class="clickylink"><a target="new" rel="nofollow" href="http://matrix.cpantesters.org/?dist=Unix-Uptime%200.4000">http://matrix.cpantesters.org/?dist=Unix-Uptime%200.4000</a></span>

I think we see a race condition in t/003-load.t: you take the load averages twice, first through the perl module and then using the system command. Unfortunately time passes in between and the load average information may be updated when using the system command, so the values may differ.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1618592" href="/Public/Bug/Display.html?id=113853#txn-1618592">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;18&nbsp;03:37:41&nbsp;2016</span>
    <span class="description">SREZIC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1618592/866605/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/866605">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 925b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2016-04-18 03:33:42, SREZIC wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; One of my smoker machines reported the following failure:
&gt; 
&gt; #   Failed test at t/003-load.t line 19.
&gt; #          got: &#39;3.16&#39;
&gt; #     expected: &#39;3.06&#39;
&gt; 
&gt; #   Failed test at t/003-load.t line 20.
&gt; #          got: &#39;6.00&#39;
&gt; #     expected: &#39;5.94&#39;
&gt; # Looks like you failed 2 tests of 9.
&gt;  t/003-load.t ..........
&gt; Dubious, test returned 2 &#40;wstat 512, 0x200&#41;
&gt;  Failed 2/9 subtests
&gt; 
&gt; Looking at CPAN Testers results, it seems that this failure happens
&gt; occasionally also on other systems:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://matrix.cpantesters.org/?dist=Unix-Uptime%200.4000">http://matrix.cpantesters.org/?dist=Unix-Uptime%200.4000</a></span>
&gt; 
&gt; I think we see a race condition in t/003-load.t: you take the load
&gt; averages twice, first through the perl module and then using the
&gt; system command. Unfortunately time passes in between and the load
&gt; average information may be updated when using the system command, so
&gt; the values may differ.
</div>
Attached a possible fix.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-avoid-race-condition-in-load-average-test-RT-113853.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1618592/866606/0001-avoid-race-condition-in-load-average-test-RT-113853.patch">Download 0001-avoid-race-condition-in-load-average-test-RT-113853.patch</a><br />
<span class="downloadcontenttype">text/x-diff 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">From f82703b9e3cb8fb03fd2331e6739cc86b59b812e Mon Sep 17 00:00:00 2001
From: Slaven Rezic &lt;slaven@rezic.de&gt;
Date: Mon, 18 Apr 2016 09:36:48 +0200
Subject: [PATCH] avoid race condition in load average test &#40;RT #113853&#41;

---
 t/003-load.t | 16 +++++++++++-----
 1 file changed, 11 insertions&#40;+&#41;, 5 deletions&#40;-&#41;

diff --git a/t/003-load.t b/t/003-load.t
index 19196c8..6889765 100644
--- a/t/003-load.t
+++ b/t/003-load.t
@@ -2,20 +2,26 @@
 use warnings;
 use strict;
 
-use Test::More tests =&gt; 9;
+use Test::More tests =&gt; 6;
 
 use Unix::Uptime;
 
 $ENV{LC_ALL} = &#39;C&#39;;
 
-ok my &#40;$load1, $load5, $load15&#41; = Unix::Uptime-&gt;load&#40;&#41;, &#39;received a load avarage&#39;;
+my &#40;$load1, $load5, $load15&#41;;
+my &#40;$pload1, $pload5, $pload15&#41;;
+
+for &#40;1..2&#41; {
+    &#40;$load1, $load5, $load15&#41; = Unix::Uptime-&gt;load&#40;&#41;;
+    my $pretty_uptime = `uptime`;
+    &#40;$pload1, $pload5, $pload15&#41; = $pretty_uptime =~ /load\s+averages?:\s+&#40;\d+\.?\d*&#41;,?\s+&#40;\d+\.?\d*&#41;,?\s+&#40;\d+\.?\d*&#41;/i;
+    last if &#40;$load1 == $pload1 &#38;&#38; $load5 == $pload5 &#38;&#38; $load15 == $pload15&#41;;
+}
+
 like $load1, qr/^\d+&#40;\.\d+&#41;?$/, &#39;load1 looks right&#39;;
 like $load5, qr/^\d+&#40;\.\d+&#41;?$/, &#39;load5 looks right&#39;;
 like $load15, qr/^\d+&#40;\.\d+&#41;?$/, &#39;load15 looks right&#39;;
 
-ok my $pretty_uptime = `uptime`;
-ok my &#40;$pload1, $pload5, $pload15&#41; = $pretty_uptime =~ /load\s+averages?:\s+&#40;\d+\.?\d*&#41;,?\s+&#40;\d+\.?\d*&#41;,?\s+&#40;\d+\.?\d*&#41;/i
-    or diag &#34;\$ uptime\n$pretty_uptime&#34;;
 is $load1, $pload1;
 is $load5, $pload5;
 is $load15, $pload15;
-- 
2.1.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1618765" href="/Public/Bug/Display.html?id=113853#txn-1618765">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;18&nbsp;06:57:28&nbsp;2016</span>
    <span class="description">PIOTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1618765/866718/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/866718">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Apr 18 03:37:41 2016, SREZIC wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 2016-04-18 03:33:42, SREZIC wrote:
<div class="message-stanza open">&gt; &gt; One of my smoker machines reported the following failure:
&gt; &gt; 
&gt; &gt; #   Failed test at t/003-load.t line 19.
&gt; &gt; #          got: &#39;3.16&#39;
&gt; &gt; #     expected: &#39;3.06&#39;
&gt; &gt; 
&gt; &gt; #   Failed test at t/003-load.t line 20.
&gt; &gt; #          got: &#39;6.00&#39;
&gt; &gt; #     expected: &#39;5.94&#39;
&gt; &gt; # Looks like you failed 2 tests of 9.
&gt; &gt;  t/003-load.t ..........
&gt; &gt; Dubious, test returned 2 &#40;wstat 512, 0x200&#41;
&gt; &gt;  Failed 2/9 subtests
&gt; &gt; 
&gt; &gt; Looking at CPAN Testers results, it seems that this failure happens
&gt; &gt; occasionally also on other systems:
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://matrix.cpantesters.org/?dist=Unix-Uptime%200.4000">http://matrix.cpantesters.org/?dist=Unix-Uptime%200.4000</a></span>
&gt; &gt; 
&gt; &gt; I think we see a race condition in t/003-load.t: you take the load
&gt; &gt; averages twice, first through the perl module and then using the
&gt; &gt; system command. Unfortunately time passes in between and the load
&gt; &gt; average information may be updated when using the system command, so
&gt; &gt; the values may differ.
</div>&gt; 
&gt; Attached a possible fix.
</div>
Unfortunately, while I agree that there are problems with the current test, and I&#39;ve seen the failures you&#39;ve mentioned, I think that your change weakens the confidence that the tests give me that I&#39;m actually doing something sensible. Now it&#39;s just checking that the code spits out the same numbers twice in a row.

I&#39;d rather have something like a &#34;fuzzy match&#34; against the values parsed from `uptime`... perhaps some sort of &#34;equals, plus or minus 1.0&#34; test could help improve the situation instead?

Anyways, this reminds me that I need up update the bugtracker metadata on this module... at this point, I&#39;d rather have bugs &#38; pull requests submitted on GitHub: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/pioto/Unix-Uptime">https://github.com/pioto/Unix-Uptime</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1618766" href="/Public/Bug/Display.html?id=113853#txn-1618766">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;18&nbsp;06:57:28&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1618882" href="/Public/Bug/Display.html?id=113853#txn-1618882">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;18&nbsp;14:50:11&nbsp;2016</span>
    <span class="description">SREZIC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1618882/866789/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/866789">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2016-04-18 06:57:28, PIOTO wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Apr 18 03:37:41 2016, SREZIC wrote:
<div class="message-stanza open">&gt; &gt; On 2016-04-18 03:33:42, SREZIC wrote:
<div class="message-stanza open">&gt; &gt; &gt; One of my smoker machines reported the following failure:
&gt; &gt; &gt;
&gt; &gt; &gt; #   Failed test at t/003-load.t line 19.
&gt; &gt; &gt; #          got: &#39;3.16&#39;
&gt; &gt; &gt; #     expected: &#39;3.06&#39;
&gt; &gt; &gt;
&gt; &gt; &gt; #   Failed test at t/003-load.t line 20.
&gt; &gt; &gt; #          got: &#39;6.00&#39;
&gt; &gt; &gt; #     expected: &#39;5.94&#39;
&gt; &gt; &gt; # Looks like you failed 2 tests of 9.
&gt; &gt; &gt;  t/003-load.t ..........
&gt; &gt; &gt; Dubious, test returned 2 &#40;wstat 512, 0x200&#41;
&gt; &gt; &gt;  Failed 2/9 subtests
&gt; &gt; &gt;
&gt; &gt; &gt; Looking at CPAN Testers results, it seems that this failure happens
&gt; &gt; &gt; occasionally also on other systems:
&gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://matrix.cpantesters.org/?dist=Unix-Uptime%200.4000">http://matrix.cpantesters.org/?dist=Unix-Uptime%200.4000</a></span>
&gt; &gt; &gt;
&gt; &gt; &gt; I think we see a race condition in t/003-load.t: you take the load
&gt; &gt; &gt; averages twice, first through the perl module and then using the
&gt; &gt; &gt; system command. Unfortunately time passes in between and the load
&gt; &gt; &gt; average information may be updated when using the system command,
&gt; &gt; &gt; so
&gt; &gt; &gt; the values may differ.
</div>&gt; &gt;
&gt; &gt; Attached a possible fix.
</div>&gt; 
&gt; Unfortunately, while I agree that there are problems with the current
&gt; test, and I&#39;ve seen the failures you&#39;ve mentioned, I think that your
&gt; change weakens the confidence that the tests give me that I&#39;m actually
&gt; doing something sensible. Now it&#39;s just checking that the code spits
&gt; out the same numbers twice in a row.
</div>
This is not what the change does. The condition within the loop does a &#34;pre-check&#34; if the values returned by the system command and by Unix::Uptime are the same. If they are, then the loop will be prematurely ended and after that six of your unaltered test cases are run.

Three test cases were removed, but I think these are not really needed:
* the check that Unix::Uptime-&gt;load&#40;&#41; returns a non-empty list --- the test script will fail anyway if any of $load1..$load15 are missing &#40;because of the floating number check&#41;
* the checks that the system uptime returns anything and may be correctly parsed --- if these would fail, then the later &#34;is $load1, $pload1&#34; etc. checks would also fail.

And what if the condition in the loop is false? Then uptime and Unix::Uptime are immediately called again. My assumption is that load averages are calculated not so often, and <span class="clickylink"><a target="new" rel="nofollow" href="https://en.wikipedia.org/wiki/Load_%28computing%29#Reckoning_CPU_load">https://en.wikipedia.org/wiki/Load_%28computing%29#Reckoning_CPU_load</a></span> says it happens every five seconds on typical linux systems, which I can confirm on a linux and a non-linux &#40;freebsd&#41; system. So if the two calls happen within five seconds of the last call, then the values should be the same. This should be enough even on loaded/slow systems.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;d rather have something like a &#34;fuzzy match&#34; against the values
&gt; parsed from `uptime`... perhaps some sort of &#34;equals, plus or minus
&gt; 1.0&#34; test could help improve the situation instead?
</div>
+/-1.0 would make a big difference if it&#39;s 0.0 vs 1.0 on a single-cpu system. On the other hand, on multi-cpu machines it&#39;s possible that the load average drops/increases by a larger delta within five seconds.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Anyways, this reminds me that I need up update the bugtracker metadata
&gt; on this module... at this point, I&#39;d rather have bugs &#38; pull requests
&gt; submitted on GitHub: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/pioto/Unix-Uptime">https://github.com/pioto/Unix-Uptime</a></span>
</div>
&#34;git am 0001-avoid-race-condition-in-load-average-test-RT-113853.patch&#34; will give you a git commit with full attribution.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.237864</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
