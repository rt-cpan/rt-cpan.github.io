<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #86744 for DBI: Possible memory corruption when using execute callback and _many_ params</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #86744 for DBI: Possible memory corruption when using execute callback and _many_ params</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBI/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBI/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBI/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBI/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBI">DBI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">86744</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBI/Active/">DBI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
OSCHWALD [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
pali [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10328-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.627    </td>
  </tr>
  <tr id="CF-10329-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;05&nbsp;18:35:48&nbsp;2013</span>
    <span class="description">OSCHWALD [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Possible memory corruption when using execute callback and _many_
 params</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">When updating some code at work, I ran into an issue where any callback on an execute with _many_ params will cause DBI to fail. The output is:

SV = PV&#40;0x1b9f150&#41; at 0x1ba0de8
  REFCNT = 1
  FLAGS = &#40;POK,pPOK&#41;
  PV = 0x1bd2f50 &#34;test&#34;\0
  CUR = 4
  LEN = 16
Invalid DBI handle &#39;test&#39; at test-case.pl line 302.

I have attached a simplified script that exhibits the issue. If I remove the callback, it works fine. It also seems to work fine when someone uses a sane number of params.

This happens with both the MySQL and Pg drivers, which leads me to believe that the issue is with DBI itself.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test-case.pl</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;07&nbsp;21:21:02&nbsp;2013</span>
    <span class="description">OSCHWALD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am attaching a more readable test case that takes the number of params as an argument. The issue seems to start at 2046 params for me, which is obviously near 2^11. With some values, I get segmentation faults rather than the error I included in my first message.

I am using Perl 5.16.3, and I tested it on multiple machines with both the MySQL and Pg drivers. Please let me know if you need any other information.

Here is the output of &#39;perl -V&#39; on my home box:

Summary of my perl5 &#40;revision 5 version 16 subversion 3&#41; configuration:
   
  Platform:
    osname=linux, osvers=3.5.0-26-generic, archname=x86_64-linux
    uname=&#39;linux godesk 3.5.0-26-generic #40-ubuntu smp tue feb 26 19:57:24 utc 2013 x86_64 x86_64 x86_64 gnulinux &#39;
    config_args=&#39;-de -Dprefix=/home/greg/perl5/perlbrew/perls/perl-5.16.2 -Aeval:scriptdir=/home/greg/perl5/perlbrew/perls/perl-5.16.2/bin&#39;
    hint=recommended, useposix=true, d_sigaction=define
    useithreads=undef, usemultiplicity=undef
    useperlio=define, d_sfio=undef, uselargefiles=define, usesocks=undef
    use64bitint=define, use64bitall=define, uselongdouble=undef
    usemymalloc=n, bincompat5005=undef
  Compiler:
    cc=&#39;cc&#39;, ccflags =&#39;-fno-strict-aliasing -pipe -fstack-protector -I/usr/local/include -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64&#39;,
    optimize=&#39;-O2&#39;,
    cppflags=&#39;-fno-strict-aliasing -pipe -fstack-protector -I/usr/local/include&#39;
    ccversion=&#39;&#39;, gccversion=&#39;4.7.2&#39;, gccosandvers=&#39;&#39;
    intsize=4, longsize=8, ptrsize=8, doublesize=8, byteorder=12345678
    d_longlong=define, longlongsize=8, d_longdbl=define, longdblsize=16
    ivtype=&#39;long&#39;, ivsize=8, nvtype=&#39;double&#39;, nvsize=8, Off_t=&#39;off_t&#39;, lseeksize=8
    alignbytes=8, prototype=define
  Linker and Libraries:
    ld=&#39;cc&#39;, ldflags =&#39; -fstack-protector -L/usr/local/lib&#39;
    libpth=/usr/local/lib /lib/x86_64-linux-gnu /lib/../lib /usr/lib/x86_64-linux-gnu /usr/lib/../lib /lib /usr/lib
    libs=-lnsl -ldb -ldl -lm -lcrypt -lutil -lc
    perllibs=-lnsl -ldl -lm -lcrypt -lutil -lc
    libc=, so=so, useshrplib=false, libperl=libperl.a
    gnulibc_version=&#39;2.15&#39;
  Dynamic Linking:
    dlsrc=dl_dlopen.xs, dlext=so, d_dlsymun=undef, ccdlflags=&#39;-Wl,-E&#39;
    cccdlflags=&#39;-fPIC&#39;, lddlflags=&#39;-shared -O2 -L/usr/local/lib -fstack-protector&#39;


Characteristics of this binary &#40;from libperl&#41;: 
  Compile-time options: HAS_TIMES PERLIO_LAYERS PERL_DONT_CREATE_GVSV
                        PERL_MALLOC_WRAP PERL_PRESERVE_IVUV USE_64_BIT_ALL
                        USE_64_BIT_INT USE_LARGE_FILES USE_LOCALE
                        USE_LOCALE_COLLATE USE_LOCALE_CTYPE
                        USE_LOCALE_NUMERIC USE_PERLIO USE_PERL_ATOF
  Built under linux
  Compiled at Mar 12 2013 20:14:20
  %ENV:
    PERLBREW_BASHRC_VERSION=&#34;0.59&#34;
    PERLBREW_HOME=&#34;/home/greg/.perlbrew&#34;
    PERLBREW_MANPATH=&#34;/home/greg/perl5/perlbrew/perls/perl-5.16.2/man&#34;
    PERLBREW_PATH=&#34;/home/greg/perl5/perlbrew/bin:/home/greg/perl5/perlbrew/perls/perl-5.16.2/bin&#34;
    PERLBREW_PERL=&#34;perl-5.16.2&#34;
    PERLBREW_ROOT=&#34;/home/greg/perl5/perlbrew&#34;
    PERLBREW_VERSION=&#34;0.59&#34;
  @INC:
    /home/greg/perl5/perlbrew/perls/perl-5.16.2/lib/site_perl/5.16.3/x86_64-linux
    /home/greg/perl5/perlbrew/perls/perl-5.16.2/lib/site_perl/5.16.3
    /home/greg/perl5/perlbrew/perls/perl-5.16.2/lib/5.16.3/x86_64-linux
    /home/greg/perl5/perlbrew/perls/perl-5.16.2/lib/5.16.3
    /home/greg/perl5/perlbrew/perls/perl-5.16.2/lib/site_perl/5.16.2/x86_64-linux
    /home/greg/perl5/perlbrew/perls/perl-5.16.2/lib/site_perl/5.16.2
    /home/greg/perl5/perlbrew/perls/perl-5.16.2/lib/site_perl
    .
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test-case.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use warnings;
use strict;

use DBI;

my $count = $ARGV[0];

my $place_holders = join&#40;&#39;,&#39;, &#40;&#39;?&#39;&#41; x $count&#41;;

my $sql = &lt;&lt;&#34;EOF&#34;;
SELECT   *
FROM     information_schema.tables
WHERE    table_schema IN &#40; $place_holders&#41;
EOF

my @params = &#40;&#39;test&#39;&#41; x $count;

my $dbh = DBI-&gt;connect&#40;
    &#39;DBI:mysql:test&#39;,
    q{}, q{},
    {
        Callbacks =&gt; {
            ChildCallbacks =&gt; {
                execute =&gt; sub { return; }
            }
        }
    }
&#41;;

my $sth = $dbh-&gt;prepare&#40;$sql&#41;;
$sth-&gt;execute&#40;@params&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;08&nbsp;10:21:58&nbsp;2013</span>
    <span class="description">OSCHWALD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Also attaching a stack trace and a core dump.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> core</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> strace</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction other SystemError even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;08&nbsp;10:22:08&nbsp;2013</span>
    <span class="description">The RT System itself -  System error</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sending the previous mail has failed.  Please contact your admin, they can find more details in the logs.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other SystemError odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;08&nbsp;10:22:12&nbsp;2013</span>
    <span class="description">The RT System itself -  System error</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sending the previous mail has failed.  Please contact your admin, they can find more details in the logs.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;22&nbsp;08:04:14&nbsp;2013</span>
    <span class="description">TIMB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think this is fixed in DBI 1.628
&#40;The change notes says Fixed stack corruption on callbacks RT#85562 RT#84974 [Aaron Schweiger]&#41;
Could you retest?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;22&nbsp;08:04:15&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;22&nbsp;08:04:15&nbsp;2013</span>
    <span class="description">TIMB [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;23&nbsp;09:27:53&nbsp;2013</span>
    <span class="description">OSCHWALD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am still experiencing this when using 1.628.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;23&nbsp;09:27:54&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;22&nbsp;16:53:33&nbsp;2020</span>
    <span class="description">pali [...] cpan.org -  Cc PALI added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;22&nbsp;16:58:52&nbsp;2020</span>
    <span class="description">pali [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jul 05 18:35:48 2013, OSCHWALD wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; When updating some code at work, I ran into an issue where any
&gt; callback on an execute with _many_ params will cause DBI to fail. The
&gt; output is:
&gt; 
&gt; SV = PV&#40;0x1b9f150&#41; at 0x1ba0de8
&gt;   REFCNT = 1
&gt;   FLAGS = &#40;POK,pPOK&#41;
&gt;   PV = 0x1bd2f50 &#34;test&#34;\0
&gt;   CUR = 4
&gt;   LEN = 16
&gt; Invalid DBI handle &#39;test&#39; at test-case.pl line 302.
&gt; 
&gt; I have attached a simplified script that exhibits the issue. If I
&gt; remove the callback, it works fine. It also seems to work fine when
&gt; someone uses a sane number of params.
&gt; 
&gt; This happens with both the MySQL and Pg drivers, which leads me to
&gt; believe that the issue is with DBI itself.
</div>
Looks like this is a same problem as which I had: When custom callback set in <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/DBI#HandleError">https://metacpan.org/pod/DBI#HandleError</a></span> is called by DBI, it triggered memory corruption. When I removed callback then problem disappeared.

I debugged my problem and prepared a pull request with fix:
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/perl5-dbi/dbi/pull/85">https://github.com/perl5-dbi/dbi/pull/85</a></span>

Everytime when DBI called external Perl callback and Perl needed to reallocate stack, then memory corruption occured and DBI either crashed or overwritten some random Perl variable on stack. Seems that this problem matches your description.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
