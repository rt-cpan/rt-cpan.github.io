<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #57337 for Mail-IMAPClient: Correctly handle multiparts in BodyStructure.pm</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #57337 for Mail-IMAPClient: Correctly handle multiparts in BodyStructure.pm</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Mail-IMAPClient/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Mail-IMAPClient/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Mail-IMAPClient/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Mail-IMAPClient/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-IMAPClient">Mail-IMAPClient CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">57337</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Mail-IMAPClient/Active/">Mail-IMAPClient</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">PLOBBES [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ROBN [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-19960-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
3.03    </td>
  </tr>
  <tr id="CF-19961-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
3.25    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




2.2.9<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/775163/401440/2.2.9">
Mon May 10 16:37:57 2010 (1.7k) by ROBN [...] cpan.org
</a>
</font></li>
</ul>


3.23<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/775163/401441/3.23">
Mon May 10 16:37:57 2010 (2.2k) by ROBN [...] cpan.org
</a>
</font></li>
</ul>


3.24<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/775163/401439/3.24">
Mon May 10 16:37:57 2010 (2.1k) by ROBN [...] cpan.org
</a>
</font></li>
</ul>


3.24+57337<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/775163/401438/3.24%2B57337">
Mon May 10 16:37:57 2010 (2.1k) by ROBN [...] cpan.org
</a>
</font></li>
</ul>


bodystructure-fix.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/774888/401268/bodystructure-fix.diff">
Mon May 10 04:04:06 2010 (7k) by ROBN [...] cpan.org
</a>
</font></li>
</ul>


bodystructure.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/775163/401442/bodystructure.pl">
Mon May 10 16:37:57 2010 (15.2k) by ROBN [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;10&nbsp;04:04:06&nbsp;2010</span>
    <span class="description">ROBN [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Correctly handle multiparts in BodyStructure.pm</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The changes to BodyStructure.pm in 3.24 almost fixed the longstanding
issues with part numbers returned by parts&#40;&#41; and bodystructure&#40;&#41; not
correctly matching the part numbers accepted by FETCH. One of the
changes made in 3.24 isn&#39;t quite right though, so it still isn&#39;t working
properly Attached patch fixes it.

The short of it is that a MULTIPART should only be removed from the tree
if its the first and direct child of a MESSAGE. I&#39;m no expert, I base
this on the one vague example in RFC3501 and what I&#39;ve seen from my own
servers. This patch makes the output produced almost identical to what
was produced by BodyStructure.pm from IMAPClient 2.2.9. The part numbers
are the same, there&#39;s just some extra .TEXT parts.

As an aside, I think its reasonable to expect .MIME and .TEXT
pseudo-parts to be available all types of MESSAGEs, not just those with
a MULTIPART under them. This at least seems to work on the servers I
have access to. I&#39;m not sure if they should be exposed via
BodyStructure.pm though. Is there any better documentation available
than the vague mess in RFC3501?

Cheers,
Rob.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> bodystructure-fix.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/lib/Mail/IMAPClient/BodyStructure.pm b/lib/Mail/IMAPClient/BodyStructure.pm
index 4353d53..1420aa9 100644
--- a/lib/Mail/IMAPClient/BodyStructure.pm
+++ b/lib/Mail/IMAPClient/BodyStructure.pm
@@ -106,17 +106,23 @@ sub bodystructure
     my $prefix = $self-&gt;{_prefix} || &#34;&#34;;
     $prefix    =~ s/\.?$/./;
 
-    # in a multipart message each subpart is one level &#34;higher&#34;
-    $prefix =~ s/\.\d+\.$/./ if &#40;$self-&gt;{bodytype} eq &#39;MULTIPART&#39;&#41;;
-
     foreach my $p &#40; @{$self-&gt;{bodystructure}} &#41;
     {   $partno++;
 
-        $p-&gt;{_prefix} = &#34;$prefix$partno&#34;;
-
-        # BUG?: old code didn&#39;t add .TEXT sections, should we skip these?
         my $pno = $partno;
-        $pno = &#34;TEXT&#34; if &#40;$partno == 1 and $self-&gt;{bodytype} eq &#39;MESSAGE&#39;&#41;;
+
+        # a message and the multipart inside of it &#34;collapse&#34; together
+        if &#40;$partno == 1 and $self-&gt;{bodytype} eq &#39;MESSAGE&#39; and $p-&gt;{bodytype} eq &#39;MULTIPART&#39;&#41; {
+            # BUG: I think every message should really have HEAD &#40;actually
+            # MIME&#41; and TEXT. at least dovecot and iplanet appear to allow
+            # this even for non-multipart sections. so this bit has to be
+            # generalised a little
+            $pno = &#34;TEXT&#34;;
+            $p-&gt;{_prefix} = &#34;$prefix&#34;;
+        }
+        else {
+            $p-&gt;{_prefix} = &#34;$prefix$partno&#34;;
+        }
         $p-&gt;{_id}   ||= &#34;$prefix$pno&#34;;
 
         push @parts, $p, $p-&gt;{bodystructure} ? $p-&gt;bodystructure : &#40;&#41;;
diff --git a/t/bodystructure.t b/t/bodystructure.t
index 3784356..e3c34b6 100644
--- a/t/bodystructure.t
+++ b/t/bodystructure.t
@@ -31,7 +31,9 @@ is&#40;
     #  this: &#34;1#2#2.HEAD#2.1#2.2#2.2.HEAD#2.2.1#2.2.1.1#2.2.1.2&#34;
     #  to:   &#34;1#2#2.HEAD#2.1#2.1.1#2.1.2#2.1.2.HEAD#2.1.2.1#2.1.2.1.1#2.1.2.1.1.1#2.1.2.1.1.2&#34;
     # Patches to BodyStructure.pm in 3.24 changed it to this:
-    &#34;1#2#2.HEAD#2.TEXT#2.1#2.2#2.2.HEAD#2.2.TEXT#2.2.1#2.2.1#2.2.2&#34;,
+    # &#34;1#2#2.HEAD#2.TEXT#2.1#2.2#2.2.HEAD#2.2.TEXT#2.2.1#2.2.1#2.2.2&#34;,
+    # Patches to BodyStructure.pm in 3.XX changed it to this:
+    &#34;1#2#2.HEAD#2.TEXT#2.1#2.2#2.2.HEAD#2.2.TEXT#2.2.1#2.2.1.1#2.2.1.2&#34;,
     &#39;parts&#39;
 &#41;;
 
@@ -67,8 +69,8 @@ is_deeply&#40; [ $bsobj-&gt;parts ], \@exp, &#39;bs5 parts&#39; &#41;
 my $bs6 = q{&#40;BODYSTRUCTURE &#40;&#40;&#34;text&#34; &#34;plain&#34; &#40;&#34;charset&#34; &#34;UTF-8&#34; &#34;format&#34; &#34;flowed&#34;&#41; NIL NIL &#34;8bit&#34; 82 6 NIL NIL NIL NIL&#41;&#40;&#34;message&#34; &#34;rfc822&#34; &#40;&#34;name&#34; &#34;this is internal letter.eml&#34;&#41; NIL NIL &#34;7bit&#34; 243436 &#40;&#34;Mon, 24 Aug 2009 10:51:22 +0400&#34; &#34;this is internal letter&#34; &#40;&#40;NIL NIL &#34;icestar&#34; &#34;inbox.ru&#34;&#41;&#41; &#40;&#40;NIL NIL &#34;icestar&#34; &#34;inbox.ru&#34;&#41;&#41; &#40;&#40;NIL NIL &#34;icestar&#34; &#34;inbox.ru&#34;&#41;&#41; &#40;&#40;NIL NIL &#34;dima&#34; &#34;adriver.ru&#34;&#41;&#41; NIL NIL NIL &#34;&lt;4A92386A.9080307@inbox.ru&gt;&#34;&#41; &#40;&#40;&#34;text&#34; &#34;plain&#34; &#40;&#34;charset&#34; &#34;UTF-8&#34; &#34;format&#34; &#34;flowed&#34;&#41; NIL NIL &#34;7bit&#34; 116 7 NIL NIL NIL NIL&#41;&#40;&#34;text&#34; &#34;xml&#34; &#40;&#34;name&#34; &#34;mediaplan.xml&#34; &#34;charset&#34; &#34;us-ascii&#34;&#41; NIL NIL &#34;base64&#34; 31412 424 NIL &#40;&#34;inline&#34; &#40;&#34;filename&#34; &#34;mediaplan.xml&#34;&#41;&#41; NIL NIL&#41;&#40;&#34;application&#34; &#34;zip&#34; &#40;&#34;name&#34; &#34;banners2.zip&#34;&#41; NIL NIL &#34;base64&#34; 209942 NIL &#40;&#34;inline&#34; &#40;&#34;filename&#34; &#34;banners2.zip&#34;&#41;&#41; NIL NIL&#41; &#34;mixed&#34; &#40;&#34;boundary&#34; &#34;------------070804080502030807020509&#34;&#41; NIL NIL NIL&#41; 3326 NIL &#40;&#34;inline&#34; &#40;&#34;filename&#34; &#34;this is internal letter.eml&#34;&#41;&#41; NIL NIL&#41; &#34;mixed&#34; &#40;&#34;boundary&#34; &#34;------------070704030806000803040203&#34;&#41; NIL NIL NIL&#41;&#41;};
 
 $bsobj = Mail::IMAPClient::BodyStructure-&gt;new&#40;$bs6&#41;;
-@exp   = qw&#40;1 2 2.HEAD 2.TEXT 2.1 2.2 2.3&#41;;
 ok&#40; defined $bsobj, &#39;parsed sixth&#39; &#41;;
+@exp   = qw&#40;1 2 2.HEAD 2.TEXT 2.1 2.2 2.3&#41;;
 is_deeply&#40; [ $bsobj-&gt;parts ], \@exp, &#39;bs6 parts&#39; &#41;
   or diag&#40; join&#40;&#34; &#34;, $bsobj-&gt;parts &#41; &#41;;
 
@@ -76,7 +78,7 @@ is_deeply&#40; [ $bsobj-&gt;parts ], \@exp, &#39;bs6 parts&#39; &#41;
 my $bs7 = q{&#40;BODYSTRUCTURE &#40;&#40;&#34;text&#34; &#34;plain&#34; &#40;&#34;charset&#34; &#34;us-ascii&#34;&#41; NIL NIL &#34;7bit&#34; 20 1 NIL NIL NIL NIL&#41;&#40;&#34;message&#34; &#34;rfc822&#34; NIL NIL NIL &#34;7bit&#34; 1810 &#40;&#34;Fri,07 May 2010 01:55:07 -0400&#34; &#34;wrap inner a&#34; &#40;&#40;&#34;Phil Pearl&#34; NIL &#34;phil&#34; &#34;perkpartners.com&#34;&#41;&#41; &#40;&#40;&#34;Phil Pearl&#34; NIL &#34;phil&#34; &#34;perkpartners.com&#34;&#41;&#41; &#40;&#40;&#34;Phil Pearl&#34; NIL &#34;phil&#34; &#34;perkpartners.com&#34;&#41;&#41; &#40;&#40;NIL NIL &#34;phil&#34; &#34;perkpartners.com&#34;&#41;&#41; NIL NIL NIL &#34;&lt;25015.1273211707@local&gt;&#34;&#41; &#40;&#40;&#34;text&#34; &#34;plain&#34; &#40;&#34;charset&#34; &#34;us-ascii&#34;&#41; NIL NIL &#34;7bit&#34; 27 3 NIL NIL NIL NIL&#41;&#40;&#34;message&#34; &#34;rfc822&#34; NIL NIL NIL &#34;7bit&#34; 783 &#40;&#34;Fri, 07 May 2010 01:54:14 -0400&#34; &#34;inner msg #1&#34; &#40;&#40;&#34;Phil Pearl&#34; NIL &#34;phil&#34; &#34;perkpartners.com&#34;&#41;&#41; &#40;&#40;&#34;Phil Pearl&#34; NIL &#34;phil&#34; &#34;perkpartners.com&#34;&#41;&#41; &#40;&#40;&#34;Phil Pearl&#34; NIL &#34;phil&#34; &#34;perkpartners.com&#34;&#41;&#41; &#40;&#40;NIL NIL &#34;phil&#34; &#34;perkpartners.com&#34;&#41;&#41; NIL NIL NIL &#34;&lt;24986.1273211654@local&gt;&#34;&#41; &#40;&#34;text&#34; &#34;plain&#34; &#40;&#34;charset&#34; &#34;us-ascii&#34;&#41; NIL NIL &#34;7bit&#34; 25 3 NIL NIL NIL NIL&#41; 23 NIL &#40;&#34;inline&#34; &#40;&#34;filename&#34; &#34;52&#34;&#41;&#41; NIL NIL&#41; &#34;mixed&#34; &#40;&#34;boundary&#34; &#34;=-=-=&#34;&#41; NIL NIL NIL&#41; 58 NIL &#40;&#34;inline&#34; &#40;&#34;filename&#34; &#34;53&#34;&#41;&#41; NIL NIL&#41; &#34;mixed&#34; &#40;&#34;boundary&#34;&#34;==-=-=&#34;&#41; NIL NIL NIL&#41;&#41;};
 
 $bsobj = Mail::IMAPClient::BodyStructure-&gt;new&#40;$bs7&#41;;
-@exp   = qw&#40;1 2 2.HEAD 2.TEXT 2.1 2.2 2.2.HEAD 2.2.TEXT&#41;;
+@exp   = qw&#40;1 2 2.HEAD 2.TEXT 2.1 2.2 2.2.HEAD 2.2.1&#41;;
 ok&#40; defined $bsobj, &#39;parsed seventh&#39; &#41;;
 is_deeply&#40; [ $bsobj-&gt;parts ], \@exp, &#39;bs7 parts&#39; &#41;
   or diag&#40; join&#40;&#34; &#34;, $bsobj-&gt;parts &#41; &#41;;
@@ -85,7 +87,7 @@ is_deeply&#40; [ $bsobj-&gt;parts ], \@exp, &#39;bs7 parts&#39; &#41;
 my $bs8 = q{&#40;BODYSTRUCTURE &#40;&#40;&#34;text&#34; &#34;plain&#34; &#40;&#34;charset&#34; &#34;us-ascii&#34;&#41; NIL NIL &#34;7bit&#34; 31 2 NIL NIL NIL NIL&#41;&#40;&#34;message&#34; &#34;rfc822&#34; NIL NIL &#34;My forwarded message&#34; &#34;7bit&#34; 2833 &#40;&#34;Fri, 07 May 2010 01:55:40 -0400&#34; &#34;outer msg&#34; &#40;&#40;&#34;Phil Pearl&#34; NIL &#34;phil&#34; &#34;perkpartners.com&#34;&#41;&#41; &#40;&#40;&#34;Phil Pearl&#34; NIL &#34;phil&#34; &#34;perkpartners.com&#34;&#41;&#41; &#40;&#40;&#34;Phil Pearl&#34; NIL &#34;phil&#34; &#34;perkpartners.com&#34;&#41;&#41; &#40;&#40;NIL NIL &#34;phil&#34; &#34;perkpartners.com&#34;&#41;&#41; NIL NIL NIL &#34;&lt;25030.1273211740@local&gt;&#34;&#41; &#40;&#40;&#34;text&#34; &#34;plain&#34; &#40;&#34;charset&#34; &#34;us-ascii&#34;&#41; NIL NIL &#34;7bit&#34; 20 1 NIL NIL NIL NIL&#41;&#40;&#34;message&#34; &#34;rfc822&#34; NIL NIL NIL &#34;7bit&#34; 1810 &#40;&#34;Fri, 07 May 2010 01:55:07 -0400&#34; &#34;wrap inner a&#34; &#40;&#40;&#34;Phil Pearl&#34; NIL &#34;phil&#34; &#34;perkpartners.com&#34;&#41;&#41; &#40;&#40;&#34;Phil Pearl&#34; NIL &#34;phil&#34; &#34;perkpartners.com&#34;&#41;&#41; &#40;&#40;&#34;Phil Pearl&#34; NIL &#34;phil&#34; &#34;perkpartners.com&#34;&#41;&#41; &#40;&#40;NIL NIL &#34;phil&#34; &#34;perkpartners.com&#34;&#41;&#41; NIL NIL NIL &#34;&lt;25015.1273211707@local&gt;&#34;&#41; &#40;&#40;&#34;text&#34; &#34;plain&#34; &#40;&#34;charset&#34; &#34;us-ascii&#34;&#41; NIL NIL &#34;7bit&#34; 27 3 NIL NIL NIL NIL&#41;&#40;&#34;message&#34; &#34;rfc822&#34; NIL NIL NIL &#34;7bit&#34; 783 &#40;&#34;Fri, 07 May 2010 01:54:14 -0400&#34; &#34;inner msg #1&#34; &#40;&#40;&#34;Phil Pearl&#34; NIL &#34;phil&#34; &#34;perkpartners.com&#34;&#41;&#41; &#40;&#40;&#34;Phil Pearl&#34; NIL &#34;phil&#34; &#34;perkpartners.com&#34;&#41;&#41; &#40;&#40;&#34;Phil Pearl&#34; NIL &#34;phil&#34; &#34;perkpartners.com&#34;&#41;&#41; &#40;&#40;NIL NIL &#34;phil&#34; &#34;perkpartners.com&#34;&#41;&#41; NIL NIL NIL &#34;&lt;24986.1273211654@local&gt;&#34;&#41; &#40;&#34;text&#34; &#34;plain&#34; &#40;&#34;charset&#34; &#34;us-ascii&#34;&#41; NIL NIL &#34;7bit&#34; 25 3 NIL NIL NIL NIL&#41; 23 NIL &#40;&#34;inline&#34; &#40;&#34;filename&#34; &#34;52&#34;&#41;&#41; NIL NIL&#41; &#34;mixed&#34; &#40;&#34;boundary&#34; &#34;=-=-=&#34;&#41; NIL NIL NIL&#41; 58 NIL &#40;&#34;inline&#34; &#40;&#34;filename&#34; &#34;53&#34;&#41;&#41; NIL NIL&#41; &#34;mixed&#34; &#40;&#34;boundary&#34; &#34;==-=-=&#34;&#41; NIL NIL NIL&#41; 91 NIL &#40;&#34;inline&#34; &#40;&#34;filename&#34; &#34;52&#34;&#41;&#41; NIL NIL&#41;&#40;&#34;text&#34; &#34;plain&#34; &#40;&#34;charset&#34; &#34;us-ascii&#34;&#41; NIL NIL &#34;7bit&#34; 30 2 NIL NIL NIL NIL&#41;&#40;&#34;application&#34; &#34;octet-stream&#34; NIL NIL &#34;My attachment&#34; &#34;7bit&#34; 76 NIL &#40;&#34;attachment&#34; &#40;&#34;filename&#34; &#34;.signature.cell&#34;&#41;&#41; NIL NIL&#41;&#40;&#34;text&#34; &#34;plain&#34; &#40;&#34;charset&#34; &#34;us-ascii&#34;&#41; NIL NIL &#34;7bit&#34; 31 2 NIL NIL NIL NIL&#41; &#34;mixed&#34; &#40;&#34;boundary&#34; &#34;===-=-=&#34;&#41; NIL NIL NIL&#41;&#41;};
 
 $bsobj = Mail::IMAPClient::BodyStructure-&gt;new&#40;$bs8&#41;;
-@exp   = qw&#40;1 2 2.HEAD 2.TEXT 2.1 2.2 2.2.HEAD 2.2.TEXT 2.2.1 2.2.2 2.2.2.HEAD 2.2.2.TEXT 3 4 5&#41;;
+@exp   = qw&#40;1 2 2.HEAD 2.TEXT 2.1 2.2 2.2.HEAD 2.2.TEXT 2.2.1 2.2.2 2.2.2.HEAD 2.2.2.1 3 4 5&#41;;
 ok&#40; defined $bsobj, &#39;parsed eighth&#39; &#41;;
 is_deeply&#40; [ $bsobj-&gt;parts ], \@exp, &#39;bs8 parts&#39; &#41;
   or diag&#40; join&#40;&#34; &#34;, $bsobj-&gt;parts &#41; &#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;10&nbsp;13:52:11&nbsp;2010</span>
    <span class="description">PLOBBES [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Can you supply a sample RFC2822 message that requires/works with the patch 
provided?  I could try to create my own but I&#39;d rather just work off the a 
provided example if possible for my own testing.  In other tests I did, I 
did not come across this problem but my tests are obviously non-
exhaustive.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;10&nbsp;13:52:13&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;10&nbsp;13:52:13&nbsp;2010</span>
    <span class="description">PLOBBES [...] cpan.org -  Given to PLOBBES</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;10&nbsp;16:37:57&nbsp;2010</span>
    <span class="description">ROBN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry, I should&#39;ve included my tests or even updated the real tests.
I&#39;ll try to do that soon. Here&#39;s all my stuff though in case you get to
it first.

I&#39;ve uploaded the raw messages I use for testing here:

  <span class="clickylink"><a target="new" rel="nofollow" href="http://cataclysm.cx/random/mime/">http://cataclysm.cx/random/mime/</a></span>

These are a couple of MIME demo/test messages that we used years ago
when first developing our webmail client.

Attached is my test script and its dump of the bodystructure with
various versions of Mail::IMAPClient. The script contains the
bodystructure for these two messages as produced by iPlanet Messaging
Server 5.2.

We currently have 2.2.9 in production and the part numbers it produces
match what comes back off the server. 3.23 and 3.24 don&#39;t match
perfectly because they do the wrong things with multiparts. The addition
of this patch makes things work correctly &#40;with the addition of .TEXT,
which our client ignores&#41;.

Tip: A side-by-side diffing tool is brilliant for seeing what&#39;s going on
here. vimdiff saved quite a bit of my hair here :P
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 3.24+57337</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/775163/401438/3.24%2B57337">Download 3.24+57337</a><br />
<span class="downloadcontenttype">application/octet-stream 2.1k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 3.24</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/775163/401439/3.24">Download 3.24</a><br />
<span class="downloadcontenttype">application/octet-stream 2.1k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 2.2.9</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/775163/401440/2.2.9">Download 2.2.9</a><br />
<span class="downloadcontenttype">application/octet-stream 1.7k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 3.23</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/775163/401441/3.23">Download 3.23</a><br />
<span class="downloadcontenttype">application/octet-stream 2.2k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> bodystructure.pl</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;14&nbsp;15:52:53&nbsp;2010</span>
    <span class="description">PLOBBES [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon May 10 16:37:57 2010, ROBN wrote:
...
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve uploaded the raw messages I use for testing here:
&gt; 
&gt;   <span class="clickylink"><a target="new" rel="nofollow" href="http://cataclysm.cx/random/mime/">http://cataclysm.cx/random/mime/</a></span>
</div>
Rob,
I am unable to reach cataclysm.cx.  Looking at WHOIS it appears that the 
domain is currently in a &#34;suspended&#34; status.  Do you have an alternate 
location to download?  Or perhaps just email them to me &#40;plobbes @ cpan 
dot org&#41;?  Thanks!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;16&nbsp;17:56:43&nbsp;2010</span>
    <span class="description">rob [...] cataclysm.cx -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> ROBN [...] cpan.org, DJKERNEN__NO_SOLICITING__ [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #57337] Correctly handle multiparts in  BodyStructure.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 17 May 2010 07:56:33 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-IMAPClient [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Robert Norris &lt;rob [...] cataclysm.cx&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Phil,

Sorry about that. My registrar broke something and I&#39;m now yelling at
them about it. Things are working again.

Rob.

On Sat, May 15, 2010 at 5:52 AM, Phil Pearl &#40;Lobbes&#41; via RT
&lt;bug-Mail-IMAPClient@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=57337">https://rt.cpan.org/Ticket/Display.html?id=57337</a></span> &gt;
&gt;
&gt; On Mon May 10 16:37:57 2010, ROBN wrote:
&gt; ...
<div class="message-stanza open">&gt;&gt; I&#39;ve uploaded the raw messages I use for testing here:
&gt;&gt;
&gt;&gt;   <span class="clickylink"><a target="new" rel="nofollow" href="http://cataclysm.cx/random/mime/">http://cataclysm.cx/random/mime/</a></span>
</div>&gt;
&gt; Rob,
&gt; I am unable to reach cataclysm.cx.  Looking at WHOIS it appears that the
&gt; domain is currently in a &#34;suspended&#34; status.  Do you have an alternate
&gt; location to download?  Or perhaps just email them to me &#40;plobbes @ cpan
&gt; dot org&#41;?  Thanks!
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;25&nbsp;15:43:36&nbsp;2010</span>
    <span class="description">PLOBBES [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the files.  I took your patch with some minor &#40;non-functional&#41; 
changes and integrated that with the code for the next release &#40;3.25&#41;.  I 
think we should be pretty close to good.  I also added a test case using 
the mime torture message.

I&#39;m almost of the opinion that I shouldn&#39;t even include the .TEXT parts 
&#40;unless we wen&#39;t crazy and did the other missing .&lt;type&gt; parts&#41; but we&#39;ll 
leave it in there for now anyway.  If you want a pre-release copy of 
IMAPClient/BodyStructure.pm let me know and I&#39;ll send it to you for your 
review.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;31&nbsp;15:19:48&nbsp;2010</span>
    <span class="description">PLOBBES [...] cpan.org -  Fixed in 3.25 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;31&nbsp;15:19:48&nbsp;2010</span>
    <span class="description">PLOBBES [...] cpan.org -  Broken in 3.03 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;31&nbsp;15:19:48&nbsp;2010</span>
    <span class="description">PLOBBES [...] cpan.org -  Broken in 3.24 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;31&nbsp;15:19:48&nbsp;2010</span>
    <span class="description">PLOBBES [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Release 3.25 is out with a fix for this bug closing for now, but please 
let me know if you run into any problems!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;31&nbsp;15:19:49&nbsp;2010</span>
    <span class="description">PLOBBES [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
