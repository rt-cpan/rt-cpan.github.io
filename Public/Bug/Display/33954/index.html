<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #33954 for Crypt-SSLeay: CONNECT is not robust to fragmentation of HTTP headers</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #33954 for Crypt-SSLeay: CONNECT is not robust to fragmentation of HTTP headers</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Crypt-SSLeay/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Crypt-SSLeay/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Crypt-SSLeay/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Crypt-SSLeay/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Crypt-SSLeay">Crypt-SSLeay CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">33954</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Crypt-SSLeay/Active/">Crypt-SSLeay</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">nanis [...] runu.moc.invalid
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
martin.waite [...] datacash.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-8676-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.57    </td>
  </tr>
  <tr id="CF-8677-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<ul>
<li>
0.57_02</li>
<li>
0.57_03</li>
<li>
0.57_04</li>
</ul>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;10&nbsp;08:13:09&nbsp;2008</span>
    <span class="description">martin.waite [...] datacash.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> CONNECT is not robust to fragmentation of HTTP headers</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 10 Mar 2008 12:07:06 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Crypt-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Martin Waite &lt;martin.waite [...] datacash.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza"><font size="meduim"><font face="verdana">Hi,<br>
<br>
Version Crypt-SSLeay-0.57<br>
<br>
In lib/Net/SSL.pm, sub proxy_connect_helper, an attempt is made to read
the HTTP headers from the proxy server:</font></font>
<br>


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><blockquote>

  
<pre>    my $header;
    my $n = $self-&gt;SUPER::sysread($header, 8192);
    my $conn_ok = ($header =~ /HTTP\/\d+\.\d+\s+200\s+/is) ? 1 : 0;

    if (not $conn_ok) {
        croak("PROXY ERROR HEADER, could be non-SSL URL:\n$header");
    }
  </pre>

</blockquote>
</div><pre>
</pre>

For our system, using apache 2 as an SSL proxy, the 2 HTTP headers (and
a blank line) are returned:<br>

<br>


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><blockquote>

  
<pre>HTTP/1.0 200 Connection establishedCRLF
Proxy-agent: ApacheCRLF
CRLF
  </pre>

</blockquote>
</div><br>

Apache appears to send the headers in two separate TCP packets.&nbsp;
Mostly, this isn't a problem because by time 
<font size="meduim"><font face="verdana">proxy_connect_helper attempts to read the header, the
whole header is available in the O/S buffer.&nbsp; Sometimes, however, the
second header hasn't arrived by time the read takes place.&nbsp; When this
happens, </font></font>
<font size="meduim"><font face="verdana">proxy_connect_helper
only removes the first header line from the read buffer, and the
remainder of the header is read in by OpenSSL, which causes the
hand-shaking to fail.<br>
<br>
What I think </font></font>
<font size="meduim"><font face="verdana">proxy_connect_helper
should do is read until it finds the end of the HTTP headers (CRLF
CRLF).&nbsp; This might take many reads, not just a single one.&nbsp; </font></font>
<br>

<br>


<div>-- <br>
<div style="font-size: 10pt; font-family: Verdana;">Martin Waite<br>
<span style="color: gray;">Solutions Architect</span><br>
<b>DataCash</b><br>
<br>
Tel (Direct): +44 (0)131 538 8431<br>
Mobile: +44 (0)7866 750509<br>
<br>
DataCash Ltd, Suite 3/1 Great Michael House,<br>
14 Links Place, Edinburgh, EH6 7EZ, United Kingdom.<br>
<br>
Tel: +44 (0)870 7274 762<br>
Fax: +44 (0)870 7274 782<br>
<br>
<a href="http://www.datacash.com/">www.datacash.com</a><br>
<br>
</div>
<div style="font-size: 8pt; font-family: Verdana;">
DISCLAIMER: This email and any files transmitted with it are
confidential to DataCash Group plc and its group companies. It is
intended only for the person to whom it is addressed. If you have
received this email in error, please forward it to <a href="mailto:info@datacash.com">info@datacash.com</a>
with the
subject line "Received in Error". If you are not the intended
recipient you must not use, disclose, copy, print, distribute or rely
on this email or any transmitted files. DataCash Ltd is registered in
England and Wales no. 3430157. DataCash Ltd is part of the DataCash
Group plc. DataCash Group plc is registered in England and Wales
no. 3168091. DataCash Ltd and DataCash Group plc registered address is
Descartes House, 8 Gate Street, London, WC2A 3HP, United Kingdom.
</div>
<br>
<div style="font-size: 8pt; font-family: Verdana; color: rgb(0, 119, 0);">
Save a tree...Please only print this page if essential
</div>
</div>




</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;10&nbsp;14:09:09&nbsp;2008</span>
    <span class="description">martin.waite [...] datacash.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #33954] AutoReply: CONNECT is not robust to fragmentation of HTTP headers</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 10 Mar 2008 18:08:45 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Crypt-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Martin Waite &lt;martin.waite [...] datacash.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza">  


Hi,<br>

<br>

Here is a patch for reading the entire HTTP header from the proxy
server:<br>


<pre>
--- /usr/lib/perl5/Net/SSL.pm   2003-05-28 07:26:08.000000000 +0100
+++ Net/SSL.pm  2008-03-10 18:02:11.000000000 +0000
@@ -370,8 +370,11 @@
     $connect_string .= $CRLF;

     $self-&gt;SUPER::send($connect_string);
-    my $header;
-    my $n = $self-&gt;SUPER::sysread($header, 8192);
+    my $header='';
+    while ( $header !~ /$CRLF$CRLF/ ) {
+      my $n = $self-&gt;SUPER::sysread($header, 8192, length($header));
+    }
+
     if($header =~ /HTTP\/\d+\.\d+\s+200\s+/is) {
        $conn_ok = 1;
     }
</pre>

<br>


<div>-- <br>
<div style="font-size: 10pt; font-family: Verdana;">Martin Waite<br>
<span style="color: gray;">Solutions Architect</span><br>
<b>DataCash</b><br>
<br>
Tel (Direct): +44 (0)131 538 8431<br>
Mobile: +44 (0)7866 750509<br>
<br>
DataCash Ltd, Suite 3/1 Great Michael House,<br>
14 Links Place, Edinburgh, EH6 7EZ, United Kingdom.<br>
<br>
Tel: +44 (0)870 7274 762<br>
Fax: +44 (0)870 7274 782<br>
<br>
<a href="http://www.datacash.com/">www.datacash.com</a><br>
<br>
</div>
<div style="font-size: 8pt; font-family: Verdana;">
DISCLAIMER: This email and any files transmitted with it are
confidential to DataCash Group plc and its group companies. It is
intended only for the person to whom it is addressed. If you have
received this email in error, please forward it to <a href="mailto:info@datacash.com">info@datacash.com</a>
with the
subject line "Received in Error". If you are not the intended
recipient you must not use, disclose, copy, print, distribute or rely
on this email or any transmitted files. DataCash Ltd is registered in
England and Wales no. 3430157. DataCash Ltd is part of the DataCash
Group plc. DataCash Group plc is registered in England and Wales
no. 3168091. DataCash Ltd and DataCash Group plc registered address is
Descartes House, 8 Gate Street, London, WC2A 3HP, United Kingdom.
</div>
<br>
<div style="font-size: 8pt; font-family: Verdana; color: rgb(0, 119, 0);">
Save a tree...Please only print this page if essential
</div>
</div>




</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;24&nbsp;07:06:17&nbsp;2008</span>
    <span class="description">dland [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;24&nbsp;07:11:31&nbsp;2008</span>
    <span class="description">dland [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Mar 10 14:09:09 2008, martin.waite@datacash.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  Hi,
&gt; 
&gt; Here is a patch for reading the entire HTTP header from the proxy
&gt; server:
</div>
Dear Martin,

thank-you very much for this patch. I will integrate it into my local
repo and release 0.57_02.

I don&#39;t suppose you know how I could add a test case for this?
Connecting to a site that returns a large number of headers?

Regards,
David

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; --- /usr/lib/perl5/Net/SSL.pm   2003-05-28 07:26:08.000000000 +0100
&gt; +++ Net/SSL.pm  2008-03-10 18:02:11.000000000 +0000
&gt; @@ -370,8 +370,11 @@
&gt;      $connect_string .= $CRLF;
&gt; 
&gt;      $self-&gt;SUPER::send&#40;$connect_string&#41;;
&gt; -    my $header;
&gt; -    my $n = $self-&gt;SUPER::sysread&#40;$header, 8192&#41;;
&gt; +    my $header=&#39;&#39;;
&gt; +    while &#40; $header !~ /$CRLF$CRLF/ &#41; {
&gt; +      my $n = $self-&gt;SUPER::sysread&#40;$header, 8192, length&#40;$header&#41;&#41;;
&gt; +    }
&gt; +
&gt;      if&#40;$header =~ /HTTP\/\d+\.\d+\s+200\s+/is&#41; {
&gt;         $conn_ok = 1;
&gt;      }
&gt; 
&gt; 
&gt; --
&gt; Martin Waite
&gt; Solutions Architect
&gt; DataCash
&gt; 
&gt; Tel &#40;Direct&#41;: +44 &#40;0&#41;131 538 8431
&gt; Mobile: +44 &#40;0&#41;7866 750509
&gt; 
&gt; DataCash Ltd, Suite 3/1 Great Michael House,
&gt; 14 Links Place, Edinburgh, EH6 7EZ, United Kingdom.
&gt; 
&gt; Tel: +44 &#40;0&#41;870 7274 762
&gt; Fax: +44 &#40;0&#41;870 7274 782
&gt; 
&gt; www.datacash.com
&gt; 
&gt; DISCLAIMER: This email and any files transmitted with it are
&gt; confidential to
&gt; DataCash Group plc and its group companies. It is intended only for
&gt; the person
&gt; to whom it is addressed. If you have received this email in error,
&gt; please
&gt; forward it to info@datacash.com with the subject line &#34;Received in
&gt; Error&#34;. If
&gt; you are not the intended recipient you must not use, disclose, copy,
&gt; print,
&gt; distribute or rely on this email or any transmitted files. DataCash
&gt; Ltd is
&gt; registered in England and Wales no. 3430157. DataCash Ltd is part of
&gt; the
&gt; DataCash Group plc. DataCash Group plc is registered in England and
&gt; Wales no.
&gt; 3168091. DataCash Ltd and DataCash Group plc registered address is
&gt; Descartes
&gt; House, 8 Gate Street, London, WC2A 3HP, United Kingdom.
&gt; Save a tree...Please only print this page if essential
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;24&nbsp;07:11:33&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;31&nbsp;04:25:05&nbsp;2008</span>
    <span class="description">martin.waite [...] datacash.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #33954] CONNECT is not robust to fragmentation of HTTP headers</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 31 Mar 2008 09:24:40 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Crypt-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Martin Waite &lt;martin.waite [...] datacash.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza">  


Hi David,<br>

<br>

Sorry - I couldn't come up with a test case.<br>

<br>

We found the problem in connecting to Apache 2 proxies across MPLS -
which has only 4mps bandwidth.  We found we could use Apache 1.3
proxies with no problem, and even Apache 2 across the local network,
but had a 90% failure rate when using Apache2 proxies across the slow
link.<br>

<br>

All I can think of is recording the packet flow through an SSL
handshake, and writing a test server to replay that at slow speed.  <br>

<br>

Timing problems are pretty difficult to embody in a test harness.<br>

<br>

regards,<br>

Martin<br>

<br>

David Landgren via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><blockquote>

  
<pre>&lt;URL: <a href="http://rt.cpan.org/Ticket/Display.html?id=33954"><span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=33954">http://rt.cpan.org/Ticket/Display.html?id=33954</a></span></a> &gt;

On Mon Mar 10 14:09:09 2008, <a href="mailto:martin.waite@datacash.com">martin.waite@datacash.com</a> wrote:
  </pre>

  
<div class="message-stanza open"><blockquote>

    
<pre> Hi,

Here is a patch for reading the entire HTTP header from the proxy
server:
    </pre>

  </blockquote>
</div>  
<pre>
Dear Martin,

thank-you very much for this patch. I will integrate it into my local
repo and release 0.57_02.

I don't suppose you know how I could add a test case for this?
Connecting to a site that returns a large number of headers?

Regards,
David

  </pre>

  
<div class="message-stanza open"><blockquote>

    
<pre>--- /usr/lib/perl5/Net/SSL.pm   2003-05-28 07:26:08.000000000 +0100
+++ Net/SSL.pm  2008-03-10 18:02:11.000000000 +0000
@@ -370,8 +370,11 @@
     $connect_string .= $CRLF;

     $self-&gt;SUPER::send($connect_string);
-    my $header;
-    my $n = $self-&gt;SUPER::sysread($header, 8192);
+    my $header='';
+    while ( $header !~ /$CRLF$CRLF/ ) {
+      my $n = $self-&gt;SUPER::sysread($header, 8192, length($header));
+    }
+
     if($header =~ /HTTP\/\d+\.\d+\s+200\s+/is) {
        $conn_ok = 1;
     }


--
Martin Waite
Solutions Architect
DataCash

Tel (Direct): +44 (0)131 538 8431
Mobile: +44 (0)7866 750509

DataCash Ltd, Suite 3/1 Great Michael House,
14 Links Place, Edinburgh, EH6 7EZ, United Kingdom.

Tel: +44 (0)870 7274 762
Fax: +44 (0)870 7274 782

<a href="http://www.datacash.com">www.datacash.com</a>

DISCLAIMER: This email and any files transmitted with it are
confidential to
DataCash Group plc and its group companies. It is intended only for
the person
to whom it is addressed. If you have received this email in error,
please
forward it to <a href="mailto:info@datacash.com">info@datacash.com</a> with the subject line "Received in
Error". If
you are not the intended recipient you must not use, disclose, copy,
print,
distribute or rely on this email or any transmitted files. DataCash
Ltd is
registered in England and Wales no. 3430157. DataCash Ltd is part of
the
DataCash Group plc. DataCash Group plc is registered in England and
Wales no.
3168091. DataCash Ltd and DataCash Group plc registered address is
Descartes
House, 8 Gate Street, London, WC2A 3HP, United Kingdom.
Save a tree...Please only print this page if essential
    </pre>

  </blockquote>
</div>  
<pre>



  </pre>

</blockquote>
</div><br>

<br>


<div>-- <br>
<div style="font-size: 10pt; font-family: Verdana;">Martin Waite<br>
<span style="color: gray;">Solutions Architect</span><br>
<b>DataCash</b><br>
<br>
Tel (Direct): +44 (0)131 538 8431<br>
Mobile: +44 (0)7866 750509<br>
<br>
DataCash Ltd, Suite 3/1 Great Michael House,<br>
14 Links Place, Edinburgh, EH6 7EZ, United Kingdom.<br>
<br>
Tel: +44 (0)870 7274 762<br>
Fax: +44 (0)870 7274 782<br>
<br>
<a href="http://www.datacash.com/">www.datacash.com</a><br>
<br>
</div>
<div style="font-size: 8pt; font-family: Verdana;">
DISCLAIMER: This email and any files transmitted with it are
confidential to DataCash Group plc and its group companies. It is
intended only for the person to whom it is addressed. If you have
received this email in error, please forward it to <a href="mailto:info@datacash.com">info@datacash.com</a>
with the
subject line "Received in Error". If you are not the intended
recipient you must not use, disclose, copy, print, distribute or rely
on this email or any transmitted files. DataCash Ltd is registered in
England and Wales no. 3430157. DataCash Ltd is part of the DataCash
Group plc. DataCash Group plc is registered in England and Wales
no. 3168091. DataCash Ltd and DataCash Group plc registered address is
Descartes House, 8 Gate Street, London, WC2A 3HP, United Kingdom.
</div>
<br>
<div style="font-size: 8pt; font-family: Verdana; color: rgb(0, 119, 0);">
Save a tree...Please only print this page if essential
</div>
</div>




</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;01&nbsp;10:42:44&nbsp;2010</span>
    <span class="description">martin.waite [...] datacash.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #33954] CONNECT is not robust to fragmentation of HTTP headers </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 1 Feb 2010 15:42:11 -0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-Crypt-SSLeay [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Martin Waite&#34; &lt;Martin.Waite [...] datacash.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi David,

We have come across a bug in the patch I submitted nearly two years ago.

--- /usr/lib/perl5/Net/SSL.pm   2003-05-28 07:26:08.000000000 +0100
+++ Net/SSL.pm  2008-03-10 18:02:11.000000000 +0000
@@ -370,8 +370,11 @@
     $connect_string .= $CRLF;

     $self-&gt;SUPER::send&#40;$connect_string&#41;;
-    my $header;
-    my $n = $self-&gt;SUPER::sysread&#40;$header, 8192&#41;;
+    my $header=&#39;&#39;;
+    while &#40; $header !~ /$CRLF$CRLF/ &#41; {
+      my $n = $self-&gt;SUPER::sysread&#40;$header, 8192, length&#40;$header&#41;&#41;;
+      break if &#40; $n == 0 &#41;;
+    }
+
     if&#40;$header =~ /HTTP\/\d+\.\d+\s+200\s+/is&#41; {
        $conn_ok = 1;
     }

The extra line &#34;break if &#40;$n==0&#41;&#34; is required to prevent entering a tight infinite loop if the connection has been severed before the headers have been read.

regards,
Martin

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: David Landgren via RT [mailto:bug-Crypt-SSLeay@rt.cpan.org] 
Sent: 24 March 2008 11:12
To: martin.waite@datacash.com
Subject: [rt.cpan.org #33954] CONNECT is not robust to fragmentation of HTTP headers 


&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=33954">http://rt.cpan.org/Ticket/Display.html?id=33954</a></span> &gt;

On Mon Mar 10 14:09:09 2008, martin.waite@datacash.com wrote:
<div class="message-stanza open">&gt;  Hi,
&gt; 
&gt; Here is a patch for reading the entire HTTP header from the proxy
&gt; server:
</div>
Dear Martin,

thank-you very much for this patch. I will integrate it into my local
repo and release 0.57_02.

I don&#39;t suppose you know how I could add a test case for this?
Connecting to a site that returns a large number of headers?

Regards,
David

<div class="message-stanza open">&gt; --- /usr/lib/perl5/Net/SSL.pm   2003-05-28 07:26:08.000000000 +0100
&gt; +++ Net/SSL.pm  2008-03-10 18:02:11.000000000 +0000
&gt; @@ -370,8 +370,11 @@
&gt;      $connect_string .= $CRLF;
&gt; 
&gt;      $self-&gt;SUPER::send&#40;$connect_string&#41;;
&gt; -    my $header;
&gt; -    my $n = $self-&gt;SUPER::sysread&#40;$header, 8192&#41;;
&gt; +    my $header=&#39;&#39;;
&gt; +    while &#40; $header !~ /$CRLF$CRLF/ &#41; {
&gt; +      my $n = $self-&gt;SUPER::sysread&#40;$header, 8192, length&#40;$header&#41;&#41;;
&gt; +    }
&gt; +
&gt;      if&#40;$header =~ /HTTP\/\d+\.\d+\s+200\s+/is&#41; {
&gt;         $conn_ok = 1;
&gt;      }
&gt; 
&gt; 
&gt; --
&gt; Martin Waite
&gt; Solutions Architect
&gt; DataCash
&gt; 
&gt; Tel &#40;Direct&#41;: +44 &#40;0&#41;131 538 8431
&gt; Mobile: +44 &#40;0&#41;7866 750509
&gt; 
&gt; DataCash Ltd, Suite 3/1 Great Michael House,
&gt; 14 Links Place, Edinburgh, EH6 7EZ, United Kingdom.
&gt; 
&gt; Tel: +44 &#40;0&#41;870 7274 762
&gt; Fax: +44 &#40;0&#41;870 7274 782
&gt; 
&gt; www.datacash.com
&gt; 
&gt; DISCLAIMER: This email and any files transmitted with it are
&gt; confidential to
&gt; DataCash Group plc and its group companies. It is intended only for
&gt; the person
&gt; to whom it is addressed. If you have received this email in error,
&gt; please
&gt; forward it to info@datacash.com with the subject line &#34;Received in
&gt; Error&#34;. If
&gt; you are not the intended recipient you must not use, disclose, copy,
&gt; print,
&gt; distribute or rely on this email or any transmitted files. DataCash
&gt; Ltd is
&gt; registered in England and Wales no. 3430157. DataCash Ltd is part of
&gt; the
&gt; DataCash Group plc. DataCash Group plc is registered in England and
&gt; Wales no.
&gt; 3168091. DataCash Ltd and DataCash Group plc registered address is
&gt; Descartes
&gt; House, 8 Gate Street, London, WC2A 3HP, United Kingdom.
&gt; Save a tree...Please only print this page if essential
</div>



</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;19&nbsp;14:25:11&nbsp;2010</span>
    <span class="description">brian [...] Awfulhak.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> brian [...] Awfulhak.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Feb 01 10:42:44 2010, martin.waite@datacash.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi David,
&gt; 
&gt; We have come across a bug in the patch I submitted nearly
&gt; two years ago.
</div>[.....]

I have a similar patch here:

--- lib/Net/SSL.pm.orig 2007-09-17 12:56:52.000000000 -0700
+++ lib/Net/SSL.pm      2010-05-19 11:23:50.000000000 -0700
@@ -361,8 +361,15 @@
 
     $connect_string .= $CRLF;
     $self-&gt;SUPER::send&#40;$connect_string&#41;;
-    my $header;
-    my $n = $self-&gt;SUPER::sysread&#40;$header, 8192&#41;;
+    my $header = &#34;&#34;;
+    my $timeout;
+    while &#40;$header !~ m{HTTP/\d+\.\d+\s+200\s+.*\r\n\r\n}s&#41; {
+       $timeout = $self-&gt;timeout&#40;5&#41; unless length $header;
+       my $n = $self-&gt;SUPER::sysread&#40;$header, 8192, length $header&#41;;
+       last if $n &lt;= 0;
+    }
+    $self-&gt;timeout&#40;$timeout&#41; if defined $timeout;
+
     my $conn_ok = &#40;$header =~ /HTTP\/\d+\.\d+\s+200\s+/is&#41; ? 1 : 0;
 
     if &#40;not $conn_ok&#41; {

As there doesn&#39;t seem to be any sign of an update to Crypt-SSLeay, I&#39;ll
submit this to the FreeBSD ports tree for now.

FWIW, the bug is caused by apache&#39;s proxy and doesn&#39;t occur with other
proxies such as squid.  It is due to apache writing the &#34;HTTP/1.0 200
...\r\n&#34; with one write call and the &#34;Proxy-access ...\r\n\r\n&#34; with a
second, sending two packets to the client on slow hardware.  The
receiving Crypt-SSLeay code is satisfied with the first string and
doesn&#39;t keep reading &#39;till the \r\n\r\n.  The subsequent openssl
protocol negotiation that takes place on the same descriptor then fails
with a protocol error because it cannot interpret &#34;Proxy-a&#34; &#40;the first 7
bytes&#41; as a reponse to it&#39;s client hello.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;20&nbsp;03:57:30&nbsp;2010</span>
    <span class="description">martin.waite [...] datacash.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #33954] CONNECT is not robust to fragmentation of HTTP headers </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 20 May 2010 08:57:20 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-Crypt-SSLeay [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Martin Waite&#34; &lt;Martin.Waite [...] datacash.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Brian,

The patch looks good.

This problem showed up in our environment where the perl app and the proxy were in different data centres.  The link between data centres was just slow enough for the separate packets to require separate reads.  Where the app was in the same data centre as the proxy, there was no problem.

regards,
Martin

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Brian Somers via RT [mailto:bug-Crypt-SSLeay@rt.cpan.org] 
Sent: 19 May 2010 19:25
To: Martin Waite
Subject: [rt.cpan.org #33954] CONNECT is not robust to fragmentation of HTTP headers 

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=33954">https://rt.cpan.org/Ticket/Display.html?id=33954</a></span> &gt;

On Mon Feb 01 10:42:44 2010, martin.waite@datacash.com wrote:
<div class="message-stanza open">&gt; Hi David,
&gt; 
&gt; We have come across a bug in the patch I submitted nearly
&gt; two years ago.
</div>[.....]

I have a similar patch here:

--- lib/Net/SSL.pm.orig 2007-09-17 12:56:52.000000000 -0700
+++ lib/Net/SSL.pm      2010-05-19 11:23:50.000000000 -0700
@@ -361,8 +361,15 @@
 
     $connect_string .= $CRLF;
     $self-&gt;SUPER::send&#40;$connect_string&#41;;
-    my $header;
-    my $n = $self-&gt;SUPER::sysread&#40;$header, 8192&#41;;
+    my $header = &#34;&#34;;
+    my $timeout;
+    while &#40;$header !~ m{HTTP/\d+\.\d+\s+200\s+.*\r\n\r\n}s&#41; {
+       $timeout = $self-&gt;timeout&#40;5&#41; unless length $header;
+       my $n = $self-&gt;SUPER::sysread&#40;$header, 8192, length $header&#41;;
+       last if $n &lt;= 0;
+    }
+    $self-&gt;timeout&#40;$timeout&#41; if defined $timeout;
+
     my $conn_ok = &#40;$header =~ /HTTP\/\d+\.\d+\s+200\s+/is&#41; ? 1 : 0;
 
     if &#40;not $conn_ok&#41; {

As there doesn&#39;t seem to be any sign of an update to Crypt-SSLeay, I&#39;ll
submit this to the FreeBSD ports tree for now.

FWIW, the bug is caused by apache&#39;s proxy and doesn&#39;t occur with other
proxies such as squid.  It is due to apache writing the &#34;HTTP/1.0 200
...\r\n&#34; with one write call and the &#34;Proxy-access ...\r\n\r\n&#34; with a
second, sending two packets to the client on slow hardware.  The
receiving Crypt-SSLeay code is satisfied with the first string and
doesn&#39;t keep reading &#39;till the \r\n\r\n.  The subsequent openssl
protocol negotiation that takes place on the same descriptor then fails
with a protocol error because it cannot interpret &#34;Proxy-a&#34; &#40;the first 7
bytes&#41; as a reponse to it&#39;s client hello.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;20&nbsp;04:01:17&nbsp;2010</span>
    <span class="description">bdfoy [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I haven&#39;t been watching this distro, but if I don&#39;t hear from David I&#39;ll apply this patch and send 
out a new dev release.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Steal odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;14&nbsp;23:10:14&nbsp;2010</span>
    <span class="description">nanis [...] runu.moc.invalid -  Stolen from DLAND</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;14&nbsp;23:10:53&nbsp;2010</span>
    <span class="description">nanis [...] runu.moc.invalid -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;14&nbsp;23:10:53&nbsp;2010</span>
    <span class="description">nanis [...] runu.moc.invalid -  Fixed in 0.57_02 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;14&nbsp;23:10:53&nbsp;2010</span>
    <span class="description">nanis [...] runu.moc.invalid -  Fixed in 0.57_03 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;14&nbsp;23:10:53&nbsp;2010</span>
    <span class="description">nanis [...] runu.moc.invalid -  Fixed in 0.57_04 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;14&nbsp;23:10:54&nbsp;2010</span>
    <span class="description">nanis [...] runu.moc.invalid -  Broken in 0.57 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
