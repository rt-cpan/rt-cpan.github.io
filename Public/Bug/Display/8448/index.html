<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #8448 for Mail-Bulkmail: headers_from_message broken?</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #8448 for Mail-Bulkmail: headers_from_message broken?</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Mail-Bulkmail/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Mail-Bulkmail/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Mail-Bulkmail/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Mail-Bulkmail/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-Bulkmail">Mail-Bulkmail CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">8448</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Mail-Bulkmail/Active/">Mail-Bulkmail</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
david [...] davidheath.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-19888-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-19889-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




bm2.conf<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/116170/24689/bm2.conf">
Mon Nov 15 14:53:10 2004 (1.6k) by 
</a>
</font></li>
</ul>


header_from_mail_bugfix.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/116169/24686/header_from_mail_bugfix.patch">
Mon Nov 15 14:52:02 2004 (1.2k) by 
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;15&nbsp;14:52:02&nbsp;2004</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> headers_from_message broken?</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Distribution name and version: Mail-Bulkmail-3.12.tar.gz
Perl version: v5.8.1
OS: mandrakelinux 9.2
Mail server: postfix-2.0.13-3mdk

Summary: the header_from_message setting appears not to work correctly.

Repro:
1. run the following program:

use Mail::Bulkmail &#34;/var/www/ez/bulkmail_test/bm2.conf&#34;;

my @l = &#40;&#39;david.heath@oneworld.net&#39;, &#39;david@davidheath.org&#39;, &#39;davidheath@iname.com&#39;&#41;;

my $bulk = Mail::Bulkmail-&gt;new&#40;
       &#39;From&#39;           =&gt; &#39;david.heath@oneworld.net&#39;,
       &#39;headers_from_message&#39; =&gt;1,
       &#39;Message&#39;           =&gt; &#39;From: david.heath@oneworld.net
To: list@oneworld.net
Subject: test

test message&#39;,
       &#34;LIST&#34;          =&gt; \@l
&#41; || die Mail::Bulkmail-&gt;error&#40;&#41;;

$bulk-&gt;bulkmail&#40;&#41; || die $bulk-&gt;error;

ACTUAL RESULT:

[heathd@vau19 bulkmail_test]$ perl bm_test.pl
Use of uninitialized value in substitution &#40;s///&#41; at /usr/lib/perl5/site_perl/5.8.1/Mail/Bulkmail.pm line 1781, &lt;HANDLE1&gt; line 14.
Use of uninitialized value in concatenation &#40;.&#41; or string at /usr/lib/perl5/site_perl/5.8.1/Mail/Bulkmail.pm line 2210, &lt;HANDLE1&gt; line 14.
Use of uninitialized value in substitution &#40;s///&#41; at /usr/lib/perl5/site_perl/5.8.1/Mail/Bulkmail.pm line 1781, &lt;HANDLE1&gt; line 19.
Use of uninitialized value in concatenation &#40;.&#41; or string at /usr/lib/perl5/site_perl/5.8.1/Mail/Bulkmail.pm line 2210, &lt;HANDLE1&gt; line 19.

EXPECTED RESULT:

no errors. Program should send emails correctly.

NOTES:

patch attached which fixes this. However I am not sure I have correctly understood your program, and also I am not a very experienced perl coder, so please check. 

Basically, it seems that the program tries to cache headers parsed out from the supplied Message. However, it clears these cached headers but then fails to regenerate them.

The intention of my patch is to change the behaviour so that the cached headers are only cleared if they need to be regenerated.

Best regards

David Heath
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Mail-Bulkmail-3.12/Bulkmail.pm	2003-12-22 18:54:10.000000000 +0000
+++ Mail/Bulkmail.pm	2004-11-15 19:00:14.000000000 +0000
@@ -485,18 +485,18 @@
 		};
 	};
 
-	#first, wipe out any previously set headers_from_message
-	if &#40;defined $self-&gt;_previous_headers_from_message&#41; {
-		foreach my $header &#40;@{$self-&gt;_previous_headers_from_message}&#41;{
-			$self-&gt;header&#40;$header, undef&#41;;
+	#then, if we&#39;re setting new headers, we should set them.
+	if &#40;$self-&gt;headers_from_message &#38;&#38; ! $self-&gt;_extracted_headers_from_message&#41; {
+		#first, wipe out any previously set headers_from_message
+		if &#40;defined $self-&gt;_previous_headers_from_message&#41; {
+			foreach my $header &#40;@{$self-&gt;_previous_headers_from_message}&#41;{
+				$self-&gt;header&#40;$header, undef&#41;;
+			};
 		};
-	};
 
-	#wipe out the list of previously set headers
-	$self-&gt;_previous_headers_from_message&#40;[]&#41;;
+		#wipe out the list of previously set headers
+		$self-&gt;_previous_headers_from_message&#40;[]&#41;;
 
-	#then, if we&#39;re setting new headers, we should set them.
-	if &#40;$self-&gt;headers_from_message &#38;&#38; ! $self-&gt;_extracted_headers_from_message&#41; {
 		$self-&gt;_extracted_headers_from_message&#40;1&#41;;
 		$passed[0] ||= $self-&gt;_Message&#40;&#41;;	#We&#39;ll sometimes call this method after setting the message
 		#sendmail-ify our messages newlines
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;15&nbsp;14:53:10&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">config file as used in repro example above
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/116170/24689/bm2.conf">Download bm2.conf</a><br />
<span class="downloadcontenttype">application/octet-stream 1.6k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
