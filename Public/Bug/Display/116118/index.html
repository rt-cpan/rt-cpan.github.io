<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #116118 for Net-SSLeay: Support for cross context session ticket sharing using  SSL_CTX_set_tlsext_ticket_key_cb</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #116118 for Net-SSLeay: Support for cross context session ticket sharing using  SSL_CTX_set_tlsext_ticket_key_cb</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Net-SSLeay">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Net-SSLeay">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Net-SSLeay">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Net-SSLeay">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-SSLeay">Net-SSLeay CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">116118</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Net-SSLeay">Net-SSLeay</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Steffen_Ullrich [...] genua.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-44414-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-44415-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




SSLeay.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1661159/891649/SSLeay.patch">
Tue Aug 23 07:34:58 2016 (2.9k) by Steffen_Ullrich [...] genua.de
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1648933/884671/SSLeay.patch">
Fri Jul 15 02:19:33 2016 (15.8k) by Steffen_Ullrich [...] genua.de
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1648728/884540/SSLeay.patch">
Thu Jul 14 13:01:13 2016 (15.3k) by Steffen_Ullrich [...] genua.de
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1648569/884443/SSLeay.patch">
Thu Jul 14 05:14:20 2016 (14.3k) by Steffen_Ullrich [...] genua.de
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1648276/884244/SSLeay.patch">
Wed Jul 13 12:39:27 2016 (14.3k) by Steffen_Ullrich [...] genua.de
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=116118">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1648276" href="/Public/Bug/Display.html?id=116118#txn-1648276">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;13&nbsp;12:39:27&nbsp;2016</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Support for cross context session ticket sharing using 
 SSL_CTX_set_tlsext_ticket_key_cb</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1648276/884243/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/884243">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 551b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The attached patch includes support for cross context &#40;and cross process&#41; session sharing using the stateless TLS session tickets. It uses the SSL_CTX_set_tlsext_ticket_key_cb function to manage the encryption and decryption of the tickets but provides a more simplified interface. 

To not conflict with the OpenSSL name in case the more complex interface will be implemented ever the current simplified interface is called slightly different: CTX_set_tlsext_ticket_*get*key_cb.

The patch includes the code, test and documentation.

Regards,
Steffen
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> SSLeay.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1648276/884244/SSLeay.patch">Download SSLeay.patch</a><br />
<span class="downloadcontenttype">text/x-diff 14.3k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1648447" href="/Public/Bug/Display.html?id=116118#txn-1648447">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;13&nbsp;20:31:26&nbsp;2016</span>
    <span class="description">mikem [...] airspayce.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #116118] Support for cross context session ticket sharing using   SSL_CTX_set_tlsext_ticket_key_cb</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 14 Jul 2016 10:31:11 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] airspayce.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1648447/884345/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/884345">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Steffen,

thanks.
Happy to consider this.

I notice that SSL_CTX_set_tlsext_ticket_getkey_cb&#40;&#41; is declared as returning a 
long but does not actually return anything.

Cheers.


On Wednesday, July 13, 2016 12:39:29 PM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Wed Jul 13 12:39:27 2016: Request 116118 was acted upon.
&gt; Transaction: Ticket created by SULLR
&gt;        Queue: Net-SSLeay
&gt;      Subject: Support for cross context session ticket sharing using
&gt;  SSL_CTX_set_tlsext_ticket_key_cb
&gt;    Broken in: &#40;no value&#41;
&gt;     Severity: &#40;no value&#41;
&gt;        Owner: Nobody
&gt;   Requestors: Steffen_Ullrich@genua.de
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=116118">https://rt.cpan.org/Ticket/Display.html?id=116118</a></span> &gt;
&gt; 
&gt; 
&gt; The attached patch includes support for cross context &#40;and cross process&#41;
&gt; session sharing using the stateless TLS session tickets. It uses the
&gt; SSL_CTX_set_tlsext_ticket_key_cb function to manage the encryption and
&gt; decryption of the tickets but provides a more simplified interface.
&gt; 
&gt; To not conflict with the OpenSSL name in case the more complex interface
&gt; will be implemented ever the current simplified interface is called
&gt; slightly different: CTX_set_tlsext_ticket_*get*key_cb.
&gt; 
&gt; The patch includes the code, test and documentation.
&gt; 
&gt; Regards,
&gt; Steffen
</div>
-- 
Mike McCauley           VK4AMM                   mikem@airspayce.com
Airspayce Pty Ltd 9 Bulbul Place Currumbin Waters QLD 4223 Australia   
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.airspayce.com">http://www.airspayce.com</a></span>
Phone +61 7 5598-7474
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1648448" href="/Public/Bug/Display.html?id=116118#txn-1648448">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;13&nbsp;20:31:27&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1648569" href="/Public/Bug/Display.html?id=116118#txn-1648569">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;14&nbsp;05:14:20&nbsp;2016</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1648569/884442/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/884442">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 533b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I notice that SSL_CTX_set_tlsext_ticket_getkey_cb&#40;&#41; is declared as
&gt; returning a
&gt; long but does not actually return anything.
</div>
Thanks for finding this. This should be void too.
The attached new patch fixes this but apart from that there are no changes to the previous patch.
Support for this is also incorporated into IO::Socket::SSL now &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/noxxi/p5-io-socket-ssl/commit/7e5d3647b2&#41;">https://github.com/noxxi/p5-io-socket-ssl/commit/7e5d3647b2&#41;</a></span>  and I&#39;ve successfully used it in some internal project to enable session reuse over multiple worker processes.

Regards,
Steffen
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> SSLeay.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1648569/884443/SSLeay.patch">Download SSLeay.patch</a><br />
<span class="downloadcontenttype">text/x-diff 14.3k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1648592" href="/Public/Bug/Display.html?id=116118#txn-1648592">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;14&nbsp;07:21:02&nbsp;2016</span>
    <span class="description">mikem [...] airspayce.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #116118] Support for cross context session ticket sharing using  SSL_CTX_set_tlsext_ticket_key_cb</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 14 Jul 2016 21:20:47 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] airspayce.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1648592/884453/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/884453">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Steffen,

thanks for the update. Compiles OK now.

Alas I find that with openssl-1.1.0 I get a segfault in 
t/local/64_ticket_sharing.t

and with /openssl-1.0.0 I get:

t/local/64_ticket_sharing.t ............ 1/15 
error:00000001:lib&#40;0&#41;:func&#40;0&#41;:reason&#40;1&#41; at t/local/64_ticket_sharing.t line 
228.
# Looks like you planned 15 tests but ran 8.
# Looks like your test exited with 255 just after 8.
t/local/64_ticket_sharing.t ............ Dubious, test returned 255 &#40;wstat 
65280, 0xff00&#41;


and with openssl-0.9.8i+extensions
I get 

#   Failed test &#39;handshake with reuse&#39;
#   at t/local/64_ticket_sharing.t line 40.
#          got: &#39;full&#39;
#     expected: &#39;reuse&#39;

#   Failed test &#39;handshake again with reuse&#39;
#   at t/local/64_ticket_sharing.t line 41.
#          got: &#39;full&#39;
#     expected: &#39;reuse&#39;

#   Failed test &#39;reuse session with server1&#39;
#   at t/local/64_ticket_sharing.t line 65.
#          got: &#39;full&#39;
#     expected: &#39;reuse&#39;

#   Failed test &#39;reuse session with server2&#39;
#   at t/local/64_ticket_sharing.t line 66.
#          got: &#39;full&#39;
#     expected: &#39;reuse&#39;

#   Failed test &#39;reuse session with server2&#39;
#   at t/local/64_ticket_sharing.t line 90.
#          got: &#39;full&#39;
#     expected: &#39;reuse&#39;

#   Failed test &#39;callback was called 2 times&#39;
#   at t/local/64_ticket_sharing.t line 91.
#          got: &#39;1&#39;
#     expected: &#39;2&#39;

#   Failed test &#39;first with the old key name&#39;
#   at t/local/64_ticket_sharing.t line 92.
#          got: undef
#     expected: &#39;secret&#39;

Too late for me to investigate further tonight. More tomorrow.

Cheers.



On Thursday, July 14, 2016 05:14:22 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=116118">https://rt.cpan.org/Ticket/Display.html?id=116118</a></span> &gt;
&gt; 
<div class="message-stanza open">&gt; &gt; I notice that SSL_CTX_set_tlsext_ticket_getkey_cb&#40;&#41; is declared as
&gt; &gt; returning a
&gt; &gt; long but does not actually return anything.
</div>&gt; 
&gt; Thanks for finding this. This should be void too.
&gt; The attached new patch fixes this but apart from that there are no changes
&gt; to the previous patch. Support for this is also incorporated into
&gt; IO::Socket::SSL now
&gt; &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/noxxi/p5-io-socket-ssl/commit/7e5d3647b2&#41;">https://github.com/noxxi/p5-io-socket-ssl/commit/7e5d3647b2&#41;</a></span>  and I&#39;ve
&gt; successfully used it in some internal project to enable session reuse over
&gt; multiple worker processes.
&gt; 
&gt; Regards,
&gt; Steffen
</div>
-- 
Mike McCauley           VK4AMM                   mikem@airspayce.com
Airspayce Pty Ltd 9 Bulbul Place Currumbin Waters QLD 4223 Australia   
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.airspayce.com">http://www.airspayce.com</a></span>
Phone +61 7 5598-7474
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1648728" href="/Public/Bug/Display.html?id=116118#txn-1648728">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;14&nbsp;13:01:13&nbsp;2016</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1648728/884539/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/884539">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Do 14. Jul 2016, 07:21:02, mikem@airspayce.com schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Steffen,
&gt; 
&gt; thanks for the update. Compiles OK now.
&gt; 
&gt; Alas I find that with openssl-1.1.0 I get a segfault in 
&gt; t/local/64_ticket_sharing.t
</div>
This looks for me like a bug in openssl-1.1.0 which corrupts some memory when SSL_CTX_set_mode is used with SSL_MODE_ACCEPT_MOVING_WRITE_BUFFER|SSL_MODE_ENABLE_PARTIAL_WRITE at least when BIO are used. This does not seem to affect IO::Socket::SSL which does not make use BIO but it might affect AnyEvent::TLS.
Anyway, this  SSL_CTX_set_mode is not needed for this test so I removed this line from the test.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; and with openssl-0.9.8i+extensions
&gt; I get 
&gt; 
&gt; #   Failed test &#39;handshake with reuse&#39;
&gt; #   at t/local/64_ticket_sharing.t line 40.
&gt; #          got: &#39;full&#39;
&gt; #     expected: &#39;reuse&#39;
</div>
This happened because 0.9.8 by default uses an SSL 2.0 record and thus does not support TLS extensions.
Fixed by explicitly using a TLS 1.0 context.

 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; and with /openssl-1.0.0 I get:
&gt; 
&gt; t/local/64_ticket_sharing.t ............ 1/15 
&gt; error:00000001:lib&#40;0&#41;:func&#40;0&#41;:reason&#40;1&#41; at t/local/64_ticket_sharing.t line 
</div>
OpenSSL 1.0.0 &#40;tried 1.0.0t&#41; is really weird. Looks like SSL_do_handshake and the handshake on the wire are kind of broken if session ticket key callback indicates that a renew of the ticket should be done. In this case SSL_do_handshake will indicate that it still requires more data, the key callback will be called multiple times to generate a new ticket and on the wire one can see several unexpected Encrypted Handshake Message and also an unexpected repeated Change Cipher Spec message.
I handle this behavior as special case in the test now.

Attached is the new patch, with the reworked test.

Regards,
Steffen
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> SSLeay.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1648728/884540/SSLeay.patch">Download SSLeay.patch</a><br />
<span class="downloadcontenttype">text/x-diff 15.3k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1648788" href="/Public/Bug/Display.html?id=116118#txn-1648788">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;14&nbsp;15:15:10&nbsp;2016</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1648788/884573/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/884573">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 384b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Do 14. Jul 2016, 13:01:13, SULLR schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ...
&gt; This looks for me like a bug in openssl-1.1.0 
</div>
Fortunately this is not a bug in OpenSSL. I just used SSL_CTX_set_mode instead of SSL_set_mode on the SSL object and the code only crashed with 1.1.0 although it was invalid was all the others too. No further changes to the patch needed since I&#39;ve remove the use of SSL_CTX_set_mode.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1648920" href="/Public/Bug/Display.html?id=116118#txn-1648920">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;15&nbsp;01:41:29&nbsp;2016</span>
    <span class="description">mikem [...] airspayce.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #116118] Support for cross context session ticket sharing using  SSL_CTX_set_tlsext_ticket_key_cb</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 15 Jul 2016 15:41:12 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] airspayce.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1648920/884659/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/884659">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Steffen,

Thanks thats much better, but:
openssl-1.0.0d and openssl-1.0.0, where I get:

mikem@zulu:/usr/local/projects/net-ssleay/trunk$ perl -I blib/lib -I 
blib/arch/ t/local/64_ticket_sharing.t 
1..15
ok 1 - initial handshake is full
ok 2 - another full handshake
ok 3 - handshake with reuse
ok 4 - handshake again with reuse
ok 5 - handshake with server2 is full
ok 6 - initial full handshake with server1
ok 7 - reuse session with server1
ok 8 - reuse session with server2
error:00000001:lib&#40;0&#41;:func&#40;0&#41;:reason&#40;1&#41; at t/local/64_ticket_sharing.t line 
262.
# Looks like you planned 15 tests but ran 8.
# Looks like your test exited with 255 just after 8.

all else is good, including openssl-1.1.0, openssl-0.9.8i+extensions and 
libressl-2.4.1, and many other 1.0.x

Cheers.

On Thursday, July 14, 2016 01:01:14 PM Steffen Ullrich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=116118">https://rt.cpan.org/Ticket/Display.html?id=116118</a></span> &gt;
&gt; 
&gt; Am Do 14. Jul 2016, 07:21:02, mikem@airspayce.com schrieb:
<div class="message-stanza open">&gt; &gt; Hi Steffen,
&gt; &gt; 
&gt; &gt; thanks for the update. Compiles OK now.
&gt; &gt; 
&gt; &gt; Alas I find that with openssl-1.1.0 I get a segfault in
&gt; &gt; t/local/64_ticket_sharing.t
</div>&gt; 
&gt; This looks for me like a bug in openssl-1.1.0 which corrupts some memory
&gt; when SSL_CTX_set_mode is used with
&gt; SSL_MODE_ACCEPT_MOVING_WRITE_BUFFER|SSL_MODE_ENABLE_PARTIAL_WRITE at least
&gt; when BIO are used. This does not seem to affect IO::Socket::SSL which does
&gt; not make use BIO but it might affect AnyEvent::TLS. Anyway, this 
&gt; SSL_CTX_set_mode is not needed for this test so I removed this line from
&gt; the test.
<div class="message-stanza open">&gt; &gt; and with openssl-0.9.8i+extensions
&gt; &gt; I get
&gt; &gt; 
&gt; &gt; #   Failed test &#39;handshake with reuse&#39;
&gt; &gt; #   at t/local/64_ticket_sharing.t line 40.
&gt; &gt; #          got: &#39;full&#39;
&gt; &gt; #     expected: &#39;reuse&#39;
</div>&gt; 
&gt; This happened because 0.9.8 by default uses an SSL 2.0 record and thus does
&gt; not support TLS extensions. Fixed by explicitly using a TLS 1.0 context.
&gt; 
<div class="message-stanza open">&gt; &gt; and with /openssl-1.0.0 I get:
&gt; &gt; 
&gt; &gt; t/local/64_ticket_sharing.t ............ 1/15
&gt; &gt; error:00000001:lib&#40;0&#41;:func&#40;0&#41;:reason&#40;1&#41; at t/local/64_ticket_sharing.t
&gt; &gt; line
</div>&gt; 
&gt; OpenSSL 1.0.0 &#40;tried 1.0.0t&#41; is really weird. Looks like SSL_do_handshake
&gt; and the handshake on the wire are kind of broken if session ticket key
&gt; callback indicates that a renew of the ticket should be done. In this case
&gt; SSL_do_handshake will indicate that it still requires more data, the key
&gt; callback will be called multiple times to generate a new ticket and on the
&gt; wire one can see several unexpected Encrypted Handshake Message and also an
&gt; unexpected repeated Change Cipher Spec message. I handle this behavior as
&gt; special case in the test now.
&gt; 
&gt; Attached is the new patch, with the reworked test.
&gt; 
&gt; Regards,
&gt; Steffen
</div>
-- 
Mike McCauley           VK4AMM                   mikem@airspayce.com
Airspayce Pty Ltd 9 Bulbul Place Currumbin Waters QLD 4223 Australia   
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.airspayce.com">http://www.airspayce.com</a></span>
Phone +61 7 5598-7474
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1648933" href="/Public/Bug/Display.html?id=116118#txn-1648933">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;15&nbsp;02:19:33&nbsp;2016</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1648933/884670/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/884670">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 574b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Fr 15. Jul 2016, 01:41:29, mikem@airspayce.com schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ...
&gt; ok 8 - reuse session with server2
&gt; error:00000001:lib&#40;0&#41;:func&#40;0&#41;:reason&#40;1&#41; at t/local/64_ticket_sharing.t
</div>
That&#39;s not funny anymore. It looks like that while support for SSL_CTX_set_tlsext_ticket_key_cb was added with 0.9.8 already it was unstable...broken in various ways in the 1.0.0. versions. In the specific case of 1.0.0d the client could not handle the session ticket created by the server which caused this error. 
Therefore I&#39;ve enabled the feature now only for 1.0.1 and better.

Regards,
Steffen
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> SSLeay.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1648933/884671/SSLeay.patch">Download SSLeay.patch</a><br />
<span class="downloadcontenttype">text/x-diff 15.8k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1648942" href="/Public/Bug/Display.html?id=116118#txn-1648942">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;15&nbsp;02:36:20&nbsp;2016</span>
    <span class="description">mikem [...] airspayce.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #116118] Support for cross context session ticket sharing using  SSL_CTX_set_tlsext_ticket_key_cb</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 15 Jul 2016 16:35:52 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] airspayce.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1648942/884676/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/884676">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1021b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Steffen,

thanks thats all good now.

Pushed to SVN version 470

Cheers.



On Friday, July 15, 2016 02:19:34 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=116118">https://rt.cpan.org/Ticket/Display.html?id=116118</a></span> &gt;
&gt; 
&gt; Am Fr 15. Jul 2016, 01:41:29, mikem@airspayce.com schrieb:
<div class="message-stanza open">&gt; &gt; ...
&gt; &gt; ok 8 - reuse session with server2
&gt; &gt; error:00000001:lib&#40;0&#41;:func&#40;0&#41;:reason&#40;1&#41; at t/local/64_ticket_sharing.t
</div>&gt; 
&gt; That&#39;s not funny anymore. It looks like that while support for
&gt; SSL_CTX_set_tlsext_ticket_key_cb was added with 0.9.8 already it was
&gt; unstable...broken in various ways in the 1.0.0. versions. In the specific
&gt; case of 1.0.0d the client could not handle the session ticket created by
&gt; the server which caused this error. Therefore I&#39;ve enabled the feature now
&gt; only for 1.0.1 and better.
&gt; 
&gt; Regards,
&gt; Steffen
</div>
-- 
Mike McCauley           VK4AMM                   mikem@airspayce.com
Airspayce Pty Ltd 9 Bulbul Place Currumbin Waters QLD 4223 Australia   
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.airspayce.com">http://www.airspayce.com</a></span>
Phone +61 7 5598-7474
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1661159" href="/Public/Bug/Display.html?id=116118#txn-1661159">#</a>      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;23&nbsp;07:34:58&nbsp;2016</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1661159/891648/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/891648">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 689b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Fr 15. Jul 2016, 02:36:20, mikem@airspayce.com schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Steffen,
&gt; 
&gt; thanks thats all good now.
&gt; 
</div>
Hi Mike,
while writing a test for IO::Socket::SSL I&#39;ve noticed some very weird behavior, like unexpected changes in the control flow of the Perl program which seemed to be triggered by the ticket key callback. Turns out that these effects were caused by missing cleanups in the XS code, i.e. PUTBACK, FREETMPS and LEAVE :&#40;

The attached patch resolves this issue. I&#39;ve tested it with openssl versions 1.0.2g, 1.0.2c, 1.1.0 and 1.0.1. I don&#39;t expect any problems with other versions since the code is basically doing the same as before, only with proper cleanups at the right time.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> SSLeay.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1661159/891649/SSLeay.patch">Download SSLeay.patch</a><br />
<span class="downloadcontenttype">text/x-diff 2.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: SSLeay.xs
===================================================================
--- SSLeay.xs	&#40;revision 478&#41;
+++ SSLeay.xs	&#40;working copy&#41;
@@ -1256,12 +1256,11 @@
 &#41;{
 
     dSP;
-    int count;
+    int count,usable_rv_count;
     SV *cb_func, *cb_data;
-    SV *sv_name, *sv_key;
     STRLEN svlen;
-    unsigned char *key;  /* key[0..15] aes, key[16..32] hmac */
-    unsigned char *name;
+    unsigned char key[32];  /* key[0..15] aes, key[16..32] hmac */
+    unsigned char name[16];
     SSL_CTX *ctx = SSL_get_SSL_CTX&#40;ssl&#41;;
 
     PR1&#40;&#34;STARTED: tlsext_ticket_key_cb_invoke\n&#34;&#41;;
@@ -1274,6 +1273,7 @@
     ENTER;
     SAVETMPS;
     PUSHMARK&#40;SP&#41;;
+
     XPUSHs&#40;sv_2mortal&#40;newSVsv&#40;cb_data&#41;&#41;&#41;;
 
     if &#40;!enc&#41; {
@@ -1283,29 +1283,50 @@
 	/* call as getkey&#40;data&#41; -&gt; &#40;key,current_name&#41; */
     }
 
+    PUTBACK;
 
-    PUTBACK;
     count = call_sv&#40; cb_func, G_ARRAY &#41;;
 
     SPAGAIN;
-    if &#40;count&gt;0&#41; sv_name = POPs;
-    if &#40;count&gt;1&#41; sv_key = POPs;
 
-    if &#40;!enc &#38;&#38; &#40; !count || !SvOK&#40;sv_key&#41; &#41;&#41; {
+    if &#40;count&gt;2&#41;
+	croak&#40;&#34;too much return values - only &#40;name,key&#41; should be returned&#34;&#41;;
+
+    usable_rv_count = 0;
+    if &#40;count&gt;0&#41; {
+	SV *sname = POPs;
+	if &#40;SvOK&#40;sname&#41;&#41; {
+	    unsigned char *pname = SvPV&#40;sname,svlen&#41;;
+	    if &#40;svlen &gt; 16&#41;
+		croak&#40;&#34;name must be at at most 16 bytes, got %d&#34;,svlen&#41;;
+	    if &#40;svlen == 0&#41;
+		croak&#40;&#34;name should not be empty&#34;&#41;;
+	    memset&#40;name, 0, 16&#41;;
+	    memcpy&#40;name,pname,svlen&#41;;
+	    usable_rv_count++;
+	}
+    }
+    if &#40;count&gt;1&#41; {
+	SV *skey = POPs;
+	if &#40;SvOK&#40;skey&#41;&#41; {
+	    unsigned char *pkey = SvPV&#40;skey,svlen&#41;;
+	    if &#40;svlen != 32&#41;
+		croak&#40;&#34;key must be exactly 32 random bytes, got %d&#34;,svlen&#41;;
+	    memcpy&#40;key,pkey,32&#41;;
+	    usable_rv_count++;
+	}
+    }
+
+    PUTBACK;
+    FREETMPS;
+    LEAVE;
+
+    if &#40;!enc &#38;&#38; usable_rv_count == 0&#41; {
 	TRACE&#40;2,&#34;no key returned for ticket&#34;&#41;;
 	return 0;
     }
-
-    if &#40;count != 2&#41;
+    if &#40;usable_rv_count != 2&#41;
 	croak&#40;&#34;key functions needs to return &#40;key,name&#41;&#34;&#41;;
-    key = SvPV&#40;sv_key,svlen&#41;;
-    if &#40;svlen &lt; 32&#41;
-	croak&#40;&#34;key must be at least 32 random bytes, got %d&#34;,svlen&#41;;
-    name = SvPV&#40;sv_name,svlen&#41;;
-    if &#40;svlen != 16&#41;
-	croak&#40;&#34;name should be exactly 16 characters, got %d&#34;,svlen&#41;;
-    if &#40;svlen == 0&#41;
-	croak&#40;&#34;name should not be empty&#34;&#41;;
 
     if &#40;enc&#41; {
 	/* encrypt ticket information with given key */
@@ -1312,18 +1333,14 @@
 	RAND_bytes&#40;iv, 16&#41;;
 	EVP_EncryptInit_ex&#40;ectx, EVP_aes_128_cbc&#40;&#41;, NULL, key, iv&#41;;
 	HMAC_Init_ex&#40;hctx,key+16,16,EVP_sha256&#40;&#41;,NULL&#41;;
-	memset&#40;key_name, 0, 16&#41;;
-	memcpy&#40;key_name,name,svlen&#41;;
+	memcpy&#40;key_name,name,16&#41;;
 	return 1;
+
     } else {
-	unsigned char new_name[16];
-	memset&#40;new_name, 0, sizeof&#40;new_name&#41;&#41;;
-	memcpy&#40;new_name,name,svlen&#41;;
-
 	HMAC_Init_ex&#40;hctx,key+16,16,EVP_sha256&#40;&#41;,NULL&#41;;
 	EVP_DecryptInit_ex&#40;ectx, EVP_aes_128_cbc&#40;&#41;, NULL, key, iv&#41;;
 
-	if &#40;memcmp&#40;new_name,key_name,16&#41; == 0&#41;
+	if &#40;memcmp&#40;name,key_name,16&#41; == 0&#41;
 	    return 1;  /* current key was used */
 	else 
 	    return 2;  /* different key was used, need to be renewed */
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1661176" href="/Public/Bug/Display.html?id=116118#txn-1661176">#</a>      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;23&nbsp;09:45:33&nbsp;2016</span>
    <span class="description">mikem [...] airspayce.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #116118] Support for cross context session ticket sharing using  SSL_CTX_set_tlsext_ticket_key_cb</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 23 Aug 2016 15:45:17 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] airspayce.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1661176/891657/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/891657">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks Steffens
I&#39;m travelling at the moment and won&#39;t get a chance to patch this until October 

Cheers

Sent from my iPhone

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 23 Aug 2016, at 1:34 PM, Steffen Ullrich via RT &lt;bug-Net-SSLeay@rt.cpan.org&gt; wrote:
&gt; 
&gt;       Queue: Net-SSLeay
&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=116118">https://rt.cpan.org/Ticket/Display.html?id=116118</a></span> &gt;
&gt; 
&gt; Am Fr 15. Jul 2016, 02:36:20, mikem@airspayce.com schrieb:
<div class="message-stanza open">&gt;&gt; Hi Steffen,
&gt;&gt; 
&gt;&gt; thanks thats all good now.
</div>&gt; 
&gt; Hi Mike,
&gt; while writing a test for IO::Socket::SSL I&#39;ve noticed some very weird behavior, like unexpected changes in the control flow of the Perl program which seemed to be triggered by the ticket key callback. Turns out that these effects were caused by missing cleanups in the XS code, i.e. PUTBACK, FREETMPS and LEAVE :&#40;
&gt; 
&gt; The attached patch resolves this issue. I&#39;ve tested it with openssl versions 1.0.2g, 1.0.2c, 1.1.0 and 1.0.1. I don&#39;t expect any problems with other versions since the code is basically doing the same as before, only with proper cleanups at the right time.
&gt; Index: SSLeay.xs =================================================================== --- SSLeay.xs    &#40;revision 478&#41; +++ SSLeay.xs    &#40;working copy&#41; @@ -1256,12 +1256,11 @@ &#41;{ dSP; - int count; + int count,usable_rv_count; SV *cb_func, *cb_data; - SV *sv_name, *sv_key; STRLEN svlen; - unsigned char *key; /* key[0..15] aes, key[16..32] hmac */ - unsigned char *name; + unsigned char key[32]; /* key[0..15] aes, key[16..32] hmac */ +    unsigned char name[16]; SSL_CTX *ctx = SSL_get_SSL_CTX&#40;ssl&#41;; PR1&#40;&#34;STARTED: tlsext_ticket_key_cb_invoke\n&#34;&#41;; @@ -1274,6 +1273,7 @@ ENTER; SAVETMPS; PUSHMARK&#40;SP&#41;; + XPUSHs&#40;sv_2mortal&#40;newSVsv&#40;cb_data&#41;&#41;&#41;; if &#40;!enc&#41; { @@ -1283,29 +1283,50 @@ /* call as getkey&#40;data&#41; -&gt; &#40;key,current_name&#41; */ } + PUTBACK; - PUTBACK; count = call_sv&#40; cb_func, G_ARRAY &#41;; SPAGAIN; - if &#40;count&gt;0&#41; sv_name = POPs; - if &#40;count&gt;1&#41; sv_key = POPs; -    if &#40;!enc &#38;&#38; &#40; !count || !SvOK&#40;sv_key&#41; &#41;&#41; { + if &#40;count&gt;2&#41; +        croak&#40;&#34;too much return values - only &#40;name,key&#41; should be returned&#34;&#41;; + + usable_rv_count = 0; + if &#40;count&gt;0&#41; { +       SV *sname = POPs; +     if &#40;SvOK&#40;sname&#41;&#41; { +    unsigned char *pname = SvPV&#40;sname,svlen&#41;; +     if &#40;svlen &gt; 16&#41; +       croak&#40;&#34;name must be at at most 16 bytes, got %d&#34;,svlen&#41;; +      if &#40;svlen == 0&#41; +       croak&#40;&#34;name should not be empty&#34;&#41;; + memset&#40;name, 0, 16&#41;; + memcpy&#40;name,pname,svlen&#41;; + usable_rv_count++; +    } + } + if &#40;count&gt;1&#41; { +        SV *skey = POPs; +      if &#40;SvOK&#40;skey&#41;&#41; { +     unsigned char *pkey = SvPV&#40;skey,svlen&#41;; +       if &#40;svlen != 32&#41; +      croak&#40;&#34;key must be exactly 32 random bytes, got %d&#34;,svlen&#41;; + memcpy&#40;key,pkey,32&#41;; + usable_rv_count++; +       } + } + + PUTBACK; + FREETMPS; + LEAVE; + + if &#40;!enc &#38;&#38; usable_rv_count == 0&#41; {         TRACE&#40;2,&#34;no key returned for ticket&#34;&#41;; return 0; } - - if &#40;count != 2&#41; + if &#40;usable_rv_count != 2&#41; croak&#40;&#34;key functions needs to return &#40;key,name&#41;&#34;&#41;; - key = SvPV&#40;sv_key,svlen&#41;; - if &#40;svlen &lt; 32&#41; -   croak&#40;&#34;key must be at least 32 random bytes, got %d&#34;,svlen&#41;; - name = SvPV&#40;sv_name,svlen&#41;; - if &#40;svlen != 16&#41; - croak&#40;&#34;name should be exactly 16 characters, got %d&#34;,svlen&#41;; - if &#40;svlen == 0&#41; -        croak&#40;&#34;name should not be empty&#34;&#41;; if &#40;enc&#41; { /* encrypt ticket information with given key */ @@ -1312,18 +1333,14 @@ RAND_bytes&#40;iv, 16&#41;; EVP_EncryptInit_ex&#40;ectx, EVP_aes_128_cbc&#40;&#41;, NULL, key, iv&#41;; HMAC_Init_ex&#40;hctx,key+16,16,EVP_sha256&#40;&#41;,NULL&#41;; - memset&#40;key_name, 0, 16&#41;; -      memcpy&#40;key_name,name,svlen&#41;; +  memcpy&#40;key_name,name,16&#41;; return 1; + } else { -        unsigned char new_name[16]; -   memset&#40;new_name, 0, sizeof&#40;new_name&#41;&#41;; -        memcpy&#40;new_name,name,svlen&#41;; - HMAC_Init_ex&#40;hctx,key+16,16,EVP_sha256&#40;&#41;,NULL&#41;; EVP_DecryptInit_ex&#40;ectx, EVP_aes_128_cbc&#40;&#41;, NULL, key, iv&#41;; -    if &#40;memcmp&#40;new_name,key_name,16&#41; == 0&#41; +        if &#40;memcmp&#40;name,key_name,16&#41; == 0&#41;          return 1; /* current key was used */ else return 2; /* different key was used, need to be renewed */
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1696146" href="/Public/Bug/Display.html?id=116118#txn-1696146">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;03&nbsp;16:35:25&nbsp;2017</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1696146/910890/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/910890">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 534b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Di 23. Aug 2016, 09:45:33, mikem@airspayce.com schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks Steffens
&gt;  I&#39;m travelling at the moment and won&#39;t get a chance to patch this
&gt; until October
</div>
Hi Mike,
unfortunately Net::SSLeay 1.79 was released without my latest patch which means that the feature is still not official usable from IO::Socket::SSL and the related tests will fail. I&#39;m using this patch for several month in production without problems now. It would be nice if you could make a release in the next time which includes this patch.

Regards,
Steffen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1696397" href="/Public/Bug/Display.html?id=116118#txn-1696397">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;04&nbsp;16:41:10&nbsp;2017</span>
    <span class="description">mikem [...] airspayce.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #116118] Support for cross context session ticket sharing using  SSL_CTX_set_tlsext_ticket_key_cb</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 05 Jan 2017 07:40:54 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] airspayce.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1696397/911030/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/911030">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Steffen,

Sorry, I dont know what happened there. Your patch is now in the new version 
1.80.

Cheers.


On Tuesday, January 03, 2017 04:35:27 PM Steffen Ullrich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=116118">https://rt.cpan.org/Ticket/Display.html?id=116118</a></span> &gt;
&gt; 
&gt; Am Di 23. Aug 2016, 09:45:33, mikem@airspayce.com schrieb:
<div class="message-stanza open">&gt; &gt; Thanks Steffens
&gt; &gt; 
&gt; &gt;  I&#39;m travelling at the moment and won&#39;t get a chance to patch this
&gt; &gt; 
&gt; &gt; until October
</div>&gt; 
&gt; Hi Mike,
&gt; unfortunately Net::SSLeay 1.79 was released without my latest patch which
&gt; means that the feature is still not official usable from IO::Socket::SSL
&gt; and the related tests will fail. I&#39;m using this patch for several month in
&gt; production without problems now. It would be nice if you could make a
&gt; release in the next time which includes this patch.
&gt; 
&gt; Regards,
&gt; Steffen
</div>
-- 
Mike McCauley           VK4AMM                   mikem@airspayce.com
Airspayce Pty Ltd 9 Bulbul Place Currumbin Waters QLD 4223 Australia   
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.airspayce.com">http://www.airspayce.com</a></span>
Phone +61 7 5598-7474
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1696571" href="/Public/Bug/Display.html?id=116118#txn-1696571">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;05&nbsp;14:09:52&nbsp;2017</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1696571/911111/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/911111">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 367b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Mi 04. Jan 2017, 16:41:10, mikem@airspayce.com schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Steffen,
&gt; 
&gt; Sorry, I dont know what happened there. Your patch is now in the new
&gt; version
&gt; 1.80.
&gt; 
&gt; Cheers.
</div>
Thanks for the quick response.
Tests now run successfully and I&#39;ve released a new version of IO::Socket::SL which enables this feature when used with Net::SSLeay&gt;= 1.80.

Regards,
Steffen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1696573" href="/Public/Bug/Display.html?id=116118#txn-1696573">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;05&nbsp;14:09:58&nbsp;2017</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.7159</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
