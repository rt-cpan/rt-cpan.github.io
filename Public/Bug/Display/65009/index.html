<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #65009 for Dancer-Plugin-FlashMessage: Message never shows up in template</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #65009 for Dancer-Plugin-FlashMessage: Message never shows up in template</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Dancer-Plugin-FlashMessage/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Dancer-Plugin-FlashMessage/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Dancer-Plugin-FlashMessage/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Dancer-Plugin-FlashMessage/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Dancer-Plugin-FlashMessage">Dancer-Plugin-FlashMessage CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">65009</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Dancer-Plugin-FlashMessage/Active/">Dancer-Plugin-FlashMessage</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">DAMS [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
lozier [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-236574-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-236575-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;21&nbsp;17:18:50&nbsp;2011</span>
    <span class="description">lozier [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Message never shows up in template</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am trying to follow the examples and am unable to get it to work as
advertised.  I can set a message with flash error =&gt; &#39;some error&#39;;  Then
I can verify that it exists in my session on the next page view:

[11520]  warn @0.001062&gt; [hit #1] $VAR1 = bless&#40; {
                 &#39;id&#39; =&gt; &#39;58434346941446644293786320501729180&#39;,
                 &#39;_flash&#39; =&gt; {
                             &#39;error&#39; =&gt; &#39;some warning message&#39;
                           }
               }, &#39;Dancer::Session::YAML&#39; &#41;; in
/home/brian/sites/goyaads/lib/goyaads.pm l. 14

My handler for that looks like this:

get &#39;/&#39; =&gt; sub {
    warning Dumper&#40;session&#40;&#41;&#41;;

    template&#40;&#39;index&#39;&#41;;
};

The main.tt has this in it:

  &lt;% IF flash.error %&gt;
    &lt;div class=error&gt; &lt;% flash.error %&gt; &lt;/div&gt;
  &lt;% END %&gt;

But the error never shows up.  The only way I can get it to show up is
to manually pull it out in the handler like this:

get &#39;/&#39; =&gt; sub {
    warning Dumper&#40;session&#40;&#41;&#41;;

    template&#40;&#39;index&#39;, {error =&gt; flash &#39;error&#39;}&#41;;
};

And then change the template to look like this:

  &lt;% IF error %&gt;
    &lt;div class=error&gt; &lt;% error %&gt; &lt;/div&gt;
  &lt;% END %&gt;

I would like to understand how &#34;flash.error&#34; is supposed to be set in
the template because it appears it never gets there.  Is the
documentation wrong?  Did I miss something?  Thanks!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;21&nbsp;17:34:42&nbsp;2011</span>
    <span class="description">lozier [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jan 21 17:18:50 2011, LOZIER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I am trying to follow the examples and am unable to get it to work as
&gt; advertised.  I can set a message with flash error =&gt; &#39;some error&#39;;  Then
&gt; I can verify that it exists in my session on the next page view:
&gt; 
&gt; [11520]  warn @0.001062&gt; [hit #1] $VAR1 = bless&#40; {
&gt;                  &#39;id&#39; =&gt; &#39;58434346941446644293786320501729180&#39;,
&gt;                  &#39;_flash&#39; =&gt; {
&gt;                              &#39;error&#39; =&gt; &#39;some warning message&#39;
&gt;                            }
&gt;                }, &#39;Dancer::Session::YAML&#39; &#41;; in
&gt; /home/brian/sites/goyaads/lib/goyaads.pm l. 14
&gt; 
&gt; My handler for that looks like this:
&gt; 
&gt; get &#39;/&#39; =&gt; sub {
&gt;     warning Dumper&#40;session&#40;&#41;&#41;;
&gt; 
&gt;     template&#40;&#39;index&#39;&#41;;
&gt; };
&gt; 
&gt; The main.tt has this in it:
&gt; 
&gt;   &lt;% IF flash.error %&gt;
&gt;     &lt;div class=error&gt; &lt;% flash.error %&gt; &lt;/div&gt;
&gt;   &lt;% END %&gt;
&gt; 
&gt; But the error never shows up.  The only way I can get it to show up is
&gt; to manually pull it out in the handler like this:
&gt; 
&gt; get &#39;/&#39; =&gt; sub {
&gt;     warning Dumper&#40;session&#40;&#41;&#41;;
&gt; 
&gt;     template&#40;&#39;index&#39;, {error =&gt; flash &#39;error&#39;}&#41;;
&gt; };
&gt; 
&gt; And then change the template to look like this:
&gt; 
&gt;   &lt;% IF error %&gt;
&gt;     &lt;div class=error&gt; &lt;% error %&gt; &lt;/div&gt;
&gt;   &lt;% END %&gt;
&gt; 
&gt; I would like to understand how &#34;flash.error&#34; is supposed to be set in
&gt; the template because it appears it never gets there.  Is the
&gt; documentation wrong?  Did I miss something?  Thanks!
</div>
I was able to get this to work suddenly using your examples but the
flash message is persistent.  The only way to get rid of it is to call
flash &#39;error&#39;; which is not called by default when the value is rendered
in the template.  I think the example is broken, in order to get the
correct behavior I have to call the flash &#39;error&#39; function manually as
in my last message anyway.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;21&nbsp;17:34:43&nbsp;2011</span>
    <span class="description">lozier [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;23&nbsp;13:23:15&nbsp;2011</span>
    <span class="description">DAMS [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;23&nbsp;13:28:27&nbsp;2011</span>
    <span class="description">DAMS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

thanks for your bug report.

I have fixed the persistence issue. Now by default flash messages are not persistent : they are 
removed from the session at the end of the request.

Note that it&#39;s at the end of the request, not just after the first template has been issued. You 
can potentially do more than one view or layout rendering in the same request. They would 
all see the flash message. At the end of the request however, the flash messages hash is 
removed.

That is, unless you override the default, and set &#39;persistence&#39; to a true value in the 
configuration.

I&#39;ve juste pushed version 0.305 which implements all that. Let me know if it works for you.

About your troubles at the beginning of your bug report : what was the issue ? Even if you 
figured it out, I&#39;d be interested to know if I could make it easier for user to make it work, 
maybe by updating the doc.

Thanks,
dams
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;26&nbsp;10:32:51&nbsp;2011</span>
    <span class="description">lozier [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65009] Message never shows up in template</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 26 Jan 2011 07:32:22 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Dancer-Plugin-FlashMessage [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Brian E. Lozier&#34; &lt;brian [...] massassi.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for your prompt attention.  Unfortunately I am unable to
reproduce the original error.  I may have been doing something wrong
as I&#39;m new to Dancer.

To address the changes you made to the Plugin, I think we&#39;re moving in
the right direction.  However, here is how I think of flash messages
and how they should work.  If I&#39;m not thinking of this correctly,
please tell me.

A user submits a form.  We want to process the form and send a message
back to the user that the form was processed successfully.  We
typically don&#39;t want to have the success message on the same page as
the form processing because it&#39;s too easy to accidentally press reload
and resubmit the data.  So the normal pattern we use is:

show a form
user posts to /process
/process processes the form, sets a flash message, and then forwards
the user to /something-else
since the flash message is saved in a session, it&#39;s available on
/something-else even though it&#39;s a separate request
/something-else shows the flash message, and then importantly, deletes
the flash message from the session so it doesn&#39;t get shown again

I like to have &#34;global&#34; handling of flash messages.  &#40;I&#39;ve typically
done this myself using CGI::Application&#41;.  This means that the flash
messages should only ever be shown once but that they should only be
deleted when we&#39;re sure they were shown.  So for my Dancer app I&#39;m
working on I made a before_template hook to delete the flash message.
This isn&#39;t ideal because it&#39;s not guaranteed that every time I show a
template it&#39;s the &#34;layout&#34; which has the flash message handling.

I&#39;m not familiar with writing Dancer plugins but it seems like the
most useful case would be to, instead of just providing the data to
the template, maybe provide a function to the template.  When called,
the function would fetch the message from the session and then delete
it from the session and then return it.  That way, I wouldn&#39;t have to
have any extra logic to try to figure out whether it&#39;s shown.  The
perl logic looks something like this, I&#39;m not sure how to make that
work with template::toolkit or whatever:

if&#40;my $warning  = flash&#40;&#39;warning&#39;&#41;&#41; {
  show_warning&#40;$warning&#41;;
}

In order to please template::toolkit or others, it may be that we need
two functions, something like flash_exists&#40;&#39;warning&#39;&#41; and then the
flash&#40;&#39;warning&#39;&#41; itself.  With those, the logic for showing flash
messages and deleting them from the session will reside solely in the
plugin and the template.  In the application logic, all we have to do
is set the flash message and then the rest is taken care of
automatically.

On Sun, Jan 23, 2011 at 10:28 AM, Damien Krotkine via RT
&lt;bug-Dancer-Plugin-FlashMessage@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=65009">https://rt.cpan.org/Ticket/Display.html?id=65009</a></span> &gt;
&gt;
&gt; Hi,
&gt;
&gt; thanks for your bug report.
&gt;
&gt; I have fixed the persistence issue. Now by default flash messages are not persistent : they are
&gt; removed from the session at the end of the request.
&gt;
&gt; Note that it&#39;s at the end of the request, not just after the first template has been issued. You
&gt; can potentially do more than one view or layout rendering in the same request. They would
&gt; all see the flash message. At the end of the request however, the flash messages hash is
&gt; removed.
&gt;
&gt; That is, unless you override the default, and set &#39;persistence&#39; to a true value in the
&gt; configuration.
&gt;
&gt; I&#39;ve juste pushed version 0.305 which implements all that. Let me know if it works for you.
&gt;
&gt; About your troubles at the beginning of your bug report : what was the issue ? Even if you
&gt; figured it out, I&#39;d be interested to know if I could make it easier for user to make it work,
&gt; maybe by updating the doc.
&gt;
&gt; Thanks,
&gt; dams
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;08&nbsp;06:48:28&nbsp;2011</span>
    <span class="description">DAMS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">These issues should be resolved in the latest version of the module. Please reopen this ticket if 
it&#39;s not the case.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;08&nbsp;06:48:29&nbsp;2011</span>
    <span class="description">DAMS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
