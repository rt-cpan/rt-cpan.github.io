<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #49666 for POE-Component-MessageQueue: Messages in queue are out of order.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #49666 for POE-Component-MessageQueue: Messages in queue are out of order.</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/POE-Component-MessageQueue/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/POE-Component-MessageQueue/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/POE-Component-MessageQueue/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/POE-Component-MessageQueue/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="http://github.com/ironcamel/POE-Component-MessageQueue/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/POE-Component-MessageQueue">POE-Component-MessageQueue CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">49666</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/POE-Component-MessageQueue/Active/">POE-Component-MessageQueue</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
IRONCAMEL [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-42374-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.2.6    </td>
  </tr>
  <tr id="CF-42375-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;13&nbsp;02:52:25&nbsp;2009</span>
    <span class="description">IRONCAMEL [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Messages in queue are out of order.</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have a simple script that produces 10 messages.  When I consume them,
the messages are out of order.  If I uncomment the sleep 1, then it
works correctly.  Shouldn&#39;t order be guaranteed since this is a queue? 
What am I not understanding?

I have started mq.pl with no arguments.

Here is the relevant section of my producer code:

my $stomp = Net::Stomp-&gt;new&#40;{
    hostname =&gt; &#39;localhost&#39;,
    port     =&gt; 61613
}&#41;;
$stomp-&gt;connect&#40;&#41;;

for &#40;1 .. $numMessages&#41;
{
    print &#34;$_ adding $qpath: $message\n&#34;;
    $stomp-&gt;send&#40;{
        destination =&gt; &#34;$qpath&#34;,
        body        =&gt; &#34;$message$_&#34;,
        persistent  =&gt; &#39;true&#39;,
    }&#41;;
    #sleep 1;
}
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;13&nbsp;03:28:11&nbsp;2009</span>
    <span class="description">dsnopek [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
The MQ attempts to deliver messages in order, but puts performance above
order.

Specifically, there is one performance optimization which works as follows:

 - At the time a message is received, if there is a non-busy subscriber
an that queue, simply deliver the message right away.

So, lets say this happens:

 &#40;1&#41; Message 1 is sent and the subscriber isn&#39;t busy, so the message is
delivered right away.
 &#40;2&#41; Message 2 comes in, but the subscriber is still busy with message
1, so its stored to be delivered later.
 &#40;3&#41; Message 3 comes in right when the subscriber finishes with message
1, but before message 2 can be taken out of storage, so message 3 is
delivered.

I can&#39;t be sure that this is what is happening in your case.  The log
files would help.  However, if order is absolutely important to your
application, this optimization would need to be &#34;turned off&#34; however
there isn&#39;t a convenient way to do this now.  Patches would be welcome!

On Nie. 13 Wrz. 2009, 02:52:25, IRONCAMEL wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have a simple script that produces 10 messages.  When I consume them,
&gt; the messages are out of order.  If I uncomment the sleep 1, then it
&gt; works correctly.  Shouldn&#39;t order be guaranteed since this is a queue? 
&gt; What am I not understanding?
&gt; 
&gt; I have started mq.pl with no arguments.
&gt; 
&gt; Here is the relevant section of my producer code:
&gt; 
&gt; my $stomp = Net::Stomp-&gt;new&#40;{
&gt;     hostname =&gt; &#39;localhost&#39;,
&gt;     port     =&gt; 61613
&gt; }&#41;;
&gt; $stomp-&gt;connect&#40;&#41;;
&gt; 
&gt; for &#40;1 .. $numMessages&#41;
&gt; {
&gt;     print &#34;$_ adding $qpath: $message\n&#34;;
&gt;     $stomp-&gt;send&#40;{
&gt;         destination =&gt; &#34;$qpath&#34;,
&gt;         body        =&gt; &#34;$message$_&#34;,
&gt;         persistent  =&gt; &#39;true&#39;,
&gt;     }&#41;;
&gt;     #sleep 1;
&gt; }
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;13&nbsp;03:28:12&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;13&nbsp;04:01:12&nbsp;2009</span>
    <span class="description">naveedm9 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #49666] Messages in queue are out of order.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 13 Sep 2009 04:00:30 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE-Component-MessageQueue [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Naveed Massjouni &lt;naveedm9 [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Yes, order is very important in our application.  I am attaching the
log output in case it may help you confirm that the problem is what
you suspected.  I have the producer sending 10 messages while one
consumer was listening.

I would be happy to work on a patch, if you could point me in the
right direction.


RECV &#40;14&#41;: CONNECT :
RECV &#40;14&#41;: SEND message 174 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
QUEUE: Message 174 claimed by 13 during send
STORE: COMPLEX: FRONT: Added 174
Dispatching message 174 to client 13
RECV &#40;14&#41;: SEND message 175 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
STORE: COMPLEX: FRONT: Added 175
RECV &#40;14&#41;: SEND message 176 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
STORE: COMPLEX: FRONT: Added 176
RECV &#40;14&#41;: SEND message 177 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
STORE: COMPLEX: FRONT: Added 177
RECV &#40;14&#41;: SEND message 178 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
STORE: COMPLEX: FRONT: Added 178
RECV &#40;14&#41;: SEND message 179 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
STORE: COMPLEX: FRONT: Added 179
RECV &#40;14&#41;: SEND message 180 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
STORE: COMPLEX: FRONT: Added 180
RECV &#40;14&#41;: SEND message 181 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
STORE: COMPLEX: FRONT: Added 181
RECV &#40;14&#41;: SEND message 182 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
STORE: COMPLEX: FRONT: Added 182
RECV &#40;14&#41;: SEND message 183 &#40;2 bytes&#41; to /queue/test &#40;persistent: 1&#41;
STORE: COMPLEX: FRONT: Added 183
RECV &#40;14&#41;: DISCONNECT
MASTER: Removing client 14
RECV &#40;13&#41;: ACK - message 174
STORE: COMPLEX: FRONT: Message 177 claimed by client 13
Dispatching message 177 to client 13
RECV &#40;13&#41;: ACK - message 177
STORE: COMPLEX: FRONT: Message 176 claimed by client 13
Dispatching message 176 to client 13
RECV &#40;13&#41;: ACK - message 176
STORE: COMPLEX: FRONT: Message 175 claimed by client 13
Dispatching message 175 to client 13
RECV &#40;13&#41;: ACK - message 175
STORE: COMPLEX: FRONT: Message 180 claimed by client 13
Dispatching message 180 to client 13
RECV &#40;13&#41;: ACK - message 180
STORE: COMPLEX: FRONT: Message 179 claimed by client 13
Dispatching message 179 to client 13
RECV &#40;13&#41;: ACK - message 179
STORE: COMPLEX: FRONT: Message 178 claimed by client 13
Dispatching message 178 to client 13
RECV &#40;13&#41;: ACK - message 178
STORE: COMPLEX: FRONT: Message 183 claimed by client 13
Dispatching message 183 to client 13
RECV &#40;13&#41;: ACK - message 183
STORE: COMPLEX: FRONT: Message 182 claimed by client 13
Dispatching message 182 to client 13
RECV &#40;13&#41;: ACK - message 182
STORE: COMPLEX: FRONT: Message 181 claimed by client 13
Dispatching message 181 to client 13
RECV &#40;13&#41;: ACK - message 181

Regards,
Naveed

On Sun, Sep 13, 2009 at 3:28 AM, David Snopek via RT
&lt;bug-POE-Component-MessageQueue@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=49666">https://rt.cpan.org/Ticket/Display.html?id=49666</a></span> &gt;
&gt;
&gt;
&gt; The MQ attempts to deliver messages in order, but puts performance above
&gt; order.
&gt;
&gt; Specifically, there is one performance optimization which works as follows:
&gt;
&gt;  - At the time a message is received, if there is a non-busy subscriber
&gt; an that queue, simply deliver the message right away.
&gt;
&gt; So, lets say this happens:
&gt;
&gt;  &#40;1&#41; Message 1 is sent and the subscriber isn&#39;t busy, so the message is
&gt; delivered right away.
&gt;  &#40;2&#41; Message 2 comes in, but the subscriber is still busy with message
&gt; 1, so its stored to be delivered later.
&gt;  &#40;3&#41; Message 3 comes in right when the subscriber finishes with message
&gt; 1, but before message 2 can be taken out of storage, so message 3 is
&gt; delivered.
&gt;
&gt; I can&#39;t be sure that this is what is happening in your case.  The log
&gt; files would help.  However, if order is absolutely important to your
&gt; application, this optimization would need to be &#34;turned off&#34; however
&gt; there isn&#39;t a convenient way to do this now.  Patches would be welcome!
&gt;
&gt; On Nie. 13 Wrz. 2009, 02:52:25, IRONCAMEL wrote:
<div class="message-stanza open">&gt;&gt; I have a simple script that produces 10 messages.  When I consume them,
&gt;&gt; the messages are out of order.  If I uncomment the sleep 1, then it
&gt;&gt; works correctly.  Shouldn&#39;t order be guaranteed since this is a queue?
&gt;&gt; What am I not understanding?
&gt;&gt;
&gt;&gt; I have started mq.pl with no arguments.
&gt;&gt;
&gt;&gt; Here is the relevant section of my producer code:
&gt;&gt;
&gt;&gt; my $stomp = Net::Stomp-&gt;new&#40;{
&gt;&gt;     hostname =&gt; &#39;localhost&#39;,
&gt;&gt;     port     =&gt; 61613
&gt;&gt; }&#41;;
&gt;&gt; $stomp-&gt;connect&#40;&#41;;
&gt;&gt;
&gt;&gt; for &#40;1 .. $numMessages&#41;
&gt;&gt; {
&gt;&gt;     print &#34;$_ adding $qpath: $message\n&#34;;
&gt;&gt;     $stomp-&gt;send&#40;{
&gt;&gt;         destination =&gt; &#34;$qpath&#34;,
&gt;&gt;         body        =&gt; &#34;$message$_&#34;,
&gt;&gt;         persistent  =&gt; &#39;true&#39;,
&gt;&gt;     }&#41;;
&gt;&gt;     #sleep 1;
&gt;&gt; }
</div>&gt;
&gt;
&gt;
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;13&nbsp;09:09:04&nbsp;2009</span>
    <span class="description">dsnopek [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Actually, my suspicion was not on at all &#40;although, what I described
could genuinely affect order of message delivery&#41;.

It appears whats going on here, is that the front store
&#40;PoCo::MQ::Storage::BigMemory, assuming you are using the default
configuration&#41; is delivering the messages out-of-order which shouldn&#39;t
happen.

Can you try running the unit tests?  Specifically t/05_storage_api.t and
watch for tests 27 - 42.  Those tests depend on BigMemory returning the
results in order.

Also, you could try running mq.pl &#40;if you are, in fact, using mq.pl&#41;
with the option &#34;--front-store memory&#34;.  That will cause it to use the
much slower PoCo::MQ::Storage::Memory, but then we can atleast try and
isolate the bug to BigMemory.

And one last thing!  Are you using perl 5.8 or 5.10?  There are some
issues with 5.10 that haven&#39;t yet been fully explored.

Hopefully, we can get to the bottom of this.

On Nie. 13 Wrz. 2009, 01:01:12, naveedm9@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Yes, order is very important in our application.  I am attaching the
&gt; log output in case it may help you confirm that the problem is what
&gt; you suspected.  I have the producer sending 10 messages while one
&gt; consumer was listening.
&gt; 
&gt; I would be happy to work on a patch, if you could point me in the
&gt; right direction.
&gt; 
&gt; 
&gt; RECV &#40;14&#41;: CONNECT :
&gt; RECV &#40;14&#41;: SEND message 174 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
&gt; QUEUE: Message 174 claimed by 13 during send
&gt; STORE: COMPLEX: FRONT: Added 174
&gt; Dispatching message 174 to client 13
&gt; RECV &#40;14&#41;: SEND message 175 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
&gt; STORE: COMPLEX: FRONT: Added 175
&gt; RECV &#40;14&#41;: SEND message 176 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
&gt; STORE: COMPLEX: FRONT: Added 176
&gt; RECV &#40;14&#41;: SEND message 177 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
&gt; STORE: COMPLEX: FRONT: Added 177
&gt; RECV &#40;14&#41;: SEND message 178 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
&gt; STORE: COMPLEX: FRONT: Added 178
&gt; RECV &#40;14&#41;: SEND message 179 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
&gt; STORE: COMPLEX: FRONT: Added 179
&gt; RECV &#40;14&#41;: SEND message 180 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
&gt; STORE: COMPLEX: FRONT: Added 180
&gt; RECV &#40;14&#41;: SEND message 181 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
&gt; STORE: COMPLEX: FRONT: Added 181
&gt; RECV &#40;14&#41;: SEND message 182 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
&gt; STORE: COMPLEX: FRONT: Added 182
&gt; RECV &#40;14&#41;: SEND message 183 &#40;2 bytes&#41; to /queue/test &#40;persistent: 1&#41;
&gt; STORE: COMPLEX: FRONT: Added 183
&gt; RECV &#40;14&#41;: DISCONNECT
&gt; MASTER: Removing client 14
&gt; RECV &#40;13&#41;: ACK - message 174
&gt; STORE: COMPLEX: FRONT: Message 177 claimed by client 13
&gt; Dispatching message 177 to client 13
&gt; RECV &#40;13&#41;: ACK - message 177
&gt; STORE: COMPLEX: FRONT: Message 176 claimed by client 13
&gt; Dispatching message 176 to client 13
&gt; RECV &#40;13&#41;: ACK - message 176
&gt; STORE: COMPLEX: FRONT: Message 175 claimed by client 13
&gt; Dispatching message 175 to client 13
&gt; RECV &#40;13&#41;: ACK - message 175
&gt; STORE: COMPLEX: FRONT: Message 180 claimed by client 13
&gt; Dispatching message 180 to client 13
&gt; RECV &#40;13&#41;: ACK - message 180
&gt; STORE: COMPLEX: FRONT: Message 179 claimed by client 13
&gt; Dispatching message 179 to client 13
&gt; RECV &#40;13&#41;: ACK - message 179
&gt; STORE: COMPLEX: FRONT: Message 178 claimed by client 13
&gt; Dispatching message 178 to client 13
&gt; RECV &#40;13&#41;: ACK - message 178
&gt; STORE: COMPLEX: FRONT: Message 183 claimed by client 13
&gt; Dispatching message 183 to client 13
&gt; RECV &#40;13&#41;: ACK - message 183
&gt; STORE: COMPLEX: FRONT: Message 182 claimed by client 13
&gt; Dispatching message 182 to client 13
&gt; RECV &#40;13&#41;: ACK - message 182
&gt; STORE: COMPLEX: FRONT: Message 181 claimed by client 13
&gt; Dispatching message 181 to client 13
&gt; RECV &#40;13&#41;: ACK - message 181
&gt; 
&gt; Regards,
&gt; Naveed
&gt; 
&gt; On Sun, Sep 13, 2009 at 3:28 AM, David Snopek via RT
&gt; &lt;bug-POE-Component-MessageQueue@rt.cpan.org&gt; wrote:
<div class="message-stanza open">&gt; &gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=49666">https://rt.cpan.org/Ticket/Display.html?id=49666</a></span> &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; The MQ attempts to deliver messages in order, but puts performance
</div>&gt; above
<div class="message-stanza open">&gt; &gt; order.
&gt; &gt;
&gt; &gt; Specifically, there is one performance optimization which works as
</div>&gt; follows:
<div class="message-stanza open">&gt; &gt;
&gt; &gt;  - At the time a message is received, if there is a non-busy
</div>&gt; subscriber
<div class="message-stanza open">&gt; &gt; an that queue, simply deliver the message right away.
&gt; &gt;
&gt; &gt; So, lets say this happens:
&gt; &gt;
&gt; &gt;  &#40;1&#41; Message 1 is sent and the subscriber isn&#39;t busy, so the message
</div>&gt; is
<div class="message-stanza open">&gt; &gt; delivered right away.
&gt; &gt;  &#40;2&#41; Message 2 comes in, but the subscriber is still busy with
</div>&gt; message
<div class="message-stanza open">&gt; &gt; 1, so its stored to be delivered later.
&gt; &gt;  &#40;3&#41; Message 3 comes in right when the subscriber finishes with
</div>&gt; message
<div class="message-stanza open">&gt; &gt; 1, but before message 2 can be taken out of storage, so message 3 is
&gt; &gt; delivered.
&gt; &gt;
&gt; &gt; I can&#39;t be sure that this is what is happening in your case.  The
</div>&gt; log
<div class="message-stanza open">&gt; &gt; files would help.  However, if order is absolutely important to your
&gt; &gt; application, this optimization would need to be &#34;turned off&#34; however
&gt; &gt; there isn&#39;t a convenient way to do this now.  Patches would be
</div>&gt; welcome!
<div class="message-stanza open">&gt; &gt;
&gt; &gt; On Nie. 13 Wrz. 2009, 02:52:25, IRONCAMEL wrote:
<div class="message-stanza open">&gt; &gt;&gt; I have a simple script that produces 10 messages.  When I consume
</div></div>&gt; them,
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt; the messages are out of order.  If I uncomment the sleep 1, then it
&gt; &gt;&gt; works correctly.  Shouldn&#39;t order be guaranteed since this is a
</div></div>&gt; queue?
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt; What am I not understanding?
&gt; &gt;&gt;
&gt; &gt;&gt; I have started mq.pl with no arguments.
&gt; &gt;&gt;
&gt; &gt;&gt; Here is the relevant section of my producer code:
&gt; &gt;&gt;
&gt; &gt;&gt; my $stomp = Net::Stomp-&gt;new&#40;{
&gt; &gt;&gt;     hostname =&gt; &#39;localhost&#39;,
&gt; &gt;&gt;     port     =&gt; 61613
&gt; &gt;&gt; }&#41;;
&gt; &gt;&gt; $stomp-&gt;connect&#40;&#41;;
&gt; &gt;&gt;
&gt; &gt;&gt; for &#40;1 .. $numMessages&#41;
&gt; &gt;&gt; {
&gt; &gt;&gt;     print &#34;$_ adding $qpath: $message\n&#34;;
&gt; &gt;&gt;     $stomp-&gt;send&#40;{
&gt; &gt;&gt;         destination =&gt; &#34;$qpath&#34;,
&gt; &gt;&gt;         body        =&gt; &#34;$message$_&#34;,
&gt; &gt;&gt;         persistent  =&gt; &#39;true&#39;,
&gt; &gt;&gt;     }&#41;;
&gt; &gt;&gt;     #sleep 1;
&gt; &gt;&gt; }
</div>&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt;
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;13&nbsp;21:53:21&nbsp;2009</span>
    <span class="description">naveedm9 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #49666] Messages in queue are out of order.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 13 Sep 2009 21:52:42 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE-Component-MessageQueue [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Naveed Massjouni &lt;naveedm9 [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun, Sep 13, 2009 at 9:09 AM, David Snopek via RT
&lt;bug-POE-Component-MessageQueue@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; Actually, my suspicion was not on at all &#40;although, what I described
&gt; could genuinely affect order of message delivery&#41;.
&gt;
&gt; It appears whats going on here, is that the front store
&gt; &#40;PoCo::MQ::Storage::BigMemory, assuming you are using the default
&gt; configuration&#41; is delivering the messages out-of-order which shouldn&#39;t
&gt; happen.
</div>
I was using the default configuration.  I had simply run: mq.pl --nouuids

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Can you try running the unit tests?  Specifically t/05_storage_api.t and
&gt; watch for tests 27 - 42.  Those tests depend on BigMemory returning the
&gt; results in order.
</div>
All the unit tests pass.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Also, you could try running mq.pl &#40;if you are, in fact, using mq.pl&#41;
&gt; with the option &#34;--front-store memory&#34;.  That will cause it to use the
&gt; much slower PoCo::MQ::Storage::Memory, but then we can atleast try and
&gt; isolate the bug to BigMemory.
</div>
Using the --front-store memory option didn&#39;t make a difference.  The
messages were still out of order.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; And one last thing!  Are you using perl 5.8 or 5.10?  There are some
&gt; issues with 5.10 that haven&#39;t yet been fully explored.
</div>
I am using perl 5.8.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hopefully, we can get to the bottom of this.
</div>
Agreed :&#41;
Naveed
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;13&nbsp;22:19:02&nbsp;2009</span>
    <span class="description">naveedm9 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #49666] Messages in queue are out of order.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 13 Sep 2009 22:18:24 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE-Component-MessageQueue [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Naveed Massjouni &lt;naveedm9 [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am providing logs of another run.  As before, I run the producer
script to produce 10 messages, using the script I posted earlier.
This time the consumer wasn&#39;t running.  Then I turn on the consumer.
This way the log lines for the producer and consumer are not
overlapping, so it may be easier to figure out what is going on.

I started the broker with &#34;sudo mq.pl --nouuids&#34;.

The lines starting with &#34;STORE: COMPLEX: FRONT: Added&#34; show that the
messages are arriving in the correct order &#40;254 .. 263&#41;.

The final order of the messages when they are consumed are:
&#40;254, 257, 256, 255, 260, 259, 258, 263, 262, 261&#41;

Here is the log.

*** Start log.  First I produce 10 messages:

MASTER: Removing client 12
RECV &#40;13&#41;: CONNECT :
RECV &#40;13&#41;: SEND message 254 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
STORE: COMPLEX: FRONT: Added 254
RECV &#40;13&#41;: SEND message 255 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
STORE: COMPLEX: FRONT: Added 255
RECV &#40;13&#41;: SEND message 256 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
STORE: COMPLEX: FRONT: Added 256
RECV &#40;13&#41;: SEND message 257 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
STORE: COMPLEX: FRONT: Added 257
RECV &#40;13&#41;: SEND message 258 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
STORE: COMPLEX: FRONT: Added 258
RECV &#40;13&#41;: SEND message 259 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
STORE: COMPLEX: FRONT: Added 259
RECV &#40;13&#41;: SEND message 260 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
STORE: COMPLEX: FRONT: Added 260
RECV &#40;13&#41;: SEND message 261 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
STORE: COMPLEX: FRONT: Added 261
RECV &#40;13&#41;: SEND message 262 &#40;1 bytes&#41; to /queue/test &#40;persistent: 1&#41;
STORE: COMPLEX: FRONT: Added 262
RECV &#40;13&#41;: SEND message 263 &#40;2 bytes&#41; to /queue/test &#40;persistent: 1&#41;
STORE: COMPLEX: FRONT: Added 263
RECV &#40;13&#41;: DISCONNECT
MASTER: Removing client 13
STORE: COMPLEX: Pushing expired messages &#40;254, 256, 255&#41; to backstore.
STORE: COMPLEX: BACK: THROTTLED: Added 256.
STORE: COMPLEX: BACK: Sending throttled message 256 &#40;0 left&#41;
STORE: COMPLEX: Pushing expired messages &#40;261, 259, 263, 262, 258,
260, 257&#41; to backstore.
STORE: COMPLEX: BACK: THROTTLED: Added 259.
STORE: COMPLEX: BACK: THROTTLED: Added 260.
STORE: COMPLEX: BACK: THROTTLED: Added 261.
STORE: COMPLEX: BACK: THROTTLED: Added 262.
STORE: COMPLEX: BACK: THROTTLED: Added 263.
STORE: COMPLEX: BACK: Sending throttled message 259 &#40;4 left&#41;
STORE: COMPLEX: BACK: Sending throttled message 260 &#40;3 left&#41;
STORE: COMPLEX: BACK: Sending throttled message 263 &#40;2 left&#41;
STORE: COMPLEX: BACK: Sending throttled message 262 &#40;1 left&#41;
STORE: COMPLEX: BACK: Sending throttled message 261 &#40;0 left&#41;

*** Now starting the consumer:

RECV &#40;14&#41;: CONNECT :
RECV &#40;14&#41;: SUBSCRIBE /queue/test &#40;ack: client&#41;
STORE: COMPLEX: FRONT: Message 254 claimed by client 14
Dispatching message 254 to client 14
RECV &#40;14&#41;: ACK - message 254
STORE: COMPLEX: FRONT: Message 257 claimed by client 14
Dispatching message 257 to client 14
RECV &#40;14&#41;: ACK - message 257
STORE: COMPLEX: FRONT: Message 256 claimed by client 14
Dispatching message 256 to client 14
RECV &#40;14&#41;: ACK - message 256
STORE: COMPLEX: FRONT: Message 255 claimed by client 14
Dispatching message 255 to client 14
RECV &#40;14&#41;: ACK - message 255
STORE: COMPLEX: FRONT: Message 260 claimed by client 14
Dispatching message 260 to client 14
RECV &#40;14&#41;: ACK - message 260
STORE: COMPLEX: FRONT: Message 259 claimed by client 14
Dispatching message 259 to client 14
RECV &#40;14&#41;: ACK - message 259
STORE: COMPLEX: FRONT: Message 258 claimed by client 14
Dispatching message 258 to client 14
RECV &#40;14&#41;: ACK - message 258
STORE: COMPLEX: FRONT: Message 263 claimed by client 14
Dispatching message 263 to client 14
RECV &#40;14&#41;: ACK - message 263
STORE: COMPLEX: FRONT: Message 262 claimed by client 14
Dispatching message 262 to client 14
RECV &#40;14&#41;: ACK - message 262
STORE: COMPLEX: FRONT: Message 261 claimed by client 14
Dispatching message 261 to client 14
RECV &#40;14&#41;: ACK - message 261

*** End log

Naveed
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;14&nbsp;02:43:34&nbsp;2009</span>
    <span class="description">dsnopek [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Hrm..  Let&#39;s try an other test..

Do the same thing you did here, where you do the producer first but
instead of running the consumer afterwards, stop the MQ and open the
backstore database with sqlite &#40;on my Debian system, its called
&#34;sqlite3&#34;&#41;.  Note: you have to wait until all the messages move into the
back store before stopping the MQ, so watch the logs.

Here I did the same test on my machine:

dsnopek@skystudio:~/prj/perl_mq/devel.mainline$ sqlite3
/var/lib/perl_mq/mq.db 
SQLite version 3.5.9
Enter &#34;.help&#34; for instructions
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">sqlite&gt; SELECT * FROM messages ORDER BY timestamp;
</div>1|/queue/monkey_bin|1|||1252909883.39394|6|
2|/queue/monkey_bin|1|||1252909883.39896|6|
3|/queue/monkey_bin|1|||1252909883.40001|6|
4|/queue/monkey_bin|1|||1252909883.40083|6|
5|/queue/monkey_bin|1|||1252909883.40159|6|
6|/queue/monkey_bin|1|||1252909883.40236|6|
7|/queue/monkey_bin|1|||1252909883.40315|6|
8|/queue/monkey_bin|1|||1252909883.40394|6|
9|/queue/monkey_bin|1|||1252909883.40471|6|
10|/queue/monkey_bin|1|||1252909883.40549|6|
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">sqlite&gt; 
</div>
It shows that when ordered by timestamp, the messages go in the correct
order.

If both Memory and BigMemory are getting it wrong, the only thing I can
think of, is that somehow on your system the timestamps are not getting
set right or are getting set without enough precision.  This should show
that if its the case.

Although, I still am confused about how the tests could pass if the
storage engines are returning messages out of order, so it could be
something else entirely.  But lets check out this possibility first.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;14&nbsp;03:02:30&nbsp;2009</span>
    <span class="description">naveedm9 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #49666] Messages in queue are out of order.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 14 Sep 2009 03:01:49 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE-Component-MessageQueue [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Naveed Massjouni &lt;naveedm9 [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think you are on to something.  The timestamps look fishy:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">sqlite&gt; select * from messages order by timestamp;
</div>294|/queue/test|1|||1252911075.89115|5|
295|/queue/test|1|||1252911075.89515|5|
296|/queue/test|1|||1252911075.89915|5|
297|/queue/test|1|||1252911075.89915|5|
298|/queue/test|1|||1252911075.89915|5|
301|/queue/test|1|||1252911075.90315|5|
300|/queue/test|1|||1252911075.90315|5|
299|/queue/test|1|||1252911075.90315|5|
303|/queue/test|1|||1252911075.90715|6|
302|/queue/test|1|||1252911075.90715|5|

The timestamps are equal for multiple messages.  I believe that the
reason for this might have to do with these 2 lines from the log:

STORE: COMPLEX: Pushing expired messages &#40;294&#41; to backstore.
STORE: COMPLEX: Pushing expired messages &#40;298, 303, 295, 299, 302,
296, 297, 300, 301&#41; to backstore.

Seems like when messages expire from the front-store, they get pushed
to the back-store all at once.  The original order is not maintained.
Right?

Naveed
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;14&nbsp;03:12:03&nbsp;2009</span>
    <span class="description">dsnopek [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Pon. 14 Wrz. 2009, 03:02:30, naveedm9@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think you are on to something.  The timestamps look fishy:
&gt; 
<div class="message-stanza open">&gt; sqlite&gt; select * from messages order by timestamp;
</div>&gt; 294|/queue/test|1|||1252911075.89115|5|
&gt; 295|/queue/test|1|||1252911075.89515|5|
&gt; 296|/queue/test|1|||1252911075.89915|5|
&gt; 297|/queue/test|1|||1252911075.89915|5|
&gt; 298|/queue/test|1|||1252911075.89915|5|
&gt; 301|/queue/test|1|||1252911075.90315|5|
&gt; 300|/queue/test|1|||1252911075.90315|5|
&gt; 299|/queue/test|1|||1252911075.90315|5|
&gt; 303|/queue/test|1|||1252911075.90715|6|
&gt; 302|/queue/test|1|||1252911075.90715|5|
</div>
Ah ha!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The timestamps are equal for multiple messages.  I believe that the
&gt; reason for this might have to do with these 2 lines from the log:
&gt; 
&gt; STORE: COMPLEX: Pushing expired messages &#40;294&#41; to backstore.
&gt; STORE: COMPLEX: Pushing expired messages &#40;298, 303, 295, 299, 302,
&gt; 296, 297, 300, 301&#41; to backstore.
&gt; 
&gt; Seems like when messages expire from the front-store, they get pushed
&gt; to the back-store all at once.  The original order is not maintained.
&gt; Right?
</div>
Actually, no.  The timestamp is set on the message object as soon as the
message is received.  This is a little tricky to see in the code because
its Moose-ified, but look at MessageQueue/Message.pm lines 80-84:

has &#39;timestamp&#39; =&gt; &#40;
    is      =&gt; &#39;ro&#39;,
    isa     =&gt; &#39;Num&#39;,
    default =&gt; sub { time&#40;&#41; },
&#41;;

When the message object is created, it calls &#34;time&#40;&#41;&#34; to set the
timestamp.  The fact that all those are moved to the backstore at once
is because the timestamp is the same, so they would expire at the same time.

So!  Either time&#40;&#41; isn&#39;t being precise enough, or somehow all those
messages are being created within the same fraction of a second.

Try installing Time::HighRes and see if that helps.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;14&nbsp;03:18:45&nbsp;2009</span>
    <span class="description">dsnopek [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Pon. 14 Wrz. 2009, 03:12:03, DSNOPEK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; Try installing Time::HighRes and see if that helps.
</div>
Er, sorry!  I made a type-o.  I meant to say install Time::HiRes
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;14&nbsp;04:29:11&nbsp;2009</span>
    <span class="description">naveedm9 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #49666] Messages in queue are out of order.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 14 Sep 2009 04:28:28 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE-Component-MessageQueue [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Naveed Massjouni &lt;naveedm9 [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I installed Time::HiRes and that did not solve the problem.  So I did
a little investigating.  I added a print statement inside the loop of
my producer script.

use Time::HiRes qw&#40;time&#41;;
for &#40;1 .. $numMessages&#41;
{
        print time . &#34; $_: adding $qpath: $message$_\n&#34;;
        $stomp-&gt;send&#40;{
                destination =&gt; &#34;$qpath&#34;,
                body        =&gt; &#34;$message$_&#34;,
                persistent  =&gt; &#39;true&#39;,
        }&#41;;
}

Here is the output:

$ ./pro.pl -queue=test -count=10 asdf
connecting to host: localhost
1252915736.00148 1: adding /queue/test: asdf1
1252915736.00148 2: adding /queue/test: asdf2
1252915736.00148 3: adding /queue/test: asdf3
1252915736.00148 4: adding /queue/test: asdf4
1252915736.00148 5: adding /queue/test: asdf5
1252915736.00148 6: adding /queue/test: asdf6
1252915736.00148 7: adding /queue/test: asdf7
1252915736.00148 8: adding /queue/test: asdf8
1252915736.00148 9: adding /queue/test: asdf9
1252915736.00148 10: adding /queue/test: asdf10

Seems like everything happened at 1252915736.00148 o&#39;clock.  So then I
tried running this from the shell:

$ perl -MTime::HiRes -le &#39;use Time::HiRes q&#40;time&#41;; print time for &#40;1..10&#41;&#39;
1252916393.97498
1252916393.97498
1252916393.97498
1252916393.97498
1252916393.97498
1252916393.97498
1252916393.97498
1252916393.97498
1252916393.97498
1252916393.97498

This is on a centos 5 machine, which is running in the cloud, which
the mq.pl broker is running on.  I tested the same commanded on my
personal ubuntu machine and got this:

$ perl -MTime::HiRes -le &#39;use Time::HiRes q&#40;time&#41;; print time for &#40;1..10&#41;&#39;
1252915576.46853
1252915576.46869
1252915576.46875
1252915576.46881
1252915576.46887
1252915576.46893
1252915576.46898
1252915576.46904
1252915576.4691
1252915576.46916

So it seems like it is a timestamp issue.  I&#39;m not sure if the centos
server is incorrect or if it is just super fast.  Do you have any
ideas?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;14&nbsp;04:35:22&nbsp;2009</span>
    <span class="description">naveedm9 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #49666] Messages in queue are out of order.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 14 Sep 2009 04:34:45 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE-Component-MessageQueue [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Naveed Massjouni &lt;naveedm9 [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here is something that is interesting.  On the server that mq.pl is
running on, I ran this:

$ perl -MTime::HiRes -le &#39;use Time::HiRes q&#40;time&#41;; print time for
&#40;1..1000&#41;&#39; | uniq
1252917001.29759
1252917001.30159

Note that I am piping the results of the perl command into uniq.  And
there were only 2 lines in the result.  So the time seems to jump from
1252917001.29759 to 1252917001.30159.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;14&nbsp;04:43:37&nbsp;2009</span>
    <span class="description">dsnopek [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Pon. 14 Wrz. 2009, 04:29:11, naveedm9@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; So it seems like it is a timestamp issue.  I&#39;m not sure if the centos
&gt; server is incorrect or if it is just super fast.  Do you have any
&gt; ideas?
</div>
Hrm.  This is most likely a problem with the timer functionality on the
CentOS server, particularly since its running in the cloud, the virtual
OS probably doesn&#39;t have access to hardware functionality that would
help the timer..

There is probably a way to make a work around for this but I can&#39;t think
of an easy one right now, for example:

 &#40;1&#41; We could add something to the timestamp, but that gets dangerous
too, because when do we reset it, how do we make sure it doesn&#39;t go too
far ahead.

 &#40;2&#41; We could replace the timestamp with a simple counter which
increments for each message, but that will have problems between MQ
shutdown/startup &#40;and theoretic problems for the unfinished clustering
code&#41;.

 &#40;3&#41; An option to use the message id for order &#40;in the case of
--nouuids&#41; but this would require changes to every storage engine, some
more serious than others.

I don&#39;t have a good answer right now...
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;14&nbsp;12:56:44&nbsp;2009</span>
    <span class="description">FRODWITH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Sep 14 04:43:37 2009, DSNOPEK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Pon. 14 Wrz. 2009, 04:29:11, naveedm9@gmail.com wrote:
<div class="message-stanza open">&gt; &gt;
&gt; &gt; So it seems like it is a timestamp issue.  I&#39;m not sure if the
&gt; &gt; centos server is incorrect or if it is just super fast.  Do you
&gt; &gt; have any ideas?
</div>&gt; 
&gt; Hrm.  This is most likely a problem with the timer functionality
&gt; on the CentOS server, particularly since its running in the cloud,
&gt; the virtual OS probably doesn&#39;t have access to hardware
&gt; functionality that would help the timer..
&gt; 
&gt; There is probably a way to make a work around for this but I can&#39;t
&gt; think of an easy one right now, for example:
&gt; 
&gt;  &#40;1&#41; We could add something to the timestamp, but that gets
&gt;  dangerous too, because when do we reset it, how do we make sure
&gt;  it doesn&#39;t go too far ahead.
&gt; 
&gt;  &#40;2&#41; We could replace the timestamp with a simple counter which
&gt;  increments for each message, but that will have problems between
&gt;  MQ shutdown/startup &#40;and theoretic problems for the unfinished
&gt;  clustering code&#41;.
&gt; 
&gt;  &#40;3&#41; An option to use the message id for order &#40;in the case of
&gt;  --nouuids&#41; but this would require changes to every storage
&gt;  engine, some more serious than others.
&gt; 
&gt; I don&#39;t have a good answer right now...
</div>
<span class="clickylink"><a target="new" rel="nofollow" href="http://pastie.org/616357">http://pastie.org/616357</a></span>

Add an ordinal field to messages.  It resets every time there&#39;s a
new timestamp.  Then, you can break timestamp ties with it.

The above pastie is just pseudocode, it&#39;d go somewhere in Message.pm
&#40;probably want to use BUILD instead of the inline builder on the
timestamp attribute&#41;.  

Any of the storage engines that sort would need to be updated to
break timestamp ties with ordinal, and the db schema would have to
change to include the ordinal field.  Grep the codebase for any
other sorts, and that should fix you right up.

This is a nontrivial amount of hacking, and this bug isn&#39;t a problem
for me right now, so I&#39;m not going to spend any time on it.  Should
be a clear path to solving your problem if you&#39;ve got the programmer
time though.  :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;14&nbsp;13:06:56&nbsp;2009</span>
    <span class="description">dsnopek [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On Pon. 14 Wrz. 2009, 12:56:44, frodwith wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://pastie.org/616357">http://pastie.org/616357</a></span>
&gt; 
&gt; Add an ordinal field to messages.  It resets every time there&#39;s a
&gt; new timestamp.  Then, you can break timestamp ties with it.
&gt; 
&gt; The above pastie is just pseudocode, it&#39;d go somewhere in Message.pm
&gt; &#40;probably want to use BUILD instead of the inline builder on the
&gt; timestamp attribute&#41;.  
&gt; 
&gt; Any of the storage engines that sort would need to be updated to
&gt; break timestamp ties with ordinal, and the db schema would have to
&gt; change to include the ordinal field.  Grep the codebase for any
&gt; other sorts, and that should fix you right up.
&gt; 
&gt; This is a nontrivial amount of hacking, and this bug isn&#39;t a problem
&gt; for me right now, so I&#39;m not going to spend any time on it.  Should
&gt; be a clear path to solving your problem if you&#39;ve got the programmer
&gt; time though.  :&#41;
</div>
I just want to add that frodwith&#39;s solution looks good and a patch that
implemented this would very likely be accepted &#40;after review, of course!&#41;.

Additionally, a unit test that would fail on systems with timers that
perform like shown in the rest of the ticket would be very welcome, even
without a fix for the problem.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;14&nbsp;17:00:41&nbsp;2009</span>
    <span class="description">naveedm9 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #49666] Messages in queue are out of order.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 14 Sep 2009 17:00:00 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE-Component-MessageQueue [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Naveed Massjouni &lt;naveedm9 [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, Sep 14, 2009 at 1:06 PM, David Snopek via
RT&lt;bug-POE-Component-MessageQueue@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; I just want to add that frodwith&#39;s solution looks good and a patch that
&gt; implemented this would very likely be accepted &#40;after review, of course!&#41;.
&gt;
&gt; Additionally, a unit test that would fail on systems with timers that
&gt; perform like shown in the rest of the ticket would be very welcome, even
&gt; without a fix for the problem.
</div>
I would like to take a shot at it.  Is there a version control system
for this project, or should I just download the latest source code
from cpan and hack away at that?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;15&nbsp;02:26:11&nbsp;2009</span>
    <span class="description">dsnopek [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Sep 14 17:00:41 2009, naveedm9@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; I would like to take a shot at it.  Is there a version control system
&gt; for this project, or should I just download the latest source code
&gt; from cpan and hack away at that?
</div>
We use Bazaar as described &#40;very shorty&#41; in the POD docs:

<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~dsnopek/POE-Component-MessageQueue-0.2.6/lib/POE/Component/MessageQueue.pm#DEVELOPMENT">http://search.cpan.org/~dsnopek/POE-Component-MessageQueue-0.2.6/lib/POE/Component/MessageQueue.pm#DEVELOPMENT</a></span>

The ideal way to contribute is to make a branch of the main branch and
publish it somewhere.  Then there is a back and forth during review,
where we&#39;ll suggest or make changes, and ultimately the branch is merged
into the main branch and released.

Contributing with patches rather than Bazaar is also acceptable, it just
creates a little extra work, especially if we need to go back and forth
during review a few times.

Also, we do most of our development discussions on the Google Group:

<span class="clickylink"><a target="new" rel="nofollow" href="http://groups.google.com/group/pocomq">http://groups.google.com/group/pocomq</a></span>

You can search around there for examples of how contributions have gone
in the past.

Thanks for taking the time to hack on this!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;16&nbsp;11:34:42&nbsp;2009</span>
    <span class="description">naveedm9 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #49666] Messages in queue are out of order.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 16 Sep 2009 11:33:56 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE-Component-MessageQueue [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Naveed Massjouni &lt;naveedm9 [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, Sep 14, 2009 at 12:56 PM, Paul Driver via RT
&lt;bug-POE-Component-MessageQueue@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=49666">https://rt.cpan.org/Ticket/Display.html?id=49666</a></span> &gt;
&gt;
&gt; On Mon Sep 14 04:43:37 2009, DSNOPEK wrote:
<div class="message-stanza open">&gt;&gt; On Pon. 14 Wrz. 2009, 04:29:11, naveedm9@gmail.com wrote:
<div class="message-stanza open">&gt;&gt; &gt;
&gt;&gt; &gt; So it seems like it is a timestamp issue.  I&#39;m not sure if the
&gt;&gt; &gt; centos server is incorrect or if it is just super fast.  Do you
&gt;&gt; &gt; have any ideas?
</div>&gt;&gt;
&gt;&gt; Hrm.  This is most likely a problem with the timer functionality
&gt;&gt; on the CentOS server, particularly since its running in the cloud,
&gt;&gt; the virtual OS probably doesn&#39;t have access to hardware
&gt;&gt; functionality that would help the timer..
&gt;&gt;
&gt;&gt; There is probably a way to make a work around for this but I can&#39;t
&gt;&gt; think of an easy one right now, for example:
&gt;&gt;
&gt;&gt;  &#40;1&#41; We could add something to the timestamp, but that gets
&gt;&gt;  dangerous too, because when do we reset it, how do we make sure
&gt;&gt;  it doesn&#39;t go too far ahead.
&gt;&gt;
&gt;&gt;  &#40;2&#41; We could replace the timestamp with a simple counter which
&gt;&gt;  increments for each message, but that will have problems between
&gt;&gt;  MQ shutdown/startup &#40;and theoretic problems for the unfinished
&gt;&gt;  clustering code&#41;.
&gt;&gt;
&gt;&gt;  &#40;3&#41; An option to use the message id for order &#40;in the case of
&gt;&gt;  --nouuids&#41; but this would require changes to every storage
&gt;&gt;  engine, some more serious than others.
&gt;&gt;
&gt;&gt; I don&#39;t have a good answer right now...
</div>&gt;
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://pastie.org/616357">http://pastie.org/616357</a></span>
&gt;
&gt; Add an ordinal field to messages.  It resets every time there&#39;s a
&gt; new timestamp.  Then, you can break timestamp ties with it.
&gt;
&gt; The above pastie is just pseudocode, it&#39;d go somewhere in Message.pm
&gt; &#40;probably want to use BUILD instead of the inline builder on the
&gt; timestamp attribute&#41;.
&gt;
&gt; Any of the storage engines that sort would need to be updated to
&gt; break timestamp ties with ordinal, and the db schema would have to
&gt; change to include the ordinal field.  Grep the codebase for any
&gt; other sorts, and that should fix you right up.
&gt;
&gt; This is a nontrivial amount of hacking, and this bug isn&#39;t a problem
&gt; for me right now, so I&#39;m not going to spend any time on it.  Should
&gt; be a clear path to solving your problem if you&#39;ve got the programmer
&gt; time though.  :&#41;
&gt;
</div>
Just want to point out that this could be a problem for you even if
your broker is not on a cloud server.  If order matters to you.  And
in general, if you are using a queue data structure, then you probably
care about order.  On my puny desktop, I ran the following.

$ perl -MTime::HiRes -le &#39;use Time::HiRes q&#40;time&#41;; print time for &#40;1..10&#41;&#39;
1253115071.29503
1253115071.2951
1253115071.2951
1253115071.29511
1253115071.29512
1253115071.29513
1253115071.29513
1253115071.29514
1253115071.29514
1253115071.29515

You see that the second and third prints both happened at 1253115071.2951.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;02&nbsp;03:24:37&nbsp;2010</span>
    <span class="description">IRONCAMEL [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have a patch that fixes this issue:

<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/ironcamel/POE--Component--MessageQueue/commit/09ffbd01a711cd4536ac0b6f01fb832939944b96">http://github.com/ironcamel/POE--Component--MessageQueue/commit/09ffbd01a711cd4536ac0b6f01fb832939944b96</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;03&nbsp;04:05:29&nbsp;2010</span>
    <span class="description">dsnopek [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Pt 02 Apr 2010, 03:24:37, IRONCAMEL wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have a patch that fixes this issue:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/ironcamel/POE--Component--">http://github.com/ironcamel/POE--Component--</a></span>
&gt; MessageQueue/commit/09ffbd01a711cd4536ac0b6f01fb832939944b96
</div>
I haven&#39;t had time to do a full review of the changes or any testing
yet, but I like what you&#39;re doing here.

Unlike Paul&#39;s proposed fix, this doesn&#39;t require adding an additional
field or DB column, so its fully compatible with what already exists.

Also, I did a little research on the speed of time&#40;&#41; vs.
Time::HiRes::time&#40;&#41;.  Attached is a benchmarking script.  It appears
that time&#40;&#41; is about 4-6% faster than Time::HiRes::time&#40;&#41;.  While that
isn&#39;t much, since we don&#39;t really *need* the accuracy of Time::HiRes, I
think this is an argument in favor of your approach.

So, I still have to do full review and some testing but right now I
think that this patch will be accepted.

Thanks so much for hacking on this!
David Snopek.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> benchmark-time.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use Time::HiRes;
use Benchmark qw&#40;:all&#41; ;

cmpthese&#40;-10, {
        &#39;Time::HiRes&#39;    =&gt; sub { my $t0 = Time::HiRes::time&#40;&#41;; },
        &#39;builtin time&#40;&#41;&#39; =&gt; sub { my $t0 = time&#40;&#41;; },
    }&#41;;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;06&nbsp;08:28:09&nbsp;2010</span>
    <span class="description">dsnopek [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On Pt 02 Apr 2010, 03:24:37, IRONCAMEL wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have a patch that fixes this issue:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/ironcamel/POE--Component--">http://github.com/ironcamel/POE--Component--</a></span>
&gt; MessageQueue/commit/09ffbd01a711cd4536ac0b6f01fb832939944b96
</div>
So, I have been thinking about what datatype this should be in the
database.  In your patch, you set it to REAL &#40;which really doesn&#39;t
matter too much for sqlite anyway&#41; but I&#39;m not 100% sure that&#39;s what we
should do.

Floating point values can sometimes be bad representations of decimal
numbers and this patch is very decimal &#40;appends .00001, .00002, etc to
the number&#41;.  But switching to a string could slow things down on
databases like MySQL.  I&#39;m not sure either of these is really a worry
&#40;more research necessary!&#41; but if they are, a fixed-point number
represented as an integer seems the most logical.  But that would break
the ease with which we can query the database and see whats going on...

This needs more thought.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;06&nbsp;08:48:07&nbsp;2010</span>
    <span class="description">dsnopek [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wt 06 Apr 2010, 08:28:09, DSNOPEK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; On Pt 02 Apr 2010, 03:24:37, IRONCAMEL wrote:
<div class="message-stanza open">&gt; &gt; I have a patch that fixes this issue:
&gt; &gt; 
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/ironcamel/POE--Component--">http://github.com/ironcamel/POE--Component--</a></span>
&gt; &gt; MessageQueue/commit/09ffbd01a711cd4536ac0b6f01fb832939944b96
</div>&gt; 
&gt; So, I have been thinking about what datatype this should be in the
&gt; database.  In your patch, you set it to REAL &#40;which really doesn&#39;t
&gt; matter too much for sqlite anyway&#41; but I&#39;m not 100% sure that&#39;s what we
&gt; should do.
&gt; 
&gt; Floating point values can sometimes be bad representations of decimal
&gt; numbers and this patch is very decimal &#40;appends .00001, .00002, etc to
&gt; the number&#41;.  But switching to a string could slow things down on
&gt; databases like MySQL.  I&#39;m not sure either of these is really a worry
&gt; &#40;more research necessary!&#41; but if they are, a fixed-point number
&gt; represented as an integer seems the most logical.  But that would break
&gt; the ease with which we can query the database and see whats going on...
&gt; 
&gt; This needs more thought.
</div>
I&#39;m thinking that DECIMAL&#40;15,5&#41; would be a good type.  For MySQL &gt;5.0.3
it should work without floating-point problems and a number with these
dimensions &#40;15 significant digits, 5 of which are fractional&#41; should
work with SQLite3&#39;s storage engine correctly &#40;it will try to store it as
a float, but convert to text if it isn&#39;t *exact* to 15 significant digits&#41;.

I&#39;ll start making up the schemas and what not.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;06&nbsp;09:41:45&nbsp;2010</span>
    <span class="description">dsnopek [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
The patch and some other house keeping for the new version and schemas
is now in the mainline Bazaar branch and its Git mirror.  Please test,
this will become the next release.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;06&nbsp;23:58:04&nbsp;2010</span>
    <span class="description">naveedm9 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #49666] Messages in queue are out of order.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 7 Apr 2010 04:57:29 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-POE-Component-MessageQueue [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Naveed Massjouni &lt;naveedm9 [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Apr 6, 2010 at 2:41 PM, David Snopek via RT
&lt;bug-POE-Component-MessageQueue@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=49666">https://rt.cpan.org/Ticket/Display.html?id=49666</a></span> &gt;
&gt;
&gt;
&gt; The patch and some other house keeping for the new version and schemas
&gt; is now in the mainline Bazaar branch and its Git mirror.  Please test,
&gt; this will become the next release.
</div>
Thanks David.  Please hold off on the release until I get a chance to
test this on my cloud servers.  I will try to do this very soon.

Naveed
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;13&nbsp;14:41:51&nbsp;2010</span>
    <span class="description">IRONCAMEL [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Apr 06 23:58:04 2010, naveedm9@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue, Apr 6, 2010 at 2:41 PM, David Snopek via RT
&gt; &lt;bug-POE-Component-MessageQueue@rt.cpan.org&gt; wrote:
<div class="message-stanza open">&gt; &gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=49666">https://rt.cpan.org/Ticket/Display.html?id=49666</a></span> &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; The patch and some other house keeping for the new version and 
</div></div>schemas
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; is now in the mainline Bazaar branch and its Git mirror.  Please 
</div></div>test,
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; this will become the next release.
</div>&gt; 
&gt; Thanks David.  Please hold off on the release until I get a chance to
&gt; test this on my cloud servers.  I will try to do this very soon.
&gt; 
&gt; Naveed
</div>
I just installed the latest version from github and ran some tests on my 
boxes and everything seems to be working good.  All messages were in 
order.  Great idea using DECIMAL instead of REAL to store the value.  I 
just learned that the decimal type is &#34;used to store values for which it 
is important to preserve exact precision, for example with monetary 
data&#34;.  Which is what we want here.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;03&nbsp;06:50:45&nbsp;2012</span>
    <span class="description">IRONCAMEL [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
