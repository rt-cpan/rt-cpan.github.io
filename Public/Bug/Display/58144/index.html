<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #58144 for CAM-PDF: Interactive forms - Fully qualified field names, text font size, and interactive form dictionary</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #58144 for CAM-PDF: Interactive forms - Fully qualified field names, text font size, and interactive form dictionary</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=CAM-PDF">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=CAM-PDF">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=CAM-PDF">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=CAM-PDF">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/CAM-PDF">CAM-PDF CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">58144</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=CAM-PDF">CAM-PDF</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
m.g.birdsall [...] mbirdsall.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-4996-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.52    </td>
  </tr>
  <tr id="CF-4997-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




campdf.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/786735/407599/campdf.diff">
Fri Jun 04 16:04:30 2010 (2.9k) by m.g.birdsall [...] mbirdsall.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=58144">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-786735" href="/Public/Bug/Display.html?id=58144#txn-786735">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;04&nbsp;16:04:30&nbsp;2010</span>
    <span class="description">m.g.birdsall [...] mbirdsall.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Interactive forms - Fully qualified field names, text font size,
 and interactive form dictionary</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/786735/407598/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/407598">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve been doing some work to fill in form fields in a PDF, and ran into
a few issues or features that CAM::PDF does not seem to handle
correctly. I&#39;ve created some fixes for these problems, and wanted to
report the problems and the fixes that I&#39;ve found. 

The form I am working with is a PDF for reporting Minimum Data Set 3.0
&#40;MDS 3.0&#41; data to the Centers for Medicare and Medicaid Services &#40;CMS&#41;,
part of the United States Department of Health and Human Services. 

The issues I have found are:
1. The getFormField method is not properly handling fully qualified
field names &#40;name1.name2.name3...&#41;. This issue is line 2813

        if &#40;$fieldname =~ s/ \A&#40;.*&#41;[.]&#40;[.]+&#41;\z /$2/xms&#41;
   which I believe is intended to be 
        if &#40;$fieldname =~ s/ \A&#40;.*&#41;[.]&#40;[^.]+&#41;\z /$2/xms&#41;

The current line looks for a pair of &#34;.&#34; in the field name, the correct
one collects up the final &#40;rightmost&#41; partial field name remaining.

2. The fillFormFields method is not properly handling Font names with
dashes in them, or text font sizes defined with a real &#40;not an integer&#41;.
This issue is in line 4415:
        
         if &#40;$da =~ m{ \s*/&#40;\w+&#41;\s+&#40;\d+&#41;\s+Tf.*? \z }xms&#41;
    which I modified to 
         if &#40;$da =~ m{ \s*/&#40;[\w-]+&#41;\s+&#40;[.\d]+&#41;\s+Tf.*? \z }xms&#41;

which adds dash to the acceptable characters in a font name, and the
period&#40;decimal-point&#41; to the text font size. 

Dash is likely not the only character that needs to be added to word
characters for the fontnames, but it is pretty common with fonts being
commonly named things like &#34;Courier-Bold&#34; or &#34;Times-Italic&#34; and other
similar names. The correct solution would allow any characters other
than white space or delimiters, That would be sufficient to make it a
PDF Name, and should deal with all valid PDFs. A further test could
check that it is a valid PostScript name, so it can&#39;t have the
appearance of a number following the slash. The code for that should be

         if &#40;$da =~ 
            m{ \s*/
               &#40;[$!#&#38;&#39;*+,.:;=?@\\^`|~\w-]+&#41;
               \s+
               &#40;[.\d]+&#41;
               \s+Tf.*? \z 
             }xms&#41; 

but I have not tested that, apart from the syntax, and have not included
it in the patch.

3. The fillFormsField is searching for the font in DR entry in the Field
Dictionary in order to get the font metrics. According to PDF Reference
version 1.6 &#40;implementation note 117&#41; 

&#34;In PDF 1.2, an additional entry in the field dictionary, DR, was
defined but was never implemented. Beginning with PDF 1.5, this entry is
obsolete and should be ignored.&#34;

Instead, as defined in Section 8.6.2 under Variable Text, the
information should be taken from the interactive form dictionary&#39;s DR
entry. 

So, I changed the code at 4421 to look up the interactive field
dictionary for the DR entry, rather than in the field dictionary. 

4. Similarly, when fillFormsField at 4576 tries to set the font object
in the Resources directory, it should get the font object from the
interactive forms dictionary&#39;s DR entry

Perl Version:
This is perl, v5.10.0 built for x86_64-linux-gnu-thread-multi
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> campdf.diff</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/786735/407599/campdf.diff">Download campdf.diff</a><br />
<span class="downloadcontenttype">text/x-diff 2.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- CAM-PDF-1.52-rev-bug/lib/CAM/PDF.pm	2008-10-03 03:35:52.000000000 -0400
+++ CAM-PDF-1.52/lib/CAM/PDF.pm	2010-06-04 15:52:29.000000000 -0400
@@ -2810,7 +2810,7 @@ sub getFormField
       if &#40;$fieldname =~ m/ [.] /xms&#41;
       {
          my $parentname;
-         if &#40;$fieldname =~ s/ \A&#40;.*&#41;[.]&#40;[.]+&#41;\z /$2/xms&#41;
+         if &#40;$fieldname =~ s/ \A&#40;.*&#41;[.]&#40;[^.]+&#41;\z /$2/xms&#41;
          {
             $parentname = $1;
          }
@@ -4412,15 +4412,17 @@ sub fillFormFields  ## no critic&#40;Subrout
             # Try to pull out the font size, if any.  If more than
             # one, pick the last one.  Font commands look like:
             # &#34;/&lt;fontname&gt; &lt;size&gt; Tf&#34;
-            if &#40;$da =~ m{ \s*/&#40;\w+&#41;\s+&#40;\d+&#41;\s+Tf.*? \z }xms&#41;
+            if &#40;$da =~ m{ \s*/&#40;[\w-]+&#41;\s+&#40;[.\d]+&#41;\s+Tf.*? \z }xms&#41;
             {
                $fontname = $1;
                $fontsize = $2;
                if &#40;$fontname&#41;
                {
-                  if &#40;$propdict-&gt;{DR}&#41;
+                  my $root = $self-&gt;getRootDict&#40;&#41;-&gt;{AcroForm};
+                  my $ifdict = $self-&gt;getValue&#40;$root&#41;;
+                  if &#40;exists $ifdict-&gt;{DR}&#41;
                   {
-                     my $dr = $self-&gt;getValue&#40;$propdict-&gt;{DR}&#41;;
+                     my $dr = $self-&gt;getValue&#40;$ifdict-&gt;{DR}&#41;;
                      $fontmetrics = $self-&gt;getFontMetrics&#40;$dr, $fontname&#41;;
                   }
                   #print STDERR &#34;Didn&#39;t get font\n&#34; if &#40;!$fontmetrics&#41;;
@@ -4573,17 +4575,26 @@ sub fillFormFields  ## no critic&#40;Subrout
             }
             my $fdict = $self-&gt;getValue&#40;$rdict-&gt;{Font}&#41;;
 
-            # Search out font resources.  This is a total kluge.
-            # TODO: the right way to do this is to look for the DR
-            # attribute in the form element or it&#39;s ancestors.
+            # Search out font resources.  
+            # As of PDF Reference fifth edition, the right way to do this
+            # is to get the DR attribute from the interactive form dictionary
+            # from the AcroForm entry in the document catalog
             for my $font &#40;@rsrcs&#41;
             {
-               my $fobj = $self-&gt;dereference&#40;&#34;/$font&#34;, &#39;All&#39;&#41;;
-               if &#40;!$fobj&#41;
+               my $root = $self-&gt;getRootDict&#40;&#41;-&gt;{AcroForm};
+               my $ifdict = $self-&gt;getValue&#40;$root&#41;;
+               if &#40;!exists $ifdict-&gt;{DR}&#41;
+               {
+                 die &#34;Could not find resource /$font while preparing form field $key\n&#34;;
+               }
+               my $dr = $self-&gt;getValue&#40;$ifdict-&gt;{DR}&#41;;
+               my $fobjnum = $dr-&gt;{Font}-&gt;{value}-&gt;{$font}-&gt;{value};
+               
+               if &#40;!$fobjnum&#41;
                {
                   die &#34;Could not find resource /$font while preparing form field $key\n&#34;;
                }
-               $fdict-&gt;{$font} = CAM::PDF::Node-&gt;new&#40;&#39;reference&#39;, $fobj-&gt;{objnum}, $formonum, $formgnum&#41;;
+               $fdict-&gt;{$font} = CAM::PDF::Node-&gt;new&#40;&#39;reference&#39;, $fobjnum, $formonum, $formgnum&#41;;
             }
          }
       }
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.295358</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
