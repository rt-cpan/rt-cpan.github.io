<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #90218 for Sys-Syslog: Handle getprotobyn{ame,umber} not being available</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #90218 for Sys-Syslog: Handle getprotobyn{ame,umber} not being available</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Sys-Syslog/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Sys-Syslog/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Sys-Syslog/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Sys-Syslog/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Sys-Syslog">Sys-Syslog CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">90218</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Sys-Syslog/Active/">Sys-Syslog</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">SAPER [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
fraserbn [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-30616-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-30617-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.34    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;10&nbsp;16:40:02&nbsp;2013</span>
    <span class="description">fraserbn [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Handle getprotobyn{ame,umber} not being available</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Perls built without those functions &#40;either because the system lacks them, ala Android, or because they were undefined during Configure&#41;, calling these results in an exception, so they should either be protected by an eval {} or only called as &#39;if &#40;$Config{func}&#41; { func&#40;&#41; }&#39;.

The attached patch implements the latter.

diff --git a/cpan/Sys-Syslog/Syslog.pm b/cpan/Sys-Syslog/Syslog.pm
index 75a1832..dbceb13 100644
--- a/cpan/Sys-Syslog/Syslog.pm
+++ b/cpan/Sys-Syslog/Syslog.pm
@@ -3,6 +3,7 @@ use strict;
 use warnings;
 use warnings::register;
 use Carp;
+use Config;
 use Exporter        qw&lt; import &gt;;
 use File::Basename;
 use POSIX           qw&lt; strftime setlocale LC_TIME &gt;;
@@ -11,7 +12,7 @@ require 5.005;
 
 
 {   no strict &#39;vars&#39;;
-    $VERSION = &#39;0.33&#39;;
+    $VERSION = &#39;0.33_1&#39;;
 
     %EXPORT_TAGS = &#40;
         standard =&gt; [qw&#40;openlog syslog closelog setlogmask&#41;],
@@ -429,7 +430,6 @@ sub syslog {
         $buf = $message;
     }
     else {
-        require Config;
         my $whoami = $ident;
         $whoami .= &#34;[$$]&#34; if $options{pid};
 
@@ -628,7 +628,10 @@ sub connect_log {
 sub connect_tcp {
     my &#40;$errs&#41; = @_;
 
-    my $proto = getprotobyname&#40;&#39;tcp&#39;&#41;;
+    my $proto;
+    if &#40; $Config{d_getpbyname} &#41; {
+        $proto = getprotobyname&#40;&#39;tcp&#39;&#41;;
+    }
     if &#40;!defined $proto&#41; {
        push @$errs, &#34;getprotobyname failed for tcp&#34;;
        return 0;
@@ -676,7 +679,10 @@ sub connect_tcp {
 sub connect_udp {
     my &#40;$errs&#41; = @_;
 
-    my $proto = getprotobyname&#40;&#39;udp&#39;&#41;;
+    my $proto;
+    if &#40; $Config{d_getpbyname} &#41; {
+        $proto = getprotobyname&#40;&#39;udp&#39;&#41;;
+    }
     if &#40;!defined $proto&#41; {
        push @$errs, &#34;getprotobyname failed for udp&#34;;
        return 0;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;20&nbsp;19:23:44&nbsp;2013</span>
    <span class="description">SAPER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #90218] Handle getprotobyn{ame,umber} not being available</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 21 Nov 2013 01:23:26 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sys-Syslog [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Sébastien Aperghis-Tramoni &lt;saper [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Brian Fraser wrote via RT:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Perls built without those functions &#40;either because the system lacks them, ala Android, or because they were undefined during Configure&#41;, calling these results in an exception, so they should either be protected by an eval {} or only called as &#39;if &#40;$Config{func}&#41; { func&#40;&#41; }&#39;.
</div>
Urk! This is awful!
I know I&#39;m micro-optimizing here, but I wonder if eval-ing isn&#39;t both faster and visually easier to swallow.
In terms of generated opcodes at least, 

    my $proto = eval { getprotobyname&#40;&#39;tcp&#39;&#41; };

produces less opcodes than

    my $proto = getprotobyname&#40;&#39;tcp&#39;&#41; if $Config{d_getpbyname};

which also produces less opcodes than

    my $proto;
    if &#40; $Config{d_getpbyname} &#41; {
        $proto = getprotobyname&#40;&#39;tcp&#39;&#41;;
    }

I&#39;ll benchmark these to check which is faster, but in terms of readability, I really prefer eval.


-- 
Sébastien Aperghis-Tramoni

Close the world, txEn eht nepO.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;20&nbsp;19:23:45&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;20&nbsp;21:16:52&nbsp;2013</span>
    <span class="description">fraserbn [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #90218] Handle getprotobyn{ame,umber} not being available</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 21 Nov 2013 00:16:39 -0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sys-Syslog [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Brian Fraser &lt;fraserbn [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Nov 20, 2013 at 9:23 PM, Sébastien Aperghis-Tramoni via RT &lt;
bug-Sys-Syslog@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=90218">https://rt.cpan.org/Ticket/Display.html?id=90218</a></span> &gt;
&gt;
&gt; Brian Fraser wrote via RT:
&gt;
<div class="message-stanza open">&gt; &gt; On Perls built without those functions &#40;either because the system lacks
</div>&gt; them, ala Android, or because they were undefined during Configure&#41;,
&gt; calling these results in an exception, so they should either be protected
&gt; by an eval {} or only called as &#39;if &#40;$Config{func}&#41; { func&#40;&#41; }&#39;.
&gt;
&gt; Urk! This is awful!
&gt; I know I&#39;m micro-optimizing here, but I wonder if eval-ing isn&#39;t both
&gt; faster and visually easier to swallow.
&gt; In terms of generated opcodes at least,
&gt;
&gt;     my $proto = eval { getprotobyname&#40;&#39;tcp&#39;&#41; };
&gt;
&gt; produces less opcodes than
&gt;
&gt;     my $proto = getprotobyname&#40;&#39;tcp&#39;&#41; if $Config{d_getpbyname};
&gt;
&gt; which also produces less opcodes than
&gt;
&gt;     my $proto;
&gt;     if &#40; $Config{d_getpbyname} &#41; {
&gt;         $proto = getprotobyname&#40;&#39;tcp&#39;&#41;;
&gt;     }
&gt;
&gt; I&#39;ll benchmark these to check which is faster, but in terms of
&gt; readability, I really prefer eval.
&gt;
</div>
Yeah, the eval version is much nicer to read. However, consider that the
long version with the if can be optimized away by perl so that only the &#39;my
$proto;&#39; is ever run. The my $proto = ... if ...; version might give
deprecation warnings too, because it&#39;s unintentionally creating a state
variable.
Also, the less opcodes of eval might not be as less as you imagine; off the
top of my head, you&#39;d be dealing with entertry, dotry, possibly a
croak+longjmp+$SIG{__DIE__}, plus the risk that __DIE__ handler is not
checking for $^S, and then leavetry.
Perhaps this would be better?
my $proto = $Config{d_getpbyname} ? getprotobyname&#40;&#39;tcp&#39;&#41; : undef;
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;22&nbsp;03:26:03&nbsp;2013</span>
    <span class="description">SAPER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #90218] Handle getprotobyn{ame,umber} not being available</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 22 Nov 2013 09:25:42 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sys-Syslog [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Sébastien Aperghis-Tramoni &lt;saper [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Brian Fraser wrote via RT:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sébastien Aperghis-Tramoni wrote via RT:
&gt; 
<div class="message-stanza open">&gt;&gt; Brian Fraser wrote via RT:
&gt;&gt; 
<div class="message-stanza open">&gt;&gt;&gt; On Perls built without those functions &#40;either because the system lacks
&gt;&gt;&gt; them, ala Android, or because they were undefined during Configure&#41;,
&gt;&gt;&gt; calling these results in an exception, so they should either be protected
&gt;&gt;&gt; by an eval {} or only called as &#39;if &#40;$Config{func}&#41; { func&#40;&#41; }&#39;.
</div>&gt;&gt; 
&gt;&gt; Urk! This is awful!
&gt;&gt; I know I&#39;m micro-optimizing here, but I wonder if eval-ing isn&#39;t both
&gt;&gt; faster and visually easier to swallow.
&gt;&gt; In terms of generated opcodes at least,
&gt;&gt; 
&gt;&gt;    my $proto = eval { getprotobyname&#40;&#39;tcp&#39;&#41; };
&gt;&gt; 
&gt;&gt; produces less opcodes than
&gt;&gt; 
&gt;&gt;    my $proto = getprotobyname&#40;&#39;tcp&#39;&#41; if $Config{d_getpbyname};
&gt;&gt; 
&gt;&gt; which also produces less opcodes than
&gt;&gt; 
&gt;&gt;    my $proto;
&gt;&gt;    if &#40; $Config{d_getpbyname} &#41; {
&gt;&gt;        $proto = getprotobyname&#40;&#39;tcp&#39;&#41;;
&gt;&gt;    }
&gt;&gt; 
&gt;&gt; I&#39;ll benchmark these to check which is faster, but in terms of
&gt;&gt; readability, I really prefer eval.
</div>&gt; 
&gt; Yeah, the eval version is much nicer to read. However, consider that the
&gt; long version with the if can be optimized away by perl so that only the &#39;my
&gt; $proto;&#39; is ever run.
</div>
Hmm, can it be optimized in such a case? I think only when there&#39;s a if 0 at compilation time, the expression is optimized away.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The my $proto = ... if ...; version might give
&gt; deprecation warnings too, because it&#39;s unintentionally creating a state
&gt; variable.
</div>
Indeed, although this construct does not warn yet, it might one day.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Also, the less opcodes of eval might not be as less as you imagine; off the
&gt; top of my head, you&#39;d be dealing with entertry, dotry, possibly a
&gt; croak+longjmp+$SIG{__DIE__}, plus the risk that __DIE__ handler is not
&gt; checking for $^S, and then leavetry.
&gt; Perhaps this would be better?
&gt; my $proto = $Config{d_getpbyname} ? getprotobyname&#40;&#39;tcp&#39;&#41; : undef;
</div>

I&#39;m benchmarking the different solutions with Dumbbench &#40;supposedly better than Benchmark&#41; to see how well they perform, and currently, eval-block seem to always win, but in some cases with such a difference that I&#39;m doubting the results.


-- 
Sébastien Aperghis-Tramoni

Close the world, txEn eht nepO.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;23&nbsp;19:15:57&nbsp;2014</span>
    <span class="description">fraserbn [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> fraserbn [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Nov 22 03:26:03 2013, SAPER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Brian Fraser wrote via RT:
&gt; 
<div class="message-stanza open">&gt; &gt; Sébastien Aperghis-Tramoni wrote via RT:
&gt; &gt;
<div class="message-stanza open">&gt; &gt;&gt; Brian Fraser wrote via RT:
&gt; &gt;&gt;
<div class="message-stanza open">&gt; &gt;&gt;&gt; On Perls built without those functions &#40;either because the system
&gt; &gt;&gt;&gt; lacks
&gt; &gt;&gt;&gt; them, ala Android, or because they were undefined during
&gt; &gt;&gt;&gt; Configure&#41;,
&gt; &gt;&gt;&gt; calling these results in an exception, so they should either be
&gt; &gt;&gt;&gt; protected
&gt; &gt;&gt;&gt; by an eval {} or only called as &#39;if &#40;$Config{func}&#41; { func&#40;&#41; }&#39;.
</div>&gt; &gt;&gt;
&gt; &gt;&gt; Urk! This is awful!
&gt; &gt;&gt; I know I&#39;m micro-optimizing here, but I wonder if eval-ing isn&#39;t
&gt; &gt;&gt; both
&gt; &gt;&gt; faster and visually easier to swallow.
&gt; &gt;&gt; In terms of generated opcodes at least,
&gt; &gt;&gt;
&gt; &gt;&gt; my $proto = eval { getprotobyname&#40;&#39;tcp&#39;&#41; };
&gt; &gt;&gt;
&gt; &gt;&gt; produces less opcodes than
&gt; &gt;&gt;
&gt; &gt;&gt; my $proto = getprotobyname&#40;&#39;tcp&#39;&#41; if $Config{d_getpbyname};
&gt; &gt;&gt;
&gt; &gt;&gt; which also produces less opcodes than
&gt; &gt;&gt;
&gt; &gt;&gt; my $proto;
&gt; &gt;&gt; if &#40; $Config{d_getpbyname} &#41; {
&gt; &gt;&gt;     $proto = getprotobyname&#40;&#39;tcp&#39;&#41;;
&gt; &gt;&gt; }
&gt; &gt;&gt;
&gt; &gt;&gt; I&#39;ll benchmark these to check which is faster, but in terms of
&gt; &gt;&gt; readability, I really prefer eval.
</div>&gt; &gt;
&gt; &gt; Yeah, the eval version is much nicer to read. However, consider that
&gt; &gt; the
&gt; &gt; long version with the if can be optimized away by perl so that only
&gt; &gt; the &#39;my
&gt; &gt; $proto;&#39; is ever run.
</div>&gt; 
&gt; Hmm, can it be optimized in such a case? I think only when there&#39;s a
&gt; if 0 at compilation time, the expression is optimized away.
</div>
Whoops, pardons, I missed this message. I think you&#39;re right -- it won&#39;t optimize it away at runtime, much less with %Config which is tried.  You could do something like

use Config;
use constant {
        HAS_GETPROTOBYNAME     =&gt; $Config::Config{d_getpbyname},
        HAS_GETPROTOBYNUMBER =&gt; $Config::Config{d_getpbynumber}
};

my $proto = HAS_GETPROTOBYNAME ? getprotobyname&#40;&#39;tcp&#39;&#41; : undef;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt; &gt; The my $proto = ... if ...; version might give
&gt; &gt; deprecation warnings too, because it&#39;s unintentionally creating a
&gt; &gt; state
&gt; &gt; variable.
</div>&gt; 
&gt; Indeed, although this construct does not warn yet, it might one day.
&gt; 
<div class="message-stanza open">&gt; &gt; Also, the less opcodes of eval might not be as less as you imagine;
&gt; &gt; off the
&gt; &gt; top of my head, you&#39;d be dealing with entertry, dotry, possibly a
&gt; &gt; croak+longjmp+$SIG{__DIE__}, plus the risk that __DIE__ handler is
&gt; &gt; not
&gt; &gt; checking for $^S, and then leavetry.
&gt; &gt; Perhaps this would be better?
&gt; &gt; my $proto = $Config{d_getpbyname} ? getprotobyname&#40;&#39;tcp&#39;&#41; : undef;
</div>&gt; 
&gt; 
&gt; I&#39;m benchmarking the different solutions with Dumbbench &#40;supposedly
&gt; better than Benchmark&#41; to see how well they perform, and currently,
&gt; eval-block seem to always win, but in some cases with such a
&gt; difference that I&#39;m doubting the results.
</div>
Benchmarks are hard, let&#39;s go shopping :P
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;25&nbsp;12:24:47&nbsp;2014</span>
    <span class="description">fraserbn [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> fraserbn [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jan 23 19:15:57 2014, Hugmeir wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Nov 22 03:26:03 2013, SAPER wrote:
<div class="message-stanza open">&gt; &gt; Brian Fraser wrote via RT:
&gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; Sébastien Aperghis-Tramoni wrote via RT:
&gt; &gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt;&gt; Brian Fraser wrote via RT:
&gt; &gt; &gt;&gt;
<div class="message-stanza open">&gt; &gt; &gt;&gt;&gt; On Perls built without those functions &#40;either because the system
&gt; &gt; &gt;&gt;&gt; lacks
&gt; &gt; &gt;&gt;&gt; them, ala Android, or because they were undefined during
&gt; &gt; &gt;&gt;&gt; Configure&#41;,
&gt; &gt; &gt;&gt;&gt; calling these results in an exception, so they should either be
&gt; &gt; &gt;&gt;&gt; protected
&gt; &gt; &gt;&gt;&gt; by an eval {} or only called as &#39;if &#40;$Config{func}&#41; { func&#40;&#41; }&#39;.
</div>&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; Urk! This is awful!
&gt; &gt; &gt;&gt; I know I&#39;m micro-optimizing here, but I wonder if eval-ing isn&#39;t
&gt; &gt; &gt;&gt; both
&gt; &gt; &gt;&gt; faster and visually easier to swallow.
&gt; &gt; &gt;&gt; In terms of generated opcodes at least,
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; my $proto = eval { getprotobyname&#40;&#39;tcp&#39;&#41; };
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; produces less opcodes than
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; my $proto = getprotobyname&#40;&#39;tcp&#39;&#41; if $Config{d_getpbyname};
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; which also produces less opcodes than
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; my $proto;
&gt; &gt; &gt;&gt; if &#40; $Config{d_getpbyname} &#41; {
&gt; &gt; &gt;&gt;     $proto = getprotobyname&#40;&#39;tcp&#39;&#41;;
&gt; &gt; &gt;&gt; }
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; I&#39;ll benchmark these to check which is faster, but in terms of
&gt; &gt; &gt;&gt; readability, I really prefer eval.
</div>&gt; &gt; &gt;
&gt; &gt; &gt; Yeah, the eval version is much nicer to read. However, consider
&gt; &gt; &gt; that
&gt; &gt; &gt; the
&gt; &gt; &gt; long version with the if can be optimized away by perl so that only
&gt; &gt; &gt; the &#39;my
&gt; &gt; &gt; $proto;&#39; is ever run.
</div>&gt; &gt;
&gt; &gt; Hmm, can it be optimized in such a case? I think only when there&#39;s a
&gt; &gt; if 0 at compilation time, the expression is optimized away.
</div>&gt; 
&gt; Whoops, pardons, I missed this message. I think you&#39;re right -- it
&gt; won&#39;t optimize it away at runtime, much less with %Config which is
&gt; tried.  You could do something like
&gt; 
&gt; use Config;
&gt; use constant {
&gt;         HAS_GETPROTOBYNAME     =&gt; $Config::Config{d_getpbyname},
&gt;         HAS_GETPROTOBYNUMBER =&gt; $Config::Config{d_getpbynumber}
&gt; };
&gt; 
&gt; my $proto = HAS_GETPROTOBYNAME ? getprotobyname&#40;&#39;tcp&#39;&#41; : undef;
&gt; 
<div class="message-stanza open">&gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; The my $proto = ... if ...; version might give
&gt; &gt; &gt; deprecation warnings too, because it&#39;s unintentionally creating a
&gt; &gt; &gt; state
&gt; &gt; &gt; variable.
</div>&gt; &gt;
&gt; &gt; Indeed, although this construct does not warn yet, it might one day.
&gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; Also, the less opcodes of eval might not be as less as you imagine;
&gt; &gt; &gt; off the
&gt; &gt; &gt; top of my head, you&#39;d be dealing with entertry, dotry, possibly a
&gt; &gt; &gt; croak+longjmp+$SIG{__DIE__}, plus the risk that __DIE__ handler is
&gt; &gt; &gt; not
&gt; &gt; &gt; checking for $^S, and then leavetry.
&gt; &gt; &gt; Perhaps this would be better?
&gt; &gt; &gt; my $proto = $Config{d_getpbyname} ? getprotobyname&#40;&#39;tcp&#39;&#41; : undef;
</div>&gt; &gt;
&gt; &gt;
&gt; &gt; I&#39;m benchmarking the different solutions with Dumbbench &#40;supposedly
&gt; &gt; better than Benchmark&#41; to see how well they perform, and currently,
&gt; &gt; eval-block seem to always win, but in some cases with such a
&gt; &gt; difference that I&#39;m doubting the results.
</div>&gt; 
&gt; Benchmarks are hard, let&#39;s go shopping :P
</div>
Hey, sorry to nag, but would it be possible to get some variant of this applied? It&#39;s making smoking android a bit of a pain :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;25&nbsp;15:51:54&nbsp;2014</span>
    <span class="description">sebastien [...] aperghis.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #90218] Handle getprotobyn{ame,umber} not being available</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 25 Jul 2014 21:51:44 +0200 &#40;CEST&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sys-Syslog [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Sébastien Aperghis-Tramoni &lt;sebastien [...] aperghis.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Brian Fraser wrote via RT:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hey, sorry to nag, but would it be possible to get some variant of
&gt; this applied? It&#39;s making smoking android a bit of a pain :&#41;
</div>
Don&#39;t apologize, I&#39;m a terrible maintainer :&#40;
I actually did quite some benchmarks in OSX and Linux and found the
less costly code. This code is on the computer in repair. I&#39;ll try
to fetch from the backup and commit. Not sure when I can though.

-- 
Sébastien Aperghis-Tramoni

Close the world, txEn eht nepO.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;25&nbsp;17:47:31&nbsp;2014</span>
    <span class="description">fraserbn [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> fraserbn [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jul 25 15:51:54 2014, sebastien@aperghis.net wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Brian Fraser wrote via RT:
&gt; 
<div class="message-stanza open">&gt; &gt; Hey, sorry to nag, but would it be possible to get some variant of
&gt; &gt; this applied? It&#39;s making smoking android a bit of a pain :&#41;
</div>&gt; 
&gt; Don&#39;t apologize, I&#39;m a terrible maintainer :&#40;
&gt; I actually did quite some benchmarks in OSX and Linux and found the
&gt; less costly code. This code is on the computer in repair. I&#39;ll try
&gt; to fetch from the backup and commit. Not sure when I can though.
&gt; 
</div>
Actually, I&#39;m worse still: There was a discussion in another module about the most efficient approach, and I notice now that I somehow neglected to relay the results here.

getprotobyname&#40;&#34;tcp&#34;&#41; in scalar context is exactly the same as Socket::IPPROTO_TCP; for &#39;udp&#39;, the constant is Socket::IPPROTO_UDP.
If you were using the function in list context, the eval/%Config games become more attractive, but in scalar context, the constants are not just correct but faster. Score :D

For <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=90224">https://rt.cpan.org/Public/Bug/Display.html?id=90224</a></span> I don&#39;t think there is a consensus; I imagine that

use Config;
use constant HAVE_SETLOCALE =&gt; $Config::Config{d_setlocale};

And then replace the $Config::Config{d_setlocale} in that patch on that ticket with HAVE_SETLOCALE would do away with any performance hit, since the if&#40;&#41; would get optimized away at compile time, one way or another.

..so here&#39;s an updated patch with those changes.

diff --git a/cpan/Sys-Syslog/Syslog.pm b/cpan/Sys-Syslog/Syslog.pm
index 25164af..1d9c3f7 100644
--- a/cpan/Sys-Syslog/Syslog.pm
+++ b/cpan/Sys-Syslog/Syslog.pm
@@ -9,6 +9,9 @@ use POSIX           qw&lt; strftime setlocale LC_TIME &gt;;
 use Socket          qw&lt; :all &gt;;
 require 5.005;
 
+use Config;
+use constant HAVE_SETLOCALE =&gt; $Config::Config{d_setlocale};
+
 
 {   no strict &#39;vars&#39;;
     $VERSION = &#39;0.33&#39;;
@@ -433,10 +436,13 @@ sub syslog {
         $whoami .= &#34;[$$]&#34; if $options{pid};
 
         $sum = $numpri + $numfac;
-        my $oldlocale = setlocale&#40;LC_TIME&#41;;
-        setlocale&#40;LC_TIME, &#39;C&#39;&#41;;
+        my $oldlocale;
+        if &#40; HAVE_SETLOCALE &#41; {
+            $oldlocale = setlocale&#40;LC_TIME&#41;;
+            setlocale&#40;LC_TIME, &#39;C&#39;&#41;;
+        }
         my $timestamp = strftime &#34;%b %d %H:%M:%S&#34;, localtime;
-        setlocale&#40;LC_TIME, $oldlocale&#41;;
+        setlocale&#40;LC_TIME, $oldlocale&#41; if HAVE_SETLOCALE;
 
         # construct the stream that will be transmitted
         $buf = &#34;&lt;$sum&gt;$timestamp $whoami: $message&#34;;
@@ -622,11 +628,7 @@ sub connect_log {
 sub connect_tcp {
     my &#40;$errs&#41; = @_;
 
-    my $proto = getprotobyname&#40;&#39;tcp&#39;&#41;;
-    if &#40;!defined $proto&#41; {
-       push @$errs, &#34;getprotobyname failed for tcp&#34;;
-       return 0;
-    }
+    my $proto = Socket::IPPROTO_TCP;
 
     my $port = $sock_port || getservbyname&#40;&#39;syslog&#39;, &#39;tcp&#39;&#41;;
     $port = getservbyname&#40;&#39;syslogng&#39;, &#39;tcp&#39;&#41; unless defined $port;
@@ -670,11 +672,7 @@ sub connect_tcp {
 sub connect_udp {
     my &#40;$errs&#41; = @_;
 
-    my $proto = getprotobyname&#40;&#39;udp&#39;&#41;;
-    if &#40;!defined $proto&#41; {
-       push @$errs, &#34;getprotobyname failed for udp&#34;;
-       return 0;
-    }
+    my $proto = Socket::IPPROTO_UDP;
 
     my $port = $sock_port || getservbyname&#40;&#39;syslog&#39;, &#39;udp&#39;&#41;;
     if &#40;!defined $port&#41; {
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;05&nbsp;17:32:22&nbsp;2016</span>
    <span class="description">SAPER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Apologies, I had forgot about Sys::Syslog again.

Regarding the part about setlocale&#40;&#41;, I have mostly applied your
patch &#40;with a few adjustments because of other changes&#41;.

For the part about getprotobyname&#40;&#41; / IPPROTO_TCP, I am going to
use local constants which get their values from getprotobyname&#40;&#41;,
or from Socket::IPPROTO_*. This will simply the code.

-- 
Close the world, txEn eht nepO.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;06&nbsp;05:27:00&nbsp;2016</span>
    <span class="description">SAPER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This issue should be fixed with version 0.34, just released.

-- 
Close the world, txEn eht nepO.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;06&nbsp;05:27:06&nbsp;2016</span>
    <span class="description">SAPER [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;06&nbsp;05:27:07&nbsp;2016</span>
    <span class="description">SAPER [...] cpan.org -  Fixed in 0.34 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;06&nbsp;07:35:09&nbsp;2016</span>
    <span class="description">SAPER [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
