<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #92904 for Net-Async-HTTP: Futures in ready-queue are double-failed when max_connections_per_host!=1</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #92904 for Net-Async-HTTP: Futures in ready-queue are double-failed when max_connections_per_host!=1</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Net-Async-HTTP">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Net-Async-HTTP">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Net-Async-HTTP">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Net-Async-HTTP">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-Async-HTTP">Net-Async-HTTP CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">92904</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Net-Async-HTTP">Net-Async-HTTP</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">leonerd-cpan [...] leonerd.org.uk
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dakkar [...] thenautilus.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-222348-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.33    </td>
  </tr>
  <tr id="CF-222349-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.34    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




client-test.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1324860/702624/client-test.pl">
Mon Feb 10 09:48:24 2014 (468b) by DAKKAR [...] cpan.org
</a>
</font></li>
</ul>


maybe-fix-double-fail.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1324860/702625/maybe-fix-double-fail.patch">
Mon Feb 10 09:48:24 2014 (735b) by DAKKAR [...] cpan.org
</a>
</font></li>
</ul>


rt92904.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1343897/713181/rt92904.patch">
Thu Mar 27 08:54:32 2014 (9.7k) by leonerd-cpan [...] leonerd.org.uk
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=92904">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1324860" href="/Public/Bug/Display.html?id=92904#txn-1324860">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;10&nbsp;09:48:24&nbsp;2014</span>
    <span class="description">DAKKAR [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Futures in ready-queue are double-failed when max_connections_per_host!=1</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1324860/702623/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/702623">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 420b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">First attachment: minimal test case.
Second attachment: a patch that seems to fix the issue

I&#39;m not sure what goes wrong in the released version, but I&#39;ve made the failure code work the same way as the success one: grab a non-cancelled future from the ready-queue, and fail it.

Problem: passing a future to get_connection does not work anymore, and this is probably a bug. On the other hand, it was never documented…
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> client-test.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1324860/702624/client-test.pl">Download client-test.pl</a><br />
<span class="downloadcontenttype">text/x-perl 468b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/env perl
use strict;
use warnings;
use 5.10.0;
use Data::Printer;
use Net::Async::HTTP;
use IO::Async::Loop;

my $client = Net::Async::HTTP-&gt;new&#40;
    max_connections_per_host =&gt; 2,
&#41;;

my $loop = IO::Async::Loop-&gt;new;
$loop-&gt;add&#40;$client&#41;;

my @f = map {
    $client-&gt;do_request&#40;uri=&gt;&#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:5000/&#39;&#41;">http://localhost:5000/&#39;&#41;</a></span>
        -&gt;then&#40;
            sub{say &#34;OK:&#34;.p&#40;@_&#41;;Future-&gt;wrap&#40;&#41;},
            sub{say &#34;Fail:&#34;.p&#40;@_&#41;;Future-&gt;wrap&#40;&#41;},
        &#41;;
} 1..2;

$loop-&gt;run;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> maybe-fix-double-fail.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1324860/702625/maybe-fix-double-fail.patch">Download maybe-fix-double-fail.patch</a><br />
<span class="downloadcontenttype">text/x-diff 735b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git c/lib/Net/Async/HTTP.pm w/lib/Net/Async/HTTP.pm
index a42b018..60ccac5 100644
--- c/lib/Net/Async/HTTP.pm
+++ w/lib/Net/Async/HTTP.pm
@@ -388,10 +388,15 @@ sub get_connection
          on_error =&gt; sub {
             my $conn = shift;
 
-            $f-&gt;fail&#40; @_ &#41; unless $f-&gt;is_cancelled;
+            while&#40; @$ready_queue &#41; {
+                my $f = shift @$ready_queue;
+                next if $f-&gt;is_cancelled;
+
+                $f-&gt;fail&#40; @_ &#41;;
+                last;
+            }
 
             @$conns = grep { $_ != $conn } @$conns;
-            @$ready_queue = grep { $_ != $f } @$ready_queue;
 
             if&#40; @$ready_queue &#41; {
                # Requeue another connection attempt as there&#39;s still more to do
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1328616" href="/Public/Bug/Display.html?id=92904#txn-1328616">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;19&nbsp;20:38:17&nbsp;2014</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1328616/704726/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/704726">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 299b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Feb 10 09:48:24 2014, DAKKAR wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; First attachment: minimal test case.
</div>
Indeed; &#40;minus the redundant  use Data::Printer&#41; I get:

$ perl rt92904.pl 
IO::Async::Future=HASH&#40;0x1fc7558&#41; is already failed and cannot be -&gt;fail&#39;ed at /usr/share/perl5/Net/Async/HTTP.pm line 391.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1328617" href="/Public/Bug/Display.html?id=92904#txn-1328617">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;19&nbsp;20:38:17&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1328623" href="/Public/Bug/Display.html?id=92904#txn-1328623">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;19&nbsp;20:58:00&nbsp;2014</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1328623/704732/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/704732">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Feb 10 09:48:24 2014, DAKKAR wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Second attachment: a patch that seems to fix the issue
&gt; 
&gt; I&#39;m not sure what goes wrong in the released version, but I&#39;ve made
&gt; the failure code work the same way as the success one: grab a non-
&gt; cancelled future from the ready-queue, and fail it.
</div>
I don&#39;t think that&#39;s the right solution; I think the problem is in fact somewhat earlier than this.

Despite there being only two -&gt;GET calls and two Futures, in total three connection attempts are made:

$ IO_ASYNC_DEBUG=1 perl rt92904.pl 
[Na:HTTP::Connection{localhost:5000,connecting}&lt;-Na:HTTP] CONNECT localhost:5000
[Na:HTTP::Connection{localhost:5000,connecting}&lt;-Na:HTTP] CONNECT localhost:5000
[Ia:Stream{r=8}&lt;-Ia:Channel&lt;-Ia:Function::Worker&lt;-Ia:Resolver] EVENT on_read
[Ia:Stream{r=5}&lt;-Ia:Channel&lt;-Ia:Function::Worker&lt;-Ia:Resolver] EVENT on_read
[Na:HTTP::Connection{localhost:5000,connecting}&lt;-Na:HTTP] CONNECT localhost:5000
[Ia:Stream{r=5}&lt;-Ia:Channel&lt;-Ia:Function::Worker&lt;-Ia:Resolver] EVENT on_read
IO::Async::Future=HASH&#40;0x1522f10&#41; is already failed and cannot be -&gt;fail&#39;ed at /usr/share/perl5/Net/Async/HTTP.pm line 391.

I suspect getting to the bottom of this will solve it.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1343897" href="/Public/Bug/Display.html?id=92904#txn-1343897">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;27&nbsp;08:54:32&nbsp;2014</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1343897/713180/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/713180">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 301b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Found it.

This was due to a second attempt to connect&#40;&#41; to the host for the second request after the first request failed, due to second request still living in the ready queue.

Solved by keeping track of which ready queue items are already connect-pending, and skipping over those.

-- 

Paul Evans
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rt92904.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1343897/713181/rt92904.patch">Download rt92904.patch</a><br />
<span class="downloadcontenttype">text/x-diff 9.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">=== modified file &#39;Build.PL&#39;
--- Build.PL	2013-12-30 23:22:21 +0000
+++ Build.PL	2014-03-27 12:34:15 +0000
@@ -14,6 +14,7 @@
       &#39;IO::Async::Loop&#39; =&gt; &#39;0.59&#39;,
       &#39;IO::Async::Stream&#39; =&gt; &#39;0.59&#39;,
       &#39;IO::Async::Timer::Countdown&#39; =&gt; 0,
+      &#39;Struct::Dumb&#39; =&gt; 0,
       &#39;URI&#39; =&gt; 0,
    },
    recommends =&gt; {

=== modified file &#39;lib/Net/Async/HTTP.pm&#39;
--- lib/Net/Async/HTTP.pm	2014-02-20 14:39:05 +0000
+++ lib/Net/Async/HTTP.pm	2014-03-27 12:45:58 +0000
@@ -1,7 +1,7 @@
 #  You may distribute under the terms of either the GNU General Public License
 #  or the Artistic License &#40;the same terms as Perl itself&#41;
 #
-#  &#40;C&#41; Paul Evans, 2008-2013 -- leonerd@leonerd.org.uk
+#  &#40;C&#41; Paul Evans, 2008-2014 -- leonerd@leonerd.org.uk
 
 package Net::Async::HTTP;
 
@@ -53,6 +53,9 @@
 use constant READ_LEN  =&gt; 64*1024; # 64 KiB
 use constant WRITE_LEN =&gt; 64*1024; # 64 KiB
 
+use Struct::Dumb;
+struct Ready =&gt; [qw&#40; future connecting &#41;];
+
 =head1 NAME
 
 C&lt;Net::Async::HTTP&gt; - use HTTP with C&lt;IO::Async&gt;
@@ -323,7 +326,7 @@
       push @{ $args{extensions} }, &#34;SSL&#34;;
    }
 
-   $conn-&gt;connect&#40;
+   my $f = $conn-&gt;connect&#40;
       host     =&gt; $host,
       service  =&gt; $port,
       &#40; map { defined $self-&gt;{$_} ? &#40; $_ =&gt; $self-&gt;{$_} &#41; : &#40;&#41; } qw&#40; local_host local_port local_addrs local_addr &#41; &#41;,
@@ -340,6 +343,8 @@
    }&#41;-&gt;on_fail&#40; sub {
       $on_error-&gt;&#40; $conn, &#34;$host:$port - $_[0] failed [$_[-1]]&#34; &#41;;
    }&#41;;
+
+   $f-&gt;on_ready&#40; sub { undef $f } &#41;; # intentionally cycle
 }
 
 sub get_connection
@@ -356,50 +361,56 @@
    my $conns = $self-&gt;{connections}{$key} ||= [];
    my $ready_queue = $self-&gt;{ready_queue}{$key} ||= [];
 
-   my $f = $args{future} || $self-&gt;loop-&gt;new_future;
-
    # Have a look to see if there are any idle connected ones first
    foreach my $conn &#40; @$conns &#41; {
-      $conn-&gt;is_idle and $conn-&gt;read_handle and return $f-&gt;done&#40; $conn &#41;;
-   }
-
-   push @$ready_queue, $f unless $args{future};
-
-   if&#40; !$self-&gt;{max_connections_per_host} or @$conns &lt; $self-&gt;{max_connections_per_host} &#41; {
-      my $conn = Net::Async::HTTP::Connection-&gt;new&#40;
-         notifier_name =&gt; &#34;$host:$port,connecting&#34;,
-         ready_queue   =&gt; $ready_queue,
-         &#40; map { $_ =&gt; $self-&gt;{$_} }
-            qw&#40; max_in_flight pipeline read_len write_len decode_content &#41; &#41;,
-
-         on_closed =&gt; sub {
-            my $conn = shift;
-
-            $conn-&gt;remove_from_parent;
-            @$conns = grep { $_ != $conn } @$conns;
-         },
-      &#41;;
-
-      $self-&gt;add_child&#40; $conn &#41;;
-      push @$conns, $conn;
-
-      $self-&gt;connect_connection&#40; %args,
-         conn =&gt; $conn,
-         on_error =&gt; sub {
-            my $conn = shift;
-
-            $f-&gt;fail&#40; @_ &#41; unless $f-&gt;is_cancelled;
-
-            @$conns = grep { $_ != $conn } @$conns;
-            @$ready_queue = grep { $_ != $f } @$ready_queue;
-
-            if&#40; @$ready_queue &#41; {
-               # Requeue another connection attempt as there&#39;s still more to do
-               $self-&gt;get_connection&#40; %args, future =&gt; $ready_queue-&gt;[0] &#41;;
-            }
-         },
-      &#41;;
-   }
+      $conn-&gt;is_idle and $conn-&gt;read_handle and return Future-&gt;new-&gt;done&#40; $conn &#41;;
+   }
+
+   my $ready = $args{ready};
+   $ready or push @$ready_queue, $ready = Ready&#40; $self-&gt;loop-&gt;new_future, 0 &#41;;
+
+   my $f = $ready-&gt;future;
+
+   my $max = $self-&gt;{max_connections_per_host};
+   if&#40; $max and @$conns &gt;= $max &#41; {
+      return $f;
+   }
+
+   $ready-&gt;connecting++;
+
+   my $conn = Net::Async::HTTP::Connection-&gt;new&#40;
+      notifier_name =&gt; &#34;$host:$port,connecting&#34;,
+      ready_queue   =&gt; $ready_queue,
+      &#40; map { $_ =&gt; $self-&gt;{$_} }
+         qw&#40; max_in_flight pipeline read_len write_len decode_content &#41; &#41;,
+
+      on_closed =&gt; sub {
+         my $conn = shift;
+
+         $conn-&gt;remove_from_parent;
+         @$conns = grep { $_ != $conn } @$conns;
+      },
+   &#41;;
+
+   $self-&gt;add_child&#40; $conn &#41;;
+   push @$conns, $conn;
+
+   $self-&gt;connect_connection&#40; %args,
+      conn =&gt; $conn,
+      on_error =&gt; sub {
+         my $conn = shift;
+
+         $f-&gt;fail&#40; @_ &#41; unless $f-&gt;is_cancelled;
+
+         @$conns = grep { $_ != $conn } @$conns;
+         @$ready_queue = grep { $_ != $ready } @$ready_queue;
+
+         if&#40; my &#40; $next &#41; = grep { !$_-&gt;connecting } @$ready_queue &#41; {
+            # Requeue another connection attempt as there&#39;s still more to do
+            $self-&gt;get_connection&#40; %args, ready =&gt; $next &#41;;
+         }
+      },
+   &#41;;
 
    return $f;
 }

=== modified file &#39;lib/Net/Async/HTTP/Connection.pm&#39;
--- lib/Net/Async/HTTP/Connection.pm	2014-02-20 14:39:05 +0000
+++ lib/Net/Async/HTTP/Connection.pm	2014-03-27 12:45:58 +0000
@@ -1,7 +1,7 @@
 #  You may distribute under the terms of either the GNU General Public License
 #  or the Artistic License &#40;the same terms as Perl itself&#41;
 #
-#  &#40;C&#41; Paul Evans, 2008-2013 -- leonerd@leonerd.org.uk
+#  &#40;C&#41; Paul Evans, 2008-2014 -- leonerd@leonerd.org.uk
 
 package Net::Async::HTTP::Connection;
 
@@ -20,10 +20,8 @@
 
 my $CRLF = &#34;\x0d\x0a&#34;; # More portable than \r\n
 
-# Indices into responder/ready queue elements
-use constant ON_READ  =&gt; 0;
-use constant ON_ERROR =&gt; 1;
-use constant IS_DONE  =&gt; 2;
+use Struct::Dumb;
+struct Responder =&gt; [qw&#40; on_read on_error is_done &#41;];
 
 # Detect whether HTTP::Message properly trims whitespace in header values. If
 # it doesn&#39;t, we have to deploy a workaround to fix them up.
@@ -111,7 +109,7 @@
    if&#40; $self-&gt;should_pipeline &#41; {
       $self-&gt;debug_printf&#40; &#34;READY pipelined&#34; &#41;;
       while&#40; @$queue &#38;&#38; $self-&gt;should_pipeline &#41; {
-         my $f = shift @$queue;
+         my $f = &#40; shift @$queue &#41;-&gt;future;
          next if $f-&gt;is_cancelled;
 
          $f-&gt;done&#40; $self &#41;;
@@ -120,7 +118,7 @@
    elsif&#40; @$queue and $self-&gt;is_idle &#41; {
       $self-&gt;debug_printf&#40; &#34;READY non-pipelined&#34; &#41;;
       while&#40; @$queue &#41; {
-         my $f = shift @$queue;
+         my $f = &#40; shift @$queue &#41;-&gt;future;
          next if $f-&gt;is_cancelled;
 
          $f-&gt;done&#40; $self &#41;;
@@ -153,12 +151,12 @@
    my &#40; $buffref, $closed &#41; = @_;
 
    if&#40; my $head = $self-&gt;{responder_queue}[0] &#41; {
-      my $ret = $head-&gt;[ON_READ]-&gt;&#40; $self, $buffref, $closed, $head &#41;;
+      my $ret = $head-&gt;on_read-&gt;&#40; $self, $buffref, $closed, $head &#41;;
 
       if&#40; defined $ret &#41; {
          return $ret if !ref $ret;
 
-         $head-&gt;[ON_READ] = $ret;
+         $head-&gt;on_read = $ret;
          return 1;
       }
 
@@ -184,7 +182,7 @@
    my $self = shift;
 
    while&#40; my $head = shift @{ $self-&gt;{responder_queue} } &#41; {
-      $head-&gt;[ON_ERROR]-&gt;&#40; @_ &#41; unless $head-&gt;[IS_DONE];
+      $head-&gt;on_error-&gt;&#40; @_ &#41; unless $head-&gt;is_done;
    }
 }
 
@@ -337,7 +335,7 @@
       # 204 &#40;No Content&#41; nor 304 &#40;Not Modified&#41;
       if&#40; $method eq &#34;HEAD&#34; or $code =~ m/^1..$/ or $code eq &#34;204&#34; or $code eq &#34;304&#34; &#41; {
          $self-&gt;debug_printf&#40; &#34;BODY done&#34; &#41;;
-         $responder-&gt;[IS_DONE]++;
+         $responder-&gt;is_done++;
          $self-&gt;close if $connection_close;
          $f-&gt;done&#40; $on_body_chunk-&gt;&#40;&#41; &#41; unless $f-&gt;is_cancelled;
          $self-&gt;_request_done;
@@ -390,7 +388,7 @@
                   # TODO: Actually use the trailer
 
                   $self-&gt;debug_printf&#40; &#34;BODY done&#34; &#41;;
-                  $responder-&gt;[IS_DONE]++;
+                  $responder-&gt;is_done++;
 
                   my $final;
                   if&#40; $decoder and not eval { $final = $decoder-&gt;&#40;&#41;; 1 } &#41; {
@@ -443,7 +441,7 @@
 
          if&#40; $content_length == 0 &#41; {
             $self-&gt;debug_printf&#40; &#34;BODY done&#34; &#41;;
-            $responder-&gt;[IS_DONE]++;
+            $responder-&gt;is_done++;
             $f-&gt;done&#40; $on_body_chunk-&gt;&#40;&#41; &#41; unless $f-&gt;is_cancelled;
             $self-&gt;_request_done;
             return undef; # Finished
@@ -470,7 +468,7 @@
 
             if&#40; $content_length == 0 &#41; {
                $self-&gt;debug_printf&#40; &#34;BODY done&#34; &#41;;
-               $responder-&gt;[IS_DONE]++;
+               $responder-&gt;is_done++;
                $self-&gt;close if $connection_close;
 
                my $final;
@@ -520,7 +518,7 @@
             # TODO: IO::Async probably ought to do this. We need to fire the
             # on_closed event _before_ calling on_body_chunk, to clear the
             # connection cache in case another request comes - e.g. HEAD-&gt;GET
-            $responder-&gt;[IS_DONE]++;
+            $responder-&gt;is_done++;
             $self-&gt;close;
 
             $self-&gt;debug_printf&#40; &#34;BODY done&#34; &#41;;
@@ -590,10 +588,11 @@
 
    $self-&gt;{requests_in_flight}++;
 
-   push @{ $self-&gt;{responder_queue} }, [ $on_read, sub {
-      # Protect against double-fail during -&gt;error_all
-      $f-&gt;fail&#40; @_ &#41; unless $f-&gt;is_ready;
-   } ];
+   push @{ $self-&gt;{responder_queue} }, Responder&#40;
+      $on_read,
+      sub { $f-&gt;fail&#40; @_ &#41; unless $f-&gt;is_ready; }, # on_error
+      0, # is_done
+   &#41;;
 
    return $f;
 }

=== added file &#39;t/90rt92904.t&#39;
--- t/90rt92904.t	1970-01-01 00:00:00 +0000
+++ t/90rt92904.t	2014-03-27 12:45:58 +0000
@@ -0,0 +1,44 @@
+#!/usr/bin/perl
+
+use strict;
+use warnings;
+
+use Test::More;
+use IO::Async::Test;
+use IO::Async::Loop;
+
+use Net::Async::HTTP;
+
+my $loop = IO::Async::Loop-&gt;new;
+testing_loop&#40; $loop &#41;;
+
+my $http = Net::Async::HTTP-&gt;new&#40;
+    max_connections_per_host =&gt; 2,
+&#41;;
+
+$loop-&gt;add&#40; $http &#41;;
+
+my @conn_f;
+no warnings &#39;redefine&#39;;
+local *IO::Async::Loop::connect = sub {
+   shift;
+   my %args = @_;
+   $args{host} eq &#34;localhost&#34; or die &#34;Cannot fake connect - expected host &#39;localhost&#39;&#34;;
+   $args{service} eq &#34;5000&#34;   or die &#34;Cannot fake connect - expected service &#39;5000&#39;&#34;;
+
+   push @conn_f, my $f = $loop-&gt;new_future;
+   return $f;
+};
+
+my @f = map { $http-&gt;do_request&#40;uri=&gt;&#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:5000/&#39;&#41;">http://localhost:5000/&#39;&#41;</a></span> } 0 .. 1;
+
+is&#40; scalar @conn_f, 2, &#39;Two pending connect&#40;&#41; attempts after two concurrent -&gt;do_request&#39; &#41;;
+
+# Fail them both
+&#40; shift @conn_f &#41;-&gt;fail&#40; &#34;Connection refused&#34;, connect =&gt; &#41; for 0 .. 1;
+
+ok&#40; $f[$_]-&gt;is_ready &#38;&#38; $f[$_]-&gt;failure, &#34;Request [$_] Future fails after connect failure&#34; &#41; for 0 .. 1;
+
+ok&#40; !@conn_f, &#39;No more pending connect&#40;&#41; attempts&#39; &#41;;
+
+done_testing;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1343899" href="/Public/Bug/Display.html?id=92904#txn-1343899">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;27&nbsp;08:54:49&nbsp;2014</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1344361" href="/Public/Bug/Display.html?id=92904#txn-1344361">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;28&nbsp;06:47:01&nbsp;2014</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1344361/713411/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/713411">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 33b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Released in 0.34

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1344363" href="/Public/Bug/Display.html?id=92904#txn-1344363">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;28&nbsp;06:47:01&nbsp;2014</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1344365" href="/Public/Bug/Display.html?id=92904#txn-1344365">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;28&nbsp;06:47:02&nbsp;2014</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Fixed in 0.34 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.494795</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
