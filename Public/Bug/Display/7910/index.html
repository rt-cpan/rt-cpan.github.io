<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #7910 for Net-SSH-Perl: $shh&#40;&#34;cat -&gt; file&#34;,$data&#41; hangs on large amount of data</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #7910 for Net-SSH-Perl: $shh&#40;&#34;cat -&gt; file&#34;,$data&#41; hangs on large amount of data</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-SSH-Perl/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-SSH-Perl/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-SSH-Perl/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-SSH-Perl/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-SSH-Perl">Net-SSH-Perl CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">7910</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-SSH-Perl/Active/">Net-SSH-Perl</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bwalz [...] paradigm-healthcare.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-23272-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.25    </td>
  </tr>
  <tr id="CF-23273-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;06&nbsp;17:41:46&nbsp;2004</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> $shh&#40;&#34;cat -&gt; file&#34;,$data&#41; hangs on large amount of data</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This probalbly is not a bug but a problem with my older version of openssh on the client machine but:

$ssh-&gt;cmd&#40;&#34;cat -&gt;/tmp/file.tmp&#34;, $alot_of_data&#41;;

will cause the process to hang when dumping more than say 6K of data.

The following code sample from pscp fixes the problem &#40;file contents in $c&#41;:

    # chop up file, seems to lock up on large chunks
    my @chunks = $c =~ /.{1,6144}/gs;
    my $f = 0;
    foreach my $chunk &#40;@chunks&#41; {
      my $cmd = $f++?&#34;cat - &gt;&gt;$tfile&#34;:&#34;cat - &gt;$tfile&#34;;
      my&#40;$out, $err, $exit&#41; = $ssh-&gt;cmd&#40;$cmd, $chunk&#41;;
        die &#34;Can&#39;t write file $tfile: $err&#34; if $err;
    }



Debug ouput including version numbers:

: Reading configuration data /home/bill/.ssh/config
: Reading configuration data /etc/ssh_config
: Connecting to xxxx.xxxx.com, port 22.
: Remote protocol version 1.99, remote software version OpenSSH_3.1p1
: Net::SSH::Perl Version 1.25, protocol version 2.0.
: No compat match: OpenSSH_3.1p1.
: Connection established.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;15&nbsp;10:14:33&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Wed Oct  6 17:41:46 2004]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This probalbly is not a bug but a problem with my older version of
&gt; openssh on the client machine but:
&gt; 
&gt; $ssh-&gt;cmd&#40;&#34;cat -&gt;/tmp/file.tmp&#34;, $alot_of_data&#41;;
&gt; 
&gt; will cause the process to hang when dumping more than say 6K of data.
</div>
I&#39;ve found the bug, and have fixed it as described below. I don&#39;t
think this is the best way to fix it, but it did prove my theory
on how the bug was occuring.

The problem occurs due to the interaction between drain_outgoing
&#40;in Channel.pm&#41; and client_loop in &#40;SSH2.pm&#41;.

If your $stdout is bigger than remote_maxpacket, drain_outgoing
tries to repeatedly call client_loop until the length is reduced
to zero. The problem is that client_loop will not return back
to drain_outgoing, once it is called from inside the while loop
the second time.

MY FIX:
I reasoned that if I could force the client_loop to execute
one-and-only-one-time, for each time it was called from the
drain_outgoing while loop, there would be no problem. To test
this, I did the following:

1.&#41; drain_outgoing: added the following line before the
        while loop

$c-&gt;{ssh}-&gt;{DoOneLoop}=1;

2.&#41; drain_outgoing: added the following line after the
        while loop

undef&#40;$c-&gt;{ssh}-&gt;{DoOneLoop}&#41;;

3.&#41; client_loop: added the following line just before the
        end of the first while loop

        last if&#40;$ssh-&gt;{DoOneLoop}&#41;;

This seems to have fixed it for all scenarios that I&#39;ve tested.

If you know of a better solution, or know how to get this
into the official distribution, please email me:
craig_at_lucent_dot_com
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;15&nbsp;22:35:33&nbsp;2005</span>
    <span class="description">dbrobins [...] davidrobins.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> David Robins &lt;dbrobins [...] davidrobins.net&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSH-Perl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #7910] $shh&#40;&#34;cat -&gt; file&#34;,$data&#41; hangs on large amount of data</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 15 Aug 2005 19:32:29 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> craig [...] lucent.com</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Monday August 15, 2005 07:14, Guest via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Full context and any attached attachments can be found at:
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=7910">https://rt.cpan.org/Ticket/Display.html?id=7910</a></span> &gt;
</div>
...

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If you know of a better solution, or know how to get this
&gt; into the official distribution, please email me:
&gt; craig_at_lucent_dot_com
</div>
Patches can be submitted to the list or to me &#40;DBROBINS at cpan.org&#41; directly.  
Please include:

- a summary of the problem being fixed &#40;test cases, what goes wrong, what you 
expect to happen&#41;
- a gzipped unified diff of the changed file&#40;s&#41;

I&#39;ll review it, and either apply it &#40;possibly with changes&#41; or get back to you 
with suggested changes.

Thanks,

-- 
Dave
Isa. 40:31
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;07&nbsp;19:52:47&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jgilbert</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Mon Aug 15 10:14:33 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve found the bug, and have fixed it as described below. I don&#39;t
&gt; think this is the best way to fix it, but it did prove my theory
&gt; on how the bug was occuring.
</div>[excellent fix snip]
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; This seems to have fixed it for all scenarios that I&#39;ve tested.
</div>
There are two scenarios where this is isn&#39;t totally fixed: 

1. when the remote peer is running OpenSSH 3.7.1p3
2. when the remote peer is running Sun&#39;s deployed SSH identified by
&#39;SSH-1.99-Sun_SSH_1.1&#39;

In these cases, with the DoOneLoop fix, the select&#40;&#41; call inside 
client_loop hangs indefinitely with a $stdin to cmd&#40;&#41; that is 
greater than 32768B. More interestingly, it appears that 
data on STDIN is put onto the resulting channel which is then put 
into the fd on the remote peer. 

We&#39;ve implemented the above, with the following additional changes in 
SSH2.pm, Constants.pm, and Channel.pm: 

diff /opt/rcs/lib/Net/SSH/Perl/Channel.pm
/opt/rcs/os_deployment/lib/Net/SSH/Perl/Channel.pm
191a192,193
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     ## COVD FIX:
&gt;     $c-&gt;{ssh}-&gt;{DoOneLoop} = 10;
</div>195a198,200
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     ## COVD FIX:
&gt;     undef&#40; $c-&gt;{ssh}-&gt;{DoOneLoop} &#41;;
&gt;     delete $c-&gt;{ssh}-&gt;{DoOneLoop};
</div>diff /opt/rcs/lib/Net/SSH/Perl/Constants.pm
/opt/rcs/os_deployment/lib/Net/SSH/Perl/Constants.pm
138c138
&lt;     &#39;MAX_PACKET_SIZE&#39; =&gt; 256000,
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     &#39;MAX_PACKET_SIZE&#39; =&gt; 8192,
</div>diff /opt/rcs/lib/Net/SSH/Perl/SSH2.pm
/opt/rcs/os_deployment/lib/Net/SSH/Perl/SSH2.pm
302c303,306
&lt;         my&#40;$rready, $wready&#41; = $select_class-&gt;select&#40;$rb, $wb&#41;;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         ## COVD FIX:
&gt;         $ssh-&gt;debug&#40;&#34;Instantiating a select with $ssh-&gt;{DoOneLoop}
</div>second timeout.&#34;&#41;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;             if &#40;exists $ssh-&gt;{DoOneLoop} &#38;&#38; $ssh-&gt;{DoOneLoop} &gt; 0&#41;;
&gt;         my&#40;$rready, $wready&#41; = $select_class-&gt;select&#40;$rb, $wb, undef,
</div>&#40;$ssh-&gt;{DoOneLoop} || undef&#41;&#41;;
313a318,319
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         ## COVD FIX:
&gt;         last if &#40;$ssh-&gt;{DoOneLoop}&#41;;
</div>
This workaround appears to function correctly with any filesize 
for SSH implementations identifing themselves as
SSH-1.99-OpenSSH_3.7.1p2, SSH-1.99-Sun_SSH_1.0.1, and 
SSH-1.99-Sun_SSH_1.1.

I&#39;m pretty sure this shouldn&#39;t make it into an official patch; I&#39;m 
just documenting this for anyone else bitten by this. ;&#41;

-jgilbert.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;16&nbsp;16:42:56&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Craig</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Folks- 

Not only is this bug appearing on many different platforms, but the fix I proposed earlier 
&#40;and the subsequent jgilbert fix&#41; doesn&#39;t work on some of them with v1.30 &#40;ppc-linux in 
particular&#41;. 

I&#39;ve written a perl script to cause the bug to occur, and identify just how many characters 
your system needs to trigger it. Can you try running it and see if you have the bug and post 
your results here? I&#39;ve also sent this to Dave Robins to see if he can figure this but out once 
and for all. 

My output is below. I&#39;m attaching the perl test script. 

Thanks 
-Craig

Net::SSH::Perl bug test...
host=nwsgpb user=watchmrk remoteCmd=cat
xferChars=932779|-Error, down to 466390 chars
        Received disconnect message: Corrupted MAC on input.
xferChars=466390|-Error, down to 233195 chars
        Received disconnect message: Corrupted MAC on input.
xferChars=233195|-Error, down to 116598 chars
        Received disconnect message: Corrupted MAC on input.
xferChars=116598|-Error, down to 58299 chars
        Received disconnect message: Corrupted MAC on input.
xferChars=58299|-Error, down to 29150 chars
        alarm handler 10 second timeout
xferChars=29150|-Error, down to 14575 chars
        alarm handler 10 second timeout
xferChars=14575|-Error, down to 7288 chars
        alarm handler 10 second timeout
xferChars=7288|-OK, back up to 10931 chars
xferChars=10931|-OK, back up to 12753 chars
xferChars=12753|-Error, down to 11842 chars
        alarm handler 10 second timeout
xferChars=11842|-Error, down to 11387 chars
        alarm handler 10 second timeout
xferChars=11387|-OK, back up to 11614 chars
xferChars=11614|-Error, down to 11501 chars
        alarm handler 10 second timeout
xferChars=11501|-OK, back up to 11557 chars
xferChars=11557|-Error, down to 11529 chars
        Received disconnect message: Corrupted MAC on input.
xferChars=11529|-OK, back up to 11543 chars
xferChars=11543|-Error, down to 11536 chars
        Received disconnect message: Corrupted MAC on input.
xferChars=11536|-Error, down to 11533 chars
        alarm handler 10 second timeout
xferChars=11533|-OK, back up to 11534 chars
xferChars=11534|-OK, back up to 11535 chars
xferChars=11535|-OK, back up to 11535 chars

Report for remote host: nwsgpb...
xferChars=11535 works, xferChars=11536 hangs on timeout=10.
exiting...
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/opt/exp/bin/perl
#!/usr/bin/perl

use strict;
use warnings;
use English;
use Data::Dumper;

# Set these for your remote host...
my $user = &#34;user&#34;;
my $password = &#34;password&#34;;
my $host = &#34;machine&#34;;

# Time to wait for remote command to finish...
my $timeout=10;		# Consider upping this if you change $high

# Remote command...
my $cmd = &#34;cat&#34;;

# Print heading...
print &#34;Net::SSH::Perl bug test...\n&#34;;
print &#34;host=$host user=$user remoteCmd=$cmd\n&#34;;

# Set variables...
my $high=932779;	# Maximum number of starting xmitChars
my $low=0;
my $i=$high;
my $delta=$high-$low;;

my $ssh;
# Main loop...
while&#40;$delta&gt;1&#41; {
	undef&#40;$ssh&#41;;
	print &#34;xferChars=$i&#34;;

	# setup SSH...
	$ssh = newssh&#40;&#41; ||
		die &#34;Can&#39;t create a new ssh, exiting...&#34;;
	print &#39;|&#39;;	# Indicates newssh worked...
	$ssh-&gt;login&#40;$user,$password&#41; ||
		die &#34;Can&#39;t login, exiting...&#34;;
	print &#39;-&#39;;	# Indicates successful login...

	# Proper values of $i will trigger the bug...
	my $stdin = &#39;=&#39; x  $i;
	# Run remote command...
	my &#40;$stdout, $stderr, $exit&#41; = runcmd&#40;$ssh, $cmd, $stdin, $timeout&#41;;

	# Check output...
	if&#40;defined&#40;$stdout&#41;&#41; {
		if&#40;length&#40;$stdout&#41; != $i&#41; {
			die &#34;Data mismatch, expected: $i chars, got: &#34;,
			length&#40;$stdout&#41;, &#34;chars\n&#34;;
		}
		# Go back up...
		$delta = $high-$i;
		$low = $i;
		$i += int&#40;$delta/2&#41;;
		print &#34;OK, back up to $i chars\n&#34;
	}else{
		# Go down...
		$delta = $i-$low;
		$high = $i;
		$i -= int&#40;$delta/2&#41;;
		print &#34;Error, down to $i chars\n\t$stderr\n&#34;;
		next;
	}
}

if &#40;$i == $high&#41; {
	print &#34;\nBug did not trigger with $high chars on this system.\n&#34;;
}else{
	print &#34;\nReport for remote host: $host...\n&#34;;
	print &#34;xferChars=$low works, xferChars=$high hangs on timeout=$timeout.\n&#34;;
}
print &#34;exiting...\n&#34;;

sub newssh
{
	my $ssh;

	# Require the correct SSH package, based on OS...
	if&#40;$OSNAME=~/^&#40;MSWin32&#41;/&#41; {
		require Net::SSH::W32Perl;
		$ssh = Net::SSH::W32Perl-&gt;new&#40; $host, 
			port =&gt; 22 ,
			protocol =&gt; 2,
			#debug =&gt; 999,
		&#41;;
	}else{
		require Net::SSH::Perl;
		$ssh = Net::SSH::Perl-&gt;new&#40; $host, 
			port =&gt; 22 ,
			protocol =&gt; 2,
			#debug =&gt; 999,
		&#41;;
	}
	return&#40;$ssh&#41;;
}

sub runcmd
{
	my $ssh = shift || die &#34;Missing ssh object&#34;;
	my $cmd = shift || die &#34;Missing cmd&#34;;
	my $stdin = shift || die &#34;Missing stdin&#34;;
	my $timeout = shift || die &#34;Missing timeout&#34;;

	my &#40;$stdout, $stderr, $exit&#41;;
	eval {
		local $SIG{&#39;ALRM&#39;} = sub {
			die &#34;alarm handler $timeout second timeout&#34;;
		};

		alarm&#40;$timeout&#41;;

		&#40;$stdout, $stderr, $exit&#41; = $ssh-&gt;cmd&#40;$cmd, $stdin&#41;;

		alarm&#40;0&#41;;
	};
	if&#40;$@&#41; {
		$stderr=$@;
		$stderr=~s/&#40; at |\n&#41;.*$/ /s;
	}
	return &#40;$stdout, $stderr, $exit&#41;;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;16&nbsp;16:42:58&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;17&nbsp;02:10:10&nbsp;2007</span>
    <span class="description">dbrobins [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Looks like a dupe of 4559.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;17&nbsp;02:10:12&nbsp;2007</span>
    <span class="description">dbrobins [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;10&nbsp;09:31:12&nbsp;2011</span>
    <span class="description">craig [...] alcatel-lucent.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> craig [...] alcatel-lucent.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This ticket needs to be re-opened, as I&#39;ve encountered it again on version 1.34. I&#39;ve verified both 
the bug, and the DoOneLoop fix, under windows &#40;XP&#41;, MacOSX, and Solaris. However, the 
included detection script &#40;as-is&#41; does not catch the bug anymore. If you modify the high value to 
98304 or below, it will catch the bug when you connect to a solaris box running SSH-2.0-
Sun_SSH_1.1.3 &#40;and possibly others&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;10&nbsp;09:31:14&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
