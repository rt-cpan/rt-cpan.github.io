<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #43904 for Moose: Forbid recursive runtime role application</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #43904 for Moose: Forbid recursive runtime role application</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Moose/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Moose/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Moose/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Moose/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Moose">Moose CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">43904</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Moose/Active/">Moose</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">stevan.little [...] gmail.com
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ovid [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-38786-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-38787-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;06&nbsp;12:45:23&nbsp;2009</span>
    <span class="description">ovid [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Forbid recursive runtime role application</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I *think* this should be a bug as I can&#39;t find a use case for it and
it&#39;s bitten me pretty hard.  For any role, do this:

    MyRole-&gt;meta-&gt;apply&#40;$foo&#41; while 1;

Eventually you will get fun errors such as:

    Deep recursion on subroutine &#34;MRO::Compat::__get_linear_isa_dfs&#34; at
/home/poec01/trunk/Pips3/deps/lib/perl5/MRO/Compat.pm line 123.
    Deep recursion on subroutine
&#34;Class::MOP::Class::class_precedence_list&#34; at
/home/poec01/trunk/Pips3/deps/lib/perl5/i86pc-solaris-thread-multi/Class/MOP/Class.pm
line 613.
    Deep recursion on subroutine &#34;MRO::Compat::__get_linear_isa_dfs&#34; at
/home/poec01/trunk/Pips3/deps/lib/perl5/MRO/Compat.pm line 123.
    Deep recursion on subroutine &#34;MRO::Compat::__get_linear_isa_dfs&#34; at
/home/poec01/trunk/Pips3/deps/lib/perl5/MRO/Compat.pm line 123.
    Deep recursion on subroutine &#34;MRO::Compat::__get_linear_isa_dfs&#34; at
/home/poec01/trunk/Pips3/deps/lib/perl5/MRO/Compat.pm line 123.
    Deep recursion on subroutine &#34;MRO::Compat::__get_linear_isa_dfs&#34; at
/home/poec01/trunk/Pips3/deps/lib/perl5/MRO/Compat.pm line 123.
    Deep recursion on subroutine
&#34;Class::MOP::Class::class_precedence_list&#34; at
/home/poec01/trunk/Pips3/deps/lib/perl5/i86pc-solaris-thread-multi/Class/MOP/Class.pm
line 613.
    Deep recursion on subroutine &#34;MRO::Compat::__get_linear_isa_dfs&#34; at
/home/poec01/trunk/Pips3/deps/lib/perl5/MRO/Compat.pm line 123.
    Recursive inheritance detected while looking for method &#39;&#40;&#41;&#39; in
package &#39;Foo&#39; at
/home/poec01/trunk/Pips3/deps/lib/perl5/i86pc-solaris-thread-multi/Class/MOP/Instance.pm
line 157.
    Recursive inheritance detected while looking for method &#39;&#40;&#41;&#39; in
package &#39;Foo&#39;.

Reapplying a role at runtime to an instance should probably be fatal &#40;I
think&#41;.

This came up as we have test code which fetches a singleton &#40;yeah, I
know&#41; and applies a role to that.

Cheers,
Ovid
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;09&nbsp;17:26:24&nbsp;2009</span>
    <span class="description">autarch [...] urth.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #43904] Forbid recursive runtime role application</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 9 Mar 2009 16:25:47 -0500 &#40;CDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Curtis &#39;Ovid&#39; Poe via RT &lt;bug-Moose [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dave Rolsky &lt;autarch [...] urth.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, 6 Mar 2009, Curtis &#39;Ovid&#39; Poe via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Reapplying a role at runtime to an instance should probably be fatal &#40;I
&gt; think&#41;.
</div>
Shouldn&#39;t it just ignore it?

I made a test that applied the same role twice, and there wasn&#39;t any deep 
recursion warning. It seems that doing

  anything&#40;&#41; while 1;

is going to be a problem, right?

Can you come up with a failing test case?


-dave

/*============================================================
<span class="clickylink"><a target="new" rel="nofollow" href="http://VegGuide.org">http://VegGuide.org</a></span>               <span class="clickylink"><a target="new" rel="nofollow" href="http://blog.urth.org">http://blog.urth.org</a></span>
Your guide to all that&#39;s veg      House Absolute&#40;ly Pointless&#41;
============================================================*/
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;09&nbsp;17:26:25&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;10&nbsp;03:35:03&nbsp;2009</span>
    <span class="description">curtis_ovid_poe [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #43904] Forbid recursive runtime role application</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 10 Mar 2009 00:34:48 -0700 &#40;PDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Moose [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ovid &lt;curtis_ovid_poe [...] yahoo.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">----- Original Message ----

<div class="message-stanza open">&gt; From: &#34;autarch@urth.org via RT&#34; &lt;bug-Moose@rt.cpan.org&gt;
</div>
<div class="message-stanza open">&gt; On Fri, 6 Mar 2009, Curtis &#39;Ovid&#39; Poe via RT wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; Reapplying a role at runtime to an instance should probably be fatal &#40;I
&gt; &gt; think&#41;.
</div>&gt; 
&gt; Shouldn&#39;t it just ignore it?
</div>
Possibly it should just ignore it if it&#39;s applying the role directly on top of another application of the same role.  That would have stopped my error.  Otherwise, if you apply Serializeable::YAML, later apply Serializable::XML and then your code decides it wants Serialiable::YAML again and reapplies that, if you ignore the role application because it&#39;s already been applied, then you have the ordering problem that mixins and MI have &#40;last/first win respectively&#41;.  If you make the re-application fatal, then you forbid tricks like the YAML-&gt;XML-&gt;YAML swap &#40;which might be a good thing&#41;.

<div class="message-stanza open">&gt; I made a test that applied the same role twice, and there wasn&#39;t any deep 
&gt; recursion warning. It seems that doing
</div>
Right. It wouldn&#39;t do that.

<div class="message-stanza open">&gt;   anything&#40;&#41; while 1;
&gt; 
&gt; is going to be a problem, right?
&gt; 
&gt; Can you come up with a failing test case?
</div>
Do you mean &#34;write some tests&#34;?  Tough to do since I&#39;m unsure of what behavior is needed here.  If you mean a use case, I have one written up at <span class="clickylink"><a target="new" rel="nofollow" href="http://use.perl.org/~Ovid/journal/38618">http://use.perl.org/~Ovid/journal/38618</a></span> and explained above.  Otherwise, if you&#39;re just looking for code to demonstrate the error, the following self-contained script does that:

    {
        package MyRole;
        use Moose::Role;
    }
    {
        package Foo;
        use Moose;
        with &#39;MyRole&#39;;
    }
    my $foo   = Foo-&gt;new;
    my $count = 0;
    while &#40;1&#41; {
        print $count++, $/;
        MyRole-&gt;meta-&gt;apply&#40;$foo&#41;;
    }

That throws the warnings on my box after 98 applications.

I don&#39;t see any perfect solutions here, but one which I think can help things tremendously would be for Moose to detect this problem before Perl does and give clear warnings to help the programmer pin this down.  I think the programmer will understand why the repeated application is bad and, more imporantly, I wouldn&#39;t have spent hours puzzling over the cryptic error messages before finding this bug :&#41;

Cheers,
Ovid
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;14&nbsp;14:23:25&nbsp;2009</span>
    <span class="description">stevan.little [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ovid,

I don&#39;t see this as a bug, but more as an incorrect usage of the feature. You simply need to 
change your test case to check to see if the role has already been applied. For further 
justification can be found here -&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://use.perl.org/~Ovid/journal/38618">http://use.perl.org/~Ovid/journal/38618</a></span>

- Stevan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;14&nbsp;14:23:26&nbsp;2009</span>
    <span class="description">stevan.little [...] gmail.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;14&nbsp;14:23:27&nbsp;2009</span>
    <span class="description">stevan.little [...] gmail.com -  Given to STEVAN</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
