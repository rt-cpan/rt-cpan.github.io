<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #95272 for Audio-FindChunks: Test fails with bleadperl</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #95272 for Audio-FindChunks: Test fails with bleadperl</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Audio-FindChunks/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Audio-FindChunks/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Audio-FindChunks/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Audio-FindChunks/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Audio-FindChunks">Audio-FindChunks CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">95272</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Audio-FindChunks/Active/">Audio-FindChunks</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
SREZIC [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-3002-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.00    </td>
  </tr>
  <tr id="CF-3003-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;02&nbsp;08:01:53&nbsp;2014</span>
    <span class="description">SREZIC [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Test fails with bleadperl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On most systems with perl 5.19.x the test suite is failing. See <span class="clickylink"><a target="new" rel="nofollow" href="http://matrix.cpantesters.org/?dist=Audio-FindChunks">http://matrix.cpantesters.org/?dist=Audio-FindChunks</a></span> for an overview.

Maybe it&#39;s related to the malloc wrapper which is by default enabled for bleadperl, but this is just a gut feeling. 

Regards,
    Slaven
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;09&nbsp;15:17:17&nbsp;2014</span>
    <span class="description">ANDK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">FTR, FindChunks did get a BBC, namely <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.perl.org/rt3/Ticket/Display.html?id=115910">http://rt.perl.org/rt3/Ticket/Display.html?id=115910</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;09&nbsp;15:17:18&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;10&nbsp;00:00:13&nbsp;2014</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Mailing list Perl5 &lt;perl5-porters [...] perl.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95272] Test fails with bleadperl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 9 May 2014 20:59:53 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Andreas Koenig via RT &lt;bug-Audio-FindChunks [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[Cc&#39;ed to p5p, I hope]

On Fri, May 09, 2014 at 03:17:18PM -0400, Andreas Koenig via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Audio-FindChunks
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95272">https://rt.cpan.org/Ticket/Display.html?id=95272</a></span> &gt;
&gt; 
&gt; FTR, FindChunks did get a BBC, namely <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.perl.org/rt3/Ticket/Display.html?id=115910">http://rt.perl.org/rt3/Ticket/Display.html?id=115910</a></span>
</div>
Do not know what is a BBC…

Is there a document summarizing what one is NOT supposed to do with
the new COW scheme?  The things possible with older Perls, but not
with newer builds?  &#40;Based on the experience of “stitching” modules
not working with newer Perls…&#41;

BTW, with the edit of such a breaking power, I would make it a flag to
allocate **all** the PVs for SVs “unmanaged by Perl” &#40;with SvLen ==
0&#41;.  Then a module &#40;e.g., in PERL5OPTS&#41; might have set this flag to 1
in CHECK time, and one could run the usual test suite in this
environment…

Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;10&nbsp;14:31:10&nbsp;2014</span>
    <span class="description">andreas.koenig.7os6VVqR [...] franz.ak.mind.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Andreas Koenig via RT &lt;bug-Audio-FindChunks [...] rt.cpan.org&gt;, Mailing list Perl5 &lt;perl5-porters [...] perl.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95272] Test fails with bleadperl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 10 May 2014 20:30:51 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Andreas Koenig &lt;andreas.koenig.7os6VVqR [...] franz.ak.mind.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ilya Zakharevich &lt;nospam-abuse@ilyaz.org&gt; writes:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Do not know what is a BBC…
</div>
Hey, Ilya, this nowadays quite indispensable[0] acronym stands for
&#34;Bleadperl Breaks CPAN&#34;, which is usually manifesting in a bugreport and
the subject thereof contains the words &#39;Bleadperl&#39; and &#39;breaks&#39;. There&#39;s
of course also the verb to BBC which denotes the act of writing a BBC.

-- 
andreas

[0] we hardly ever use it, it&#39;s just in the weeks before a new perl
release that it sometimes slips into written documents.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;10&nbsp;14:47:52&nbsp;2014</span>
    <span class="description">fawaka [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Andreas Koenig via RT &lt;bug-Audio-FindChunks [...] rt.cpan.org&gt;,  Mailing list Perl5 &lt;perl5-porters [...] perl.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95272] Test fails with bleadperl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 10 May 2014 20:47:23 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Leon Timmermans &lt;fawaka [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat, May 10, 2014 at 5:59 AM, Ilya Zakharevich &lt;nospam-abuse@ilyaz.org&gt;wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Is there a document summarizing what one is NOT supposed to do with
&gt; the new COW scheme?  The things possible with older Perls, but not
&gt; with newer builds?  &#40;Based on the experience of “stitching” modules
&gt; not working with newer Perls…&#41;
&gt;
</div>
The new perlguts has a section on this, but it I&#39;m not sure it&#39;s advertised
elsewhere. sv_force_normal and sv_force_normal_flags are your friends.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; BTW, with the edit of such a breaking power, I would make it a flag to
&gt; allocate **all** the PVs for SVs “unmanaged by Perl” &#40;with SvLen ==
&gt; 0&#41;.  Then a module &#40;e.g., in PERL5OPTS&#41; might have set this flag to 1
&gt; in CHECK time, and one could run the usual test suite in this
&gt; environment…
</div>

I&#39;m not quite sure that you mean here.

Leon
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;10&nbsp;15:39:33&nbsp;2014</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Andreas Koenig via RT &lt;bug-Audio-FindChunks [...] rt.cpan.org&gt;, Mailing list Perl5 &lt;perl5-porters [...] perl.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95272] Test fails with bleadperl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 10 May 2014 12:39:16 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Leon Timmermans &lt;fawaka [...] gmail.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat, May 10, 2014 at 08:47:23PM +0200, Leon Timmermans wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The new perlguts has a section on this, but it I&#39;m not sure it&#39;s advertised
&gt; elsewhere. sv_force_normal and sv_force_normal_flags are your friends.
</div>
Aha, it is now easily findable via search.cpan.org, great!  Will have
a look at it…

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; BTW, with the edit of such a breaking power, I would make it a flag to
&gt; &gt; allocate **all** the PVs for SVs “unmanaged by Perl” &#40;with SvLen ==
&gt; &gt; 0&#41;.  Then a module &#40;e.g., in PERL5OPTS&#41; might have set this flag to 1
&gt; &gt; in CHECK time, and one could run the usual test suite in this
&gt; &gt; environment…
</div></div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m not quite sure that you mean here.
</div>
Yeah, must be more explicit.  I assume there is still a way to import
a “foreign” memory region into a Perl string; years ago you would do
it by setting SvLen to 0.  This was a signal to Perl guts so that they
should not freely relocate the region.

The opposite of this is how Perl deals with the strings for which Perl
allocates memory itself: one is free to realloc&#40;&#41; it etc.  Consider
this as “a default” Perl strategy of allocation.

I propose to make this strategy “a real default”, i.e., a choice of
many &#40;as opposed to a choice of one, as it is now — or at least was
long ago ;-&#41;.  Given that a certain flag is set, Perl would allocate
new PVs for SVs using the “foreign memory” model &#40;instead of “I can
reallocate it” model&#41;.

I do not see it useful in the world at large; however, it may be
useful for testing purposes:
  • Suppose that Perl test suite would grant PERL5OPTS &#40;I suspect that
    currently it disables PERL5OPTS&#41;; presume that it is
    PERLTEST5OPTS.
  • Suppose that there is a module which would raise the flag above at
    the CHECK{} time &#40;why so late?  just in case;  I suspect a few
    “standard” SVPVs may need to be allocated with the default
    policy&#41;; call it Devel::ForeignMemory.  
  • then
        env PERLTEST5OPTS=-MDevel::ForeignMemory=:set make test
    would test how Perl core is able to deal with the new allocation
    policy.

I expect that some test would break even without COW enabled.  But the
“new” failures correlated with COW would indicate possible problems
with COW.

Hope this helps,
Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;11&nbsp;15:19:23&nbsp;2014</span>
    <span class="description">fawaka [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Andreas Koenig via RT &lt;bug-Audio-FindChunks [...] rt.cpan.org&gt;,  Mailing list Perl5 &lt;perl5-porters [...] perl.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95272] Test fails with bleadperl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 11 May 2014 21:18:51 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Leon Timmermans &lt;fawaka [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space"> On Sat, May 10, 2014 at 9:39 PM, Ilya Zakharevich
&lt;nospam-abuse@ilyaz.org&gt;wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; BTW, with the edit of such a breaking power, I would make it a flag to
&gt; &gt; &gt; allocate **all** the PVs for SVs “unmanaged by Perl” &#40;with SvLen ==
&gt; &gt; &gt; 0&#41;.  Then a module &#40;e.g., in PERL5OPTS&#41; might have set this flag to 1
&gt; &gt; &gt; in CHECK time, and one could run the usual test suite in this
&gt; &gt; &gt; environment…
</div></div>&gt;
<div class="message-stanza open">&gt; &gt; I&#39;m not quite sure that you mean here.
</div>&gt;
&gt; Yeah, must be more explicit.  I assume there is still a way to import
&gt; a “foreign” memory region into a Perl string; years ago you would do
&gt; it by setting SvLen to 0.  This was a signal to Perl guts so that they
&gt; should not freely relocate the region.
&gt;
&gt; The opposite of this is how Perl deals with the strings for which Perl
&gt; allocates memory itself: one is free to realloc&#40;&#41; it etc.  Consider
&gt; this as “a default” Perl strategy of allocation.
&gt;
&gt; I propose to make this strategy “a real default”, i.e., a choice of
&gt; many &#40;as opposed to a choice of one, as it is now — or at least was
&gt; long ago ;-&#41;.  Given that a certain flag is set, Perl would allocate
&gt; new PVs for SVs using the “foreign memory” model &#40;instead of “I can
&gt; reallocate it” model&#41;.
&gt;
&gt; I do not see it useful in the world at large; however, it may be
&gt; useful for testing purposes:
&gt;   • Suppose that Perl test suite would grant PERL5OPTS &#40;I suspect that
&gt;     currently it disables PERL5OPTS&#41;; presume that it is
&gt;     PERLTEST5OPTS.
&gt;   • Suppose that there is a module which would raise the flag above at
&gt;     the CHECK{} time &#40;why so late?  just in case;  I suspect a few
&gt;     “standard” SVPVs may need to be allocated with the default
&gt;     policy&#41;; call it Devel::ForeignMemory.
&gt;   • then
&gt;         env PERLTEST5OPTS=-MDevel::ForeignMemory=:set make test
&gt;     would test how Perl core is able to deal with the new allocation
&gt;     policy.
&gt;
&gt; I expect that some test would break even without COW enabled.  But the
&gt; “new” failures correlated with COW would indicate possible problems
&gt; with COW.
&gt;
</div>
I suspect the PERL_DEBUG_READONLY_COW flag mentioned in perlguts is close
enough what you want, though with a completely different implementation: It
uses mmap + mprotect to turn logical violations of COW into segfaults.

 It could probably even be made to fix things up for you in a SEGV handler,
but that would be insane by most people&#39;s standards ;-&#41; &#40;and too slow to be
usable anyway&#41;

Leon
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;13&nbsp;21:44:05&nbsp;2014</span>
    <span class="description">TONYC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri May 02 08:01:53 2014, SREZIC wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On most systems with perl 5.19.x the test suite is failing. See
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://matrix.cpantesters.org/?dist=Audio-FindChunks">http://matrix.cpantesters.org/?dist=Audio-FindChunks</a></span> for an overview.
&gt; 
&gt; Maybe it&#39;s related to the malloc wrapper which is by default enabled
&gt; for bleadperl, but this is just a gut feeling.
</div>
The problem is that the code writes over its arguments without ensuring they&#39;re not COWed, so for example:

  above_thres_in_window =&gt; [sub { my $a = shift; my @r = $a-&gt;[0];  # Reserve space
                                  int_sum_window&#40;$a-&gt;[0], $r[0], shift, shift&#41;;
                            \@r}, &#39;above_thres&#39;, &#39;chunks&#39;, &#39;above_thres_window&#39;]

copies $a-&gt;[0] into $r[0], which with COW means that both $a-&gt;[0] and $r[0] share the same buffer, and when int_sum_window&#40;&#41; writes to $r[0]&#39;s buffer, it ends up writing over $a-&gt;[0] as well &#40;and any other SVs that share the same buffer.

I&#39;ve attached a patch that ensures that each output SV is not using a shared buffer, though it makes the XS a lot more verbose unfortunately.

Tony
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> FindChunks.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ru Audio-FindChunks-2.00-orig/FindChunks.xs Audio-FindChunks-2.00/FindChunks.xs
--- Audio-FindChunks-2.00-orig/FindChunks.xs	2008-04-08 19:58:00.000000000 +1000
+++ Audio-FindChunks-2.00/FindChunks.xs	2014-05-14 11:36:37.000000000 +1000
@@ -15,30 +15,55 @@
 PROTOTYPES: ENABLE
 
 long
-bool_find_runs&#40;input, output, cnt, out_cnt&#41;
+bool_find_runs&#40;input, output_sv, cnt, out_cnt&#41;
 	int *	input
-	array_run_t *	output
+	SV *	output_sv
 	long	cnt
 	long	out_cnt
-
+  PREINIT:
+	array_run_t *	output = &#40;array_run_t *&#41;SvPV_force_nolen&#40;output_sv&#41;;
+  CODE:
+        RETVAL = bool_find_runs&#40;input, output, cnt, out_cnt&#41;;
+  OUTPUT:
+        RETVAL
+	output_sv
+        
 void
-double_find_above&#40;input, output, cnt, threshold&#41;
+double_find_above&#40;input, output_sv, cnt, threshold&#41;
 	double *	input
-	int *	output
+	SV *	output_sv
 	long	cnt
 	double	threshold
+  PREINIT:
+	int *	output = &#40;int *&#41;SvPV_force_nolen&#40;output_sv&#41;;
+  CODE:
+	double_find_above&#40;input, output, cnt, threshold&#41;;
+  OUTPUT:
+        output_sv
 
 void
-double_median3&#40;rmsarray, medarray, total_blocks&#41;
+double_median3&#40;rmsarray, medarray_sv, total_blocks&#41;
 	double *	rmsarray
-	double *	medarray
+	SV *	medarray_sv
 	long	total_blocks
+  PREINIT:
+	double *	medarray = &#40;double *&#41;SvPV_force_nolen&#40;medarray_sv&#41;;
+  CODE:
+	double_median3&#40;rmsarray, medarray, total_blocks&#41;;
+  OUTPUT:
+        medarray_sv
 
 void
-double_sort&#40;input, output, cnt&#41;
+double_sort&#40;input, output_sv, cnt&#41;
 	double *	input
-	double *	output
+	SV *	output_sv
 	long	cnt
+  PREINIT:
+	double *	output = &#40;double *&#41;SvPV_force_nolen&#40;output_sv&#41;;
+  CODE:
+	double_sort&#40;input, output, cnt&#41;;
+  OUTPUT:
+        output_sv
 
 double
 double_sum&#40;input, off, cnt&#41;
@@ -47,25 +72,43 @@
 	long	cnt
 
 void
-int_find_above&#40;input, output, cnt, threshold&#41;
+int_find_above&#40;input, output_sv, cnt, threshold&#41;
 	int *	input
-	int *	output
+	SV *	output_sv
 	long	cnt
 	int	threshold
+  PREINIT:
+	int *	output = &#40;int *&#41;SvPV_force_nolen&#40;output_sv&#41;;
+  CODE:
+	int_find_above&#40;input, output, cnt, threshold&#41;;
+  OUTPUT:
+	output_sv
 
 void
-int_sum_window&#40;input, output, cnt, window_size&#41;
+int_sum_window&#40;input, output_sv, cnt, window_size&#41;
 	int *	input
-	int *	output
+	SV *	output_sv
 	long	cnt
 	int	window_size
+  PREINIT:
+	int *	output = &#40;int *&#41;SvPV_force_nolen&#40;output_sv&#41;;
+  CODE:
+	int_sum_window&#40;input, output, cnt, window_size&#41;;
+  OUTPUT:
+	output_sv
 
 void
-le_short_sample_stats&#40;buf, stride, samples, stat&#41;
+le_short_sample_stats&#40;buf, stride, samples, stat_sv&#41;
 	void_char *	buf
 	int	stride
 	long	samples
-	array_stats_t *	stat
+	SV *	stat_sv
+  PREINIT:
+	array_stats_t *	stat = &#40;array_stats_t *&#41;SvPV_force_nolen&#40;stat_sv&#41;;
+  CODE:
+	le_short_sample_stats&#40;buf, stride, samples, stat&#41;;
+  OUTPUT:
+	stat_sv
 
 int
 _s_size&#40;&#41;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;29&nbsp;03:29:25&nbsp;2014</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Mailing list Perl5 &lt;perl5-porters [...] perl.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95272] Test fails with bleadperl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 29 May 2014 00:29:10 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> TONYC via RT &lt;bug-Audio-FindChunks [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, May 13, 2014 at 09:44:06PM -0400, TONYC via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The problem is that the code writes over its arguments without ensuring they&#39;re not COWed, so for example:
&gt; 
&gt;   above_thres_in_window =&gt; [sub { my $a = shift; my @r = $a-&gt;[0];  # Reserve space
&gt;                                 int_sum_window&#40;$a-&gt;[0], $r[0], shift, shift&#41;;
&gt;                           \@r}, &#39;above_thres&#39;, &#39;chunks&#39;, &#39;above_thres_window&#39;]
&gt; 
&gt; copies $a-&gt;[0] into $r[0], which with COW means that both $a-&gt;[0] and $r[0] share the same buffer, and when int_sum_window&#40;&#41; writes to $r[0]&#39;s buffer, it ends up writing over $a-&gt;[0] as well &#40;and any other SVs that share the same buffer.
</div>
Note that int_sum_window&#40;&#41; does not access SV in any way.  The buffer
is given to it by typemap’s entry for
  int *
which is assigned to T_PV &#40;in the ./typemap file of the distribution&#41;.

Do you say that T_PV is now restricted for read-only access only?  If
so, where is it documented?  And what is a reason for such an
incompatible change?  And which typemap entry should one use for R/W
access?

I’m pretty sure that many CPAN modules use T_PV for R/W &#40;and for every
one where it is detected by the test suite, there are 20 where it is
not&#41;…

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve attached a patch that ensures that each output SV is not using a shared buffer, though it makes the XS a lot more verbose unfortunately.
&gt; 
&gt; Tony
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; diff -ru Audio-FindChunks-2.00-orig/FindChunks.xs Audio-FindChunks-2.00/FindChunks.xs
&gt; --- Audio-FindChunks-2.00-orig/FindChunks.xs  2008-04-08 19:58:00.000000000 +1000
&gt; +++ Audio-FindChunks-2.00/FindChunks.xs       2014-05-14 11:36:37.000000000 +1000
&gt; @@ -15,30 +15,55 @@
&gt;  PROTOTYPES: ENABLE
&gt;  
&gt;  long
&gt; -bool_find_runs&#40;input, output, cnt, out_cnt&#41;
&gt; +bool_find_runs&#40;input, output_sv, cnt, out_cnt&#41;
&gt;       int *   input
&gt; -     array_run_t *   output
&gt; +     SV *    output_sv
&gt;       long    cnt
&gt;       long    out_cnt
&gt; -
&gt; +  PREINIT:
&gt; +     array_run_t *   output = &#40;array_run_t *&#41;SvPV_force_nolen&#40;output_sv&#41;;
&gt; +  CODE:
&gt; +        RETVAL = bool_find_runs&#40;input, output, cnt, out_cnt&#41;;
&gt; +  OUTPUT:
&gt; +        RETVAL
&gt; +     output_sv
&gt; +        
</div>
I see no reason why this should be done in XS.  It should have been
done in the typemap — preferably, the Perl’s typemap, which knows the
idiosyncrasies of the current version of Perl.

Thanks,
Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;29&nbsp;20:23:39&nbsp;2014</span>
    <span class="description">tony [...] develop-help.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> TONYC via RT &lt;bug-Audio-FindChunks [...] rt.cpan.org&gt;, Mailing list Perl5 &lt;perl5-porters [...] perl.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95272] Test fails with bleadperl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 30 May 2014 10:23:03 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tony Cook &lt;tony [...] develop-help.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, May 29, 2014 at 12:29:10AM -0700, Ilya Zakharevich wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue, May 13, 2014 at 09:44:06PM -0400, TONYC via RT wrote:
<div class="message-stanza open">&gt; &gt; The problem is that the code writes over its arguments without ensuring they&#39;re not COWed, so for example:
&gt; &gt; 
&gt; &gt;   above_thres_in_window =&gt; [sub { my $a = shift; my @r = $a-&gt;[0];  # Reserve space
&gt; &gt;                               int_sum_window&#40;$a-&gt;[0], $r[0], shift, shift&#41;;
&gt; &gt;                         \@r}, &#39;above_thres&#39;, &#39;chunks&#39;, &#39;above_thres_window&#39;]
&gt; &gt; 
&gt; &gt; copies $a-&gt;[0] into $r[0], which with COW means that both $a-&gt;[0] and $r[0] share the same buffer, and when int_sum_window&#40;&#41; writes to $r[0]&#39;s buffer, it ends up writing over $a-&gt;[0] as well &#40;and any other SVs that share the same buffer.
</div>&gt; 
&gt; Note that int_sum_window&#40;&#41; does not access SV in any way.  The buffer
&gt; is given to it by typemap’s entry for
&gt;   int *
&gt; which is assigned to T_PV &#40;in the ./typemap file of the distribution&#41;.
&gt; 
&gt; Do you say that T_PV is now restricted for read-only access only?  If
&gt; so, where is it documented?  And what is a reason for such an
&gt; incompatible change?  And which typemap entry should one use for R/W
&gt; access?
&gt; 
&gt; I’m pretty sure that many CPAN modules use T_PV for R/W &#40;and for every
&gt; one where it is detected by the test suite, there are 20 where it is
&gt; not&#41;…
</div>
Using T_PV for write access has never been safe, consider what happens
if the caller supplies a reference, or undef, or a &#34;&#34; overloaded value.

If T_PV were modified to allowing writing to the value, it would need
to use SvPV_force&#40;&#41;, which modifies non-PV parameters, changing the
behaviour of any code that uses T_PV parameters for read-only.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I&#39;ve attached a patch that ensures that each output SV is not using a shared buffer, though it makes the XS a lot more verbose unfortunately.
&gt; &gt; 
&gt; &gt; Tony
</div>&gt; 
<div class="message-stanza open">&gt; &gt; diff -ru Audio-FindChunks-2.00-orig/FindChunks.xs Audio-FindChunks-2.00/FindChunks.xs
&gt; &gt; --- Audio-FindChunks-2.00-orig/FindChunks.xs        2008-04-08 19:58:00.000000000 +1000
&gt; &gt; +++ Audio-FindChunks-2.00/FindChunks.xs     2014-05-14 11:36:37.000000000 +1000
&gt; &gt; @@ -15,30 +15,55 @@
&gt; &gt;  PROTOTYPES: ENABLE
&gt; &gt;  
&gt; &gt;  long
&gt; &gt; -bool_find_runs&#40;input, output, cnt, out_cnt&#41;
&gt; &gt; +bool_find_runs&#40;input, output_sv, cnt, out_cnt&#41;
&gt; &gt;     int *   input
&gt; &gt; -   array_run_t *   output
&gt; &gt; +   SV *    output_sv
&gt; &gt;     long    cnt
&gt; &gt;     long    out_cnt
&gt; &gt; -
&gt; &gt; +  PREINIT:
&gt; &gt; +   array_run_t *   output = &#40;array_run_t *&#41;SvPV_force_nolen&#40;output_sv&#41;;
&gt; &gt; +  CODE:
&gt; &gt; +        RETVAL = bool_find_runs&#40;input, output, cnt, out_cnt&#41;;
&gt; &gt; +  OUTPUT:
&gt; &gt; +        RETVAL
&gt; &gt; +   output_sv
&gt; &gt; +        
</div>&gt; 
&gt; I see no reason why this should be done in XS.  It should have been
&gt; done in the typemap — preferably, the Perl’s typemap, which knows the
&gt; idiosyncrasies of the current version of Perl.
</div>
It could be done with a new typemap entry, and it was discussed, but
to be safe the typemap entry would need to know the output size, which
would mean a custom typemap.

Tony
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;30&nbsp;09:18:12&nbsp;2014</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> TONYC via RT &lt;bug-Audio-FindChunks [...] rt.cpan.org&gt;, Mailing list Perl5 &lt;perl5-porters [...] perl.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95272] Test fails with bleadperl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 30 May 2014 06:17:59 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Tony Cook &lt;tony [...] develop-help.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, May 30, 2014 at 10:23:03AM +1000, Tony Cook wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Note that int_sum_window&#40;&#41; does not access SV in any way.  The buffer
&gt; &gt; is given to it by typemap’s entry for
&gt; &gt;   int *
&gt; &gt; which is assigned to T_PV &#40;in the ./typemap file of the distribution&#41;.
&gt; &gt; 
&gt; &gt; Do you say that T_PV is now restricted for read-only access only?  If
&gt; &gt; so, where is it documented?  And what is a reason for such an
&gt; &gt; incompatible change?  And which typemap entry should one use for R/W
&gt; &gt; access?
&gt; &gt; 
&gt; &gt; I’m pretty sure that many CPAN modules use T_PV for R/W &#40;and for every
&gt; &gt; one where it is detected by the test suite, there are 20 where it is
&gt; &gt; not&#41;…
</div>&gt; 
&gt; Using T_PV for write access has never been safe, consider what happens
&gt; if the caller supplies a reference, or undef, or a &#34;&#34; overloaded value.
</div>
I do not see any problem there, except
  “So do not do this then”.
There IS a value in code which may be used only in controlled environment.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If T_PV were modified to allowing writing to the value,
</div>  ^^

There is no “if” here.  T_PV DOES allow writing to the value — or at
least WAS allowing it before 5.19 &#40;provided PV is there&#41;.  For backward
compatibility, it is very important that it continues to do so.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; it would need to use SvPV_force&#40;&#41;, which modifies non-PV parameters,
&gt; changing the behaviour of any code that uses T_PV parameters for
&gt; read-only.
</div>
This is wrong on so many counts, that I do not even know where to start…
First of all, you write that it cannot use SvPV_force&#40;&#41; without
breaking backward compatibility.  So why do you even mention SvPV_force&#40;&#41;?

AFAIU, __ALL__ the T_PV code should do is to disable COW state if it
is present.  This way, the damage done by upgrading to 5.19 is fixed.

-----------------------------

  BTW, I think there must be a way to make it easy for an XSUB to
  specify that it uses T_PV in read-only mode.  Something like

    #define T_PV_IS_READONLY 1

  near the start of XSUB.  Then T_PV-expansion could check for this,
  and generate code WITHOUT unlinking COW.

  This way:
    • extension may use T_PV, so be backward-compatible and future-proof;
    • extension may use benefits of COW.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; I&#39;ve attached a patch that ensures that each output SV is not using a shared buffer, though it makes the XS a lot more verbose unfortunately.
&gt; &gt; &gt; 
&gt; &gt; &gt; Tony
</div>&gt; &gt; 
<div class="message-stanza open">&gt; &gt; &gt; diff -ru Audio-FindChunks-2.00-orig/FindChunks.xs Audio-FindChunks-2.00/FindChunks.xs
&gt; &gt; &gt; --- Audio-FindChunks-2.00-orig/FindChunks.xs      2008-04-08 19:58:00.000000000 +1000
&gt; &gt; &gt; +++ Audio-FindChunks-2.00/FindChunks.xs   2014-05-14 11:36:37.000000000 +1000
&gt; &gt; &gt; @@ -15,30 +15,55 @@
&gt; &gt; &gt;  PROTOTYPES: ENABLE
&gt; &gt; &gt;  
&gt; &gt; &gt;  long
&gt; &gt; &gt; -bool_find_runs&#40;input, output, cnt, out_cnt&#41;
&gt; &gt; &gt; +bool_find_runs&#40;input, output_sv, cnt, out_cnt&#41;
&gt; &gt; &gt;   int *   input
&gt; &gt; &gt; - array_run_t *   output
&gt; &gt; &gt; + SV *    output_sv
&gt; &gt; &gt;   long    cnt
&gt; &gt; &gt;   long    out_cnt
&gt; &gt; &gt; -
&gt; &gt; &gt; +  PREINIT:
&gt; &gt; &gt; + array_run_t *   output = &#40;array_run_t *&#41;SvPV_force_nolen&#40;output_sv&#41;;
&gt; &gt; &gt; +  CODE:
&gt; &gt; &gt; +        RETVAL = bool_find_runs&#40;input, output, cnt, out_cnt&#41;;
&gt; &gt; &gt; +  OUTPUT:
&gt; &gt; &gt; +        RETVAL
&gt; &gt; &gt; + output_sv
&gt; &gt; &gt; +        
</div>&gt; &gt; 
&gt; &gt; I see no reason why this should be done in XS.  It should have been
&gt; &gt; done in the typemap — preferably, the Perl’s typemap, which knows the
&gt; &gt; idiosyncrasies of the current version of Perl.
</div>&gt; 
&gt; It could be done with a new typemap entry, and it was discussed, but
&gt; to be safe the typemap entry would need to know the output size, which
&gt; would mean a custom typemap.
</div>
It DID NOT need to know the output size before.  So it should not need
it now… 

Yours,
Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;31&nbsp;05:50:29&nbsp;2014</span>
    <span class="description">demerphq [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Tony Cook &lt;tony [...] develop-help.com&gt;, TONYC via RT &lt;bug-Audio-FindChunks [...] rt.cpan.org&gt;,  Mailing list Perl5 &lt;perl5-porters [...] perl.org&gt;, Ricardo Signes &lt;rjbs [...] manxome.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95272] Test fails with bleadperl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 31 May 2014 11:50:17 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> demerphq &lt;demerphq [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Friday, 30 May 2014, Ilya Zakharevich &lt;nospam-abuse@ilyaz.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri, May 30, 2014 at 10:23:03AM +1000, Tony Cook wrote:
<div class="message-stanza open"><div class="message-stanza open">&gt;&gt; &gt; Note that int_sum_window&#40;&#41; does not access SV in any way.  The buffer
&gt;&gt; &gt; is given to it by typemap’s entry for
&gt;&gt; &gt;   int *
&gt;&gt; &gt; which is assigned to T_PV &#40;in the ./typemap file of the distribution&#41;.
&gt;&gt; &gt;
&gt;&gt; &gt; Do you say that T_PV is now restricted for read-only access only?  If
&gt;&gt; &gt; so, where is it documented?  And what is a reason for such an
&gt;&gt; &gt; incompatible change?  And which typemap entry should one use for R/W
&gt;&gt; &gt; access?
&gt;&gt; &gt;
&gt;&gt; &gt; I’m pretty sure that many CPAN modules use T_PV for R/W &#40;and for every
&gt;&gt; &gt; one where it is detected by the test suite, there are 20 where it is
&gt;&gt; &gt; not&#41;…
</div>&gt;&gt;
&gt;&gt; Using T_PV for write access has never been safe, consider what happens
&gt;&gt; if the caller supplies a reference, or undef, or a &#34;&#34; overloaded value.
</div>&gt;
&gt; I do not see any problem there, except
&gt;   “So do not do this then”.
&gt; There IS a value in code which may be used only in controlled environment.
&gt;
<div class="message-stanza open">&gt;&gt; If T_PV were modified to allowing writing to the value,
</div>&gt;   ^^
&gt;
&gt; There is no “if” here.  T_PV DOES allow writing to the value — or at
&gt; least WAS allowing it before 5.19 &#40;provided PV is there&#41;.  For backward
&gt; compatibility, it is very important that it continues to do so.
&gt;
<div class="message-stanza open">&gt;&gt; it would need to use SvPV_force&#40;&#41;, which modifies non-PV parameters,
&gt;&gt; changing the behaviour of any code that uses T_PV parameters for
&gt;&gt; read-only.
</div>&gt;
&gt; This is wrong on so many counts, that I do not even know where to start…
&gt; First of all, you write that it cannot use SvPV_force&#40;&#41; without
&gt; breaking backward compatibility.  So why do you even mention SvPV_force&#40;&#41;?
&gt;
&gt; AFAIU, __ALL__ the T_PV code should do is to disable COW state if it
&gt; is present.  This way, the damage done by upgrading to 5.19 is fixed.
</div>
I think ilya is right here. We broke back compat and instead of admitting
it we hide behind unconvincing language lawyering to try to pretend we
didnt. This is exactly why people complain we don&#39;t care about backward
compatibility.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; -----------------------------
&gt;
&gt;   BTW, I think there must be a way to make it easy for an XSUB to
&gt;   specify that it uses T_PV in read-only mode.  Something like
&gt;
&gt;     #define T_PV_IS_READONLY 1
&gt;
&gt;   near the start of XSUB.  Then T_PV-expansion could check for this,
&gt;   and generate code WITHOUT unlinking COW.
&gt;
&gt;   This way:
&gt;     • extension may use T_PV, so be backward-compatible and future-proof;
&gt;     • extension may use benefits of COW.
&gt;
<div class="message-stanza open">&gt;&gt; &gt; &gt; I&#39;ve attached a patch that ensures that each output SV is not using
</div></div>a shared buffer, though it makes the XS a lot more verbose unfortunately.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt;&gt; &gt; &gt;
&gt;&gt; &gt; &gt; Tony
</div>&gt;&gt; &gt;
<div class="message-stanza open">&gt;&gt; &gt; &gt; diff -ru Audio-FindChunks-2.00-orig/FindChunks.xs
</div></div></div>Audio-FindChunks-2.00/FindChunks.xs
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; &gt; &gt; --- Audio-FindChunks-2.00-orig/FindChunks.xs      2008-04-08
</div></div>19:58:00.000000000 +1000
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; &gt; &gt; +++ Audio-FindChunks-2.00/FindChunks.xs   2014-05-14
</div></div>11:36:37.000000000 +1000
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; &gt; &gt; @@ -15,30 +15,55 @@
&gt;&gt; &gt; &gt;  PROTOTYPES: ENABLE
&gt;&gt; &gt; &gt;
&gt;&gt; &gt; &gt;  long
&gt;&gt; &gt; &gt; -bool_find_runs&#40;input, output, cnt, out_cnt&#41;
&gt;&gt; &gt; &gt; +bool_find_runs&#40;input, output_sv, cnt, out_cnt&#41;
&gt;&gt; &gt; &gt;   int *   input
&gt;&gt; &gt; &gt; - array_run_t *   output
&gt;&gt; &gt; &gt; + SV *    output_sv
&gt;&gt; &gt; &gt;   long    cnt
&gt;&gt; &gt; &gt;   long    out_cnt
&gt;&gt; &gt; &gt; -
&gt;&gt; &gt; &gt; +  PREINIT:
&gt;&gt; &gt; &gt; + array_run_t *   output = &#40;array_run_t
</div></div>*&#41;SvPV_force_nolen&#40;output_sv&#41;;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open"><div class="message-stanza open">&gt;&gt; &gt; &gt; +  CODE:
&gt;&gt; &gt; &gt; +        RETVAL = bool_find_runs&#40;input, output, cnt, out_cnt&#41;;
&gt;&gt; &gt; &gt; +  OUTPUT:
&gt;&gt; &gt; &gt; +        RETVAL
&gt;&gt; &gt; &gt; + output_sv
&gt;&gt; &gt; &gt; +
</div>&gt;&gt; &gt;
&gt;&gt; &gt; I see no reason why this should be done in XS.  It should have been
&gt;&gt; &gt; done in the typemap — preferably, the Perl’s typemap, which knows the
&gt;&gt; &gt; idiosyncrasies of the current version of Perl.
</div>&gt;&gt;
&gt;&gt; It could be done with a new typemap entry, and it was discussed, but
&gt;&gt; to be safe the typemap entry would need to know the output size, which
&gt;&gt; would mean a custom typemap.
</div>&gt;
&gt; It DID NOT need to know the output size before.  So it should not need
&gt; it now…
</div>
Again i think ilya is right. We broke back compat and we did it in a
dangerous way &#40;changing the meaning of the RO flag&#41; and then we blamed xs
authors for &#34;doing it wrong in the first place&#34; while completely ignoring
there was no documented wrong or right for them to follow. Specifically I
challenge anyone arguing this to find a single doc that says that svpv args
to xs are readonly. Dont waste too much time onit as it doesnt exist.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Yours,
&gt; Ilya
&gt;
</div>
-- 
perl -Mre=debug -e &#34;/just|another|perl|hacker/&#34;
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;01&nbsp;16:52:24&nbsp;2014</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Tony Cook &lt;tony [...] develop-help.com&gt;, TONYC via RT &lt;bug-Audio-FindChunks [...] rt.cpan.org&gt;, Mailing list Perl5 &lt;perl5-porters [...] perl.org&gt;, Ricardo Signes &lt;rjbs [...] manxome.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95272] Test fails with bleadperl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 1 Jun 2014 13:52:10 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> demerphq &lt;demerphq [...] gmail.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat, May 31, 2014 at 11:50:17AM +0200, demerphq wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt; &gt; I see no reason why this should be done in XS.  It should have been
&gt; &gt;&gt; &gt; done in the typemap — preferably, the Perl’s typemap, which knows the
&gt; &gt;&gt; &gt; idiosyncrasies of the current version of Perl.
</div>&gt; &gt;&gt;
&gt; &gt;&gt; It could be done with a new typemap entry, and it was discussed, but
&gt; &gt;&gt; to be safe the typemap entry would need to know the output size, which
&gt; &gt;&gt; would mean a custom typemap.
</div>&gt; &gt;
&gt; &gt; It DID NOT need to know the output size before.  So it should not need
&gt; &gt; it now…
</div>&gt; 
&gt; Again i think ilya is right. We broke back compat and we did it in a
&gt; dangerous way &#40;changing the meaning of the RO flag&#41; and then we blamed xs
&gt; authors for &#34;doing it wrong in the first place&#34; while completely ignoring
&gt; there was no documented wrong or right for them to follow. Specifically I
&gt; challenge anyone arguing this to find a single doc that says that svpv args
&gt; to xs are readonly. Dont waste too much time onit as it doesnt exist.
</div>
I want to make a couple of remarks.

  • First, I do not want to be as legalistic as that.  Perl is &#40;uniquely&#41; 
    gifted to have a wonderfully useful documentation — so useful, that one 
    can utilize it standalone, without side communication channels &#40;Usenet,
    books, googling, etc&#41;.
    
    However, one should not forget that most other software packages are
    not up to this standard — so people ARE used to be needing side
    communication channels.  And on such channels, my usage of T_PV
    ***would*** be frowned upon.
    
    So in some ways, I was more or less consciously going against the flow
    by literally following “what is possible to do” &#40;and maybe it is
    my usage of these non-features which FORCED them not being documented
    as non-supported!&#41;.
    
    In short: the fact that the documentation does not prohibit this
    usage should be taken with a certain grain of salt.
    
  • Why go against the flow?  I believe that it IS crucial to have 
    quick-and-dirty ways to program XSUBs “the C way”.  Use PVs as 
    windows-into-computer-memory etc.
    
    On one hand, it is important as a &#40;semi-&#41;automatic way to import C 
    libraries.  On the other hand, it is also important standalone: for 
    Audio::FindChunks, I did not start with a C library; it is a complete
    Perl+XSUB rewrite of &#40;an undocumented&#41; C code.
    
    Doing this “in a protective, Perl-core-like way” would not only 
    increase the development time dramatically; it would also be completely
    useless since the chance that these XSUBs are going to used by anything
    but the companion Perl subs is close to nil.  And I should not explain
    why moving the “protect from misuses” logic from XSUB into Perl decreases
    complexity a lot.
    
    Writing XSUBs in a Perl-core-way, when it is impossible to crash the
    interpreter no matter what you through at these XSUBs ***has*** its
    advantages.  My point is that these advantages are not universal, and
    in many &#40;most?&#41; situations such level of “correctness” is excessive.
    
  • After the patch by TonyC arrived, for me it would be much easier to
    patch the distribution than to continue this discussion.  I had chosen
    to continue since I think the current p5p approach to the problem
    is very wrong.
    
    I was very lucky with Audio::FindChunks so that in a few hours, I could 
    write a test suite which tests the functionality more or less completely.
    For a lot of my modules, the test suite is an empty shell: it basically
    checks that the module loads, and nothing else.  And the reason for
    this is that writing a test suite is out of question: the mode of usage
    and amount of dependencies on the environment make the task of automating
    the testing unfeasible.
    
    I would not be surprised if the ratio of 
       well-auto-tested/not-auto-tested-at-all
    modules on CPAN were 1/20.  Taking into account that the failures
    resulting from COW-not-being-triggered are ABSOLUTELY impossible to
    debug &#40;unless you know in advance that they are due to COW&#41;, this would
    put the developers into a quite an ugly corner.  In addition, on CPAN
    the failures may be happening on remote machines only, the people 
    observing the failures may have communication problems etc.: this hurdles
    make it very hard to debug even the stuff which would be fixed immediately
    when it happens locally.
    
    In short: COW-failures + CPAN could make any developer suicidal.  One should
    cut every corner trying to bend in direction of simplifying life of CPAN
    developers in this regard.

Thanks for your patience,
Ilya
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
