<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #83200 for Sphinx-Manager: Running under mod_perl inherits apache listening ports</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #83200 for Sphinx-Manager: Running under mod_perl inherits apache listening ports</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Sphinx-Manager/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Sphinx-Manager/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Sphinx-Manager/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Sphinx-Manager/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Sphinx-Manager">Sphinx-Manager CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">83200</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Sphinx-Manager/Active/">Sphinx-Manager</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
tlyons [...] ivenue.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-223108-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.06    </td>
  </tr>
  <tr id="CF-223109-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;07&nbsp;15:53:33&nbsp;2013</span>
    <span class="description">tlyons [...] ivenue.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Running under mod_perl inherits apache listening ports</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">A programmer used this module to detect absence of and start searchd
from inside of Apache &#40;mod_perl with Catalyst and RoseDB&#41;.  When this
occurs, the process tree looks like this:

        ├─searchd&#40;31838&#41;───searchd&#40;31839&#41;─┬─{searchd}&#40;31840&#41;
        │                                 ├─{searchd}&#40;31841&#41;
        │                                 └─{searchd}&#40;31842&#41;

KVM-CentOS58[root@ivwww41 script]# lsof -P -p 31838 | grep LISTEN; echo;
lsof -P -p 31839 | grep LISTEN
searchd 31838  www    4u  IPv6 852945      0t0     TCP *:81 &#40;LISTEN&#41;
searchd 31838  www    6u  IPv6 852950      0t0     TCP *:86 &#40;LISTEN&#41;
searchd 31838  www    8u  IPv6 852955      0t0     TCP *:444 &#40;LISTEN&#41;
searchd 31838  www   10u  IPv6 852960      0t0     TCP *:88 &#40;LISTEN&#41;

searchd 31839  www    4u  IPv6 852945      0t0      TCP *:81 &#40;LISTEN&#41;
searchd 31839  www    6u  IPv6 852950      0t0      TCP *:86 &#40;LISTEN&#41;
searchd 31839  www    8u  IPv6 852955      0t0      TCP *:444 &#40;LISTEN&#41;
searchd 31839  www   10u  IPv6 852960      0t0      TCP *:88 &#40;LISTEN&#41;
searchd 31839  www   24u  IPv4 853632      0t0      TCP *:9312 &#40;LISTEN&#41;
searchd 31839  www   25u  IPv4 853633      0t0      TCP *:9306 &#40;LISTEN&#41;

The parent process never dies, so when you restart apache, it kills all
the running httpd processes leaving this process as the primary listener
on those ports, preventing apache from starting back up.

Stopping httpd:                                            [  OK  ]
Starting httpd: &#40;98&#41;Address already in use: make_sock: could not bind to
address [::]:81
&#40;98&#41;Address already in use: make_sock: could not bind to address 0.0.0.0:81
no listening sockets available, shutting down
Unable to open logs

Suggestion is to detect and unbind any listening ports before the first
fork, or maybe between the two forks.  I am not sure which is more
correct &#40;if at all&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;08&nbsp;01:10:19&nbsp;2013</span>
    <span class="description">jon.schutz [...] youramigo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #83200] Running under mod_perl inherits apache listening ports</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 08 Feb 2013 16:40:01 +1030</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sphinx-Manager [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jon Schutz &lt;jon.schutz [...] youramigo.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On 08/02/13 07:23, Todd Lyons via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thu Feb 07 15:53:33 2013: Request 83200 was acted upon.
&gt; Transaction: Ticket created by mrballcb
&gt;        Queue: Sphinx-Manager
&gt;      Subject: Running under mod_perl inherits apache listening ports
&gt;    Broken in: 0.06
&gt;     Severity: Important
&gt;        Owner: Nobody
&gt;   Requestors: tlyons@ivenue.com
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=83200">https://rt.cpan.org/Ticket/Display.html?id=83200</a></span> &gt;
&gt;
&gt;
&gt; A programmer used this module to detect absence of and start searchd
&gt; from inside of Apache &#40;mod_perl with Catalyst and RoseDB&#41;.  When this
&gt; occurs, the process tree looks like this:
&gt;
&gt;         ├─searchd&#40;31838&#41;───searchd&#40;31839&#41;─┬─{searchd}&#40;31840&#41;
&gt;         │                                 ├─{searchd}&#40;31841&#41;
&gt;         │                                 └─{searchd}&#40;31842&#41;
&gt;
&gt; KVM-CentOS58[root@ivwww41 script]# lsof -P -p 31838 | grep LISTEN; echo;
&gt; lsof -P -p 31839 | grep LISTEN
&gt; searchd 31838  www    4u  IPv6 852945      0t0     TCP *:81 &#40;LISTEN&#41;
&gt; searchd 31838  www    6u  IPv6 852950      0t0     TCP *:86 &#40;LISTEN&#41;
&gt; searchd 31838  www    8u  IPv6 852955      0t0     TCP *:444 &#40;LISTEN&#41;
&gt; searchd 31838  www   10u  IPv6 852960      0t0     TCP *:88 &#40;LISTEN&#41;
&gt;
&gt; searchd 31839  www    4u  IPv6 852945      0t0      TCP *:81 &#40;LISTEN&#41;
&gt; searchd 31839  www    6u  IPv6 852950      0t0      TCP *:86 &#40;LISTEN&#41;
&gt; searchd 31839  www    8u  IPv6 852955      0t0      TCP *:444 &#40;LISTEN&#41;
&gt; searchd 31839  www   10u  IPv6 852960      0t0      TCP *:88 &#40;LISTEN&#41;
&gt; searchd 31839  www   24u  IPv4 853632      0t0      TCP *:9312 &#40;LISTEN&#41;
&gt; searchd 31839  www   25u  IPv4 853633      0t0      TCP *:9306 &#40;LISTEN&#41;
&gt;
&gt; The parent process never dies, so when you restart apache, it kills all
&gt; the running httpd processes leaving this process as the primary listener
&gt; on those ports, preventing apache from starting back up.
&gt;
&gt; Stopping httpd:                                            [  OK  ]
&gt; Starting httpd: &#40;98&#41;Address already in use: make_sock: could not bind to
&gt; address [::]:81
&gt; &#40;98&#41;Address already in use: make_sock: could not bind to address 0.0.0.0:81
&gt; no listening sockets available, shutting down
&gt; Unable to open logs
&gt;
&gt; Suggestion is to detect and unbind any listening ports before the first
&gt; fork, or maybe between the two forks.  I am not sure which is more
&gt; correct &#40;if at all&#41;.
</div>
Hi Todd,

Please find an experimental version attached.  It should work
out-of-the-box but you can customise the behaviour using the
pre_exec_callback if you wish &#40;see docs&#41;.  I don&#39;t have a mod_perl setup
to test with, so let me know if this solves your problem, then I will
release to cpan.

-- 
Jon Schutz
CTO, YourAmigo Ltd
53 Gilbert St
Adelaide SA 5000
Ph:  +61 8 82119211
Fax: +61 8 8211 6356
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.youramigo.com">http://www.youramigo.com</a></span>
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;08&nbsp;01:10:20&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;09&nbsp;13:54:56&nbsp;2013</span>
    <span class="description">tlyons [...] ivenue.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> tlyons [...] ivenue.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Feb 08 01:10:19 2013, jon.schutz@youramigo.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Hi Todd,
&gt; 
&gt; Please find an experimental version attached.  It should work
&gt; out-of-the-box but you can customise the behaviour using the
&gt; pre_exec_callback if you wish &#40;see docs&#41;.  I don&#39;t have a mod_perl
&gt; setup to test with, so let me know if this solves your problem,
&gt; then I will release to cpan.
</div>
We were unable to test it.  We are running this on CentOS 5.8, which
uses perl 5.8.8.  This new module seemed to want POSIX::1003::Symbols,
which we don&#39;t have available.  Instead, we are going to just change our
method of invocation.  Rather than forking from inside of mod_perl, we
are going to have a standalone service running in a separate VM.  My
apologies for being unable to test it, but we greatly appreciate the
rapid response!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;10&nbsp;04:48:27&nbsp;2013</span>
    <span class="description">jon.schutz [...] youramigo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #83200] Running under mod_perl inherits apache listening ports</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 10 Feb 2013 20:18:07 +1030</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sphinx-Manager [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jon Schutz &lt;jon.schutz [...] youramigo.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On 10/02/13 05:24, Todd Lyons via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Sphinx-Manager
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=83200">https://rt.cpan.org/Ticket/Display.html?id=83200</a></span> &gt;
&gt;
&gt; On Fri Feb 08 01:10:19 2013, jon.schutz@youramigo.com wrote:
<div class="message-stanza open">&gt;&gt; Hi Todd,
&gt;&gt;
&gt;&gt; Please find an experimental version attached.  It should work
&gt;&gt; out-of-the-box but you can customise the behaviour using the
&gt;&gt; pre_exec_callback if you wish &#40;see docs&#41;.  I don&#39;t have a mod_perl
&gt;&gt; setup to test with, so let me know if this solves your problem,
&gt;&gt; then I will release to cpan.
</div>&gt; We were unable to test it.  We are running this on CentOS 5.8, which
&gt; uses perl 5.8.8.  This new module seemed to want POSIX::1003::Symbols,
&gt; which we don&#39;t have available.  Instead, we are going to just change our
&gt; method of invocation.  Rather than forking from inside of mod_perl, we
&gt; are going to have a standalone service running in a separate VM.  My
&gt; apologies for being unable to test it, but we greatly appreciate the
&gt; rapid response!
</div>
Hi Todd,

Seems plain old POSIX works just as well, so I have updated the patch to
work with 5.8.8 in case it is still useful to you.

Regards,

-- 
Jon Schutz
CTO, YourAmigo Ltd
53 Gilbert St
Adelaide SA 5000
Ph:  +61 8 82119211
Fax: +61 8 8211 6356
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.youramigo.com">http://www.youramigo.com</a></span>
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
