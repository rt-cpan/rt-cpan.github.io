<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #26318 for XML-LibXML: Improve $doc-&gt;toString&#40;&#41; to encode document correctly</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #26318 for XML-LibXML: Improve $doc-&gt;toString&#40;&#41; to encode document correctly</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=XML-LibXML">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=XML-LibXML">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=XML-LibXML">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=XML-LibXML">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-LibXML">XML-LibXML CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">26318</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=XML-LibXML">XML-LibXML</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
alankila [...] elma.fi

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-37350-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-37351-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=26318">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-309240" href="/Public/Bug/Display.html?id=26318#txn-309240">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;13&nbsp;07:01:45&nbsp;2007</span>
    <span class="description">alankila [...] elma.fi -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Improve $doc-&gt;toString&#40;&#41; to encode document correctly</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/309240/140599/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/140599">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 5.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The current implementation of toString&#40;&#41; leaves the document in perl&#39;s
internal unicode encoding in many cases. This is difficult to fix,
because people likely do not know how to fix the problem, and resort to
random hacks that seem to work, but could be wrong.

For instance, the simple task of printing many documents to STDOUT tends
to invoke &#34;wide character in print&#34; warnings, and the end result that
goes to STDOUT might be corrupt XML.

Use of &#34;toFH&#40;\*STDOUT&#41;&#34; somewhat works around this issue, but it&#39;s not
convenient when you aren&#39;t actually writing to a file, but need the
document as string, maybe to pass to other XML-expecting APIs, or
something. Or maybe you are implementing XML-DSig and need to calculate
SHA-1 hashes of documents. &#40;I know that you most often do
canonicalization on the XML-DSig, and this fixes the encoding to UTF-8,
but this is not always true.&#41;

My argument is however, that this must work just like toFH&#40;\*STDOUT&#41; works:

    print STDOUT $xml-&gt;toString&#40;&#41;

The solution appears to be something along the lines that if the
document that comes out has perl&#39;s unicode flag set, then you must
Encode::encode&#40;&#41; it to UTF-8. I am not 100 % sure of the correctness of
the solution, but it appears to do the right thing. For instance, if
ISO-8859-15 is used to describe a document with euro, then the result
has UTF-8 flag off &#40;looks like it is ISO-8859-1&#41;, and the character a4
is put where Euro symbol should be, making Perl replace it with ? as it
attempts to convert iso-8859-1 \xa4 to iso-8859-15 equivalent, which
does not exist:

use Encode;
use XML::LibXML;
my $x = XML::LibXML-&gt;new-&gt;parse_string&#40;&#34;&lt;?xml version=\&#34;1.0\&#34;
encoding=\&#34;ISO-8859-15\&#34;?&gt;&lt;x&gt;\xa4&lt;/x&gt;&#34;&#41;;
print Encode::encode&#40;&#34;ISO-8859-15&#34;, $x-&gt;toString&#41;;

and the output is:

&lt;?xml version=&#34;1.0&#34; encoding=&#34;ISO-8859-15&#34;?&gt;
&lt;x&gt;?&lt;/x&gt;

Now, let&#39;s try the same with UTF-8:

my $x = XML::LibXML-&gt;new-&gt;parse_string&#40;&#34;&lt;?xml version=\&#34;1.0\&#34;
encoding=\&#34;UTF-8\&#34;?&gt;&lt;x&gt;\xe2\x82\xac&lt;/x&gt;&#34;&#41;;
print Encode::encode&#40;&#34;ISO-8859-15&#34;, $x-&gt;toString&#41;;

Outputs:

&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;x&gt;â‚¬&lt;/x&gt;

Ugh! Perl sees the euro symbol as a single character, instead of the
original sequence of 3 octets! What this means is that to correctly
stringify this document UTF-8 encoding needs to be performed when the
string has Encode::is_utf8&#40;&#41; on. Or in other words, turning the Unicode
flag off &#34;fixes&#34; it so that we work the same way regardless what the
original encoding of the document is!

Why this works is that Encoding::is_utf8 apparently stays off as long as
the characters put into the document have char values less than 256.
This means that regardless of document content, it all gets written the
same way to regular, encoding-unaware filehandles.

When the higher characters are present in the stream, then the flag
somehow gets turned on, and chaos ensues because the fact that document
contains these high characters now require a different treatment!!!
Corrupt documents may result. Warnings about prints of wide characters
occur. This is no good at all.


There are more small issues: sometimes $doc-&gt;getEncoding is not defined,
which basically means that XML version is 1.0 and encoding is UTF-8.
&#40;According to documentation and XML specification.&#41; However, when
outputting, UTF-8 is not assumed.

Without encoding declaration:

print XML::LibXML-&gt;new-&gt;parse_string&#40;&#34;&lt;x&gt;\xe2\x82\xac&lt;/x&gt;&#34;&#41;-&gt;toString&#39; 
                                    
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;x&gt;&#38;#x20AC;&lt;/x&gt;

I do think that getEncoding&#40;&#41; should probably still return UTF-8,
because formally this is true for a prologless XML file, and also for
XML file that misses encoding information.

I realize the method was probably meant as an accessor, to find out what
the value in &#34;encoding&#34; field is, but if we aren&#39;t concerned about text
representation of XML, we don&#39;t really care what was in the original
file, we care about what the file&#39;s content interpreted as XML _mean_.
So I do not like the fact that XML::LibXML pretends that there is &#34;no&#34;
encoding, because text strings always are in some encoding, and UTF-8 is
assumed according to the XML spec. And this is clearly what it is doing.

My take on this is that XML::LibXML should either put prolog there and
declare encoding as UTF-8 honestly, or just return UTF-8 from
getEncoding&#40;&#41; and omit the prolog. Either way, it now says that there is
no encoding &#40;this is impossible, the fact it doesn&#39;t appear in prolog is
irrelevant&#41;, and it changes the document by adding the prolog when input
did not actually have a prolog! So this is quite possibly the worst
possible way to treat it.


I wonder if the document piece saying that &#34;$doc-&gt;setEncoding&#40;&#41; is
unsafe&#34; is true any more. Maybe it depends on libxml2 version? It would
appear that XML::LibXML performs character reference substitutions as
appropriate, and everything works just fine as I&#39;m testing it.

Let&#39;s just fix this mess so that toString&#40;&#41; properly encodes the
document to UTF-8 when the unicode bit is on and hands out octets. Let
us remove the mention about setEncoding&#40;&#41; being unsafe, because it seems
perfectly safe. And getEncoding&#40;&#41; should return UTF-8, never undef, and
the missing prolog problem could be handled by always adding a prolog to
output and explicitly choosing UTF-8 encoding for the document, which is
what XML standard implies the document&#39;s content is.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-309429" href="/Public/Bug/Display.html?id=26318#txn-309429">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;13&nbsp;17:31:03&nbsp;2007</span>
    <span class="description">pajas [...] matfyz.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/309429/140699/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/140699">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 5.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Friday 13 April 2007, Antti S. Lankila via RT wrote:
...
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The solution appears to be something along the lines that if the
&gt; document that comes out has perl&#39;s unicode flag set, then you must
&gt; Encode::encode&#40;&#41; it to UTF-8. I am not 100 % sure of the correctness 
</div>of 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; the solution, but it appears to do the right thing. For instance, if
&gt; ISO-8859-15 is used to describe a document with euro, then the result
&gt; has UTF-8 flag off &#40;looks like it is ISO-8859-1&#41;, and the character 
</div>a4
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; is put where Euro symbol should be, making Perl replace it with ? as 
</div>it
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; attempts to convert iso-8859-1 \xa4 to iso-8859-15 equivalent, which
&gt; does not exist:
&gt;
&gt; use Encode;
&gt; use XML::LibXML;
&gt; my $x = XML::LibXML-&gt;new-&gt;parse_string&#40;&#34;&lt;?xml version=\&#34;1.0\&#34;
&gt; encoding=\&#34;ISO-8859-15\&#34;?&gt;&lt;x&gt;\xa4&lt;/x&gt;&#34;&#41;;
&gt; print Encode::encode&#40;&#34;ISO-8859-15&#34;, $x-&gt;toString&#41;;
&gt;
&gt; and the output is:
&gt;
&gt; &lt;?xml version=&#34;1.0&#34; encoding=&#34;ISO-8859-15&#34;?&gt;
&gt; &lt;x&gt;?&lt;/x&gt;
</div>
yes, but note that you in fact do something completely weird there. 
$x-&gt;toString is a string of octets in the iso-8859-15 encoding and by 
passing it to Encode::encode&#40;...&#41; you tell Perl &#40;implicitly&#41; to upgrade 
it to UTF-8 &#40;as if it were Latin-1&#41; and then &#40;explicitly&#41; to convert so 
upgraded string back to iso-8859-15. What you should do here is just 
print $x-&gt;toString &#40;no Encode&#41;. You&#39;ll get the same bytes in the output 
as were on the input.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Now, let&#39;s try the same with UTF-8:
&gt;
&gt; my $x = XML::LibXML-&gt;new-&gt;parse_string&#40;&#34;&lt;?xml version=\&#34;1.0\&#34;
&gt; encoding=\&#34;UTF-8\&#34;?&gt;&lt;x&gt;\xe2\x82\xac&lt;/x&gt;&#34;&#41;;
&gt; print Encode::encode&#40;&#34;ISO-8859-15&#34;, $x-&gt;toString&#41;;
&gt;
&gt; Outputs:
&gt;
&gt; &lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&gt; &lt;x&gt;â‚¬&lt;/x&gt;
&gt;
&gt; Ugh! Perl sees the euro symbol as a single character, instead of the
&gt; original sequence of 3 octets!
</div>
not sure what was your intention here, but yes, the fact that UTF8 flag 
is ON in this case is really odd. On the other hand, your code seems to 
be aware of it &#40;otherwise why would you pass it to Encode::encode&#40;...&#41; 
without doing Encode::decode&#40;&#39;UTF-8&#39;,...&#41; first, right? :-&#41;&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; What this means is that to correctly 
&gt; stringify this document UTF-8 encoding needs to be performed when the
&gt; string has Encode::is_utf8&#40;&#41; on. Or in other words, turning the 
</div>Unicode
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; flag off &#34;fixes&#34; it so that we work the same way regardless what the
&gt; original encoding of the document is!
</div>
I agree completely that $doc-&gt;toString should behave consistently. The 
current inconsistency lies in the fact that if the document encoding is 
UTF-8, the XML is returned with UTF8 flag is on &#40;imposing character 
semantics&#41;, whereas for all other encodings are returned &#40;of course&#41; as 
bytes. 

Ideally, $doc-&gt;toString would always return characters &#40;UTF-8 encoded 
string with the UTF8 on&#41;, just as $node-&gt;toString does and there would 
be another API for returning the XML in the document encoding. But now 
its too late to go back this way. For compatibility with existing 
applications, $doc-&gt;toString must remain in the document encoding.

But then the flag should never be ON. The fact that it is set ON for 
UTF-8 documents is &#40;probably&#41; because XML::LibXML originated before 
Perl 5.6 appeared, and when it did, people were confused and did not 
fully understand the semantics of the UTF8 flag.

read on...

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; I wonder if the document piece saying that &#34;$doc-&gt;setEncoding&#40;&#41; is
&gt; unsafe&#34; is true any more. 
</div>
no, it&#39;s not. Removed.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Maybe it depends on libxml2 version? It would
&gt; appear that XML::LibXML performs character reference substitutions as
&gt; appropriate, and everything works just fine as I&#39;m testing it.
&gt;
&gt; Let&#39;s just fix this mess so that toString&#40;&#41; properly encodes the
&gt; document to UTF-8 when the unicode bit is on and hands out octets.
</div>
If you wish toString&#40;&#41; to always return a character string &#40;with 
UTF8 &#34;on&#34;&#41;, then no, I can&#39;t do that &#40;would break too many existing 
applications&#41;. If you wish toString&#40;&#41; to consistently return a byte 
string - i.e. octets &#40;UTF8 flag &#34;off&#34;&#41;, then yes, I think this is 
currently the best  way to go &#40;consistent and least invasive&#41;. There is 
only a marginal chance of breaking existing code and in those cases 
adding

$string = $doc-&gt;toString;
Encode::decode_utf8&#40;$string,0&#41; if Encode::is_utf8&#40;$string&#41;;

simulates the old behavior.

So I just changed the code in the SVN in this way.

This means that now it is ensured that the result is a byte string in 
the document encoding and as such it can be safely passed to a :byte 
&#40;default&#41; I/O layer or re-encoded using the Encode module without 
warnings or any obscure side effects.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Let 
&gt; us remove the mention about setEncoding&#40;&#41; being unsafe, because it 
</div>seems
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; perfectly safe.
</div>
done

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; And getEncoding&#40;&#41; should return UTF-8, never undef,.
</div>
Can&#39;t do in this way - I know some real applications that make use of 
this distinction. This function is indeed meant as an accessor, like 
xmlEncoding in DOM Level 3.

There is, however, an existing alias for getEncoding named 
actualEncoding which seems quite suitable for this. I changed it to 
return what you suggest.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; the missing prolog problem could be handled by always adding a prolog 
</div>to
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; output and explicitly choosing UTF-8 encoding for the document, which 
</div>is
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; what XML standard implies the document&#39;s content is
</div>
sorry, but no automatic adding of encoding declarations! That could 
break things too and many people require control over the resulting 
XML.

Please try the current SVN version:

svn co svn://axkit.org/XML-LibXML/trunk

perl Makefile.PL
make
make docs
perl Makefile.PL  # yes, again
make
make test
make install

Feel free to reopen the bug if needed or contact me on pajas at matfyz 
dot cz
-- Petr
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-309430" href="/Public/Bug/Display.html?id=26318#txn-309430">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;13&nbsp;17:31:06&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-309433" href="/Public/Bug/Display.html?id=26318#txn-309433">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;13&nbsp;17:31:08&nbsp;2007</span>
    <span class="description">pajas [...] matfyz.cz -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-309435" href="/Public/Bug/Display.html?id=26318#txn-309435">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;13&nbsp;17:36:42&nbsp;2007</span>
    <span class="description">pajas [...] matfyz.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/309435/140703/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/140703">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 250b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On pÃ¡ 13.dub.2007 17:31:03, PAJAS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; $string = $doc-&gt;toString;
&gt; Encode::decode_utf8&#40;$string,0&#41; if Encode::is_utf8&#40;$string&#41;;
</div>
oops, should have been something like

$string = Encode::decode&#40;$string,0&#41; if
  $doc-&gt;actualEncoding=~/^UTF-?8/;
-- p
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-309436" href="/Public/Bug/Display.html?id=26318#txn-309436">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;13&nbsp;17:36:46&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-309462" href="/Public/Bug/Display.html?id=26318#txn-309462">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;13&nbsp;17:41:14&nbsp;2007</span>
    <span class="description">pajas [...] matfyz.cz -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.344598</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
