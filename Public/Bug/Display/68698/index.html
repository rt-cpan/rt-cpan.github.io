<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #68698 for Moose: Applying traits to attributes using clone_and_inherit_options fails for traits that overwrite _process_options</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #68698 for Moose: Applying traits to attributes using clone_and_inherit_options fails for traits that overwrite _process_options</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Moose">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Moose">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Moose">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Moose">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Moose">Moose CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">68698</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Moose">Moose</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
EALLENIII [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-38786-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.0007    </td>
  </tr>
  <tr id="CF-38787-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




hackish_fix.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/943587/490610/hackish_fix.patch">
Thu Jun 09 00:22:05 2011 (4.3k) by EALLENIII [...] cpan.org
</a>
</font></li>
</ul>


moosetrait.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/943313/490468/moosetrait.t">
Wed Jun 08 01:50:30 2011 (1.1k) by EALLENIII [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=68698">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-943313" href="/Public/Bug/Display.html?id=68698#txn-943313">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;08&nbsp;01:50:30&nbsp;2011</span>
    <span class="description">EALLENIII [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Applying traits to attributes using clone_and_inherit_options
 fails for traits that overwrite _process_options</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/943313/490467/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/490467">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 298b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Several MooseX modules hack the _process_options method for attributes.  
After trying to figure out why my &#40;evil evil evil&#41; module 
MooseX::Role::AttributeOverride was failing for these, I found the issue 
was with Moose.

The attached test demonstrates the issue.

Thanks &#40;and please forgive me&#41;.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> moosetrait.t</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/943313/490468/moosetrait.t">Download moosetrait.t</a><br />
<span class="downloadcontenttype">text/x-perl 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">package MyApp::Meta::Attribute;
use Moose::Role;

around _process_options =&gt; sub {
    my &#40; $orig, $class, $name, $options &#41; = @_;
    $options-&gt;{default} = sub { return &#39;yep&#39; };  
    return $orig-&gt;&#40;$class , $name, $options&#41;;
};

package MyApp;
use Moose;

has &#39;fun&#39; =&gt; &#40;
    is  =&gt; &#39;rw&#39;,
    isa =&gt; &#39;Str&#39;
&#41;;

__PACKAGE__-&gt;meta-&gt;make_immutable;
no Moose;

package MyApp::Child;
use Moose;

extends qw&#40;MyApp&#41;;

has &#39;+fun&#39; =&gt; &#40; traits =&gt; [&#39;MyApp::Meta::Attribute&#39;] &#41;;

no Moose::Role;

package MyApp::Brother;
use Moose;

has &#39;fun&#39; =&gt; &#40;
    is  =&gt; &#39;rw&#39;,
    isa =&gt; &#39;Str&#39;,
    traits =&gt; [&#39;MyApp::Meta::Attribute&#39;] 
&#41;;

__PACKAGE__-&gt;meta-&gt;make_immutable;
no Moose;

package main;

use Test::More tests =&gt; 6;    # last test to print

my $testa = MyApp::Child-&gt;new&#40;&#41;;
my $testb = MyApp::Brother-&gt;new&#40;&#41;;

for my $test &#40;$testa,$testb&#41; { 
    my $attr = $test-&gt;meta-&gt;find_attribute_by_name&#40;&#39;fun&#39;&#41;;

    ok &#40; $attr-&gt;has_applied_traits, &#39;Traits get applied&#39;&#41;;

    my @good = grep {$_ eq &#39;MyApp::Meta::Attribute&#39;} @{$attr-&gt;applied_traits};

    ok &#40;scalar @good, &#39;My traits get applied&#39;&#41;;
    is&#40; $test-&gt;fun, &#39;yep&#39;, &#34;Default was set by role&#34; &#41;;
}



</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-943583" href="/Public/Bug/Display.html?id=68698#txn-943583">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;08&nbsp;23:29:49&nbsp;2011</span>
    <span class="description">EALLENIII [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/943583/490605/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/490605">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 793b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">After reviewing the Moose source for some time, I see no easy fix for 
this. The problem is that the clone method, reasonably, skips the 
_process_options method.

It would be ideal to pass the options through _process_options from 
clone_and_inherit_options, but this does not solve the problem.  The 
problem is that the generated metaclass is not the metaclass of the 
final cloned option until new is ran, where we are back to running 
_process_options being not a good idea.

All the solutions I can think of are even uglier than the current code.  
I think I am going to implement something that basically rewrites 
clone_and_inherit_options and runs it through process_options after 
running interpolate_class, using the returned metaclass instead of 
$self, if that makes any sense.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-943586" href="/Public/Bug/Display.html?id=68698#txn-943586">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;08&nbsp;23:29:51&nbsp;2011</span>
    <span class="description">EALLENIII [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-943587" href="/Public/Bug/Display.html?id=68698#txn-943587">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;09&nbsp;00:22:05&nbsp;2011</span>
    <span class="description">EALLENIII [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/943587/490609/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/490609">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 72b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ok.  Attached is a patch to &#39;fix&#39; the issue.  It is a horrible hack...
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> hackish_fix.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/943587/490610/hackish_fix.patch">Download hackish_fix.patch</a><br />
<span class="downloadcontenttype">text/x-diff 4.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/lib/Moose/Meta/Attribute.pm b/lib/Moose/Meta/Attribute.pm
index 3b138fa..f574e8d 100644
--- a/lib/Moose/Meta/Attribute.pm
+++ b/lib/Moose/Meta/Attribute.pm
@@ -198,34 +198,6 @@ sub clone_and_inherit_options {
     &#40;scalar @found_illegal_options == 0&#41;
         || $self-&gt;throw_error&#40;&#34;Illegal inherited options =&gt; &#40;&#34; . &#40;join &#39;, &#39; =&gt; @found_illegal_options&#41; . &#34;&#41;&#34;, data =&gt; \%options&#41;;
 
-    if &#40;$options{isa}&#41; {
-        my $type_constraint;
-        if &#40;blessed&#40;$options{isa}&#41; &#38;&#38; $options{isa}-&gt;isa&#40;&#39;Moose::Meta::TypeConstraint&#39;&#41;&#41; {
-            $type_constraint = $options{isa};
-        }
-        else {
-            $type_constraint = Moose::Util::TypeConstraints::find_or_create_isa_type_constraint&#40;$options{isa}&#41;;
-            &#40;defined $type_constraint&#41;
-                || $self-&gt;throw_error&#40;&#34;Could not find the type constraint &#39;&#34; . $options{isa} . &#34;&#39;&#34;, data =&gt; $options{isa}&#41;;
-        }
-
-        $options{type_constraint} = $type_constraint;
-    }
-
-    if &#40;$options{does}&#41; {
-        my $type_constraint;
-        if &#40;blessed&#40;$options{does}&#41; &#38;&#38; $options{does}-&gt;isa&#40;&#39;Moose::Meta::TypeConstraint&#39;&#41;&#41; {
-            $type_constraint = $options{does};
-        }
-        else {
-            $type_constraint = Moose::Util::TypeConstraints::find_or_create_does_type_constraint&#40;$options{does}&#41;;
-            &#40;defined $type_constraint&#41;
-                || $self-&gt;throw_error&#40;&#34;Could not find the type constraint &#39;&#34; . $options{does} . &#34;&#39;&#34;, data =&gt; $options{does}&#41;;
-        }
-
-        $options{type_constraint} = $type_constraint;
-    }
-
     # NOTE:
     # this doesn&#39;t apply to Class::MOP::Attributes,
     # so we can ignore it for them.
@@ -238,10 +210,22 @@ sub clone_and_inherit_options {
         $options{traits} = \@all_traits if @all_traits;
     }
 
+
+    ### This is a hack to make _process_lazy_options work
+    $options{__hack_is_inherit}  = 1;
+
+    ### This is a hack to make _process_options work.
+    if &#40;$options{coerce} &#38;&#38; &#40;! exists $options{isa}&#41;&#41; {
+        $options{isa} = $self-&gt;type_constraint;
+    }
+   
+
     # This method can be called on a CMOP::Attribute object, so we need to
     # make sure we can call this method.
-    $self-&gt;_process_lazy_build_option&#40; $self-&gt;name, \%options &#41;
-        if $self-&gt;can&#40;&#39;_process_lazy_build_option&#39;&#41;;
+    $options{metaclass}-&gt;_process_options&#40; $self-&gt;name, \%options &#41;
+        if $self-&gt;can&#40;&#39;_process_options&#39;&#41;;
+    
+    delete $options{__hack_is_inherit};
 
     $self-&gt;clone&#40;%options&#41;;
 }
@@ -450,7 +434,9 @@ sub _process_lazy_option {
 
     return unless $options-&gt;{lazy};
 
-    &#40; exists $options-&gt;{default} || defined $options-&gt;{builder} &#41;
+    # Added hack to allow lazy on inherit
+    &#40; exists $options-&gt;{default} || defined $options-&gt;{builder} || exists
+    $options-&gt;{__hack_is_inherit} &#41;
         || $class-&gt;throw_error&#40;
         &#34;You cannot have a lazy attribute &#40;$name&#41; without specifying a default value for it&#34;,
         data =&gt; $options &#41;;
diff --git a/t/attributes/ealleniii_attr_inherit_test.t b/t/attributes/ealleniii_attr_inherit_test.t
new file mode 100644
index 0000000..0e23c71
--- /dev/null
+++ b/t/attributes/ealleniii_attr_inherit_test.t
@@ -0,0 +1,63 @@
+package MyApp::Meta::Attribute;
+use Moose::Role;
+
+around _process_lazy_build_option =&gt; sub {
+    my &#40; $orig, $class, $name, $options &#41; = @_;
+    $options-&gt;{default} = sub { return &#39;yep&#39; };  
+    return $orig-&gt;&#40;$class , $name, $options&#41;;
+};
+
+
+
+
+package MyApp;
+use Moose;
+
+has &#39;fun&#39; =&gt; &#40;
+    is  =&gt; &#39;rw&#39;,
+    isa =&gt; &#39;Str&#39;
+&#41;;
+
+__PACKAGE__-&gt;meta-&gt;make_immutable;
+no Moose;
+
+package MyApp::Child;
+use Moose;
+
+extends qw&#40;MyApp&#41;;
+
+has &#39;+fun&#39; =&gt; &#40; traits =&gt; [&#39;MyApp::Meta::Attribute&#39;] &#41;;
+
+no Moose;
+package MyApp::Brother;
+use Moose;
+
+has &#39;fun&#39; =&gt; &#40;
+    is  =&gt; &#39;rw&#39;,
+    isa =&gt; &#39;Str&#39;,
+    traits =&gt; [&#39;MyApp::Meta::Attribute&#39;] 
+&#41;;
+
+__PACKAGE__-&gt;meta-&gt;make_immutable;
+no Moose;
+
+package main;
+
+use Test::More tests =&gt; 6;    # last test to print
+
+my $testa = MyApp::Child-&gt;new&#40;&#41;;
+my $testb = MyApp::Brother-&gt;new&#40;&#41;;
+
+for my $test &#40;$testa,$testb&#41; { 
+    my $attr = $test-&gt;meta-&gt;find_attribute_by_name&#40;&#39;fun&#39;&#41;;
+
+    ok &#40; $attr-&gt;has_applied_traits, &#39;Traits get applied to &#39; . ref&#40;$test&#41;&#41;;
+
+    my @good = grep {$_ eq &#39;MyApp::Meta::Attribute&#39;} @{$attr-&gt;applied_traits};
+
+    ok &#40;scalar @good, &#39;My traits get applied to &#39;. ref&#40;$test&#41;&#41;;
+    is&#40; $test-&gt;fun, &#39;yep&#39;, &#39;Default was set by role for &#39; .ref&#40;$test&#41; &#41;;
+}
+
+
+
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.363274</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
