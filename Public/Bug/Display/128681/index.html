<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #128681 for Data-Dumper: the XS version doesn&#39;t work w/my code when pureperl does.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #128681 for Data-Dumper: the XS version doesn&#39;t work w/my code when pureperl does.</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Data-Dumper">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Data-Dumper">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Data-Dumper">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Data-Dumper">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="http://rt.perl.org/perlbug/">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Data-Dumper">Data-Dumper CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">128681</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Data-Dumper">Data-Dumper</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">XSAWYERX [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
pause [...] tlinx.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-9006-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.173    </td>
  </tr>
  <tr id="CF-9007-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




CompVer.pm<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1835827/987018/CompVer.pm">
Fri Mar 01 13:50:54 2019 (1.7k) by pause [...] tlinx.org
</a>
</font></li>
</ul>


RecycleBin.pm<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1835827/987019/RecycleBin.pm">
Fri Mar 01 13:50:54 2019 (4.2k) by pause [...] tlinx.org
</a>
</font></li>
</ul>


remove-oldver-rpms-in-dir.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1835827/987020/remove-oldver-rpms-in-dir.pl">
Fri Mar 01 13:50:54 2019 (18k) by pause [...] tlinx.org
</a>
</font></li>
</ul>


src-inp.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1835830/987026/src-inp.txt">
Fri Mar 01 13:58:28 2019 (1.9k) by pause [...] tlinx.org
</a>
</font></li>
</ul>


tmpdata-0<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1835827/987021/tmpdata-0">
Fri Mar 01 13:50:54 2019 (329.3k) by pause [...] tlinx.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=128681">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1835827" href="/Public/Bug/Display.html?id=128681#txn-1835827">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;01&nbsp;13:50:54&nbsp;2019</span>
    <span class="description">pause [...] tlinx.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> the XS version doesn&#39;t work w/my code when pureperl does.</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1835827/987017/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/987017">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Have an util that goes back to 2012.  It trims duplicate versions
of downloaded RPMS and saves the latest.  
Using pure perl, output looks like:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; remove-oldver-rpms-in-dir.pl
</div>Read 32742 rpm names.
Use 9 procs w/3639 items/process
#pkgs=20864, #deletes=11878, total=32742
1 additional duplicates found in last pass
Recycling 11879 duplicates...Done
 Cumulative      This Phase      ID                                   
 0.000s          0.000s          Init                                 
 0.000s          0.000s          start_program                        
 0.230s          0.230s          starting_children                    
 0.233s          0.003s          end_starting_children                
 276.811s        276.578s        endRdFrmChldrn_n_start_re_sort       
 337.756s        60.945s         afterFinalSort                       
 340.943s        3.187s          afterRecycle      

It splits up the task and divides it among multiple processes.
To read the data structs in from the children, they dump the data they worked on and the paran evals the data back in.

The XS version gives:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">h&gt; remove-oldver-rpms-in-dir.pl
</div>Read 42 rpm names.
Use 1 procs w/24 items/process
Error in evaluating data: Global symbol &#34;%Data&#34; requires explicit package name at /home/law/bin/remove-oldver-rpms-in-dir.pl line 469, &lt;$mfrh&gt; line 1.
syntax error at /home/law/bin/remove-oldver-rpms-in-dir.pl line 469, near &#34;# line 469  /home/law/bin/remove-oldver-rpms-in-dir.pl
%Data[&#34;

 at /home/law/bin/remove-oldver-rpms-in-dir.pl line 472, &lt;$mfrh&gt; line 1.
  main::read_slave&#40;1, GLOB&#40;0xa97d80&#41;, Parse_n_Cmp=HASH&#40;0xa9e310&#41;, undef&#41; called at /home/law/bin/remove-oldver-rpms-in-dir.pl line 590
  main::read_data_from_children&#40;main=HASH&#40;0x61f210&#41;&#41; called at /home/law/bin/remove-oldver-rpms-in-dir.pl line 705

&#34;Data&#34; should have been an array &#40;@Data&#41;.

I did try recompiling D::D just in case something was out of date -- no change.

Attached is some sample data that I eval in the parent when it collects from the child.

Also is the source of the program.  Dbg isn&#39;t needed &#40;I don&#39;t think&#41;.
I think any other modules are in cpan.

This does work in pureperl, so I have that option on a separate
line not too far from the top to comment out or not.

Also, I&#39;m not in a hurry to get a solution, since I can use
the perl version though it is a bit slower... :-&#41;

Any Questions, be sure to ask.  

Linda
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> CompVer.pm</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1835827/987018/CompVer.pm">Download CompVer.pm</a><br />
<span class="downloadcontenttype">text/x-perl 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
# gvim=:SetNumberAndWidth 
use warnings; use strict;
################################################################################
{ package TypeVal;
	use warnings; use strict; use mem;
	use Data::Vars [qw&#40;type val&#41;];
1}
################################################################################
{ package CompVer;
	use warnings; use strict;
	our $VERSION=&#39;0.0.1&#39;;
	use mem; use P;
	our @EXPORT;
	use mem &#40;@EXPORT = qw&#40;cmp_vers&#41;&#41;;
	use Xporter;

	use constant {	date		=&gt; 100, num			=&gt; 75,	string	=&gt; 50,
									colon		=&gt; 4, 	dash		=&gt; 4, 	dot			=&gt; 3,
								};

	sub parse_ver &#40;$&#41; { 
		local $_ = $_[0];
		my &#40;@result, $t&#41;;
		
		sub addtok;
		local *addtok = sub {
			push @result, TypeVal-&gt;new&#40;{type =&gt; $t, val =&gt; $1 }&#41;;
			$_ = $2;
		};

		while &#40;length&#41; {
			/^&#40;2\d{7}&#41;&#40;.*&#41;$/		and $t=date,		addtok, next;
			/^&#40;\d+&#41;&#40;\W.*&#41;$/			and $t=num,			addtok, next;
			/^&#40;\d+&#41;$/						and $t=num,			addtok, next;
			/^&#40;\.&#41;&#40;.*&#41;$/				and $t=dot,			addtok, next;
			/^&#40;[-_]&#41;&#40;.*&#41;$/			and $t=dash,		addtok, next;
			/^&#40;:&#41;&#40;.*&#41;$/					and $t=colon,		addtok, next;
			/^&#40;[^_\.:-]+&#41;&#40;.*&#41;$/	and $t=string,	addtok, next;
			/^&#40;.+&#41;$/						and $t=string,	addtok, next;
		}
		return @result;
	} ## end sub parse_ver &#40;$&#41;

	sub cmp_vers&#40;$$&#41; {
		my &#40;$va, $vb&#41; = @_;
		my @pa = parse_ver&#40;&#34;$va&#34;&#41;;
		my @pb = parse_ver&#40;&#34;$vb&#34;&#41;;
		for &#40;my $i = 0 ; $i &lt; @pa ; ++$i&#41; {
			return -1 if $i &gt; @pb;
			my &#40;$pat, $pav&#41; = @{$pa[$i]}{qw&#40;type val&#41;};
			my &#40;$pbt, $pbv&#41; = @{$pb[$i]}{qw&#40;type val&#41;};
			my $cmp;
			return $cmp if &#40;$pat &gt;= num &#38;&#38; $pbt &gt;= num and $cmp = $pav &lt;=&gt; $pbv&#41; or
																										 $cmp = $pav cmp $pbv;
		}
		# getting here means at end of pa array; 
		# if we still have more in pb array then it is longer &#40;and greater&#41;
		return @pb &gt; @pa ? 1 : 0;
	}

1}

</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RecycleBin.pm</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1835827/987019/RecycleBin.pm">Download RecycleBin.pm</a><br />
<span class="downloadcontenttype">text/x-perl 4.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

{ package RecycleBin;
	use warnings; use strict;
	use P; use PathCat qw&#40;Sep&#41;;
	use Cwd;
	my $max_warn	= 1;
	my $warnings	= 0;
# gvim=:SetNumberAndWidth 

	sub getdev_n_path&#40;$&#41; {	
		my $path	= $_[0]; 
		my $dev		= &#40;stat $path&#41;[0];

		return &#40;$dev, $path&#41;;

#		my $retry=0;
#		if &#40;$path =~ m{noarch\.rpm$} &#41; { 
#			$path=~ s/noarch\.rpm/src.rpm/; $retry=1 ;
#		} elsif &#40;$path =~ m{src\.rpm$} &#41; { 
#			$path=~ s/src\.rpm/noarch.rpm/; $retry=1;
#		}
#
#		if &#40;$retry&#41; {
#			&#40;$dev = &#40;stat $path&#41;[0]&#41; and  do {
#				return &#40;$dev, $path&#41;;
#			};
#		}
#		return undef; 
	}

	sub get_partname&#40;$&#41; { my $dev = $_[0];
		my &#40;$devmaj, $devmin&#41; = &#40;$dev &gt;&gt; 8, $dev &#38; 0xff&#41;;
		my $devpath			= &#34;/sys/dev/block/$devmaj:$devmin&#34;;
		my $devname;
		my &#40;$partname, $partRE&#41;;
		if &#40;-d pathcat&#40;$devpath, &#34;dm&#34;&#41;&#41; {
			open&#40;my $ph, &#34;&lt;&#34;, &#34;/sys/dev/block/$devmaj:$devmin/dm/name&#34;&#41; ||
				die &#34;can&#39;t open volume name: $!\n&#34;;
			$partname = &lt;$ph&gt;;
			chomp $partname;
			$partRE	= $partname;
			while &#40;$partRE =~ m{\w-\w}&#41; {
				$partRE =~ s{&#40;\w&#41;-&#40;\w&#41;}{$1.&#39;[-/]&#39;.$2}e;
			}
		} else {
			my $part = readlink $devpath;
			$partname = &#40;$part =~ m{&#40;[^/]+&#41;$}&#41; ? $1 : undef;
			unless &#40;$partname&#41; {
				warn &#34;Cannot get partion name from devpath link&#34;;
				return &#40;undef, undef&#41;;
			}
			$partname = &#34;/dev/&#34; . $partname;
			$partRE		= $partname;
		}
		&#40;$partname, $partRE&#41;
	}

	sub get_mnt_point &#40;$&#41; { my $partname = $_[0];
		open&#40;my $mh, &#34;&lt;&#34;, &#34;/proc/mounts&#34;&#41; or die &#34;Can&#39;t open /proc/mount: $?\n&#34;;
		my @table = &lt;$mh&gt;;
		my @mps		= grep m{$partname}, @table;

		die &#34;Cannot find $partname in mount table&#34; if @mps &lt; 1;

		my $mnt_pnt = &#40;split /\s+/, $mps[0]&#41;[1];
		chomp $mnt_pnt;
		$mnt_pnt;
	}

	sub get_recycle_bin&#40;$&#41; { my $mnt_pnt  = $_[0]; my $recycle_bin;
		umask 0;
		if &#40;!-d &#40;$recycle_bin = pathcat&#40;$mnt_pnt, &#34;.recycle&#34;&#41;&#41;&#41; {
			mkdir &#40;$recycle_bin, 01777&#41; ||
				die &#34;Cannot create recycle bin under mount $mnt_pnt: $!&#34;;

			chmod 01777, $recycle_bin || die &#34;Cannot set correct mode:$!&#34;;
		}
		$recycle_bin;
	}

	sub createdest&#40;$$&#41; {my &#40;$voldir, $dest&#41; = @_;
		umask 0;
		use Cwd qw&#40;abs_path&#41;;
		my @parts		= split &#39;/&#39;, $dest;
		my $curdir	= abs_path&#40;&#41;;
		chdir $voldir || die &#34;Cannot create path for recycling @ $voldir&#34;;
		while &#40;@parts&#41; {
			$voldir = pathcat&#40;$voldir, shift @parts&#41;;
			if &#40;! -d $voldir&#41; {
				mkdir &#40;$voldir, 01777&#41; || die &#34;Cannot create path @ $voldir: $!&#34;;
				chmod 01777, $voldir;
				chdir $voldir;
			}
		}
		chdir $curdir;
	}
	
	our &#40;%dev2partname, %partition2mntpt, %mntdir2recycle&#41;;

	sub recycle_warn&#40;$&#41; { my $msg=$_[0];
		++$warnings;
		if &#40;--$max_warn&#41; { warn $msg;return undef; } else { die $msg};
	}

	sub recycle &#40;$&#41; {
		my $path = Sep eq substr&#40;$_[0],0,1&#41; ? $_[0] : pathcat&#40;getcwd,$_[0]&#41;;

		my &#40;$dev, $real_path&#41; = getdev_n_path&#40;$path&#41;;


		#/local/suse/tumbleweed/repo/src-non-oss/suse
		#/ &#40;src&#41; &#40;7kaa-music-20140929-1.11&#41; .&#40;noarch&#41;.rpm
#		unless &#40;$dev &#38;&#38; $real_path&#41; {
#			my &#40;$dirs,$file, $rpmtype, $sfx&#41; = m{^&#40;.*?&#41;/&#40;[^/]+?&#41;/&#40;[^/.]+?&#41;\.&#40;[^/.]+&#41;$};
#			Pe &#34;dr=%s, fl=%s, rt=%s, sfx=%s&#34;, $dirs,$file, $rpmtype, $sfx;
#			my $newpath=&#34;$dirs/$file.&#34;;
#		}

		return recycle_warn&#40;
			P &#34;real_path=%s&#40;%s&#41;, dev=%s&#34;, $real_path, 
				 &#40;$real_path &#38;&#38; -e $real_path? &#34;exists&#34; : &#34;Nexist&#34;&#41;, $dev&#41;
				 unless $dev &#38;&#38; $real_path;


		my &#40;$partname, $partRE&#41; = $dev2partname{$dev} ||= get_partname&#40;$dev&#41;;
		die &#34;Can&#39;t get partname &#40;?$partname?&#41; from dev &#40;$dev&#41;&#34; unless $partname;

		my $mnt_pnt = $partition2mntpt{$partname}			||= get_mnt_point&#40;$partname&#41;;
		die &#34;Can&#39;t get mntpnt &#40;4 partname $partname&#41;&#34;  unless $mnt_pnt;

		my $recycle_bin = $mntdir2recycle{$mnt_pnt}		||= get_recycle_bin&#40;$mnt_pnt&#41;;

		my $file = &#40;$real_path =~ m{.*/&#40;[^/]+&#41;$}&#41;[0];
		my $src = $real_path;
		$real_path =~ s{$mnt_pnt/}{};		#sub path in recycle bin

		my $path_recycle_dir = &#40;$real_path =~ m{&#40;.*&#41;/[^/]+$} &#41; [0];

		my $dst = pathcat&#40;$recycle_bin, $path_recycle_dir, $file&#41;;

		my $recycle_target_dir = pathcat&#40;$recycle_bin, $path_recycle_dir&#41;;
		createdest&#40;$recycle_bin, $path_recycle_dir&#41; unless -d $recycle_target_dir;
		
		die P &#34;FAIL -- no target dir %s, in mntpt %s&#34;, $recycle_target_dir, $mnt_pnt
			unless -d $recycle_target_dir;

		if &#40;link $src, $dst&#41; {
			unlink $src or recycle_warn&#40;
					P &#34;Could not unlink old file %s&#34;, $src&#41;;
		} else {
			recycle_warn&#40;P &#34;Could not link %s into %s&#34;, $src, $recycle_bin&#41;;
		}

		return !$warnings;	
	} ## end sub recycle &#40;$&#41;
1}


## vim: ts=2 sw=2 ai
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> remove-oldver-rpms-in-dir.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1835827/987020/remove-oldver-rpms-in-dir.pl">Download remove-oldver-rpms-in-dir.pl</a><br />
<span class="downloadcontenttype">text/x-perl 18k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> tmpdata-0</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1835827/987021/tmpdata-0">Download tmpdata-0</a><br />
<span class="downloadcontenttype">application/octet-stream 329.3k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1835830" href="/Public/Bug/Display.html?id=128681#txn-1835830">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;01&nbsp;13:58:28&nbsp;2019</span>
    <span class="description">pause [...] tlinx.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1835830/987025/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/987025">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">BTW, this is in perl 5.16.3:

Summary of my perl5 &#40;revision 5 version 16 subversion 3&#41; configuration:
   
  Platform:
    osname=linux, osvers=3.12.0-isht-van, archname=x86_64-linux-thread-multi-ld
    uname=&#39;linux ishtar 3.12.0-isht-van #1 smp preempt wed nov 13 16:50:51 pst 2013 x86_64 x86_64 x86_64 gnulinux &#39;
    config_args=&#39;&#39;
    hint=previous, useposix=true, d_sigaction=define
    useithreads=define, usemultiplicity=define
    useperlio=define, d_sfio=undef, uselargefiles=define, usesocks=undef
    use64bitint=define, use64bitall=define, uselongdouble=define
    usemymalloc=n, bincompat5005=undef
  Compiler:
    cc=&#39;gcc&#39;, ccflags =&#39;-D_REENTRANT -D_GNU_SOURCE -fno-strict-aliasing -pipe -fstack-protector -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64&#39;,
    optimize=&#39;-g -O2&#39;,
    cppflags=&#39;-D_REENTRANT -D_GNU_SOURCE -fno-strict-aliasing -pipe -fstack-protector -D_REENTRANT -D_GNU_SOURCE -fno-strict-aliasing -pipe -fstack-protector -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64 -D_REENTRANT -D_GNU_SOURCE -fno-strict-aliasing -pipe -fstack-protector -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64&#39;
    ccversion=&#39;&#39;, gccversion=&#39;4.8.1 20130909 [gcc-4_8-branch revision 202388]&#39;, gccosandvers=&#39;&#39;
    intsize=4, longsize=8, ptrsize=8, doublesize=8, byteorder=12345678
    d_longlong=define, longlongsize=8, d_longdbl=define, longdblsize=16
    ivtype=&#39;long&#39;, ivsize=8, nvtype=&#39;long double&#39;, nvsize=16, Off_t=&#39;off_t&#39;, lseeksize=8
    alignbytes=16, prototype=define
  Linker and Libraries:
    ld=&#39;gcc&#39;, ldflags =&#39;-g -fstack-protector -fPIC&#39;
    libpth=/usr/lib64 /lib64
    libs=-lnsl -lndbm -lgdbm -ldb -ldl -lm -lcrypt -lutil -lpthread -lc -lgdbm_compat
    perllibs=-lnsl -ldl -lm -lcrypt -lutil -lpthread -lc
    libc=/lib/libc-2.18.so, so=so, useshrplib=true, libperl=libperl-5.16.3.so
    gnulibc_version=&#39;2.18&#39;
  Dynamic Linking:
    dlsrc=dl_dlopen.xs, dlext=so, d_dlsymun=undef, ccdlflags=&#39;-Wl,-E -Wl,-rpath,/home/perl/perl-5.16.3/lib/x86_64-linux-thread-multi-ld/CORE&#39;
    cccdlflags=&#39;-fPIC&#39;, lddlflags=&#39;-shared -g -O2 -fstack-protector -fPIC&#39;


Characteristics of this binary &#40;from libperl&#41;: 
  Compile-time options: HAS_TIMES MULTIPLICITY PERLIO_LAYERS
                        PERL_DONT_CREATE_GVSV PERL_IMPLICIT_CONTEXT
                        PERL_MALLOC_WRAP PERL_PRESERVE_IVUV USE_64_BIT_ALL
                        USE_64_BIT_INT USE_ITHREADS USE_LARGE_FILES
                        USE_LOCALE USE_LOCALE_COLLATE USE_LOCALE_CTYPE
                        USE_LOCALE_NUMERIC USE_LONG_DOUBLE USE_PERLIO
                        USE_PERL_ATOF USE_REENTRANT_API
  Built under linux
  Compiled at Jan 23 2014 00:35:49
  %ENV:
    PERL5OPT=&#34;-Mutf8 -CSA -I/home/law/bin/lib&#34;
  @INC:
    /home/law/bin/lib
    /home/perl/perl-5.16.3/lib/site/x86_64-linux-thread-multi-ld
    /home/perl/perl-5.16.3/lib/site
    /home/perl/perl-5.16.3/lib/x86_64-linux-thread-multi-ld
    /home/perl/perl-5.16.3/lib

Also -- attaching a sample directory that this would
use as input &#40;a smallish directory&#41;, though it probably isn&#39;t practical for me to submit the actual rpms behind this directory &#40;2.5G&#41;

They are from the SuSE tumbleweed distribution.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> src-inp.txt</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1835830/987026/src-inp.txt">Download src-inp.txt</a><br />
<span class="downloadcontenttype">text/plain 1.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">7kaa-music-20140929-1.16.src.rpm
7kaa-music-20140929-1.17.src.rpm
AdobeICCProfiles-2.0-155.13.src.rpm
AdobeICCProfiles-2.0-155.14.src.rpm
Reaction-1.0-1.51.src.rpm
Reaction-1.0-1.58.src.rpm
Reaction-1.0-1.61.src.rpm
Reaction-data-1.0-1.10.src.rpm
Reaction-data-1.0-1.9.src.rpm
THE-3.3~RC4-4.35.src.rpm
THE-3.3~RC4-5.4.src.rpm
THE-3.3~RC4-5.7.src.rpm
bpg-fonts-0.20120510-192.16.src.rpm
bpg-fonts-0.20120510-192.17.src.rpm
bpg-fonts-0.20120510-192.18.src.rpm
cg-3.1.0013-8.59.src.rpm
cg-3.1.0013-8.61.src.rpm
cg-3.1.0013-8.63.src.rpm
discord-0.0.5-1.1.src.rpm
discord-0.0.8-1.1.src.rpm
discord-0.0.8-1.2.src.rpm
frogatto-1.3.1-4.23.src.rpm
frogatto-1.3.1-4.33.src.rpm
frogatto-1.3.1-4.36.src.rpm
iozone-3.471-1.12.src.rpm
iozone-3.483-1.2.src.rpm
iozone-3.483-1.5.src.rpm
ivtv-firmware-1.4.0-3.16.src.rpm
ivtv-firmware-1.4.0-3.17.src.rpm
john-wordlists-1-6.13.src.rpm
john-wordlists-1-6.14.src.rpm
mikachan-fonts-9.1.2006.08.09-174.46.src.rpm
mikachan-fonts-9.1.2006.08.09-174.47.src.rpm
mikachan-fonts-9.1.2006.08.09-174.48.src.rpm
moneyplex-12.0.20869-8.25.src.rpm
moneyplex-12.0.20869-8.26.src.rpm
netperf-2.7.0-1.54.src.rpm
netperf-2.7.0-1.58.src.rpm
netperf-2.7.0-1.60.src.rpm
openSUSE-Addon-NonOss-release-20190121-9.1.src.rpm
openSUSE-Addon-NonOss-release-20190209-40.1.src.rpm
openttd-opensfx-0.2.3-8.15.src.rpm
openttd-opensfx-0.2.3-8.16.src.rpm
opera-54.0.2952.41-1.1.src.rpm
opera-57.0.3098.116-1.1.src.rpm
opera-58.0.3135.47-1.1.src.rpm
patterns-non_oss-20170319-1.3.src.rpm
patterns-non_oss-20170319-1.4.src.rpm
perlref-5.004.1-7.7.src.rpm
snipl-0.3.0.0-3.13.src.rpm
snipl-0.3.0.0-3.19.src.rpm
snipl-0.3.0.0-3.20.src.rpm
steam-1.0.0.54-5.4.src.rpm
steam-1.0.0.59-1.1.src.rpm
steamcmd-0.20160905-2.1.src.rpm
steamcmd-0.20160905-2.2.src.rpm
stream-5.10-2.6.src.rpm
stream-5.10-2.7.src.rpm
stream-5.10-2.9.src.rpm
unrar-5.6.5-1.6.src.rpm
unrar-5.6.8-1.4.src.rpm
unrar-5.7.1-1.3.src.rpm
xv-3.10a-1297.27.src.rpm
xv-3.10a-1297.32.src.rpm
xv-3.10a-1297.36.src.rpm
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1835873" href="/Public/Bug/Display.html?id=128681#txn-1835873">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;01&nbsp;18:14:00&nbsp;2019</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1835873/987043/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/987043">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 113b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is a huge amount of code. Is it possible to boil it down to something small that still reproduces the issue?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1835874" href="/Public/Bug/Display.html?id=128681#txn-1835874">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;01&nbsp;18:14:01&nbsp;2019</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1835895" href="/Public/Bug/Display.html?id=128681#txn-1835895">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;01&nbsp;20:16:37&nbsp;2019</span>
    <span class="description">pause [...] tlinx.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #128681] the XS version doesn&#39;t work w/my code when pureperl does.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 01 Mar 2019 17:08:32 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Data-Dumper [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;L. A. Walsh&#34; &lt;pause [...] tlinx.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1835895/987053/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/987053">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">

On 3/1/2019 3:14 PM, Karen Etheridge via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=128681">https://rt.cpan.org/Ticket/Display.html?id=128681</a></span> &gt;
&gt;
&gt; This is a huge amount of code. Is it possible to boil it down to something small that still reproduces the issue?
&gt;   
</div>
----
Like I said,
1&#41; it&#39;s a new error.  I last ran the script in Sep of last year.
2&#41; it doesn&#39;t happen in the pure perl version.
3&#41; I have a workaround using the perl version
4&#41; The package dumps output in &#34;sub start_childrenQs @ #395-430  where
it says
&#34;$package_p-&gt;dump_to_output&#34;.  That calls Dump_SO &#40;dump to standard out&#41;.
That calls SDump right above it in package &#34;DDump @ #42.

Immediately below start_childrenQs is &#39;read_slave -- used by the mother
of the
children to slurp the data in and eval it. which is where the failure occurs
&#40;in the eval&#41;.  I.e. the code dumped out by the children shows a
$Data[&#34;0&#34;]=&lt;all the data&gt;.  I.e. Data is an array &#40;yes I tried it without
the quotes&#41;.  @Data i/s /declared just before the eval, but the error
message
says something about looking for a %Data. 

Why it is looking for a hash rather than array is the problem/different
between the xs/perl versions.

Have you tried running the test case?   The line to toggle is in the
DDump package&#40;#42&#41; at line 52, where &#39;Useperl&#40;1&#41;-&gt;&#39; is on a line by
itself. 
As it is, it calls Useperl&#40;1&#41;, but commented out it will default to the &#39;xs&#39;
version.

I tried to include everything needed to reproduce the bug.  But as far as
narrowing down the bug in Data::Dumper with a small test case, I  know its
time I don&#39;t have. 

FWIW, the constant &#39;save_intermediate set to &#40;1&#41; uses tmp files to
communicate between children+mother in /dev/shm/tmp/.  Otherwise
it uses sockets.

You don&#39;t have to follow everything.

If I was debugging it, I might save the intermediate files in the
perl vs. xs case, and compare them.  That&#39;d be my first step.

I almost didn&#39;t report it because that took up quite a bit of time by
itself,
but it is a clearly a bug that only is visible when the &#39;xs&#39; module is used
and due to some change since last fall. &#40;assuming xs was the default before
then&#41;.  If the &#39;xs&#39; had just been added, I&#39;d point fingers at that, but that
doesn&#39;t seem to be the case.

Let me know if you have a problem running it, but I really tried to put
everything needed there.

Cheers!
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.441098</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
