<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #71601 for AnyEvent-CouchDB: Stream module lacks basic required functionality to prevent socket closing</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #71601 for AnyEvent-CouchDB: Stream module lacks basic required functionality to prevent socket closing</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/AnyEvent-CouchDB/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/AnyEvent-CouchDB/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/AnyEvent-CouchDB/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/AnyEvent-CouchDB/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/AnyEvent-CouchDB">AnyEvent-CouchDB CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">71601</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/AnyEvent-CouchDB/Active/">AnyEvent-CouchDB</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bdavis [...] hostgator.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-223090-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
1.00</li>
<li>
1.01</li>
<li>
1.02</li>
<li>
1.03</li>
<li>
1.04</li>
<li>
1.05</li>
<li>
1.07</li>
<li>
1.08</li>
<li>
1.09</li>
<li>
1.10</li>
<li>
1.12</li>
<li>
1.13</li>
<li>
1.14</li>
<li>
1.15</li>
<li>
1.16</li>
<li>
1.17</li>
<li>
1.19</li>
<li>
1.20</li>
<li>
1.21</li>
<li>
1.22</li>
<li>
1.23</li>
<li>
1.24</li>
<li>
1.25</li>
<li>
1.26</li>
<li>
1.27</li>
</ul>
    </td>
  </tr>
  <tr id="CF-223091-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;11&nbsp;13:45:13&nbsp;2011</span>
    <span class="description">http://benbot.myopenid.com/ -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Stream module lacks basic required functionality to prevent
 socket closing</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">As per <span class="clickylink"><a target="new" rel="nofollow" href="http://guide.couchdb.org/draft/notifications.html">http://guide.couchdb.org/draft/notifications.html</a></span>
The &#34;Continuous&#34; feed can be used to monitor active changes from a
CouchDB database.  Unfortunately, the URL being crafted for this purpose
within AnyEvent::CouchDB::Stream does not satisfy the necessary
requirements to ensure continuous connection.
References to this issue exist in the following locations:
<span class="clickylink"><a target="new" rel="nofollow" href="https://issues.apache.org/jira/browse/COUCHDB-580?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel#issue-tabs">https://issues.apache.org/jira/browse/COUCHDB-580?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel#issue-tabs</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/CPAN-API/metacpan-web/issues/281">https://github.com/CPAN-API/metacpan-web/issues/281</a></span>

It&#39;s documented here:

<span class="clickylink"><a target="new" rel="nofollow" href="http://wiki.apache.org/couchdb/HTTP%5Fdatabase%5FAPI#Changes">http://wiki.apache.org/couchdb/HTTP%5Fdatabase%5FAPI#Changes</a></span> 
That the changes API has a default timeout of 60 seconds if no new data
is implemented.

Please note that the relevant code to resolve this issue has been
attached, as well as sample code which displays the noted issue after a
60 second timeframe.

[benbot@benbot ~]$ perl -v

This is perl 5, version 14, subversion 1 &#40;v5.14.1&#41; built for i686-linux

[benbot@benbot ~]$ uname -a
Linux benbot.houston.hostgator.com 2.6.40.4-5.fc15.i686 #1 SMP Tue Aug
30 14:54:41 UTC 2011 i686 i686 i386 GNU/Linux
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Stream.pm.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- a/Stream.pm	2011-10-11 12:01:37.208112734 -0500
+++ b/Stream.pm	2011-10-11 12:05:05.952926161 -0500
@@ -8,7 +8,7 @@
 use JSON;
 use Try::Tiny;
 
-our $VERSION = &#39;0.01&#39;;
+our $VERSION = &#39;0.02&#39;;
 
 sub new {
     my $class        = shift;
@@ -19,6 +19,7 @@
     my $filter       = delete $args{filter};
     my $since        = delete $args{since} || 1;
     my $on_change    = delete $args{on_change};
+    my $heartbeat    = delete $args{heartbeat} || 5000;
     my $on_error     = delete $args{on_error} || sub { die @_ };
     my $on_eof       = delete $args{on_eof} || sub { };
     my $on_keepalive = delete $args{on_keepalive} || sub { };
@@ -27,7 +28,7 @@
 
     my $uri = URI-&gt;new&#40;$server&#41;;
     $uri-&gt;path&#40; $db. &#39;/_changes&#39; &#41;;
-    $uri-&gt;query_form&#40; filter =&gt; $filter, feed =&gt; &#34;continuous&#34;, since =&gt; $since &#41;;
+    $uri-&gt;query_form&#40; filter =&gt; $filter, feed =&gt; &#34;continuous&#34;, since =&gt; $since, heartbeat =&gt; $heartbeat &#41;;
 
     my $self = bless {}, $class;
 
@@ -160,6 +161,10 @@
 
 A code ref to execute on eof
 
+=item B&lt;heartbeat&gt;
+
+The interval in milliseconds between newlines sent from the server to ensure that an open connection is still being maintained
+
 =back
 
 =head1 AUTHOR

</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> couchdb-stream.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!perl
use AnyEvent;
use AnyEvent::CouchDB::Stream;


my &#40;$changes_watcher,$changes_listener, $changes_callback&#41;;
my %listener_args = &#40;
	url =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:5984/&#39;">http://localhost:5984/&#39;</a></span>,
	database =&gt; &#39;jobs&#39;,
	since =&gt; 0,
	on_change =&gt; sub {
		my $change = shift;
                $changes_watcher-&gt;send and warn &#34;Connection Closed&#34; if $change-&gt;{last_seq};
		$listener_args-&gt;{since} = $change-&gt;{seq} if $change-&gt;{seq} &gt; $listener_args-&gt;{since};
	},
	on_error =&gt; sub {warn &#34;Error due to closed pipe.&#34; and $changes_watcher-&gt;send;},
	timeout =&gt; 1
&#41;;

sub loop {
        $changes_listener = undef;
	$changes_watcher = undef;
        $changes_listener = AnyEvent::CouchDB::Stream-&gt;new&#40;%listener_args&#41;;
	$changes_watcher = AnyEvent::condvar;
	$changes_callback = $changes_watcher-&gt;cb&#40;sub{loop&#40;&#41;;}&#41;;
}

loop&#40;&#41;;

$changes_watcher-&gt;recv;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;25&nbsp;22:39:05&nbsp;2011</span>
    <span class="description">beppu [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I applied your patch and released AnyEvent::CouchDB 1.28.

Sorry for the delay.

$work has been busy;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;25&nbsp;22:39:05&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;25&nbsp;22:39:06&nbsp;2011</span>
    <span class="description">beppu [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
