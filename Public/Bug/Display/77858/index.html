<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #77858 for AnyEvent: EV::loop don&#39;t return context after resolve_addr calls &#40;?&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #77858 for AnyEvent: EV::loop don&#39;t return context after resolve_addr calls &#40;?&#41;</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=AnyEvent">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=AnyEvent">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=AnyEvent">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=AnyEvent">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/AnyEvent">AnyEvent CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">77858</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">deleted</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=AnyEvent">AnyEvent</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
reisub [...] ya.ru

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-1118-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
7.01    </td>
  </tr>
  <tr id="CF-1119-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




test_anyevent_ev_loop.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1090680/573218/test_anyevent_ev_loop.pl">
Sat Jun 16 00:36:35 2012 (6.7k) by reisub [...] ya.ru
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=77858">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1090680" href="/Public/Bug/Display.html?id=77858#txn-1090680">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;16&nbsp;00:36:35&nbsp;2012</span>
    <span class="description">reisub [...] ya.ru -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> EV::loop don&#39;t return context after resolve_addr calls &#40;?&#41;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1090680/573217/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/573217">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 559b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello.
I&#39;m not sure but thinking that after AnyEvent::Socket::resolve_addr call
EV::loop don&#39;t return context. Attach include 4 tests that can help to
inspect EV::loop behavior. First 3 tests is switch EV::loop behavior
using resolve_sockaddr in AnyEvent::Socket::tcp_connect sub. Test4 is a
bit different: EV::loop switching using manuall resolve_sockaddr call.
I hope that with some modifications &#40;now it is not possible to use
Test::More to test EV::loop behavior&#41; tests can help to inspect now and
test AnyEvent package in next time.

Best regards,
Nick.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test_anyevent_ev_loop.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1090680/573218/test_anyevent_ev_loop.pl">Download test_anyevent_ev_loop.pl</a><br />
<span class="downloadcontenttype">text/x-perl 6.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!perl

#
# Stupid test-case to detect EV::loop resolver problem &#40;?&#41;
#
# I know that if peer drop connection
#
# License: This program is free software; you can redistribute it
# and/or modify it under the same terms as Perl itself and/or GNU GPLv2 or later.
#
# 				Contact with author by jabber/email: reisub@ya.ru
#

use strict;
use IO::Socket::INET;
use Time::HiRes;

$|=1;

our $perl = &#39;perl&#39;; # perl path; set correct path
our $free_port = 12345; # default free port

# advanced functions in EOF

unless&#40;@ARGV&#41;{
    print &#34;Usage: $perl $0 &#40;test1|test2|test3|test4&#41;\n&#34;;
    exit&#40;0&#41;;
}elsif&#40;$ARGV[0] eq &#39;echo_server&#39;&#41;{
    very_stupid_echo_server&#40;&#41;;
    exit&#40;0&#41;;
}elsif&#40;$ARGV[0]=~/test&#40;\d+&#41;/&#41;{

    _exec&#40;&#34;echo_server&#34;, 1&#41;;
    {
	sleep 0.1;
        my $sock = IO::Socket::INET-&gt;new&#40;PeerAddr =&gt; &#34;127.0.0.1:$free_port&#34;, proto =&gt; &#39;tcp&#39;&#41;
    	    or redo;
    	print &#34;[+] found echo server\n&#34;;
    }

    eval&#40;&#34;$ARGV[0]&#40;&#41;&#34;&#41;;
    exit&#40;0&#41;;
}

#
# test fuctions do just _exec call with 3 &#40;or 4 if port defined&#41; parameters: first two parameter use to do exec call;
# remaining  parameters will post to TestPkg::test_connect &#40;calling after this test* subs&#41;
#

sub test1{
    print &#34;&gt;&gt;&gt; test case 1; test 1\n&#34;;
    print&#40;&#34;    get data from &#39;ya.ru&#39;; connect to host IP directly &#40;EV::loop release context&#41;\n    callbacks call chain: &#34;&#41;;
    _exec&#40;&#34;$perl $0 &#39;93.158.134.3&#39; 80&#34;&#41;;
    print &#34;\n&gt;&gt;&gt; EV::loop released\n\n&#34;;

    print &#34;&gt;&gt;&gt; test case 1; test 1\n&#34;;
    print&#40;&#34;    get data from &#39;ya.ru&#39; using hostname &#40;EV::loop never return&#41;\n    callbacks call chain: &#34;&#41;;
    _exec&#40;&#34;$perl $0 &#39;ya.ru&#39; 80&#34;&#41;;
    print &#34;\n&gt;&gt;&gt; EV::loop released\n\n&#34;; # message never print
}

sub test2{
    print &#34;&gt;&gt;&gt; test case 2; test 1\n&#34;;
    print&#40;&#34;    get data from &#39;local.openflow.ru&#39; &#40;resolve to 127.0.0.1&#41;; connect to host IP directly &#40;EV::loop release context&#41;\n    callbacks call chain: &#34;&#41;;
    _exec&#40;&#34;$perl $0 &#39;127.0.0.1&#39;&#34;&#41;;
    print &#34;\n&gt;&gt;&gt; EV::loop released\n\n&#34;;

    print &#34;&gt;&gt;&gt; test case 2; test 1\n&#34;;
    print&#40;&#34;    get data from &#39;local.openflow.ru&#39; using hostname &#40;EV::loop never return&#41;\n    callbacks call chain: &#34;&#41;;
    _exec&#40;&#34;$perl $0 &#39;local.openflow.ru&#39;&#34;&#41;;
    print &#34;\n&gt;&gt;&gt; EV::loop released\n\n&#34;; # message never print
}

sub test3{
    print &#34;&gt;&gt;&gt; test case 3; test 1\n&#34;;

    print&#40;&#34;    call connection error &#40;trying to connect to &#39;255.255.255.255&#39;&#41;; connect to host IP directly &#40;EV::loop release context&#41;\n    callbacks call chain: &#34;&#41;;
    _exec&#40;&#34;$perl $0 &#39;255.255.255.255&#39;&#34;&#41;;
    print &#34;\n&gt;&gt;&gt; EV::loop released\n\n&#34;;

    print &#34;&gt;&gt;&gt; test case 3; test 2\n&#34;;
    print&#40;&#34;   call connection error &#40;trying to connect to &#39;255.255.255.255&#39;&#41;; using hostname &#40;resolve to 255.255.255.255&#41; &#40;EV::loop never return&#41;\n    callbacks call chain: &#34;&#41;;
    _exec&#40;&#34;$perl $0 &#39;ffff.openflow.ru&#39;&#34;&#41;;
    print &#34;\n&gt;&gt;&gt; EV::loop released\n\n&#34;; # message never print

}

sub test4{ # core test show that resove_sockaddr call switch EV::loop behavior
    print &#34;&gt;&gt;&gt; test case 4; test 1\n&#34;;
    print&#40;&#34;    Get data from &#39;local.openflow.ru&#39; &#40;resolve to 127.0.0.1&#41;; connect to host IP directly &#40;EV::loop release context&#41;\n    callbacks call chain: &#34;&#41;;
    _exec&#40;&#34;$perl $0 &#39;127.0.0.1&#39;&#34;&#41;; # just connect to stupid echo server
    print &#34;\n&gt;&gt;&gt; EV::loop released\n\n&#34;;

    print &#34;&gt;&gt;&gt; test case 4; test 1\n&#34;;
    print&#40;&#34;    Get data from &#39;local.openflow.ru&#39; &#40;resolve to 127.0.0.1&#41;; connect to host IP directly &#40;EV::loop never returned&#41;\n    callbacks call chain: &#34;&#41;;
    _exec&#40;&#34;$perl $0 &#39;127.0.0.1&#39; 0 call_resolve_sockaddr 1&#34;&#41;; # same as previous but do one call resolve_sockaddr
    print &#34;\n&gt;&gt;&gt; EV::loop released\n\n&#34;;
}

#
# core code starting here
#

use strict;
use AnyEvent::Handle;
use Data::Dumper;
use EV;

my &#40;$fh, $h&#41;;

#
# TestPkg::test_connect just call AnyEvent::Socket::tcp_connect&#40;&#41;
# @ARGV accepted from _exec called in test* subs
#

TestPkg::test_connect&#40;$ARGV[0], $ARGV[1] || $free_port, \&#38;cb, # connect to &#39;ya.ru&#39; directly without resolving
 on_connect =&gt; sub{print &#34;on_connect =&gt; &#34;;},
 on_error =&gt; sub{print &#34;on error:@_ =&gt; &#34;},
 call_resolve_sockaddr =&gt; &#40;$ARGV[2] eq &#39;call_resolve_sockaddr&#39; and $ARGV[3]&#41;,
&#41;;

EV::loop; # main loop sometimes release context
#
# next no code execution; just subs and package definitions
#

sub cb{
    &#40;$fh, $h&#41; = @_;

    print &#34;Connected =&gt; &#34;;

    $fh-&gt;on_read&#40;\&#38;on_read&#41;;
    $fh-&gt;on_eof&#40;\&#38;on_eof&#41;;
}

sub on_read{
    print &#34;on_read =&gt; &#34;;
#    print &#34;on_read =&gt; &#34;, $fh-&gt;{rbuf};
    undef $fh-&gt;{rbuf};
}

sub on_eof{
    undef $fh-&gt;{rbuf};
    $fh-&gt;destroy;
    print &#34;on_eof =&gt; &#34;;
    return AE::postpone{
	$h = {};
	printf &#34;on_eof postpone...&#34;;
    };
}

#
# TestPkg; no user code execution here; only subs definitions
#
package TestPkg;

use strict;
use warnings;

use AnyEvent;
use AnyEvent::Handle;
use AnyEvent::Socket;
use AnyEvent::Util qw/guard/;


our @ISA = qw/AnyEvent::Socket/;

sub _on_err&#40;$$&#41;{
    my $e = $_[0]-&gt;{on_error};
    my $cb = $_[0]-&gt;{cb};
    $e ?
	$e-&gt;&#40;$_[0]-&gt;{ae_fh}, $_[1]&#41;
    :
	AE::log&#40;error =&gt; $_[1]&#41;, $cb-&gt;&#40;&#41;;
}

sub test_connect&#40;$$$$$;$@&#41;{
    my &#40;$host, $serv, $cb, %h&#41; = @_;

    @h{qw/cb host serv/} = &#40;$cb, $host, $serv&#41;;

    tcp_connect&#40;$host, $serv, sub{
	my &#40;$lfh&#41; = @_;

	if&#40;$lfh&#41;{
	    @h{qw/lfh ae_fh/} = &#40;$lfh, AnyEvent::Handle-&gt;new&#40;fh =&gt; $lfh, on_error =&gt; sub{_on_err&#40;\%h, $_[2]&#41;;close_conn&#40;\%h&#41;;}, on_eof =&gt; $h{on_eof}&#41;&#41;;

	    $h{on_connect}
		and $h{on_connect}-&gt;&#40;\%h&#41;,

	    $h{ae_fh}-&gt;on_read&#40;sub{_on_recv&#40;\%h&#41;}&#41;,
	    $h{ae_fh}-&gt;push_write&#40;&#34;GET / HTTP/1.1\r\nHost: ya.ru\r\n\r\n&#34;&#41;;

	    $h{call_resolve_sockaddr}
		and AnyEvent::Socket::resolve_sockaddr&#40;&#39;ya.ru&#39;, &#39;http&#39;, undef, undef, undef, sub{print &#34;\n[+] AnyEvent::Socket::resolve_sockaddr called\n&#34;;}&#41;;

	}else{
	    _on_err&#40;\%h, $!&#41;;
	    return;
	}

    }&#41;;

    defined wantarray &#38;&#38; guard { print &#34;guard! =&gt; &#34;;%h = &#40;&#41; };
}

sub _on_recv{
    my $h = shift;
    my $data = $h-&gt;{ae_fh}-&gt;rbuf;

    return AE::postpone{
	$h-&gt;{ae_fh}-&gt;{rbuf} = undef;
	$h-&gt;{cb}&#40;$h-&gt;{ae_fh}, $h&#41;;
	print &#34;postpone cleanup =&gt; &#34;;
	$h = {};
    };
}

sub close_conn{
    my $h = shift;
    $h-&gt;{ae_fh}-&gt;destroy&#40;&#41;;
}

#
# main pkg advanced subs
#
package main;

sub _exec{
    my $msg;

    unless&#40;$_[1]&#41;{
	open my $fh, &#34;$_[0]|&#34;
	    or die &#34;_exec failed; $!&#34;;

	while&#40;sysread&#40;$fh, $msg=&#39;&#39;,4096&#41;&#41;{
	    syswrite STDOUT, $msg;
	}

	close $fh;
    }else{
	_fork_call&#40;&#34;exec \&#34;$perl $0 $_[0]\&#34; or die \&#34;can&#39;t exec; $!\n\&#34;&#34;&#41;;
    }

}

sub _fork_call{
	my $pid = fork;

	die &#34;fork; $!\n&#34;
	    unless defined $pid;

	$pid
	    or &#40;eval&#40;$_[0]&#41;,&#40;$@ and print&#40;&#34;_fork_call excpn: $@&#34;&#41;&#41;,exit&#40;0&#41;&#41;;
}

sub very_stupid_echo_server{
    use IO::Socket::INET;

    my $sock = IO::Socket::INET-&gt;new&#40;LocalAddr =&gt; &#39;127.0.0.1&#39;, LocalPort =&gt; $free_port, proto =&gt; &#39;tcp&#39;, ReuseAddr =&gt; 1, Listen =&gt;1&#41;
	    or die &#34;Can&#39;t bind socket; $!\n&#34;;

    my $msg;
    while&#40;my $cl = $sock-&gt;accept&#40;&#41;&#41;{
	$cl-&gt;recv&#40;$msg=&#39;&#39;, 4096&#41;;

	$msg
	    or $cl-&gt;shutdown&#40;2&#41;, $cl=undef, next;

	$cl-&gt;send&#40;&#39;0&#39; x 4096&#41;;
	$cl-&gt;send&#40;&#39;1&#39; x 4096&#41;;

	$cl-&gt;shutdown&#40;2&#41;;
	$cl=undef;
    }
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1090741" href="/Public/Bug/Display.html?id=77858#txn-1090741">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;16&nbsp;11:38:37&nbsp;2012</span>
    <span class="description">schmorp [...] schmorp.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #77858] EV::loop don&#39;t return context after resolve_addr calls &#40;?&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 16 Jun 2012 17:38:25 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> reisub via RT &lt;bug-AnyEvent [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marc Lehmann &lt;schmorp [...] schmorp.de&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1090741/573254/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/573254">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi!

Please send your bug report it to the official contact/author address for
the module in question &#40;or send it to rt.cpan.org@schmorp.de, that&#39;s fine
as well&#41;. What follows is the rationale for this request, you don&#39;t have
to read it if you don&#39;t care.

Why is this necessary?

rt.cpan.org has many deficiencies which makes it tedious and hard to use,
increasing the workload on the people who provide all the perl modules you
probably appreciate &#40;and that is really to be avoided - module authors
should be able to invest all their time into improving their modules and
not fighting with rt.cpan.org&#39;s bugs&#41;.

Still, for some people, rt.cpan.org is useful to have, and some people
even like it and really want to use it. That is fine, too.

Unfortunately, the designers of rt.cpan.org didn&#39;t make their &#34;service&#34;
optional - you can neither opt-in nor opt-out of rt.cpan.org as a module
author.

Just like a spammer, rt.cpan.org forces its &#34;service&#34; &#40;whether wanted
or unwanted&#41; on everybody. Just like a spammer, they don&#39;t care for the
people they actively hurt. Just like a spammer, they don&#39;t don&#39;t care to
fix these issues and make their &#34;service&#34; ethically acceptable.

You cannot even configure it to redirect tickets to somewhere else.

Unfortunately, ignoring rt.cpan.org is not an option either: for people
reporting possible bugs there is no indication that their report will
be ignored, and for module authors it means they miss potentially vital
bug reports such as yours &#40;and of course it&#39;s a great impression if
rt.cpan.org has lots of bug reports that are unanswered, making a module
look unmaintained when in fact the opposite might be true&#41;.

I am sorry that this wasted a bit of your time, but please understand that
I am just as much a victim as you are - the problem is the unethical stance
of the rt.cpan.org providers who force their &#34;service&#34; on everybody.

Please redirect your bug report as stated in the beginning of this mail,
and please consider petitioning the rt.cpan.org providers to stop their
unethical behaviour and allow opt-in, opt-out, or some redirect option.

One last issue: many people mail me that this can be &#34;fixed&#34; by including
the bugtracker element in my module meta file.

This is not true:

1. This field only affects search.cpan.org and maybe similar services.
   &#40;Many people confuse rt.cpan.org with search.cpan.org for some reason&#41;.
2. It doesn&#39;t even work &#40;there are still links to rt.cpan.org displayed&#41;.
3. Even if search.cpan.org does no longer display the link, it doesn&#39;t
   actually affect rt.cpan.org &#40;and tests have shown that people go
   to rt.cpan.org regardless&#41;

Even *iff* rt.cpan.org would start listening on the bugtracker field,
however, it&#39;s still wrong. I have a lot of modules, and each time a
service like rt.cpan.org comes out, I would have to make dummy releases
for all my modules. This not only ceeates a lot of extra work for me &#40;I
take releases very seriously&#41; but also users, who would wonder why there
is a new release.

Thanks a lot,
Marc Lehmann &lt;rt.cpan.org@schmorp.de&gt;

Last updated: 2012-04-22
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1090744" href="/Public/Bug/Display.html?id=77858#txn-1090744">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;16&nbsp;11:38:38&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1090956" href="/Public/Bug/Display.html?id=77858#txn-1090956">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;17&nbsp;18:44:37&nbsp;2012</span>
    <span class="description">reisub [...] ya.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> reisub [...] ya.ru</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1090956/573357/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/573357">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 331b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Mark.

Thank for Your comprehensive comment about rt-tracker work and it&#39;s
defects. A bit later I&#39;ll resend my first message about AnyEvent module
to Schmorpforge.

Regards.

PS: I&#39;m not thinking that behavior I found is a defective bug. No any
problems with condvar usage, but may be better if EV::loop will return
context.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1143619" href="/Public/Bug/Display.html?id=77858#txn-1143619">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;16&nbsp;17:45:10&nbsp;2012</span>
    <span class="description">MLEHMANN [...] cpan.org -  Ticket deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.345743</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
