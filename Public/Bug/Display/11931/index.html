<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #11931 for Net-DNS: Wrong nameserver list handling in Net::DNS::Resolver::Win32</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #11931 for Net-DNS: Wrong nameserver list handling in Net::DNS::Resolver::Win32</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-DNS/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-DNS">Net-DNS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">11931</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-DNS/Active/">Net-DNS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">OLAF [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
risto.kankkunen [...] f-secure.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
hanno.stock [...] gmx.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-22454-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.48    </td>
  </tr>
  <tr id="CF-22455-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;18&nbsp;09:32:59&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Wrong nameserver list handling in Net::DNS::Resolver::Win32</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I had problems getting SpamAssassin RBL queries working on a Windows 2003 server: all I got was timeouts. However, doing any of the queries manually with nslookup worked just fine. And I had SpamAssassin working OK in other Windows servers.

It turned out that Net::DNS::Resolver was using a list of two nameservers, and the 2nd one was the one that should have been used. Since SpamAssassin issues asynchronous queries with bgsend&#40;&#41;, only the first item was used, SpamAssassin could not get any replies from it and all the queries failed in a timeout.

What I&#39;m wondering now, is if the logic in Net::DNS::Resolver::Win32 is correct, when it builds the nameservers list default &#40;see init&#40;&#41;, especially lines 54-90&#41;. The unwanted entry was found from the registry branch [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\DNSRegisteredAdapters\{184B6DCE-9C8B-4405-BDF4-40968CB59FAB}]
and the correct one from [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\Interfaces\{184B6DCE-9C8B-4405-BDF4-40968CB59FAB}]

I wonder, whether you should look for DNSRegisteredAdapters branch at all. I didn&#39;t find too much documentation about this branch, but what there is seems to indicate that it is used for dynamic DNS to configure what server the adapter is registered to, not what server to query. See <span class="clickylink"><a target="new" rel="nofollow" href="http://support.microsoft.com/default.aspx?scid=kb;en-us;254031">http://support.microsoft.com/default.aspx?scid=kb;en-us;254031</a></span>

Furthermore, &#34;ipconfig /all&#34; and &#34;netsh interface ip show dns&#34; show only one entry in &#34;DNS Servers&#34;, and that is the second one in Win32&#39;s list. There is no mention of the address of the first entry in ipconfig or netsh output.

My hunch at the moment is that DNSRegisteredAdapters should not be used when building the nameserver list.

An additional issue is that at the moment the code doesn&#39;t seem to pay any attention to the interface order. It seems that the keys in [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Linkage] control the order the interfaces should be looked up. At least changing the connections order in &#34;Network Connections | Advanced | Advanced Settings...&#34; affects these keys.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;18&nbsp;10:33:33&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I found out that the problematic code comes from a fix to 2533.

Initially there was just a small patch to add support for DhcpNameServer
key. Then the fix expanded to include fix for 2465, too. The final fix
includes the original fix, some support for Windows9x, fix to iterate
all Interfaces &#40;closing 2465&#41; and then the problematic part of
DNSServerAddresses value of the DNSRegisteredAdapters key.

It is unclear to me, what prompted the inclusion of that new problematic
logic, and it is definitely wrong in the server configuration I stumbled
upon.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;18&nbsp;10:54:23&nbsp;2005</span>
    <span class="description">OLAF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; An additional issue is that at the moment the code doesn&#39;t seem to pay
&gt;    any attention to the interface order. It seems that the keys in
&gt;    [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Linkage]
&gt;    control the order the interfaces should be looked up. At least
&gt;    changing the connections order in &#34;Network Connections | Advanced |
&gt;    Advanced Settings...&#34; affects these keys.
</div>
Just to delve into this particular point. There are multiple keys in for
the Linkage path. Which one to choose? What are the different meanings.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;18&nbsp;10:54:24&nbsp;2005</span>
    <span class="description">OLAF [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Take odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;18&nbsp;10:54:37&nbsp;2005</span>
    <span class="description">OLAF [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;21&nbsp;08:45:24&nbsp;2005</span>
    <span class="description">OLAF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Win32.pm used the DNSRegisteredAdapters registry key to determine which
local forwarders to send queries to. This is arguably the wrong key as
it is used to identify the server which to send dynamic updates to.


I have therefore commented out the &#34;broken&#34; code fragment. It has been
committed to the trunk and will appaear in 0.48_03 shortly.

This will prevent errournous nameservers in the list &#40;as are the problem
for Risto&#41; but does not provide us with a reliable method to obtain the
set of nameservers. 


As Michiel de Bruijn pointed out that the registry settings are not a
reliable way of getting this information. They have a different layout
for different Microsoft OS-es and the keys used differ between a DHCP
and a static configured environment. Besides the configuration is
interface based and one cannot determine which interfaces are in use so
one might end up with a bunch of cruft.

The reliable way to get the information is through the
getNetworkParams&#40;&#41; API call in IpHlpApi.dll.  That call works as off
95-met-de-WINSOCK2-fix.
&#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/iphlp/iphlp/getnetworkparams.asp&#41;">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/iphlp/iphlp/getnetworkparams.asp&#41;</a></span>

One could probably call this function through the use of Win32::API, the
  getNetworkParams function is similar to calls in Win32::IPhelper.
Unfortunattelly this is where I get stuck. I cannot get Win32::API
installed on Cygwin and I also do not have much success in with
ActivePerl.  That breaks portability pretty much. 

I&#39;ll stall this ticket in the hope Win32::API gets fixed or somebody has
some spare time to provide an XS interface to getNetworParam that is
portable.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;21&nbsp;08:45:24&nbsp;2005</span>
    <span class="description">OLAF [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;28&nbsp;06:00:17&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Sidney</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here&#39;s a patch that fixes the most common version of the problem that I
see that you can implement before getting the ideal fix describedd above.

I am in the process of fixing SpamAssassin 3.1 trunk so it is not so
vulnerable to these problems. While looking at it I found a small patch
to Net::DNS::Resolver that will make a big difference.

In Windows XP and later, the code is going through the list of network
interfaces in the registry and gathering a list of nameservers. The
biggest problem I&#39;m seeing is registry entries for nameservers for
inactive network interfaces. For example, when I unplug my laptop from
the wired network and use a wireless card, Net::DNS::Resolver still sees
the nameserver address that had been assigned by DHCP on the wired
network and puts that first.

The fix is simple: When getting the list of nameservers also get the
IPAddress key for the interface and if it is equal to &#34;0.0.0.0&#34; do not
add the nameserver to the list.

In Cygwin.pm the patched code section looks like

 my $ns;
 my $ip;
 $ip = getregkey&#40;$regiface, &#34;IPAddress&#34;&#41;;
 $ns = getregkey&#40;$regiface, &#34;NameServer&#34;&#41; ||
       getregkey&#40;$regiface, &#34;DhcpNameServer&#34;&#41; || &#39;&#39;
    unless !$ip || &#40;$ip =~ /0\.0\.0\.0/&#41;;
 $nameservers .= &#34; $ns&#34; if $ns;

In Win32.pm it looks like

 if &#40;$regiface&#41; {
  my $ns;
  my $type;
  my $ip;
  $regiface-&gt;QueryValueEx&#40;&#34;IPAddress&#34;, $type, $ip&#41;;
  if &#40;$ip &#38;&#38; !&#40;$ip =~ /0\.0\.0\.0/&#41;&#41; {
  # NameServer overrides DhcpNameServer if both exist
  $regiface-&gt;QueryValueEx&#40;&#34;NameServer&#34;, $type, $ns&#41;;
  $regiface-&gt;QueryValueEx&#40;&#34;DhcpNameServer&#34;, $type, $ns&#41; unless $ns;
  $nameservers .= &#34; $ns&#34; if $ns;
  }
 }

My contact address is at my personal web site <span class="clickylink"><a target="new" rel="nofollow" href="http://www.sidney.com">http://www.sidney.com</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;28&nbsp;06:00:18&nbsp;2005</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;28&nbsp;09:02:56&nbsp;2005</span>
    <span class="description">OLAF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Thu Apr 28 06:00:17 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In Windows XP and later, the code is going through the list of network
&gt; interfaces in the registry and gathering a list of nameservers.
</div>
How portable is your fix to older versions of MS OSs like Win2000?
I have no way of testing...

--Olaf
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;21&nbsp;03:44:41&nbsp;2005</span>
    <span class="description">OLAF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> sidney [...] sidney.com,</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Thu Apr 28 06:00:17 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Here&#39;s a patch that fixes the most common version of the problem that I
&gt; see that you can implement before getting the ideal fix describedd above.
</div>

After having concentrated on a few other things I am now about to launch
0.49_1 and have just applied this patch to the trunk on
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.net-dns.org/svn/net-dns/trunk/">http://www.net-dns.org/svn/net-dns/trunk/</a></span>

I would appreciate if you guys, that use Net::DNS in production on Win32
based systems would give it a go.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I am in the process of fixing SpamAssassin 3.1 trunk so it is not so
&gt; vulnerable to these problems. While looking at it I found a small patch
&gt; to Net::DNS::Resolver that will make a big difference.
&gt; 
</div>
What is the approach to fixing this in SpamAssassin? I reckon
SpamAssassin will remain dependend on Net::DNS?


Thanks for the contribution.

--Olaf
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;24&nbsp;22:01:45&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Sidney Markowitz</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[OLAF - Sat May 21 03:44:41 2005]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; What is the approach to fixing this in SpamAssassin? I reckon
&gt; SpamAssassin will remain dependend on Net::DNS?
</div>
We&#39;re using bgsend to let DNS queries get sent off at the beginning of
processing a message, then harvest the replies after all other
processing is done. That made the code very vulnerable to the first
nameserver in the list being wrong. This patch fixes one way it could be
wrong, but SpamAssassin was still vulnerable if, for example, the first
nameserver in the list happened to be really down.

The approach I use is a test at initialization time that loops doing a
background query, if it fails popping the first element off the
nameservers list and trying the query again. This ensures that the first
element of nameservers works, at least at the time of that initial test.
If the nameservers list empties before any query succeeds, then we flag
that DNS is disabled and don&#39;t do any more DNS stuff.

The code is at
<span class="clickylink"><a target="new" rel="nofollow" href="http://svn.apache.org/repos/asf/spamassassin/trunk/lib/Mail/SpamAssassin/Dns.pm">http://svn.apache.org/repos/asf/spamassassin/trunk/lib/Mail/SpamAssassin/Dns.pm</a></span>
and search for the string &#39;nameservers&#39; &#40;without quotes&#41;.

 -- Sidney Markowitz <span class="clickylink"><a target="new" rel="nofollow" href="http://www.sidney.com/">http://www.sidney.com/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;24&nbsp;22:09:02&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Sidney Markowitz</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[OLAF - Thu Apr 28 09:02:56 2005]: 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; How portable is your fix to older versions of MS OSs like Win2000?
&gt; I have no way of testing...
</div>
I don&#39;t have a convenient way of testing it, but the patch can&#39;t have
any negative effect. It won&#39;t be executed unless the registry contains
those entries. I think that&#39;s Windows XP or later. But in any case, all
it is doing is ignoring an entry that has an ip address of 0.0.0.0. That
can never be a valid active network connection, so if the code gets
executed it will always be correct to ignore that entry.

 Sidney Markowitz <span class="clickylink"><a target="new" rel="nofollow" href="http://www.sidney.com/">http://www.sidney.com/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;25&nbsp;22:58:18&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Sidney Markowitz</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Olaf, I&#39;m not sure if this should be in a separate bug report, but I
found what I think is a bug in send_udp while looking at code related to
this.

In Net::DNS::Resolver::Base-&gt;send_udp the code contains nested loops,
the outer one looping through all the nameservers, the inner loop
processing replies from the nameserver, looking like this &#40;in pseudo code&#41;:

loop through all nameservers
 @ready = $sel-&gt;can_read&#40;$timeout&#41; # wait for replies or timeout
 loop through the received packets
     skip over any packets with qr not set or wrong ID
 end inner loop
end outer loop

The problem I&#39;m seeing is that it is not uncommon for a query to a
nameserver to time out before the reply comes back, then there is
another query from the same UDP port, then the first reply arrives. If,
as is usually the case, the ID of the old reply doesn&#39;t match the ID of
the second query, the reply packet is rejected &#40;which is correct&#41; but
the inner loop exits never having received the real reply. That causes
the real reply to be dropped. Actually it makes it more likely that the
real reply will show up when there is a listener to yet another query,
causing that one to be lost and the cycle continues.

The symptom is that in a high volume situation some DNS queries are
getting a &#39;query timed out&#39; error before the timeout period has passed.
My ISP is seeing that happen regularly, in perhaps 0.1% of the queries
in something that they are running.

The fix would be to keep running the inner loop until either a packet
for the right query is received &#40;as determined by the ID&#41; or the
timeout. In pseudocode that could be

loop through all nameservers
 my $found_reply = FALSE;
 until &#40;$found_reply || timed out&#41; {
   @ready = $sel-&gt;can_read&#40;$timeout&#41; # wait for replies or timeout
   loop through the received packets
     skip over any packets with qr not set or wrong ID
     $found_reply = TRUE;
   end inner loop
 } # end the until loop
end outer loop

  Sidney Markowitz <span class="clickylink"><a target="new" rel="nofollow" href="http://www.sidney.com/">http://www.sidney.com/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;25&nbsp;23:13:35&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Sidney Markowitz</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Slight correction to my pseudocode:

Since the inner loop either skips to the next iteration of the inner
loop or skips to the next iteration of the outer loop, or returns from
the function, there is no need to use the $found_reply variable. You
will always exit out of there if a reply is found. So you can elminate
the $found_reply variable completely and just wrap the can_read and the
inner loop with 

 until &#40;timed out&#41; { # inner loop exits this early if it finds an answer
 [...]
 }

  Sidney Markowitz <span class="clickylink"><a target="new" rel="nofollow" href="http://www.sidney.com/">http://www.sidney.com/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;25&nbsp;23:25:07&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Sidney Markowitz</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry for the multiple posts, but I see that a patch would be really simple.

In send_udp just insert two lines in between 

    my @ready = $sel-&gt;can_read&#40;$timeout&#41;;

    SELECTOR: foreach my $ready &#40;@ready&#41; {

so it says

   my @ready = $sel-&gt;can_read&#40;$timeout&#41;;
   my $now = time;
   until &#40;$stop_time &#38;&#38; &#40;$stop_time &lt; $now&#41;&#41; {
    SELECTOR: foreach my $ready &#40;@ready&#41; {

and add a close brace after the one that matches the foreach.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;26&nbsp;09:46:01&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Sidney Markowitz</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[I wrote - Wed May 25 23:25:07 2005]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;    my @ready = $sel-&gt;can_read&#40;$timeout&#41;;
&gt;    my $now = time;
&gt;    until &#40;$stop_time &#38;&#38; &#40;$stop_time &lt; $now&#41;&#41; {
&gt;     SELECTOR: foreach my $ready &#40;@ready&#41; {
</div>
And of course that is a recipe for an infinite loop and should be

   my $now = time;
   until &#40;$stop_time &#38;&#38; &#40;$stop_time &lt; $now&#41;&#41; {
    my @ready = $sel-&gt;can_read&#40;$timeout&#41;;
    SELECTOR: foreach my $ready &#40;@ready&#41; {
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;27&nbsp;17:44:21&nbsp;2005</span>
    <span class="description">olaf [...] dacht.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 27 May 2005 23:44:02 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Olaf M. Kolkman&#34; &lt;olaf [...] dacht.net&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #11931] Wrong nameserver list handling in Net::DNS::Resolver::Win32</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Guest via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;This message about Net-DNS was sent to you by guest &lt;&gt; via rt.cpan.org
&gt;
&gt;Full context and any attached attachments can be found at:
&gt;&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=11931">https://rt.cpan.org/Ticket/Display.html?id=11931</a></span> &gt;
&gt;
&gt;[I wrote - Wed May 25 23:25:07 2005]:
&gt;  
&gt;
<div class="message-stanza open">&gt;&gt;   my @ready = $sel-&gt;can_read&#40;$timeout&#41;;
&gt;&gt;   my $now = time;
&gt;&gt;   until &#40;$stop_time &#38;&#38; &#40;$stop_time &lt; $now&#41;&#41; {
&gt;&gt;    SELECTOR: foreach my $ready &#40;@ready&#41; {
&gt;&gt;    
&gt;&gt;
</div>&gt;
&gt;And of course that is a recipe for an infinite loop and should be
&gt;
&gt;   my $now = time;
&gt;   until &#40;$stop_time &#38;&#38; &#40;$stop_time &lt; $now&#41;&#41; {
&gt;    my @ready = $sel-&gt;can_read&#40;$timeout&#41;;
&gt;    SELECTOR: foreach my $ready &#40;@ready&#41; {
&gt;  
&gt;
</div>

Still a recipy for infinity as $now is a constant after entering the 
loop :-&#41; .... but that is easilly fixed by writing

   until &#40;$stop_time &#38;&#38; &#40;$stop_time &lt; time&#41;&#41; {


Still this is not the perfect solution because if you use this you will 
wait untill you have completely timed out all your nameservers while
essentially you will have to wait untill the &#34;$timeout&#34; that is 
allocated to this particular server &#40;which is a fraction of the 
$stop_time in order to allow alternative servers to be contacted as well 
if one fails&#41;.

I think this will do

                        my $oldpacket_timeout=time+$timeout;
                        until &#40; $oldpacket_timeout &#38;&#38; 
&#40;$oldpacket_timeout &lt; time&#40;&#41;&#41;&#41; {

This code now lives on the trunk...


--Olaf
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;11&nbsp;14:27:13&nbsp;2005</span>
    <span class="description">OLAF [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;01&nbsp;19:46:14&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Orjan</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Using Net-DNS 0.53 on Win XP, it is unable to retrieve the nameservers 
when the IP address of the interface is assigned by DHCP.
This is due to the DHCP assigned IP address being stored in 
DhcpIPAddress rather than IPAddress &#40;which is then 0.0.0.0&#41;.
Adding a check of DhcpIPAddress existance and not being 0.0.0.0 fixes 
the problem.

Replace the code:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; In Win32.pm it looks like
&gt; 
&gt;  if &#40;$regiface&#41; {
&gt;   my $ns;
&gt;   my $type;
&gt;   my $ip;
&gt;   $regiface-&gt;QueryValueEx&#40;&#34;IPAddress&#34;, $type, $ip&#41;;
&gt;   if &#40;$ip &#38;&#38; !&#40;$ip =~ /0\.0\.0\.0/&#41;&#41; {
&gt;   # NameServer overrides DhcpNameServer if both exist
&gt;   $regiface-&gt;QueryValueEx&#40;&#34;NameServer&#34;, $type, $ns&#41;;
&gt;   $regiface-&gt;QueryValueEx&#40;&#34;DhcpNameServer&#34;, $type, $ns&#41; unless $ns;
&gt;   $nameservers .= &#34; $ns&#34; if $ns;
&gt;   }
&gt;  }
&gt; 
</div>
with:

if &#40;$regiface&#41; {
 my $ns;
 my $type;
 my $ip;
 my $ipdhcp;
 $regiface-&gt;QueryValueEx&#40;&#34;IPAddress&#34;, $type, $ip&#41;;
 $regiface-&gt;QueryValueEx&#40;&#34;DhcpIPAddress&#34;, $type, $ipdhcp&#41;;
 if &#40;&#40;$ip &#38;&#38; !&#40;$ip =~ /0\.0\.0\.0/&#41;&#41; || &#40;$ipdhcp &#38;&#38; !&#40;$ipdhcp =~ /0\.0
\.0\.0/&#41;&#41;&#41; {
  # NameServer overrides DhcpNameServer if both exist
  $regiface-&gt;QueryValueEx&#40;&#34;NameServer&#34;, $type, $ns&#41;;
  $regiface-&gt;QueryValueEx&#40;&#34;DhcpNameServer&#34;, $type, $ns&#41; unless $ns;
  $nameservers .= &#34; $ns&#34; if $ns;
 }
}

and it works with DHCP assigned addresses as well.
I expect the corresponding fix would be needed for Cygwin.pm as well.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;01&nbsp;19:46:15&nbsp;2005</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;15&nbsp;08:05:34&nbsp;2005</span>
    <span class="description">OLAF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I applied the patch supplied by &#34;Orjan&#34;  on Win32.pm. 

As long as there is no reliable and portable way to determine the IP I&#39;m stalling this ticket again.

--Olaf
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;15&nbsp;08:05:35&nbsp;2005</span>
    <span class="description">OLAF [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;19&nbsp;13:58:36&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have attached a patch that makes bgsend query all nameservers. That
resolves the issue for my situation but I feel that it might not be the
best way to do it.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: Base.pm
===================================================================
--- Base.pm	&#40;revision 7602&#41;
+++ Base.pm	&#40;working copy&#41;
@@ -981,65 +981,75 @@
 	my $srcport = $self-&gt;{&#39;srcport&#39;};
 
 
-	my &#40;@res, $sockfamily, $dst_sockaddr&#41;;
-	my $ns_address = &#40;$self-&gt;nameservers&#40;&#41;&#41;[0];
+	# my &#40;@res, $sockfamily, $dst_sockaddr&#41;;
+	my @destinations;
+	my @nameservers = $self-&gt;nameservers&#40;&#41;;
 	my $dstport = $self-&gt;{&#39;port&#39;};
 
-
-	# The logic below determines ther $dst_sockaddr.
-	# If getaddrinfo is available that is used for both INET4 and INET6
-	# If getaddrinfo is not avialable &#40;Socket6 failed to load&#41; we revert
-	# to the &#39;classic mechanism
-	if &#40;$has_inet6  &#38;&#38; ! $self-&gt;force_v4&#40;&#41;&#41;{ 
-
-	    my &#40; $socktype_tmp, $proto_tmp, $canonname_tmp&#41;;
-
-	    no strict &#39;subs&#39;;   # Because of the eval statement in the BEGIN
-	                      # AI_NUMERICHOST is not available at compile time.
-
-	    # The AI_NUMERICHOST surpresses lookups.
-	    my @res = getaddrinfo&#40;$ns_address, $dstport, AF_UNSPEC, SOCK_DGRAM,
-				  0 , AI_NUMERICHOST&#41;;
-
-	    use strict &#39;subs&#39;;
-
-	    &#40;$sockfamily, $socktype_tmp, 
-	     $proto_tmp, $dst_sockaddr, $canonname_tmp&#41; = @res;
-
-	    if &#40;scalar&#40;@res&#41; &lt; 5&#41; {
-		die &#40;&#34;can&#39;t resolve \&#34;$ns_address\&#34; to address &#40;it could have been an IP address&#41;&#34;&#41;;
-	    }
-
-	}else{
-	    $sockfamily=AF_INET;
-	    
-	    if &#40;! ip_is_ipv4&#40;$ns_address&#41;&#41;{
-		$self-&gt;errorstring&#40;&#34;bgsend&#40;ipv4 only&#41;:$ns_address does not seem to be a valid IPv4 address&#34;&#41;;
-		return;
-	    }
-
-	    $dst_sockaddr = sockaddr_in&#40;$dstport, inet_aton&#40;$ns_address&#41;&#41;;
-	}
+  foreach my $ns_address &#40;@nameservers&#41;{
+  	# The logic below determines ther $dst_sockaddr.
+  	# If getaddrinfo is available that is used for both INET4 and INET6
+  	# If getaddrinfo is not avialable &#40;Socket6 failed to load&#41; we revert
+  	# to the &#39;classic mechanism
+  	if &#40;$has_inet6  &#38;&#38; ! $self-&gt;force_v4&#40;&#41;&#41;{ 
+  
+  	    my &#40; $socktype_tmp, $proto_tmp, $canonname_tmp&#41;;
+  
+  	    no strict &#39;subs&#39;;   # Because of the eval statement in the BEGIN
+  	                      # AI_NUMERICHOST is not available at compile time.
+  
+  	    # The AI_NUMERICHOST surpresses lookups.
+  	    my @res = getaddrinfo&#40;$ns_address, $dstport, AF_UNSPEC, SOCK_DGRAM,
+  				  0 , AI_NUMERICHOST&#41;;
+  
+  	    use strict &#39;subs&#39;;
+  
+  	    my &#40;$sockfamily, $socktype_tmp, 
+  	     $proto_tmp, $dst_sockaddr, $canonname_tmp&#41; = @res;
+  	     
+  	    push @destinations, {&#39;ns_address&#39; =&gt; $ns_address,
+                             &#39;sockfamily&#39; =&gt; $sockfamily,
+                             &#39;dst_sockaddr&#39; =&gt; $dst_sockaddr};
+  
+  	    if &#40;scalar&#40;@res&#41; &lt; 5&#41; {
+  		die &#40;&#34;can&#39;t resolve \&#34;$ns_address\&#34; to address &#40;it could have been an IP address&#41;&#34;&#41;;
+  	    }
+  
+  	}else{
+  	    my $sockfamily=AF_INET;
+  	    
+  	    if &#40;! ip_is_ipv4&#40;$ns_address&#41;&#41;{
+  		$self-&gt;errorstring&#40;&#34;bgsend&#40;ipv4 only&#41;:$ns_address does not seem to be a valid IPv4 address&#34;&#41;;
+  		return;
+  	    }
+  
+  	    push @destinations, {&#39;dst_sockaddr&#39; =&gt; scalar&#40;sockaddr_in&#40;$dstport, inet_aton&#40;$ns_address&#41;&#41;&#41;, 
+                            &#39;sockfamily&#39; =&gt; $sockfamily,
+                            &#39;ns_address&#39; =&gt; $ns_address};
+  	}
+  }
+	
+	
 	my @socket;  
 
-	if &#40;$sockfamily == AF_INET&#41; {
-	    $socket[$sockfamily] = IO::Socket::INET-&gt;new&#40;
+	if &#40;$destinations[0]{&#39;sockfamily&#39;} == AF_INET&#41; {
+	    $socket[$destinations[0]{&#39;sockfamily&#39;}] = IO::Socket::INET-&gt;new&#40;
 							 Proto =&gt; &#39;udp&#39;,
 							 Type =&gt; SOCK_DGRAM,
 							 LocalAddr =&gt; $srcaddr,
 							 LocalPort =&gt; &#40;$srcport || undef&#41;,
 					    &#41;;
-	} elsif &#40;$has_inet6 &#38;&#38; $sockfamily == AF_INET6&#40;&#41; &#41; {
+	} elsif &#40;$has_inet6 &#38;&#38; $destinations[0]{&#39;sockfamily&#39;} == AF_INET6&#40;&#41; &#41; {
 	    # Otherwise the INET6 socket will just fail
 	    my $srcaddr6 = $srcaddr eq &#34;0.0.0.0&#34; ? &#39;::&#39; : $srcaddr;
-	    $socket[$sockfamily] = IO::Socket::INET6-&gt;new&#40;
+	    $socket[$destinations[0]{&#39;sockfamily&#39;}] = IO::Socket::INET6-&gt;new&#40;
 							  Proto =&gt; &#39;udp&#39;,
 							  Type =&gt; SOCK_DGRAM,
 							  LocalAddr =&gt; $srcaddr6,
 							  LocalPort =&gt; &#40;$srcport || undef&#41;,
 					     &#41;;
 	} else {
-	    die ref&#40;$self&#41;.&#34; bgsend:Unsoported Socket Family: $sockfamily&#34;;
+	    die ref&#40;$self&#41;.&#34; bgsend:Unsoported Socket Family: $destinations[0]{&#39;sockfamily&#39;}&#34;;
 	}
 	
 	unless &#40;scalar&#40;@socket&#41;&#41; {
@@ -1047,17 +1057,23 @@
 		return;
 	}
 
-	print &#34;;; bgsend&#40;$ns_address : $dstport&#41;\n&#34; if $self-&gt;{&#39;debug&#39;}	;
-
 	foreach my $socket &#40;@socket&#41;{
 	    next if !defined $socket;
 	    
-	    unless &#40;$socket-&gt;send&#40;$packet_data,0,$dst_sockaddr&#41;&#41;{
-		my $err = $!;
-		print &#34;;; send ERROR&#40;$ns_address&#41;: $err\n&#34; if $self-&gt;{&#39;debug&#39;};
-		
-		$self-&gt;errorstring&#40;&#34;Send: &#34;.$err&#41;;
-		return;
+	    foreach my $destination &#40;@destinations&#41;{
+	    
+	    my $ns_address = $destination-&gt;{&#39;ns_address&#39;};
+	    print &#34;;; bgsend&#40;$ns_address : $dstport&#41;\n&#34; if $self-&gt;{&#39;debug&#39;}	;
+	    
+        if&#40;@socket[$destination-&gt;{&#39;sockfamily&#39;}] == $socket&#41;{	    
+          unless &#40;$socket-&gt;send&#40;$packet_data,0,$destination-&gt;{&#39;dst_sockaddr&#39;}&#41;&#41;{
+            	my $err = $!;
+            	print &#34;;; send ERROR&#40;$ns_address&#41;: $err\n&#34; if $self-&gt;{&#39;debug&#39;};
+            	
+            	$self-&gt;errorstring&#40;&#34;Send: &#34;.$err&#41;;
+            	return;
+          }
+        }
 	    }
 	    return $socket;
 	}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;19&nbsp;13:58:39&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;19&nbsp;16:01:17&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Hanno Stock &lt;hanno.stock [...] gmx.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here is a patch that retrieves information about the
DNS resolution order from the registry.

Windows has a sorted list of the interfaces for seperate
services. &#40;Actually for DNS it is &#34;Bind&#34; in the registry.&#41;

With this patch, the nameservers are sorted according to
this ordered list.

AFAIR there is a UI option in Windows somewhere.

This works only under Win2k/XP, AFAIK. If the registry key
is not present it will fall back to the default &#40;unsorted&#41;
behavior.

&#40;Previous patch is mine also - if you want to contact me&#41;

The issue came up when working on Slimserver &#40;www.slimdevices.com&#41;
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: G:/Programme/SlimServer/server/CPAN/Net/DNS/Resolver/Win32.pm
===================================================================
--- G:/Programme/SlimServer/server/CPAN/Net/DNS/Resolver/Win32.pm	&#40;revision 7602&#41;
+++ G:/Programme/SlimServer/server/CPAN/Net/DNS/Resolver/Win32.pm	&#40;revision 7605&#41;
@@ -14,10 +14,15 @@
 use Win32::Registry;
 
 sub init {
+  
 	my &#40;$class&#41; = @_;
 	
 	my $defaults = $class-&gt;defaults;
 	
+	# my $self = bless&#40;{ %{$class-&gt;defaults} }, $class&#41;;
+	# 
+	# $self-&gt;{&#39;debug&#39;} = 1;
+	
 	my &#40;$resobj, %keys&#41;;
 
 	my $root = &#39;SYSTEM\CurrentControlSet\Services\Tcpip\Parameters&#39;;
@@ -83,13 +88,33 @@
 #	}
 
 
+  my $bind_linkage;
+  my @sorted_interfaces;
+  print &#34;;; DNS: Getting sorted interface list\n&#34; if $self-&gt;{&#39;debug&#39;};
+  $main::HKEY_LOCAL_MACHINE-&gt;Open&#40;&#39;SYSTEM\CurrentControlSet\Services\Tcpip\Linkage&#39;,
+   $bind_linkage&#41;;
+  if&#40;$bind_linkage&#41;{
+    my $bind_linkage_list;
+    my $type;
+    $bind_linkage-&gt;QueryValueEx&#40;&#39;Bind&#39;, $type, $bind_linkage_list&#41;;
+    if&#40;$bind_linkage_list&#41;{
+      @sorted_interfaces = split&#40;m/[^\w{}\\-]+/s, $bind_linkage_list&#41;;
+    }
+    foreach my $interface &#40;@sorted_interfaces&#41;{
+      $interface =~ s/^\\device\\//i;
+      print &#34;;; DNS:Interface: $interface\n&#34; if $self-&gt;{&#39;debug&#39;};
+    }
+  }
 
-
 	my $interfaces;
 	$resobj-&gt;Open&#40;&#34;Interfaces&#34;, $interfaces&#41;;
 	if &#40;$interfaces&#41; {
 	    my @ifacelist;
-	    $interfaces-&gt;GetKeys&#40;\@ifacelist&#41;;
+	    if&#40;@sorted_interfaces&#41;{
+	       @ifacelist = @sorted_interfaces;
+	    }else{
+         $interfaces-&gt;GetKeys&#40;\@ifacelist&#41;;
+      }
 	    foreach my $iface &#40;@ifacelist&#41; {
 		my $regiface;
 		$interfaces-&gt;Open&#40;$iface, $regiface&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;22&nbsp;07:50:19&nbsp;2006</span>
    <span class="description">hanno.stock [...] gmx.net -  Cc HANSTO added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;22&nbsp;17:15:46&nbsp;2006</span>
    <span class="description">OLAF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri May 19 13:58:36 2006, guest wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have attached a patch that makes bgsend query all nameservers. That
&gt; resolves the issue for my situation but I feel that it might not be the
&gt; best way to do it.
</div>

Would you be so kind to create a new ticket for this particular issue.

I do not know how to split a single message with attachement  from a thread and create a new 
ticket from it and preserve the e-mail of the sender within rt.

As far as the substance goes. I have to study this patch a bit.

--Olaf
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;22&nbsp;17:21:05&nbsp;2006</span>
    <span class="description">OLAF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri May 19 16:01:17 2006, guest wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Here is a patch that retrieves information about the
&gt; DNS resolution order from the registry.
&gt; 
&gt; Windows has a sorted list of the interfaces for seperate
&gt; services. &#40;Actually for DNS it is &#34;Bind&#34; in the registry.&#41;
&gt; 
&gt; With this patch, the nameservers are sorted according to
&gt; this ordered list.
&gt; 
&gt; AFAIR there is a UI option in Windows somewhere.
&gt; 
&gt; This works only under Win2k/XP, AFAIK. If the registry key
&gt; is not present it will fall back to the default &#40;unsorted&#41;
&gt; behavior.
&gt; 
&gt; &#40;Previous patch is mine also - if you want to contact me&#41;
&gt; 
&gt; The issue came up when working on Slimserver &#40;www.slimdevices.com&#41;
</div>
For this part of the thread I applied the patch and did rudimentary testing.  I basically have 
no clue about the XP registry. So I have a question,

Except for the hex codes, that indicate the interfaces &#40;what do these codes contain?&#41; there is 
one entry NdisWANIP in the Interface list. Which one is that.

I did apply the patch, it looked pretty solid and passed the rudimentary tests &#40;and did not 
break the resolver&#41;. The patch now lives on the trunk.

--Olaf
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;22&nbsp;17:47:40&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mo. 22. Mai 2006, 17:21:05, OLAF wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Except for the hex codes, that indicate the interfaces &#40;what do these
&gt; codes contain?&#41; there is
&gt; one entry NdisWANIP in the Interface list. Which one is that.
</div>
The codes are just genuine identifiers and hold no additional
information. AFAIK the NdisWANIP interface is used for the
&#34;DialupNetworking&#34; component of windows.

BTW, I have submitted a wrapper for GetNetworkParams&#40;&#41; to the author of
Win32::IPHelper.

The use of this function was discussed above. It&#39;s much more consistent
between windows versions and might as well be more &#34;future safe&#34;.

For more information see:
<span class="clickylink"><a target="new" rel="nofollow" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/iphlp/iphlp/getnetworkparams.asp">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/iphlp/iphlp/getnetworkparams.asp</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;16&nbsp;08:54:03&nbsp;2006</span>
    <span class="description">hanno.stock [...] gmx.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mo. 21. Mr. 2005, 08:45:24, OLAF wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The reliable way to get the information is through the
&gt; getNetworkParams&#40;&#41; API call in IpHlpApi.dll.  That call works as off
&gt; 95-met-de-WINSOCK2-fix.
&gt; &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-">http://msdn.microsoft.com/library/default.asp?url=/library/en-</a></span>
&gt; us/iphlp/iphlp/getnetworkparams.asp&#41;
&gt; 
&gt; One could probably call this function through the use of Win32::API,
&gt; the
&gt;   getNetworkParams function is similar to calls in Win32::IPhelper.
</div>
getNetworkParams&#40;&#41; is now included in Win32::IPHelper. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;16&nbsp;10:39:05&nbsp;2006</span>
    <span class="description">olaf [...] dacht.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #11931] Wrong nameserver list handling in Net::DNS::Resolver::Win32</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 16 Jun 2006 16:38:35 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Olaf M. Kolkman&#34; &lt;olaf [...] dacht.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hanno Stock via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-DNS
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=11931">http://rt.cpan.org/Ticket/Display.html?id=11931</a></span> &gt;
&gt;
&gt; On Mo. 21. Mr. 2005, 08:45:24, OLAF wrote:
&gt;   
<div class="message-stanza open">&gt;&gt; The reliable way to get the information is through the
&gt;&gt; getNetworkParams&#40;&#41; API call in IpHlpApi.dll.  That call works as off
&gt;&gt; 95-met-de-WINSOCK2-fix.
&gt;&gt; &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-">http://msdn.microsoft.com/library/default.asp?url=/library/en-</a></span>
&gt;&gt; us/iphlp/iphlp/getnetworkparams.asp&#41;
&gt;&gt;
&gt;&gt; One could probably call this function through the use of Win32::API,
&gt;&gt; the
&gt;&gt;   getNetworkParams function is similar to calls in Win32::IPhelper.
&gt;&gt;     
</div>&gt;
&gt; getNetworkParams&#40;&#41; is now included in Win32::IPHelper. 
&gt;   
</div>
Hmmm.... is that lib generally available on win32 perl installations?
&#40;The only perl for win32 I am aware off is active perl&#41;



--Olaf
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;16&nbsp;14:17:33&nbsp;2006</span>
    <span class="description">hanno.stock [...] gmx.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">ActiveState contains Win32::IPhelper, however not yet the new version
0.05. As Win32::IPHelper is pure perl, the new version should be there
soon. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;04&nbsp;03:23:19&nbsp;2006</span>
    <span class="description">OLAF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jun 16 14:17:33 2006, HANSTO wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ActiveState contains Win32::IPhelper, however not yet the new version
&gt; 0.05. As Win32::IPHelper is pure perl, the new version should be there
&gt; soon. 
</div>

In that case I will not take any action yet. I&#39;ll stall this ticket.

Will you poke me when the library is available in Active X, then I will look into this matter 
further?

OK?

--Olaf
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;04&nbsp;03:23:20&nbsp;2006</span>
    <span class="description">OLAF [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;24&nbsp;09:15:20&nbsp;2008</span>
    <span class="description">obasharov [...] auragan.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #11931] Wrong nameserver list handling in Net::DNS::Resolver::Win32</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 24 Feb 2008 19:13:11 +0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Oscar Basharov &lt;obasharov [...] auragan.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

I suggest to exclude the patch by Hanno Stock from Win32.pm becasue in some cases
&#39;HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Linkage\Bind&#39; exists, but
doesn&#39;t contain some of actual network interfaces &#40;WinXP SP2, ppp interfaces&#41;,
as result, some of the DNS server&#39;s addresses will not be obtained. 

Additionally, if first DNS server will report &#34;NXDOMAIN&#34; the resolve process will stop on this, 
even if other DNS servers can resolve the given domain name.
I would suggest to remove &#39;$ans-&gt;header-&gt;rcode ne &#34;NXDOMAIN&#34;&#39; condition from send_tcp&#40;&#41; and send_udp&#40;&#41; in Base.pm,
this would clear the issue.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;24&nbsp;09:15:21&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;24&nbsp;11:13:21&nbsp;2008</span>
    <span class="description">hanno.stock [...] gmx.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> hanno.stock [...] gmx.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On So. 24. Feb. 2008, 09:15:20, obasharov@auragan.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hello,
&gt; 
&gt; I suggest to exclude the patch by Hanno Stock from Win32.pm becasue in
&gt; some cases
&gt; &#39;HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Linkage\Bind&#39; exists,
&gt; but
&gt; doesn&#39;t contain some of actual network interfaces &#40;WinXP SP2, ppp
&gt; interfaces&#41;,
&gt; as result, some of the DNS server&#39;s addresses will not be obtained.
</div>
As mentioned earlier a call to getNetworkParams&#40;&#41; is a more reliable way
to obtain the DNS servers. A wrapper using Win32::API is already in
Win32::IPHelper as of version 0.05. This version is now also included in
the ActiveState PPM repositories.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;25&nbsp;11:57:07&nbsp;2008</span>
    <span class="description">olaf [...] dacht.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #11931] Wrong nameserver list handling in Net::DNS::Resolver::Win32</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 25 Feb 2008 17:56:41 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Olaf Kolkman &lt;olaf [...] dacht.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On Feb 24, 2008, at 3:15 PM, Oscar Basharov via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; Additionally, if first DNS server will report &#34;NXDOMAIN&#34; the resolve  
&gt; process will stop on this,
&gt; even if other DNS servers can resolve the given domain name.
</div>

NXDOMAIN is a perfectly valid response to a query. There is no reason  
to hunt for another answer.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I would suggest to remove &#39;$ans-&gt;header-&gt;rcode ne &#34;NXDOMAIN&#34;&#39;  
&gt; condition from send_tcp&#40;&#41; and send_udp&#40;&#41; in Base.pm,
&gt; this would clear the issue.
</div>


--Olaf
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;22&nbsp;16:34:54&nbsp;2008</span>
    <span class="description">OLAF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">

As of Revision 751, just checked in on the trunk, we use WIN32::IPHelper, the availability and 
functionality is available under ActivePerl and Strawberry perl.

I&#39;ve only tested on an XP environment.

For the searchlist we still remain on the registry readings, but don&#39;t croak if we are not able to 
get them.

Closing ticket...
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;22&nbsp;16:34:55&nbsp;2008</span>
    <span class="description">OLAF [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
