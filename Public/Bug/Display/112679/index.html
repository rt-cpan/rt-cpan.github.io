<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #112679 for Catalyst-Plugin-Session-Store-DBIC: Error calling $c-&gt;change_session_id &#40;patch included&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #112679 for Catalyst-Plugin-Session-Store-DBIC: Error calling $c-&gt;change_session_id &#40;patch included&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Catalyst-Plugin-Session-Store-DBIC/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Catalyst-Plugin-Session-Store-DBIC/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Catalyst-Plugin-Session-Store-DBIC/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Catalyst-Plugin-Session-Store-DBIC/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Catalyst-Plugin-Session-Store-DBIC">Catalyst-Plugin-Session-Store-DBIC CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">112679</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Catalyst-Plugin-Session-Store-DBIC/Active/">Catalyst-Plugin-Session-Store-DBIC</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ceeshek [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-38630-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.14    </td>
  </tr>
  <tr id="CF-38631-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;03&nbsp;14:23:04&nbsp;2016</span>
    <span class="description">cees-perl [...] crtconsulting.ca -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Error calling $c-&gt;change_session_id &#40;patch included&#41;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
The DBIC session store plugin errors out with the following message when calling $c-&gt;change_session_id:

ERROR - Caught exception in engine &#34;DBIx::Class::Row::update&#40;&#41;: Can&#39;t update MyApp::Model::DB::Session=HASH&#40;0x7f8f3d4f5c20&#41;: row not found at ~/perl5/perlbrew/perls/perl-5.20.2/lib/site_perl/5.20.2/Catalyst/Plugin/Session/Store/DBIC/Delegate.pm line 124&#34;

I have attached a patch to fix the problem, which includes a new set of tests that can be used to recreate the issue.

The problem occurs when the old session is deleted, but the Delegate object keeps an old copy of the DBIx::Class row object in an accessor and continues to use that old object.  This means the cached object keeps it&#39;s old session ID, and when it tries to flush to the database, since the -&gt;in_storage flag for the row is still set to true, it attempts an update of the row in the database which fails.

The fix is simple.  When asking for the row object, check to make sure that the row object that is cached matches the session ID that is being requested.  This just requires a small change to the &#39;session&#39; method in Catalyst/Plugin/Session/Store/DBIC/Delegate.pm.

I would have provided a pull request through github, but it looks like the distribution there is out of date.  I hope a patch is acceptable.

Cheers,

Cees Hek
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Catalyst-Plugin-Session-Store-DBIC-0.14.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Only in Catalyst-Plugin-Session-Store-DBIC-0.14: MANIFEST
Only in Catalyst-Plugin-Session-Store-DBIC-0.14: META.yml
Only in Catalyst-Plugin-Session-Store-DBIC-0.14: MYMETA.json
diff -ru Catalyst-Plugin-Session-Store-DBIC-0.14/lib/Catalyst/Plugin/Session/Store/DBIC/Delegate.pm Catalyst-Plugin-Session-Store-DBIC-0.14.patched/lib/Catalyst/Plugin/Session/Store/DBIC/Delegate.pm
--- Catalyst-Plugin-Session-Store-DBIC-0.14/lib/Catalyst/Plugin/Session/Store/DBIC/Delegate.pm	2013-07-27 04:33:16.000000000 -0400
+++ Catalyst-Plugin-Session-Store-DBIC-0.14.patched/lib/Catalyst/Plugin/Session/Store/DBIC/Delegate.pm	2016-03-03 13:52:59.000000000 -0500
@@ -31,7 +31,7 @@
 
     my $row = $self-&gt;_session_row;
 
-    unless &#40;$row&#41; {
+    if &#40;not $row or $row-&gt;id ne $key&#41; {
         $row = $self-&gt;_load_row&#40;$key&#41;;
         $self-&gt;_session_row&#40;$row&#41;;
     }
diff -ru Catalyst-Plugin-Session-Store-DBIC-0.14/t/05dbic-schema.t Catalyst-Plugin-Session-Store-DBIC-0.14.patched/t/05dbic-schema.t
--- Catalyst-Plugin-Session-Store-DBIC-0.14/t/05dbic-schema.t	2013-07-27 04:33:16.000000000 -0400
+++ Catalyst-Plugin-Session-Store-DBIC-0.14.patched/t/05dbic-schema.t	2016-03-03 13:55:22.000000000 -0500
@@ -21,7 +21,7 @@
     eval { require Catalyst::Model::DBIC::Schema }
         or plan skip_all =&gt; &#34;Catalyst::Model::DBIC::Schema is required for this test&#34;;
 
-    plan tests =&gt; 14;
+    plan tests =&gt; 21;
 
     $TestApp::DB_FILE = &#34;$FindBin::Bin/session.db&#34;;
 
@@ -64,6 +64,16 @@
 $mech-&gt;get_ok&#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/session/output?key=$key">http://localhost/session/output?key=$key</a></span>&#34;, &#39;request to get session value&#39;&#41;;
 $mech-&gt;content_is&#40;$value, &#39;got session value back&#39;&#41;;
 
+# Check change_session_id
+$mech-&gt;get_ok&#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/session/sessionid">http://localhost/session/sessionid</a></span>&#34;, &#39;request current session ID&#39;&#41;;
+my $sid = $mech-&gt;content;
+$mech-&gt;get_ok&#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/session/change">http://localhost/session/change</a></span>&#34;, &#39;request to change session ID&#39;&#41;;
+$mech-&gt;content_is&#40;&#39;ok&#39;, &#39;successful&#39;&#41;;
+$mech-&gt;get_ok&#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/session/sessionid">http://localhost/session/sessionid</a></span>&#34;, &#39;request current session ID&#39;&#41;;
+ok&#40;$mech-&gt;content ne $sid, &#39;got a new session ID&#39;&#41;;
+$mech-&gt;get_ok&#40;&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/session/output?key=$key">http://localhost/session/output?key=$key</a></span>&#34;, &#39;request to get session value&#39;&#41;;
+$mech-&gt;content_is&#40;$value, &#39;got session value back&#39;&#41;;
+
 # Exceed our session storage capactity
 $value = &#34;blah&#34; x 200;
 warnings_exist {
diff -ru Catalyst-Plugin-Session-Store-DBIC-0.14/t/lib/TestApp/Controller/Session.pm Catalyst-Plugin-Session-Store-DBIC-0.14.patched/t/lib/TestApp/Controller/Session.pm
--- Catalyst-Plugin-Session-Store-DBIC-0.14/t/lib/TestApp/Controller/Session.pm	2013-07-27 04:33:16.000000000 -0400
+++ Catalyst-Plugin-Session-Store-DBIC-0.14.patched/t/lib/TestApp/Controller/Session.pm	2016-03-03 13:54:33.000000000 -0500
@@ -22,6 +22,22 @@
     $c-&gt;res-&gt;body&#40;$c-&gt;session-&gt;{$key}&#41;;
 }
 
+sub change : Local {
+    my &#40;$self, $c&#41; = @_;
+
+    my $oldsid = $c-&gt;sessionid;
+    $c-&gt;change_session_id;
+    my $newsid = $c-&gt;sessionid;
+
+    $c-&gt;res-&gt;body&#40;$oldsid ne $newsid ? &#39;ok&#39; : &#39;not ok&#39;&#41;;
+}
+
+sub sessionid : Local {
+    my &#40;$self, $c&#41; = @_;
+
+    $c-&gt;res-&gt;body&#40;$c-&gt;sessionid&#41;;
+}
+
 sub delete : Local {
     my &#40;$self, $c&#41; = @_;
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;24&nbsp;19:22:33&nbsp;2016</span>
    <span class="description">violapiratejunky [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Bump!!! I would love for this to be fixed.

On Thu Mar 03 14:23:04 2016, CEESHEK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; The DBIC session store plugin errors out with the following message
&gt; when calling $c-&gt;change_session_id:
&gt; 
&gt; ERROR - Caught exception in engine &#34;DBIx::Class::Row::update&#40;&#41;: Can&#39;t
&gt; update MyApp::Model::DB::Session=HASH&#40;0x7f8f3d4f5c20&#41;: row not found
&gt; at ~/perl5/perlbrew/perls/perl-
&gt; 5.20.2/lib/site_perl/5.20.2/Catalyst/Plugin/Session/Store/DBIC/Delegate.pm
&gt; line 124&#34;
&gt; 
&gt; I have attached a patch to fix the problem, which includes a new set
&gt; of tests that can be used to recreate the issue.
&gt; 
&gt; The problem occurs when the old session is deleted, but the Delegate
&gt; object keeps an old copy of the DBIx::Class row object in an accessor
&gt; and continues to use that old object.  This means the cached object
&gt; keeps it&#39;s old session ID, and when it tries to flush to the database,
&gt; since the -&gt;in_storage flag for the row is still set to true, it
&gt; attempts an update of the row in the database which fails.
&gt; 
&gt; The fix is simple.  When asking for the row object, check to make sure
&gt; that the row object that is cached matches the session ID that is
&gt; being requested.  This just requires a small change to the &#39;session&#39;
&gt; method in Catalyst/Plugin/Session/Store/DBIC/Delegate.pm.
&gt; 
&gt; I would have provided a pull request through github, but it looks like
&gt; the distribution there is out of date.  I hope a patch is acceptable.
&gt; 
&gt; Cheers,
&gt; 
&gt; Cees Hek
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;24&nbsp;19:22:34&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;24&nbsp;19:52:24&nbsp;2016</span>
    <span class="description">violapiratejunky [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">By the way,

I&#39;ve noticed that your fix works when they are called in this order:

    $c-&gt;delete_session;
    $c-&gt;change_session_id;

But NOT when they are called in this order:
    
    $c-&gt;change_session_id;
    $c-&gt;delete_session;

Thanks for the fix though!

On Thu Mar 03 14:23:04 2016, CEESHEK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; The DBIC session store plugin errors out with the following message
&gt; when calling $c-&gt;change_session_id:
&gt; 
&gt; ERROR - Caught exception in engine &#34;DBIx::Class::Row::update&#40;&#41;: Can&#39;t
&gt; update MyApp::Model::DB::Session=HASH&#40;0x7f8f3d4f5c20&#41;: row not found
&gt; at ~/perl5/perlbrew/perls/perl-
&gt; 5.20.2/lib/site_perl/5.20.2/Catalyst/Plugin/Session/Store/DBIC/Delegate.pm
&gt; line 124&#34;
&gt; 
&gt; I have attached a patch to fix the problem, which includes a new set
&gt; of tests that can be used to recreate the issue.
&gt; 
&gt; The problem occurs when the old session is deleted, but the Delegate
&gt; object keeps an old copy of the DBIx::Class row object in an accessor
&gt; and continues to use that old object.  This means the cached object
&gt; keeps it&#39;s old session ID, and when it tries to flush to the database,
&gt; since the -&gt;in_storage flag for the row is still set to true, it
&gt; attempts an update of the row in the database which fails.
&gt; 
&gt; The fix is simple.  When asking for the row object, check to make sure
&gt; that the row object that is cached matches the session ID that is
&gt; being requested.  This just requires a small change to the &#39;session&#39;
&gt; method in Catalyst/Plugin/Session/Store/DBIC/Delegate.pm.
&gt; 
&gt; I would have provided a pull request through github, but it looks like
&gt; the distribution there is out of date.  I hope a patch is acceptable.
&gt; 
&gt; Cheers,
&gt; 
&gt; Cees Hek
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;29&nbsp;02:40:17&nbsp;2016</span>
    <span class="description">violapiratejunky [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I also realized that this doesn&#39;t work when you call delete_session_data in DBIC.pm. This deletes the row out of the database, but then when DBIC/Delegate.pm is called that row hasn&#39;t been unset and so it tries to update it.

On Sat Sep 24 19:52:24 2016, srchulo wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; By the way,
&gt; 
&gt; I&#39;ve noticed that your fix works when they are called in this order:
&gt; 
&gt;     $c-&gt;delete_session;
&gt;     $c-&gt;change_session_id;
&gt; 
&gt; But NOT when they are called in this order:
&gt;     
&gt;     $c-&gt;change_session_id;
&gt;     $c-&gt;delete_session;
&gt; 
&gt; Thanks for the fix though!
&gt; 
&gt; On Thu Mar 03 14:23:04 2016, CEESHEK wrote:
<div class="message-stanza open">&gt; &gt; 
&gt; &gt; The DBIC session store plugin errors out with the following message
&gt; &gt; when calling $c-&gt;change_session_id:
&gt; &gt; 
&gt; &gt; ERROR - Caught exception in engine &#34;DBIx::Class::Row::update&#40;&#41;: Can&#39;t
&gt; &gt; update MyApp::Model::DB::Session=HASH&#40;0x7f8f3d4f5c20&#41;: row not found
&gt; &gt; at ~/perl5/perlbrew/perls/perl-
&gt; &gt; 5.20.2/lib/site_perl/5.20.2/Catalyst/Plugin/Session/Store/DBIC/Delegate.pm
&gt; &gt; line 124&#34;
&gt; &gt; 
&gt; &gt; I have attached a patch to fix the problem, which includes a new set
&gt; &gt; of tests that can be used to recreate the issue.
&gt; &gt; 
&gt; &gt; The problem occurs when the old session is deleted, but the Delegate
&gt; &gt; object keeps an old copy of the DBIx::Class row object in an accessor
&gt; &gt; and continues to use that old object.  This means the cached object
&gt; &gt; keeps it&#39;s old session ID, and when it tries to flush to the database,
&gt; &gt; since the -&gt;in_storage flag for the row is still set to true, it
&gt; &gt; attempts an update of the row in the database which fails.
&gt; &gt; 
&gt; &gt; The fix is simple.  When asking for the row object, check to make sure
&gt; &gt; that the row object that is cached matches the session ID that is
&gt; &gt; being requested.  This just requires a small change to the &#39;session&#39;
&gt; &gt; method in Catalyst/Plugin/Session/Store/DBIC/Delegate.pm.
&gt; &gt; 
&gt; &gt; I would have provided a pull request through github, but it looks like
&gt; &gt; the distribution there is out of date.  I hope a patch is acceptable.
&gt; &gt; 
&gt; &gt; Cheers,
&gt; &gt; 
&gt; &gt; Cees Hek
</div>&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;29&nbsp;03:02:35&nbsp;2016</span>
    <span class="description">violapiratejunky [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Okay, so I actually think the approach mentioned above in the first comment was wrong. It works for that case, but it doesn&#39;t really solve the issue. The issue is that in DBIC.pm in delete_session_data the session is deleted from the database, but it is not cleared from DBIC/Delegate.pm, so when flush is called on DBIC/Delegate.pm then it tries to update a deleted row. I changed delete_session_data in DBIC.pm to:

sub delete_session_data {
    my &#40;$c, $key&#41; = @_; 

    # expires is stored on the session row for compatibility with Store::DBI
    return if $key =~ /^expires/;

    $c-&gt;session_store_model-&gt;search&#40;{
        $c-&gt;session_store_dbic_id_field =&gt; $key,
    }&#41;-&gt;delete;

    #my additions begin here
    my &#40;$field&#41; = split&#40;&#39;:&#39;, $key&#41;;

    if &#40;$field eq &#39;session&#39;&#41; {
        $c-&gt;_session_store_delegate-&gt;delete_session;
    } elsif &#40;$field eq &#39;flash&#39;&#41; {
        $c-&gt;_session_store_delegate-&gt;delete_flash;
    }   
}


And I added these two methods to DBIC/Delegate.pm:

=head2 delete_session

Deletes the session row LOCALLY for this Delegate &#40;sets the accessor to undef&#41;.

=cut

sub delete_session {
    my &#40;$self, $c&#41; = @_; 
    $self-&gt;_session_row&#40;undef&#41;;
}

=head2 delete_flash

Deletes the flash row LOCALLY for this Delegate &#40;sets the accessor to undef&#41;.

=cut

sub delete_flash {
    my &#40;$self, $c&#41; = @_; 
    $self-&gt;_flash_row&#40;undef&#41;;
}

I&#39;m not sure if you would need to clear any local session or flash rows in DBIC/Delegate.pm if delete_expired_sessions is called in DBIC.pm. However, I think you would need to if any of the deleted expired sessions was the current row in _session_row or _flash_row in DBIC/Delegate.pm.


Please advise if I&#39;m wrong! This seems to work, so this is what I will be using for now. I would love to have this fixed in an update-- it&#39;s getting tricky between me and my teammates to patch modules manually.

On Thu Sep 29 02:40:17 2016, srchulo wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I also realized that this doesn&#39;t work when you call
&gt; delete_session_data in DBIC.pm. This deletes the row out of the
&gt; database, but then when DBIC/Delegate.pm is called that row hasn&#39;t
&gt; been unset and so it tries to update it.
&gt; 
&gt; On Sat Sep 24 19:52:24 2016, srchulo wrote:
<div class="message-stanza open">&gt; &gt; By the way,
&gt; &gt;
&gt; &gt; I&#39;ve noticed that your fix works when they are called in this order:
&gt; &gt;
&gt; &gt; $c-&gt;delete_session;
&gt; &gt; $c-&gt;change_session_id;
&gt; &gt;
&gt; &gt; But NOT when they are called in this order:
&gt; &gt;
&gt; &gt; $c-&gt;change_session_id;
&gt; &gt; $c-&gt;delete_session;
&gt; &gt;
&gt; &gt; Thanks for the fix though!
&gt; &gt;
&gt; &gt; On Thu Mar 03 14:23:04 2016, CEESHEK wrote:
<div class="message-stanza open">&gt; &gt; &gt;
&gt; &gt; &gt; The DBIC session store plugin errors out with the following message
&gt; &gt; &gt; when calling $c-&gt;change_session_id:
&gt; &gt; &gt;
&gt; &gt; &gt; ERROR - Caught exception in engine &#34;DBIx::Class::Row::update&#40;&#41;:
&gt; &gt; &gt; Can&#39;t
&gt; &gt; &gt; update MyApp::Model::DB::Session=HASH&#40;0x7f8f3d4f5c20&#41;: row not
&gt; &gt; &gt; found
&gt; &gt; &gt; at ~/perl5/perlbrew/perls/perl-
&gt; &gt; &gt; 5.20.2/lib/site_perl/5.20.2/Catalyst/Plugin/Session/Store/DBIC/Delegate.pm
&gt; &gt; &gt; line 124&#34;
&gt; &gt; &gt;
&gt; &gt; &gt; I have attached a patch to fix the problem, which includes a new
&gt; &gt; &gt; set
&gt; &gt; &gt; of tests that can be used to recreate the issue.
&gt; &gt; &gt;
&gt; &gt; &gt; The problem occurs when the old session is deleted, but the
&gt; &gt; &gt; Delegate
&gt; &gt; &gt; object keeps an old copy of the DBIx::Class row object in an
&gt; &gt; &gt; accessor
&gt; &gt; &gt; and continues to use that old object.  This means the cached object
&gt; &gt; &gt; keeps it&#39;s old session ID, and when it tries to flush to the
&gt; &gt; &gt; database,
&gt; &gt; &gt; since the -&gt;in_storage flag for the row is still set to true, it
&gt; &gt; &gt; attempts an update of the row in the database which fails.
&gt; &gt; &gt;
&gt; &gt; &gt; The fix is simple.  When asking for the row object, check to make
&gt; &gt; &gt; sure
&gt; &gt; &gt; that the row object that is cached matches the session ID that is
&gt; &gt; &gt; being requested.  This just requires a small change to the
&gt; &gt; &gt; &#39;session&#39;
&gt; &gt; &gt; method in Catalyst/Plugin/Session/Store/DBIC/Delegate.pm.
&gt; &gt; &gt;
&gt; &gt; &gt; I would have provided a pull request through github, but it looks
&gt; &gt; &gt; like
&gt; &gt; &gt; the distribution there is out of date.  I hope a patch is
&gt; &gt; &gt; acceptable.
&gt; &gt; &gt;
&gt; &gt; &gt; Cheers,
&gt; &gt; &gt;
&gt; &gt; &gt; Cees Hek
</div>&gt; &gt;
&gt; &gt;
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;04&nbsp;20:26:44&nbsp;2019</span>
    <span class="description">bokutin [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I also encountered this bug.

CatalystX::SimpleLogin did not work.
<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/ABRAXXA/CatalystX-SimpleLogin-0.20/lib/CatalystX/SimpleLogin/Controller/Login.pm#L110">https://metacpan.org/source/ABRAXXA/CatalystX-SimpleLogin-0.20/lib/CatalystX/SimpleLogin/Controller/Login.pm#L110</a></span>

I am glad if it resolves.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
