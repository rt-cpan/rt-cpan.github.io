<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #121937 for Mojo-Cloudstack: Bug when using in a mojolicious APP &#40;close_wait due to not resetting the IOLoop&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #121937 for Mojo-Cloudstack: Bug when using in a mojolicious APP &#40;close_wait due to not resetting the IOLoop&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Mojo-Cloudstack/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Mojo-Cloudstack/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Mojo-Cloudstack/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Mojo-Cloudstack/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mojo-Cloudstack">Mojo-Cloudstack CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">121937</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Mojo-Cloudstack/Active/">Mojo-Cloudstack</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
franz.skale [...] citycom-austria.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-259814-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-259815-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;30&nbsp;09:03:31&nbsp;2017</span>
    <span class="description">franz.skale [...] citycom-austria.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Bug when using in a mojolicious APP &#40;close_wait due to not resetting the IOLoop&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 30 May 2017 12:51:09 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Mojo-Cloudstack [...] rt.cpan.org&#34; &lt;bug-Mojo-Cloudstack [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Skale Franz &lt;franz.skale [...] citycom-austria.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Perl Version: 5.24.1

Mojo Cloudstack Version: 0.0.7

Mojolicious:

mojo version
CORE
  Perl        &#40;v5.24.1, linux&#41;
  Mojolicious &#40;7.31, Doughnut&#41;

OPTIONAL
  EV 4.0+                 &#40;4.22&#41;
  IO::Socket::SSL 1.94+   &#40;2.048&#41;
  Net::DNS::Native 0.15+  &#40;0.15&#41;


When using Mojo::Cloudstack in a Mojolicious APP, the IO Loop never stops, so on overy new connection, the io loop will be open until stopping the mojolicious app.

This small patch fixes the problem by resetting the ioloop on AUTOLOAD:


diff -upr Mojo-Cloudstack-0.07/lib/Mojo/Cloudstack.pm Mojo-Cloudstack-0.07.new/lib/Mojo/Cloudstack.pm
--- Mojo-Cloudstack-0.07/lib/Mojo/Cloudstack.pm 2015-09-29 17:10:24.000000000 +0200
+++ Mojo-Cloudstack-0.07.new/lib/Mojo/Cloudstack.pm     2017-05-30 09:24:35.937728851 +0200
@@ -5,7 +5,7 @@ use Mojo::Parameters;
 use Mojo::URL;
 use Mojo::UserAgent;
 use Mojo::JSON &#39;j&#39;;
-use Mojo::Util &#39;slurp&#39;;
+use Mojo::File;
 use Mojo::Collection &#39;c&#39;;
 use Mojo::Cloudstack::Base;
 use Mojo::Cloudstack::Api;
@@ -64,8 +64,10 @@ sub AUTOLOAD {
   my %params = @_;
   $params{command} = $command;
   my $req = $self-&gt;_build_request&#40;\%params&#41;;
+  my $loop = $self-&gt;ioloop;
   my $res = $self-&gt;post&#40;$req&#41;-&gt;res;
   my $items = $res-&gt;json;
+  $loop-&gt;reset;
   #warn Dumper &#39;ITEMS&#39;, $items;
   die sprintf&#40;&#34;Could not get response for %s\n%s&#34;, $req,  Dumper&#40;$res&#41;&#41; unless $items;
   my $responsetype = &#40;keys %$items&#41;[0];
@@ -114,7 +116,7 @@ sub _load_api_cache {
       if &#40;$force or &#40;not -f $cf&#41;&#41;;
   #TODO File::ShareDir

-  $self-&gt;api_cache&#40;j&#40;slurp $cf&#41;&#41; if -f $cf;
+  $self-&gt;api_cache&#40;j&#40;Mojo::File-&gt;new&#40;$cf&#41;-&gt;slurp&#41;&#41; if -f $cf;
   return $self-&gt;api_cache;
 }



Also please fix the issue regarding the deprecated slurp function which is now part of Mojo::File.

Here a temp fix to get Mojo::Cloudstack working with Mojolicious 7.31


diff -upr Mojo-Cloudstack-0.07/ex/createvm.pl Mojo-Cloudstack-0.07.new/ex/createvm.pl
--- Mojo-Cloudstack-0.07/ex/createvm.pl    2015-09-29 17:10:24.000000000 +0200
+++ Mojo-Cloudstack-0.07.new/ex/createvm.pl    2017-05-30 09:27:22.071150461 +0200
@@ -1,12 +1,12 @@
 #!/usr/bin/perl

-use Mojo::Util &#39;slurp&#39;;
+use Mojo::File;
 use Data::Dumper &#39;Dumper&#39;;
 use Mojo::Cloudstack;

-my $api_key = slurp&#40;&#34;/home/holger/.mojo_cloudstack/api_key&#34;&#41;;
+my $api_key = Mojo::File-&gt;new&#40;&#39;/home/holger/.mojo_cloudstack/api_key&#39;&#41;-&gt;slurp;
 chomp $api_key;
-my $secret_key = slurp&#40;&#34;/home/holger/.mojo_cloudstack/secret_key&#34;&#41;;
+my $secret_key = Mojo::File-&gt;new&#40;&#39;/home/holger/.mojo_cloudstack/secret_key&#39;&#41;-&gt;slurp;
 chomp $secret_key;

 my $cs = Mojo::Cloudstack-&gt;new&#40;
diff -upr Mojo-Cloudstack-0.07/ex/delete_all_volumes_by_customer.pl Mojo-Cloudstack-0.07.new/ex/delete_all_volumes_by_customer.pl
--- Mojo-Cloudstack-0.07/ex/delete_all_volumes_by_customer.pl    2015-09-29 17:10:24.000000000 +0200
+++ Mojo-Cloudstack-0.07.new/ex/delete_all_volumes_by_customer.pl    2017-05-30 09:28:35.408260817 +0200
@@ -1,12 +1,12 @@
 #!/usr/bin/perl

-use Mojo::Util &#39;slurp&#39;;
+use Mojo::File;
 use Data::Dumper &#39;Dumper&#39;;
 use Mojo::Cloudstack;

-my $api_key = slurp&#40;&#34;/home/holger/.mojo_cloudstack/api_key&#34;&#41;;
+my $api_key = Mojo::File-&gt;new&#40;&#39;/home/holger/.mojo_cloudstack/api_key&#39;&#41;-&gt;slurp;
 chomp $api_key;
-my $secret_key = slurp&#40;&#34;/home/holger/.mojo_cloudstack/secret_key&#34;&#41;;
+my $secret_key = Mojo::File-&gt;new&#40;&#39;/home/holger/.mojo_cloudstack/secret_key&#39;&#41;-&gt;slurp;
 chomp $secret_key;

 my $cs = Mojo::Cloudstack-&gt;new&#40;
diff -upr Mojo-Cloudstack-0.07/ex/expunge_destroyed_vms.pl Mojo-Cloudstack-0.07.new/ex/expunge_destroyed_vms.pl
--- Mojo-Cloudstack-0.07/ex/expunge_destroyed_vms.pl    2015-09-29 17:10:24.000000000 +0200
+++ Mojo-Cloudstack-0.07.new/ex/expunge_destroyed_vms.pl    2017-05-30 09:29:17.256611867 +0200
@@ -1,12 +1,12 @@
 #!/usr/bin/perl

-use Mojo::Util &#39;slurp&#39;;
+use Mojo::File;
 use Data::Dumper &#39;Dumper&#39;;
 use Mojo::Cloudstack;

-my $api_key = slurp&#40;&#34;/home/holger/.mojo_cloudstack/api_key&#34;&#41;;
+my $api_key = Mojo::File-&gt;new&#40;&#39;/home/holger/.mojo_cloudstack/api_key&#39;&#41;-&gt;slurp;
 chomp $api_key;
-my $secret_key = slurp&#40;&#34;/home/holger/.mojo_cloudstack/secret_key&#34;&#41;;
+my $secret_key = Mojo::File-&gt;new&#40;&#39;/home/holger/.mojo_cloudstack/secret_key&#39;&#41;-&gt;slurp;
 chomp $secret_key;

 my $cs = Mojo::Cloudstack-&gt;new&#40;
diff -upr Mojo-Cloudstack-0.07/ex/listapi.pl Mojo-Cloudstack-0.07.new/ex/listapi.pl
--- Mojo-Cloudstack-0.07/ex/listapi.pl    2015-09-29 17:10:24.000000000 +0200
+++ Mojo-Cloudstack-0.07.new/ex/listapi.pl    2017-05-30 09:30:02.644825007 +0200
@@ -1,12 +1,12 @@
 #!/usr/bin/perl

-use Mojo::Util &#39;slurp&#39;;
+use Mojo::File;
 use Data::Dumper &#39;Dumper&#39;;
 use Mojo::Cloudstack;

-my $api_key = slurp&#40;&#34;/home/holger/.mojo_cloudstack/api_key&#34;&#41;;
+my $api_key = Mojo::File-&gt;new&#40;&#39;/home/holger/.mojo_cloudstack/api_key&#39;&#41;-&gt;slurp;
 chomp $api_key;
-my $secret_key = slurp&#40;&#34;/home/holger/.mojo_cloudstack/secret_key&#34;&#41;;
+my $secret_key = Mojo::File-&gt;new&#40;&#39;/home/holger/.mojo_cloudstack/secret_key&#39;&#41;-&gt;slurp;
 chomp $secret_key;

 my $cs = Mojo::Cloudstack-&gt;new&#40;
diff -upr Mojo-Cloudstack-0.07/ex/login.pl Mojo-Cloudstack-0.07.new/ex/login.pl
--- Mojo-Cloudstack-0.07/ex/login.pl    2015-09-29 17:10:24.000000000 +0200
+++ Mojo-Cloudstack-0.07.new/ex/login.pl    2017-05-30 09:31:08.542230044 +0200
@@ -1,12 +1,12 @@
 #!/usr/bin/perl

-use Mojo::Util &#39;slurp&#39;;
+use Mojo::File;
 use Data::Dumper &#39;Dumper&#39;;
 use Mojo::Cloudstack;

-my $api_key = slurp&#40;&#34;/home/holger/.mojo_cloudstack/api_key&#34;&#41;;
+my $api_key = Mojo::File-&gt;new&#40;&#39;/home/holger/.mojo_cloudstack/api_key&#39;&#41;-&gt;slurp;
 chomp $api_key;
-my $secret_key = slurp&#40;&#34;/home/holger/.mojo_cloudstack/secret_key&#34;&#41;;
+my $secret_key = Mojo::File-&gt;new&#40;&#39;/home/holger/.mojo_cloudstack/secret_key&#39;&#41;-&gt;slurp;
 chomp $secret_key;

 my $cs = Mojo::Cloudstack-&gt;new&#40;
diff -upr Mojo-Cloudstack-0.07/lib/Mojo/Cloudstack.pm Mojo-Cloudstack-0.07.new/lib/Mojo/Cloudstack.pm
--- Mojo-Cloudstack-0.07/lib/Mojo/Cloudstack.pm    2015-09-29 17:10:24.000000000 +0200
+++ Mojo-Cloudstack-0.07.new/lib/Mojo/Cloudstack.pm    2017-05-30 09:24:35.937728851 +0200
@@ -5,7 +5,7 @@ use Mojo::Parameters;
 use Mojo::URL;
 use Mojo::UserAgent;
 use Mojo::JSON &#39;j&#39;;
-use Mojo::Util &#39;slurp&#39;;
+use Mojo::File;
 use Mojo::Collection &#39;c&#39;;
 use Mojo::Cloudstack::Base;
 use Mojo::Cloudstack::Api;
@@ -64,8 +64,10 @@ sub AUTOLOAD {
   my %params = @_;
   $params{command} = $command;
   my $req = $self-&gt;_build_request&#40;\%params&#41;;
+  my $loop = $self-&gt;ioloop;
   my $res = $self-&gt;post&#40;$req&#41;-&gt;res;
   my $items = $res-&gt;json;
+  $loop-&gt;reset;
   #warn Dumper &#39;ITEMS&#39;, $items;
   die sprintf&#40;&#34;Could not get response for %s\n%s&#34;, $req,  Dumper&#40;$res&#41;&#41; unless $items;
   my $responsetype = &#40;keys %$items&#41;[0];
@@ -114,7 +116,7 @@ sub _load_api_cache {
       if &#40;$force or &#40;not -f $cf&#41;&#41;;
   #TODO File::ShareDir

-  $self-&gt;api_cache&#40;j&#40;slurp $cf&#41;&#41; if -f $cf;
+  $self-&gt;api_cache&#40;j&#40;Mojo::File-&gt;new&#40;$cf&#41;-&gt;slurp&#41;&#41; if -f $cf;
   return $self-&gt;api_cache;
 }

diff -upr Mojo-Cloudstack-0.07/t/00-load.t Mojo-Cloudstack-0.07.new/t/00-load.t
--- Mojo-Cloudstack-0.07/t/00-load.t    2015-09-29 17:10:24.000000000 +0200
+++ Mojo-Cloudstack-0.07.new/t/00-load.t    2017-05-30 09:22:53.721780782 +0200
@@ -2,7 +2,7 @@ use strict;
 use warnings;
 use Test::More &#39;no_plan&#39;;
 use Mojo::UserAgent;
-use Mojo::Util &#39;slurp&#39;;
+use Mojo::File;
 use Mojo::JSON &#39;j&#39;;

 use Data::Dumper &#39;Dumper&#39;;
@@ -15,9 +15,9 @@ BEGIN {

 diag&#40;&#34;Testing Mojo::Cloudstack $Mojo::Cloudstack::VERSION, Perl $], $^X&#34;&#41;;

-my $api_key = slurp&#40;&#34;t/api_key&#34;&#41;;
+my $api_key = Mojo::File-&gt;new&#40;&#39;t/api_key&#39;&#41;-&gt;slurp;
 chomp $api_key;
-my $secret_key = slurp&#40;&#34;t/secret_key&#34;&#41;;
+my $secret_key = Mojo::File-&gt;new&#40;&#39;t/secret_key&#39;&#41;-&gt;slurp;
 chomp $secret_key;

 my $cs = Mojo::Cloudstack-&gt;new&#40;



Best regards.


Franz
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
