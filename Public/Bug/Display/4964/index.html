<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #4964 for Module-Build: distdir postprocessing &#40;pod wrapping, tab expansion&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #4964 for Module-Build: distdir postprocessing &#40;pod wrapping, tab expansion&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Module-Build/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Module-Build/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Module-Build/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Module-Build/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Module-Build">Module-Build CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">4964</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Module-Build/Active/">Module-Build</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
NUFFIN [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-21558-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-21559-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;17&nbsp;08:57:11&nbsp;2004</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> distdir postprocessing &#40;pod wrapping, tab expansion&#41;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The following patch will allow Module::Build to automatically wrap pod sections and expand tabs using some modules.

The documentation has also been patched.

The modifications were made as high up the file as logically possible, to ease repositioning.


Motivation:
people like me, who use real tabs and don&#39;t wrap their code, should do so, because we are not the majority.


Reasons not to integrate:

The distribution tarball will differ from the working copy, making patch submission be icky. But this is not on by default, so... Distribution post &#40;or pre, from the perspective of the end user&#41; processing in general can be deemed a bad thing from this perspective.

Implementation is sort of qnd


Possible extension:
use Perl::Tidy
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ur Module-Build-0.22/lib/Module/Build/Base.pm Module-Build-0.22-Text-Tabs_and_Pod-Wrap/lib/Module/Build/Base.pm
--- Module-Build-0.22/lib/Module/Build/Base.pm	Sun Jan 11 06:19:59 2004
+++ Module-Build-0.22-Text-Tabs_and_Pod-Wrap/lib/Module/Build/Base.pm	Sat Jan 17 15:43:07 2004
@@ -12,6 +12,70 @@
 use Data::Dumper &#40;&#41;;
 use IO::File &#40;&#41;;
 
+##### place wherever #####
+
+sub expand_tabs { return &#40;@_ ? $_ = shift : $_ &#41; for shift-&gt;{properties}{expand_tabs} }
+sub wrap_pod { return &#40;@_ ? $_ = shift : $_&#41; for shift-&gt;{properties}{wrap_pod} }
+
+sub _pp_wrap_pod {
+  my $self = shift;
+  
+  require Pod::Wrap or warn &#34;Can&#39;t wrap pod because Pod::Wrap is not available&#34; and return;
+  require Pod::Find;
+  
+  my %args = @_;
+  my $file = File::Spec-&gt;catfile&#40;$args{in}, $args{file}&#41;;
+  
+  $Text::Wrap::columns = $self-&gt;wrap_pod + 0 if eval { $self-&gt;wrap_pod + 0 || 1 } &#38;&#38; not $@;      
+  
+  if &#40;Pod::Find::contains_pod&#40;$file&#41;&#41; {
+    require File::Temp;
+    
+    my &#40;$out, $tmpfile&#41; = File::Temp::tempfile&#40;DIR =&gt; $args{in}, UNLINK =&gt; 0&#41; or die &#34;Couldn&#39;t create tempfile: $!&#34;; # in the destination dir, because sometimes /tmp or equivelent and what we&#39;ll work on aren&#39;t on the same filesystem
+    
+    my $w = new Pod::Wrap;
+    
+    open PP_INFILE, &#34;&lt;&#34;, $file or die &#34;Couldn&#39;t open $file for reading: $!&#34;;
+    
+    $w-&gt;parse_from_filehandle&#40;\*PP_INFILE, $out&#41;;
+    
+    close PP_INFILE;
+    close $out;
+    
+    unlink $file or die &#34;Couldn&#39;t remove $file: $!&#34;;
+    rename $tmpfile, $file or die &#34;Couldn&#39;t rename $tmpfile to $file: $!&#34;;
+  }
+}
+
+sub _pp_expand_tabs {
+  my $self = shift;
+  
+  
+  
+  require Text::Tabs;
+  require File::Temp;
+  
+  my %args = @_;
+  my $file = File::Spec-&gt;catfile&#40;$args{in}, $args{file}&#41;;
+  
+  $Text::Tabs::tabstop = $self-&gt;expand_tabs + 0 if eval { $self-&gt;expand_tabs + 0 || 1 } &#38;&#38; not $@;
+  
+  my &#40;$out, $tmpfile&#41; = File::Temp::tempfile&#40;DIR =&gt; $args{in}, UNLINK =&gt; 0&#41; or die &#34;Couldn&#39;t create tempfile: $!&#34;;
+  
+  open PP_INFILE, &#34;&lt;&#34;, $file or die &#34;Couldn&#39;t open $file for reading: $!&#34;;
+  
+  while&#40;&lt;PP_INFILE&gt;&#41;{
+    print {$out} Text::Tabs::expand&#40;$_&#41;;
+  }
+  
+  close PP_INFILE;
+  close $out;
+  
+  unlink $file or die &#34;Couldn&#39;t remove $file: $!&#34;;
+  rename $tmpfile, $file or die &#34;Couldn&#39;t rename $tmpfile to $file: $!&#34;;
+}
+
+
 #################### Constructors ###########################
 sub new {
   my $self = shift&#40;&#41;-&gt;_construct&#40;@_&#41;;
@@ -1570,6 +1634,14 @@
   foreach my $file &#40;keys %$dist_files&#41; {
     $self-&gt;copy_if_modified&#40;from =&gt; $file, to_dir =&gt; $dist_dir, verbose =&gt; 0&#41;;
   }
+  
+  if &#40;my @pp = map { &#34;_pp_$_&#34; } grep { $self-&gt;$_&#40;&#41; } qw/expand_tabs wrap_pod/&#41; {  
+    foreach my $file &#40;keys %$dist_files&#41;{
+      foreach my $pp &#40;@pp&#41;{
+        $self-&gt;$pp&#40;file =&gt; $file, in =&gt; $dist_dir&#41;;
+      }
+    }
+  } 
   
   $self-&gt;_sign_dir&#40;$dist_dir&#41; if $self-&gt;{properties}{sign};
 }
diff -ur Module-Build-0.22/lib/Module/Build.pm Module-Build-0.22-Text-Tabs_and_Pod-Wrap/lib/Module/Build.pm
--- Module-Build-0.22/lib/Module/Build.pm	Sun Jan 11 06:19:59 2004
+++ Module-Build-0.22-Text-Tabs_and_Pod-Wrap/lib/Module/Build.pm	Sat Jan 17 15:49:57 2004
@@ -214,6 +214,17 @@
 
 =over 4
 
+=item expand_tabs
+
+If true, distribution files&#39; tabs will be expanded using L&lt;Text::Tabs&gt;.
+If it is a number, $Text::Tabs::tabstop will be set to it&#39;s value.
+
+=item wrap_pod
+
+If true, distribution files&#39; pod sections will be wrapped using
+L&lt;Pod::Wrap&gt;. If it is a number, $Text::Wrap::columns will be set to
+it&#39;s value.
+
 =item module_name
 
 The C&lt;module_name&gt; is a shortcut for setting default values of
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;18&nbsp;21:47:18&nbsp;2004</span>
    <span class="description">kwilliams [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Sat Jan 17 08:57:11 2004]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Reasons not to integrate:
&gt; 
&gt; The distribution tarball will differ from the working copy, making
&gt;    patch submission be icky. But this is not on by default, so...
&gt;    Distribution post &#40;or pre, from the perspective of the end user&#41;
&gt;    processing in general can be deemed a bad thing from this
&gt;    perspective.
</div>
Yeah, I don&#39;t think I want to apply this for that reason.  It&#39;s even conceivable that the 
module could break without the author&#39;s knowledge while building the distribution.  I 
recommend getting word-wrapping and tab-expansion working in your editor, which is 
where this kind of stuff belongs IMO.

Once we get the plugin architecture for M::B figured out, you could make a plugin for 
this, though.

 -Ken
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;18&nbsp;21:47:19&nbsp;2004</span>
    <span class="description">kwilliams [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
