<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #13226 for Data-FormValidator: Patch to handle coderefs in defaults</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #13226 for Data-FormValidator: Patch to handle coderefs in defaults</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Data-FormValidator/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Data-FormValidator/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Data-FormValidator/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Data-FormValidator/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Data-FormValidator">Data-FormValidator CPAN distribution</a>.</p>


<h3>Maintainer&#40;s&#41;&#39; notes</h3>

<p>This is the bug queue for Data::FormValidator. </p>



<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">13226</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Data-FormValidator/Active/">Data-FormValidator</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">MARKSTOS [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
m.romani [...] spinsoft.it

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-9052-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-9053-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;13&nbsp;12:11:47&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Patch to handle coderefs in defaults</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Using this patch I can write something like:

$input_profile-&gt;{defaults} = {
    creation_date =&gt; sub {
        require Time::Piece;
        my $now = Timie::Piece-&gt;new&#40;&#41;;
        return $now-&gt;ymd;
    }
}

and have the &#39;creation_date&#39; filled with current date left blank.
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">262c262,269
&lt; 		$valid{$field} = $value unless exists $valid{$field};
---
&gt; 		#$valid{$field} = $value unless exists $valid{$field};
&gt; 		unless&#40;exists $valid{$field}&#41; {
&gt; 			if &#40;ref&#40;$value&#41; &#38;&#38; ref&#40;$value&#41; eq &#34;CODE&#34;&#41; {
&gt; 				$valid{$field} = $value-&gt;&#40;&#41;;
&gt; 			} else {
&gt; 				$valid{$field} = $value;
&gt; 			}
&gt; 		}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;13&nbsp;12:12:26&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Mon Jun 13 12:11:47 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Using this patch I can write something like:
&gt; 
&gt; $input_profile-&gt;{defaults} = {
&gt;     creation_date =&gt; sub {
&gt;         require Time::Piece;
&gt;         my $now = Timie::Piece-&gt;new&#40;&#41;;
&gt;         return $now-&gt;ymd;
&gt;     }
&gt; }
&gt; 
&gt; and have the &#39;creation_date&#39; filled with current date if left blank.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;03&nbsp;15:25:54&nbsp;2005</span>
    <span class="description">MARKSTOS [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;03&nbsp;15:26:01&nbsp;2005</span>
    <span class="description">MARKSTOS [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;03&nbsp;15:29:20&nbsp;2005</span>
    <span class="description">MARKSTOS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;03&nbsp;15:29:20&nbsp;2005</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> cascade-dataform [...] lists.sourceforge.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Mon Jun 13 12:11:47 2005]:   
   
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Using this patch I can write something like:   
&gt;    
&gt; $input_profile-&gt;{defaults} = {   
&gt;     creation_date =&gt; sub {   
&gt;         require Time::Piece;   
&gt;         my $now = Timie::Piece-&gt;new&#40;&#41;;   
&gt;         return $now-&gt;ymd;   
&gt;     }   
&gt; }   
&gt;    
&gt; and have the &#39;creation_date&#39; filled with current date left blank.   
</div>   
I will accept this feature addition. Could you also add a test for it  
and update the docs and Changes files as well? I&#39;m CC&#39;ing the mailing  
list against someone else wants to contribute that work as well.   
  
Otherwise, I&#39;ll get to it eventually myself.   
 
Stalling ticket for feedback.  
   
 Mark  
   
   
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;05&nbsp;04:02:01&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mromani</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[MARKSTOS - Sun Jul  3 15:29:20 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [guest - Mon Jun 13 12:11:47 2005]:
&gt; 
<div class="message-stanza open">&gt; &gt; Using this patch I can write something like:
&gt; &gt;
&gt; &gt; $input_profile-&gt;{defaults} = {
&gt; &gt;     creation_date =&gt; sub {
&gt; &gt;         require Time::Piece;
&gt; &gt;         my $now = Timie::Piece-&gt;new&#40;&#41;;
&gt; &gt;         return $now-&gt;ymd;
&gt; &gt;     }
&gt; &gt; }
&gt; &gt;
&gt; &gt; and have the &#39;creation_date&#39; filled with current date left blank.
</div>&gt; 
&gt; I will accept this feature addition. Could you also add a test for it
&gt; and update the docs and Changes files as well? I&#39;m CC&#39;ing the mailing
&gt; list against someone else wants to contribute that work as well.
&gt; 
&gt; Otherwise, I&#39;ll get to it eventually myself.
&gt; 
&gt; Stalling ticket for feedback.
&gt; 
&gt;  Mark
&gt; 
</div>

I have written a simple addition to 25_results.t, and while doing that I
realized it might be useful to pass $field as an argument to the
coderef. So here are the new Restuls.pm patch and the 25_results.t patch:

-------------------- 25_results.t ------------------
1c1
&lt; use Test::More tests =&gt; 4;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; use Test::More tests =&gt; 6;
</div>13c13
&lt;         required =&gt; &#39;stick&#39;,
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         required =&gt; [ &#39;stick&#39;, &#39;fromsub&#39;, &#39;whoami&#39; ],
</div>15c15,18
&lt;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       defaults =&gt; {
&gt;               fromsub =&gt; sub { return &#34;got value from a subroutine&#34;; },
&gt;               whoami =&gt; sub { my $me = shift; return &#34;I am field $me&#34;; },
&gt;               },
</div>29c32,33
&lt;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ok&#40;$results-&gt;valid&#40;&#39;fromsub&#39;&#41; eq &#34;got value from a subroutine&#34;, &#39;usg
</div>CODE references as default values&#39;&#41;;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ok&#40;$results-&gt;valid&#40;&#39;whoami&#39;&#41; eq &#34;I am field whoami&#34;, &#39;usg CODE
</div>references as default values&#39;&#41;;
~
~



-------------------- Results.pm ------------------
262c262,268
&lt;               $valid{$field} = $value unless exists $valid{$field};
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;               unless&#40;exists $valid{$field}&#41; {
&gt;                       if &#40;ref&#40;$value&#41; &#38;&#38; ref&#40;$value&#41; eq &#34;CODE&#34;&#41; {
&gt;                               $valid{$field} = $value-&gt;&#40;$field&#41;;
&gt;                       } else {
&gt;                               $valid{$field} = $value;
&gt;                       }
&gt;               }
</div>

I&#39;ll post a patch to the docs ASAP.
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">1c1
&lt; use Test::More tests =&gt; 4;
---
&gt; use Test::More tests =&gt; 6;
13c13
&lt;         required =&gt; &#39;stick&#39;,
---
&gt;         required =&gt; [ &#39;stick&#39;, &#39;fromsub&#39;, &#39;whoami&#39; ],
15c15,18
&lt; 
---
&gt; 	defaults =&gt; {
&gt; 		fromsub =&gt; sub { return &#34;got value from a subroutine&#34;; },
&gt; 		whoami =&gt; sub { my $me = shift; return &#34;I am field $me&#34;; },
&gt;        	},
29c32,33
&lt; 
---
&gt; ok&#40;$results-&gt;valid&#40;&#39;fromsub&#39;&#41; eq &#34;got value from a subroutine&#34;, &#39;usg CODE references as default values&#39;&#41;;
&gt; ok&#40;$results-&gt;valid&#40;&#39;whoami&#39;&#41; eq &#34;I am field whoami&#34;, &#39;usg CODE references as default values&#39;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;05&nbsp;04:02:01&nbsp;2005</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;05&nbsp;04:27:01&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Added a couple lines to Changes:

0a1,4
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 3.64
&gt;     [ENHANCEMENTS]
&gt;     - support for coderefs as default values
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;05&nbsp;05:02:49&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The feature is mentioned in the docs, with a simple example:

--------------------- FormValidator.pm --------------------
477a478,482
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;      creation_date =&gt; sub {
&gt;          require Time::Piece;
&gt;          my $now = Timie::Piece-&gt;new&#40;&#41;;
&gt;          return $now-&gt;ymd;
&gt;      }
</div>482a488,492
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If the default value is a coderef, its return value will be used.
&gt; This can be useful if you want the default value to be the current date,
&gt; the number of items in a database table, etc.
&gt; The only parameter that gets passed to the code is the field name.
&gt;
</div></div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">477a478,482
&gt;      creation_date =&gt; sub {
&gt;          require Time::Piece;
&gt;          my $now = Timie::Piece-&gt;new&#40;&#41;;
&gt;          return $now-&gt;ymd;
&gt;      }
482a488,492
&gt; If the default value is a coderef, its return value will be used.
&gt; This can be useful if you want the default value to be the current date,
&gt; the number of items in a database table, etc.
&gt; The only parameter that gets passed to the code is the field name.
&gt; 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;05&nbsp;09:07:20&nbsp;2005</span>
    <span class="description">mark [...] summersault.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 5 Jul 2005 08:07:04 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Stosberg &lt;mark [...] summersault.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Guest via RT &lt;bug-Data-FormValidator [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> cascade-dataform [...] lists.sourceforge.net</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #13226] Patch to handle coderefs in defaults</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Thanks for the patch allowing us to use coderefs to set default values!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have written a simple addition to 25_results.t, and while doing that I
&gt; realized it might be useful to pass $field as an argument to the
&gt; coderef.
</div>
This is an interesting thought, and in line with how constraints work.
But it leads me to consider another design niggle. We also have
&#39;constraint_methods&#39;, which take the DFV object as the input. 

That allows you access the current field name, as well as much more.
With that approach some could set a default based on current value of
other CGI fields. 

See here for the methods that are most useful for this:
<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~markstos/Data-FormValidator-3.63/lib/Data/FormValidator/Constraints.pm#WRITING_YOUR_OWN_CONSTRAINT_ROUTINES">http://search.cpan.org/~markstos/Data-FormValidator-3.63/lib/Data/FormValidator/Constraints.pm#WRITING_YOUR_OWN_CONSTRAINT_ROUTINES</a></span>

Unless there are objections from the list, I think I will go the route of
passing the DFV object instead of the field name. My reasoning is that the
common simple case, neither will be needed &#40;such as your own Time::Piece example&#41;. 

Even for a case when you need the field name, it&#39;s a /static/ value. So to write 
a default routine for a single field, you can just write &#34;field_name&#34; in your routine,
because you know what it is. 

I think that leaves a minority of cases which will actually be more
complex. In that case we might as well give them the full power of the
DFV object instead figuring out a way to graft that feature on later
when someone asks for it. 

Let&#39;s see if there are any other opinions from the list before
proceeding. 

    Mark

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So here are the new Restuls.pm patch and the 25_results.t patch:
&gt; 
&gt; -------------------- 25_results.t ------------------
&gt; 1c1
&gt; &lt; use Test::More tests =&gt; 4;
&gt; ---
<div class="message-stanza open">&gt; &gt; use Test::More tests =&gt; 6;
</div>&gt; 13c13
&gt; &lt;         required =&gt; &#39;stick&#39;,
&gt; ---
<div class="message-stanza open">&gt; &gt;         required =&gt; [ &#39;stick&#39;, &#39;fromsub&#39;, &#39;whoami&#39; ],
</div>&gt; 15c15,18
&gt; &lt;
&gt; ---
<div class="message-stanza open">&gt; &gt;       defaults =&gt; {
&gt; &gt;               fromsub =&gt; sub { return &#34;got value from a subroutine&#34;; },
&gt; &gt;               whoami =&gt; sub { my $me = shift; return &#34;I am field $me&#34;; },
&gt; &gt;               },
</div>&gt; 29c32,33
&gt; &lt;
&gt; ---
<div class="message-stanza open">&gt; &gt; ok&#40;$results-&gt;valid&#40;&#39;fromsub&#39;&#41; eq &#34;got value from a subroutine&#34;, &#39;usg
</div>&gt; CODE references as default values&#39;&#41;;
<div class="message-stanza open">&gt; &gt; ok&#40;$results-&gt;valid&#40;&#39;whoami&#39;&#41; eq &#34;I am field whoami&#34;, &#39;usg CODE
</div>&gt; references as default values&#39;&#41;;
&gt; ~
&gt; ~
&gt; 
&gt; 
&gt; 
&gt; -------------------- Results.pm ------------------
&gt; 262c262,268
&gt; &lt;               $valid{$field} = $value unless exists $valid{$field};
&gt; ---
<div class="message-stanza open">&gt; &gt;               unless&#40;exists $valid{$field}&#41; {
&gt; &gt;                       if &#40;ref&#40;$value&#41; &#38;&#38; ref&#40;$value&#41; eq &#34;CODE&#34;&#41; {
&gt; &gt;                               $valid{$field} = $value-&gt;&#40;$field&#41;;
&gt; &gt;                       } else {
&gt; &gt;                               $valid{$field} = $value;
&gt; &gt;                       }
&gt; &gt;               }
</div>&gt; 
&gt; 
&gt; I&#39;ll post a patch to the docs ASAP.
</div>-- 
<span class="clickylink"><a target="new" rel="nofollow" href="http://mark.stosberg.com/">http://mark.stosberg.com/</a></span> 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;05&nbsp;10:07:10&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[mark@summersault.com - Tue Jul  5 09:07:20 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Thanks for the patch allowing us to use coderefs to set default
&gt;    values!
&gt; 
<div class="message-stanza open">&gt; &gt; I have written a simple addition to 25_results.t, and while doing
</div>&gt;    that I
<div class="message-stanza open">&gt; &gt; realized it might be useful to pass $field as an argument to the
&gt; &gt; coderef.
</div>&gt; 
&gt; This is an interesting thought, and in line with how constraints work.
&gt; But it leads me to consider another design niggle. We also have
&gt; &#39;constraint_methods&#39;, which take the DFV object as the input.
&gt; 
&gt; That allows you access the current field name, as well as much more.
&gt; With that approach some could set a default based on current value of
&gt; other CGI fields.
&gt; 
&gt; See here for the methods that are most useful for this:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~markstos/Data-FormValidator-">http://search.cpan.org/~markstos/Data-FormValidator-</a></span>
&gt;   
</div>3.63/lib/Data/FormValidator/Constraints.pm#WRITING_YOUR_OWN_CONSTRAINT_ROUTINES
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Unless there are objections from the list, I think I will go the route
&gt;    of
&gt; passing the DFV object instead of the field name. My reasoning is that
&gt;    the
&gt; common simple case, neither will be needed &#40;such as your own
&gt;    Time::Piece example&#41;.
</div>
Yes, it makes much more sense to pass the whole DFV object instead of
just a small portion of information &#40;e.g. the field name&#41;.
In fact I didn&#39;t need any extra information &#40;as per my example&#41; so I
included the field name just as a simple addition to write a slightly
more complex test.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;05&nbsp;11:16:50&nbsp;2005</span>
    <span class="description">mark [...] summersault.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 5 Jul 2005 10:16:33 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Stosberg &lt;mark [...] summersault.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Guest via RT &lt;bug-Data-FormValidator [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #13226] Patch to handle coderefs in defaults</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Jul 05, 2005 at 10:07:10AM -0400, Guest via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Yes, it makes much more sense to pass the whole DFV object instead of
&gt; just a small portion of information &#40;e.g. the field name&#41;.
&gt; In fact I didn&#39;t need any extra information &#40;as per my example&#41; so I
&gt; included the field name just as a simple addition to write a slightly
&gt; more complex test.
</div>
Would you mind making that refinement in your patch then? 

I&#39;ll get to it soon anyway if you don&#39;t since you&#39;ve graciously done
most of the work already.

    Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;06&nbsp;08:17:07&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[mark@summersault.com - Tue Jul  5 11:16:50 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue, Jul 05, 2005 at 10:07:10AM -0400, Guest via RT wrote:
<div class="message-stanza open">&gt; &gt;
&gt; &gt; Yes, it makes much more sense to pass the whole DFV object instead
</div>&gt;    of
<div class="message-stanza open">&gt; &gt; just a small portion of information &#40;e.g. the field name&#41;.
&gt; &gt; In fact I didn&#39;t need any extra information &#40;as per my example&#41; so I
&gt; &gt; included the field name just as a simple addition to write a
</div>&gt;    slightly
<div class="message-stanza open">&gt; &gt; more complex test.
</div>&gt; 
&gt; Would you mind making that refinement in your patch then?
&gt; 
&gt; I&#39;ll get to it soon anyway if you don&#39;t since you&#39;ve graciously done
&gt; most of the work already.
</div>
Don&#39;t we need something in the lines of __CURRENT_CONSTRAINT_FIELD,
something like __CURRENT_DEFAULT_FIELD and a method like
current_default_field&#40;&#41; ?

&#40;Please correct me if I misunderstood your code&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt;     Mark
</div>
Marcello
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;10&nbsp;20:30:22&nbsp;2005</span>
    <span class="description">mark [...] summersault.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 10 Jul 2005 19:30:31 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Stosberg &lt;mark [...] summersault.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Guest via RT &lt;bug-Data-FormValidator [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #13226] Patch to handle coderefs in defaults</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Jul 06, 2005 at 08:17:07AM -0400, Guest via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; This message about Data-FormValidator was sent to you by guest &lt;&gt; via rt.cpan.org
&gt; 
&gt; Full context and any attached attachments can be found at:
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=13226">https://rt.cpan.org/Ticket/Display.html?id=13226</a></span> &gt;
&gt; 
&gt; [mark@summersault.com - Tue Jul  5 11:16:50 2005]:
&gt; 
<div class="message-stanza open">&gt; &gt; On Tue, Jul 05, 2005 at 10:07:10AM -0400, Guest via RT wrote:
<div class="message-stanza open">&gt; &gt; &gt;
&gt; &gt; &gt; Yes, it makes much more sense to pass the whole DFV object instead
</div>&gt; &gt;    of
<div class="message-stanza open">&gt; &gt; &gt; just a small portion of information &#40;e.g. the field name&#41;.
&gt; &gt; &gt; In fact I didn&#39;t need any extra information &#40;as per my example&#41; so I
&gt; &gt; &gt; included the field name just as a simple addition to write a
</div>&gt; &gt;    slightly
<div class="message-stanza open">&gt; &gt; &gt; more complex test.
</div>&gt; &gt; 
&gt; &gt; Would you mind making that refinement in your patch then?
&gt; &gt; 
&gt; &gt; I&#39;ll get to it soon anyway if you don&#39;t since you&#39;ve graciously done
&gt; &gt; most of the work already.
</div>&gt; 
&gt; Don&#39;t we need something in the lines of __CURRENT_CONSTRAINT_FIELD,
&gt; something like __CURRENT_DEFAULT_FIELD and a method like
&gt; current_default_field&#40;&#41; ?
</div>
Can&#39;t we make a first cut without it, just to keep things simple. It
seems to me it would only be necessary if you wrote a default-settor that
changed it&#39;s behavior based on the name of the field. Seems uncommon. 

With constraints, somes you might want &#34;field&#34; to refer to
&#34;field_value&#34;, making it more necessary there. 

I&#39;m not opposed to the idea, I just want to make sure it will get used. 

    Mark

-- 
<span class="clickylink"><a target="new" rel="nofollow" href="http://mark.stosberg.com/">http://mark.stosberg.com/</a></span> 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;11&nbsp;02:55:26&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[mark@summersault.com - Sun Jul 10 20:30:22 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed, Jul 06, 2005 at 08:17:07AM -0400, Guest via RT wrote:
<div class="message-stanza open">&gt; &gt;
&gt; &gt; This message about Data-FormValidator was sent to you by guest &lt;&gt;
</div>&gt; via rt.cpan.org
<div class="message-stanza open">&gt; &gt;
&gt; &gt; Full context and any attached attachments can be found at:
&gt; &gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=13226">https://rt.cpan.org/Ticket/Display.html?id=13226</a></span> &gt;
&gt; &gt;
&gt; &gt; [mark@summersault.com - Tue Jul  5 11:16:50 2005]:
&gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; On Tue, Jul 05, 2005 at 10:07:10AM -0400, Guest via RT wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Yes, it makes much more sense to pass the whole DFV object
</div></div></div>&gt; instead
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt;    of
<div class="message-stanza open">&gt; &gt; &gt; &gt; just a small portion of information &#40;e.g. the field name&#41;.
&gt; &gt; &gt; &gt; In fact I didn&#39;t need any extra information &#40;as per my example&#41;
</div></div></div>&gt; so I
<div class="message-stanza open"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; included the field name just as a simple addition to write a
</div>&gt; &gt; &gt;    slightly
<div class="message-stanza open">&gt; &gt; &gt; &gt; more complex test.
</div>&gt; &gt; &gt;
&gt; &gt; &gt; Would you mind making that refinement in your patch then?
&gt; &gt; &gt;
&gt; &gt; &gt; I&#39;ll get to it soon anyway if you don&#39;t since you&#39;ve graciously
</div></div>&gt; done
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; most of the work already.
</div>&gt; &gt;
&gt; &gt; Don&#39;t we need something in the lines of __CURRENT_CONSTRAINT_FIELD,
&gt; &gt; something like __CURRENT_DEFAULT_FIELD and a method like
&gt; &gt; current_default_field&#40;&#41; ?
</div>&gt; 
&gt; Can&#39;t we make a first cut without it, just to keep things simple. It
&gt; seems to me it would only be necessary if you wrote a default-settor
&gt; that
&gt; changed it&#39;s behavior based on the name of the field. Seems uncommon.
</div>
You&#39;re right.
I should have been more clear perhaps. My question was: if I pass the
whole DFV object instead of the field name, how can I access &#40;potential&#41;
useful informations such as the field name, etc. provided by the DFV
object ?
It seemed to me this was similar to the constraints part, so I looked at
the code and thought that a similar method could be used here.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; With constraints, somes you might want &#34;field&#34; to refer to
&gt; &#34;field_value&#34;, making it more necessary there.
&gt; 
&gt; I&#39;m not opposed to the idea, I just want to make sure it will get
&gt; used.
&gt; 
&gt;     Mark
</div>
Since the motivation behind passing the field name to the coderef did
not arise from practical needs, I think we should just KIS for now and
go with the first version of the patch.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;13&nbsp;11:53:38&nbsp;2005</span>
    <span class="description">mark [...] summersault.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 13 Aug 2005 10:53:25 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Stosberg &lt;mark [...] summersault.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Guest via RT &lt;bug-Data-FormValidator [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Fwd: Re: [cpan #13226] sample code from Cees.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Cees has provided the code for this feature, below. 

I recommended naming it &#39;summarize_errors&#39; and otherwise
dropping it into Results.pm with light changes. 

Cees has even helped to document it. :&#41; 

It should just need some simple tests and it&#39;s ready to go. 

    Mark

----- Forwarded message from Cees Hek &lt;ceeshek@gmail.com&gt; -----

Date: Sat, 13 Aug 2005 11:19:55 -0400
From: Cees Hek &lt;ceeshek@gmail.com&gt;
To: Mark Stosberg &lt;mark@summersault.com&gt;
Subject: Re: DFV template integration request for code

sub summarize_form_errors {
    my $self    = shift;
    my $results = shift;
    my $errors  = {};

    # get &#39;invalid&#39; elements as a hashref, and then convert any
arrayrefs to hashrefs
    $errors-&gt;{invalid} = $results-&gt;invalid;
    foreach my $invalid &#40; keys %{ $errors-&gt;{invalid} } &#41; {
        if &#40; ref $errors-&gt;{invalid}-&gt;{$invalid} eq &#39;ARRAY&#39; &#41; {
            $errors-&gt;{invalid}-&gt;{$invalid} = { map { $_ =&gt; 1 } @{
$errors-&gt;{invalid}-&gt;{$invalid} } };
        }
    }
    # get &#39;missing&#39; elements and convert to hashref
    $errors-&gt;{missing} = { map { $_ =&gt; 1 } $results-&gt;missing };

    return $errors;
}

It is pretty simple really.  Calling invalid gets us a hashref
already, but when you have multiple constraints, it is nice to know
the name of those constraints that failed as well, so if we have an
arrayref, we just map it to a hash.

And calling missing gets us a simple array which we convert to a hash.
 I return the entire thing as a hashref containing the keys &#39;invalid&#39;
and &#39;missing&#39;, but that could be separated out easily.

Then in the templates I call  [% IF errors.missing.first_name %]...[%
END %].  And for invalid, I sometimes have constraints that look
something like this:

email =&gt; [
  {
    name       =&gt; &#39;exists&#39;,
    constraint =&gt; sub { ! Users-&gt;search&#40; email =&gt; $_[0] &#41;-&gt;first },
  },
  {
    name       =&gt; &#39;length&#39;,
    constraint =&gt; max_length&#40;200&#41;,
  }
],

Which makes sure we don&#39;t get duplicate email accounts and keeps the
length to a max of 200 characters.

Then in the template I can access them like this:

[% errors.invalid.email.exists %]This email address is already
registered[% END %]
[% errors.invalid.email.length %]The email address is too long[% END %]
[% errors.missing.email %]The email field is a required field[% END %]


As for an API into D::FV that generates the results like this.  That
is a tough one.  It is not that far off what is already returned.  We
are just returning a hashes for everything, instead of arrays.  The
easiest might be to pull an idea from DBI with the
fetchall_arrayref&#40;{}&#41; which will return hashes instead of arrays.  So
a call to $results-&gt;invalid would remain the same, but
$results-&gt;invalid&#40;{}&#41; returns the new hash only form.  The same could
work for missing.

It is a bit magical though, so it might be better to pass in a named
parameter directly, or to provide new methods for it.  It&#39;s really up
to you what you like.

Cheers,

Cees


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">----- End forwarded message -----
-- 
<span class="clickylink"><a target="new" rel="nofollow" href="http://mark.stosberg.com/">http://mark.stosberg.com/</a></span> 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;13&nbsp;12:49:44&nbsp;2005</span>
    <span class="description">MARKSTOS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
