<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #63801 for PAR-Packer: setuid pp&#39;ed scripts: 1st invocation fails, 2nd+ call ok</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #63801 for PAR-Packer: setuid pp&#39;ed scripts: 1st invocation fails, 2nd+ call ok</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=PAR-Packer">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=PAR-Packer">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=PAR-Packer">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=PAR-Packer">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/PAR-Packer">PAR-Packer CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">63801</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=PAR-Packer">PAR-Packer</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bitcard [...] post2.25u.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-41710-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.008    </td>
  </tr>
  <tr id="CF-41711-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=63801">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-867043" href="/Public/Bug/Display.html?id=63801#txn-867043">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;10&nbsp;13:44:41&nbsp;2010</span>
    <span class="description">bitcard [...] post2.25u.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> setuid pp&#39;ed scripts: 1st invocation fails, 2nd+ call ok</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/867043/448986/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/448986">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 772b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dear maintainers,

setuid pp&#39;ed binaries fail upon first invocation. Here&#39;s how to 
reproduce:


/tmp$ cat &gt; suidtest.pl
#!/usr/bin/perl
print &#34;hello, world, this is $&lt; running as $&gt;!\n&#34;;
/tmp$ pp -o suidtest suidtest.pl 
/tmp$ sudo chown root:root suidtest
/tmp$ sudo chmod 6755 suidtest
/tmp$ sudo mv suidtest /
/tmp$ ls -l /suidtest
-rwsr-sr-x 1 root root 3792430 Dec 10 19:23 /suidtest
/tmp$ /suidtest 
Insecure dependency in utime while running setuid at 
/home/userid/.lib/perl-5.12.2/lib/site_perl/5.12.2/Archive/Zip/Directory
Member.pm line 63.
eagle323:/tmp$ /suidtest 
hello, world, this is 32288 running as 0!


Depending on what other files are included in the pp&#39;ed archive, the 
failure appears in different locations.

Could you please have a look at this?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-870938" href="/Public/Bug/Display.html?id=63801#txn-870938">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;19&nbsp;11:16:26&nbsp;2010</span>
    <span class="description">RSCHUPP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/870938/451044/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/451044">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 278b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2010-12-10 13:44:41, arost wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; /tmp$ sudo chown root:root suidtest
&gt; /tmp$ sudo chmod 6755 suidtest
</div>
As I already wrote in #62552, packed executables are not
meant to be run setuid and - as far as I&#39;m concerned -
never will be. So don&#39;t do that then.

Cheers, Roderich
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-870941" href="/Public/Bug/Display.html?id=63801#txn-870941">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;19&nbsp;11:16:27&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-870943" href="/Public/Bug/Display.html?id=63801#txn-870943">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;19&nbsp;11:18:11&nbsp;2010</span>
    <span class="description">RSCHUPP [...] cpan.org -  Severity Important changed to Wishlist</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-871171" href="/Public/Bug/Display.html?id=63801#txn-871171">#</a>      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;20&nbsp;06:28:54&nbsp;2010</span>
    <span class="description">bitcard [...] post2.25u.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bitcard [...] post2.25u.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/871171/451168/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/451168">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Dec 19 11:16:26 2010, RSCHUPP wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; As I already wrote in #62552, packed executables are not
&gt; meant to be run setuid and - as far as I&#39;m concerned -
&gt; never will be. So don&#39;t do that then.
</div>
This fact is clear now, thanks.

I don&#39;t understand the rationale, though - to users of the pp 
&#34;compiler&#34;, this sounds like the gcc people saying that they don&#39;t care 
about gcc generating broken setuid binaries, since they cannot guarantee  
that gcc does not introduce security leaks in such binaries. Some 
background would be helpful here also for others who discover that pp 
does not support setuid execution.

In any case: I do appreciate your contribution to this tremendously 
useful package, so no need to argue here. We will try switching to sudo 
now &#40;but, read on please, since there may be similar problems with 
that&#41;.

As a matter of fact, pp&#39;ed binaries _do_ run setuid, they just suffer 
from some rather smaller glitches resulting from ownership of cached 
files.  I wonder if those problems will also appear when running a pp&#39;ed 
program via sudo &#40;and then changing the effective user id during 
execution&#41;:
1/ cache directory is created as /tmp/par-&lt;real username&gt;
2/ but the owner of the cache entries is root
3/ it seems that PAR tries to put some file into the cache at a later 
point during the program&#39;s lifetime
4/ but if the effective user id is not root at that time, then this 
*fails* due to &#34;2&#34;.

Making the cache world-writable fixes the problem under 4/, and the 
pp&#39;ed program runs fine even though it&#39;s setuid root.

It looks like a rather straightforward solution for this is to ensure 
that any cache files will *always* be read and written with the *real 
user id*, not the effective one.

If this is not the case, then also users of sudo &#40;who switch the 
effective user id in their program&#41; will run into the same problem, 
since the cache belongs to root, and it&#39;s not writeable by non-root 
users.

Cheers/alex
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-871230" href="/Public/Bug/Display.html?id=63801#txn-871230">#</a>      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;20&nbsp;07:51:04&nbsp;2010</span>
    <span class="description">roderich.schupp [...] googlemail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #63801] setuid pp&#39;ed scripts: 1st invocation fails, 2nd+ call ok</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 20 Dec 2010 13:50:56 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PAR-Packer [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Roderich Schupp &lt;roderich.schupp [...] googlemail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/871230/451196/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/451196">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, Dec 20, 2010 at 12:28 PM, Alexander Ost via RT
&lt;bug-PAR-Packer@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I don&#39;t understand the rationale, though - to users of the pp
</div>
My thinking here is: The packed executable should strive to exhibit the
same behaviour as the original perl script.

I have no problem with people writing setuid scripts that have
security problems. But a packed executable uses several Perl modules
internally &#40;i.e. unaware to user&#41; and all  these and their usage would have
to be audited not to introduce _additional_ security problems.
Moreover, the packed executable uses a custom Perl interpreter
with a small C prologue and that would have to be audited as well.
Especially cumbersome is the bootstrap process &#40;the packed
executable extracts another executable and then execs that&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; As a matter of fact, pp&#39;ed binaries _do_ run setuid, they just suffer
&gt; from some rather smaller glitches resulting from ownership of cached
&gt; files. Â I wonder if those problems will also appear when running a pp&#39;ed
&gt; program via sudo &#40;and then changing the effective user id during
&gt; execution&#41;:
&gt; 1/ cache directory is created as /tmp/par-&lt;real username&gt;
</div>
Yeah, but you can overwite the name of the cache directory
&#40;PAR_GLOBAL_TMPDIR IIRC&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 3/ it seems that PAR tries to put some file into the cache at a later
&gt; point during the program&#39;s lifetime
</div>
Correct. Some stuff will only be extracted on demand.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Making the cache world-writable fixes the problem under 4/, and the
</div>
Thereby creating a security hole you can drive an aicraft carrier through.

Cheers, Roderich
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-871248" href="/Public/Bug/Display.html?id=63801#txn-871248">#</a>      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;20&nbsp;08:24:13&nbsp;2010</span>
    <span class="description">bitcard [...] post2.25u.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bitcard [...] post2.25u.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/871248/451206/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/451206">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 835b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Dec 20 07:51:04 2010, roderich.schupp@googlemail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon, Dec 20, 2010 at 12:28 PM, Alexander Ost via RT
<div class="message-stanza open">&gt; &gt; 3/ it seems that PAR tries to put some file into the cache at a later
&gt; &gt; point during the program&#39;s lifetime
</div>&gt; 
&gt; Correct. Some stuff will only be extracted on demand.
</div>
I just verified that &#40;as suspected&#41; this breaks any script that changes its effective 
uid during runtime, because it leads to ownership clashes in the cache directory.

No matter if the change is due to setuid or because of some the script itself changes 
the id.

So... is there
a&#41; any way to &#34;request&#34; that the whole archive is extracted *completely* into the cache?
or
b&#41; what would you think about a solution where all cache entry access &#40;esp writing&#41; is 
ONLY done with the real user id, not the effective user id?

Cheers/alex
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-871486" href="/Public/Bug/Display.html?id=63801#txn-871486">#</a>      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;20&nbsp;17:53:46&nbsp;2010</span>
    <span class="description">smueller [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #63801] setuid pp&#39;ed scripts: 1st invocation fails, 2nd+ call ok </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 20 Dec 2010 23:53:36 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PAR-Packer [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Steffen Mueller &lt;smueller [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/871486/451330/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/451330">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On Dec 20, 2010, at 2:24 PM, Alexander Ost via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       Queue: PAR-Packer
&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=63801">https://rt.cpan.org/Ticket/Display.html?id=63801</a></span> &gt;
&gt; 
&gt; On Mon Dec 20 07:51:04 2010, roderich.schupp@googlemail.com wrote:
<div class="message-stanza open">&gt;&gt; On Mon, Dec 20, 2010 at 12:28 PM, Alexander Ost via RT
<div class="message-stanza open">&gt;&gt;&gt; 3/ it seems that PAR tries to put some file into the cache at a later
&gt;&gt;&gt; point during the program&#39;s lifetime
</div>&gt;&gt; 
&gt;&gt; Correct. Some stuff will only be extracted on demand.
</div>&gt; 
&gt; I just verified that &#40;as suspected&#41; this breaks any script that changes its effective 
&gt; uid during runtime, because it leads to ownership clashes in the cache directory.
&gt; 
&gt; No matter if the change is due to setuid or because of some the script itself changes 
&gt; the id.
&gt; 
&gt; So... is there
&gt; a&#41; any way to &#34;request&#34; that the whole archive is extracted *completely* into the cache?
&gt; or
&gt; b&#41; what would you think about a solution where all cache entry access &#40;esp writing&#41; is 
&gt; ONLY done with the real user id, not the effective user id?
</div>
Try installing Archive::Unzip::Burst on the dev machine. If it succeeds, it will be packed into the executable and everything will be extracted on the first invocation.

Roderich&#39;s concerns, however, remain valid. a setuid pp&#39;d executable is not guaranteed safe.\

Best regards,
Steffen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-871752" href="/Public/Bug/Display.html?id=63801#txn-871752">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;21&nbsp;10:56:00&nbsp;2010</span>
    <span class="description">bitcard [...] post2.25u.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bitcard [...] post2.25u.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/871752/451462/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/451462">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Dec 20 17:53:46 2010, SMUELLER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; On Dec 20, 2010, at 2:24 PM, Alexander Ost via RT wrote:
&gt; [...]
<div class="message-stanza open">&gt; &gt; a&#41; any way to &#34;request&#34; that the whole archive is extracted
</div>&gt; *completely* into the cache?
&gt; [...]
&gt; Try installing Archive::Unzip::Burst on the dev machine. If it
&gt; succeeds, it will be packed into the executable and everything will be
&gt; extracted on the first invocation.
</div>
Thanks for the hint. Ironically, even though I switched to using sudo
now, this fixes the setuid problem posted originally for this bug.

However, for setuid, this doesn&#39;t solve the problem
completely. Starting my application &#40;including &#34;use
Archive::Unzip::Burst&#34;&#41; via sudo, I get the following error in the
middle of the execution:

  Permission denied at /home/builder/.lib/perl-5.10.0-
nt/lib/site_perl/5.10.0/PAR/Heavy.pm line 160.
  Compilation failed in require at XML/Parser.pm line 18.
  BEGIN failed--compilation aborted at XML/Parser.pm line 22.
  Compilation failed in require at XML/SAX/Expat.pm line 11.
  BEGIN failed--compilation aborted at XML/SAX/Expat.pm line 11.
  Compilation failed in require at &#40;eval 71&#41; line 1.

Line 160 in Heavy.pm &#40;version 0.12&#41; is an open&#40;&#41; statement in sub
_dl_extract that requires write access.

To find the culprit, I made the PAR cache world writeable and started
over. After that the application runs fine, and one file has been
added to the cache. That file corresponds to

  lib/site_perl/5.10.0/i686-linux-thread-
multi/auto/XML/Parser/Expat/Expat.so

So this file hasn&#39;t been extracted at the beginning, and later on,
extraction fails, because in the meantime the application has dropped
root priviledges.

I could now work around this by explicitly require-ing XML::SAX::Expat
at the very beginning of the main module, but this is no general
solution of course.

Would there be any way to enforce a &#40;really&#41; complete &#34;unpack&#34; at the
very beginning? Or, as suggested before, maybe it&#39;s even better to
make cache handling independent of the applications current effective
user id. Which makes sense, since the cache handling &#40;I think&#41; is
something that should be completely transparent to the application.

One last remark, maybe this is relevant: XML::SAX::Expat was added
explicitly on the pp command line with

  -l &#34;/usr/lib/libexpat.so&#34; -M &#34;XML::SAX::Expat&#34;


Thanks again for your help,
/alex
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-871837" href="/Public/Bug/Display.html?id=63801#txn-871837">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;21&nbsp;12:56:07&nbsp;2010</span>
    <span class="description">bitcard [...] post2.25u.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bitcard [...] post2.25u.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/871837/451510/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/451510">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 268b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Oh my, this gets confusing now. The paragraph above should read

  However, for **sudo**, this doesn&#39;t solve the problem
  completely.

So Steffen&#39;s workaround does not solve the cache ownership problem that 
exists when running pp&#39;ed application via *sudo*.

Br/alex
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-872225" href="/Public/Bug/Display.html?id=63801#txn-872225">#</a>      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;22&nbsp;05:00:46&nbsp;2010</span>
    <span class="description">RSCHUPP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/872225/451693/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/451693">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2010-12-21 10:56:00, arost wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Line 160 in Heavy.pm &#40;version 0.12&#41; is an open&#40;&#41; statement in sub
&gt; _dl_extract that requires write access.
</div>
Which - unfortunately - can&#39;t be helped for security reasons
&#40;for the non-setuid usecase&#41;.

Archive::Unzip::Burst has probably done its job and extracted
Expat.so - but using its actual name &#40;and path&#41;. However,
PAR::Heavy insists on looking for Expat.so first in the packed
executable &#40;treated as a .par archive&#41; and then extracts it
again using a mangled name.

Now, if one were to abandon the whole name mangling scheme...

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Or, as suggested before, maybe it&#39;s even better to
&gt; make cache handling independent of the applications current effective
&gt; user id. Which makes sense, since the cache handling &#40;I think&#41; is
&gt; something that should be completely transparent to the application.
</div>
No, it doesn&#39;t make sense: the cache is per user &#40;for a reason&#41;
and YOU break transparency by &#34;switching users&#34; in midstream.
Sorry, but this not different from e.g. a script manipulating
@INC in nasty ways at runtime or invoking $^X.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; One last remark, maybe this is relevant: XML::SAX::Expat was added
&gt; explicitly on the pp command line with
&gt; 
&gt;   -l &#34;/usr/lib/libexpat.so&#34; -M &#34;XML::SAX::Expat&#34;
</div>
No, that shouldn&#39;t make any difference. What matters is that
XML::SAX::Expat is loaded by your script at runtime &#40;probably
required by XML::Simple or similar&#41;, instead of compile time
&#40;i.e. via &#34;use XML::SAX::Expat&#34;&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So Steffen&#39;s workaround does not solve the cache ownership 
&gt; problem that exists when running pp&#39;ed application via *sudo*.
</div>
Actually, it&#39;s not the use of sudo per se - it&#39;s your script
calling setuid at runtime.

Cheers, Roderich
Cheers, Roderich
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-872238" href="/Public/Bug/Display.html?id=63801#txn-872238">#</a>      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;22&nbsp;06:24:46&nbsp;2010</span>
    <span class="description">bitcard [...] post2.25u.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bitcard [...] post2.25u.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/872238/451700/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/451700">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 22 05:00:46 2010, RSCHUPP wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 2010-12-21 10:56:00, arost wrote:
&gt; [...]
<div class="message-stanza open">&gt; &gt; Or, as suggested before, maybe it&#39;s even better to
&gt; &gt; make cache handling independent of the applications current effective
&gt; &gt; user id. Which makes sense, since the cache handling &#40;I think&#41; is
&gt; &gt; something that should be completely transparent to the application.
</div>&gt; 
&gt; No, it doesn&#39;t make sense: the cache is per user &#40;for a reason&#41;
&gt; and YOU break transparency by &#34;switching users&#34; in midstream.
&gt; Sorry, but this not different from e.g. a script manipulating
&gt; @INC in nasty ways at runtime or invoking $^X.
</div>
I don&#39;t agree to that. For @INC, I know that @INC can be subject to
external settings in the environment and that @INC affects the runtime
behaviour of my Perl application - so I know that I have to be careful fiddling
with that, no matter if pp&#39;ed or not. Also for $^X, I&#39;d _expect_ things
to be different in a pp&#39;ed world.

setuid&#40;&#41;, in contrast, is a systemcall like any other, which normally
has no impact on the behaviour of a Perl application &#40;from a Perl point
of view&#41;, so in that sense, it is completely orthogonal to the world of
Perl. In the pp&#39;ed Perl world, this is no longer true.

The per-user nature of caching I don&#39;t question at all - my suggestion is
rather to _enforce_ its per-user nature, by _always_ accessing the cache with the
real user id, and _not_ taking into account any later changes to the
effective user id.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Actually, it&#39;s not the use of sudo per se - it&#39;s your script
&gt; calling setuid at runtime.
</div>
Yep. So, to summarize, pp users must be aware of these three
points then:
1/ do not use setuid
2/ do not use POSIX::setuid&#40;&#41;, and do not modify $&gt;/$&#41;
3/ if 2/ cannot be avoided, then workaround the PAR cache problems by
   a&#41; use Archive::Unzip::Burst, and
   b&#41; explicitly require any &#34;leftovers&#34; before the first call
      to setuid&#40;&#41;

Cheers/alex
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1272802" href="/Public/Bug/Display.html?id=63801#txn-1272802">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;09&nbsp;08:02:43&nbsp;2013</span>
    <span class="description">RSCHUPP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1272802/674054/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/674054">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 69b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Creating safe setuid executables is not &#40;and will never be&#41; supported
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1272806" href="/Public/Bug/Display.html?id=63801#txn-1272806">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;09&nbsp;08:02:44&nbsp;2013</span>
    <span class="description">RSCHUPP [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.599273</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
