<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #34408 for DBD-SQLite: Primary key name wrong with newline in CREATE TABLE</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #34408 for DBD-SQLite: Primary key name wrong with newline in CREATE TABLE</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-SQLite/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-SQLite">DBD-SQLite CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">34408</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-SQLite/Active/">DBD-SQLite</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ilmari+cpan [...] ilmari.org

<br />
pancho [...] pancho.name

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-10248-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.14    </td>
  </tr>
  <tr id="CF-10249-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




DBD-SQLite-PK.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/439425/215238/DBD-SQLite-PK.diff">
Mon Mar 24 19:51:21 2008 (438b) by ilmari+cpan [...] ilmari.org
</a>
</font></li>
</ul>


signature.asc<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/496379/245717/signature.asc">
Mon Aug 11 15:06:46 2008 (197b) by pancho [...] pancho.name
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;24&nbsp;19:51:21&nbsp;2008</span>
    <span class="description">ilmari+cpan [...] ilmari.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Primary key name wrong with newline in CREATE TABLE</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">If there&#39;s a newline before the opening bracket in CREATE TABLE,
DBD::SQLite misparses the name of inline primary keys. Attached is a
patch that fixes this by adding /s to the regex that strips off &#34;CREATE
TABLE&#34;.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> DBD-SQLite-PK.diff</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- a/lib/DBD/SQLite.pm	2008-03-24 23:12:03.000000000 +0000
+++ b/lib/DBD/SQLite.pm	2008-03-24 23:12:42.000000000 +0000
@@ -208,7 +208,7 @@
 	my @pk = split /\s*,\s*/, $2 || &#39;&#39;;
 	unless &#40;@pk&#41; {
 	    my $prefix = $1;
-	    $prefix =~ s/.*create\s+table\s+.*?\&#40;\s*//i;
+	    $prefix =~ s/.*create\s+table\s+.*?\&#40;\s*//si;
 	    $prefix = &#40;split /\s*,\s*/, $prefix&#41;[-1];
 	    @pk = &#40;split /\s+/, $prefix&#41;[0]; # take first word as name
 	}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Create even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;11&nbsp;15:06:46&nbsp;2008</span>
    <span class="description">pancho [...] pancho.name - Ticket #38404:  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> does not parse apparently correct SQL schema with sqlite</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 11 Aug 2008 21:04:56 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class-Schema-Loader [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Pancho Horrillo &lt;pancho [...] pancho.name&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, folks!

&#40;Version: DBIx-Class-Schema-Loader-0.04005&#41;.

I was testing a simple catalyst app, and I found out this:

If I create the sqlite database with this sql:

CREATE TABLE post
&#40;
        id      integer NOT NULL PRIMARY KEY,
        person_id integer,
        text    text,
        FOREIGN KEY&#40;person_id&#41; REFERENCES person&#40;id&#41;
&#41;;

CREATE TABLE person
&#40;
        id integer NOT NULL PRIMARY KEY,
        name text
&#41;;

sqlite is happy about it, and creates the database correctly.
But, trying to create a schema from it fails:

# Code taken from the documentation, just adjusted the dsn to point to sqlite instead of pg.
$ perl -MDBIx::Class::Schema::Loader=make_schema_at,dump_to_dir:./lib \
-e &#39;make_schema_at&#40;&#34;New::Schema::Name&#34;, { debug =&gt; 1 }, [ &#34;dbi:SQLite:dbname=db&#34; ]&#41;&#39;
New::Schema::Name::Post-&gt;load_components&#40;&#34;Core&#34;&#41;;
New::Schema::Name::Person-&gt;load_components&#40;&#34;Core&#34;&#41;;
New::Schema::Name::Post-&gt;table&#40;&#34;post&#34;&#41;;
New::Schema::Name::Post-&gt;add_columns&#40;
  &#34;id&#34;,
  { data_type =&gt; &#34;integer&#34;, is_nullable =&gt; 0, size =&gt; undef },
  &#34;person_id&#34;,
  { data_type =&gt; &#34;integer&#34;, is_nullable =&gt; 0, size =&gt; undef },
  &#34;text&#34;,
  { data_type =&gt; &#34;text&#34;, is_nullable =&gt; 0, size =&gt; undef },
&#41;;
New::Schema::Name::Post-&gt;set_primary_key&#40;&#34;create&#34;&#41;;
DBIx::Class::Schema::Loader::make_schema_at&#40;&#41;: No such column create on table post at -e line 1
$ 


N.B.: set_primary_key&#40;&#34;create&#34;&#41;; makes no sense.

If instead I create the database with this code:

CREATE TABLE post&#40;
        id      integer NOT NULL PRIMARY KEY,
        person_id integer,
        text    text,
        FOREIGN KEY&#40;person_id&#41; REFERENCES person&#40;id&#41;
&#41;;

CREATE TABLE person&#40;
        id integer NOT NULL PRIMARY KEY,
        name text
&#41;;

everything goes smoothly:

$ perl -MDBIx::Class::Schema::Loader=make_schema_at,dump_to_dir:./lib \
-e &#39;make_schema_at&#40;&#34;New::Schema::Name&#34;, { debug =&gt; 1 }, [ &#34;dbi:SQLite:dbname=db&#34; ]&#41;&#39;
New::Schema::Name::Post-&gt;load_components&#40;&#34;Core&#34;&#41;;
New::Schema::Name::Person-&gt;load_components&#40;&#34;Core&#34;&#41;;
New::Schema::Name::Post-&gt;table&#40;&#34;post&#34;&#41;;
New::Schema::Name::Post-&gt;add_columns&#40;
  &#34;id&#34;,
  { data_type =&gt; &#34;integer&#34;, is_nullable =&gt; 0, size =&gt; undef },
  &#34;person_id&#34;,
  { data_type =&gt; &#34;integer&#34;, is_nullable =&gt; 0, size =&gt; undef },
  &#34;text&#34;,
  { data_type =&gt; &#34;text&#34;, is_nullable =&gt; 0, size =&gt; undef },
&#41;;
New::Schema::Name::Post-&gt;set_primary_key&#40;&#34;id&#34;&#41;;
New::Schema::Name::Person-&gt;table&#40;&#34;person&#34;&#41;;
New::Schema::Name::Person-&gt;add_columns&#40;
  &#34;id&#34;,
  { data_type =&gt; &#34;integer&#34;, is_nullable =&gt; 0, size =&gt; undef },
  &#34;name&#34;,
  { data_type =&gt; &#34;text&#34;, is_nullable =&gt; 0, size =&gt; undef },
&#41;;
New::Schema::Name::Person-&gt;set_primary_key&#40;&#34;id&#34;&#41;;
New::Schema::Name::Person-&gt;has_many&#40;
  &#34;posts&#34;,
  &#34;New::Schema::Name::Post&#34;,
  { &#34;foreign.person_id&#34; =&gt; &#34;self.id&#34; },
&#41;;
New::Schema::Name::Post-&gt;belongs_to&#40;
  &#34;person_id&#34;,
  &#34;New::Schema::Name::Person&#34;,
  { id =&gt; &#34;person_id&#34; },
&#41;;
Dumping manual schema for New::Schema::Name to directory ./lib ...
Schema dump completed.
$ 


The only difference is the position of the left parentheses.
The new line seems to adversely affect the module.

I&#39;m not the first struck by this bug:
<span class="clickylink"><a target="new" rel="nofollow" href="http://perlmonks.org/?node_id=646439">http://perlmonks.org/?node_id=646439</a></span>

Since catalyst&#39;s dummy_create.pl helper uses DBIx-Class-Schema-Loader to do the job:
$ myapp_create.pl model DBIC::Schema 
$ script/dummy_create.pl model DB DBIC::Schema Dummy::Schema create=static dbi:SQLite:dbname=db
 exists &#34;/home/pancho/catalyst/Dummy/script/../lib/Dummy/Model&#34;
 exists &#34;/home/pancho/catalyst/Dummy/script/../t&#34;
DBIx::Class::Schema::Loader::make_schema_at&#40;&#41;: No such column create on table post at /usr/share/perl5/Catalyst/Helper/Model/DBIC/Schema.pm line 126
$ 

But does the job nicely when using the second sql to create the db.



Hope that it helps.  If you need more info, please feel free to contact me.

My sincere thanks for your work.

Friendly,

pancho.

-- 
pancho horrillo

To be conscious that
you are ignorant is a great step
to knowledge.

                Benjamin Disraeli
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/496379/245717/signature.asc">Download signature.asc</a><br />
<span class="downloadcontenttype">application/pgp-signature 197b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;11&nbsp;19:48:03&nbsp;2008</span>
    <span class="description">ilmari+cpan [...] ilmari.org - Ticket #38404:  Merged into ticket #34408</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;11&nbsp;19:48:03&nbsp;2008</span>
    <span class="description">ilmari+cpan [...] ilmari.org -  Merged into ticket #34408</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;04&nbsp;00:10:58&nbsp;2009</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Confirming resolved, and added regression test in 1.19_08
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;04&nbsp;00:11:00&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;04&nbsp;00:11:02&nbsp;2009</span>
    <span class="description">adamk [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
