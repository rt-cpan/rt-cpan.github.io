<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #77321 for Fuse: memory leak</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #77321 for Fuse: memory leak</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Fuse/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Fuse/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Fuse/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Fuse/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Fuse">Fuse CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">77321</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Fuse/Active/">Fuse</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
CYGA [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-13886-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.14</li>
<li>
0.15.1</li>
</ul>
    </td>
  </tr>
  <tr id="CF-13887-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.16    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;21&nbsp;03:52:31&nbsp;2012</span>
    <span class="description">CYGA [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> memory leak</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sample script I attached &#40;mem2.pl&#41; leaks on simple ls.
I also attached log for output:
$ for i in `seq 1024`;do ls /tmp/fuse-mem-test 2&gt;&#38;1 1&gt;/dev/null; ps faux 
| grep mem2 | grep perl | grep -v grep; done 2&gt;&#38;1 | tee -a mem.log

Checked in 0.14 from metacpan/cpan,
and in 0.15.1 from github &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/dpavlin/perl-fuse&#41;">https://github.com/dpavlin/perl-fuse&#41;</a></span>.

Sample script returns hardcoded stats entry.
And 1024 such entries in readdir.
So, even if we consider it loads 1024 such entries in memory,
it still keeps eating memory on new ls calls.
Since structures are all the same, it&#39;s definitely a leak.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> mem2.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w
use strict;
use Fuse;

my $mount_point = shift @ARGV;

my $dumb_attr   = [
    0,          # dev
    1102499,    # ino
    17917,      # mode
    1,          # nlink
    0,          # uid
    0,          # gid
    0,          # rdev
    0,          # size
    1332539095, # atime
    1332206658, # mtime
    1326627143, # ctime
    1024,       # blksize
    1,          # blocks
];

sub getattr_fs { return @$dumb_attr }
sub readdir_fs {
    return &#40;0&#41;    if 1024 == $_[1];
    return &#40;
        [
            1+$_[1],
            &#39;a&#39;,
            $dumb_attr,
        ],
        0,
    &#41;;
}

eval {
    Fuse::main&#40;
        mountpoint  =&gt; $mount_point,
        mountopts   =&gt; &#39;allow_other&#39;,
        &#39;getattr&#39;   =&gt; &#39;main::getattr_fs&#39;,
        &#39;readdir&#39;   =&gt; &#39;main::readdir_fs&#39;,
        threaded    =&gt; 0,
    &#41;;
};
die &#34;$mount_point error: &#34; . $@ if $@;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> mem.log</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;01&nbsp;00:28:49&nbsp;2012</span>
    <span class="description">CYGA [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Any plans for fixing it?

On Mon May 21 03:52:31 2012, CYGA wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sample script I attached &#40;mem2.pl&#41; leaks on simple ls.
&gt; I also attached log for output:
&gt; $ for i in `seq 1024`;do ls /tmp/fuse-mem-test 2&gt;&#38;1 1&gt;/dev/null; ps 
</div>faux 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; | grep mem2 | grep perl | grep -v grep; done 2&gt;&#38;1 | tee -a mem.log
&gt; 
&gt; Checked in 0.14 from metacpan/cpan,
&gt; and in 0.15.1 from github &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/dpavlin/perl-fuse&#41;">https://github.com/dpavlin/perl-fuse&#41;</a></span>.
&gt; 
&gt; Sample script returns hardcoded stats entry.
&gt; And 1024 such entries in readdir.
&gt; So, even if we consider it loads 1024 such entries in memory,
&gt; it still keeps eating memory on new ls calls.
&gt; Since structures are all the same, it&#39;s definitely a leak.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;01&nbsp;00:28:50&nbsp;2012</span>
    <span class="description">CYGA [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;28&nbsp;09:01:07&nbsp;2012</span>
    <span class="description">CYGA [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Any response?

On Fri Jun 01 00:28:49 2012, CYGA wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Any plans for fixing it?
&gt; 
&gt; On Mon May 21 03:52:31 2012, CYGA wrote:
<div class="message-stanza open">&gt; &gt; Sample script I attached &#40;mem2.pl&#41; leaks on simple ls.
&gt; &gt; I also attached log for output:
&gt; &gt; $ for i in `seq 1024`;do ls /tmp/fuse-mem-test 2&gt;&#38;1 1&gt;/dev/null; ps 
</div>&gt; faux 
<div class="message-stanza open">&gt; &gt; | grep mem2 | grep perl | grep -v grep; done 2&gt;&#38;1 | tee -a mem.log
&gt; &gt; 
&gt; &gt; Checked in 0.14 from metacpan/cpan,
&gt; &gt; and in 0.15.1 from github &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/dpavlin/perl-fuse&#41;">https://github.com/dpavlin/perl-fuse&#41;</a></span>.
&gt; &gt; 
&gt; &gt; Sample script returns hardcoded stats entry.
&gt; &gt; And 1024 such entries in readdir.
&gt; &gt; So, even if we consider it loads 1024 such entries in memory,
&gt; &gt; it still keeps eating memory on new ls calls.
&gt; &gt; Since structures are all the same, it&#39;s definitely a leak.
</div>&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;30&nbsp;20:43:17&nbsp;2013</span>
    <span class="description">demon [...] now.ai -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">After some poking around, I believe I isolated the issue that was causing the problem. Can you try the current git master branch and see if that addresses the problem?

See commit <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/dpavlin/perl-fuse/commit/071831e39677044477b56895ce8ff3ef9a8849e7">https://github.com/dpavlin/perl-fuse/commit/071831e39677044477b56895ce8ff3ef9a8849e7</a></span> for details.

-- 
Derrik Pates
demon@now.ai
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;02&nbsp;04:18:19&nbsp;2013</span>
    <span class="description">CYGA [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Aug 30 20:43:17 2013, DPATES wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; After some poking around, I believe I isolated the issue that was
&gt; causing the problem. Can you try the current git master branch and see
&gt; if that addresses the problem?
&gt; 
&gt; See commit <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/dpavlin/perl-">https://github.com/dpavlin/perl-</a></span>
&gt; fuse/commit/071831e39677044477b56895ce8ff3ef9a8849e7 for details.
</div>
I tried the latest version &#40;with &#34;Okay, those sv_2mortal&#40;&#41;s were bad.&#34;&#41; - same test works great.
Those:
+                SP -= prv - 1;
make perfect sense.
Will apply it on production.
Thanks.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;02&nbsp;04:18:20&nbsp;2013</span>
    <span class="description">CYGA [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;02&nbsp;04:18:20&nbsp;2013</span>
    <span class="description">CYGA [...] cpan.org -  Fixed in 0.15 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;25&nbsp;22:38:52&nbsp;2013</span>
    <span class="description">demon [...] now.ai -  Fixed in 0.16 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;25&nbsp;22:38:53&nbsp;2013</span>
    <span class="description">demon [...] now.ai -  Fixed in 0.15 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
