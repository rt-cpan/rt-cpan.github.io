<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #99892 for Win32-TieRegistry: Win32::TieRegistry::ValueNames error with Strawberry Perl 5.20</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #99892 for Win32-TieRegistry: Win32::TieRegistry::ValueNames error with Strawberry Perl 5.20</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Win32-TieRegistry/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Win32-TieRegistry/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Win32-TieRegistry/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Win32-TieRegistry/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Win32-TieRegistry">Win32-TieRegistry CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">99892</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Win32-TieRegistry/Active/">Win32-TieRegistry</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Bruce.Reed [...] infor.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-35796-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-35797-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.28    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




image001.png<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1426785/757979/image001.png">
Wed Oct 29 14:40:34 2014 (889b) by Bruce.Reed [...] infor.com
</a>
</font></li>
</ul>


TieRegistry-fix.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1464828/779659/TieRegistry-fix.txt">
Tue Feb 17 16:45:33 2015 (1.6k) by https://me.yahoo.com/a/ds3mWF8kldI4wC49Z_iMk5EMSDPe#1e821
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;29&nbsp;14:40:34&nbsp;2014</span>
    <span class="description">Bruce.Reed [...] infor.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Jean McAllister &lt;Jean.Mcallister [...] infor.com&gt;, Mark Hewitt &lt;Mark.Hewitt [...] infor.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Win32::TieRegistry::ValueNames error with Strawberry Perl 5.20</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 29 Oct 2014 18:40:16 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Win32-TieRegistry [...] rt.cpan.org&#34; &lt;bug-Win32-TieRegistry [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Bruce Reed &lt;Bruce.Reed [...] infor.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is in Version 0.26 of Win32::TieRegistry.

There are actually two issues here.

Issue #1
ValueNames calls  _enumValues.
If _enumValues does not set $self-&gt;{VALUES} for any reason, it remains an undefined value.
Then ValueNames still tries to use as an Array reference it at line 682 without checking if it&#39;s set.

Issue #2 - this is the real problem
_enumValues is making this call to a Win32API::Registry function:
    my $nlen= 1+$self-&gt;Information&#40;&#34;MaxValNameLen&#34;&#41;;
    while&#40;  $self-&gt;RegEnumValue&#40;$pos++,$name,$nlen,[],[],[],[]&#41;  &#41; {
According to the documentation for Win32API::Registry:
$plValName initially specifies the [minimum] buffer size to be allocated for $sValName. Will be set to the length of the value name if the requested value exists even if $sValName isn&#39;t successfully set to the value name. See &#34;Buffer sizes&#34; for more information.

&#34;$plValName&#34; is $nlen in this function call.

$nlen is getting changed by the call to RegEnumValue, but is not getting reset to the MaxValNameLen value &#40;plus 1&#41; for the next call to RegEnumValue.

This works OK with ActivePerl 5.18 and Strawberry Perl 5.18, and I assume earlier versions of both.

However, it fails with Strawberry Perl 5.20 with this message:
Can&#39;t use an undefined value as an ARRAY reference at c:/Strawberry64/perl/vendor/lib/Win32/TieRegistry.pm line 682.

In my testing, if I reset $nlen to the value taken from MaxValNameLen, or just pass null &#40;undef&#41; instead of $nlen, it works OK even with Strawberry Perl 5.20.








[cid:image001.png@01CFEC4C.24180FA0]

Bruce Reed | Lead Software Engineer - Systems
office/mobile: 989 430 2897 | urgent: 9894302897@vtext.com&lt;mailto:9894302897@vtext.com&gt; | bruce.reed@infor.com&lt;mailto:bruce.reed@infor.com&gt; | <span class="clickylink"><a target="new" rel="nofollow" href="http://www.infor.com">http://www.infor.com</a></span>
</div></div>

<div class="messagebody">
</div>
</div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1426785/757979/image001.png">Download image001.png</a><br />
<span class="downloadcontenttype">image/png 889b</span>
</div>
<div class="messagebody">
<img alt="image001.png" title="image001.png" src="/Ticket/Attachment/1426785/757979/" /></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;30&nbsp;08:56:17&nbsp;2014</span>
    <span class="description">https://me.yahoo.com/a/ds3mWF8kldI4wC49Z_iMk5EMSDPe#1e821 -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bruce.reed [...] infor.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This problem occurs with Strawberry Perl 5.20.1, 32-bit and 64-bit.  It does not occur with 5.20.0 or 5.18.4.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;30&nbsp;08:56:17&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;30&nbsp;08:57:21&nbsp;2014</span>
    <span class="description">m.hewitt [...] computer.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Note that this issue occurs with perl 5.20.1, but not 5.20.0 in both 32 and 64-bit builds.

On Wed Oct 29 14:40:34 2014, Bruce.Reed@infor.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This is in Version 0.26 of Win32::TieRegistry.
&gt; 
&gt; There are actually two issues here.
&gt; 
&gt; Issue #1
&gt; ValueNames calls  _enumValues.
&gt; If _enumValues does not set $self-&gt;{VALUES} for any reason, it remains
&gt; an undefined value.
&gt; Then ValueNames still tries to use as an Array reference it at line
&gt; 682 without checking if it&#39;s set.
&gt; 
&gt; Issue #2 - this is the real problem
&gt; _enumValues is making this call to a Win32API::Registry function:
&gt;     my $nlen= 1+$self-&gt;Information&#40;&#34;MaxValNameLen&#34;&#41;;
&gt;     while&#40;  $self-&gt;RegEnumValue&#40;$pos++,$name,$nlen,[],[],[],[]&#41;  &#41; {
&gt; According to the documentation for Win32API::Registry:
&gt; $plValName initially specifies the [minimum] buffer size to be
&gt; allocated for $sValName. Will be set to the length of the value name
&gt; if the requested value exists even if $sValName isn&#39;t successfully set
&gt; to the value name. See &#34;Buffer sizes&#34; for more information.
&gt; 
&gt; &#34;$plValName&#34; is $nlen in this function call.
&gt; 
&gt; $nlen is getting changed by the call to RegEnumValue, but is not
&gt; getting reset to the MaxValNameLen value &#40;plus 1&#41; for the next call to
&gt; RegEnumValue.
&gt; 
&gt; This works OK with ActivePerl 5.18 and Strawberry Perl 5.18, and I
&gt; assume earlier versions of both.
&gt; 
&gt; However, it fails with Strawberry Perl 5.20 with this message:
&gt; Can&#39;t use an undefined value as an ARRAY reference at
&gt; c:/Strawberry64/perl/vendor/lib/Win32/TieRegistry.pm line 682.
&gt; 
&gt; In my testing, if I reset $nlen to the value taken from MaxValNameLen,
&gt; or just pass null &#40;undef&#41; instead of $nlen, it works OK even with
&gt; Strawberry Perl 5.20.
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; [cid:image001.png@01CFEC4C.24180FA0]
&gt; 
&gt; Bruce Reed | Lead Software Engineer - Systems
&gt; office/mobile: 989 430 2897 | urgent:
&gt; 9894302897@vtext.com&lt;mailto:9894302897@vtext.com&gt; |
&gt; bruce.reed@infor.com&lt;mailto:bruce.reed@infor.com&gt; |
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.infor.com">http://www.infor.com</a></span>
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;08&nbsp;08:57:48&nbsp;2014</span>
    <span class="description">ZARABOZO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is also a problema with the method SubKeyNames which calls _enumSubKeys. In there, the same thing happens with the while&#40;&#41; block calling $self-&gt;RegEnumKeyEx; if $namSiz and $clsSiz are reseted to $self-&gt;Information&#40;&#39;MaxSubKeyLen&#39;, &#39;MaxSubClassLen&#39;&#41;, then the error goes away and the function Works properly. Otherwise, it causes the error &#34;Can&#39;t use an undefined value as an ARRAY reference at D:/usr/site/lib/Win32/TieRegistry.pm line 718.&#34;

This is a very simple code case that causes the error:

use Win32::TieRegistry &#40;Delimiter =&gt; &#34;/&#34;, ArrayValues =&gt; 0&#41;;
for my $i &#40;$Registry-&gt;{&#34;LMachine/System&#34;}-&gt;SubKeyNames&#41; {
    print &#34;$i\n&#34;;
}
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;14&nbsp;09:09:07&nbsp;2014</span>
    <span class="description">frioux [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Nov 08 08:57:48 2014, ZARABOZO wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This is also a problema with the method SubKeyNames which calls
&gt; _enumSubKeys. In there, the same thing happens with the while&#40;&#41; block
&gt; calling $self-&gt;RegEnumKeyEx; if $namSiz and $clsSiz are reseted to
&gt; $self-&gt;Information&#40;&#39;MaxSubKeyLen&#39;, &#39;MaxSubClassLen&#39;&#41;, then the error
&gt; goes away and the function Works properly. Otherwise, it causes the
&gt; error &#34;Can&#39;t use an undefined value as an ARRAY reference at
&gt; D:/usr/site/lib/Win32/TieRegistry.pm line 718.&#34;
&gt; 
&gt; This is a very simple code case that causes the error:
&gt; 
&gt; use Win32::TieRegistry &#40;Delimiter =&gt; &#34;/&#34;, ArrayValues =&gt; 0&#41;;
&gt; for my $i &#40;$Registry-&gt;{&#34;LMachine/System&#34;}-&gt;SubKeyNames&#41; {
&gt;     print &#34;$i\n&#34;;
&gt; }
</div>
The problem is with Win32API::Registry.  See some good analysis here: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/Public/Bug/Display.html?id=123207">https://rt.perl.org/Public/Bug/Display.html?id=123207</a></span>

The only solution is to patch Win32API::Registry.  The author seems a little unresponsive &#40;see <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=37750.&#41;">https://rt.cpan.org/Ticket/Display.html?id=37750.&#41;</a></span>  If someone who knows XS would like to offer to take it over I think that would be best.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;17&nbsp;16:45:33&nbsp;2015</span>
    <span class="description">https://me.yahoo.com/a/ds3mWF8kldI4wC49Z_iMk5EMSDPe#1e821 -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Bruce Reed</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The error in TieRegistry.pm is in two places, in _enumValues and _enumSubKeys.

The error is caused by incorrect use of input/output length parameters when calling 2 Win32API::Registry functions.  Those query functions use the length parameters to allocate a buffer, then return the actual size in those same length parameters.

According to the Win32API::Registry description of buffers, those length parameters can be passed as NULL by sending [], then the buffer size will be determined automatically.

Since TieRegistry does not use the returned lengthed, it can just pass [] for all the length variables.

I have tested this *briefly* and it works in limited testing.

I have attached a file with a code snippet showing the fixes.
That file also shows other reported bugs that seem to be this same bug; it&#39;s been around a while, but seems to hide very well depending on internal details of Perl distributions.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> TieRegistry-fix.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">﻿=pod
Win32API::Registry Explanation of Buffers and buffer sizes <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~blm/Win32API-Registry-0.32/Registry.pm#Buffer_sizes">http://search.cpan.org/~blm/Win32API-Registry-0.32/Registry.pm#Buffer_sizes</a></span>

Related bug reports:
<span class="clickylink"><a target="new" rel="nofollow" href="http://community.activestate.com/forum-topic/tieregistry-module-fails">http://community.activestate.com/forum-topic/tieregistry-module-fails</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.perlmonks.org/?node_id=663433">http://www.perlmonks.org/?node_id=663433</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=25102">https://rt.cpan.org/Public/Bug/Display.html?id=25102</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=32598">https://rt.cpan.org/Public/Bug/Display.html?id=32598</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=97127">https://rt.cpan.org/Public/Bug/Display.html?id=97127</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=99892">https://rt.cpan.org/Public/Bug/Display.html?id=99892</a></span>

=cut

sub _enumValues
{
    my $self= shift&#40;@_&#41;;
    $self= tied&#40;%$self&#41;   if  tied&#40;%$self&#41;;
    my&#40; @names &#41;= &#40;&#41;;
    my $pos= 0;
    my $name= &#34;&#34;;
    while&#40;  $self-&gt;RegEnumValue&#40;$pos++,$name,[],[],[],[],[]&#41;  &#41; {
	push&#40; @names, $name &#41;;
    }
    if&#40;  ! _NoMoreItems&#40;&#41;  &#41; {
	return &#40;&#41;;
    }
    $self-&gt;{VALUES}= \@names;
    return 1;
}


sub ValueNames
{
    my $self= shift&#40;@_&#41;;
    $self= tied&#40;%$self&#41;   if  tied&#40;%$self&#41;;
    @_  and  croak &#34;Usage:  \@names= \$key-&gt;ValueNames;&#34;;
    $self-&gt;_enumValues   unless  $self-&gt;{VALUES};
    return @{$self-&gt;{VALUES}};
}


sub _enumSubKeys
{
    my $self= shift&#40;@_&#41;;
    $self= tied&#40;%$self&#41;   if  tied&#40;%$self&#41;;
    my&#40; @subkeys, @classes, @times &#41;= &#40;&#41;;
    my $pos= 0;
    my&#40; $subkey, $class, $time &#41;= &#40;&#34;&#34;,&#34;&#34;,&#34;&#34;&#41;;
    while&#40;  $self-&gt;RegEnumKeyEx&#40;
	      $pos++, $subkey, [], [], $class, [], $time &#41;  &#41; {
	push&#40; @subkeys, $subkey &#41;;
	push&#40; @classes, $class &#41;;
	push&#40; @times, $time &#41;;
    }
    if&#40;  ! _NoMoreItems&#40;&#41;  &#41; {
	return &#40;&#41;;
    }
    $self-&gt;{SUBKEYS}= \@subkeys;
    $self-&gt;{SUBCLASSES}= \@classes;
    $self-&gt;{SUBTIMES}= \@times;
    return 1;
}

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;17&nbsp;16:50:02&nbsp;2015</span>
    <span class="description">https://me.yahoo.com/a/ds3mWF8kldI4wC49Z_iMk5EMSDPe#1e821 -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Bruce Reed</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I see that CHORNY has provided version 0.27 which fixes the bug in one of the two places, by resetting the buffer size inputs on each call. &#40;THANK YOU!&#41;

_enumSubKeys was fixed, used in SubKeyNames, SubKeyClasses, SubKeyTimes

_enumValues remains unfixed, used in ValueNames

The same fix could be used in _enumValues, or both functions could be changed to pass [] &#40;NULL&#41; for the length parameters.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;07&nbsp;14:50:20&nbsp;2015</span>
    <span class="description">CHORNY [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;07&nbsp;14:50:30&nbsp;2015</span>
    <span class="description">CHORNY [...] cpan.org -  Fixed in 0.28 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
