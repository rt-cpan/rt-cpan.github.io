<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #113671 for Config-General: recognize BOM at start of a utf8 file</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #113671 for Config-General: recognize BOM at start of a utf8 file</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Config-General">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Config-General">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Config-General">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Config-General">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Config-General">Config-General CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">113671</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Config-General">Config-General</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
DAMI [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-7696-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-7697-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
2.60    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




utf8_bom.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1618390/866486/utf8_bom.patch">
Sat Apr 16 17:09:47 2016 (2.5k) by laurent.dami [...] free.fr
</a>
</font></li>
</ul>


utf8_bom_t.zip<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1618390/866485/utf8_bom_t.zip">
Sat Apr 16 17:09:47 2016 (680b) by laurent.dami [...] free.fr
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=113671">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1616306" href="/Public/Bug/Display.html?id=113671#txn-1616306">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;11&nbsp;03:09:05&nbsp;2016</span>
    <span class="description">DAMI [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> recognize BOM at start of a utf8 file</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1616306/865245/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/865245">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 255b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Even with option -UTF8, the parser does not accept a UTF8 file that starts with a Byte Order Mark &#40;BOM&#41; =  0xefbbbf.

The parser should ignore the BOM, and ideally, option -UTF8 should be automatically turned on if a BOM is found at the start of the file.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1616324" href="/Public/Bug/Display.html?id=113671#txn-1616324">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;11&nbsp;04:49:19&nbsp;2016</span>
    <span class="description">tlinden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1616324/865261/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/865261">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 495b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">hm .. works for me:

% hexdump x
0000000 bbef 0abf 6176 2072 203d 4554 5458 000a
000000f

% perl -MConfig::General -MData::Dumper -e &#39;%c = Config::General::ParseConfig&#40;-ConfigFile=&gt;&#39;x&#39;&#41;; print Dumper&#40;\%c&#41;;&#39;
$VAR1 = {
          &#39;Ã¿&#39; =&gt; undef,
          &#39;var&#39; =&gt; &#39;TEXT&#39;
        };

well, it parses the BOM as content &#40;which it shouldn&#39;t&#41;, but at least it doesn&#39;t croak&#40;&#41; or something.

So, please, could you post an example &#40;including a config file, e.g. by uploading it somewhere&#41;?



Thanks,
Tom
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1616325" href="/Public/Bug/Display.html?id=113671#txn-1616325">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;11&nbsp;04:49:19&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1616327" href="/Public/Bug/Display.html?id=113671#txn-1616327">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;11&nbsp;04:49:19&nbsp;2016</span>
    <span class="description">tlinden [...] cpan.org -  Fixed in 2.60 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1616527" href="/Public/Bug/Display.html?id=113671#txn-1616527">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;11&nbsp;15:36:25&nbsp;2016</span>
    <span class="description">ldami [...] bluewin.ch -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #113671] recognize BOM at start of a utf8 file</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 11 Apr 2016 21:36:07 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Config-General [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Laurent Dami &lt;ldami [...] bluewin.ch&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1616527/865376/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/865376">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 724b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Le 11.04.2016 10:49, T. Linden via RT a Ã©crit :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So, please, could you post an example &#40;including a config file, e.g. by uploading it somewhere&#41;?
</div>Here is an example. Parsing $plain works fine, but parsing 
$with_utf8_bom dies with error :
Config::General: EndBlock &#34;&lt;/foo&gt;&#34; has no StartBlock statement &#40;level: 
1, chunk 3&#41;!

==========================
use Config::General;
use Data::Dumper;

my $plain = &lt;&lt;__EOCONF__;
&lt;foo&gt;
   \x{e9}=\x{ef}
&lt;/foo&gt;
__EOCONF__

my $with_utf8_bom = &#34;\x{ef}\x{bb}\x{bf}&#34; . $plain;

for my $content &#40;$plain, $with_utf8_bom&#41; {
   open my $fh, &#34;&lt;&#34;, \$content;
   my $parser = Config::General-&gt;new&#40;-ConfigFile =&gt; $fh, -UTF8 =&gt; 1&#41;;
   my %conf = $parser-&gt;getall;
   print STDERR Dumper \%conf;
}
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1616637" href="/Public/Bug/Display.html?id=113671#txn-1616637">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;12&nbsp;03:22:35&nbsp;2016</span>
    <span class="description">tlinden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1616637/865448/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/865448">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 92b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">ok, I see.

I added a fix, could you try the latest SVN if it works for you as well?


- Tom
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1617557" href="/Public/Bug/Display.html?id=113671#txn-1617557">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;13&nbsp;16:55:20&nbsp;2016</span>
    <span class="description">ldami [...] bluewin.ch -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #113671] recognize BOM at start of a utf8 file</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 13 Apr 2016 22:55:04 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Config-General [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Laurent Dami &lt;ldami [...] bluewin.ch&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1617557/865989/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/865989">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">

Le 12.04.2016 09:22, T. Linden via RT a Ã©crit :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I added a fix, could you try the latest SVN if it works for you as well?
&gt;
</div>The fix works for a fake file in a string, as supplied in my previous 
example.

It also works for a real file, *without* the -UTF8 =&gt; 1 option : the BOM 
is properly removed ... but then the file isn&#39;t parsed as UTF8, which of 
course is not what we want.

When opening a real file *with* -UTF8 =&gt; 1 turned on, the fix doesn&#39;t work.
This is because first the file is opened with &#34;&lt;:utf8&#34; layer, and *then* 
the first line is read .. but at this point the :utf8 PerlIO layer 
interprets the BOM and changes it into \x{FEFF}.

Furthermore, the proposed fix could possibly alter other lines after the 
initial line. It&#39;s probably harmless, but nevertheless there is a small 
risk of corrupting the data.

So I think the BOM detection should rather happen in _open&#40;&#41; instead of 
_parse&#40;&#41;.
I just found the module File::BOM on CPAN, I have no experience with it, 
but reading the doc it looks like it would be quite helpful here.

Hope this helps ... and thanks for your reactivity to the bug 
declaration :-&#41;

Laurent D.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1617855" href="/Public/Bug/Display.html?id=113671#txn-1617855">#</a>      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;14&nbsp;14:27:35&nbsp;2016</span>
    <span class="description">tlinden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1617855/866185/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/866185">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 978b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">What a mess.

From my point of view the best would be to revert the proposed fix and keep Config::General as is. Instead you should handle it. I&#39;m with perl monks &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.perlmonks.org/?node_id=599772&#41;">http://www.perlmonks.org/?node_id=599772&#41;</a></span>:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#34;!&#34; in an ASCII file is also valid. But if you place a &#34;!&#34; at
&gt; the start of your Perl program, it probably will not compile.
&gt; It is a malformed file, not from a UNICODE perspective, but
&gt; from your parser&#39;s perspective.
</div>
In our case, the parser doesn&#39;t handle a BOM, since not required. It would also go a little bit too far to intruduce a new dependency just for such a rare case.

So, this is, how you could do it:

use File::Bom;
use Config::General;
use FileHandle;
my $fd = FileHandle-&gt;new&#40;&#41;;
open_bom&#40;$fd, $file, &#39;:utf8&#39;&#41;;
my $cfg = Config::General-&gt;new&#40;-ConfigFile =&gt; $fd, [..]&#41;;

This works because Config::General supports Filehandles as parameter to -ConfigFile. So, File::Bom can handle the issue while Config::General still sees what it expects.


- Tom
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1618390" href="/Public/Bug/Display.html?id=113671#txn-1618390">#</a>      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;16&nbsp;17:09:47&nbsp;2016</span>
    <span class="description">laurent.dami [...] free.fr -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #113671] recognize BOM at start of a utf8 file</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 16 Apr 2016 23:09:30 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Config-General [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Laurent Dami &lt;laurent.dami [...] free.fr&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1618390/866483/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/866483">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Le 14.04.2016 20:27, T. Linden via RT a Ã©crit :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=113671">https://rt.cpan.org/Ticket/Display.html?id=113671</a></span> &gt;
&gt;
&gt; What a mess.
&gt;
&gt;  From my point of view the best would be to revert the proposed fix and keep Config::General as is. Instead you should handle it. I&#39;m with perl monks &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.perlmonks.org/?node_id=599772&#41;">http://www.perlmonks.org/?node_id=599772&#41;</a></span>:
&gt;
&gt;
</div>Hi,

I did some research to see what other modules do :

- YAML::Tiny removes the BOM _after_ reading with &lt;:utf8 by 
doing|$string| |=~ s/^\x{FEFF}//| ; # where |\x{FEFF} is the 
utf8-decoded version of &#34;\x{ef}\x{bb}\x{bf}&#34;
|

||||- YAML.pm does not handle the BOM

- YAML::XS &#40;file &#34;reader.c&#34;&#41; checks the BOM; if found it adds an offset 
to the raw buffer pointer and sets the proper encoding for the parser

- YAML::Syck ignores the BOM

- JSON::XS ignores the BOM

- Template::Provider slurps the entire file, looks at the BOM, removes 
it if found, and then calls Encode::decode&#40;$encoding ...&#41;

- AppConfig::File has no support for Unicode

So I agree, it&#39;s a mess! Nevertheless some of those do handle the BOM 
and it would be nice if Config::General could do it too.

Regarding your answer : leaving the responsability to the client would 
only work with one single file; if there are some &lt;&lt;include&gt;&gt; 
statements, then the client has no control on how those included files 
will be opened, so it can only be handled properly by the module itself.

I rolled up my sleeves and here is a proposed patch with also some test 
cases. Let me know what you think.

Best regards, Laurent D.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1618390/866484/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/866484">with headers</a>
<br />
<span class="downloadcontenttype">text/html 2.4k</span>
</div>
<div class="messagebody">
</div>
</div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1618390/866485/utf8_bom_t.zip">Download utf8_bom_t.zip</a><br />
<span class="downloadcontenttype">application/octet-stream 680b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1618390/866486/utf8_bom.patch">Download utf8_bom.patch</a><br />
<span class="downloadcontenttype">text/x-diff 2.5k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1618713" href="/Public/Bug/Display.html?id=113671#txn-1618713">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;18&nbsp;04:48:35&nbsp;2016</span>
    <span class="description">tlinden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1618713/866688/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/866688">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 760b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Apr 16 17:09:47 2016, laurent.dami@free.fr wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So I agree, it&#39;s a mess! Nevertheless some of those do handle the BOM
&gt; and it would be nice if Config::General could do it too.
</div>
Agreed.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Regarding your answer : leaving the responsability to the client would
&gt; only work with one single file; if there are some &lt;&lt;include&gt;&gt;
&gt; statements, then the client has no control on how those included files
&gt; will be opened, so it can only be handled properly by the module
&gt; itself.
</div>
Indeed, I didn&#39;t think of includes :&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I rolled up my sleeves and here is a proposed patch with also some
&gt; test cases. Let me know what you think.
</div>
Looks good, but those are not included in the patch:

+t/utf8_bom.t
+t/utf8_bom/bar.cfg
+t/utf8_bom/foo.cfg




Thanks,
Tom
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1618725" href="/Public/Bug/Display.html?id=113671#txn-1618725">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;18&nbsp;04:52:28&nbsp;2016</span>
    <span class="description">tlinden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1618725/866690/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/866690">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 151b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Apr 18 04:48:35 2016, TLINDEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Looks good, but those are not included in the patch:
</div>
My bad, they are contained in the zip file.


- Tom
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1618782" href="/Public/Bug/Display.html?id=113671#txn-1618782">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;18&nbsp;09:07:43&nbsp;2016</span>
    <span class="description">tlinden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1618782/866734/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/866734">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 99b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ok then. I applied the patch &#40;slightly modified&#41;, since it works like a charm. Thanks a lot!

- Tom
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1618784" href="/Public/Bug/Display.html?id=113671#txn-1618784">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;18&nbsp;09:07:44&nbsp;2016</span>
    <span class="description">tlinden [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.673516</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
