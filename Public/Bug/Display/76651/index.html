<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #76651 for XML-Compile: problem with namespaces</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #76651 for XML-Compile: problem with namespaces</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/XML-Compile/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/XML-Compile/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/XML-Compile/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/XML-Compile/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-Compile">XML-Compile CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">76651</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/XML-Compile/Active/">XML-Compile</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
andrew.vtk [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-40392-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.25    </td>
  </tr>
  <tr id="CF-40393-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;18&nbsp;06:00:08&nbsp;2012</span>
    <span class="description">andrew.vtk [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> problem with namespaces</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve got an error while trying to read document that has been produced
with XML::Compile. I suppose that problem appears because there are no
active namespaces for the xml nodes &#40; or I just have missed something &#41;.
Here is a short snippet demonstrating the problem:

use XML::Compile::Cache;

use XML::LibXML;
my $s = XML::Compile::Cache-&gt;new&#40;
    prefixes =&gt; { atk =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://example.com/2012/05/atk&#39;">http://example.com/2012/05/atk&#39;</a></span> } ,
    key_rewrite =&gt; &#39;PREFIXED&#39;
&#41;;

my $schemas = XML::LibXML-&gt;load_xml&#40; string =&gt; &lt;&lt;XML &#41;;
&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;xsd:schema xmlns:xsd=&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/2001/XMLSchema">http://www.w3.org/2001/XMLSchema</a></span>&#34;
        elementFormDefault=&#34;qualified&#34;
    xmlns=&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://example.com/2012/05/atk">http://example.com/2012/05/atk</a></span>&#34;
    targetNamespace=&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://example.com/2012/05/atk">http://example.com/2012/05/atk</a></span>&#34; &gt;

&lt;xsd:element name=&#34;test&#34; type=&#34;xsd:string&#34;/&gt;
&lt;/xsd:schema&gt;
XML

$s-&gt;addSchemas&#40; $schemas &#41;;

my $doc = XML::LibXML::Document-&gt;new&#40; &#39;1.0&#39; &#41;;
my $writer = $s-&gt;compile&#40;&#39;WRITER&#39;, &#39;atk:test&#39; &#41;;
$doc-&gt;setDocumentElement&#40; $writer-&gt;&#40; $doc, &#34;12&#34; &#41;&#41;;

warn $doc-&gt;toString&#40;2&#41;;

my $reader = $s-&gt;compile&#40;&#39;READER&#39;, &#39;atk:test&#39; &#41;;

eval {
# throws error
$reader-&gt;&#40; $doc &#41;;
};


# that&#39;s OK

my $new_doc = XML::LibXML-&gt;load_xml&#40; string =&gt; $doc-&gt;toString &#41;;
$reader-&gt;&#40; $new_doc &#41;;

# what&#39;s the difference:
# there is no namespace for the root node
#

warn $doc-&gt;documentElement-&gt;namespaceURI; # has it
warn $new_doc-&gt;documentElement-&gt;namespaceURI; # has no
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;18&nbsp;06:03:25&nbsp;2012</span>
    <span class="description">andrew.vtk [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> andrew.vtk [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">sorry, comments for the last two lines must be read as:

$doc-&gt;documentElement-&gt;namespaceURI; # has no
$new_doc-&gt;documentElement-&gt;namespaceURI; # has it 


i.e. $doc is broken, but $new_doc is OK since it has been converted to
XML and passed through the libxml parser
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;18&nbsp;06:10:49&nbsp;2012</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #76651] problem with namespaces</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 18 Apr 2012 12:10:25 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Andrey Tkachenko via RT &lt;bug-XML-Compile [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Andrey Tkachenko via RT &#40;bug-XML-Compile@rt.cpan.org&#41; [120418 10:00]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Wed Apr 18 06:00:08 2012: Request 76651 was acted upon.
&gt; my $doc = XML::LibXML::Document-&gt;new&#40; &#39;1.0&#39; &#41;;
&gt; my $writer = $s-&gt;compile&#40;&#39;WRITER&#39;, &#39;atk:test&#39; &#41;;
&gt; $doc-&gt;setDocumentElement&#40; $writer-&gt;&#40; $doc, &#34;12&#34; &#41;&#41;;
&gt; 
&gt; # throws error
&gt; $reader-&gt;&#40; $doc &#41;;
</div>
I remember what the cause is.   When an XML tree is being produced, I
want to control the prefix of the node.  However, there is no method
to handle that in XML::LibXML &#40;as far as I know&#41;... I need something
like this:

   $doc-&gt;createNode&#40;$prefix, $name, $value&#41;

but all I can do is

   $doc-&gt;createNode&#40;&#34;$prefix:$name&#34;, $value&#41;

So, the created node is actually incorrect, therefore the reader
doesn&#39;t like it.  After a reparse of the XML message, the new node
is correct.

I have no idea how to fix this.  The problem is documented somewhere.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;18&nbsp;06:10:49&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;18&nbsp;07:24:18&nbsp;2012</span>
    <span class="description">andrew.vtk [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> andrew.vtk [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">OK, I see. That&#39;s pity. I guess I&#39;ll use some kind of a dirty hack &#40; as
I listed below &#41; to fix the problem. It slows down everything, of course
:&#40; &#40; even though there may be some caching etc.. &#41;

Thanks.

sub fix {
    my $node = shift;

    for my $ns &#40; $node-&gt;namespaces &#41; {
        my $name = $ns-&gt;getLocalName;
        $ns{ $name } = $ns-&gt;value;
    }

    if&#40; $node-&gt;isa&#40; &#39;XML::LibXML::Element&#39; &#41;&#41; {
        if&#40; !$node-&gt;namespaceURI and $node-&gt;nodeName =~ /:/ &#41; {
            my &#40; $prefix &#41; = $node-&gt;nodeName =~ /^&#40;[^:]+&#41;:/;
            warn &#34;patching $prefix &#40; &#34;. $node-&gt;nodeName ;
            if&#40; my $v = $ns{ $prefix }&#41; {
                $node-&gt;setNamespace&#40; $v, $prefix, 1 &#41;;
            }
        }
    }

    fix&#40; $_ &#41; for $node-&gt;childNodes;
}

fix&#40; $doc-&gt;documentElement &#41;;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;18&nbsp;07:55:56&nbsp;2012</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #76651] problem with namespaces</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 18 Apr 2012 13:55:34 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Andrey Tkachenko via RT &lt;bug-XML-Compile [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Andrey Tkachenko via RT &#40;bug-XML-Compile@rt.cpan.org&#41; [120418 11:24]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: XML-Compile
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=76651">https://rt.cpan.org/Ticket/Display.html?id=76651</a></span> &gt;
&gt; 
&gt;         if&#40; !$node-&gt;namespaceURI and $node-&gt;nodeName =~ /:/ &#41; {
&gt;             my &#40; $prefix &#41; = $node-&gt;nodeName =~ /^&#40;[^:]+&#41;:/;
&gt;             warn &#34;patching $prefix &#40; &#34;. $node-&gt;nodeName ;
&gt;             if&#40; my $v = $ns{ $prefix }&#41; {
&gt;                 $node-&gt;setNamespace&#40; $v, $prefix, 1 &#41;;
</div>
Doesn&#39;t this add namespace declarations to the nodes?
There are only three places in XML/Compile/Translate/Writer where
createElement is being called.  We may be able to call setNamespace
there to fix this issue... but I am a bit worried the output would
change &#40;get more verbose&#41;
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;18&nbsp;08:01:36&nbsp;2012</span>
    <span class="description">andrew.vtk [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> andrew.vtk [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">As I see from XML::LibXML::Element man, they try to re-use namespace
declarations for the nodes. 

       setNamespace
             $node-&gt;setNamespace&#40; $nsURI , $nsPrefix, $activate &#41;;

           setNamespace&#40;&#41; allows one to apply a namespace to an element.
The function takes three parameters: 1. the namespace URI, which is
required and
           the two optional values prefix, which is the namespace
prefix, as it should be used in child elements or attributes as well as
the additional
           activate parameter. If prefix is not given, undefined or
empty, this function tries to create a declaration of the default namespace.

           The activate parameter is most useful: If this parameter is
set to FALSE &#40;0&#41;, a new namespace declaration is simply added to the
element while
           the element&#39;s namespace itself is not altered. Nevertheless,
activate is set to TRUE &#40;1&#41; on default. In this case the namespace is
used as the
           node&#39;s effective namespace.  This means the namespace prefix
is added to the node name and if there was a namespace already active
for the
           node, it will be replaced &#40;but its declaration is not removed
from the document&#41;. A new namespace declaration is only created if necessary
           &#40;that is, if the element is already in the scope of a
namespace declaration associating the prefix with the namespace URI,
then this declara‐
           tion is reused&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;18&nbsp;08:04:09&nbsp;2012</span>
    <span class="description">andrew.vtk [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> andrew.vtk [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here it is:

A new namespace declaration is only created if necessary &#40;that is, if
the element is already in the scope of a namespace declaration
associating the prefix with the namespace URI, then this declara‐ tion
is reused&#41;. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;18&nbsp;08:58:07&nbsp;2012</span>
    <span class="description">secretaris [...] nluug.nl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #76651] problem with namespaces</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 18 Apr 2012 14:57:48 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Andrey Tkachenko via RT &lt;bug-XML-Compile [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;secretaris [...] nluug.nl&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Andrey Tkachenko via RT &#40;bug-XML-Compile@rt.cpan.org&#41; [120418 12:04]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: XML-Compile
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=76651">https://rt.cpan.org/Ticket/Display.html?id=76651</a></span> &gt;
&gt; 
&gt; A new namespace declaration is only created if necessary &#40;that is, if
&gt; the element is already in the scope of a namespace declaration
&gt; associating the prefix with the namespace URI, then this declara‐ tion
&gt; is reused&#41;. 
</div>
The XML messages are constructed from bottom to up... so on each level
this will probably recreate the declaration.  When the messages gets
constructed top-down this feature would work :&#40;

#!/usr/bin/env perl

use XML::LibXML;

my $doc = XML::LibXML::Document-&gt;new&#40;&#39;1.0&#39;, &#39;UTF-8&#39;&#41;;
my $ns  = &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://example.com">http://example.com</a></span>&#39;;

my $one = $doc-&gt;createElementNS&#40;$ns, &#39;one&#39;&#41;;
my $two = $doc-&gt;createElementNS&#40;$ns, &#39;two&#39;&#41;;
$one-&gt;addChild&#40;$two&#41;;
$doc-&gt;setDocumentElement&#40;$one&#41;;

print $doc-&gt;toString&#40;1&#41;;

-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;18&nbsp;10:19:28&nbsp;2012</span>
    <span class="description">andrew.vtk [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> andrew.vtk [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">If you replace &#39;addChild&#39; with &#39;appendChild&#39; in your example, all the
things would work OK. 
As it said in XML::LibXML::Node doc, addChild is a libxml2 specific
function. It works faster than appendChild, but has some side effects..
Thus, appendChild is a bit slower, but it is a DOM-conformant &#40; it
slower than addCHild just because it makes some extra things - including
the ones we need &#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;18&nbsp;10:42:12&nbsp;2012</span>
    <span class="description">andrew.vtk [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> andrew.vtk [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">If we need to control prefixes, then

use XML::LibXML;
my $doc = XML::LibXML::Document-&gt;new&#40;&#39;1.0&#39;, &#39;UTF-8&#39;&#41;;

my $ns1 = &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://example.com">http://example.com</a></span>&#39;;
my $ns2 = &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://example.com/2&#39;">http://example.com/2&#39;</a></span>;

my $one = $doc-&gt;createElementNS&#40;$ns1, &#39;ns1:one&#39;&#41;;
$one-&gt;setNamespace&#40; $ns1, &#39;ns1&#39;, 0 &#41;;

my $two = $doc-&gt;createElementNS&#40;$ns2, &#39;ns2:two&#39;&#41;;
$two-&gt;setNamespace&#40; $ns2, &#39;ns2&#39;, 0 &#41;;

$one-&gt;setNamespace&#40; $ns2, &#39;ns2&#39;, 0 &#41;;
$one-&gt;appendChild&#40;$two&#41;;

$doc-&gt;setDocumentElement&#40;$one&#41;;
print $doc-&gt;toString&#40;1&#41;;

Of course, this requires some extra efforts for declaring namespaces in
a top element before adding child  one.
Or may be there is another way to play with prefixes 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;18&nbsp;10:52:07&nbsp;2012</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #76651] problem with namespaces</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 18 Apr 2012 16:51:46 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Andrey Tkachenko via RT &lt;bug-XML-Compile [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Andrey Tkachenko via RT &#40;bug-XML-Compile@rt.cpan.org&#41; [120418 14:42]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: XML-Compile
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=76651">https://rt.cpan.org/Ticket/Display.html?id=76651</a></span> &gt;
&gt; 
&gt; Of course, this requires some extra efforts for declaring namespaces in
&gt; a top element before adding child  one.
</div>
And that is exactly the problem: this is frustrated by the recursive
nature of the implementation: there is no overview.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Or may be there is another way to play with prefixes 
</div>
... waiting for that ;-&#41;

Of course, I could provide people with the cleanup along the lines
of your example.  Although i think it is faster and safer to
simply do

  $clone = XML::LibXML::Parser-&gt;load_xml&#40;string =&gt; $doc-&gt;toString&#41;;

-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;18&nbsp;11:26:13&nbsp;2012</span>
    <span class="description">andrew.vtk [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> andrew.vtk [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ok, probably you are right.
Thanks for the quick and kind feedback :&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;28&nbsp;05:29:51&nbsp;2012</span>
    <span class="description">MARKOV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">closed
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;28&nbsp;05:29:51&nbsp;2012</span>
    <span class="description">MARKOV [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
