<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #113390 for Curses: SEGV in Curses &#40;menus&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #113390 for Curses: SEGV in Curses &#40;menus&#41;</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Curses">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Curses">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Curses">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Curses">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Curses">Curses CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">113390</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Curses">Curses</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cpan [...] greatships.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-8784-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-8785-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




FixTemporaries.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1613138/863262/FixTemporaries.patch">
Thu Mar 31 02:20:45 2016 (3.7k) by cpan [...] greatships.com
</a>
</font></li>
</ul>


MenuItems.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1612019/862502/MenuItems.patch">
Sun Mar 27 22:25:58 2016 (1014b) by cpan [...] greatships.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=113390">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1612019" href="/Public/Bug/Display.html?id=113390#txn-1612019">#</a>      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;27&nbsp;22:25:58&nbsp;2016</span>
    <span class="description">cpan [...] greatships.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> SEGV in Curses &#40;menus&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 27 Mar 2016 22:25:38 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Curses [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> LJ McDonald &lt;cpan [...] greatships.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1612019/862501/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/862501">with headers</a>
<br />
<span class="downloadcontenttype">text/html 15k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1612019/862502/MenuItems.patch">Download MenuItems.patch</a><br />
<span class="downloadcontenttype">text/x-diff 1014b</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1613020" href="/Public/Bug/Display.html?id=113390#txn-1613020">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;30&nbsp;17:25:08&nbsp;2016</span>
    <span class="description">bryanh [...] giraffe-data.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #113390] SEGV in Curses &#40;menus&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> 30 Mar 2016 20:50:36 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Curses [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Bryan Henderson &lt;bryanh [...] giraffe-data.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1613020/863175/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/863175">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you for figuring that out.  This is a pretty basic problem.

However, the solution isn&#39;t very obvious because of the unusual architecture
of the Curses extension.  It is designed to be a bare minimum interface to the
C Curses library, with the user expected to know about the C objects and
explicitly manage the memory &#40;e.g. the user has to call free_menu, whereas in
normal Perl, just destroying all the references to the menu would be enough&#41;.

Based on that, I think the &#34;workaround&#34; is actually the solution that is
consistent with the rest of the interface.  The example program is wrong, and
I will fix that &#40;and the same problem with the forms demo&#41;.

As noted under &#34;Improvement&#34;, this is not a very good interface regardless,
and it would be really nice to have a normal Perl interface with the
underlying C library behavior hidden.  There should be no preserving of
variables, freeing, or packing.  One should create a menu with
Curses::Menu-&gt;new&#40;@itemList&#41; where @itemList is an array of references to item
objects.  And of course, the whole rest of the package should be the same way.

With the heavy lifting &#40;translation to C&#41; already done by the existing package
and extension, it should not be difficult to create a new Curses2 package in
pure Perl that has such a normal Perl interface above and uses the Curses
package below to do the work, taking care of all the hackery within.

I will look into that.

-- 
Bryan Henderson
San Jose, California
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1613021" href="/Public/Bug/Display.html?id=113390#txn-1613021">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;30&nbsp;17:25:08&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1613084" href="/Public/Bug/Display.html?id=113390#txn-1613084">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;30&nbsp;18:50:13&nbsp;2016</span>
    <span class="description">cpan [...] greatships.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #113390] SEGV in Curses &#40;menus&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 30 Mar 2016 18:49:48 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Curses [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> LJ McDonald &lt;cpan [...] greatships.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1613084/863217/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/863217">with headers</a>
<br />
<span class="downloadcontenttype">text/html 4.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza">  
    
  
  
    
<div>Thank you for examining this issue. 
      After submitting this report, I found an identical bug in new_form
      with form fields (sounds like you are aware of it too).  The exact
      same behaviour, workaround and fix.  There are also set_menu_items
      and set_form_items methods that need the same fix.  As for the fix
      itself the Perl "correct" method should be (instead of malloc in
      new_menu):<br>
      
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><blockquote>
ITEM ** item;<br>

        int count = 1;<br>

        for (item = items; *item; item++) count++;<br>

        ITEM ** new_items;<br>

        Newx(new_items, count, ITEM*);<br>

        Copy(items, new_items, count, ITEM*);<br>

        MENU *  ret = new_menu(new_items);<br>

      </blockquote>
</div>      and in free_menu (instead of free):<br>
      
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><blockquote>
Safefree(items);<br>

      </blockquote>
</div>      Similarly for new_form, free_form and the methods listed above. 
      Note "Newx", "Copy" and "Safefree" are the Perl XS memory
      routines/macros recommended over malloc/free.<br>
      <br>
      I mentioned my Menu module I wrap these curses methods with.  It
      works exactly as you describe the desired interface should be :) 
      With corresponding wrappers for Fields and Forms as well. 
      Unfortunately, the "workaround" method *is not* the correct method
      to use for folk who might create such objects around the Curses
      methods.  If you use the workaround, as shown, Perl will garbage
      collect the variable sent in to pack once the containing block
      exits.  And if the menu object still exists and is using the
      ITEMS** array, the program will (could) SEGV again.  The items
      array is always necessary until free_menu gets called, and there
      is no way to guarantee that with Perl variables since Perl cannot
      "see" the array in use and can/will delete local variables.  This
      is why I propose this simple fix inside the new_menu (and now
      new_form, set_menu_items and set_form_items).  I can see no
      disadvantage and it's really an easy hook since menu-&gt;items
      (and form-&gt;items) is always available to the C portion of the
      library.<br>
      <br>
      I was going to work up a new diff (and test) with the Perl
      "correct" methods shown above, but got too busy with work this
      week.  Let me know if you would still like me to work this up.<br>
      <br>
      <br>
      <a href="mailto:bryanh@giraffe-data.com">bryanh@giraffe-data.com</a> via RT wrote on 03/30/2016 05:25 PM:<br>
    </div>

    
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><blockquote>

      
<pre>&lt;URL: <a href="https://rt.cpan.org/Ticket/Display.html?id=113390"><span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=113390">https://rt.cpan.org/Ticket/Display.html?id=113390</a></span></a> &gt;

Thank you for figuring that out.  This is a pretty basic problem.

However, the solution isn't very obvious because of the unusual architecture
of the Curses extension.  It is designed to be a bare minimum interface to the
C Curses library, with the user expected to know about the C objects and
explicitly manage the memory (e.g. the user has to call free_menu, whereas in
normal Perl, just destroying all the references to the menu would be enough).

Based on that, I think the "workaround" is actually the solution that is
consistent with the rest of the interface.  The example program is wrong, and
I will fix that (and the same problem with the forms demo).

As noted under "Improvement", this is not a very good interface regardless,
and it would be really nice to have a normal Perl interface with the
underlying C library behavior hidden.  There should be no preserving of
variables, freeing, or packing.  One should create a menu with
Curses::Menu-&gt;new(@itemList) where @itemList is an array of references to item
objects.  And of course, the whole rest of the package should be the same way.

With the heavy lifting (translation to C) already done by the existing package
and extension, it should not be difficult to create a new Curses2 package in
pure Perl that has such a normal Perl interface above and uses the Curses
package below to do the work, taking care of all the hackery within.

I will look into that.

</pre>

    </blockquote>
</div>    <br>

  


</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1613092" href="/Public/Bug/Display.html?id=113390#txn-1613092">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;30&nbsp;20:12:11&nbsp;2016</span>
    <span class="description">bryanh [...] giraffe-data.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #113390] SEGV in Curses &#40;menus&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> 30 Mar 2016 23:35:58 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Curses [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Bryan Henderson &lt;bryanh [...] giraffe-data.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1613092/863225/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/863225">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 487b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I wouldn&#39;t do a wrapper the way you&#39;re thinking of.  I&#39;m talking about
wrapping the entire object, not just the methods.  The Curses2::Menu object
would contain a reference to a Curses::Menu object.  It would also contain a
reference to a variable that holds that packed item list value, so it would
stick around until the Curses2::Menu object is destroyed, guaranteed to be
after the free_menu&#40;&#41; has happened.

-- 
Bryan Henderson                                   San Jose, California
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1613095" href="/Public/Bug/Display.html?id=113390#txn-1613095">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;30&nbsp;22:38:46&nbsp;2016</span>
    <span class="description">cpan [...] greatships.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #113390] SEGV in Curses &#40;menus&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 30 Mar 2016 22:38:24 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Curses [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> LJ McDonald &lt;cpan [...] greatships.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1613095/863228/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/863228">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">bryanh@giraffe-data.com via RT wrote on 03/30/2016 08:12 PM:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=113390">https://rt.cpan.org/Ticket/Display.html?id=113390</a></span> &gt;
&gt;
&gt; I wouldn&#39;t do a wrapper the way you&#39;re thinking of.  I&#39;m talking about
&gt; wrapping the entire object, not just the methods.  The Curses2::Menu object
&gt; would contain a reference to a Curses::Menu object.  It would also contain a
&gt; reference to a variable that holds that packed item list value, so it would
&gt; stick around until the Curses2::Menu object is destroyed, guaranteed to be
&gt; after the free_menu&#40;&#41; has happened.
&gt;
</div>Yes, this is the method I use.  However, there is no other 
implementation method that would guarantee to prevent a SEGV.  We should 
not assume a specific implementation on the part of the user to prevent 
the library from causing a SEGV.  In my opinion, there should be no way 
for a user to write Perl, such as the original demo example, which would 
cause a SEGV.  That is why I&#39;m advocating for a fix within the library 
which would allow the user to write any Perl implementation he likes 
without such risk, and without having to document an extensive 
explanation in the library of why the user must allocate variables for 
pack, and make sure that they last as long as the menu/form.  My intent 
of providing the workaround was to allow current users who are 
experiencing the SEGV a possible short-term solution until the library 
is fixed, especially if they are on a platform where they cannot rebuild 
Curses until their distribution provides a fixed one.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1613100" href="/Public/Bug/Display.html?id=113390#txn-1613100">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;30&nbsp;23:09:59&nbsp;2016</span>
    <span class="description">bryanh [...] giraffe-data.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #113390] SEGV in Curses &#40;menus&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> 31 Mar 2016 02:46:04 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Curses [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Bryan Henderson &lt;bryanh [...] giraffe-data.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1613100/863233/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/863233">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 738b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Yes, we&#39;re both talking about the same thing: providing a module that has
a normal Perl interface without any C pointers involved and the user cannot
use it in any way that would cause an invalid memory reference.

I&#39;m proposing to call that module Curses2, and to leave Curses as it is for
backward compatibility and also as a great tool for implementing Curses2.

The existing Curses module has an entirely different goal &#40;and I don&#39;t claim
it was ever a good idea&#41; and small changes like yours would make it a
confusing hybrid of the two.  The user would still be able to cause invalid
memory references many ways, for example by doing that pack incorrectly.

-- 
Bryan Henderson                                   San Jose, California
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1613138" href="/Public/Bug/Display.html?id=113390#txn-1613138">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;31&nbsp;02:20:45&nbsp;2016</span>
    <span class="description">cpan [...] greatships.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #113390] SEGV in Curses &#40;menus&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 31 Mar 2016 02:20:27 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Curses [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> LJ McDonald &lt;cpan [...] greatships.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1613138/863261/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/863261">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">bryanh@giraffe-data.com via RT wrote on 03/30/2016 11:10 PM:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=113390">https://rt.cpan.org/Ticket/Display.html?id=113390</a></span> &gt;
&gt;
&gt; Yes, we&#39;re both talking about the same thing: providing a module that has
&gt; a normal Perl interface without any C pointers involved and the user cannot
&gt; use it in any way that would cause an invalid memory reference.
&gt;
&gt; I&#39;m proposing to call that module Curses2, and to leave Curses as it is for
&gt; backward compatibility and also as a great tool for implementing Curses2.
</div>
Actually, we&#39;re not talking the same thing.  I&#39;m not proposing a 
&#34;Curses2&#34; or any such substantial modification.  I did offer up an 
&#34;improvement&#34; in my original report, but I understood your original 
response as to why that is not appropriate and/or desired.  My point was 
that if the current Curses module is left unpatched, the user has to go 
to extraordinary and undocumented measures, far beyond the messy &#34;pack&#34; 
construct &#40;which is adequately documented&#41;, and be exceedingly careful 
to make sure his Perl &#34;pack&#34; variables have the correct scope and 
lifetime in order to even *use* the current Curses module as provided 
without risk of SEGV.  The original demo program will not run, as is, 
and I&#39;m sure there is other code written by users based on those 
examples which is at risk of SEGV.  In order for the Curses module to 
function *as originally advertised* it must be patched to fix this SEGV.

I know it is scary to even touch such a long-standing module.  But when 
the module is found to have a fundamental flaw such as this, it must be 
fixed.  The correct procedure would be to create a new version number 
with the relevant patch applied.  This addresses any compatibility 
concerns - users can choose to upgrade, or not.  But at least a user 
caught in the &#34;trap&#34; I found myself has an option to fix mysterious 
SEGVs in existing code, without being required to rewrite that code with 
some obscure workaround that requires precise understanding of the 
subtleties involved in order to even function.

I again offer such a patch for your review.  This time with fixes for 
both the items problem and the form fields problem, written in &#34;correct&#34; 
Perl XS syntax, with understandable comments.  In my opinion, this 
minimal patch fixes this problem and maintains 100% compatibility with 
existing programs.  I believe the patch to be consistent with the 
original objectives of the Curses module, and simply restores it to the 
&#34;as written&#34; functionality that was originally thought to be there.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1613138/863262/FixTemporaries.patch">Download FixTemporaries.patch</a><br />
<span class="downloadcontenttype">text/x-diff 3.7k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.509529</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
