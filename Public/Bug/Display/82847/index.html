<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #82847 for AnyEvent-Filesys-Notify: _process_events rescan is inefficient, too slow on large directories</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #82847 for AnyEvent-Filesys-Notify: _process_events rescan is inefficient, too slow on large directories</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=AnyEvent-Filesys-Notify">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=AnyEvent-Filesys-Notify">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=AnyEvent-Filesys-Notify">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=AnyEvent-Filesys-Notify">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="http://github.com/mvgrimes/AnyEvent-Filesys-Notify/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/AnyEvent-Filesys-Notify">AnyEvent-Filesys-Notify CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">82847</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=AnyEvent-Filesys-Notify">AnyEvent-Filesys-Notify</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cpan [...] wellrounded.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-230730-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.19    </td>
  </tr>
  <tr id="CF-230731-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




anyevent-filesys-notify-fix-82848-v2.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1299917/688657/anyevent-filesys-notify-fix-82848-v2.diff">
Mon Dec 09 08:35:47 2013 (3.5k) by carsten [...] wolffcarsten.de
</a>
</font></li>
</ul>


anyevent-filesys-notify-fix-82848.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1299567/688476/anyevent-filesys-notify-fix-82848.diff">
Sun Dec 08 04:03:24 2013 (1.5k) by carsten [...] wolffcarsten.de
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=82847">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1172204" href="/Public/Bug/Display.html?id=82847#txn-1172204">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;21&nbsp;03:58:01&nbsp;2013</span>
    <span class="description">cpan [...] wellrounded.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> _process_events rescan is inefficient, too slow on large directories</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1172204/618135/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/618135">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 845b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Comments in _process_events&#40;&#41; say:
    # We are just ingoring the raw events for now... Mac::FSEvents
    # doesn&#39;t provide much information, so rescan ourselves

The rescan works poorly when the directories contain a large number of
files.  Every time an inotify event occurs, this routine computes a stat
on EVERY file in the directories.

Unfortunately, this makes AnyEvent::Filesys::Notify unusable in my
application, running under Linux.  It&#39;s just too slow.

Instead, _process_events&#40;&#41; SHOULD process the raw events, and directly
translate each Linux::Inotify2 event directly into the corresponding
AEFN::Event.  No rescan is needed.

If you are concerned about Mac OSX performance, can you break that case
into a separate routine?  That way, Linux users will not have to suffer
performance degradation to accommodate Mac code.

Thank you.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1173298" href="/Public/Bug/Display.html?id=82847#txn-1173298">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;23&nbsp;09:27:40&nbsp;2013</span>
    <span class="description">mgrimes [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1173298/618795/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/618795">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 359b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Jonathan,

I agree, parsing the events where available would likely be the most efficient implementation. In 
my experience though, this can be a bit tricky. There are nuances &#40;such as multiple events fired 
for the same change&#41; that need to dealt with. I will look into making this change as time permits. 
Of course, I would welcome a patch.

Thanks,
Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1173300" href="/Public/Bug/Display.html?id=82847#txn-1173300">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;23&nbsp;09:27:41&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1225608" href="/Public/Bug/Display.html?id=82847#txn-1225608">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;18&nbsp;15:35:17&nbsp;2013</span>
    <span class="description">mgrimes [...] cpan.org -  Ticket deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1225609" href="/Public/Bug/Display.html?id=82847#txn-1225609">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;18&nbsp;15:35:19&nbsp;2013</span>
    <span class="description">mgrimes [...] cpan.org -  Status changed from &#39;deleted&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1299567" href="/Public/Bug/Display.html?id=82847#txn-1299567">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;08&nbsp;04:03:24&nbsp;2013</span>
    <span class="description">carsten [...] wolffcarsten.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #82847] Patch proposal</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 08 Dec 2013 10:03:07 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-AnyEvent-Filesys-Notify [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Carsten Wolff &lt;carsten [...] wolffcarsten.de&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1299567/688475/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/688475">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 527b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

how about the attached patch? The comment describes two cases, where the 
behavior deviates from the Notify.pm code. What do you think about these 
cases? I feel the patch behavior is more correct, but are you OK with this?

The performance advantage of this patch is big. Previously, when I touched 
1000 files at once, my daemon would use 100% CPU for 6 minutes, which also 
means a delay of 6 minutes for the last event to be generated. With the patch, 
processing of the same test takes 1 or 2 seconds.

Cheers
Carsten
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1299567/688476/anyevent-filesys-notify-fix-82848.diff">Download anyevent-filesys-notify-fix-82848.diff</a><br />
<span class="downloadcontenttype">text/x-diff 1.5k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1299612" href="/Public/Bug/Display.html?id=82847#txn-1299612">#</a>      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;08&nbsp;11:54:19&nbsp;2013</span>
    <span class="description">cpan [...] wellrounded.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1299612/688505/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/688505">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 803b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks, Carsten.  The patch looks OK to me.  I would make the following suggestions.

  - Your change could break existing code that uses AEFN.  In my opinion, it should be possible for someone to upgrade without breaking anything.  If you&#39;re going to change the event behavior as described, make it backward-compatible.  That is, add a flag to explicitly select the new behavior, and make it default to the old behavior.  &#40;That said, I have no strong opinion on which behavior is &#34;more correct.&#34;&#41;

  - Is it possible that $self-&gt;cb might be undef?  If so, your code would crash when you try to apply it at the end of the sub.

  - Would it make sense to synthesize a single &#34;moved&#34; AEFN:Event from the two MOVED_FROM and MOVED_TO events?  That would be really cool and useful.

Best wishes,
--Jonathan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1299917" href="/Public/Bug/Display.html?id=82847#txn-1299917">#</a>      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;09&nbsp;08:35:47&nbsp;2013</span>
    <span class="description">carsten [...] wolffcarsten.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #82847] Patch proposal</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 09 Dec 2013 14:35:24 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-anyevent-filesys-notify [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Carsten Wolff &lt;carsten [...] wolffcarsten.de&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1299917/688656/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/688656">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Jonathan,

Jonathan wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks, Carsten.  The patch looks OK to me.
</div>
thanks for the review.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;   - Your change could break existing code that uses AEFN.  In my opinion, it
&gt; should be possible for someone to upgrade without breaking anything.  If
&gt; you&#39;re going to change the event behavior as described, make it
&gt; backward-compatible.
</div>
Sure, that makes sense. Find attached a v2 of the patch.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;   - Is it possible that $self-&gt;cb might be undef?  If so, your code would
&gt; crash when you try to apply it at the end of the sub.
</div>
No, the member var has &#34;required =&gt; 1&#34;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;   - Would it make sense to synthesize a single &#34;moved&#34; AEFN:Event from the
&gt; two MOVED_FROM and MOVED_TO events?  That would be really cool and useful.
</div>
I see two problems with this idea:
1. A single AEFN event has only one &#34;path&#34;. How would you transport the 
information about old and new name together in one Event?
2. The Linux::Inotify2 watcher only passes one event at a time to the callback 
&#40;_process_events&#41;. To associate and/or merge two events with each other, there 
would need to exist a local event-queue which would hold and delay the first 
event up to the arrival of the second.

Cheers
Carsten
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1299917/688657/anyevent-filesys-notify-fix-82848-v2.diff">Download anyevent-filesys-notify-fix-82848-v2.diff</a><br />
<span class="downloadcontenttype">text/x-diff 3.5k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1300043" href="/Public/Bug/Display.html?id=82847#txn-1300043">#</a>      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;09&nbsp;12:38:28&nbsp;2013</span>
    <span class="description">mgrimes [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1300043/688740/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/688740">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 976b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the patch Carsten, and thanks for the comments Jonathan.

The patch looks good. I&#39;ve applied/modified the patch, added some tests and refactored the testing method. The old testing method failed since we no longer receive all the events at once. The new method seems more robust and simpler.

There were a couple of issues that I addressed. Most importantly, if we `mkdir subdir &#38;&#38; touch subdir/file` the  subdir/file created event is missed. This is because we need to catch the subdir created event, then add subdir to the list of watched directories. In the time that take, we miss the subdir/file created event from Inotify2. AEFN now walks new subdirs, generating &#39;created&#39; events for children.

I&#39;ve pushed this to github as a new branch &#39;rv/efficient-events&#39;. Let me know if you have any comments, otherwise I&#39;ll probably release to cpan in the next day or so.

<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/mvgrimes/AnyEvent-Filesys-Notify/tree/rv/efficient-events">https://github.com/mvgrimes/AnyEvent-Filesys-Notify/tree/rv/efficient-events</a></span>

Thanks again,
Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1300180" href="/Public/Bug/Display.html?id=82847#txn-1300180">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;10&nbsp;01:46:50&nbsp;2013</span>
    <span class="description">cpan [...] wellrounded.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1300180/688813/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/688813">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Carsten,

Thanks again for your work on this issue, and for your feedback.

In response to your questions about the idea of combining the MOVED_FROM and MOVED_TO pair of events events into a single AEFN::Event, I would say:

&#40;1&#41; The AEFN::Event data structure would have to be modified to carry both paths.

&#40;2&#41; Yes, the first event would have to be stored, in a hash or an array, until the second event arrives.  In the case of a Move event, the two events happen almost simultaneously.  So there would be essentially no delay from combining them.

Nevertheless, this would be a separate project, and is beyond the scope of the bugfix.  It&#39;s just an idea that could potentially simplify the processing of Move notifications.  I am not planning to submit an implementation.

Best,
--Jonathan

On Mon Dec 09 08:35:47 2013, carsten@wolffcarsten.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Jonathan,
&gt; 
&gt; Jonathan wrote:
<div class="message-stanza open">&gt; &gt; Thanks, Carsten.  The patch looks OK to me.
</div>&gt; 
&gt; thanks for the review.
&gt; 
<div class="message-stanza open">&gt; &gt; - Your change could break existing code that uses AEFN.  In my
&gt; &gt; opinion, it
&gt; &gt; should be possible for someone to upgrade without breaking anything.
&gt; &gt; If
&gt; &gt; you&#39;re going to change the event behavior as described, make it
&gt; &gt; backward-compatible.
</div>&gt; 
&gt; Sure, that makes sense. Find attached a v2 of the patch.
&gt; 
<div class="message-stanza open">&gt; &gt; - Is it possible that $self-&gt;cb might be undef?  If so, your code
&gt; &gt; would
&gt; &gt; crash when you try to apply it at the end of the sub.
</div>&gt; 
&gt; No, the member var has &#34;required =&gt; 1&#34;.
&gt; 
<div class="message-stanza open">&gt; &gt; - Would it make sense to synthesize a single &#34;moved&#34; AEFN:Event from
&gt; &gt; the
&gt; &gt; two MOVED_FROM and MOVED_TO events?  That would be really cool and
&gt; &gt; useful.
</div>&gt; 
&gt; I see two problems with this idea:
&gt;  1. A single AEFN event has only one &#34;path&#34;. How would you transport
&gt; the
&gt; information about old and new name together in one Event?
&gt;  2. The Linux::Inotify2 watcher only passes one event at a time to the
&gt; callback
&gt;  &#40;_process_events&#41;. To associate and/or merge two events with each
&gt; other, there
&gt;  would need to exist a local event-queue which would hold and delay
&gt; the first
&gt; event up to the arrival of the second.
&gt; 
&gt; Cheers
&gt; Carsten
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1300183" href="/Public/Bug/Display.html?id=82847#txn-1300183">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;10&nbsp;01:49:17&nbsp;2013</span>
    <span class="description">cpan [...] wellrounded.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1300183/688816/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/688816">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Mark,

Thank you for pushing this patch forward.  I think it will make users much happier with AEFN::Event.

--Jonathan

On Mon Dec 09 12:38:28 2013, MGRIMES wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks for the patch Carsten, and thanks for the comments Jonathan.
&gt; 
&gt; The patch looks good. I&#39;ve applied/modified the patch, added some
&gt; tests and refactored the testing method. The old testing method failed
&gt; since we no longer receive all the events at once. The new method
&gt; seems more robust and simpler.
&gt; 
&gt; There were a couple of issues that I addressed. Most importantly, if
&gt; we `mkdir subdir &#38;&#38; touch subdir/file` the  subdir/file created event
&gt; is missed. This is because we need to catch the subdir created event,
&gt; then add subdir to the list of watched directories. In the time that
&gt; take, we miss the subdir/file created event from Inotify2. AEFN now
&gt; walks new subdirs, generating &#39;created&#39; events for children.
&gt; 
&gt; I&#39;ve pushed this to github as a new branch &#39;rv/efficient-events&#39;. Let
&gt; me know if you have any comments, otherwise I&#39;ll probably release to
&gt; cpan in the next day or so.
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/mvgrimes/AnyEvent-Filesys-Notify/tree/rv/efficient-">https://github.com/mvgrimes/AnyEvent-Filesys-Notify/tree/rv/efficient-</a></span>
&gt; events
&gt; 
&gt; Thanks again,
&gt; Mark
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1300234" href="/Public/Bug/Display.html?id=82847#txn-1300234">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;10&nbsp;05:12:50&nbsp;2013</span>
    <span class="description">carsten [...] wolffcarsten.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #82847] Patch proposal</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 10 Dec 2013 11:12:33 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-anyevent-filesys-notify [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Carsten Wolff &lt;carsten [...] wolffcarsten.de&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1300234/688848/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/688848">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 835b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Mark,

thanks for the quick turnaround!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; There were a couple of issues that I addressed. Most importantly, if we
&gt; `mkdir subdir &#38;&#38; touch subdir/file` the  subdir/file created event is
&gt; missed. This is because we need to catch the subdir created event, then add
&gt; subdir to the list of watched directories. In the time that take, we miss
&gt; the subdir/file created event from Inotify2. AEFN now walks new subdirs,
&gt; generating &#39;created&#39; events for children.
</div>
That&#39;s a nice catch.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve pushed this to github as a new branch &#39;rv/efficient-events&#39;. Let me
&gt; know if you have any comments, otherwise I&#39;ll probably release to cpan in
&gt; the next day or so.
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/mvgrimes/AnyEvent-Filesys-Notify/tree/rv/efficient-events">https://github.com/mvgrimes/AnyEvent-Filesys-Notify/tree/rv/efficient-events</a></span>
</div>
For me, the branch looks good. Thanks for taking the time to polish this up!

Cheers
Carsten
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1300329" href="/Public/Bug/Display.html?id=82847#txn-1300329">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;10&nbsp;11:52:15&nbsp;2013</span>
    <span class="description">mgrimes [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1300329/688909/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/688909">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 46b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">New version 1.10 released on CPAN. Thanks all.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1300331" href="/Public/Bug/Display.html?id=82847#txn-1300331">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;10&nbsp;11:52:15&nbsp;2013</span>
    <span class="description">mgrimes [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.619404</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
