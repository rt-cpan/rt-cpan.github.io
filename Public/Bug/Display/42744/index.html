<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #33547 for Net-DNS: Net::DNS::Nameserver doesn&#39;t truncate long UDP replies [PATCH]</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #33547 for Net-DNS: Net::DNS::Nameserver doesn&#39;t truncate long UDP replies [PATCH]</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Net-DNS">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Net-DNS">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Net-DNS">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Net-DNS">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-DNS">Net-DNS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">33547</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Net-DNS">Net-DNS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cpan [...] aaroncrane.co.uk

<br />
tyronmiller [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-22454-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22455-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




PGP.sig<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/560244/282836/PGP.sig">
Tue Jan 27 05:53:05 2009 (194b) by olaf [...] dacht.net
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/559151/282233/PGP.sig">
Sat Jan 24 05:43:31 2009 (194b) by olaf [...] dacht.net
</a>
</font></li>
</ul>


signature.asc<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/426979/208850/signature.asc">
Tue Feb 26 02:29:48 2008 (252b) by olaf [...] dacht.net
</a>
</font></li>
</ul>


udp_truncation.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/426339/208525/udp_truncation.diff">
Sun Feb 24 09:22:28 2008 (4.7k) by cpan [...] aaroncrane.co.uk
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=33547">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-426339" href="/Public/Bug/Display.html?id=33547#txn-426339">#</a>      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;24&nbsp;09:22:28&nbsp;2008</span>
    <span class="description">cpan [...] aaroncrane.co.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net::DNS::Nameserver doesn&#39;t truncate long UDP replies [PATCH]</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/426339/208522/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/208522">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Net::DNS::Nameserver never attempts to apply the UDP truncation logic
required by RFC 1035 sections 4.2.1 and 6.2.

It&#39;s impossible for the ReplyHandler to work around this, because it
never has access to the socket on which the query was received, and so
can&#39;t determine whether it&#39;s a datagram or stream socket.

The attached patch against SVN r715 contains:

- Tests for the desired truncation behaviour, with both standard
512-byte UDP packets and extended 1024-byte UDP packets &#40;using an EDNS0
OPT record&#41;

- Changes to lib/Net/DNS/Nameserver.pm to truncate oversized responses;
the tests fail without these changes, and pass with them

Summary of my perl5 &#40;revision 5 version 8 subversion 8&#41; configuration:
  Platform:
    osname=linux, osvers=2.6.15.7, archname=i486-linux-gnu-thread-multi
    uname=&#39;linux terranova 2.6.15.7 #1 smp thu jul 12 14:27:56 utc 2007
i686 gnulinux &#39;
    config_args=&#39;-Dusethreads -Duselargefiles -Dccflags=-DDEBIAN
-Dcccdlflags=-fPIC -Darchname=i486-linux-gnu -Dprefix=/usr
-Dprivlib=/usr/share/perl/5.8 -Darchlib=/usr/lib/perl/5.8
-Dvendorprefix=/usr -Dvendorlib=/usr/share/perl5
-Dvendorarch=/usr/lib/perl5 -Dsiteprefix=/usr/local
-Dsitelib=/usr/local/share/perl/5.8.8
-Dsitearch=/usr/local/lib/perl/5.8.8 -Dman1dir=/usr/share/man/man1
-Dman3dir=/usr/share/man/man3 -Dsiteman1dir=/usr/local/man/man1
-Dsiteman3dir=/usr/local/man/man3 -Dman1ext=1 -Dman3ext=3perl
-Dpager=/usr/bin/sensible-pager -Uafs -Ud_csh -Uusesfio -Uusenm
-Duseshrplib -Dlibperl=libperl.so.5.8.8 -Dd_dosuid -des&#39;
    hint=recommended, useposix=true, d_sigaction=define
    usethreads=define use5005threads=undef useithreads=define
usemultiplicity=define
    useperlio=define d_sfio=undef uselargefiles=define usesocks=undef
    use64bitint=undef use64bitall=undef uselongdouble=undef
    usemymalloc=n, bincompat5005=undef
  Compiler:
    cc=&#39;cc&#39;, ccflags =&#39;-D_REENTRANT -D_GNU_SOURCE -DTHREADS_HAVE_PIDS
-DDEBIAN -fno-strict-aliasing -pipe -I/usr/local/include
-D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64&#39;,
    optimize=&#39;-O2&#39;,
    cppflags=&#39;-D_REENTRANT -D_GNU_SOURCE -DTHREADS_HAVE_PIDS -DDEBIAN
-fno-strict-aliasing -pipe -I/usr/local/include&#39;
    ccversion=&#39;&#39;, gccversion=&#39;4.1.3 20070929 &#40;prerelease&#41; &#40;Ubuntu
4.1.2-16ubuntu2&#41;&#39;, gccosandvers=&#39;&#39;
    intsize=4, longsize=4, ptrsize=4, doublesize=8, byteorder=1234
    d_longlong=define, longlongsize=8, d_longdbl=define, longdblsize=12
    ivtype=&#39;long&#39;, ivsize=4, nvtype=&#39;double&#39;, nvsize=8, Off_t=&#39;off_t&#39;,
lseeksize=8
    alignbytes=4, prototype=define
  Linker and Libraries:
    ld=&#39;cc&#39;, ldflags =&#39; -L/usr/local/lib&#39;
    libpth=/usr/local/lib /lib /usr/lib
    libs=-lgdbm -lgdbm_compat -ldb -ldl -lm -lpthread -lc -lcrypt
    perllibs=-ldl -lm -lpthread -lc -lcrypt
    libc=/lib/libc-2.6.1.so, so=so, useshrplib=true,
libperl=libperl.so.5.8.8
    gnulibc_version=&#39;2.6.1&#39;
  Dynamic Linking:
    dlsrc=dl_dlopen.xs, dlext=so, d_dlsymun=undef, ccdlflags=&#39;-Wl,-E&#39;
    cccdlflags=&#39;-fPIC&#39;, lddlflags=&#39;-shared -L/usr/local/lib&#39;


Characteristics of this binary &#40;from libperl&#41;: 
  Compile-time options: MULTIPLICITY PERL_IMPLICIT_CONTEXT
                        PERL_MALLOC_WRAP THREADS_HAVE_PIDS USE_ITHREADS
                        USE_LARGE_FILES USE_PERLIO USE_REENTRANT_API
  Built under linux
  Compiled at Dec  4 2007 08:56:39
  @INC:
    /etc/perl
    /usr/local/lib/perl/5.8.8
    /usr/local/share/perl/5.8.8
    /usr/lib/perl5
    /usr/share/perl5
    /usr/lib/perl/5.8
    /usr/share/perl/5.8
    /usr/local/lib/site_perl
    .
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> udp_truncation.diff</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/426339/208525/udp_truncation.diff">Download udp_truncation.diff</a><br />
<span class="downloadcontenttype">text/x-diff 4.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: lib/Net/DNS/Nameserver.pm
===================================================================
--- lib/Net/DNS/Nameserver.pm	&#40;revision 715&#41;
+++ lib/Net/DNS/Nameserver.pm	&#40;working copy&#41;
@@ -355,6 +355,20 @@
 	my $reply = $self-&gt;make_reply&#40;$query, $peerhost&#41; || return;
 	my $reply_data = $reply-&gt;data;
 
+	my $max_len = $self-&gt;max_udp_len&#40;$query&#41;;
+	if &#40;length $reply_data &gt; $max_len&#41; {
+		$reply-&gt;header-&gt;tc&#40;1&#41;;
+		my @sections = qw&lt;additional authority answer question&gt;;
+		while &#40;@sections&#41; {
+			if &#40;!$reply-&gt;pop&#40;$sections[0]&#41;&#41; {
+				shift @sections;
+				next;
+			}
+			$reply_data = $reply-&gt;data;
+			last if length $reply_data &lt;= $max_len;
+		}
+	}
+
 	local $| = 1 if $self-&gt;{&#34;Verbose&#34;};
 	print &#34;Writing response - &#34; if $self-&gt;{&#34;Verbose&#34;};
 
@@ -367,6 +381,17 @@
       }
 
 
+sub max_udp_len {
+	my &#40;$self, $query&#41; = @_;
+
+	for my $rr &#40;$query-&gt;additional&#41; {
+		return $rr-&gt;size if $rr-&gt;type eq &#39;OPT&#39;;
+	}
+
+	return 512;
+}
+
+
 sub get_open_tcp {
     my $self=shift;
     return keys %{$self-&gt;{&#34;_tcp&#34;}};
Index: t/13-udp-trunc.t
===================================================================
--- t/13-udp-trunc.t	&#40;revision 0&#41;
+++ t/13-udp-trunc.t	&#40;revision 0&#41;
@@ -0,0 +1,121 @@
+# $Id$ -*- perl
+
+use Test::More tests =&gt; 31;
+use strict;
+
+my $ZONE = &#39;example.com&#39;;
+
+use_ok&#40;&#39;Net::DNS::Nameserver&#39;&#41;;
+
+{
+    my @full_response;
+    my $ns = Net::DNS::Nameserver-&gt;new&#40;
+        LocalPort    =&gt; 8053,
+        ReplyHandler =&gt; sub { NOERROR =&gt; @full_response },
+    &#41;;
+    for &#40;trad_query&#40;&#41;, edns_query&#40;&#41;&#41; {
+        my &#40;$query, $size&#41; = @$_;
+        for my $n &#40;1, 5, 10, 50, 200&#41; {
+            @full_response = make_response&#40;$n&#41;;
+            my $socket = Mock::UDP-&gt;new&#40;$query-&gt;data&#41;;
+            $ns-&gt;udp_connection&#40;$socket&#41;;
+            my $reply_data = $socket-&gt;output;
+            cmp_ok&#40;length $reply_data, &#39;&lt;=&#39;, $size,
+                   &#34;UDP-$size reply for $n A records short enough&#34;&#41;;
+            my $reply = Net::DNS::Packet-&gt;new&#40;\$reply_data&#41;;
+            ok&#40;$reply, &#34;found UDP-$size reply for $n A records&#34;&#41;;
+            my $got      = reply_records&#40;$reply&#41;;
+            my $expected = response_records&#40;$query, @full_response&#41;;
+            ok&#40;is_prefix&#40;$reply-&gt;header-&gt;tc, $got, $expected&#41;,
+               &#34;UDP-$size reply for $n A records complete or sanely truncated&#34;&#41;;
+        }
+    }
+}
+
+sub trad_query {
+    return [Net::DNS::Packet-&gt;new&#40;$ZONE&#41;, 512];
+}
+
+sub edns_query {
+    my $size = 1024;
+    my $edns_rr = Net::DNS::RR-&gt;new&#40;type =&gt; &#39;OPT&#39;, class =&gt; $size, name =&gt; &#39;&#39;&#41;;
+    my $query = Net::DNS::Packet-&gt;new&#40;$ZONE&#41;;
+    $query-&gt;push&#40;additional =&gt; $edns_rr&#41;;
+    return [$query, $size];
+}
+
+sub reply_records {
+    my &#40;$reply&#41; = @_;
+    my @records;
+    for my $section &#40;qw&lt;question answer authority additional&gt;&#41; {
+        push @records, map { [$section =&gt; $_] } $reply-&gt;$section;
+    }
+    return \@records;
+}
+
+sub response_records {
+    my &#40;$query, @response&#41; = @_;
+    unshift @response, [$query-&gt;question];
+    my @records;
+    for my $section &#40;qw&lt;question answer authority additional&gt;&#41; {
+        push @records, map { [$section =&gt; $_] } @{ shift @response };
+    }
+    return \@records;
+}
+
+sub is_prefix {
+    my &#40;$truncated, $got_list, $expected_list&#41; = @_;
+    die &#39;TEST BUG: no records expected&#39; if !@$expected_list;
+    if &#40;@$got_list &gt; @$expected_list&#41; {
+        diag&#40;&#34;Most peculiar: got too many records&#34;&#41;;
+        return 0;
+    }
+    for &#40;;;&#41; {
+        return !$truncated == !@$expected_list if !@$got_list;
+        my $got      = shift @$got_list;
+        my $expected = shift @$expected_list;
+        my &#40;$got_s, $expected_s&#41; = map { $_-&gt;[1]-&gt;string } $got, $expected;
+        next if $got-&gt;[0] eq $expected-&gt;[0] &#38;&#38; $got_s eq $expected_s;
+        if &#40;$got-&gt;[0] ne $expected-&gt;[0] || $got_s ne $expected_s&#41; {
+            diag&#40;&#34;Got[$got-&gt;[0] $got_s] Expected[$expected-&gt;[0] $expected_s]&#34;&#41;;
+            return 0;
+        }
+    }
+}
+
+sub make_response {
+    my &#40;$n&#41; = @_;
+    my @ans  = map { Net::DNS::RR-&gt;new&#40;&#34;$ZONE 9 IN A 10.0.0.$_&#34;&#41; } 1 .. $n;
+    my @auth = map { Net::DNS::RR-&gt;new&#40;&#34;$ZONE 9 IN NS ns$_.$ZONE&#34;&#41;    } 1 .. 4;
+    my @add  = map { Net::DNS::RR-&gt;new&#40;&#34;ns$_.$ZONE 9 IN A 10.0.1.$_&#34;&#41; } 1 .. 4;
+    return \@ans, \@auth, \@add;
+}
+
+{
+    package Mock::UDP;
+
+    sub new {
+        my &#40;$class, $data&#41; = @_;
+        return bless {
+            input  =&gt; $data,
+            output =&gt; &#39;&#39;,
+        }, $class;
+    }
+
+    sub peerhost { &#39;127.0.0.1&#39; }
+    sub peerport { 65534 }
+    sub output   { $_[0]{output} }
+
+    sub recv {
+        my &#40;$self, $buf, $len&#41; = @_;
+        return if $self-&gt;{input} eq &#39;&#39;;
+        my $data = substr $self-&gt;{input}, 0, $len, &#39;&#39;;
+        $_[1] = $data;
+    }
+
+    sub send {
+        my &#40;$self, $data&#41; = @_;
+        $self-&gt;{output} .= $data;
+        1;
+    }
+}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-426979" href="/Public/Bug/Display.html?id=33547#txn-426979">#</a>      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;26&nbsp;02:29:48&nbsp;2008</span>
    <span class="description">olaf [...] dacht.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #33547] Net::DNS::Nameserver doesn&#39;t truncate long UDP replies [PATCH]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 26 Feb 2008 08:29:18 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Olaf M. Kolkman&#34; &lt;olaf [...] dacht.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/426979/208849/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/208849">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Aaron Crane via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sun Feb 24 09:22:28 2008: Request 33547 was acted upon.
&gt; Transaction: Ticket created by ARC
&gt;        Queue: Net-DNS
&gt;      Subject: Net::DNS::Nameserver doesn&#39;t truncate long UDP replies [PATCH]
&gt;    Broken in: &#40;no value&#41;
&gt;     Severity: Important
&gt;        Owner: Nobody
&gt;   Requestors: cpan@aaroncrane.co.uk
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=33547">http://rt.cpan.org/Ticket/Display.html?id=33547</a></span> &gt;
&gt;
&gt;
&gt; Net::DNS::Nameserver never attempts to apply the UDP truncation logic
&gt; required by RFC 1035 sections 4.2.1 and 6.2.
&gt;
&gt; It&#39;s impossible for the ReplyHandler to work around this, because it
&gt; never has access to the socket on which the query was received, and so
&gt; can&#39;t determine whether it&#39;s a datagram or stream socket.
&gt;
&gt; The attached patch against SVN r715 contains:
&gt;
&gt; - Tests for the desired truncation behaviour, with both standard
&gt; 512-byte UDP packets and extended 1024-byte UDP packets &#40;using an EDNS0
&gt; OPT record&#41;
&gt;
&gt; - Changes to lib/Net/DNS/Nameserver.pm to truncate oversized responses;
&gt; the tests fail without these changes, and pass with them
&gt;   
</div>
Thanks for the patch, however. Truncation as supplied in the patch does
two simplyfications.

One of the issues is that the patch blindly sets the TC bit in the
header while the overflow may have happened in the additional section.
&#40;RFC2181 section 9 provides guidance on when to set the TC bit&#41;. This is
fairly easy to fix by first popping additional section data, and only if
that has no effect set the TC bit.


Also the patch pops RR by RR from the sections, while to be compliant to
the specification you will have to pop RRset by RRset &#40;and RRset is the
set of RRs for which Name, Class and Type are the same&#41;. Since the RRs
in an RRset do not necessarily have to be clustered within a section you
really need to parse a complete section to strip correctly. One could
take the assumption that the RRs are bundled. Also, I would have to
check if one strips an RRSIG one has to include the signed RRset as
well, that should be buried somewhere in the specs.

It may be better to supply the user with hooks in the callback function
or an additional callback so that the user can adjust the packet themselves.

I appreciate the initiative and having something done with truncation is
better than nothing, but I would like to ponder on a solution for a bit.



--Olaf
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/426979/208850/signature.asc">Download signature.asc</a><br />
<span class="downloadcontenttype">application/pgp-signature 252b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-426980" href="/Public/Bug/Display.html?id=33547#txn-426980">#</a>      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;26&nbsp;02:29:50&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Create even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-559047" href="/Public/Bug/Display.html?id=33547#txn-559047">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;23&nbsp;21:55:01&nbsp;2009</span>
    <span class="description">tyronmiller [...] gmail.com - Ticket #42744:  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net::DNS::Header-&gt;tc&#40;1&#41; doesn&#39;t set Trucation flag</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/559047/282186/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/282186">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 838b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am trying to send large DNS responses, which means I need to set the
&#34;tc&#34; flag so that the transport changes from UDP to TCP due to truncated
data. When using the following code, the header data is printed out with
the &#34;tc&#34; flag set; however, in Wireshark the flag is still shown to be
off and the transport does not get redirected to TCP by the requesting
DNS server.

[snip]
$header = Net::DNS::Header-&gt;new;
$header-&gt;aa&#40;1&#41;; # sets aa flag in both printed output and wireshark
$header-&gt;tc&#40;1&#41;; # sets tc flag in printed output, but not wireshark
$header-&gt;print; # prints both flags as being set, but tc not shown in
wireshark
my @response = &#40;$rcode, \@ans, \@auth, \@add, $header&#41;;
return @response;
#end reply handler

I am using version 0.63, and I checked the changelog for 0.64 but there
was no mention of a bug fix for this issue.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-559151" href="/Public/Bug/Display.html?id=33547#txn-559151">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;24&nbsp;05:43:30&nbsp;2009</span>
    <span class="description">olaf [...] dacht.net - Ticket #42744:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #42744] Net::DNS::Header-&gt;tc&#40;1&#41; doesn&#39;t set Trucation flag </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 24 Jan 2009 11:41:58 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Olaf Kolkman &lt;olaf [...] dacht.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/559151/282232/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/282232">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
I take it that you are trying to construct a reply handler.

        The ReplyHandler subroutine is passed the query name, query  
class,
        query type and optionally an argument containing the peerhost,  
the
        incoming query, and the name of the incomming socket  
&#40;sockethost&#41;. It
        must return the response code and references to the answer,  
authority,
        and additional sections of the response.  Common response  
codes are:

          NOERROR       No error
          FORMERR       Format error
          SERVFAIL      Server failure
          NXDOMAIN      Non‐existent domain &#40;name doesn’t exist&#41;
          NOTIMP        Not implemented
          REFUSED       Query refused

        For advanced usage it may also contain a headermaks containing  
an
        hashref with the settings for the &#34;aa&#34;, &#34;ra&#34;, and &#34;ad&#34; header  
bits. The
        argument is of the form &#34;{ ad =&gt; 1, aa =&gt; 0, ra =&gt; 1 }&#34;.


The argument that tweaks the bits is not a header object but a  
reference to a hash containing the header values.

Here is a code sniplet from Net::DNS::TestNS that sets the arguments  
and uses the headermask, maybe that is of use.


        
        # The XML has been parsed and all info sits in the %answer db..
        # We now construct the reply handler using that.
        my $reply_handler = sub {
            my &#40;$qname, $qclass, $qtype&#41; = @_;
            $qname.=&#34;.&#34; if $qname !~ /\.$/;
            my &#40;$rcode, @ans, @auth, @add&#41;;
            if &#40; exists $answerdb{$qname}-&gt;{$qtype}&#41;{
                $rcode= $answerdb{$qname}-&gt;{$qtype}-&gt;{&#39;rcode&#39;};
                my $transporthash= {
                    &#39;aa&#39; =&gt;
                        $answerdb{$qname}-&gt;{$qtype}-&gt;
                    {&#39;header&#39;}-&gt;{&#39;aa&#39;},
                        &#39;ra&#39; =&gt;
                        $answerdb{$qname}-&gt;{$qtype}-&gt;
                    {&#39;header&#39;}-&gt;{&#39;ra&#39;},
                    };
                
                foreach my $headerfield qw&#40;aa qr ad rd tc id cd
                                           qdcount ancount nscount arcount &#41;{
                    $transporthash-&gt;{$headerfield}= $answerdb{$qname}-&gt;{$qtype}-&gt;
                    {&#39;header&#39;}-&gt;{$headerfield} if defined
                    $answerdb{$qname}-&gt;{$qtype}-&gt;{&#39;header&#39;}-&gt;{$headerfield} ;
                }
                
                print &#34;Sleeping for &#34; . $answerdb{$qname}-&gt;{$qtype}-&gt;{&#39;delay&#39;}
                . &#34; seconds &#34;
                    if $self-&gt;{verbose} &#38;&#38; $answerdb{$qname}-&gt;{$qtype}-&gt;{&#39;delay&#39;};
                
                sleep &#40;$answerdb{$qname}-&gt;{$qtype}-&gt;{&#39;delay&#39;}&#41;;
                
                if &#40;defined&#40;$answerdb{$qname}-&gt;{$qtype}-&gt;{&#39;raw&#39;}&#41;&#41;{
                    $transporthash-&gt;{&#39;raw&#39;}=$answerdb{$qname}-&gt;{$qtype}-&gt;{&#39;raw&#39;};
                }
                
                
                return &#40;$rcode, $answerdb{$qname}-&gt;{$qtype}-&gt;{&#39;answer&#39;},
                        $answerdb{$qname}-&gt;{$qtype}-&gt;{&#39;authority&#39;},
                        $answerdb{$qname}-&gt;{$qtype}-&gt;{&#39;additional&#39;},
                        $transporthash&#41;;
                
            }
        
            return &#40;&#34;SERVFAIL&#34;&#41;;
        };




Hope this helps,

--Olaf


On Jan 24, 2009, at 3:55 AM, Ty Miller via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Fri Jan 23 21:55:01 2009: Request 42744 was acted upon.
&gt; Transaction: Ticket created by tyronmiller
&gt;       Queue: Net-DNS
&gt;     Subject: Net::DNS::Header-&gt;tc&#40;1&#41; doesn&#39;t set Trucation flag
&gt;   Broken in: 0.63
&gt;    Severity: Important
&gt;       Owner: Nobody
&gt;  Requestors: tyronmiller@gmail.com
&gt;      Status: new
&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=42744">https://rt.cpan.org/Ticket/Display.html?id=42744</a></span> &gt;
&gt;
&gt;
&gt; I am trying to send large DNS responses, which means I need to set the
&gt; &#34;tc&#34; flag so that the transport changes from UDP to TCP due to  
&gt; truncated
&gt; data. When using the following code, the header data is printed out  
&gt; with
&gt; the &#34;tc&#34; flag set; however, in Wireshark the flag is still shown to be
&gt; off and the transport does not get redirected to TCP by the requesting
&gt; DNS server.
&gt;
&gt; [snip]
&gt; $header = Net::DNS::Header-&gt;new;
&gt; $header-&gt;aa&#40;1&#41;; # sets aa flag in both printed output and wireshark
&gt; $header-&gt;tc&#40;1&#41;; # sets tc flag in printed output, but not wireshark
&gt; $header-&gt;print; # prints both flags as being set, but tc not shown in
&gt; wireshark
&gt; my @response = &#40;$rcode, \@ans, \@auth, \@add, $header&#41;;
&gt; return @response;
&gt; #end reply handler
&gt;
&gt; I am using version 0.63, and I checked the changelog for 0.64 but  
&gt; there
&gt; was no mention of a bug fix for this issue.
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/559151/282233/PGP.sig">Download PGP.sig</a><br />
<span class="downloadcontenttype">application/pgp-signature 194b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-559152" href="/Public/Bug/Display.html?id=33547#txn-559152">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;24&nbsp;05:43:32&nbsp;2009</span>
    <span class="description">The RT System itself - Ticket #42744:  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-560226" href="/Public/Bug/Display.html?id=33547#txn-560226">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;27&nbsp;03:53:55&nbsp;2009</span>
    <span class="description">tyronmiller [...] gmail.com - Ticket #42744:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #42744] Net::DNS::Header-&gt;tc&#40;1&#41; doesn&#39;t set  Trucation flag</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 27 Jan 2009 19:23:53 +1100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ty Miller &lt;tyronmiller [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/560226/282821/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/282821">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 6.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Olaf,

Thanks so much for the quick and detailed response.

Yes, I have implemented a ReplyHandler which works fine, except that the
responses I am sending are larger than 512 bytes, so i&#39;m trying to set the
truncation bit &#40;tc&#41; so that the protocol falls back to TCP, which should
allow me to send large DNS responses.

I can see how you have used the &#34;transporthash&#34; in the code. Sorry about my
misunderstanding. Originally I was doing this; however, I tried to set the
tc bit directly in the hash ... like ... { aa =&gt; 1, tc =&gt; 1} ... which
obviously didn&#39;t work.

I implemented the technique shown below where it sets the hash and then
loops through the other flags &#40;including tc&#41;; however, I am still struggling
to get it to work. Some of the other flags seem to get set, but the tc flag
is still not being set - as shown by wireshark. The only difference to the
implementation that you provied was that I didn&#39;t have the &#34;answerdb&#34;, and
simply set the header field to 1 to see if each flag would be set, as shown
below;

               foreach my $headerfield qw&#40;aa qr ad rd tc id cd&#41;{
                   $transporthash-&gt;{$headerfield} = 1;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt;                }
&gt;
</div>

On a side note, since you listed the response codes, I was wondering whether
you could confirm which ones a DNS server will not cache. For example, if I
request &#34;nonexistent.projectshellcode.com&#34; I currently send back a SERVFAIL
response assuming that a DNS cache would not cache failed queries. &#40;my
server doesn&#39;t need to be RFC compliant - and specifically isn&#39;t&#41;

Thanks again for your help mate,
Ty


On Sat, Jan 24, 2009 at 9:43 PM, Olaf M. Kolkman via RT &lt;
bug-Net-DNS@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=42744">http://rt.cpan.org/Ticket/Display.html?id=42744</a></span> &gt;
&gt;
&gt;
&gt; I take it that you are trying to construct a reply handler.
&gt;
&gt;        The ReplyHandler subroutine is passed the query name, query
&gt; class,
&gt;        query type and optionally an argument containing the peerhost,
&gt; the
&gt;        incoming query, and the name of the incomming socket
&gt; &#40;sockethost&#41;. It
&gt;        must return the response code and references to the answer,
&gt; authority,
&gt;        and additional sections of the response.  Common response
&gt; codes are:
&gt;
&gt;          NOERROR       No error
&gt;          FORMERR       Format error
&gt;          SERVFAIL      Server failure
&gt;          NXDOMAIN      Non‐existent domain &#40;name doesn&#39;t exist&#41;
&gt;          NOTIMP        Not implemented
&gt;          REFUSED       Query refused
&gt;
&gt;        For advanced usage it may also contain a headermaks containing
&gt; an
&gt;        hashref with the settings for the &#34;aa&#34;, &#34;ra&#34;, and &#34;ad&#34; header
&gt; bits. The
&gt;        argument is of the form &#34;{ ad =&gt; 1, aa =&gt; 0, ra =&gt; 1 }&#34;.
&gt;
&gt;
&gt; The argument that tweaks the bits is not a header object but a
&gt; reference to a hash containing the header values.
&gt;
&gt; Here is a code sniplet from Net::DNS::TestNS that sets the arguments
&gt; and uses the headermask, maybe that is of use.
&gt;
&gt;
&gt;
&gt;        # The XML has been parsed and all info sits in the %answer db..
&gt;        # We now construct the reply handler using that.
&gt;        my $reply_handler = sub {
&gt;            my &#40;$qname, $qclass, $qtype&#41; = @_;
&gt;            $qname.=&#34;.&#34; if $qname !~ /\.$/;
&gt;            my &#40;$rcode, @ans, @auth, @add&#41;;
&gt;            if &#40; exists $answerdb{$qname}-&gt;{$qtype}&#41;{
&gt;                $rcode= $answerdb{$qname}-&gt;{$qtype}-&gt;{&#39;rcode&#39;};
&gt;                my $transporthash= {
&gt;                    &#39;aa&#39; =&gt;
&gt;                        $answerdb{$qname}-&gt;{$qtype}-&gt;
&gt;                    {&#39;header&#39;}-&gt;{&#39;aa&#39;},
&gt;                        &#39;ra&#39; =&gt;
&gt;                        $answerdb{$qname}-&gt;{$qtype}-&gt;
&gt;                    {&#39;header&#39;}-&gt;{&#39;ra&#39;},
&gt;                    };
&gt;
&gt;                foreach my $headerfield qw&#40;aa qr ad rd tc id cd
&gt;                                           qdcount ancount nscount arcount
&gt; &#41;{
&gt;                    $transporthash-&gt;{$headerfield}=
&gt; $answerdb{$qname}-&gt;{$qtype}-&gt;
&gt;                    {&#39;header&#39;}-&gt;{$headerfield} if defined
&gt;                    $answerdb{$qname}-&gt;{$qtype}-&gt;{&#39;header&#39;}-&gt;{$headerfield}
&gt; ;
&gt;                }
&gt;
&gt;                print &#34;Sleeping for &#34; .
&gt; $answerdb{$qname}-&gt;{$qtype}-&gt;{&#39;delay&#39;}
&gt;                . &#34; seconds &#34;
&gt;                    if $self-&gt;{verbose} &#38;&#38;
&gt; $answerdb{$qname}-&gt;{$qtype}-&gt;{&#39;delay&#39;};
&gt;
&gt;                sleep &#40;$answerdb{$qname}-&gt;{$qtype}-&gt;{&#39;delay&#39;}&#41;;
&gt;
&gt;                if &#40;defined&#40;$answerdb{$qname}-&gt;{$qtype}-&gt;{&#39;raw&#39;}&#41;&#41;{
&gt;
&gt;  $transporthash-&gt;{&#39;raw&#39;}=$answerdb{$qname}-&gt;{$qtype}-&gt;{&#39;raw&#39;};
&gt;                }
&gt;
&gt;
&gt;                return &#40;$rcode, $answerdb{$qname}-&gt;{$qtype}-&gt;{&#39;answer&#39;},
&gt;                        $answerdb{$qname}-&gt;{$qtype}-&gt;{&#39;authority&#39;},
&gt;                        $answerdb{$qname}-&gt;{$qtype}-&gt;{&#39;additional&#39;},
&gt;                        $transporthash&#41;;
&gt;
&gt;            }
&gt;
&gt;            return &#40;&#34;SERVFAIL&#34;&#41;;
&gt;        };
&gt;
&gt;
&gt;
&gt;
&gt; Hope this helps,
&gt;
&gt; --Olaf
&gt;
&gt;
&gt; On Jan 24, 2009, at 3:55 AM, Ty Miller via RT wrote:
&gt;
<div class="message-stanza open">&gt; &gt; Fri Jan 23 21:55:01 2009: Request 42744 was acted upon.
&gt; &gt; Transaction: Ticket created by tyronmiller
&gt; &gt;       Queue: Net-DNS
&gt; &gt;     Subject: Net::DNS::Header-&gt;tc&#40;1&#41; doesn&#39;t set Trucation flag
&gt; &gt;   Broken in: 0.63
&gt; &gt;    Severity: Important
&gt; &gt;       Owner: Nobody
&gt; &gt;  Requestors: tyronmiller@gmail.com
&gt; &gt;      Status: new
&gt; &gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=42744">https://rt.cpan.org/Ticket/Display.html?id=42744</a></span> &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; I am trying to send large DNS responses, which means I need to set the
&gt; &gt; &#34;tc&#34; flag so that the transport changes from UDP to TCP due to
&gt; &gt; truncated
&gt; &gt; data. When using the following code, the header data is printed out
&gt; &gt; with
&gt; &gt; the &#34;tc&#34; flag set; however, in Wireshark the flag is still shown to be
&gt; &gt; off and the transport does not get redirected to TCP by the requesting
&gt; &gt; DNS server.
&gt; &gt;
&gt; &gt; [snip]
&gt; &gt; $header = Net::DNS::Header-&gt;new;
&gt; &gt; $header-&gt;aa&#40;1&#41;; # sets aa flag in both printed output and wireshark
&gt; &gt; $header-&gt;tc&#40;1&#41;; # sets tc flag in printed output, but not wireshark
&gt; &gt; $header-&gt;print; # prints both flags as being set, but tc not shown in
&gt; &gt; wireshark
&gt; &gt; my @response = &#40;$rcode, \@ans, \@auth, \@add, $header&#41;;
&gt; &gt; return @response;
&gt; &gt; #end reply handler
&gt; &gt;
&gt; &gt; I am using version 0.63, and I checked the changelog for 0.64 but
&gt; &gt; there
&gt; &gt; was no mention of a bug fix for this issue.
</div>&gt;
&gt;
&gt;
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/560226/282822/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/282822">with headers</a>
<br />
<span class="downloadcontenttype">text/html 9.8k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-560244" href="/Public/Bug/Display.html?id=33547#txn-560244">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;27&nbsp;05:53:04&nbsp;2009</span>
    <span class="description">olaf [...] dacht.net - Ticket #42744:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #42744] Net::DNS::Header-&gt;tc&#40;1&#41; doesn&#39;t set  Trucation flag</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 27 Jan 2009 11:51:16 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Olaf Kolkman &lt;olaf [...] dacht.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/560244/282835/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/282835">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On Jan 27, 2009, at 9:53 AM, Ty Miller via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       Queue: Net-DNS
&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=42744">http://rt.cpan.org/Ticket/Display.html?id=42744</a></span> &gt;
&gt;
&gt; Hi Olaf,
&gt;
&gt; Thanks so much for the quick and detailed response.
&gt;
&gt; Yes, I have implemented a ReplyHandler which works fine, except that  
&gt; the
&gt; responses I am sending are larger than 512 bytes, so i&#39;m trying to  
&gt; set the
&gt; truncation bit &#40;tc&#41; so that the protocol falls back to TCP, which  
&gt; should
&gt; allow me to send large DNS responses.
&gt;
&gt; I can see how you have used the &#34;transporthash&#34; in the code. Sorry  
&gt; about my
&gt; misunderstanding. Originally I was doing this; however, I tried to  
&gt; set the
&gt; tc bit directly in the hash ... like ... { aa =&gt; 1, tc =&gt; 1} ... which
&gt; obviously didn&#39;t work.
&gt;
&gt; I implemented the technique shown below where it sets the hash and  
&gt; then
&gt; loops through the other flags &#40;including tc&#41;; however, I am still  
&gt; struggling
&gt; to get it to work. Some of the other flags seem to get set, but the  
&gt; tc flag
&gt; is still not being set - as shown by wireshark. The only difference  
&gt; to the
&gt; implementation that you provied was that I didn&#39;t have the  
&gt; &#34;answerdb&#34;, and
&gt; simply set the header field to 1 to see if each flag would be set,  
&gt; as shown
&gt; below;
&gt;
&gt;               foreach my $headerfield qw&#40;aa qr ad rd tc id cd&#41;{
&gt;                   $transporthash-&gt;{$headerfield} = 1;
<div class="message-stanza open">&gt;&gt;
&gt;&gt;               }
&gt;&gt;
</div>&gt;
&gt;
</div>
I have no time to dig into this shortly.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On a side note, since you listed the response codes, I was wondering  
&gt; whether
&gt; you could confirm which ones a DNS server will not cache. For  
&gt; example, if I
&gt; request &#34;nonexistent.projectshellcode.com&#34; I currently send back a  
&gt; SERVFAIL
&gt; response assuming that a DNS cache would not cache failed queries. &#40;my
&gt; server doesn&#39;t need to be RFC compliant - and specifically isn&#39;t&#41;
</div>


That is implementation specific. Some clients may &#39;cache&#39; the SERVFAIL  
and may not return to your server for some time.

One of the things you can do is send back a NXDOMAIN with a SOA RR  
that has a its negative caching field set to 0. But that may also not  
be respected.

--Olaf
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/560244/282836/PGP.sig">Download PGP.sig</a><br />
<span class="downloadcontenttype">application/pgp-signature 194b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-560444" href="/Public/Bug/Display.html?id=33547#txn-560444">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;27&nbsp;16:25:30&nbsp;2009</span>
    <span class="description">tyronmiller [...] gmail.com - Ticket #42744:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #42744] Net::DNS::Header-&gt;tc&#40;1&#41; doesn&#39;t set  Trucation flag</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 28 Jan 2009 08:17:21 +1100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ty Miller &lt;tyronmiller [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/560444/282969/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/282969">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks Olaf. Sorry to bug you about this. The truncation bit doesn&#39;t seem to
work, and I can&#39;t find any descent examples of anyone actually getting it to
work.

Thanks again,
Ty


On Tue, Jan 27, 2009 at 9:53 PM, Olaf M. Kolkman via RT &lt;
bug-Net-DNS@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=42744">https://rt.cpan.org/Ticket/Display.html?id=42744</a></span> &gt;
&gt;
&gt;
&gt; On Jan 27, 2009, at 9:53 AM, Ty Miller via RT wrote:
&gt;
<div class="message-stanza open">&gt; &gt;       Queue: Net-DNS
&gt; &gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=42744">http://rt.cpan.org/Ticket/Display.html?id=42744</a></span> &gt;
&gt; &gt;
&gt; &gt; Hi Olaf,
&gt; &gt;
&gt; &gt; Thanks so much for the quick and detailed response.
&gt; &gt;
&gt; &gt; Yes, I have implemented a ReplyHandler which works fine, except that
&gt; &gt; the
&gt; &gt; responses I am sending are larger than 512 bytes, so i&#39;m trying to
&gt; &gt; set the
&gt; &gt; truncation bit &#40;tc&#41; so that the protocol falls back to TCP, which
&gt; &gt; should
&gt; &gt; allow me to send large DNS responses.
&gt; &gt;
&gt; &gt; I can see how you have used the &#34;transporthash&#34; in the code. Sorry
&gt; &gt; about my
&gt; &gt; misunderstanding. Originally I was doing this; however, I tried to
&gt; &gt; set the
&gt; &gt; tc bit directly in the hash ... like ... { aa =&gt; 1, tc =&gt; 1} ... which
&gt; &gt; obviously didn&#39;t work.
&gt; &gt;
&gt; &gt; I implemented the technique shown below where it sets the hash and
&gt; &gt; then
&gt; &gt; loops through the other flags &#40;including tc&#41;; however, I am still
&gt; &gt; struggling
&gt; &gt; to get it to work. Some of the other flags seem to get set, but the
&gt; &gt; tc flag
&gt; &gt; is still not being set - as shown by wireshark. The only difference
&gt; &gt; to the
&gt; &gt; implementation that you provied was that I didn&#39;t have the
&gt; &gt; &#34;answerdb&#34;, and
&gt; &gt; simply set the header field to 1 to see if each flag would be set,
&gt; &gt; as shown
&gt; &gt; below;
&gt; &gt;
&gt; &gt;               foreach my $headerfield qw&#40;aa qr ad rd tc id cd&#41;{
&gt; &gt;                   $transporthash-&gt;{$headerfield} = 1;
<div class="message-stanza open">&gt; &gt;&gt;
&gt; &gt;&gt;               }
&gt; &gt;&gt;
</div>&gt; &gt;
&gt; &gt;
</div>&gt;
&gt; I have no time to dig into this shortly.
&gt;
&gt;
<div class="message-stanza open">&gt; &gt; On a side note, since you listed the response codes, I was wondering
&gt; &gt; whether
&gt; &gt; you could confirm which ones a DNS server will not cache. For
&gt; &gt; example, if I
&gt; &gt; request &#34;nonexistent.projectshellcode.com&#34; I currently send back a
&gt; &gt; SERVFAIL
&gt; &gt; response assuming that a DNS cache would not cache failed queries. &#40;my
&gt; &gt; server doesn&#39;t need to be RFC compliant - and specifically isn&#39;t&#41;
</div>&gt;
&gt;
&gt;
&gt; That is implementation specific. Some clients may &#39;cache&#39; the SERVFAIL
&gt; and may not return to your server for some time.
&gt;
&gt; One of the things you can do is send back a NXDOMAIN with a SOA RR
&gt; that has a its negative caching field set to 0. But that may also not
&gt; be respected.
&gt;
&gt; --Olaf
&gt;
&gt;
&gt;
&gt;
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/560444/282970/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/282970">with headers</a>
<br />
<span class="downloadcontenttype">text/html 3.6k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-627602" href="/Public/Bug/Display.html?id=33547#txn-627602">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;03&nbsp;02:38:35&nbsp;2009</span>
    <span class="description">olaf [...] dacht.net - Ticket #42744:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #42744] Net::DNS::Header-&gt;tc&#40;1&#41; doesn&#39;t set  Trucation flag</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 03 Jul 2009 08:36:55 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Olaf Kolkman &lt;olaf [...] dacht.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/627602/319469/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/319469">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 6.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ty Miller via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-DNS
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=42744">https://rt.cpan.org/Ticket/Display.html?id=42744</a></span> &gt;
&gt;
&gt; Thanks Olaf. Sorry to bug you about this. The truncation bit doesn&#39;t seem to
&gt; work, and I can&#39;t find any descent examples of anyone actually getting it to
&gt; work.
&gt;
&gt; Thanks again,
&gt; Ty
&gt;
&gt;
&gt; On Tue, Jan 27, 2009 at 9:53 PM, Olaf M. Kolkman via RT &lt;
&gt; bug-Net-DNS@rt.cpan.org&gt; wrote:
&gt;
&gt;   
<div class="message-stanza open">&gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=42744">https://rt.cpan.org/Ticket/Display.html?id=42744</a></span> &gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; On Jan 27, 2009, at 9:53 AM, Ty Miller via RT wrote:
&gt;&gt;
&gt;&gt;     
<div class="message-stanza open">&gt;&gt;&gt;       Queue: Net-DNS
&gt;&gt;&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=42744">http://rt.cpan.org/Ticket/Display.html?id=42744</a></span> &gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Hi Olaf,
&gt;&gt;&gt;
&gt;&gt;&gt; Thanks so much for the quick and detailed response.
&gt;&gt;&gt;
&gt;&gt;&gt; Yes, I have implemented a ReplyHandler which works fine, except that
&gt;&gt;&gt; the
&gt;&gt;&gt; responses I am sending are larger than 512 bytes, so i&#39;m trying to
&gt;&gt;&gt; set the
&gt;&gt;&gt; truncation bit &#40;tc&#41; so that the protocol falls back to TCP, which
&gt;&gt;&gt; should
&gt;&gt;&gt; allow me to send large DNS responses.
&gt;&gt;&gt;
&gt;&gt;&gt; I can see how you have used the &#34;transporthash&#34; in the code. Sorry
&gt;&gt;&gt; about my
&gt;&gt;&gt; misunderstanding. Originally I was doing this; however, I tried to
&gt;&gt;&gt; set the
&gt;&gt;&gt; tc bit directly in the hash ... like ... { aa =&gt; 1, tc =&gt; 1} ... which
&gt;&gt;&gt; obviously didn&#39;t work.
&gt;&gt;&gt;
&gt;&gt;&gt; I implemented the technique shown below where it sets the hash and
&gt;&gt;&gt; then
&gt;&gt;&gt; loops through the other flags &#40;including tc&#41;; however, I am still
&gt;&gt;&gt; struggling
&gt;&gt;&gt; to get it to work. Some of the other flags seem to get set, but the
&gt;&gt;&gt; tc flag
&gt;&gt;&gt; is still not being set - as shown by wireshark. The only difference
&gt;&gt;&gt; to the
&gt;&gt;&gt; implementation that you provied was that I didn&#39;t have the
&gt;&gt;&gt; &#34;answerdb&#34;, and
&gt;&gt;&gt; simply set the header field to 1 to see if each flag would be set,
&gt;&gt;&gt; as shown
&gt;&gt;&gt; below;
&gt;&gt;&gt;
&gt;&gt;&gt;               foreach my $headerfield qw&#40;aa qr ad rd tc id cd&#41;{
&gt;&gt;&gt;                   $transporthash-&gt;{$headerfield} = 1;
&gt;&gt;&gt;       
<div class="message-stanza open">&gt;&gt;&gt;&gt;               }
&gt;&gt;&gt;&gt;
&gt;&gt;&gt;&gt;         
</div>&gt;&gt;&gt;       
</div>&gt;&gt; I have no time to dig into this shortly.
&gt;&gt;
&gt;&gt;
&gt;&gt;     
<div class="message-stanza open">&gt;&gt;&gt; On a side note, since you listed the response codes, I was wondering
&gt;&gt;&gt; whether
&gt;&gt;&gt; you could confirm which ones a DNS server will not cache. For
&gt;&gt;&gt; example, if I
&gt;&gt;&gt; request &#34;nonexistent.projectshellcode.com&#34; I currently send back a
&gt;&gt;&gt; SERVFAIL
&gt;&gt;&gt; response assuming that a DNS cache would not cache failed queries. &#40;my
&gt;&gt;&gt; server doesn&#39;t need to be RFC compliant - and specifically isn&#39;t&#41;
&gt;&gt;&gt;       
</div>&gt;&gt;
&gt;&gt; That is implementation specific. Some clients may &#39;cache&#39; the SERVFAIL
&gt;&gt; and may not return to your server for some time.
&gt;&gt;
&gt;&gt; One of the things you can do is send back a NXDOMAIN with a SOA RR
&gt;&gt; that has a its negative caching field set to 0. But that may also not
&gt;&gt; be respected.
&gt;&gt;
&gt;&gt; --Olaf
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt;     
</div>&gt;
&gt;   
&gt;
&gt; ------------------------------------------------------------------------
&gt;
&gt; Thanks Olaf. Sorry to bug you about this. The truncation bit doesn&#39;t 
&gt; seem to work, and I can&#39;t find any descent examples of anyone actually 
&gt; getting it to work.
&gt;
&gt; Thanks again,
&gt; Ty
&gt;
&gt;
&gt; On Tue, Jan 27, 2009 at 9:53 PM, Olaf M. Kolkman via RT 
&gt; &lt;bug-Net-DNS@rt.cpan.org &lt;mailto:bug-Net-DNS@rt.cpan.org&gt;&gt; wrote:
&gt;
&gt;     &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=42744">https://rt.cpan.org/Ticket/Display.html?id=42744</a></span> &gt;
&gt;
&gt;
&gt;     On Jan 27, 2009, at 9:53 AM, Ty Miller via RT wrote:
&gt;
<div class="message-stanza open">&gt;     &gt;       Queue: Net-DNS
&gt;     &gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=42744">http://rt.cpan.org/Ticket/Display.html?id=42744</a></span> &gt;
&gt;     &gt;
&gt;     &gt; Hi Olaf,
&gt;     &gt;
&gt;     &gt; Thanks so much for the quick and detailed response.
&gt;     &gt;
&gt;     &gt; Yes, I have implemented a ReplyHandler which works fine, except that
&gt;     &gt; the
&gt;     &gt; responses I am sending are larger than 512 bytes, so i&#39;m trying to
&gt;     &gt; set the
&gt;     &gt; truncation bit &#40;tc&#41; so that the protocol falls back to TCP, which
&gt;     &gt; should
&gt;     &gt; allow me to send large DNS responses.
&gt;     &gt;
&gt;     &gt; I can see how you have used the &#34;transporthash&#34; in the code. Sorry
&gt;     &gt; about my
&gt;     &gt; misunderstanding. Originally I was doing this; however, I tried to
&gt;     &gt; set the
&gt;     &gt; tc bit directly in the hash ... like ... { aa =&gt; 1, tc =&gt; 1} ...
</div>&gt;     which
<div class="message-stanza open">&gt;     &gt; obviously didn&#39;t work.
&gt;     &gt;
&gt;     &gt; I implemented the technique shown below where it sets the hash and
&gt;     &gt; then
&gt;     &gt; loops through the other flags &#40;including tc&#41;; however, I am still
&gt;     &gt; struggling
&gt;     &gt; to get it to work. Some of the other flags seem to get set, but the
&gt;     &gt; tc flag
&gt;     &gt; is still not being set - as shown by wireshark. The only difference
&gt;     &gt; to the
&gt;     &gt; implementation that you provied was that I didn&#39;t have the
&gt;     &gt; &#34;answerdb&#34;, and
&gt;     &gt; simply set the header field to 1 to see if each flag would be set,
&gt;     &gt; as shown
&gt;     &gt; below;
&gt;     &gt;
&gt;     &gt;               foreach my $headerfield qw&#40;aa qr ad rd tc id cd&#41;{
&gt;     &gt;                   $transporthash-&gt;{$headerfield} = 1;
<div class="message-stanza open">&gt;     &gt;&gt;
&gt;     &gt;&gt;               }
&gt;     &gt;&gt;
</div>&gt;     &gt;
&gt;     &gt;
</div>&gt;
&gt;     I have no time to dig into this shortly.
&gt;
&gt;
<div class="message-stanza open">&gt;     &gt; On a side note, since you listed the response codes, I was wondering
&gt;     &gt; whether
&gt;     &gt; you could confirm which ones a DNS server will not cache. For
&gt;     &gt; example, if I
&gt;     &gt; request &#34;nonexistent.projectshellcode.com
</div>&gt;     &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://nonexistent.projectshellcode.com">http://nonexistent.projectshellcode.com</a></span>&gt;&#34; I currently send back a
<div class="message-stanza open">&gt;     &gt; SERVFAIL
&gt;     &gt; response assuming that a DNS cache would not cache failed
</div>&gt;     queries. &#40;my
<div class="message-stanza open">&gt;     &gt; server doesn&#39;t need to be RFC compliant - and specifically isn&#39;t&#41;
</div>&gt;
&gt;
&gt;
&gt;     That is implementation specific. Some clients may &#39;cache&#39; the SERVFAIL
&gt;     and may not return to your server for some time.
&gt;
&gt;     One of the things you can do is send back a NXDOMAIN with a SOA RR
&gt;     that has a its negative caching field set to 0. But that may also not
&gt;     be respected.
&gt;
&gt;     --Olaf
&gt;
&gt;
&gt;
&gt;
</div>

Quick fix, that may not get into the release since truncation involves a 
lot of &#39;intelligence&#39; &#40;See RFC2181 about dropping by RRset etc&#41; and 
therefore a special method to do the truncation may be more appropriate.

In Nameserver.pm


find this code fragment:

    if &#40;!defined &#40;$headermask&#41;&#41; {
        $reply-&gt;header-&gt;ra&#40;1&#41;;
        $reply-&gt;header-&gt;ad&#40;0&#41;;
    } else {
        $reply-&gt;header-&gt;aa&#40;1&#41; if $headermask-&gt;{&#39;aa&#39;};
        $reply-&gt;header-&gt;ra&#40;1&#41; if $headermask-&gt;{&#39;ra&#39;};
        $reply-&gt;header-&gt;ad&#40;1&#41; if $headermask-&gt;{&#39;ad&#39;};
        if &#40;defined $Net::DNS::opcodesbyname{$headermask-&gt;{&#39;opcode&#39;}}&#41;{
            $reply-&gt;header-&gt;opcode&#40; $headermask-&gt;{&#39;opcode&#39;} &#41;;
        }
    }
   

and add
   $reply-&gt;header-&gt;tc&#40;1&#41; if $headermask-&gt;{&#39;tc&#39;};

in the then-part of the if-then statement.


&#40;not tested&#41;
--Olaf
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-712707" href="/Public/Bug/Display.html?id=33547#txn-712707">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;29&nbsp;12:56:04&nbsp;2009</span>
    <span class="description">OLAF [...] cpan.org - Ticket #42744:  Merged into ticket #33547</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-712708" href="/Public/Bug/Display.html?id=33547#txn-712708">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;29&nbsp;12:56:04&nbsp;2009</span>
    <span class="description">OLAF [...] cpan.org -  Merged into ticket #33547</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-712762" href="/Public/Bug/Display.html?id=33547#txn-712762">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;29&nbsp;15:23:18&nbsp;2009</span>
    <span class="description">OLAF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/712762/367917/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/367917">with headers</a>
<br />
<span class="downloadcontenttype">text/html 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza">&nbsp;<br>

The Truncation code has been implemented differently than suggested, the test code was used but modified.<br>

<br>

Fixed on the trunk as of version 835<br>

<br>

From Chances:<br>

<br>


<div>&nbsp;</div>


<div>Feature Truncation for Nameserver</div>


<div>&nbsp;&nbsp; &nbsp;fixes rt.cpan.org #33547 and #42744</div>


<div>&nbsp;</div>


<div>&nbsp;&nbsp; &nbsp;TAKE CARE:</div>


<div>&nbsp;&nbsp; &nbsp;this feature may cause unexpected behavior for your nameservers</div>


<div>&nbsp;&nbsp; &nbsp;and can be turned off by setting Truncate to 0 during the creation</div>


<div>&nbsp;&nbsp; &nbsp;of the nameserver.&nbsp;</div>


<div>&nbsp;&nbsp; &nbsp;my $ns = Net::DNS::Nameserver-&gt;new(</div>


<div><span>		</span>Truncate =&gt; 0,</div>


<div>&nbsp;</div>


<div>&nbsp;&nbsp; &nbsp;);</div>


<div>&nbsp;</div>


<div>&nbsp;</div>


<div>&nbsp;&nbsp; &nbsp;Net::DNS::Packet::truncate is a new method that is called from</div>


<div>&nbsp;&nbsp; &nbsp;within Net::DNS::Nameserver that truncates a packet according to</div>


<div>&nbsp;&nbsp; &nbsp;the rules of RFC2181 section 9.</div>


<div>&nbsp;</div>


<div>&nbsp;&nbsp; &nbsp;Acknowledgement Aaron Crane for an elegant test and for</div>


<div>&nbsp;&nbsp; &nbsp;inspiration for a direction.</div>


<div>&nbsp;</div>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-712765" href="/Public/Bug/Display.html?id=33547#txn-712765">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;29&nbsp;15:23:20&nbsp;2009</span>
    <span class="description">OLAF [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-712815" href="/Public/Bug/Display.html?id=33547#txn-712815">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;29&nbsp;17:31:37&nbsp;2009</span>
    <span class="description">tyronmiller [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> cpan [...] aaroncrane.co.uk</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #33547] Net::DNS::Nameserver doesn&#39;t truncate long  UDP replies [PATCH]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 29 Dec 2009 22:31:21 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Olaf Kolkman via RT &lt;bug-Net-DNS [...] rt.cpan.org&gt;, tyronmiller [...] gmail.com</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> tyronmiller [...] gmail.com</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/712815/367955/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/367955">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 959b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hey Olaf,

Thanks for your persistance with this. It will come in handy!

Thanks again,
Ty


On , Olaf Kolkman via RT &lt;bug-Net-DNS@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=33547">https://rt.cpan.org/Ticket/Display.html?id=33547</a></span> &gt;
</div>


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The Truncation code has been implemented differently than suggested, the  
&gt; test
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; code was used but modified.
</div>


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Fixed on the trunk as of version 835
</div>


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  From Chances:
</div>


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Feature Truncation for Nameserver fixes rt.cpan.org #33547 and #42744 TAKE
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; CARE: this feature may cause unexpected behavior for your nameservers and  
&gt; can
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; be turned off by setting Truncate to 0 during the creation of the  
&gt; nameserver.
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; my $ns = Net::DNS::Nameserver-&gt;new&#40; Truncate =&gt; 0, &#41;;
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Net::DNS::Packet::truncate is a new method that is called from within
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Net::DNS::Nameserver that truncates a packet according to the rules of  
&gt; RFC2181
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; section 9. Acknowledgement Aaron Crane for an elegant test and for  
&gt; inspiration
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; for a direction.
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/712815/367956/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/367956">with headers</a>
<br />
<span class="downloadcontenttype">text/html 1.2k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-712818" href="/Public/Bug/Display.html?id=33547#txn-712818">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;29&nbsp;17:31:39&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-713021" href="/Public/Bug/Display.html?id=33547#txn-713021">#</a>      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;30&nbsp;05:31:32&nbsp;2009</span>
    <span class="description">OLAF [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 1.042159</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
