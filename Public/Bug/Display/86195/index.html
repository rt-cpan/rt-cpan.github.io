<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #86195 for Mail-Sender: Long Subject lines with accented characters broken</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #86195 for Mail-Sender: Long Subject lines with accented characters broken</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Mail-Sender">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Mail-Sender">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Mail-Sender">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Mail-Sender">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/Perl-Email-Project/Mail-Sender/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-Sender">Mail-Sender CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">86195</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Mail-Sender">Mail-Sender</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
andrew.jones11235 [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-20084-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-20085-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




print_hdr_qp_encoding.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1300037/688735/print_hdr_qp_encoding.patch">
Mon Dec 09 11:48:53 2013 (1k) by jpl [...] plosquare.com
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1299527/688447/print_hdr_qp_encoding.patch">
Sat Dec 07 18:29:06 2013 (577b) by jpl [...] plosquare.com
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1284740/680855/print_hdr_qp_encoding.patch">
Thu Nov 07 10:06:33 2013 (425b) by jpl [...] plosquare.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=86195">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1224849" href="/Public/Bug/Display.html?id=86195#txn-1224849">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;16&nbsp;16:26:12&nbsp;2013</span>
    <span class="description">andrew.jones11235 [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Long Subject lines with accented characters broken</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 16 Jun 2013 22:25:32 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-Sender [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Andrew Jones &lt;andrew.jones11235 [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1224849/647005/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/647005">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 9.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">&#40;This mail should have been sent with UTF encoding&#41;

  Long, accented subject lines are broken.

Tested on:
 Mail::Sender 0.8.21  &#40;Fedora 18&#41; perl v5.16.3
 Mail::Sender 0.8.16  &#40;Fedora 16&#41; perl v5.14.3

I have no reason to believe the latest code addresses this bug

Depending on the number of accents in the text the treatment of subject lines 
fails as the line gets longer &#40;each utf-8 accented character adds 5 extra 
bytes to the header string plus an overhead of about 12 bytes of utf-8 related 
preamble and postamble so this can break for subject lines that do not look 
excessively long.

To demonstrate here is a subject line sent by Mail::Sender that works although 
it looks wrong:

Subject: =?utf-8?Q?Subject contains utf-8 &#40;=C3=A9&#41; and gets longer123456789
 123456789 12345678?=


&#40;in case it was mangled by mail system the line wrapped after &#39;longer123456789&#39;


And this is the next one in the series &#40;which is broken&#41;

Subject: =?utf-8?Q?Subject contains utf-8 &#40;=C3=A9&#41; and gets longer123456789
 123456789 12345678= 9?=

The final &#39;9&#39; is never displayed, even on later mails in the series

As a workaround I tried to format a header correctly with the name &#39;Subject:&#39;  
&#40;formatting code is below&#41; and leave the subject blank.  This worked perfectly 
with my Evolution mail client but not with Outlook which stored the first 
Subject line it saw and silently discarded any future headers identified as 
&#39;Subject:&#39;

So I had to patch Mail::Sender by creating a new parameter for 
Mail::Sender::Open etc which I called fmtsubj

  my $stat = $sender-&gt;Open&#40;{ to =&gt; $recipient,
                             encoding =&gt; $encoding,
                             charset =&gt; $charset,
                             ctype =&gt; &#39;text/html&#39;,
                             fmtsubj =&gt; $formattedSubject,
                           }&#41;;


where:

  my $formattedSubject = code_header&#40;&#39;Subject:&#39;, $subjectTextWithAccentsPerlFormatNotUnicode, {charset =&gt; $headercharset, encoding =&gt; $headercoding }&#41;;

&#40;source for code_header appears further down&#41;

The necessary changes to Sender.pm were
This -
        $self-&gt;{&#39;subject&#39;} = &#34;&lt;No subject&gt;&#34; unless defined $self-&gt;{&#39;subject&#39;};
        print_hdr $s, &#34;Subject&#34; =&gt; $self-&gt;{&#39;subject&#39;}, $self-&gt;{&#39;charset&#39;};


Becomes this -

                if &#40;defined $self-&gt;{&#39;fmtsubj&#39;}&#41; {
                      print $s $self-&gt;{&#39;fmtsubj&#39;};
                      }
                else {
                    $self-&gt;{&#39;subject&#39;} = &#34;&lt;No subject&gt;&#34; unless defined $self-&gt;{&#39;subject&#39;};
                    print_hdr $s, &#34;Subject&#34; =&gt; $self-&gt;{&#39;subject&#39;}, $self-&gt;{&#39;charset&#39;};
                }


This happens twice in the code.  I have only tested it for my particular implementation  and it 
works perfectly.  However I make no guarantees for anyone else.


#----code_header--------------------------------------------------------------------

# Calling syntax:  $formattedSubject = code_header&#40;&#39;Subject:&#39;, $headercontents,  {charset =&gt; &#39;iso-8859-1&#39;, encoding =&gt; &#39;Quoted-Printable&#39;   }&#41;;
# If not supplied the default values of charset will be utf-8 and encoding Base64

sub code_header {
  my &#40;$caption, $headerDataRaw, $parptr&#41; = @_;
  my $headercharset = $parptr-&gt;{charset} // &#39;utf-8&#39;;    # needs perl 5.16.2 <span class="clickylink"><a target="new" rel="nofollow" href="http://perldoc.perl.org/perl5100delta.html#Defined-or-operator">http://perldoc.perl.org/perl5100delta.html#Defined-or-operator</a></span>
  my $headerencoding = $parptr-&gt;{encoding} // &#39;Base64&#39;; # needs perl 5.16.2
  my @headlines = &#40;&#41;;
  my $headerPreamble = &#39; =?&#39;;
  if &#40;$headercharset =~ /utf \-? 8/ix&#41; {
    $headerPreamble .= &#39;utf-8?&#39;;
    $headercharset = &#39;utf-8&#39;;
  }
  elsif &#40;$headercharset =~ /iso \- 8859 \- 1 \Z/ix&#41; {
    $headerPreamble .= &#39;iso-8859-1?&#39;;
    $headercharset = &#39;iso-8859-1&#39;;
  }
  else {
    die &#34;Currently unhandled charset &#39;$headercharset&#39; called for in code_header&#34;; # &#40;Roll your own&#41;
  }
  if &#40; $headerencoding =~ /Base64/i &#41; {
    $headerPreamble .= &#39;B?&#39;;
    $headerencoding = &#39;Base64&#39;;
  }
  elsif &#40; $headerencoding =~ /Quoted \- Printable/ix &#41; {
    $headerPreamble .= &#39;Q?&#39;;
    $headerencoding = &#39;Quoted-Printable&#39;;
  }
  else { 
    die &#34;Currently unhandled encoding &#39;$headerencoding&#39; called for in code_header&#34;; # I only know about Base64 and Quoted-Printable
  }
  my $headerPostamble = &#39;?=&#39;;

  my $start = 0;  #start of substring of header data
# RFC 2045 P20 QP: The Quoted-Printable encoding REQUIRES that encoded lines be no more than 76 characters long.
# RFC 2045 P21 QP: The 76 character limit does not count the trailing CRLF, but counts all other characters, including any equal signs.
# RFC 2045 P25 B64: The encoded output stream must be represented in lines of no more than 76 characters each.
  my $maxBytesPerLine = 76;

  my $headerLine = $caption; # Initialize the first header line &#40;caption should include the &#39;:&#39; but not the following space&#41;
  my $headerLengthChars = length&#40;$headerDataRaw&#41;;  # Length of header in *characters* - not encoded bytes
  my $headerDone=0;

  while &#40;!$headerDone&#41; {
    my $lineDone = 0;
    $headerLine .= $headerPreamble;
    my $bytesFree = $maxBytesPerLine - length&#40;$headerLine&#41; - length&#40;$headerPostamble&#41;;
#----Base64
    if &#40;&#39;Base64&#39; eq $headerencoding&#41; {

      my $blocksFree = int &#40;$bytesFree / 4&#41;;  # It requires 4 bytes to encode 3 8bit characters 
      my $maxCharsToDecode = 3 * $blocksFree;  # although might not be enough space if non-ascii characters present
      my $length = &#40;$start + $maxCharsToDecode &lt; $headerLengthChars&#41; ? $maxCharsToDecode : &#40;$headerLengthChars - $start&#41; ;

      while &#40;!$lineDone&#41; {
        my $teststringRaw = substr&#40;$headerDataRaw, $start, $length&#41;;
        my $teststringENC = Encode::encode&#40;$headercharset, $teststringRaw&#41;;

        my $temp = MIME::Base64::encode&#40;$teststringENC&#41;;
        chomp $temp;
        if &#40;length&#40;$temp&#41; &lt;= $bytesFree&#41; { # the encoded data fits in the space available
          $headerLine .= &#40;$temp . $headerPostamble&#41;;
          push @headlines, $headerLine;
          $headerLine = &#39;&#39;;
          $start += $length;
          $lineDone = 1;
        }
        else {  # the encoded data does not fit in the space available
          $length--; # shorten the substring by 1 *character* and try again
        }
      }  # while &#40;!$lineDone&#41;

      $headerDone = 1 if &#40;$start &gt;= $headerLengthChars&#41;; #should never be greater but just in case...
    }  # if &#40;&#39;Base64&#39; eq $headerencoding&#41;

#----Quoted-Printable
    elsif &#40;&#39;Quoted-Printable&#39; eq $headerencoding&#41; {
      my $maxCharsToDecode = $bytesFree;
      my $length = &#40;$start + $maxCharsToDecode &lt; $headerLengthChars&#41; ? $maxCharsToDecode : &#40;$headerLengthChars - $start&#41; ;
# rfc2047 P6 The 8-bit hexadecimal value 20 &#40;e.g., ISO-8859-1 SPACE&#41; may be represented as &#34;_&#34; &#40;underscore, ASCII 95.&#41;.
      $headerDataRaw =~ s/ /_/g;
      while &#40;!$lineDone&#41; {
        my $teststringRaw = substr&#40;$headerDataRaw, $start, $length&#41;;
        my $teststringENC = Encode::encode&#40;$headercharset, $teststringRaw&#41;;
        my $temp = MIME::QuotedPrint::encode&#40;$teststringENC&#41;;
        chomp $temp;
        $temp =~ s/=\Z//;
        if &#40;length&#40;$temp&#41; &lt;= $bytesFree&#41; { # the encoded data fits in the space available
          $headerLine .= &#40;$temp . $headerPostamble&#41;;
          push @headlines, $headerLine;
          $headerLine = &#39;&#39;;
          $start += $length;
          $lineDone = 1;
        }
        else {
          $length--; # shorten the substring by 1 *character* and try again
        }
      }  # while &#40;!$lineDone&#41;

      $headerDone = 1 if &#40;$start &gt;= $headerLengthChars&#41;; #should never be greater than but just in case...

    }  # elsif &#40;&#39;Quoted-Printable&#39; eq $headerencoding&#41;
#----
  }  # while &#40;!$headerDone&#41;

  return join&#40;&#34;\x0d\x0a&#34;, @headlines&#41; . &#34;\x0d\x0a&#34;;
}

#-----------------------------------------------------------------------

Examples for subject lines produced by the above follow;

Subject line:
1234567891àçéïñôßü92123àçéïñôßü23456789412345678951234567896123456789712345678981234567899123456789

utf-8 Base64:
Subject: =?utf-8?B?MTIzNDU2Nzg5McOgw6fDqcOvw7HDtMOfw7w5MjEyM8Ogw6fDqcOv?=
 =?utf-8?B?w7HDtMOfw7wyMzQ1Njc4OTQxMjM0NTY3ODk1MTIzNDU2Nzg5NjEyMzQ1Njc4?=
 =?utf-8?B?OTcxMjM0NTY3ODk4MTIzNDU2Nzg5OTEyMzQ1Njc4OQ==?=

iso-8859-1 Base64:
Subject: =?iso-8859-1?B?MTIzNDU2Nzg5MeDn6e/x9N/8OTIxMjPg5+nv8fTf/DIzNDU2?=
 =?iso-8859-1?B?Nzg5NDEyMzQ1Njc4OTUxMjM0NTY3ODk2MTIzNDU2Nzg5NzEyMzQ1Njc4?=
 =?iso-8859-1?B?OTgxMjM0NTY3ODk5MTIzNDU2Nzg5?=

iso-8859-1 Quoted-Printable:
Subject: =?iso-8859-1?Q?1234567891=E0=E7=E9=EF=F1=F4=DF=FC92123=E0=E7=E9?=
 =?iso-8859-1?Q?=EF=F1=F4=DF=FC2345678941234567895123456789612345678971234?=
 =?iso-8859-1?Q?5678981234567899123456789?=

utf-8 Quoted-Printable:
Subject: =?utf-8?Q?1234567891=C3=A0=C3=A7=C3=A9=C3=AF=C3=B1=C3=B4=C3=9F?=
 =?utf-8?Q?=C3=BC92123=C3=A0=C3=A7=C3=A9=C3=AF=C3=B1=C3=B4=C3=9F=C3=BC2345?=
 =?utf-8?Q?678941234567895123456789612345678971234567898123456789912345678?=
 =?utf-8?Q?9?=


I have followed the rule in perlunitut:

   I/O flow &#40;the actual 5 minute tutorial&#41;
       The typical input/output flow of a program is:

           1. Receive and decode
           2. Process
           3. Encode and output

So for the test code I used for the above, Emacs saved the source file in utf8
and the first thing I had to do was decode it to perl&#39;s internal format

my $acntstring = &#39;1234567891àçéïñôßü92123àçéïñôßü23456789412345678951234567896123456789712345678981234567899123456789&#39;;
$acntstring = decode&#40;&#39;utf-8&#39;, $acntstring&#41;;

I forgot that step at one point and spent a day trying to work out why my subject lines were all 
double-encoded utf and displaying garbage.

I have relied on Mail::Sender for years and I hope I have been able to give back something of value

Best regards

Andy Jones
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1284740" href="/Public/Bug/Display.html?id=86195#txn-1284740">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;07&nbsp;10:06:33&nbsp;2013</span>
    <span class="description">jpl [...] plosquare.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jpl [...] plosquare.com</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1284740/680854/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/680854">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 344b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I just ran into this bug as well, long subject with non-ASCII characters delivered as gibberish. 

Please consider applying the attached two-line patch to print_hdr instead. The extra parameter for encode_qp which prevents it from outputting line breaks has been in MIME::QuotedPrintable since 2009 &#40;so it should be backward-compatible enough&#41;.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> print_hdr_qp_encoding.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1284740/680855/print_hdr_qp_encoding.patch">Download print_hdr_qp_encoding.patch</a><br />
<span class="downloadcontenttype">text/x-diff 425b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- orig/Mail-Sender-0.8.22/Sender.pm	2012-12-12 18:29:40.000000000 +0100
+++ new/Mail-Sender-0.8.22/Sender.pm	2013-11-07 16:00:05.883773811 +0100
@@ -181,8 +181,7 @@
 		my @parts = split /&#40;\s*[,;&lt;&gt;]\s*&#41;/, $str;
 		for &#40;@parts&#41; {
 			next unless /[^[:ascii:]]/;
-			$_ = encode_qp&#40;$_&#41;;
-			s/=\r?\n$//;
+			$_ = encode_qp&#40;$_, &#39;&#39;&#41;;
 			s/&#40;\s&#41;/&#39;=&#39; . sprintf &#39;%x&#39;,ord&#40;$1&#41;/ge;
 			$_ = &#34;=?$charset?Q?&#34; . $_ . &#34;?=&#34;;
 		}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1284741" href="/Public/Bug/Display.html?id=86195#txn-1284741">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;07&nbsp;10:06:33&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1299527" href="/Public/Bug/Display.html?id=86195#txn-1299527">#</a>      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;07&nbsp;18:29:06&nbsp;2013</span>
    <span class="description">jpl [...] plosquare.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jpl [...] plosquare.com</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1299527/688446/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/688446">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Nov 07 10:06:33 2013, jploski wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I just ran into this bug as well, long subject with non-ASCII
&gt; characters delivered as gibberish.
&gt; 
&gt; Please consider applying the attached two-line patch to print_hdr
&gt; instead. The extra parameter for encode_qp which prevents it from
&gt; outputting line breaks has been in MIME::QuotedPrintable since 2009
&gt; &#40;so it should be backward-compatible enough&#41;.
</div>
I noticed another problem - some &#40;older?&#41; versions of Outlook seem to adhere strictly to RFC2047, which calls for maximum length of 75 characters for an encoded-word. In such versions the subject would appear garbled and be displayed to recipient in its raw form, whereas other mail clients &#40;mutt, Seamonkey&#41; would present it correctly.

To deal with this I updated the patch so that individual input words rather than the entire header are encoded &#40;it&#39;s still not perfect - a very long input word with special characters would cause problems&#41;.

Also of interest might be Email::MIME::RFC2047::Encoder, but I abandoned it after quick tests, as it seemed to double-encode umlaut characters for me and I didn&#39;t wish another dependency.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> print_hdr_qp_encoding.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1299527/688447/print_hdr_qp_encoding.patch">Download print_hdr_qp_encoding.patch</a><br />
<span class="downloadcontenttype">text/x-diff 577b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- orig/Mail-Sender-0.8.22/Sender.pm	2013-12-08 00:18:57.686853067 +0100
+++ new/Mail-Sender-0.8.22/Sender.pm	2013-12-08 00:19:54.046353555 +0100
@@ -178,11 +178,11 @@
 
 	if &#40;$charset &#38;&#38; $str =~ /[^[:ascii:]]/&#41; {
 		$str = encode&#40; $charset, $str&#41;;
-		my @parts = split /&#40;\s*[,;&lt;&gt;]\s*&#41;/, $str;
+		my @parts = split /&#40;\s*[,;&lt;&gt; ]\s*&#41;/, $str;
 		for &#40;@parts&#41; {
 			next unless /[^[:ascii:]]/;
-			$_ = encode_qp&#40;$_&#41;;
-			s/=\r?\n$//;
+			$_ = encode_qp&#40;$_, &#39;&#39;&#41;;
+			#s/=\r?\n$//;
 			s/&#40;\s&#41;/&#39;=&#39; . sprintf &#39;%x&#39;,ord&#40;$1&#41;/ge;
 			$_ = &#34;=?$charset?Q?&#34; . $_ . &#34;?=&#34;;
 		}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1300037" href="/Public/Bug/Display.html?id=86195#txn-1300037">#</a>      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;09&nbsp;11:48:53&nbsp;2013</span>
    <span class="description">jpl [...] plosquare.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jpl [...] plosquare.com</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1300037/688734/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/688734">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Next try: the one-character fix in last patch turned out insufficient, as it caused two consecutive encoded-words to appear concatenated when the header was displayed in mail client &#40;the whitespace bewtween encoded-words apparently doesn&#39;t count&#41;. So I fixed the patch to include following whitespace into the encoded-word. Also added encoding for \n, \r and \t characters &#40;they are matched by [:ascii:], but may not appear literally in a header.

Obviously, it&#39;s still just dirty hacks rather than a clean RFC2047-compliant version. Even so, it works better than the original, so I&#39;d apply it in new releases &#40;with some comments for KNOWN BUGS&#41;.

On Sat Dec 07 18:29:06 2013, jploski wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Nov 07 10:06:33 2013, jploski wrote:
<div class="message-stanza open">&gt; &gt; I just ran into this bug as well, long subject with non-ASCII
&gt; &gt; characters delivered as gibberish.
&gt; &gt;
&gt; &gt; Please consider applying the attached two-line patch to print_hdr
&gt; &gt; instead. The extra parameter for encode_qp which prevents it from
&gt; &gt; outputting line breaks has been in MIME::QuotedPrintable since 2009
&gt; &gt; &#40;so it should be backward-compatible enough&#41;.
</div>&gt; 
&gt; I noticed another problem - some &#40;older?&#41; versions of Outlook seem to
&gt; adhere strictly to RFC2047, which calls for maximum length of 75
&gt; characters for an encoded-word. In such versions the subject would
&gt; appear garbled and be displayed to recipient in its raw form, whereas
&gt; other mail clients &#40;mutt, Seamonkey&#41; would present it correctly.
&gt; 
&gt; To deal with this I updated the patch so that individual input words
&gt; rather than the entire header are encoded &#40;it&#39;s still not perfect - a
&gt; very long input word with special characters would cause problems&#41;.
&gt; 
&gt; Also of interest might be Email::MIME::RFC2047::Encoder, but I
&gt; abandoned it after quick tests, as it seemed to double-encode umlaut
&gt; characters for me and I didn&#39;t wish another dependency.
</div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> print_hdr_qp_encoding.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1300037/688735/print_hdr_qp_encoding.patch">Download print_hdr_qp_encoding.patch</a><br />
<span class="downloadcontenttype">text/x-diff 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- orig/Mail-Sender-0.8.22/Sender.pm	2012-12-12 18:29:40.000000000 +0100
+++ new/Mail-Sender-0.8.22/Sender.pm	2013-12-09 16:53:29.842935378 +0100
@@ -178,15 +178,20 @@
 
 	if &#40;$charset &#38;&#38; $str =~ /[^[:ascii:]]/&#41; {
 		$str = encode&#40; $charset, $str&#41;;
-		my @parts = split /&#40;\s*[,;&lt;&gt;]\s*&#41;/, $str;
-		for &#40;@parts&#41; {
-			next unless /[^[:ascii:]]/;
-			$_ = encode_qp&#40;$_&#41;;
-			s/=\r?\n$//;
-			s/&#40;\s&#41;/&#39;=&#39; . sprintf &#39;%x&#39;,ord&#40;$1&#41;/ge;
-			$_ = &#34;=?$charset?Q?&#34; . $_ . &#34;?=&#34;;
+		my @parts = split /&#40;\s*[,;&lt;&gt; ]\s*&#41;/, $str;
+		$str = &#39;&#39;;
+		for &#40;my $i = 0; $i &lt; @parts; $i++&#41; {
+		    my $part = $parts[$i];
+		    $part .= $parts[++$i] if &#40;$i &lt; $#parts &#38;&#38; $parts[$i+1] =~ /^\s+$/&#41;;
+			if &#40;$part =~ /[^[:ascii:]]/ || $part =~ /[\r\n\t]/&#41; {
+			    $part = encode_qp&#40;$part, &#39;&#39;&#41;;
+			    $part =~ s/&#40;[\s\?]&#41;/&#39;=&#39; . sprintf &#39;%02x&#39;,ord&#40;$1&#41;/ge;
+			    $str .= &#34;=?$charset?Q?$part?=&#34;;
+			}
+			else {
+			    $str .= $part;
+			}
 		}
-		$str = join &#39;&#39;, @parts;
 	}
 
 	$str =~ s/&#40;?:\x0D\x0A?|\x0A&#41;/\x0D\x0A/sg; # \n or \r =&gt; \r\n
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1387261" href="/Public/Bug/Display.html?id=86195#txn-1387261">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;15&nbsp;14:57:06&nbsp;2014</span>
    <span class="description">JENDA [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1387261/736699/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/736699">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 96b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I used the patch from the last message, it seems to work fine for me. Thanks!

Patched in 0.8.23
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1387263" href="/Public/Bug/Display.html?id=86195#txn-1387263">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;15&nbsp;14:57:07&nbsp;2014</span>
    <span class="description">JENDA [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.498134</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
