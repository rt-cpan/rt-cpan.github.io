<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #76676 for IO-Async: Channel improvemements - longrunning on_recv; sync-to-sync</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #76676 for IO-Async: Channel improvemements - longrunning on_recv; sync-to-sync</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=IO-Async">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=IO-Async">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=IO-Async">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=IO-Async">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/IO-Async">IO-Async CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">76676</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=IO-Async">IO-Async</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
leonerd-cpan [...] leonerd.org.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
cpan [...] prather.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-42614-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.47    </td>
  </tr>
  <tr id="CF-42615-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.48    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




rt76676-1.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1069298/562344/rt76676-1.patch">
Wed Apr 18 19:19:34 2012 (3.6k) by leonerd-cpan [...] leonerd.org.uk
</a>
</font></li>
</ul>


rt76676-2.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1071581/563722/rt76676-2.patch">
Wed Apr 25 19:00:53 2012 (9.6k) by leonerd-cpan [...] leonerd.org.uk
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=76676">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1069217" href="/Public/Bug/Display.html?id=76676#txn-1069217">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;18&nbsp;17:41:44&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Channel improvemements - longrunning on_recv; sync-to-sync</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1069217/562283/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/562283">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 332b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Two features:

1&#41; Allow setting up a longrunning on_recv for a Channel, rather than the 
   oneshot of the -&gt;recv method. E.g. 

   $ch-&gt;configure&#40;
      on_recv =&gt; sub { ... }
   &#41;;

2&#41; Allow passing both ends of a Channel to two different Routines, thus 
   making a synchronous channel to pass data between them.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1069219" href="/Public/Bug/Display.html?id=76676#txn-1069219">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;18&nbsp;17:45:14&nbsp;2012</span>
    <span class="description">cpan [...] prather.org -  Cc PERIGRIN added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1069298" href="/Public/Bug/Display.html?id=76676#txn-1069298">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;18&nbsp;19:19:33&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1069298/562343/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/562343">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 325b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Apr 18 17:41:44 2012, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 1&#41; Allow setting up a longrunning on_recv for a Channel, rather than the 
&gt;    oneshot of the -&gt;recv method. E.g. 
&gt; 
&gt;    $ch-&gt;configure&#40;
&gt;       on_recv =&gt; sub { ... }
&gt;    &#41;;
</div>
Attached is a patch for this.

The other is harder; I&#39;ll take a look tomorrow maybe.

-- 

Paul Evans
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rt76676-1.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1069298/562344/rt76676-1.patch">Download rt76676-1.patch</a><br />
<span class="downloadcontenttype">text/x-diff 3.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">=== modified file &#39;lib/IO/Async/Channel.pm&#39;
--- lib/IO/Async/Channel.pm	2012-03-24 21:08:34 +0000
+++ lib/IO/Async/Channel.pm	2012-04-18 23:05:18 +0000
@@ -59,8 +59,8 @@
 
 While this object does in fact inherit from L&lt;IO::Async::Notifier&gt; for
 implementation reasons it is not intended that this object be used as a
-Notifier. The C&lt;configure&gt; method should not be called, and it should not be
-added to a Loop object.
+Notifier. It should not be added to a Loop object directly; event management
+will be handled by its containing C&lt;IO::Async::Routine&gt; object.
 
 =cut
 
@@ -76,6 +76,39 @@
 
 =cut
 
+=head2 $channel-&gt;configure&#40; %params &#41;
+
+Similar to the standard C&lt;configure&gt; method on C&lt;IO::Async::Notifier&gt;, this is
+used to change details of the Channel&#39;s operation.
+
+=over 4
+
+=item on_recv =&gt; CODE
+
+May only be set on an async mode channel. If present, will be invoked whenever
+a new value is received, rather than using the C&lt;recv&gt; method.
+
+ $on_recv-&gt;&#40; $channel, $data &#41;
+
+=back
+
+=cut
+
+sub configure
+{
+   my $self = shift;
+   my %params = @_;
+
+   if&#40; exists $params{on_recv} &#41; {
+      $self-&gt;{mode} and $self-&gt;{mode} eq &#34;async&#34; or
+         croak &#34;Can only configure on_recv in async mode&#34;;
+
+      $self-&gt;{on_recv} = delete $params{on_recv};
+   }
+
+   $self-&gt;SUPER::configure&#40; %params &#41;;
+}
+
 =head2 $channel-&gt;send&#40; $data &#41;
 
 Pushes the data stored in the given Perl reference into the FIFO of the
@@ -245,24 +278,12 @@
       $self-&gt;{on_recv} = $on_recv;
       $self-&gt;{on_eof} = delete $args{on_eof};
    }
-   else {
-      $self-&gt;{on_result_queue} = \my @on_result_queue;
-      $self-&gt;{on_recv} = sub {
-         my &#40; $self, $result &#41; = @_;
-         &#40;shift @on_result_queue&#41;-&gt;&#40; $self, recv =&gt; $result &#41;;
-      };
-      $self-&gt;{on_eof} = sub {
-         my &#40; $self &#41; = @_;
-         while&#40; @on_result_queue &#41; {
-            &#40;shift @on_result_queue&#41;-&gt;&#40; $self, eof =&gt; &#41;;
-         }
-      };
-   }
 
    keys %args and croak &#34;Unrecognised keys for setup_async_mode: &#34; . join&#40; &#34;, &#34;, keys %args &#41;;
 
    $self-&gt;{stream} = $stream;
    $self-&gt;{mode} = &#34;async&#34;;
+   $self-&gt;{on_result_queue} = [];
 
    $stream-&gt;configure&#40;
       autoflush =&gt; 1,
@@ -307,7 +328,10 @@
    my &#40; $stream, $buffref, $eof &#41; = @_;
 
    if&#40; $eof &#41; {
-      $self-&gt;{on_eof}-&gt;&#40; $self &#41;;
+      while&#40; my $on_result = shift @{ $self-&gt;{on_result_queue} } &#41; {
+         $on_result-&gt;&#40; $self, eof =&gt; &#41;;
+      }
+      $self-&gt;{on_eof}-&gt;&#40; $self &#41; if $self-&gt;{on_eof};
       return;
    }
 
@@ -318,7 +342,12 @@
    my $record = thaw&#40; substr&#40; $$buffref, 4, $len &#41; &#41;;
    substr&#40; $$buffref, 0, 4 + $len &#41; = &#34;&#34;;
 
-   $self-&gt;{on_recv}-&gt;&#40; $self, $record &#41;;
+   if&#40; my $on_result = shift @{ $self-&gt;{on_result_queue} } &#41; {
+      $on_result-&gt;&#40; $self, recv =&gt; $record &#41;;
+   }
+   else {
+      $self-&gt;{on_recv}-&gt;&#40; $self, $record &#41;;
+   }
 
    return 1;
 }

=== modified file &#39;t/40channel.t&#39;
--- t/40channel.t	2012-02-14 22:24:38 +0000
+++ t/40channel.t	2012-04-18 23:05:18 +0000
@@ -4,7 +4,7 @@
 
 use IO::Async::Test;
 
-use Test::More tests =&gt; 11;
+use Test::More tests =&gt; 12;
 use Test::Identity;
 
 use IO::Async::Channel;
@@ -133,6 +133,22 @@
 
    is_deeply&#40; $recved, [ data =&gt; &#34;by sync&#34; ], &#39;Async mode channel can -&gt;recv on_recv&#39; &#41;;
 
+   my @recv_queue;
+   $channel_rd-&gt;configure&#40;
+      on_recv =&gt; sub { push @recv_queue, $_[1] }
+   &#41;;
+
+   undef $recved;
+
+   $channel_wr-&gt;send&#40; [ first  =&gt; &#34;thing&#34; ] &#41;;
+   $channel_wr-&gt;send&#40; [ second =&gt; &#34;thing&#34; ] &#41;;
+
+   wait_for { @recv_queue &gt;= 2 };
+
+   is_deeply&#40; \@recv_queue,
+              [ [ first =&gt; &#34;thing&#34; ], [ second =&gt; &#34;thing&#34; ] ],
+              &#39;Async mode channel can receive with -&gt;configure on_recv&#39; &#41;;
+
    $channel_wr-&gt;close;
 
    my $recv_eof;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1069300" href="/Public/Bug/Display.html?id=76676#txn-1069300">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;18&nbsp;19:19:34&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1071530" href="/Public/Bug/Display.html?id=76676#txn-1071530">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;25&nbsp;16:03:52&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1071530/563689/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/563689">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 549b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Apr 18 17:41:44 2012, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2&#41; Allow passing both ends of a Channel to two different Routines, 
</div>thus 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;    making a synchronous channel to pass data between them.
</div>
This part is proving to be non-trivial, on part of tearing down the 
async-mode end of the channel inbetween.

I wonder if it might be easier to add two new keys, channels_src and 
channels_sink, that configure the in-routine side of a channel but don&#39;t 
configure the main process side. That would allow two routines to share 
a channel quite easily.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1071581" href="/Public/Bug/Display.html?id=76676#txn-1071581">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;25&nbsp;19:00:53&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1071581/563721/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/563721">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 217b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Actually, via some cunning trickery and being lazy, this works too.

Find attached a patch to implement sync-&gt;sync mode sharing of Channel
between two Routines. It requires the previous patch as well.

-- 

Paul Evans
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rt76676-2.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1071581/563722/rt76676-2.patch">Download rt76676-2.patch</a><br />
<span class="downloadcontenttype">text/x-diff 9.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">=== modified file &#39;lib/IO/Async/Channel.pm&#39;
--- lib/IO/Async/Channel.pm	2012-04-18 23:16:23 +0000
+++ lib/IO/Async/Channel.pm	2012-04-25 22:58:35 +0000
@@ -14,6 +14,8 @@
 use Carp;
 use Storable qw&#40; freeze thaw &#41;;
 
+use IO::Async::Stream;
+
 =head1 NAME
 
 C&lt;IO::Async::Channel&gt; - pass values into or out from an L&lt;IO::Async::Routine&gt;
@@ -31,7 +33,9 @@
 mode. In asynchronous mode all methods return immediately and use
 C&lt;IO::Async&gt;-style callback functions. In synchronous within the Routine
 process the methods block until they are ready and may be used for
-flow-control within the routine.
+flow-control within the routine. Alternatively, a Channel may be shared
+between two different Routine objects, and not used directly by the
+controlling program.
 
 The channel itself represents a FIFO of Perl reference values. New values may
 be put into the channel by the C&lt;send&gt; method in either mode. Values may be
@@ -68,7 +72,7 @@
 {
    my $class = shift;
    return bless {
-      mode =&gt; undef,
+      mode =&gt; &#34;&#34;,
    }, $class;
 }
 
@@ -90,6 +94,13 @@
 
  $on_recv-&gt;&#40; $channel, $data &#41;
 
+=item on_eof =&gt; CODE
+
+May only be set on an async mode channel. If present, will be invoked when the
+channel gets closed by the peer.
+
+ $on_eof-&gt;&#40; $channel &#41;
+
 =back
 
 =cut
@@ -99,11 +110,13 @@
    my $self = shift;
    my %params = @_;
 
-   if&#40; exists $params{on_recv} &#41; {
+   foreach &#40;qw&#40; on_recv on_eof &#41;&#41; {
+      next unless exists $params{$_};
       $self-&gt;{mode} and $self-&gt;{mode} eq &#34;async&#34; or
-         croak &#34;Can only configure on_recv in async mode&#34;;
+         croak &#34;Can only configure $_ in async mode&#34;;
 
-      $self-&gt;{on_recv} = delete $params{on_recv};
+      $self-&gt;{$_} = delete $params{$_};
+      $self-&gt;_build_stream;
    }
 
    $self-&gt;SUPER::configure&#40; %params &#41;;
@@ -272,30 +285,37 @@
    my $self = shift;
    my %args = @_;
 
-   my $stream = delete $args{stream} or croak &#34;Expected &#39;stream&#39;&#34;;
-
-   if&#40; my $on_recv = delete $args{on_recv} &#41; {
-      $self-&gt;{on_recv} = $on_recv;
-      $self-&gt;{on_eof} = delete $args{on_eof};
-   }
+   exists $args{$_} and $self-&gt;{$_} = delete $args{$_} for qw&#40; read_handle write_handle &#41;;
 
    keys %args and croak &#34;Unrecognised keys for setup_async_mode: &#34; . join&#40; &#34;, &#34;, keys %args &#41;;
 
-   $self-&gt;{stream} = $stream;
    $self-&gt;{mode} = &#34;async&#34;;
-   $self-&gt;{on_result_queue} = [];
-
-   $stream-&gt;configure&#40;
-      autoflush =&gt; 1,
-      on_read   =&gt; $self-&gt;_capture_weakself&#40; &#39;_on_stream_read&#39; &#41;
-   &#41;;
+}
+
+sub _build_stream
+{
+   my $self = shift;
+   return $self-&gt;{stream} ||= do {
+      $self-&gt;{on_result_queue} = [];
+
+      my $stream = IO::Async::Stream-&gt;new&#40;
+         read_handle  =&gt; $self-&gt;{read_handle},
+         write_handle =&gt; $self-&gt;{write_handle},
+         autoflush    =&gt; 1,
+         on_read      =&gt; $self-&gt;_capture_weakself&#40; &#39;_on_stream_read&#39; &#41;
+      &#41;;
+
+      $self-&gt;add_child&#40; $stream &#41;;
+
+      $stream;
+   };
 }
 
 sub _send_async
 {
    my $self = shift;
    my &#40; $bytes &#41; = @_;
-   $self-&gt;{stream}-&gt;write&#40; $bytes &#41;;
+   $self-&gt;_build_stream-&gt;write&#40; $bytes &#41;;
 }
 
 sub _recv_async
@@ -305,6 +325,8 @@
    my $on_recv = $args{on_recv};
    my $on_eof  = $args{on_eof};
 
+   $self-&gt;_build_stream;
+
    push @{ $self-&gt;{on_result_queue} }, sub {
       my &#40; $self, $type, $result &#41; = @_;
       if&#40; $type eq &#34;recv&#34; &#41; {
@@ -352,6 +374,30 @@
    return 1;
 }
 
+sub _extract_read_handle
+{
+   my $self = shift;
+
+   return undef if !$self-&gt;{mode};
+
+   croak &#34;Cannot extract filehandle&#34; if $self-&gt;{mode} ne &#34;async&#34;;
+   $self-&gt;{mode} = &#34;dead&#34;;
+
+   return $self-&gt;{read_handle};
+}
+
+sub _extract_write_handle
+{
+   my $self = shift;
+
+   return undef if !$self-&gt;{mode};
+
+   croak &#34;Cannot extract filehandle&#34; if $self-&gt;{mode} ne &#34;async&#34;;
+   $self-&gt;{mode} = &#34;dead&#34;;
+
+   return $self-&gt;{write_handle};
+}
+
 =head1 AUTHOR
 
 Paul Evans &lt;leonerd@leonerd.org.uk&gt;

=== modified file &#39;lib/IO/Async/Routine.pm&#39;
--- lib/IO/Async/Routine.pm	2012-04-12 15:40:20 +0000
+++ lib/IO/Async/Routine.pm	2012-04-25 22:58:35 +0000
@@ -12,8 +12,6 @@
 
 use base qw&#40; IO::Async::Process &#41;;
 
-use IO::Async::Stream;
-
 =head1 NAME
 
 C&lt;IO::Async::Routine&gt; - execute code in an independent sub-process
@@ -130,13 +128,19 @@
    my @channels_out;
 
    foreach my $ch &#40; @{ $self-&gt;{channels_in} || [] } &#41; {
-      my &#40; $rd, $wr &#41; = $loop-&gt;pipepair;
+      my &#40; $rd, $wr &#41;;
+      unless&#40; $rd = $ch-&gt;_extract_read_handle &#41; {
+         &#40; $rd, $wr &#41; = $loop-&gt;pipepair;
+      }
       push @setup, $rd =&gt; &#34;keep&#34;;
       push @channels_in, [ $ch, $wr, $rd ];
    }
 
    foreach my $ch &#40; @{ $self-&gt;{channels_out} || [] } &#41; {
-      my &#40; $rd, $wr &#41; = $loop-&gt;pipepair;
+      my &#40; $rd, $wr &#41;;
+      unless&#40; $wr = $ch-&gt;_extract_write_handle &#41; {
+         &#40; $rd, $wr &#41; = $loop-&gt;pipepair;
+      }
       push @setup, $wr =&gt; &#34;keep&#34;;
       push @channels_out, [ $ch, $rd, $wr ];
    }
@@ -173,19 +177,17 @@
    foreach &#40; @channels_in &#41; {
       my &#40; $ch, $wr &#41; = @$_;
 
-      my $stream = IO::Async::Stream-&gt;new&#40; write_handle =&gt; $wr &#41;;
-      $ch-&gt;setup_async_mode&#40; stream =&gt; $stream &#41;;
+      $ch-&gt;setup_async_mode&#40; write_handle =&gt; $wr &#41;;
 
-      $self-&gt;add_child&#40; $stream &#41;;
+      $self-&gt;add_child&#40; $ch &#41; unless $ch-&gt;parent;
    }
 
    foreach &#40; @channels_out &#41; {
       my &#40; $ch, $rd &#41; = @$_;
 
-      my $stream = IO::Async::Stream-&gt;new&#40; read_handle =&gt; $rd &#41;;
-      $ch-&gt;setup_async_mode&#40; stream =&gt; $stream &#41;;
+      $ch-&gt;setup_async_mode&#40; read_handle =&gt; $rd &#41;;
 
-      $self-&gt;add_child&#40; $stream &#41;;
+      $self-&gt;add_child&#40; $ch &#41; unless $ch-&gt;parent;
    }
 
    $self-&gt;SUPER::_add_to_loop&#40; $loop &#41;;

=== modified file &#39;t/40channel.t&#39;
--- t/40channel.t	2012-04-18 23:16:23 +0000
+++ t/40channel.t	2012-04-25 22:58:35 +0000
@@ -4,12 +4,11 @@
 
 use IO::Async::Test;
 
-use Test::More tests =&gt; 12;
+use Test::More tests =&gt; 11;
 use Test::Identity;
 
 use IO::Async::Channel;
 
-use IO::Async::Stream;
 use IO::Async::Loop::Poll;
 use Storable qw&#40; freeze &#41;;
 
@@ -48,17 +47,15 @@
    $channel_rd-&gt;setup_sync_mode&#40; $pipe_rd &#41;;
 
    my $channel_wr = IO::Async::Channel-&gt;new;
-   $channel_wr-&gt;setup_async_mode&#40;
-      stream =&gt; my $stream_wr = IO::Async::Stream-&gt;new&#40; write_handle =&gt; $pipe_wr &#41;,
-   &#41;;
+   $channel_wr-&gt;setup_async_mode&#40; write_handle =&gt; $pipe_wr &#41;;
 
-   $loop-&gt;add&#40; $stream_wr &#41;;
+   $loop-&gt;add&#40; $channel_wr &#41;;
 
    $channel_wr-&gt;send&#40; [ data =&gt; &#34;by async&#34; ] &#41;;
 
    # Cheat for semi-sync
    my $flushed;
-   $stream_wr-&gt;write&#40; &#34;&#34;, on_flush =&gt; sub { $flushed++ } &#41;;
+   $channel_wr-&gt;{stream}-&gt;write&#40; &#34;&#34;, on_flush =&gt; sub { $flushed++ } &#41;;
    wait_for { $flushed };
 
    is_deeply&#40; $channel_rd-&gt;recv, [ data =&gt; &#34;by async&#34; ], &#39;Async mode channel can send&#39; &#41;;
@@ -68,7 +65,7 @@
    is&#40; $channel_rd-&gt;recv, undef, &#39;Sync mode can be closed&#39; &#41;;
 }
 
-# sync-&gt;async
+# sync-&gt;async configured on_recv
 {
    my &#40; $pipe_rd, $pipe_wr &#41; = $loop-&gt;pipepair;
 
@@ -76,8 +73,11 @@
    my $recv_eof;
 
    my $channel_rd = IO::Async::Channel-&gt;new;
-   $channel_rd-&gt;setup_async_mode&#40;
-      stream =&gt; my $stream_rd = IO::Async::Stream-&gt;new&#40; read_handle =&gt; $pipe_rd &#41;,
+   $channel_rd-&gt;setup_async_mode&#40; read_handle =&gt; $pipe_rd &#41;;
+
+   $loop-&gt;add&#40; $channel_rd &#41;;
+
+   $channel_rd-&gt;configure&#40;
       on_recv =&gt; sub {
          identical&#40; $_[0], $channel_rd, &#39;Channel passed to on_recv&#39; &#41;;
          push @recv_queue, $_[1];
@@ -87,8 +87,6 @@
       },
    &#41;;
 
-   $loop-&gt;add&#40; $stream_rd &#41;;
-
    my $channel_wr = IO::Async::Channel-&gt;new;
    $channel_wr-&gt;setup_sync_mode&#40; $pipe_wr &#41;;
 
@@ -104,16 +102,14 @@
    is&#40; $recv_eof, 1, &#39;Async mode channel can on_eof&#39; &#41;;
 }
 
-# sync-&gt;async late -&gt;recv
+# sync-&gt;async oneshot -&gt;recv
 {
    my &#40; $pipe_rd, $pipe_wr &#41; = $loop-&gt;pipepair;
 
    my $channel_rd = IO::Async::Channel-&gt;new;
-   $channel_rd-&gt;setup_async_mode&#40;
-      stream =&gt; my $stream_rd = IO::Async::Stream-&gt;new&#40; read_handle =&gt; $pipe_rd &#41;,
-   &#41;;
+   $channel_rd-&gt;setup_async_mode&#40; read_handle =&gt; $pipe_rd &#41;;
 
-   $loop-&gt;add&#40; $stream_rd &#41;;
+   $loop-&gt;add&#40; $channel_rd &#41;;
 
    my $channel_wr = IO::Async::Channel-&gt;new;
    $channel_wr-&gt;setup_sync_mode&#40; $pipe_wr &#41;;
@@ -133,22 +129,6 @@
 
    is_deeply&#40; $recved, [ data =&gt; &#34;by sync&#34; ], &#39;Async mode channel can -&gt;recv on_recv&#39; &#41;;
 
-   my @recv_queue;
-   $channel_rd-&gt;configure&#40;
-      on_recv =&gt; sub { push @recv_queue, $_[1] }
-   &#41;;
-
-   undef $recved;
-
-   $channel_wr-&gt;send&#40; [ first  =&gt; &#34;thing&#34; ] &#41;;
-   $channel_wr-&gt;send&#40; [ second =&gt; &#34;thing&#34; ] &#41;;
-
-   wait_for { @recv_queue &gt;= 2 };
-
-   is_deeply&#40; \@recv_queue,
-              [ [ first =&gt; &#34;thing&#34; ], [ second =&gt; &#34;thing&#34; ] ],
-              &#39;Async mode channel can receive with -&gt;configure on_recv&#39; &#41;;
-
    $channel_wr-&gt;close;
 
    my $recv_eof;

=== modified file &#39;t/41routine.t&#39;
--- t/41routine.t	2012-02-21 21:53:57 +0000
+++ t/41routine.t	2012-04-25 22:58:35 +0000
@@ -4,7 +4,7 @@
 
 use IO::Async::Test;
 
-use Test::More tests =&gt; 11;
+use Test::More tests =&gt; 12;
 use Test::Identity;
 use Test::Refcount;
 
@@ -127,3 +127,35 @@
    identical&#40; $finishargs[0], $routine, &#39;on_finish passed self&#39; &#41;;
    is&#40; $finishargs[1], 0, &#39;on_finish passed exit code&#39; &#41;;
 }
+
+{
+   my $channel = IO::Async::Channel-&gt;new;
+
+   my $src_finished;
+   my $src_routine = IO::Async::Routine-&gt;new&#40;
+      channels_out =&gt; [ $channel ],
+      code =&gt; sub {
+         $channel-&gt;send&#40; [ some =&gt; &#34;data&#34; ] &#41;;
+         return 0;
+      },
+      on_finish =&gt; sub { $src_finished++ },
+   &#41;;
+
+   $loop-&gt;add&#40; $src_routine &#41;;
+
+   my $sink_result;
+   my $sink_routine = IO::Async::Routine-&gt;new&#40;
+      channels_in =&gt; [ $channel ],
+      code =&gt; sub {
+         my @data = @{ $channel-&gt;recv };
+         return &#40; $data[0] eq &#34;some&#34; and $data[1] eq &#34;data&#34; &#41; ? 0 : 1;
+      },
+      on_finish =&gt; sub { $sink_result = $_[1] },
+   &#41;;
+
+   $loop-&gt;add&#40; $sink_routine &#41;;
+
+   wait_for { $src_finished and defined $sink_result };
+
+   is&#40; $sink_result, 0, &#39;synchronous src-&gt;sink can share a channel&#39; &#41;;
+}

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1071583" href="/Public/Bug/Display.html?id=76676#txn-1071583">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;25&nbsp;19:01:04&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1079635" href="/Public/Bug/Display.html?id=76676#txn-1079635">#</a>      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;20&nbsp;07:23:27&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1079635/568154/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/568154">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 33b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Released in 0.48

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1079637" href="/Public/Bug/Display.html?id=76676#txn-1079637">#</a>      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;20&nbsp;07:23:28&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1079638" href="/Public/Bug/Display.html?id=76676#txn-1079638">#</a>      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;20&nbsp;07:23:29&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1079639" href="/Public/Bug/Display.html?id=76676#txn-1079639">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;May&nbsp;20&nbsp;07:23:49&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Fixed in 0.48 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.576252</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
