<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #76269 for DBD-Oracle: TAF with DBD:Oracle - no way to stop retrying reconnects?</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #76269 for DBD-Oracle: TAF with DBD:Oracle - no way to stop retrying reconnects?</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=DBD-Oracle">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=DBD-Oracle">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=DBD-Oracle">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=DBD-Oracle">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/pythian/DBD-Oracle/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-Oracle">DBD-Oracle CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">76269</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=DBD-Oracle">DBD-Oracle</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
norbert.debes [...] oradbpro.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10192-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10193-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.45_00    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




norbert_debes.vcf<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1070884/563335/norbert_debes.vcf">
Mon Apr 23 11:52:05 2012 (343b) by norbert.debes [...] oradbpro.com
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1070775/563274/norbert_debes.vcf">
Mon Apr 23 09:25:06 2012 (343b) by norbert.debes [...] oradbpro.com
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1070766/563267/norbert_debes.vcf">
Mon Apr 23 09:19:52 2012 (343b) by norbert.debes [...] oradbpro.com
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1070528/563132/norbert_debes.vcf">
Sun Apr 22 10:38:25 2012 (343b) by norbert.debes [...] oradbpro.com
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1058255/553693/norbert_debes.vcf">
Tue Apr 03 08:36:19 2012 (343b) by norbert.debes [...] oradbpro.com
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1058241/553680/norbert_debes.vcf">
Tue Apr 03 06:51:12 2012 (331b) by norbert.debes [...] oradbpro.com
</a>
</font></li>
</ul>


taf.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1058241/553679/taf.pl">
Tue Apr 03 06:51:12 2012 (4.1k) by norbert.debes [...] oradbpro.com
</a>
</font></li>
</ul>


x.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1070553/563148/x.patch">
Sun Apr 22 11:41:45 2012 (2.4k) by bohica [...] ntlworld.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=76269">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1058241" href="/Public/Bug/Display.html?id=76269#txn-1058241">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;03&nbsp;06:51:12&nbsp;2012</span>
    <span class="description">norbert.debes [...] oradbpro.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> TAF with DBD:Oracle - no way to stop retrying reconnects?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 03 Apr 2012 12:50:08 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;DBD:&#34; [...] relay01.alfahosting-server.de:Oracle Bug &lt;bug-DBD-Oracle [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Norbert Debes &lt;norbert.debes [...] oradbpro.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1058241/553677/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/553677">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi DBD:Oracle team,

I have run some tests with TAF in DBD::Oracle with a TAF callback 
handler. What I&#39;m missing is some feature to limit the number of 
reconnection retries. The program retries forever, no matter what the 
return code of the TAF callback is.

It looks like there should be an additional parameter*taf_retries* that 
limits the number of reconnect attempts. According to OracleÂ® Database
PL/SQL Packages and Types Reference
11g Release 2 &#40;11.2&#41;
E10577-05
December 2009:

If a TAF callback has been registered, then the failover retries and 
failover delay
are ignored. If an error occurs, TAF will continue to re-attempt the 
connect and
authentication as long as the callback returns a value of OCI_FO_RETRY. Any
delay should be coded into the callback logic.

So the RETRIES set for the service on the server-side using DBMS_SERVICE 
are ignored.

Another problem: the value 15 that I passed for taf_sleep is ignored. 
Instead a 5 second sleep is always used.

By the way the example TAF handler provided in the DBD::Oracle doc did 
not work for me. I had to change

ora_taf_function=&gt;&#39;handle_taf&#39;
to
ora_taf_function=&gt;&#39;main::handle_taf&#39;

Does this reproduce in other environments?

Could it be that the return value from the TAF handler is ignored? It should be possible to return a value that stops any further
reconnect attempts. Unfortunately even the OracleÂ® Call Interface
Programmer&#39;s Guide
11g Release 2 &#40;11.2&#41;
E10646-04
does not say what value to return in order to stop reconnect attempts &#40;or I could not find the information&#41;.

I&#39;ll attach the source file that I used.

I tested with this service that has server-side TAF settings &#40;such that EZConnect can be used on the client-side&#41;:

begin
        dbms_service.create_service&#40;
                SERVICE_NAME =&gt;  &#39;PLMON&#39;,
                NETWORK_NAME =&gt;  &#39;PLMON&#39;,
                FAILOVER_METHOD =&gt;  &#39;BASIC&#39;,
                FAILOVER_TYPE =&gt;  &#39;SESSION&#39;,
                FAILOVER_RETRIES =&gt;  1440,
                FAILOVER_DELAY =&gt;  60
        &#41;;
end;
/

exec dbms_service.start_service&#40;&#39;PLMON&#39;, dbms_service.all_instances&#41;;

begin
        dbms_service.modify_service&#40;
                SERVICE_NAME =&gt;  &#39;PLMON&#39;,
                FAILOVER_METHOD =&gt;  &#39;BASIC&#39;,
                FAILOVER_TYPE =&gt;  &#39;SESSION&#39;,
                FAILOVER_RETRIES =&gt;  4,
                FAILOVER_DELAY =&gt;  15
        &#41;;
end;
/

-- this triggers failover:
exec dbms_service.stop_service&#40;&#39;PLMON&#39;, dbms_service.all_instances&#41;;
exec dbms_service.disconnect_session&#40;&#39;PLMON&#39;, dbms_service.immediate&#41;;




PS:

E:\home\ndebes\it\perl&gt;perl taf.pl
audsid=1162169
update and commit complete
audsid=1162169
update and commit complete
  Instance Unavailable Please stand by!!
  Your TAF type is SESSION
3.4.2012 12:27:20
  Failover error - sleeping ...
  Failover aborted. Failover will not take place.
DBD::Oracle::db prepare failed: ORA-03113: end-of-file on communication channel
Process ID: 22192
Session ID: 72 Serial number: 63 &#40;DBD ERROR: OCIStmtExecute/Describe&#41; [for Statement &#34;SELECT userenv&#40;&#39;sessionid&#39;&#41; FROM dual&#34;] at taf.pl line 108.
ORA-03113: end-of-file on communication channel
Process ID: 22192
Session ID: 72 Serial number: 63 &#40;DBD ERROR: OCIStmtExecute/Describe&#41;
audsid=1162170
update and commit complete
audsid=1162170
update and commit complete
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1058241/553678/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/553678">with headers</a>
<br />
<span class="downloadcontenttype">text/html 3.6k</span>
</div>
<div class="messagebody">
</div>
</div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1058241/553679/taf.pl">Download taf.pl</a><br />
<span class="downloadcontenttype">text/x-perl 4.1k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1058241/553680/norbert_debes.vcf">Download norbert_debes.vcf</a><br />
<span class="downloadcontenttype">text/x-vcard 331b</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1058244" href="/Public/Bug/Display.html?id=76269#txn-1058244">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;03&nbsp;07:57:55&nbsp;2012</span>
    <span class="description">byterock [...] hotmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> byterock [...] hotmail.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1058244/553683/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/553683">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 468b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Just some quick notes on this.  I will look into in more detail later.

I did notice you have an &#39;update&#39; in your .pl code.  It is my 
understanding that TAF will only work with selects.  Inset delete and 
updates cannot cannot failover and restart, perhaps that is what is 
causing your greif.

A max attepmts looks like a good idea.  But you could just set this up 
in perl as well and exit out of the callback??

Any way will get some time tonight.

Cheers
John
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1058247" href="/Public/Bug/Display.html?id=76269#txn-1058247">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;03&nbsp;07:57:56&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1058255" href="/Public/Bug/Display.html?id=76269#txn-1058255">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;03&nbsp;08:36:19&nbsp;2012</span>
    <span class="description">norbert.debes [...] oradbpro.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #76269] TAF with DBD:Oracle - no way to stop retrying reconnects?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 03 Apr 2012 14:35:58 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Oracle [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Norbert Debes &lt;norbert.debes [...] oradbpro.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1058255/553692/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/553692">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 5.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi John,

TAF can - under certain circumstances and without guarantee - replay 
SELECT statements. I did not even configure that since I used 
FAILOVER_TYPE =&gt; &#39;SESSION&#39;. All I set up with DBMS_SERVICE was to 
reestablish the connection.

The problem is that the callback function runs indefinitely as long as 
the reconnect fails. It never returns control to the main program.

Testcase:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">SQL&gt; create and start a TAF enabled service using SQL*Plus and user with 
</div>role DBA:
begin
     dbms_service.create_service&#40;
         SERVICE_NAME =&gt; &#39;PLMON&#39;,
         NETWORK_NAME =&gt; &#39;PLMON&#39;,
         FAILOVER_METHOD =&gt; &#39;BASIC&#39;,
         FAILOVER_TYPE =&gt; &#39;SESSION&#39;,
         FAILOVER_RETRIES =&gt; 1440,
         FAILOVER_DELAY =&gt; 60
     &#41;;
end;
/

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">SQL&gt; exec dbms_service.start_service&#40;&#39;PLMON&#39;, dbms_service.all_instances&#41;;
</div>
Run taf.pl:

E:\home\ndebes\it\perl&gt;perl taf.pl
audsid=1162204
update and commit complete
audsid=1162204
update and commit complete
audsid=1162204
update and commit complete
audsid=1162204
update and commit complete
audsid=1162204
update and commit complete
audsid=1162204
update and commit complete
audsid=1162204
update and commit complete
audsid=1162204
update and commit complete
audsid=1162204
update and commit complete
audsid=1162204
update and commit complete
audsid=1162204
update and commit complete
audsid=1162204
update and commit complete
audsid=1162204
update and commit complete
audsid=1162204
update and commit complete
audsid=1162204
update and commit complete

shut down the service and disconnect all sessions that use it:


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">SQL&gt; exec dbms_service.stop_service&#40;&#39;PLMON&#39;, dbms_service.all_instances&#41;;
SQL&gt; exec dbms_service.disconnect_session&#40;&#39;PLMON&#39;, dbms_service.immediate&#41;;
</div>

At this point the TAF handler retries forever as long as I don&#39;t restart 
the service. That&#39;s a problem, since my program needs to return to the 
main code within 60 seconds - with or without a valid connection.

  Instance Unavailable Please stand by!!
  Your TAF type is SESSION
3.4.2012 14:25:47
  Failover error - sleeping ...
3.4.2012 14:25:52
  Failover error - sleeping ...
3.4.2012 14:25:58
  Failover error - sleeping ...
3.4.2012 14:26:03
  Failover error - sleeping ...
3.4.2012 14:26:08
  Failover error - sleeping ...
3.4.2012 14:26:13
  Failover error - sleeping ...
3.4.2012 14:26:18
  Failover error - sleeping ...
3.4.2012 14:26:23
  Failover error - sleeping ...
3.4.2012 14:26:28
  Failover error - sleeping ...
3.4.2012 14:26:33
  Failover error - sleeping ...
3.4.2012 14:26:38
  Failover error - sleeping ...
3.4.2012 14:26:43
  Failover error - sleeping ...
3.4.2012 14:26:49
  Failover error - sleeping ...
3.4.2012 14:26:54
  Failover error - sleeping ...
3.4.2012 14:26:59
  Failover error - sleeping ...
3.4.2012 14:27:04
  Failover error - sleeping ...
3.4.2012 14:27:09
  Failover error - sleeping ...
3.4.2012 14:27:14
  Failover error - sleeping ...
3.4.2012 14:27:19
  Failover error - sleeping ...
3.4.2012 14:27:24
  Failover error - sleeping ...
3.4.2012 14:27:29
  Failover error - sleeping ...
3.4.2012 14:27:34
  Failover error - sleeping ...
3.4.2012 14:27:39
  Failover error - sleeping ...
3.4.2012 14:27:44
  Failover error - sleeping ...
3.4.2012 14:27:49
  Failover error - sleeping ...
3.4.2012 14:27:55
  Failover error - sleeping ...
3.4.2012 14:28:00
  Failover error - sleeping ...
3.4.2012 14:28:05
  Failover error - sleeping ...
3.4.2012 14:28:10
  Failover error - sleeping ...
3.4.2012 14:28:15
  Failover error - sleeping ...
3.4.2012 14:28:20
  Failover error - sleeping ...
3.4.2012 14:28:25
  Failover error - sleeping ...
3.4.2012 14:28:30
  Failover error - sleeping ...
3.4.2012 14:28:35
  Failover error - sleeping ...
3.4.2012 14:28:40
  Failover error - sleeping ...
3.4.2012 14:28:45
  Failover error - sleeping ...
3.4.2012 14:28:50
  Failover error - sleeping ...
3.4.2012 14:28:56
  Failover error - sleeping ...
3.4.2012 14:29:01
  Failover error - sleeping ...
3.4.2012 14:29:06
  Failover error - sleeping ...
3.4.2012 14:29:11
  Failover error - sleeping ...
3.4.2012 14:29:16
  Failover error - sleeping ...
3.4.2012 14:29:21
  Failover error - sleeping ...
3.4.2012 14:29:26
  Failover error - sleeping ...
3.4.2012 14:29:31
  Failover error - sleeping ...
3.4.2012 14:29:36
  Failover error - sleeping ...
3.4.2012 14:29:41

As you can see from the console output control never returned from the 
TAF handler. If it had either &#34;user error handler&#34; would have been 
printed or some other message from within the for loop.

If you know of a way to stop the TAF handler from looping then please 
let me know what exactly it is.
Also please check whether the return code of the TAF handler can be used 
to stop reconnect attempts - as Oracle designed it to be. I doubt that 
this is the case.

If you use Skype I could demo the process to you but I suppose it is clear.


Mit freundlichen GrÃ¼ÃŸen/Kind regards

Norbert Debes

Hinweis: Kontaktdaten s. angehÃ¤ngte vcard/Note: contact information in attached vcard


On 4/3/2012 13:57, John Scoles via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=76269">https://rt.cpan.org/Ticket/Display.html?id=76269</a></span>&gt;
&gt;
&gt; Just some quick notes on this.  I will look into in more detail later.
&gt;
&gt; I did notice you have an &#39;update&#39; in your .pl code.  It is my
&gt; understanding that TAF will only work with selects.  Inset delete and
&gt; updates cannot cannot failover and restart, perhaps that is what is
&gt; causing your greif.
&gt;
&gt; A max attepmts looks like a good idea.  But you could just set this up
&gt; in perl as well and exit out of the callback??
&gt;
&gt; Any way will get some time tonight.
&gt;
&gt; Cheers
&gt; John
&gt;
&gt;
&gt;
&gt;
&gt;
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1058255/553693/norbert_debes.vcf">Download norbert_debes.vcf</a><br />
<span class="downloadcontenttype">text/x-vcard 343b</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1070471" href="/Public/Bug/Display.html?id=76269#txn-1070471">#</a>      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;22&nbsp;05:32:26&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> byterock [...] hotmail.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1070471/563094/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/563094">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Bear in mind I don&#39;t use TAF and never have so what follows could be
nonesense but I think John was saying it is up to you what happens after
the handler is called &#40;BUT see below&#41;. DBD::Oracle registers an internal
function with Oracle to be called for the callback and in that it calls
your registered function. The DBD::Oracle wrapper is as follows:

/* TAF or Transparent Application Failoever callback
   Works like this.  The fuction below is registered on the server,
   when the server is set up to use it, when an exe is called &#40;not sure
about other server round trips&#41;
   and the server fails tt should get into this cbk error below.
   It will wait X seconds and then try to reconnect &#40;up to n times if
that is the users choice&#41;
   That is how I see it working */

sb4
taf_cbk&#40;dvoid *svchp, dvoid *envhp, dvoid *fo_ctx,ub4 fo_type, ub4
fo_event &#41;
{
        dTHX;
        taf_callback_t *cb =&#40;taf_callback_t*&#41;fo_ctx;

        dSP;
        PUSHMARK&#40;SP&#41;;
        XPUSHs&#40;sv_2mortal&#40;newSViv&#40;fo_event&#41;&#41;&#41;;
        XPUSHs&#40;sv_2mortal&#40;newSViv&#40;fo_type&#41;&#41;&#41;;
        PUTBACK;
        call_pv&#40;cb-&gt;function, G_DISCARD&#41;;

        switch &#40;fo_event&#41;{

                case OCI_FO_BEGIN:
                case OCI_FO_ABORT:
                case OCI_FO_END:
                case OCI_FO_REAUTH:
                {
                        break;
                }
                case OCI_FO_ERROR:
                {
                        sleep&#40;cb-&gt;sleep&#41;;
                        return OCI_FO_RETRY;
                        break;
                }

                default:
                {
                        break;
                }
        }
        return 0;
}

As far as I can tell from reading
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.csee.umbc.edu/portal/help/oracle8/server.815/a67846/new_adva.htm">http://www.csee.umbc.edu/portal/help/oracle8/server.815/a67846/new_adva.htm</a></span>
if you get an OCI_FO_ERROR you return OCI_FO_RETRY to retry which the
code above always seems to do. I presume if you return 0 it stops
retrying &#40;could not specifically find that in the above link&#41;. There
does not seem to be a way for the users registered handler to say to
DBD::Oracle, I don&#39;t want to retry.

I think it would be fairly simple to add this functonality so
suggestions welcome.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1070528" href="/Public/Bug/Display.html?id=76269#txn-1070528">#</a>      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;22&nbsp;10:38:25&nbsp;2012</span>
    <span class="description">norbert.debes [...] oradbpro.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #76269] TAF with DBD:Oracle - no way to stop retrying reconnects?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 22 Apr 2012 16:38:07 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Oracle [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Norbert Debes &lt;norbert.debes [...] oradbpro.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1070528/563131/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/563131">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Martin,

the TAF handler definitely needs to give the Perl programmer a chance to 
stop retrying. In my view the decision whether to retry or not should be 
made in the Perl TAF handler and not hard coded in Perl C code. So the 
return code of the Perl TAF handler should be taken into account. 
According to my tests it is ignored. I would expect a Perl TAF handler 
to have the same choices as a C TAF handler that is used directly with OCI.

Can you fix this?

Mit freundlichen GrÃ¼ÃŸen/Kind regards

Norbert Debes

Hinweis: Kontaktdaten s. angehÃ¤ngte vcard/Note: contact information in attached vcard


On 4/22/2012 11:32, Martin J Evans via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=76269">https://rt.cpan.org/Ticket/Display.html?id=76269</a></span>&gt;
&gt;
&gt; Hi,
&gt;
&gt; Bear in mind I don&#39;t use TAF and never have so what follows could be
&gt; nonesense but I think John was saying it is up to you what happens after
&gt; the handler is called &#40;BUT see below&#41;. DBD::Oracle registers an internal
&gt; function with Oracle to be called for the callback and in that it calls
&gt; your registered function. The DBD::Oracle wrapper is as follows:
&gt;
&gt; /* TAF or Transparent Application Failoever callback
&gt;     Works like this.  The fuction below is registered on the server,
&gt;     when the server is set up to use it, when an exe is called &#40;not sure
&gt; about other server round trips&#41;
&gt;     and the server fails tt should get into this cbk error below.
&gt;     It will wait X seconds and then try to reconnect &#40;up to n times if
&gt; that is the users choice&#41;
&gt;     That is how I see it working */
&gt;
&gt; sb4
&gt; taf_cbk&#40;dvoid *svchp, dvoid *envhp, dvoid *fo_ctx,ub4 fo_type, ub4
&gt; fo_event &#41;
&gt; {
&gt;       dTHX;
&gt;       taf_callback_t *cb =&#40;taf_callback_t*&#41;fo_ctx;
&gt;
&gt;       dSP;
&gt;       PUSHMARK&#40;SP&#41;;
&gt;       XPUSHs&#40;sv_2mortal&#40;newSViv&#40;fo_event&#41;&#41;&#41;;
&gt;       XPUSHs&#40;sv_2mortal&#40;newSViv&#40;fo_type&#41;&#41;&#41;;
&gt;       PUTBACK;
&gt;       call_pv&#40;cb-&gt;function, G_DISCARD&#41;;
&gt;
&gt;       switch &#40;fo_event&#41;{
&gt;
&gt;               case OCI_FO_BEGIN:
&gt;               case OCI_FO_ABORT:
&gt;               case OCI_FO_END:
&gt;               case OCI_FO_REAUTH:
&gt;               {
&gt;                       break;
&gt;               }
&gt;               case OCI_FO_ERROR:
&gt;               {
&gt;                       sleep&#40;cb-&gt;sleep&#41;;
&gt;                       return OCI_FO_RETRY;
&gt;                       break;
&gt;               }
&gt;
&gt;               default:
&gt;               {
&gt;                       break;
&gt;               }
&gt;       }
&gt;       return 0;
&gt; }
&gt;
&gt; As far as I can tell from reading
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.csee.umbc.edu/portal/help/oracle8/server.815/a67846/new_adva.htm">http://www.csee.umbc.edu/portal/help/oracle8/server.815/a67846/new_adva.htm</a></span>
&gt; if you get an OCI_FO_ERROR you return OCI_FO_RETRY to retry which the
&gt; code above always seems to do. I presume if you return 0 it stops
&gt; retrying &#40;could not specifically find that in the above link&#41;. There
&gt; does not seem to be a way for the users registered handler to say to
&gt; DBD::Oracle, I don&#39;t want to retry.
&gt;
&gt; I think it would be fairly simple to add this functonality so
&gt; suggestions welcome.
&gt;
&gt; Martin
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1070528/563132/norbert_debes.vcf">Download norbert_debes.vcf</a><br />
<span class="downloadcontenttype">text/x-vcard 343b</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1070531" href="/Public/Bug/Display.html?id=76269#txn-1070531">#</a>      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;22&nbsp;10:46:24&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1070531/563134/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/563134">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 955b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Apr 22 10:38:25 2012, norbert.debes@oradbpro.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Martin,
&gt; 
&gt; the TAF handler definitely needs to give the Perl programmer a chance
&gt; to
&gt; stop retrying. In my view the decision whether to retry or not should
&gt; be
&gt; made in the Perl TAF handler and not hard coded in Perl C code. So the
&gt; return code of the Perl TAF handler should be taken into account.
&gt; According to my tests it is ignored.
</div>
It is ignored - that is the code I showed you.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I would expect a Perl TAF handler
&gt; to have the same choices as a C TAF handler that is used directly with
&gt; OCI.
&gt; 
&gt; Can you fix this?
</div>
Yes assuming we decide what the fix is. I could change it to work based
on what the your perl taf handler returns but I cannot test it so you&#39;d
have to do that. Can you install DBD::Oracle from source? Is so, I&#39;ll
have a go later today/tomorrow. If you cannot test it I&#39;m loathe to
change it as I cannot test it.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1070546" href="/Public/Bug/Display.html?id=76269#txn-1070546">#</a>      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;22&nbsp;11:17:09&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1070546/563140/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/563140">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Apr 22 10:46:24 2012, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sun Apr 22 10:38:25 2012, norbert.debes@oradbpro.com wrote:
<div class="message-stanza open">&gt; &gt; Hi Martin,
&gt; &gt; 
&gt; &gt; the TAF handler definitely needs to give the Perl programmer a chance
&gt; &gt; to
&gt; &gt; stop retrying. In my view the decision whether to retry or not should
&gt; &gt; be
&gt; &gt; made in the Perl TAF handler and not hard coded in Perl C code. So the
&gt; &gt; return code of the Perl TAF handler should be taken into account.
&gt; &gt; According to my tests it is ignored.
</div>&gt; 
&gt; It is ignored - that is the code I showed you.
&gt; 
<div class="message-stanza open">&gt; &gt; I would expect a Perl TAF handler
&gt; &gt; to have the same choices as a C TAF handler that is used directly with
&gt; &gt; OCI.
&gt; &gt; 
&gt; &gt; Can you fix this?
</div>&gt; 
&gt; Yes assuming we decide what the fix is. I could change it to work based
&gt; on what the your perl taf handler returns but I cannot test it so you&#39;d
&gt; have to do that. Can you install DBD::Oracle from source? Is so, I&#39;ll
&gt; have a go later today/tomorrow. If you cannot test it I&#39;m loathe to
&gt; change it as I cannot test it.
&gt; 
&gt; Martin
</div>
Get the version of DBD::Oracle from subversion trunk - see the pod for
how to do this. Try applying the following patch and then return
OCI_FO_RETRY ONLY when you want to retry.

Index: oci8.c
===================================================================
--- oci8.c      &#40;revision 15285&#41;
+++ oci8.c      &#40;working copy&#41;
@@ -1308,6 +1308,8 @@
 taf_cbk&#40;dvoid *svchp, dvoid *envhp, dvoid *fo_ctx,ub4 fo_type, ub4
fo_event &#41;
 {
        dTHX;
+    int return_count;
+    int ret;
        taf_callback_t *cb =&#40;taf_callback_t*&#41;fo_ctx;
 
        dSP;
@@ -1315,8 +1317,15 @@
        XPUSHs&#40;sv_2mortal&#40;newSViv&#40;fo_event&#41;&#41;&#41;;
        XPUSHs&#40;sv_2mortal&#40;newSViv&#40;fo_type&#41;&#41;&#41;;
        PUTBACK;
-       call_pv&#40;cb-&gt;function, G_DISCARD&#41;;
+       return_count = call_pv&#40;cb-&gt;function, G_SCALAR&#41;;
 
+    SPAGAIN;
+    
+    if &#40;return_count != 1&#41;
+        croak&#40;&#34;Expected one scalar back from taf handler&#34;&#41;;
+
+    ret = POPi;
+    
        switch &#40;fo_event&#41;{
 
                case OCI_FO_BEGIN:
@@ -1328,8 +1337,10 @@
                }
                case OCI_FO_ERROR:
                {
-                       sleep&#40;cb-&gt;sleep&#41;;
-                       return OCI_FO_RETRY;
+            if &#40;ret == OCI_FO_RETRY&#41; {
+                sleep&#40;cb-&gt;sleep&#41;;
+                return OCI_FO_RETRY;
+            }
                        break;
                }
 
@@ -1338,6 +1349,8 @@
                        break;
                }
        }
+    PUTBACK;
+    
        return 0;
 }
 
Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1070549" href="/Public/Bug/Display.html?id=76269#txn-1070549">#</a>      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;22&nbsp;11:24:41&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1070549/563143/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/563143">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 240b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Forgot to say. If the patch does not work you can find me on
irc.perl.org in #dbi, nick mje &#40;or mje_ or mje__&#41; and I&#39;ll try and work
through it with you. Best I can do since I don&#39;t have TAF support.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1070553" href="/Public/Bug/Display.html?id=76269#txn-1070553">#</a>      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;22&nbsp;11:41:45&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1070553/563147/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/563147">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 424b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Apr 03 06:51:12 2012, norbert.debes@oradbpro.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi DBD:Oracle team,
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Another problem: the value 15 that I passed for taf_sleep is ignored.
&gt; Instead a 5 second sleep is always used.
</div>
I cannot see how this is happening. The code looks correct. Here is a
slightly different patch which also logs the taf_sleep value when
tracing is enabled e.g., set ora_verbose = 6:

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> x.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1070553/563148/x.patch">Download x.patch</a><br />
<span class="downloadcontenttype">text/x-diff 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: oci8.c
===================================================================
--- oci8.c	&#40;revision 15285&#41;
+++ oci8.c	&#40;working copy&#41;
@@ -1308,6 +1308,8 @@
 taf_cbk&#40;dvoid *svchp, dvoid *envhp, dvoid *fo_ctx,ub4 fo_type, ub4 fo_event &#41;
 {
 	dTHX;
+    int return_count;
+    int ret;
 	taf_callback_t *cb =&#40;taf_callback_t*&#41;fo_ctx;
 
 	dSP;
@@ -1315,8 +1317,15 @@
 	XPUSHs&#40;sv_2mortal&#40;newSViv&#40;fo_event&#41;&#41;&#41;;
 	XPUSHs&#40;sv_2mortal&#40;newSViv&#40;fo_type&#41;&#41;&#41;;
 	PUTBACK;
-	call_pv&#40;cb-&gt;function, G_DISCARD&#41;;
+	return_count = call_pv&#40;cb-&gt;function, G_SCALAR&#41;;
 
+    SPAGAIN;
+    
+    if &#40;return_count != 1&#41;
+        croak&#40;&#34;Expected one scalar back from taf handler&#34;&#41;;
+
+    ret = POPi;
+    
 	switch &#40;fo_event&#41;{
 
 		case OCI_FO_BEGIN:
@@ -1328,8 +1337,10 @@
 		}
 		case OCI_FO_ERROR:
 		{
-			sleep&#40;cb-&gt;sleep&#41;;
-			return OCI_FO_RETRY;
+            if &#40;ret == OCI_FO_RETRY&#41; {
+                sleep&#40;cb-&gt;sleep&#41;;
+                return OCI_FO_RETRY;
+            }
 			break;
 		}
 
@@ -1338,6 +1349,8 @@
 			break;
 		}
 	}
+    PUTBACK;
+    
 	return 0;
 }
 
Index: lib/DBD/Oracle.pm
===================================================================
--- lib/DBD/Oracle.pm	&#40;revision 15283&#41;
+++ lib/DBD/Oracle.pm	&#40;working copy&#41;
@@ -1413,6 +1413,8 @@
   #import the ora fail over constants
 
   #set up TAF on the connection
+  # NOTE since DBD::Oracle uses call_pv you may need to pass a full
+  # name space as the function e.g., &#39;main::handle_taf&#39;
   my $dbh = DBI-&gt;connect&#40;&#39;dbi:Oracle:XE&#39;,&#39;hr&#39;,&#39;hr&#39;,{ora_taf=&gt;1,taf_sleep=&gt;5,ora_taf_function=&gt;&#39;handle_taf&#39;}&#41;;
 
   #create the perl TAF event function
Index: dbdimp.c
===================================================================
--- dbdimp.c	&#40;revision 15283&#41;
+++ dbdimp.c	&#40;working copy&#41;
@@ -487,7 +487,6 @@
 		imp_dbh-&gt;taf_sleep = 5; /* 5 second default */
 
     	DBD_ATTRIB_GET_IV&#40; attr, &#34;ora_taf_sleep&#34;,  13, svp, imp_dbh-&gt;taf_sleep&#41;;
-
 		if &#40;&#40;svp=DBD_ATTRIB_GET_SVP&#40;attr, &#34;ora_taf_function&#34;,  16&#41;&#41; &#38;&#38; SvOK&#40;*svp&#41;&#41; {
 			STRLEN  svp_len;
 			if &#40;!SvPOK&#40;*svp&#41;&#41;
@@ -495,6 +494,11 @@
 			imp_dbh-&gt;taf_function = &#40;char *&#41; SvPV &#40;*svp, svp_len &#41;;
 
 		}
+        if &#40;DBIc_DBISTATE&#40;imp_dbh&#41;-&gt;debug || dbd_verbose &gt;= 3&#41;
+            PerlIO_printf&#40;
+                DBIc_LOGPIO&#40;imp_dbh&#41;,
+                &#34;taf sleep = %d, taf_function = %s\n&#34;,
+                imp_dbh-&gt;taf_sleep, imp_dbh-&gt;taf_function ? imp_dbh-&gt;taf_function : &#34;&#34;&#41;;
 	}
 
     imp_dbh-&gt;server_version = 0;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1070766" href="/Public/Bug/Display.html?id=76269#txn-1070766">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;23&nbsp;09:19:52&nbsp;2012</span>
    <span class="description">norbert.debes [...] oradbpro.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #76269] TAF with DBD:Oracle - no way to stop retrying reconnects?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 23 Apr 2012 15:18:35 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Oracle [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Norbert Debes &lt;norbert.debes [...] oradbpro.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1070766/563266/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/563266">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Martin,

no, I can&#39;t build Perl and DBD::Oracle. Currently at least. But I guess 
I could give you access to an Oracle Instance on my Laptop for testing. 
Of course I may fail opening the Windows firewall for you. Never tried 
something like that. On the other hand it should not be hard to do.

Mit freundlichen GrÃ¼ÃŸen/Kind regards

Norbert Debes

Hinweis: Kontaktdaten s. angehÃ¤ngte vcard/Note: contact information in attached vcard


On 4/22/2012 16:46, Martin J Evans via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=76269">https://rt.cpan.org/Ticket/Display.html?id=76269</a></span>&gt;
&gt;
&gt; On Sun Apr 22 10:38:25 2012, norbert.debes@oradbpro.com wrote:
<div class="message-stanza open">&gt;&gt; Hi Martin,
&gt;&gt;
&gt;&gt; the TAF handler definitely needs to give the Perl programmer a chance
&gt;&gt; to
&gt;&gt; stop retrying. In my view the decision whether to retry or not should
&gt;&gt; be
&gt;&gt; made in the Perl TAF handler and not hard coded in Perl C code. So the
&gt;&gt; return code of the Perl TAF handler should be taken into account.
&gt;&gt; According to my tests it is ignored.
</div>&gt; It is ignored - that is the code I showed you.
&gt;
<div class="message-stanza open">&gt;&gt; I would expect a Perl TAF handler
&gt;&gt; to have the same choices as a C TAF handler that is used directly with
&gt;&gt; OCI.
&gt;&gt;
&gt;&gt; Can you fix this?
</div>&gt; Yes assuming we decide what the fix is. I could change it to work based
&gt; on what the your perl taf handler returns but I cannot test it so you&#39;d
&gt; have to do that. Can you install DBD::Oracle from source? Is so, I&#39;ll
&gt; have a go later today/tomorrow. If you cannot test it I&#39;m loathe to
&gt; change it as I cannot test it.
&gt;
&gt; Martin
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1070766/563267/norbert_debes.vcf">Download norbert_debes.vcf</a><br />
<span class="downloadcontenttype">text/x-vcard 343b</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1070775" href="/Public/Bug/Display.html?id=76269#txn-1070775">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;23&nbsp;09:25:06&nbsp;2012</span>
    <span class="description">norbert.debes [...] oradbpro.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #76269] TAF with DBD:Oracle - no way to stop retrying reconnects?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 23 Apr 2012 15:23:40 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Oracle [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Norbert Debes &lt;norbert.debes [...] oradbpro.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1070775/563273/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/563273">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Martin,

if you have an installation with Oracle Personal Edition or Enterprise 
Edition then TAF will be usable. Contrary to what some believe you don&#39;t 
need RAC to use TAF.

This PL/SQL Code creates a TAF-enabled service in Oracle EE:
begin
     dbms_service.create_service&#40;
         SERVICE_NAME =&gt; &#39;PLMON&#39;,
         NETWORK_NAME =&gt; &#39;PLMON&#39;,
         FAILOVER_METHOD =&gt; &#39;BASIC&#39;,
         FAILOVER_TYPE =&gt; &#39;SESSION&#39;,
         FAILOVER_RETRIES =&gt; 1440,
         FAILOVER_DELAY =&gt; 60
     &#41;;
end;
/

exec dbms_service.start_service&#40;&#39;PLMON&#39;, dbms_service.all_instances&#41;;

You can then connect with service_name=plmon.&lt;db_domain&gt; where db_domain 
is the value of the Oracle initialization parameter db_domain &#40;omit 
angle brackets of course&#41;.


Mit freundlichen GrÃ¼ÃŸen/Kind regards

Norbert Debes

Hinweis: Kontaktdaten s. angehÃ¤ngte vcard/Note: contact information in attached vcard


On 4/22/2012 17:24, Martin J Evans via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=76269">https://rt.cpan.org/Ticket/Display.html?id=76269</a></span>&gt;
&gt;
&gt; Forgot to say. If the patch does not work you can find me on
&gt; irc.perl.org in #dbi, nick mje &#40;or mje_ or mje__&#41; and I&#39;ll try and work
&gt; through it with you. Best I can do since I don&#39;t have TAF support.
&gt;
&gt; Martin
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1070775/563274/norbert_debes.vcf">Download norbert_debes.vcf</a><br />
<span class="downloadcontenttype">text/x-vcard 343b</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1070846" href="/Public/Bug/Display.html?id=76269#txn-1070846">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;23&nbsp;11:14:58&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1070846/563314/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/563314">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 479b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Apr 23 09:19:52 2012, norbert.debes@oradbpro.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Martin,
&gt; 
&gt; no, I can&#39;t build Perl and DBD::Oracle. Currently at least. But I
&gt; guess
&gt; I could give you access to an Oracle Instance on my Laptop for
&gt; testing.
&gt; Of course I may fail opening the Windows firewall for you. Never tried
&gt; something like that. On the other hand it should not be hard to do.
</div>
You don&#39;t need to build Perl.

How did you install DBD::Oracle?

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1070884" href="/Public/Bug/Display.html?id=76269#txn-1070884">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;23&nbsp;11:52:05&nbsp;2012</span>
    <span class="description">norbert.debes [...] oradbpro.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #76269] TAF with DBD:Oracle - no way to stop retrying reconnects?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 23 Apr 2012 17:48:30 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Oracle [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Norbert Debes &lt;norbert.debes [...] oradbpro.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1070884/563334/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/563334">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 746b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">ActiveState Perl for Windows

Mit freundlichen GrÃ¼ÃŸen/Kind regards

Norbert Debes

Hinweis: Kontaktdaten s. angehÃ¤ngte vcard/Note: contact information in attached vcard


On 4/23/2012 17:14, Martin J Evans via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=76269">https://rt.cpan.org/Ticket/Display.html?id=76269</a></span>&gt;
&gt;
&gt; On Mon Apr 23 09:19:52 2012, norbert.debes@oradbpro.com wrote:
<div class="message-stanza open">&gt;&gt; Hi Martin,
&gt;&gt;
&gt;&gt; no, I can&#39;t build Perl and DBD::Oracle. Currently at least. But I
&gt;&gt; guess
&gt;&gt; I could give you access to an Oracle Instance on my Laptop for
&gt;&gt; testing.
&gt;&gt; Of course I may fail opening the Windows firewall for you. Never tried
&gt;&gt; something like that. On the other hand it should not be hard to do.
</div>&gt; You don&#39;t need to build Perl.
&gt;
&gt; How did you install DBD::Oracle?
&gt;
&gt; Martin
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1070884/563335/norbert_debes.vcf">Download norbert_debes.vcf</a><br />
<span class="downloadcontenttype">text/x-vcard 343b</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1070890" href="/Public/Bug/Display.html?id=76269#txn-1070890">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;23&nbsp;12:07:07&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1070890/563340/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/563340">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 324b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Apr 23 11:52:05 2012, norbert.debes@oradbpro.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ActiveState Perl for Windows
&gt; 
</div>
Then you can use MinGW which you can install from ActiveState - to build 
a local DBD::Oracle but not install it. I could send you a complete zip 
file of the distribution with changes.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1071024" href="/Public/Bug/Display.html?id=76269#txn-1071024">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;24&nbsp;04:10:54&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1071024/563403/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/563403">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 572b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Apr 22 11:41:45 2012, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Apr 03 06:51:12 2012, norbert.debes@oradbpro.com wrote:
<div class="message-stanza open">&gt; &gt; Hi DBD:Oracle team,
</div>&gt; 
<div class="message-stanza open">&gt; &gt; Another problem: the value 15 that I passed for taf_sleep is 
</div></div>ignored.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Instead a 5 second sleep is always used.
</div>&gt; 
&gt; I cannot see how this is happening. The code looks correct. Here is a
&gt; slightly different patch which also logs the taf_sleep value when
&gt; tracing is enabled e.g., set ora_verbose = 6:
&gt; 
&gt; Martin
</div>
The attribute is ora_taf_sleep not taf_sleep. I have fixed the example.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1071049" href="/Public/Bug/Display.html?id=76269#txn-1071049">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;24&nbsp;05:34:32&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1071049/563417/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/563417">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 690b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is now fixed in subversion trunk. There were 2 problems. 1&#41; example 
used taf_sleep and it should have been ora_taf_sleep. 2&#41; there was no 
way to stop retrying the TAF event. Now, if you want to retry you need 
to return OCI_FO_RETRY from your handler.

I can package this up into a zip for you. You CAN install it with 
ActiveState because ActiveState comes with the MinGW package which 
allows you to build a Perl module.

ppm install MinGW
unzip DBD::Oracle &#40;which I&#39;ll send you on request&#41;
cd DBD-Oracle-1.44 &#40;or whatever it is when I send you it&#41;
cpan .

Thanks for the report and bearing with me whilst I tried to get my head 
around it.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1071052" href="/Public/Bug/Display.html?id=76269#txn-1071052">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;24&nbsp;05:34:35&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1092786" href="/Public/Bug/Display.html?id=76269#txn-1092786">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;24&nbsp;04:47:51&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1092788" href="/Public/Bug/Display.html?id=76269#txn-1092788">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;24&nbsp;04:47:52&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Fixed in 1.45_00 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 1.117973</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
