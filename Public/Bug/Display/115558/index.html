<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #115558 for Net-DNS: Net::DNS::Nameserver does not allow EDNS replies</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #115558 for Net-DNS: Net::DNS::Nameserver does not allow EDNS replies</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-DNS/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-DNS">Net-DNS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">115558</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-DNS/Active/">Net-DNS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bjorn [...] mork.no

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22454-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22455-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




dns-reply-missing-edns.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1694262/909866/dns-reply-missing-edns.patch">
Wed Dec 28 04:22:10 2016 (700b) by ABBYPAN [...] cpan.org
</a>
</font></li>
</ul>


edns-bug.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1641221/879967/edns-bug.diff">
Thu Jun 23 13:59:25 2016 (1.5k) by bjorn [...] mork.no
</a>
</font></li>
</ul>


Nameserver.pm-patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1641896/880346/Nameserver.pm-patch">
Sun Jun 26 11:11:51 2016 (845b) by rwfranks [...] acm.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;23&nbsp;13:59:25&nbsp;2016</span>
    <span class="description">bjorn [...] mork.no -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net::DNS::Nameserver does not allow EDNS replies</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 23 Jun 2016 19:59:08 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-DNS [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Bjørn Mork &lt;bjorn [...] mork.no&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

I have implemented a small server with DNSSEC support, but have been
unable to figure out any way to make it return the required OPT record.
The problem is that Net::DNS::Nameserver::make_reply&#40;&#41; unconditionally
calls

        my $reply  = $query-&gt;reply&#40;&#41;;

without any possibility to set the optional $UDPmax argument to -&gt;reply&#40;&#41;.
So -&gt;reply&#40;&#41; calls -&gt;edns-&gt;size&#40;$UDPmax&#41; with $UDPmax undefined:

        $reply-&gt;edns-&gt;size&#40;$UDPmax&#41; if $query-&gt;edns-&gt;_specified;

and the result is no Net::DNS::RR::OPT.  I propose either just set a
default bufsize and unconditionally enabled EDNS0 support.  There is
really no place for a server without it anymore...  Or make it optional,
like the proposed patch does.

But even with the EDNS0 OPT in place, there is still no way to set the
&#34;DO&#34; flag on replies. I propose adding that to the existing headermask
and leave it to the ReplyHandler implementation to set it as
appropriate.  This is also done in the attached patch.

Thanks for your excellent DNS implementation.  This is extremely useful
for implementing special purpose DNS services.


Bjørn
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;25&nbsp;23:22:03&nbsp;2016</span>
    <span class="description">jmaslak [...] antelope.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jun 23 13:59:25 2016, bjorn@mork.no wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; and the result is no Net::DNS::RR::OPT.  I propose either just set a
&gt; default bufsize and unconditionally enabled EDNS0 support.  There is
&gt; really no place for a server without it anymore...  Or make it optional,
&gt; like the proposed patch does.
</div>
I&#39;m just another Perl hacker here, with no influence on the module author.  I&#39;m just another person who has used this module and found it very helpful.

I would suggest some changes to this part.  I&#39;d suggest adding $reply to @arglist that is passed to the handler functions, so that full control over $reply can be done by user code if needed.  I&#39;m thinking it should be reasonably safe to add it to the end of @arglist.  This has the added benefit of being able to override any other behavior &#40;not just the size, but any EDNS options that you might want to set, not to mention possibly setting different versions of EDNS and the like&#41;.  Alternatively, expose $reply-&gt;edns by itself.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; But even with the EDNS0 OPT in place, there is still no way to set the
&gt; &#34;DO&#34; flag on replies. I propose adding that to the existing headermask
&gt; and leave it to the ReplyHandler implementation to set it as
&gt; appropriate.  This is also done in the attached patch.
</div>
I like this.  :&#41;  I think this might be able to accomplish a lot of what you desire &#40;but not necessarily adding an EDNS option&#41; if it was extended a bit.

I.E. support do, cd, z, and EDNS size &#40;which can also be accessed as $header-&gt;size&#40;&#41;&#41; via this mechanism. Perhaps add your &#34;$header-&gt;do&#40;1&#41; if $headermask-&gt;{ad};&#34; and similar for do, cd, and z, which would look substantially identical.  Size would have to take a value and pass that to $header-&gt;size&#40;&#41;.

You could probably even do the same thing as size with edns flags in general and perhaps even EDNS options &#40;I.E. perhaps a flag value of &#34;edns_option&#34; could be an arrayref containing option number and option data pairs - I initially thought maybe a hashref with the key being the edns option, but I suspect it&#39;s possible in the future to have send the same option more than once&#41;.

I too would like to thank the author for his work, which makes it pretty simple to write DNS servers.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;25&nbsp;23:22:04&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;26&nbsp;11:11:51&nbsp;2016</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Jun 25 23:22:03 2016, JMASLAK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Jun 23 13:59:25 2016, bjorn@mork.no wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; and the result is no Net::DNS::RR::OPT.  I propose either just set a
&gt; &gt; default bufsize and unconditionally enabled EDNS0 support.  There is
&gt; &gt; really no place for a server without it anymore...  Or make it
&gt; &gt; optional,
&gt; &gt; like the proposed patch does.
</div></div>
Firstly, may I underline the point that Nameserver.pm is *not* a production grade implementation, never was, never will be.  It is a plaything for testing only.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I would suggest some changes to this part.  I&#39;d suggest adding $reply
&gt; to @arglist that is passed to the handler functions, so that full
&gt; control over $reply can be done by user code if needed.  I&#39;m thinking
&gt; it should be reasonably safe to add it to the end of @arglist.  This
&gt; has the added benefit of being able to override any other behavior
&gt; &#40;not just the size, but any EDNS options that you might want to set,
</div>
No need to do that to set UDP size and DO flag.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; But even with the EDNS0 OPT in place, there is still no way to set
&gt; &gt; the
&gt; &gt; &#34;DO&#34; flag on replies. I propose adding that to the existing
&gt; &gt; headermask
&gt; &gt; and leave it to the ReplyHandler implementation to set it as
&gt; &gt; appropriate.  This is also done in the attached patch.
</div>&gt; 
&gt; I like this.  :&#41;  I think this might be able to accomplish a lot of
&gt; what you desire &#40;but not necessarily adding an EDNS option&#41; if it was
&gt; extended a bit.
</div>
This suggestion appeals to my code reduction instincts, even if the rest of me is unmoved.

 $headermask = { DO =&gt; 1, size =&gt; 12345 }





 
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Nameserver.pm-patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1641896/880346/Nameserver.pm-patch">Download Nameserver.pm-patch</a><br />
<span class="downloadcontenttype">application/octet-stream 845b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;26&nbsp;11:47:10&nbsp;2016</span>
    <span class="description">bjorn [...] mork.no -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #115558] Net::DNS::Nameserver does not allow EDNS replies</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 26 Jun 2016 17:46:42 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;Dick Franks via RT&#34; &lt;bug-Net-DNS [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Bjørn Mork &lt;bjorn [...] mork.no&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&#34;Dick Franks via RT&#34; &lt;bug-Net-DNS@rt.cpan.org&gt; writes:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sat Jun 25 23:22:03 2016, JMASLAK wrote:
<div class="message-stanza open">&gt;&gt; On Thu Jun 23 13:59:25 2016, bjorn@mork.no wrote:
&gt;&gt; 
<div class="message-stanza open">&gt;&gt; &gt; and the result is no Net::DNS::RR::OPT.  I propose either just set a
&gt;&gt; &gt; default bufsize and unconditionally enabled EDNS0 support.  There is
&gt;&gt; &gt; really no place for a server without it anymore...  Or make it
&gt;&gt; &gt; optional,
&gt;&gt; &gt; like the proposed patch does.
</div></div>&gt;
&gt; Firstly, may I underline the point that Nameserver.pm is *not* a
&gt; production grade implementation, never was, never will be.  It is a
&gt; plaything for testing only.
</div>
Sure, like all good code :&#41;


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This suggestion appeals to my code reduction instincts, even if the rest of me is unmoved.
&gt;
&gt;  $headermask = { DO =&gt; 1, size =&gt; 12345 }
&gt;
</div>..

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; *** /home/rwf/svn/net-dns/lib/Net/DNS/Nameserver.pm   2015-10-05 09:25:49.640428000 +0100
&gt; --- Nameserver.pm     2016-06-26 15:42:48.763186288 +0100
&gt; ***************
&gt; *** 251,265 ****
&gt;               $reply-&gt;{additional} = [@$add]  if $add;
&gt;       }
&gt;   
&gt; !     if &#40; !defined&#40;$headermask&#41; &#41; {
&gt; !             $header-&gt;ra&#40;1&#41;;
&gt; !             $header-&gt;ad&#40;0&#41;;
&gt; !     } else {
&gt; !             $header-&gt;opcode&#40; $headermask-&gt;{opcode} &#41; if $headermask-&gt;{opcode};
&gt;   
&gt; !             $header-&gt;aa&#40;1&#41; if $headermask-&gt;{aa};
&gt; !             $header-&gt;ra&#40;1&#41; if $headermask-&gt;{ra};
&gt; !             $header-&gt;ad&#40;1&#41; if $headermask-&gt;{ad};
&gt;       }
&gt;   
&gt;       $header-&gt;print if $self-&gt;{Verbose} &#38;&#38; defined $headermask;
&gt; --- 251,260 ----
&gt;               $reply-&gt;{additional} = [@$add]  if $add;
&gt;       }
&gt;   
&gt; !     $headermask ||= { ra =&gt; 1, ad =&gt; 0 };
&gt;   
&gt; !     while &#40; my &#40; $key, $value &#41; = each %$headermask &#41; {
&gt; !             $header-&gt;$key&#40;$value&#41;;
&gt;       }
&gt;   
&gt;       $header-&gt;print if $self-&gt;{Verbose} &#38;&#38; defined $headermask;
</div>

Nice! I like that.  Works for me.


Bjørn
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;29&nbsp;04:18:21&nbsp;2016</span>
    <span class="description">bjorn [...] mork.no -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #115558] Net::DNS::Nameserver does not allow EDNS replies</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 29 Jun 2016 10:17:44 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;Dick Franks via RT&#34; &lt;bug-Net-DNS [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Bjørn Mork &lt;bjorn [...] mork.no&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Just an additional thing to consider before deciding on the API here:
The proposed solution still does not allow adding any ENDS options.

For fun, I thought I might as well add NSID to my small server.  But you
need the $reply-&gt;edns Net::DNS::RR::OPT object for that.  So I added the
rather ugly

  $header-&gt;edns-&gt;options&#40;@{delete $headermask-&gt;{options}}&#41; if exists&#40;$headermask-&gt;{options}&#41;;

in Nameserver.pm:make_reply&#40;&#41;. But this overloading of the $headermask
is starting to feel odd.  Better alternatives are wanted.  You might
want to consider how this feature can be supported before deciding on
the DO/size support.  The headermask support does not make much sense if
the edns object becomes directly available in the reply_handler.

Yes, yes, noone *needs* any EDNS options.  I know :&#41;


Bjørn
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;29&nbsp;11:46:12&nbsp;2016</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jun 29 04:18:21 2016, bjorn@mork.no wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Just an additional thing to consider before deciding on the API here:
&gt; The proposed solution still does not allow adding any ENDS options.
&gt; 
&gt; For fun, I thought I might as well add NSID to my small server.  But
&gt; you
&gt; need the $reply-&gt;edns Net::DNS::RR::OPT object for that.  So I added
&gt; the
&gt; rather ugly
&gt; 
&gt; $header-&gt;edns-&gt;options&#40;@{delete $headermask-&gt;{options}}&#41; if
&gt; exists&#40;$headermask-&gt;{options}&#41;;
&gt; 
&gt; in Nameserver.pm:make_reply&#40;&#41;. But this overloading of the $headermask
&gt; is starting to feel odd.  Better alternatives are wanted.  You might
&gt; want to consider how this feature can be supported before deciding on
&gt; the DO/size support.  The headermask support does not make much sense
&gt; if
&gt; the edns object becomes directly available in the reply_handler.
</div>
The DO and size support was a nil-cost extension of what was already there.  Otherwise, it would likely not be done at all. 

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Yes, yes, noone *needs* any EDNS options.  I know :&#41;
</div>
If nobody needs it, why waste time and effort on making special provision for it? 

Anyway, the reply handler is free to insert an OPT RR with options into the additional section which should be good enough for test purposes.

As I noted at the start of this thread, Nameserver.pm falls a long way short of being a proper nameserver implementation.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;03&nbsp;08:56:08&nbsp;2016</span>
    <span class="description">NLNETLABS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Will be in the 1.07 release
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;03&nbsp;08:56:09&nbsp;2016</span>
    <span class="description">NLNETLABS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;28&nbsp;04:22:10&nbsp;2016</span>
    <span class="description">ABBYPAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I encountered the same OPT problem as bjorn.

the patch is addon: dns-reply-missing-edns.diff

debug trace as follows:

1. Nameserver.pm

sub tcp_connection / udp_connection  call 

     my $reply = $self-&gt;make_reply&#40; $query, $sock-&gt;peerhost, $conn &#41;;

to make reply packet

then call $reply-&gt;data to send reply packet data


2. $self-&gt;make_reply 

sub make_reply&#40;&#41; 

     my $reply = $query-&gt;reply&#40;&#41;;

init the reply packet


2.1 Packet.pm  : sub reply&#40;&#41; 

 $reply-&gt;edns-&gt;size&#40;$UDPmax&#41; if $query-&gt;edns-&gt;_specified;

set edns size

2.2 Packet.pm : sub edns&#40;&#41;

sub edns {
     my $self = shift;
     my $link = \$self-&gt;{xedns};
     &#40;$$link&#41; = grep $_-&gt;isa&#40;qw&#40;Net::DNS::RR::OPT&#41;&#41;, @{$self-&gt;{additional}} unless $$link;
     $$link = new Net::DNS::RR&#40; type =&gt; &#39;OPT&#39; &#41; unless $$link;
}

if the query contains a EDNS OPT,

when my $reply = $query-&gt;reply&#40;&#41;;  first call   $reply-&gt;edns-&gt;size&#40;$UDPmax&#41;,

$self-&gt;{xedns} is null, $link is set to $self-&gt;{xedns}&#39;s ref address.

because $self-&gt;{additional} is null, $$link is set to a new empty OPT.

that means, $self-&gt;{xedns} is set to this new empty OPT.


next time call $reply-&gt;edns

$link = \$self-&gt;{xedns} is ref to the empty OPT which created in $reply-&gt;edns-&gt;size&#40;$UDPmax&#41; initiation.

$$link will always be true, next two lines won&#39;t work:

     &#40;$$link&#41; = grep $_-&gt;isa&#40;qw&#40;Net::DNS::RR::OPT&#41;&#41;, @{$self-&gt;{additional}} unless $$link;
     $$link = new Net::DNS::RR&#40; type =&gt; &#39;OPT&#39; &#41; unless $$link;


$self-&gt;edns is always the empty OPT.

3. $reply-&gt;data

$self-&gt;edns is empty OPT, $edns-&gt;_specified always 0, no edns OPT will be unshift to @addl,

that is why EDNS OPT is missing in reply packet.

sub data {
    &#38;encode;
}

sub encode {
    my &#40; $self, $size &#41; = @_;               # uncoverable pod

    my $edns = $self-&gt;edns;                 # EDNS support
    my @addl = grep !$_-&gt;isa&#40;&#39;Net::DNS::RR::OPT&#39;&#41;, @{$self-&gt;{additional}};
    unshift&#40; @addl, $edns &#41; if $edns-&gt;_specified;
    $self-&gt;{additional} = \@addl;

    # ...
}
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dns-reply-missing-edns.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Net-DNS-1.06_05/lib/Net/DNS/Packet.pm	2016-11-12 11:23:47.000000000 +0800
+++ Net-DNS-1.06_05.fix/lib/Net/DNS/Packet.pm	2016-12-28 16:13:02.577195268 +0800
@@ -237,10 +237,12 @@
 =cut
 
 sub edns {
-	my $self = shift;
-	my $link = \$self-&gt;{xedns};
-	&#40;$$link&#41; = grep $_-&gt;isa&#40;qw&#40;Net::DNS::RR::OPT&#41;&#41;, @{$self-&gt;{additional}} unless $$link;
-	$$link = new Net::DNS::RR&#40; type =&gt; &#39;OPT&#39; &#41; unless $$link;
+    my $self = shift;
+    my $link ;
+    $link = \$self-&gt;{xedns} if&#40;exists $self-&gt;{xedns}&#41;;
+    &#40;$$link&#41; = grep $_-&gt;isa&#40;qw&#40;Net::DNS::RR::OPT&#41;&#41;, @{$self-&gt;{additional}} unless &#40;$link and $$link&#41;;
+    $$link = new Net::DNS::RR&#40; type =&gt; &#39;OPT&#39; &#41; unless &#40;$link and $$link&#41;;
+    return $$link;
 }
 
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;29&nbsp;11:56:30&nbsp;2016</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 28 04:22:10 2016, ABBYPAN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I encountered the same OPT problem as bjorn.
&gt; 
&gt; the patch is addon: dns-reply-missing-edns.diff
&gt; 
</div>Patch, as written, breaks a few install tests.

However, your diagnosis was correct.  Thanks for doing the work.

Solution will be in 1.07 soon to be released.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;01&nbsp;05:09:00&nbsp;2017</span>
    <span class="description">ABBYPAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">thanks a lot, v1.07 works now.

在2016-十二月-29 11:56:30 星期四时，rwfranks@acm.org写到：
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Dec 28 04:22:10 2016, ABBYPAN wrote:
<div class="message-stanza open">&gt; &gt; I encountered the same OPT problem as bjorn.
&gt; &gt; 
&gt; &gt; the patch is addon: dns-reply-missing-edns.diff
&gt; &gt; 
</div>&gt; Patch, as written, breaks a few install tests.
&gt; 
&gt; However, your diagnosis was correct.  Thanks for doing the work.
&gt; 
&gt; Solution will be in 1.07 soon to be released.
&gt; 
</div></div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
