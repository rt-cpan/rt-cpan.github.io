<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #30101 for CPAN-Mini: during updating of local repository, older module versions were not being removed</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #30101 for CPAN-Mini: during updating of local repository, older module versions were not being removed</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/CPAN-Mini/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/CPAN-Mini/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/CPAN-Mini/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/CPAN-Mini/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/rjbs/CPAN-Mini/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/CPAN-Mini">CPAN-Mini CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">30101</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/CPAN-Mini/Active/">CPAN-Mini</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
arfreitas [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-8200-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.563    </td>
  </tr>
  <tr id="CF-8201-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;18&nbsp;15:17:14&nbsp;2007</span>
    <span class="description">arfreitas [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> during updating of local repository, older module versions were
 not being removed</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">First of all, thank you for developing CPAN::Mini! It helps a loot,
since I don&#39;t have Internet connection available sometimes.

Today I decided to update my local CPAN, that was made a long time ago
&#40;July of 2007&#41; and was located in a CDROM.

I justed copied it to a directory in my Cygwin, updated to the last
version of CPAN::Mini and start the update process &#40;which is indeed much
faster than fetching everything again&#41;.

The problem is that some old modules were not removed in the process. I
got the size of the local repository and in fact was bigger than a CDROM
can hold!

I looked for bugs and found one related to my problem. Since the issue
seems to be still broken &#40;at least as shown in RT&#41; I made a simple
script, nothing more than a hack, to find the repeated modules and
remove than.

It&#39;s quite complicated to make 100% of the job, so this script
&#40;attached&#41; does only part of the removing older versions. Due the
complete lack of formal specification about publishing a module, it
seems impossible to match all module names and versions and there are
author that put their modules inside directories, others that use ZIPed
files or TGZ instead of tar.gz in the tarballs.

The script will just skip those cases and keep working. It will check
the last modification date of each release and remove all of them except
the most recent.

I hope the script helps others until the problem in CPAN::Mini is fixed.
I would be glad to help fixing it too.

Regards,
Alceu
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> fix.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
use warnings;
use strict;
use Cwd;
use File::Spec;
use File::stat;

my $previous_dir;
my $regex = &#39;^&#40;[\w\-]+\w&#41;&#40;\-[\d\.\-]+&#41;&#40;&#40;\.tar\.gz&#41;|&#40;\.zip&#41;|&#40;\.tgz&#41;&#41;$&#39;;

chdir File::Spec-&gt;catdir&#40; &#39;authors&#39;, &#39;id&#39; &#41;;
my $root_dir = cwd&#40;&#41;;

my $ids = read_dir&#40;$root_dir&#41;;

foreach my $id &#40; @{$ids} &#41; {

    chdir&#40;$id&#41; or die &#39;Cannot change from &#39; . cwd&#40;&#41; . &#34; to $id: $!\n&#34;;

    my $intermediates = read_dir&#40; cwd&#40;&#41; &#41;;

    foreach my $intermediate &#40; @{$intermediates} &#41; {

        chdir&#40;$intermediate&#41;
          or die &#39;Cannot change from &#39; . cwd&#40;&#41; . &#34;to $intermediate: $!\n&#34;;

        my $authors = read_dir&#40; cwd&#40;&#41; &#41;;

        foreach my $author &#40; @{$authors} &#41; {

            chdir&#40;$author&#41;
              or die &#39;Cannot change from &#39; . cwd&#40;&#41; . &#34;to $author: $!\n&#34;;

            my $modules = read_dir&#40; cwd&#40;&#41; &#41;;

            my %table;

            foreach my $module &#40; @{$modules} &#41; {

                next if $module eq &#39;CHECKSUMS&#39;;

                if &#40; -d $module &#41; {

                    print &#34;found a dir in $author\n&#34;;
                    next;

                }

                get_module&#40; $module, $author, \%table &#41;;

            }

            foreach my $module &#40; keys&#40;%table&#41; &#41; {

                if &#40; scalar&#40; keys&#40; %{ $table{$module} } &#41; &#41; &gt; 1 &#41; {

                    print &#34;there are repeated modules in $author\n&#34;;

                    # sort by last modification
                    my @sorted =
                      sort { $b &lt;=&gt; $a } keys&#40; %{ $table{$module} } &#41;;

                    #removes the higher value &#40;most recent module&#41;
                    shift&#40;@sorted&#41;;

                    foreach my $last_mod &#40;@sorted&#41; {

                        unlink $table{$module}-&gt;{$last_mod}
                          or die
                          &#34;Cannot remove $table{$module}-&gt;{$last_mod}: $!\n&#34;;

                    }

                }

            }

            # going down one level
            chdir&#40;&#39;..&#39;&#41; or die &#34;Cannot go down one level: $!\n&#34;;

        }

        chdir&#40;&#39;..&#39;&#41; or die &#34;Cannot go down one level: $!\n&#34;;

    }

    chdir&#40;&#39;..&#39;&#41; or die &#34;Cannot go down one level: $!\n&#34;;

}

sub read_dir {

    my $path = shift;
    my @list;

    opendir&#40; DIR, $path &#41; or die &#34;Cannot read $path: $!\n&#34;;

    foreach &#40; readdir&#40;DIR&#41; &#41; {

        next if $_ eq &#39;.&#39;;
        next if $_ eq &#39;..&#39;;

        push&#40; @list, $_ &#41;;

    }

    return \@list;

}

sub get_module {

    my $module    = shift;
    my $author    = shift;
    my $table_ref = shift;

    if &#40; $module =~ /$regex/io &#41; {

        #my &#40; $name, $version, $extension &#41; = &#40; $module =~ /$regex/io &#41;;
        my $name = &#40; $module =~ /$regex/io &#41;[0];

        my $file_props = stat&#40;$module&#41; or die &#34;Cannot stat $module: $!\n&#34;;

        if &#40; exists&#40; $table_ref-&gt;{$name} &#41; &#41; {

            $table_ref-&gt;{$name}-&gt;{ $file_props-&gt;mtime&#40;&#41; } = $module;

        }
        else {

            $table_ref-&gt;{$name} = { $file_props-&gt;mtime&#40;&#41; =&gt; $module };

        }

    }
    else {

        print &#34;$module of $author does not match regex\n&#34;;

    }

}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;18&nbsp;15:26:32&nbsp;2007</span>
    <span class="description">rjbs [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #30101] during updating of local repository, older module versions were not being removed</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 18 Oct 2007 15:24:57 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> via RT &lt;bug-CPAN-Mini [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ricardo SIGNES &lt;rjbs [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">*  via RT &lt;bug-CPAN-Mini@rt.cpan.org&gt; [2007-10-18T15:17:32]
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The problem is that some old modules were not removed in the process. I
&gt; got the size of the local repository and in fact was bigger than a CDROM
&gt; can hold!
</div>
The issue is almost certainly this:  I need more docs.

See, the goal is to mirror everything indexed in the CPAN index.  That means
the latest version of every indexed *module* and not every indexed
*distribution*.  You&#39;re seeing older dists because the older dist is required
to keep a version of a module available which is deleted later.

This is the desired behavior.

I may, in the future, offer a subclass that is dist-version-based.

-- 
rjbs
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;18&nbsp;15:27:07&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;09&nbsp;19:27:42&nbsp;2007</span>
    <span class="description">rjbs [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">dupe of #28408

-- 
rjbs
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;09&nbsp;19:27:43&nbsp;2007</span>
    <span class="description">rjbs [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
