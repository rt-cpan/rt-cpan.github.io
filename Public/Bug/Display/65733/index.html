<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #65733 for MooseX-Storage: issue with init_arg attribute option</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #65733 for MooseX-Storage: issue with init_arg attribute option</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/MooseX-Storage/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/MooseX-Storage/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/MooseX-Storage/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/MooseX-Storage/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/MooseX-Storage">MooseX-Storage CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">65733</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/MooseX-Storage/Active/">MooseX-Storage</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
denis.baurain [...] ulg.ac.be

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-43368-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-43369-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;15&nbsp;02:56:59&nbsp;2011</span>
    <span class="description">denis.baurain [...] ulg.ac.be -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> issue with init_arg attribute option</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 15 Feb 2011 08:56:46 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-MooseX-Storage [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Denis BAURAIN&#34; &lt;denis.baurain [...] ulg.ac.be&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Per perigrin&#39;s advice, I post here the test case that I posted earlier
on stackoverflow.com. Sorry for the delay.

I&#39;m trying to add serialization to a Moose class that has required
attributes using custom init_arg&#39;s &#40;to prefix the attribute name with a
dash for API consistency&#41; and it seems that this causes unpacking to
fail. I&#39;ve setup a test case below to illustrate my point.

use strict;
use warnings;


package MyClass1;

use Moose;
use MooseX::Storage;
use namespace::autoclean;

with Storage;

has &#39;my_attr&#39; =&gt; &#40;
    is       =&gt; &#39;ro&#39;,
    isa      =&gt; &#39;Str&#39;,
    required =&gt; 1,
&#41;;

__PACKAGE__-&gt;meta-&gt;make_immutable;


package MyClass2;

use Moose;
use MooseX::Storage;
use namespace::autoclean;

with Storage;

has &#39;my_attr&#39; =&gt; &#40;
    is       =&gt; &#39;ro&#39;,
    isa      =&gt; &#39;Str&#39;,
    required =&gt; 1,
    init_arg =&gt; &#39;-my_attr&#39;,
&#41;;

__PACKAGE__-&gt;meta-&gt;make_immutable;


package main;

my $inst1 = MyClass1-&gt;new&#40;my_attr =&gt; &#39;The String&#39;&#41;;
my $packed1 = $inst1-&gt;pack;
my $unpacked1 = MyClass1-&gt;unpack&#40;$packed1&#41;;     # this works

my $inst2 = MyClass2-&gt;new&#40;-my_attr =&gt; &#39;The String&#39;&#41;;
my $packed2 = $inst2-&gt;pack;
my $unpacked2 = MyClass2-&gt;unpack&#40;$packed2&#41;;     # this fails with a ...
    # ... Attribute &#40;my_attr&#41; is required at ...


Update: further investigation indicates that the issue is that init_arg
is not taken into account when packing. Hence, even a non-required
attribute using a custom init_arg is not correctly restored after
unpacking. See this additional test case:

package MyClass3;

with Storage;

has &#39;my_attr&#39; =&gt; &#40;
    is       =&gt; &#39;ro&#39;,
    isa      =&gt; &#39;Str&#39;,
    init_arg =&gt; &#39;-my_attr&#39;,
&#41;;

# in main...

my $inst3 = MyClass3-&gt;new&#40;-my_attr =&gt; &#39;The String&#39;&#41;;
my $packed3 = $inst3-&gt;pack;
my $unpacked3 = MyClass3-&gt;unpack&#40;$packed3&#41;;     # this seems to work ...
say $unpacked3-&gt;my_attr;                        # ... but my_attr stays undef


Thanks a lot for your help,
Denis
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;28&nbsp;04:34:28&nbsp;2011</span>
    <span class="description">denis.baurain [...] ulg.ac.be -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #65733] AutoReply: issue with init_arg attribute option </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 28 Feb 2011 10:34:13 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-MooseX-Storage [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Denis BAURAIN&#34; &lt;denis.baurain [...] ulg.ac.be&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I&#39;ve written a patch for the issue I reported last month. I&#39;ve also
added a basic test file to check it works as expected. All other tests
&#40;even optional&#41; of the current distribution &#40;0.29&#41; still pass. Not sure
about the impact on performance though... I attach the files.

Hope this helps &#40;this helps me at least :-&#41;

Denis

At Tue, 15 Feb 2011 02:56:59 -0500, bug-MooseX-Storage@rt.cpan.org wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt;Greetings,
&gt;
&gt;This message has been automatically generated in response to the
&gt;creation of a trouble ticket regarding:
&gt;       &#34;issue with init_arg attribute option&#34;,
&gt;a summary of which appears below.
&gt;
&gt;There is no need to reply to this message right now.  Your ticket has been
&gt;assigned an ID of [rt.cpan.org #65733].  Your ticket is accessible
&gt;on the web at:
&gt;
&gt;    <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=65733">http://rt.cpan.org/Ticket/Display.html?id=65733</a></span>
&gt;
&gt;Please include the string:
&gt;
&gt;         [rt.cpan.org #65733]
&gt;
&gt;in the subject line of all future correspondence about this issue. To do so,
&gt;you may reply to this message.
&gt;
&gt;                        Thank you,
&gt;                        bug-MooseX-Storage@rt.cpan.org
&gt;
&gt;-------------------------------------------------------------------------
&gt;Hi,
&gt;
&gt;Per perigrin&#39;s advice, I post here the test case that I posted earlier
&gt;on stackoverflow.com. Sorry for the delay.
&gt;
&gt;I&#39;m trying to add serialization to a Moose class that has required
&gt;attributes using custom init_arg&#39;s &#40;to prefix the attribute name with a
&gt;dash for API consistency&#41; and it seems that this causes unpacking to
&gt;fail. I&#39;ve setup a test case below to illustrate my point.
&gt;
&gt;use strict;
&gt;use warnings;
&gt;
&gt;
&gt;package MyClass1;
&gt;
&gt;use Moose;
&gt;use MooseX::Storage;
&gt;use namespace::autoclean;
&gt;
&gt;with Storage;
&gt;
&gt;has &#39;my_attr&#39; =&gt; &#40;
&gt;    is       =&gt; &#39;ro&#39;,
&gt;    isa      =&gt; &#39;Str&#39;,
&gt;    required =&gt; 1,
&gt;&#41;;
&gt;
&gt;__PACKAGE__-&gt;meta-&gt;make_immutable;
&gt;
&gt;
&gt;package MyClass2;
&gt;
&gt;use Moose;
&gt;use MooseX::Storage;
&gt;use namespace::autoclean;
&gt;
&gt;with Storage;
&gt;
&gt;has &#39;my_attr&#39; =&gt; &#40;
&gt;    is       =&gt; &#39;ro&#39;,
&gt;    isa      =&gt; &#39;Str&#39;,
&gt;    required =&gt; 1,
&gt;    init_arg =&gt; &#39;-my_attr&#39;,
&gt;&#41;;
&gt;
&gt;__PACKAGE__-&gt;meta-&gt;make_immutable;
&gt;
&gt;
&gt;package main;
&gt;
&gt;my $inst1 = MyClass1-&gt;new&#40;my_attr =&gt; &#39;The String&#39;&#41;;
&gt;my $packed1 = $inst1-&gt;pack;
&gt;my $unpacked1 = MyClass1-&gt;unpack&#40;$packed1&#41;;     # this works
&gt;
&gt;my $inst2 = MyClass2-&gt;new&#40;-my_attr =&gt; &#39;The String&#39;&#41;;
&gt;my $packed2 = $inst2-&gt;pack;
&gt;my $unpacked2 = MyClass2-&gt;unpack&#40;$packed2&#41;;     # this fails with a ...
&gt;    # ... Attribute &#40;my_attr&#41; is required at ...
&gt;
&gt;
&gt;Update: further investigation indicates that the issue is that init_arg
&gt;is not taken into account when packing. Hence, even a non-required
&gt;attribute using a custom init_arg is not correctly restored after
&gt;unpacking. See this additional test case:
&gt;
&gt;package MyClass3;
&gt;
&gt;with Storage;
&gt;
&gt;has &#39;my_attr&#39; =&gt; &#40;
&gt;    is       =&gt; &#39;ro&#39;,
&gt;    isa      =&gt; &#39;Str&#39;,
&gt;    init_arg =&gt; &#39;-my_attr&#39;,
&gt;&#41;;
&gt;
&gt;# in main...
&gt;
&gt;my $inst3 = MyClass3-&gt;new&#40;-my_attr =&gt; &#39;The String&#39;&#41;;
&gt;my $packed3 = $inst3-&gt;pack;
&gt;my $unpacked3 = MyClass3-&gt;unpack&#40;$packed3&#41;;     # this seems to work ...
&gt;say $unpacked3-&gt;my_attr;                        # ... but my_attr stays undef
&gt;
&gt;
&gt;Thanks a lot for your help,
&gt;Denis
&gt;
&gt;
&gt;
&gt;
</div>
--

Denis BAURAIN, Ph.D.
Unit of Animal Genomics
GIGA-R &#38; Faculty of Veterinary Medicine
University of Liège
GIGA Tower &#40;B34 - 1° floor&#41;
CHU, Sart Tilman Campus
1 Avenue de l&#39;Hopital
4000-Liège, Belgium
</div></div>
<div class="messageattachments">

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;10&nbsp;10:33:20&nbsp;2011</span>
    <span class="description">DBAURAIN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> issue with init_arg attribute option: candidate patch</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I have written a more extensive patch to handle unpacking of attributes with custom init_arg 
options &#40;either defined or not&#41;. I attach the patch file as well as a comprehensive test file. The 
rationale is given in the module POD &#40;maybe not the best place&#41;.

Though I am not sure about performance penalty, nor whether it is advisable to implement this 
solution &#34;as is&#34; in MooseX::Storage::Basic, my opinion is that the provided functionality is useful 
&#40;at least to me :-&#41;

I apologize if I do not follow best practices to submit this patch. I would be happy to follow 
another route if someone points me in the right direction.

Hope this helps,
Denis
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 080_basic_initarg.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use strict;
use warnings;

use Test::More tests =&gt; 36;

BEGIN {
    use_ok&#40;&#39;MooseX::Storage&#39;&#41;;
}

{

    package Foo;
    use Moose;
    use MooseX::Storage;

    with Storage;

    has &#39;number&#39;  =&gt; &#40; is =&gt; &#39;ro&#39;, isa =&gt; &#39;Int&#39;,
        init_arg =&gt; &#39;-number&#39; &#41;;
    has &#39;string&#39;  =&gt; &#40; is =&gt; &#39;ro&#39;, isa =&gt; &#39;Str&#39;,
        init_arg =&gt; &#39;-string&#39; &#41;;
    has &#39;boolean&#39; =&gt; &#40; is =&gt; &#39;ro&#39;, isa =&gt; &#39;Bool&#39;,
        init_arg =&gt; &#39;-boolean&#39; &#41;;
    has &#39;float&#39;   =&gt; &#40; is =&gt; &#39;ro&#39;, isa =&gt; &#39;Num&#39;,
        init_arg =&gt; &#39;-float&#39; &#41;;
    has &#39;array&#39;   =&gt; &#40; is =&gt; &#39;ro&#39;, isa =&gt; &#39;ArrayRef&#39;,
        init_arg =&gt; &#39;-array&#39; &#41;;
    has &#39;hash&#39;    =&gt; &#40; is =&gt; &#39;ro&#39;, isa =&gt; &#39;HashRef&#39;,
        init_arg =&gt; &#39;-hash&#39; &#41;;
    has &#39;object&#39;  =&gt; &#40; is =&gt; &#39;ro&#39;, isa =&gt; &#39;Foo&#39;,
        init_arg =&gt; &#39;-object&#39; &#41;;
    has &#39;union&#39;   =&gt; &#40; is =&gt; &#39;ro&#39;, isa =&gt; &#39;ArrayRef|Str&#39;,
        init_arg =&gt; &#39;-union&#39; &#41;;
    has &#39;union2&#39;  =&gt; &#40; is =&gt; &#39;ro&#39;, isa =&gt; &#39;ArrayRef|Str&#39;,
        init_arg =&gt; &#39;-union2&#39; &#41;;

    has &#39;requ_str&#39;  =&gt; &#40; is =&gt; &#39;ro&#39;, isa =&gt; &#39;Str&#39;,
        init_arg =&gt; &#39;-requ_str&#39;, required =&gt; 1 &#41;;
    has &#39;_priv_str&#39; =&gt; &#40; is =&gt; &#39;ro&#39;, isa =&gt; &#39;Str&#39;,
        init_arg =&gt; undef, writer  =&gt; &#39;_set_priv_str&#39; &#41;;
    has &#39;_auto_str&#39; =&gt; &#40; is =&gt; &#39;ro&#39;, isa =&gt; &#39;Str&#39;,
        init_arg =&gt; undef, builder =&gt; &#39;_build_auto_str&#39;, lazy =&gt; 1 &#41;;
    has &#39;_dual_str&#39; =&gt; &#40; is =&gt; &#39;ro&#39;, isa =&gt; &#39;Str&#39;,
        init_arg =&gt; undef, writer  =&gt; &#39;_set_dual_str&#39;,
                           builder =&gt; &#39;_build_dual_str&#39;, lazy =&gt; 1 &#41;;
    has &#39;_skip_str&#39; =&gt; &#40; is =&gt; &#39;ro&#39;, isa =&gt; &#39;Str&#39;,
        init_arg =&gt; undef &#41;;
        
    sub _build_auto_str {
        return &#39;auto string&#39;;
    }

    sub _build_dual_str {
        return &#39;dual string&#39;;
    }
    
}

{

    package Bar;
    use Moose;
    use MooseX::Storage;

    extends &#39;Foo&#39;;

    has &#39;child_str&#39; =&gt; &#40; is =&gt; &#39;ro&#39;, isa =&gt; &#39;Str&#39;,
        init_arg =&gt; &#39;-child_str&#39; &#41;;

}



{
    my $packed = {
            __CLASS__ =&gt; &#39;Foo&#39;,
            number    =&gt; 10,
            string    =&gt; &#39;foo&#39;,
            boolean   =&gt; 1,
            float     =&gt; 10.5,
            array     =&gt; [ 1 .. 10 ],
            hash      =&gt; { map { $_ =&gt; undef } &#40; 1 .. 10 &#41; },
            object    =&gt; {
                            __CLASS__ =&gt; &#39;Foo&#39;,
                            number    =&gt; 2,
                            requ_str  =&gt; &#39;inner required string&#39;,
                         },
            union     =&gt; [ 1, 2, 3 ],
            union2    =&gt; &#39;A String&#39;,
            
            # exercise interaction between init_arg and other attr properties
            requ_str  =&gt; &#39;required string&#39;,
            _priv_str =&gt; &#39;private string&#39;,
            _auto_str =&gt; &#39;overriden by builder&#39;,
            _dual_str =&gt; &#39;restored dual string&#39;,
            _skip_str =&gt; &#39;private string without writer&#39;,
    };

    my $foo = Foo-&gt;unpack&#40;$packed&#41;;
    isa_ok&#40; $foo, &#39;Foo&#39; &#41;;
    do_common_checks&#40;$foo&#41;;
    
    my $bar = Bar-&gt;unpack&#40; {            # exercise inherited attributes
        %$packed,
        child_str =&gt; &#39;a string in child class&#39;
    } &#41;;
    isa_ok&#40; $bar, &#39;Bar&#39; &#41;;
    do_common_checks&#40;$bar&#41;;
    is&#40; $bar-&gt;child_str,  &#39;a string in child class&#39;,  &#39;... got the right string &#40;child&#41;&#39; &#41;;
}


sub do_common_checks {
    my $foo = shift;

    is&#40; $foo-&gt;number, 10,    &#39;... got the right number&#39; &#41;;
    is&#40; $foo-&gt;string, &#39;foo&#39;, &#39;... got the right string&#39; &#41;;
    ok&#40; $foo-&gt;boolean,       &#39;... got the right boolean&#39; &#41;;
    is&#40; $foo-&gt;float,  10.5,  &#39;... got the right float&#39; &#41;;
    is_deeply&#40; $foo-&gt;array, [ 1 .. 10 ], &#39;... got the right array&#39; &#41;;
    is_deeply&#40;
        $foo-&gt;hash,
        { map { $_ =&gt; undef } &#40; 1 .. 10 &#41; },
        &#39;... got the right hash&#39;
    &#41;;

    isa_ok&#40; $foo-&gt;object, &#39;Foo&#39; &#41;;
    is&#40; $foo-&gt;object-&gt;number, 2,
        &#39;... got the right number &#40;in the embedded object&#41;&#39; &#41;;
    is&#40; $foo-&gt;object-&gt;requ_str, &#39;inner required string&#39;,
        &#39;... got the right string &#40;required in the embedded object&#41;&#39; &#41;;
    is_deeply&#40; $foo-&gt;union, [ 1 .. 3 ], &#39;... got the right array &#40;in the union&#41;&#39; &#41;;
    is&#40; $foo-&gt;union2,  &#39;A String&#39;,  &#39;... got the right string &#40;in the union&#41;&#39; &#41;;

    is&#40; $foo-&gt;requ_str,  &#39;required string&#39;,  &#39;... got the right string &#40;required&#41;&#39; &#41;;
    is&#40; $foo-&gt;_priv_str,  &#39;private string&#39;,  &#39;... got the right string &#40;private&#41;&#39; &#41;;
    is&#40; $foo-&gt;_auto_str,  &#39;auto string&#39;,  &#39;... got the right string &#40;builder&#41;&#39; &#41;;    
    is&#40; $foo-&gt;_dual_str,  &#39;restored dual string&#39;,  &#39;... got the right string &#40;writer/builder&#41;&#39; &#41;;    
    is&#40; $foo-&gt;_skip_str, undef, &#39;... skipped private string without writer&#39; &#41;;    
}


</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> init_arg.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- MooseX-Storage-0.29/lib/MooseX/Storage/Basic.pm	2010-11-17 14:51:35.000000000 +0100
+++ MooseX-Storage-0.29f/lib/MooseX/Storage/Basic.pm	2011-03-10 17:56:46.000000000 +0100
@@ -51,8 +51,35 @@
 sub _storage_construct_instance {
     my &#40;$class, $args, $opts&#41; = @_;
     my %i = defined $opts-&gt;{&#39;inject&#39;} ? %{ $opts-&gt;{&#39;inject&#39;} } : &#40;&#41;;
-
-    $class-&gt;new&#40; %$args, %i &#41;;
+    
+    my %priv_attrs;    
+    for my $arg &#40;keys %$args&#41; {
+
+        # collect private attributes with undef init_arg but defined writer
+        # these will be restored after instance construction
+        my $init_arg = $class-&gt;meta-&gt;find_attribute_by_name&#40;$arg&#41;-&gt;init_arg;
+        if &#40;!defined $init_arg&#41; {
+            my $writer = $class-&gt;meta-&gt;find_attribute_by_name&#40;$arg&#41;-&gt;writer;
+            if &#40;defined $writer&#41; {
+                $priv_attrs{$writer} = $args-&gt;{$arg};
+                delete $args-&gt;{$arg};
+            }
+        }
+        
+        # replace attribute name by init_arg if defined
+        # this allows call to constructor below to work as expected
+        elsif &#40;$init_arg ne $arg&#41; {
+            $args-&gt;{$init_arg} = $args-&gt;{$arg};
+            delete $args-&gt;{$arg};
+        }
+    }
+    
+    # create new instance using public attributes ...
+    # and populate private attributes with corresponding writers
+    my $instance = $class-&gt;new&#40; %$args, %i &#41;;
+    $instance-&gt;$_&#40; $priv_attrs{$_} &#41; for keys %priv_attrs;
+    
+    return $instance;
 }
 
 no Moose::Role;
@@ -119,6 +146,71 @@
 Providing the C&lt;insert&gt; argument let&#39;s you supply additional arguments to
 the class&#39; C&lt;new&gt; function, or override ones from the serialized data.
 
+Attributes with custom constructor parameters &#40;specified with the C&lt;init_arg&gt;
+option&#41; are packed as other attributes but lead to more complex unpacking. The
+current behavior is as follows.
+
+If C&lt;init_arg&gt; has a defined value &#40;e.g., C&lt;-start&gt; for attribute C&lt;start&gt;&#41;, the
+custom constructor parameter &#40;C&lt;-start&gt;&#41; is used when restoring the attribute
+&#40;even though it is still packed as C&lt;start&gt;&#41;. This is needed to ensure API
+consistency when extending a large module distribution making use of custom
+constructor parameters &#40;e.g., BioPerl classes&#41;.
+
+If C&lt;init_arg&gt; is explicitly set to C&lt;undef&gt;, the unpacking behavior depends on
+the value of the C&lt;writer&gt; option. When C&lt;writer&gt; is defined, the corresponding
+method is used to restore the attribute after object creation &#40;thus overriding
+any attribute value possibly provided by C&lt;default&gt; or C&lt;builder&gt; options&#41;. This
+is especially useful for lazy attributes that are very expensive to build and
+thus prime candidates for serialization. Here is a use case that illustrates
+this point.
+
+Consider a C&lt;Store&gt; class providing high-level access to an array of hashes. The
+private C&lt;_store&gt; attribute of this class could be defined as:
+
+    has &#39;_store&#39; =&gt; &#40;
+        is       =&gt; &#39;ro&#39;,
+        isa      =&gt; &#39;ArrayRef[HashRef[Num]]|ArrayRef&#39;,  # union required for
+        init_arg =&gt; undef,                              # unpacking empty slots
+        default  =&gt; sub { [] },
+        writer   =&gt; &#39;_set_store&#39;,                       # for unserialization
+    &#41;;
+
+Now, let&#39;s say that populating a C&lt;Store&gt; object requires processing hundreds of
+large files. Ultimately, input data is stored in the object using methods like:
+
+    sub add_coverage {
+        my $self = shift;
+        my $bin  = shift;
+        my $tag  = shift;    
+        return ${$self-&gt;_store}[$bin]{$tag} += shift;   # weight
+    }
+    
+This is typically a preprocessing step that you only want to do once. In
+contrast, accessing the C&lt;Store&gt; object might be needed several times &#40;for
+example with different sets of parameters for statistical analysis of the store
+content&#41;. Thanks to the behavior described above, it is very easy to serialize
+an object with such a private C&lt;_store&gt;. While the C&lt;_store&gt; attribute is
+properly initialized on object creation &#40;owing to its C&lt;default&gt; option&#41;, it is
+also correctly restored on unpacking &#40;due to its C&lt;writer&gt; option&#41;. Further,
+this approach does not violate encapsulation of the private attribute since it
+restores its value through explicitly defined methods.
+
+Finally, for attributes with C&lt;init_arg&gt; set to C&lt;undef&gt; but without a defined
+C&lt;writer&gt;, attribute values are not restored at all &#40;even if actually packed&#41;.
+This is the desired behavior for lazy attributes that are cheap to compute from
+other attributes &#40;generally with a C&lt;builder&gt; option&#41;. In this case, it is
+probably better &#40;i.e., clearer&#41; to explicitly add the &#39;DoNotSerialize&#39; trait, as
+below:
+
+    has &#39;bin_width&#39; =&gt; &#40;
+        is       =&gt; &#39;ro&#39;,
+        isa      =&gt; &#39;Num&#39;,
+        init_arg =&gt; undef,
+        lazy     =&gt; 1,
+        builder  =&gt; &#39;_build_bin_width&#39;,
+        traits   =&gt; [ &#39;DoNotSerialize&#39; ],   # will be recomputed on unpacking
+    &#41;;
+
 =back
 
 =head2 Introspection
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;10&nbsp;10:33:21&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
