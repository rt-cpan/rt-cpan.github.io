<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #43859 for URI: should be _utf8_off -ed raw data before URI encoding</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #43859 for URI: should be _utf8_off -ed raw data before URI encoding</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/URI/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/URI/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/URI/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/URI/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/URI">URI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">43859</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/URI/Active/">URI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
msmouse [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-34672-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-34673-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;04&nbsp;21:18:16&nbsp;2009</span>
    <span class="description">msmouse [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> should be _utf8_off -ed raw data before URI encoding</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 5 Mar 2009 10:17:58 +0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-URI [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> msmouse &lt;msmouse [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I&#39;m here to report a problem with the latest URI / URI::Escape suite.

&#40;URI-1.37, URI::Escape-3.29, Windows Vista sp1 x86, Strawberry perl 5.10.0.3
built for MSWin32-x86-multi-thread&#41;

I was trying to POST string in gbk encoding via WWW::Mechanize and got wrong
resullt. I discovered that it was caused by a join of utf8-flaged and
non-utf8-flaged strings -- /&#40;\C&#41;/g matching returns wrong result on such
joined string. I don&#39;t known by whom &#40;Mech or LWP?&#41; the utf8-flag of the
form key which is in ASCII was turned on, and afterwards it was joined with
my non-utf8 value string. URI::Escape::escape_char uses /&#40;\C&#41;/g to get raw
bytes and got the raw result.

to make clear the problem:

  1 use strict;
  2 use warnings;
  3 use Encode;
  4 use utf8;
  5
  6 my $s1 = decode&#40;&#39;utf8&#39;, &#39;s1&#39;&#41;;
  7 my $s2 = encode&#40;&#39;gbk&#39;,&#39;公司&#39;&#41;;
  8 my $s3 = &#34;$s1+$s2&#34;;
  9
 10 print_is_utf8&#40;$s1&#41;;
 11 print_is_utf8&#40;$s2&#41;;
 12 print_is_utf8&#40;$s3&#41;;
 13
 14
 15 print_str&#40;$s1&#41;;
 16 print_str&#40;$s2&#41;;
 17 print_str&#40;$s3&#41;;
 18
 19 sub print_str {
 20     my $str = shift;
 21     print &#34;$str: &#34;;
 22     print unpack&#40;&#39;H*&#39;, $str&#41; . &#39;=&#39; . join&#40;&#39;+&#39;, map {unpack&#40;&#39;H*&#39;, $_&#41;}
&#40;$str=~/&#40;\C&#41;/g&#41;&#41; . &#34;\n&#34;;
 23 }
 24
 25 sub print_is_utf8 {
 26     my $str = shift;
 27     print +&#40;Encode::is_utf8&#40;$str&#41;?&#34;y&#34;:&#34;n&#34;&#41;, &#34;\n&#34;;
 28 }
~
~
Test result:

y
n
y
s1: 7331=73+31
公司: b9abcbbe=b9+ab+cb+be
s1+公司: 73312bb9abcbbe=73+31+2b+c2+b9+c2+ab+c3+8b+c2+be &lt;-- wrong result


To solve the problem, URI could force the utf8 flag off for all the keys and
values before escaping:

&#40;in sub query_form&#40;&#41;, _query.pm, around line 40 &#41;

    $delim = pop if @_ % 2;
    use Encode;                                        &lt;--------my fix
    map {Encode::_utf8_off&#40;$_&#41;} @_;           &lt;------ my fix

        my @query;
        while &#40;my&#40;$key,$vals&#41; = splice&#40;@_, 0, 2&#41;&#41; {
            $key = &#39;&#39; unless defined $key;
        $key =~ s/&#40;[;\/?:@&#38;=+,\$\[\]%]&#41;/ URI::Escape::escape_char&#40;$1&#41;/eg;
        $key =~ s/ /+/g;
        $vals = [ref&#40;$vals&#41; eq &#34;ARRAY&#34; ? @$vals : $vals];


I don&#39;t known whether this is a CORE bug or intented, but . However I think
URI should treat the data to be escaped as raw, so maybe you can accept my
fix.

Thank you!

msmouse
----------------------------------
msmouse@ir.hit.edu.cn
msmouse@gmail.com
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;30&nbsp;04:42:02&nbsp;2011</span>
    <span class="description">NANTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I agree this ticket. For that matter, I think URI &#40;as defined in RFC
3986&#41; should always be octets. URI itself has no information about
character encodings. Ideally, percent-encoded parts of a URI can be
decoded with an arbitrary character encoding. Therefore a
percent-decoded value should be octets.

But the URI module accepts internationalized domain names against RFC
3986, that makes this problem more complex. Consider about a URI
&#34;http://日本語.jp/?q=%E5%AD%97&#34; &#40;&#34;日本語&#34; is U+65E5 U+672C U+8A9E&#41;.

my $u = URI-&gt;new&#40;&#34;http://\x{65E5}\x{672C}\x{8A9E}.jp/?q=%E5AD%97&#34;&#41;;
$u-&gt;host; # &#34;xn--wgv71a119e.jp&#34;
$u-&gt;query_param&#40;&#39;q&#39;&#41;; # &#34;\x{e5}\x{ad}\x{97}&#34; &#40;UTF8 flag is on&#41; 

The query_param method returns a UTF8-flagged string
&#34;\x{e5}\x{ad}\x{97}&#34;, not octets. I can get octets when I pass octets to
URI-&gt;new, but then a host method returns a different value from the
string case.

my $u =
URI-&gt;new&#40;encode_utf8&#40;&#34;http://\x{65E5}\x{672C}\x{8A9E}.jp/?q=%E5AD%97&#34;&#41;&#41;;
$u-&gt;host; # &#34;xn--xakg0a0al61bcu.jp&#34;
$u-&gt;query_param&#40;&#39;q&#39;&#41;; # &#34;\xe5\xad\x97&#34; &#40;UTF8 flag is off&#41; 

I think in both cases a host method should return &#34;xn--wgv71a119e.jp&#34;
and a query_param method should return octets &#34;\xe5\xad\x97&#34;.

I write a patch to fix this problem.
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/nanto/uri/compare/master...coerce_octets">https://github.com/nanto/uri/compare/master...coerce_octets</a></span>
By this patch:

1. Arguments of all methods &#40;except IRI-related methods&#41; are treated as
octets. As a result, return values also become octets. UTF8-flagged
strings are treated as octets encoded with UTF-8.

2. In a host part, octets are treated as UTF-8 encoded octets. They are
decoded with UTF-8 and then encoded in Punycode. This special treatment
is for programs that already use IDN with URI module.

3. URI module loses backward compatibility by these changes. In
particular, octets in a host part are no longer treated as a Latin-1
string. For users who want compatibity, a $URI::COERCE_OCTETS variable,
whose defualt value is true, is introduced. Setting this variable to
false makes URI module&#39;s behavior the same as version 1.58.

Thank you.

-- 
nanto_vi &#40;TOYAMA Nao&#41;
nanto@moon.email.ne.jp
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;May&nbsp;30&nbsp;04:42:03&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
