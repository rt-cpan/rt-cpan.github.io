<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #97840 for Type-Tiny: incorrect argument fingered in validate w/ optional coerced arg and bogus extra arg</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #97840 for Type-Tiny: incorrect argument fingered in validate w/ optional coerced arg and bogus extra arg</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Type-Tiny">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Type-Tiny">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Type-Tiny">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Type-Tiny">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Type-Tiny">Type-Tiny CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">97840</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Type-Tiny">Type-Tiny</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
djerius [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-249424-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.047_08    </td>
  </tr>
  <tr id="CF-249425-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




bug2.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1396026/741237/bug2.t">
Thu Aug 07 14:25:02 2014 (1001b) by djerius [...] cpan.org
</a>
</font></li>
</ul>


bug3.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1396050/741252/bug3.t">
Thu Aug 07 15:04:57 2014 (1.2k) by djerius [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=97840">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1396026" href="/Public/Bug/Display.html?id=97840#txn-1396026">#</a>      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;07&nbsp;14:25:02&nbsp;2014</span>
    <span class="description">djerius [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> incorrect argument fingered in validate w/ optional coerced arg
 and bogus extra arg</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1396026/741236/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/741236">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The attached code illustrates this problem:

cfg_path is an optional class_type argument which may be coerced into
a class from a string.  If validate&#40;&#41; is passed a valid cfg_path plus
a bogus extra parameter, cfg_path&#39;s validation fails; the coercion is
not performed, but the class check is still performed.  The correct
error would be that the extra parameter is bogus.

Here&#39;s the output on a clean install of Perl 5.20.0 with Type::Tiny
0.047_08 &#40;fails on 0.046 as well&#41;:

e% perl bug2.t
ok 1 - just the optional argument
ok 2 - &#39;the coerced optional argument&#39; isa &#39;Foo&#39;
ok 3 - an unexpected argument
not ok 4 - both the optional and unexpected arguments
#   Failed test &#39;both the optional and unexpected arguments&#39;
#   at bug2.t line 51.
#                   &#39;Reference {&#34;cfg_path&#34; =&gt; &#34;.&#34;,&#34;shell&#34; =&gt; &#34;.&#34;} did not pass type constraint &#34;Dict[cfg_path=&gt;Optional[Path]]&#34; &#40;in $_[0]&#41; at /home/dj/.perlbrew/libs/perl-5.20.0@tmp4/lib/perl5/Test/Fatal.pm line 45
#     Reference {&#34;cfg_path&#34; =&gt; &#34;.&#34;,&#34;shell&#34; =&gt; &#34;.&#34;} did not pass type constraint &#34;Dict[cfg_path=&gt;Optional[Path]]&#34; &#40;in $_[0]&#41;
#     &#34;Dict[cfg_path=&gt;Optional[Path]]&#34; constrains value at key &#34;cfg_path&#34; of hash with &#34;Optional[Path]&#34;
#     Value &#34;.&#34; did not pass type constraint &#34;Optional[Path]&#34; &#40;in $_[0]-&gt;{&#34;cfg_path&#34;}&#41;
#     $_[0]-&gt;{&#34;cfg_path&#34;} exists
#     &#34;Optional[Path]&#34; constrains $_[0]-&gt;{&#34;cfg_path&#34;} with &#34;Path&#34; if it exists
#     Not a blessed reference
# &#39;
#     doesn&#39;t match &#39;&#40;?^:does not allow key &#34;shell&#34;&#41;&#39;
1..4
# Looks like you failed 1 test of 4.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> bug2.t</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1396026/741237/bug2.t">Download bug2.t</a><br />
<span class="downloadcontenttype">text/x-perl 1001b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#! perl

use strict;
use warnings;

use Test::More;
use Test::Fatal;

{ package Foo; sub new { bless {}, shift } };

use Types::Standard qw[ Str Dict Optional ];
use Type::Params qw[ validate ];
use Type::Utils -all;

use Type::Library  -base, -declare =&gt; qw&#40; Path &#41;;

class_type Path, { class =&gt; &#34;Foo&#34; };

coerce Path,  from Str&#40;&#41; =&gt; q{ Foo-&gt;new&#40;$_&#41; }, ;



my @spec = &#40; Dict [ cfg_path =&gt; Optional [Path] ] &#41;;

my %args = @ARGV; 

is&#40;
     exception  {
	 validate&#40; [ {cfg_path =&gt; &#39;.&#39;} ], @spec &#41;;
     },
   undef,
   &#39;just the optional argument&#39;,
&#41;;

isa_ok&#40; &#40;validate&#40; [ {cfg_path =&gt; &#39;.&#39;} ], @spec &#41;&#41;[0]-&gt;{cfg_path}, &#39;Foo&#39;,
	&#39;the coerced optional argument&#39;&#41;;


like&#40;
     exception  {
	 validate&#40; [ { shell =&gt; &#39;.&#39;} ], @spec &#41;;
     },
   qr/does not allow key &#34;shell&#34;/,
   &#39;an unexpected argument&#39;,
&#41;;

like&#40;
     exception  {
	 validate&#40; [ { cfg_path =&gt; &#39;.&#39;, shell =&gt; &#39;.&#39;} ], @spec &#41;;
     },
   qr/does not allow key &#34;shell&#34;/,
   &#39;both the optional and unexpected arguments&#39;,
&#41;;


done_testing;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1396041" href="/Public/Bug/Display.html?id=97840#txn-1396041">#</a>      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;07&nbsp;15:02:06&nbsp;2014</span>
    <span class="description">djerius [...] cpan.org -  Broken in 0.046 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1396050" href="/Public/Bug/Display.html?id=97840#txn-1396050">#</a>      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;07&nbsp;15:04:57&nbsp;2014</span>
    <span class="description">djerius [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1396050/741251/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/741251">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Aug 07 14:25:02 2014, DJERIUS wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Here&#39;s the output on a clean install of Perl 5.20.0 with Type::Tiny
&gt; 0.047_08 &#40;fails on 0.046 as well&#41;:
&gt; 
</div>
I was incorrect; this does not fail on 0.046, only on 0.047_08.  I&#39;ve isolated another means of triggering the error message, this time without requiring an unexpected parameter. Here it requires two parameters requiring coercion:

ok 1 - missing required parameter
not ok 2 - optional arg, missing required
#   Failed test &#39;optional arg, missing required&#39;
#   at bug3.t line 49.
#                   &#39;Reference {&#34;cfg_path&#34; =&gt; &#34;.&#34;} did not pass type constraint &#34;Dict[cfg_path=&gt;Optional[Path],shell=&gt;Str,tilt_angle=&gt;Optional[Angle]]&#34; &#40;in $_[0]&#41; at /home/dj/.perlbrew/libs/perl-5.20.0@tmp4/lib/perl5/Test/Fatal.pm line 45
#     Reference {&#34;cfg_path&#34; =&gt; &#34;.&#34;} did not pass type constraint &#34;Dict[cfg_path=&gt;Optional[Path],shell=&gt;Str,tilt_angle=&gt;Optional[Angle]]&#34; &#40;in $_[0]&#41;
#     &#34;Dict[cfg_path=&gt;Optional[Path],shell=&gt;Str,tilt_angle=&gt;Optional[Angle]]&#34; constrains value at key &#34;cfg_path&#34; of hash with &#34;Optional[Path]&#34;
#     Value &#34;.&#34; did not pass type constraint &#34;Optional[Path]&#34; &#40;in $_[0]-&gt;{&#34;cfg_path&#34;}&#41;
#     $_[0]-&gt;{&#34;cfg_path&#34;} exists
#     &#34;Optional[Path]&#34; constrains $_[0]-&gt;{&#34;cfg_path&#34;} with &#34;Path&#34; if it exists
#     Not a blessed reference
# &#39;
#     doesn&#39;t match &#39;&#40;?^:requires key &#34;shell&#34;&#41;&#39;
ok 3 - optional arg, missing required, removed other optional arg from spec
1..3
# Looks like you failed 1 test of 3.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> bug3.t</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1396050/741252/bug3.t">Download bug3.t</a><br />
<span class="downloadcontenttype">text/x-perl 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#! perl

use strict;
use warnings;

use Test::More;
use Test::Fatal;

use Types::Standard -all;
use Types::Common::Numeric -all;
use Type::Params qw[ validate ];
use Type::Utils -all;

{ package Foo; sub new { bless {}, shift } };


use Type::Library  -base, -declare =&gt; qw&#40; Path Angle &#41;;

class_type Path, { class =&gt; &#34;Foo&#34; };

coerce Path,  from Str , q{ Foo-&gt;new&#40;$_&#41; }, ;

declare Angle,  as Num;

coerce Angle,  from Str, via {   };

my %ARG = &#40; cfg_path =&gt; &#39;.&#39; &#41;;

like &#40; exception {
       validate&#40; [ {  } ],
    Dict [
        cfg_path         =&gt; Optional [Path],
        shell            =&gt; Str,
        tilt_angle    =&gt; Optional [Angle],
    ] &#41;;
   },
   qr/requires key &#34;shell&#34;/,
   &#39;missing required parameter&#39;
   &#41;;

like &#40; exception {
   validate&#40; [ { cfg_path =&gt; &#39;.&#39; } ],
    Dict [
        cfg_path         =&gt; Optional [Path],
        shell            =&gt; Str,
        tilt_angle    =&gt; Optional [Angle],
    ] &#41;;
   },
   qr/requires key &#34;shell&#34;/,
   &#39;optional arg, missing required&#39;
   &#41;;

like &#40; exception {
   validate&#40; [ { cfg_path =&gt; &#39;.&#39; } ],
    Dict [
        cfg_path         =&gt; Optional [Path],
        shell            =&gt; Str,
    ] &#41;;
   },
   qr/requires key &#34;shell&#34;/,
   &#39;optional arg, missing required, removed other optional arg from spec&#39;
   &#41;;

done_testing;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1396061" href="/Public/Bug/Display.html?id=97840#txn-1396061">#</a>      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;07&nbsp;15:19:09&nbsp;2014</span>
    <span class="description">djerius [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1396061/741257/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/741257">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 496b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Aug 07 15:04:57 2014, DJERIUS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Aug 07 14:25:02 2014, DJERIUS wrote:
&gt; 
<div class="message-stanza open">&gt; &gt;
&gt; &gt; Here&#39;s the output on a clean install of Perl 5.20.0 with Type::Tiny
&gt; &gt; 0.047_08 &#40;fails on 0.046 as well&#41;:
&gt; &gt;
</div>&gt; 
&gt; I was incorrect; this does not fail on 0.046, only on 0.047_08. 
</div>
Today is my day to be incorrect &#40;or have too many terminals open&#41;.

The indicated failures in the tests in file &#34;bug2.t&#34; fail on both 0.046 and 0.047_08.

The indicated failures in &#34;bug3.t&#34; only occur on 0.047_08.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1396392" href="/Public/Bug/Display.html?id=97840#txn-1396392">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;08&nbsp;06:21:53&nbsp;2014</span>
    <span class="description">perl [...] toby.ink -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1396392/741413/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/741413">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 911b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I don&#39;t consider this to be a bug.

The type coercion and type check are two separate steps.

Coercion either happens 100% or it does not happen at all. In this case, the data structure you&#39;re passing in cannot be coerced &#40;because the automatic deep coercion for Dict stops short of deleting keys from the hashref&#41;.

Coercion has failed. Now we move on to the type check. Because there was nothing output from the coercion, the type check happens on the *original hashref* which was:

    { cfg_path =&gt; &#39;.&#39;, shell =&gt; &#39;.&#39; }

This is checked against:

    Dict[ cfg_path =&gt; Optional[Path] ]

It fails, and you get the reason:

    Value &#34;.&#34; did not pass type constraint &#34;Optional[Path]&#34;

Which is true.

I grant you that it&#39;s not entirely intuitive, but it does make sense when you consider coercion and check to be two separate stages, and that the check happens on the original input if the coercion has failed.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1396393" href="/Public/Bug/Display.html?id=97840#txn-1396393">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;08&nbsp;06:21:53&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1396395" href="/Public/Bug/Display.html?id=97840#txn-1396395">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;08&nbsp;06:21:55&nbsp;2014</span>
    <span class="description">perl [...] toby.ink -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1396472" href="/Public/Bug/Display.html?id=97840#txn-1396472">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;08&nbsp;10:59:29&nbsp;2014</span>
    <span class="description">djerius [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1396472/741462/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/741462">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Aug 08 06:21:53 2014, TOBYINK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I don&#39;t consider this to be a bug.
&gt;
&gt; The type coercion and type check are two separate steps.
&gt;
&gt; Coercion either happens 100% or it does not happen at all. In this
&gt; case, the data structure you&#39;re passing in cannot be coerced &#40;because
&gt; the automatic deep coercion for Dict stops short of deleting keys from
&gt; the hashref&#41;.
</div>
Does this mean that the check for extra or missing elements happens
twice, once during type coercion of Dict &#40;which apparently fails
silently&#41;, and then during type checking, but apparently only after
checking types for passed elements?

A container is special, especially one like Dict, which limits
membership based upon name as well as type.  Why not check that the
set of passed parameters is complete before doing any other work?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; Coercion has failed. Now we move on to the type check. Because there
&gt; was nothing output from the coercion, the type check happens on the
&gt; *original hashref* which was:
&gt;
&gt; { cfg_path =&gt; &#39;.&#39;, shell =&gt; &#39;.&#39; }
&gt;
&gt; This is checked against:
&gt;
&gt; Dict[ cfg_path =&gt; Optional[Path] ]
&gt;
&gt; It fails, and you get the reason:
&gt;
&gt; Value &#34;.&#34; did not pass type constraint &#34;Optional[Path]&#34;
&gt;
&gt; Which is true.
&gt;
&gt; I grant you that it&#39;s not entirely intuitive, but it does make sense
&gt; when you consider coercion and check to be two separate stages, and
&gt; that the check happens on the original input if the coercion has
&gt; failed.
</div>
In practice, this means that one should never use a coercion in a
Dict, as there&#39;s no way of knowning which element caused the
validation process to fail. That has significant repercussions.

You can&#39;t use coerced types in slurpy Dict&#39;s used to provide named
parameters to functions in the public API.  User&#39;s have to be able
to figure out which parameter caused the problem.  Unfortunately, this
is exactly where you&#39;d want to be able to provide the flexibility that
coercions give.

Type libraries are now suspect. Prior to being pared down for the bug
report, the code used Types::Path::Tiny to ensure that a passed path
was valid.  Now each library type has to be checked that it doesn&#39;t
have an attached coercion.

This significantly limits what&#39;s possible with a Dict. That&#39;s
unfortunate.  Dict&#39;s &#40;sole&#41; purpose is to guarantee a fixed set of named
parameters, but it cannot guarantee that if that requirement is
violated that it can provide correct information as to the problem.
That seems like a bug.

Diab
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1396526" href="/Public/Bug/Display.html?id=97840#txn-1396526">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;08&nbsp;14:16:07&nbsp;2014</span>
    <span class="description">djerius [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1396526/741485/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/741485">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 418b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Aug 08 10:59:29 2014, DJERIUS wrote:
[... many things ...]

Rather than continue to guess as to what&#39;s happening in the code, I&#39;m going to have to take a dive into that section.

If there is some non-grotty fashion of ensuring that violations of container constraints are reported as such, would you accept code to do so, or is there a more fundamental philosophical reason for not pursuing it?


Thanks,
Diab
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1397409" href="/Public/Bug/Display.html?id=97840#txn-1397409">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;11&nbsp;20:41:04&nbsp;2014</span>
    <span class="description">perl [...] toby.ink -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1397409/741915/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/741915">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2014-08-08T15:59:29+01:00, DJERIUS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Does this mean that the check for extra or missing elements happens
&gt; twice, once during type coercion of Dict &#40;which apparently fails
&gt; silently&#41;, and then during type checking, but apparently only after
&gt; checking types for passed elements?
</div>
Coercions will always result in two checks. The first is to check if the value is something that needs to be coerced; the second check is necessary to ensure that the output of the coercion does indeed pass the type constraint. &#40;Coercions after all accept arbitrary coderefs, which may accidentally return a value that does not pass the type constraint.&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In practice, this means that one should never use a coercion in a
&gt; Dict, as there&#39;s no way of knowning which element caused the
&gt; validation process to fail. That has significant repercussions.
</div>
The biggest thing you usually want to know is *whether* it failed.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; You can&#39;t use coerced types in slurpy Dict&#39;s used to provide named
&gt; parameters to functions in the public API.  User&#39;s have to be able
&gt; to figure out which parameter caused the problem.  Unfortunately, this
&gt; is exactly where you&#39;d want to be able to provide the flexibility that
&gt; coercions give.
</div>
The use of slurpy dicts with Type::Params is mostly a workaround for the fact that the compile/validate functions are designed for positional parameters. So it&#39;s really just considering your named parameters as a single big hashref parameter. When validation fails, it tells you exactly which parameter was the problem - the single big hashref one! :-&#41;

Ultimately this would be improved by Type::Params providing compile_named/validate_named counterparts, so that each named parameter could be coerced and validated separately. Mithaldu has also requested this. It&#39;s likely to end up as a 1.002000 feature.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.541262</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
