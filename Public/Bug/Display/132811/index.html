<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #132811 for PAR-Packer: Win32: Crash a week after start</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #132811 for PAR-Packer: Win32: Crash a week after start</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/PAR-Packer/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/PAR-Packer/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/PAR-Packer/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/PAR-Packer/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/PAR-Packer">PAR-Packer CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">132811</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/PAR-Packer/Active/">PAR-Packer</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Ralf.Neubauer [...] wido.bv.aok.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-41710-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-41711-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;12&nbsp;09:37:57&nbsp;2020</span>
    <span class="description">Ralf.Neubauer [...] wido.bv.aok.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Win32: Crash a week after start</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 12 Jun 2020 13:22:43 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-PAR-Packer [...] rt.cpan.org&#34; &lt;bug-PAR-Packer [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Neubauer, Ralf&#34; &lt;ralf.neubauer [...] wido.bv.aok.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I just found out why PAR::Packer-generated executables tend to crash when I interact with them after I started them some days ago and they stayed mostly idle in the task bar -- this also happened on Win7, but I analyzed it under Win10:

<span class="clickylink"><a target="new" rel="nofollow" href="https://support.microsoft.com/en-us/help/4506040/temp-folder-with-logon-session-id-is-deleted-unexpectedly">https://support.microsoft.com/en-us/help/4506040/temp-folder-with-logon-session-id-is-deleted-unexpectedly</a></span>

You can imagine a program behaving strange or crashing when it wants to load modules, resources or data files from its PAR_TEMP directory, but everything but the already open DLLs has vanished. I don&#39;t know exactly which windows versions are affected, but I don&#39;t want to give programs to users that suddenly crash out of nowhere, they might lose trust into the programs.

I don&#39;t know if there can be a better solution than documenting this behaviour. Of course one can set PAR_GLOBAL_TEMP or PAR_GLOBAL_TMPDIR, but you have to use wrapper scripts or an installer that find a suitable directory on the user&#39;s machine and set the variables for the process or globally -- which a bit defeats the &#39;one executable, no installer, just double-click the file I gave you&#39; purpose of PAR::Packer. So the workaround I found is &#40;without the Win32API::File-doesn&#39;t-exist-on-non-Win32 handling&#41;:

  if &#40;&#39;CODE&#39; eq ref $INC[-1] &#38;&#38; $^O eq &#39;MSWin32&#39; &#38;&#38; !$ENV{PAR_GLOBAL_TEMP} &#38;&#38; !$ENV{PAR_GLOBAL_TMPDIR}&#41; {
    use File::Find;
    use Win32API::File qw&#40;:ALL&#41;;
    #use threads;
    #&#40;async
    {
      no warnings &#39;File::Find&#39;;
      find +{
             no_chdir =&gt; 1,
             wanted =&gt; sub {
               # ignore result, handle stays open until program terminates
               -f and createFile $_, &#39;r ke&#39;, &#39;rw&#39;;
             },
            }, $ENV{PAR_TEMP};
    }
    #&#41;-&gt;detach;
  }

Is there a better way?

Mit freundlichen Grüßen
Ralf
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;12&nbsp;19:44:29&nbsp;2020</span>
    <span class="description">SLAFFAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is related to <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=101800">https://rt.cpan.org/Public/Bug/Display.html?id=101800</a></span> 

Shawn.


On Fri Jun 12 09:37:57 2020, Ralf.Neubauer@wido.bv.aok.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; I just found out why PAR::Packer-generated executables tend to crash
&gt; when I interact with them after I started them some days ago and they
&gt; stayed mostly idle in the task bar -- this also happened on Win7, but
&gt; I analyzed it under Win10:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://support.microsoft.com/en-us/help/4506040/temp-folder-with-">https://support.microsoft.com/en-us/help/4506040/temp-folder-with-</a></span>
&gt; logon-session-id-is-deleted-unexpectedly
&gt; 
&gt; You can imagine a program behaving strange or crashing when it wants
&gt; to load modules, resources or data files from its PAR_TEMP directory,
&gt; but everything but the already open DLLs has vanished. I don&#39;t know
&gt; exactly which windows versions are affected, but I don&#39;t want to give
&gt; programs to users that suddenly crash out of nowhere, they might lose
&gt; trust into the programs.
&gt; 
&gt; I don&#39;t know if there can be a better solution than documenting this
&gt; behaviour. Of course one can set PAR_GLOBAL_TEMP or PAR_GLOBAL_TMPDIR,
&gt; but you have to use wrapper scripts or an installer that find a
&gt; suitable directory on the user&#39;s machine and set the variables for the
&gt; process or globally -- which a bit defeats the &#39;one executable, no
&gt; installer, just double-click the file I gave you&#39; purpose of
&gt; PAR::Packer. So the workaround I found is &#40;without the Win32API::File-
&gt; doesn&#39;t-exist-on-non-Win32 handling&#41;:
&gt; 
&gt; if &#40;&#39;CODE&#39; eq ref $INC[-1] &#38;&#38; $^O eq &#39;MSWin32&#39; &#38;&#38;
&gt; !$ENV{PAR_GLOBAL_TEMP} &#38;&#38; !$ENV{PAR_GLOBAL_TMPDIR}&#41; {
&gt;   use File::Find;
&gt;   use Win32API::File qw&#40;:ALL&#41;;
&gt;   #use threads;
&gt;   #&#40;async
&gt;   {
&gt;     no warnings &#39;File::Find&#39;;
&gt;     find +{
&gt;            no_chdir =&gt; 1,
&gt;            wanted =&gt; sub {
&gt;              # ignore result, handle stays open until program
&gt; terminates
&gt;              -f and createFile $_, &#39;r ke&#39;, &#39;rw&#39;;
&gt;            },
&gt;           }, $ENV{PAR_TEMP};
&gt;   }
&gt;   #&#41;-&gt;detach;
&gt; }
&gt; 
&gt; Is there a better way?
&gt; 
&gt; Mit freundlichen Grüßen
&gt; Ralf
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;12&nbsp;19:44:30&nbsp;2020</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;12&nbsp;21:35:12&nbsp;2020</span>
    <span class="description">Ralf.Neubauer [...] wido.bv.aok.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #132811] Win32: Crash a week after start</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 13 Jun 2020 01:34:59 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-PAR-Packer [...] rt.cpan.org&#34; &lt;bug-PAR-Packer [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Neubauer, Ralf&#34; &lt;ralf.neubauer [...] wido.bv.aok.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This is related to <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=101800">https://rt.cpan.org/Public/Bug/Display.html?id=101800</a></span>
</div>
Yes and no. _CANARY_.txt exists and the directory will be repopulated on the next start of the program, so there is no problem except having to unpack the files again between runs of the program. My problem on the other hand is, that I start the program and the files are deleted while it is running. My crude protection scheme &#40;locking all of the files -- 3500 files in my case, which only works with Windows file handles since Perl only gets the 2048 file handles implemented by the Windows libc&#41; only protects the files while the program is running, so _CANARY_.txt is still needed &#40;and there is a short time window at the start of the program, inbetween starting the unpacking and locking the files, where files could still vanish if you are unlucky enough to have cleanmgr.exe run at exactly the same time.

Using a non-temp-directory would solve both problems but carries some problems on its own, see original message. Declaring %TEMP% to be a non-temp directory sounds strange. Raising the existence interval only makes it less bad, but doesn&#39;t solve it. Also you have to have administrator privilege for both.

I also thought about keeping the files fresh by manipulating their timestamps, that also doesn&#39;t really solve it, but reflects the truth that the files have been used very recently. The would be easy but time-consuming on startup &#40;and make _CANARY_.txt obsolete&#41;. To solve the runtime problems you would have to spawn a parallel job to keep the files fresh every couple of hours.

In essence, the reason is the same, but I don&#39;t see a simultaneous solution for both aspects that doesn&#39;t require user oder administrator input.

Mit freundlichen Grüßen                         

Ralf
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;12&nbsp;22:04:55&nbsp;2020</span>
    <span class="description">SLAFFAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jun 12 21:35:12 2020, Ralf.Neubauer@wido.bv.aok.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi.
&gt; 
<div class="message-stanza open">&gt; &gt; This is related to
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=101800">https://rt.cpan.org/Public/Bug/Display.html?id=101800</a></span>
</div>&gt; 
&gt; Yes and no. _CANARY_.txt exists and the directory will be repopulated
&gt; on the next start of the program, so there is no problem except having
&gt; to unpack the files again between runs of the program. My problem on
&gt; the other hand is, that I start the program and the files are deleted
&gt; while it is running. My crude protection scheme &#40;locking all of the
&gt; files -- 3500 files in my case, which only works with Windows file
&gt; handles since Perl only gets the 2048 file handles implemented by the
&gt; Windows libc&#41; only protects the files while the program is running, so
&gt; _CANARY_.txt is still needed &#40;and there is a short time window at the
&gt; start of the program, inbetween starting the unpacking and locking the
&gt; files, where files could still vanish if you are unlucky enough to
&gt; have cleanmgr.exe run at exactly the same time.
&gt; 
&gt; Using a non-temp-directory would solve both problems but carries some
&gt; problems on its own, see original message. Declaring %TEMP% to be a
&gt; non-temp directory sounds strange. Raising the existence interval only
&gt; makes it less bad, but doesn&#39;t solve it. Also you have to have
&gt; administrator privilege for both.
&gt; 
&gt; I also thought about keeping the files fresh by manipulating their
&gt; timestamps, that also doesn&#39;t really solve it, but reflects the truth
&gt; that the files have been used very recently. The would be easy but
&gt; time-consuming on startup &#40;and make _CANARY_.txt obsolete&#41;. To solve
&gt; the runtime problems you would have to spawn a parallel job to keep
&gt; the files fresh every couple of hours.
&gt; 
&gt; In essence, the reason is the same, but I don&#39;t see a simultaneous
&gt; solution for both aspects that doesn&#39;t require user oder administrator
&gt; input.
&gt; 
&gt; Mit freundlichen Grüßen
&gt; 
&gt; Ralf
</div>
Yes, the canary file only helps in cases where files are deleted between program runs or where files only need to be read at startup.  

The regular temp file cleanup will also impact all users in that the PAR archive needs to be unpacked each time it is cleaned up, causing a slow user experience for large archives at startup.

FWIW, I&#39;d be OK if the default PAR_TEMP location was in the user&#39;s home dir or under C:\ProgramData &#40;$ENV{PROGRAMDATA}&#41;.  The latter might have issues on shared machines depending on how the unpacked files are used, though.

Shawn.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;13&nbsp;02:59:53&nbsp;2020</span>
    <span class="description">SLAFFAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jun 12 22:04:55 2020, SLAFFAN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Jun 12 21:35:12 2020, Ralf.Neubauer@wido.bv.aok.de wrote:
<div class="message-stanza open">&gt; &gt; Hi.
&gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; This is related to
&gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=101800">https://rt.cpan.org/Public/Bug/Display.html?id=101800</a></span>
</div>&gt; &gt;
&gt; &gt; Yes and no. _CANARY_.txt exists and the directory will be repopulated
&gt; &gt; on the next start of the program, so there is no problem except
&gt; &gt; having
&gt; &gt; to unpack the files again between runs of the program. My problem on
&gt; &gt; the other hand is, that I start the program and the files are deleted
&gt; &gt; while it is running. My crude protection scheme &#40;locking all of the
&gt; &gt; files -- 3500 files in my case, which only works with Windows file
&gt; &gt; handles since Perl only gets the 2048 file handles implemented by the
&gt; &gt; Windows libc&#41; only protects the files while the program is running,
&gt; &gt; so
&gt; &gt; _CANARY_.txt is still needed &#40;and there is a short time window at the
&gt; &gt; start of the program, inbetween starting the unpacking and locking
&gt; &gt; the
&gt; &gt; files, where files could still vanish if you are unlucky enough to
&gt; &gt; have cleanmgr.exe run at exactly the same time.
&gt; &gt;
&gt; &gt; Using a non-temp-directory would solve both problems but carries some
&gt; &gt; problems on its own, see original message. Declaring %TEMP% to be a
&gt; &gt; non-temp directory sounds strange. Raising the existence interval
&gt; &gt; only
&gt; &gt; makes it less bad, but doesn&#39;t solve it. Also you have to have
&gt; &gt; administrator privilege for both.
&gt; &gt;
&gt; &gt; I also thought about keeping the files fresh by manipulating their
&gt; &gt; timestamps, that also doesn&#39;t really solve it, but reflects the truth
&gt; &gt; that the files have been used very recently. The would be easy but
&gt; &gt; time-consuming on startup &#40;and make _CANARY_.txt obsolete&#41;. To solve
&gt; &gt; the runtime problems you would have to spawn a parallel job to keep
&gt; &gt; the files fresh every couple of hours.
&gt; &gt;
&gt; &gt; In essence, the reason is the same, but I don&#39;t see a simultaneous
&gt; &gt; solution for both aspects that doesn&#39;t require user oder
&gt; &gt; administrator
&gt; &gt; input.
&gt; &gt;
&gt; &gt; Mit freundlichen Grüßen
&gt; &gt;
&gt; &gt; Ralf
</div>&gt; 
&gt; Yes, the canary file only helps in cases where files are deleted
&gt; between program runs or where files only need to be read at startup.
&gt; 
&gt; The regular temp file cleanup will also impact all users in that the
&gt; PAR archive needs to be unpacked each time it is cleaned up, causing a
&gt; slow user experience for large archives at startup.
&gt; 
&gt; FWIW, I&#39;d be OK if the default PAR_TEMP location was in the user&#39;s
&gt; home dir or under C:\ProgramData &#40;$ENV{PROGRAMDATA}&#41;.  The latter
&gt; might have issues on shared machines depending on how the unpacked
&gt; files are used, though.
&gt; 
&gt; Shawn.
</div>
$ENV{APPDATA} would be better than $ENV{PROGRAMDATA}

It is easy enough to add to mktmpdir.c for Windows builds, so I can work up a PR if Roderich is in favour of the idea.  
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;13&nbsp;06:44:03&nbsp;2020</span>
    <span class="description">Ralf.Neubauer [...] wido.bv.aok.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #132811] Win32: Crash a week after start</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 13 Jun 2020 10:43:54 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-PAR-Packer [...] rt.cpan.org&#34; &lt;bug-PAR-Packer [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Neubauer, Ralf&#34; &lt;ralf.neubauer [...] wido.bv.aok.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; FWIW, I&#39;d be OK if the default PAR_TEMP location was in the user&#39;s
&gt; &gt; home dir or under C:\ProgramData &#40;$ENV{PROGRAMDATA}&#41;.  The latter
&gt; &gt; might have issues on shared machines depending on how the unpacked
&gt; &gt; files are used, though.
</div>&gt;
&gt; $ENV{APPDATA} would be better than $ENV{PROGRAMDATA}
&gt;
&gt; It is easy enough to add to mktmpdir.c for Windows builds, so I can work up a PR if Roderich is in favour of the idea.  
</div>
What is your concept for getting rid of old PAR_TEMP locations once you get &#40;or create&#41; an updated version of the application or just stop using it? Explicit deinstallation &#40;maybe by using a special argument or variable when calling this version&#41;? An own version of &#39;delete old files&#39; but with a longer timeout and using a better protocol for detecting the last use and removing only whole directories? Giving the user better hints than cryptic directory names with cryptic files in it, that he can decide which dirs to purge manually? This could be implemented by description files or by a version manager.

Explicit deinstallation could be paired with explicit installation -- the application only unpacks intelf into a permanent location, if you explicely tell it to do so, in a way every user understands.

Mit freundlichen Grüßen                         

Ralf Neubauer
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;13&nbsp;18:45:02&nbsp;2020</span>
    <span class="description">SLAFFAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Jun 13 06:44:03 2020, Ralf.Neubauer@wido.bv.aok.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi.
&gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; FWIW, I&#39;d be OK if the default PAR_TEMP location was in the user&#39;s
&gt; &gt; &gt; home dir or under C:\ProgramData &#40;$ENV{PROGRAMDATA}&#41;.  The latter
&gt; &gt; &gt; might have issues on shared machines depending on how the unpacked
&gt; &gt; &gt; files are used, though.
</div>&gt; &gt;
&gt; &gt; $ENV{APPDATA} would be better than $ENV{PROGRAMDATA}
&gt; &gt;
&gt; &gt; It is easy enough to add to mktmpdir.c for Windows builds, so I can
&gt; &gt; work up a PR if Roderich is in favour of the idea.
</div>&gt; 
&gt; What is your concept for getting rid of old PAR_TEMP locations once
&gt; you get &#40;or create&#41; an updated version of the application or just stop
&gt; using it? Explicit deinstallation &#40;maybe by using a special argument
&gt; or variable when calling this version&#41;? An own version of &#39;delete old
&gt; files&#39; but with a longer timeout and using a better protocol for
&gt; detecting the last use and removing only whole directories? Giving the
&gt; user better hints than cryptic directory names with cryptic files in
&gt; it, that he can decide which dirs to purge manually? This could be
&gt; implemented by description files or by a version manager.
&gt; 
&gt; Explicit deinstallation could be paired with explicit installation --
&gt; the application only unpacks intelf into a permanent location, if you
&gt; explicely tell it to do so, in a way every user understands.
&gt; 
&gt; Mit freundlichen Grüßen
&gt; 
&gt; Ralf Neubauer
</div>

Currently there is no removal of old PAR archives that I am aware of.  Removal is left to the user or automated processes.  

It could be done manually using PAR_GLOBAL_CLEAN at the cost of running the exe.  e.g. for some_archive.exe this could be packed into an uninstall.bat:

  set PAR_GLOBAL_CLEAN=1
  some_archive.exe

Maybe this could be added to PAR so it does not run the exe and just does the cleanup, e.g.:

some_archive.exe --run-par-cleanup

It&#39;s probably conceptually simpler for the user if it is a separate process, though.  

It would also be possible to add that logic to your own perl script so it can exit without doing anything, but it might be too late by the time that is loaded.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;13&nbsp;23:32:46&nbsp;2020</span>
    <span class="description">SLAFFAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Jun 13 18:45:02 2020, SLAFFAN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sat Jun 13 06:44:03 2020, Ralf.Neubauer@wido.bv.aok.de wrote:
<div class="message-stanza open">&gt; &gt; Hi.
&gt; &gt;
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; FWIW, I&#39;d be OK if the default PAR_TEMP location was in the
&gt; &gt; &gt; &gt; user&#39;s
&gt; &gt; &gt; &gt; home dir or under C:\ProgramData &#40;$ENV{PROGRAMDATA}&#41;.  The latter
&gt; &gt; &gt; &gt; might have issues on shared machines depending on how the
&gt; &gt; &gt; &gt; unpacked
&gt; &gt; &gt; &gt; files are used, though.
</div>&gt; &gt; &gt;
&gt; &gt; &gt; $ENV{APPDATA} would be better than $ENV{PROGRAMDATA}
&gt; &gt; &gt;
&gt; &gt; &gt; It is easy enough to add to mktmpdir.c for Windows builds, so I can
&gt; &gt; &gt; work up a PR if Roderich is in favour of the idea.
</div>&gt; &gt;
&gt; &gt; What is your concept for getting rid of old PAR_TEMP locations once
&gt; &gt; you get &#40;or create&#41; an updated version of the application or just
&gt; &gt; stop
&gt; &gt; using it? Explicit deinstallation &#40;maybe by using a special argument
&gt; &gt; or variable when calling this version&#41;? An own version of &#39;delete old
&gt; &gt; files&#39; but with a longer timeout and using a better protocol for
&gt; &gt; detecting the last use and removing only whole directories? Giving
&gt; &gt; the
&gt; &gt; user better hints than cryptic directory names with cryptic files in
&gt; &gt; it, that he can decide which dirs to purge manually? This could be
&gt; &gt; implemented by description files or by a version manager.
&gt; &gt;
&gt; &gt; Explicit deinstallation could be paired with explicit installation --
&gt; &gt; the application only unpacks intelf into a permanent location, if you
&gt; &gt; explicely tell it to do so, in a way every user understands.
&gt; &gt;
&gt; &gt; Mit freundlichen Grüßen
&gt; &gt;
&gt; &gt; Ralf Neubauer
</div>&gt; 
&gt; 
&gt; Currently there is no removal of old PAR archives that I am aware of.
&gt; Removal is left to the user or automated processes.
&gt; 
&gt; It could be done manually using PAR_GLOBAL_CLEAN at the cost of
&gt; running the exe.  e.g. for some_archive.exe this could be packed into
&gt; an uninstall.bat:
&gt; 
&gt; set PAR_GLOBAL_CLEAN=1
&gt; some_archive.exe
&gt; 
&gt; Maybe this could be added to PAR so it does not run the exe and just
&gt; does the cleanup, e.g.:
&gt; 
&gt; some_archive.exe --run-par-cleanup
&gt; 
&gt; It&#39;s probably conceptually simpler for the user if it is a separate
&gt; process, though.
&gt; 
&gt; It would also be possible to add that logic to your own perl script so
&gt; it can exit without doing anything, but it might be too late by the
&gt; time that is loaded.
</div>
I&#39;ve run some testing and neither approach works.  When PAR_GLOBAL_TEMP is set before running the exe, the archive is unpacked into a different folder named like temp-12345 and cleaned up on exit.  Setting it in a BEGIN block within the packed script appears too late to have any effect.  Presumably the environment is localised or some other flag is set by PAR at startup to check on exit.

It looks like a separate uninstaller is needed, although it would need to ensure it does not remove files from under a running process, as otherwise it is another example of the original reported issue.

Shawn.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;14&nbsp;11:24:18&nbsp;2020</span>
    <span class="description">RSCHUPP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> Ralf.Neubauer [...] wido.bv.aok.de</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2020-06-13 02:59:53, SLAFFAN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; $ENV{APPDATA} would be better than $ENV{PROGRAMDATA}
&gt; 
&gt; It is easy enough to add to mktmpdir.c for Windows builds, so I can
&gt; work up a PR if Roderich is in favour of the idea.
</div>
Go for it :&#41; I suggest &#34;$ENV{APPDATA}/Local/pp&#34; and maybe we may omit the per-user sub directory
in this case &#40;as %APPDATA% should already be per-user&#41;. Maybe drop the ancient fallback to C:\TEMP 
&#40;and the really weird %WinDir%\temp&#41; as well.

Keep in mind that par_mktmpdir in myldr/mktmpdir.c has a perl-level sibling _set_par_temp in script/par.pl.

Cheers, Roderich
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;14&nbsp;11:49:03&nbsp;2020</span>
    <span class="description">RSCHUPP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2020-06-13 06:44:03, Ralf.Neubauer@wido.bv.aok.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; What is your concept for getting rid of old PAR_TEMP locations once
&gt; you get &#40;or create&#41; an updated version of the application or just stop
&gt; using it?
</div>
There is none.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Explicit deinstallation &#40;maybe by using a special argument
&gt; or variable when calling this version&#41;? 
</div>
Nope. PAR::Packer is expressly designed to work WITHOUT installation and tacking on stuff
is out of the question - there are already too many special arguments/variables.
If you want installation/deinstallation look somewhere else.

Cheers, Roderich
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;14&nbsp;16:21:45&nbsp;2020</span>
    <span class="description">Ralf.Neubauer [...] wido.bv.aok.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #132811] Win32: Crash a week after start</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 14 Jun 2020 20:21:34 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-PAR-Packer [...] rt.cpan.org&#34; &lt;bug-PAR-Packer [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Neubauer, Ralf&#34; &lt;ralf.neubauer [...] wido.bv.aok.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Roderich Schupp via RT &lt;bug-PAR-Packer@rt.cpan.org&gt; 
<div class="message-stanza open">&gt;
&gt; On 2020-06-13 06:44:03, Ralf.Neubauer@wido.bv.aok.de wrote:
<div class="message-stanza open">&gt; &gt; What is your concept for getting rid of old PAR_TEMP locations once
&gt; &gt; you get &#40;or create&#41; an updated version of the application or just stop
&gt; &gt; using it?
</div>&gt;
&gt; There is none.
</div>
This question was meant to be an answer  to Shawns ideas. He devised de-facto-installation and I wanted to hear the fully thought out story from him.
If the files are in %TEMP% someday someone will come along and clean up, because it is a known place for cleaning up potential. No one will look into Appdata/pp if the disk fills up. 

<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; Explicit deinstallation &#40;maybe by using a special argument
&gt; &gt; or variable when calling this version&#41;? 
</div>&gt;
&gt; Nope. PAR::Packer is expressly designed to work WITHOUT installation and tacking on stuff
&gt; is out of the question - there are already too many special arguments/variables.
&gt; If you want installation/deinstallation look somewhere else.
</div>
Unpacking into something else than %TEMP% is de facto installation. I don&#39;t want installation, but if the archive de facto installs itself into a hidden permanent directory, there should be some help for the user to keep the space usage under control. Sometimes I create new versions every couple of days and if people run that, their disks will fill up. Completely ignoring the problem means the deinstallation process is to manually clean the correct ones of a big collections of directories with cryptic names from a not-so-well-know subdirectory of Appdata. I read most of the source of the package and still hope there can be some middle ground to make it a bit easier for the users. One of my suggestions was to at least describe the contents of the directories, for every cache-xyz/ there could be a cache-xyz-description.txt which lists the name of the application, the date of unpacking. And maybe the timestamp of cache-xyz/ and cache-xyz-description.txt should be set to the current time every time the application is started, that would make it possible to find the old unused entries with a sorted directory listing.

As an alternative to Shawns solution you could also unpack into %TEMP% like before, but set a timestamp some interval &#40;e.g. 6 months&#41; in the future for all files every time the application starts, that would most likely also protect the files.

Mit freundlichen Grüßen                         

Ralf

</div></div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
