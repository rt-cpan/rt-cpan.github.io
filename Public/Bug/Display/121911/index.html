<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #121911 for PDF-API2: Adding pages to existing documents doesn&#39;t work if page tree is anything but very simple &#40;+ maybe fixed&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #121911 for PDF-API2: Adding pages to existing documents doesn&#39;t work if page tree is anything but very simple &#40;+ maybe fixed&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/PDF-API2/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/PDF-API2">PDF-API2 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">121911</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/PDF-API2/Active/">PDF-API2</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
futuramedium [...] yandex.ru

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-24958-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.031    </td>
  </tr>
  <tr id="CF-24959-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
2.034    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;27&nbsp;09:04:13&nbsp;2017</span>
    <span class="description">futuramedium [...] yandex.ru -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Adding pages to existing documents doesn&#39;t work if page tree is
 anything but very simple &#40;+ maybe fixed&#41;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use warnings;
use feature &#39;say&#39;;
use PDF::API2;

my $pdf = PDF::API2-&gt; open&#40; &#39;sample.pdf&#39; &#41;;
$pdf-&gt; page;
$pdf-&gt; saveas&#40; &#39;sample+.pdf&#39; &#41;;

Can&#39;t call method &#34;new_obj&#34; on an undefined value at C:/PDL24/perl/site/lib/PDF/API2/Basic/PDF/Pages.pm line 95.

Sample.pdf is attached. Its &#39;Pages&#39; root has a single intermediate node, which further has 11 leaves i.e. pages.

&#39;Pages&#39; are blessed in line 521 of PDF::API2::Basic::PDF::File, i.e. not in constructor of PDF::API2::Basic::PDF::Pages. In line 61 of latter module there&#39;s assignment to &#39; outto&#39; property. If file is opened, this property is never assigned. But in line 207 it is used to create intermediate node. Hence, the above error message.

I suggest adding after line 521 in PDF::API2::Basic::PDF::File:

$result-&gt; {&#39; outto&#39;} = [ $self ];

Then script completes, but blank page is prepended &#40;??&#41;. It looks like this problem is in line 213 of PDF::API2::Basic::PDF::Pages. Condition is always false, it should be changed to

$pindex = -1 if &#40;$pindex == $ppnum - 1&#41;;

Then document is modified as expected. I didn&#39;t test these fixes extensively, because I don&#39;t yet understand fully internal mechanics of this module.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> sample.pdf</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;29&nbsp;07:34:01&nbsp;2017</span>
    <span class="description">futuramedium [...] yandex.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> futuramedium [...] yandex.ru</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">No, still not good enough. Adding another page in above script, i.e. duplicating &#34;$pdf-&gt; page;&#34; results in broken PDF file. Looks like increment statement in &#34;for&#34; loop in line 192 of PDF::API2::Basic::PDF::Pages reads from file and thus previously made changes to object in memory are lost.

I think if object already was &#39; realised&#39;, then it should not be read again. Is that what this flag is for? Then the whole &#34;realise&#34; method of PDF::API2::Basic::PDF::Objind -- line 157 -- should be replaced with:

sub realise {
    my &#40; $self &#41; = @_;

    return $self if $self-&gt; { &#39; realised&#39; } or
                   !$self-&gt; { &#39; objnum&#39; };
    
    $self-&gt; { &#39; realised&#39; } = 1;
    $self-&gt; { &#39; parent&#39; }-&gt; read_obj&#40; $self &#41;
}

Further, line 539 of PDF::API2::Basic::PDF::File should be deleted &#40;commented out&#41;, because it just makes no sense &#40;??&#41;.

With these changes it seems to work, but it requires more tests from someone who understands internal logic of this distribution.

And, change to line 213 in report above should be duplicated, for the same reason, in line 188 of PDF::API2::Basic::PDF::Pages.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;29&nbsp;09:58:34&nbsp;2017</span>
    <span class="description">futuramedium [...] yandex.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> futuramedium [...] yandex.ru</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry, I forgot about related issue: the PDF::API2::Basic::PDF::Pages::rebuild_tree is a no-op, and its return contradicts to what POD says.

+ Speaking about strange code fragments &#40;unrelated issue&#41;. What does line 815 of PDF::API2::Basic::PDF::File was supposed to do?

+ Another unrelated issue: lines 163-181 of PDF::API2::Basic::PDF::Dict are meant to replace LZWDecode with FlateDecode, preventing second FlateDecode in Filter array. But this fragment will never work.

&#40;1&#41; It assumes Filter is always an array.
&#40;2&#41; Splicing is performed on array that is just not used further. I think @filters array was intended to be spliced.
&#40;3&#41; If LZWDecode happens before FlateDecode, it&#39;s just replaced with FlateDecode. If there was another FlateDecode further in array, there&#39;ll be two of them.
&#40;4&#41; If LZWDecode happens after FlateDecode, it&#39;s not pushed to @filters. And what is supposedly spliced later, is some other different filter.

Ehm, maybe it&#39;s better be replaced with:

@filters = map { $_-&gt; val } ref $self-&gt; { Filter }{ &#39; val&#39; } eq &#39;ARRRAY&#39;
    ? @{ $self-&gt; { Filter }{ &#39; val&#39; }}
    : &#40; $self-&gt; { Filter }&#41;;
my $hasflate = grep { /^FlateDecode$/ } @filters;
@filters = map { 
    s/^LZWDecode$/FlateDecode/ &#38;&#38; $hasflate 
        ? &#40;&#41; 
        : &#34;PDF::API2::Basic::PDF::Filter::$_&#34;-&gt; new 
} @filters;

But of course there hardly exists a PDF file with both LZWDecode and FlateDecode in Filter array.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;22&nbsp;11:49:26&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This one is difficult to figure out, because 1&#41; it folds many different issues into one report, and some may duplicate or have been fixed in other bug reports &#40;almost two years since the last update by OP&#41;, and 2&#41; reference only to line numbers are difficult to locate when the underlying code has been changed &#40;especially a problem in PDF::Builder, which has had many updates&#41;. It would help if the OP could a&#41; clearly split this into separate bugs &#40;perhaps even closing this report and opening multiple others&#41;, b&#41; confirm that the problems still exist in the latest releases of API2 and Builder, and c&#41; give a few lines of code rather than just a line number, to assist coders in figuring out what&#39;s going on. Then it would have a chance of being resolved. Thank you!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;22&nbsp;11:49:27&nbsp;2019</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;26&nbsp;05:53:30&nbsp;2019</span>
    <span class="description">futuramedium [...] yandex.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, Phil. You are right, I shouldn&#39;t have piled everything up in single thread, thus messing everything and making life difficult for maintainers. Don&#39;t know what I was thinking about, sorry. Using line numbers seemed good idea, sorry about it, too.

Please disregard previous message, i.e. #1730162 completely, they are bunch of small unrelated issues. Maybe I&#39;ll address them later elsewhere. The problem in original post, however, is still present. Can I re-phrase it more clearly here, without creating a fresh ticket? I.e. can I save this thread? 

Comparing code &#40;line numbers&#41; between 2.031 and current 2.033, I&#39;m suggesting same patches, actually. Please find test file in OP.

use strict;
use warnings;
use feature &#39;say&#39;;
use PDF::API2;

say $^V;
say $PDF::API2::VERSION;

my $pdf = PDF::API2-&gt; open&#40; &#39;sample.pdf&#39; &#41;;
$pdf-&gt; page;
$pdf-&gt; page;
$pdf-&gt; page;
$pdf-&gt; saveas&#40; &#39;sample+.pdf&#39; &#41;;

__END__

v5.26.0
2.033
Can&#39;t call method &#34;new_obj&#34; on an undefined value at C:/berrybrew/5.26.0_64_PDL/perl/site/lib/PDF/API2/Basic/PDF/Pages.pm line 98.

After applying 3 patches, the program above completes successfully, and PDF file is modified as expected.




On Fri Mar 22 11:49:26 2019, PMPERRY wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This one is difficult to figure out, because 1&#41; it folds many
&gt; different issues into one report, and some may duplicate or have been
&gt; fixed in other bug reports &#40;almost two years since the last update by
&gt; OP&#41;, and 2&#41; reference only to line numbers are difficult to locate
&gt; when the underlying code has been changed &#40;especially a problem in
&gt; PDF::Builder, which has had many updates&#41;. It would help if the OP
&gt; could a&#41; clearly split this into separate bugs &#40;perhaps even closing
&gt; this report and opening multiple others&#41;, b&#41; confirm that the problems
&gt; still exist in the latest releases of API2 and Builder, and c&#41; give a
&gt; few lines of code rather than just a line number, to assist coders in
&gt; figuring out what&#39;s going on. Then it would have a chance of being
&gt; resolved. Thank you!
</div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> File.diff.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- PDF\API2\Basic\PDF\File.old	Fri Jul  7 04:53:59 2017
+++ PDF\API2\Basic\PDF\File.pm	Tue Mar 26 12:20:06 2019
@@ -522,6 +522,7 @@
 
         if &#40;defined $result-&gt;{&#39;Type&#39;} and defined $types{$result-&gt;{&#39;Type&#39;}-&gt;val}&#41; {
             bless $result, $types{$result-&gt;{&#39;Type&#39;}-&gt;val};
+            $result-&gt; {&#39; outto&#39;} = [ $self ];
         }
         # gdj: FIXME: if any of the ws chars were crs, then the whole
         # string might not have been read.
@@ -540,7 +541,7 @@
         }
         $result-&gt;{&#39; parent&#39;} = $self;
         weaken $result-&gt;{&#39; parent&#39;};
-        $result-&gt;{&#39; realised&#39;} = 0;
+#??        $result-&gt;{&#39; realised&#39;} = 0;
         # gdj: FIXME: if any of the ws chars were crs, then the whole
         # string might not have been read.
     }

</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Objind.diff.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- PDF\API2\Basic\PDF\Objind.old	Fri Jul  7 04:53:59 2017
+++ PDF\API2\Basic\PDF\Objind.pm	Tue Mar 26 12:11:42 2019
@@ -154,7 +154,13 @@
 =cut
 
 sub realise {
-    $_[0]-&gt;{&#39; realised&#39;} ? $_[0] : $_[0]-&gt;{&#39; objnum&#39;} ? $_[0]-&gt;{&#39; parent&#39;}-&gt;read_obj&#40;@_&#41; : $_[0];
+    my &#40; $self &#41; = @_;
+
+    return $self if $self-&gt; { &#39; realised&#39; } or
+                   !$self-&gt; { &#39; objnum&#39; };
+    
+    $self-&gt; { &#39; realised&#39; } = 1;
+    $self-&gt; { &#39; parent&#39; }-&gt; read_obj&#40; $self &#41;
 }
 
 =head2 $r-&gt;outobjdeep&#40;$fh, $pdf&#41;

</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Pages.diff.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- PDF\API2\Basic\PDF\Pages.old	Fri Jul  7 04:53:59 2017
+++ PDF\API2\Basic\PDF\Pages.pm	Tue Mar 26 12:24:25 2019
@@ -191,7 +191,7 @@
     {
         for &#40;$pindex = 0; $pindex &lt; $ppnum; $pindex++&#41;
         { last if &#40;$ppages-&gt;{&#39;Kids&#39;}{&#39; val&#39;}[$pindex] eq $ppage&#41;; }
-        $pindex = -1 if &#40;$pindex == $ppnum&#41;;
+        $pindex = -1 if &#40;$pindex == $ppnum - 1&#41;;
     }
 
     $ppages-&gt;add_page_recurse&#40;$page-&gt;realise, $pindex&#41;;
@@ -216,7 +216,7 @@
             $ppnum = scalar $ppages-&gt;{&#39;Kids&#39;}-&gt;realise-&gt;elementsof;
             for &#40;$pindex = 0; $pindex &lt; $ppnum; $pindex++&#41;
             { last if &#40;$ppages-&gt;{&#39;Kids&#39;}{&#39; val&#39;}[$pindex] eq $self&#41;; }
-            $pindex = -1 if &#40;$pindex == $ppnum&#41;;
+            $pindex = -1 if &#40;$pindex == $ppnum - 1&#41;;
             $ppages-&gt;add_page_recurse&#40;$newpages, $pindex&#41;;
         }
     }

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;26&nbsp;10:25:01&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you for the update to the problem and the suggested patches. I can replicate the problem in PDF::Builder. I want to carefully investigate your suggested patches and make sure I fully understand them and am happy with them before I commit them &#40;to PDF::Builder&#39;s repository -- it&#39;s up to Steve to verify and patch on PDF::API2&#41;. It&#39;s possible I will be back here with further questions or issues, unless you want to shift the discussion over to GitHub &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/PhilterPaper/Perl-PDF-Builder/issues/66&#41;">https://github.com/PhilterPaper/Perl-PDF-Builder/issues/66&#41;</a></span>.

&#34;Can I re-phrase it more clearly here, without creating a fresh ticket? I.e. can I save this thread?&#34;

This appears to be adequate information for a fix to be made. Will this fix all the issues reported in the 121911 ticket, or should the rest of them be ignored for now &#40;i.e., are not problems, or are quite minor&#41;? I know that at least one of them &#40;the line 815&#41; was fixed long ago. Perhaps you should open one or more new tickets to deal with them, just to keep issues cleanly separated.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;28&nbsp;19:50:51&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Vadim,

I looked over your changes and have some questions. I needed to omit one of them to get the example to work &#40;to get three new pages added instead of just two&#41;.

File.pm
  I have no idea what  $result-&gt;{&#39; outto&#39;} = [ $self ]; does &#40;Dictionary entry&#41;, but it seems to be necessary. Any idea what it does?
  $result-&gt;{&#39; realised&#39;} = 0;  &#40;Indirect Object entry&#41; I don&#39;t know what it does, but it seems to be necessary &#40;to keep it&#41;. Any idea what it does? I HAD TO LEAVE THIS STATEMENT IN, OR I ONLY GOT TWO BLANK PAGES INSTEAD OF THREE. Acrobat Reader also seemed to be quite slow &#40;with two new pages&#41;, and I suspect it was repairing damage in the PDF.

Objind.pm
  $self-&gt;{&#39; realised&#39;} = 1;  looks plausible... it would make sense to set this flag in the &#34;realise&#34; routine. 
  Other than adding realised=1; to realise&#40;&#41;, your changes are the same as the original code. One thing I&#39;m wondering about is the call to read_obj&#40;@_&#41;. Normally $self as $_[0] is removed &#40;via shift&#41;, but it&#39;s left in here. $self gets added again as part of the call, so it&#39;s more or less &#40;$self, $self, any_options&#41; passed to read_obj&#40;&#41;. The second usage is $objind, which is a hash pointer, so it seems to work. It just looks odd. Does it seem correct to you?
  You just let realise&#40;&#41; &#34;run off the end&#34; &#40;as did the original code&#41;. I modified the code to explicitly return either $self or the read_obj&#40;&#41; value. It works, anyway, and perlcritic is happy.

Pages.pm
  Both your changes &#40;$pindex == $ppnum -1&#41; seem to be necessary, but I&#39;m wondering why they work. It appears that $pnum = -1 means &#34;add new page at end&#34; &#40;insert before virtual end page, not physical last page&#41;. The loop &#40;3 lines before&#41; goes through all the children and tries to match the given page number &#40;$pindex&#41;. If it matched the last one, $pindex should be $ppnum - 1. If it failed to match any, $pindex should be $ppnum, shouldn&#39;t it? Your change is to set it to -1 &#40;add after all existing pages&#41; if it matched the LAST page? Yet... it seems to work. Any idea what the author was trying to do? Is a match on one of the existing pages guaranteed? Should the test be &gt;= instead of ==?

A thousand curses on the head of the author&#40;s&#41; of this code, who couldn&#39;t be bothered to add a few comment notes on what they were doing. I guess they&#39;re of the &#34;if it was hard to write, it should be hard to read&#34; school of programming. I see in your earlier posts you repeatedly throw up your hands and are hoping that an expert will come along and explain things. Me too.

HOLD THE PHONE -- t/circular-references.t fails with these changes. I ran all the t-tests and I think this is the one failure. I haven&#39;t tried
all the examples yet. perlcritic does run clean &#40;level 5 clean, no unexpected level 4&#41;.
============================
&#34;Line 815&#34;: according to my notes, removed from PDF::API2 and PDF::Builder July 2017. That may be after the last PDF::API2 release.

&#34;rebuild_tree&#34; dummy stub and not matching POD: I fixed the POD &#40;warned coders not to use it&#41; in PDF::Builder. I guess PDF::API2 isn&#39;t fixed yet.

Does this leave only the possible LZWDecode/FlateDecode issue to be dealt with? That should probably be a new ticket so this one can be closed.
  
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;28&nbsp;22:09:03&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">By the way, my testing was with PDF::Builder, not PDF::API2, so your results may differ &#40;hopefully not&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;29&nbsp;19:55:06&nbsp;2019</span>
    <span class="description">futuramedium [...] yandex.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Your results are strange, because patches work for me, both for PDF::API2 and PDF::Buider. You either did something wrong &#40;then check again, please&#41; or, perhaps, you are working with some internal modified version.

As to questions:

1&#41; The issue with &#34;$result-&gt;{&#39; outto&#39;} = [ $self ];&#34; was described in the OP. File is either created anew or read from disk. In former case, the &#39; outto&#39; property is initialized i.e. assigned. In latter case, it is not &#40;maybe, rather, it is what&#39;s to be fixed?&#41;. All nodes in page tree seem to require this property to output themselves. 

2&#41; The &#34;$result-&gt;{&#39; realised&#39;} = 0;&#34; is useless because in all conditionals where this key is tested it is not compared to zero, but simply checked for truth. So it&#39;s OK to be non-existent. If you don&#39;t like it, then lift that line a few lines higher into &#34;unless&#34; block &#40;as original author did in &#34;copy&#34; subroutine, please find&#41;.

What I think is going on:

Suppose some object is referenced in 2 different parts of PDF, e.g. as &#34;6 0 R&#34;. When 1st fragment is parsed, Objind is created, but object #6 itself is not &#34;realized&#34; i.e. found through xref table and parsed from source. Then my program does something &#40;call it X&#41; that _does_ require this #6 to be &#34;realized&#34;. OK, and it was. Later, for any reason, 2nd fragment of &#34;6 0 R&#34; was parsed. New Objind wasn&#39;t created, but the &#39; realized&#39; flag was unset!!! Oops. Now, what if between realizing #6 and reading 2nd fragment I made any changes to #6&#39;s representation in memory? Very well. But now I do something similar &#40;or not similar, doesn&#39;t matter&#41; to &#40;X&#41; which resulted in checking if the #6 was &#34;realized&#34; and its subsequent  &#34;realization&#34;. Remember, flag has been unset, old version is _now_ parsed from source again, previous changes are lost.

3&#41; The &#34;sub realize&#34; -- I think you misread it, the invocant of &#34;read_obj&#34; is not $self, so nothing strange is happening. Explicit return is right thing to do, but, though not your fault, it can lead to ugly and impossible-to-be-correct code, e.g. subroutine &#34;val&#34; in same module. Looks suspicious in original, too. &#40;As you see, I can&#39;t help but digress.&#41;

4&#41; Pages.pm -- About this one I was absolutely wrong, sorry I have mislead anyone, my patch was invalid, new patch is attached. Thank you that you made me try to understand that code yet again. 

Two separate lines of code in question &#40;which were both modified in invalid patch&#41; look deceptively similar -- the same! But they are very different. As you see, 1st one is now left alone, because it does as described in POD: if position to insert new page is too high, then insert it last.

OTOH, in 2nd fragment &#40;the only present in suggested new patch&#41; the loop directly above is guaranteed to trigger its &#34;last&#34;, and it is only reachable if &#40;1&#41; we are adding to intermediate &#40;not root&#41; node, &#40;2&#41; it&#39;s being over-filled &#40;so, new container is added to parent&#41;, &#40;3&#41; new container is, strictly, either prepended &#40;$index == 0&#41; or appended &#40;$index == -1&#41;. So, the only thing I need to do here is to check $index and increase position to append &#40;or otherwise it would be &#34;prepending&#34;&#41;.

5&#41; As to issues with circular refs -- can&#39;t say anything for now. My &#34;in-production&#34; long-running script &#40;though it uses modified CAM::PDF, I suspect it also leaks&#41; starts asynchronously a new perl process to process each PDF file because I gave up on tracking memory, so it&#39;s reclaimed by OS, and with just thousands PDF files per day this setup OK. 

6&#41; Issue with LZWDecode/FlateDecode I&#39;d rather revoke, its probability in real world being almost zero.

Can&#39;t agree on &#34;curses on authors&#39; :&#41;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Pages.diff.new.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- PDF\API2\Basic\PDF\Pages.old	Fri Jul  7 04:53:59 2017
+++ PDF\API2\Basic\PDF\Pages.pm	Sat Mar 30 01:14:48 2019
@@ -216,7 +216,7 @@
             $ppnum = scalar $ppages-&gt;{&#39;Kids&#39;}-&gt;realise-&gt;elementsof;
             for &#40;$pindex = 0; $pindex &lt; $ppnum; $pindex++&#41;
             { last if &#40;$ppages-&gt;{&#39;Kids&#39;}{&#39; val&#39;}[$pindex] eq $self&#41;; }
-            $pindex = -1 if &#40;$pindex == $ppnum&#41;;
+            $pindex ++ if $index == -1;
             $ppages-&gt;add_page_recurse&#40;$newpages, $pindex&#41;;
         }
     }

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;30&nbsp;12:48:45&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you for the response. It may take me a few days to digest it and try out the changes -- and I also have to finish my income tax returns!

Re #3 &#40;sub realise&#41;, my point was that a method call adds a reference to its object &#40;?&#41; to the beginning of the parameter list, and usually it&#39;s immediately pulled out as &#34;$self&#34;. Leaving the original @_ alone and passing it in, you now have two references &#40;plus options stuff&#41; in the call to read_obj. The first I think is the object containing method read_obj, and the second is $self, the object containing the caller to read_obj. I really wish the author had been more straightforward and done something like:

 my $self = shift; # just option stuff left in @_
 ... use $self instead of $_[0] in calls ...
 ... -&gt;read_obj&#40;$self, @_&#41; ...

That should do the same thing as the current code, but be a lot clearer &#40;at least to me&#41;. I really despise coders who want to show off how smart they are by collapsing an entire function into one impossible-to-read line!

Re #6 &#40;compression list&#41;, OK by me to drop it for the time being. It&#39;s still archived if someone wants to revisit it in the future &#40;in the futuramedium?&#41;. So, once the primary fixes in this bug are completed, that&#39;s everything and the bug can be closed?

I will try out your latest change soon, and see what&#39;s going on. I&#39;m still worried about having to drop the realised=0 line in order to get three new pages rather than two -- that may point to other changes that are interfering. Are you testing on PDF::Builder 3.013 &#40;CPAN release&#41; or 3.014 &#40;GitHub current release&#41;? Are you running the t-test suite on your changes?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;31&nbsp;09:12:09&nbsp;2019</span>
    <span class="description">futuramedium [...] yandex.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Yes, once patches to 3 files are tested and accepted, I&#39;m for closing this bug.

I downloaded the release from GitHub, and, again, the &#34;$result-&gt;{&#39; realised&#39;} = 0;&#34; line should be removed, or otherwise invalid PDF file is produced. I&#39;m attaching 3 modified files &#40;they are for PDF::Builder distribution&#41;, if they are not working for you, then it&#39;s some mysticism.

The issue with failing test for circular references is easily fixed, see new patch attached &#40;and that&#39;s for PDF::API2 distribution&#41;. The new line is copied from Pages constructor -- this constructor is not called if PDF is &#34;opened&#34; from file.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> File.diff.new.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- PDF\API2\Basic\PDF\File.old	Fri Jul  7 04:53:59 2017
+++ PDF\API2\Basic\PDF\File.pm	Sun Mar 31 15:41:05 2019
@@ -522,6 +522,8 @@
 
         if &#40;defined $result-&gt;{&#39;Type&#39;} and defined $types{$result-&gt;{&#39;Type&#39;}-&gt;val}&#41; {
             bless $result, $types{$result-&gt;{&#39;Type&#39;}-&gt;val};
+            $result-&gt; {&#39; outto&#39;} = [ $self ];
+            weaken $_ for @{$result-&gt;{&#39; outto&#39;}};
         }
         # gdj: FIXME: if any of the ws chars were crs, then the whole
         # string might not have been read.
@@ -540,7 +542,7 @@
         }
         $result-&gt;{&#39; parent&#39;} = $self;
         weaken $result-&gt;{&#39; parent&#39;};
-        $result-&gt;{&#39; realised&#39;} = 0;
+#??        $result-&gt;{&#39; realised&#39;} = 0;
         # gdj: FIXME: if any of the ws chars were crs, then the whole
         # string might not have been read.
     }

</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> PDF.zip</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;31&nbsp;19:39:33&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Vadim,

Your latest changes &#40;including adding a &#34;weaken&#34; statement&#41; seem to be working. Thank you! Not only does your test case work, but it also passes all the t-tests, examples, contributions, and perlcritic.

Are you still doing any testing? I will wait a couple days or so, and if you have not made any further changes, commit these three files to GitHub and close the ticket &#40;for PDF::Builder&#41;. It&#39;s up to Steve what to do for PDF::API2 &#40;consider making a Pull Request?&#41;. I will probably have PDF::Builder 3.014 out on CPAN by the end of April.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;05&nbsp;09:07:40&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">FYI, this ticket&#39;s &#40;121911&#41; changes have been pushed to GitHub and will be in PDF::Builder 3.014 later this month. Thanks again, Vadim, for the hard work. Please consider making a Pull Request to Steve for PDF::Builder.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;05&nbsp;09:49:08&nbsp;2019</span>
    <span class="description">PMPERRY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Apr 05 09:07:40 2019, PMPERRY wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; FYI, this ticket&#39;s &#40;121911&#41; changes have been pushed to GitHub and
&gt; will be in PDF::Builder 3.014 later this month. Thanks again, Vadim,
&gt; for the hard work. Please consider making a Pull Request to Steve for
&gt; PDF::Builder.
</div>
...a Pull Request to Steve for PDF::API2.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;17&nbsp;16:11:22&nbsp;2019</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This was a long discussion, not all of which related to PDF::API2, so for reference I&#39;m only replying to the first two comments, though I&#39;ve read the rest.

Thanks for your test files and debugging efforts.  I just spent most of the day learning, updating, and rewriting the relevant code to improve its clarity, remove unnecessary bits, and subsequently fix the issues you raised.

Everything should be working at this point at HEAD.  If it isn&#39;t, you should at least have more descriptive variable names to work with.  :-&#41;  In addition, some of the more complicated bits &#40;like &#39; outto&#39;&#41; have been eliminated altogether.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;17&nbsp;16:11:23&nbsp;2019</span>
    <span class="description">steve [...] deefs.net -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;08&nbsp;14:50:04&nbsp;2019</span>
    <span class="description">steve [...] deefs.net -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;08&nbsp;14:50:05&nbsp;2019</span>
    <span class="description">steve [...] deefs.net -  Fixed in 2.034 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
