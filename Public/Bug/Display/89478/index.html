<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #89478 for REST-Neo4p: Create final cleanup in REST::Neo4p-&gt;disconnect&#40;&#41; to remove tmp files</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #89478 for REST-Neo4p: Create final cleanup in REST::Neo4p-&gt;disconnect&#40;&#41; to remove tmp files</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/REST-Neo4p/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/REST-Neo4p/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/REST-Neo4p/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/REST-Neo4p/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/REST-Neo4p">REST-Neo4p CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">89478</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/REST-Neo4p/Active/">REST-Neo4p</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">maj.fortinbras [...] gmail.com
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
symonsjo [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-245446-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.2101    </td>
  </tr>
  <tr id="CF-245447-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.2220    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;14&nbsp;07:58:51&nbsp;2013</span>
    <span class="description">symonsjo [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Create final cleanup in REST::Neo4p-&gt;disconnect&#40;&#41; to remove tmp files</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Currently files are created in /tmp when using REST::Neo4p::Query to parse JSON content. Although I can cleanup a lot of these files by exhausting the -&gt;fetch on the query and undef&#39;g the query, there are some files which still remain. It would be nice to implement a disconnect for REST::Neo4p which would be capable of cleaning up any remaining files.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;14&nbsp;08:00:10&nbsp;2013</span>
    <span class="description">symonsjo [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> symonsjo [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Oct 14 07:58:51 2013, symonsjo@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Currently files are created in /tmp when using REST::Neo4p::Query to
&gt; parse JSON content. Although I can cleanup a lot of these files by
&gt; exhausting the -&gt;fetch on the query and undef&#39;g the query, there are
&gt; some files which still remain. It would be nice to implement a
&gt; disconnect for REST::Neo4p which would be capable of cleaning up any
&gt; remaining files.
</div>
An example of a current script I&#39;m using can be found here: <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/CD9CEhnY">http://pastebin.com/CD9CEhnY</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;14&nbsp;08:11:48&nbsp;2013</span>
    <span class="description">symonsjo [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> symonsjo [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Oct 14 08:00:10 2013, symonsjo@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Oct 14 07:58:51 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; Currently files are created in /tmp when using REST::Neo4p::Query to
&gt; &gt; parse JSON content. Although I can cleanup a lot of these files by
&gt; &gt; exhausting the -&gt;fetch on the query and undef&#39;g the query, there are
&gt; &gt; some files which still remain. It would be nice to implement a
&gt; &gt; disconnect for REST::Neo4p which would be capable of cleaning up any
&gt; &gt; remaining files.
</div>&gt; 
&gt; An example of a current script I&#39;m using can be found here:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/CD9CEhnY">http://pastebin.com/CD9CEhnY</a></span>
</div>
Actually, since letting the program finish naturally cleans up once REST::Neo4p is collected it would be nice just to set a max file limit on the connection to keep it from overflowing, and/or override /tmp as a location for storing the files.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;14&nbsp;13:24:36&nbsp;2013</span>
    <span class="description">maj.fortinbras [...] gmail.com -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;16&nbsp;23:40:13&nbsp;2013</span>
    <span class="description">maj.fortinbras [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Oct 14 08:11:48 2013, symonsjo@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Oct 14 08:00:10 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; On Mon Oct 14 07:58:51 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; Currently files are created in /tmp when using REST::Neo4p::Query
&gt; &gt; &gt; to
&gt; &gt; &gt; parse JSON content. Although I can cleanup a lot of these files by
&gt; &gt; &gt; exhausting the -&gt;fetch on the query and undef&#39;g the query, there
&gt; &gt; &gt; are
&gt; &gt; &gt; some files which still remain. It would be nice to implement a
&gt; &gt; &gt; disconnect for REST::Neo4p which would be capable of cleaning up
&gt; &gt; &gt; any
&gt; &gt; &gt; remaining files.
</div>&gt; &gt;
&gt; &gt; An example of a current script I&#39;m using can be found here:
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/CD9CEhnY">http://pastebin.com/CD9CEhnY</a></span>
</div>&gt; 
&gt; Actually, since letting the program finish naturally cleans up once
&gt; REST::Neo4p is collected it would be nice just to set a max file limit
&gt; on the connection to keep it from overflowing, and/or override /tmp as
&gt; a location for storing the files.
</div>
Hi, thanks very much for pointing this issue out. You&#39;re having to do way too much; cleanup should just work. 

I&#39;ve uploaded v0.2110; please give this a try. If you would, try this version with your script without invoking your destroy_query and see if the tmp files are removed. 
MAJ
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;16&nbsp;23:40:13&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;05&nbsp;23:42:29&nbsp;2013</span>
    <span class="description">maj.fortinbras [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Calling this resolved; please reopen if necessary. thanks
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;05&nbsp;23:42:29&nbsp;2013</span>
    <span class="description">maj.fortinbras [...] gmail.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;05&nbsp;23:42:29&nbsp;2013</span>
    <span class="description">maj.fortinbras [...] gmail.com -  Fixed in 0.2111 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;18&nbsp;15:57:01&nbsp;2013</span>
    <span class="description">symonsjo [...] gmail.com -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;18&nbsp;16:06:10&nbsp;2013</span>
    <span class="description">symonsjo [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> symonsjo [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Nov 05 23:42:29 2013, MAJENSEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Calling this resolved; please reopen if necessary. thanks
</div>
I don&#39;t think this is resolved, in fact without destroy_query there&#39;s a whole lot more files open at once, the below result is after loading only 2500 rows.

[jsymons@larva nrls]$ perl -MREST::Neo4p -E &#39;say $REST::Neo4p::VERSION&#39;
0.126
[jsymons@larva nrls]$ ps -ef | grep extract
jsymons  20538 19391 64 20:46 pts/11   00:06:49 /usr/bin/perl -w /home/jsymons/extract_nrls.2.0.0_stable.pl --input_file RA3_All.xlsx --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span>
jsymons  21582 20114  0 20:56 pts/13   00:00:00 grep extract
[jsymons@larva nrls]$ lsof -p 20538 | grep -c &#39;/tmp/.\{10\}&#39;
38071

And once I killed the script at between 3000 &#38; 3500 rows, in tmp current there were:

[jsymons@larva nrls]$ ls -l /tmp | grep -c &#39;.\{10\}$&#39;
46498

Latest code with destory_query &#38; updated for 2.0.0 stable at <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/v3xUJFeP">http://pastebin.com/v3xUJFeP</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;18&nbsp;16:12:09&nbsp;2013</span>
    <span class="description">symonsjo [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> symonsjo [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 18 16:06:10 2013, symonsjo@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Nov 05 23:42:29 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; Calling this resolved; please reopen if necessary. thanks
</div>&gt; 
&gt; I don&#39;t think this is resolved, in fact without destroy_query there&#39;s
&gt; a whole lot more files open at once, the below result is after loading
&gt; only 2500 rows.
&gt; 
&gt; [jsymons@larva nrls]$ perl -MREST::Neo4p -E &#39;say
&gt; $REST::Neo4p::VERSION&#39;
&gt; 0.126
&gt; [jsymons@larva nrls]$ ps -ef | grep extract
&gt; jsymons  20538 19391 64 20:46 pts/11   00:06:49 /usr/bin/perl -w
&gt; /home/jsymons/extract_nrls.2.0.0_stable.pl --input_file RA3_All.xlsx
&gt; --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span>
&gt; jsymons  21582 20114  0 20:56 pts/13   00:00:00 grep extract
&gt; [jsymons@larva nrls]$ lsof -p 20538 | grep -c &#39;/tmp/.\{10\}&#39;
&gt; 38071
&gt; 
&gt; And once I killed the script at between 3000 &#38; 3500 rows, in tmp
&gt; current there were:
&gt; 
&gt; [jsymons@larva nrls]$ ls -l /tmp | grep -c &#39;.\{10\}$&#39;
&gt; 46498
&gt; 
&gt; Latest code with destory_query &#38; updated for 2.0.0 stable at
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/v3xUJFeP">http://pastebin.com/v3xUJFeP</a></span>
</div>

Just FYI, with this version info I call destroy_query the files are open only equal to the amount of rows loaded &#40;this is using the same code with the destroy_query intact&#41;, they are also unlinked from /tmp. After 59000 rows loading:

[jsymons@miyu nrls]$ ps -ef | grep extract
jsymons   3356 26122  0 21:08 pts/5    00:00:00 grep extract
jsymons  29042   963 73 13:47 pts/3    05:26:07 /usr/bin/perl -w /home/jsymons/extract_nrls.M06.pl --input_file RCB_All.xlsx --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span>
[jsymons@miyu nrls]$ lsof -p 29042 | grep -c &#39;/tmp/.\{10\}&#39;
59245
[jsymons@miyu nrls]$ perl -MREST::Neo4p -E &#39;say $REST::Neo4p::VERSION&#39;
0.2101
[jsymons@miyu nrls]$ ls /tmp | grep -c &#39;.\{10\}$&#39;
59404

P.S. sorry it took so long to get back to you I was busy performance tuning Neo4j and upgrading.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;18&nbsp;16:13:43&nbsp;2013</span>
    <span class="description">symonsjo [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> symonsjo [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 18 16:12:09 2013, symonsjo@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Dec 18 16:06:10 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; On Tue Nov 05 23:42:29 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; &gt; Calling this resolved; please reopen if necessary. thanks
</div>&gt; &gt;
&gt; &gt; I don&#39;t think this is resolved, in fact without destroy_query there&#39;s
&gt; &gt; a whole lot more files open at once, the below result is after
&gt; &gt; loading
&gt; &gt; only 2500 rows.
&gt; &gt;
&gt; &gt; [jsymons@larva nrls]$ perl -MREST::Neo4p -E &#39;say
&gt; &gt; $REST::Neo4p::VERSION&#39;
&gt; &gt; 0.126
&gt; &gt; [jsymons@larva nrls]$ ps -ef | grep extract
&gt; &gt; jsymons  20538 19391 64 20:46 pts/11   00:06:49 /usr/bin/perl -w
&gt; &gt; /home/jsymons/extract_nrls.2.0.0_stable.pl --input_file RA3_All.xlsx
&gt; &gt; --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span>
&gt; &gt; jsymons  21582 20114  0 20:56 pts/13   00:00:00 grep extract
&gt; &gt; [jsymons@larva nrls]$ lsof -p 20538 | grep -c &#39;/tmp/.\{10\}&#39;
&gt; &gt; 38071
&gt; &gt;
&gt; &gt; And once I killed the script at between 3000 &#38; 3500 rows, in tmp
&gt; &gt; current there were:
&gt; &gt;
&gt; &gt; [jsymons@larva nrls]$ ls -l /tmp | grep -c &#39;.\{10\}$&#39;
&gt; &gt; 46498
&gt; &gt;
&gt; &gt; Latest code with destory_query &#38; updated for 2.0.0 stable at
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/v3xUJFeP">http://pastebin.com/v3xUJFeP</a></span>
</div>&gt; 
&gt; 
&gt; Just FYI, with this version info I call destroy_query the files are
&gt; open only equal to the amount of rows loaded &#40;this is using the same
&gt; code with the destroy_query intact&#41;, they are also unlinked from /tmp.
&gt; After 59000 rows loading:
&gt; 
&gt; [jsymons@miyu nrls]$ ps -ef | grep extract
&gt; jsymons   3356 26122  0 21:08 pts/5    00:00:00 grep extract
&gt; jsymons  29042   963 73 13:47 pts/3    05:26:07 /usr/bin/perl -w
&gt; /home/jsymons/extract_nrls.M06.pl --input_file RCB_All.xlsx
&gt; --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span>
&gt; [jsymons@miyu nrls]$ lsof -p 29042 | grep -c &#39;/tmp/.\{10\}&#39;
&gt; 59245
&gt; [jsymons@miyu nrls]$ perl -MREST::Neo4p -E &#39;say $REST::Neo4p::VERSION&#39;
&gt; 0.2101
&gt; [jsymons@miyu nrls]$ ls /tmp | grep -c &#39;.\{10\}$&#39;
&gt; 59404
&gt; 
&gt; P.S. sorry it took so long to get back to you I was busy performance
&gt; tuning Neo4j and upgrading.
</div>

Above also on Neo4j 2.0.0 stable and code is here: <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/mS2F5iJh">http://pastebin.com/mS2F5iJh</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;18&nbsp;16:23:59&nbsp;2013</span>
    <span class="description">symonsjo [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> symonsjo [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 18 16:06:10 2013, symonsjo@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Nov 05 23:42:29 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; Calling this resolved; please reopen if necessary. thanks
</div>&gt; 
&gt; I don&#39;t think this is resolved, in fact without destroy_query there&#39;s
&gt; a whole lot more files open at once, the below result is after loading
&gt; only 2500 rows.
&gt; 
&gt; [jsymons@larva nrls]$ perl -MREST::Neo4p -E &#39;say
&gt; $REST::Neo4p::VERSION&#39;
&gt; 0.126
&gt; [jsymons@larva nrls]$ ps -ef | grep extract
&gt; jsymons  20538 19391 64 20:46 pts/11   00:06:49 /usr/bin/perl -w
&gt; /home/jsymons/extract_nrls.2.0.0_stable.pl --input_file RA3_All.xlsx
&gt; --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span>
&gt; jsymons  21582 20114  0 20:56 pts/13   00:00:00 grep extract
&gt; [jsymons@larva nrls]$ lsof -p 20538 | grep -c &#39;/tmp/.\{10\}&#39;
&gt; 38071
&gt; 
&gt; And once I killed the script at between 3000 &#38; 3500 rows, in tmp
&gt; current there were:
&gt; 
&gt; [jsymons@larva nrls]$ ls -l /tmp | grep -c &#39;.\{10\}$&#39;
&gt; 46498
&gt; 
&gt; Latest code with destory_query &#38; updated for 2.0.0 stable at
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/v3xUJFeP">http://pastebin.com/v3xUJFeP</a></span>
</div>

^without destroy_query
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;18&nbsp;20:42:30&nbsp;2013</span>
    <span class="description">maj.fortinbras [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ok, I will think a bit harder about this. 

In the latest version &#40;0.2222&#41;, there are a couple of things that might help. If you have thousands of files open, then presumably there are thousands of live query objects &#40;without destroy_query&#41;. That&#39;s probably my bad at some level. Not sure why the files are not cleaned up when $neo4p_query is reassigned to a new query. Old object should go away at that point.

However, in the latest version, execute&#40;&#41; can take parameter assignments as arguments, and there is now &#40;as you suggested before&#41; a finish&#40;&#41; method that will delete the tmp file but leave the object intact. So you could prepare the queries before you start the loop, and use finish at the end of the loop:

$incident_query =
            &#39;MATCH &#40;i:INCIDENT&#41;, &#40;ic:INCIDENT_CATEGORY&#41;&#39;
            . &#39; WHERE i.incident_id = { incident_id }&#39;
            . &#39; AND ic.category_level_01 = { category_level_01 }&#39;
            . &#39; CREATE UNIQUE&#39;
            . &#39; ic&lt;-[r:HAS_INCIDENT_CATEGORY]-i RETURN r&#39;;
$incident_query_obj = REST::Neo4p::Query-&gt;new&#40;$incident_query&#41;;
# suppose an array of 2-elt arrays with desired parm combinations:
while &#40; &#40;$id,$lev&#41; = @{pop @{ @incident_and_category_params }} &#41; {
  $incident_query_obj-&gt;execute&#40; incident_id =&gt; $id,
                                category_level_01 =&gt; $lev &#41;;
  while &#40;my $row = $incident_query_obj-&gt;fetch&#41; {
     ...
     last if $GOT_WHAT_I_WANT;
  }

  $incident_query_obj-&gt;finish&#40;&#41;;
}

Each time you call finish, the tmp file is deleted, and each time you call execute a tmp file is created, but all within one query instance. You can set up multiple such query instances outside the loop and use the parameter bindings within the loop. Should make the code more maintainable too.

Please try and let me know. I REALLY appreciate this feedback!
best MAJ


On Wed Dec 18 16:23:59 2013, symonsjo@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Dec 18 16:06:10 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; On Tue Nov 05 23:42:29 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; &gt; Calling this resolved; please reopen if necessary. thanks
</div>&gt; &gt; 
&gt; &gt; I don&#39;t think this is resolved, in fact without destroy_query there&#39;s
&gt; &gt; a whole lot more files open at once, the below result is after loading
&gt; &gt; only 2500 rows.
&gt; &gt; 
&gt; &gt; [jsymons@larva nrls]$ perl -MREST::Neo4p -E &#39;say
&gt; &gt; $REST::Neo4p::VERSION&#39;
&gt; &gt; 0.126
&gt; &gt; [jsymons@larva nrls]$ ps -ef | grep extract
&gt; &gt; jsymons  20538 19391 64 20:46 pts/11   00:06:49 /usr/bin/perl -w
&gt; &gt; /home/jsymons/extract_nrls.2.0.0_stable.pl --input_file RA3_All.xlsx
&gt; &gt; --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span>
&gt; &gt; jsymons  21582 20114  0 20:56 pts/13   00:00:00 grep extract
&gt; &gt; [jsymons@larva nrls]$ lsof -p 20538 | grep -c &#39;/tmp/.\{10\}&#39;
&gt; &gt; 38071
&gt; &gt; 
&gt; &gt; And once I killed the script at between 3000 &#38; 3500 rows, in tmp
&gt; &gt; current there were:
&gt; &gt; 
&gt; &gt; [jsymons@larva nrls]$ ls -l /tmp | grep -c &#39;.\{10\}$&#39;
&gt; &gt; 46498
&gt; &gt; 
&gt; &gt; Latest code with destory_query &#38; updated for 2.0.0 stable at
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/v3xUJFeP">http://pastebin.com/v3xUJFeP</a></span>
</div>&gt; 
&gt; 
&gt; ^without destroy_query
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;18&nbsp;20:53:36&nbsp;2013</span>
    <span class="description">maj.fortinbras [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">oops - a bug in the sample below, should be

 while &#40; &#40;$id,$lev&#41; = @{pop @incident_and_category_params} &#41;

On Wed Dec 18 20:42:30 2013, MAJENSEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Ok, I will think a bit harder about this.
&gt; 
&gt; In the latest version &#40;0.2222&#41;, there are a couple of things that
&gt; might help. If you have thousands of files open, then presumably there
&gt; are thousands of live query objects &#40;without destroy_query&#41;. That&#39;s
&gt; probably my bad at some level. Not sure why the files are not cleaned
&gt; up when $neo4p_query is reassigned to a new query. Old object should
&gt; go away at that point.
&gt; 
&gt; However, in the latest version, execute&#40;&#41; can take parameter
&gt; assignments as arguments, and there is now &#40;as you suggested before&#41; a
&gt; finish&#40;&#41; method that will delete the tmp file but leave the object
&gt; intact. So you could prepare the queries before you start the loop,
&gt; and use finish at the end of the loop:
&gt; 
&gt; $incident_query =
&gt;             &#39;MATCH &#40;i:INCIDENT&#41;, &#40;ic:INCIDENT_CATEGORY&#41;&#39;
&gt;             . &#39; WHERE i.incident_id = { incident_id }&#39;
&gt;             . &#39; AND ic.category_level_01 = { category_level_01 }&#39;
&gt;             . &#39; CREATE UNIQUE&#39;
&gt;             . &#39; ic&lt;-[r:HAS_INCIDENT_CATEGORY]-i RETURN r&#39;;
&gt; $incident_query_obj = REST::Neo4p::Query-&gt;new&#40;$incident_query&#41;;
&gt; # suppose an array of 2-elt arrays with desired parm combinations:
&gt; while &#40; &#40;$id,$lev&#41; = @{pop @{ @incident_and_category_params }} &#41; {
&gt;   $incident_query_obj-&gt;execute&#40; incident_id =&gt; $id,
&gt;                                 category_level_01 =&gt; $lev &#41;;
&gt;   while &#40;my $row = $incident_query_obj-&gt;fetch&#41; {
&gt;      ...
&gt;      last if $GOT_WHAT_I_WANT;
&gt;   }
&gt; 
&gt; $incident_query_obj-&gt;finish&#40;&#41;;
&gt; }
&gt; 
&gt; Each time you call finish, the tmp file is deleted, and each time you
&gt; call execute a tmp file is created, but all within one query instance.
&gt; You can set up multiple such query instances outside the loop and use
&gt; the parameter bindings within the loop. Should make the code more
&gt; maintainable too.
&gt; 
&gt; Please try and let me know. I REALLY appreciate this feedback!
&gt; best MAJ
&gt; 
&gt; 
&gt; On Wed Dec 18 16:23:59 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; On Wed Dec 18 16:06:10 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; On Tue Nov 05 23:42:29 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; Calling this resolved; please reopen if necessary. thanks
</div>&gt; &gt; &gt;
&gt; &gt; &gt; I don&#39;t think this is resolved, in fact without destroy_query
&gt; &gt; &gt; there&#39;s
&gt; &gt; &gt; a whole lot more files open at once, the below result is after
&gt; &gt; &gt; loading
&gt; &gt; &gt; only 2500 rows.
&gt; &gt; &gt;
&gt; &gt; &gt; [jsymons@larva nrls]$ perl -MREST::Neo4p -E &#39;say
&gt; &gt; &gt; $REST::Neo4p::VERSION&#39;
&gt; &gt; &gt; 0.126
&gt; &gt; &gt; [jsymons@larva nrls]$ ps -ef | grep extract
&gt; &gt; &gt; jsymons  20538 19391 64 20:46 pts/11   00:06:49 /usr/bin/perl -w
&gt; &gt; &gt; /home/jsymons/extract_nrls.2.0.0_stable.pl --input_file
&gt; &gt; &gt; RA3_All.xlsx
&gt; &gt; &gt; --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span>
&gt; &gt; &gt; jsymons  21582 20114  0 20:56 pts/13   00:00:00 grep extract
&gt; &gt; &gt; [jsymons@larva nrls]$ lsof -p 20538 | grep -c &#39;/tmp/.\{10\}&#39;
&gt; &gt; &gt; 38071
&gt; &gt; &gt;
&gt; &gt; &gt; And once I killed the script at between 3000 &#38; 3500 rows, in tmp
&gt; &gt; &gt; current there were:
&gt; &gt; &gt;
&gt; &gt; &gt; [jsymons@larva nrls]$ ls -l /tmp | grep -c &#39;.\{10\}$&#39;
&gt; &gt; &gt; 46498
&gt; &gt; &gt;
&gt; &gt; &gt; Latest code with destory_query &#38; updated for 2.0.0 stable at
&gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/v3xUJFeP">http://pastebin.com/v3xUJFeP</a></span>
</div>&gt; &gt;
&gt; &gt;
&gt; &gt; ^without destroy_query
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;19&nbsp;01:07:29&nbsp;2013</span>
    <span class="description">symonsjo [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> symonsjo [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Mark,

In my latest code I&#39;m using param queries to take advantage of neo4j query caching. That code is here: <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/mS2F5iJh">http://pastebin.com/mS2F5iJh</a></span>

I&#39;ll upgrade REST::Neo4p and integrate $query-&gt;finish&#40;&#41; into my destroy_query method from the code above &#40;and drop undef $query&#41;.

On Wed Dec 18 20:53:36 2013, MAJENSEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; oops - a bug in the sample below, should be
&gt; 
&gt;  while &#40; &#40;$id,$lev&#41; = @{pop @incident_and_category_params} &#41;
&gt; 
&gt; On Wed Dec 18 20:42:30 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; Ok, I will think a bit harder about this.
&gt; &gt; 
&gt; &gt; In the latest version &#40;0.2222&#41;, there are a couple of things that
&gt; &gt; might help. If you have thousands of files open, then presumably there
&gt; &gt; are thousands of live query objects &#40;without destroy_query&#41;. That&#39;s
&gt; &gt; probably my bad at some level. Not sure why the files are not cleaned
&gt; &gt; up when $neo4p_query is reassigned to a new query. Old object should
&gt; &gt; go away at that point.
&gt; &gt; 
&gt; &gt; However, in the latest version, execute&#40;&#41; can take parameter
&gt; &gt; assignments as arguments, and there is now &#40;as you suggested before&#41; a
&gt; &gt; finish&#40;&#41; method that will delete the tmp file but leave the object
&gt; &gt; intact. So you could prepare the queries before you start the loop,
&gt; &gt; and use finish at the end of the loop:
&gt; &gt; 
&gt; &gt; $incident_query =
&gt; &gt;             &#39;MATCH &#40;i:INCIDENT&#41;, &#40;ic:INCIDENT_CATEGORY&#41;&#39;
&gt; &gt;             . &#39; WHERE i.incident_id = { incident_id }&#39;
&gt; &gt;             . &#39; AND ic.category_level_01 = { category_level_01 }&#39;
&gt; &gt;             . &#39; CREATE UNIQUE&#39;
&gt; &gt;             . &#39; ic&lt;-[r:HAS_INCIDENT_CATEGORY]-i RETURN r&#39;;
&gt; &gt; $incident_query_obj = REST::Neo4p::Query-&gt;new&#40;$incident_query&#41;;
&gt; &gt; # suppose an array of 2-elt arrays with desired parm combinations:
&gt; &gt; while &#40; &#40;$id,$lev&#41; = @{pop @{ @incident_and_category_params }} &#41; {
&gt; &gt;   $incident_query_obj-&gt;execute&#40; incident_id =&gt; $id,
&gt; &gt;                                 category_level_01 =&gt; $lev &#41;;
&gt; &gt;   while &#40;my $row = $incident_query_obj-&gt;fetch&#41; {
&gt; &gt;      ...
&gt; &gt;      last if $GOT_WHAT_I_WANT;
&gt; &gt;   }
&gt; &gt; 
&gt; &gt; $incident_query_obj-&gt;finish&#40;&#41;;
&gt; &gt; }
&gt; &gt; 
&gt; &gt; Each time you call finish, the tmp file is deleted, and each time you
&gt; &gt; call execute a tmp file is created, but all within one query instance.
&gt; &gt; You can set up multiple such query instances outside the loop and use
&gt; &gt; the parameter bindings within the loop. Should make the code more
&gt; &gt; maintainable too.
&gt; &gt; 
&gt; &gt; Please try and let me know. I REALLY appreciate this feedback!
&gt; &gt; best MAJ
&gt; &gt; 
&gt; &gt; 
&gt; &gt; On Wed Dec 18 16:23:59 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; On Wed Dec 18 16:06:10 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; On Tue Nov 05 23:42:29 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; Calling this resolved; please reopen if necessary. thanks
</div>&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; I don&#39;t think this is resolved, in fact without destroy_query
&gt; &gt; &gt; &gt; there&#39;s
&gt; &gt; &gt; &gt; a whole lot more files open at once, the below result is after
&gt; &gt; &gt; &gt; loading
&gt; &gt; &gt; &gt; only 2500 rows.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; [jsymons@larva nrls]$ perl -MREST::Neo4p -E &#39;say
&gt; &gt; &gt; &gt; $REST::Neo4p::VERSION&#39;
&gt; &gt; &gt; &gt; 0.126
&gt; &gt; &gt; &gt; [jsymons@larva nrls]$ ps -ef | grep extract
&gt; &gt; &gt; &gt; jsymons  20538 19391 64 20:46 pts/11   00:06:49 /usr/bin/perl -w
&gt; &gt; &gt; &gt; /home/jsymons/extract_nrls.2.0.0_stable.pl --input_file
&gt; &gt; &gt; &gt; RA3_All.xlsx
&gt; &gt; &gt; &gt; --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span>
&gt; &gt; &gt; &gt; jsymons  21582 20114  0 20:56 pts/13   00:00:00 grep extract
&gt; &gt; &gt; &gt; [jsymons@larva nrls]$ lsof -p 20538 | grep -c &#39;/tmp/.\{10\}&#39;
&gt; &gt; &gt; &gt; 38071
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; And once I killed the script at between 3000 &#38; 3500 rows, in tmp
&gt; &gt; &gt; &gt; current there were:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; [jsymons@larva nrls]$ ls -l /tmp | grep -c &#39;.\{10\}$&#39;
&gt; &gt; &gt; &gt; 46498
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Latest code with destory_query &#38; updated for 2.0.0 stable at
&gt; &gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/v3xUJFeP">http://pastebin.com/v3xUJFeP</a></span>
</div>&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; ^without destroy_query
</div></div>&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;19&nbsp;01:34:09&nbsp;2013</span>
    <span class="description">symonsjo [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> symonsjo [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Dec 19 01:07:29 2013, symonsjo@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Mark,
&gt; 
&gt; In my latest code I&#39;m using param queries to take advantage of neo4j
&gt; query caching. That code is here: <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/mS2F5iJh">http://pastebin.com/mS2F5iJh</a></span>
&gt; 
&gt; I&#39;ll upgrade REST::Neo4p and integrate $query-&gt;finish&#40;&#41; into my
&gt; destroy_query method from the code above &#40;and drop undef $query&#41;.
&gt; 
&gt; On Wed Dec 18 20:53:36 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; oops - a bug in the sample below, should be
&gt; &gt;
&gt; &gt; while &#40; &#40;$id,$lev&#41; = @{pop @incident_and_category_params} &#41;
&gt; &gt;
&gt; &gt; On Wed Dec 18 20:42:30 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; &gt; Ok, I will think a bit harder about this.
&gt; &gt; &gt;
&gt; &gt; &gt; In the latest version &#40;0.2222&#41;, there are a couple of things that
&gt; &gt; &gt; might help. If you have thousands of files open, then presumably
&gt; &gt; &gt; there
&gt; &gt; &gt; are thousands of live query objects &#40;without destroy_query&#41;. That&#39;s
&gt; &gt; &gt; probably my bad at some level. Not sure why the files are not
&gt; &gt; &gt; cleaned
&gt; &gt; &gt; up when $neo4p_query is reassigned to a new query. Old object
&gt; &gt; &gt; should
&gt; &gt; &gt; go away at that point.
&gt; &gt; &gt;
&gt; &gt; &gt; However, in the latest version, execute&#40;&#41; can take parameter
&gt; &gt; &gt; assignments as arguments, and there is now &#40;as you suggested
&gt; &gt; &gt; before&#41; a
&gt; &gt; &gt; finish&#40;&#41; method that will delete the tmp file but leave the object
&gt; &gt; &gt; intact. So you could prepare the queries before you start the loop,
&gt; &gt; &gt; and use finish at the end of the loop:
&gt; &gt; &gt;
&gt; &gt; &gt; $incident_query =
&gt; &gt; &gt;             &#39;MATCH &#40;i:INCIDENT&#41;, &#40;ic:INCIDENT_CATEGORY&#41;&#39;
&gt; &gt; &gt;             . &#39; WHERE i.incident_id = { incident_id }&#39;
&gt; &gt; &gt;             . &#39; AND ic.category_level_01 = { category_level_01 }&#39;
&gt; &gt; &gt;             . &#39; CREATE UNIQUE&#39;
&gt; &gt; &gt;             . &#39; ic&lt;-[r:HAS_INCIDENT_CATEGORY]-i RETURN r&#39;;
&gt; &gt; &gt; $incident_query_obj = REST::Neo4p::Query-&gt;new&#40;$incident_query&#41;;
&gt; &gt; &gt; # suppose an array of 2-elt arrays with desired parm combinations:
&gt; &gt; &gt; while &#40; &#40;$id,$lev&#41; = @{pop @{ @incident_and_category_params }} &#41; {
&gt; &gt; &gt;   $incident_query_obj-&gt;execute&#40; incident_id =&gt; $id,
&gt; &gt; &gt;                                 category_level_01 =&gt; $lev &#41;;
&gt; &gt; &gt;   while &#40;my $row = $incident_query_obj-&gt;fetch&#41; {
&gt; &gt; &gt;      ...
&gt; &gt; &gt;      last if $GOT_WHAT_I_WANT;
&gt; &gt; &gt;   }
&gt; &gt; &gt;
&gt; &gt; &gt; $incident_query_obj-&gt;finish&#40;&#41;;
&gt; &gt; &gt; }
&gt; &gt; &gt;
&gt; &gt; &gt; Each time you call finish, the tmp file is deleted, and each time
&gt; &gt; &gt; you
&gt; &gt; &gt; call execute a tmp file is created, but all within one query
&gt; &gt; &gt; instance.
&gt; &gt; &gt; You can set up multiple such query instances outside the loop and
&gt; &gt; &gt; use
&gt; &gt; &gt; the parameter bindings within the loop. Should make the code more
&gt; &gt; &gt; maintainable too.
&gt; &gt; &gt;
&gt; &gt; &gt; Please try and let me know. I REALLY appreciate this feedback!
&gt; &gt; &gt; best MAJ
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; On Wed Dec 18 16:23:59 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; On Wed Dec 18 16:06:10 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; On Tue Nov 05 23:42:29 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; Calling this resolved; please reopen if necessary. thanks
</div>&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; I don&#39;t think this is resolved, in fact without destroy_query
&gt; &gt; &gt; &gt; &gt; there&#39;s
&gt; &gt; &gt; &gt; &gt; a whole lot more files open at once, the below result is after
&gt; &gt; &gt; &gt; &gt; loading
&gt; &gt; &gt; &gt; &gt; only 2500 rows.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; [jsymons@larva nrls]$ perl -MREST::Neo4p -E &#39;say
&gt; &gt; &gt; &gt; &gt; $REST::Neo4p::VERSION&#39;
&gt; &gt; &gt; &gt; &gt; 0.126
&gt; &gt; &gt; &gt; &gt; [jsymons@larva nrls]$ ps -ef | grep extract
&gt; &gt; &gt; &gt; &gt; jsymons  20538 19391 64 20:46 pts/11   00:06:49 /usr/bin/perl
&gt; &gt; &gt; &gt; &gt; -w
&gt; &gt; &gt; &gt; &gt; /home/jsymons/extract_nrls.2.0.0_stable.pl --input_file
&gt; &gt; &gt; &gt; &gt; RA3_All.xlsx
&gt; &gt; &gt; &gt; &gt; --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span>
&gt; &gt; &gt; &gt; &gt; jsymons  21582 20114  0 20:56 pts/13   00:00:00 grep extract
&gt; &gt; &gt; &gt; &gt; [jsymons@larva nrls]$ lsof -p 20538 | grep -c &#39;/tmp/.\{10\}&#39;
&gt; &gt; &gt; &gt; &gt; 38071
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; And once I killed the script at between 3000 &#38; 3500 rows, in
&gt; &gt; &gt; &gt; &gt; tmp
&gt; &gt; &gt; &gt; &gt; current there were:
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; [jsymons@larva nrls]$ ls -l /tmp | grep -c &#39;.\{10\}$&#39;
&gt; &gt; &gt; &gt; &gt; 46498
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Latest code with destory_query &#38; updated for 2.0.0 stable at
&gt; &gt; &gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/v3xUJFeP">http://pastebin.com/v3xUJFeP</a></span>
</div>&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; ^without destroy_query
</div></div>&gt; &gt;
&gt; &gt;
</div></div>

Hello Mark,

I upgraded to 0.2222 as suggested:

[jsymons@larva nrls]$ perl -MREST::Neo4p -E &#39;say $REST::Neo4p::VERSION&#39;
0.2222

And I added $query-&gt;finish&#40;&#41; to the destroy_query sub and removed the undef $query in the code in pastebin here: <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/mS2F5iJh">http://pastebin.com/mS2F5iJh</a></span>

But after loading 500 rows from the spreadsheet without the undef in place I end up with 7045 open files:
                                                                                                    
[jsymons@larva nrls]$ /home/jsymons/extract_nrls.2.0.0_stable.pl --input_file RA3_All.xlsx --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span> 2&gt; RA3_All.xlsx.loading.error.log | tee RA3_All.xlsx.loading.log                                                                                                                                   
Processed 500 rows. Thu Dec 19 06:18:46 2013                                                                                                                   

[jsymons@larva nrls]$ ps -ef | grep extract                                                                                                                    
jsymons   5268 19391 79 06:16 pts/11   00:00:05 /usr/bin/perl -w /home/jsymons/extract_nrls.2.0.0_stable.pl --input_file RA3_All.xlsx --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span>                                                                                                                                                         
jsymons   5271 20114  0 06:16 pts/13   00:00:00 grep extract                                                                                                   
[jsymons@larva nrls]$ while true ; do echo &#34;/tmp has &#34; $&#40;lsof -p 5268 | grep -c &#39;/tmp/.\{10\}&#39;&#41; &#34; open files for pid&#34; ; sleep 10 ; done                        
/tmp has  1086  open files for pid                                                                                                                             
/tmp has  1612  open files for pid                                                                                                                             
/tmp has  2122  open files for pid                                                                                                                             
/tmp has  2634  open files for pid                                                                                                                             
/tmp has  3201  open files for pid                                                                                                                             
/tmp has  3783  open files for pid                                                                                                                             
/tmp has  4317  open files for pid                                                                                                                             
/tmp has  4838  open files for pid                                                                                                                             
/tmp has  5387  open files for pid                                                                                                                             
/tmp has  5933  open files for pid                                                                                                                             
/tmp has  6479  open files for pid                                                                                                                             
/tmp has  7045  open files for pid                                                                                                                             

Actually even with undef on the newer code it&#39;s still worse than it was with 0.126 as far as open files go because I also tried with $query-finish&#40;&#41;; AND undef $query; and still had a huge amount of open files. Sub is below:

sub destroy_query {
    my $query = shift;
    
    if &#40;defined&#40;$query&#41;&#41; {
        while &#40;my $response = $query-&gt;fetch&#40;&#41;&#41; {
            # Who cares, throw it out
        }
        $query-&gt;finish&#40;&#41;; # Cleanup suggested by Mark
        undef $query;
    }
}
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;26&nbsp;20:22:11&nbsp;2013</span>
    <span class="description">maj.fortinbras [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Jo- I think you will get more mileage if you set the parameter values in the execute&#40;&#41; method &#40;I don&#39;t see that in the paste&#41;; then you don&#39;t have to create a separate query object for each set of parameter values:
Rather than something like:

 $query = &#39;START n=...{my_parmA}...RETURN n&#39;;
 $q1 = REST::Neo4p::Query-&gt;new&#40;$query, {my_parmA =&gt; 1}&#41;;
 $q1-&gt;execute&#40;&#41;;
 $q2 = REST::Neo4p::Query-&gt;new&#40;$query, {my_parmA =&gt; 2}&#41;;
 $q2-&gt;execute&#40;&#41;;
 ...

try &#40;with v0.2222&#41;

 $query = &#39;START n=...{my_parmA}...RETURN n&#39;;
 $q = REST::neo4p::Query-&gt;new&#40;$query&#41;;
 for &#40;1..2&#41; {
  $q-&gt;execute&#40;{my_parmA =&gt; $_}&#41;;
 }

Here you&#39;re only creating one query object, but executing it multiple times with new parameter values. I think this will cut down the number of open files.

Let me know- MAJ


On Thu Dec 19 01:34:09 2013, symonsjo@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Dec 19 01:07:29 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; Hi Mark,
&gt; &gt;
&gt; &gt; In my latest code I&#39;m using param queries to take advantage of neo4j
&gt; &gt; query caching. That code is here: <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/mS2F5iJh">http://pastebin.com/mS2F5iJh</a></span>
&gt; &gt;
&gt; &gt; I&#39;ll upgrade REST::Neo4p and integrate $query-&gt;finish&#40;&#41; into my
&gt; &gt; destroy_query method from the code above &#40;and drop undef $query&#41;.
&gt; &gt;
&gt; &gt; On Wed Dec 18 20:53:36 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; &gt; oops - a bug in the sample below, should be
&gt; &gt; &gt;
&gt; &gt; &gt; while &#40; &#40;$id,$lev&#41; = @{pop @incident_and_category_params} &#41;
&gt; &gt; &gt;
&gt; &gt; &gt; On Wed Dec 18 20:42:30 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; Ok, I will think a bit harder about this.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; In the latest version &#40;0.2222&#41;, there are a couple of things that
&gt; &gt; &gt; &gt; might help. If you have thousands of files open, then presumably
&gt; &gt; &gt; &gt; there
&gt; &gt; &gt; &gt; are thousands of live query objects &#40;without destroy_query&#41;.
&gt; &gt; &gt; &gt; That&#39;s
&gt; &gt; &gt; &gt; probably my bad at some level. Not sure why the files are not
&gt; &gt; &gt; &gt; cleaned
&gt; &gt; &gt; &gt; up when $neo4p_query is reassigned to a new query. Old object
&gt; &gt; &gt; &gt; should
&gt; &gt; &gt; &gt; go away at that point.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; However, in the latest version, execute&#40;&#41; can take parameter
&gt; &gt; &gt; &gt; assignments as arguments, and there is now &#40;as you suggested
&gt; &gt; &gt; &gt; before&#41; a
&gt; &gt; &gt; &gt; finish&#40;&#41; method that will delete the tmp file but leave the
&gt; &gt; &gt; &gt; object
&gt; &gt; &gt; &gt; intact. So you could prepare the queries before you start the
&gt; &gt; &gt; &gt; loop,
&gt; &gt; &gt; &gt; and use finish at the end of the loop:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; $incident_query =
&gt; &gt; &gt; &gt;             &#39;MATCH &#40;i:INCIDENT&#41;, &#40;ic:INCIDENT_CATEGORY&#41;&#39;
&gt; &gt; &gt; &gt;             . &#39; WHERE i.incident_id = { incident_id }&#39;
&gt; &gt; &gt; &gt;             . &#39; AND ic.category_level_01 = { category_level_01 }&#39;
&gt; &gt; &gt; &gt;             . &#39; CREATE UNIQUE&#39;
&gt; &gt; &gt; &gt;             . &#39; ic&lt;-[r:HAS_INCIDENT_CATEGORY]-i RETURN r&#39;;
&gt; &gt; &gt; &gt; $incident_query_obj = REST::Neo4p::Query-&gt;new&#40;$incident_query&#41;;
&gt; &gt; &gt; &gt; # suppose an array of 2-elt arrays with desired parm
&gt; &gt; &gt; &gt; combinations:
&gt; &gt; &gt; &gt; while &#40; &#40;$id,$lev&#41; = @{pop @{ @incident_and_category_params }} &#41;
&gt; &gt; &gt; &gt; {
&gt; &gt; &gt; &gt;   $incident_query_obj-&gt;execute&#40; incident_id =&gt; $id,
&gt; &gt; &gt; &gt;                                 category_level_01 =&gt; $lev &#41;;
&gt; &gt; &gt; &gt;   while &#40;my $row = $incident_query_obj-&gt;fetch&#41; {
&gt; &gt; &gt; &gt;      ...
&gt; &gt; &gt; &gt;      last if $GOT_WHAT_I_WANT;
&gt; &gt; &gt; &gt;   }
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; $incident_query_obj-&gt;finish&#40;&#41;;
&gt; &gt; &gt; &gt; }
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Each time you call finish, the tmp file is deleted, and each time
&gt; &gt; &gt; &gt; you
&gt; &gt; &gt; &gt; call execute a tmp file is created, but all within one query
&gt; &gt; &gt; &gt; instance.
&gt; &gt; &gt; &gt; You can set up multiple such query instances outside the loop and
&gt; &gt; &gt; &gt; use
&gt; &gt; &gt; &gt; the parameter bindings within the loop. Should make the code more
&gt; &gt; &gt; &gt; maintainable too.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Please try and let me know. I REALLY appreciate this feedback!
&gt; &gt; &gt; &gt; best MAJ
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; On Wed Dec 18 16:23:59 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; On Wed Dec 18 16:06:10 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; On Tue Nov 05 23:42:29 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; Calling this resolved; please reopen if necessary. thanks
</div>&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; I don&#39;t think this is resolved, in fact without destroy_query
&gt; &gt; &gt; &gt; &gt; &gt; there&#39;s
&gt; &gt; &gt; &gt; &gt; &gt; a whole lot more files open at once, the below result is
&gt; &gt; &gt; &gt; &gt; &gt; after
&gt; &gt; &gt; &gt; &gt; &gt; loading
&gt; &gt; &gt; &gt; &gt; &gt; only 2500 rows.
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; [jsymons@larva nrls]$ perl -MREST::Neo4p -E &#39;say
&gt; &gt; &gt; &gt; &gt; &gt; $REST::Neo4p::VERSION&#39;
&gt; &gt; &gt; &gt; &gt; &gt; 0.126
&gt; &gt; &gt; &gt; &gt; &gt; [jsymons@larva nrls]$ ps -ef | grep extract
&gt; &gt; &gt; &gt; &gt; &gt; jsymons  20538 19391 64 20:46 pts/11   00:06:49 /usr/bin/perl
&gt; &gt; &gt; &gt; &gt; &gt; -w
&gt; &gt; &gt; &gt; &gt; &gt; /home/jsymons/extract_nrls.2.0.0_stable.pl --input_file
&gt; &gt; &gt; &gt; &gt; &gt; RA3_All.xlsx
&gt; &gt; &gt; &gt; &gt; &gt; --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span>
&gt; &gt; &gt; &gt; &gt; &gt; jsymons  21582 20114  0 20:56 pts/13   00:00:00 grep extract
&gt; &gt; &gt; &gt; &gt; &gt; [jsymons@larva nrls]$ lsof -p 20538 | grep -c &#39;/tmp/.\{10\}&#39;
&gt; &gt; &gt; &gt; &gt; &gt; 38071
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; And once I killed the script at between 3000 &#38; 3500 rows, in
&gt; &gt; &gt; &gt; &gt; &gt; tmp
&gt; &gt; &gt; &gt; &gt; &gt; current there were:
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; [jsymons@larva nrls]$ ls -l /tmp | grep -c &#39;.\{10\}$&#39;
&gt; &gt; &gt; &gt; &gt; &gt; 46498
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Latest code with destory_query &#38; updated for 2.0.0 stable at
&gt; &gt; &gt; &gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/v3xUJFeP">http://pastebin.com/v3xUJFeP</a></span>
</div>&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; ^without destroy_query
</div></div>&gt; &gt; &gt;
&gt; &gt; &gt;
</div></div>&gt; 
&gt; 
&gt; Hello Mark,
&gt; 
&gt; I upgraded to 0.2222 as suggested:
&gt; 
&gt; [jsymons@larva nrls]$ perl -MREST::Neo4p -E &#39;say
&gt; $REST::Neo4p::VERSION&#39;
&gt; 0.2222
&gt; 
&gt; And I added $query-&gt;finish&#40;&#41; to the destroy_query sub and removed the
&gt; undef $query in the code in pastebin here:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/mS2F5iJh">http://pastebin.com/mS2F5iJh</a></span>
&gt; 
&gt; But after loading 500 rows from the spreadsheet without the undef in
&gt; place I end up with 7045 open files:
&gt; 
&gt; [jsymons@larva nrls]$ /home/jsymons/extract_nrls.2.0.0_stable.pl
&gt; --input_file RA3_All.xlsx --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span> 2&gt;
&gt; RA3_All.xlsx.loading.error.log | tee RA3_All.xlsx.loading.log
&gt; Processed 500 rows. Thu Dec 19 06:18:46 2013
&gt; 
&gt; [jsymons@larva nrls]$ ps -ef | grep extract
&gt;                                      jsymons   5268 19391 79 06:16
&gt; pts/11   00:00:05 /usr/bin/perl -w
&gt; /home/jsymons/extract_nrls.2.0.0_stable.pl --input_file RA3_All.xlsx
&gt; --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span>
&gt; jsymons   5271 20114  0 06:16 pts/13   00:00:00 grep extract
&gt; [jsymons@larva nrls]$ while true ; do echo &#34;/tmp has &#34; $&#40;lsof -p 5268
&gt; | grep -c &#39;/tmp/.\{10\}&#39;&#41; &#34; open files for pid&#34; ; sleep 10 ; done
&gt;          /tmp has  1086  open files for pid
&gt;          /tmp has  1612  open files for pid
&gt;          /tmp has  2122  open files for pid
&gt;          /tmp has  2634  open files for pid
&gt;          /tmp has  3201  open files for pid
&gt;          /tmp has  3783  open files for pid
&gt;          /tmp has  4317  open files for pid
&gt;          /tmp has  4838  open files for pid
&gt;          /tmp has  5387  open files for pid
&gt;          /tmp has  5933  open files for pid
&gt;          /tmp has  6479  open files for pid
&gt;          /tmp has  7045  open files for pid
&gt; 
&gt; Actually even with undef on the newer code it&#39;s still worse than it
&gt; was with 0.126 as far as open files go because I also tried with
&gt; $query-finish&#40;&#41;; AND undef $query; and still had a huge amount of open
&gt; files. Sub is below:
&gt; 
&gt; sub destroy_query {
&gt;     my $query = shift;
&gt; 
&gt; if &#40;defined&#40;$query&#41;&#41; {
&gt;     while &#40;my $response = $query-&gt;fetch&#40;&#41;&#41; {
&gt;         # Who cares, throw it out
&gt;     }
&gt;     $query-&gt;finish&#40;&#41;; # Cleanup suggested by Mark
&gt;     undef $query;
&gt; }
&gt; }
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;01&nbsp;05:39:50&nbsp;2014</span>
    <span class="description">symonsjo [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> symonsjo [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi MAJ,

So I&#39;ve updated the code and I&#39;ve confirmed that I now only have open files for the queries I&#39;ve opened. I apologize that the last code I pasted you wasn&#39;t correct but I&#39;ve updated the code even further and it&#39;s working beautifully. Thanks. The updated code is here:

<span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/GNaWKB48">http://pastebin.com/GNaWKB48</a></span>

~ icenine

On Thu Dec 26 20:22:11 2013, MAJENSEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Jo- I think you will get more mileage if you set the parameter
&gt; values in the execute&#40;&#41; method &#40;I don&#39;t see that in the paste&#41;; then
&gt; you don&#39;t have to create a separate query object for each set of
&gt; parameter values:
&gt; Rather than something like:
&gt; 
&gt; $query = &#39;START n=...{my_parmA}...RETURN n&#39;;
&gt; $q1 = REST::Neo4p::Query-&gt;new&#40;$query, {my_parmA =&gt; 1}&#41;;
&gt; $q1-&gt;execute&#40;&#41;;
&gt; $q2 = REST::Neo4p::Query-&gt;new&#40;$query, {my_parmA =&gt; 2}&#41;;
&gt; $q2-&gt;execute&#40;&#41;;
&gt; ...
&gt; 
&gt; try &#40;with v0.2222&#41;
&gt; 
&gt; $query = &#39;START n=...{my_parmA}...RETURN n&#39;;
&gt; $q = REST::neo4p::Query-&gt;new&#40;$query&#41;;
&gt; for &#40;1..2&#41; {
&gt;  $q-&gt;execute&#40;{my_parmA =&gt; $_}&#41;;
&gt; }
&gt; 
&gt; Here you&#39;re only creating one query object, but executing it multiple
&gt; times with new parameter values. I think this will cut down the number
&gt; of open files.
&gt; 
&gt; Let me know- MAJ
&gt; 
&gt; 
&gt; On Thu Dec 19 01:34:09 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; On Thu Dec 19 01:07:29 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; Hi Mark,
&gt; &gt; &gt;
&gt; &gt; &gt; In my latest code I&#39;m using param queries to take advantage of
&gt; &gt; &gt; neo4j
&gt; &gt; &gt; query caching. That code is here: <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/mS2F5iJh">http://pastebin.com/mS2F5iJh</a></span>
&gt; &gt; &gt;
&gt; &gt; &gt; I&#39;ll upgrade REST::Neo4p and integrate $query-&gt;finish&#40;&#41; into my
&gt; &gt; &gt; destroy_query method from the code above &#40;and drop undef $query&#41;.
&gt; &gt; &gt;
&gt; &gt; &gt; On Wed Dec 18 20:53:36 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; oops - a bug in the sample below, should be
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; while &#40; &#40;$id,$lev&#41; = @{pop @incident_and_category_params} &#41;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; On Wed Dec 18 20:42:30 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; Ok, I will think a bit harder about this.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; In the latest version &#40;0.2222&#41;, there are a couple of things
&gt; &gt; &gt; &gt; &gt; that
&gt; &gt; &gt; &gt; &gt; might help. If you have thousands of files open, then
&gt; &gt; &gt; &gt; &gt; presumably
&gt; &gt; &gt; &gt; &gt; there
&gt; &gt; &gt; &gt; &gt; are thousands of live query objects &#40;without destroy_query&#41;.
&gt; &gt; &gt; &gt; &gt; That&#39;s
&gt; &gt; &gt; &gt; &gt; probably my bad at some level. Not sure why the files are not
&gt; &gt; &gt; &gt; &gt; cleaned
&gt; &gt; &gt; &gt; &gt; up when $neo4p_query is reassigned to a new query. Old object
&gt; &gt; &gt; &gt; &gt; should
&gt; &gt; &gt; &gt; &gt; go away at that point.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; However, in the latest version, execute&#40;&#41; can take parameter
&gt; &gt; &gt; &gt; &gt; assignments as arguments, and there is now &#40;as you suggested
&gt; &gt; &gt; &gt; &gt; before&#41; a
&gt; &gt; &gt; &gt; &gt; finish&#40;&#41; method that will delete the tmp file but leave the
&gt; &gt; &gt; &gt; &gt; object
&gt; &gt; &gt; &gt; &gt; intact. So you could prepare the queries before you start the
&gt; &gt; &gt; &gt; &gt; loop,
&gt; &gt; &gt; &gt; &gt; and use finish at the end of the loop:
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; $incident_query =
&gt; &gt; &gt; &gt; &gt;             &#39;MATCH &#40;i:INCIDENT&#41;, &#40;ic:INCIDENT_CATEGORY&#41;&#39;
&gt; &gt; &gt; &gt; &gt;             . &#39; WHERE i.incident_id = { incident_id }&#39;
&gt; &gt; &gt; &gt; &gt;             . &#39; AND ic.category_level_01 = { category_level_01
&gt; &gt; &gt; &gt; &gt; }&#39;
&gt; &gt; &gt; &gt; &gt;             . &#39; CREATE UNIQUE&#39;
&gt; &gt; &gt; &gt; &gt;             . &#39; ic&lt;-[r:HAS_INCIDENT_CATEGORY]-i RETURN r&#39;;
&gt; &gt; &gt; &gt; &gt; $incident_query_obj = REST::Neo4p::Query-&gt;new&#40;$incident_query&#41;;
&gt; &gt; &gt; &gt; &gt; # suppose an array of 2-elt arrays with desired parm
&gt; &gt; &gt; &gt; &gt; combinations:
&gt; &gt; &gt; &gt; &gt; while &#40; &#40;$id,$lev&#41; = @{pop @{ @incident_and_category_params }}
&gt; &gt; &gt; &gt; &gt; &#41;
&gt; &gt; &gt; &gt; &gt; {
&gt; &gt; &gt; &gt; &gt;   $incident_query_obj-&gt;execute&#40; incident_id =&gt; $id,
&gt; &gt; &gt; &gt; &gt;                                 category_level_01 =&gt; $lev &#41;;
&gt; &gt; &gt; &gt; &gt;   while &#40;my $row = $incident_query_obj-&gt;fetch&#41; {
&gt; &gt; &gt; &gt; &gt;      ...
&gt; &gt; &gt; &gt; &gt;      last if $GOT_WHAT_I_WANT;
&gt; &gt; &gt; &gt; &gt;   }
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; $incident_query_obj-&gt;finish&#40;&#41;;
&gt; &gt; &gt; &gt; &gt; }
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Each time you call finish, the tmp file is deleted, and each
&gt; &gt; &gt; &gt; &gt; time
&gt; &gt; &gt; &gt; &gt; you
&gt; &gt; &gt; &gt; &gt; call execute a tmp file is created, but all within one query
&gt; &gt; &gt; &gt; &gt; instance.
&gt; &gt; &gt; &gt; &gt; You can set up multiple such query instances outside the loop
&gt; &gt; &gt; &gt; &gt; and
&gt; &gt; &gt; &gt; &gt; use
&gt; &gt; &gt; &gt; &gt; the parameter bindings within the loop. Should make the code
&gt; &gt; &gt; &gt; &gt; more
&gt; &gt; &gt; &gt; &gt; maintainable too.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Please try and let me know. I REALLY appreciate this feedback!
&gt; &gt; &gt; &gt; &gt; best MAJ
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; On Wed Dec 18 16:23:59 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; On Wed Dec 18 16:06:10 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; On Tue Nov 05 23:42:29 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; Calling this resolved; please reopen if necessary. thanks
</div>&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; I don&#39;t think this is resolved, in fact without
&gt; &gt; &gt; &gt; &gt; &gt; &gt; destroy_query
&gt; &gt; &gt; &gt; &gt; &gt; &gt; there&#39;s
&gt; &gt; &gt; &gt; &gt; &gt; &gt; a whole lot more files open at once, the below result is
&gt; &gt; &gt; &gt; &gt; &gt; &gt; after
&gt; &gt; &gt; &gt; &gt; &gt; &gt; loading
&gt; &gt; &gt; &gt; &gt; &gt; &gt; only 2500 rows.
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; [jsymons@larva nrls]$ perl -MREST::Neo4p -E &#39;say
&gt; &gt; &gt; &gt; &gt; &gt; &gt; $REST::Neo4p::VERSION&#39;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 0.126
&gt; &gt; &gt; &gt; &gt; &gt; &gt; [jsymons@larva nrls]$ ps -ef | grep extract
&gt; &gt; &gt; &gt; &gt; &gt; &gt; jsymons  20538 19391 64 20:46 pts/11   00:06:49
&gt; &gt; &gt; &gt; &gt; &gt; &gt; /usr/bin/perl
&gt; &gt; &gt; &gt; &gt; &gt; &gt; -w
&gt; &gt; &gt; &gt; &gt; &gt; &gt; /home/jsymons/extract_nrls.2.0.0_stable.pl --input_file
&gt; &gt; &gt; &gt; &gt; &gt; &gt; RA3_All.xlsx
&gt; &gt; &gt; &gt; &gt; &gt; &gt; --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span>
&gt; &gt; &gt; &gt; &gt; &gt; &gt; jsymons  21582 20114  0 20:56 pts/13   00:00:00 grep
&gt; &gt; &gt; &gt; &gt; &gt; &gt; extract
&gt; &gt; &gt; &gt; &gt; &gt; &gt; [jsymons@larva nrls]$ lsof -p 20538 | grep -c
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &#39;/tmp/.\{10\}&#39;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 38071
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; And once I killed the script at between 3000 &#38; 3500 rows,
&gt; &gt; &gt; &gt; &gt; &gt; &gt; in
&gt; &gt; &gt; &gt; &gt; &gt; &gt; tmp
&gt; &gt; &gt; &gt; &gt; &gt; &gt; current there were:
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; [jsymons@larva nrls]$ ls -l /tmp | grep -c &#39;.\{10\}$&#39;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 46498
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; Latest code with destory_query &#38; updated for 2.0.0 stable
&gt; &gt; &gt; &gt; &gt; &gt; &gt; at
&gt; &gt; &gt; &gt; &gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/v3xUJFeP">http://pastebin.com/v3xUJFeP</a></span>
</div>&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; ^without destroy_query
</div></div>&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;
</div></div>&gt; &gt;
&gt; &gt;
&gt; &gt; Hello Mark,
&gt; &gt;
&gt; &gt; I upgraded to 0.2222 as suggested:
&gt; &gt;
&gt; &gt; [jsymons@larva nrls]$ perl -MREST::Neo4p -E &#39;say
&gt; &gt; $REST::Neo4p::VERSION&#39;
&gt; &gt; 0.2222
&gt; &gt;
&gt; &gt; And I added $query-&gt;finish&#40;&#41; to the destroy_query sub and removed the
&gt; &gt; undef $query in the code in pastebin here:
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/mS2F5iJh">http://pastebin.com/mS2F5iJh</a></span>
&gt; &gt;
&gt; &gt; But after loading 500 rows from the spreadsheet without the undef in
&gt; &gt; place I end up with 7045 open files:
&gt; &gt;
&gt; &gt; [jsymons@larva nrls]$ /home/jsymons/extract_nrls.2.0.0_stable.pl
&gt; &gt; --input_file RA3_All.xlsx --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span> 2&gt;
&gt; &gt; RA3_All.xlsx.loading.error.log | tee RA3_All.xlsx.loading.log
&gt; &gt; Processed 500 rows. Thu Dec 19 06:18:46 2013
&gt; &gt;
&gt; &gt; [jsymons@larva nrls]$ ps -ef | grep extract
&gt; &gt;                                      jsymons   5268 19391 79 06:16
&gt; &gt; pts/11   00:00:05 /usr/bin/perl -w
&gt; &gt; /home/jsymons/extract_nrls.2.0.0_stable.pl --input_file RA3_All.xlsx
&gt; &gt; --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span>
&gt; &gt; jsymons   5271 20114  0 06:16 pts/13   00:00:00 grep extract
&gt; &gt; [jsymons@larva nrls]$ while true ; do echo &#34;/tmp has &#34; $&#40;lsof -p 5268
&gt; &gt; | grep -c &#39;/tmp/.\{10\}&#39;&#41; &#34; open files for pid&#34; ; sleep 10 ; done
&gt; &gt;          /tmp has  1086  open files for pid
&gt; &gt;          /tmp has  1612  open files for pid
&gt; &gt;          /tmp has  2122  open files for pid
&gt; &gt;          /tmp has  2634  open files for pid
&gt; &gt;          /tmp has  3201  open files for pid
&gt; &gt;          /tmp has  3783  open files for pid
&gt; &gt;          /tmp has  4317  open files for pid
&gt; &gt;          /tmp has  4838  open files for pid
&gt; &gt;          /tmp has  5387  open files for pid
&gt; &gt;          /tmp has  5933  open files for pid
&gt; &gt;          /tmp has  6479  open files for pid
&gt; &gt;          /tmp has  7045  open files for pid
&gt; &gt;
&gt; &gt; Actually even with undef on the newer code it&#39;s still worse than it
&gt; &gt; was with 0.126 as far as open files go because I also tried with
&gt; &gt; $query-finish&#40;&#41;; AND undef $query; and still had a huge amount of
&gt; &gt; open
&gt; &gt; files. Sub is below:
&gt; &gt;
&gt; &gt; sub destroy_query {
&gt; &gt;     my $query = shift;
&gt; &gt;
&gt; &gt; if &#40;defined&#40;$query&#41;&#41; {
&gt; &gt;     while &#40;my $response = $query-&gt;fetch&#40;&#41;&#41; {
&gt; &gt;         # Who cares, throw it out
&gt; &gt;     }
&gt; &gt;     $query-&gt;finish&#40;&#41;; # Cleanup suggested by Mark
&gt; &gt;     undef $query;
&gt; &gt; }
&gt; &gt; }
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;01&nbsp;12:16:54&nbsp;2014</span>
    <span class="description">maj.fortinbras [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ice-9, that&#39;s awesome. Looks like a cool application too. 
Happy New Year! MAJ
On Wed Jan 01 05:39:50 2014, symonsjo@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi MAJ,
&gt; 
&gt; So I&#39;ve updated the code and I&#39;ve confirmed that I now only have open
&gt; files for the queries I&#39;ve opened. I apologize that the last code I
&gt; pasted you wasn&#39;t correct but I&#39;ve updated the code even further and
&gt; it&#39;s working beautifully. Thanks. The updated code is here:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/GNaWKB48">http://pastebin.com/GNaWKB48</a></span>
&gt; 
&gt; ~ icenine
&gt; 
&gt; On Thu Dec 26 20:22:11 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; Hi Jo- I think you will get more mileage if you set the parameter
&gt; &gt; values in the execute&#40;&#41; method &#40;I don&#39;t see that in the paste&#41;; then
&gt; &gt; you don&#39;t have to create a separate query object for each set of
&gt; &gt; parameter values:
&gt; &gt; Rather than something like:
&gt; &gt;
&gt; &gt; $query = &#39;START n=...{my_parmA}...RETURN n&#39;;
&gt; &gt; $q1 = REST::Neo4p::Query-&gt;new&#40;$query, {my_parmA =&gt; 1}&#41;;
&gt; &gt; $q1-&gt;execute&#40;&#41;;
&gt; &gt; $q2 = REST::Neo4p::Query-&gt;new&#40;$query, {my_parmA =&gt; 2}&#41;;
&gt; &gt; $q2-&gt;execute&#40;&#41;;
&gt; &gt; ...
&gt; &gt;
&gt; &gt; try &#40;with v0.2222&#41;
&gt; &gt;
&gt; &gt; $query = &#39;START n=...{my_parmA}...RETURN n&#39;;
&gt; &gt; $q = REST::neo4p::Query-&gt;new&#40;$query&#41;;
&gt; &gt; for &#40;1..2&#41; {
&gt; &gt;  $q-&gt;execute&#40;{my_parmA =&gt; $_}&#41;;
&gt; &gt; }
&gt; &gt;
&gt; &gt; Here you&#39;re only creating one query object, but executing it multiple
&gt; &gt; times with new parameter values. I think this will cut down the
&gt; &gt; number
&gt; &gt; of open files.
&gt; &gt;
&gt; &gt; Let me know- MAJ
&gt; &gt;
&gt; &gt;
&gt; &gt; On Thu Dec 19 01:34:09 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; On Thu Dec 19 01:07:29 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; Hi Mark,
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; In my latest code I&#39;m using param queries to take advantage of
&gt; &gt; &gt; &gt; neo4j
&gt; &gt; &gt; &gt; query caching. That code is here: <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/mS2F5iJh">http://pastebin.com/mS2F5iJh</a></span>
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; I&#39;ll upgrade REST::Neo4p and integrate $query-&gt;finish&#40;&#41; into my
&gt; &gt; &gt; &gt; destroy_query method from the code above &#40;and drop undef $query&#41;.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; On Wed Dec 18 20:53:36 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; oops - a bug in the sample below, should be
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; while &#40; &#40;$id,$lev&#41; = @{pop @incident_and_category_params} &#41;
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; On Wed Dec 18 20:42:30 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; Ok, I will think a bit harder about this.
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; In the latest version &#40;0.2222&#41;, there are a couple of things
&gt; &gt; &gt; &gt; &gt; &gt; that
&gt; &gt; &gt; &gt; &gt; &gt; might help. If you have thousands of files open, then
&gt; &gt; &gt; &gt; &gt; &gt; presumably
&gt; &gt; &gt; &gt; &gt; &gt; there
&gt; &gt; &gt; &gt; &gt; &gt; are thousands of live query objects &#40;without destroy_query&#41;.
&gt; &gt; &gt; &gt; &gt; &gt; That&#39;s
&gt; &gt; &gt; &gt; &gt; &gt; probably my bad at some level. Not sure why the files are not
&gt; &gt; &gt; &gt; &gt; &gt; cleaned
&gt; &gt; &gt; &gt; &gt; &gt; up when $neo4p_query is reassigned to a new query. Old object
&gt; &gt; &gt; &gt; &gt; &gt; should
&gt; &gt; &gt; &gt; &gt; &gt; go away at that point.
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; However, in the latest version, execute&#40;&#41; can take parameter
&gt; &gt; &gt; &gt; &gt; &gt; assignments as arguments, and there is now &#40;as you suggested
&gt; &gt; &gt; &gt; &gt; &gt; before&#41; a
&gt; &gt; &gt; &gt; &gt; &gt; finish&#40;&#41; method that will delete the tmp file but leave the
&gt; &gt; &gt; &gt; &gt; &gt; object
&gt; &gt; &gt; &gt; &gt; &gt; intact. So you could prepare the queries before you start the
&gt; &gt; &gt; &gt; &gt; &gt; loop,
&gt; &gt; &gt; &gt; &gt; &gt; and use finish at the end of the loop:
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; $incident_query =
&gt; &gt; &gt; &gt; &gt; &gt;             &#39;MATCH &#40;i:INCIDENT&#41;, &#40;ic:INCIDENT_CATEGORY&#41;&#39;
&gt; &gt; &gt; &gt; &gt; &gt;             . &#39; WHERE i.incident_id = { incident_id }&#39;
&gt; &gt; &gt; &gt; &gt; &gt;             . &#39; AND ic.category_level_01 = {
&gt; &gt; &gt; &gt; &gt; &gt; category_level_01
&gt; &gt; &gt; &gt; &gt; &gt; }&#39;
&gt; &gt; &gt; &gt; &gt; &gt;             . &#39; CREATE UNIQUE&#39;
&gt; &gt; &gt; &gt; &gt; &gt;             . &#39; ic&lt;-[r:HAS_INCIDENT_CATEGORY]-i RETURN r&#39;;
&gt; &gt; &gt; &gt; &gt; &gt; $incident_query_obj = REST::Neo4p::Query-
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt;new&#40;$incident_query&#41;;
</div>&gt; &gt; &gt; &gt; &gt; &gt; # suppose an array of 2-elt arrays with desired parm
&gt; &gt; &gt; &gt; &gt; &gt; combinations:
&gt; &gt; &gt; &gt; &gt; &gt; while &#40; &#40;$id,$lev&#41; = @{pop @{ @incident_and_category_params
&gt; &gt; &gt; &gt; &gt; &gt; }}
&gt; &gt; &gt; &gt; &gt; &gt; &#41;
&gt; &gt; &gt; &gt; &gt; &gt; {
&gt; &gt; &gt; &gt; &gt; &gt;   $incident_query_obj-&gt;execute&#40; incident_id =&gt; $id,
&gt; &gt; &gt; &gt; &gt; &gt;                                 category_level_01 =&gt; $lev &#41;;
&gt; &gt; &gt; &gt; &gt; &gt;   while &#40;my $row = $incident_query_obj-&gt;fetch&#41; {
&gt; &gt; &gt; &gt; &gt; &gt;      ...
&gt; &gt; &gt; &gt; &gt; &gt;      last if $GOT_WHAT_I_WANT;
&gt; &gt; &gt; &gt; &gt; &gt;   }
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; $incident_query_obj-&gt;finish&#40;&#41;;
&gt; &gt; &gt; &gt; &gt; &gt; }
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Each time you call finish, the tmp file is deleted, and each
&gt; &gt; &gt; &gt; &gt; &gt; time
&gt; &gt; &gt; &gt; &gt; &gt; you
&gt; &gt; &gt; &gt; &gt; &gt; call execute a tmp file is created, but all within one query
&gt; &gt; &gt; &gt; &gt; &gt; instance.
&gt; &gt; &gt; &gt; &gt; &gt; You can set up multiple such query instances outside the loop
&gt; &gt; &gt; &gt; &gt; &gt; and
&gt; &gt; &gt; &gt; &gt; &gt; use
&gt; &gt; &gt; &gt; &gt; &gt; the parameter bindings within the loop. Should make the code
&gt; &gt; &gt; &gt; &gt; &gt; more
&gt; &gt; &gt; &gt; &gt; &gt; maintainable too.
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Please try and let me know. I REALLY appreciate this
&gt; &gt; &gt; &gt; &gt; &gt; feedback!
&gt; &gt; &gt; &gt; &gt; &gt; best MAJ
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; On Wed Dec 18 16:23:59 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; On Wed Dec 18 16:06:10 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; On Tue Nov 05 23:42:29 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; Calling this resolved; please reopen if necessary.
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; thanks
</div>&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; I don&#39;t think this is resolved, in fact without
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; destroy_query
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; there&#39;s
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; a whole lot more files open at once, the below result is
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; after
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; loading
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; only 2500 rows.
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; [jsymons@larva nrls]$ perl -MREST::Neo4p -E &#39;say
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; $REST::Neo4p::VERSION&#39;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; 0.126
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; [jsymons@larva nrls]$ ps -ef | grep extract
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; jsymons  20538 19391 64 20:46 pts/11   00:06:49
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; /usr/bin/perl
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; -w
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; /home/jsymons/extract_nrls.2.0.0_stable.pl --input_file
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; RA3_All.xlsx
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span>
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; jsymons  21582 20114  0 20:56 pts/13   00:00:00 grep
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; extract
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; [jsymons@larva nrls]$ lsof -p 20538 | grep -c
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &#39;/tmp/.\{10\}&#39;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; 38071
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; And once I killed the script at between 3000 &#38; 3500 rows,
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; in
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; tmp
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; current there were:
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; [jsymons@larva nrls]$ ls -l /tmp | grep -c &#39;.\{10\}$&#39;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; 46498
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; Latest code with destory_query &#38; updated for 2.0.0 stable
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; at
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/v3xUJFeP">http://pastebin.com/v3xUJFeP</a></span>
</div>&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; ^without destroy_query
</div></div>&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt;
</div></div>&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; Hello Mark,
&gt; &gt; &gt;
&gt; &gt; &gt; I upgraded to 0.2222 as suggested:
&gt; &gt; &gt;
&gt; &gt; &gt; [jsymons@larva nrls]$ perl -MREST::Neo4p -E &#39;say
&gt; &gt; &gt; $REST::Neo4p::VERSION&#39;
&gt; &gt; &gt; 0.2222
&gt; &gt; &gt;
&gt; &gt; &gt; And I added $query-&gt;finish&#40;&#41; to the destroy_query sub and removed
&gt; &gt; &gt; the
&gt; &gt; &gt; undef $query in the code in pastebin here:
&gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/mS2F5iJh">http://pastebin.com/mS2F5iJh</a></span>
&gt; &gt; &gt;
&gt; &gt; &gt; But after loading 500 rows from the spreadsheet without the undef
&gt; &gt; &gt; in
&gt; &gt; &gt; place I end up with 7045 open files:
&gt; &gt; &gt;
&gt; &gt; &gt; [jsymons@larva nrls]$ /home/jsymons/extract_nrls.2.0.0_stable.pl
&gt; &gt; &gt; --input_file RA3_All.xlsx --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span> 2&gt;
&gt; &gt; &gt; RA3_All.xlsx.loading.error.log | tee RA3_All.xlsx.loading.log
&gt; &gt; &gt; Processed 500 rows. Thu Dec 19 06:18:46 2013
&gt; &gt; &gt;
&gt; &gt; &gt; [jsymons@larva nrls]$ ps -ef | grep extract
&gt; &gt; &gt;                                      jsymons   5268 19391 79 06:16
&gt; &gt; &gt; pts/11   00:00:05 /usr/bin/perl -w
&gt; &gt; &gt; /home/jsymons/extract_nrls.2.0.0_stable.pl --input_file
&gt; &gt; &gt; RA3_All.xlsx
&gt; &gt; &gt; --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span>
&gt; &gt; &gt; jsymons   5271 20114  0 06:16 pts/13   00:00:00 grep extract
&gt; &gt; &gt; [jsymons@larva nrls]$ while true ; do echo &#34;/tmp has &#34; $&#40;lsof -p
&gt; &gt; &gt; 5268
&gt; &gt; &gt; | grep -c &#39;/tmp/.\{10\}&#39;&#41; &#34; open files for pid&#34; ; sleep 10 ; done
&gt; &gt; &gt;          /tmp has  1086  open files for pid
&gt; &gt; &gt;          /tmp has  1612  open files for pid
&gt; &gt; &gt;          /tmp has  2122  open files for pid
&gt; &gt; &gt;          /tmp has  2634  open files for pid
&gt; &gt; &gt;          /tmp has  3201  open files for pid
&gt; &gt; &gt;          /tmp has  3783  open files for pid
&gt; &gt; &gt;          /tmp has  4317  open files for pid
&gt; &gt; &gt;          /tmp has  4838  open files for pid
&gt; &gt; &gt;          /tmp has  5387  open files for pid
&gt; &gt; &gt;          /tmp has  5933  open files for pid
&gt; &gt; &gt;          /tmp has  6479  open files for pid
&gt; &gt; &gt;          /tmp has  7045  open files for pid
&gt; &gt; &gt;
&gt; &gt; &gt; Actually even with undef on the newer code it&#39;s still worse than it
&gt; &gt; &gt; was with 0.126 as far as open files go because I also tried with
&gt; &gt; &gt; $query-finish&#40;&#41;; AND undef $query; and still had a huge amount of
&gt; &gt; &gt; open
&gt; &gt; &gt; files. Sub is below:
&gt; &gt; &gt;
&gt; &gt; &gt; sub destroy_query {
&gt; &gt; &gt;     my $query = shift;
&gt; &gt; &gt;
&gt; &gt; &gt; if &#40;defined&#40;$query&#41;&#41; {
&gt; &gt; &gt;     while &#40;my $response = $query-&gt;fetch&#40;&#41;&#41; {
&gt; &gt; &gt;         # Who cares, throw it out
&gt; &gt; &gt;     }
&gt; &gt; &gt;     $query-&gt;finish&#40;&#41;; # Cleanup suggested by Mark
&gt; &gt; &gt;     undef $query;
&gt; &gt; &gt; }
&gt; &gt; &gt; }
</div></div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;01&nbsp;12:17:17&nbsp;2014</span>
    <span class="description">maj.fortinbras [...] gmail.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;01&nbsp;12:17:17&nbsp;2014</span>
    <span class="description">maj.fortinbras [...] gmail.com -  Fixed in 0.2220 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;01&nbsp;12:17:17&nbsp;2014</span>
    <span class="description">maj.fortinbras [...] gmail.com -  Fixed in 0.2111 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;01&nbsp;12:44:38&nbsp;2014</span>
    <span class="description">symonsjo [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> symonsjo [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks MAJ, happy new year as well.

~ icenine

On Wed Jan 01 12:16:54 2014, MAJENSEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Ice-9, that&#39;s awesome. Looks like a cool application too. 
&gt; Happy New Year! MAJ
&gt; On Wed Jan 01 05:39:50 2014, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; Hi MAJ,
&gt; &gt; 
&gt; &gt; So I&#39;ve updated the code and I&#39;ve confirmed that I now only have open
&gt; &gt; files for the queries I&#39;ve opened. I apologize that the last code I
&gt; &gt; pasted you wasn&#39;t correct but I&#39;ve updated the code even further and
&gt; &gt; it&#39;s working beautifully. Thanks. The updated code is here:
&gt; &gt; 
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/GNaWKB48">http://pastebin.com/GNaWKB48</a></span>
&gt; &gt; 
&gt; &gt; ~ icenine
&gt; &gt; 
&gt; &gt; On Thu Dec 26 20:22:11 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; &gt; Hi Jo- I think you will get more mileage if you set the parameter
&gt; &gt; &gt; values in the execute&#40;&#41; method &#40;I don&#39;t see that in the paste&#41;; then
&gt; &gt; &gt; you don&#39;t have to create a separate query object for each set of
&gt; &gt; &gt; parameter values:
&gt; &gt; &gt; Rather than something like:
&gt; &gt; &gt;
&gt; &gt; &gt; $query = &#39;START n=...{my_parmA}...RETURN n&#39;;
&gt; &gt; &gt; $q1 = REST::Neo4p::Query-&gt;new&#40;$query, {my_parmA =&gt; 1}&#41;;
&gt; &gt; &gt; $q1-&gt;execute&#40;&#41;;
&gt; &gt; &gt; $q2 = REST::Neo4p::Query-&gt;new&#40;$query, {my_parmA =&gt; 2}&#41;;
&gt; &gt; &gt; $q2-&gt;execute&#40;&#41;;
&gt; &gt; &gt; ...
&gt; &gt; &gt;
&gt; &gt; &gt; try &#40;with v0.2222&#41;
&gt; &gt; &gt;
&gt; &gt; &gt; $query = &#39;START n=...{my_parmA}...RETURN n&#39;;
&gt; &gt; &gt; $q = REST::neo4p::Query-&gt;new&#40;$query&#41;;
&gt; &gt; &gt; for &#40;1..2&#41; {
&gt; &gt; &gt;  $q-&gt;execute&#40;{my_parmA =&gt; $_}&#41;;
&gt; &gt; &gt; }
&gt; &gt; &gt;
&gt; &gt; &gt; Here you&#39;re only creating one query object, but executing it multiple
&gt; &gt; &gt; times with new parameter values. I think this will cut down the
&gt; &gt; &gt; number
&gt; &gt; &gt; of open files.
&gt; &gt; &gt;
&gt; &gt; &gt; Let me know- MAJ
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; On Thu Dec 19 01:34:09 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; On Thu Dec 19 01:07:29 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; Hi Mark,
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; In my latest code I&#39;m using param queries to take advantage of
&gt; &gt; &gt; &gt; &gt; neo4j
&gt; &gt; &gt; &gt; &gt; query caching. That code is here: <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/mS2F5iJh">http://pastebin.com/mS2F5iJh</a></span>
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; I&#39;ll upgrade REST::Neo4p and integrate $query-&gt;finish&#40;&#41; into my
&gt; &gt; &gt; &gt; &gt; destroy_query method from the code above &#40;and drop undef $query&#41;.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; On Wed Dec 18 20:53:36 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; oops - a bug in the sample below, should be
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; while &#40; &#40;$id,$lev&#41; = @{pop @incident_and_category_params} &#41;
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; On Wed Dec 18 20:42:30 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; Ok, I will think a bit harder about this.
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; In the latest version &#40;0.2222&#41;, there are a couple of things
&gt; &gt; &gt; &gt; &gt; &gt; &gt; that
&gt; &gt; &gt; &gt; &gt; &gt; &gt; might help. If you have thousands of files open, then
&gt; &gt; &gt; &gt; &gt; &gt; &gt; presumably
&gt; &gt; &gt; &gt; &gt; &gt; &gt; there
&gt; &gt; &gt; &gt; &gt; &gt; &gt; are thousands of live query objects &#40;without destroy_query&#41;.
&gt; &gt; &gt; &gt; &gt; &gt; &gt; That&#39;s
&gt; &gt; &gt; &gt; &gt; &gt; &gt; probably my bad at some level. Not sure why the files are not
&gt; &gt; &gt; &gt; &gt; &gt; &gt; cleaned
&gt; &gt; &gt; &gt; &gt; &gt; &gt; up when $neo4p_query is reassigned to a new query. Old object
&gt; &gt; &gt; &gt; &gt; &gt; &gt; should
&gt; &gt; &gt; &gt; &gt; &gt; &gt; go away at that point.
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; However, in the latest version, execute&#40;&#41; can take parameter
&gt; &gt; &gt; &gt; &gt; &gt; &gt; assignments as arguments, and there is now &#40;as you suggested
&gt; &gt; &gt; &gt; &gt; &gt; &gt; before&#41; a
&gt; &gt; &gt; &gt; &gt; &gt; &gt; finish&#40;&#41; method that will delete the tmp file but leave the
&gt; &gt; &gt; &gt; &gt; &gt; &gt; object
&gt; &gt; &gt; &gt; &gt; &gt; &gt; intact. So you could prepare the queries before you start the
&gt; &gt; &gt; &gt; &gt; &gt; &gt; loop,
&gt; &gt; &gt; &gt; &gt; &gt; &gt; and use finish at the end of the loop:
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; $incident_query =
&gt; &gt; &gt; &gt; &gt; &gt; &gt;             &#39;MATCH &#40;i:INCIDENT&#41;, &#40;ic:INCIDENT_CATEGORY&#41;&#39;
&gt; &gt; &gt; &gt; &gt; &gt; &gt;             . &#39; WHERE i.incident_id = { incident_id }&#39;
&gt; &gt; &gt; &gt; &gt; &gt; &gt;             . &#39; AND ic.category_level_01 = {
&gt; &gt; &gt; &gt; &gt; &gt; &gt; category_level_01
&gt; &gt; &gt; &gt; &gt; &gt; &gt; }&#39;
&gt; &gt; &gt; &gt; &gt; &gt; &gt;             . &#39; CREATE UNIQUE&#39;
&gt; &gt; &gt; &gt; &gt; &gt; &gt;             . &#39; ic&lt;-[r:HAS_INCIDENT_CATEGORY]-i RETURN r&#39;;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; $incident_query_obj = REST::Neo4p::Query-
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;new&#40;$incident_query&#41;;
</div>&gt; &gt; &gt; &gt; &gt; &gt; &gt; # suppose an array of 2-elt arrays with desired parm
&gt; &gt; &gt; &gt; &gt; &gt; &gt; combinations:
&gt; &gt; &gt; &gt; &gt; &gt; &gt; while &#40; &#40;$id,$lev&#41; = @{pop @{ @incident_and_category_params
&gt; &gt; &gt; &gt; &gt; &gt; &gt; }}
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &#41;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; {
&gt; &gt; &gt; &gt; &gt; &gt; &gt;   $incident_query_obj-&gt;execute&#40; incident_id =&gt; $id,
&gt; &gt; &gt; &gt; &gt; &gt; &gt;                                 category_level_01 =&gt; $lev &#41;;
&gt; &gt; &gt; &gt; &gt; &gt; &gt;   while &#40;my $row = $incident_query_obj-&gt;fetch&#41; {
&gt; &gt; &gt; &gt; &gt; &gt; &gt;      ...
&gt; &gt; &gt; &gt; &gt; &gt; &gt;      last if $GOT_WHAT_I_WANT;
&gt; &gt; &gt; &gt; &gt; &gt; &gt;   }
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; $incident_query_obj-&gt;finish&#40;&#41;;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; }
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; Each time you call finish, the tmp file is deleted, and each
&gt; &gt; &gt; &gt; &gt; &gt; &gt; time
&gt; &gt; &gt; &gt; &gt; &gt; &gt; you
&gt; &gt; &gt; &gt; &gt; &gt; &gt; call execute a tmp file is created, but all within one query
&gt; &gt; &gt; &gt; &gt; &gt; &gt; instance.
&gt; &gt; &gt; &gt; &gt; &gt; &gt; You can set up multiple such query instances outside the loop
&gt; &gt; &gt; &gt; &gt; &gt; &gt; and
&gt; &gt; &gt; &gt; &gt; &gt; &gt; use
&gt; &gt; &gt; &gt; &gt; &gt; &gt; the parameter bindings within the loop. Should make the code
&gt; &gt; &gt; &gt; &gt; &gt; &gt; more
&gt; &gt; &gt; &gt; &gt; &gt; &gt; maintainable too.
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; Please try and let me know. I REALLY appreciate this
&gt; &gt; &gt; &gt; &gt; &gt; &gt; feedback!
&gt; &gt; &gt; &gt; &gt; &gt; &gt; best MAJ
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; On Wed Dec 18 16:23:59 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; On Wed Dec 18 16:06:10 2013, symonsjo@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; On Tue Nov 05 23:42:29 2013, MAJENSEN wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; Calling this resolved; please reopen if necessary.
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; thanks
</div>&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; I don&#39;t think this is resolved, in fact without
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; destroy_query
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; there&#39;s
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; a whole lot more files open at once, the below result is
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; after
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; loading
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; only 2500 rows.
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; [jsymons@larva nrls]$ perl -MREST::Neo4p -E &#39;say
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; $REST::Neo4p::VERSION&#39;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; 0.126
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; [jsymons@larva nrls]$ ps -ef | grep extract
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; jsymons  20538 19391 64 20:46 pts/11   00:06:49
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; /usr/bin/perl
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; -w
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; /home/jsymons/extract_nrls.2.0.0_stable.pl --input_file
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; RA3_All.xlsx
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span>
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; jsymons  21582 20114  0 20:56 pts/13   00:00:00 grep
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; extract
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; [jsymons@larva nrls]$ lsof -p 20538 | grep -c
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &#39;/tmp/.\{10\}&#39;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; 38071
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; And once I killed the script at between 3000 &#38; 3500 rows,
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; in
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; tmp
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; current there were:
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; [jsymons@larva nrls]$ ls -l /tmp | grep -c &#39;.\{10\}$&#39;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; 46498
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; Latest code with destory_query &#38; updated for 2.0.0 stable
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; at
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/v3xUJFeP">http://pastebin.com/v3xUJFeP</a></span>
</div>&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; ^without destroy_query
</div></div>&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt;
</div></div>&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Hello Mark,
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; I upgraded to 0.2222 as suggested:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; [jsymons@larva nrls]$ perl -MREST::Neo4p -E &#39;say
&gt; &gt; &gt; &gt; $REST::Neo4p::VERSION&#39;
&gt; &gt; &gt; &gt; 0.2222
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; And I added $query-&gt;finish&#40;&#41; to the destroy_query sub and removed
&gt; &gt; &gt; &gt; the
&gt; &gt; &gt; &gt; undef $query in the code in pastebin here:
&gt; &gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://pastebin.com/mS2F5iJh">http://pastebin.com/mS2F5iJh</a></span>
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; But after loading 500 rows from the spreadsheet without the undef
&gt; &gt; &gt; &gt; in
&gt; &gt; &gt; &gt; place I end up with 7045 open files:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; [jsymons@larva nrls]$ /home/jsymons/extract_nrls.2.0.0_stable.pl
&gt; &gt; &gt; &gt; --input_file RA3_All.xlsx --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span> 2&gt;
&gt; &gt; &gt; &gt; RA3_All.xlsx.loading.error.log | tee RA3_All.xlsx.loading.log
&gt; &gt; &gt; &gt; Processed 500 rows. Thu Dec 19 06:18:46 2013
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; [jsymons@larva nrls]$ ps -ef | grep extract
&gt; &gt; &gt; &gt;                                      jsymons   5268 19391 79 06:16
&gt; &gt; &gt; &gt; pts/11   00:00:05 /usr/bin/perl -w
&gt; &gt; &gt; &gt; /home/jsymons/extract_nrls.2.0.0_stable.pl --input_file
&gt; &gt; &gt; &gt; RA3_All.xlsx
&gt; &gt; &gt; &gt; --neo_uri=<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost:7474">http://localhost:7474</a></span>
&gt; &gt; &gt; &gt; jsymons   5271 20114  0 06:16 pts/13   00:00:00 grep extract
&gt; &gt; &gt; &gt; [jsymons@larva nrls]$ while true ; do echo &#34;/tmp has &#34; $&#40;lsof -p
&gt; &gt; &gt; &gt; 5268
&gt; &gt; &gt; &gt; | grep -c &#39;/tmp/.\{10\}&#39;&#41; &#34; open files for pid&#34; ; sleep 10 ; done
&gt; &gt; &gt; &gt;          /tmp has  1086  open files for pid
&gt; &gt; &gt; &gt;          /tmp has  1612  open files for pid
&gt; &gt; &gt; &gt;          /tmp has  2122  open files for pid
&gt; &gt; &gt; &gt;          /tmp has  2634  open files for pid
&gt; &gt; &gt; &gt;          /tmp has  3201  open files for pid
&gt; &gt; &gt; &gt;          /tmp has  3783  open files for pid
&gt; &gt; &gt; &gt;          /tmp has  4317  open files for pid
&gt; &gt; &gt; &gt;          /tmp has  4838  open files for pid
&gt; &gt; &gt; &gt;          /tmp has  5387  open files for pid
&gt; &gt; &gt; &gt;          /tmp has  5933  open files for pid
&gt; &gt; &gt; &gt;          /tmp has  6479  open files for pid
&gt; &gt; &gt; &gt;          /tmp has  7045  open files for pid
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Actually even with undef on the newer code it&#39;s still worse than it
&gt; &gt; &gt; &gt; was with 0.126 as far as open files go because I also tried with
&gt; &gt; &gt; &gt; $query-finish&#40;&#41;; AND undef $query; and still had a huge amount of
&gt; &gt; &gt; &gt; open
&gt; &gt; &gt; &gt; files. Sub is below:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; sub destroy_query {
&gt; &gt; &gt; &gt;     my $query = shift;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; if &#40;defined&#40;$query&#41;&#41; {
&gt; &gt; &gt; &gt;     while &#40;my $response = $query-&gt;fetch&#40;&#41;&#41; {
&gt; &gt; &gt; &gt;         # Who cares, throw it out
&gt; &gt; &gt; &gt;     }
&gt; &gt; &gt; &gt;     $query-&gt;finish&#40;&#41;; # Cleanup suggested by Mark
&gt; &gt; &gt; &gt;     undef $query;
&gt; &gt; &gt; &gt; }
&gt; &gt; &gt; &gt; }
</div></div></div>&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
