<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #107103 for IO-Socket-IP: multi-homed non-blocking connect looks broken with epoll &#40;and kqueue, i believe&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #107103 for IO-Socket-IP: multi-homed non-blocking connect looks broken with epoll &#40;and kqueue, i believe&#41;</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=IO-Socket-IP">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=IO-Socket-IP">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=IO-Socket-IP">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=IO-Socket-IP">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/IO-Socket-IP">IO-Socket-IP CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">107103</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=IO-Socket-IP">IO-Socket-IP</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
oleg [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
sri [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-234790-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.37    </td>
  </tr>
  <tr id="CF-234791-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=107103">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1535507" href="/Public/Bug/Display.html?id=107103#txn-1535507">#</a>      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;15&nbsp;09:15:29&nbsp;2015</span>
    <span class="description">oleg [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> sri [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> multi-homed non-blocking connect looks broken with epoll &#40;and
 kqueue, i believe&#41;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1535507/819496/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/819496">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 347b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">We faced with this inside Mojolicious. Please see this topic &#40;especially strace log&#41;: <span class="clickylink"><a target="new" rel="nofollow" href="https://groups.google.com/forum/#!topic/mojolicious/RetqP4QsyHU">https://groups.google.com/forum/#!topic/mojolicious/RetqP4QsyHU</a></span>

Here you can see some description why dup2&#40;&#41; call removes descriptor from epoll watcher:
<span class="clickylink"><a target="new" rel="nofollow" href="http://stackoverflow.com/questions/27948251/why-epoll-wait-doesnt-react-on-dup2writable-fd-non-writable-fd">http://stackoverflow.com/questions/27948251/why-epoll-wait-doesnt-react-on-dup2writable-fd-non-writable-fd</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1535542" href="/Public/Bug/Display.html?id=107103#txn-1535542">#</a>      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;15&nbsp;09:52:17&nbsp;2015</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1535542/819513/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/819513">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Sep 15 09:15:29 2015, OLEG wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; We faced with this inside Mojolicious. Please see this topic
&gt; &#40;especially strace log&#41;:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://groups.google.com/forum/#!topic/mojolicious/RetqP4QsyHU">https://groups.google.com/forum/#!topic/mojolicious/RetqP4QsyHU</a></span>
</div>
Ahyes, you have stumbled upon the bug alluded to in

  <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/PEVANS/IO-Socket-IP-0.37/lib/IO/Socket/IP.pm#L1200">https://metacpan.org/source/PEVANS/IO-Socket-IP-0.37/lib/IO/Socket/IP.pm#L1200</a></span>

Ultimately, I&#39;m not sure that IO::Socket::IP alone can do anything about this. It *has* to be able to switch between different socket filehandles, because it might have to swap between PF_INET and PF_INET6, and that cannot be done to an open filehandle.

The failing is in the way that it is being used by the application. The application would need some way to remove and re-add the appropriate filehandle to that persistent mechanism &#40;epoll, kqueue, etc...&#41; each time the no-arg -&gt;connect call is made again to request that it continue.

Currently it could be done by always just removing the filehandle before that -&gt;connect call and adding it again afterwards. I think in practice it&#39;s unlikely to ever be the case that you don&#39;t have to do that - the only thing -&gt;connect is going to do is check for success, and lacking success it will just destroy and recreate the socket anyway.

I could probably add something of that effect to the documentation.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1535543" href="/Public/Bug/Display.html?id=107103#txn-1535543">#</a>      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;15&nbsp;09:52:18&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1535545" href="/Public/Bug/Display.html?id=107103#txn-1535545">#</a>      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;15&nbsp;09:52:24&nbsp;2015</span>
    <span class="description">oleg [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1535545/819515/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/819515">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Втр Сен 15 09:15:29 2015, OLEG писал:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; We faced with this inside Mojolicious. Please see this topic
&gt; &#40;especially strace log&#41;:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://groups.google.com/forum/#!topic/mojolicious/RetqP4QsyHU">https://groups.google.com/forum/#!topic/mojolicious/RetqP4QsyHU</a></span>
&gt; 
&gt; Here you can see some description why dup2&#40;&#41; call removes descriptor
&gt; from epoll watcher:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://stackoverflow.com/questions/27948251/why-epoll-wait-doesnt-">http://stackoverflow.com/questions/27948251/why-epoll-wait-doesnt-</a></span>
&gt; react-on-dup2writable-fd-non-writable-fd
</div>

Here is an example which confirms this problem on Linux.
$ cat /etc/hosts
127.0.0.1       localhost
::1            localhost

$ cat s.pl
use strict;
use IO::Socket::INET;

my $serv = IO::Socket::INET-&gt;new&#40;LocalPort =&gt; 1025, Listen =&gt; 10&#41;
        or die $@;

warn &#34;Listening...\n&#34;;

while &#40;my $client = $serv-&gt;accept&#40;&#41;&#41; {
        $client-&gt;syswrite&#40;&#34;!&#34;&#41;;
}

$ cat c.pl
use strict;
use IO::Socket::IP;
use AnyEvent;
use Errno qw/EINPROGRESS EWOULDBLOCK/;

my $sock = IO::Socket::IP-&gt;new&#40;PeerAddr =&gt; &#34;localhost&#34;, PeerPort =&gt; 1025, Blocking =&gt; 0&#41;
        or die $@;

my $cv = AnyEvent-&gt;condvar;

my $t = AnyEvent-&gt;timer&#40;
        after =&gt; 5,
        cb    =&gt; sub {
                warn &#34;Timeout!&#34;;
                $cv-&gt;send;
        }
&#41;;


my $w = AnyEvent-&gt;io&#40;
        fh   =&gt; $sock,
        poll =&gt; &#39;w&#39;,
        cb   =&gt; sub {
                if &#40;$sock-&gt;connect&#41; {
                        warn &#34;Connected!&#34;;
                        $cv-&gt;send;
                }
                elsif &#40;$! != EINPROGRESS &#38;&#38; $! != EWOULDBLOCK&#41; {
                        warn &#34;Connection failed!&#34;;
                        $cv-&gt;send;
                }
        }
&#41;;

$cv-&gt;recv;

__END__

$ ./s.pl
Listening...

$ ./c.pl
Timeout!

Expected result is: &#34;Connected!&#34;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1535555" href="/Public/Bug/Display.html?id=107103#txn-1535555">#</a>      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;15&nbsp;09:56:49&nbsp;2015</span>
    <span class="description">oleg [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1535555/819521/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/819521">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Втр Сен 15 09:52:24 2015, OLEG писал:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Втр Сен 15 09:15:29 2015, OLEG писал:
<div class="message-stanza open">&gt; &gt; We faced with this inside Mojolicious. Please see this topic
&gt; &gt; &#40;especially strace log&#41;:
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://groups.google.com/forum/#!topic/mojolicious/RetqP4QsyHU">https://groups.google.com/forum/#!topic/mojolicious/RetqP4QsyHU</a></span>
&gt; &gt;
&gt; &gt; Here you can see some description why dup2&#40;&#41; call removes descriptor
&gt; &gt; from epoll watcher:
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://stackoverflow.com/questions/27948251/why-epoll-wait-doesnt-">http://stackoverflow.com/questions/27948251/why-epoll-wait-doesnt-</a></span>
&gt; &gt; react-on-dup2writable-fd-non-writable-fd
</div>&gt; 
&gt; 
&gt; Here is an example which confirms this problem on Linux.
&gt; $ cat /etc/hosts
&gt; 127.0.0.1       localhost
&gt; ::1            localhost
&gt; 
&gt; $ cat s.pl
&gt; use strict;
&gt; use IO::Socket::INET;
&gt; 
&gt; my $serv = IO::Socket::INET-&gt;new&#40;LocalPort =&gt; 1025, Listen =&gt; 10&#41;
&gt;         or die $@;
&gt; 
&gt; warn &#34;Listening...\n&#34;;
&gt; 
&gt; while &#40;my $client = $serv-&gt;accept&#40;&#41;&#41; {
&gt;         $client-&gt;syswrite&#40;&#34;!&#34;&#41;;
&gt; }
&gt; 
&gt; $ cat c.pl
&gt; use strict;
&gt; use IO::Socket::IP;
&gt; use AnyEvent;
&gt; use Errno qw/EINPROGRESS EWOULDBLOCK/;
&gt; 
&gt; my $sock = IO::Socket::IP-&gt;new&#40;PeerAddr =&gt; &#34;localhost&#34;, PeerPort =&gt;
&gt; 1025, Blocking =&gt; 0&#41;
&gt;         or die $@;
&gt; 
&gt; my $cv = AnyEvent-&gt;condvar;
&gt; 
&gt; my $t = AnyEvent-&gt;timer&#40;
&gt;         after =&gt; 5,
&gt;         cb    =&gt; sub {
&gt;                 warn &#34;Timeout!&#34;;
&gt;                 $cv-&gt;send;
&gt;         }
&gt; &#41;;
&gt; 
&gt; 
&gt; my $w = AnyEvent-&gt;io&#40;
&gt;         fh   =&gt; $sock,
&gt;         poll =&gt; &#39;w&#39;,
&gt;         cb   =&gt; sub {
&gt;                 if &#40;$sock-&gt;connect&#41; {
&gt;                         warn &#34;Connected!&#34;;
&gt;                         $cv-&gt;send;
&gt;                 }
&gt;                 elsif &#40;$! != EINPROGRESS &#38;&#38; $! != EWOULDBLOCK&#41; {
&gt;                         warn &#34;Connection failed!&#34;;
&gt;                         $cv-&gt;send;
&gt;                 }
&gt;         }
&gt; &#41;;
&gt; 
&gt; $cv-&gt;recv;
&gt; 
&gt; __END__
&gt; 
&gt; $ ./s.pl
&gt; Listening...
&gt; 
&gt; $ ./c.pl
&gt; Timeout!
&gt; 
&gt; Expected result is: &#34;Connected!&#34;
</div>
Forgot to say:
LIBEV_FLAGS=2 perl c.pl &#40;this works - poll backend&#41;
LIBEV_FLAGS=4 perl c.pl &#40;doesn&#39;t work - epoll backend&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1535564" href="/Public/Bug/Display.html?id=107103#txn-1535564">#</a>      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;15&nbsp;10:00:39&nbsp;2015</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1535564/819527/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/819527">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 832b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Sep 15 09:52:24 2015, OLEG wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Here is an example which confirms this problem on Linux.
</div>...
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; my $w = AnyEvent-&gt;io&#40;
&gt;         fh   =&gt; $sock,
&gt;         poll =&gt; &#39;w&#39;,
&gt;         cb   =&gt; sub {
&gt;                 if &#40;$sock-&gt;connect&#41; {
&gt;                         warn &#34;Connected!&#34;;
&gt;                         $cv-&gt;send;
&gt;                 }
&gt;                 elsif &#40;$! != EINPROGRESS &#38;&#38; $! != EWOULDBLOCK&#41; {
&gt;                         warn &#34;Connection failed!&#34;;
&gt;                         $cv-&gt;send;
&gt;                 }
&gt;         }
&gt; &#41;;
</div>
Yes; this would be the core of the issue. You&#39;re presumably only &#39;add&#39;ing the $sock FD once to the persistent &#40;e.g. epoll&#41; muxer once, whereas you&#39;d need to remove/add it each time you call -&gt;connect. I&#39;m afraid I don&#39;t know the relevant AnyEvent&#39;ism to arrange for that though.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1535566" href="/Public/Bug/Display.html?id=107103#txn-1535566">#</a>      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;15&nbsp;10:05:13&nbsp;2015</span>
    <span class="description">oleg [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1535566/819529/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/819529">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Втр Сен 15 09:52:17 2015, PEVANS писал:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Sep 15 09:15:29 2015, OLEG wrote:
<div class="message-stanza open">&gt; &gt; We faced with this inside Mojolicious. Please see this topic
&gt; &gt; &#40;especially strace log&#41;:
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://groups.google.com/forum/#!topic/mojolicious/RetqP4QsyHU">https://groups.google.com/forum/#!topic/mojolicious/RetqP4QsyHU</a></span>
</div>&gt; 
&gt; Ahyes, you have stumbled upon the bug alluded to in
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/PEVANS/IO-Socket-IP-">https://metacpan.org/source/PEVANS/IO-Socket-IP-</a></span>
&gt; 0.37/lib/IO/Socket/IP.pm#L1200
&gt; 
&gt; Ultimately, I&#39;m not sure that IO::Socket::IP alone can do anything
&gt; about this. It *has* to be able to switch between different socket
&gt; filehandles, because it might have to swap between PF_INET and
&gt; PF_INET6, and that cannot be done to an open filehandle.
&gt; 
&gt; The failing is in the way that it is being used by the application.
&gt; The application would need some way to remove and re-add the
&gt; appropriate filehandle to that persistent mechanism &#40;epoll, kqueue,
&gt; etc...&#41; each time the no-arg -&gt;connect call is made again to request
&gt; that it continue.
&gt; 
&gt; Currently it could be done by always just removing the filehandle
&gt; before that -&gt;connect call and adding it again afterwards. I think in
&gt; practice it&#39;s unlikely to ever be the case that you don&#39;t have to do
&gt; that - the only thing -&gt;connect is going to do is check for success,
&gt; and lacking success it will just destroy and recreate the socket
&gt; anyway.
&gt; 
&gt; I could probably add something of that effect to the documentation.
</div>
Yes, I think this needs to be documented
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 1.816395</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
