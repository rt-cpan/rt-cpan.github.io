<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #14875 for libnet: Net::Cmd returns obsolete error codes after connection failure</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #14875 for libnet: Net::Cmd returns obsolete error codes after connection failure</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/libnet/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/libnet/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/libnet/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/libnet/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/libnet">libnet CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">14875</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/libnet/Active/">libnet</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
tmetro [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
PHILIPP [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-18284-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-18285-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;02&nbsp;02:06:43&nbsp;2005</span>
    <span class="description">tmetro [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 02 Oct 2005 02:06:10 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tom Metro &lt;tmetro [...] cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-libnet [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net::Cmd returns obsolete error codes after connection failure</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">While using Net::SMTP in a proxy server, I observed that under certain 
circumstances Net::SMTP was returning the error code from the previous 
command when the current command failed.

A specific scenario in which this might occur is when the server 
Net::SMTP was talking to drops the connection during the DATA command 
state, resulting in the dataend&#40;&#41; method failing. At this point if you 
call code&#40;&#41; or message&#40;&#41; methods, they will return the values set by the 
data&#40;&#41; method, which is normally 354. In a proxy server context, when 
the client machine see 354 in response to &#34;.&#34; &#40;dataend&#41; &#40;instead of the 
expected 250&#41;, it considers it a protocol error, and in the case of 
sendmail, also considers it a permanent failure and bounces the message.


I tracked the problem down to the internals of Net::Cmd and confirmed 
the problem still exists in the current version &#40;2.26&#41;.

I&#39;ve created a test server and client &#40;attached&#41; to demonstrate this 
problem. First I start the server:

% perl crash_server.pl 1

Passing anything on the command line activates the &#34;crash mode,&#34; which 
causes the server to intentionally crash &#40;exit&#41; during the dataend state.

Then the client:

% perl -MCarp=verbose client.pl
CMD: banner
Net::SMTP&gt;&gt;&gt; Net::SMTP&#40;2.26&#41;
Net::SMTP&gt;&gt;&gt;   Net::Cmd&#40;2.26&#41;
Net::SMTP&gt;&gt;&gt;     Exporter&#40;5.58&#41;
Net::SMTP&gt;&gt;&gt;   IO::Socket::INET&#40;1.27&#41;
Net::SMTP&gt;&gt;&gt;     IO::Socket&#40;1.28&#41;
Net::SMTP&gt;&gt;&gt;       IO::Handle&#40;1.24&#41;
Net::SMTP=GLOB&#40;0x1b6dda4&#41;&lt;&lt;&lt; 220 [A] crash-server
CMD: helo example.com
Net::SMTP=GLOB&#40;0x1b6dda4&#41;&gt;&gt;&gt; EHLO example.com
Net::SMTP=GLOB&#40;0x1b6dda4&#41;&lt;&lt;&lt; 500 Syntax error: unrecognized command
Net::SMTP=GLOB&#40;0x1b6dda4&#41;&gt;&gt;&gt; HELO example.com
Net::SMTP=GLOB&#40;0x1b6dda4&#41;&lt;&lt;&lt; 250 [B] helo example.com
CMD: mail from &lt;user@example.com&gt;
Net::SMTP=GLOB&#40;0x1b6dda4&#41;&gt;&gt;&gt; MAIL FROM:&lt;user@example.com&gt;
Net::SMTP=GLOB&#40;0x1b6dda4&#41;&lt;&lt;&lt; 250 [C] mail from &lt;user@example.com&gt;
CMD: rcpt to &lt;user@example.com&gt;
Net::SMTP=GLOB&#40;0x1b6dda4&#41;&gt;&gt;&gt; RCPT TO:&lt;user@example.com&gt;
Net::SMTP=GLOB&#40;0x1b6dda4&#41;&lt;&lt;&lt; 250 [D] rcpt to &lt;user@example.com&gt;
CMD: data_init
Net::SMTP=GLOB&#40;0x1b6dda4&#41;&gt;&gt;&gt; DATA
Net::SMTP=GLOB&#40;0x1b6dda4&#41;&lt;&lt;&lt; 354 [E] data_init
CMD: data_part
Net::SMTP=GLOB&#40;0x1b6dda4&#41;&gt;&gt;&gt; data data data data data data data data 
data data
CMD: data_end
Net::SMTP=GLOB&#40;0x1b6dda4&#41;&gt;&gt;&gt; .
Net::SMTP: Unexpected EOF on command channel at 
C:/bin/dev/Perl/5.8.4/lib/Net/Cmd.pm line 273
         Net::Cmd::getline&#40;&#39;Net::SMTP=GLOB&#40;0x1b6dda4&#41;&#39;&#41; called at 
C:/bin/dev/Perl/5.8.4/lib/Net/Cmd.pm line 332
         Net::Cmd::response&#40;&#39;Net::SMTP=GLOB&#40;0x1b6dda4&#41;&#39;&#41; called at 
C:/bin/dev/Perl/5.8.4/lib/Net/Cmd.pm line 530
         Net::Cmd::dataend&#40;&#39;Net::SMTP=GLOB&#40;0x1b6dda4&#41;&#39;&#41; called at 
client.pl line 42
Client returned: 354 [E] data_init


What&#39;s important to note is that you see:

   Net::SMTP=GLOB&#40;0x1b6dda4&#41;&lt;&lt;&lt; 354 [E] data_init

in response to the DATA command, and then the same values returned from 
code&#40;&#41; and message&#40;&#41; after the dataend&#40;&#41; method fails:

   Client returned: 354 [E] data_init


Reviewing Net::Cmd, it appears to have some problems with how the object 
properties accessed by code&#40;&#41; and message&#40;&#41; are initialized. Currently 
they&#39;re initialized near the end of command&#40;&#41;:

sub command
{
[...]
    ${*$cmd}{&#39;net_cmd_resp&#39;} = [];      # the response
    ${*$cmd}{&#39;net_cmd_code&#39;} = &#34;000&#34;;   # Made this one up :-&#41;
   }
  $cmd;
}

which has two problems: 1. things can happen to cause command&#40;&#41; to exit 
before it gets to that point, and 2. this seems like it should really be 
in response&#40;&#41;, which can be called independent of command&#40;&#41;.

Looking at response&#40;&#41; we see:

sub response
{
  my $cmd = shift;
  my&#40;$code,$more&#41; = &#40;undef&#41; x 2;

  ${*$cmd}{&#39;net_cmd_resp&#39;} ||= [];
[...]


which suggests that response&#40;&#41; can be called iteratively to build up a 
multi-line response, yet it has internal logic that contradicts that. 
The internal logic says that it won&#39;t return until all of the lines in a 
multi-line response are received. My best guess is that this construct 
was unintentionally copied from getline&#40;&#41;, which has a similar 
conditional initialization of its buffer, but there it makes sense.

response&#40;&#41; also makes no attempt to initialize ${*$cmd}{&#39;net_cmd_code&#39;}, 
yet has failure modes in which it will return prior to setting it.

More generally, internal error handling is not done consistently. At the 
top of command&#40;&#41; we see:

  unless &#40;defined fileno&#40;$cmd&#41;&#41;
   {
     $cmd-&gt;set_status&#40;&#34;599&#34;, &#34;Connection closed&#34;&#41;;
     return $cmd;
   }

which seems like a good approach, though this is the only place in the 
code where a pseudo &#40;internally generated&#41; result code is used. Many 
other places in which the code tests for a closed file handle or IO 
errors it simply returns without communicating that the failure was 
internal, and leaves the code and message properties in an undetermined 
state.

The same situation is true for trapped timeouts, as mentioned in bug #9394.

&#40;On a side note, I&#39;d argue that &#34;599&#34; - a permanent failure - is not a 
good choice for this purpose. Especially when used as part of a proxy 
server such that the code gets passed on to a client. I propose 421, 
which signifies a temporary connection failure.&#41;


It may be argued &#40;though not documented as such&#41; that the return values 
from code&#40;&#41; or message&#40;&#41; methods should not be used when a method fails, 
but that logic doesn&#39;t hold, because the cause of a method returning 
false more typically is due to the remote server returning an error 
code. So the normal reaction to a failed method &#40;in calling code&#41; is 
going to be examining the result code.

With some clean up in the initialization code, it could be made so that 
Net::Cmd consistently returns &#34;000&#34; for internal errors, which would 
have the advantage of distinguishing itself from remote server errors 
&#40;given that &#34;000&#34; is out of range for protocol errors&#41;, but that then 
precludes being able to pass on the code in a proxy scenario, and it 
requires that the calling code introduce a special case to handle it.

It seems the best solution is to embrace the idea of pseudo result 
codes, and update the code to consistently set the code and message 
properties when internal IO errors are trapped.

I&#39;ve created a patch to do just that, and I&#39;ll post it as a follow up to 
this message after it has undergone some testing.

  -Tom
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use Net::SMTP;

warn &#34;CMD: banner\n&#34;;
my $smtpc = Net::SMTP-&gt;new&#40;&#39;localhost&#39;,
		Port =&gt; 9025,
		Hello =&gt; undef,
		Debug =&gt; 99
	&#41; or do {
		die q/connection failed/;
	};

my $hostname = &#39;example.com&#39;;
warn &#34;CMD: helo $hostname\n&#34;;
$smtpc-&gt;hello&#40;$hostname&#41; or do {
	client_error&#40;$smtpc&#41;;
};

my $address = &#34;&lt;user\@$hostname&gt;&#34;;
warn &#34;CMD: mail from $address\n&#34;;
$smtpc-&gt;mail&#40;$address&#41; or do {
	client_error&#40;$smtpc&#41;;
};

warn &#34;CMD: rcpt to $address\n&#34;;
$smtpc-&gt;recipient&#40;$address&#41; or do {
	client_error&#40;$smtpc&#41;;
};

warn &#34;CMD: data_init\n&#34;;
$smtpc-&gt;data&#40;&#41; or do {
	client_error&#40;$smtpc&#41;;
};

my $chunk = &#39;data &#39; x 10 . &#34;\n&#34;;
warn &#34;CMD: data_part\n&#34;;
$smtpc-&gt;datasend&#40;[$chunk]&#41; or do {
	client_error&#40;$smtpc&#41;;
};

warn &#34;CMD: data_end\n&#34;;
$smtpc-&gt;dataend&#40;&#41; or do {
	client_error&#40;$smtpc&#41;;
};

warn &#34;CMD: quit\n&#34;;
$smtpc-&gt;quit&#40;&#41; or do {
	client_error&#40;$smtpc&#41;;
};


sub client_error {
  my $client = shift;
    die &#34;Client returned: &#34;,$client-&gt;code&#40;&#41;,&#34; &#34;,$client-&gt;message&#40;&#41;,&#34;\n&#34;;
}
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use Net::Server::Mail::SMTP;
use IO::Socket::INET;

# pass 1 &#40;or anything true&#41; on the command line to invoke
# &#34;crash mode&#34;
my $crash = shift;

my $server = new IO::Socket::INET Listen =&gt; 1, LocalPort =&gt; 9025;
warn &#34;Listening on port 9025\n&#34;;
warn &#34;Crash mode enabled\n&#34; if $crash;

my $conn;
while &#40;$conn = $server-&gt;accept&#41; {
	warn &#34;Connected to: &#34;,$conn-&gt;peerhost&#40;&#41;,&#34;\n&#34;;
	my $smtpd = new Net::Server::Mail::SMTP socket =&gt; $conn;

	$smtpd-&gt;set_callback&#40;&#39;banner&#39; =&gt; \&#38;banner&#41;;
	$smtpd-&gt;set_callback&#40;&#39;HELO&#39; =&gt; \&#38;helo&#41;;
	$smtpd-&gt;set_callback&#40;&#39;MAIL&#39; =&gt; \&#38;mail&#41;;
	$smtpd-&gt;set_callback&#40;&#39;RCPT&#39; =&gt; \&#38;rcpt&#41;;
	$smtpd-&gt;set_callback&#40;&#39;DATA-INIT&#39; =&gt; \&#38;data_init&#41;;
	$smtpd-&gt;set_callback&#40;&#39;DATA-PART&#39; =&gt; \&#38;data_part&#41;;
	$smtpd-&gt;set_callback&#40;&#39;DATA&#39; =&gt; \&#38;data_end&#41;;
	$smtpd-&gt;set_callback&#40;&#39;QUIT&#39; =&gt; \&#38;quit&#41;;

	warn &#34;Entering SMTP processing loop...\n&#34;;
	$smtpd-&gt;process;

	# cleanup
	$smtpd = undef;
	$conn = undef;
}

exit&#40;0&#41;;

## subs

sub banner {
my $session = shift;

	warn &#34;CMD: banner\n&#34;;
	return&#40;0, 220, &#39;[A] crash-server&#39;&#41;;
}

sub helo {
my $session = shift;
my $hostname = shift;

	warn &#34;CMD: helo $hostname\n&#34;;
	return &#40;1,250, &#34;[B] helo $hostname&#34;&#41;;
}

sub mail {
my $session = shift;
my $address = shift;

	warn &#34;CMD: mail from $address\n&#34;;
	return &#40;1, 250, &#34;[C] mail from $address&#34;&#41;;
}

sub rcpt {
my $session = shift;
my $address = shift;

	warn &#34;CMD: rcpt to $address\n&#34;;
	return &#40;1, 250, &#34;[D] rcpt to $address&#34;&#41;;
}

sub data_init {
my $session = shift;

	warn &#34;CMD: data_init\n&#34;;
	return &#40;1, 354, &#39;[E] data_init&#39;&#41;;
}

sub data_part {
my $session = shift;
my $chunk = shift;	# ref to buffer

	warn &#34;CMD: data_part\n&#34;;

	if &#40;$crash&#41; {
	    warn &#34;** crashing **\n&#34;;
	    exit&#40;0&#41;;
	}

	return &#40;1&#41;;
}

sub data_end {
my $session = shift;

	warn &#34;CMD: data_end\n&#34;;
	return &#40;1, 250, &#39;[F] data_end&#39;&#41;;
}

sub quit {
my $session = shift;

	warn &#34;CMD: quit\n&#34;;
	return &#40;1, 221, &#39;[G] quit&#39;&#41;;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;09&nbsp;20:49:25&nbsp;2008</span>
    <span class="description">GBARR [...] CPAN.ORG -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hey Tom,

I was working through old tickets and came across this one. You ended with saying you would 
post a followup with a patch. I am guessing it has been so long you don&#39;t have that anymore.

Graham.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;09&nbsp;20:49:27&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;09&nbsp;20:49:28&nbsp;2008</span>
    <span class="description">GBARR [...] CPAN.ORG -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;09&nbsp;22:22:41&nbsp;2008</span>
    <span class="description">tmetro [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #14875] Net::Cmd returns obsolete error codes after connection failure</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 09 Feb 2008 22:22:26 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-libnet [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tom Metro &lt;tmetro [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Graham_Barr via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; You ended with saying you would post a followup with a patch. I am
&gt; guessing it has been so long you don&#39;t have that anymore.
</div>
I think the reason I never posted a path is that the changes I made 
never fully resolved the problem. I might have opened a separate ticket 
for this, but I seem to recall tracking the issue down to the use of 
higher layer I/O calls instead of sysread/syswrite, and yet an attempt 
at fixing that introduced other problems.

The code is still in active use as part of a custom anti-spam proxy, but 
generally the problem crops up infrequently enough that I haven&#39;t been 
adequately motivated to dig into the problem. I&#39;ve also been planning to 
migrate the code to another platform or replace it entirely &#34;any day 
now,&#34; either of which would probably eliminate the

Let me take a look at the version of Net::Cmd I&#39;m using...looks like I&#39;m 
currently using an unmodified 2.26. I do have a patched 2.24 kicking 
around. I don&#39;t recall why I didn&#39;t migrate the changes forward. I&#39;ve 
attached the diff for it, though I no longer recall the specifics of the 
changes, though most of it seems to correspond with stuff covered in 
this ticket.

The good news is that it looks like I wrote a test program to 
demonstrate the bug, so it shouldn&#39;t be too tough to see if the problem 
is resolved in 2.26 and fix it again, if it isn&#39;t.

  -Tom
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- cmd.pm.orig	Tue Jun 01 10:49:34 2004
+++ cmd.pm.mod	Sun Oct 02 01:31:28 2005
@@ -1,4 +1,4 @@
-# Net::Cmd.pm $Id: //depot/libnet/Net/Cmd.pm#33 $
+# Net::Cmd.pm $Id: cmd.pm,v 1.2 2005-09-30 03:31:09-04 administrator Exp administrator $
 #
 # Copyright &#40;c&#41; 1995-1997 Graham Barr &lt;gbarr@pobox.com&gt;. All rights reserved.
 # This program is free software; you can redistribute it and/or
@@ -32,6 +32,8 @@
 sub CMD_ERROR	{ 5 }
 sub CMD_PENDING { 0 }
 
+sub DEF_REPLY_CODE { 421 }
+
 my %debug = &#40;&#41;;
 
 my $tr = $^O eq &#39;os390&#39; ? Convert::EBCDIC-&gt;new&#40;&#41; : undef;
@@ -156,7 +158,7 @@
 
  my $cmd = shift;
 
- ${*$cmd}{&#39;net_cmd_code&#39;} = &#34;000&#34;
+ ${*$cmd}{&#39;net_cmd_code&#39;} = $cmd-&gt;DEF_REPLY_CODE
 	unless exists ${*$cmd}{&#39;net_cmd_code&#39;};
 
  ${*$cmd}{&#39;net_cmd_code&#39;};
@@ -186,16 +188,40 @@
  1;
 }
 
-sub command
+sub _set_status_timeout
 {
  my $cmd = shift;
+ my $pkg = ref&#40;$cmd&#41; || $cmd;
 
- unless &#40;defined fileno&#40;$cmd&#41;&#41;
-  {
-    $cmd-&gt;set_status&#40;&#34;599&#34;, &#34;Connection closed&#34;&#41;;
-    return $cmd;
-  }
+    $cmd-&gt;set_status&#40;$cmd-&gt;DEF_REPLY_CODE, &#34;[$pkg] Timeout&#34;&#41;;
+    carp&#40;ref&#40;$cmd&#41; . &#34;: &#34; . &#40;caller&#40;1&#41;&#41;[3] . &#34;&#40;&#41;: timeout&#34;&#41; if $cmd-&gt;debug;
+}
+
+sub _set_status_closed
+{
+ my $cmd = shift;
+ my $pkg = ref&#40;$cmd&#41; || $cmd;
 
+    $cmd-&gt;set_status&#40;$cmd-&gt;DEF_REPLY_CODE, &#34;[$pkg] Connection closed&#34;&#41;;
+    carp&#40;ref&#40;$cmd&#41; . &#34;: &#34; . &#40;caller&#40;1&#41;&#41;[3] 
+	. &#34;&#40;&#41;: unexpected EOF on command channel: $!&#34;&#41; if $cmd-&gt;debug;
+}
+
+sub _is_closed
+{
+ my $cmd = shift;
+ if &#40;!defined fileno&#40;$cmd&#41;&#41; {
+    $cmd-&gt;_set_status_closed;
+    return 1;
+ }
+ return 0;
+}
+
+sub command
+{
+ my $cmd = shift;
+
+ $cmd-&gt;_is_closed &#38;&#38; return $cmd;
 
  $cmd-&gt;dataend&#40;&#41;
     if&#40;exists ${*$cmd}{&#39;net_cmd_need_crlf&#39;}&#41;;
@@ -211,14 +237,14 @@
    my $len = length $str;
    my $swlen;
 
-   $cmd-&gt;close
-	unless &#40;defined&#40;$swlen = syswrite&#40;$cmd,$str,$len&#41;&#41; &#38;&#38; $swlen == $len&#41;;
-
    $cmd-&gt;debug_print&#40;1,$str&#41;
 	if&#40;$cmd-&gt;debug&#41;;
 
-   ${*$cmd}{&#39;net_cmd_resp&#39;} = [];      # the response
-   ${*$cmd}{&#39;net_cmd_code&#39;} = &#34;000&#34;;	# Made this one up :-&#41;
+   unless &#40;defined&#40;$swlen = syswrite&#40;$cmd,$str,$len&#41;&#41; &#38;&#38; $swlen == $len&#41; {
+	$cmd-&gt;close;
+	$cmd-&gt;_set_status_closed;
+	return $cmd;
+   }
   }
 
  $cmd;
@@ -236,8 +262,8 @@
 {
  my $cmd = shift;
 
- ${*$cmd}{&#39;net_cmd_resp&#39;} = [ &#39;Unsupported command&#39; ];
- ${*$cmd}{&#39;net_cmd_code&#39;} = 580;
+ $cmd-&gt;set_status&#40;580, &#39;Unsupported command&#39;&#41;;
+
  0;
 }
 
@@ -252,11 +278,10 @@
 
  my $partial = defined&#40;${*$cmd}{&#39;net_cmd_partial&#39;}&#41;
 		? ${*$cmd}{&#39;net_cmd_partial&#39;} : &#34;&#34;;
- my $fd = fileno&#40;$cmd&#41;;
 
- return undef
-	unless defined $fd;
+ $cmd-&gt;_is_closed &#38;&#38; return undef;
 
+ my $fd = fileno&#40;$cmd&#41;;
  my $rin = &#34;&#34;;
  vec&#40;$rin,$fd,1&#41; = 1;
 
@@ -270,11 +295,10 @@
     {
      unless &#40;sysread&#40;$cmd, $buf=&#34;&#34;, 1024&#41;&#41;
       {
-       carp&#40;ref&#40;$cmd&#41; . &#34;: Unexpected EOF on command channel&#34;&#41;
-		if $cmd-&gt;debug;
        $cmd-&gt;close;
+       $cmd-&gt;_set_status_closed;
        return undef;
-      } 
+      }
 
      substr&#40;$buf,0,0&#41; = $partial;	## prepend from last sysread
 
@@ -287,7 +311,7 @@
     }
    else
     {
-     carp&#40;&#34;$cmd: Timeout&#34;&#41; if&#40;$cmd-&gt;debug&#41;;
+     $cmd-&gt;_set_status_timeout;
      return undef;
     }
   }
@@ -325,7 +349,7 @@
  my $cmd = shift;
  my&#40;$code,$more&#41; = &#40;undef&#41; x 2;
 
- ${*$cmd}{&#39;net_cmd_resp&#39;} ||= [];
+ $cmd-&gt;set_status&#40;$cmd-&gt;DEF_REPLY_CODE, undef&#41;; # initialize the response
 
  while&#40;1&#41;
   {
@@ -340,8 +364,9 @@
    &#40;$code,$more&#41; = $cmd-&gt;parse_response&#40;$str&#41;;
    unless&#40;defined $code&#41;
     {
+     carp&#40;&#34;$cmd: response&#40;&#41;: parse error in &#39;$str&#39;&#34;&#41; if &#40;$cmd-&gt;debug&#41;;
      $cmd-&gt;ungetline&#40;$str&#41;;
-     last;
+     return CMD_ERROR;
     }
 
    ${*$cmd}{&#39;net_cmd_code&#39;} = $code;
@@ -390,12 +415,12 @@
  my $arr = @_ == 1 &#38;&#38; ref&#40;$_[0]&#41; ? $_[0] : \@_;
  my $line = join&#40;&#34;&#34; ,@$arr&#41;;
 
- return 0 unless defined&#40;fileno&#40;$cmd&#41;&#41;;
+ $cmd-&gt;_is_closed &#38;&#38; return 0;
 
  unless &#40;length $line&#41; {
    # Even though we are not sending anything, the fact we were
    # called means that dataend needs to be called before the next
-   # command, which happens of net_cmd_need_crlf exists
+   # command, which happens if net_cmd_need_crlf exists
    ${*$cmd}{&#39;net_cmd_need_crlf&#39;} ||= 0;
    return 1;
  }
@@ -428,9 +453,10 @@
    if &#40;select&#40;undef,$wout=$win, undef, $timeout&#41; &gt; 0&#41;
     {
      my $w = syswrite&#40;$cmd, $line, $len, $offset&#41;;
-     unless &#40;defined&#40;$w&#41;&#41;
+     unless &#40;defined&#40;$w&#41; &#38;&#38; $w == $len&#41;
       {
-       carp&#40;&#34;$cmd: $!&#34;&#41; if $cmd-&gt;debug;
+       $cmd-&gt;close;
+       $cmd-&gt;_set_status_closed;
        return undef;
       }
      $len -= $w;
@@ -438,7 +464,7 @@
     }
    else
     {
-     carp&#40;&#34;$cmd: Timeout&#34;&#41; if&#40;$cmd-&gt;debug&#41;;
+     $cmd-&gt;_set_status_timeout;
      return undef;
     }
   }
@@ -452,7 +478,7 @@
  my $arr = @_ == 1 &#38;&#38; ref&#40;$_[0]&#41; ? $_[0] : \@_;
  my $line = join&#40;&#34;&#34; ,@$arr&#41;;
 
- return 0 unless defined&#40;fileno&#40;$cmd&#41;&#41;;
+ $cmd-&gt;_is_closed &#38;&#38; return 0;
 
  return 1
     unless length&#40;$line&#41;;
@@ -476,9 +502,10 @@
    if &#40;select&#40;undef,$wout=$win, undef, $timeout&#41; &gt; 0&#41;
     {
      my $w = syswrite&#40;$cmd, $line, $len, $offset&#41;;
-     unless &#40;defined&#40;$w&#41;&#41;
+     unless &#40;defined&#40;$w&#41; &#38;&#38; $w == $len&#41;
       {
-       carp&#40;&#34;$cmd: $!&#34;&#41; if $cmd-&gt;debug;
+       $cmd-&gt;close;
+       $cmd-&gt;_set_status_closed;
        return undef;
       }
      $len -= $w;
@@ -486,7 +513,7 @@
     }
    else
     {
-     carp&#40;&#34;$cmd: Timeout&#34;&#41; if&#40;$cmd-&gt;debug&#41;;
+     $cmd-&gt;_set_status_timeout;
      return undef;
     }
   }
@@ -498,19 +525,28 @@
 {
  my $cmd = shift;
 
- return 0 unless defined&#40;fileno&#40;$cmd&#41;&#41;;
+ $cmd-&gt;_is_closed &#38;&#38; return 0;
 
  return 1
     unless&#40;exists ${*$cmd}{&#39;net_cmd_need_crlf&#39;}&#41;;
 
  local $SIG{PIPE} = &#39;IGNORE&#39; unless $^O eq &#39;MacOS&#39;;
- syswrite&#40;$cmd,&#34;\015\012&#34;,2&#41;
-    if ${*$cmd}{&#39;net_cmd_need_crlf&#39;};
 
  $cmd-&gt;debug_print&#40;1, &#34;.\n&#34;&#41;
     if&#40;$cmd-&gt;debug&#41;;
 
- syswrite&#40;$cmd,&#34;.\015\012&#34;,3&#41;;
+ my $terminator = ${*$cmd}{&#39;net_cmd_need_crlf&#39;} ?
+    &#34;\015\012&#34; : &#39;&#39;;
+
+ $terminator .= &#34;.\015\012&#34;;
+ my $len = length&#40;$terminator&#41;;
+ my $w = syswrite&#40;$cmd,$terminator,$len&#41;;
+ unless &#40;defined&#40;$w&#41; &#38;&#38; $w == $len&#41;
+  {
+	$cmd-&gt;close;
+	$cmd-&gt;_set_status_closed;
+	return 0;
+  }
 
  delete ${*$cmd}{&#39;net_cmd_need_crlf&#39;};
 
@@ -626,12 +662,13 @@
 
 =item message &#40;&#41;
 
-Returns the text message returned from the last command
+Returns the text message returned from the last command.
+&#40;See L&lt;PSEUDO RESPONSES&gt; below.&#41;
 
 =item code &#40;&#41;
 
 Returns the 3-digit code from the last command. If a command is pending
-then the value 0 is returned
+then the value 0 is returned. &#40;See L&lt;PSEUDO RESPONSES&gt; below.&#41;
 
 =item ok &#40;&#41;
 
@@ -672,21 +709,21 @@
 data being sent to the server. Calls C&lt;debug_text&gt; before printing to
 STDERR.
 
-=item debug_text &#40; TEXT &#41;
+=item debug_text &#40; undef, TEXT &#41;
 
 This method is called to print debugging information. TEXT is
-the text being sent. The method should return the text to be printed
+the text being sent. The method should return the text to be printed.
 
 This is primarily meant for the use of modules such as FTP where passwords
 are sent, but we do not want to display them in the debugging information.
 
 =item command &#40; CMD [, ARGS, ... ]&#41;
 
-Send a command to the command server. All arguments a first joined with
+Send a command to the command server. All arguments are first joined with
 a space character and CRLF is appended, this string is then sent to the
 command server.
 
-Returns undef upon failure
+Returns undef upon failure.
 
 =item unsupported &#40;&#41;
 
@@ -696,14 +733,14 @@
 =item response &#40;&#41;
 
 Obtain a response from the server. Upon success the most significant digit
-of the status code is returned. Upon failure, timeout etc., I&lt;undef&gt; is
+of the status code is returned. Upon failure, timeout etc., I&lt;CMD_ERROR&gt; is
 returned.
 
 =item parse_response &#40; TEXT &#41;
 
 This method is called by C&lt;response&gt; as a method with one argument. It should
 return an array of 2 values, the 3-digit status code and a flag which is true
-when this is part of a multi-line response and this line is not the list.
+when this is part of a multi-line response and this line is not the last.
 
 =item getline &#40;&#41;
 
@@ -741,6 +778,44 @@
 
 =back
 
+=head1 PSEUDO RESPONSES
+
+Normally the values returned by C&lt;message&#40;&#41;&gt; and C&lt;code&#40;&#41;&gt; are 
+obtained from the remote server, but in a few circumstances, as
+detailed below, C&lt;Net::Cmd&gt; will return values that it sets. You
+can alter this behavior by overriding DEF_REPLY_CODE&#40;&#41; to specify 
+a different default reply code, or overriding one of the specific
+error handling methods below.
+
+=over 4
+
+=item Initial value
+
+Before any command has executed or if an unexpected error occurs 
+C&lt;code&#40;&#41;&gt; will return &#34;421&#34; &#40;temporary connection failure&#41; and
+C&lt;message&#40;&#41;&gt; will return undef.
+
+=item Connection closed
+
+If the underlying C&lt;IO::Handle&gt; is closed, or if there are
+any read or write failures, the file handle will be forced closed, 
+and C&lt;code&#40;&#41;&gt; will return &#34;421&#34; &#40;temporary connection failure&#41; 
+and C&lt;message&#40;&#41;&gt; will return &#34;[$pkg] Connection closed&#34; 
+&#40;where $pkg is the name of the class that subclassed C&lt;Net::Cmd&gt;&#41;.
+The _set_status_closed&#40;&#41; method can be overridden to set a different
+message &#40;by calling set_status&#40;&#41;&#41; or otherwise trap this error.
+
+=item Timeout
+
+If if there is a read or write timeout C&lt;code&#40;&#41;&gt; will return &#34;421&#34;
+&#40;temporary connection failure&#41; and C&lt;message&#40;&#41;&gt; will return 
+&#34;[$pkg] Timeout&#34; &#40;where $pkg is the name of the class
+that subclassed C&lt;Net::Cmd&gt;&#41;. The _set_status_timeout&#40;&#41; method 
+can be overridden to set a different message &#40;by calling set_status&#40;&#41;&#41;
+or otherwise trap this error.
+
+=back
+
 =head1 EXPORTS
 
 C&lt;Net::Cmd&gt; exports six subroutines, five of these, C&lt;CMD_INFO&gt;, C&lt;CMD_OK&gt;,
@@ -759,6 +834,6 @@
 
 =for html &lt;hr&gt;
 
-I&lt;$Id: //depot/libnet/Net/Cmd.pm#33 $&gt;
+I&lt;$Id: cmd.pm,v 1.2 2005-09-30 03:31:09-04 administrator Exp administrator $&gt;
 
 =cut
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;09&nbsp;22:22:43&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;10&nbsp;08:50:54&nbsp;2008</span>
    <span class="description">gbarr [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #14875] Net::Cmd returns obsolete error codes after connection failure</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 10 Feb 2008 07:50:33 -0600</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-libnet [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Graham Barr &lt;gbarr [...] pobox.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Feb 9, 2008, at 9:22 PM, Tom Metro via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Graham_Barr via RT wrote:
<div class="message-stanza open">&gt;&gt; You ended with saying you would post a followup with a patch. I am
&gt;&gt; guessing it has been so long you don&#39;t have that anymore.
</div>&gt;
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The good news is that it looks like I wrote a test program to
&gt; demonstrate the bug, so it shouldn&#39;t be too tough to see if the  
&gt; problem
&gt; is resolved in 2.26 and fix it again, if it isn&#39;t.
</div>
Please try from my repository, although I suspect this has not fixed  
your problem.

<span class="clickylink"><a target="new" rel="nofollow" href="http://svn.goingon.net/repos/libnet/trunk/Net/Cmd.pm">http://svn.goingon.net/repos/libnet/trunk/Net/Cmd.pm</a></span>

Graham.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;29&nbsp;08:17:59&nbsp;2014</span>
    <span class="description">TIMB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">We seem to be hitting the same problem.

Very occasional failures of $smtp-&gt;dataend&#40;&#41; with a code&#40;&#41; of 354 that seems to be the obsolete code from the earlier data&#40;&#41; command. In our case Email::Sender::Transport::SMTP fails with &#34;error at after DATA&#34;.

Is there any news on this Tom? &#40;Or Steve or Graham &#40;hi!&#41;&#41;

Tim.

p.s. The <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=47557">https://rt.cpan.org/Ticket/Display.html?id=47557</a></span> case might also overlap with this one.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;03&nbsp;03:59:18&nbsp;2014</span>
    <span class="description">shay [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Aug 29 08:17:59 2014, TIMB wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; We seem to be hitting the same problem.
&gt; 
&gt; Very occasional failures of $smtp-&gt;dataend&#40;&#41; with a code&#40;&#41; of 354 that
&gt; seems to be the obsolete code from the earlier data&#40;&#41; command. In our
&gt; case Email::Sender::Transport::SMTP fails with &#34;error at after DATA&#34;.
&gt; 
&gt; Is there any news on this Tom? &#40;Or Steve or Graham &#40;hi!&#41;&#41;
&gt; 
&gt; Tim.
&gt; 
&gt; p.s. The <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=47557">https://rt.cpan.org/Ticket/Display.html?id=47557</a></span> case might
&gt; also overlap with this one.
</div>
I&#39;ve had a read through this ticket and it certainly contains a lot of useful comments about how Net::Cmd could be improved. I&#39;m inclined to apply the patch, but I would love to be able to reproduce the failure first and see the fix in action. However, when I run the crash_server.pl and client.pl programs I find that the crash_server.pl crashes a little too enthusiastically: On my 5.18.0 system &#40;on Windows&#41; it actually causes perl.exe to crash when the client.pl connects and starts doing stuff!!!

Tim, are you able to apply the patch to your system &#40;or preferably to the current development version in my Git repo&#41; and see that it cures your problem?

If not then I might just go ahead and apply it anyway since it all looks like good improvements to me, but I would welcome any feedback first.

&#40;And yes, 47557 looks like the same problem so I will ask if the reporter of that ticket can test this patch too.&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;07&nbsp;09:04:19&nbsp;2014</span>
    <span class="description">shay [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Oct 03 03:59:18 2014, SHAY wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#40;And yes, 47557 looks like the same problem so I will ask if the
&gt; reporter of that ticket can test this patch too.&#41;
</div>
Successful use of the patch on several versions of perl over a couple of years have been reported on #47557, so I&#39;ve applied the patch in commit:

<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/steve-m-hay/perl-libnet/commit/6b249e0122f764e186b14f7a7663a0ffd3055121">https://github.com/steve-m-hay/perl-libnet/commit/6b249e0122f764e186b14f7a7663a0ffd3055121</a></span>

with a minor fix-up in commit:

<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/steve-m-hay/perl-libnet/commit/b3e899dfaad77c48bf0f83c66a9a8a3c2233beb2">https://github.com/steve-m-hay/perl-libnet/commit/b3e899dfaad77c48bf0f83c66a9a8a3c2233beb2</a></span>

Many thanks for the detailed report and the patch.

This will be in libnet-1.28, to be released shortly.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;07&nbsp;09:04:21&nbsp;2014</span>
    <span class="description">shay [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;25&nbsp;16:54:14&nbsp;2015</span>
    <span class="description">dagolden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is bad patch.  It introduces a fundamental error in the treatment of reads and writes.  Consider this example:

      my $w = syswrite&#40;$cmd, $line, $len, $offset&#41;;
  -   unless &#40;defined&#40;$w&#41;&#41; 
  +   unless &#40;defined&#40;$w&#41; &#38;&#38; $w == $len&#41;

syswrite is allowed to return less than the requested amount of data &#40;which is why it&#39;s in a loop and len/offset are adjusted by $w later&#41;.  This patch makes a short write into an error condition and does so pretty much everywhere that syswrite is used.

Separately, I note that even the original code doesn&#39;t check $! for EINTR if $w is not defined.  It should so check and continue.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;25&nbsp;16:54:16&nbsp;2015</span>
    <span class="description">dagolden [...] cpan.org -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;25&nbsp;22:36:36&nbsp;2015</span>
    <span class="description">dagolden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/steve-m-hay/perl-libnet/pull/24">https://github.com/steve-m-hay/perl-libnet/pull/24</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;26&nbsp;12:33:31&nbsp;2015</span>
    <span class="description">tmetro [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Dec 25 16:54:14 2015, DAGOLDEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This is bad patch.  It introduces a fundamental error in the treatment
&gt; of reads and writes. 
&gt; syswrite is allowed to return less than the requested amount of data...
</div>
That seems like a valid point, and a behavior of syswrite I was well aware of at the time of the original patch, so I don&#39;t understand why the code wouldn&#39;t have anticipated getting back underfull buffers from syswrite, unless there is some explanation I&#39;m not immediately gleaning from a quick read of the original patch. &#40;A decade later, lots of context has been lost to time.&#41;

Your proposed pull request on github looks like a suitable refinement.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;27&nbsp;13:42:15&nbsp;2015</span>
    <span class="description">shay [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">PR#24 now merged, so marking this ticket as resolved once more. The fix will be in 3.08, to be released soon.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;27&nbsp;13:42:26&nbsp;2015</span>
    <span class="description">shay [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;06&nbsp;16:45:39&nbsp;2016</span>
    <span class="description">PHILIPP [...] cpan.org -  Cc PHILIPP added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
