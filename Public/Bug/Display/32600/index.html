<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #32600 for Perl-RPM: does not load headers from files on rpm &gt;= 4.01</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #32600 for Perl-RPM: does not load headers from files on rpm &gt;= 4.01</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Perl-RPM/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Perl-RPM/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Perl-RPM/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Perl-RPM/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Perl-RPM">Perl-RPM CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">32600</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Perl-RPM/Active/">Perl-RPM</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
strobert-cpan [...] strobe.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-25248-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.51    </td>
  </tr>
  <tr id="CF-25249-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;23&nbsp;22:50:10&nbsp;2008</span>
    <span class="description">strobert-bitcard [...] strobe.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> does not load headers from files on rpm &gt;= 4.01</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am hoping this module is still alive.  I am trying to use version 
1.51 on a rpm ver 4.2 machine &#40;happens to be fc1, but the error should 
be on anything 4.1 or newer&#41;.

tieing RPM::Header to a file to read a non installed package&#39;s header 
from a file fails.

I did some debugging over the past couple of days &#40;combo of the perl 
debugger and cgdb to trap the C code&#41; and after adding in the error 
messages from rpmReadHeader, I have found the issue.

in rpm 4.01 and newer, rpmReadHeader is being called.  however that 
function expects the seek position to be at the start of the header 
which is at least 96 bytes into the file.  from reeading the RPM 
format docs it looks like there can be an optional digest/sig block 
bewteen the lead and the rpm header, but so far I haven&#39;t found a 
package that has one.  and hardwired to 96 is what the 
RPM::Header::Pureperl package does.

There is also a rpmReadPAckageFile API that looks to be the one to 
use.

I have attached a patch that used that function and it seems like 
things are working now.

It probably would not be hard to whip up a test case and add it to the 
package &#40;thining maybe include a REALLY basic rpm to load&#41;.  if there 
is interest, please let me know and I will see about writing one to 
add.  It looks like the current cases just attach to a RPM database as 
opposed to individual rpm files.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> perlrpm.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Perl-RPM-1.51/RPM/Header.xs.orig	2008-01-23 19:44:48.000000000 -0800
+++ Perl-RPM-1.51/RPM/Header.xs	2008-01-23 19:40:31.000000000 -0800
@@ -136,10 +136,14 @@
 {
     Header h;
     int isSource = 0;
+#if RPM_VERSION &gt;= 0x040100
+    rpmts ts;
+#endif
     RPM_Header *hdr = Null&#40;RPM_Header *&#41;;
     sv_setiv&#40;rpm_errSV, 0&#41;;
 #if RPM_VERSION &gt;= 0x040100
-    if &#40;rpmReadHeader&#40;NULL, Fd, &#38;h, NULL&#41;&#41;
+    ts = rpmtsCreate&#40;&#41;;
+    if &#40;rpmReadPackageFile&#40;ts, Fd, &#34;filename&#34;, &#38;h&#41;&#41;
 #else
     if &#40;rpmReadPackageHeader&#40;Fd, &#38;h, &#38;isSource, Null&#40;int *&#41;, Null&#40;int *&#41;&#41;&#41;
 #endif
@@ -150,6 +154,9 @@
             rpmError&#40;RPMERR_READ, &#34;Error reading package header&#34;&#41;;
         return hdr;
     }
+#if RPM_VERSION &gt;= 0x040100
+    ts = rpmtsFree&#40;ts&#41;;
+#endif
     hdr = rpmhdr_TIEHASH_header&#40;aTHX_ h&#41;;
     if &#40;hdr&#41;
         hdr-&gt;isSource = isSource;
--- Perl-RPM-1.51/RPM.h.orig	2008-01-23 19:44:28.000000000 -0800
+++ Perl-RPM-1.51/RPM.h	2008-01-23 19:43:11.000000000 -0800
@@ -48,6 +48,10 @@
 #include &lt;rpmlib.h&gt;
 #include &lt;rpmdb.h&gt;
 
+#if RPM_VERSION &gt;= 0x040100
+#include &lt;rpmts.h&gt;
+#endif
+
 /* Various flags. For now, one nybble for header and one for package. */
 #define RPM_HEADER_MASK        0x0f
 #define RPM_HEADER_READONLY    0x01
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;15&nbsp;20:57:20&nbsp;2010</span>
    <span class="description">strobert-bitcard [...] strobe.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> strobert-bitcard [...] strobe.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jan 23 22:50:10 2008, strobert wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; in rpm 4.01 and newer, rpmReadHeader is being called.  however that 
&gt; function expects the seek position to be at the start of the header 
&gt; which is at least 96 bytes into the file.  from reeading the RPM 
&gt; format docs it looks like there can be an optional digest/sig block 
&gt; bewteen the lead and the rpm header, but so far I haven&#39;t found a 
&gt; package that has one.  and hardwired to 96 is what the 
&gt; RPM::Header::Pureperl package does.
&gt; 
&gt; There is also a rpmReadPAckageFile API that looks to be the one to 
&gt; use.
&gt; 
&gt; I have attached a patch that used that function and it seems like 
&gt; things are working now.
</div>
Any idea if/when this will get put into the upstream release?  I have a
local patch applied tot he RPM we built/use around here, but it would be
nice to have it in the upstream code.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;15&nbsp;20:57:21&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
