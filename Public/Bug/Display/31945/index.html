<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #31945 for XML-LibXML: xs, thread related refcount issue</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #31945 for XML-LibXML: xs, thread related refcount issue</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/XML-LibXML/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-LibXML">XML-LibXML CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">31945</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/XML-LibXML/Active/">XML-LibXML</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jhoger [...] pobox.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-37350-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-37351-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;27&nbsp;19:14:19&nbsp;2007</span>
    <span class="description">jhoger [...] pobox.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> xs, thread related refcount issue</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 27 Dec 2007 16:13:47 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-LibXML [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;John R. Hogerhuis&#34; &lt;jhoger [...] pobox.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Running this code &#40;contrived, my real-world case is more complex,
hopefully it is the same problem&#41;:


##################

#!/usr/bin/env perl

use threads;

use XML::LibXML;

my $parser = XML::LibXML-&gt;new&#40;&#41;;
my $doc = $parser-&gt;parse_string &#40;&#39;&lt;AnyXML&gt;&lt;/AnyXML&gt;&#39;&#41;;

sub bgrd_task {
        my $parser = XML::LibXML-&gt;new&#40;&#41;;
        my $doc = $parser-&gt;parse_string &#40;&#39;&lt;AnyXML&gt;&lt;/AnyXML&gt;&#39;&#41;;
}

my $bgrd = threads-&gt;new &#40;\&#38;bgrd_task&#41;;
$bgrd-&gt;join&#40;&#41;;

################

Results in this error, and a segfault:

################
john@sqalab1:~/projects/libxml_test$ ./test.pl
PmmREFCNT_dec: REFCNT decremented below 0!.
PmmREFCNT_dec: REFCNT decremented below 0!.
Segmentation fault
################


john@sqalab1:~/projects/libxml_test$ perl -v

This is perl, v5.8.7 built for i486-linux-gnu-thread-multi
&#40;with 1 registered patch, see perl -V for more detail&#41;

Copyright 1987-2005, Larry Wall

Perl may be copied only under the terms of either the Artistic License or the
GNU General Public License, which may be found in the Perl 5 source kit.

Complete documentation for Perl, including FAQ lists, should be found on
this system using `man perl&#39; or `perldoc perl&#39;.  If you have access to the
Internet, point your browser at <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perl.org/">http://www.perl.org/</a></span>, the Perl Home Page.

john@sqalab1:~/projects/libxml_test$


john@sqalab1:~/projects/libxml_test$ uname -a
Linux sqalab1 2.6.15-23-386 #1 PREEMPT Tue May 23 13:49:40 UTC 2006
i686 GNU/Linux
john@sqalab1:~/projects/libxml_test$


admin tells me we&#39;re running latest version of XML::LibXML &#40;XML-LibXML-1.65&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;07&nbsp;12:48:57&nbsp;2008</span>
    <span class="description">TIMBRODY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> TIMBRODY [...] cpan.org</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve written a small patch that should prevent the seg faults on clean
up when spawning threads after creating LibXML objects.

IIUC this isn&#39;t the way Perl threading is supposed to work &#40;objects
should be copied on thread spawns&#41;, so I would be very careful if you
intend using any object in more than one thread.

Tim.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: perl-libxml-mm.c
===================================================================
--- perl-libxml-mm.c	&#40;revision 695&#41;
+++ perl-libxml-mm.c	&#40;working copy&#41;
@@ -111,6 +111,7 @@
 struct _ProxyNode {
     xmlNodePtr node;
     xmlNodePtr owner;
+    SV * thread;
     int count;
     int encoding; 
 };
@@ -129,6 +130,7 @@
 #define PmmREFCNT_inc&#40;node&#41;  node-&gt;count++
 #define PmmNODE&#40;thenode&#41;     thenode-&gt;node
 #define PmmOWNER&#40;node&#41;       node-&gt;owner
+#define PmmTHREAD&#40;node&#41;      node-&gt;thread
 #define PmmOWNERPO&#40;node&#41;     &#40;&#40;node &#38;&#38; PmmOWNER&#40;node&#41;&#41; ? &#40;ProxyNodePtr&#41;PmmOWNER&#40;node&#41;-&gt;_private : node&#41;
 
 #define PmmENCODING&#40;node&#41;    node-&gt;encoding
@@ -153,6 +155,7 @@
         if &#40;proxy != NULL&#41; {
             proxy-&gt;node  = node;
             proxy-&gt;owner   = NULL;
+            proxy-&gt;thread  = aTHX;
             proxy-&gt;count   = 0;
             proxy-&gt;encoding= 0;
             node-&gt;_private = &#40;void*&#41; proxy;
Index: LibXML.xs
===================================================================
--- LibXML.xs	&#40;revision 695&#41;
+++ LibXML.xs	&#40;working copy&#41;
@@ -3711,9 +3711,13 @@
 void
 DESTROY&#40; node &#41;
         SV * node
+    PREINIT:
+        SV * thread;
     CODE:
+        thread = aTHX; // aTHX is the current perl interpreter
         xs_warn&#40;&#34;DESTROY PERL NODE\n&#34;&#41;;
-        PmmREFCNT_dec&#40;SvPROXYNODE&#40;node&#41;&#41;;
+        if&#40; PmmTHREAD&#40;SvPROXYNODE&#40;node&#41;&#41; == thread &#41;
+            PmmREFCNT_dec&#40;SvPROXYNODE&#40;node&#41;&#41;;
 
 SV*
 nodeName&#40; self &#41;
Index: perl-libxml-mm.h
===================================================================
--- perl-libxml-mm.h	&#40;revision 695&#41;
+++ perl-libxml-mm.h	&#40;working copy&#41;
@@ -48,6 +48,7 @@
 struct _ProxyNode {
     xmlNodePtr node;
     xmlNodePtr owner;
+    SV * thread;
     int count;
     int encoding;
 };
@@ -66,6 +67,7 @@
 #define PmmREFCNT_inc&#40;node&#41;  node-&gt;count++
 #define PmmNODE&#40;xnode&#41;       xnode-&gt;node
 #define PmmOWNER&#40;node&#41;       node-&gt;owner
+#define PmmTHREAD&#40;node&#41;      node-&gt;thread
 #define PmmOWNERPO&#40;node&#41;     &#40;&#40;node &#38;&#38; PmmOWNER&#40;node&#41;&#41; ? &#40;ProxyNodePtr&#41;PmmOWNER&#40;node&#41;-&gt;_private : node&#41;
 #define PmmENCODING&#40;node&#41;    node-&gt;encoding
 
Index: t/90threads.t
===================================================================
--- t/90threads.t	&#40;revision 695&#41;
+++ t/90threads.t	&#40;working copy&#41;
@@ -2,7 +2,7 @@
 use Config;
 use constant MAX_THREADS =&gt; 10;
 use constant MAX_LOOP =&gt; 50;
-use constant PLAN =&gt; 14;
+use constant PLAN =&gt; 15;
 BEGIN {
   plan tests =&gt; PLAN;
   if&#40; $Config{useithreads} &#41; {
@@ -38,6 +38,17 @@
 &lt;root&gt;&lt;node&gt;&lt;leaf/&gt;&lt;/node&gt;&lt;/root&gt;
 EOF
 
+# Spawn threads with a document in scope
+{
+my $doc = $p-&gt;parse_string&#40; $xml &#41;;
+for&#40;1..MAX_THREADS&#41;
+{
+	threads-&gt;new&#40;sub {}&#41;;
+}
+$_-&gt;join for&#40;threads-&gt;list&#41;;
+}
+ok&#40;1&#41;;
+
 # Parse a correct XML document
 {
 for&#40;1..MAX_THREADS&#41;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;07&nbsp;12:49:06&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;08&nbsp;06:56:21&nbsp;2008</span>
    <span class="description">TIMBRODY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> TIMBRODY [...] cpan.org</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">After a bit more thought here&#39;s a different approach.

This will handle the case where a thread uses an object that has gone
out scope of the thread that created it &#40;added test case to t/90threads.t&#41;.

This is possibly closer to how threads support is &#34;supposed&#34; to happen,
but doesn&#39;t copy the XS objects on clone.

Performance-wise I doubt it&#39;s worth maintaining anything more complex
than a linked list? Memory-wise this adds one pointer per active Perl
LibXML node.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: perl-libxml-mm.c
===================================================================
--- perl-libxml-mm.c	&#40;revision 695&#41;
+++ perl-libxml-mm.c	&#40;working copy&#41;
@@ -101,6 +101,7 @@
  *         &#40;in case of document fragments, they are not the same!&#41;
  * @count: this is the internal reference count!
  * @encoding: this value is missing in libxml2&#39;s doc structure
+ * @_registry: used to build the proxy node registry
  *
  * Since XML::LibXML will not know, is a certain node is already
  * defined in the perl layer, it can&#39;t shurely tell when a node can be
@@ -113,6 +114,7 @@
     xmlNodePtr owner;
     int count;
     int encoding; 
+    struct _ProxyNode * _registry;
 };
 
 /* helper type for the proxy structure */
@@ -134,6 +136,79 @@
 #define PmmENCODING&#40;node&#41;    node-&gt;encoding
 #define PmmNodeEncoding&#40;node&#41; &#40;&#40;ProxyNodePtr&#41;&#40;node-&gt;_private&#41;&#41;-&gt;encoding
 #define PmmDocEncoding&#40;node&#41; &#40;node-&gt;charset&#41;
+
+/*
+ * registry of all current proxy nodes
+ */
+ProxyNodePtr PROXY_NODE_REGISTRY = NULL;
+
+/*
+ * @proxy: proxy node to register
+ *
+ * adds a proxy node to the proxy node registry
+ */
+void
+PmmRegisterProxyNode&#40;ProxyNodePtr proxy&#41;
+{
+    proxy-&gt;_registry = PROXY_NODE_REGISTRY;
+    PROXY_NODE_REGISTRY = proxy;
+}
+
+/*
+ * @proxy: proxy node to remove
+ *
+ * removes a proxy node from the proxy node registry
+ */
+void
+PmmUnregisterProxyNode&#40;ProxyNodePtr proxy&#41;
+{
+    ProxyNodePtr cur = PROXY_NODE_REGISTRY;
+    if&#40; PROXY_NODE_REGISTRY == proxy &#41; {
+        PROXY_NODE_REGISTRY = proxy-&gt;_registry;
+    }
+    else {
+        while&#40;cur-&gt;_registry != NULL&#41;
+        {
+            if&#40; cur-&gt;_registry == proxy &#41;
+            {
+                cur-&gt;_registry = proxy-&gt;_registry;
+                break;
+            }
+            cur = cur-&gt;_registry;
+        }
+    }
+}
+
+/*
+ * increments all proxy node counters by one &#40;called on thread spawn&#41;
+ */
+void
+PmmCloneProxyNodes&#40;&#41;
+{
+    ProxyNodePtr cur = PROXY_NODE_REGISTRY;
+    while&#40;cur != NULL&#41;
+    {
+        PmmREFCNT_inc&#40;cur&#41;;
+        cur = cur-&gt;_registry;
+    }
+}
+
+/*
+ * returns the current number of proxy nodes in the registry
+ */
+int
+PmmProxyNodeRegistrySize&#40;&#41;
+{
+    int i = 0;
+    ProxyNodePtr cur = PROXY_NODE_REGISTRY;
+    while&#40;cur != NULL&#41;
+    {
+        ++i;
+        cur = cur-&gt;_registry;
+    }
+    return i;
+}
+
 /* creates a new proxy node from a given node. this function is aware
  * about the fact that a node may already has a proxy structure.
  */
@@ -155,7 +230,9 @@
             proxy-&gt;owner   = NULL;
             proxy-&gt;count   = 0;
             proxy-&gt;encoding= 0;
+            proxy-&gt;_registry = NULL;
             node-&gt;_private = &#40;void*&#41; proxy;
+            PmmRegisterProxyNode&#40;proxy&#41;;
         }
     }
     else {
@@ -283,6 +360,7 @@
                 
                 PmmFreeNode&#40; libnode &#41;;
             }
+            PmmUnregisterProxyNode&#40;node&#41;;
             Safefree&#40; node &#41;;
             /* free&#40; node &#41;; */
         }
Index: LibXML.xs
===================================================================
--- LibXML.xs	&#40;revision 695&#41;
+++ LibXML.xs	&#40;working copy&#41;
@@ -1272,6 +1272,19 @@
     xmlInitializeCatalog&#40;&#41;; /* use catalog data */
 #endif
 
+void
+_CLONE&#40; class &#41;
+        char * class
+    CODE:
+        PmmCloneProxyNodes&#40;&#41;;
+
+int
+_leaked_nodes&#40;&#41;
+    CODE:
+        RETVAL = PmmProxyNodeRegistrySize&#40;&#41;;
+    OUTPUT:
+        RETVAL
+
 char *
 LIBXML_DOTTED_VERSION&#40;&#41;
     CODE:
Index: perl-libxml-mm.h
===================================================================
--- perl-libxml-mm.h	&#40;revision 695&#41;
+++ perl-libxml-mm.h	&#40;working copy&#41;
@@ -50,6 +50,7 @@
     xmlNodePtr owner;
     int count;
     int encoding;
+    struct _ProxyNode * _registry;
 };
 
 /* helper type for the proxy structure */
Index: LibXML.pm
===================================================================
--- LibXML.pm	&#40;revision 695&#41;
+++ LibXML.pm	&#40;working copy&#41;
@@ -152,6 +152,14 @@
 }
 
 #-------------------------------------------------------------------------#
+# Threads support methods                                                 #
+#-------------------------------------------------------------------------#
+
+# threads doc says CLONE&#39;s API may change in future, which would break
+# an XS method prototype
+sub CLONE { XML::LibXML::_CLONE&#40; $_[0] &#41; }
+
+#-------------------------------------------------------------------------#
 # DOM Level 2 document constructor                                        #
 #-------------------------------------------------------------------------#
 
Index: t/80registryleak.t
===================================================================
--- t/80registryleak.t	&#40;revision 0&#41;
+++ t/80registryleak.t	&#40;revision 0&#41;
@@ -0,0 +1,23 @@
+use Test;
+BEGIN { plan tests =&gt; 3}
+END { ok&#40;0&#41; unless $loaded }
+use XML::LibXML;
+
+$loaded = 1;
+ok&#40;1&#41;;
+
+my $p = XML::LibXML-&gt;new&#40;&#41;;
+ok&#40;$p&#41;;
+
+my $xml = &lt;&lt;EOX;
+&lt;?xml version=&#34;1.0&#34;?&gt;
+&lt;root&gt;&lt;child/&gt;&lt;/root&gt;
+EOX
+
+{
+my $doc = $p-&gt;parse_string&#40;$xml&#41;;
+my $root = $doc-&gt;documentElement;
+my $child = $root-&gt;firstChild;
+}
+
+ok&#40;&#38;XML::LibXML::_leaked_nodes == 0&#41;;
Index: t/90threads.t
===================================================================
--- t/90threads.t	&#40;revision 695&#41;
+++ t/90threads.t	&#40;working copy&#41;
@@ -2,12 +2,13 @@
 use Config;
 use constant MAX_THREADS =&gt; 10;
 use constant MAX_LOOP =&gt; 50;
-use constant PLAN =&gt; 14;
+use constant PLAN =&gt; 16;
 BEGIN {
   plan tests =&gt; PLAN;
   if&#40; $Config{useithreads} &#41; {
     if &#40;$ENV{THREAD_TEST}&#41; {
       require threads;;
+	  require threads::shared;
     } else {
       skip&#40;&#34;optional &#40;set THREAD_TEST=1 to run these tests&#41;\n&#34;&#41; for &#40;1..PLAN&#41;;
       exit;
@@ -38,6 +39,33 @@
 &lt;root&gt;&lt;node&gt;&lt;leaf/&gt;&lt;/node&gt;&lt;/root&gt;
 EOF
 
+# Spawn threads with a document in scope
+{
+my $doc = $p-&gt;parse_string&#40; $xml &#41;;
+for&#40;1..MAX_THREADS&#41;
+{
+	threads-&gt;new&#40;sub {}&#41;;
+}
+$_-&gt;join for&#40;threads-&gt;list&#41;;
+}
+ok&#40;1&#41;;
+
+# Spawn threads that use document that has gone out of scope from where it was
+# created
+{
+my $waitfor : shared;
+{
+lock $waitfor;
+my $doc = $p-&gt;parse_string&#40;$xml&#41;;
+for&#40;1..MAX_THREADS&#41;
+{
+	threads-&gt;new&#40;sub { lock $waitfor; $doc-&gt;toString; }&#41;;
+}
+}
+$_-&gt;join for&#40;threads-&gt;list&#41;;
+ok&#40;1&#41;;
+}
+
 # Parse a correct XML document
 {
 for&#40;1..MAX_THREADS&#41;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;08&nbsp;10:38:08&nbsp;2008</span>
    <span class="description">pajas [...] matfyz.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Tim, thanks a lot!

I&#39;m about to commit the patch.

I hope O&#40;n&#41; unregistering won&#39;t be too great an overhead. 
What do you think about this idea:

Enable the reference counting only if &#39;use threads&#39; is in called 
before &#39;use XML::LibXML&#39;, i.e. if $threads::threads == 1 when the  
XML::LibXML&#39;s INIT is called? Then XML::LibXML could set up a flag that 
enables this reference counting; if $threads::threads is off, then the 
flag will be off and the reference counting won&#39;t be used &#40;with the 
benefit of avoiding the unregistering overhead&#41;. Just a 
thought,

Cheers,

-- Petr
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;08&nbsp;15:53:45&nbsp;2008</span>
    <span class="description">jhoger [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jhoger [...] pobox.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jan 08 06:56:21 2008, TIMBRODY wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Performance-wise I doubt it&#39;s worth maintaining anything more complex
&gt; than a linked list? Memory-wise this adds one pointer per active Perl
&gt; LibXML node.
</div>
Thanks for coming up with a fix, Tim!

I can&#39;t say I understand xs, but based on your explanation, does this
mean an O&#40;n&#41; lookup per every node in the document when a LibXML object
goes out of scope? That seems like it would add up. A O&#40;1&#41; &#40;hash, or
cache the pointer in a handy place&#41; operation would probably be worth it
for larger docs or lots of transient docs.

But if it&#39;s not really a lookup then it wouldn&#39;t matter.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;09&nbsp;03:49:06&nbsp;2008</span>
    <span class="description">pajas [...] matfyz.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> pajas [...] matfyz.cz</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I can&#39;t say I understand xs, but based on your explanation, does this
&gt; mean an O&#40;n&#41; lookup per every node in the document when a LibXML 
</div>object
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; goes out of scope? That seems like it would add up. A O&#40;1&#41; &#40;hash, or
&gt; cache the pointer in a handy place&#41; operation would probably be worth 
</div>it
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; for larger docs or lots of transient docs.
</div>
Not for every document node but for every node for which there is some 
reference from Perl still in the scope. I.e. if you do, say,

$doc = $parser-&gt;parse_file&#40;&#39;foo.xml&#39;&#41;;
{ my $el = XML::LibXML::Element-&gt;new&#40;&#39;bar&#39;&#41;; }

then when $el goes out of scope, a list of &#40;up to&#41; two nodes 
&#40;consisting of the document node and element node referred to in $doc 
and $el respectivelly&#41; is traversed &#40;although there may be thousands of 
nodes in the document $doc&#41;. Also, if things go in this particular 
order, $el is at the top of the list, so in fact it is removed in O&#40;1&#41;.

But otherwise I agree, maybe a Perl hash would be worth trying. Maybe 
benchmarks &#40;e.g. of the regression tests&#41; with no thread support, with 
a list and with a hash would be nice.

-- Petr
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;16&nbsp;14:21:21&nbsp;2008</span>
    <span class="description">jhoger [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jhoger [...] pobox.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jan 09 03:49:06 2008, PAJAS wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Not for every document node but for every node for which there is some 
&gt; reference from Perl still in the scope. I.e. if you do, say,
&gt; 
&gt; $doc = $parser-&gt;parse_file&#40;&#39;foo.xml&#39;&#41;;
&gt; { my $el = XML::LibXML::Element-&gt;new&#40;&#39;bar&#39;&#41;; }
&gt; 
&gt; then when $el goes out of scope, a list of &#40;up to&#41; two nodes 
&gt; &#40;consisting of the document node and element node referred to in $doc 
&gt; and $el respectivelly&#41; is traversed &#40;although there may be thousands of 
&gt; nodes in the document $doc&#41;. Also, if things go in this particular 
&gt; order, $el is at the top of the list, so in fact it is removed in O&#40;1&#41;.
&gt; 
</div>
Much less bad than if it happened for all nodes.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; But otherwise I agree, maybe a Perl hash would be worth trying. Maybe 
&gt; benchmarks &#40;e.g. of the regression tests&#41; with no thread support, with 
&gt; a list and with a hash would be nice.
&gt; 
</div>
Well, given your description of the list impact, it seems like the patch
makes sense to apply as-is. Certainly better than segfaults and double
free messages.

If the lookup causes any pain for those using threads and lots of XML
documents they &#40;may end up being me&#41; will have an itch to scratch.

Probably the experimental nature of the threading support should be
mentioned in the POD though. The current situation at least warns of
issues by printing errors. If it is fixed then there won&#39;t be any
indication, but the documentation could make up for that.

Please apply

-- John.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;28&nbsp;06:43:49&nbsp;2008</span>
    <span class="description">pajas [...] matfyz.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">applied amd ported to XML-LibXSLT
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;28&nbsp;06:43:58&nbsp;2008</span>
    <span class="description">pajas [...] matfyz.cz -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
