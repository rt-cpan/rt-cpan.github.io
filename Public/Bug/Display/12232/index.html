<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #12232 for Mail-Box: large fraction of testsuite fails because of -T usage</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #12232 for Mail-Box: large fraction of testsuite fails because of -T usage</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Mail-Box/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Mail-Box/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Mail-Box/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Mail-Box/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-Box">Mail-Box CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">12232</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Mail-Box/Active/">Mail-Box</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
rt.cpan.org [...] plan9.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-19874-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-19875-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




p1<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/129033/35987/p1">
Sun Jun 12 14:05:49 2005 (13k) by 
</a>
</font></li>
</ul>


taint2.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/129035/36179/taint2.patch">
Fri Jun 17 07:07:59 2005 (7.2k) by 
</a>
</font></li>
</ul>


version.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/129031/33547/version.txt">
Sun Apr 10 19:05:42 2005 (3.1k) by 
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;10&nbsp;19:05:42&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> large fraction of testsuite fails because of -T usage</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">A large fraction of the testsuite fails with messages like the following:

40mbox/20write......ok 1/5Insecure dependency in open while running with -T switch at /opt/perl/lib/perl5/IO/File.pm line 176.
        &#40;in cleanup&#41; Insecure dependency in open while running with -T switch at /opt/perl/lib/perl5/IO/File.pm line 176.

...

--- Test report
Success: 01platform, 10reporter, 11field, 12head, 13body, 14fieldu, 
    20pparser, 30encode, 31fgroups, 43pop3, 45dbx, 50message, 
    53threads, 54search, 60imap, 80msgconv, 81bodyconv
Failure: 40mbox&#40;*&#41;, 41mh, 42maildir, 51folder, 52manager&#40;*&#41;, 55locking
    Marked &#40;*&#41; are critical errors.
Skipped: 44imap
  /usr/bin/make test -- OK


I guess most if not all of those are bogus, but it&#39;s hard to find out which ones.

Perl -V output is attached.
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Summary of my perl5 &#40;revision 5 version 8 subversion 6&#41; configuration:
  Platform:
    osname=linux, osvers=2.6.10-rc1, archname=amd64-linux
    uname=&#39;linux cerebro 2.6.10-rc1 #1 smp mon nov 22 05:47:21 cet 2004 x86_64 gnulinux &#39;
    config_args=&#39;-Duselargefiles -Dxuse64bitint -Uxuse64bitall -Dusemymalloc=y -Dcc=gcc-3.4 -Dccflags=-ggdb -Dcppflags=-D_GNU_SOURCE -I/opt/include -Doptimize=-O4 -march=opteron -mtune=opteron -funroll-loops -fno-strict-aliasing -Dcccdlflags=-fPIC -Dldflags=-L/opt/perl/lib -L/opt/lib -Dlibs=-ldl -lm -lcrypt -Darchname=amd64-linux -Dprefix=/opt/perl -Dprivlib=/opt/perl/lib/perl5 -Darchlib=/opt/perl/lib/perl5 -Dvendorprefix=/opt/perl -Dvendorlib=/opt/perl/lib/perl5 -Dvendorarch=/opt/perl/lib/perl5 -Dsiteprefix=/opt/perl -Dsitelib=/opt/perl/lib/perl5 -Dsitearch=/opt/perl/lib/perl5 -Dsitebin=/opt/perl/bin -Dman1dir=/opt/perl/man/man1 -Dman3dir=/opt/perl/man/man3 -Dsiteman1dir=/opt/perl/man/man1 -Dsiteman3dir=/opt/perl/man/man3 -Dman1ext=1 -Dman3ext=3 -Dpager=/usr/bin/less -Uafs -Uusesfio -Uusenm -Uuseshrplib -Dd_dosuid -Dusethreads=undef -Duse5005threads=undef -Duseithreads=undef -Dusemultiplicity=undef -Demail=perl-binary@plan9.de -Dcf_email=perl-binary@plan9.de -Dcf_by=Marc Lehmann -Dlocincpth=/opt/perl/include /opt/include -Dmyhostname=localhost -Dmultiarch=undef -Dbin=/opt/perl/bin -des&#39;
    hint=recommended, useposix=true, d_sigaction=define
    usethreads=undef use5005threads=undef useithreads=undef usemultiplicity=undef
    useperlio=define d_sfio=undef uselargefiles=define usesocks=undef
    use64bitint=define use64bitall=define uselongdouble=undef
    usemymalloc=y, bincompat5005=undef
  Compiler:
    cc=&#39;gcc-3.4&#39;, ccflags =&#39;-ggdb -fno-strict-aliasing -pipe -I/opt/include -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64&#39;,
    optimize=&#39;-O4 -march=opteron -mtune=opteron -funroll-loops -fno-strict-aliasing&#39;,
    cppflags=&#39;-D_GNU_SOURCE -I/opt/include -ggdb -fno-strict-aliasing -pipe -I/opt/include&#39;
    ccversion=&#39;&#39;, gccversion=&#39;3.4.2 &#40;Debian 3.4.2-3&#41;&#39;, gccosandvers=&#39;&#39;
    intsize=4, longsize=8, ptrsize=8, doublesize=8, byteorder=12345678
    d_longlong=define, longlongsize=8, d_longdbl=define, longdblsize=16
    ivtype=&#39;long&#39;, ivsize=8, nvtype=&#39;double&#39;, nvsize=8, Off_t=&#39;off_t&#39;, lseeksize=8
    alignbytes=8, prototype=define
  Linker and Libraries:
    ld=&#39;gcc-3.4&#39;, ldflags =&#39;-L/opt/perl/lib -L/opt/lib -L/usr/local/lib&#39;
    libpth=/usr/local/lib /lib /usr/lib
    libs=-ldl -lm -lcrypt
    perllibs=-ldl -lm -lcrypt
    libc=/lib/libc-2.3.2.so, so=so, useshrplib=false, libperl=libperl.a
    gnulibc_version=&#39;2.3.2&#39;
  Dynamic Linking:
    dlsrc=dl_dlopen.xs, dlext=so, d_dlsymun=undef, ccdlflags=&#39;-Wl,-E&#39;
    cccdlflags=&#39;-fPIC&#39;, lddlflags=&#39;-shared -L/opt/perl/lib -L/opt/lib -L/usr/local/lib&#39;


Characteristics of this binary &#40;from libperl&#41;: 
  Compile-time options: USE_64_BIT_INT USE_64_BIT_ALL USE_LARGE_FILES
  Built under linux
  Compiled at Nov 30 2004 01:00:09
  %ENV:
    PERL5LIB=&#34;/root/src/sex&#34;
    PERL5_CPANPLUS_CONFIG=&#34;/root/.cpanplus/config&#34;
    PERLDB_OPTS=&#34;ornaments=0&#34;
    PERL_UNICODE=&#34;SAL&#34;
  @INC:
    /root/src/sex
    /opt/perl/lib/perl5
    /opt/perl/lib/perl5
    /opt/perl/lib/perl5
    /opt/perl/lib/perl5
    /opt/perl/lib/perl5
    /opt/perl/lib/perl5
    /opt/perl/lib/perl5
    .
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;03&nbsp;11:54:30&nbsp;2005</span>
    <span class="description">MARKOV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Sun Apr 10 19:05:42 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; A large fraction of the testsuite fails with messages like the
&gt; following:
&gt; 
&gt; 40mbox/20write......ok 1/5Insecure dependency in open while running
&gt; with -T switch at /opt/perl/lib/perl5/IO/File.pm line 176.
&gt;         &#40;in cleanup&#41; Insecure dependency in open while running with -T
&gt; switch at /opt/perl/lib/perl5/IO/File.pm line 176.
</div>
Would you be so kind to try to figure out what is happening for only
one of these?  Then I will fix the other cases.  In my set-up at home
&#40;5.8.5&#41; everything runs without complaints.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;12&nbsp;14:05:49&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ntyni [...] iki.fi</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[MARKOV - Fri Jun  3 11:54:30 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [guest - Sun Apr 10 19:05:42 2005]:
&gt; 
<div class="message-stanza open">&gt; &gt; A large fraction of the testsuite fails with messages like the
&gt; &gt; following:
&gt; &gt;
&gt; &gt; 40mbox/20write......ok 1/5Insecure dependency in open while running
&gt; &gt; with -T switch at /opt/perl/lib/perl5/IO/File.pm line 176.
&gt; &gt;         &#40;in cleanup&#41; Insecure dependency in open while running with
</div>&gt;    -T
<div class="message-stanza open">&gt; &gt; switch at /opt/perl/lib/perl5/IO/File.pm line 176.
</div>&gt; 
&gt; Would you be so kind to try to figure out what is happening for only
&gt; one of these?  Then I will fix the other cases.  In my set-up at home
&gt; &#40;5.8.5&#41; everything runs without complaints.
</div>
Hi,

the reason for these error messages is that IO::File has been upgraded 
from 1.10 to 1.11, and it&#39;s now using File::Spec-&gt;rel2abs&#40;$file&#41; instead of 
File::Spec-&gt;catfile&#40;File::Spec-&gt;curdir&#40;&#41;,$file&#41;

The File::Spec::Unix implementation of rel2abs&#40;&#41; uses Cwd::cwd&#40;&#41;, which
is tainted,
while curdir&#40;&#41; uses  just dot &#40;&#39;.&#39;&#41;, which isn&#39;t.

Thus, every test where a mailbox with a relative path is opened for writing 
fails the taint check. There are quite many of these, of course.

As we probably don&#39;t want to drop the -T parameter, here&#39;s a proposed
patch that

- turns the $folderdir variable in Tools.pm into an absolute path 
- untaints $folderdir 
- makes all the tests use $folderdir instead of the usually hardcoded
string &#39;folders&#39;

Hope I found all the occurrences. At least this gets rid of all the
tainting errors in my setup. There are other problems with the tests and
Perl 5.8.7, but I&#39;ll report them as separate tickets.
-- 
Niko Tyni
ntyni@iki.fi
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/129033/35987/p1">Download p1</a><br />
<span class="downloadcontenttype">application/octet-stream 13k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;15&nbsp;15:49:23&nbsp;2005</span>
    <span class="description">MARKOV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Sun Jun 12 14:05:49 2005]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; &gt; A large fraction of the testsuite fails with messages like the
&gt; &gt; &gt; following:
&gt; &gt; &gt;
&gt; &gt; &gt; 40mbox/20write......ok 1/5Insecure dependency in open while
</div>&gt;    running
<div class="message-stanza open">&gt; &gt; &gt; with -T switch
</div>&gt; As we probably don&#39;t want to drop the -T parameter, here&#39;s a proposed
&gt; patch that
&gt; 
&gt; - turns the $folderdir variable in Tools.pm into an absolute path
&gt; - untaints $folderdir
&gt; - makes all the tests use $folderdir instead of the usually hardcoded
&gt; string &#39;folders&#39;
</div>
I do not think that this is the best solution for the problem... I would
like other people who use -T in their scripts with MailBox to be able to
use relative paths as well.  Isn&#39;t there a simple patch which untaints
the filename before open?

Isn&#39;t it a bit silly to have the cwd return a tainted value?  On UNIX, I
cannot imagin any security problem, because all characters are permitted
in a path &#40;except \0, which is not a problem&#41;

I really hesitate to install all my zillion modules over again just to
test this bug :-&#40;  
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;17&nbsp;07:07:59&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ntyni [...] iki.fi</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[MARKOV - Wed Jun 15 15:49:23 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I do not think that this is the best solution for the problem... I
&gt; would
&gt; like other people who use -T in their scripts with MailBox to be able
&gt; to
&gt; use relative paths as well.  Isn&#39;t there a simple patch which untaints
&gt; the filename before open?
</div>
Well, since hacking IO::File itself is out of question &#40;I suppose&#41;,
the Right Way to do this is probably to subclass IO::File and 
do the untainting there. See the attached patch. It does fix
the errors for me.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Isn&#39;t it a bit silly to have the cwd return a tainted value?  On UNIX,
&gt; I
&gt; cannot imagin any security problem, because all characters are
&gt; permitted
&gt; in a path &#40;except \0, which is not a problem&#41;
</div>
In general, cwd is and should be tainted just like all the environment
variables. Think SUID programs that modify a file with a relative path.
&#40;hope no-one is that stupid, but anyway...&#41;

So I think IO::File is doing the right thing, although in the case
of Mail::Box I guess cwd shouldn&#39;t matter, as the -T is there mainly
to catch possibly malicious stuff from email headers and server 
responses &#40;?&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I really hesitate to install all my zillion modules over again just to
&gt; test this bug :-&#40;
</div>
Hope this patch helps a bit.

Note that I&#39;m not the original submitter of this ticket, and thus don&#39;t
currently
receive any responses by e-mail. Could you please add me to the ticket CCs
if possible.

Thanks,
-- 
Niko Tyni
ntyni@iki.fi
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Mail-Box-2.060/lib/Mail/Box/Dir/Message.pm	2005-03-15 21:02:43.000000000 +0000
+++ Mail-Box-2.060-mod/lib/Mail/Box/Dir/Message.pm	2005-06-17 06:42:50.000000000 +0000
@@ -8,7 +8,7 @@
 use base &#39;Mail::Box::Message&#39;;
 
 use File::Copy qw/move/;
-use IO::File;
+use Mail::Box::IOFile;
 
 
 sub init&#40;$&#41;
@@ -186,7 +186,7 @@
     # Write the new data to a new file.
 
     my $new     = $filename . &#39;.new&#39;;
-    my $newfile = IO::File-&gt;new&#40;$new, &#39;w&#39;&#41;;
+    my $newfile = Mail::Box::IOFile-&gt;new&#40;$new, &#39;w&#39;&#41;;
     $self-&gt;log&#40;ERROR =&gt; &#34;Cannot write message to $new: $!&#34;&#41;, return
         unless $newfile;
 
--- Mail-Box-2.060/lib/Mail/Box/Locker/NFS.pm	2005-03-15 21:02:42.000000000 +0000
+++ Mail-Box-2.060-mod/lib/Mail/Box/Locker/NFS.pm	2005-06-17 06:42:50.000000000 +0000
@@ -7,6 +7,7 @@
 use base &#39;Mail::Box::Locker&#39;;
 
 use Sys::Hostname;
+use Mail::Box::IOFile;
 use IO::File;
 use Carp;
 
@@ -40,7 +41,7 @@
 {   my $self    = shift;
     my $tmpfile = $self-&gt;_tmpfilename;
 
-    my $fh      = IO::File-&gt;new&#40;$tmpfile, O_CREAT|O_WRONLY, 0600&#41;
+    my $fh      = Mail::Box::IOFile-&gt;new&#40;$tmpfile, O_CREAT|O_WRONLY, 0600&#41;
         or return undef;
 
     $fh-&gt;close;
--- Mail-Box-2.060/lib/Mail/Box/Locker/DotLock.pm	2005-03-15 21:02:43.000000000 +0000
+++ Mail-Box-2.060-mod/lib/Mail/Box/Locker/DotLock.pm	2005-06-17 06:42:50.000000000 +0000
@@ -6,6 +6,7 @@
 $VERSION = &#39;2.060&#39;;
 use base &#39;Mail::Box::Locker&#39;;
 
+use Mail::Box::IOFile;
 use IO::File;
 use Carp;
 use File::Spec;
@@ -41,7 +42,7 @@
                  ?  O_CREAT|O_EXCL|O_WRONLY
                  :  O_CREAT|O_EXCL|O_WRONLY|O_NONBLOCK;
 
-    my $lock     = IO::File-&gt;new&#40;$lockfile, $flags, 0600&#41;
+    my $lock     = Mail::Box::IOFile-&gt;new&#40;$lockfile, $flags, 0600&#41;
        or return 0;
 
     close $lock;
--- Mail-Box-2.060/lib/Mail/Box/Locker/Flock.pm	2005-03-15 21:02:42.000000000 +0000
+++ Mail-Box-2.060-mod/lib/Mail/Box/Locker/Flock.pm	2005-06-17 06:42:50.000000000 +0000
@@ -6,7 +6,7 @@
 $VERSION = &#39;2.060&#39;;
 use base &#39;Mail::Box::Locker&#39;;
 
-use IO::File;
+use Mail::Box::IOFile;
 use Fcntl         qw/:DEFAULT :flock/;
 use Errno         qw/EAGAIN/;
 
@@ -41,7 +41,7 @@
 
     my $filename = $self-&gt;filename;
 
-    my $file   = IO::File-&gt;new&#40;$filename, $lockfile_access_mode&#41;;
+    my $file   = Mail::Box::IOFile-&gt;new&#40;$filename, $lockfile_access_mode&#41;;
     unless&#40;$file&#41;
     {   $self-&gt;log&#40;ERROR =&gt;
            &#34;Unable to open flock file $filename for $self-&gt;{MBL_folder}: $!&#34;&#41;;
@@ -77,7 +77,7 @@
 {   my $self     = shift;
     my $filename = $self-&gt;filename;
 
-    my $file     = IO::File-&gt;new&#40;$filename, $lockfile_access_mode&#41;;
+    my $file     = Mail::Box::IOFile-&gt;new&#40;$filename, $lockfile_access_mode&#41;;
     unless&#40;$file&#41;
     {   $self-&gt;log&#40;ERROR =&gt;
             &#34;Unable to check lock file $filename for $self-&gt;{MBL_folder}: $!&#34;&#41;;
--- Mail-Box-2.060/lib/Mail/Box/Locker/POSIX.pm	2005-03-15 21:02:43.000000000 +0000
+++ Mail-Box-2.060-mod/lib/Mail/Box/Locker/POSIX.pm	2005-06-17 06:42:50.000000000 +0000
@@ -8,7 +8,7 @@
 
 use POSIX;
 use Fcntl;
-use IO::File;
+use Mail::Box::IOFile;
 
 
 #-------------------------------------------
@@ -39,7 +39,7 @@
 
     my $filename = $self-&gt;filename;
 
-    my $file   = IO::File-&gt;new&#40;$filename, &#39;r+&#39;&#41;;
+    my $file   = Mail::Box::IOFile-&gt;new&#40;$filename, &#39;r+&#39;&#41;;
     unless&#40;defined $file&#41;
     {   $self-&gt;log&#40;ERROR =&gt;
            &#34;Unable to open POSIX lock file $filename for $self-&gt;{MBL_folder}: $!&#34;&#41;;
@@ -75,7 +75,7 @@
 {   my $self     = shift;
     my $filename = $self-&gt;filename;
 
-    my $file     = IO::File-&gt;new&#40;$filename, &#34;r&#34;&#41;;
+    my $file     = Mail::Box::IOFile-&gt;new&#40;$filename, &#34;r&#34;&#41;;
     unless&#40;$file&#41;
     {   $self-&gt;log&#40;ERROR =&gt;
                &#34;Unable to check lock file $filename for $self-&gt;{MBL_folder}: $!&#34;&#41;;
--- Mail-Box-2.060/lib/Mail/Box/IOFile.pm	1970-01-01 00:00:00.000000000 +0000
+++ Mail-Box-2.060-mod/lib/Mail/Box/IOFile.pm	2005-06-17 10:45:40.805633159 +0000
@@ -0,0 +1,21 @@
+package Mail::Box::IOFile;
+
+use base &#39;IO::File&#39;;
+use File::Spec;
+
+# this class is just a wrapper around IO::File,
+# because starting with 1.11 &#40;Perl 5.8.7&#41; 
+# IO::File-&gt;open cannot open files with relative pathnames
+# when tainting checks are enabled
+
+# workaround: turn the relative path to an absolute
+# one here, then untaint it
+
+sub open {
+	my &#40;$self, $file, @rest&#41; = @_;
+	$file = File::Spec-&gt;rel2abs&#40;$file&#41;;
+	&#40;$file&#41; = $file =~ /^&#40;.*&#41;$/;
+	return $self-&gt;SUPER::open&#40;$file, @rest&#41;;
+}
+
+1;
--- Mail-Box-2.060/lib/Mail/Box/Parser/Perl.pm	2005-03-15 21:02:42.000000000 +0000
+++ Mail-Box-2.060-mod/lib/Mail/Box/Parser/Perl.pm	2005-06-17 06:42:50.000000000 +0000
@@ -8,7 +8,7 @@
 
 use Mail::Message::Field;
 use List::Util &#39;sum&#39;;
-use IO::File;
+use Mail::Box::IOFile;
 
 
 sub init&#40;@&#41;
@@ -301,7 +301,7 @@
 
 sub openFile&#40;$&#41;
 {   my &#40;$self, $args&#41; = @_;
-    my $fh = $args-&gt;{file} || IO::File-&gt;new&#40;$args-&gt;{filename}, $args-&gt;{mode}&#41;;
+    my $fh = $args-&gt;{file} || Mail::Box::IOFile-&gt;new&#40;$args-&gt;{filename}, $args-&gt;{mode}&#41;;
 
     return unless $fh;
     $self-&gt;{MBPP_file}       = $fh;
--- Mail-Box-2.060/lib/Mail/Box/File.pm	2005-03-15 21:02:43.000000000 +0000
+++ Mail-Box-2.060-mod/lib/Mail/Box/File.pm	2005-06-17 06:42:50.000000000 +0000
@@ -19,7 +19,7 @@
 use File::Spec;
 use File::Basename;
 use POSIX &#39;:unistd_h&#39;;
-use IO::File &#40;&#41;;
+use Mail::Box::IOFile &#40;&#41;;
 
 my $windows;
 BEGIN { $windows = $^O =~ m/mswin32|cygwin/i }
@@ -118,7 +118,7 @@
     $class-&gt;moveAwaySubFolder&#40;$filename, $subext&#41;
         if -d $filename &#38;&#38; defined $subext;
 
-    if&#40;my $create = IO::File-&gt;new&#40;$filename, &#39;w&#39;&#41;&#41;
+    if&#40;my $create = Mail::Box::IOFile-&gt;new&#40;$filename, &#39;w&#39;&#41;&#41;
     {   $class-&gt;log&#40;PROGRESS =&gt; &#34;Created folder $name.&#34;&#41;;
         $create-&gt;close or return;
     }
@@ -186,7 +186,7 @@
  
     my $filename = $folder-&gt;filename;
 
-    my $out      = IO::File-&gt;new&#40;$filename, &#39;a&#39;&#41;;
+    my $out      = Mail::Box::IOFile-&gt;new&#40;$filename, &#39;a&#39;&#41;;
     unless&#40;$out&#41;
     {   $class-&gt;log&#40;ERROR =&gt; &#34;Cannot append messages to folder file $filename: $!&#34;&#41;;
         return &#40;&#41;;
@@ -359,7 +359,7 @@
 {   my &#40;$self, $args&#41; = @_;
 
     my $filename = $self-&gt;filename;
-    my $new      = IO::File-&gt;new&#40;$filename, &#39;w&#39;&#41;;
+    my $new      = Mail::Box::IOFile-&gt;new&#40;$filename, &#39;w&#39;&#41;;
     return 0 unless defined $new;
 
     $_-&gt;write&#40;$new&#41; foreach @{$args-&gt;{messages}};
@@ -382,8 +382,8 @@
     my $filename = $self-&gt;filename;
     my $tmpnew   = $self-&gt;tmpNewFolder&#40;$filename&#41;;
 
-    my $new      = IO::File-&gt;new&#40;$tmpnew, &#39;w&#39;&#41;   or return 0;
-    my $old      = IO::File-&gt;new&#40;$filename, &#39;r&#39;&#41; or return 0;
+    my $new      = Mail::Box::IOFile-&gt;new&#40;$tmpnew, &#39;w&#39;&#41;   or return 0;
+    my $old      = Mail::Box::IOFile-&gt;new&#40;$filename, &#39;r&#39;&#41; or return 0;
 
     my &#40;$reprint, $kept&#41; = &#40;0,0&#41;;
 
@@ -461,7 +461,7 @@
     my $mode     = $^O eq &#39;MSWin32&#39; ? &#39;a&#39; : &#39;+&lt;&#39;;
     my $filename = $self-&gt;filename;
 
-    my $old      = IO::File-&gt;new&#40;$filename, $mode&#41; or return 0;
+    my $old      = Mail::Box::IOFile-&gt;new&#40;$filename, $mode&#41; or return 0;
 
     # Chop the folder after the messages which does not have to change.
 
--- Mail-Box-2.060/tests/40mbox/50create.t	2005-03-15 20:59:48.000000000 +0000
+++ Mail-Box-2.060-mod/tests/40mbox/50create.t	2005-06-17 06:42:50.000000000 +0000
@@ -49,7 +49,7 @@
 folder $top, &#34;f2&#34;;
 
 {   # Create an empty file.
-    my $f = IO::File-&gt;new&#40;File::Spec-&gt;catfile&#40;$top,&#39;f3&#39;&#41;, &#39;w&#39;&#41;
+    my $f = Mail::Box::IOFile-&gt;new&#40;File::Spec-&gt;catfile&#40;$top,&#39;f3&#39;&#41;, &#39;w&#39;&#41;
         or die &#34;Empty? $top/f3: $!&#34;;
 
     $f-&gt;close;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;18&nbsp;06:53:05&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ntyni [...] iki.fi</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[MARKOV - Wed Jun 15 15:49:23 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I really hesitate to install all my zillion modules over again just to
&gt; test this bug :-&#40;
</div>
BTW, this problem can be reproduced with at least Perl 5.8.4 just by
copying the newer version of IO::File to the search path.

Cheers,
-- 
Niko Tyni
ntyni@iki.fi
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;22&nbsp;14:04:32&nbsp;2005</span>
    <span class="description">MARKOV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">You put me on the right track...  Still, I decided for a little
different approach: I do not want the IO::MailBox::File or such to be
present for everyone: it breaks the taint protection.  The only thing I
need it to pass the tests, where I want to test with relative paths.

So: this is what I did to tests/Tools.pm:

  BEGIN {                                                              
                 
   my $old_open = \&#38;IO::File::open;

   no warnings &#39;redefine&#39;;

   *IO::File::open = sub {
      my $self = shift;
      my $file = File::Spec-&gt;rel2abs&#40;shift&#41;;
      $file =~ /^&#40;.*&#41;$/;   # untaint
      $old_open-&gt;&#40;$self, $1, @_&#41;;
  }

It works &#40;I hope for everyone&#41;.  Thanks for your suggestions!  The
helped me a lot.

Changes just released in MailBox v2.061
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;22&nbsp;14:04:33&nbsp;2005</span>
    <span class="description">MARKOV [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
