<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #5962 for Mail-IMAPClient: IMAPClient eats CPU while waiting for a response</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #5962 for Mail-IMAPClient: IMAPClient eats CPU while waiting for a response</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Mail-IMAPClient">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Mail-IMAPClient">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Mail-IMAPClient">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Mail-IMAPClient">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-IMAPClient">Mail-IMAPClient CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">5962</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Mail-IMAPClient">Mail-IMAPClient</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
colin [...] spamjab.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-19960-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-19961-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




IMAPClient.pm-2.1.9.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/101296/25213/IMAPClient.pm-2.1.9.patch">
Sat Nov 27 03:40:50 2004 (599b) by 
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=5962">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-101295" href="/Public/Bug/Display.html?id=5962#txn-101295">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;07&nbsp;05:41:32&nbsp;2004</span>
    <span class="description">colin [...] spamjab.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Colin Robertson&#34; &lt;colin [...] spamjab.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-IMAPClient [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> IMAPClient eats CPU while waiting for a response</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 7 Apr 2004 10:41:21 +0100</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/101295/18048/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/18048">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 767b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve been using Mail::IMAPClient 2.2.9 for a while, and I&#39;ve found a problem
in its handling of a 0 timeout. Looking at the _read_line method, I see that
when the timeout is set to 0 IMAPClient will poll as fast as it can to read
new data. This means that it swallows up as many CPU cycles as it can get.

This can be demonstrated by setting up an IMAP server that sends no response
to a login command and attempting to connect with Mail::IMAPClient. Running
top will show the client using all the CPU time on the system.

As a suggestion, when the timeout is 0 it might be reasonable to call
$self-&gt;{_select}-&gt;can_read with an arbitrary timeout and, when it returns an
empty list, just call it again. This would drastically reduce the CPU usage in
this case.

colin
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-101296" href="/Public/Bug/Display.html?id=5962#txn-101296">#</a>      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;27&nbsp;03:40:50&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jules Agee</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/101296/25212/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/25212">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 428b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">[colin@spamjab.com - Wed Apr  7 05:41:32 2004]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve been using Mail::IMAPClient 2.2.9 for a while, and I&#39;ve found a
&gt; problem
&gt; in its handling of a 0 timeout. Looking at the _read_line method, I
&gt; see that
&gt; when the timeout is set to 0 IMAPClient will poll as fast as it can to
&gt; read
&gt; new data. This means that it swallows up as many CPU cycles as it can
&gt; get.
</div>
I ran into the same problem. Attached is da patch I used.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/101296/25213/IMAPClient.pm-2.1.9.patch">Download IMAPClient.pm-2.1.9.patch</a><br />
<span class="downloadcontenttype">text/x-diff 599b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- IMAPClient.pm	2004-11-26 23:56:07.000000000 -0800
+++ IMAPClient.pm.new	2004-11-24 18:01:04.000000000 -0800
@@ -1805,13 +1805,17 @@
 sub _sysread {
 	my $self = shift @_;
 	if &#40; exists $self-&gt;{Readmethod} &#41;  {
 		return $self-&gt;Readmethod-&gt;&#40;$self,@_&#41; ;
 	} else {
 		my&#40;$handle,$buffer,$count,$offset&#41; = @_;
-		return sysread&#40; $handle, $$buffer, $count, $offset&#41;;
+		my $retval = sysread&#40; $handle, $$buffer, $count, $offset&#41;;
+		if &#40;$! eq &#34;Resource temporarily unavailable&#34; &#41; {
+			CORE::select&#40;undef, undef, undef, .001&#41;;
+		}
+		return $retval;
 	}
 }
 
 =begin obsolete
 
 sub old_read_line {
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-375150" href="/Public/Bug/Display.html?id=5962#txn-375150">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;24&nbsp;18:28:43&nbsp;2007</span>
    <span class="description">MARKOV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/375150/170962/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/170962">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 630b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Apr 07 05:41:32 2004, colin@spamjab.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; As a suggestion, when the timeout is 0 it might be reasonable to call
&gt; $self-&gt;{_select}-&gt;can_read with an arbitrary timeout and, when it
&gt; returns an
&gt; empty list, just call it again. This would drastically reduce the CPU
&gt; usage in
&gt; this case.
</div>
New maintainer.

I think that the solution is much simpler.  The timeout parameter
of select&#40;&#41; makes a difference between 0 and undef.  In case of 0,
the select does not wait at all.  For undef, it waits blocking.
I think the latter is what is meant.

In 2.99_02, the code will be:  select&#40; , , , $timeout||undef&#41;

-- MarkOv
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-375151" href="/Public/Bug/Display.html?id=5962#txn-375151">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;24&nbsp;18:28:44&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-382662" href="/Public/Bug/Display.html?id=5962#txn-382662">#</a>      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;13&nbsp;06:06:09&nbsp;2007</span>
    <span class="description">MARKOV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/382662/175285/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/175285">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 33b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">probably working.  Ticket closed.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-382665" href="/Public/Bug/Display.html?id=5962#txn-382665">#</a>      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;13&nbsp;06:06:14&nbsp;2007</span>
    <span class="description">MARKOV [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-382794" href="/Public/Bug/Display.html?id=5962#txn-382794">#</a>      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;13&nbsp;13:19:40&nbsp;2007</span>
    <span class="description">jwm [...] horde.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #5962] $timeout || undef doesn&#39;t seem to fix excessive CPU consumption</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 13 Nov 2007 13:19:02 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-IMAPClient [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> John Morrissey &lt;jwm [...] horde.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/382794/175385/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/175385">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I noticed this behavior recently, with IMAPClient 2.2.9.

strace&#40;1&#41; shows the socket in non-blocking mode and IMAPClient in a tight
loop trying to read the server&#39;s response:

read&#40;3, &#34;* 1 FETCH &#40;FLAGS &#40;\\Seen&#41; UID 100&#34;..., 4096&#41; = 36
read&#40;3, &#34;169 OK UID FETCH completed\r\n&#34;, 4096&#41; = 28
write&#40;5, &#34;266 UID store 1 +FLAGS &#40;\\Seen&#41;\r\n&#34;, 32&#41; = 32
read&#40;5, 0x85f5698, 4096&#41;                = -1 EAGAIN &#40;Resource temporarily unavailable&#41;
read&#40;5, 0x85f5698, 4096&#41;                = -1 EAGAIN &#40;Resource temporarily unavailable&#41;
read&#40;5, 0x85f5698, 4096&#41;                = -1 EAGAIN &#40;Resource temporarily unavailable&#41;
read&#40;5, 0x85f5698, 4096&#41;                = -1 EAGAIN &#40;Resource temporarily unavailable&#41;
read&#40;5, 0x85f5698, 4096&#41;                = -1 EAGAIN &#40;Resource temporarily unavailable&#41;
read&#40;5, 0x85f5698, 4096&#41;                = -1 EAGAIN &#40;Resource temporarily unavailable&#41;


As mentioned in this bug, I tried changing the timeout arguments to
CORE::select&#40;&#41; to &#39;$timeout || undef&#39;, but this did not seem to have any
impact on CPU consumption &#40;sorry, the diff is backward&#41;:

--- IMAPClient.pm       2007-11-09 19:52:28.000000000 +0000
+++ IMAPClient.pm.orig  2007-11-09 19:40:06.000000000 +0000
@@ -1690,7 +1690,7 @@
                                unless &#40; CORE::select&#40; $ready = $rvec, 
                                                        undef, 
                                                        $errors = $rvec, 
-                                                       $timeout || undef&#41; 
+                                                       $timeout&#41; 
                                &#41; {     
                                        # Select failed; that means bad news. 
                                        # Better tell someone.
@@ -1966,7 +1962,7 @@
                                unless &#40; CORE::select&#40; $ready = $rvec, 
                                                        undef, 
                                                        $errors = $rvec, 
-                                                       $timeout || undef&#41; 
+                                                       $timeout&#41; 
                                &#41; {     
                                        # Select failed; that means bad news. 
                                        # Better tell someone.


but this had no effect on CPU consumption. Jules Agee&#39;s proposed solution
&#40;Sat Nov 27 03:40:50 2004&#41; decreases CPU consumption *dramatically* by
sleeping for a small amount of time between EAGAIN read&#40;&#41; calls. FWIW, I&#39;ll
post the exact diff we used &#40;again, sorry for the backward diff&#41;:

--- IMAPClient.pm       2007-11-09 19:52:28.000000000 +0000
+++ IMAPClient.pm.orig  2007-11-09 19:40:06.000000000 +0000
@@ -1813,11 +1813,7 @@
                return $self-&gt;Readmethod-&gt;&#40;$self,@_&#41; ;
        } else {
                my&#40;$handle,$buffer,$count,$offset&#41; = @_;
-               my $retval = sysread&#40; $handle, $$buffer, $count, $offset&#41;;
-               if &#40;$! eq &#34;Resource temporarily unavailable&#34;&#41; {
-                       CORE::select&#40;undef, undef, undef, .001&#41;;
-               }
-               return $retval;
+               return sysread&#40; $handle, $$buffer, $count, $offset&#41;;
        }
 }


This change drops CPU usage from 100% to 10-15% at peak, 5-8% typical. I
didn&#39;t try using a longer timeout to see what effect that had.

john
-- 
John Morrissey          _o            /\         ----  __o
jwm@horde.net        _-&lt; \_          /  \       ----  &lt;  \,
www.horde.net/    __&#40;_&#41;/_&#40;_&#41;________/    \_______&#40;_&#41; /_&#40;_&#41;__
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-382795" href="/Public/Bug/Display.html?id=5962#txn-382795">#</a>      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;13&nbsp;13:19:41&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-383083" href="/Public/Bug/Display.html?id=5962#txn-383083">#</a>      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;14&nbsp;03:03:41&nbsp;2007</span>
    <span class="description">webmaster [...] nlnet.nl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #5962] $timeout || undef doesn&#39;t seem to fix excessive CPU consumption</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 14 Nov 2007 09:03:19 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;jwm [...] horde.net via RT&#34; &lt;bug-Mail-IMAPClient [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> NLnet webmaster &lt;webmaster [...] nlnet.nl&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/383083/175531/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/175531">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 825b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">* jwm@horde.net via RT &#40;bug-Mail-IMAPClient@rt.cpan.org&#41; [071113 18:19]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Mail-IMAPClient
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=5962">http://rt.cpan.org/Ticket/Display.html?id=5962</a></span> &gt;
&gt; 
&gt; I noticed this behavior recently, with IMAPClient 2.2.9.
&gt; strace&#40;1&#41; shows the socket in non-blocking mode and IMAPClient in a tight
&gt; loop trying to read the server&#39;s response:
</div>
This is a known problem.  Try 2.99_06.  It has a few dozen more
useful fixes.
-- 
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
drs Mark A.C.J. Overmeer                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-383357" href="/Public/Bug/Display.html?id=5962#txn-383357">#</a>      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;14&nbsp;16:05:27&nbsp;2007</span>
    <span class="description">jwm [...] horde.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #5962] $timeout || undef doesn&#39;t seem to fix excessive CPU consumption</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 14 Nov 2007 14:40:37 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-IMAPClient [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> John Morrissey &lt;jwm [...] horde.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/383357/175695/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/175695">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed, 14 Nov 2007 09:03:19 +0100, NLnet webmaster wrote:
&gt; * jwm[...]horde.net via RT &#40;bug-Mail-IMAPClient[...]rt.cpan.org&#41; [071113 18:19]:
<div class="message-stanza open">&gt; &gt; Queue: Mail-IMAPClient
&gt; &gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=5962">http://rt.cpan.org/Ticket/Display.html?id=5962</a></span> &gt;
&gt; &gt;
&gt; &gt; I noticed this behavior recently, with IMAPClient 2.2.9.
&gt; &gt; strace&#40;1&#41; shows the socket in non-blocking mode and IMAPClient in a tight
&gt; &gt; loop trying to read the server&#39;s response:
</div>&gt; 
&gt; This is a known problem. Try 2.99_06. It has a few dozen more
&gt; useful fixes.
</div>
I&#39;m using IMAPClient with imapsync. I grabbed Mail-IMAPClient-2.99_07 and
imapsync-1.233 &#40;the latest revisions of both&#41;.

Unfortunately, all connections seem to time out:

Can not open imap connection on [imap.example.com] with user [example] : Timeout after 30 seconds during read from server

strace&#40;1&#41; output is thus:

connect&#40;3, {sa_family=AF_INET, sin_port=htons&#40;143&#41;, sin_addr=inet_addr&#40;&#34;1.2.3.4&#34;&#41;}, 16&#41; = 0
select&#40;8, [3], NULL, NULL, {30, 0}&#41;     = 1 &#40;in [3], left {29, 992000}&#41;
read&#40;3, &#34;* OK IMAP4 server &#40;InterMail vM.&#34;..., 4096&#41; = 111
select&#40;8, [3], NULL, NULL, {30, 0}&#41;     = 0 &#40;Timeout&#41;

This is more FWIW than anything; I&#39;m going to stick to the older versions of
Mail-IMAPClient &#40;plus the artificial-delay kludge I mentioned earlier&#41; and
imapsync, since I just don&#39;t have the time to plumb this rabbit hole right
now.

john
-- 
John Morrissey          _o            /\         ----  __o
jwm@horde.net        _-&lt; \_          /  \       ----  &lt;  \,
www.horde.net/    __&#40;_&#41;/_&#40;_&#41;________/    \_______&#40;_&#41; /_&#40;_&#41;__
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-383436" href="/Public/Bug/Display.html?id=5962#txn-383436">#</a>      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;14&nbsp;19:26:08&nbsp;2007</span>
    <span class="description">jwm [...] horde.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> mark [...] overmeer.net</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #5962] attempt at new Mail-IMAPClient revision</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 14 Nov 2007 15:53:47 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-IMAPClient [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> John Morrissey &lt;jwm [...] horde.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/383436/175746/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/175746">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed, 14 Nov 2007 09:03:19 +0100, NLnet webmaster wrote:
&gt; * jwm[...]horde.net via RT &#40;bug-Mail-IMAPClient[...]rt.cpan.org&#41; [071113 18:19]:
<div class="message-stanza open">&gt; &gt; Queue: Mail-IMAPClient
&gt; &gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=5962">http://rt.cpan.org/Ticket/Display.html?id=5962</a></span> &gt;
&gt; &gt;
&gt; &gt; I noticed this behavior recently, with IMAPClient 2.2.9.
&gt; &gt; strace&#40;1&#41; shows the socket in non-blocking mode and IMAPClient in a tight
&gt; &gt; loop trying to read the server&#39;s response:
</div>&gt; 
&gt; This is a known problem. Try 2.99_06. It has a few dozen more
&gt; useful fixes.
</div>
I&#39;m using IMAPClient with imapsync. I grabbed Mail-IMAPClient-2.99_07 and
imapsync-1.233 &#40;the latest revisions of both&#41;.

Unfortunately, all connections seem to time out:

Can not open imap connection on [imap.example.com] with user [example] : Timeout after 30 seconds during read from server

strace&#40;1&#41; output is thus:

connect&#40;3, {sa_family=AF_INET, sin_port=htons&#40;143&#41;, sin_addr=inet_addr&#40;&#34;1.2.3.4&#34;&#41;}, 16&#41; = 0
select&#40;8, [3], NULL, NULL, {30, 0}&#41;     = 1 &#40;in [3], left {29, 992000}&#41;
read&#40;3, &#34;* OK IMAP4 server &#40;InterMail vM.&#34;..., 4096&#41; = 111
select&#40;8, [3], NULL, NULL, {30, 0}&#41;     = 0 &#40;Timeout&#41;

This is more FWIW than anything; I&#39;m going to stick to the older versions of
Mail-IMAPClient &#40;plus the artificial-delay kludge I mentioned earlier&#41; and
imapsync, since I just don&#39;t have the time to plumb this rabbit hole right
now.

john
-- 
John Morrissey          _o            /\         ----  __o
jwm@horde.net        _-&lt; \_          /  \       ----  &lt;  \,
www.horde.net/    __&#40;_&#41;/_&#40;_&#41;________/    \_______&#40;_&#41; /_&#40;_&#41;__
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-388849" href="/Public/Bug/Display.html?id=5962#txn-388849">#</a>      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;30&nbsp;04:11:12&nbsp;2007</span>
    <span class="description">MARKOV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/388849/178642/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/178642">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 68b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">When the users do not care, who am I to invest my sparse time in it?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-388852" href="/Public/Bug/Display.html?id=5962#txn-388852">#</a>      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;30&nbsp;04:11:20&nbsp;2007</span>
    <span class="description">MARKOV [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.647737</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
