<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #105604 for Perl-Dist-Strawberry: Calls to an object&#39;s method within a child thread hang</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #105604 for Perl-Dist-Strawberry: Calls to an object&#39;s method within a child thread hang</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Perl-Dist-Strawberry/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Perl-Dist-Strawberry/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Perl-Dist-Strawberry/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Perl-Dist-Strawberry/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Perl-Dist-Strawberry">Perl-Dist-Strawberry CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">105604</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Perl-Dist-Strawberry/Active/">Perl-Dist-Strawberry</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
rjray [...] blackperl.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-40214-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-40215-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;01&nbsp;18:43:26&nbsp;2015</span>
    <span class="description">rjray [...] blackperl.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Calls to an object&#39;s method within a child thread hang</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">While diagnosing my previous bug &#40;105603&#41;, I found a different problem in Strawberry Perl, one that does not seem to exhibit in ActiveState Perl.

In my test code, I create a server object, then fork and have the server start in the child process. The parent then sends some requests to the server and kills the child when done. The server object is *not* shared between the parent and child; the child should have gotten a copy of the object &#40;as I understand things, at least&#41;.

However, when I made multiple calls to the &#34;url&#34; method of the server object in the parent, I found that my second call would hang indefinitely. If I cached the value of the URL before the fork, and just used that value instead, I had no problems.

In the attached code, look at lines 28-29 and 37-38. Run as-is, the problem will manifest. You will see the results of the HEAD request, and the message &#34;Creating POST request&#34;. But the child/server will never see a second request, and you&#39;ll never see the results of the request printed out by the parent. If you comment-out 29 and 38, then uncomment 28 and 37, the script will run correctly. You will see the results of both the HEAD and POST requests.

I know that fork&#40;&#41; et al are implemented in terms of threads on Windows, but I expected that calling $server-&gt;url in the parent would work consistently even while a child-thread was waiting in an accept-loop. And it is odd that the *first* call to -&gt;url returns fine, it is only the second call that hangs.

This is on 5.20.2. I have not yet tried it on 5.22.0.

Randy
-- 
Randy J. Ray
rjray@blackperl.com
randy.j.ray@gmail.com
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> socket-fail.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/env perl

use strict;
use warnings;

use LWP::UserAgent;
use HTTP::Daemon;
use HTTP::Request;
use HTTP::Response;
use HTTP::Status;

my $server = HTTP::Daemon-&gt;new&#40;
    ReuseAddr =&gt; 1,
    LocalHost =&gt; &#39;localhost&#39;,
    LocalPort =&gt; 9000,
    Listen    =&gt; 5
&#41;;
my $url = $server-&gt;url;

die &#34;Failed to create server object\n&#34; if &#40;! $server&#41;;

my $child = fork;
if &#40;! defined $child&#41; {
    die &#34;fork&#40;&#41; failed: $!\n&#34;;
} elsif &#40;$child&#41; {
    # Parent
    my $UA = LWP::UserAgent-&gt;new;
    #my $req = HTTP::Request-&gt;new&#40;HEAD =&gt; $url&#41;;
    my $req = HTTP::Request-&gt;new&#40;HEAD =&gt; $server-&gt;url&#41;;
    print &#34;&gt;&gt;&gt; Sending HEAD request\n&#34;;
    my $res = $UA-&gt;request&#40;$req&#41;;
    print &#34;&gt;&gt;&gt; Headers from HEAD request:\n\t&#34;;
    printf &#34;%d %s\n\t&#34;, $res-&gt;code, $res-&gt;message;
    print $res-&gt;headers_as_string&#40;&#34;\n\t&#34;&#41;, &#34;\n&#34;;
    sleep 1;
    printf &#34;&gt;&gt;&gt; Creating POST request to %s\n&#34;, $url;
    #$req = HTTP::Request-&gt;new&#40;POST =&gt; $url&#41;;
    $req = HTTP::Request-&gt;new&#40;POST =&gt; $server-&gt;url&#41;;
    print &#34;&gt;&gt;&gt; Sending POST request\n&#34;;
    $res = $UA-&gt;request&#40;$req&#41;;
    print &#34;&gt;&gt;&gt; Full message from POST request:\n\t&#34;;
    print $res-&gt;as_string&#40;&#34;\n\t&#34;&#41;, &#34;\n&#34;;
} else {
    # Child
    $server-&gt;timeout&#40;1&#41;;
    while &#40;1&#41; {
        my $conn = $server-&gt;accept;
        printf &#34;&lt;&lt;&lt; Accept: %s\n&#34;, &#40;$conn || &#39;&#40;none&#41;&#39;&#41;;
        next if &#40;! $conn&#41;;

        my $req;
        while &#40;$conn and $req = $conn-&gt;get_request&#40;&#39;headers only&#39;&#41;&#41; {
            my $res = HTTP::Response-&gt;new;
            $res-&gt;code&#40;RC_OK&#41;;
            $res-&gt;message&#40;&#39;OK&#39;&#41;;
            $res-&gt;header&#40;Accept =&gt; &#39;text/xml&#39;&#41;;
            $res-&gt;content_type&#40;&#39;text/xml&#39;&#41;;

            if &#40;$req-&gt;method eq &#39;HEAD&#39;&#41; {
                print &#34;&lt;&lt;&lt; Sending HEAD response\n&#34;;
                $conn-&gt;send_response&#40;$res&#41;;
            } elsif &#40;$req-&gt;method eq &#39;POST&#39;&#41; {
                print &#34;&lt;&lt;&lt; Sending POST response\n&#34;;
                $res-&gt;content&#40;&#39;Success&#39;&#41;;
                $conn-&gt;send_response&#40;$res&#41;;
            }
        }

        my $eval_return = eval {
            local $SIG{PIPE} = sub { die &#34;&lt;&lt;&lt; server_loop: Caught SIGPIPE\n&#34;; };
            $conn-&gt;close;
            1;
        };
        if &#40;&#40;! $eval_return&#41; &#38;&#38; $@&#41;
        {
            warn &#34;&lt;&lt;&lt; Cannot close connection: $@\n&#34;;
        }

        undef $conn;
    }
}

kill &#39;KILL&#39;, $child;
exit;
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
