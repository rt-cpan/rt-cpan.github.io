<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #101800 for PAR: [PATCH] Reinstate files to inc dir if deleted by external process</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #101800 for PAR: [PATCH] Reinstate files to inc dir if deleted by external process</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=PAR">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=PAR">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=PAR">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=PAR">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/PAR">PAR CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">101800</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=PAR">PAR</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
SLAFFAN [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-24530-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-24531-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




canary.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1457954/775754/canary.patch">
Wed Jan 28 18:23:47 2015 (10.4k) by SLAFFAN [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=101800">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1457954" href="/Public/Bug/Display.html?id=101800#txn-1457954">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;28&nbsp;18:23:47&nbsp;2015</span>
    <span class="description">SLAFFAN [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] Reinstate files to inc dir if deleted by external process</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1457954/775753/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/775753">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 902b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">As discussed on the PAR mailing list &#40; <span class="clickylink"><a target="new" rel="nofollow" href="https://groups.google.com/forum/#!topic/perl.par/_obYvAgHeEc">https://groups.google.com/forum/#!topic/perl.par/_obYvAgHeEc</a></span> &#41;, external processes can sometimes delete the files in the inc folder, but not the entire folder.  Their absence then causes issues in packed scripts.  

The attached patch adds a &#34;canary&#34; file to the inc directory and checks for its existence each time the part executable is called.  If the canary file is missing then the files in the inc directory are re-extracted as needed.

The patch also:
1.  Decreases the verbosity threshold for packing files into inc, as previously they needed double verbosity flags in pp to trigger. 
2.  Adds the files in inc to the manifest.
3.  Corrects some quoting errors in the generated manifest.yml file &#40;although I don&#39;t think that file is used anywhere?&#41;

I can separate the additional points into their own patches if that&#39;s more appropriate.

Regards,
Shawn.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> canary.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1457954/775754/canary.patch">Download canary.patch</a><br />
<span class="downloadcontenttype">text/x-diff 10.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: PAR-Packer/trunk/lib/PAR/Packer.pm
===================================================================
--- PAR-Packer/trunk/lib/PAR/Packer.pm	&#40;revision 1533&#41;
+++ PAR-Packer/trunk/lib/PAR/Packer.pm	&#40;working copy&#41;
@@ -459,6 +459,7 @@
 
     $self-&gt;_add_pack_manifest&#40;&#41;;
     $self-&gt;_add_add_manifest&#40;&#41;;
+    $self-&gt;_add_canary_file&#40;&#41;;
     $self-&gt;_make_manifest&#40;&#41;;
     $self-&gt;_write_zip&#40;&#41;;
 
@@ -521,6 +522,33 @@
     }
 }
 
+#  Allows PAR to detect if an external process has
+#  deleted unlocked files in /inc
+sub _add_canary_file {
+    my &#40;$self&#41; = @_;
+
+    my $opt      = $self-&gt;{options};
+    my $par_file = $self-&gt;{par_file};
+
+    my $canary_file_name = PAR::get_canary_file_name&#40;&#41;;
+    my $canary_dir  = File::Temp::tempdir&#40;TMPDIR =&gt; 1, CLEANUP =&gt; 1&#41;;
+    my $canary_file = File::Spec-&gt;catdir &#40;$canary_dir, $canary_file_name&#41;;
+
+    $self-&gt;_vprint&#40;0, &#34;Writing canary file $canary_file_name to $par_file&#34;&#41;;
+    $self-&gt;{zip} ||= Archive::Zip-&gt;new;
+    my $zip = $self-&gt;{zip};
+    
+    my $canary_existed = -e $canary_file;
+    if &#40;!$canary_existed&#41; {
+        open&#40;my $fh, &#39;&gt;&#39;, $canary_file&#41; or die &#34;Could not open $canary_file&#34;;
+        print {$fh} &#34;This is a file to detect if an external process has incompletely cleared the PAR cache\n&#34;;
+        close $fh;
+    }
+
+    my $value = [&#39;file&#39;, &#34;$canary_file;$canary_file_name&#34;];
+    $self-&gt;_add_file&#40;$zip, $canary_file_name, $value&#41;;
+}
+
 sub _add_add_manifest {
     my &#40;$self&#41; = @_;
 
@@ -528,7 +556,7 @@
     my $add_manifest = $self-&gt;add_manifest_hash&#40;&#41;;
     my $par_file     = $self-&gt;{par_file};
 
-    $self-&gt;_vprint&#40;1, &#34;Writing extra files to $par_file&#34;&#41; if &#40;%$add_manifest&#41;;
+    $self-&gt;_vprint&#40;0, &#34;Writing extra files to $par_file&#34;&#41; if &#40;%$add_manifest&#41;;
     $self-&gt;{zip} ||= Archive::Zip-&gt;new;
     my $zip = $self-&gt;{zip};
 
@@ -543,6 +571,7 @@
     my &#40;$self&#41; = @_;
 
     my $full_manifest = $self-&gt;{full_manifest};
+    my $add_manifest  = $self-&gt;{add_manifest};
 
     my $opt      = $self-&gt;{options};
     my $par_file = $self-&gt;{par_file};
@@ -555,6 +584,8 @@
     my $manifest = join&#40;&#34;\n&#34;,
 &#39;    &lt;!-- accessible as jar:file:///NAME.par!/MANIFEST in compliant browsers --&gt;&#39;,
         &#40;sort keys %$full_manifest&#41;,
+        &#40;sort keys %$add_manifest&#41;,
+        PAR::get_canary_file_name&#40;&#41;,
 q&#40;    # &lt;html&gt;&lt;body onload=&#34;var X=document.body.innerHTML.split&#40;/\n/&#41;;var Y=&#39;&lt;iframe src=&#38;quot;META.yml&#38;quot; style=&#38;quot;float:right;height:40%;width:40%&#38;quot;&gt;&lt;/iframe&gt;&lt;ul&gt;&#39;;for&#40;var x in X&#41;{if&#40;!X[x].match&#40;/^\s*#/&#41;&#38;&#38;X[x].length&#41;Y+=&#39;&lt;li&gt;&lt;a href=&#38;quot;&#39;+X[x]+&#39;&#38;quot;&gt;&#39;+X[x]+&#39;&lt;/a&gt;&#39;}document.body.innerHTML=Y&#34;&gt;&#41;
     &#41;;
 
@@ -565,7 +596,7 @@
 dist_name: $dist_name
 distribution_type: par
 dynamic_config: 0
-generated_by: &#39;$class version $version
+generated_by: &#39;$class version $version&#39;
 license: unknown
 par:
   clean: $clean
Index: PAR-Packer/trunk/t/21-pp_reinstate_cached_files.t
===================================================================
--- PAR-Packer/trunk/t/21-pp_reinstate_cached_files.t	&#40;revision 0&#41;
+++ PAR-Packer/trunk/t/21-pp_reinstate_cached_files.t	&#40;working copy&#41;
@@ -0,0 +1,212 @@
+#!/usr/bin/perl
+
+#  Test that added files &#40;via -a flag&#41; are re-extracted
+#  if deleted by some other process.  
+#  Much of this is a copy of 20-pp.t but seems to be
+#  needed if we retain the sanity checks at the top.  
+
+use strict;
+use warnings;
+use Cwd;
+use Config;
+use FindBin;
+use File::Spec;
+use File::Temp &#40;&#41;;
+use ExtUtils::MakeMaker;
+use File::Path qw /remove_tree/;
+use PAR &#40;&#41;;
+
+use Test::More;
+
+$ENV{PAR_TMPDIR} = File::Temp::tempdir&#40;TMPDIR =&gt; 1, CLEANUP =&gt; 1&#41;;
+
+sub samefiles {
+    my &#40;$f1, $f2&#41; = @_;
+    $f1 eq $f2 and return 1;
+    -e $f1 &#38;&#38; -e $f2 or return 0;
+    -s $f1 == -s $f2 or return 0;
+    local $/ = \65536;
+    open my $fh1, &#39;&lt;&#39;, $f1 or return 0;
+    open my $fh2, &#39;&lt;&#39;, $f2 or return 0;
+    while &#40;1&#41; {
+        my $c1 = &lt;$fh1&gt;;
+        my $c2 = &lt;$fh2&gt;;
+        last if !defined $c1 and !defined $c2;
+        return 0 if !defined $c1 or !defined $c2;
+        return 0 if $c1 ne $c2;
+    }
+    return 1;
+}
+
+chdir File::Spec-&gt;catdir&#40;$FindBin::Bin, File::Spec-&gt;updir&#41;;
+
+my $cwd = getcwd&#40;&#41;;
+#my $test_dir = File::Spec-&gt;catdir&#40;$cwd, &#39;contrib&#39;, &#39;automated_pp_test&#39;&#41;;
+my $test_dir = File::Temp::tempdir&#40;TMPDIR =&gt; 1, CLEANUP =&gt; 1&#41;;
+
+my $parl = File::Spec-&gt;catfile&#40;$cwd, &#39;blib&#39;, &#39;script&#39;, &#34;parl$Config{_exe}&#34;&#41;;
+my $startperl = $Config{startperl};
+$startperl =~ s/^#!//;
+
+my $orig_X = $^X;
+my $orig_startperl = $startperl;
+
+if &#40;!-e $parl&#41; {
+    print &#34;1..0 # Skip &#39;parl&#39; not found\n&#34;;
+    exit;
+}
+elsif &#40;!&#40;$^X = main-&gt;can_run&#40;$^X&#41;&#41;&#41; {
+    print &#34;1..0 # Skip &#39;$orig_X&#39; not found\n&#34;;
+    exit;
+}
+elsif &#40;!&#40;$startperl = main-&gt;can_run&#40;$startperl&#41;&#41;&#41; {
+    print &#34;1..0 # Skip &#39;$orig_startperl&#39; not found\n&#34;;
+    exit;
+}
+
+# NOTE: Win32::GetShortPathName exists on cygwin, too
+if &#40;$^O eq &#39;MSWin32&#39; &#38;&#38; defined &#38;Win32::GetShortPathName&#41; {
+    $^X = lc&#40;Win32::GetShortPathName&#40;$^X&#41;&#41;;
+    $startperl = lc&#40;Win32::GetShortPathName&#40;$startperl&#41;&#41;;
+}
+
+if &#40;!samefiles&#40;$startperl, $^X&#41;&#41; {
+    print &#34;1..0 # Skip &#39;$^X&#39; is not the same as &#39;$startperl&#39;\n&#34;;
+    exit;
+}
+
+#unshift @INC, File::Spec-&gt;catdir&#40;$cwd, &#39;inc&#39;&#41;;
+#unshift @INC, File::Spec-&gt;catdir&#40;$cwd, &#39;blib&#39;, &#39;lib&#39;&#41;;
+#unshift @INC, File::Spec-&gt;catdir&#40;$cwd, &#39;blib&#39;, &#39;script&#39;&#41;;
+
+$ENV{PAR_GLOBAL_CLEAN} = 1;
+
+#$ENV{PATH} = join&#40;
+#    $Config{path_sep},
+#    grep length,
+#        File::Spec-&gt;catdir&#40;$cwd, &#39;blib&#39;, &#39;script&#39;&#41;,
+#        $ENV{PATH},
+#&#41;;
+#$ENV{PERL5LIB} = join&#40;
+#    $Config{path_sep},
+#    grep length,
+#        File::Spec-&gt;catdir&#40;$cwd, &#39;blib&#39;, &#39;lib&#39;&#41;,
+#        $test_dir,
+#        $ENV{PERL5LIB},
+#&#41;;
+
+chdir $test_dir;
+
+$ENV{PAR_TMPDIR} = $test_dir;
+
+my $tmpfile1 = File::Spec-&gt;catfile&#40;$test_dir, &#39;check1.txt&#39;&#41;;
+my $tmpdir1  = File::Spec-&gt;catfile&#40;$test_dir, &#39;checkdir1&#39;&#41;;
+my $tmpfile2 = File::Spec-&gt;catfile&#40;$tmpdir1,  &#39;check2.txt&#39;&#41;;
+
+mkdir $tmpdir1 if !-d $tmpdir1;
+foreach my $file &#40;$tmpfile1, $tmpfile2&#41; {
+    open&#40;my $fh, &#39;&gt;&#39;, $file&#41; or die &#34;Cannot open $file to write to&#34;;
+    print {$fh} &#34;$file\n$file\n&#34;;  #  contents don&#39;t matter for this test
+    close &#40;$fh&#41;;
+}
+
+
+my $script = File::Spec-&gt;catfile&#40;&#39;script.pl&#39;&#41;;
+open&#40;my $fh, &#39;&gt;&#39;, $script&#41; or die &#34;Cannot open $script&#34;;
+print {$fh} &lt;&lt;&#39;END_OF_SCRIPT&#39;
+use File::Spec;
+my $inc = File::Spec-&gt;catdir&#40;$ENV{PAR_TEMP}, &#39;inc&#39;&#41;;
+print &#34;$inc\n&#34;;
+#print join &#39; &#39;, &#39;@INC:&#39;, @INC, &#34;\n&#34;;
+my $fname = File::Spec-&gt;catfile&#40;$inc, &#39;check1.txt&#39;&#41;;
+open my $fh1, &#39;&lt;&#39;, $fname
+  or die &#34;Cannot open $fname&#34;;
+$fname = File::Spec-&gt;catfile&#40;$inc, &#39;checkdir1&#39;, &#39;check2.txt&#39;&#41;;
+open my $fh2, &#39;&lt;&#39;, $fname
+  or die &#34;Cannot open $fname&#34;;
+exit;
+END_OF_SCRIPT
+  ;
+close &#40;$fh&#41;;
+
+my $osname = $^O;
+my $exe_file = &#39;tester&#39; . $Config{_exe};
+
+#  Not using script approach, as pp-&gt;go&#40;&#41; allows for debugger step-through
+#my $pp_script = File::Spec-&gt;catdir&#40;$cwd, &#39;blib&#39;, &#39;script&#39;, &#39;pp&#39;&#41;;
+
+my @cmd = &#40;
+    #$pp_script,
+    &#39;-o&#39; =&gt; $exe_file,
+    &#39;-a&#39; =&gt; &#34;$tmpfile1;check1.txt&#34;,
+    &#39;-a&#39; =&gt; &#34;$tmpdir1;checkdir1&#34;,
+    #&#39;-v&#39;,
+    $script,
+&#41;;
+#print join &#39; &#39;, @cmd, &#34;\n&#34;;
+#system @cmd;
+my $opts = join &#39; &#39;, @cmd;
+$opts =~ s&#39;\\&#39;\\\\&#39;g;  #  CLUNKY, but quotemeta is overzealous and also escapes dashes and spaces
+$ENV{PP_OPTS} = $opts;
+print &#34;\$ENV{PP_OPTS} = $ENV{PP_OPTS}\n&#34;;
+use pp;
+pp-&gt;go&#40;&#41;;
+
+#  now run it
+$ENV{PAR_GLOBAL_CLEAN} = 0;
+print &#34;...First run...\n&#34;;
+my $feedback = `$exe_file`;
+my @feedback = split &#34;\n&#34;, $feedback;
+my $inc_dir  = $feedback[0];
+
+#  Now delete the files we packed into the exe using -a
+#  These are in the par temp inc folder
+print &#34;Deleting inc files\n&#34;;
+my $success;
+my $file1   = File::Spec-&gt;catfile&#40;$inc_dir, &#39;check1.txt&#39;&#41;;
+my $dir1    = File::Spec-&gt;catfile&#40;$inc_dir, &#39;checkdir1&#39;&#41;;
+my $canary1 = File::Spec-&gt;catfile&#40;$inc_dir, PAR::get_canary_file_name&#40;&#41;&#41;;
+
+$success = unlink $file1;
+$success = remove_tree $dir1;
+$success = unlink $canary1;
+#  If the whole inc directory is deleted then it all gets re-extracted
+#  and thus there are no failures to test.
+#$success  = remove_tree $inc_dir;
+
+#  A couple of sanity checks.
+#  If these files are not deleted then subsequent tests will fail,
+#  so this way we get a better indication as to why.
+for my $file &#40;$file1, $dir1, $canary1&#41; {
+    use File::Basename;
+    my $basename = basename&#40;$file&#41;;
+    ok &#40;!-e $file, &#34;inc/$basename was deleted&#34;&#41;;
+}
+
+#  Now run the PAR binary again.  We should get 0 on success.
+print &#34;...Second run...\n&#34;;
+my $error = system $exe_file;
+
+ok &#40;!$error, &#34;Packed script runs after -a packed files deleted from par/inc&#34;&#41;;
+
+#  go back to the start dir so the File::Temp cleanup will work
+chdir $cwd;
+
+done_testing&#40;&#41;;
+
+
+sub can_run {
+    my &#40;$self, $cmd&#41; = @_;
+
+    my $_cmd = $cmd;
+    return $_cmd if &#40;-x $_cmd or $_cmd = MM-&gt;maybe_command&#40;$_cmd&#41;&#41;;
+
+    for my $dir &#40;&#40;split /$Config::Config{path_sep}/, $ENV{PATH}&#41;, &#39;.&#39;&#41; {
+        my $abs = File::Spec-&gt;catfile&#40;$dir, $_[1]&#41;;
+        return $abs if &#40;-x $abs or $abs = MM-&gt;maybe_command&#40;$abs&#41;&#41;;
+    }
+
+    return;
+}
+
+__END__
Index: trunk/lib/PAR.pm
===================================================================
--- trunk/lib/PAR.pm	&#40;revision 1533&#41;
+++ trunk/lib/PAR.pm	&#40;working copy&#41;
@@ -668,6 +668,12 @@
     }
 }
 
+#  canary file name could perhaps use CRC string or similar
+#  to make it more unique
+sub get_canary_file_name {
+    return &#39;_PAR_CANARY.txt&#39;;
+}
+
 # extract the contents of a .par &#40;or .exe&#41; or any
 # Archive::Zip handle to the PAR_TEMP/inc directory.
 # returns that directory.
@@ -674,14 +680,17 @@
 sub _extract_inc {
     my $file_or_azip_handle = shift;
     my $force_extract = shift;
-    my $inc = &#34;$PAR::SetupTemp::PARTemp/inc&#34;;
+    my $inc   = File::Spec-&gt;catdir &#40;$PAR::SetupTemp::PARTemp, &#39;inc&#39;&#41;;
     my $dlext = defined&#40;$Config{dlext}&#41; ? $Config::Config{dlext} : &#39;&#39;;
     my $inc_exists = -d $inc;
-    my $is_handle = ref&#40;$file_or_azip_handle&#41; &#38;&#38; $file_or_azip_handle-&gt;isa&#40;&#39;Archive::Zip::Archive&#39;&#41;;
+    my $is_handle  = ref&#40;$file_or_azip_handle&#41; &#38;&#38; $file_or_azip_handle-&gt;isa&#40;&#39;Archive::Zip::Archive&#39;&#41;;
 
+    my $inc_canary = File::Spec-&gt;catdir&#40;$inc, get_canary_file_name&#40;&#41;&#41;;
+    my $inc_canary_exists = -e $inc_canary;
+
     require File::Spec;
 
-    if &#40;!$inc_exists or $force_extract&#41; {
+    if &#40;!$inc_exists or $force_extract or !$inc_canary_exists&#41; {
         for &#40;1 .. 10&#41; { mkdir&#40;&#34;$inc.lock&#34;, 0755&#41; and last; sleep 1 }
         
         undef $@;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1518305" href="/Public/Bug/Display.html?id=101800#txn-1518305">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;19&nbsp;09:08:40&nbsp;2015</span>
    <span class="description">RSCHUPP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1518305/809700/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/809700">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 78b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed in PAR::Packer 1.026 &#40;the actual fix is in PAR 1.010&#41;.

Cheers, Roderich
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1518306" href="/Public/Bug/Display.html?id=101800#txn-1518306">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;19&nbsp;09:08:41&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1518310" href="/Public/Bug/Display.html?id=101800#txn-1518310">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;19&nbsp;09:08:43&nbsp;2015</span>
    <span class="description">RSCHUPP [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.358989</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
