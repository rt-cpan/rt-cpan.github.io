<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #86649 for SOAP-Lite: UTF-8 not handled properly</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #86649 for SOAP-Lite: UTF-8 not handled properly</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=SOAP-Lite">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=SOAP-Lite">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=SOAP-Lite">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=SOAP-Lite">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/SOAP-Lite">SOAP-Lite CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">86649</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=SOAP-Lite">SOAP-Lite</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
brianjamespugh [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-29122-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.715</li>
<li>
0.716</li>
</ul>
    </td>
  </tr>
  <tr id="CF-29123-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




SOAP-Lite-0.715-utf8_correction.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1231204/650563/SOAP-Lite-0.715-utf8_correction.patch">
Tue Jul 02 14:22:53 2013 (1.7k) by brianjamespugh [...] gmail.com
</a>
</font></li>
</ul>


SOAP-Lite-1.13_RT86649.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1462303/778221/SOAP-Lite-1.13_RT86649.patch">
Tue Feb 10 10:51:59 2015 (1.9k) by F.Dreyer [...] telekom.de
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=86649">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1231204" href="/Public/Bug/Display.html?id=86649#txn-1231204">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;02&nbsp;14:22:53&nbsp;2013</span>
    <span class="description">brianjamespugh [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> UTF-8 not handled properly</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1231204/650562/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/650562">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">When sending a HTTP message that as constructed with UTF-8 characters, the server is sending truncated messages. 

I found this by testing a server with soapUI, the message payload that is a complex XML structure using UTF-8 characters and is stored as a string &#40;with utf8 flag&#41; to be passed to SOAP::Lite for transmission.  The resulting message is truncated by a few bytes.

I traced through the code and found that the content-length header is being calculated properly but the message content is being re-encoded in Latin 1 which is causing the UTF-8 characters to multiply in size, thus causing the client to stop reading prematurely and truncating the message.

The issue is that SOAP::Lite is using the wrong method to retrieve the data from HTTP::Message.  It should be using decoded_content&#40;&#41; instead of just plain content&#40;&#41;.  I created a patch to fix this.  

This patch also impacts a test case:  SOAP/Transport/HTTP/CGI.t
The test payload in this test case uses a UTF-8 string cut and pasted from somewhere, but doesn&#39;t use the &#39;utf8&#39; pragma or uses Enocde::_utf8_on to tell Perl that it is a UTF-8 string or that the test script has a UTF-8 character in its source.  I updated the test to replace the UTF-8 character with the code &#39;\x{DC}&#39; which causes the string to be built properly.  The test server also needed to flag its STDOUT and STDIN as well.

The attached patch is for .715 but has been tested with .716 as well.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> SOAP-Lite-0.715-utf8_correction.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1231204/650563/SOAP-Lite-0.715-utf8_correction.patch">Download SOAP-Lite-0.715-utf8_correction.patch</a><br />
<span class="downloadcontenttype">text/x-diff 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -uNr SOAP-Lite-0.715.orig/lib/SOAP/Transport/HTTP.pm SOAP-Lite-0.715/lib/SOAP/Transport/HTTP.pm
--- SOAP-Lite-0.715.orig/lib/SOAP/Transport/HTTP.pm	2012-07-15 05:18:44.000000000 -0400
+++ SOAP-Lite-0.715/lib/SOAP/Transport/HTTP.pm	2013-07-02 13:07:38.930105900 -0400
@@ -615,7 +615,7 @@
 
     print STDOUT &#34;$status $code &#34;, HTTP::Status::status_message&#40;$code&#41;,
       &#34;\015\012&#34;, $self-&gt;response-&gt;headers_as_string&#40;&#34;\015\012&#34;&#41;, &#34;\015\012&#34;,
-      $self-&gt;response-&gt;content;
+      $self-&gt;response-&gt;decoded_content;
 }
 
 # ======================================================================
diff -uNr SOAP-Lite-0.715.orig/t/SOAP/Transport/HTTP/CGI/test_server.pl SOAP-Lite-0.715/t/SOAP/Transport/HTTP/CGI/test_server.pl
--- SOAP-Lite-0.715.orig/t/SOAP/Transport/HTTP/CGI/test_server.pl	2010-06-03 11:33:24.000000000 -0400
+++ SOAP-Lite-0.715/t/SOAP/Transport/HTTP/CGI/test_server.pl	2013-07-02 13:15:54.915699500 -0400
@@ -7,11 +7,14 @@
     dispatch_to =&gt; &#39;main&#39;
 &#41;;
 
+binmode STDIN, &#34;:utf8&#34;;
+binmode STDOUT, &#34;:utf8&#34;;
+
 $soap-&gt;handle&#40;&#41;;
 
 sub test {
     my &#40;$self, $envelope&#41; = @_;
-    return SOAP::Data-&gt;name&#40;&#39;testResult&#39;&#41;-&gt;value&#40;&#39;Ãberall&#39;&#41;-&gt;type&#40;&#39;string&#39;&#41;;
+    return SOAP::Data-&gt;name&#40;&#39;testResult&#39;&#41;-&gt;value&#40;&#34;\x{dc}berall&#34;&#41;-&gt;type&#40;&#39;string&#39;&#41;;
 
 }
 
diff -uNr SOAP-Lite-0.715.orig/t/SOAP/Transport/HTTP/CGI.t SOAP-Lite-0.715/t/SOAP/Transport/HTTP/CGI.t
--- SOAP-Lite-0.715.orig/t/SOAP/Transport/HTTP/CGI.t	2010-06-03 11:33:24.000000000 -0400
+++ SOAP-Lite-0.715/t/SOAP/Transport/HTTP/CGI.t	2013-07-02 13:15:45.540762100 -0400
@@ -56,7 +56,7 @@
 if &#40;$] &gt;= 5.008&#41; {
     ok utf8::is_utf8&#40;$result&#41;, &#39;return utf8 string&#39;;
     {
-        is $result, &#39;Ãberall&#39;, &#39;utf8 content: &#39; . $result;
+        is $result, &#34;\x{dc}berall&#34;, &#39;utf8 content: &#39; . $result;
     }
 }
 else {
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1437056" href="/Public/Bug/Display.html?id=86649#txn-1437056">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;27&nbsp;13:21:38&nbsp;2014</span>
    <span class="description">ether [...] cpan.org -  Severity Important added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1462303" href="/Public/Bug/Display.html?id=86649#txn-1462303">#</a>      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;10&nbsp;10:51:59&nbsp;2015</span>
    <span class="description">F.Dreyer [...] telekom.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #86649]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 10 Feb 2015 16:51:42 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-SOAP-Lite [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &lt;F.Dreyer [...] telekom.de&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1462303/778220/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/778220">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I also encountered a problem where a message generated by a SOAP CGI server gets truncated.

Since the original report did not provide example code and is reported against a different version of SOAP::Lite &#40;I&#39;m using 1.13&#41;, I can&#39;t tell if this is caused by the exact same bug. But I assume it is since the symptom is the same.


I reproduced the bug with the following code &#40;files saved in latin1 charset - see explanation below&#41;:
server:
--------
#!/usr/bin/perl

use SOAP::Lite;
use SOAP::Transport::HTTP;
use SOAP::Constants;

SOAP::Transport::HTTP::CGI-&gt;dispatch_to&#40;&#39;WebserviceTest&#39;&#41;-&gt;handle&#40;&#41;;

package WebserviceTest;
use Encode qw&#40;decode&#41;;

sub webservice_test {
        die SOAP::Fault-&gt;faultcode&#40;$SOAP::Constants::FAULT_SERVER&#41;-&gt;faultstring&#40;&#39;tüdelü&#39;&#41;;
};
-------


client:
-------
#!/usr/bin/perl

use SOAP::Lite;

my $soap = SOAP::Lite
        -&gt;uri&#40;&#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://just-a-test/WebserviceTest&#39;&#41;">http://just-a-test/WebserviceTest&#39;&#41;</a></span>
        -&gt;proxy&#40;&#39;<span class="clickylink"><a target="new" rel="nofollow" href="https://example.org/soap_rt86649.cgi&#39;&#41;">https://example.org/soap_rt86649.cgi&#39;&#41;</a></span>; #replace with url to server cgi script

$soap-&gt;transport-&gt;add_handler&#40;&#34;request_send&#34;,  sub {
        print STDERR &#34;SOAP Request:\n&#34; . shift-&gt;dump&#40;maxlength=&gt;2000&#41;;
        return;
}&#41;;
$soap-&gt;transport-&gt;add_handler&#40;&#34;response_done&#34;, sub {
        print STDERR &#34;SOAP Response:\n&#34; . shift-&gt;dump&#40;maxlength=&gt;2000&#41;;
        return;
}&#41;;

$soap-&gt;call&#40;&#39;webservice_test&#39;&#41;;
-------


The debug output shows that the reply from the server has Content-Length: 459 and the following content:
-------
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;&lt;soap:Envelope soap:encodingStyle=&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://schemas.xmlsoap.org/soap/encoding/">http://schemas.xmlsoap.org/soap/encoding/</a></span>&#34; xmlns:soap=&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://schemas.xmlsoap.org/soap/envelope/">http://schemas.xmlsoap.org/soap/envelope/</a></span>&#34; xmlns:soapenc=&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://schemas.xmlsoap.org/soap/encoding/">http://schemas.xmlsoap.org/soap/encoding/</a></span>&#34; xmlns:xsd=&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/2001/XMLSchema">http://www.w3.org/2001/XMLSchema</a></span>&#34; xmlns:xsi=&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/2001/XMLSchema-instance">http://www.w3.org/2001/XMLSchema-instance</a></span>&#34;&gt;&lt;soap:Body&gt;&lt;soap:Fault&gt;&lt;faultcode&gt;soap:Server&lt;/faultcode&gt;&lt;faultstring&gt;t\xC3\xBCdel\xC3\xBC&lt;/faultstring&gt;&lt;/soap:Fault&gt;&lt;/soap:Body&gt;&lt;/soap:Envelop
-------

As you can see, the latin1 scalar was automatically upgrade to a perl unicode string which was then correctly converted to utf-8 byte output &#40;\xC3\xBC&#41;. The total length of the correct output is 461 byte, but only 459 bytes are transmitted so the &#34;e&gt;&#34; at the end is truncated.

I looked through the code and found the cause of the bug in SOAP::Transport::HTTP::Server-&gt;make_response, beginning at line 491. Now the first thing that is wrong here &#40;although this has no impact on my testcase because it doesn&#39;t use compression&#41; is that the Compress::Zlib::compress call is done while $response still contains a unicode string.

Next, the value of the Content-Length header is calculated using SOAP::Utils::bytelength. This function is inherently broken because it just calculates the byte length of the internal data structure that represents the unicode string. The CPAN documentation of the &#39;bytes&#39; pragma even mentions that you should never use it except for debugging: &#34;[...] use of this module for anything other than debugging purposes is strongly discouraged. If you feel that the functions here within might be useful for your application, this possibly indicates a mismatch between your mental model of Perl Unicode and the current reality. In that case, you may wish to read some of the perl Unicode documentation: perluniintro, perlunitut, perlunifaq and perlunicode&#34;. Now because in my testcase the input is a latin1 string which has not been implicitly upgraded to unicode yet at this point, SOAP::Utils::bytelength actually returns the same value as the character length which is 459 for the entire response.

Finally, the call to Encode::encode does the actual encoding from unicode string &#40;implicitly upgraded from the latin1 string $response&#41; to utf-8 byte output. The size of this byte output is 461 bytes &#40;two ü chars encoded as \xC3\xBC in utf-8&#41;.


The attached patch fixes the bug by rearranging the code so that
1&#41; the value of the Content-Length Header is calculated by first calling Encode::encode to convert $response to utf-8 bytes and then calling length&#40;&#41; on the actual byte data that is passed to HTTP::Response-&gt;new.
2&#41; the call to Compress::Zlib::compress is done after Encode::encode so that it compresses the utf-8bytes &#40;instead of converting the binary zlib compressed data to utf-8&#41;



PS1: the change to HTTP.pm suggested in the attached patchfile of the original report &#40;replace response-&gt;content with response-&gt;decoded_content&#41; is definitely wrong, because just above that print statement is a binmode&#40;STDOUT&#41;; call which means the output is expected to be binary &#40;bytes&#41;. The documentation of HTTP::Message says that content contains the raw binary data while decoded_content converts that data to perl unicode strings.



PS2: I can only reproduce this bug with the &#34;die SOAP::Fault&#34; statement inside the webservice_test function. If I instead return a SOAP::Data object of type string &#40;with latin1 or unicode value&#41;, for some reason this works without truncating the message. I assume that in this case the latin1 string is already upgraded to a unicode string at an earlier point so that SOAP::Utils::bytelength happens to return the correct length. But note that this only &#34;accidentally&#34; works - if you for example change that charset on the server side to utf-16:
-------
my $soap_transport = SOAP::Transport::HTTP::CGI-&gt;dispatch_to&#40;&#39;WebserviceTest&#39;&#41;;
$soap_transport-&gt;serializer-&gt;encoding&#40;&#39;UTF-16&#39;&#41;;
$soap_transport-&gt;handle&#40;&#41;;
-------
then the current code _always_ breaks and truncates the second half of the message but with my patch it always works correctly.



PS3: Both with and without my patch, compression didn&#39;t even work if I add a compress_threshold=&gt;50 to my above testcase. First, it currently cannot even theoretically work because SOAP::Transport::HTTP::Client sends $COMPRESS = &#39;gzip&#39; &#40;HTTP.pm line 147&#41; as Content-Encoding header, but SOAP::Transport::HTTP::Server rejects the request with HTTP 415 Unsupported Media Type if the header isn&#39;t $COMPRESS = &#39;deflate&#39; &#40;HTTP.pm line 342&#41;. But even if I set both variables to the same value, the debug output shows that the compression doesn&#39;t work and there are perl warnings on both client and server side. So it seems getting compression to work is an even more complex issue and requires further investigation which would be beyond the scope of this ticket.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1462303/778221/SOAP-Lite-1.13_RT86649.patch">Download SOAP-Lite-1.13_RT86649.patch</a><br />
<span class="downloadcontenttype">text/x-diff 1.9k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1462304" href="/Public/Bug/Display.html?id=86649#txn-1462304">#</a>      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;10&nbsp;10:52:00&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.374803</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
