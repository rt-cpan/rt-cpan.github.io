<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #34286 for DBIx-Profile: Enhancements: select* methods, capture parameters, query filter [patch]</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #34286 for DBIx-Profile: Enhancements: select* methods, capture parameters, query filter [patch]</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBIx-Profile/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBIx-Profile/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBIx-Profile/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBIx-Profile/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBIx-Profile">DBIx-Profile CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">34286</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBIx-Profile/Active/">DBIx-Profile</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jasonporritt [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-10650-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10651-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;20&nbsp;13:02:03&nbsp;2008</span>
    <span class="description">jasonporritt [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Enhancements: select* methods, capture parameters, query filter
 [patch]</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve put together a few changes to DBIx::Profile that have been useful to me recently and 
thought I&#39;d share them.

1. Capture statistics for the high-level $dbh-&gt;select* methods.
2. Capture the parameters used for each execution of a query.  This is important information if 
you want to run the *exact* same query again.
3. Allow a filter to be placed on what results are printed.  Useful for cutting out clutter from the 
logs when you&#39;re only interested in a small subset of all the queries being run.

Patch file attached.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> DBIx_Profile.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- original/DBIx/Profile.pm	2000-08-29 17:41:21.000000000 -0400
+++ jason/DBIx/Profile.pm	2008-03-20 09:41:18.000000000 -0400
@@ -103,6 +103,24 @@
 
      Will save all output to the file.
 
+  setFilter
+     $dbh-&gt;setFilter&#40;&#39;interesting_table&#39;&#41;;
+     $dbh-&gt;setFilter&#40;sub {
+         my $query = shift;
+         my $info = shift;
+         $info-&gt;{&#39;execute&#39;}-&gt;{&#39;normal&#39;}-&gt;{&#39;count&#39;} &gt; 100;
+     }&#41;;
+
+     Will make printProfile print out information only for queries where
+     this filter is true.  May be a string to match against &#40;regex syntax
+     is allowed&#41; or a code reference.
+
+     For the code reference, the first parameter will be the query text and
+     the second will be the hashref with all the stored information.
+
+     Alternatively, you may also specify text to match in an environment 
+     variable named DBIXPROFILEFILTER.
+
 =head1 AUTHORS
 
   Jeff Lathan, lathan@pobox.com
@@ -146,11 +164,16 @@ __PACKAGE__-&gt;init_rootclass;
 $DBIx::Profile::DBIXFILE = &#34;&#34;;
 $DBIx::Profile::DBIXFILEHANDLE = &#34;&#34;;
 $DBIx::Profile::DBIXTRACE = 0;
+$DBIx::Profile::DBIXFILTERSUB = undef;
 
 if &#40;$ENV{DBIXPROFILETRACE}&#41; {
     $DBIx::Profile::DBIXTRACE = 1;
 }
 
+if &#40;$ENV{DBIXPROFILEFILTER}&#41; {
+    $DBIx::Profile::DBIXFILTERSUB = sub { $_[0] =~ /$ENV{DBIXPROFILEFILTER}/ };
+}
+
 sub connect {
     my $self = shift;
     my $result = __PACKAGE__-&gt;_DBI_connect&#40;@_&#41;;
@@ -169,9 +192,72 @@ sub connect {
 package DBIx::Profile::db;
 use strict;
 use vars qw&#40;@ISA &#41;;
+use Time::HiRes qw &#40; gettimeofday tv_interval&#41;;
+use Data::Dumper;
 
 @ISA = qw&#40; DBI::db &#41;;
 
+BEGIN {
+
+    # Basic idea for each timing function:
+    # Grab timing info
+    # Call real DBI call
+    # Grab timing info
+    # Calculate time diff
+    # 
+    # Just add more functions in @func_list
+
+    my @func_list = qw&#40;selectrow_array selectrow_arrayref selectall_array selectall_arrayref&#41;;
+    
+    my $func;
+
+    foreach $func &#40;@func_list&#41;{
+	
+	# define subroutine code, incl dynamic name and SUPER:: call 
+	my $sub_code = 
+	    &#34;sub $func {&#34; . &#39;
+            my $self = shift;
+            my &#40;$query, $blah, @args&#41; = @_;
+            my @result; 
+            my $result;
+            my &#40;$time, $ctime, $x, $y, $z&#41;;
+            if &#40;wantarray&#41; {
+                $time = [gettimeofday];
+                &#40;$ctime, $x &#41; = times&#40;&#41;;
+                @result =  $self-&gt;SUPER::&#39; . &#34;$func&#34; . &#39;&#40;@_&#41;; 
+                &#40;$y, $z &#41; = times&#40;&#41;;
+                $time = tv_interval&#40;$time, [gettimeofday]&#41;;
+            }
+            else {
+                $time = [gettimeofday];
+                &#40;$ctime, $x&#41; = times&#40;&#41;;
+                $result =  $self-&gt;SUPER::&#39; . &#34;$func&#34; . &#39;&#40;@_&#41;; 
+                &#40;$y, $z&#41; = times&#40;&#41;;
+                $time = tv_interval&#40;$time, [gettimeofday]&#41;;
+            }
+
+            my $private_profile = {};
+            $private_profile-&gt;{&#34;Total&#34;}-&gt;{&#34;count&#34;}++;
+            $private_profile-&gt;{&#34;Total&#34;}-&gt;{&#34;realtime&#34;} += $time;
+            $private_profile-&gt;{&#34;Total&#34;}-&gt;{&#34;cputime&#34;} += &#40;&#40;$y + $z&#41; - &#40;$x + $ctime&#41;&#41;;
+            push @{$private_profile-&gt;{&#34;params&#34;}}, \@args if @args;
+
+            $self-&gt;{&#34;private_profile&#34;}-&gt;{$query}-&gt;{$func} = $private_profile;
+
+            return @result if wantarray;
+            return $result;
+
+	    } # end of function definition
+    &#39;;
+	
+	# define $func in current package
+	eval $sub_code;
+        warn $@ if $@;
+    }
+}
+
+
+
 # 
 # insert our &#34;hooks&#34; to grab subsequent calls
 #
@@ -214,6 +300,18 @@ sub setLogFile { 
     return 1;
 }
 
+sub setFilter {
+    my $self = shift;
+    my $toMatch = shift;
+
+    if &#40;ref&#40;$toMatch eq &#39;CODE&#39;&#41;&#41; {
+        $DBIx::Profile::DBIXFILTERSUB = $toMatch;
+    }
+    elsif &#40;ref&#40;$toMatch eq &#39;SCALAR&#39;&#41;&#41; {
+        $DBIx::Profile::DBIXFILTERSUB = sub { $_[0] =~ /$toMatch/ };
+    }
+}
+
 sub DESTROY {
     my $self = shift;
     $self-&gt;disconnect&#40;@_&#41;;
@@ -244,6 +342,11 @@ sub printProfile {
 	    next;
 	}
 
+        # If we&#39;ve defined a filter, skip everything else
+        if &#40;$DBIx::Profile::DBIXFILTERSUB &#38;&#38; ref&#40;$DBIx::Profile::DBIXFILTERSUB&#41; eq &#39;CODE&#39;&#41; {
+            next unless $DBIx::Profile::DBIXFILTERSUB-&gt;&#40;$qry, $self-&gt;{&#39;private_profile&#39;}-&gt;{$qry}&#41;;
+        }
+
 	$total = 0;
 
 	# Now loop through the actions &#40;execute, fetchrow, etc&#41;
@@ -256,8 +359,16 @@ sub printProfile {
 	    }
 
 	    $text .= &#34;   $name ---------------------------------------\n&#34;;
+            my $params = $self-&gt;{&#39;private_profile&#39;}-&gt;{$qry}-&gt;{$name}-&gt;{&#39;params&#39;};
+            if &#40;$params and ref $params eq &#39;ARRAY&#39;&#41; {
+                for my $inst_params &#40;@$params&#41; {
+                    next unless $inst_params and ref $inst_params eq &#39;ARRAY&#39; and @$inst_params &gt; 0;
+                    $text .=  &#39;      Parameters: &#39; . join&#40;&#39;, &#39;, @$inst_params&#41; . &#34;\n&#34;;
+                }
+            }
 
 	    foreach my $type &#40;sort keys %{$self-&gt;{&#39;private_profile&#39;}-&gt;{$qry}-&gt;{$name}}&#41; {
+                next if $type eq &#39;params&#39;;
 		$text .= &#34;      $type\n&#34;;
 		
 		my &#40;$count, $time, $ctime&#41;;
@@ -265,6 +376,8 @@ sub printProfile {
 		$time = $self-&gt;{&#39;private_profile&#39;}-&gt;{$qry}-&gt;{$name}-&gt;{$type}-&gt;{&#39;realtime&#39;};
 		$ctime = $self-&gt;{&#39;private_profile&#39;}-&gt;{$qry}-&gt;{$name}-&gt;{$type}-&gt;{&#39;cputime&#39;};
 		
+
+                
 		$text .= sprintf &#34;         Count        : %10d\n&#34;,$count;
 		$text .= sprintf &#34;         Wall Clock   : %10.7f s   %10.7f s\n&#34;,$time,$time/$count;
 		$text .= sprintf &#34;         Cpu Time     : %10.7f s   %10.7f s\n&#34;,$ctime,$ctime/$count;
@@ -384,7 +497,7 @@ BEGIN {
                    }
 
 		   $ctime = &#40;$y + $z&#41; - &#40;$x + $ctime&#41;;
-                   $self-&gt;increment&#40;$func,$type,$time, $ctime&#41;;
+                   $self-&gt;increment&#40;$func,$type,$time, $ctime,\@_&#41;;
                    return @result;
 
                 } else {
@@ -413,7 +526,7 @@ BEGIN {
                    }
 
 		   $ctime = &#40;$y + $z&#41; - &#40;$x + $ctime&#41;;
-                   $self-&gt;increment&#40;$func,$type,$time, $ctime&#41;;
+                   $self-&gt;increment&#40;$func,$type,$time, $ctime,\@_&#41;;
                    return $result;
 
                 } # end of if &#40;wantarray&#41;;
@@ -423,6 +536,7 @@ BEGIN {
 	
 	# define $func in current package
 	eval $sub_code;
+    warn $@ if $@;
     }
 }
 
@@ -439,23 +553,27 @@ sub fetchrow {
 }
 
 sub increment {
-    my &#40;$self, $name, $type, $time, $ctime&#41; = @_;
+    my &#40;$self, $name, $type, $time, $ctime, $params&#41; = @_;
 
-    my $ref;
     my $qry = $self-&gt;{&#39;Statement&#39;};
-    $ref = $self-&gt;{&#39;private_profile&#39;};
+    my $ref = $self-&gt;{&#39;private_profile&#39;};
 
     # text matching?!?  *sigh* - JEFF
-    if &#40; $name =~ /^execute/ &#41; {
+    if &#40; $name =~ /^execute/ || $name=~ /^select/ &#41; {
 	$ref-&gt;{&#34;first&#34;} = 1;
+        push @{$ref-&gt;{$name}-&gt;{&#39;params&#39;}}, $params if $params;
+
 	if &#40; $DBIx::Profile::DBIXTRACE &#41; {
 	    my &#40;$sec, $min, $hour, $mday, $mon&#41;;
 	    &#40;$sec, $min, $hour, $mday, $mon&#41; = localtime&#40;time&#41;;
 	    my $text = sprintf&#40;&#34;%d-%2d %2d:%2d:%2d&#34;, $mon, $mday,$hour,$min,$sec&#41;;
+
+            my $to_print = &#34;$$ $text $name SQL: $qry\n&#34;;
+            $to_print .= &#39;Parameters: &#39;. join&#40;&#39;, &#39;, @$params&#41; if ref $params eq &#39;ARRAY&#39;;
 	    if &#40;$DBIx::Profile::DBIXFILE eq &#34;&#34; &#41; {
-		warn &#34;$$ text $name SQL: $qry\n&#34;;
+                warn $to_print;
 	    } else {
-		print $DBIx::Profile::DBIXFILEHANDLE &#34;$$ $text $name SQL: $qry\n&#34;;
+                print $DBIx::Profile::DBIXFILEHANDLE $to_print;
 	    }
 	}
     }
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
