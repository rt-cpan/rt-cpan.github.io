<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #125658 for Business-OnlinePayment-PayflowPro: Missing Fields</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #125658 for Business-OnlinePayment-PayflowPro: Missing Fields</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Business-OnlinePayment-PayflowPro/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Business-OnlinePayment-PayflowPro/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Business-OnlinePayment-PayflowPro/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Business-OnlinePayment-PayflowPro/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Business-OnlinePayment-PayflowPro">Business-OnlinePayment-PayflowPro CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">125658</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Business-OnlinePayment-PayflowPro/Active/">Business-OnlinePayment-PayflowPro</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
PHILLUP [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Unimportant    </td>
  </tr>
  <tr id="CF-4690-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-4691-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;22&nbsp;17:56:18&nbsp;2018</span>
    <span class="description">PHILLUP [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Missing Fields</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">There are many fields that may be required that are not accounted for during the call to _revmap_fields.

For example, see the &#39;Processors Requiring Additional Transaction Parameters&#39; section at <span class="clickylink"><a target="new" rel="nofollow" href="https://developer.paypal.com/docs/classic/payflow/integration-guide/">https://developer.paypal.com/docs/classic/payflow/integration-guide/</a></span>

Closer to heart, I am trying to implement multiple currency support which requires adding the CURRENCY field to the api request. &#40;I also used ECHODATA to get feedback on paypal&#39;s interpretation of the submitted data&#41;

Please consider the following patch which should allow for a flexible mapping depending on the processor&#39;s requirements.

Thanks,

--Phillip
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/lib/Business/OnlinePayment/PayflowPro.pm b/lib/Business/OnlinePayment/PayflowPro.pm
index d95affc..5b25163 100644
--- a/lib/Business/OnlinePayment/PayflowPro.pm
+++ b/lib/Business/OnlinePayment/PayflowPro.pm
@@ -155,7 +155,12 @@ sub expdate_mmyy {
 }
 
 sub submit {
-    my &#40;$self&#41; = @_;
+    my &#40;$self, $extra_fields&#41; = @_;
+
+    $extra_fields ||= {};
+    if &#40;ref $extra_fields ne &#39;HASH&#39;&#41; {
+        croak&#40;&#34;extra_fields must be a hash reference&#34;&#41;;
+    }
 
     $self-&gt;_map_fields&#40;&#41;;
 
@@ -216,6 +221,7 @@ sub submit {
         SHIPTOSTATE     =&gt; &#39;ship_state&#39;,
         SHIPTOZIP       =&gt; &#39;ship_zip&#39;,
         SHIPTOCOUNTRY   =&gt; &#39;ship_country&#39;,
+        %$extra_fields,
     &#41;;
 
     # Reload %content as _revmap_fields makes our copy old/invalid!
@@ -244,7 +250,8 @@ sub submit {
           SHIPTOFIRSTNAME SHIPTOLASTNAME
           SHIPTOSTREET SHIPTOCITY SHIPTOSTATE SHIPTOZIP SHIPTOCOUNTRY
           CUSTCODE
-          &#41;
+          &#41;,
+        keys %$extra_fields
     &#41;;
 
     # get header data
@@ -280,7 +287,7 @@ sub submit {
     # - Enclose the PARMLIST in quotation marks &#40;&#34;&#34;&#41;
     # - Do not place quotation marks &#40;&#34;&#34;&#41; within the body of the PARMLIST
     # - Separate all PARMLIST name-value pairs using an ampersand &#40;&#38;&#41;
-    # 
+    #
     # Because &#39;&#38;&#39; and &#39;=&#39; have special meanings/uses values containing
     # these special characters must be encoded using a special &#34;length
     # tag&#34;.  The &#34;length tag&#34; is simply the length of the &#34;value&#34;
@@ -394,14 +401,14 @@ Business::OnlinePayment::PayflowPro - Payflow Pro backend for Business::OnlinePa
 =head1 SYNOPSIS
 
   use Business::OnlinePayment;
-  
+
   my $tx = new Business::OnlinePayment&#40;
       &#39;PayflowPro&#39;,
       &#39;vendor&#39;  =&gt; &#39;your_vendor&#39;,
       &#39;partner&#39; =&gt; &#39;your_partner&#39;,
       &#39;client_certification_id&#39; =&gt; &#39;GuidUpTo32Chars&#39;,
   &#41;;
-  
+
   # See the module documentation for details of content&#40;&#41;
   $tx-&gt;content&#40;
       type           =&gt; &#39;VISA&#39;,
@@ -422,9 +429,9 @@ Business::OnlinePayment::PayflowPro - Payflow Pro backend for Business::OnlinePa
       order_number   =&gt; &#39;string&#39;,
       request_id     =&gt; &#39;unique_identifier_for_transaction&#39;,
   &#41;;
-  
+
   $tx-&gt;submit&#40;&#41;;
-  
+
   if &#40; $tx-&gt;is_success&#40;&#41; &#41; {
       print&#40;
           &#34;Card processed successfully: &#34;, $tx-&gt;authorization, &#34;\n&#34;,
@@ -436,7 +443,7 @@ Business::OnlinePayment::PayflowPro - Payflow Pro backend for Business::OnlinePa
   else {
       my $info = &#34;&#34;;
       $info = &#34; &#40;CVV2 mismatch&#41;&#34; if &#40; $tx-&gt;result_code == 114 &#41;;
-      
+
       print&#40;
           &#34;Card was rejected: &#34;, $tx-&gt;error_message, $info, &#34;\n&#34;,
           &#34;order number: &#34;,      $tx-&gt;order_number,         &#34;\n&#34;,
@@ -651,6 +658,39 @@ The required Payflow Pro parameters for credit card transactions are:
 
   TRXTYPE TENDER PARTNER VENDOR USER PWD ORIGID
 
+=head1 Extra Fields
+
+You can pass extra fields to the &#39;submit&#39; method using a hash ref in the same format as the mappings in the previous section.
+
+These extra fields will be mapped to the request using the same rules as the default mapping above.
+
+For example, to add the currency to the request:
+
+  $tx-&gt;content&#40;
+    type           =&gt; &#39;VISA&#39;,
+    action         =&gt; &#39;Normal Authorization&#39;,
+    description    =&gt; &#39;Business::OnlinePayment::PayflowPro test&#39;,
+    amount         =&gt; &#39;49.95&#39;,
+    invoice_number =&gt; &#39;100100&#39;,
+    customer_id    =&gt; &#39;jsk&#39;,
+    name           =&gt; &#39;Jason Kohles&#39;,
+    address        =&gt; &#39;123 Anystreet&#39;,
+    city           =&gt; &#39;Anywhere&#39;,
+    state          =&gt; &#39;GA&#39;,
+    zip            =&gt; &#39;30004&#39;,
+    email          =&gt; &#39;ivan-payflowpro@420.am&#39;,
+    card_number    =&gt; &#39;4111111111111111&#39;,
+    expiration     =&gt; &#39;12/09&#39;,
+    cvv2           =&gt; &#39;123&#39;,
+    order_number   =&gt; &#39;string&#39;,
+    request_id     =&gt; &#39;unique_identifier_for_transaction&#39;,
+    event_currency =&gt; &#39;CAD&#39;,
+  &#41;;
+
+  $tx-&gt;submit&#40;{CURRENCY =&gt; event_currency}&#41;;
+
+This maps the &#39;event_currency&#39; field value from the content to the &#39;CURRENCY&#39; field during the api request.
+
 =head1 Mapping Payflow Pro transaction responses to object methods
 
 The following methods provides access to the transaction response data
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;22&nbsp;18:29:48&nbsp;2018</span>
    <span class="description">ivan-pause [...] 420.am -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jun 22 17:56:18 2018, PHILLUP wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; There are many fields that may be required that are not accounted for
&gt; during the call to _revmap_fields.
&gt; 
&gt; For example, see the &#39;Processors Requiring Additional Transaction
&gt; Parameters&#39; section at
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://developer.paypal.com/docs/classic/payflow/integration-guide/">https://developer.paypal.com/docs/classic/payflow/integration-guide/</a></span>
&gt; 
&gt; Closer to heart, I am trying to implement multiple currency support
&gt; which requires adding the CURRENCY field to the api request. &#40;I also
&gt; used ECHODATA to get feedback on paypal&#39;s interpretation of the
&gt; submitted data&#41;
&gt; 
&gt; Please consider the following patch which should allow for a flexible
&gt; mapping depending on the processor&#39;s requirements.
</div>
Sorry, no.  This would be a reasonable &#34;future proofing&#34; patch if we were Business::PayflowPro, just implementing an interface to Payflow Pro, but that is not the case.  This is a Business::OnlinePayment module.  The point is to  provide a common interface to different processors without requiring code changes per processor.

So: If you want to support new fields like currency, they should be mapped from the B:OP standard fields, or defined and added to the B:OP docs/specification if necessary.  There&#39;s already a B:OP currency field.

If there are &#34;additional transaction parameters&#34; required that are atypical and beyond that required for other gateways then we should define and add additional introspection information, in the same way as CC_void_requires_card and ECHECK_void_requires_account are set for some processors and indicate the additional parameters necessary for those kinds of transactions.

&#40;Check out the B:OP documentation, specifically the B:OP manpage and notes_for_module_writers_v3&#41;

Thanks a bunch for your efforts and hope to see a refactored patch taking the above into consideration!

Ivan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;22&nbsp;18:29:49&nbsp;2018</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;25&nbsp;13:17:02&nbsp;2018</span>
    <span class="description">PHILLUP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jun 22 18:29:48 2018, IVAN wrote:

Thanks for the feedback, it all makes perfect sense... except:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So: If you want to support new fields like currency, they should be
&gt; mapped from the B:OP standard fields, or defined and added to the B:OP
&gt; docs/specification if necessary.  There&#39;s already a B:OP currency
&gt; field.
</div>
I see where these fields are mentioned in the POD, but can not see where they
are actually defined in the code. So, I am not quite sure how to go about doing
the mapping there.

Also, I can not get the payflow module to send currency as a value even tho
it is described in the base class. 

And, looking at the code for the payflow modue does not provide any hint where
the optional fields in the description of the base module would be included in the 
request sent to paypal. &#40;I am using the debug option to see what is sent&#41;

Any help here would be greatly appreciated.

Thanks,

--Phillip
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;25&nbsp;14:54:16&nbsp;2018</span>
    <span class="description">ivan-pause [...] 420.am -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jun 25 13:17:02 2018, PHILLUP wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Jun 22 18:29:48 2018, IVAN wrote:
&gt; 
&gt; Thanks for the feedback, it all makes perfect sense... except:
&gt; 
<div class="message-stanza open">&gt; &gt; So: If you want to support new fields like currency, they should be
&gt; &gt; mapped from the B:OP standard fields, or defined and added to the
&gt; &gt; B:OP
&gt; &gt; docs/specification if necessary.  There&#39;s already a B:OP currency
&gt; &gt; field.
</div>&gt; 
&gt; I see where these fields are mentioned in the POD, but can not see
&gt; where they
&gt; are actually defined in the code. So, I am not quite sure how to go
&gt; about doing
&gt; the mapping there.
&gt;
&gt; Also, I can not get the payflow module to send currency as a value
&gt; even tho
&gt;  it is described in the base class.
&gt; 
&gt; And, looking at the code for the payflow modue does not provide any
&gt; hint where
&gt;  the optional fields in the description of the base module would be
&gt; included in the
&gt; request sent to paypal. &#40;I am using the debug option to see what is
&gt; sent&#41;
&gt; 
&gt; Any help here would be greatly appreciated.
</div>
I haven&#39;t looked at the code for this module in a decade and have no idea how to help you with these questions.  Sorry.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
