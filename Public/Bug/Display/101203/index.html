<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #101203 for Web-Machine: allowed_methods is called twice per request, forcing method to be idempotent</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #101203 for Web-Machine: allowed_methods is called twice per request, forcing method to be idempotent</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Web-Machine/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Web-Machine/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Web-Machine/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Web-Machine/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/houseabsolute/webmachine-perl/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Web-Machine">Web-Machine CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">101203</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Web-Machine/Active/">Web-Machine</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
SMITHFARM [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-244174-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-244175-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;30&nbsp;05:17:21&nbsp;2014</span>
    <span class="description">SMITHFARM [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Please call allowed_methods method only once</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">In Web::Machine::FSM::States there is this code:

    $STATE_DESC{&#39;b10&#39;} = &#39;method_allowed&#39;;
    sub b10 {
        my &#40;$resource, $request, $response&#41; = @_;
        my $method = $request-&gt;method;
        return \&#38;b9 if grep { $method eq $_ } @{ $resource-&gt;allowed_methods };
        $response-&gt;header&#40;&#39;Allow&#39; =&gt; join &#34;, &#34; =&gt; @{ $resource-&gt;allowed_methods } &#41;;
        return \405;
    }

which has the effect of calling my &#39;allowed_methods&#39; method twice, which is confusing at best and at worst might introduce a race condition &#40;?&#41;. Please consider calling it only once by doing something like this:

    $STATE_DESC{&#39;b10&#39;} = &#39;method_allowed&#39;;
    sub b10 {
        my &#40;$resource, $request, $response&#41; = @_;
        my $method = $request-&gt;method;
        my @allowed_methods = @{ $resource-&gt;allowed_methods };
        return \&#38;b9 if grep { $method eq $_ } @allowed_methods;
        $response-&gt;header&#40;&#39;Allow&#39; =&gt; join &#34;, &#34; =&gt; @allowed_methods &#41;;
        return \405;
    }

Thanks.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;30&nbsp;05:25:50&nbsp;2014</span>
    <span class="description">SMITHFARM [...] cpan.org -  Subject changed from &#39;Please call allowed_methods method only once&#39; to &#39;allowed_methods is called twice per request, forcing method to be re-entrant&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;30&nbsp;05:26:58&nbsp;2014</span>
    <span class="description">SMITHFARM [...] cpan.org -  Subject changed from &#39;allowed_methods is called twice per request, forcing method to be re-entrant&#39; to &#39;allowed_methods is called twice per request, forcing method to be idempotent&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;31&nbsp;01:11:23&nbsp;2014</span>
    <span class="description">tsibley [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #101203] Please call allowed_methods method only once</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 30 Dec 2014 22:11:08 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Web-Machine [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Thomas Sibley &lt;tsibley [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 12/30/2014 02:17 AM, Nathan Cutler via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; which has the effect of calling my &#39;allowed_methods&#39; method twice,
&gt; which is confusing at best and at worst might introduce a race condition
&gt; &#40;?&#41;. Please consider calling it only once by doing something like this:
&gt; 
&gt;     $STATE_DESC{&#39;b10&#39;} = &#39;method_allowed&#39;;
&gt;     sub b10 {
&gt;         my &#40;$resource, $request, $response&#41; = @_;
&gt;         my $method = $request-&gt;method;
&gt;         my @allowed_methods = @{ $resource-&gt;allowed_methods };
&gt;         return \&#38;b9 if grep { $method eq $_ } @allowed_methods;
&gt;         $response-&gt;header&#40;&#39;Allow&#39; =&gt; join &#34;, &#34; =&gt; @allowed_methods &#41;;
&gt;         return \405;
&gt;     }
</div>
This seems reasonable. +1
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;31&nbsp;01:11:23&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;31&nbsp;07:01:19&nbsp;2014</span>
    <span class="description">SMITHFARM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Multiple calls to the same method are the norm, rather than the exception, in Web::Machine::FSM::States, so fixing just this one instance might not be deemed systemic. On the other hand, ensuring that no method gets called more than once might be a lot of work.

To me, the FSM diagram seems to imply that the individual methods should get called only once. And the documentation does not warn me that my overlay implementations of these methods need to be idempotent.

I am willing to hack on Web::Machine::FSM::States and submit a patch for this, if you guys agree it is a good thing to do.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;01&nbsp;05:15:13&nbsp;2015</span>
    <span class="description">stevan.little [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #101203] allowed_methods is called twice per request, forcing method to be idempotent</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 1 Jan 2015 11:15:01 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Web-Machine [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Stevan Little &lt;stevan.little [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Nathan,

You are correct, the docs do not mention that these methods should be
idempotent and this was likely an assumption we inherited from the Erlang
implementation. I think that it should both; be documented &#40;as a suggestion
and not a hard rule, this *is* Perl after all&#41; and we should do our best
&#40;when appropriate&#41; to not incur the second method call &#40;both for
performance reasons and do-not-assume-things-are-idempotent reasons&#41;.

If you are willing to hack on this, that would be great, please submit pull
requests via <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/stevan/webmachine-perl">https://github.com/stevan/webmachine-perl</a></span> and we will be happy
to review and integrate.

- Stevan

On Wed, Dec 31, 2014 at 1:01 PM, Nathan Cutler via RT &lt;
bug-Web-Machine@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Web-Machine
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101203">https://rt.cpan.org/Ticket/Display.html?id=101203</a></span> &gt;
&gt;
&gt; Multiple calls to the same method are the norm, rather than the exception,
&gt; in Web::Machine::FSM::States, so fixing just this one instance might not be
&gt; deemed systemic. On the other hand, ensuring that no method gets called
&gt; more than once might be a lot of work.
&gt;
&gt; To me, the FSM diagram seems to imply that the individual methods should
&gt; get called only once. And the documentation does not warn me that my
&gt; overlay implementations of these methods need to be idempotent.
&gt;
&gt; I am willing to hack on Web::Machine::FSM::States and submit a patch for
&gt; this, if you guys agree it is a good thing to do.
&gt;
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;02&nbsp;03:00:21&nbsp;2015</span>
    <span class="description">SMITHFARM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If you are willing to hack on this, that would be great, please submit
&gt; pull
&gt; requests via <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/stevan/webmachine-perl">https://github.com/stevan/webmachine-perl</a></span> and we will be
&gt; happy
&gt; to review and integrate.
</div>
Thanks, Stevan! The first pull request is ready:

<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/stevan/webmachine-perl/pull/31">https://github.com/stevan/webmachine-perl/pull/31</a></span>

Nathan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;08&nbsp;06:03:44&nbsp;2015</span>
    <span class="description">SMITHFARM [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
