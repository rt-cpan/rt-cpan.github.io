<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #126932 for HTML-WikiConverter: Using $base_uri not working</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #126932 for HTML-WikiConverter: Using $base_uri not working</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/HTML-WikiConverter/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/HTML-WikiConverter/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/HTML-WikiConverter/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/HTML-WikiConverter/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/HTML-WikiConverter">HTML-WikiConverter CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">126932</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/HTML-WikiConverter/Active/">HTML-WikiConverter</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">diberri [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
alan [...] ufies.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-16200-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.68    </td>
  </tr>
  <tr id="CF-16201-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;23&nbsp;18:14:37&nbsp;2018</span>
    <span class="description">alan [...] ufies.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Using $base_uri not working</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I don&#39;t know if this is even maintained anymore, but I&#39;ve been fighting all day with the base_uri attribute not working.  From the docs:

---
URI to use for converting relative URIs to absolute ones. This effectively ensures that the src and href attributes of image and anchor tags, respectively, are absolute before converting the HTML to wiki markup, which is necessary for wiki dialects that handle internal and external links separately. Relative URIs are only converted to absolute ones if the base_uri argument is present. Defaults to undef.
---

As I understand it if you have a link:

&lt;a href=&#34;foo.html&#34;&gt;foo&lt;/a&gt;

and base_uri is set, the output markdown will include to the full URL.  So if base_uri is set to &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://google.com">http://google.com</a></span>&#34; the output markdown would be:

[foo]&#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://google.com/foo.html&#41;">http://google.com/foo.html&#41;</a></span>

If the base_uri isn&#39;t set it would simply return the relative URL

[foo]&#40;foo.html&#41;

This doesn&#39;t seem to work.  I&#39;ve dug through and it looks like the conversion of the HTML is working internally - the HTML is converted from &lt;a href=&#34;foo.html&#34;&gt;foo&lt;/a&gt; to &lt;a href=&#34;http://google.com/foo.html&#34;&gt;foo&lt;/a&gt; within WikiConverter.pm, when the rules are executed on an element the conversion from that HTML to Markdown it doesn&#39;t work &#40;at least as expected&#41;. 

I seem to have it narrowed down to the _abs2rel&#40;&#41; function called from _link&#40;&#41; in WikiConverter::Markdown, which creates a new relative URL from the &#40;converted properly&#41; HTML if the base_url is set - BUT this seems to go against what the documentation for the attribute says.

&#34;Relative URIs are only converted to absolute ones if the base_uri argument is present. Defaults to undef.&#34;

To me this means that if a URL is relative &#40;foo.html&#41; it&#39;s converted to absolute &#40;google.com/foo.html&#41; if the base_uri is set &#40;ie: google.com&#41;. 

To fix this &#40;at least for my case&#41; I simply return $uri from _abs2rel&#40;&#41; without checking for base_uri &#40;line 519&#41;, avoiding the creation of a relative link for it &#40;line 520&#41;.

So it seems like the internal HTML cleanup is doing what it should and creating absolute URLs for all the relative ones, but the HTML to Markdown conversion is undoing that.

Test code attached.

If I&#39;m misunderstanding what base_uri is doing, or if the documentation is wrong, please excuse me and let me know.

If it is working as it should now, is there a way to do what I&#39;m looking for, which is create absolute URLs in the resulting Markdown from relative ones in the HTML input.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> html-wikiconverter-markdown-base_uri-test.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use strict;
use warnings;
use Data::Dumper;
use HTML::WikiConverter;

my $base_uri = &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://arcterex.net">http://arcterex.net</a></span>&#34;;

my $html = &lt;&lt;&#39;END&#39;;
&lt;p&gt;This is &lt;a href=&#34;/test1.html&#34;&gt;link to just a page&lt;/a&gt;.
&lt;p&gt;This is &lt;a href=&#34;http://arcterex.net/test1.html&#34;&gt;link to a server + page&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;This is &lt;a href=&#34;http://google.com/test1.html&#34;&gt;link to a dfferent server&lt;/a&gt;.&lt;/p&gt;
END

print &#34;Input:\n$html\n-----\n&#34;;

print &#34;With Base_URI set\n&#34;;
my $wc = new HTML::WikiConverter&#40;
   dialect              =&gt; &#39;Markdown&#39;,
   link_style           =&gt; &#39;inline&#39;,
   base_uri             =&gt; $base_uri,
&#41;;

print $wc-&gt;html2wiki&#40;$html&#41; . &#34;\n&#34;;

print &#34;\n----\nWithout BaseURI set\n&#34;;
my $wc2 = new HTML::WikiConverter&#40;
   dialect              =&gt; &#39;Markdown&#39;,
   link_style           =&gt; &#39;inline&#39;,
&#41;;

print $wc2-&gt;html2wiki&#40;$html&#41; . &#34;\n&#34;;
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
