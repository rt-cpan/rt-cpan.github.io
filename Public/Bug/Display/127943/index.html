<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #127943 for Scalar-List-Utils: List::Util reduce oddly repeating input</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #127943 for Scalar-List-Utils: List::Util reduce oddly repeating input</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Scalar-List-Utils/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Scalar-List-Utils/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Scalar-List-Utils/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Scalar-List-Utils/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Scalar-List-Utils">Scalar-List-Utils CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">127943</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Scalar-List-Utils/Active/">Scalar-List-Utils</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dlamblin [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-28278-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-28279-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;06&nbsp;06:46:39&nbsp;2018</span>
    <span class="description">dlamblin [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> List::Util reduce oddly repeating input</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 6 Dec 2018 20:46:04 +0900</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Scalar-List-Utils [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Daniel Lamblin &lt;dlamblin [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m getting a seemingly randomly chosen single input being repeated for
input to reduce.
EG a {say &#34;$a $b&#34;;$hash{$a}&lt;$hash{$b}?$a:$b} inside a reduce block is just
printing out:
a 380
a 380
over and over, with 380 not even being one of the items in the list of keys
passed in.

This happens in Perl 5.28 &#40;homebrew built&#41; and Perl 5.18 &#40;system build&#41; on
a Macbook.

Here&#39;s some examples where things are normal:
~$ perl -MList::Util=reduce -E&#39;say reduce {say &#34;$a $b&#34;;$a&gt;$b?$a:$b} 1..3&#39;
1 2
2 3
3
~$ perl -MList::Util=reduce -E&#39;%h=&#40;&#41;;map{$h{$_}=3-$_}1..4;say reduce {say
&#34;$a $b&#34;;$h{$a}&gt;$h{$b}?$a:$b} keys %h&#39;
3 2
2 4
2 1
1
~$ perl -MList::Util=reduce -E&#39;%h=&#40;&#41;;map{$h{$_}=3-$_}1..3;say reduce {say
&#34;$a $b&#34;;$h{$a}&gt;$h{$b}?$a:$b} keys %h&#39;
2 3
2 1
1
~$ perl -MList::Util=reduce -E&#39;%k=&#40;&#41;;map{$k{$_}=4-$_}1..4;say reduce {say
&#34;$a $b&#34;;$k{$a}&gt;$k{$b}?$a:$b} grep {$k{$_}&gt;-0} keys %k&#39;
3 1
1 2
1

But when trying to solve <span class="clickylink"><a target="new" rel="nofollow" href="https://adventofcode.com/2018/day/6">https://adventofcode.com/2018/day/6</a></span>
I wrote some code where top level I defined my $b and assigned something to
it &#40;380&#41; for the example, and then things just didn&#39;t work right with it.

Here&#39;s a reproduction of the problem minimally:
~$ perl -MList::Util=reduce -E&#39;use warnings;use strict;use feature
&#34;:5.28&#34;;my &#40;$b,%k&#41;=&#40;100,&#40;&#41;&#41;;map{$k{$_}=4-$_}1..4;say reduce {say &#34;$a
$b&#34;;$k{$a}&gt;$k{$b}?$a:$b} grep {$k{$_}&gt;0} keys %k&#39;
3 100
Use of uninitialized value in numeric gt &#40;&gt;&#41; at -e line 1.
3 100
Use of uninitialized value in numeric gt &#40;&gt;&#41; at -e line 1.
3
Compared to not setting $b:
~$ perl -MList::Util=reduce -E&#39;use warnings;use strict;use feature
&#34;:5.28&#34;;my %k=&#40;&#41;;map{$k{$_}=4-$_}1..4;say reduce {say &#34;$a
$b&#34;;$k{$a}&gt;$k{$b}?$a:$b} grep {$k{$_}&gt;0} keys %k&#39;
1 2
1 3
1

So; I was surprised to have this happen, I thought the $a and $b in the
block would be locally scoped. Is this a bug? If so is it mentioned
somewhere that this pre-defined $b thing is a known issue or gotcha?

My Advent of Code attempt is here [apologies re:style]:
#!/usr/bin/env perl
use warnings;
use strict;
use feature &#34;:5.28&#34;;
use List::Util qw/reduce min max/;
use POSIX &#34;ceil&#34;;

my @z=&#40;&#34;a&#34;..&#34;z&#34;,&#34;A&#34;..&#34;Z&#34;,&#34;0&#34;..&#34;9&#34;&#41;;my$x=0;
my &#40;$n,%p,%e,@x,@y&#41;=&#40;&#39;aa&#39;,&#40;&#41;x4&#41;;
for &#40;&lt;DATA&gt;&#41;{
    m/^&#40;\d+&#41;, &#40;\d+&#41;$/;
    #&#40;$p{n}{a}, $p{$n}{x}, $p{$n++}{y}&#41; = &#40;0, int&#40;$1&#41;, int&#40;$2&#41;&#41;;
    &#40;$p{$z[$x]}{a}, $p{$z[$x]}{x}, $p{$z[$x++]}{y}&#41; = &#40;0, int&#40;$1&#41;, int&#40;$2&#41;&#41;;
    push @x, int&#40;$1&#41;;
    push @y, int&#40;$2&#41;;
}
my &#40;$l,$r,$t,$b&#41; = &#40;min&#40;@x&#41;, max&#40;@x&#41;, min&#40;@y&#41;, max&#40;@y&#41;&#41;;
$l -= ceil&#40;$r/9&#41;;
$r += ceil&#40;$r/9&#41;;
$t -= ceil&#40;$b/9&#41;;
$b += ceil&#40;$b/9&#41;;
sub d{my&#40;$x, $y, $i, $j&#41; = @_; abs&#40;$x - $i&#41; + abs&#40;$y - $j&#41;}
sub c{
    my &#40;$x, $y&#41; = @_;
    my &#40;$k, $n, $d&#41; = &#40;&#40;0&#41;x2,$r+$b&#41;;
    for &#40;keys %p&#41;{
    ┆   ┆$n = d&#40;$x, $y, $p{$_}{x}, $p{$_}{y}&#41;;
    ┆   ┆$k .= &#34;_$_&#34; if &#40;$d == $n&#41;;
    ┆   ┆&#40;$k, $d&#41; = &#40;$_, $n&#41; if &#40;$d &gt; $n&#41;;
    }
    &#40;$k, $d&#41;;
}
for my $j &#40;$t..$b&#41;{
    for my $i &#40;$l..$r&#41;{
    ┆   my &#40;$k, $d&#41; = c&#40;$i, $j&#41;;
    ┆   $p{$k}{a}++ if $p{$k};
    ┆   if &#40;$i==$l || $i==$r || $j==$t || $j==$b&#41;{
    ┆   ┆   $e{$k} = 1;
    ┆   }
    ┆   #print $p{$k} ? $k : &#34;.&#34;;
    }
    #say&#34;&#34;;
}
say map {sprintf &#34;%2s:%3d,%3d=%5d\n&#34;,exists $e{$_} ? &#34;^$_&#34; :
&#34;=$_&#34;,$p{$_}{x},$p{$_}{y},$p{$_}{a}} sort keys %p;
say &#34;None of: &#34;.join&#40;&#34; &#34;, sort keys %e&#41;;
say &#34;Only of: &#34;.join&#40;&#34; &#34;, sort grep {!exists $e{$_}} keys %p&#41;;
my $k = reduce {say &#34;$a $b&#34;; $p{$a}{a} &gt; $p{$b}{a} ? $a : $b} grep {!exists
$e{$_}} keys %p;
say &#34;WHAT&#34;;
say &#34;$k at $p{$k}{x}, $p{$k}{y} is $p{$k}{a} big.&#34;
#There&#39;s more data but, you don&#39;t need it do you?
__DATA__
81, 157
209, 355
111, 78
179, 211
224, 268
93, 268
237, 120
345, 203
72, 189
298, 265
190, 67
319, 233
328, 40
323, 292
125, 187
343, 186
46, 331
106, 350
247, 332
349, 145
217, 329
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;06&nbsp;10:15:31&nbsp;2018</span>
    <span class="description">haarg [...] haarg.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The $a and $b used by reduce are package globals.  Their values are localized during the reduce operation.  If you use a lexical of the same name, it will shadow the global, and the lexical will be used by your reduce block but will not be set by the reduce function.  sort blocks have the same issue.  This is why you should never use variables named $a or $b.  There isn&#39;t really anything to fix here, although it could be mentioned in the docs.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;06&nbsp;10:15:32&nbsp;2018</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
