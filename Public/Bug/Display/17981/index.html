<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #17981 for Imager: Imager Crash on Jpeg</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #17981 for Imager: Imager Crash on Jpeg</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Imager/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Imager/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Imager/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Imager/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Imager">Imager CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">17981</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Imager/Active/">Imager</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">TONYC [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
perl [...] rbt.ca

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-16790-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.47</li>
<li>
0.48</li>
</ul>
    </td>
  </tr>
  <tr id="CF-16791-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;04&nbsp;12:31:12&nbsp;2006</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Imager Crash on Jpeg</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">In Bricolage with thumbnails enabled I receive the below apache crash
&#40;mod_perl&#41; with Imager 0.47 and later. 0.45 is confirmed to function on
these images correctly.  Three image examples that work in 0.45 and
crash 0.47 and 0.48 are attached.

&#40;gdb&#41; backtrace
#0  0x0000000805589bb7 in i_int_decode_exif &#40;&#41;
   from /usr/local/lib/perl5/site_perl/5.8.8/mach/auto/Imager/Imager.so
#1  0x0000000805583177 in i_readjpeg_wiol &#40;&#41;
   from /usr/local/lib/perl5/site_perl/5.8.8/mach/auto/Imager/Imager.so
#2  0x0000000805546d13 in XS_Imager_i_readjpeg_wiol &#40;&#41;
   from /usr/local/lib/perl5/site_perl/5.8.8/mach/auto/Imager/Imager.so
#3  0x0000000802de014c in Perl_pp_entersub &#40;&#41;
   from /usr/local/lib/perl5/5.8.8/mach/CORE/libperl.so
#4  0x0000000802dd8dee in Perl_runops_standard &#40;&#41;
   from /usr/local/lib/perl5/5.8.8/mach/CORE/libperl.so
#5  0x0000000802d89c4c in Perl_call_sv &#40;&#41; from
/usr/local/lib/perl5/5.8.8/mach/CORE/libperl.so
#6  0x0000000802c2aa8e in perl_call_handler &#40;&#41; from
/usr/local/libexec/apache/libperl.so
#7  0x0000000802c2b0f6 in perl_run_stacked_handlers &#40;&#41;
   from /usr/local/libexec/apache/libperl.so
#8  0x0000000802c2c732 in perl_handler &#40;&#41; from
/usr/local/libexec/apache/libperl.so
#9  0x000000000040c6cc in ap_invoke_handler &#40;&#41;
#10 0x000000000041e4fc in process_request_internal &#40;&#41;
#11 0x000000000041e63d in ap_process_request &#40;&#41;
#12 0x0000000000415d79 in child_main &#40;&#41;
#13 0x0000000000416109 in make_child &#40;&#41;
#14 0x00000000004161a6 in startup_children &#40;&#41;
---Type &lt;return&gt; to continue, or q &lt;return&gt; to quit---
#15 0x00000000004171cb in standalone_main &#40;&#41;
#16 0x0000000000417ec3 in main &#40;&#41;



The code that Bricolage runs is similar to this:

use strict;
use warnings;

require Imager;

use constant THUMBNAIL_SIZE =&gt; 150;

my $path = shift;

    # Get the media format. Try using the MIME type, and fall back on
what Imager
    # guesses.
   &#40;my $mt = $path&#41; =~ s|.*/||;
   my $format = $Imager::FORMATGUESS-&gt;&#40;&#34;.$mt&#34;&#41;;
   $format = $Imager::FORMATGUESS-&gt;&#40;$path&#41;;


    # Just warn and return if Imager doesn&#39;t support the format.
    unless &#40;$Imager::formats{$format}&#41; {
        warn qq{It looks like the image library to handle the &#34;$format&#34; }
          . &#39;fomat is not installed. No thumbnail will be created for file &#39;
          . &#34;&#39;$path&#39;.\n&#34;;
        return;
    }

    my $img = Imager-&gt;new;
    $img-&gt;open&#40;file =&gt; $path, type =&gt; $format&#41;
      or die &#34;Imager cannot open &#39;$path&#39; : $img-&gt;errstr&#34;;

    # If either dimension is greather than the thumbnail size, create a
    # smaller version by scaling largest side to THUMBNAIL_SIZE
    if &#40;$img-&gt;getwidth &gt; THUMBNAIL_SIZE || $img-&gt;getheight &gt;
THUMBNAIL_SIZE&#41; {
        $img = $img-&gt;scale&#40;xpixels =&gt; THUMBNAIL_SIZE,
                           ypixels =&gt; THUMBNAIL_SIZE,
                           type    =&gt; &#39;min&#39;&#41;;
    }

    # Save the image or die.
    $img-&gt;write&#40;file =&gt; &#34;$path-thumb&#34;&#41;
      or die &#34;Imager cannot write &#39;thumb.jpg&#39;&#34;;
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 210_dundas.jpg</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<img alt="210_dundas.jpg" title="210_dundas.jpg" src="/Ticket/Attachment/170650/55757/" /></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 209_yonge.jpg</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<img alt="209_yonge.jpg" title="209_yonge.jpg" src="/Ticket/Attachment/170650/55760/" /></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 200_wellington.jpg</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<img alt="200_wellington.jpg" title="200_wellington.jpg" src="/Ticket/Attachment/170650/55763/" /></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;04&nbsp;12:39:58&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> perl [...] rbt.ca</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Almost forgot:

FreeBSD home 6.0-RELEASE FreeBSD 6.0-RELEASE #13: Sat Nov  5 00:19:49
EST 2005     root@home:/usr/obj/usr/src/sys/HOME  amd64
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;04&nbsp;12:39:59&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;04&nbsp;19:18:32&nbsp;2006</span>
    <span class="description">tony [...] develop-help.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17981] Imager Crash on Jpeg</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 5 Mar 2006 11:18:16 +1100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Guest via RT &lt;bug-Imager [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tony Cook &lt;tony [...] develop-help.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat, Mar 04, 2006 at 12:31:13PM -0500, Guest via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Sat Mar 04 12:31:12 2006: Request 17981 was acted upon.
&gt; Transaction: Ticket created by guest
&gt;        Queue: Imager
&gt;      Subject: Imager Crash on Jpeg
&gt;        Owner: Nobody
&gt;   Requestors: perl@rbt.ca
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=17981">http://rt.cpan.org/Ticket/Display.html?id=17981</a></span> &gt;
&gt; 
&gt; 
&gt; In Bricolage with thumbnails enabled I receive the below apache crash
&gt; &#40;mod_perl&#41; with Imager 0.47 and later. 0.45 is confirmed to function on
&gt; these images correctly.  Three image examples that work in 0.45 and
&gt; crash 0.47 and 0.48 are attached.
&gt; 
&gt; &#40;gdb&#41; backtrace
&gt; #0  0x0000000805589bb7 in i_int_decode_exif &#40;&#41;
&gt;    from /usr/local/lib/perl5/site_perl/5.8.8/mach/auto/Imager/Imager.so
&gt; #1  0x0000000805583177 in i_readjpeg_wiol &#40;&#41;
&gt;    from /usr/local/lib/perl5/site_perl/5.8.8/mach/auto/Imager/Imager.so
</div>
Hi,

Thanks for reporting this problem.

This is a problem in the EXIF data decoder, you can disable that by
running Makefile.PL with the --noexif option:

  perl Makefile.PL --noexif

I&#39;ve been able to reproduce this problem locally, and tracked down the
cause of the problem.

I&#39;ll send you a patch for the problem as soon as I have one, and I&#39;ll
release a fixed Imager within a few days of receiving confirmation of
the fix, or within a week or so if you don&#39;t confirm the fix.

Thanks again,
Tony Cook
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;04&nbsp;19:20:20&nbsp;2006</span>
    <span class="description">tony [...] develop-help.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17981] Imager Crash on Jpeg</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 5 Mar 2006 11:20:07 +1100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Guest via RT &lt;bug-Imager [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tony Cook &lt;tony [...] develop-help.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat, Mar 04, 2006 at 12:31:13PM -0500, Guest via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In Bricolage with thumbnails enabled I receive the below apache crash
&gt; &#40;mod_perl&#41; with Imager 0.47 and later. 0.45 is confirmed to function on
&gt; these images correctly.  Three image examples that work in 0.45 and
&gt; crash 0.47 and 0.48 are attached.
</div>
Would there be a problem with including one of those images in Imager
for regression testing?

Thanks,
Tony
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;04&nbsp;20:13:31&nbsp;2006</span>
    <span class="description">pg [...] rbt.ca -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> perl [...] rbt.ca</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17981] Imager Crash on Jpeg</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 04 Mar 2006 20:11:45 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Imager [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Rod Taylor &lt;pg [...] rbt.ca&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat, 2006-03-04 at 19:20 -0500, tony@develop-help.com via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sat, Mar 04, 2006 at 12:31:13PM -0500, Guest via RT wrote:
<div class="message-stanza open">&gt; &gt; In Bricolage with thumbnails enabled I receive the below apache crash
&gt; &gt; &#40;mod_perl&#41; with Imager 0.47 and later. 0.45 is confirmed to function on
&gt; &gt; these images correctly.  Three image examples that work in 0.45 and
&gt; &gt; crash 0.47 and 0.48 are attached.
</div>&gt; 
&gt; Would there be a problem with including one of those images in Imager
&gt; for regression testing?
</div>
Please do so.

Thanks.
-- 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;05&nbsp;03:51:56&nbsp;2006</span>
    <span class="description">tony [...] develop-help.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17981] Imager Crash on Jpeg</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 5 Mar 2006 19:51:37 +1100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Guest via RT &lt;bug-Imager [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tony Cook &lt;tony [...] develop-help.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat, Mar 04, 2006 at 12:31:13PM -0500, Guest via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In Bricolage with thumbnails enabled I receive the below apache crash
&gt; &#40;mod_perl&#41; with Imager 0.47 and later. 0.45 is confirmed to function on
&gt; these images correctly.  Three image examples that work in 0.45 and
&gt; crash 0.47 and 0.48 are attached.
</div>
Hi,

I&#39;ve attached a patch which should resolve your problem with reading
JPEG images with Imager 0.47 - 0.48.

The important part for your purposes is:

Index: imexif.c
===================================================================
--- imexif.c    &#40;revision 933&#41;
+++ imexif.c    &#40;revision 934&#41;
@@ -695,7 +695,7 @@
       memcpy&#40;user_comment, tiff-&gt;base + entry-&gt;offset, entry-&gt;size&#41;;
       /* the first 8 bytes indicate the encoding, make them into spaces
         for better presentation */
-      for &#40;i = 0; i &lt; 8; ++i&#41; {
+      for &#40;i = 0; i &lt; entry-&gt;size &#38;&#38; i &lt; 8; ++i&#41; {
        if &#40;user_comment[i] == &#39;\0&#39;&#41;
          user_comment[i] = &#39; &#39;;
       }

Please let me know how it goes.

Tony Cook
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;05&nbsp;19:02:44&nbsp;2006</span>
    <span class="description">tony [...] develop-help.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17981] Imager Crash on Jpeg</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 6 Mar 2006 11:02:24 +1100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Guest via RT &lt;bug-Imager [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tony Cook &lt;tony [...] develop-help.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat, Mar 04, 2006 at 12:31:13PM -0500, Guest via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In Bricolage with thumbnails enabled I receive the below apache crash
&gt; &#40;mod_perl&#41; with Imager 0.47 and later. 0.45 is confirmed to function on
&gt; these images correctly.  Three image examples that work in 0.45 and
&gt; crash 0.47 and 0.48 are attached.
</div>
And so I forgot the patch.  Attached this time.

Tony
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;05&nbsp;23:39:29&nbsp;2006</span>
    <span class="description">iam [...] rbt.ca -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> perl [...] rbt.ca</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17981] Imager Crash on Jpeg</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 05 Mar 2006 23:37:27 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Imager [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> RT &lt;iam [...] rbt.ca&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Seems to be fine with the patch applied.

Thanks.

On Sun, 2006-03-05 at 19:02 -0500, tony@develop-help.com via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sat, Mar 04, 2006 at 12:31:13PM -0500, Guest via RT wrote:
<div class="message-stanza open">&gt; &gt; In Bricolage with thumbnails enabled I receive the below apache crash
&gt; &gt; &#40;mod_perl&#41; with Imager 0.47 and later. 0.45 is confirmed to function on
&gt; &gt; these images correctly.  Three image examples that work in 0.45 and
&gt; &gt; crash 0.47 and 0.48 are attached.
</div>&gt; 
&gt; And so I forgot the patch.  Attached this time.
&gt; 
&gt; Tony
&gt; 
&gt; plain text document attachment &#40;exif_user_comment.diff&#41;
&gt; Index: MANIFEST
&gt; ===================================================================
&gt; --- MANIFEST  &#40;revision 933&#41;
&gt; +++ MANIFEST  &#40;revision 934&#41;
&gt; @@ -209,6 +209,7 @@
&gt;  t/t92samples.t
&gt;  t/testtools.pl
&gt;  tags.c
&gt; +testimg/209_yonge.jpg        Regression test: #17981
&gt;  testimg/bad1oflow.bmp   1-bit/pixel, overflow integer on 32-bit machines
&gt;  testimg/bad1wid0.bmp    1-bit/pixel, zero width
&gt;  testimg/bad24comp.bmp   24-bit/pixel, bad compression
&gt; Index: Changes
&gt; ===================================================================
&gt; --- Changes   &#40;revision 933&#41;
&gt; +++ Changes   &#40;revision 934&#41;
&gt; @@ -1366,12 +1366,19 @@
&gt;    custom META.yml was a waste.
&gt;  - bump to 0.47_01
&gt;  
&gt; -0.48
&gt; +0.48 Fri 3 Mar 2006
&gt;  - removed unused hashinfo&#40;&#41; function from Imager.xs
&gt;  - added =items for various methods, so Pod::Coverage will pick them up
&gt;    &#40;Pod::Coverage tests to be added in 0.49&#41;
&gt;  - bump to 0.48
&gt;  
&gt; +0.49
&gt; +- handle short EXIF user_comment fields correctly, previously Imager
&gt; +  would read &#40;and potentially&#41; write beyond the end of an allocated block,
&gt; +  or through a NULL pointer if the EXIF user_comment field was less
&gt; +  than 8 bytes long.
&gt; +  <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=17981">https://rt.cpan.org/Ticket/Display.html?id=17981</a></span>
&gt; +
&gt;  =================================================================
&gt;  
&gt;          For latest versions check the Imager-devel pages:
&gt; Index: imexif.c
&gt; ===================================================================
&gt; --- imexif.c  &#40;revision 933&#41;
&gt; +++ imexif.c  &#40;revision 934&#41;
&gt; @@ -695,7 +695,7 @@
&gt;        memcpy&#40;user_comment, tiff-&gt;base + entry-&gt;offset, entry-&gt;size&#41;;
&gt;        /* the first 8 bytes indicate the encoding, make them into spaces
&gt;        for better presentation */
&gt; -      for &#40;i = 0; i &lt; 8; ++i&#41; {
&gt; +      for &#40;i = 0; i &lt; entry-&gt;size &#38;&#38; i &lt; 8; ++i&#41; {
&gt;       if &#40;user_comment[i] == &#39;\0&#39;&#41;
&gt;         user_comment[i] = &#39; &#39;;
&gt;        }
&gt; Index: t/t101jpeg.t
&gt; ===================================================================
&gt; --- t/t101jpeg.t      &#40;revision 933&#41;
&gt; +++ t/t101jpeg.t      &#40;revision 934&#41;
&gt; @@ -2,7 +2,7 @@
&gt;  use strict;
&gt;  use lib &#39;t&#39;;
&gt;  use Imager qw&#40;:all&#41;;
&gt; -use Test::More tests =&gt; 49;
&gt; +use Test::More tests =&gt; 51;
&gt;  
&gt;  init_log&#40;&#34;testout/t101jpeg.log&#34;,1&#41;;
&gt;  
&gt; @@ -30,7 +30,7 @@
&gt;      $im = Imager-&gt;new&#40;xsize=&gt;2, ysize=&gt;2&#41;;
&gt;      ok&#40;!$im-&gt;write&#40;file=&gt;&#34;testout/nojpeg.jpg&#34;&#41;, &#34;should fail to write jpeg&#34;&#41;;
&gt;      cmp_ok&#40;$im-&gt;errstr, &#39;=~&#39;, qr/format not supported/, &#34;check no jpeg message&#34;&#41;;
&gt; -    skip&#40;&#34;no jpeg support&#34;, 45&#41;;
&gt; +    skip&#40;&#34;no jpeg support&#34;, 47&#41;;
&gt;    }
&gt;  } else {
&gt;    open&#40;FH,&#34;&gt;testout/t101.jpg&#34;&#41; || die &#34;cannot open testout/t101.jpg for writing\n&#34;;
&gt; @@ -233,5 +233,17 @@
&gt;        is_deeply&#40;$expect_tags, \%tags, &#34;check tags for $filename&#34;&#41;;
&gt;      }
&gt;    }
&gt; +
&gt; +  { # Issue # 17981
&gt; +    # the test image has a zero-length user_comment field
&gt; +    # the code would originally attempt to convert &#39;\0&#39; to &#39; &#39;
&gt; +    # for the first 8 bytes, even if the string was less than 
&gt; +    # 8 bytes long
&gt; +    my $im = Imager-&gt;new;
&gt; +    ok&#40;$im-&gt;read&#40;file =&gt; &#39;testimg/209_yonge.jpg&#39;, type=&gt;&#39;jpeg&#39;&#41;,
&gt; +       &#34;test read of image with invalid exif_user_comment&#34;&#41;;
&gt; +    is&#40;$im-&gt;tags&#40;name=&gt;&#39;exif_user_comment&#39;&#41;, &#39;&#39;,
&gt; +       &#34;check exif_user_comment set correctly&#34;&#41;;
&gt; +  }
&gt;  }
&gt;  
&gt; Index: testimg/209_yonge.jpg
&gt; ===================================================================
&gt; Cannot display: file marked as a binary type.
&gt; svn:mime-type = application/octet-stream
&gt; 
&gt; Property changes on: testimg/209_yonge.jpg
&gt; ___________________________________________________________________
&gt; Name: svn:mime-type
&gt;    + application/octet-stream
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;07&nbsp;18:11:53&nbsp;2006</span>
    <span class="description">TONYC [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;07&nbsp;18:13:43&nbsp;2006</span>
    <span class="description">TONYC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

This is fixed in Imager 0.49, released yesterday.

Thanks for your report and help in tracking the problem down.

Note: a reply will reopen this ticket.

Tony
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;07&nbsp;18:13:44&nbsp;2006</span>
    <span class="description">TONYC [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
