<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #101881 for Sereal-Encoder: floating-point formats not according to spec</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #101881 for Sereal-Encoder: floating-point formats not according to spec</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Sereal-Encoder/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Sereal-Encoder/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Sereal-Encoder/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Sereal-Encoder/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/Sereal/Sereal/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Sereal-Encoder">Sereal-Encoder CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">101881</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Sereal-Encoder/Active/">Sereal-Encoder</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
zefram [...] fysh.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-245624-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-245625-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;02&nbsp;10:15:07&nbsp;2015</span>
    <span class="description">zefram [...] fysh.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> floating-point formats not according to spec</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 2 Feb 2015 15:14:53 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sereal-Encoder [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The Sereal format spec clearly says that floating-point values
are to be stored in IEEE formats.  However, the spec does poorly at
specifying which formats these are, and the implementation actually uses
not-necessarily-IEEE native formats.

First, the spec.  The tag table documents tags named &#34;FLOAT&#34;, &#34;DOUBLE&#34;,
and &#34;LONG_DOUBLE&#34;, describing the type-specific data for each as
&#34;&lt;IEEE-FLOAT&gt;&#34;, &#34;&lt;IEEE-DOUBLE&gt;&#34;, and &#34;&lt;IEEE-LONG-DOUBLE&gt;&#34; respectively.
This, along with the general note about using IEEE formats and the
other general note about numeric quantities being little-endian, is the
entire specification for the floating-point representations.  This is
a problem, because the terms &#34;float&#34; and &#34;long double&#34; don&#39;t have any
defined meaning in the context of IEEE 754, so the intended referents
are unclear.  The family of terms &#34;float&#34;, &#34;double&#34;, and &#34;long double&#34;
are actually C type names, and IEEE 754 does not specify any particular
mapping of its formats onto C types.

IEEE 754 defines four binary floating-point formats for data interchange.
Each has an explicit name based on its bit length, and a common
name based on multiples of the historical default size of 32 bits.
The four formats are binary16 &#40;&#34;half precision&#34;, 5 exponent bits, 10
fractional significand bits&#41;, binary32 &#40;&#34;single precision&#34;, 8 exponent
bits, 23 fractional significand bits&#41;, binary64 &#40;&#34;double precision&#34;, 11
exponent bits, 52 fractional significand bits&#41;, and binary128 &#40;&#34;quadruple
precision&#34;, 15 exponent bits, 112 fractional significand bits&#41;.  The spec
should refer to these formats by either of their names, not by C types.

Next, the implementation.  srl_encoder.c &#40;and matching srl_decoder.c
of Sereal::Decoder&#41; does not make any effort to use IEEE formats in
serialised data.  Instead it uses the native C floating-point types,
associating float, double, and long double each with the similarly-named
tag.  It doesn&#39;t even canonicalise endianness: so even where the native
types are IEEE, a big-endian system serialises contrary to the spec&#39;s
statement that numeric data are little-endian.  &#40;With the varint clause
explicitly specifying little-endian, and all other numeric quantities
being single bytes, the floating-point formats seem to be the only data
to which the general endianness statement apply.&#41;

Hosts with different endianness or otherwise differing floating-point
formats of the same size will see corrupted numeric data when they
try to exchange serialised NVs.  Hosts whose floating-point formats
for particular C types have different sizes will see worse corruption,
by virtue of losing synchronisation between encoder and decoder.

I&#39;m not presently affected by this, but foreseeably might become affected.
We configure our perls to use long double for NV, and currently for
us that&#39;s the decidedly non-IEEE x87 80-bit format.  &#40;Not only is
the format not one of the lengths specified by IEEE, but by using an
explicit integral significand bit it doesn&#39;t even follow IEEE&#39;s rules
for constructing floating-point formats.&#41;  It is foreseeable that this
format will eventually be supplanted, one way or another, by the IEEE
quad-precision format, which is already used for the long double type on
some platforms.  In switching over we would face a compatibility problem.

-zefram
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;02&nbsp;10:21:51&nbsp;2015</span>
    <span class="description">demerphq [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #101881] floating-point formats not according to spec</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 2 Feb 2015 16:21:41 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sereal-Encoder [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> demerphq &lt;demerphq [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2 February 2015 at 16:15, Zefram via RT
&lt;bug-Sereal-Encoder@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Mon Feb 02 10:15:07 2015: Request 101881 was acted upon.
&gt; Transaction: Ticket created by zefram@fysh.org
&gt;        Queue: Sereal-Encoder
&gt;      Subject: floating-point formats not according to spec
&gt;    Broken in: &#40;no value&#41;
&gt;     Severity: &#40;no value&#41;
&gt;        Owner: Nobody
&gt;   Requestors: zefram@fysh.org
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=101881">https://rt.cpan.org/Ticket/Display.html?id=101881</a></span> &gt;
&gt;
&gt;
&gt; The Sereal format spec clearly says that floating-point values
&gt; are to be stored in IEEE formats.  However, the spec does poorly at
&gt; specifying which formats these are, and the implementation actually uses
&gt; not-necessarily-IEEE native formats.
&gt;
&gt; First, the spec.  The tag table documents tags named &#34;FLOAT&#34;, &#34;DOUBLE&#34;,
&gt; and &#34;LONG_DOUBLE&#34;, describing the type-specific data for each as
&gt; &#34;&lt;IEEE-FLOAT&gt;&#34;, &#34;&lt;IEEE-DOUBLE&gt;&#34;, and &#34;&lt;IEEE-LONG-DOUBLE&gt;&#34; respectively.
&gt; This, along with the general note about using IEEE formats and the
&gt; other general note about numeric quantities being little-endian, is the
&gt; entire specification for the floating-point representations.  This is
&gt; a problem, because the terms &#34;float&#34; and &#34;long double&#34; don&#39;t have any
&gt; defined meaning in the context of IEEE 754, so the intended referents
&gt; are unclear.  The family of terms &#34;float&#34;, &#34;double&#34;, and &#34;long double&#34;
&gt; are actually C type names, and IEEE 754 does not specify any particular
&gt; mapping of its formats onto C types.
&gt;
&gt; IEEE 754 defines four binary floating-point formats for data interchange.
&gt; Each has an explicit name based on its bit length, and a common
&gt; name based on multiples of the historical default size of 32 bits.
&gt; The four formats are binary16 &#40;&#34;half precision&#34;, 5 exponent bits, 10
&gt; fractional significand bits&#41;, binary32 &#40;&#34;single precision&#34;, 8 exponent
&gt; bits, 23 fractional significand bits&#41;, binary64 &#40;&#34;double precision&#34;, 11
&gt; exponent bits, 52 fractional significand bits&#41;, and binary128 &#40;&#34;quadruple
&gt; precision&#34;, 15 exponent bits, 112 fractional significand bits&#41;.  The spec
&gt; should refer to these formats by either of their names, not by C types.
&gt;
&gt; Next, the implementation.  srl_encoder.c &#40;and matching srl_decoder.c
&gt; of Sereal::Decoder&#41; does not make any effort to use IEEE formats in
&gt; serialised data.  Instead it uses the native C floating-point types,
&gt; associating float, double, and long double each with the similarly-named
&gt; tag.  It doesn&#39;t even canonicalise endianness: so even where the native
&gt; types are IEEE, a big-endian system serialises contrary to the spec&#39;s
&gt; statement that numeric data are little-endian.  &#40;With the varint clause
&gt; explicitly specifying little-endian, and all other numeric quantities
&gt; being single bytes, the floating-point formats seem to be the only data
&gt; to which the general endianness statement apply.&#41;
&gt;
&gt; Hosts with different endianness or otherwise differing floating-point
&gt; formats of the same size will see corrupted numeric data when they
&gt; try to exchange serialised NVs.  Hosts whose floating-point formats
&gt; for particular C types have different sizes will see worse corruption,
&gt; by virtue of losing synchronisation between encoder and decoder.
&gt;
&gt; I&#39;m not presently affected by this, but foreseeably might become affected.
&gt; We configure our perls to use long double for NV, and currently for
&gt; us that&#39;s the decidedly non-IEEE x87 80-bit format.  &#40;Not only is
&gt; the format not one of the lengths specified by IEEE, but by using an
&gt; explicit integral significand bit it doesn&#39;t even follow IEEE&#39;s rules
&gt; for constructing floating-point formats.&#41;  It is foreseeable that this
&gt; format will eventually be supplanted, one way or another, by the IEEE
&gt; quad-precision format, which is already used for the long double type on
&gt; some platforms.  In switching over we would face a compatibility problem.
</div>
We have patches in the branch proto4 to fix some of this. Could you
review that branch and tell me what you think?

Yves
ps: Sometimes you file tickets with RT sometimes with the Sereal
tracker, could we please make the sereal tracker primary? I keep
having to copy your tickets over. &#40;I dont mind if you file RT tickets
as well, but I keep stealing your tickets in the main tracker.&#41;


-- 
perl -Mre=debug -e &#34;/just|another|perl|hacker/&#34;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;02&nbsp;10:21:51&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;02&nbsp;10:33:15&nbsp;2015</span>
    <span class="description">zefram [...] fysh.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #101881] floating-point formats not according to spec</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 2 Feb 2015 15:33:01 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> demerphq via RT &lt;bug-Sereal-Encoder [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">demerphq via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;We have patches in the branch proto4 to fix some of this. Could you
&gt;review that branch and tell me what you think?
</div>
Will look.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;ps: Sometimes you file tickets with RT sometimes with the Sereal
&gt;tracker, could we please make the sereal tracker primary?
</div>
I haven&#39;t filed Sereal-related issues anywhere other than RT.  If by
&#34;the Sereal tracker&#34; you mean the thing on github that RT has a link to,
then no, I can&#39;t file tickets there.  Last I checked, github doesn&#39;t
offer a way to submit bug reports to its issue trackers without creating
a github account and thus signing away one&#39;s firstborn.  I suggest that
you take this up with github, or else select as your primary bug tracker
something that places fewer barriers in the way of bug reporters.

-zefram
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;02&nbsp;11:54:21&nbsp;2015</span>
    <span class="description">zefram [...] fysh.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #101881] floating-point formats not according to spec</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 2 Feb 2015 16:54:08 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> demerphq via RT &lt;bug-Sereal-Encoder [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">demerphq via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;We have patches in the branch proto4 to fix some of this. Could you
&gt;review that branch and tell me what you think?
</div>
This branch still uses native formats, including native endianness.  The
only improvements are that you now retain encoder/decoder synchronisation,
by asserting exact sizes for float and double and by padding long double.
All the other failure modes relating to native formats still apply.
You actually make things worse in another respect by making the support
for long double NV non-default.

The new sizeof&#40;NV&#41; == sizeof&#40;float&#41; checks that are trying to determine
which type NV is are flawed: one could have two floating-point types
that are the same size but behave differently.

The spec in this branch is self-contradictory about the formats.
It still has the general notes about IEEE formats and little-endian,
but now contradicts that by describing the LONG_DOUBLE type as platform
specific.  The descriptions for FLOAT and DOUBLE, by giving specific
sizes, now succeed in identifying specific formats &#40;though it would still
be better to use the formats&#39; correct names&#41;, but they still don&#39;t match
the code&#39;s de facto use of native formats.

To fix this you need some format conversion code.  It&#39;s not difficult
to pull a floating-point value apart bit-by-bit to convert it to a known
format, nor to perform the reverse conversion.  The difficult part is to
recognise the common case where some of the IEEE formats are implemented
natively, in order to avoid slow bit twiddling.  &#40;More generally, if a
specific native format is known then conversion between it and IEEE can be
done more efficiently than would be achieved by handling it opaquely.&#41;
I recommend that, as an initial step, you should implement format
conversion with no attempt at this optimisation.  Correctness first.
Then you can look into how to detect details of the native formats.

-zefram
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
