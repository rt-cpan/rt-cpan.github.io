<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #70760 for Sphinx-Search: persistent connection problem</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #70760 for Sphinx-Search: persistent connection problem</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Sphinx-Search/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Sphinx-Search/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Sphinx-Search/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Sphinx-Search/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Sphinx-Search">Sphinx-Search CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">70760</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Sphinx-Search/Active/">Sphinx-Search</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
kholodkov [...] mail.ru

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-45236-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-45237-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




patch.027.1<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1048465/548011/patch.027.1">
Sat Mar 10 09:44:18 2012 (7.4k) by kholodkov [...] mail.ru
</a>
</font></li>
</ul>


patch.sphinx_module<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/979018/509628/patch.sphinx_module">
Mon Sep 19 03:47:09 2011 (7.2k) by holodkov [...] corp.mail.ru
</a>
</font></li>
</ul>


test.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/979018/509627/test.pl">
Mon Sep 19 03:47:09 2011 (547b) by holodkov [...] corp.mail.ru
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;06&nbsp;08:29:07&nbsp;2011</span>
    <span class="description">kholodkov [...] mail.ru -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> persistent connection problem</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 06 Sep 2011 16:28:52 +0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sphinx-Search [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Алексей Холодков &lt;kholodkov [...] mail.ru&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,
Thanks for your modules.
I try to use persistent connection  in Sphinx::Search module $VERSION = &#39;0.240.1&#39; .   Linux. perl v5.8.8
I think that other versions have the same problem.
It makes connecction to sphinx and keep it. 
But, when I run indexer with option --rotate and reindex data on sphinx server I catch a littele problem.
Some first queries fails with: &#34;read failed:&#34; and than it works fine &#40;but not in persistent connection mode&#41;.
sample code with comments:
....
my $sph = Sph::Search-&gt;new&#40;&#41;;
$sph-&gt;SetServer&#40;$host, $port&#41;;
$sph-&gt;SetConnectTimeout&#40;$timeout&#41;;
$sph-&gt;Open&#40;&#41;;
﻿....
my $res = $sph-&gt;Query&#40;&#39;test&#39;, &#39;test&#39;&#41;;  #this is ok 
&lt;/span&gt;$res = $sph-&gt;Query&#40;&#39;test&#39;, &#39;test&#39;&#41;; #this is ok  and work with the same socket

while&#40;&lt;STDIN&gt;&#41;{  # wait for reindex data on server
    last if $_ =~/\n/;
}﻿
&lt;/span&gt;$res = $sph-&gt;Query&#40;&#39;test&#39;, &#39;test&#39;&#41;; #this fails
$res = $sph-&gt;Query&#40;&#39;test&#39;, &#39;test&#39;&#41;; #this is ok, but from this point no persistent connection
.....all other queries get new sockets.

end code...

Is it possible to fix persistent connection and restore it  on fail?
and if query falls in persistent mode try to reconnect and resent failed query.

Thanks.
WBR. Alexey.
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;15&nbsp;05:59:17&nbsp;2011</span>
    <span class="description">kholodkov [...] mail.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #70760] AutoReply: persistent connection problem </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 15 Sep 2011 13:59:00 +0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sphinx-Search [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Алексей Холодков &lt;kholodkov [...] mail.ru&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I make some changes in module $VERSION = &#39;0.240.1&#39;  to fix the problem:

=============================
1. add two items to object
            _persistent     =&gt; undef,     &#39;flag - is persistent connection mode&#39;
            _connectretries =&gt; 1;       &#39;number of reconnections if connection fails&#39;
2. add new method &#39; SetConnectRetries &#39; it changes value of _connectretries;
 
3. _ProcessRequest  -   send/resend requests to sphinx.

4. Persistent connect data moved to method _Connect 
================================================== 
DIFF BELOW
================================================
281a282,283
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     _persistent     =&gt; undef,
&gt;     _connectretries =&gt; 1,
</div>490a493,510
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; =head2 SetConnectRetries
&gt;
&gt;     $sph-&gt;SetConnectRetries&#40;$retries&#41;
&gt;
&gt; Set server connection retries &#40;in case of connection fail&#41;.
&gt;
&gt; Returns $sph.
&gt;
&gt; =cut
&gt;
&gt; sub SetConnectRetries {
&gt;     my $self = shift;
&gt;     my $retires = shift;
&gt;     croak&#40;&#34;connectretries is not numeric&#34;&#41; unless &#40;$retires =~  m/$num_re/&#41;;
&gt;     $self-&gt;{connectretries} = $retires;
&gt; }
&gt;
&gt;
</div>497,501c517,524
&lt;     $fp-&gt;write&#40;$data&#41;; return 1;
&lt;     if &#40;$fp-&gt;eof || ! $fp-&gt;write&#40;$data&#41;&#41; {
&lt;       $self-&gt;_Error&#40;&#34;connection unexpectedly closed &#40;timed out?&#41;: $!&#34;&#41;;
&lt;       $self-&gt;{_connerror} = 1;
&lt;       return 0;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     unless &#40; send&#40;$fp,$data,0&#41;&#41;{
&gt;         $self-&gt;_Error&#40;&#34;connection unexpectedly closed &#40;timed out?&#41;: $!&#34;&#41;;
&gt;         $self-&gt;{_connerror} = 1;
&gt;         if &#40;$self-&gt;{_socket}&#41; {
&gt;             close&#40;$self-&gt;{_socket}&#41;;
&gt;             undef $self-&gt;{_socket};
&gt;         }
&gt;         return 0;
</div>510c533
&lt;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     $self-&gt;_Error&#40;&#41;; #reset old errors in new connection
</div>566,567c589,593
&lt;       $self-&gt;_Send&#40;$fp, pack&#40;&#34;N&#34;, 1&#41;&#41; or return 0;
&lt;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       unless &#40;$self-&gt;_Send&#40;$fp, pack&#40;&#34;N&#34;, 1&#41;&#41;&#41; {
&gt;           $self-&gt;{_connerror} = 1;
&gt;         $self-&gt;_Error&#40;&#34;error while send version&#34;&#41;;
&gt;         return 0;
&gt;     }
</div>569c595,604
&lt;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt;     if &#40;$self-&gt;{_persistent}&#41; {
&gt;         my $req = pack&#40;&#34;nnNN&#34;, SEARCHD_COMMAND_PERSIST, 0, 4, 1&#41;;
&gt;         unless &#40;$self-&gt;_Send&#40;$fp, $req&#41;&#41; {
&gt;           $self-&gt;{_connerror} = 1;
&gt;             $self-&gt;_Error&#40;&#34;error while set persistent connection&#34;&#41;;
&gt;             return 0;
&gt;         }
&gt;         $self-&gt;{_socket} = $fp;
&gt;     }
</div>580d614
&lt;
582,585c616,622
&lt;       defined&#40;$fp-&gt;read&#40;$header, 8, 0&#41;&#41; or do {
&lt;           $self-&gt;_Error&#40;&#34;read failed: $!&#34;&#41;;
&lt;           return 0;
&lt;       };
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     my $resp = $fp-&gt;read&#40;$header, 8, 0&#41;;
&gt;     if &#40;!defined&#40;$resp&#41; || $resp==0&#41; {
&gt;         close $self-&gt;{_socket};
&gt;         undef $self-&gt;{_socket};
&gt;         $self-&gt;_Error&#40;&#34;read failed: $!&#34;&#41;;
&gt;         return 0;
&gt;     }
</div>593c630
&lt;         my $response = q{};
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     my $response = q{};
</div>638a676,696
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; #-----------------------------------------------
&gt; # connect to searchd, send request and get data
&gt;
&gt; sub _ProcessRequest {
&gt;     my &#40;$self,$req&#41; = @_;
&gt;     return unless $req;
&gt;     my $tries = $self-&gt;{_connectretries} + 1;
&gt;     while&#40; $tries-- &#41; {
&gt;         my $fp = $self-&gt;_Connect;
&gt;         if &#40;! $fp&#41; {
&gt;             next if $self-&gt;IsConnectError;
&gt;             last;
&gt;         }
&gt;         $self-&gt;_Send&#40;$fp, $req&#41; or next;
&gt;         my $response = $self-&gt;_GetResponse &#40;$fp, VER_COMMAND_SEARCH&#41;;
&gt;         return $response if $response;
&gt;     }
&gt;     $self-&gt;_Error&#40;$self-&gt;GetLastError . &#34;... ConnectRetries exceed...&#34;&#41; if $self-&gt;IsConnectError;
&gt;     return 0;
&gt; }
&gt;
</div>1525,1526d1582
&lt;     my $fp = $self-&gt;_Connect&#40;&#41; or do { $self-&gt;{_reqs} = []; return };
&lt;
1533,1534c1589
&lt;     $self-&gt;_Send&#40;$fp, $req&#41;;
&lt;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     my $response = $self-&gt;_ProcessRequest&#40;$req&#41;;
</div>1536,1537d1590
&lt;
&lt;     my $response = $self-&gt;_GetResponse &#40; $fp, VER_COMMAND_SEARCH &#41;;
1736d1788
&lt;         my $fp = $self-&gt;_Connect&#40;&#41; or return;
1801,1803c1853,1854
&lt;       $self-&gt;_Send&#40;$fp, $req&#41;;
&lt;
&lt;       my $response = $self-&gt;_GetResponse&#40;$fp, VER_COMMAND_EXCERPT&#41; or return;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     my $response = $self-&gt;_ProcessRequest&#40;$req&#41;;
&gt;     return unless $response;
</div>1855d1905
&lt;     my $fp = $self-&gt;_Connect&#40;&#41; or return;
1867,1868c1917
&lt;     $self-&gt;_Send&#40;$fp, $req&#41;;
&lt;     my $response = $self-&gt;_GetResponse &#40; $fp, VER_COMMAND_KEYWORDS &#41;;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     my $response = $self-&gt;_ProcessRequest&#40;$req&#41;;
</div>2008d2056
&lt;     my $fp = $self-&gt;_Connect&#40;&#41; or return;
2011c2059
&lt;     send &#40; $fp, $req, 0&#41;;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     my $response = $self-&gt;_ProcessRequest&#40;$req&#41;;
</div>2013d2060
&lt;     my $response = $self-&gt;_GetResponse &#40; $fp, VER_COMMAND_UPDATE &#41;;
2037c2084
&lt;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     $self-&gt;{_persistent} = 1;
</div>2043,2047d2089
&lt;
&lt;     my $req = pack&#40;&#34;nnNN&#34;, SEARCHD_COMMAND_PERSIST, 0, 4, 1&#41;;
&lt;     $self-&gt;_Send&#40;$fp, $req&#41; or return 0;
&lt;
&lt;     $self-&gt;{_socket} = $fp;
2062a2105
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     $self-&gt;{_persistent} = 0;
</div>2088,2089d2130
&lt;
&lt;     my $fp = $self-&gt;_Connect&#40;&#41; or return;
2092,2093c2133,2134
&lt;     $self-&gt;_Send&#40;$fp, $req&#41; or return;
&lt;     my $response = $self-&gt;_GetResponse &#40; $fp, VER_COMMAND_STATUS &#41;;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt;     my $response = $self-&gt;_ProcessRequest&#40;$req&#41;;
</div>2124,2125d2164
&lt;
&lt;     my $fp = $self-&gt;_Connect&#40;&#41; or return;
2128,2129c2167
&lt;     $self-&gt;_Send&#40;$fp, $req&#41; or return;
&lt;     my $response = $self-&gt;_GetResponse &#40; $fp, VER_COMMAND_FLUSHATTRS &#41;;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     my $response = $self-&gt;_ProcessRequest&#40;$req&#41;;
</div>
==========================================
END DIFF
========================================

Will you insert this implement to module?

WBR. Aleksey.






06 сентября 2011, 16:29 от &#34;Bugs in Sphinx-Search via RT&#34; &lt;bug-Sphinx-Search@rt.cpan.org&gt;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Greetings,
&gt; 
&gt; This message has been automatically generated in response to the
&gt; creation of a trouble ticket regarding:
&gt;       &#34;persistent connection problem&#34;,
&gt; a summary of which appears below.
&gt; 
&gt; There is no need to reply to this message right now.  Your ticket has been
&gt; assigned an ID of [rt.cpan.org #70760].  Your ticket is accessible
&gt; on the web at:
&gt; 
&gt;     <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=70760">https://rt.cpan.org/Ticket/Display.html?id=70760</a></span>
&gt; 
&gt; Please include the string:
&gt; 
&gt;          [rt.cpan.org #70760]
&gt; 
&gt; in the subject line of all future correspondence about this issue. To do so,
&gt; you may reply to this message.
&gt; 
&gt;                         Thank you,
&gt;                         bug-Sphinx-Search@rt.cpan.org
&gt; 
&gt; -------------------------------------------------------------------------
&gt; Hi,
&gt; Thanks for your modules.
&gt; I try to use persistent connection  in Sphinx::Search module $VERSION = &#39;0.240.1&#39; .   Linux. perl v5.8.8
&gt; I think that other versions have the same problem.
&gt; It makes connecction to sphinx and keep it. 
&gt; But, when I run indexer with option --rotate and reindex data on sphinx server I catch a littele problem.
&gt; Some first queries fails with: &#34;read failed:&#34; and than it works fine &#40;but not in persistent connection mode&#41;.
&gt; sample code with comments:
&gt; ....
&gt; my $sph = Sph::Search-&gt;new&#40;&#41;;
&gt; $sph-&gt;SetServer&#40;$host, $port&#41;;
&gt; $sph-&gt;SetConnectTimeout&#40;$timeout&#41;;
&gt; $sph-&gt;Open&#40;&#41;;
&gt; ﻿....
&gt; my $res = $sph-&gt;Query&#40;&#39;test&#39;, &#39;test&#39;&#41;;  #this is ok 
&gt; &lt;/span&gt;$res = $sph-&gt;Query&#40;&#39;test&#39;, &#39;test&#39;&#41;; #this is ok  and work with the same socket
&gt; 
&gt; while&#40;&lt;STDIN&gt;&#41;{  # wait for reindex data on server
&gt;     last if $_ =~/\n/;
&gt; }﻿
&gt; &lt;/span&gt;$res = $sph-&gt;Query&#40;&#39;test&#39;, &#39;test&#39;&#41;; #this fails
&gt; $res = $sph-&gt;Query&#40;&#39;test&#39;, &#39;test&#39;&#41;; #this is ok, but from this point no persistent connection
&gt; .....all other queries get new sockets.
&gt; 
&gt; end code...
&gt; 
&gt; Is it possible to fix persistent connection and restore it  on fail?
&gt; and if query falls in persistent mode try to reconnect and resent failed query.
&gt; 
&gt; Thanks.
&gt; WBR. Alexey.
&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;15&nbsp;20:36:41&nbsp;2011</span>
    <span class="description">JJSCHUTZ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Alexey,

Thankyou for providing a patch.  I cannot apply it cleanly by pasting
from RT.  Could you please create the patch with &#39;diff -u&#39; and attach it
as a text file?

Are you able to write a test case that covers the problem you were having?

Regards,

-- 

Jon Schutz

On Thu Sep 15 05:59:17 2011, kholodkov@mail.ru wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I make some changes in module $VERSION = &#39;0.240.1&#39;  to fix the
&gt; problem:
&gt; 
&gt; =============================
&gt; 1. add two items to object
&gt;             _persistent     =&gt; undef,     &#39;flag - is persistent
&gt; connection mode&#39;
&gt;             _connectretries =&gt; 1;       &#39;number of reconnections if
&gt; connection fails&#39;
&gt; 2. add new method &#39; SetConnectRetries &#39; it changes value of
&gt; _connectretries;
&gt; 
&gt; 3. _ProcessRequest  -   send/resend requests to sphinx.
&gt; 
&gt; 4. Persistent connect data moved to method _Connect
&gt; ==================================================
&gt; DIFF BELOW
&gt; ================================================
&gt; 281a282,283
<div class="message-stanza open">&gt; &gt;     _persistent     =&gt; undef,
&gt; &gt;     _connectretries =&gt; 1,
</div>&gt; 490a493,510
<div class="message-stanza open">&gt; &gt; =head2 SetConnectRetries
&gt; &gt;
&gt; &gt;     $sph-&gt;SetConnectRetries&#40;$retries&#41;
&gt; &gt;
&gt; &gt; Set server connection retries &#40;in case of connection fail&#41;.
&gt; &gt;
&gt; &gt; Returns $sph.
&gt; &gt;
&gt; &gt; =cut
&gt; &gt;
&gt; &gt; sub SetConnectRetries {
&gt; &gt;     my $self = shift;
&gt; &gt;     my $retires = shift;
&gt; &gt;     croak&#40;&#34;connectretries is not numeric&#34;&#41; unless &#40;$retires =~
</div>&gt; m/$num_re/&#41;;
<div class="message-stanza open">&gt; &gt;     $self-&gt;{connectretries} = $retires;
&gt; &gt; }
&gt; &gt;
&gt; &gt;
</div>&gt; 497,501c517,524
&gt; &lt;     $fp-&gt;write&#40;$data&#41;; return 1;
&gt; &lt;     if &#40;$fp-&gt;eof || ! $fp-&gt;write&#40;$data&#41;&#41; {
&gt; &lt;       $self-&gt;_Error&#40;&#34;connection unexpectedly closed &#40;timed out?&#41;:
&gt; $!&#34;&#41;;
&gt; &lt;       $self-&gt;{_connerror} = 1;
&gt; &lt;       return 0;
&gt; ---
<div class="message-stanza open">&gt; &gt;     unless &#40; send&#40;$fp,$data,0&#41;&#41;{
&gt; &gt;         $self-&gt;_Error&#40;&#34;connection unexpectedly closed &#40;timed out?&#41;:
</div>&gt; $!&#34;&#41;;
<div class="message-stanza open">&gt; &gt;         $self-&gt;{_connerror} = 1;
&gt; &gt;         if &#40;$self-&gt;{_socket}&#41; {
&gt; &gt;             close&#40;$self-&gt;{_socket}&#41;;
&gt; &gt;             undef $self-&gt;{_socket};
&gt; &gt;         }
&gt; &gt;         return 0;
</div>&gt; 510c533
&gt; &lt;
&gt; ---
<div class="message-stanza open">&gt; &gt;     $self-&gt;_Error&#40;&#41;; #reset old errors in new connection
</div>&gt; 566,567c589,593
&gt; &lt;       $self-&gt;_Send&#40;$fp, pack&#40;&#34;N&#34;, 1&#41;&#41; or return 0;
&gt; &lt;
&gt; ---
<div class="message-stanza open">&gt; &gt;       unless &#40;$self-&gt;_Send&#40;$fp, pack&#40;&#34;N&#34;, 1&#41;&#41;&#41; {
&gt; &gt;           $self-&gt;{_connerror} = 1;
&gt; &gt;         $self-&gt;_Error&#40;&#34;error while send version&#34;&#41;;
&gt; &gt;         return 0;
&gt; &gt;     }
</div>&gt; 569c595,604
&gt; &lt;
&gt; ---
<div class="message-stanza open">&gt; &gt;
&gt; &gt;     if &#40;$self-&gt;{_persistent}&#41; {
&gt; &gt;         my $req = pack&#40;&#34;nnNN&#34;, SEARCHD_COMMAND_PERSIST, 0, 4, 1&#41;;
&gt; &gt;         unless &#40;$self-&gt;_Send&#40;$fp, $req&#41;&#41; {
&gt; &gt;           $self-&gt;{_connerror} = 1;
&gt; &gt;             $self-&gt;_Error&#40;&#34;error while set persistent connection&#34;&#41;;
&gt; &gt;             return 0;
&gt; &gt;         }
&gt; &gt;         $self-&gt;{_socket} = $fp;
&gt; &gt;     }
</div>&gt; 580d614
&gt; &lt;
&gt; 582,585c616,622
&gt; &lt;       defined&#40;$fp-&gt;read&#40;$header, 8, 0&#41;&#41; or do {
&gt; &lt;           $self-&gt;_Error&#40;&#34;read failed: $!&#34;&#41;;
&gt; &lt;           return 0;
&gt; &lt;       };
&gt; ---
<div class="message-stanza open">&gt; &gt;     my $resp = $fp-&gt;read&#40;$header, 8, 0&#41;;
&gt; &gt;     if &#40;!defined&#40;$resp&#41; || $resp==0&#41; {
&gt; &gt;         close $self-&gt;{_socket};
&gt; &gt;         undef $self-&gt;{_socket};
&gt; &gt;         $self-&gt;_Error&#40;&#34;read failed: $!&#34;&#41;;
&gt; &gt;         return 0;
&gt; &gt;     }
</div>&gt; 593c630
&gt; &lt;         my $response = q{};
&gt; ---
<div class="message-stanza open">&gt; &gt;     my $response = q{};
</div>&gt; 638a676,696
<div class="message-stanza open">&gt; &gt; #-----------------------------------------------
&gt; &gt; # connect to searchd, send request and get data
&gt; &gt;
&gt; &gt; sub _ProcessRequest {
&gt; &gt;     my &#40;$self,$req&#41; = @_;
&gt; &gt;     return unless $req;
&gt; &gt;     my $tries = $self-&gt;{_connectretries} + 1;
&gt; &gt;     while&#40; $tries-- &#41; {
&gt; &gt;         my $fp = $self-&gt;_Connect;
&gt; &gt;         if &#40;! $fp&#41; {
&gt; &gt;             next if $self-&gt;IsConnectError;
&gt; &gt;             last;
&gt; &gt;         }
&gt; &gt;         $self-&gt;_Send&#40;$fp, $req&#41; or next;
&gt; &gt;         my $response = $self-&gt;_GetResponse &#40;$fp,
</div>&gt; VER_COMMAND_SEARCH&#41;;
<div class="message-stanza open">&gt; &gt;         return $response if $response;
&gt; &gt;     }
&gt; &gt;     $self-&gt;_Error&#40;$self-&gt;GetLastError . &#34;... ConnectRetries
</div>&gt; exceed...&#34;&#41; if $self-&gt;IsConnectError;
<div class="message-stanza open">&gt; &gt;     return 0;
&gt; &gt; }
&gt; &gt;
</div>&gt; 1525,1526d1582
&gt; &lt;     my $fp = $self-&gt;_Connect&#40;&#41; or do { $self-&gt;{_reqs} = []; return
&gt; };
&gt; &lt;
&gt; 1533,1534c1589
&gt; &lt;     $self-&gt;_Send&#40;$fp, $req&#41;;
&gt; &lt;
&gt; ---
<div class="message-stanza open">&gt; &gt;     my $response = $self-&gt;_ProcessRequest&#40;$req&#41;;
</div>&gt; 1536,1537d1590
&gt; &lt;
&gt; &lt;     my $response = $self-&gt;_GetResponse &#40; $fp, VER_COMMAND_SEARCH &#41;;
&gt; 1736d1788
&gt; &lt;         my $fp = $self-&gt;_Connect&#40;&#41; or return;
&gt; 1801,1803c1853,1854
&gt; &lt;       $self-&gt;_Send&#40;$fp, $req&#41;;
&gt; &lt;
&gt; &lt;       my $response = $self-&gt;_GetResponse&#40;$fp, VER_COMMAND_EXCERPT&#41;
&gt; or return;
&gt; ---
<div class="message-stanza open">&gt; &gt;     my $response = $self-&gt;_ProcessRequest&#40;$req&#41;;
&gt; &gt;     return unless $response;
</div>&gt; 1855d1905
&gt; &lt;     my $fp = $self-&gt;_Connect&#40;&#41; or return;
&gt; 1867,1868c1917
&gt; &lt;     $self-&gt;_Send&#40;$fp, $req&#41;;
&gt; &lt;     my $response = $self-&gt;_GetResponse &#40; $fp, VER_COMMAND_KEYWORDS
&gt; &#41;;
&gt; ---
<div class="message-stanza open">&gt; &gt;     my $response = $self-&gt;_ProcessRequest&#40;$req&#41;;
</div>&gt; 2008d2056
&gt; &lt;     my $fp = $self-&gt;_Connect&#40;&#41; or return;
&gt; 2011c2059
&gt; &lt;     send &#40; $fp, $req, 0&#41;;
&gt; ---
<div class="message-stanza open">&gt; &gt;     my $response = $self-&gt;_ProcessRequest&#40;$req&#41;;
</div>&gt; 2013d2060
&gt; &lt;     my $response = $self-&gt;_GetResponse &#40; $fp, VER_COMMAND_UPDATE &#41;;
&gt; 2037c2084
&gt; &lt;
&gt; ---
<div class="message-stanza open">&gt; &gt;     $self-&gt;{_persistent} = 1;
</div>&gt; 2043,2047d2089
&gt; &lt;
&gt; &lt;     my $req = pack&#40;&#34;nnNN&#34;, SEARCHD_COMMAND_PERSIST, 0, 4, 1&#41;;
&gt; &lt;     $self-&gt;_Send&#40;$fp, $req&#41; or return 0;
&gt; &lt;
&gt; &lt;     $self-&gt;{_socket} = $fp;
&gt; 2062a2105
<div class="message-stanza open">&gt; &gt;     $self-&gt;{_persistent} = 0;
</div>&gt; 2088,2089d2130
&gt; &lt;
&gt; &lt;     my $fp = $self-&gt;_Connect&#40;&#41; or return;
&gt; 2092,2093c2133,2134
&gt; &lt;     $self-&gt;_Send&#40;$fp, $req&#41; or return;
&gt; &lt;     my $response = $self-&gt;_GetResponse &#40; $fp, VER_COMMAND_STATUS &#41;;
&gt; ---
<div class="message-stanza open">&gt; &gt;
&gt; &gt;     my $response = $self-&gt;_ProcessRequest&#40;$req&#41;;
</div>&gt; 2124,2125d2164
&gt; &lt;
&gt; &lt;     my $fp = $self-&gt;_Connect&#40;&#41; or return;
&gt; 2128,2129c2167
&gt; &lt;     $self-&gt;_Send&#40;$fp, $req&#41; or return;
&gt; &lt;     my $response = $self-&gt;_GetResponse &#40; $fp, VER_COMMAND_FLUSHATTRS
&gt; &#41;;
&gt; ---
<div class="message-stanza open">&gt; &gt;     my $response = $self-&gt;_ProcessRequest&#40;$req&#41;;
</div>&gt; 
&gt; ==========================================
&gt; END DIFF
&gt; ========================================
&gt; 
&gt; Will you insert this implement to module?
&gt; 
&gt; WBR. Aleksey.
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 06 сентября 2011, 16:29 от &#34;Bugs in Sphinx-Search via RT&#34; &lt;bug-Sphinx-
&gt; Search@rt.cpan.org&gt;:
<div class="message-stanza open">&gt; &gt;
&gt; &gt; Greetings,
&gt; &gt;
&gt; &gt; This message has been automatically generated in response to the
&gt; &gt; creation of a trouble ticket regarding:
&gt; &gt;     &#34;persistent connection problem&#34;,
&gt; &gt; a summary of which appears below.
&gt; &gt;
&gt; &gt; There is no need to reply to this message right now.  Your ticket
</div>&gt; has been
<div class="message-stanza open">&gt; &gt; assigned an ID of [rt.cpan.org #70760].  Your ticket is accessible
&gt; &gt; on the web at:
&gt; &gt;
&gt; &gt;     <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=70760">https://rt.cpan.org/Ticket/Display.html?id=70760</a></span>
&gt; &gt;
&gt; &gt; Please include the string:
&gt; &gt;
&gt; &gt;          [rt.cpan.org #70760]
&gt; &gt;
&gt; &gt; in the subject line of all future correspondence about this issue.
</div>&gt; To do so,
<div class="message-stanza open">&gt; &gt; you may reply to this message.
&gt; &gt;
&gt; &gt;                         Thank you,
&gt; &gt;                         bug-Sphinx-Search@rt.cpan.org
&gt; &gt;
&gt; &gt;
</div>&gt; -------------------------------------------------------------------------
<div class="message-stanza open">&gt; &gt; Hi,
&gt; &gt; Thanks for your modules.
&gt; &gt; I try to use persistent connection  in Sphinx::Search module
</div>&gt; $VERSION = &#39;0.240.1&#39; .   Linux. perl v5.8.8
<div class="message-stanza open">&gt; &gt; I think that other versions have the same problem.
&gt; &gt; It makes connecction to sphinx and keep it. 
&gt; &gt; But, when I run
</div>&gt; indexer with option --rotate and reindex data on sphinx server I catch
&gt; a littele problem.
<div class="message-stanza open">&gt; &gt; Some first queries fails with: &#34;read failed:&#34; and than it works fine
</div>&gt; &#40;but not in persistent connection mode&#41;.
<div class="message-stanza open">&gt; &gt; sample code with comments:
&gt; &gt; ....
&gt; &gt; my $sph = Sph::Search-&gt;new&#40;&#41;;
&gt; &gt; $sph-&gt;SetServer&#40;$host, $port&#41;;
&gt; &gt; $sph-&gt;SetConnectTimeout&#40;$timeout&#41;;
&gt; &gt; $sph-&gt;Open&#40;&#41;;
&gt; &gt; ﻿....
&gt; &gt; my $res = $sph-&gt;Query&#40;&#39;test&#39;, &#39;test&#39;&#41;;  #this is ok 
&gt; &gt; &lt;/span&gt;$res =
</div>&gt; $sph-&gt;Query&#40;&#39;test&#39;, &#39;test&#39;&#41;; #this is ok  and work with the same
&gt; socket
<div class="message-stanza open">&gt; &gt;
&gt; &gt; while&#40;&lt;STDIN&gt;&#41;{  # wait for reindex data on server
&gt; &gt;     last if $_ =~/\n/;
&gt; &gt; }﻿
&gt; &gt; &lt;/span&gt;$res = $sph-&gt;Query&#40;&#39;test&#39;, &#39;test&#39;&#41;; #this fails
&gt; &gt; $res = $sph-&gt;Query&#40;&#39;test&#39;, &#39;test&#39;&#41;; #this is ok, but from this point
</div>&gt; no persistent connection
<div class="message-stanza open">&gt; &gt; .....all other queries get new sockets.
&gt; &gt;
&gt; &gt; end code...
&gt; &gt;
&gt; &gt; Is it possible to fix persistent connection and restore it  on fail?
&gt; &gt; and if query falls in persistent mode try to reconnect and resent
</div>&gt; failed query.
<div class="message-stanza open">&gt; &gt;
&gt; &gt; Thanks.
&gt; &gt; WBR. Alexey.
&gt; &gt;
&gt; &gt;
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;15&nbsp;20:36:42&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;19&nbsp;03:47:09&nbsp;2011</span>
    <span class="description">holodkov [...] corp.mail.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #70760] persistent connection problem </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 19 Sep 2011 11:46:56 +0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sphinx-Search [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> holodkov [...] corp.mail.ru</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Jon,
I can&#39;t  write perl test which can show this problem because of shinx &#40;or emulator&#41; needed while test.
But i write simple script  whith comment &#40;in attachments&#41;.
You need to add sphinx host, port and test query to this script.
Script open persistent connection, makes 4 queries to sphinx and than wait. You should broke connection&#40; reindex with rotate or stop and start sphinx&#41; than press &#34;Enter&#34;. 
The script makes  6 more queries. if request successful it prints total found, else Last_Error.
You can use 2 ways to see problem use trace and look on system calls to find open ports.
Or just add print $fp.&#34;\n&#34;; in _GetResponse function in Sphinx::Search module. It helps you to see descriptor of open port.
 
Than you&#39;ll see that first 4 queries opens only 1 descriptor,&#40;this is correct&#41;,
but after stop/start sphinx 6-th query falls with read failed and 7-10 open&#39;s their own ports for queries&#40;it&#39;s not correct for persistent mode&#41;.
 
after patch module open persistent connection after fail and resend last query
and 6-10 queries open only 1 port. 
 

 
You can find 2 files in attachments&#40;patch and simple script&#41;

./Search.pm - old module
./Sphinx/Search.pm -new


WBR. Alexey.

16 сентября 2011, 04:36 от &#34;Jon Schutz via RT&#34; &lt;bug-Sphinx-Search@rt.cpan.org&gt;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=70760">https://rt.cpan.org/Ticket/Display.html?id=70760</a></span> &gt;
&gt; 
&gt; Hi Alexey,
&gt; 
&gt; Thankyou for providing a patch.  I cannot apply it cleanly by pasting
&gt; from RT.  Could you please create the patch with &#39;diff -u&#39; and attach it
&gt; as a text file?
&gt; 
&gt; Are you able to write a test case that covers the problem you were having?
&gt; 
&gt; Regards,
&gt; 
&gt; --
&gt; 
&gt; Jon Schutz
&gt; 
</div></div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/979018/509628/patch.sphinx_module">Download patch.sphinx_module</a><br />
<span class="downloadcontenttype">application/octet-stream 7.2k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;28&nbsp;01:40:12&nbsp;2011</span>
    <span class="description">kholodkov [...] mail.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #70760] persistent connection problem </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 28 Nov 2011 10:40:02 +0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sphinx-Search [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Алексей Холодков &lt;kholodkov [...] mail.ru&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, Jon,
Is it possible to fix this issue?
WBR. Aleksey.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;28&nbsp;01:46:22&nbsp;2011</span>
    <span class="description">jon.schutz [...] youramigo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #70760] persistent connection problem</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 28 Nov 2011 17:16:02 +1030</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sphinx-Search [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jon Schutz &lt;jon.schutz [...] youramigo.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry, it&#39;s been delayed as I&#39;ve been fully committed on other tasks. 
Unfortunately it&#39;s not as simple as applying your patch as I&#39;d need to
rework the patch for the latest version and then test.  If you had a
tested patch against 0.26.1 I might be able to get it out quicker.

Thanks again for doing the patching.

On 28/11/11 17:10, Алексей Холодков via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Sphinx-Search
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=70760">https://rt.cpan.org/Ticket/Display.html?id=70760</a></span> &gt;
&gt;
&gt; Hi, Jon,
&gt; Is it possible to fix this issue?
&gt; WBR. Aleksey.
</div>
-- 
Jon Schutz
CTO, YourAmigo Ltd
53 Gilbert St
Adelaide SA 5000
Ph:  +61 8 82119211
Fax: +61 8 8211 6356
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.youramigo.com">http://www.youramigo.com</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;10&nbsp;09:44:18&nbsp;2012</span>
    <span class="description">kholodkov [...] mail.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re[2]: [rt.cpan.org #70760] persistent connection problem</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 10 Mar 2012 18:44:05 +0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sphinx-Search [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Алексей Холодков &lt;kholodkov [...] mail.ru&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, Jon,

Sorry for delay. 
I attach patch file for module 0.27.1, the latesv version at the moment.
will you run test&#39;s on resulting module?
the changes the same as in previous version.

WBR, Aleksey.

28 ноября 2011, 10:46 от &#34;jon.schutz@youramigo.com via RT&#34; &lt;bug-Sphinx-Search@rt.cpan.org&gt;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=70760">https://rt.cpan.org/Ticket/Display.html?id=70760</a></span> &gt;
&gt; 
&gt; Sorry, it&#39;s been delayed as I&#39;ve been fully committed on other tasks.
&gt; Unfortunately it&#39;s not as simple as applying your patch as I&#39;d need to
&gt; rework the patch for the latest version and then test.  If you had a
&gt; tested patch against 0.26.1 I might be able to get it out quicker.
&gt; 
&gt; Thanks again for doing the patching.
&gt; 
&gt; On 28/11/11 17:10, Алексей Холодков via RT wrote:
<div class="message-stanza open">&gt; &gt;        Queue: Sphinx-Search
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=70760">https://rt.cpan.org/Ticket/Display.html?id=70760</a></span> &gt;
&gt; &gt;
&gt; &gt; Hi, Jon,
&gt; &gt; Is it possible to fix this issue?
&gt; &gt; WBR. Aleksey.
</div>&gt; 
&gt; --
&gt; Jon Schutz
&gt; CTO, YourAmigo Ltd
&gt; 53 Gilbert St
&gt; Adelaide SA 5000
&gt; Ph:  +61 8 82119211
&gt; Fax: +61 8 8211 6356
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.youramigo.com">http://www.youramigo.com</a></span>
&gt; 
&gt; 
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1048465/548011/patch.027.1">Download patch.027.1</a><br />
<span class="downloadcontenttype">application/octet-stream 7.4k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;18&nbsp;03:38:38&nbsp;2012</span>
    <span class="description">jon.schutz [...] youramigo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #70760] persistent connection problem</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 18 Mar 2012 18:08:20 +1030</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sphinx-Search [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jon Schutz &lt;jon.schutz [...] youramigo.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Alexey,

I have incorporated your patch with a minor change to _ProcessRequest -
it needs the correct client version for the type of command it&#39;s
handling.  Version 0.27.2 has been uploaded to CPAN.  Thanks for your
contribution.

Regards,

-- 
Jon Schutz
CTO, YourAmigo Ltd
53 Gilbert St
Adelaide SA 5000
Ph:  +61 8 82119211
Fax: +61 8 8211 6356
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.youramigo.com">http://www.youramigo.com</a></span>



On 03/11/2012 01:14 AM, Алексей Холодков via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Sphinx-Search
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=70760">https://rt.cpan.org/Ticket/Display.html?id=70760</a></span> &gt;
&gt;
&gt; Hi, Jon,
&gt;
&gt; Sorry for delay. 
&gt; I attach patch file for module 0.27.1, the latesv version at the moment.
&gt; will you run test&#39;s on resulting module?
&gt; the changes the same as in previous version.
&gt;
&gt; WBR, Aleksey.
&gt;
&gt; 28 ноября 2011, 10:46 от &#34;jon.schutz@youramigo.com via RT&#34; &lt;bug-Sphinx-Search@rt.cpan.org&gt;:
<div class="message-stanza open">&gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=70760">https://rt.cpan.org/Ticket/Display.html?id=70760</a></span> &gt;
&gt;&gt;
&gt;&gt; Sorry, it&#39;s been delayed as I&#39;ve been fully committed on other tasks.
&gt;&gt; Unfortunately it&#39;s not as simple as applying your patch as I&#39;d need to
&gt;&gt; rework the patch for the latest version and then test.  If you had a
&gt;&gt; tested patch against 0.26.1 I might be able to get it out quicker.
&gt;&gt;
&gt;&gt; Thanks again for doing the patching.
&gt;&gt;
&gt;&gt; On 28/11/11 17:10, Алексей Холодков via RT wrote:
<div class="message-stanza open">&gt;&gt;&gt;        Queue: Sphinx-Search
&gt;&gt;&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=70760">https://rt.cpan.org/Ticket/Display.html?id=70760</a></span> &gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Hi, Jon,
&gt;&gt;&gt; Is it possible to fix this issue?
&gt;&gt;&gt; WBR. Aleksey.
</div>&gt;&gt; --
&gt;&gt; Jon Schutz
&gt;&gt; CTO, YourAmigo Ltd
&gt;&gt; 53 Gilbert St
&gt;&gt; Adelaide SA 5000
&gt;&gt; Ph:  +61 8 82119211
&gt;&gt; Fax: +61 8 8211 6356
&gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.youramigo.com">http://www.youramigo.com</a></span>
&gt;&gt;
&gt;&gt;
</div></div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;05&nbsp;19:49:19&nbsp;2012</span>
    <span class="description">JJSCHUTZ [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
