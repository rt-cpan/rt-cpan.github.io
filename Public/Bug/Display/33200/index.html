<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #33200 for Catalyst-Authentication-Store-LDAP: lookup_user chokes on array in user_field</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #33200 for Catalyst-Authentication-Store-LDAP: lookup_user chokes on array in user_field</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Catalyst-Authentication-Store-LDAP/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Catalyst-Authentication-Store-LDAP/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Catalyst-Authentication-Store-LDAP/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Catalyst-Authentication-Store-LDAP/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Catalyst-Authentication-Store-LDAP">Catalyst-Authentication-Store-LDAP CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">33200</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Catalyst-Authentication-Store-LDAP/Active/">Catalyst-Authentication-Store-LDAP</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">karman [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
andreas.marienborg [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-220546-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.1000    </td>
  </tr>
  <tr id="CF-220547-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;13&nbsp;02:00:00&nbsp;2008</span>
    <span class="description">andreas.marienborg [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> lookup_user chokes on array in user_field</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">user_field can, according to the documentation, be an array of fields
that can be the userid. This chokes in lookup_user with:

&#34;LDAP claims &#39;ARRAY0xBEEFCAKE&#39; equals &#39;some_user_id&#39; but results entry
does not match.&#34;

the attached patch includes a test-case for this, and a patch to
lookup_user to check each of the userfields if user_fields is an array.

If you need it some other way, or better tests or whatever, let me know.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> catalyst-authentication-store-ldap-array-user-field.01.diff</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -urN Catalyst-Authentication-Store-LDAP-0.1000.orig/lib/Catalyst/Authentication/Store/LDAP/Backend.pm Catalyst-Authentication-Store-LDAP-0.1000/lib/Catalyst/Authentication/Store/LDAP/Backend.pm
--- Catalyst-Authentication-Store-LDAP-0.1000.orig/lib/Catalyst/Authentication/Store/LDAP/Backend.pm	2008-02-13 07:52:05.000000000 +0100
+++ Catalyst-Authentication-Store-LDAP-0.1000/lib/Catalyst/Authentication/Store/LDAP/Backend.pm	2008-02-13 07:55:42.000000000 +0100
@@ -315,10 +315,25 @@
     # a little extra sanity check with the &#39;eq&#39; since LDAP already
     # says it matches.
     if &#40; defined&#40;$entry&#41; &#41; {
-        unless &#40; $entry-&gt;get_value&#40;$user_field&#41; eq $id &#41; {
-            Catalyst::Exception-&gt;throw&#40;
-                &#34;LDAP claims &#39;$user_field&#39; equals &#39;$id&#39; but results entry does not match.&#34;
-            &#41;;
+        if &#40;ref&#40;$user_field&#41; eq &#39;ARRAY&#39;&#41; {
+            # userfield can be an array, lets check each one
+            my $match = 0;
+            foreach my $f &#40;@$user_field&#41; {
+                if &#40;$entry-&gt;get_value&#40;$f&#41; eq $id&#41; {
+                    $match = 1;
+                }
+            }
+            unless &#40;$match&#41; {
+                Catalyst::Exception-&gt;throw&#40;
+                    &#34;LDAP claims &#39;$user_field&#39; equals &#39;$id&#39; but results entry does not match.&#34;
+                &#41;;                
+            }
+        } else {
+            unless &#40; $entry-&gt;get_value&#40;$user_field&#41; eq $id &#41; {
+                Catalyst::Exception-&gt;throw&#40;
+                    &#34;LDAP claims &#39;$user_field&#39; equals &#39;$id&#39; but results entry does not match.&#34;
+                &#41;;
+            }            
         }
         $userentry = $entry;
     }
diff -urN Catalyst-Authentication-Store-LDAP-0.1000.orig/t/04-array_user_field.t Catalyst-Authentication-Store-LDAP-0.1000/t/04-array_user_field.t
--- Catalyst-Authentication-Store-LDAP-0.1000.orig/t/04-array_user_field.t	1970-01-01 01:00:00.000000000 +0100
+++ Catalyst-Authentication-Store-LDAP-0.1000/t/04-array_user_field.t	2008-02-13 07:54:19.000000000 +0100
@@ -0,0 +1,37 @@
+#!/usr/bin/perl
+
+use strict;
+use warnings;
+use Catalyst::Exception;
+
+use Test::More tests =&gt; 5;
+use lib &#39;t/lib&#39;;
+use LDAPTest;
+my $server = LDAPTest::spawn_server&#40;&#41;;
+
+use_ok&#40;&#34;Catalyst::Authentication::Store::LDAP::Backend&#34;&#41;;
+
+my $back = Catalyst::Authentication::Store::LDAP::Backend-&gt;new&#40;
+    {   &#39;ldap_server&#39; =&gt; LDAPTest::server_host&#40;&#41;,
+
+        # can test the timeout SKIP with this
+        &#39;ldap_server_options&#39; =&gt;
+            { timeout =&gt; -1, debug =&gt; $ENV{PERL_DEBUG} || 0 },
+
+        &#39;binddn&#39;      =&gt; &#39;anonymous&#39;,
+        &#39;bindpw&#39;      =&gt; &#39;dontcarehow&#39;,
+        &#39;start_tls&#39;   =&gt; 0,
+        &#39;user_basedn&#39; =&gt; &#39;ou=foobar&#39;,
+        &#39;user_filter&#39; =&gt; &#39;&#40;&#38;&#40;objectClass=person&#41;&#40;uid=%s&#41;&#41;&#39;,
+        &#39;user_scope&#39;  =&gt; &#39;one&#39;,
+        &#39;user_field&#39;  =&gt; [qw&#40;uid displayName&#41;],
+        &#39;use_roles&#39;   =&gt; 0,
+    }
+&#41;;
+
+isa_ok&#40; $back, &#34;Catalyst::Authentication::Store::LDAP::Backend&#34; &#41;;
+ok&#40; my $user = $back-&gt;find_user&#40; { username =&gt; &#39;somebody&#39; } &#41;, &#34;find_user&#34; &#41;;
+isa_ok&#40; $user, &#34;Catalyst::Authentication::Store::LDAP::User&#34; &#41;;
+my $displayname = $user-&gt;displayname;
+cmp_ok&#40; $displayname, &#39;eq&#39;, &#39;Some Body&#39;, &#39;Should be Some Body&#39; &#41;;
+
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;13&nbsp;22:46:40&nbsp;2008</span>
    <span class="description">peter [...] peknet.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #33200] lookup_user chokes on array in user_field</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 13 Feb 2008 21:45:38 -0600</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Catalyst-Authentication-Store-LDAP [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Karman &lt;peter [...] peknet.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">

Andreas Marienborg via RT wrote on 2/13/08 1:00 AM:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Wed Feb 13 02:00:00 2008: Request 33200 was acted upon.
&gt; Transaction: Ticket created by ANDREMAR
&gt;        Queue: Catalyst-Authentication-Store-LDAP
&gt;      Subject: lookup_user chokes on array in user_field
&gt;    Broken in: 0.1000
&gt;     Severity: &#40;no value&#41;
&gt;        Owner: Nobody
&gt;   Requestors: omega@palle.net
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=33200">http://rt.cpan.org/Ticket/Display.html?id=33200</a></span> &gt;
&gt; 
&gt; 
&gt; user_field can, according to the documentation, be an array of fields
&gt; that can be the userid. This chokes in lookup_user with:
&gt; 
&gt; &#34;LDAP claims &#39;ARRAY0xBEEFCAKE&#39; equals &#39;some_user_id&#39; but results entry
&gt; does not match.&#34;
&gt; 
&gt; the attached patch includes a test-case for this, and a patch to
&gt; lookup_user to check each of the userfields if user_fields is an array.
&gt; 
&gt; If you need it some other way, or better tests or whatever, let me know.
</div>
Thanks for the patch and test.

I believe what is wrong is actually the documentation. The code was 
intentionally changed in the 0.1000 release, and this feature added in its place:

<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~karman/Catalyst-Authentication-Store-LDAP-0.1000/lib/Catalyst/Authentication/Store/LDAP.pm#user_results_filter">http://search.cpan.org/~karman/Catalyst-Authentication-Store-LDAP-0.1000/lib/Catalyst/Authentication/Store/LDAP.pm#user_results_filter</a></span>

The email thread that led to the change is here:

<span class="clickylink"><a target="new" rel="nofollow" href="http://lists.scsys.co.uk/pipermail/catalyst-dev/2008-January/001017.html">http://lists.scsys.co.uk/pipermail/catalyst-dev/2008-January/001017.html</a></span>

Please let me know if the new API just doesn&#39;t make sense to you. I will fix the 
documentation and note in the Changes file.

-- 
Peter Karman  .  <span class="clickylink"><a target="new" rel="nofollow" href="http://peknet.com/">http://peknet.com/</a></span>  .  peter@peknet.com
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;13&nbsp;22:46:42&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;14&nbsp;02:52:46&nbsp;2008</span>
    <span class="description">andreas.marienborg [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #33200] lookup_user chokes on array in user_field</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 14 Feb 2008 08:51:50 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Catalyst-Authentication-Store-LDAP [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Andreas Marienborg &lt;omega [...] palle.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On Feb 14, 2008, at 4:46 AM, peter@peknet.com via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=33200">http://rt.cpan.org/Ticket/Display.html?id=33200</a></span> &gt;
&gt;
&gt;
&gt;
&gt; Andreas Marienborg via RT wrote on 2/13/08 1:00 AM:
<div class="message-stanza open">&gt;&gt; Wed Feb 13 02:00:00 2008: Request 33200 was acted upon.
&gt;&gt; Transaction: Ticket created by ANDREMAR
&gt;&gt;       Queue: Catalyst-Authentication-Store-LDAP
&gt;&gt;     Subject: lookup_user chokes on array in user_field
&gt;&gt;   Broken in: 0.1000
&gt;&gt;    Severity: &#40;no value&#41;
&gt;&gt;       Owner: Nobody
&gt;&gt;  Requestors: omega@palle.net
&gt;&gt;      Status: new
&gt;&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=33200">http://rt.cpan.org/Ticket/Display.html?id=33200</a></span> &gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; user_field can, according to the documentation, be an array of fields
&gt;&gt; that can be the userid. This chokes in lookup_user with:
&gt;&gt;
&gt;&gt; &#34;LDAP claims &#39;ARRAY0xBEEFCAKE&#39; equals &#39;some_user_id&#39; but results  
&gt;&gt; entry
&gt;&gt; does not match.&#34;
&gt;&gt;
&gt;&gt; the attached patch includes a test-case for this, and a patch to
&gt;&gt; lookup_user to check each of the userfields if user_fields is an  
&gt;&gt; array.
&gt;&gt;
&gt;&gt; If you need it some other way, or better tests or whatever, let me  
&gt;&gt; know.
</div>&gt;
&gt; Thanks for the patch and test.
&gt;
&gt; I believe what is wrong is actually the documentation. The code was
&gt; intentionally changed in the 0.1000 release, and this feature added  
&gt; in its place:
&gt;
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~karman/Catalyst-Authentication-Store-LDAP-0.1000/lib/Catalyst/Authentication/Store/LDAP.pm#user_results_filter">http://search.cpan.org/~karman/Catalyst-Authentication-Store-LDAP-0.1000/lib/Catalyst/Authentication/Store/LDAP.pm#user_results_filter</a></span>
&gt;
&gt; The email thread that led to the change is here:
&gt;
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://lists.scsys.co.uk/pipermail/catalyst-dev/2008-January/001017.html">http://lists.scsys.co.uk/pipermail/catalyst-dev/2008-January/001017.html</a></span>
&gt;
&gt; Please let me know if the new API just doesn&#39;t make sense to you. I  
&gt; will fix the
&gt; documentation and note in the Changes file.
</div>
Aha, perhaps. I think we have both mail and nsUniqueId in user_field  
for the same reason. I&#39;ll try it with only nsUniqueId and see if that  
solves my issues
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;14&nbsp;03:06:45&nbsp;2008</span>
    <span class="description">andreas.marienborg [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #33200] lookup_user chokes on array in user_field</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 14 Feb 2008 09:05:56 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Catalyst-Authentication-Store-LDAP [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Andreas Marienborg &lt;omega [...] palle.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On Feb 14, 2008, at 4:46 AM, peter@peknet.com via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=33200">http://rt.cpan.org/Ticket/Display.html?id=33200</a></span> &gt;
&gt;
&gt;
&gt;
&gt; Andreas Marienborg via RT wrote on 2/13/08 1:00 AM:
<div class="message-stanza open">&gt;&gt; Wed Feb 13 02:00:00 2008: Request 33200 was acted upon.
&gt;&gt; Transaction: Ticket created by ANDREMAR
&gt;&gt;       Queue: Catalyst-Authentication-Store-LDAP
&gt;&gt;     Subject: lookup_user chokes on array in user_field
&gt;&gt;   Broken in: 0.1000
&gt;&gt;    Severity: &#40;no value&#41;
&gt;&gt;       Owner: Nobody
&gt;&gt;  Requestors: omega@palle.net
&gt;&gt;      Status: new
&gt;&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=33200">http://rt.cpan.org/Ticket/Display.html?id=33200</a></span> &gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; user_field can, according to the documentation, be an array of fields
&gt;&gt; that can be the userid. This chokes in lookup_user with:
&gt;&gt;
&gt;&gt; &#34;LDAP claims &#39;ARRAY0xBEEFCAKE&#39; equals &#39;some_user_id&#39; but results  
&gt;&gt; entry
&gt;&gt; does not match.&#34;
&gt;&gt;
&gt;&gt; the attached patch includes a test-case for this, and a patch to
&gt;&gt; lookup_user to check each of the userfields if user_fields is an  
&gt;&gt; array.
&gt;&gt;
&gt;&gt; If you need it some other way, or better tests or whatever, let me  
&gt;&gt; know.
</div>&gt;
&gt; Thanks for the patch and test.
&gt;
&gt; I believe what is wrong is actually the documentation. The code was
&gt; intentionally changed in the 0.1000 release, and this feature added  
&gt; in its place:
&gt;
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~karman/Catalyst-Authentication-Store-LDAP-0.1000/lib/Catalyst/Authentication/Store/LDAP.pm#user_results_filter">http://search.cpan.org/~karman/Catalyst-Authentication-Store-LDAP-0.1000/lib/Catalyst/Authentication/Store/LDAP.pm#user_results_filter</a></span>
&gt;
&gt; The email thread that led to the change is here:
&gt;
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://lists.scsys.co.uk/pipermail/catalyst-dev/2008-January/001017.html">http://lists.scsys.co.uk/pipermail/catalyst-dev/2008-January/001017.html</a></span>
&gt;
&gt; Please let me know if the new API just doesn&#39;t make sense to you. I  
&gt; will fix the
&gt; documentation and note in the Changes file.
&gt;
&gt; -- 
&gt; Peter Karman  .  <span class="clickylink"><a target="new" rel="nofollow" href="http://peknet.com/">http://peknet.com/</a></span>  .  peter@peknet.com
&gt;
</div>

the use case of the OP in that thread has basicly the same scenario as  
me. We filter om mail=%s, and would like the user_field to be  
nsUniqueId, but if I try to do that, it says &#34;nsUniqueId&#34; does not  
match mail, which of course is true.

What is that bit of code there to fix? Is it just to sanity check the  
returned LDAP-entries?


- andreas
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;14&nbsp;21:04:09&nbsp;2008</span>
    <span class="description">peter [...] peknet.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #33200] lookup_user chokes on array in user_field</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 14 Feb 2008 20:03:45 -0600</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Catalyst-Authentication-Store-LDAP [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Karman &lt;peter [...] peknet.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">

Andreas Marienborg via RT wrote on 2/14/08 2:06 AM:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; the use case of the OP in that thread has basicly the same scenario as  
&gt; me. We filter om mail=%s, and would like the user_field to be  
&gt; nsUniqueId, but if I try to do that, it says &#34;nsUniqueId&#34; does not  
&gt; match mail, which of course is true.
&gt; 
&gt; What is that bit of code there to fix? Is it just to sanity check the  
&gt; returned LDAP-entries?
</div>
yes, just a sanity check. The assumption is that there is only going to be one 
exact match in the common case, when you are matching uid or username. But the 
less-common case &#40;like yours&#41; where you are matching on one field but returning 
value from another &#40;that&#39;s how I&#39;m reading your example anyway -- correct me if 
I&#39;m wrong&#41; might require post-ldap filtering. Hence the filter config feature.

If I&#39;m reading your need correctly, perhaps you could work up a patch that 
implements that feature more directly than the original loop does: match on mail 
but return a different field as the user_field. Maybe a config option?

Or perhaps the original loop is/was the most effective implementation. Convince 
me. I&#39;m just the maintainer at this point. :&#41;

-- 
Peter Karman  .  <span class="clickylink"><a target="new" rel="nofollow" href="http://peknet.com/">http://peknet.com/</a></span>  .  peter@peknet.com
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;09&nbsp;22:46:42&nbsp;2008</span>
    <span class="description">peter [...] peknet.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #33200] lookup_user chokes on array in user_field</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 09 Apr 2008 21:46:24 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Catalyst-Authentication-Store-LDAP [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Karman &lt;peter [...] peknet.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">

Andreas Marienborg via RT wrote on 2/14/08 1:52 AM:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Catalyst-Authentication-Store-LDAP
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=33200">http://rt.cpan.org/Ticket/Display.html?id=33200</a></span> &gt;
&gt; 
&gt; 
&gt; On Feb 14, 2008, at 4:46 AM, peter@peknet.com via RT wrote:
&gt; 
<div class="message-stanza open">&gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=33200">http://rt.cpan.org/Ticket/Display.html?id=33200</a></span> &gt;
&gt;&gt;
</div></div>
I just released 0.1001 which may or may not have contained the POD fix. I didn&#39;t 
remember till after uploading to pause that it wasn&#39;t noted in the Changes file, 
and I&#39;m not sure whether I actually made the change or not. svn log doesn&#39;t 
indicate I did.

Did you ever resolve your problem? Was the &#39;user_results_filter&#39; feature 
helpful? I&#39;d like to close this ticket if the issue is no longer an issue.

-- 
Peter Karman  .  <span class="clickylink"><a target="new" rel="nofollow" href="http://peknet.com/">http://peknet.com/</a></span>  .  peter@peknet.com
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;10&nbsp;00:24:34&nbsp;2008</span>
    <span class="description">Andreas Marienborg -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #33200] lookup_user chokes on array in user_field</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 10 Apr 2008 06:23:38 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Catalyst-Authentication-Store-LDAP [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Andreas Marienborg &lt;andreas.marienborg [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On Apr 10, 2008, at 4:46 AM, peter@peknet.com via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=33200">http://rt.cpan.org/Ticket/Display.html?id=33200</a></span> &gt;
&gt;
&gt;
&gt;
&gt; Andreas Marienborg via RT wrote on 2/14/08 1:52 AM:
<div class="message-stanza open">&gt;&gt;       Queue: Catalyst-Authentication-Store-LDAP
&gt;&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=33200">http://rt.cpan.org/Ticket/Display.html?id=33200</a></span> &gt;
&gt;&gt;
&gt;&gt;
&gt;&gt; On Feb 14, 2008, at 4:46 AM, peter@peknet.com via RT wrote:
&gt;&gt;
<div class="message-stanza open">&gt;&gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=33200">http://rt.cpan.org/Ticket/Display.html?id=33200</a></span> &gt;
&gt;&gt;&gt;
</div></div>&gt;
&gt; I just released 0.1001 which may or may not have contained the POD  
&gt; fix. I didn&#39;t
&gt; remember till after uploading to pause that it wasn&#39;t noted in the  
&gt; Changes file,
&gt; and I&#39;m not sure whether I actually made the change or not. svn log  
&gt; doesn&#39;t
&gt; indicate I did.
&gt;
&gt; Did you ever resolve your problem? Was the &#39;user_results_filter&#39;  
&gt; feature
&gt; helpful? I&#39;d like to close this ticket if the issue is no longer an  
&gt; issue.
</div>
Yeah, sorry for not replying

I fixed it by ditching one of the fields I think. I didn&#39;t use the  
filter, so it basically turned out to be a pure configuration error  
that was no longer allowed :&#41;

Thanks for the help!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;10&nbsp;11:53:40&nbsp;2008</span>
    <span class="description">karman [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;10&nbsp;11:53:45&nbsp;2008</span>
    <span class="description">karman [...] cpan.org -  Given to KARMAN</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
