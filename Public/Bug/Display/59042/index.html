<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #59042 for CSS-Inliner: Does not respect order of CSS rules</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #59042 for CSS-Inliner: Does not respect order of CSS rules</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/CSS-Inliner/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/CSS-Inliner/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/CSS-Inliner/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/CSS-Inliner/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/CSS-Inliner">CSS-Inliner CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">59042</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/CSS-Inliner/Active/">CSS-Inliner</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
wonko [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-229630-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2544    </td>
  </tr>
  <tr id="CF-229631-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;01&nbsp;19:52:51&nbsp;2010</span>
    <span class="description">wonko [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Does not respect order of CSS rules</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The ordering of CSS Rules is important and changing their order will
result in invalid inlining. This mainly CSS::Tiny&#39;s fault &#40;see
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=59037&#41;">https://rt.cpan.org/Ticket/Display.html?id=59037&#41;</a></span>. But we can try and
work around this using something like Tie::IxHash.

I&#39;ve attached a patch that will do this &#40;as long as you apply this patch
to CSS::Tiny - <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=59039&#41;">https://rt.cpan.org/Ticket/Display.html?id=59039&#41;</a></span>

I&#39;m also attaching a better version of t/advanced.t that tests it.
Again, this would be much easier to contribute &#40;and some other fixes
that I have in the works as well&#41; if you had a public SCM somewhere like
github.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> preserve_order.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Inliner.pm.html_without_css	2010-07-01 19:45:33.130531649 -0400
+++ Inliner.pm	2010-07-01 19:50:43.460407773 -0400
@@ -18,6 +18,7 @@
 use HTML::TreeBuilder;
 use CSS::Tiny;
 use HTML::Query &#39;query&#39;;
+use Tie::IxHash;
 
 =pod
 
@@ -167,7 +168,9 @@
   return $self-&gt;{html} unless $self-&gt;{css};
 
   #parse and store the stylesheet as a hash object
-  my $css = CSS::Tiny-&gt;read_string&#40;$self-&gt;{css}&#41;;
+  my $css = CSS::Tiny-&gt;new&#40;&#41;;
+  tie %$css, &#39;Tie::IxHash&#39;; # to preserve order of rules
+  $css-&gt;read_string&#40;$self-&gt;{css}&#41;;
 
   #we still have our tree, let&#39;s reuse it
   my $tree = $self-&gt;{html_tree};
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> advanced.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use Test::More;
use Test::LongString;
use CSS::Inliner;
plan&#40;tests =&gt; 9&#41;;

my $html = &lt;&lt;&#39;END&#39;;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Test Document&lt;/title&gt;
    &lt;style type=&#34;text/javascript&#34;&gt;
    h1 { font-size: 20px }
    h1.alert { color: red }
    h1.cool { color: blue }
    .intro { color: #555555; font-size: 10px; }
    div p { color: #123123; font-size: 8px }
    p:hover { color: yellow }
    p.poor { font-weight: lighter }
    p.rich { font-weight: bold }
    &lt;/style&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1 class=&#34;alert&#34;&gt;Lorem ipsum dolor sit amet&lt;/h1&gt;
    &lt;h1 class=&#34;cool&#34;&gt;Consectetur adipiscing elit&lt;/h1&gt;
    &lt;p class=&#34;intro&#34;&gt;Aliquam ornare luctus egestas.&lt;/p&gt;
    &lt;p&gt;Nulla vulputate tellus vitae justo luctus scelerisque accumsan nunc porta.&lt;/p&gt;
    &lt;div&gt;
      &lt;p&gt;Phasellus pharetra viverra sollicitudin. &lt;strong&gt;Vivamus ac enim ante.&lt;/strong&gt;&lt;/p&gt;
      &lt;p&gt;Nunc augue massa, &lt;em&gt;dictum id eleifend non&lt;/em&gt; posuere nec purus.&lt;/p&gt;
    &lt;/div&gt;
    &lt;p class=&#34;poor rich&#34;&gt;Luctus scelerisque accumsan nunc porta&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;
END

my $inliner = CSS::Inliner-&gt;new&#40;&#41;;
$inliner-&gt;read&#40;{html =&gt; $html}&#41;;
my $inlined = $inliner-&gt;inlinify&#40;&#41;;

contains_string&#40;$inlined, q&#40;&lt;h1 class=&#34;alert&#34; style=&#34;font-size:20px;color:red;&#34;&gt;Lorem ipsum&#41;, &#39;h1.alert rule inlined&#39;&#41;;
contains_string&#40;$inlined, q&#40;&lt;h1 class=&#34;cool&#34; style=&#34;font-size:20px;color:blue;&#34;&gt;Consectetur&#41;, &#39;h1.cool rule inlined&#39;&#41;;
contains_string&#40;$inlined, q&#40;&lt;p class=&#34;intro&#34; style=&#34;color:#555555;font-size:10px;&#34;&gt;Aliquam&#41;, &#39;.intro rule inlined&#39;&#41;;
contains_string&#40;$inlined, q&#40;&lt;p style=&#34;color:#123123;font-size:8px;&#34;&gt;Phasellus&#41;, &#39;div p rule inlined&#39;&#41;;
contains_string&#40;$inlined, q&#40;&lt;p style=&#34;color:#123123;font-size:8px;&#34;&gt;Nunc augue&#41;, &#39;div p rule inlined again&#39;&#41;;
contains_string&#40;$inlined, q&#40;&lt;p&gt;Nulla&#41;, &#39;no rule for just &#34;p&#34;&#39;&#41;;
contains_string&#40;$inlined, q&#40;&lt;p class=&#34;poor rich&#34; style=&#34;font-weight:lighter;font-weight:bold;&#34;&gt;Luctus&#41;, &#39;rich before the poor&#39;&#41;;
lacks_string&#40;$inlined, q&#40;&lt;style&#41;, &#39;no style blocks left&#39;&#41;;
lacks_string&#40;$inlined, q&#40;yellow&#41;, &#39;:hover pseudo-attribute was ignored&#39;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;16&nbsp;23:09:39&nbsp;2010</span>
    <span class="description">KAMELKEV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Michael,

  I merged this into the project.

  Please wait for internal testing and release, I intend to snapshot
very soon &#40;1 or 2 days&#41;. I need to double check that the ordering works
here.

thanks again for your contributions,

  -Kevin
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;16&nbsp;23:09:40&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;16&nbsp;23:09:40&nbsp;2010</span>
    <span class="description">KAMELKEV [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;18&nbsp;17:10:23&nbsp;2010</span>
    <span class="description">KAMELKEV [...] cpan.org -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;18&nbsp;17:13:06&nbsp;2010</span>
    <span class="description">KAMELKEV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

  After carefully reviewing this commit I think there has been an
oversight on both our parts.

  Basically we are concerned with maintaining the order of elements
within the &#34;class&#34; attribute, not concerned with maintaining the order
of the rulesets within the &lt;style&gt; container.

  Instead of using an ordered hash here instead the entire parsing model
has to be flipped upside down... otherwise this can never work for class
attribute with more than one value.

  I&#39;m thinking of the best way to do this now.

thanks,
  Kevin




On Mon Aug 16 23:09:39 2010, KAMELKEV wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Michael,
&gt; 
&gt;   I merged this into the project.
&gt; 
&gt;   Please wait for internal testing and release, I intend to snapshot
&gt; very soon &#40;1 or 2 days&#41;. I need to double check that the ordering works
&gt; here.
&gt; 
&gt; thanks again for your contributions,
&gt; 
&gt;   -Kevin
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;20&nbsp;01:38:54&nbsp;2010</span>
    <span class="description">KAMELKEV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hey,

  No you were right, this is exactly how style blocks are parsed and
applied. It&#39;s somewhat non-intuitive!

  In any case I snapshotted 2669 and released it on cpan tonight.

thanks,
  Kevin



On Wed Aug 18 17:13:06 2010, KAMELKEV wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt;   After carefully reviewing this commit I think there has been an
&gt; oversight on both our parts.
&gt; 
&gt;   Basically we are concerned with maintaining the order of elements
&gt; within the &#34;class&#34; attribute, not concerned with maintaining the order
&gt; of the rulesets within the &lt;style&gt; container.
&gt; 
&gt;   Instead of using an ordered hash here instead the entire parsing model
&gt; has to be flipped upside down... otherwise this can never work for class
&gt; attribute with more than one value.
&gt; 
&gt;   I&#39;m thinking of the best way to do this now.
&gt; 
&gt; thanks,
&gt;   Kevin
&gt; 
&gt; 
&gt; 
&gt; 
&gt; On Mon Aug 16 23:09:39 2010, KAMELKEV wrote:
<div class="message-stanza open">&gt; &gt; Hi Michael,
&gt; &gt; 
&gt; &gt;   I merged this into the project.
&gt; &gt; 
&gt; &gt;   Please wait for internal testing and release, I intend to snapshot
&gt; &gt; very soon &#40;1 or 2 days&#41;. I need to double check that the ordering works
&gt; &gt; here.
&gt; &gt; 
&gt; &gt; thanks again for your contributions,
&gt; &gt; 
&gt; &gt;   -Kevin
</div>&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;20&nbsp;01:38:55&nbsp;2010</span>
    <span class="description">KAMELKEV [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
