<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #104020 for POE-Component-Client-Keepalive: Impossible to deactivate Keepalive</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #104020 for POE-Component-Client-Keepalive: Impossible to deactivate Keepalive</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/POE-Component-Client-Keepalive/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/POE-Component-Client-Keepalive/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/POE-Component-Client-Keepalive/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/POE-Component-Client-Keepalive/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/POE-Component-Client-Keepalive">POE-Component-Client-Keepalive CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">104020</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/POE-Component-Client-Keepalive/Active/">POE-Component-Client-Keepalive</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
perl [...] pied.nu

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-26426-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-26427-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;27&nbsp;16:58:42&nbsp;2015</span>
    <span class="description">perl [...] pied.nu -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Impossible to deactivate Keepalive</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">PoCo::Client::Keepalive does more then just keep a socket alive.  It also handles DNS, connecting, etc.  This means that it is pretty dificult to use PoCo::Client::HTTP without PoCo::Client::Keepalive.

The enclosed patch will allow the Keepalive param to be equal to zero, and will respect this by never reusing a socket.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> PoCo-Client-Keepalive.deactivate.01.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Only in POE-Component-Client-Keepalive: MYMETA.json
Only in POE-Component-Client-Keepalive: MYMETA.yml
Only in POE-Component-Client-Keepalive: Makefile
Only in POE-Component-Client-Keepalive: blib
diff -rub POE-Component-Client-Keepalive-0.272/lib/POE/Component/Client/Keepalive.pm POE-Component-Client-Keepalive/lib/POE/Component/Client/Keepalive.pm
--- POE-Component-Client-Keepalive-0.272/lib/POE/Component/Client/Keepalive.pm	2014-07-08 13:54:50.000000000 -0400
+++ POE-Component-Client-Keepalive/lib/POE/Component/Client/Keepalive.pm	2015-04-24 14:51:49.868993044 -0400
@@ -1,6 +1,6 @@
 package POE::Component::Client::Keepalive;
 # vim: ts=2 sw=2 expandtab
-$POE::Component::Client::Keepalive::VERSION = &#39;0.272&#39;;
+$POE::Component::Client::Keepalive::VERSION = &#39;0.272-PG1&#39;;
 use warnings;
 use strict;
 
@@ -130,7 +130,8 @@
 
   my $max_per_host = delete&#40;$args{max_per_host}&#41; || 4;
   my $max_open     = delete&#40;$args{max_open}&#41;     || 128;
-  my $keep_alive   = delete&#40;$args{keep_alive}&#41;   || 15;
+  my $keep_alive   = delete&#40;$args{keep_alive}&#41;;
+  $keep_alive = 15 unless defined $keep_alive;
   my $timeout      = delete&#40;$args{timeout}&#41;      || 120;
   my $resolver     = delete&#40;$args{resolver}&#41;;
   my $bind_address = delete&#40;$args{bind_address}&#41;;
@@ -811,6 +812,12 @@
   my $request_key = $used-&gt;[USED_KEY];
   $self-&gt;_decrement_used_each&#40;$request_key&#41;;
 
+  if&#40; $self-&gt;[SF_KEEPALIVE] &lt;=0 &#41; {
+    DEBUG and 
+        warn &#34;$$: RECLAIM: never reuse socket&#34;;
+    goto &#38;_ka_wake_up;
+  }
+
   # Socket is closed.  We can&#39;t reuse it.
   unless &#40;defined fileno $socket&#41; {
     DEBUG and warn &#34;RECLAIM: freed socket has previously been closed&#34;;
@@ -1352,7 +1359,9 @@
 
 Programs may not want to wait a long time for a connection to be
 established.  They can set the request timeout to alter how long the
-component holds a request before generating an error.
+component holds a request before generating an error.  A keep_alive value of
+zero means that a socket will never be reused.  Note that this is not the
+same thing as setting C&lt;Connection: close&gt; in your request header.
 
   timeout      =&gt; $seconds_to_process_a_request, # defaults to 120
 
Only in POE-Component-Client-Keepalive/lib/POE/Component/Client: Keepalive.pm~
Only in POE-Component-Client-Keepalive: pm_to_blib
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;29&nbsp;15:46:37&nbsp;2015</span>
    <span class="description">perl [...] pied.nu -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This second patch adds a test for reusing vs not-reuse connections.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Philip_Gwyn-PoCo-Client-Keepalive.no-reuse.02.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -rub POE-Component-Client-Keepalive-0.272/MANIFEST POE-Component-Client-Keepalive-0.272-PG1/MANIFEST
--- POE-Component-Client-Keepalive-0.272/MANIFEST	2014-07-08 13:54:50.000000000 -0400
+++ POE-Component-Client-Keepalive-0.272-PG1/MANIFEST	2015-04-29 15:44:15.758937462 -0400
@@ -30,3 +30,5 @@
 t/51_reiss_reuse.t
 t/release-pod-coverage.t
 t/release-pod-syntax.t
+t/61_noreuse.t
diff -rub POE-Component-Client-Keepalive-0.272/dist.ini POE-Component-Client-Keepalive-0.272-PG1/dist.ini
--- POE-Component-Client-Keepalive-0.272/dist.ini	2014-07-08 13:54:50.000000000 -0400
+++ POE-Component-Client-Keepalive-0.272-PG1/dist.ini	2015-04-29 14:34:32.826397948 -0400
@@ -7,6 +7,7 @@
 Net::IP::Minimal          = 0.02
 POE                       = 1.311
 POE::Component::Resolver  = 0.917
+Test::POE::Server::TCP    = 1.14
 
 [MetaResources]
 bugtracker        = <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Public/Dist/POE-Component-Client-Keepalive/Active/">http://rt.cpan.org/Public/Dist/Display.html?Name=POE-Component-Client-Keepalive</a></span>
diff -rub POE-Component-Client-Keepalive-0.272/t/61_noreuse.t POE-Component-Client-Keepalive-0.272-PG1/t/61_noreuse.t
--- POE-Component-Client-Keepalive-0.272/t/61_noreuse.t	2015-04-29 15:43:43.067944006 -0400
+++ POE-Component-Client-Keepalive-0.272-PG1/t/61_noreuse.t	2015-04-29 15:39:21.397984969 -0400
@@ -0,0 +1,233 @@
+#!/usr/bin/perl
+# vim: ts=2 sw=2 filetype=perl expandtab
+
+# Philip Gwyn&#39;s test for never reusing a connection
+
+use warnings;
+use strict;
+
+use Test::More;
+use Test::POE::Server::TCP;
+use POE qw&#40;Filter::Stream Component::Client::HTTP&#41;;
+use HTTP::Request::Common qw&#40;GET&#41;;
+
+use_ok&#40; &#39;POE::Component::Client::Keepalive&#39; &#41;;
+
+# These connections should never be reused
+my $once = POE::Component::Client::Keepalive-&gt;new&#40; keep_alive =&gt; 0 &#41;;
+# These connections should be reused
+my $reuse = POE::Component::Client::Keepalive-&gt;new&#40; keep_alive =&gt; 10 &#41;;
+
+plan tests =&gt; 30;
+
+POE::Session-&gt;create&#40;
+  inline_states =&gt; {
+    _start =&gt; \&#38;start,
+    testd_registered =&gt; \&#38;testd_start,
+    testd_client_input =&gt; \&#38;testd_input,
+
+    first_conn     =&gt; \&#38;first_conn,
+    first_response =&gt; \&#38;first_response,
+    first_done     =&gt; \&#38;first_done,
+
+    second_conn     =&gt; \&#38;second_conn,
+    second_response =&gt; \&#38;second_response,
+    second_done     =&gt; \&#38;second_done,
+
+    third_conn     =&gt; \&#38;third_conn,
+    third_response =&gt; \&#38;third_response,
+    third_done     =&gt; \&#38;third_done,
+
+    fourth_conn     =&gt; \&#38;fourth_conn,
+    fourth_response =&gt; \&#38;fourth_response,
+    done =&gt; \&#38;done,
+  },
+  heap =&gt; {
+        once =&gt; $once,
+        reuse =&gt; $reuse
+    }
+&#41;;
+
+sub start {
+  my&#40; $kernel, $heap &#41; = @_[KERNEL, HEAP];
+  $kernel-&gt;alias_set&#40; &#39;tester&#39; &#41;;
+
+  $heap-&gt;{testd} = Test::POE::Server::TCP-&gt;spawn&#40;
+    Filter =&gt; POE::Filter::Stream-&gt;new,
+    address =&gt; &#39;localhost&#39;,
+  &#41;;
+}
+
+sub get_conn
+{
+    my&#40; $heap, $type, $event, $ctx &#41; = @_;
+    $ctx ||= {};
+
+    my $cm = $heap-&gt;{$type};
+
+    $ctx-&gt;{rid} = $cm-&gt;allocate&#40; scheme =&gt; &#39;http&#39;,
+                          addr   =&gt; &#39;localhost&#39;,
+                          port   =&gt; $heap-&gt;{port},
+                          event  =&gt; $event,
+                          context =&gt; $ctx &#41;;
+    return $ctx-&gt;{rid};
+}
+
+
+sub testd_start {
+  my &#40;$kernel, $heap&#41; = @_[KERNEL, HEAP];
+  
+  my $port = $heap-&gt;{testd}-&gt;port;
+  $heap-&gt;{port} = $port;
+
+  my $rid = get_conn&#40; $heap, &#39;once&#39;, &#39;first_conn&#39; &#41;;
+  ok&#40; $rid, &#34;Allocating first connection&#34; &#41;;
+
+};
+
+sub done {
+  pass&#40; &#39;done&#39; &#41;;
+  $_[HEAP]-&gt;{testd}-&gt;shutdown;
+  delete&#40; $_[HEAP]-&gt;{once} &#41;-&gt;shutdown;
+  delete&#40; $_[HEAP]-&gt;{reuse} &#41;-&gt;shutdown;
+}
+
+#######################################################################
+sub conn2wheel
+{
+    my&#40; $heap, $resp, $event &#41; = @_;
+
+    my $conn = $resp-&gt;{connection};
+    ok&#40; $conn, &#34;Got a connection&#34; &#41;;
+    my $wheel = $conn-&gt;start&#40;
+      Driver       =&gt; POE::Driver::SysRW-&gt;new&#40;&#41;,
+      InputEvent   =&gt; $event,
+      ErrorEvent   =&gt; &#39;got_socket_error&#39;,
+    &#41;;
+    $heap-&gt;{id2w}{ $wheel-&gt;ID } = $wheel;
+    $heap-&gt;{id2conn}{ $wheel-&gt;ID } = $conn;
+    return $wheel;
+}
+
+
+###################################
+sub first_conn {
+    my&#40; $kernel, $heap, $resp &#41; = @_[ KERNEL, HEAP, ARG0...$#_ ];
+    my $wheel = conn2wheel&#40; $heap, $resp, &#39;first_response&#39; &#41;;
+    $wheel-&gt;put&#40; &#34;first&#34; &#41;;
+}
+
+sub first_response {
+  my&#40; $kernel, $heap, $line, $id &#41; = @_[KERNEL, HEAP, ARG0..$#_];
+
+  ok&#40; $line, &#34;Got response&#34; &#41;;
+  $heap-&gt;{first} = $line;
+
+  my $wheel = delete $heap-&gt;{id2w}{$id};
+  ok&#40; $wheel, &#34; ... on a known wheel&#34; &#41;;
+  my $conn = delete $heap-&gt;{id2conn}{$id};
+  ok&#40; $conn, &#34; ... for a known request&#34; &#41;;
+
+    # give up slices so that the connection can be destroyed
+  $kernel-&gt;yield&#40; &#39;first_done&#39; &#41;;
+}
+
+sub first_done {
+  my&#40; $kernel, $heap &#41; = @_[ KERNEL, HEAP ];
+
+  my $rid = get_conn&#40; $heap, &#39;once&#39;, &#39;second_conn&#39; &#41;;
+  ok&#40; $rid, &#34;Allocating second connection&#34; &#41;;
+}
+
+###################################
+sub second_conn {
+    my&#40; $kernel, $heap, $resp &#41; = @_[ KERNEL, HEAP, ARG0...$#_ ];
+    my $wheel = conn2wheel&#40; $heap, $resp, &#39;second_response&#39; &#41;;
+    $wheel-&gt;put&#40; &#34;second&#34; &#41;;
+}
+
+sub second_response {
+  my&#40; $kernel, $heap, $line, $id &#41; = @_[KERNEL, HEAP, ARG0..$#_];
+
+  ok&#40; $line, &#34;Got response&#34; &#41;;
+  isnt&#40; $heap-&gt;{first}, $line, &#34; ... on a different connection&#34; &#41;;
+
+  my $wheel = delete $heap-&gt;{id2w}{$id};
+  ok&#40; $wheel, &#34; ... on a known wheel&#34; &#41;;
+  my $conn = delete $heap-&gt;{id2conn}{$id};
+  ok&#40; $conn, &#34; ... for a known request&#34; &#41;;
+  $kernel-&gt;yield&#40; &#39;second_done&#39; &#41;;
+}
+
+sub second_done {
+  my&#40; $kernel, $heap &#41; = @_[ KERNEL, HEAP ];
+
+  my $rid = get_conn&#40; $heap, &#39;reuse&#39;, &#39;third_conn&#39; &#41;;
+  pass&#40; &#34;Allocating third connection&#34; &#41;;
+}
+
+###################################
+sub third_conn {
+    my&#40; $kernel, $heap, $resp &#41; = @_[ KERNEL, HEAP, ARG0...$#_ ];
+    my $wheel = conn2wheel&#40; $heap, $resp, &#39;third_response&#39; &#41;;
+    $wheel-&gt;put&#40; &#34;third&#34; &#41;;
+}
+
+sub third_response {
+  my&#40; $kernel, $heap, $line, $id &#41; = @_[KERNEL, HEAP, ARG0..$#_];
+
+  ok&#40; $line, &#34;Got response&#34; &#41;;
+  $heap-&gt;{third} = $line;
+  isnt&#40; $heap-&gt;{first}, $line, &#34; ... on a different connection&#34; &#41;;
+
+  my $wheel = delete $heap-&gt;{id2w}{$id};
+  ok&#40; $wheel, &#34; ... on a known wheel&#34; &#41;;
+  my $conn = delete $heap-&gt;{id2conn}{$id};
+  ok&#40; $conn, &#34; ... for a known request&#34; &#41;;
+  $kernel-&gt;yield&#40; &#39;third_done&#39; &#41;;
+}
+
+sub third_done {
+  my&#40; $kernel, $heap &#41; = @_[ KERNEL, HEAP ];
+
+  my $rid = get_conn&#40; $heap, &#39;reuse&#39;, &#39;fourth_conn&#39; &#41;;
+  pass&#40; &#34;Allocating fourth connection&#34; &#41;;
+}
+
+###################################
+sub fourth_conn {
+    my&#40; $kernel, $heap, $resp &#41; = @_[ KERNEL, HEAP, ARG0...$#_ ];
+    my $wheel = conn2wheel&#40; $heap, $resp, &#39;fourth_response&#39; &#41;;
+    $wheel-&gt;put&#40; &#34;fourth&#34; &#41;;
+}
+
+sub fourth_response {
+  my&#40; $kernel, $heap, $line, $id &#41; = @_[KERNEL, HEAP, ARG0..$#_];
+
+  ok&#40; $line, &#34;Got response&#34; &#41;;
+  is&#40; $heap-&gt;{third}, $line, &#34; ... on the same connection&#34; &#41;;
+
+  my $wheel = delete $heap-&gt;{id2w}{$id};
+  ok&#40; $wheel, &#34; ... on a known wheel&#34; &#41;;
+  my $conn = delete $heap-&gt;{id2conn}{$id};
+  ok&#40; $conn, &#34; ... for a known request&#34; &#41;;
+  $kernel-&gt;yield&#40; &#39;done&#39; &#41;;
+}
+
+
+
+#######################################################################
+sub testd_input {
+  my &#40;$kernel, $heap, $id, $input&#41; = @_[KERNEL, HEAP, ARG0, ARG1];
+
+  my $I = $heap-&gt;{testd}-&gt;client_info&#40; $id &#41;;
+  my $info = join &#39;-&gt;&#39;, &#34;$I-&gt;{peeraddr}:$I-&gt;{peerport}&#34;, 
+                        &#34;$I-&gt;{sockaddr}:$I-&gt;{sockport}&#34;;
+  pass&#40; &#34;Input $info&#34; &#41;;
+  $heap-&gt;{testd}-&gt;send_to_client&#40; $id, &#34;$info\n&#34; &#41;;
+}
+
+#######################################################################
+POE::Kernel-&gt;run&#40;&#41;;
+pass&#40; &#34;Sane shutdown&#34; &#41;;
+exit;
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
