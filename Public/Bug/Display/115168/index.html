<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #115168 for Encode: [PATCH] Passing regex globals to decode&#40;&#41; results in wrong result</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #115168 for Encode: [PATCH] Passing regex globals to decode&#40;&#41; results in wrong result</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Encode/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Encode/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Encode/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Encode/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Encode">Encode CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">115168</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Encode/Active/">Encode</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dcollinsn [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-12062-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-12063-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;08&nbsp;10:18:27&nbsp;2016</span>
    <span class="description">dcollinsn [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] Passing regex globals to decode&#40;&#41; results in wrong result</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

In [perl #128143][0], a user reports inconsistent behavior between the following two ways to call decode:

    $x =~ s/&#40;.&#41;/$latin1-&gt;decode&#40;$1&#41;/ge
    $x =~ s/&#40;.&#41;/Encode::decode&#40;&#39;latin1&#39;, $1&#41;/ge

The issue seems to be that Encode.xs Method_decode&#40;&#41; performs some operations on src without checking to see if it is readonly or magical. Since $1 is magical, this results in incorrect data. From stepping through with GDB, it looks like the corruption doesn&#39;t happen until this line, early in encode_method&#40;&#41;:

    U8 *s = &#40;U8 *&#41; SvPV&#40;src, slen&#41;;

The attached patch will correct this issue by making a mortal copy in these cases.

Submitting to get a ticket number, patch to follow.

[0]: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.perl.org/Ticket/Display.html?id=128143">https://rt.perl.org/Ticket/Display.html?id=128143</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;08&nbsp;10:24:08&nbsp;2016</span>
    <span class="description">dcollinsn [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dcollinsn [...] gmail.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Patches attached.

I can&#39;t easily find a similar issue in encode&#40;&#41;, but I might just be using the wrong testcase.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0002-cpan-115168-Test-for-decode-1.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 1104ffa0fae19c1da34a000a0196c3cac5a70763 Mon Sep 17 00:00:00 2001
From: Dan Collins &lt;dcollinsn@gmail.com&gt;
Date: Wed, 8 Jun 2016 10:15:29 -0400
Subject: [PATCH 2/2] [cpan #115168] Test for -&gt;decode&#40;$1&#41;

Adds a testcase to decode.t for the above issue.
---
 t/decode.t | 9 +++++++--
 1 file changed, 7 insertions&#40;+&#41;, 2 deletions&#40;-&#41;

diff --git a/t/decode.t b/t/decode.t
index 77cdaba..dbbc190 100644
--- a/t/decode.t
+++ b/t/decode.t
@@ -2,8 +2,8 @@
 # $Id: decode.t,v 1.1 2013/08/29 16:47:39 dankogai Exp $
 #
 use strict;
-use Encode qw&#40;decode_utf8 FB_CROAK&#41;;
-use Test::More tests =&gt; 3;
+use Encode qw&#40;decode_utf8 FB_CROAK find_encoding decode&#41;;
+use Test::More tests =&gt; 4;
 
 sub croak_ok&#40;&#38;&#41; {
     my $code = shift;
@@ -23,3 +23,8 @@ croak_ok { Encode::decode&#40;&#39;utf-8&#39;, $orig2, FB_CROAK&#41; };
 chop&#40;my $new = $bytes . $pad&#41;;
 croak_ok { Encode::decode_utf8&#40;$new, FB_CROAK&#41; };
 
+my $latin1 = find_encoding&#40;&#39;latin1&#39;&#41;;
+$orig = &#34;\N{U+0080}&#34;;
+$orig =~ /&#40;.&#41;/;
+is&#40;$latin1-&gt;decode&#40;$1&#41;, $orig, &#39;[cpan #115168] passing magic regex globals to decode&#39;&#41;;
+
-- 
2.8.1

</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-cpan-115168-Decode-returns-wrong-data-with-magical-i.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 8ccfe4df06b47883a8fe01229137c7a1c67e165c Mon Sep 17 00:00:00 2001
From: Dan Collins &lt;dcollinsn@gmail.com&gt;
Date: Wed, 8 Jun 2016 09:52:17 -0400
Subject: [PATCH 1/2] [cpan #115168] Decode returns wrong data with magical
 inputs

In [perl #128143], a user reports inconsistent behavior between the
following two ways to call decode:

    $x =~ s/&#40;.&#41;/$latin1-&gt;decode&#40;$1&#41;/ge
    $x =~ s/&#40;.&#41;/Encode::decode&#40;&#39;latin1&#39;, $1&#41;/ge

The issue seems to be that Encode.xs Method_decode&#40;&#41; performs some
operations on src without checking to see if it is readonly or
magical. Since $1 is magical, this results in incorrect data. From
stepping through with GDB, it looks like the corruption doesn&#39;t
happen until this line, early in encode_method&#40;&#41;:

    U8 *s = &#40;U8 *&#41; SvPV&#40;src, slen&#41;;

The patch creates a mortal copy of src if it is readonly or magical.
---
 Encode.xs | 5 ++++-
 1 file changed, 4 insertions&#40;+&#41;, 1 deletion&#40;-&#41;

diff --git a/Encode.xs b/Encode.xs
index cd7f7d1..0b11e80 100644
--- a/Encode.xs
+++ b/Encode.xs
@@ -647,8 +647,11 @@ CODE:
     int check;
     SV *fallback_cb = &#38;PL_sv_undef;
     encode_t *enc = INT2PTR&#40;encode_t *, SvIV&#40;SvRV&#40;obj&#41;&#41;&#41;;
+    if &#40;SvREADONLY&#40;src&#41; || SvSMAGICAL&#40;src&#41;&#41; {
+        src = sv_mortalcopy&#40;src&#41;;
+    }
     if &#40;SvUTF8&#40;src&#41;&#41; {
-    	sv_utf8_downgrade&#40;src, FALSE&#41;;
+        sv_utf8_downgrade&#40;src, FALSE&#41;;
     }
     if &#40;SvROK&#40;check_sv&#41;&#41;{
 	fallback_cb = check_sv;
-- 
2.8.1

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;08&nbsp;16:22:33&nbsp;2016</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jun 08 10:24:08 2016, dcollinsn@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Patches attached.
&gt; 
&gt; I can&#39;t easily find a similar issue in encode&#40;&#41;, but I might just be
&gt; using the wrong testcase.
</div>
I see a slight problem with the patch, or, rather, a bug that it fails to fix.  I see you are using SvSMAGICAL, not SvGMAGICAL.  If a GMAGICAL but not SMAGICAL scalar is passed, it will get the SvUTF8 flag checked too soon, because you can’t check the flag until after stringification.

In fact, that applies to typeglobs and references as well.  So maybe we just need a void SvPV before SvUTF8 check &#40;after the ‘if’ block your patch adds&#41;, to make sure the flag has the right value.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;08&nbsp;16:22:34&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;08&nbsp;19:05:51&nbsp;2016</span>
    <span class="description">dcollinsn [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dcollinsn [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jun 08 16:22:33 2016, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I see a slight problem with the patch, or, rather, a bug that it fails
&gt; to fix.
</div>
Unsurprising. I&#39;m not really at the point where I can anticipate all the things that this might be passed, so I&#39;m really just plugging holes.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  I see you are using SvSMAGICAL, not SvGMAGICAL.  If a
&gt; GMAGICAL but not SMAGICAL scalar is passed, it will get the SvUTF8
&gt; flag checked too soon, because you can’t check the flag until after
&gt; stringification.
</div>

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; In fact, that applies to typeglobs and references as well.  So maybe
&gt; we just need a void SvPV before SvUTF8 check &#40;after the ‘if’ block
&gt; your patch adds&#41;, to make sure the flag has the right value.
</div>
Sounds like a plan.

Some creative fuzzing also found a testcase that exposes a similar problem in encode, so I&#39;m going to investigate that some more and look for other related failures before updating this ticket with a more complete patch.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;08&nbsp;20:32:01&nbsp;2016</span>
    <span class="description">dcollinsn [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dcollinsn [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jun 08 16:22:33 2016, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In fact, that applies to typeglobs and references as well.  So maybe
&gt; we just need a void SvPV before SvUTF8 check &#40;after the ‘if’ block
&gt; your patch adds&#41;, to make sure the flag has the right value.
</div>
Turns out, you need quite a bit more than that. If you pass a typeglob in &#40;why are you doing this&#41;, SvPV will give you a string representation and set SvUTF8, but doesn&#39;t actually set svu_pv - so we need a temporary copy anyway or there&#39;s no point in calling sv_utf8_downgrade.

656             SvPV&#40;src, len&#41;;
&#40;gdb&#41; p *src
$2 = {sv_any = 0xbcaae0, sv_refcnt = 5, sv_flags = 32777, sv_u = {
    svu_pv = 0xaadbb0 &#34;&#34;, svu_iv = 11197360, svu_uv = 11197360,
    svu_rv = 0xaadbb0, svu_rx = 0xaadbb0, svu_array = 0xaadbb0,
    svu_hash = 0xaadbb0, svu_gp = 0xaadbb0, svu_fp = 0xaadbb0}}
&#40;gdb&#41; n
657             is_utf8 = SvUTF8&#40;src&#41;;
&#40;gdb&#41; p *src
$3 = {sv_any = 0xbcaae0, sv_refcnt = 5, sv_flags = 536903689, sv_u = {
    svu_pv = 0xaadbb0 &#34;&#34;, svu_iv = 11197360, svu_uv = 11197360,
    svu_rv = 0xaadbb0, svu_rx = 0xaadbb0, svu_array = 0xaadbb0,
    svu_hash = 0xaadbb0, svu_gp = 0xaadbb0, svu_fp = 0xaadbb0}}

But tracking this down leads me to the question: Is $latin1-&gt;decode&#40;*b&#41; something that is supported? Because, I /can/ submit a patch that fixes that, but I don&#39;t know if it would be accepted.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;09&nbsp;01:20:01&nbsp;2016</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jun 08 20:32:01 2016, dcollinsn@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; But tracking this down leads me to the question: Is $latin1-
<div class="message-stanza open">&gt; &gt;decode&#40;*b&#41; something that is supported? Because, I /can/ submit a
</div>&gt; patch that fixes that, but I don&#39;t know if it would be accepted.
</div>
I generally follow the view that *every* scalar in Perl is a string &#40;the type depends on the use&#41;, and, since substr&#40;*b,...&#41; is supported, and any decoder written in pure-Perl would be able to handle it, -&gt;decode&#40;*b&#41; should be supported.

I think you actually need to copy and SvPV_force every input that is not SvPOK already, since sv_utf8_downgrade &#40;I just looked in sv.c&#41; is almost a no-op if SvPOK is not true.

That simple approach would Just Work for objects with string overloading too &#40;and those should definitely work as strings&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;09&nbsp;21:18:43&nbsp;2016</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jun 09 01:20:01 2016, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Jun 08 20:32:01 2016, dcollinsn@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; But tracking this down leads me to the question: Is $latin1-
<div class="message-stanza open">&gt; &gt; &gt; decode&#40;*b&#41; something that is supported? Because, I /can/ submit a
</div>&gt; &gt; patch that fixes that, but I don&#39;t know if it would be accepted.
</div>&gt; 
&gt; I generally follow the view that *every* scalar in Perl is a string
&gt; &#40;the type depends on the use&#41;, and, since substr&#40;*b,...&#41; is supported,
&gt; and any decoder written in pure-Perl would be able to handle it,
&gt; -&gt;decode&#40;*b&#41; should be supported.
&gt; 
&gt; I think you actually need to copy and SvPV_force every input that is
&gt; not SvPOK already, since sv_utf8_downgrade &#40;I just looked in sv.c&#41; is
&gt; almost a no-op if SvPOK is not true.
</div>
Gah!  I’m not thinking!  sv_copypv if !SvPOK would be a better approach.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; That simple approach would Just Work for objects with string
&gt; overloading too &#40;and those should definitely work as strings&#41;.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;09&nbsp;21:47:13&nbsp;2016</span>
    <span class="description">dcollinsn [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #115168] [PATCH] Passing regex globals to decode&#40;&#41; results in wrong result</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 9 Jun 2016 21:46:41 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Encode [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dan Collins &lt;dcollinsn [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Either works. Is

        SV *tmp;
        tmp = sv_newmortal&#40;&#41;;
        sv_copypv&#40;tmp, src&#41;;
        src = tmp;

really better than

        src = sv_mortalcopy&#40;src&#41;;
        SvPV_force_nolen&#40;src&#41;;

?

On Thu, Jun 9, 2016 at 9:18 PM, Father Chrysostomos via RT &lt;
bug-Encode@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=115168">https://rt.cpan.org/Ticket/Display.html?id=115168</a></span> &gt;
&gt;
&gt; On Thu Jun 09 01:20:01 2016, SPROUT wrote:
<div class="message-stanza open">&gt; &gt; On Wed Jun 08 20:32:01 2016, dcollinsn@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; But tracking this down leads me to the question: Is $latin1-
<div class="message-stanza open">&gt; &gt; &gt; &gt; decode&#40;*b&#41; something that is supported? Because, I /can/ submit a
</div>&gt; &gt; &gt; patch that fixes that, but I don&#39;t know if it would be accepted.
</div>&gt; &gt;
&gt; &gt; I generally follow the view that *every* scalar in Perl is a string
&gt; &gt; &#40;the type depends on the use&#41;, and, since substr&#40;*b,...&#41; is supported,
&gt; &gt; and any decoder written in pure-Perl would be able to handle it,
&gt; &gt; -&gt;decode&#40;*b&#41; should be supported.
&gt; &gt;
&gt; &gt; I think you actually need to copy and SvPV_force every input that is
&gt; &gt; not SvPOK already, since sv_utf8_downgrade &#40;I just looked in sv.c&#41; is
&gt; &gt; almost a no-op if SvPOK is not true.
</div>&gt;
&gt; Gah!  I’m not thinking!  sv_copypv if !SvPOK would be a better approach.
&gt;
<div class="message-stanza open">&gt; &gt; That simple approach would Just Work for objects with string
&gt; &gt; overloading too &#40;and those should definitely work as strings&#41;.
</div>&gt;
&gt;
&gt;
&gt;
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;09&nbsp;22:09:26&nbsp;2016</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jun 09 21:47:13 2016, dcollinsn@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Either works. Is
&gt; 
&gt;         SV *tmp;
&gt;         tmp = sv_newmortal&#40;&#41;;
&gt;         sv_copypv&#40;tmp, src&#41;;
&gt;         src = tmp;
&gt; 
&gt; really better than
&gt; 
&gt;         src = sv_mortalcopy&#40;src&#41;;
&gt;         SvPV_force_nolen&#40;src&#41;;
&gt; 
&gt; ?
</div>
SvPV_force is more complicated, so it’s slower.  In fact, for a scalar that is more that just a PV &#40;e.g., PVNV, PVIV, REGEXP, or PVGV&#41;, the new scalar ends up being heavier.  For a REGEXP or PVGV you do end up copying a more complicated data structure unnecessarily.  Also sv_copypv will stringify the original, causing uninitialized warnings to report the source SV.

I know I’m being a bit pedantic.  I’ve spent too much time looking at the perl source. :-&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;13&nbsp;13:31:21&nbsp;2016</span>
    <span class="description">dcollinsn [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dcollinsn [...] gmail.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry for the delay, just getting back from a weekend trip. Attachment 3 replaces attachments 1 and 2, and fixes the additional issues noted by Sprout and discovered while investigating his suggestions. It creates a temporary, mortal, PV copy of any input SV to either encode or decode which is read-only, which has get or set magic, or which is not POK. Tests were added for the changed behavior, and no existing tests were impacted.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0003-cpan-115168-Correct-magical-and-non-POK-inputs.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 253098cb2d33d8b10fb377f776715e807c5cbb67 Mon Sep 17 00:00:00 2001
From: Dan Collins &lt;dcollinsn@gmail.com&gt;
Date: Wed, 8 Jun 2016 10:15:29 -0400
Subject: [PATCH] [cpan #115168] Correct magical and non-POK inputs

In [perl #128143], a user reports inconsistent behavior between the
following two ways to call decode:

    $x =~ s/&#40;.&#41;/$latin1-&gt;decode&#40;$1&#41;/ge
    $x =~ s/&#40;.&#41;/Encode::decode&#40;&#39;latin1&#39;, $1&#41;/ge

The issue seems to be that Encode.xs Method_decode&#40;&#41; performs some
operations on src without checking to see if it is readonly or
magical. Since $1 is magical, this results in incorrect data. From
stepping through with GDB, it looks like the corruption doesn&#39;t
happen until this line, early in encode_method&#40;&#41;:

    U8 *s = &#40;U8 *&#41; SvPV&#40;src, slen&#41;;

For inputs that are readonly, magical, or not POK, we first create
a mortal SV, then use sv_copypv to stringify and transfer.

Encode needs to do the same thing. Currently, encode will not
accept being passed, for example, a typeglob, but decode will.
This patch brings the functions in line, and will stringify any
input that sv_pvcopy is able to.

Tests are added for both functions for both magic and typeglob inputs.
---
 Encode.xs  | 14 +++++++++++++-
 t/Encode.t | 10 +++++++++-
 t/decode.t | 11 +++++++++--
 3 files changed, 31 insertions&#40;+&#41;, 4 deletions&#40;-&#41;

diff --git a/Encode.xs b/Encode.xs
index cd7f7d1..b945eb4 100644
--- a/Encode.xs
+++ b/Encode.xs
@@ -647,8 +647,14 @@ CODE:
     int check;
     SV *fallback_cb = &#38;PL_sv_undef;
     encode_t *enc = INT2PTR&#40;encode_t *, SvIV&#40;SvRV&#40;obj&#41;&#41;&#41;;
+    if &#40;SvREADONLY&#40;src&#41; || SvSMAGICAL&#40;src&#41; || SvGMAGICAL&#40;src&#41; || !SvPOK&#40;src&#41;&#41; {
+        SV *tmp;
+        tmp = sv_newmortal&#40;&#41;;
+        sv_copypv&#40;tmp, src&#41;;
+        src = tmp;
+    }
     if &#40;SvUTF8&#40;src&#41;&#41; {
-    	sv_utf8_downgrade&#40;src, FALSE&#41;;
+        sv_utf8_downgrade&#40;src, FALSE&#41;;
     }
     if &#40;SvROK&#40;check_sv&#41;&#41;{
 	fallback_cb = check_sv;
@@ -672,6 +678,12 @@ CODE:
     int check;
     SV *fallback_cb = &#38;PL_sv_undef;
     encode_t *enc = INT2PTR&#40;encode_t *, SvIV&#40;SvRV&#40;obj&#41;&#41;&#41;;
+    if &#40;SvREADONLY&#40;src&#41; || SvSMAGICAL&#40;src&#41; || SvGMAGICAL&#40;src&#41; || !SvPOK&#40;src&#41;&#41; {
+        SV *tmp;
+        tmp = sv_newmortal&#40;&#41;;
+        sv_copypv&#40;tmp, src&#41;;
+        src = tmp;
+    }
     sv_utf8_upgrade&#40;src&#41;;
     if &#40;SvROK&#40;check_sv&#41;&#41;{
 	fallback_cb = check_sv;
diff --git a/t/Encode.t b/t/Encode.t
index d490255..55592f0 100644
--- a/t/Encode.t
+++ b/t/Encode.t
@@ -25,7 +25,7 @@ my @character_set = &#40;&#39;0&#39;..&#39;9&#39;, &#39;A&#39;..&#39;Z&#39;, &#39;a&#39;..&#39;z&#39;&#41;;
 my @source = qw&#40;ascii iso8859-1 cp1250&#41;;
 my @destiny = qw&#40;cp1047 cp37 posix-bc&#41;;
 my @ebcdic_sets = qw&#40;cp1047 cp37 posix-bc&#41;;
-plan test =&gt; 38+$n*@encodings + 2*@source*@destiny*@character_set + 2*@ebcdic_sets*256 + 6 + 5;
+plan test =&gt; 38+$n*@encodings + 2*@source*@destiny*@character_set + 2*@ebcdic_sets*256 + 6 + 5 + 2;
 my $str = join&#40;&#39;&#39;,map&#40;chr&#40;$_&#41;,0x20..0x7E&#41;&#41;;
 my $cpy = $str;
 ok&#40;length&#40;$str&#41;,from_to&#40;$cpy,&#39;iso8859-1&#39;,&#39;Unicode&#39;&#41;,&#34;Length Wrong&#34;&#41;;
@@ -164,3 +164,11 @@ $key = &#40;keys %{{ &#34;whatever&#34; =&gt; &#39;&#39; }}&#41;[0];
 $kopy = $key;
 decode&#40;&#34;UTF-16LE&#34;, $kopy, Encode::FB_CROAK&#41;;
 ok $key, &#34;whatever&#34;, &#39;decode with shared hash key scalars&#39;;
+
+my $latin1 = find_encoding&#40;&#39;latin1&#39;&#41;;
+my $orig = &#34;\316&#34;;
+$orig =~ /&#40;.&#41;/;
+ok $latin1-&gt;encode&#40;$1&#41;, $orig, &#39;[cpan #115168] passing magic regex globals to encode&#39;;
+
+*a = $orig;
+ok $latin1-&gt;encode&#40;*a&#41;, &#39;*main::&#39;.$orig, &#39;[cpan #115168] passing typeglobs to encode&#39;;
diff --git a/t/decode.t b/t/decode.t
index 77cdaba..8f7b64e 100644
--- a/t/decode.t
+++ b/t/decode.t
@@ -2,8 +2,8 @@
 # $Id: decode.t,v 1.1 2013/08/29 16:47:39 dankogai Exp $
 #
 use strict;
-use Encode qw&#40;decode_utf8 FB_CROAK&#41;;
-use Test::More tests =&gt; 3;
+use Encode qw&#40;decode_utf8 FB_CROAK find_encoding decode&#41;;
+use Test::More tests =&gt; 5;
 
 sub croak_ok&#40;&#38;&#41; {
     my $code = shift;
@@ -23,3 +23,10 @@ croak_ok { Encode::decode&#40;&#39;utf-8&#39;, $orig2, FB_CROAK&#41; };
 chop&#40;my $new = $bytes . $pad&#41;;
 croak_ok { Encode::decode_utf8&#40;$new, FB_CROAK&#41; };
 
+my $latin1 = find_encoding&#40;&#39;latin1&#39;&#41;;
+$orig = &#34;\N{U+0080}&#34;;
+$orig =~ /&#40;.&#41;/;
+is&#40;$latin1-&gt;decode&#40;$1&#41;, $orig, &#39;[cpan #115168] passing magic regex globals to decode&#39;&#41;;
+
+*a = $orig;
+is&#40;$latin1-&gt;decode&#40;*a&#41;, &#39;*main::&#39;.$orig, &#39;[cpan #115168] passing typeglobs to decode&#39;&#41;;
-- 
2.8.1

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;14&nbsp;04:02:08&nbsp;2016</span>
    <span class="description">DANKOGAI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Your patch is in:

<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/dankogai/p5-encode/commit/f37539b74f73327e6d1c85b245a064f6831edca0">https://github.com/dankogai/p5-encode/commit/f37539b74f73327e6d1c85b245a064f6831edca0</a></span>

Dan the Maintainer Thereof

On Mon Jun 13 13:31:21 2016, dcollinsn@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sorry for the delay, just getting back from a weekend trip. Attachment
&gt; 3 replaces attachments 1 and 2, and fixes the additional issues noted
&gt; by Sprout and discovered while investigating his suggestions. It
&gt; creates a temporary, mortal, PV copy of any input SV to either encode
&gt; or decode which is read-only, which has get or set magic, or which is
&gt; not POK. Tests were added for the changed behavior, and no existing
&gt; tests were impacted.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;14&nbsp;04:02:30&nbsp;2016</span>
    <span class="description">DANKOGAI [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
