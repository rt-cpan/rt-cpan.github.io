<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #24460 for DBD-Multi: PATCH: Improve performance by 25%, and docs as well.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #24460 for DBD-Multi: PATCH: Improve performance by 25%, and docs as well.</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-Multi/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-Multi/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-Multi/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-Multi/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-Multi">DBD-Multi CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">24460</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-Multi/Active/">DBD-Multi</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
MARKSTOS [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-38372-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.03    </td>
  </tr>
  <tr id="CF-38373-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.03    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;19&nbsp;17:13:03&nbsp;2007</span>
    <span class="description">MARKSTOS [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> PATCH: Improve performance by 25%, and docs as well.</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Using the attached benchmarking script, I compared the basic overhead of
using DBD::Multi for selects. The results were poor on my setup... about
212% slower, or a difference of 4,000 fewer SELECTs/second. 

By using Devel::DProf, I was able to make a number of optimizations,
bringing the difference down to... 187% slower.  The summary of the
changes include:
  - using direct hash access instead of accessors
  - caching sorts that never change. 

These changes pass the whole regression suite. I also added a number
blocks of &#34;private&#34; comments about the internal functions and data
structures. 

Further optimization could possibly be made if calls to FETCH could be
replaced by using an internal object accesses. I wasn&#39;t sure about
what&#39;s possible there, while meeting the spec for what it means to be a
DBD driver. 

I&#39;m attaching the &#34;diff&#34; of my changes, which may need the other patches
I&#39;ve previously submitted to work. 

I&#39;m also attaching the complete file in case that&#39;s helpful. 

Overall, I realize that DBD::Multi can still over significant benefit
when the performance of the database is truly the bottleneck, and not
how fast Perl&#39;s access to it is.

Still, this research indicates that use of DBD::Multi is best limited to
 places that are truly identified as &#34;hot spots&#34;. Otherwise, the use can
be counter-productive. 

   Mark
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dbd_multi_overhead.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">=head

The purpose of this script is to see how much overhead
is added by using DBD::Multi vs. a direct connection

=cut

use strict;
use Benchmark &#39;:all&#39;;

use DBI;
use DBD::Multi;
print &#34;testing with DBD::Multi $DBD::Multi::VERSION\n&#34;;
my $raw_dbh = DBI-&gt;connect&#40;&#34;dbi:Pg:dbname=saveapet_dev&#34;&#41;;

my $multi_dbh = DBI-&gt;connect&#40;&#39;dbi:Multi:&#39;, undef, undef, {
        dsns =&gt; [ 10 =&gt; $raw_dbh ]
}&#41;;


cmpthese&#40;10_000, {
    raw   =&gt; sub { $raw_dbh-&gt;selectrow_array&#40;&#34;SELECT CURRENT_DATE&#34;&#41; },
    multi =&gt; sub { $multi_dbh-&gt;selectrow_array&#40;&#34;SELECT CURRENT_DATE&#34;&#41; },
}&#41;;
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Multi.pm</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dbd-multi-optimization.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- old-saveapet-1/perllib/DBD/Multi.pm	2007-01-19 17:02:09.000000000 -0500
+++ new-saveapet-1/perllib/DBD/Multi.pm	2007-01-19 17:02:09.000000000 -0500
@@ -6,7 +6,7 @@
 
 use vars qw[$VERSION $err $errstr $sqlstate $drh];
 
-$VERSION   = &#39;0.03&#39;;
+$VERSION   = &#39;0.10&#39;;
 
 $err       = 0;        # DBI::err
 $errstr    = &#34;&#34;;       # DBI::errstr
@@ -34,7 +34,10 @@
 package DBD::Multi::dr;
 use strict;
 
+no warnings;
 $DBD::Multi::dr::imp_data_size = 0;
+use warnings;
+
 use DBD::File;
 use base qw[DBD::File::dr];
 
@@ -56,9 +59,9 @@
     my $handler = DBD::Multi::Handler-&gt;new&#40;{
         dsources =&gt; [ @dsns ],
     }&#41;;
-    $handler-&gt;failed_max&#40;$attr-&gt;{failed_max}&#41;
+    $handler-&gt;{failed_max} = $attr-&gt;{failed_max}
       if exists $attr-&gt;{failed_max};
-    $handler-&gt;failed_expire&#40;$attr-&gt;{failed_expire}&#41;
+    $handler-&gt;{failed_expire} = $attr-&gt;{failed_expire}
       if exists $attr-&gt;{failed_expire};
 
     $dbh-&gt;STORE&#40;_handler =&gt; $handler&#41;;
@@ -74,7 +77,10 @@
 package DBD::Multi::db;
 use strict;
 
+no warnings;
 $DBD::Multi::db::imp_data_size = 0;
+use warnings;
+
 use base qw[DBD::File::db];
 
 sub prepare {
@@ -142,7 +148,10 @@
 package DBD::Multi::st;
 use strict;
 
+no warnings;
 $DBD::Multi::st::imp_data_size = 0;
+use warnings;
+
 use base qw[DBD::File::st];
 
 use vars qw[@METHODS @FIELDS];
@@ -218,54 +227,74 @@
 package DBD::Multi::Handler;
 use strict;
 
-use base qw[Class::Accessor::Fast];
+sub new {
+    my &#40;$class, $args&#41;     = @_;
+    my $self               = $args;
 
-__PACKAGE__-&gt;mk_accessors&#40;qw[
-    dsources
-    nextid
-    all_dsources
-    current_dsource
-    used
-    failed
-    failed_last
-    failed_max
-    failed_expire
-]&#41;;
+    bless $self, $class;
 
-sub new {
-    my &#40;$class, $args&#41; = @_;
-    my $self     = $class-&gt;SUPER::new&#40;$args&#41;;
-    $self-&gt;nextid&#40;0&#41; unless defined $self-&gt;nextid;
-    $self-&gt;all_dsources&#40;{}&#41;;
-    $self-&gt;used&#40;{}&#41;;
-    $self-&gt;failed&#40;{}&#41;;
-    $self-&gt;failed_last&#40;{}&#41;;
-    $self-&gt;failed_max&#40;3&#41; unless defined $self-&gt;failed_max;
-    $self-&gt;failed_expire&#40;60*5&#41; unless defined $self-&gt;failed_expire;
+    $self-&gt;{nextid}        = 0 unless defined $self-&gt;{nextid};
+    $self-&gt;{all_dsources}  = {};
+    $self-&gt;{used}          = {};
+    $self-&gt;{failed}        = {};
+    $self-&gt;{failed_last}   = {};
+    $self-&gt;{failed_max}    = 3 unless defined $self-&gt;{failed_max};
+    $self-&gt;{failed_expire} = 60*5 unless defined $self-&gt;{failed_expire};
     $self-&gt;_configure_dsources;
+
     return $self;
 }
 
 sub all_sources {
     my &#40;$self&#41; = @_;
-    return values %{$self-&gt;all_dsources};
+    return values %{ $self-&gt;{all_dsources} };
 }
 
+=begin private
+
+=head2 add_to_pri
+
+  $self-&gt;add_to_pri&#40;$priority, $data_source&#41;;
+
+Given a $priority, and a $data_source, updates internal data structures
+for later use. 
+
+C&lt;all_dsources&gt; is a hashref with a structure that that looks like this:
+
+ &#39;0&#39; =&gt; $first_raw_data_source,
+ &#39;1&#39; =&gt; $second_raw_data_source,
+
+C&lt;dsources&gt; provides an alternate lookup by priority. It has a structure, like
+this:
+
+  # The top level keys are priorities
+  &#39;10&#39; =&gt; {
+            # Second level keys correspond to all_sources keys
+            # The values are always just &#34;1&#34;.
+            &#39;1&#39; =&gt; 1,
+            &#39;0&#39; =&gt; 1
+          },
+  &#39;20&#39; =&gt; {
+            &#39;2&#39; =&gt; 1
+          }
+
+=end private
+
+=cut 
+
 sub add_to_pri {
     my &#40;$self, $pri, $dsource&#41; = @_;
-    my $dsource_id = $self-&gt;nextid;
-    my $dsources   = $self-&gt;dsources;
-    my $all        = $self-&gt;all_dsources;
+    my $dsource_id = $self-&gt;{nextid};
 
-    $all-&gt;{$dsource_id} = $dsource;
-    $dsources-&gt;{$pri}-&gt;{$dsource_id} = 1;
+    $self-&gt;{all_dsources}-&gt;{$dsource_id} = $dsource;
+    $self-&gt;{dsources}-&gt;{$pri}-&gt;{$dsource_id} = 1;
 
-    $self-&gt;nextid&#40;$dsource_id + 1&#41;;
+    $self-&gt;{nextid} = $dsource_id + 1;
 }
 
 sub dbh {
     my $self = shift;
-    my $dbh = $self-&gt;_connect_dsource; 
+    my $dbh = $self-&gt;connect_dsource; 
     return $dbh if $dbh;
     $self-&gt;dbh_failed;
     $self-&gt;dbh;
@@ -274,21 +303,34 @@
 sub dbh_failed {
     my &#40;$self&#41; = @_;
 
-    my $current_dsource = $self-&gt;current_dsource;
-    $self-&gt;failed-&gt;{$current_dsource}++;
-    $self-&gt;failed_last-&gt;{$current_dsource} = time;
+    my $current_dsource = $self-&gt;{current_dsource};
+    $self-&gt;{failed}-&gt;{$current_dsource}++;
+    $self-&gt;{failed_last}-&gt;{$current_dsource} = time;
 }
 
+
+=begin private
+
+=head2 _purge_old_failures
+
+ $self-&gt;_purge_old_failures
+
+Allow sources to be considered for use again if enough time as passed.
+
+=end private
+
+=cut
+
 sub _purge_old_failures {
     my &#40;$self&#41; = @_;
     my $now = time;
-    my @all = keys %{$self-&gt;all_dsources};
+    my @all = keys %{$self-&gt;{all_dsources} };
     
-    foreach my $dsource &#40; @all &#41; {
-        next unless $self-&gt;failed-&gt;{$dsource};
-        if &#40; &#40;$now - $self-&gt;failed_last-&gt;{$dsource}&#41; &gt; $self-&gt;failed_expire &#41; {
-            delete $self-&gt;failed-&gt;{$dsource};
-            delete $self-&gt;failed_last-&gt;{$dsource};
+    for my $dsource &#40; @all &#41; {
+        next unless $self-&gt;{failed}-&gt;{$dsource};
+        if &#40; &#40;$now - $self-&gt;{failed_last}-&gt;{$dsource}&#41; &gt; $self-&gt;{failed_expire} &#41; {
+            delete $self-&gt;{failed}-&gt;{$dsource};
+            delete $self-&gt;{failed_last}-&gt;{$dsource};
         }
     }
 }
@@ -296,62 +338,110 @@
 sub _pick_dsource {
     my &#40;$self&#41; = @_;
     $self-&gt;_purge_old_failures;
-    my $dsources = $self-&gt;dsources;
-    my @pri      = sort { $a &lt;=&gt; $b } keys %{$dsources};
 
-    foreach my $pri &#40; @pri &#41; {
-        my $dsource = $self-&gt;_pick_pri_dsource&#40;$dsources-&gt;{$pri}&#41;;
+    my $dsources = $self-&gt;{dsources};
+
+    for my $pri &#40; @{ $self-&gt;{sorted_pris} } &#41; {
+        my $dsource = $self-&gt;_pick_pri_dsource&#40;$pri,$dsources-&gt;{$pri}&#41;;
         if &#40; defined $dsource &#41; {
-            $self-&gt;current_dsource&#40;$dsource&#41;;
+            $self-&gt;{current_dsource} = $dsource;
             return;
         }
     }
 
-    $self-&gt;used&#40;{}&#41;;
+    $self-&gt;{used} = {};
     return $self-&gt;_pick_dsource
-      if &#40;grep {$self-&gt;failed-&gt;{$_} &gt;= $self-&gt;failed_max} keys&#40;%{$self-&gt;failed}&#41;&#41; &lt; keys&#40;%{$self-&gt;all_dsources}&#41;;
+      if &#40;grep {$self-&gt;{failed}-&gt;{$_} &gt;= $self-&gt;{failed_max}} keys&#40;%{$self-&gt;{failed}}&#41;&#41; &lt; keys&#40;%{$self-&gt;{all_dsources}}&#41;;
     die&#40;&#34;All data sources failed!&#34;&#41;;
 }
 
+=begin private
+
+=head2 _pick_pri_dsource
+
+  my $dsource = $self-&gt;_pick_pri_dsource&#40;$pri,$dsources-&gt;{$pri}&#41;;
+
+Given 1 or more data sources with the same priority, return
+one that is available, or undef if they have all failed. 
+
+Args: 
+ - priority
+ - hashref that maps integer keys from the all_dsources hash to &#39;1&#39;.
+
+See L&lt;add_to_pri&#40;&#41;&gt; for more data structure docs.
+
+=end private
+
+=cut 
+
 sub _pick_pri_dsource {
-    my &#40;$self, $dsources&#41; = @_;
-    my @dsources = sort { $a &lt;=&gt; $b } keys %{$dsources};
-    my @used     = grep { exists $self-&gt;used-&gt;{$_} } @dsources;
-    my @failed   = grep { exists&#40;$self-&gt;failed-&gt;{$_}&#41; &#38;&#38; $self-&gt;failed-&gt;{$_} &gt;= $self-&gt;failed_max } @dsources;
+    my &#40;$self, $pri, $dsources&#41; = @_;
+
+    my $cached_dsources =  $self-&gt;{dsources_sorted_by_pri}{$pri};
+
+    my @used     = grep { exists $self-&gt;{used}-&gt;{$_} } @$cached_dsources;
+    my @failed   = grep { exists&#40;$self-&gt;{failed}-&gt;{$_}&#41; &#38;&#38; $self-&gt;{failed}-&gt;{$_} &gt;= $self-&gt;{failed_max} } @$cached_dsources;
 
     # We&#39;ve used them all and they all failed. Escallate.
-    return if @used == @dsources &#38;&#38; @failed == @dsources;
+    return if @used == @$cached_dsources &#38;&#38; @failed == @$cached_dsources;
     
     # We&#39;ve used them all but some are good. Purge and reuse.
-    delete @{$self-&gt;used}{@dsources} if @used == @dsources;
+    delete @{$self-&gt;{used} }{@$cached_dsources} if @used == @$cached_dsources;
 
-    foreach my $dsource &#40; @dsources &#41; {
-        next if    $self-&gt;failed-&gt;{$dsource}
-                &#38;&#38; $self-&gt;failed-&gt;{$dsource} &gt;= $self-&gt;failed_max;
-        next if $self-&gt;used-&gt;{$dsource};
+    for my $dsource &#40; @$cached_dsources &#41; {
+        next if    $self-&gt;{failed}-&gt;{$dsource}
+                &#38;&#38; $self-&gt;{failed}-&gt;{$dsource} &gt;= $self-&gt;{failed_max};
+        next if $self-&gt;{used}-&gt;{$dsource};
 
-        $self-&gt;used-&gt;{$dsource} = 1;
+        $self-&gt;{used}-&gt;{$dsource} = 1;
         return $dsource;
     }
-    return;
+    return undef;
 }
 
+=begin private
+
+=head2 _configure_dsources
+
+ $self-&gt;_configure_dsources;
+
+Set up internal tracking of data sources. This is meant
+to be called just once as part of new&#40;&#41;.
+
+
+=end private
+
+=cut 
+
 sub _configure_dsources {
     my &#40;$self&#41; = @_;
-    my $dsources = $self-&gt;dsources;
-    $self-&gt;dsources&#40;{}&#41;;
+    # XXX Here, &#39;dsources&#39; refers to the &#39;dsns&#39; array that the user provides.
+    # However, here it is reset and used in a different way, documented in add_to_pri 
+    my $dsources = $self-&gt;{dsources};
+    $self-&gt;{dsources} = {};
 
     while &#40; my $pri = shift @{$dsources} &#41; {
         my $dsource = shift @{$dsources} or last;
         $self-&gt;add_to_pri&#40;$pri =&gt; $dsource&#41;;
     }
+
+
+    # Cache these, since $dsources doesn&#39;t change over the object lifetime.
+    $self-&gt;{sorted_pris} =  [ sort { $a &lt;=&gt; $b } keys %{$self-&gt;{dsources} } ];
+
+    for my $pri &#40;@{ $self-&gt;{sorted_pris} }&#41; {
+            $self-&gt;{dsources_sorted_by_pri}{$pri} = [ sort { $a &lt;=&gt; $b } keys %{ $self-&gt;{dsources}{$pri} } ];
+        }
+
+
+
 }
 
-sub _connect_dsource {
+sub connect_dsource {
     my &#40;$self, $dsource&#41; = @_;
     unless &#40; $dsource &#41; {
         $self-&gt;_pick_dsource;
-        $dsource = $self-&gt;all_dsources-&gt;{$self-&gt;current_dsource};
+        $dsource = $self-&gt;{all_dsources}-&gt;{ $self-&gt;{current_dsource} };
     }
 
     # Support ready-made handles
@@ -364,15 +454,10 @@
     return $dbh;
 }
 
-sub connect_dsource {
-    my &#40;$self, $dsource&#41; = @_;
-    $self-&gt;_connect_dsource&#40;$dsource&#41;;
-}
-
 sub multi_do_all {
     my &#40;$self, $code&#41; = @_;
 
-    my @all = values %{$self-&gt;all_dsources};
+    my @all = values %{ $self-&gt;{all_dsources} };
 
     foreach my $source &#40; @all &#41; {
         my $dbh = $self-&gt;connect_dsource&#40;$source&#41;;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;29&nbsp;17:18:04&nbsp;2007</span>
    <span class="description">Dan [...] DWright.Org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jan 19 17:13:03 2007, MARKSTOS wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; By using Devel::DProf, I was able to make a number of optimizations,
&gt; bringing the difference down to... 187% slower.  The summary of the
&gt; changes include:
&gt;   - using direct hash access instead of accessors
</div>
While I agree that direct hash access is indeed faster, it isn&#39;t
necessarily better.   I&#39;m not willing to make this trade-off of style
for speed at this time, sorry.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;   - caching sorts that never change. 
</div>
I will take a look at this and see about merging it in.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; These changes pass the whole regression suite. I also added a number
&gt; blocks of &#34;private&#34; comments about the internal functions and data
&gt; structures. 
</div>
I will also look at merging some of the comments in as well.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Overall, I realize that DBD::Multi can still over significant benefit
&gt; when the performance of the database is truly the bottleneck, and not
&gt; how fast Perl&#39;s access to it is.
&gt; 
&gt; Still, this research indicates that use of DBD::Multi is best limited to
&gt;  places that are truly identified as &#34;hot spots&#34;. Otherwise, the use can
&gt; be counter-productive. 
</div>
It is also useful in places where absolute uptime outweighs the needs
for bleeding edge speed.  

Thank you for the comments and the patch.  I appreciate you taking the
time to do this.

-Dan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;29&nbsp;17:18:05&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;16&nbsp;15:05:10&nbsp;2007</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> re: DBD::Multi benchmarks</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> MARKSTOS [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Just to follow-up on this, I ran more benchmarks today with a real-world
query we use. It&#39;s complex and slow enough that we can run 6/sec or
less, max. 

In this circumstance, the overhead appeared to be at most 2%, and the
difference between my &#34;optimized&#34; version and the original was not even
detectable. 

Which just goes to show that performance and optimization are all rather
relative things!

  Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;10&nbsp;20:33:16&nbsp;2007</span>
    <span class="description">Dan [...] DWright.Org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Since the requester doesn&#39;t seem to think it helps all that much, and
since I&#39;m not crazy about it.. I&#39;m just going to close this.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;May&nbsp;10&nbsp;20:33:17&nbsp;2007</span>
    <span class="description">Dan [...] DWright.Org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
