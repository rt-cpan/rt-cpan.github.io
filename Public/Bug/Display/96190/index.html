<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #96190 for PathTools: incorrect absolute path generated for windows</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #96190 for PathTools: incorrect absolute path generated for windows</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/PathTools/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/PathTools/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/PathTools/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/PathTools/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/PathTools">PathTools CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">96190</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/PathTools/Active/">PathTools</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
JBenton [...] algebraixdata.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-24906-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-24907-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;03&nbsp;18:25:02&nbsp;2014</span>
    <span class="description">JBenton [...] algebraixdata.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> incorrect absolute path generated for windows</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 3 Jun 2014 22:24:53 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-pathtools [...] rt.cpan.org&#34; &lt;bug-pathtools [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jeff Benton &lt;jbenton [...] algebraixdata.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Perl 5.16.3, ActiveState, 64bit running on Windows 7 Professional.
PathTools 3.47
Path::Class 0.33
File::pushd 1.007

Copy the following script to your user home directory, c:\users\&lt;username&gt; and run it

use Path::Class;
use File::pushd;

my $path = dir&#40;&#39;C:\Windows&#39;&#41;;
my $initialDir = pushd&#40;$path&#41;;

print &#34;changed to $initialDir\n&#34;;

The result:
Can&#39;t chdir to c:\Users/C:\Windows: No such file or directory at path-test-failing2.t line 5.

This was a pretty difficult issue to track down because when you run in debug mode, it works.
I was able to trace it down to the behavior around Cwd::abs_path.  If I hacked File::pushd and referred to Cwd::fast_abs_path instead of abs_path at line 43, the script works.
Also, if I did not use Path::Class and just passed in a string, the script worked.

With the 3.40 versions of Cwd and File::Spec I do not get this issue.

Regards,
Jeff Benton
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;20&nbsp;09:24:06&nbsp;2014</span>
    <span class="description">Martin.Schlemmer [...] nwu.ac.za -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Martin.Schlemmer [...] nwu.ac.za</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have the same problem, with the same setup, except for 32bit perl on 64bit Win7.

Interestingly enough, this was working fine without debugging, but in Komodo IDE its injected code for debugging broke my program&#39;s use of FindBin &#40;which uses abs_path&#41; to setup lib path - so yeah, had some fun running around tracing it to PathTools from FindBin :&#41;

Anyway, the problem looks to be the new XS bits for File::Spec. If File::Spec is booted before Cwd, then Cwd do not setup abs_path, etc. correctly:

-----
C:\opt\workdir\PathTools-3.47&gt;perl -w -MFile::Spec -MCwd -e &#34;print Cwd::abs_path&#40; cwd&#40;&#41; &#41;;&#34;
Subroutine Cwd::bootstrap redefined at C:/Perl/lib/DynaLoader.pm line 207.
Subroutine Cwd::CLONE redefined at C:/Perl/lib/DynaLoader.pm line 214.
Subroutine Cwd::fastcwd redefined at C:/Perl/lib/DynaLoader.pm line 214.
Subroutine Cwd::getcwd redefined at C:/Perl/lib/DynaLoader.pm line 214.
Subroutine Cwd::abs_path redefined at C:/Perl/lib/DynaLoader.pm line 214.
Subroutine Cwd::getdcwd redefined at C:/Perl/lib/DynaLoader.pm line 214.
Subroutine File::Spec::Unix::canonpath redefined at C:/Perl/lib/DynaLoader.pm line 214.
Subroutine File::Spec::Unix::_fn_canonpath redefined at C:/Perl/lib/DynaLoader.pm line 214.
Subroutine File::Spec::Unix::catdir redefined at C:/Perl/lib/DynaLoader.pm line 214.
Subroutine File::Spec::Unix::_fn_catdir redefined at C:/Perl/lib/DynaLoader.pm line 214.
Subroutine File::Spec::Unix::catfile redefined at C:/Perl/lib/DynaLoader.pm line 214.
Subroutine File::Spec::Unix::_fn_catfile redefined at C:/Perl/lib/DynaLoader.pm line 214.
C:\opt\workdir\PathTools-3.47/C:/opt/workdir/PathTools-3.47
C:\opt\workdir\PathTools-3.47&gt;
-----

I can see two ways to fix this:
- Split the XS into two modules
- Only load the XS in Cwd &#40;see attached patch, which works here&#41;

With Patch:

-----
C:\opt\workdir\PathTools-3.47&gt;perl -w -MFile::Spec -MCwd -e &#34;print Cwd::abs_path&#40; cwd&#40;&#41; &#41;;&#34;
C:/opt/workdir/PathTools-3.47
-----

Comments appreciated.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> PathTools-3.47-require-cwd-in-file_spec.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -uprN PathTools-3.47.orig/lib/File/Spec/Unix.pm PathTools-3.47/lib/File/Spec/Unix.pm
--- PathTools-3.47.orig/lib/File/Spec/Unix.pm	2014-05-23 18:39:28 +0200
+++ PathTools-3.47/lib/File/Spec/Unix.pm	2014-06-20 14:44:58 +0200
@@ -9,7 +9,9 @@ $VERSION =~ tr/_//;
 
 unless &#40;defined &#38;canonpath&#41; {
   eval {
-    if &#40; $] &gt;= 5.006 &#41; {
+    # XXX: If we load this here, Cwd do not do the needed setup, and abs_path&#40;&#41;
+    #      fails on Win32. See bug #96190.
+    if &#40; 0 &#38;&#38; $] &gt;= 5.006 &#41; {
 	require XSLoader;
 	XSLoader::load&#40;&#34;Cwd&#34;, $xs_version&#41;;
     } else {
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;20&nbsp;09:24:06&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;01&nbsp;08:08:56&nbsp;2014</span>
    <span class="description">haarg [...] haarg.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This isn&#39;t a bug in Cwd, it&#39;s a bug in ActiveState Perl.  They have a system for overloading values from Config.pm, but it loads a bunch of modules, which causes issues if those modules try to use DynaLoader &#40;which uses Config.pm&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;01&nbsp;08:27:32&nbsp;2014</span>
    <span class="description">haarg [...] haarg.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Bug filed with ActiveState at <span class="clickylink"><a target="new" rel="nofollow" href="https://bugs.activestate.com/show_bug.cgi?id=104767">https://bugs.activestate.com/show_bug.cgi?id=104767</a></span>
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
