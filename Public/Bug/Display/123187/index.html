<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #123187 for DBD-Pg: Placeholder parsing causing ERRORs</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #123187 for DBD-Pg: Placeholder parsing causing ERRORs</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-Pg/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-Pg/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-Pg/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-Pg/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-Pg">DBD-Pg CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">123187</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-Pg/Active/">DBD-Pg</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">greg [...] turnstep.com
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ya [...] mtw.ru

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10200-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
3.5.0</li>
<li>
3.5.0_1</li>
<li>
3.5.0_2</li>
<li>
3.5.1</li>
<li>
3.5.2</li>
<li>
3.5.3</li>
<li>
3.5.9_1</li>
<li>
3.6.0</li>
<li>
3.6.1</li>
<li>
3.6.2</li>
<li>
3.6.9_1</li>
<li>
3.6.9_2</li>
<li>
3.7.0</li>
</ul>
    </td>
  </tr>
  <tr id="CF-10201-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
3.7.1    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;04&nbsp;03:56:22&nbsp;2017</span>
    <span class="description">ya [...] mtw.ru -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> What the problem?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 4 Oct 2017 10:46:21 +0300</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Pg [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Yuri I. Averiyanov&#34; &lt;ya [...] mtw.ru&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">CREATE TABLE &#34;TBL&#34; &#40;
  &#34;NODE&#34; INTEGER NOT NULL,
  &#34;TREE&#34; INTEGER[],
  PRIMARY KEY &#34;NODE&#34;
&#41;;
INSERT ...

SELECT * FROM &#34;TBL&#34;
 WHERE &#34;NODE&#34; = ANY &#40;ARRAY[&#40;SELECT &#34;TREE&#34; FROM &#34;TBL&#34;
                             WHERE &#34;NODE&#34; = $node&#41;]&#41;;

Field &#34;TREE&#34; is list of all parenthes in hierarhy.

This query worked in PgAdmin3, psql and perl-Pg, but not worked in
DBD::Pg. Not worked with $DBH-&gt;prepare&#40;$query&#41;. Answered &#34;Syntax
error&#34;. Other interfaces/handlers to subroutines in libpg worked.
Not worked only DBD::Pg.

-- 
С уважением
Юрий
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;04&nbsp;08:00:53&nbsp;2017</span>
    <span class="description">david [...] endpoint.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, can you find the exact syntax error from the Postgres log files? My first instinct was to think it has to do with the dollar placeholders. I assume you have verified that the placeholder is not being interpolated in the string? I.e. It&#39;s in a single-quoted string?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;04&nbsp;08:00:54&nbsp;2017</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;04&nbsp;08:33:00&nbsp;2017</span>
    <span class="description">ya [...] mtw.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #123187] What the problem?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 4 Oct 2017 15:32:44 +0300</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Pg [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Yuri I. Averiyanov&#34; &lt;ya [...] mtw.ru&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">В Wed, 4 Oct 2017 08:00:54 -0400
&#34;David Christensen via RT&#34; &lt;bug-DBD-Pg@rt.cpan.org&gt; пишет:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=123187">https://rt.cpan.org/Ticket/Display.html?id=123187</a></span> &gt;
&gt; 
&gt; Hi, can you find the exact syntax error from the Postgres log files?
&gt; My first instinct was to think it has to do with the dollar
&gt; placeholders. I assume you have verified that the placeholder is not
&gt; being interpolated in the string? I.e. It&#39;s in a single-quoted string?
</div>
No errors in PgSQL log file. This error generated before PgSQL ONLY by
$DBH-&gt;prepare&#40;$query&#41; and ONLY in perl! I think, that is bug in
&#39;prepare&#39; function. Other APIs for libpg don&#39;t generate errors.

-- 
С уважением
Юрий
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;04&nbsp;08:50:52&nbsp;2017</span>
    <span class="description">ya [...] mtw.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #123187] What the problem?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 4 Oct 2017 15:50:12 +0300</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Pg [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Yuri I. Averiyanov&#34; &lt;ya [...] mtw.ru&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">В Wed, 4 Oct 2017 08:00:54 -0400
&#34;David Christensen via RT&#34; &lt;bug-DBD-Pg@rt.cpan.org&gt; пишет:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, can you find the exact syntax error from the Postgres log files?
&gt; My first instinct was to think it has to do with the dollar
&gt; placeholders. I assume you have verified that the placeholder is not
&gt; being interpolated in the string? I.e. It&#39;s in a single-quoted string?
</div>Oh,sorry. I change control of logs and now have error.

Perl code:
my $req = $DBH-&gt;prepare&#40;q{SELECT * FROM &#34;TBL&#34; WHERE &#34;NODE&#34; = ANY &#40;ARRAY[&#40;SELECT &#34;TREE&#34; FROM &#34;TBL&#34; WHERE &#34;NODE&#34; = ? &#41;]&#41;;}&#41;;
$req-&gt;execute&#40;100&#41;;

PgSQL log:
STATEMENT:  SELECT * FROM &#34;TBL&#34; WHERE &#34;NODE&#34; = ANY &#40;ARRAY[&#40;SELECT
&#34;TREE&#34; FROM &#34;TBL&#34; WHERE &#34;NODE&#34; = ? &#41;]&#41;; ERROR:  syntax error at or near
&#34;ARRAY&#34; at character 41 STATEMENT:  SELECT * FROM &#34;NODE&#34; WHERE &#34;NODE&#34; =
ANY ARRAY[ ? ];

This query work in PgAdmin3, in psql, in Pg. But don&#39;t work ONLY in
DBD::Pg. In PgAdmin3, psql, Pg I see 5 records without any errors.

-- 
С уважением
Юрий
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;04&nbsp;09:18:05&nbsp;2017</span>
    <span class="description">ya [...] mtw.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #123187] What the problem?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 4 Oct 2017 16:17:47 +0300</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Pg [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Yuri I. Averiyanov&#34; &lt;ya [...] mtw.ru&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">В Wed, 4 Oct 2017 08:00:54 -0400
&#34;David Christensen via RT&#34; &lt;bug-DBD-Pg@rt.cpan.org&gt; пишет:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi, can you find the exact syntax error from the Postgres log files?
&gt; My first instinct was to think it has to do with the dollar
&gt; placeholders. I assume you have verified that the placeholder is not
&gt; being interpolated in the string? I.e. It&#39;s in a single-quoted string?
</div>
As I see from log, $DBH-&gt;prepare&#40;$query&#41; lost a subquery that returns
an array of the links from the field &#34;TREE&#34;.

-- 
С уважением
Юрий
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;08&nbsp;10:58:14&nbsp;2017</span>
    <span class="description">greg [...] turnstep.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This query work in PgAdmin3, in psql, in Pg. But don&#39;t work ONLY in
&gt; DBD::Pg. In PgAdmin3, psql, Pg I see 5 records without any errors.
</div>
That code works for me with DBD::Pg. Can you please provide a standalone, complete script that shows how it fails for you &#40;and have it do print $DBD::Pg::VERSION and 
$dbh-&gt;{pg_server_version} please&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;08&nbsp;14:14:10&nbsp;2017</span>
    <span class="description">ya [...] mtw.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #123187] What the problem?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 8 Oct 2017 21:13:51 +0300</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Pg [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Yuri I. Averiyanov&#34; &lt;ya [...] mtw.ru&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">В Sun, 8 Oct 2017 10:58:15 -0400
&#34;Greg Sabino Mullane via RT&#34; &lt;bug-DBD-Pg@rt.cpan.org&gt; пишет:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; This query work in PgAdmin3, in psql, in Pg. But don&#39;t work ONLY in
&gt; &gt; DBD::Pg. In PgAdmin3, psql, Pg I see 5 records without any errors.  
</div>&gt; 
&gt; That code works for me with DBD::Pg. Can you please provide a
&gt; standalone, complete script that shows how it fails for you &#40;and have
&gt; it do print $DBD::Pg::VERSION and $dbh-&gt;{pg_server_version} please&#41;
</div>
$DBD::Pg::VERSION=3.5.3
$dbh-&gt;{pg_server_version}=90603

server PgSQL work under FreeBSD 11.1-RELEASE i386.
client PgSQL work under Fedora-25 x86_64
Not work perl-DBD-Pg.x86_64-3.5.3-3.fc25

I work in Unix from 1983 and in Postgres from 1993 and perl-4. Before
this time, all worked without problem. This code was writen in 2005. Of
cause, I can run this script under FreeBSD, but script will work long
time &#40;more than 24h&#41; because work with great number of data. On HDD
gzip archive used more than 300G.

Until 2017, I used Pg. But in 2017 I tried to use DBD::Pg, that DBI
allows to prepare requests and store their handlers in variables.
The speed tests showed that it works about equally fast. However, using
the handlers as variables makes the code more readable. And here I was
faced with this problem. The database contains information on the
ownership of the records to any groups. Groups can be hierarchical. And
when I tried to use a massive type in one request. To get a set of
record IDs in a single query using an ARRAY. And here I was faced with
the problem that the subquery somehow lost in DBD::Pg. Other
implementations of the API to libpg in other programs in Linux work
fine.

As I understand it, DBI somehow loses the subquery if it is placed in
brackets within the subquery have &#39;?&#39;. Other sub-queries without
parentheses and &#39;?&#39; are worked correctly.

May be this effect due to the fact that I&#39;m using &#39;use strict&#39; in the
beginning of code?

Now I rollback the old 2012 version of this query that performed a
search of the records in the hierarchy step by step.

Of cause, I can myself find the bug, but sorry, now I don&#39;t have
time for it. May be after New Year only.

Sorry my English. I&#39;m Russian.

-- 
С уважением
Юрий
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;27&nbsp;16:57:00&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Again, it would help to see the actual code. The only way I can reproduce the error shown is to force a question mark to be accepted by the server literally like so:

$SQL = &#39;SELECT * FROM &#34;NODE&#34; WHERE &#34;NODE&#34; = ANY ARRAY[ ? ]&#39;;
$dbh-&gt;{pg_placeholder_dollaronly} = 1;
$sth = $dbh-&gt;prepare&#40;$SQL&#41;;
$req-&gt;execute&#40;&#41;;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;29&nbsp;05:44:16&nbsp;2018</span>
    <span class="description">ya [...] mtw.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #123187] What the problem?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 29 Jan 2018 13:33:33 +0300</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Pg [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Yuri I. Averiyanov&#34; &lt;ya [...] mtw.ru&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">В Sat, 27 Jan 2018 16:57:01 -0500
&#34;Greg Sabino Mullane via RT&#34; &lt;bug-DBD-Pg@rt.cpan.org&gt; пишет:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Again, it would help to see the actual code. The only way I can
&gt; reproduce the error shown is to force a question mark to be accepted
&gt; by the server literally like so:
&gt; 
&gt; $SQL = &#39;SELECT * FROM &#34;NODE&#34; WHERE &#34;NODE&#34; = ANY ARRAY[ ? ]&#39;;
&gt; $dbh-&gt;{pg_placeholder_dollaronly} = 1;
&gt; $sth = $dbh-&gt;prepare&#40;$SQL&#41;;
&gt; $req-&gt;execute&#40;&#41;;
</div>
Source SQL code:
CREATE TABLE &#34;TBL&#34; &#40;
 &#34;NODE&#34; INTEGER NOT NULL,
 &#34;TREE&#34; INTEGER[],
 PRIMARY KEY &#34;NODE&#34;
&#41;;
INSERT ...

SELECT * FROM &#34;TBL&#34; WHERE &#34;NODE&#34; = ANY &#40;ARRAY[&#40;SELECT &#34;TREE&#34; FROM &#34;TBL&#34; WHERE &#34;NODE&#34; = 100&#41;]&#41;; 

Perl code:
  my $req = $DBH-&gt;prepare&#40;q{SELECT * FROM &#34;TBL&#34; WHERE &#34;NODE&#34; = ANY &#40;ARRAY[&#40;SELECT &#34;TREE&#34; FROM &#34;TBL&#34; WHERE &#34;NODE&#34; = ? &#41;]&#41;;}&#41;;
  $req-&gt;execute&#40;100&#41;;

PgSQL log:
STATEMENT: SELECT * FROM &#34;TBL&#34; WHERE &#34;NODE&#34; = ANY &#40;ARRAY[&#40;
           SELECT &#34;TREE&#34; FROM &#34;TBL&#34; WHERE &#34;NODE&#34; = ? &#41;]&#41;;
    ERROR: syntax error at or near &#34;ARRAY&#34; at character 41
STATEMENT: SELECT * FROM &#34;NODE&#34; WHERE &#34;NODE&#34; = ANY ARRAY[ ? ];

I don&#39;t use Windows. This query work in PgAdmin3, in psql, in Pg in any
UNIX OS. But don&#39;t work ONLY in DBD::Pg. In PgAdmin3, psql, Pg I see 5
records without any errors.

I think, that $DBH-&gt;prepare&#40;$SQL&#41; have bug when parse subquery in
query. Prepare ONLY query wihout subquery don&#39;t generate error. In
other programs, worked with libpg, which don&#39;t prepared query, don&#39;t
make error and result have 5 records. Parser query in postgresql work
right.

ONLY in DBD::Pg this SQL query generated error.

Next code, equivalent of original code, worked all time and anywhere:
  my $q1 = $DBH-&gt;prepare&#40;q{SELECT &#34;TREE&#34; FROM &#34;TBL&#34; WHERE &#34;NODE&#34; = ? ;}&#41;;
  my $q2 = $DBH-&gt;prepare&#40;q{SELECT * FROM &#34;TBL&#34; WHERE &#34;NODE&#34; = ANY &#40;ARRAY[ ? ]&#41;;}&#41;;
  my $r1 = $q1-&gt;execute&#40;100&#41;;
  my $row = $r1-&gt;fetchrow_hashref;
  my $r2 = $q2-&gt;execute&#40;&#34;$row-&gt;{TREE}&#34;&#41;;

-- 
С уважением
Юрий
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;30&nbsp;10:21:00&nbsp;2018</span>
    <span class="description">ya [...] mtw.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #123187] What the problem?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 30 Jan 2018 18:20:35 +0300</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Pg [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Yuri I. Averiyanov&#34; &lt;ya [...] mtw.ru&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">В Sat, 27 Jan 2018 16:57:01 -0500
&#34;Greg Sabino Mullane via RT&#34; &lt;bug-DBD-Pg@rt.cpan.org&gt; пишет:

I understand where is the error. If the SQL query contains a subquery,
there is no substitution of the argument instead of character &#39;?&#39;if the
character &#39;?&#39;located in the subquery. This is evidenced by the string:

PgSQL log:
STATEMENT: SELECT * FROM &#34;TBL&#34; WHERE &#34;NODE&#34; = ANY &#40;ARRAY[&#40;
           SELECT &#34;TREE&#34; FROM &#34;TBL&#34; WHERE &#34;NODE&#34; = ? &#41;]&#41;;

Must be 
SELECT * FROM &#34;TBL&#34; WHERE &#34;NODE&#34; = ANY &#40;ARRAY[&#40;
       SELECT &#34;TREE&#34; FROM &#34;TBL&#34; WHERE &#34;NODE&#34; = 100 &#41;]&#41;;
-- 
С уважением
Юрий
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;03&nbsp;14:26:08&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Okay, I was able to duplicate and have a fix, in 22c134d850e857e1f9d0b67e2830a44c34ca623d. Please see if that clears up the error for you too. Thank you.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;03&nbsp;14:26:45&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Subject changed from &#39;What the problem?&#39; to &#39;Placeholder parsing causing ERRORs&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;03&nbsp;14:26:45&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;04&nbsp;16:58:43&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Assuming fixed, marking as patched.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;04&nbsp;16:58:43&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;12&nbsp;22:49:03&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;12&nbsp;22:49:03&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Fixed in 3.7.1 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;12&nbsp;22:49:03&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Broken in 3.5.0 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;12&nbsp;22:49:03&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Broken in 3.5.0_1 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;12&nbsp;22:49:03&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Broken in 3.5.0_2 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;12&nbsp;22:49:03&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Broken in 3.5.1 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;12&nbsp;22:49:03&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Broken in 3.5.2 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;12&nbsp;22:49:03&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Broken in 3.5.3 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;12&nbsp;22:49:03&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Broken in 3.5.9_1 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;12&nbsp;22:49:03&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Broken in 3.6.0 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;12&nbsp;22:49:04&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Broken in 3.6.1 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;12&nbsp;22:49:04&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Broken in 3.6.2 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;12&nbsp;22:49:04&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Broken in 3.6.9_1 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;12&nbsp;22:49:04&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Broken in 3.6.9_2 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;12&nbsp;22:49:04&nbsp;2018</span>
    <span class="description">greg [...] turnstep.com -  Broken in 3.7.0 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
