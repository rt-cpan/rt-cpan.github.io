<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #18618 for AppConfig: [PATCH] Various failures under Win32 fixed.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #18618 for AppConfig: [PATCH] Various failures under Win32 fixed.</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/AppConfig/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/AppConfig/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/AppConfig/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/AppConfig/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/AppConfig">AppConfig CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">18618</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/AppConfig/Active/">AppConfig</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
demerphq [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-2462-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-2463-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;09&nbsp;16:20:05&nbsp;2006</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] Various failures under Win32 fixed.</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">With AppConfig 1.56 building on Win32 produces the following result:

t/file.........ok 3/43Usage: POSIX::getpwuid&#40;uid&#41; at
lib/AppConfig/File.pm line 410
# Looks like you planned 43 tests but only ran 3.
# Looks like your test died just after 3.
t/file.........dubious
        Test returned status 255 &#40;wstat 65280, 0xff00&#41;
DIED. FAILED tests 4-43
        Failed 40/43 tests, 6.98% okay
t/flag.........ok
t/getopt.......ok
t/multi........ok
t/novars.......ok
t/state........ok
t/sys..........ok
Failed Test Stat Wstat Total Fail  Failed  List of Failed
-------------------------------------------------------------------------------
t/file.t     255 65280    43   80 186.05%  4-43
Failed 1/14 test scripts, 92.86% okay. 40/253 subtests failed, 84.19% okay.
NMAKE : fatal error U1077: &#39;D:\ASPerl\811\bin\perl.exe&#39; : return code &#39;0xff&#39;
Stop.

This failure is due to the line

  use POSIX qw&#40;getpwuid getpwnam&#41;;

which loads the two POSIX subs into the AppConfig::Sys namespace, which
means that the entire AUTOLOAD logic for handling getpwuid/getpwnam is
bypassed. By changing the use to a require and then explicitly calling
the POSIX versions of these subs the error goes away. Note that this
means that most of the point of having AppConfig::Sys is redundant.

Frankly I think the use of AUTOLOAD in AppConfig::Sys is entirely
superfluous, and would be better off being replaced by proper 
subroutines. It makes no sense to me to autoload routines that could be
resolved once at compile time.

Once that error is fixed further failures occur unless ENV{HOME} is
explicitly set, something that cannot be guaranteed on Win32. Therefore
my patch explicitly sets ENV{HOME} before testing.

I also patched the code that tries to ascertain the home directory for a
user so that on Win32 when ENV{HOME} is not set it uses the windows
standard path for the purpose.

With the patch applied I get passing results:

D:\dev\cpan\Versioned\AppConfig-1.56&gt;nmake test

Microsoft &#40;R&#41; Program Maintenance Utility Version 7.00.9955
Copyright &#40;C&#41; Microsoft Corporation.  All rights reserved.

        D:\ASPerl\811\bin\perl.exe &#34;-MExtUtils::Command::MM&#34; &#34;-e&#34;
&#34;test_harness&#40;0, &#39;blib\lib&#39;, &#39;blib\arch&#39;&#41;&#34; t/*.t
t/appconfig....ok
t/args.........ok
t/block........ok
t/cgi..........ok
t/compact......ok
t/const........ok
t/default......ok
t/file.........ok
t/flag.........ok
t/getopt.......ok
t/multi........ok
t/novars.......ok
t/state........ok
t/sys..........ok
All tests successful.
Files=14, Tests=253,  2 wallclock secs &#40; 0.00 cusr +  0.00 csys =  0.00 CPU&#41;

Cheers,
Yves

D:\.cpan\build\AppConfig-1.56&gt;ver

Microsoft Windows 2000 [Version 5.00.2195]

D:\dev\cpan\ExtUtils-Install\trunk&gt;perl -V
Summary of my perl5 &#40;revision 5 version 8 subversion 6&#41; configuration:
  Platform:
    osname=MSWin32, osvers=4.0, archname=MSWin32-x86-multi-thread
    uname=&#39;&#39;
    config_args=&#39;undef&#39;
    hint=recommended, useposix=true, d_sigaction=undef
    usethreads=define use5005threads=undef useithreads=define
usemultiplicity=define
    useperlio=define d_sfio=undef uselargefiles=define usesocks=undef
    use64bitint=undef use64bitall=undef uselongdouble=undef
    usemymalloc=n, bincompat5005=undef
  Compiler:
    cc=&#39;cl&#39;, ccflags =&#39;-nologo -Gf -W3 -MD -Zi -DNDEBUG -O1 -DWIN32
-D_CONSOLE -DNO_STRICT -DHAVE_DES_FCRYPT  -DNO_HASH_SEED
-DPERL_IMPLICIT_CONTEXT -DPERL_IMPL
ICIT_SYS -DUSE_PERLIO -DPERL_MSVCRT_READFIX&#39;,
    optimize=&#39;-MD -Zi -DNDEBUG -O1&#39;,
    cppflags=&#39;-DWIN32&#39;
    ccversion=&#39;&#39;, gccversion=&#39;&#39;, gccosandvers=&#39;&#39;
    intsize=4, longsize=4, ptrsize=4, doublesize=8, byteorder=1234
    d_longlong=undef, longlongsize=8, d_longdbl=define, longdblsize=10
    ivtype=&#39;long&#39;, ivsize=4, nvtype=&#39;double&#39;, nvsize=8, Off_t=&#39;__int64&#39;,
lseeksize=8
    alignbytes=8, prototype=define
  Linker and Libraries:
    ld=&#39;link&#39;, ldflags =&#39;-nologo -nodefaultlib -debug -opt:ref,icf 
-libpath:&#34;D:\ASPerl\811\lib\CORE&#34;  -machine:x86&#39;
    libpth=\lib
    libs=  oldnames.lib kernel32.lib user32.lib gdi32.lib winspool.lib 
comdlg32.lib advapi32.lib shell32.lib ole32.lib oleaut32.lib 
netapi32.lib uuid.lib ws2_
32.lib mpr.lib winmm.lib  version.lib odbc32.lib odbccp32.lib msvcrt.lib
    perllibs=  oldnames.lib kernel32.lib user32.lib gdi32.lib
winspool.lib  comdlg32.lib advapi32.lib shell32.lib ole32.lib
oleaut32.lib  netapi32.lib uuid.lib
ws2_32.lib mpr.lib winmm.lib  version.lib odbc32.lib odbccp32.lib msvcrt.lib
    libc=msvcrt.lib, so=dll, useshrplib=yes, libperl=perl58.lib
    gnulibc_version=&#39;undef&#39;
  Dynamic Linking:
    dlsrc=dl_win32.xs, dlext=dll, d_dlsymun=undef, ccdlflags=&#39; &#39;
    cccdlflags=&#39; &#39;, lddlflags=&#39;-dll -nologo -nodefaultlib -debug
-opt:ref,icf  -libpath:&#34;D:\ASPerl\811\lib\CORE&#34;  -machine:x86&#39;


Characteristics of this binary &#40;from libperl&#41;:
  Compile-time options: MULTIPLICITY USE_ITHREADS USE_LARGE_FILES
PERL_IMPLICIT_CONTEXT PERL_IMPLICIT_SYS
  Locally applied patches:
        ActivePerl Build 811
        21540 Fix backward-compatibility issues in if.pm
        23565 Wrong MANIFEST.SKIP
  Built under MSWin32
  Compiled at Dec 13 2004 09:52:01
  @INC:
    D:/ASPerl/811/lib
    D:/ASPerl/811/site/lib
    .
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> apconfig.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Only in d:\dev\cpan\Versioned\AppConfig-1.56: Makefile
Only in D:\.cpan\build\AppConfig-1.56: apconfig.patch
Only in d:\dev\cpan\Versioned\AppConfig-1.56: blib
diff -urd D:\.cpan\build\AppConfig-1.56/lib/AppConfig/File.pm d:\dev\cpan\Versioned\AppConfig-1.56/lib/AppConfig/File.pm
--- D:\.cpan\build\AppConfig-1.56/lib/AppConfig/File.pm	2006-04-09 22:06:32.566368600 +0200
+++ d:\dev\cpan\Versioned\AppConfig-1.56/lib/AppConfig/File.pm	2006-04-09 20:36:03.503868600 +0200
@@ -407,11 +407,15 @@
 		    unless &#40;defined&#40;$val = $self-&gt;{ HOME }&#41;&#41; {
 			if &#40;exists $ENV{ HOME }&#41; {
 			    $val = $ENV{ HOME };
-			}
-			elsif &#40;$sys-&gt;can_getpwuid&#40;&#41;&#41; {
-			    $val = &#40;$sys-&gt;getpwuid&#40;$&lt;&#41;&#41;[7];
-			}
-
+			} else {
+			    if &#40;$^O=~/win32/i&#41; {
+			        require Win32;
+			        $val = Win32::GetFolderPath&#40;Win32::CSIDL_LOCAL_APPDATA&#40;&#41;,1&#41;;
+			    }
+			    if &#40;!$val &#38;&#38; $sys-&gt;can_getpwuid&#40;&#41;&#41; {
+			        $val = &#40; $sys-&gt;getpwuid&#40;$&lt;&#41; &#41;[7];
+			    }
+                        }
 			# cache value for next time
 			$self-&gt;{ HOME } = $val;
 		    }
diff -urd D:\.cpan\build\AppConfig-1.56/lib/AppConfig/Sys.pm d:\dev\cpan\Versioned\AppConfig-1.56/lib/AppConfig/Sys.pm
--- D:\.cpan\build\AppConfig-1.56/lib/AppConfig/Sys.pm	2006-04-09 22:05:49.441368600 +0200
+++ d:\dev\cpan\Versioned\AppConfig-1.56/lib/AppConfig/Sys.pm	2006-04-09 20:24:55.816368600 +0200
@@ -19,7 +19,7 @@
 require 5.004;
 use strict;
 use vars qw&#40; $VERSION $AUTOLOAD $OS %CAN %METHOD&#41;;
-use POSIX qw&#40; getpwnam getpwuid &#41;;
+require POSIX;
 
 $VERSION = sprintf&#40;&#34;%d.%02d&#34;, q$Revision: 1.61 $ =~ /&#40;\d+&#41;\.&#40;\d+&#41;/&#41;;
 
@@ -38,13 +38,12 @@
     else
     {
         $METHOD{ getpwuid } = sub {
-            getpwuid&#40; defined $_[0] ? shift : $&lt; &#41;;
+            POSIX::getpwuid&#40; defined $_[0] ? shift : $&lt; &#41;;
         };
         $METHOD{ getpwnam } = sub {
-            getpwnam&#40; defined $_[0] ? shift : &#39;&#39; &#41;;
+            POSIX::getpwnam&#40; defined $_[0] ? shift : &#39;&#39; &#41;;
         };
     }
-
     # try out each METHOD to see if it&#39;s supported on this platform;
     # it&#39;s important we do this before defining AUTOLOAD which would
     # otherwise catch the unresolved call
@@ -184,6 +183,7 @@
 
     $self-&gt;{ OS      } = $os;
     $self-&gt;{ PATHSEP } = $ps;
+
 }
 
 
Only in d:\dev\cpan\Versioned\AppConfig-1.56: pm_to_blib
diff -urd D:\.cpan\build\AppConfig-1.56/t/file.t d:\dev\cpan\Versioned\AppConfig-1.56/t/file.t
--- D:\.cpan\build\AppConfig-1.56/t/file.t	2006-04-09 22:07:31.191368600 +0200
+++ d:\dev\cpan\Versioned\AppConfig-1.56/t/file.t	2006-04-09 22:09:10.644493600 +0200
@@ -91,6 +91,9 @@
 ok&#40; defined $state, &#39;state defined&#39; &#41;;
 ok&#40; defined $cfgfile, &#39;cfgfile defined&#39; &#41;;
 
+# explicitly set the HOME variable for testing in situations where there
+# is no HOME variable set.
+$ENV{HOME}=&#39;HOME&#39;;
 ok&#40; $cfgfile-&gt;parse&#40;\*DATA&#41;, &#39;parsed&#39; &#41;;
 
 
@@ -109,9 +112,11 @@
 
 # see if &#34;[~/$html]&#34; matches &#34;[${HOME}/$html]&#34;.  It may fail if your
 #   platform doesn&#39;t provide getpwuid&#40;&#41;.  See AppConfig::Sys for details.
+
+my $same=$state-&gt;same&#40;&#41;;
 my &#40;$one, $two&#41; =
-    $state-&gt;same&#40;&#41; =~ / \[ &#40; [^\]]+ &#41; \] \s+=&gt;\s+ \[ &#40; [^\]]+ &#41; \]/gx;
-is&#40; $one, $two, &#39;one is two&#39; &#41;;
+     $same =~ / \[ &#40; [^\]]+ &#41; \] \s+=&gt;\s+ \[ &#40; [^\]]+ &#41; \]/gx;
+is&#40; $one, $two, &#34;one is two: $same&#34; &#41;;
 
 # test that &#34;split&#34; came out the same as &#34;same&#34;
 is&#40; $state-&gt;same&#40;&#41;, $state-&gt;split&#40;&#41;, &#39;same split&#39; &#41;;
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
