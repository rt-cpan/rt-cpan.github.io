<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #103157 for File-LibMagic: oo-api.t fails on OS X 10.9.5 w/ libmagic from homebrew; magic.mgc confusion.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #103157 for File-LibMagic: oo-api.t fails on OS X 10.9.5 w/ libmagic from homebrew; magic.mgc confusion.</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/File-LibMagic/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/File-LibMagic/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/File-LibMagic/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/File-LibMagic/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/File-LibMagic">File-LibMagic CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">103157</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/File-LibMagic/Active/">File-LibMagic</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
hartzell [...] alerce.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-12920-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.12    </td>
  </tr>
  <tr id="CF-12921-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.16    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;28&nbsp;12:10:50&nbsp;2015</span>
    <span class="description">hartzell [...] alerce.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> oo-api.t fails on OS X 10.9.5 w/ libmagic from homebrew;
 magic.mgc confusion.</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On a Mac running OS X 10.9.5 with libmagic v5.22 installed via homebrew.

oo-api.t fails the custom file part of the test, where it tries to load /usr/share/file/magic.mgc.

The `$info` returned around line 46 of oo-api.t for that file reports that it is 

```
  DB&lt;1&gt; x $info
0  HASH&#40;0x7fe03aed5780&#41;
   &#39;description&#39; =&gt; &#39;magic binary file for file&#40;1&#41; cmd &#40;version 7&#41; &#40;little endian&#41;&#39;
   &#39;encoding&#39; =&gt; &#39;binary&#39;
   &#39;mime_type&#39; =&gt; &#39;application/octet-stream&#39;
   &#39;mime_with_encoding&#39; =&gt; &#39;application/octet-stream; charset=binary&#39;
  DB&lt;2&gt; n
```

but when it is used as the standard_file argument to File::LibMagic-&gt;new&#40;&#41; it generates the following failures:

```
t/samples/magic, 2: Warning: using regular magic file `/usr/share/file/magic.mgc&#39;
/usr/share/file/magic.mgc, 1: Warning: offset `�&#39; invalid
/usr/share/file/magic.mgc, 1: Warning: type `�&#39; invalid
/usr/share/file/magic.mgc, 2: Warning: offset `Firmware v&#39; invalid
[...]
```

and then the tests fail.

If I replace that magic file with `/usr/local//Cellar/libmagic/5.22/share/misc/magic.mgc` then `$info` is

```
  DB&lt;1&gt; x $info
0  HASH&#40;0x7fa75402c950&#41;
   &#39;description&#39; =&gt; &#39;magic binary file for file&#40;1&#41; cmd &#40;version 12&#41; &#40;little endian&#41;&#39;
   &#39;encoding&#39; =&gt; &#39;binary&#39;
   &#39;mime_type&#39; =&gt; &#39;application/octet-stream&#39;
   &#39;mime_with_encoding&#39; =&gt; &#39;application/octet-stream; charset=binary&#39;
  DB&lt;2&gt; n
```

and the tests all pass.

It seems that the homebrew installed library does not work with the system magic.mgc file.

Given that the path to the magic.mgc file that work contains the releases version number, I&#39;m not sure how to best proceed.

My best idea is to work with the homebrew port and have it link its magic.mgc file somewhere underneath /usr/share then have t/oo-api.t use it a&#41; in preference to the one in /usr/share, or b&#41; if it&#39;s running on a mac or c&#41; based on an environment variable or....

What can I do to help get this cleaned up?

Thanks!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;18&nbsp;14:45:24&nbsp;2017</span>
    <span class="description">wyant [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The underlying problem is not, as far as I can tell, related to homebrew. but rather that there appears to be some weirdness in the copy of magic.mgc distributed by Apple.

Pull request #7 addresses this in the least-bad way I could come up with. As that request states, it involves scraping the output of &#39;file -v&#39; to try to get the magic that File::LibMagic will actually be using.

Normally the preferred implementation would be to get this information via the API, but the call that does this is undocumented, which makes me fear it is there simply for the convenience of the &#39;file&#39; command, and subject to change without notice.

A .patch file representing the code in the pull request is attached, for the benefit of the curious.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> File-LibMagic-t-ooapi.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/t/oo-api.t b/t/oo-api.t
index 74c5d10..7eb2f71 100644
--- a/t/oo-api.t
+++ b/t/oo-api.t
@@ -8,6 +8,9 @@ use Test::More 0.96;
 
 use File::LibMagic;
 
+local $ENV{MAGIC};
+delete $ENV{MAGIC};
+
 {
     my %standard = &#40;
         &#39;foo.foo&#39; =&gt; [
@@ -16,7 +19,11 @@ use File::LibMagic;
             qr/us-ascii/,
         ],
         &#39;foo.c&#39; =&gt; [
-            [ &#39;ASCII C program text&#39;, &#39;C source, ASCII text&#39; ],
+            [
+		&#39;ASCII C program text&#39;,
+		&#39;C source, ASCII text&#39;,
+		&#39;c program, ASCII text&#39;,	# Apple default magic
+	    ],
             &#39;text/x-c&#39;,
             qr/us-ascii/,
         ],
@@ -39,7 +46,10 @@ use File::LibMagic;
 
 SKIP:
 {
-    my $standard_file = &#39;/usr/share/file/magic.mgc&#39;;
+    my $standard_file = _scrape_file_version&#40;&#41;;
+
+    note &#34;Testing with standard magic file &#39;$standard_file&#39;&#34;;
+
     skip &#34;The standard magic file must exist at $standard_file&#34;, 1
         unless -l $standard_file || -f _;
 
@@ -54,7 +64,11 @@ SKIP:
             &#39;us-ascii&#39;,
         ],
         &#39;foo.c&#39; =&gt; [
-            [ &#39;ASCII C program text&#39;, &#39;C source, ASCII text&#39; ],
+            [
+		&#39;ASCII C program text&#39;,
+		&#39;C source, ASCII text&#39;,
+		&#39;c program, ASCII text&#39;,	# Apple default magic
+	    ],
             &#39;text/x-c&#39;,
             &#39;us-ascii&#39;,
         ],
@@ -75,6 +89,20 @@ SKIP:
     &#41;;
 }
 
+sub _scrape_file_version {
+    foreach &#40; `file -v` &#41; {
+	chomp;
+	next
+	    unless m/\AXmagic file from &#40;.*&#41;/;
+	return &#34;$1.mgc&#34;
+	    if -f &#34;$1.mgc&#34;;
+	return &#34;$1&#34;
+	    if -f $1;
+	last;
+    }
+    return &#39;/usr/share/file/magic.mgc&#39;;
+}
+
 sub _test_flm {
     my $flm   = shift;
     my $tests = shift;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;18&nbsp;14:45:25&nbsp;2017</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;29&nbsp;11:00:43&nbsp;2017</span>
    <span class="description">DROLSKY [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;29&nbsp;11:00:43&nbsp;2017</span>
    <span class="description">DROLSKY [...] cpan.org -  Fixed in 1.16 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
