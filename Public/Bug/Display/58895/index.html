<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #45019 for CGI: Needs Discussion: PATCH: url&#40;&#41; rewrite/path_info handling not compatible with CGI::Application::Dispatch rewriting</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #45019 for CGI: Needs Discussion: PATCH: url&#40;&#41; rewrite/path_info handling not compatible with CGI::Application::Dispatch rewriting</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/CGI/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/CGI/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/CGI/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/CGI/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/leejo/CGI.pm/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/CGI">CGI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">45019</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/CGI/Active/">CGI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">MARKSTOS [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
MARKSTOS [...] cpan.org

<br />
sec [...] 42.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
GTERMARS [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-230860-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-230861-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;13&nbsp;21:40:43&nbsp;2009</span>
    <span class="description">MARKSTOS [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> url&#40;&#41; rewrite/path_info handling not compatible with
 CGI::Application::Dispatch rewriting</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The current logic for url&#40;&#41; forces the path_info to be undefined if
rewriting is in use. 

However, there is somewhat common use-case where combining rewriting and
the path_info is desired, and this is currently not possible with URL. 

The rewriting recipe is simple conceptually: If a file or directory
physically exists, serve it directly. If the path does not physically
exist, give the path to a dispatcher as path_info, which will take it
from there. 

This is how Drupal implements their &#34;Clean URIs&#34; solution, and
CGI::Application::Dispatch uses the same recipe. Here&#39;s how it looks in
mod_rewrite:

  # If an actual file or directory is requested, serve directly
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d

  # Otherwise, pass everything through to the dispatcher
  RewriteRule ^&#40;.*&#41;$ /cgi-bin/dispatch.cgi/$1 [L,QSA]

Below is one proposed fix. It says to only clear out the path_info if
you specifically asked for it to be thrown away &#40; path_info =&gt; 0 &#41;. This
allows &#34;rewrite&#34; to be used with or without path_info&#40;&#41;.

Although it seems technically correct, it&#39;s not backwards compatible,
since the 3.12 release around 2005. The situation is complicated by
self_url&#40;&#41; always &#34;passes path_info =&gt; 1&#34;

To stay backwards compatible, we have to keep the notion that rewrite=&gt;1
always implies throwing out path_info. I think a compatible solution
would have to involve adding yet-another flag, like
&#34;keep_rewrite_path_info&#34;... or something. 

    Mark


--- old-alphasite/perllib/CGI.pm        2009-04-13 21:29:16.000000000 -0400
+++ new-alphasite/perllib/CGI.pm        2009-04-13 21:29:16.000000000 -0400
@@ -2717,7 +2717,11 @@
     my $query_str   =  $self-&gt;query_string;

     my $rewrite_in_use = $request_uri &#38;&#38; $request_uri !~ /^\Q$script_name/;
-    undef $path if $rewrite_in_use &#38;&#38; $rewrite;  # path not valid when
rewriting active
+
+    # path not valid when rewriting active, unless you specifically ask
for it.
+    if &#40;$rewrite_in_use &#38;&#38; $rewrite &#38;&#38; not $path_info&#41; {
+        undef $path;
+    }

     my $uri         =  $rewrite &#38;&#38; $request_uri ? $request_uri :
$script_name;
     $uri            =~ s/\?.*$//s;                                #
remove query string
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;19&nbsp;21:17:01&nbsp;2009</span>
    <span class="description">MARKSTOS [...] cpan.org -  Subject changed from &#39;url&#40;&#41; rewrite/path_info handling not compatible with CGI::Application::Dispatch rewriting&#39; to &#39;Needs Discussion: PATCH: url&#40;&#41; rewrite/path_info handling not compatible with CGI::Application::Dispatch rewriting&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;17&nbsp;10:14:00&nbsp;2010</span>
    <span class="description">MARKSTOS [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;17&nbsp;10:15:13&nbsp;2010</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> lincoln.stein [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Lincoln, Yanick,

Could either of you comment on this proposed behavior change?

It just came up again as a bug on the CGI::Application mailing list. See 
the latest context below:

###


From: Graham TerMarsch &lt;cgi-application@howlingfrog.com&gt;

On June 16, 2010, n1zero@aol.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I am using CA::Dispatch &#38; CAP::Authentication in pretty much their
&gt; out-the-box state. I have found that I get this to work only if I hack 
</div>a
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; line in CAP::Authentication, but I&#39;d like to know why things don&#39;t 
</div>work
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; without the hack and what I should do to avoid it.
&gt; 
&gt; For apache I have
&gt;     DocumentRoot /srv/trial/www/
&gt;     PerlOptions +Parent
&gt;     PerlSwitches -I/srv/trial/mod
&gt;     PerlSwitches -I/srv/trial/lib
&gt;     &lt;Location /trial&gt;
&gt;         SetHandler perl-script
&gt;         PerlHandler CGI::Application::Dispatch
&gt;     &lt;/Location&gt;
&gt; so that the user hits /trial/mod3/page2 and this is dispatched to 
</div>Mod3.pm
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; in runmode page2. &#40;This all works perfectly.&#41;
&gt; 
&gt; In Mod3.pm I have
&gt; __PACKAGE__-&gt;authen-&gt;protected_runmodes&#40;&#39;page2&#39;&#41;;
&gt; so that upon the above hit, the user is given the built-in login form.
&gt; &#40;This all works perfectly.&#41;
&gt; 
&gt; But this is where it goes wrong.  When the user hits &lt;Sign In&gt; the 
</div>post
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; goes to /trial, which doesn&#39;t exist &#40;in this example app&#41;.  Looking at 
</div>the
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; page of the form reveals it has action=&#34;/trial&#34;. That comes from
&gt; CAP::Authentication, &#34;my $action = $query-&gt;url&#40; -absolute =&gt; 1 &#41;;&#34;, 
</div>which
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; gives in my case &#39;/trial&#39;.  Now, it turns out $destination is set
&gt; correctly, so if I follow this with &#34;$action = $destination&#34; then it 
</div>all
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; appears to work perfectly.  I&#39;m guessing this is a case of user error, 
</div>but
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I can&#39;t see what I&#39;ve done wrong to make $query-&gt;url give a
&gt; less-than-useful value.  
</div>
Hmmm... this sounds an awful lot like:

  <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=45019">https://rt.cpan.org/Ticket/Display.html?id=45019</a></span>

where the &#34;path_info&#34; isn&#39;t properly set up if you&#39;re using URL 
rewriting via 
mod_rewrite, and as a result generated links thereafter aren&#39;t generated 
the 
way that you think they should be.

Although you don&#39;t say you&#39;re using mod_rewrite in your config, this 
sounds a 
lot like this problem &#40;which I&#39;ve experienced ever since CGI.pm changed 
its 
behaviour w.r.t. this&#41;.

Which reminds me... markstos... did you ever get any further discussion 
on 
this &#40;and is it something we can ever hope to see fixed in CGI.pm&#41;?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;17&nbsp;12:31:19&nbsp;2010</span>
    <span class="description">lincoln.stein [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #45019] Needs Discussion: PATCH: url&#40;&#41;  rewrite/path_info handling not compatible with CGI::Application::Dispatch  rewriting</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 17 Jun 2010 12:31:01 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI.pm [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Lincoln Stein &lt;lincoln.stein [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Some versions of Apache have bugs in how they set up the PATH_INFO and
REQUEST_URL environment variables in the context of mod_rewrite. This has
created the need for considerable workaround code in CGI.pm. The workarounds
catch most, but not all cases. I would be very happy to pull out all this
code and replace it with the simple code and simply tell people to file the
bug reports against Apache.

Lincoln

On Thu, Jun 17, 2010 at 10:15 AM, MARKSTOS via RT &lt;bug-CGI.pm@rt.cpan.org&gt;wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       Queue: CGI.pm
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=45019">https://rt.cpan.org/Ticket/Display.html?id=45019</a></span> &gt;
&gt;
&gt; Lincoln, Yanick,
&gt;
&gt; Could either of you comment on this proposed behavior change?
&gt;
&gt; It just came up again as a bug on the CGI::Application mailing list. See
&gt; the latest context below:
&gt;
&gt; ###
&gt;
&gt;
&gt; From: Graham TerMarsch &lt;cgi-application@howlingfrog.com&gt;
&gt;
&gt; On June 16, 2010, n1zero@aol.com wrote:
<div class="message-stanza open">&gt; &gt; I am using CA::Dispatch &#38; CAP::Authentication in pretty much their
&gt; &gt; out-the-box state. I have found that I get this to work only if I hack
</div>&gt; a
<div class="message-stanza open">&gt; &gt; line in CAP::Authentication, but I&#39;d like to know why things don&#39;t
</div>&gt; work
<div class="message-stanza open">&gt; &gt; without the hack and what I should do to avoid it.
&gt; &gt;
&gt; &gt; For apache I have
&gt; &gt;     DocumentRoot /srv/trial/www/
&gt; &gt;     PerlOptions +Parent
&gt; &gt;     PerlSwitches -I/srv/trial/mod
&gt; &gt;     PerlSwitches -I/srv/trial/lib
&gt; &gt;     &lt;Location /trial&gt;
&gt; &gt;         SetHandler perl-script
&gt; &gt;         PerlHandler CGI::Application::Dispatch
&gt; &gt;     &lt;/Location&gt;
&gt; &gt; so that the user hits /trial/mod3/page2 and this is dispatched to
</div>&gt; Mod3.pm
<div class="message-stanza open">&gt; &gt; in runmode page2. &#40;This all works perfectly.&#41;
&gt; &gt;
&gt; &gt; In Mod3.pm I have
&gt; &gt; __PACKAGE__-&gt;authen-&gt;protected_runmodes&#40;&#39;page2&#39;&#41;;
&gt; &gt; so that upon the above hit, the user is given the built-in login form.
&gt; &gt; &#40;This all works perfectly.&#41;
&gt; &gt;
&gt; &gt; But this is where it goes wrong.  When the user hits &lt;Sign In&gt; the
</div>&gt; post
<div class="message-stanza open">&gt; &gt; goes to /trial, which doesn&#39;t exist &#40;in this example app&#41;.  Looking at
</div>&gt; the
<div class="message-stanza open">&gt; &gt; page of the form reveals it has action=&#34;/trial&#34;. That comes from
&gt; &gt; CAP::Authentication, &#34;my $action = $query-&gt;url&#40; -absolute =&gt; 1 &#41;;&#34;,
</div>&gt; which
<div class="message-stanza open">&gt; &gt; gives in my case &#39;/trial&#39;.  Now, it turns out $destination is set
&gt; &gt; correctly, so if I follow this with &#34;$action = $destination&#34; then it
</div>&gt; all
<div class="message-stanza open">&gt; &gt; appears to work perfectly.  I&#39;m guessing this is a case of user error,
</div>&gt; but
<div class="message-stanza open">&gt; &gt; I can&#39;t see what I&#39;ve done wrong to make $query-&gt;url give a
&gt; &gt; less-than-useful value.
</div>&gt;
&gt; Hmmm... this sounds an awful lot like:
&gt;
&gt;  <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=45019">https://rt.cpan.org/Ticket/Display.html?id=45019</a></span>
&gt;
&gt; where the &#34;path_info&#34; isn&#39;t properly set up if you&#39;re using URL
&gt; rewriting via
&gt; mod_rewrite, and as a result generated links thereafter aren&#39;t generated
&gt; the
&gt; way that you think they should be.
&gt;
&gt; Although you don&#39;t say you&#39;re using mod_rewrite in your config, this
&gt; sounds a
&gt; lot like this problem &#40;which I&#39;ve experienced ever since CGI.pm changed
&gt; its
&gt; behaviour w.r.t. this&#41;.
&gt;
&gt; Which reminds me... markstos... did you ever get any further discussion
&gt; on
&gt; this &#40;and is it something we can ever hope to see fixed in CGI.pm&#41;?
&gt;
&gt;
</div>

-- 
Lincoln D. Stein
Director, Informatics and Biocomputing Platform
Ontario Institute for Cancer Research
101 College St., Suite 800
Toronto, ON, Canada M5G0A3
416 673-8514
Assistant: Renata Musa &lt;Renata.Musa@oicr.on.ca&gt;
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;20&nbsp;01:27:06&nbsp;2010</span>
    <span class="description">GTERMARS [...] cpan.org -  Cc GTERMARS added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;28&nbsp;06:30:31&nbsp;2010</span>
    <span class="description">sec [...] 42.org - Ticket #58895:  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> CGI.pm url&#40;&#41; function bug</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 28 Jun 2010 12:30:19 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI.pm [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Stefan `Sec` Zehl &lt;sec [...] 42.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I have encountered a problem with CGI.pm&#39;s url&#40;&#41; function. When
mod_rewrite is active.

In these cases it then unconditionally clears &#34;path_info&#34; so that 
url&#40;&#41; and url&#40;-path =&gt; 1&#41; always return the same info.

Removing line 2720:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; undef $path if $rewrite_in_use &#38;&#38; $rewrite;  # path not valid when rewriting active
</div>
restores this functionality and makes it work like it should.

setting &#34;-rewrite =&gt; 0&#34; unfortunately isn&#39;t an option because it then
uses &#34;script_name&#34; instead of &#34;request_uri&#34; to construct the URL which
is not what I want.

I can see no harm in removing that line, as $path is only used if
manually requested with url&#40;-path =&gt;1&#41; - and then it should just do
what I requested, not try to second-guess.

I encountered that bug with CGI.pm 3.43 , but a quick check via CPAN
shows that the offending code is still there in 3.49

CU,
    Sec
-- 
Good spelling, punctuation, and formatting are
essentially the on-line equivalent of bathing. -- Elf Sternberg
<span class="clickylink"><a target="new" rel="nofollow" href="http://4c2877f5.w.b.cx/stamp">http://4c2877f5.w.b.cx/stamp</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;28&nbsp;09:18:07&nbsp;2010</span>
    <span class="description">MARKSTOS [...] cpan.org - Ticket #58895:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This bug report is the same as RT#45019:

<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=45019">https://rt.cpan.org/Public/Bug/Display.html?id=45019</a></span>

Please comment on fix proposed there. 

I will merge this ticket into that one shortly. 

   Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;28&nbsp;09:18:08&nbsp;2010</span>
    <span class="description">The RT System itself - Ticket #58895:  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;28&nbsp;09:18:25&nbsp;2010</span>
    <span class="description">MARKSTOS [...] cpan.org - Ticket #58895:  Merged into ticket #45019</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;28&nbsp;09:18:25&nbsp;2010</span>
    <span class="description">MARKSTOS [...] cpan.org -  Merged into ticket #45019</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;13&nbsp;15:41:44&nbsp;2011</span>
    <span class="description">MARKSTOS [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;13&nbsp;15:43:34&nbsp;2011</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jun 28 06:30:31 2010, sec@42.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; I have encountered a problem with CGI.pm&#39;s url&#40;&#41; function. When
&gt; mod_rewrite is active.
&gt; 
&gt; In these cases it then unconditionally clears &#34;path_info&#34; so that
&gt; url&#40;&#41; and url&#40;-path =&gt; 1&#41; always return the same info.
&gt; 
&gt; Removing line 2720:
<div class="message-stanza open">&gt; &gt; undef $path if $rewrite_in_use &#38;&#38; $rewrite;  # path not valid when
</div>&gt; rewriting active
&gt; 
&gt; restores this functionality and makes it work like it should.
&gt; 
&gt; setting &#34;-rewrite =&gt; 0&#34; unfortunately isn&#39;t an option because it then
&gt; uses &#34;script_name&#34; instead of &#34;request_uri&#34; to construct the URL which
&gt; is not what I want.
&gt; 
&gt; I can see no harm in removing that line, as $path is only used if
&gt; manually requested with url&#40;-path =&gt;1&#41; - and then it should just do
&gt; what I requested, not try to second-guess.
&gt; 
&gt; I encountered that bug with CGI.pm 3.43 , but a quick check via CPAN
&gt; shows that the offending code is still there in 3.49
</div>
Thanks for the report. I&#39;m considering accepting this patch, and am 
currently getting the proposal peer reviewed on the CGI::Application 
mailing list. 

I found that I&#39;m bitten by it as well-- it affects some CGI.pm upgrades, 
because older versions used to work as you proposed, some the current 
version has the bad behavior you recommend reverting. 

   Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;13&nbsp;16:47:12&nbsp;2011</span>
    <span class="description">lincoln.stein [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #45019] Needs Discussion: PATCH: url&#40;&#41; rewrite/path_info handling not compatible with CGI::Application::Dispatch rewriting</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 13 May 2011 16:47:03 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI.pm [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Lincoln Stein &lt;lincoln.stein [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think it is fair to remove the line. Caveat emptor when using mod_rewrite.
CGI.pm shouldn&#39;t try to second guess the user.

Lincoln

On Fri, May 13, 2011 at 3:43 PM, MARKSTOS via RT &lt;bug-CGI.pm@rt.cpan.org&gt;wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       Queue: CGI.pm
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=45019">https://rt.cpan.org/Ticket/Display.html?id=45019</a></span> &gt;
&gt;
&gt; On Mon Jun 28 06:30:31 2010, sec@42.org wrote:
<div class="message-stanza open">&gt; &gt; Hi,
&gt; &gt;
&gt; &gt; I have encountered a problem with CGI.pm&#39;s url&#40;&#41; function. When
&gt; &gt; mod_rewrite is active.
&gt; &gt;
&gt; &gt; In these cases it then unconditionally clears &#34;path_info&#34; so that
&gt; &gt; url&#40;&#41; and url&#40;-path =&gt; 1&#41; always return the same info.
&gt; &gt;
&gt; &gt; Removing line 2720:
<div class="message-stanza open">&gt; &gt; &gt; undef $path if $rewrite_in_use &#38;&#38; $rewrite;  # path not valid when
</div>&gt; &gt; rewriting active
&gt; &gt;
&gt; &gt; restores this functionality and makes it work like it should.
&gt; &gt;
&gt; &gt; setting &#34;-rewrite =&gt; 0&#34; unfortunately isn&#39;t an option because it then
&gt; &gt; uses &#34;script_name&#34; instead of &#34;request_uri&#34; to construct the URL which
&gt; &gt; is not what I want.
&gt; &gt;
&gt; &gt; I can see no harm in removing that line, as $path is only used if
&gt; &gt; manually requested with url&#40;-path =&gt;1&#41; - and then it should just do
&gt; &gt; what I requested, not try to second-guess.
&gt; &gt;
&gt; &gt; I encountered that bug with CGI.pm 3.43 , but a quick check via CPAN
&gt; &gt; shows that the offending code is still there in 3.49
</div>&gt;
&gt; Thanks for the report. I&#39;m considering accepting this patch, and am
&gt; currently getting the proposal peer reviewed on the CGI::Application
&gt; mailing list.
&gt;
&gt; I found that I&#39;m bitten by it as well-- it affects some CGI.pm upgrades,
&gt; because older versions used to work as you proposed, some the current
&gt; version has the bad behavior you recommend reverting.
&gt;
&gt;   Mark
&gt;
</div>


-- 
Lincoln D. Stein
Director, Informatics and Biocomputing Platform
Ontario Institute for Cancer Research
101 College St., Suite 800
Toronto, ON, Canada M5G0A3
416 673-8514
Assistant: Renata Musa &lt;Renata.Musa@oicr.on.ca&gt;
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;16&nbsp;16:21:07&nbsp;2011</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the comment, Lincoln.

As I wrote tests for this and reviewed it more detail, it clearer to me 
that this is not just a &#34;behavior change&#34;, it&#39;s a bug fix for a bug that 
happens to be very old. 

I was considering doing a &#34;developer release&#34; for a comment period on 
the change, but now that&#39;s more clearly a bug fix, I think we should go 
ahead with a next release, with a clear warning in the &#34;Changes&#34; file 
that people may have come to depend on the old-but-buggy behavior, and 
should check their apps. 

The full proposed diff is here. I&#39;ve also posted into the 
CGI::Application mailing list. 

Excepting blocking feedback, I would plan to release the new version 
later this week &#40; and excepting that my wife doesn&#39;t go into labor this 
week &#41;.

<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/markstos/CGI.pm/commit/0023f178943c687333285713971ea8">https://github.com/markstos/CGI.pm/commit/0023f178943c687333285713971ea8</a></span>
2e54b3dcc6

   Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;03&nbsp;11:40:29&nbsp;2011</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">My wife did go into labor, but I&#39;m back at work now after paternity leave 
and have just now pushed 3.55 to CPAN to address solely this issue. 

Resolving. 

  Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;03&nbsp;11:40:31&nbsp;2011</span>
    <span class="description">MARKSTOS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;05&nbsp;21:32:07&nbsp;2011</span>
    <span class="description">yanick [...] babyl.dyndns.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #45019] Needs Discussion: PATCH: url&#40;&#41; rewrite/path_info handling not compatible with CGI::Application::Dispatch rewriting</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 05 Jun 2011 21:33:49 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI.pm [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Yanick Champoux &lt;yanick [...] babyl.dyndns.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 11-06-03 11:40 AM, MARKSTOS via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; My wife did go into labor, but I&#39;m back at work now after paternity leave
&gt; and have just now pushed 3.55 to CPAN to address solely this issue.
</div>
Absolutely unrelated to the ticket, but I just read this, and I have to 
send my congrats to the happy dad and mom, and my welcomes to the new 
wee hacker. :-&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;05&nbsp;21:32:10&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;06&nbsp;10:47:23&nbsp;2011</span>
    <span class="description">MARKSTOS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;May&nbsp;23&nbsp;14:29:30&nbsp;2014</span>
    <span class="description">The RT System itself -  Queue changed from CGI.pm to CGI</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
