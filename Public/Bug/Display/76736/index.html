<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #76736 for Imager: Images from clipboard fail</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #76736 for Imager: Images from clipboard fail</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Imager/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Imager/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Imager/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Imager/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Imager">Imager CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">76736</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Imager/Active/">Imager</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ben-goldberg [...] hotmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-16790-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-16791-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;21&nbsp;00:32:33&nbsp;2012</span>
    <span class="description">ben-goldberg [...] hotmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Images from clipboard fail</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 21 Apr 2012 00:32:16 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-imager [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Benjamin Goldberg &lt;ben-goldberg [...] hotmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
The following test program...
use strict;use warnings;
use Win32::GuiTest &#39;:FUNC&#39;;
my &#40;$win&#41; = FindWindowLike&#40;undef, &#34;Command Prompt&#34;&#41;   or die &#34;Couldn&#39;t find window\n&#34;;my $prior = SetActiveWindow&#40;$win&#41;;END {   SetActiveWindow&#40;$prior&#41; if $prior &#38;&#38; GetActiveWindow&#40;&#41; == $win;}SendKeys&#40;&#39;%{PRTSCR}&#39;&#41;;
use Win32::Clipboard;my $clip = Win32::Clipboard-&gt;new-&gt;GetBitmap&#40;&#41;   or die &#34;No BMP in clipboard&#34;;
my @header = unpack&#40;&#39;aaVvvVVV!V!vvVVVVVV&#39;, $clip&#41;;my @hnames = qw&#40;b m filesize res1 res2 offbits infohead_size  xsize ysize planes bitcount compression size_image      xres yres clr_use clr_important&#41;;die &#34;oops&#34; if @hnames != @header;print &#34;$hnames[$_]:\t$header[$_]\n&#34; for 0..$#header;
use Imager; # print &#34;Imager loaded.\n&#34;;my $img = Imager-&gt;new;$img-&gt;read&#40;data=&gt;$clip, type=&gt;&#39;bmp&#39;&#41;   or die &#34;Imager-&gt;read failed: &#34;, $img-&gt;errstr&#40;&#41;;__END__


Fails, with the following output:

b:      Bm:      Mfilesize:       1942610res1:   0res2:   0offbits:        66infohead_size:  40xsize:  668ysize:  727planes: 1bitcount:       32compression:    3size_image:     1942544xres:   0yres:   0clr_use:        0clr_important:  0Imager-&gt;read failed: image data offset too small &#40;66&#41; at fail.pl line 27.
Looking through the source code on CPAN, I notice that in bmp.c, whencompression is equal to 3 &#40;aka BI_BITFIELDS&#41;, the error producing code is reached if offbitsis less than FILEHEAD_SIZE + INFOHEAD_SIZE + 4 * 4... aka 14   + 40   + 16, or 70...
Obviously, the value 66   is less than 70, producing the message.
Since the image was produced by Windows itself, it shouldbe safe to assume that the image is well formed.
Are you certain that adding 4 * 4 to base_offset is the correct thing to do?

According to Wikipedia&#39;s file on the BMP file format:


The color table &#40;palette&#41; occurs in the BMP image file directly after the BMP file header, the DIB header &#40;and after optional three red, green and blue bitmasks if the BITMAPINFOHEADER header with BI_BITFIELDS option is used&#41;. Therefore, its offset is the size of the BITMAPFILEHEADER plus the size of the DIB header &#40;plus optional 2  bytes for the three bit masks&#41;.
Note: On Windows CE the BITMAPINFOHEADER header can be used with the BI_ALPHABITFIELDS[2] option in the biCompression member. In such case, four optional bitmasks follow the BITMAPINFOHEADER header instead of the two bitmask mentioned above, thus the color table&#39;s offset is the size of the BITMAPFILEHEADER plus the size of the BITMAPINFOHEADER header plus the 6  bytes of the four bitmasks &#40;red, green, blue and alpha&#41;.


Maybe you should be adding &#34;3 * 4&#34; instead of &#34;4 * 4&#34; ?



I&#39;m using Imager version .75, Windows XP, and perl -V produces:
Summary of my perl5 &#40;revision 5 version 12 subversion 1&#41; configuration:
  Platform:    osname=MSWin32, osvers=5.1, archname=MSWin32-x86-multi-thread    uname=&#39;Win32 strawberryperl 5.12.1.0 #1 Thu Jul 29 10:08:11 2010 i386&#39;    config_args=&#39;undef&#39;    hint=recommended, useposix=true, d_sigaction=undef    useithreads=define, usemultiplicity=define    useperlio=define, d_sfio=undef, uselargefiles=define, usesocks=undef    use64bitint=undef, use64bitall=undef, uselongdouble=undef    usemymalloc=n, bincompat5005=undef  Compiler:    cc=&#39;gcc&#39;, ccflags =&#39; -s -O2 -DWIN32 -DHAVE_DES_FCRYPT  -DUSE_SITECUSTOMIZE -DPERL_IMPLICIT_CONTEXT -DPERL_IMPLICIT_SYS -fno-strict-aliasing -mms-bitfields -DPERL_MSVCRT_READFIX&#39;,    optimize=&#39;-s -O2&#39;,    cppflags=&#39;-DWIN32&#39;    ccversion=&#39;&#39;, gccversion=&#39;4.4.3&#39;, gccosandvers=&#39;&#39;    intsize=4, longsize=4, ptrsize=4, doublesize=8, byteorder=1234    d_longlong=undef, longlongsize=8, d_longdbl=define, longdblsize=12    ivtype=&#39;long&#39;, ivsize=4, nvtype=&#39;double&#39;, nvsize=8, Off_t=&#39;long long&#39;, lseeksize=8    alignbytes=8, prototype=define  Linker and Libraries:    ld=&#39;g++&#39;, ldflags =&#39;-s -L&#34;C:\strawberry\perl\lib\CORE&#34; -L&#34;C:\strawberry\c\lib&#34;&#39;    libpth=C:\strawberry\c\lib C:\strawberry\c\i686-w64-mingw32\lib    libs=-lmoldname -lkernel32 -luser32 -lgdi32 -lwinspool -lcomdlg32 -ladvapi32 -lshell32 -lole32 -loleaut32 -lnetapi32 -luuid -lws2_32 -lmpr -lwinmm -lversion -lodbc32 -lodbccp32 -lcomctl32    perllibs=-lmoldname -lkernel32 -luser32 -lgdi32 -lwinspool -lcomdlg32 -ladvapi32 -lshell32 -lole32 -loleaut32 -lnetapi32 -luuid -lws2_32 -lmpr -lwinmm -lversion -lodbc32 -lodbccp32 -lcomctl32    libc=, so=dll, useshrplib=true, libperl=libperl512.a    gnulibc_version=&#39;&#39;  Dynamic Linking:    dlsrc=dl_win32.xs, dlext=dll, d_dlsymun=undef, ccdlflags=&#39; &#39;    cccdlflags=&#39; &#39;, lddlflags=&#39;-mdll -s -L&#34;C:\strawberry\perl\lib\CORE&#34; -L&#34;C:\strawberry\c\lib&#34;&#39;

Characteristics of this binary &#40;from libperl&#41;:  Compile-time options: MULTIPLICITY PERL_DONT_CREATE_GVSV                        PERL_IMPLICIT_CONTEXT PERL_IMPLICIT_SYS                        PERL_MALLOC_WRAP PL_OP_SLAB_ALLOC USE_ITHREADS                        USE_LARGE_FILES USE_PERLIO USE_PERL_ATOF                        USE_SITECUSTOMIZE  Built under MSWin32  Compiled at Jul 29 2010 16:46:09  @INC:    C:/strawberry/perl/site/lib    C:/strawberry/perl/vendor/lib    C:/strawberry/perl/lib    .                                       
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;22&nbsp;20:58:09&nbsp;2012</span>
    <span class="description">TONYC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Apr 21 00:32:33 2012, ben-goldberg@hotmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Fails, with the following output:
&gt; 
&gt; b:      Bm:      Mfilesize:       1942610res1:   0res2:   0offbits:
&gt;    66infohead_size:  40xsize:  668ysize:  727planes: 1bitcount:
&gt;    32compression:    3size_image:     1942544xres:   0yres:
&gt;    0clr_use:        0clr_important:  0Imager-&gt;read failed: image data
&gt;    offset too small &#40;66&#41; at fail.pl line 27.
&gt; Looking through the source code on CPAN, I notice that in bmp.c,
&gt;    whencompression is equal to 3 &#40;aka BI_BITFIELDS&#41;, the error
&gt;    producing code is reached if offbitsis less than FILEHEAD_SIZE +
&gt;    INFOHEAD_SIZE + 4 * 4... aka 14   + 40   + 16, or 70...
&gt; Obviously, the value 66   is less than 70, producing the message.
&gt; Since the image was produced by Windows itself, it shouldbe safe to
&gt;    assume that the image is well formed.
&gt; Are you certain that adding 4 * 4 to base_offset is the correct thing
&gt;    to do?
</div>
Thank you, I&#39;ve reproduced this locally.

The problem I has with the BI_BITFIELDS format was finding images to
test with.

This solves that and should let me add some tests and fixes for the
behaviour you&#39;re seeing.

I expect I&#39;ll fix this for the next release of Imager.

Tony
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;22&nbsp;20:58:10&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;24&nbsp;23:07:31&nbsp;2012</span>
    <span class="description">TONYC [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;30&nbsp;09:13:13&nbsp;2012</span>
    <span class="description">TONYC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Apr 21 00:32:33 2012, ben-goldberg@hotmail.com wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Fails, with the following output:
&gt; 
&gt; b:      Bm:      Mfilesize:       1942610res1:   0res2:   0offbits:
&gt;    66infohead_size:  40xsize:  668ysize:  727planes: 1bitcount:
&gt;    32compression:    3size_image:     1942544xres:   0yres:
&gt;    0clr_use:        0clr_important:  0Imager-&gt;read failed: image data
&gt;    offset too small &#40;66&#41; at fail.pl line 27.
&gt; Looking through the source code on CPAN, I notice that in bmp.c,
&gt;    whencompression is equal to 3 &#40;aka BI_BITFIELDS&#41;, the error
&gt;    producing code is reached if offbitsis less than FILEHEAD_SIZE +
&gt;    INFOHEAD_SIZE + 4 * 4... aka 14   + 40   + 16, or 70...
&gt; Obviously, the value 66   is less than 70, producing the message.
&gt; Since the image was produced by Windows itself, it shouldbe safe to
&gt;    assume that the image is well formed.
&gt; Are you certain that adding 4 * 4 to base_offset is the correct thing
&gt;    to do?
</div>
Thank you.  This is fixed in Imager 0.90, along with some other BMP issues.

Tony
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;30&nbsp;09:13:13&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;30&nbsp;09:13:13&nbsp;2012</span>
    <span class="description">TONYC [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
