<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #118032 for XML-LibXML: External entities are parsed by default</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #118032 for XML-LibXML: External entities are parsed by default</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/XML-LibXML/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-LibXML">XML-LibXML CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">118032</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/XML-LibXML/Active/">XML-LibXML</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ppisar [...] redhat.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
CARNIL [...] cpan.org

<br />
gortan [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-37350-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.0128    </td>
  </tr>
  <tr id="CF-37351-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;22&nbsp;07:44:39&nbsp;2016</span>
    <span class="description">ppisar [...] redhat.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> External entities are parsed by default</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">$XML::LibXML::XML_LIBXML_PARSE_DEFAULTS is set to XML_PARSE_NODICT | XML_PARSE_DTDLOAD | XML_PARSE_NOENT. That overrides libxml2 default behavior that stopped processing external entities by default many years ago &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://git.gnome.org/browse/libxml2/commit/?id=4629ee02ac649c27f9c0cf98ba017c6b5526070f">https://git.gnome.org/browse/libxml2/commit/?id=4629ee02ac649c27f9c0cf98ba017c6b5526070f</a></span>&gt; because it could leak data from a local file system or a local network.

This XML-LibXML issue was reported to Debian &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=838097">https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=838097</a></span>&gt; and to Fedora &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://bugzilla.redhat.com/show_bug.cgi?id=1377996">https://bugzilla.redhat.com/show_bug.cgi?id=1377996</a></span>&gt;.

Would it be possible to change XML-LibXML default behavior in similar way?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;30&nbsp;09:01:29&nbsp;2016</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Čt 22.zář.2016 07:44:39, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; $XML::LibXML::XML_LIBXML_PARSE_DEFAULTS is set to XML_PARSE_NODICT |
&gt; XML_PARSE_DTDLOAD | XML_PARSE_NOENT. That overrides libxml2 default
&gt; behavior that stopped processing external entities by default
</div>
Attached patch disables expanding entities. Maybe XML_PARSE_DTDLOAD should be disables also.

Or maybe one should define a default ext_ent_handler that always. That could preserve ability to expand internal entities.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Do-not-enable-expanding-entities-by-default.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 05749ae525317d05bd9d4232c080e530854f1d88 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Fri, 30 Sep 2016 14:31:26 +0200
Subject: [PATCH] Do not enable expanding entities by default
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Expanding external entity is insecure.
&lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://www.owasp.org/index.php/XML_External_Entity_&#40;XXE&#41;_Processing">https://www.owasp.org/index.php/XML_External_Entity_&#40;XXE&#41;_Processing</a></span>&gt;.
This patch makes expand_entities option disabled by default.

CPAN RT#118032

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 LibXML.pm       | 2 +-
 docs/libxml.dbk | 2 +-
 t/43options.t   | 4 ++--
 3 files changed, 4 insertions&#40;+&#41;, 4 deletions&#40;-&#41;

diff --git a/LibXML.pm b/LibXML.pm
index eb3cbd6..9ab4748 100644
--- a/LibXML.pm
+++ b/LibXML.pm
@@ -261,7 +261,7 @@ use constant {
   HTML_PARSE_NOERROR  =&gt; &#40;1&lt;&lt;5&#41;,       # suppress error reports
 };
 
-$XML_LIBXML_PARSE_DEFAULTS = &#40; XML_PARSE_NODICT | XML_PARSE_DTDLOAD | XML_PARSE_NOENT &#41;;
+$XML_LIBXML_PARSE_DEFAULTS = &#40; XML_PARSE_NODICT | XML_PARSE_DTDLOAD &#41;;
 
 # this hash is made global so that applications can add names for new
 # libxml2 parser flags as temporary workaround
diff --git a/docs/libxml.dbk b/docs/libxml.dbk
index 30f279b..2c6674b 100644
--- a/docs/libxml.dbk
+++ b/docs/libxml.dbk
@@ -1676,7 +1676,7 @@ local $XML::LibXML::setTagCompression = 1;&lt;/programlisting&gt;
             &lt;term&gt;expand_entities&lt;/term&gt;
             &lt;listitem&gt;
 	      &lt;para&gt;/parser, reader/&lt;/para&gt;
-              &lt;para&gt;substitute entities; possible values are 0 and 1; default is 1&lt;/para&gt;
+              &lt;para&gt;substitute entities; possible values are 0 and 1; default is 0&lt;/para&gt;
 	      &lt;para&gt;Note that although this flag disables entity substitution, it
 	      does not prevent the parser from loading external entities;
 	      when substitution of an external entity is disabled, the
diff --git a/t/43options.t b/t/43options.t
index 826f0ad..53dd35e 100644
--- a/t/43options.t
+++ b/t/43options.t
@@ -50,7 +50,7 @@ no_network
 {
   my $p = XML::LibXML-&gt;new&#40;&#41;;
   for my $opt &#40;@all&#41; {
-    my $ret = &#40;&#40;$opt =~ /^&#40;?:load_ext_dtd|expand_entities&#41;$/&#41; ? 1 : 0&#41;;
+    my $ret = &#40;&#40;$opt =~ /^&#40;?:load_ext_dtd&#41;$/&#41; ? 1 : 0&#41;;
     # TEST*$all
     ok&#40;
         &#40;$p-&gt;get_option&#40;$opt&#41;||0&#41; == $ret
@@ -110,7 +110,7 @@ no_network
   ok&#40; $p-&gt;get_option&#40;&#39;recover&#39;&#41; == 2, &#39; TODO : Add test name&#39; &#41;;
 
   # TEST
-  ok&#40; $p-&gt;expand_entities&#40;&#41; == 1, &#39; TODO : Add test name&#39; &#41;;
+  ok&#40; $p-&gt;expand_entities&#40;&#41; == 0, &#39; TODO : Add test name&#39; &#41;;
   # TEST
   ok&#40; $p-&gt;load_ext_dtd&#40;&#41; == 1, &#39; TODO : Add test name&#39; &#41;;
   $p-&gt;load_ext_dtd&#40;0&#41;;
-- 
2.7.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;02&nbsp;01:42:57&nbsp;2016</span>
    <span class="description">CARNIL [...] cpan.org -  Cc CARNIL added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;02&nbsp;11:18:43&nbsp;2016</span>
    <span class="description">john [...] nixnuts.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Sep 22 07:44:39 2016, ppisar wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; $XML::LibXML::XML_LIBXML_PARSE_DEFAULTS is set to XML_PARSE_NODICT |
&gt; XML_PARSE_DTDLOAD | XML_PARSE_NOENT. That overrides libxml2 default
&gt; behavior that stopped processing external entities by default many
&gt; years ago
&gt; &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://git.gnome.org/browse/libxml2/commit/?id=4629ee02ac649c27f9c0cf98ba017c6b5526070f">https://git.gnome.org/browse/libxml2/commit/?id=4629ee02ac649c27f9c0cf98ba017c6b5526070f</a></span>&gt;
&gt; because it could leak data from a local file system or a local
&gt; network.
&gt; 
&gt; This XML-LibXML issue was reported to Debian
&gt; &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=838097">https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=838097</a></span>&gt; and to
&gt; Fedora &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://bugzilla.redhat.com/show_bug.cgi?id=1377996">https://bugzilla.redhat.com/show_bug.cgi?id=1377996</a></span>&gt;.
&gt; 
&gt; Would it be possible to change XML-LibXML default behavior in similar
&gt; way?
</div>
If the default behavior with external entities is being changed to prevent XXE attacks, please also change the default behavior to NOT load external DTDs.

DTD loading by default is an SSRF attack.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;02&nbsp;11:18:44&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;28&nbsp;22:32:31&nbsp;2018</span>
    <span class="description">KENTNL [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza">The given patch as stated seems to be over-applied.<br>

<br>

Not only does it inhibit expanding external entities, but it inhibits expanding native entity encodings such as &amp;#38;<br>

<br>

Subsequently, applying this patch breaks XML-Simple when it runs its tests using XML::LibXML::SAX due to expecting to decode &quot;&amp;#38;&quot; as &quot;&amp;&quot; , and instead getting it undecoded as &quot;&amp;#38;&quot;<br>

<br>

--&nbsp;<br>

- CPAN kentnl@cpan.org<br>

- Gentoo Perl Maintainer kentnl@gentoo.org ( perl@gentoo.org )<br>


</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;03&nbsp;11:31:56&nbsp;2018</span>
    <span class="description">gortan [...] cpan.org -  Cc GORTAN added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;24&nbsp;03:59:42&nbsp;2019</span>
    <span class="description">tim [...] retout.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have started a pull request on github which changes both the load_ext_dtd and expand_entities defaults:

<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/shlomif/perl-XML-LibXML/pull/39">https://github.com/shlomif/perl-XML-LibXML/pull/39</a></span>

Some doc fixes are still required.

I added a test which confirms that the behaviour of the predefined entities &#40;as mentioned by KENTNL&#41; should not change, but I have not yet tested that XML::Simple builds.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
