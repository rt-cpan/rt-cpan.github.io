<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #125218 for Net-SSLeay: libnet-ssleay-perl/1.85: Testsuite fails against openssl 1.1.1 &#40;current beta&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #125218 for Net-SSLeay: libnet-ssleay-perl/1.85: Testsuite fails against openssl 1.1.1 &#40;current beta&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-SSLeay/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-SSLeay">Net-SSLeay CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">125218</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-SSLeay/Active/">Net-SSLeay</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">chrisn [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
sebastian [...] breakpoint.cc

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
dam [...] cpan.org

<br />
gregoa [...] cpan.org

<br />
SREZIC [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-44414-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-44415-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.86_06    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;26&nbsp;16:34:25&nbsp;2018</span>
    <span class="description">sebastian [...] breakpoint.cc -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> libnet-ssleay-perl/1.85: Testsuite fails against openssl 1.1.1 &#40;current beta&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 26 Apr 2018 22:21:16 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Sebastian Andrzej Siewior &lt;sebastian [...] breakpoint.cc&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

The testuite of libnet-ssleay-perl/1.85 fails against openssl 1.1.1
&#40;current beta&#41;. This is t/local/07_sslecho.t I refer here to.

The SSL_read&#40;&#41; and SSL_write&#40;&#41; wrapper need to handle a possible retry.
The man-page for both function [0] says that it might need to be retried
with the same arguments. With the following hunk:

diff --git a/SSLeay.xs b/SSLeay.xs
--- a/SSLeay.xs
+++ b/SSLeay.xs
@@ -1999,7 +1999,17 @@ SSL_read&#40;s,max=32768&#41;
        int got;
     PPCODE:
        New&#40;0, buf, max, char&#41;;
-       got = SSL_read&#40;s, buf, max&#41;;
+
+       do {
+               int err;
+
+               got = SSL_read&#40;s, buf, max&#41;;
+               if &#40;got &gt; 0&#41;
+                       break;
+               err = SSL_get_error&#40;s, got&#41;;
+               if &#40;err != SSL_ERROR_WANT_READ&#41;
+                       break;
+       } while &#40;1&#41;;
 
        /* If in list context, return 2-item list:
         *   first return value:  data gotten, or undef on error &#40;got&lt;0&#41;
@@ -2051,10 +2061,20 @@ SSL_write&#40;s,buf&#41;
      SSL *   s
      PREINIT:
      STRLEN len;
+     int err;
+     int ret;
      INPUT:
      char *  buf = SvPV&#40; ST&#40;1&#41;, len&#41;;
      CODE:
-     RETVAL = SSL_write &#40;s, buf, &#40;int&#41;len&#41;;
+     do {
+            ret = SSL_write &#40;s, buf, &#40;int&#41;len&#41;;
+            if &#40;ret &gt; 0&#41;
+                    break;
+            err = SSL_get_error&#40;s, ret&#41;;
+            if &#40;err != SSL_ERROR_WANT_WRITE&#41;
+                    break;
+     } while &#40;1&#41;;
+     RETVAL = ret;
      OUTPUT:
      RETVAL
 
@@ -2083,8 +2103,20 @@ SSL_write_partial&#40;s,from,count,buf&#41;
      if &#40;len &lt; 0&#41; {
        croak&#40;&#34;from beyound end of buffer&#34;&#41;;
        RETVAL = -1;
-     } else
-       RETVAL = SSL_write &#40;s, &#38;&#40;buf[from]&#41;, &#40;count&lt;=len&#41;?count:len&#41;;
+     } else {
+            int ret;
+            int err;
+
+            do {
+                    ret = SSL_write &#40;s, &#38;&#40;buf[from]&#41;, &#40;count&lt;=len&#41;?count:len&#41;;
+                    if &#40;ret &gt; 0&#41;
+                            break;
+                    err = SSL_get_error&#40;s, ret&#41;;
+                    if &#40;err != SSL_ERROR_WANT_WRITE&#41;
+                            break;
+            } while &#40;1&#41;;
+            RETVAL = ret;
+     }
      OUTPUT:
      RETVAL

I was able to let the test-suite continue a little further. As per
upstream [1] this was always the case it worked by coincidence before.

The next thing is that step 24 within 07_sslecho.t blocks forever. As it
turns out one side does &#34;shutdown $s, 2;&#34; &#40;around line 170&#41; while the
other does a read+write operation. In &#34;older&#34; openssl is seems to just
work but in the newer one SIGPIPE is received and this seems to
stall/block the test case. By adding:

index 5e16b04b55ea..c60afccc0051 100644
--- a/t/local/07_sslecho.t
+++ b/t/local/07_sslecho.t
@@ -14,6 +14,7 @@ BEGIN {
 }
 
 plan tests =&gt; 78;
+$SIG{&#39;PIPE&#39;} = &#39;IGNORE&#39;;
 
 my $sock;
 my $pid;
&#40;
 
it does not stall anymore but complains about the return value from
write:

ok 21 - get_cipher
ok 22 - get_shared_ciphers
ok 23 - ssl_read_all
not ok 24 - ssl_write_all
#   Failed test &#39;ssl_write_all&#39;
#   at t/local/07_sslecho.t line 88.
ok 25 - new

This should be okay since the other side never reads anything and just
shutdowns the socket. Upstream recommends to use SSL_shutdown&#40;&#41; instead
of operating on sockets directly.
I&#39;m forwanding this from the Debian bug [2] I reported but received no
feedback so far.

[0] <span class="clickylink"><a target="new" rel="nofollow" href="https://manpages.debian.org/stretch/libssl-doc/SSL_read.3ssl.en.html#WARNING">https://manpages.debian.org/stretch/libssl-doc/SSL_read.3ssl.en.html#WARNING</a></span>
[1] <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/openssl/openssl/issues/5637#issuecomment-381364019">https://github.com/openssl/openssl/issues/5637#issuecomment-381364019</a></span>
[2] <span class="clickylink"><a target="new" rel="nofollow" href="https://bugs.debian.org/895959">https://bugs.debian.org/895959</a></span>

Sebastian
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;01&nbsp;09:11:20&nbsp;2018</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Čt 26.dub.2018 16:34:25, sebastian@breakpoint.cc napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The testuite of libnet-ssleay-perl/1.85 fails against openssl 1.1.1
&gt; &#40;current beta&#41;. This is t/local/07_sslecho.t I refer here to.
&gt; 
&gt; The SSL_read&#40;&#41; and SSL_write&#40;&#41; wrapper need to handle a possible
&gt; retry.
&gt; The man-page for both function [0] says that it might need to be
&gt; retried
&gt; with the same arguments. With the following hunk:
&gt; 
</div>Funnily, SSL_read&#40;&#41; can return SSL_ERROR_WANT_WRITE and SSL_write&#40;&#41; can return SSL_ERROR_WANT_READ. But I don&#39;t understand when it can happen &#40;buffered BIO only?&#41; and what remedy should be used. The patch obviously does not handle them.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The next thing is that step 24 within 07_sslecho.t blocks forever. As
&gt; it
&gt; turns out one side does &#34;shutdown $s, 2;&#34; &#40;around line 170&#41; while the
&gt; other does a read+write operation. In &#34;older&#34; openssl is seems to just
&gt; work but in the newer one SIGPIPE is received and this seems to
&gt; stall/block the test case. By adding:
&gt; 
&gt; index 5e16b04b55ea..c60afccc0051 100644
&gt; --- a/t/local/07_sslecho.t
&gt; +++ b/t/local/07_sslecho.t
&gt; @@ -14,6 +14,7 @@ BEGIN {
&gt;  }
&gt; 
&gt; plan tests =&gt; 78;
&gt; +$SIG{&#39;PIPE&#39;} = &#39;IGNORE&#39;;
&gt; 
</div>How is it possible an operation on a TCP socket generates a SIGPIPE? This should happen only on pipes. Does OpenSSL use some pipes underneath?

Here the the SIGPIPE is received by the child performing ssl_read_all&#40;&#41; when the TCP client closes TCP connection just after sending the data. I don&#39;t think application should expect and handle SIGPIPE in this case.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;01&nbsp;09:11:22&nbsp;2018</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;01&nbsp;09:26:17&nbsp;2018</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne St 01.srp.2018 09:11:20, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; How is it possible an operation on a TCP socket generates a SIGPIPE?
&gt; This should happen only on pipes. Does OpenSSL use some pipes
&gt; underneath?
&gt;
</div>Now I found in socket&#40;7&#41; that the SIGPIPE is generated on a write to any half-closed connection-oriented socket. Not only for pipes.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;02&nbsp;10:35:56&nbsp;2018</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Čt 26.dub.2018 16:34:25, sebastian@breakpoint.cc napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; it does not stall anymore but complains about the return value from
&gt; write:
&gt; 
&gt; ok 21 - get_cipher
&gt; ok 22 - get_shared_ciphers
&gt; ok 23 - ssl_read_all
&gt; not ok 24 - ssl_write_all
&gt; #   Failed test &#39;ssl_write_all&#39;
&gt; #   at t/local/07_sslecho.t line 88.
&gt; ok 25 - new
&gt; 
&gt; This should be okay since the other side never reads anything and just
&gt; shutdowns the socket. Upstream recommends to use SSL_shutdown&#40;&#41;
&gt; instead
&gt; of operating on sockets directly.
</div>
Adding SSL_shutdown everywhere where appropriate &#40;e.g. into sslcat&#40;&#41;&#41; fixes some t/local/07_sslecho.t subtest failures but causes new ones.

I think the issue is many of the tests including sslcat&#40;&#41; function would violate TLS &lt;= 1.2 if they use SSL_shutdown&#40;&#41;. TLS 1.2 RFC mandates that if a peer receives close_notify event it must also send close_notify and must not send any other data. TLS 1.3 changed that and allowed closing only one direction of the connection and still keeping sending the other direction. But how to write a code that conforms both of the protocols is unknown to me.

A tempting solution is not using SSL_shutdown&#40;&#41; at all, but that returns us to the issues with the current patch and it also goes against TLS 1.3 that recommends sending close_notify events to prevent from an attacker from spoofing premature end of a stream.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;10&nbsp;11:09:00&nbsp;2018</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Čt 26.dub.2018 16:34:25, sebastian@breakpoint.cc napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The testuite of libnet-ssleay-perl/1.85 fails against openssl 1.1.1
&gt; &#40;current beta&#41;.
</div>
After talking to OpenSSL developers I implemented the attached fix. It includes Sebastian&#39;s patch and it adapts the tests rather than the library. That means that most of the OpenSSL changes will be visible to Net::SSLeay users. 

E.g. SIGPIPE in a server where data are only received and no proper two-way TLS shutdown is performed.

E.g. undef returned from Net::SSLeay::read&#40;&#41; after the TLS session is closed.

E.g. not working session resumption if the client does not employ session ticket callback.

The fix also adds wrappers for SSL_CTX_set_num_tickets&#40;&#41; functions introduced in OpenSSL 1.1.1.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Adapt-to-OpenSSL-1.1.1.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From b01291bf88dd84529c93973da7c275e0ffe5cc1f Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Fri, 3 Aug 2018 14:30:22 +0200
Subject: [PATCH] Adapt to OpenSSL 1.1.1
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

OpenSSL 1.1.1 defaults to TLS 1.3 that handles session tickets and
session shutdowns differently. This leads to failing various Net-SSLeay
tests that exhibits use cases that are not possible with OpenSSL 1.1.1
anymore or where the library behaves differently.

Since Net-SSLeay is a low-level wrapper, Net-SSLeay will be corrected
in tests. Higher-level code as IO::Socket::SSL and other Net::SSLeay
applications need to be adjusted on case-to-case basis.

This patche changes:

- Retry SSL_read&#40;&#41; and SSL_write&#40;&#41; &#40;by sebastian [...] breakpoint.cc&#41;
- Disable session tickets in t/local/07_sslecho.t.
- Adaps t/local/36_verify.t to a session end when Net::SSLeay::read&#40;&#41;
  returns undef.

<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=125218">https://rt.cpan.org/Public/Bug/Display.html?id=125218</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/openssl/openssl/issues/5637">https://github.com/openssl/openssl/issues/5637</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/openssl/openssl/issues/6904">https://github.com/openssl/openssl/issues/6904</a></span>
Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 SSLeay.xs            | 56 ++++++++++++++++++++++++++++++++++++++++++++++++----
 lib/Net/SSLeay.pod   | 46 ++++++++++++++++++++++++++++++++++++++++++
 t/local/07_sslecho.t | 15 ++++++++++++--
 t/local/36_verify.t  |  2 +-
 4 files changed, 112 insertions&#40;+&#41;, 7 deletions&#40;-&#41;

diff --git a/SSLeay.xs b/SSLeay.xs
index bf148c0..5aed4d7 100644
--- a/SSLeay.xs
+++ b/SSLeay.xs
@@ -1999,7 +1999,17 @@ SSL_read&#40;s,max=32768&#41;
 	int got;
     PPCODE:
 	New&#40;0, buf, max, char&#41;;
-	got = SSL_read&#40;s, buf, max&#41;;
+
+	do {
+		int err;
+
+		got = SSL_read&#40;s, buf, max&#41;;
+		if &#40;got &gt; 0&#41;
+			break;
+		err = SSL_get_error&#40;s, got&#41;;
+		if &#40;err != SSL_ERROR_WANT_READ &#38;&#38; err != SSL_ERROR_WANT_WRITE&#41;
+			break;
+	} while &#40;1&#41;;
 
 	/* If in list context, return 2-item list:
 	 *   first return value:  data gotten, or undef on error &#40;got&lt;0&#41;
@@ -2051,10 +2061,20 @@ SSL_write&#40;s,buf&#41;
      SSL *   s
      PREINIT:
      STRLEN len;
+     int err;
+     int ret;
      INPUT:
      char *  buf = SvPV&#40; ST&#40;1&#41;, len&#41;;
      CODE:
-     RETVAL = SSL_write &#40;s, buf, &#40;int&#41;len&#41;;
+     do {
+	     ret = SSL_write &#40;s, buf, &#40;int&#41;len&#41;;
+	     if &#40;ret &gt; 0&#41;
+		     break;
+	     err = SSL_get_error&#40;s, ret&#41;;
+	     if &#40;err != SSL_ERROR_WANT_READ &#38;&#38; err != SSL_ERROR_WANT_WRITE&#41;
+		     break;
+     } while &#40;1&#41;;
+     RETVAL = ret;
      OUTPUT:
      RETVAL
 
@@ -2083,8 +2103,20 @@ SSL_write_partial&#40;s,from,count,buf&#41;
      if &#40;len &lt; 0&#41; {
        croak&#40;&#34;from beyound end of buffer&#34;&#41;;
        RETVAL = -1;
-     } else
-       RETVAL = SSL_write &#40;s, &#38;&#40;buf[from]&#41;, &#40;count&lt;=len&#41;?count:len&#41;;
+     } else {
+	     int ret;
+	     int err;
+
+	     do {
+		     ret = SSL_write &#40;s, &#38;&#40;buf[from]&#41;, &#40;count&lt;=len&#41;?count:len&#41;;
+		     if &#40;ret &gt; 0&#41;
+			     break;
+		     err = SSL_get_error&#40;s, ret&#41;;
+		     if &#40;err != SSL_ERROR_WANT_READ &#38;&#38; err != SSL_ERROR_WANT_WRITE&#41;
+			     break;
+	     } while &#40;1&#41;;
+	     RETVAL = ret;
+     }
      OUTPUT:
      RETVAL
 
@@ -6957,4 +6989,20 @@ SSL_export_keying_material&#40;ssl, outlen, label, p&#41;
 
 #endif
 
+#if OPENSSL_VERSION_NUMBER &gt;= 0x1010100fL
+
+int
+SSL_CTX_set_num_tickets&#40;SSL_CTX *ctx,size_t num_tickets&#41;
+
+size_t
+SSL_CTX_get_num_tickets&#40;SSL_CTX *ctx&#41;
+
+int
+SSL_set_num_tickets&#40;SSL *ssl,size_t num_tickets&#41;
+
+size_t
+SSL_get_num_tickets&#40;SSL *ssl&#41;
+
+#endif
+
 #define REM_EOF &#34;/* EOF - SSLeay.xs */&#34;
diff --git a/lib/Net/SSLeay.pod b/lib/Net/SSLeay.pod
index 2e1aae3..bca7be4 100644
--- a/lib/Net/SSLeay.pod
+++ b/lib/Net/SSLeay.pod
@@ -4437,6 +4437,52 @@ getticket&#40;$ssl,$ticket,$data&#41; -&gt; $return_value
 
 This function is based on the OpenSSL function SSL_set_session_ticket_ext_cb.
 
+=item * CTX_set_num_tickets
+
+B&lt;COMPATIBILITY:&gt; not available in Net-SSLeay-1.85 and before; requires at least OpenSSL 1.1.1
+
+Set number of session tickets that will be sent to a client.
+
+ my $rv = Net::SSLeay::CTX_set_num_tickets&#40;$ctx, $number_of_tickets&#41;;
+ # $ctx  - value corresponding to openssl&#39;s SSL_CTX structure
+ # $number_of_tickets - number of tickets to send
+ # returns: 1 on success, 0 on failure
+
+Set to zero if you do not no want to support a session resumption.
+
+=item * CTX_get_num_tickets
+
+B&lt;COMPATIBILITY:&gt; not available in Net-SSLeay-1.85 and before; requires at least OpenSSL 1.1.1
+
+Get number of session tickets that will be sent to a client.
+
+ my $number_of_tickets = Net::SSLeay::CTX_get_num_tickets&#40;$ctx&#41;;
+ # $ctx  - value corresponding to openssl&#39;s SSL_CTX structure
+ # returns: number of tickets to send
+
+=item * set_num_tickets
+
+B&lt;COMPATIBILITY:&gt; not available in Net-SSLeay-1.85 and before; requires at least OpenSSL 1.1.1
+
+Set number of session tickets that will be sent to a client.
+
+ my $rv = Net::SSLeay::set_num_tickets&#40;$ssl, $number_of_tickets&#41;;
+ # $ssl  - value corresponding to openssl&#39;s SSL structure
+ # $number_of_tickets - number of tickets to send
+ # returns: 1 on success, 0 on failure
+
+Set to zero if you do not no want to support a session resumption.
+
+=item * get_num_tickets
+
+B&lt;COMPATIBILITY:&gt; not available in Net-SSLeay-1.85 and before; requires at least OpenSSL 1.1.1
+
+Get number of session tickets that will be sent to a client.
+
+ my $number_of_tickets = Net::SSLeay::get_num_tickets&#40;$ctx&#41;;
+ # $ctx  - value corresponding to openssl&#39;s SSL structure
+ # returns: number of tickets to send
+
 =item * set_shutdown
 
 Sets the shutdown state of $ssl to $mode.
diff --git a/t/local/07_sslecho.t b/t/local/07_sslecho.t
index 5e16b04..5dc946a 100644
--- a/t/local/07_sslecho.t
+++ b/t/local/07_sslecho.t
@@ -13,7 +13,8 @@ BEGIN {
   plan skip_all =&gt; &#34;fork&#40;&#41; not supported on $^O&#34; unless $Config{d_fork};
 }
 
-plan tests =&gt; 78;
+plan tests =&gt; 79;
+$SIG{&#39;PIPE&#39;} = &#39;IGNORE&#39;;
 
 my $sock;
 my $pid;
@@ -61,6 +62,16 @@ Net::SSLeay::library_init&#40;&#41;;
     ok&#40;Net::SSLeay::CTX_set_cipher_list&#40;$ctx, &#39;ALL&#39;&#41;, &#39;CTX_set_cipher_list&#39;&#41;;
     my &#40;$dummy, $errs&#41; = Net::SSLeay::set_cert_and_key&#40;$ctx, $cert_pem, $key_pem&#41;;
     ok&#40;$errs eq &#39;&#39;, &#34;set_cert_and_key: $errs&#34;&#41;;
+    SKIP: {
+        skip &#39;Disabling session tickets requires OpenSSL &gt;= 1.1.1&#39;, 1
+            unless &#40;&#38;Net::SSLeay::OPENSSL_VERSION_NUMBER &gt;= 0x1010100f&#41;;
+        # TLS 1.3 server sends session tickets after a handhake as part of
+        # the SSL_accept&#40;&#41;. If a client finishes all its job including closing
+        # TCP connectino before a server sends the tickets, SSL_accept&#40;&#41; fails
+        # with SSL_ERROR_SYSCALL and EPIPE errno and the server receives
+        # SIGPIPE signal. &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/openssl/openssl/issues/6904">https://github.com/openssl/openssl/issues/6904</a></span>&gt;
+        ok&#40;Net::SSLeay::CTX_set_num_tickets&#40;$ctx, 0&#41;, &#39;Session tickets disabled&#39;&#41;;
+    }
 
     $pid = fork&#40;&#41;;
     BAIL_OUT&#40;&#34;failed to fork: $!&#34;&#41; unless defined $pid;
@@ -351,7 +362,7 @@ waitpid $pid, 0;
 push @results, [ $? == 0, &#39;server exited with 0&#39; ];
 
 END {
-    Test::More-&gt;builder-&gt;current_test&#40;51&#41;;
+    Test::More-&gt;builder-&gt;current_test&#40;52&#41;;
     for my $t &#40;@results&#41; {
         ok&#40; $t-&gt;[0], $t-&gt;[1] &#41;;
     }
diff --git a/t/local/36_verify.t b/t/local/36_verify.t
index 92afc52..e55b138 100644
--- a/t/local/36_verify.t
+++ b/t/local/36_verify.t
@@ -282,7 +282,7 @@ sub run_server
 
 	# Termination request or other message from client
 	my $msg = Net::SSLeay::read&#40;$ssl&#41;;
-	if &#40;$msg eq &#39;end&#39;&#41;
+	if &#40;defined $msg and $msg eq &#39;end&#39;&#41;
 	{
 	    Net::SSLeay::write&#40;$ssl, &#39;end&#39;&#41;;
 	    exit &#40;0&#41;;
-- 
2.14.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;14&nbsp;11:41:34&nbsp;2018</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Pá 10.srp.2018 11:09:00, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; E.g. SIGPIPE in a server where data are only received and no proper
&gt; two-way TLS shutdown is performed.
&gt; 
</div>Due to this I randomly experienced a failure in t/local/36_verify.t:

#   Failed test &#39;Verify callback result and get_verify_result are equal&#39;
#   at t/local/36_verify.t line 111.
#          got: &#39;-1&#39;
#     expected: &#39;0&#39;
#   Failed test &#39;Verify result is X509_V_ERR_NO_EXPLICIT_POLICY&#39;
#   at t/local/36_verify.t line 118.
#          got: &#39;-1&#39;
#     expected: &#39;43&#39;
Bailout called.  Further testing stopped:  failed to connect to server: Connection refused
FAILED--Further testing stopped: failed to connect to server: Connection refused

Attached patch adds the same SIGPIPE workaround as the previous patch added into t/local/07_sslecho.t.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net-SSLeay-1.85-Avoid-SIGPIPE-in-t-local-36_verify.t.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 173cd9c1340f1f5231625a1dd4ecaea10c207622 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Tue, 14 Aug 2018 16:55:52 +0200
Subject: [PATCH] Avoid SIGPIPE in t/local/36_verify.t
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

t/local/36_verify.t fails randomly with OpenSSL 1.1.1:

    #   Failed test &#39;Verify callback result and get_verify_result are equal&#39;
    #   at t/local/36_verify.t line 111.
    #          got: &#39;-1&#39;
    #     expected: &#39;0&#39;
    #   Failed test &#39;Verify result is X509_V_ERR_NO_EXPLICIT_POLICY&#39;
    #   at t/local/36_verify.t line 118.
    #          got: &#39;-1&#39;
    #     expected: &#39;43&#39;
    Bailout called.  Further testing stopped:  failed to connect to server: Connection refused
    FAILED--Further testing stopped: failed to connect to server: Connection refused

I believe this because TLSv1.3 server can generate SIGPIPE if a client
disconnects too soon.

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 t/local/36_verify.t | 10 ++++++++++
 1 file changed, 10 insertions&#40;+&#41;

diff --git a/t/local/36_verify.t b/t/local/36_verify.t
index e55b138..2837288 100644
--- a/t/local/36_verify.t
+++ b/t/local/36_verify.t
@@ -266,10 +266,20 @@ sub run_server
 
     return if $pid != 0;
 
+    $SIG{&#39;PIPE&#39;} = &#39;IGNORE&#39;;
     my $ctx = Net::SSLeay::CTX_new&#40;&#41;;
     Net::SSLeay::set_cert_and_key&#40;$ctx, $cert_pem, $key_pem&#41;;
     my $ret = Net::SSLeay::CTX_check_private_key&#40;$ctx&#41;;
     BAIL_OUT&#40;&#34;Server: CTX_check_private_key failed: $cert_pem, $key_pem&#34;&#41; unless $ret == 1;
+    if &#40;&#38;Net::SSLeay::OPENSSL_VERSION_NUMBER &gt;= 0x1010100f&#41; {
+        # TLS 1.3 server sends session tickets after a handhake as part of
+        # the SSL_accept&#40;&#41;. If a client finishes all its job including closing
+        # TCP connectino before a server sends the tickets, SSL_accept&#40;&#41; fails
+        # with SSL_ERROR_SYSCALL and EPIPE errno and the server receives
+        # SIGPIPE signal. &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/openssl/openssl/issues/6904">https://github.com/openssl/openssl/issues/6904</a></span>&gt;
+        my $ret = Net::SSLeay::CTX_set_num_tickets&#40;$ctx, 0&#41;;
+        BAIL_OUT&#40;&#34;Session tickets disabled&#34;&#41; unless $ret;
+    }
 
     while &#40;1&#41;
     {
-- 
2.14.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;14&nbsp;11:58:39&nbsp;2018</span>
    <span class="description">chrisn [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> ppisar [...] redhat.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks to both of you for persisting with this --- we&#39;ll take a look at all of the attached patches, with a view to merging them sometime this week.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;14&nbsp;11:58:40&nbsp;2018</span>
    <span class="description">chrisn [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;15&nbsp;07:01:58&nbsp;2018</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Čt 26.dub.2018 16:34:25, sebastian@breakpoint.cc napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The SSL_read&#40;&#41; and SSL_write&#40;&#41; wrapper need to handle a possible
&gt; retry.
</div>
This change breaks IO-Socket-SSL-1.85 t/core.t test that does

if &#40;$CAN_NONBLOCK&#41; {
    $client-&gt;blocking&#40;0&#41;;
    $client-&gt;read&#40;$buffer, 20, 0&#41;;
    is&#40; $SSL_ERROR, SSL_WANT_READ, &#34;Server Nonblocking Check 1&#34;&#41;;
}

and hangs by a busy-wait in the $client-&gt;read&#40;&#41; instead of returning with $SSL_ERROR==SSL_WABT_READ. IO::Socket::SSL has extensive documentation on the non-blocking mode and it looks like Net::SSLeay should not hide the retry. Instead Net::SSLeay should move the retry to test and and blocking functions like ssl_read_all&#40;&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;15&nbsp;11:24:15&nbsp;2018</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne St 15.srp.2018 07:01:58, ppisar napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dne Čt 26.dub.2018 16:34:25, sebastian@breakpoint.cc napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; The SSL_read&#40;&#41; and SSL_write&#40;&#41; wrapper need to handle a possible
&gt; &gt; retry.
</div>&gt; 
&gt; This change breaks IO-Socket-SSL-1.85 t/core.t test that does
&gt; 
</div>Attached patch moves the retry handling from read&#40;&#41;/write&#40;&#41; to ssl_read_all&#40;&#41;. ssl_write_all&#40;&#41; seems already doing that. IO-Socket-SSL-1.85 t/core.t passes now. This patch is meant to be applied on top of the previous one.

Though there are still other IO-Socket-SSL-1.85 tests that fail or hang &#40;e.g. t/sni.t&#41;. Still needs more work.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net-SSLeay-1.85-Move-SSL_ERROR_WANT_READ-SSL_ERROR_WANT_WRITE-retry-.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From e0b42b0120b941b5675e4071445424dc8a1230e1 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Wed, 15 Aug 2018 14:46:52 +0200
Subject: [PATCH] Move SSL_ERROR_WANT_READ/SSL_ERROR_WANT_WRITE retry from
 read&#40;&#41;/write&#40;&#41; up
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Original OpenSSL 1.1.1 fix broke IO-Socket-SSL-2.058&#39;s t/core.t test
because it tests non-blocking socket operations and expects to see
SSL_ERROR_WANT_READ/SSL_ERROR_WANT_WRITE errors and to handle them
byt itself.

This patch purifies Net::SSLeay::{read,write}&#40;&#41; to behave exactly as
underlying OpenSSL functions. The retry is moved to
Net::SSLeay::ssl_read_all. All relevant Net::SSLeay::{read,write}&#40;&#41; calls in
tests are changed into Net::SSLea::ssl_{read,write}_all&#40;&#41;.

All applications should implement the retry themsleves or use
ssl_*_all&#40;&#41; instead.

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 SSLeay.xs            | 28 +++++++---------------------
 lib/Net/SSLeay.pm    | 22 +++++++++++++++-------
 t/local/07_sslecho.t | 12 ++++++------
 t/local/36_verify.t  |  9 +++++----
 4 files changed, 33 insertions&#40;+&#41;, 38 deletions&#40;-&#41;

diff --git a/SSLeay.xs b/SSLeay.xs
index 5aed4d7..7cb6eab 100644
--- a/SSLeay.xs
+++ b/SSLeay.xs
@@ -1997,19 +1997,13 @@ SSL_read&#40;s,max=32768&#41;
     PREINIT:
 	char *buf;
 	int got;
+	int succeeded = 1;
     PPCODE:
 	New&#40;0, buf, max, char&#41;;
 
-	do {
-		int err;
-
-		got = SSL_read&#40;s, buf, max&#41;;
-		if &#40;got &gt; 0&#41;
-			break;
-		err = SSL_get_error&#40;s, got&#41;;
-		if &#40;err != SSL_ERROR_WANT_READ &#38;&#38; err != SSL_ERROR_WANT_WRITE&#41;
-			break;
-	} while &#40;1&#41;;
+	got = SSL_read&#40;s, buf, max&#41;;
+	if &#40;got &lt;= 0 &#38;&#38; SSL_ERROR_ZERO_RETURN != SSL_get_error&#40;s, got&#41;&#41;
+	       succeeded = 0;
 
 	/* If in list context, return 2-item list:
 	 *   first return value:  data gotten, or undef on error &#40;got&lt;0&#41;
@@ -2017,13 +2011,13 @@ SSL_read&#40;s,max=32768&#41;
 	 */
 	if &#40;GIMME_V==G_ARRAY&#41; {
 	    EXTEND&#40;SP, 2&#41;;
-	    PUSHs&#40;sv_2mortal&#40;got&gt;=0 ? newSVpvn&#40;buf, got&#41; : newSV&#40;0&#41;&#41;&#41;;
+	    PUSHs&#40;sv_2mortal&#40;succeeded ? newSVpvn&#40;buf, got&#41; : newSV&#40;0&#41;&#41;&#41;;
 	    PUSHs&#40;sv_2mortal&#40;newSViv&#40;got&#41;&#41;&#41;;
 
 	/* If in scalar or void context, return data gotten, or undef on error. */
 	} else {
 	    EXTEND&#40;SP, 1&#41;;
-	    PUSHs&#40;sv_2mortal&#40;got&gt;=0 ? newSVpvn&#40;buf, got&#41; : newSV&#40;0&#41;&#41;&#41;;
+	    PUSHs&#40;sv_2mortal&#40;succeeded ? newSVpvn&#40;buf, got&#41; : newSV&#40;0&#41;&#41;&#41;;
 	}
 
 	Safefree&#40;buf&#41;;
@@ -2066,15 +2060,7 @@ SSL_write&#40;s,buf&#41;
      INPUT:
      char *  buf = SvPV&#40; ST&#40;1&#41;, len&#41;;
      CODE:
-     do {
-	     ret = SSL_write &#40;s, buf, &#40;int&#41;len&#41;;
-	     if &#40;ret &gt; 0&#41;
-		     break;
-	     err = SSL_get_error&#40;s, ret&#41;;
-	     if &#40;err != SSL_ERROR_WANT_READ &#38;&#38; err != SSL_ERROR_WANT_WRITE&#41;
-		     break;
-     } while &#40;1&#41;;
-     RETVAL = ret;
+     RETVAL = SSL_write &#40;s, buf, &#40;int&#41;len&#41;;
      OUTPUT:
      RETVAL
 
diff --git a/lib/Net/SSLeay.pm b/lib/Net/SSLeay.pm
index 3adf12c..afc6c8f 100644
--- a/lib/Net/SSLeay.pm
+++ b/lib/Net/SSLeay.pm
@@ -579,14 +579,22 @@ sub debug_read {
 sub ssl_read_all {
     my &#40;$ssl,$how_much&#41; = @_;
     $how_much = 2000000000 unless $how_much;
-    my &#40;$got, $errs&#41;;
+    my &#40;$got, $rv, $errs&#41;;
     my $reply = &#39;&#39;;
 
     while &#40;$how_much &gt; 0&#41; {
-        $got = Net::SSLeay::read&#40;$ssl,
+        &#40;$got, $rv&#41; = Net::SSLeay::read&#40;$ssl,
                 &#40;$how_much &gt; 32768&#41; ? 32768 : $how_much
         &#41;;
-        last if $errs = print_errs&#40;&#39;SSL_read&#39;&#41;;
+        if &#40;! defined $got&#41; {
+            my $err = Net::SSLeay::get_error&#40;$ssl, $rv&#41;;
+            if &#40;$err != Net::SSLeay::ERROR_WANT_READ&#40;&#41; and
+                    $err != Net::SSLeay::ERROR_WANT_WRITE&#40;&#41;&#41; {
+                $errs = print_errs&#40;&#39;SSL_read&#39;&#41;;
+                last;
+            }
+            next;
+        }
         $how_much -= blength&#40;$got&#41;;
         debug_read&#40;\$reply, \$got&#41; if $trace&gt;1;
         last if $got eq &#39;&#39;;  # EOF
@@ -839,14 +847,14 @@ sub ssl_read_until &#40;$;$$&#41; {
 	    $found = index&#40;$match, $delim&#41;;
 
 	    if &#40;$found &gt; -1&#41; {
-		#$got = Net::SSLeay::read&#40;$ssl, $found+$len_delim&#41;;
+		#$got = Net::SSLeay::ssl_read_all&#40;$ssl, $found+$len_delim&#41;;
 		#read up to the end of the delimiter
-		$got = Net::SSLeay::read&#40;$ssl,
+		$got = Net::SSLeay::ssl_read_all&#40;$ssl,
 					 $found + $len_delim
 					 - &#40;&#40;blength&#40;$match&#41;&#41; - &#40;blength&#40;$got&#41;&#41;&#41;&#41;;
 		$done = 1;
 	    } else {
-		$got = Net::SSLeay::read&#40;$ssl, $peek_length&#41;;
+		$got = Net::SSLeay::ssl_read_all&#40;$ssl, $peek_length&#41;;
 		$done = 1 if &#40;$peek_length == $max_length - blength&#40;$reply&#41;&#41;;
 	    }
 
@@ -857,7 +865,7 @@ sub ssl_read_until &#40;$;$$&#41; {
 	}
     } else {
 	while &#40;!defined $max_length || length $reply &lt; $max_length&#41; {
-	    $got = Net::SSLeay::read&#40;$ssl,1&#41;;  # one by one
+	    $got = Net::SSLeay::ssl_read_all&#40;$ssl,1&#41;;  # one by one
 	    last if print_errs&#40;&#39;SSL_read&#39;&#41;;
 	    debug_read&#40;\$reply, \$got&#41; if $trace&gt;1;
 	    last if $got eq &#39;&#39;;
diff --git a/t/local/07_sslecho.t b/t/local/07_sslecho.t
index 74e317a..7f19027 100644
--- a/t/local/07_sslecho.t
+++ b/t/local/07_sslecho.t
@@ -134,10 +134,10 @@ my @results;
 
     push @results, [ Net::SSLeay::get_cipher&#40;$ssl&#41;, &#39;get_cipher&#39; ];
 
-    push @results, [ Net::SSLeay::write&#40;$ssl, $msg&#41;, &#39;write&#39; ];
+    push @results, [ Net::SSLeay::ssl_write_all&#40;$ssl, $msg&#41;, &#39;write&#39; ];
     shutdown&#40;$s, 1&#41;;
 
-    my &#40;$got&#41; = Net::SSLeay::read&#40;$ssl&#41;;
+    my $got = Net::SSLeay::ssl_read_all&#40;$ssl&#41;;
     push @results, [ $got eq uc&#40;$msg&#41;, &#39;read&#39; ];
 
     Net::SSLeay::free&#40;$ssl&#41;;
@@ -177,7 +177,7 @@ my @results;
             Net::SSLeay::set_fd&#40;$ssl, fileno&#40;$s&#41;&#41;;
             Net::SSLeay::connect&#40;$ssl&#41;;
 
-            Net::SSLeay::write&#40;$ssl, $msg&#41;;
+            Net::SSLeay::ssl_write_all&#40;$ssl, $msg&#41;;
 
             shutdown $s, 2;
             close $s;
@@ -231,15 +231,15 @@ my @results;
             Net::SSLeay::set_fd&#40;$ssl3, $s3&#41;;
 
             Net::SSLeay::connect&#40;$ssl1&#41;;
-            Net::SSLeay::write&#40;$ssl1, $msg&#41;;
+            Net::SSLeay::ssl_write_all&#40;$ssl1, $msg&#41;;
             shutdown $s1, 2;
 
             Net::SSLeay::connect&#40;$ssl2&#41;;
-            Net::SSLeay::write&#40;$ssl2, $msg&#41;;
+            Net::SSLeay::ssl_write_all&#40;$ssl2, $msg&#41;;
             shutdown $s2, 2;
 
             Net::SSLeay::connect&#40;$ssl3&#41;;
-            Net::SSLeay::write&#40;$ssl3, $msg&#41;;
+            Net::SSLeay::ssl_write_all&#40;$ssl3, $msg&#41;;
             shutdown $s3, 2;
 
             close $s1;
diff --git a/t/local/36_verify.t b/t/local/36_verify.t
index 2837288..b04be13 100644
--- a/t/local/36_verify.t
+++ b/t/local/36_verify.t
@@ -252,8 +252,9 @@ sub client {
     Net::SSLeay::set_fd&#40;$ssl, $cl&#41;;
     Net::SSLeay::connect&#40;$ssl&#41;;
     my $end = &#34;end&#34;;
-    Net::SSLeay::write&#40;$ssl, $end&#41;;
-    ok&#40;$end eq Net::SSLeay::read&#40;$ssl&#41;,  &#39;Successful termination&#39;&#41;;
+    Net::SSLeay::ssl_write_all&#40;$ssl, $end&#41;;
+    Net::SSLeay::shutdown&#40;$ssl&#41;;
+    ok&#40;$end eq Net::SSLeay::ssl_read_all&#40;$ssl&#41;,  &#39;Successful termination&#39;&#41;;
     return;
 }
 
@@ -291,10 +292,10 @@ sub run_server
 	next unless $ret == 1;
 
 	# Termination request or other message from client
-	my $msg = Net::SSLeay::read&#40;$ssl&#41;;
+	my $msg = Net::SSLeay::ssl_read_all&#40;$ssl&#41;;
 	if &#40;defined $msg and $msg eq &#39;end&#39;&#41;
 	{
-	    Net::SSLeay::write&#40;$ssl, &#39;end&#39;&#41;;
+	    Net::SSLeay::ssl_write_all&#40;$ssl, &#39;end&#39;&#41;;
 	    exit &#40;0&#41;;
 	}
     }
-- 
2.14.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;16&nbsp;05:04:53&nbsp;2018</span>
    <span class="description">github [...] trace.city-fan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Aug 15 11:24:15 2018, ppisar wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Though there are still other IO-Socket-SSL-1.85 tests that fail or
&gt; hang &#40;e.g. t/sni.t&#41;. Still needs more work.
</div>
As it stands, this patch set appears to break IO::Socket::SSL&#39;s t/nonblock.t tests 13 and 26 &#40;[client] multiple write attempts&#41; on older OpenSSL versions, e.g. on Fedora 28 &#40;OpenSSL 1.1.0h&#41;:

t/nonblock.t ...................... 
1..27
ok # [server] Server Initialization
# connect in progress
ok # [client] client tcp connect
ok # [server] tcp accept
# wrote 9 bytes
ok # [client] write plain text
ok # [server] received plain text
ok # [server] upgrade to_client to IO::Socket::SSL
ok # [client] upgrade client to IO::Socket::SSL
# SSL wants a read first
# SSL wants a read first
ok # [server] ssl accept handshake done
ok # [client] connected
ok # [client] nonblocking connect with 2 attempts
# sndbuf=16384
ok # [server] received client message
# read 30000 &#40;1 r/w attempts&#41;
# $!=Connection reset by peer $SSL_ERROR=SSL write error &#40;5&#41; send=269670
# connection closed
ok # [client] syswrite
not ok # [client] multiple write attempts
ok # [client] 30000 bytes send
# connect in progress
ok # [client] client tcp connect
# wrote 9 bytes
ok # [client] write plain text
ok # [server] tcp accept
ok # [server] received plain text
ok # [server] upgrade to_client to IO::Socket::SSL
ok # [client] upgrade client to IO::Socket::SSL
# SSL wants a read first
# SSL wants a read first
ok # [server] ssl accept handshake done
ok # [server] nonblocking accept_SSL with 2 attempts
ok # [client] connected
# sndbuf=16384
ok # [server] received client message
# read 30000 &#40;2 r/w attempts&#41;
# $!=Connection reset by peer $SSL_ERROR=SSL write error &#40;5&#41; send=269580
# connection closed
ok # [client] syswrite
not ok # [client] multiple write attempts
ok # [client] 30000 bytes send
Failed 2/27 subtests 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;16&nbsp;11:05:07&nbsp;2018</span>
    <span class="description">RADIATOR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed 15.elokuu 2018 11:24:15, ppisar wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Attached patch moves the retry handling from read&#40;&#41;/write&#40;&#41; to
&gt; ssl_read_all&#40;&#41;. ssl_write_all&#40;&#41; seems already doing that. IO-Socket-
&gt; SSL-1.85 t/core.t passes now. This patch is meant to be applied on top
&gt; of the previous one.
&gt; 
&gt; Though there are still other IO-Socket-SSL-1.85 tests that fail or
&gt; hang &#40;e.g. t/sni.t&#41;. Still needs more work.
</div>
I created a patch that combines:

0001-Adapt-to-OpenSSL-1.1.1.patch
Net-SSLeay-1.85-Avoid-SIGPIPE-in-t-local-36_verify.t.patch
Net-SSLeay-1.85-Move-SSL_ERROR_WANT_READ-SSL_ERROR_WANT_WRITE-retry-.patch

It also changes version check to 1.1.1-pre7 &#40;this is where *_get/set_num_tickets was added&#41; so that it&#39;s easier to test the changes as of today with current pre-release OpenSSL.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net-SSLeay-combo-2018-08-16.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/SSLeay.xs b/SSLeay.xs
index 630f09e..b3d684c 100644
--- a/SSLeay.xs
+++ b/SSLeay.xs
@@ -1996,9 +1996,13 @@ SSL_read&#40;s,max=32768&#41;
     PREINIT:
 	char *buf;
 	int got;
+	int succeeded = 1;
     PPCODE:
 	New&#40;0, buf, max, char&#41;;
+
 	got = SSL_read&#40;s, buf, max&#41;;
+	if &#40;got &lt;= 0 &#38;&#38; SSL_ERROR_ZERO_RETURN != SSL_get_error&#40;s, got&#41;&#41;
+	       succeeded = 0;
 
 	/* If in list context, return 2-item list:
 	 *   first return value:  data gotten, or undef on error &#40;got&lt;0&#41;
@@ -2006,13 +2010,13 @@ SSL_read&#40;s,max=32768&#41;
 	 */
 	if &#40;GIMME_V==G_ARRAY&#41; {
 	    EXTEND&#40;SP, 2&#41;;
-	    PUSHs&#40;sv_2mortal&#40;got&gt;=0 ? newSVpvn&#40;buf, got&#41; : newSV&#40;0&#41;&#41;&#41;;
+	    PUSHs&#40;sv_2mortal&#40;succeeded ? newSVpvn&#40;buf, got&#41; : newSV&#40;0&#41;&#41;&#41;;
 	    PUSHs&#40;sv_2mortal&#40;newSViv&#40;got&#41;&#41;&#41;;
 
 	/* If in scalar or void context, return data gotten, or undef on error. */
 	} else {
 	    EXTEND&#40;SP, 1&#41;;
-	    PUSHs&#40;sv_2mortal&#40;got&gt;=0 ? newSVpvn&#40;buf, got&#41; : newSV&#40;0&#41;&#41;&#41;;
+	    PUSHs&#40;sv_2mortal&#40;succeeded ? newSVpvn&#40;buf, got&#41; : newSV&#40;0&#41;&#41;&#41;;
 	}
 
 	Safefree&#40;buf&#41;;
@@ -2050,6 +2054,8 @@ SSL_write&#40;s,buf&#41;
      SSL *   s
      PREINIT:
      STRLEN len;
+     int err;
+     int ret;
      INPUT:
      char *  buf = SvPV&#40; ST&#40;1&#41;, len&#41;;
      CODE:
@@ -2082,8 +2088,20 @@ SSL_write_partial&#40;s,from,count,buf&#41;
      if &#40;len &lt; 0&#41; {
        croak&#40;&#34;from beyound end of buffer&#34;&#41;;
        RETVAL = -1;
-     } else
-       RETVAL = SSL_write &#40;s, &#38;&#40;buf[from]&#41;, &#40;count&lt;=len&#41;?count:len&#41;;
+     } else {
+	     int ret;
+	     int err;
+
+	     do {
+		     ret = SSL_write &#40;s, &#38;&#40;buf[from]&#41;, &#40;count&lt;=len&#41;?count:len&#41;;
+		     if &#40;ret &gt; 0&#41;
+			     break;
+		     err = SSL_get_error&#40;s, ret&#41;;
+		     if &#40;err != SSL_ERROR_WANT_READ &#38;&#38; err != SSL_ERROR_WANT_WRITE&#41;
+			     break;
+	     } while &#40;1&#41;;
+	     RETVAL = ret;
+     }
      OUTPUT:
      RETVAL
 
@@ -6959,4 +6977,20 @@ SSL_export_keying_material&#40;ssl, outlen, label, p&#41;
 
 #endif
 
+#if OPENSSL_VERSION_NUMBER &gt;= 0x10101007L
+
+int
+SSL_CTX_set_num_tickets&#40;SSL_CTX *ctx,size_t num_tickets&#41;
+
+size_t
+SSL_CTX_get_num_tickets&#40;SSL_CTX *ctx&#41;
+
+int
+SSL_set_num_tickets&#40;SSL *ssl,size_t num_tickets&#41;
+
+size_t
+SSL_get_num_tickets&#40;SSL *ssl&#41;
+
+#endif
+
 #define REM_EOF &#34;/* EOF - SSLeay.xs */&#34;
diff --git a/lib/Net/SSLeay.pm b/lib/Net/SSLeay.pm
index b3d64bb..8e64090 100644
--- a/lib/Net/SSLeay.pm
+++ b/lib/Net/SSLeay.pm
@@ -578,14 +578,22 @@ sub debug_read {
 sub ssl_read_all {
     my &#40;$ssl,$how_much&#41; = @_;
     $how_much = 2000000000 unless $how_much;
-    my &#40;$got, $errs&#41;;
+    my &#40;$got, $rv, $errs&#41;;
     my $reply = &#39;&#39;;
 
     while &#40;$how_much &gt; 0&#41; {
-        $got = Net::SSLeay::read&#40;$ssl,
+        &#40;$got, $rv&#41; = Net::SSLeay::read&#40;$ssl,
                 &#40;$how_much &gt; 32768&#41; ? 32768 : $how_much
         &#41;;
-        last if $errs = print_errs&#40;&#39;SSL_read&#39;&#41;;
+        if &#40;! defined $got&#41; {
+            my $err = Net::SSLeay::get_error&#40;$ssl, $rv&#41;;
+            if &#40;$err != Net::SSLeay::ERROR_WANT_READ&#40;&#41; and
+                    $err != Net::SSLeay::ERROR_WANT_WRITE&#40;&#41;&#41; {
+                $errs = print_errs&#40;&#39;SSL_read&#39;&#41;;
+                last;
+            }
+            next;
+        }
         $how_much -= blength&#40;$got&#41;;
         debug_read&#40;\$reply, \$got&#41; if $trace&gt;1;
         last if $got eq &#39;&#39;;  # EOF
@@ -838,14 +846,14 @@ sub ssl_read_until &#40;$;$$&#41; {
 	    $found = index&#40;$match, $delim&#41;;
 
 	    if &#40;$found &gt; -1&#41; {
-		#$got = Net::SSLeay::read&#40;$ssl, $found+$len_delim&#41;;
+		#$got = Net::SSLeay::ssl_read_all&#40;$ssl, $found+$len_delim&#41;;
 		#read up to the end of the delimiter
-		$got = Net::SSLeay::read&#40;$ssl,
+		$got = Net::SSLeay::ssl_read_all&#40;$ssl,
 					 $found + $len_delim
 					 - &#40;&#40;blength&#40;$match&#41;&#41; - &#40;blength&#40;$got&#41;&#41;&#41;&#41;;
 		$done = 1;
 	    } else {
-		$got = Net::SSLeay::read&#40;$ssl, $peek_length&#41;;
+		$got = Net::SSLeay::ssl_read_all&#40;$ssl, $peek_length&#41;;
 		$done = 1 if &#40;$peek_length == $max_length - blength&#40;$reply&#41;&#41;;
 	    }
 
@@ -856,7 +864,7 @@ sub ssl_read_until &#40;$;$$&#41; {
 	}
     } else {
 	while &#40;!defined $max_length || length $reply &lt; $max_length&#41; {
-	    $got = Net::SSLeay::read&#40;$ssl,1&#41;;  # one by one
+	    $got = Net::SSLeay::ssl_read_all&#40;$ssl,1&#41;;  # one by one
 	    last if print_errs&#40;&#39;SSL_read&#39;&#41;;
 	    debug_read&#40;\$reply, \$got&#41; if $trace&gt;1;
 	    last if $got eq &#39;&#39;;
diff --git a/lib/Net/SSLeay.pod b/lib/Net/SSLeay.pod
index 4d56405..17924e6 100644
--- a/lib/Net/SSLeay.pod
+++ b/lib/Net/SSLeay.pod
@@ -4445,6 +4445,52 @@ getticket&#40;$ssl,$ticket,$data&#41; -&gt; $return_value
 
 This function is based on the OpenSSL function SSL_set_session_ticket_ext_cb.
 
+=item * CTX_set_num_tickets
+
+B&lt;COMPATIBILITY:&gt; not available in Net-SSLeay-1.85 and before; requires at least OpenSSL 1.1.1
+
+Set number of session tickets that will be sent to a client.
+
+ my $rv = Net::SSLeay::CTX_set_num_tickets&#40;$ctx, $number_of_tickets&#41;;
+ # $ctx  - value corresponding to openssl&#39;s SSL_CTX structure
+ # $number_of_tickets - number of tickets to send
+ # returns: 1 on success, 0 on failure
+
+Set to zero if you do not no want to support a session resumption.
+
+=item * CTX_get_num_tickets
+
+B&lt;COMPATIBILITY:&gt; not available in Net-SSLeay-1.85 and before; requires at least OpenSSL 1.1.1
+
+Get number of session tickets that will be sent to a client.
+
+ my $number_of_tickets = Net::SSLeay::CTX_get_num_tickets&#40;$ctx&#41;;
+ # $ctx  - value corresponding to openssl&#39;s SSL_CTX structure
+ # returns: number of tickets to send
+
+=item * set_num_tickets
+
+B&lt;COMPATIBILITY:&gt; not available in Net-SSLeay-1.85 and before; requires at least OpenSSL 1.1.1
+
+Set number of session tickets that will be sent to a client.
+
+ my $rv = Net::SSLeay::set_num_tickets&#40;$ssl, $number_of_tickets&#41;;
+ # $ssl  - value corresponding to openssl&#39;s SSL structure
+ # $number_of_tickets - number of tickets to send
+ # returns: 1 on success, 0 on failure
+
+Set to zero if you do not no want to support a session resumption.
+
+=item * get_num_tickets
+
+B&lt;COMPATIBILITY:&gt; not available in Net-SSLeay-1.85 and before; requires at least OpenSSL 1.1.1
+
+Get number of session tickets that will be sent to a client.
+
+ my $number_of_tickets = Net::SSLeay::get_num_tickets&#40;$ctx&#41;;
+ # $ctx  - value corresponding to openssl&#39;s SSL structure
+ # returns: number of tickets to send
+
 =item * set_shutdown
 
 Sets the shutdown state of $ssl to $mode.
diff --git a/t/local/07_sslecho.t b/t/local/07_sslecho.t
index 5e16b04..d68176e 100644
--- a/t/local/07_sslecho.t
+++ b/t/local/07_sslecho.t
@@ -13,7 +13,8 @@ BEGIN {
   plan skip_all =&gt; &#34;fork&#40;&#41; not supported on $^O&#34; unless $Config{d_fork};
 }
 
-plan tests =&gt; 78;
+plan tests =&gt; 79;
+$SIG{&#39;PIPE&#39;} = &#39;IGNORE&#39;;
 
 my $sock;
 my $pid;
@@ -61,6 +62,16 @@ Net::SSLeay::library_init&#40;&#41;;
     ok&#40;Net::SSLeay::CTX_set_cipher_list&#40;$ctx, &#39;ALL&#39;&#41;, &#39;CTX_set_cipher_list&#39;&#41;;
     my &#40;$dummy, $errs&#41; = Net::SSLeay::set_cert_and_key&#40;$ctx, $cert_pem, $key_pem&#41;;
     ok&#40;$errs eq &#39;&#39;, &#34;set_cert_and_key: $errs&#34;&#41;;
+    SKIP: {
+        skip &#39;Disabling session tickets requires OpenSSL &gt;= 1.1.1&#39;, 1
+            unless &#40;&#38;Net::SSLeay::OPENSSL_VERSION_NUMBER &gt;= 0x10101007&#41;;
+        # TLS 1.3 server sends session tickets after a handhake as part of
+        # the SSL_accept&#40;&#41;. If a client finishes all its job including closing
+        # TCP connectino before a server sends the tickets, SSL_accept&#40;&#41; fails
+        # with SSL_ERROR_SYSCALL and EPIPE errno and the server receives
+        # SIGPIPE signal. &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/openssl/openssl/issues/6904">https://github.com/openssl/openssl/issues/6904</a></span>&gt;
+        ok&#40;Net::SSLeay::CTX_set_num_tickets&#40;$ctx, 0&#41;, &#39;Session tickets disabled&#39;&#41;;
+    }
 
     $pid = fork&#40;&#41;;
     BAIL_OUT&#40;&#34;failed to fork: $!&#34;&#41; unless defined $pid;
@@ -123,10 +134,10 @@ my @results;
 
     push @results, [ Net::SSLeay::get_cipher&#40;$ssl&#41;, &#39;get_cipher&#39; ];
 
-    push @results, [ Net::SSLeay::write&#40;$ssl, $msg&#41;, &#39;write&#39; ];
+    push @results, [ Net::SSLeay::ssl_write_all&#40;$ssl, $msg&#41;, &#39;write&#39; ];
     shutdown&#40;$s, 1&#41;;
 
-    my &#40;$got&#41; = Net::SSLeay::read&#40;$ssl&#41;;
+    my $got = Net::SSLeay::ssl_read_all&#40;$ssl&#41;;
     push @results, [ $got eq uc&#40;$msg&#41;, &#39;read&#39; ];
 
     Net::SSLeay::free&#40;$ssl&#41;;
@@ -166,7 +177,7 @@ my @results;
             Net::SSLeay::set_fd&#40;$ssl, fileno&#40;$s&#41;&#41;;
             Net::SSLeay::connect&#40;$ssl&#41;;
 
-            Net::SSLeay::write&#40;$ssl, $msg&#41;;
+            Net::SSLeay::ssl_write_all&#40;$ssl, $msg&#41;;
 
             shutdown $s, 2;
             close $s;
@@ -220,15 +231,15 @@ my @results;
             Net::SSLeay::set_fd&#40;$ssl3, $s3&#41;;
 
             Net::SSLeay::connect&#40;$ssl1&#41;;
-            Net::SSLeay::write&#40;$ssl1, $msg&#41;;
+            Net::SSLeay::ssl_write_all&#40;$ssl1, $msg&#41;;
             shutdown $s1, 2;
 
             Net::SSLeay::connect&#40;$ssl2&#41;;
-            Net::SSLeay::write&#40;$ssl2, $msg&#41;;
+            Net::SSLeay::ssl_write_all&#40;$ssl2, $msg&#41;;
             shutdown $s2, 2;
 
             Net::SSLeay::connect&#40;$ssl3&#41;;
-            Net::SSLeay::write&#40;$ssl3, $msg&#41;;
+            Net::SSLeay::ssl_write_all&#40;$ssl3, $msg&#41;;
             shutdown $s3, 2;
 
             close $s1;
@@ -351,7 +362,7 @@ waitpid $pid, 0;
 push @results, [ $? == 0, &#39;server exited with 0&#39; ];
 
 END {
-    Test::More-&gt;builder-&gt;current_test&#40;51&#41;;
+    Test::More-&gt;builder-&gt;current_test&#40;52&#41;;
     for my $t &#40;@results&#41; {
         ok&#40; $t-&gt;[0], $t-&gt;[1] &#41;;
     }
diff --git a/t/local/36_verify.t b/t/local/36_verify.t
index 92afc52..73c3e1a 100644
--- a/t/local/36_verify.t
+++ b/t/local/36_verify.t
@@ -252,8 +252,9 @@ sub client {
     Net::SSLeay::set_fd&#40;$ssl, $cl&#41;;
     Net::SSLeay::connect&#40;$ssl&#41;;
     my $end = &#34;end&#34;;
-    Net::SSLeay::write&#40;$ssl, $end&#41;;
-    ok&#40;$end eq Net::SSLeay::read&#40;$ssl&#41;,  &#39;Successful termination&#39;&#41;;
+    Net::SSLeay::ssl_write_all&#40;$ssl, $end&#41;;
+    Net::SSLeay::shutdown&#40;$ssl&#41;;
+    ok&#40;$end eq Net::SSLeay::ssl_read_all&#40;$ssl&#41;,  &#39;Successful termination&#39;&#41;;
     return;
 }
 
@@ -266,10 +267,20 @@ sub run_server
 
     return if $pid != 0;
 
+    $SIG{&#39;PIPE&#39;} = &#39;IGNORE&#39;;
     my $ctx = Net::SSLeay::CTX_new&#40;&#41;;
     Net::SSLeay::set_cert_and_key&#40;$ctx, $cert_pem, $key_pem&#41;;
     my $ret = Net::SSLeay::CTX_check_private_key&#40;$ctx&#41;;
     BAIL_OUT&#40;&#34;Server: CTX_check_private_key failed: $cert_pem, $key_pem&#34;&#41; unless $ret == 1;
+    if &#40;&#38;Net::SSLeay::OPENSSL_VERSION_NUMBER &gt;= 0x10101007&#41; {
+        # TLS 1.3 server sends session tickets after a handhake as part of
+        # the SSL_accept&#40;&#41;. If a client finishes all its job including closing
+        # TCP connectino before a server sends the tickets, SSL_accept&#40;&#41; fails
+        # with SSL_ERROR_SYSCALL and EPIPE errno and the server receives
+        # SIGPIPE signal. &lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/openssl/openssl/issues/6904">https://github.com/openssl/openssl/issues/6904</a></span>&gt;
+        my $ret = Net::SSLeay::CTX_set_num_tickets&#40;$ctx, 0&#41;;
+        BAIL_OUT&#40;&#34;Session tickets disabled&#34;&#41; unless $ret;
+    }
 
     while &#40;1&#41;
     {
@@ -281,10 +292,10 @@ sub run_server
 	next unless $ret == 1;
 
 	# Termination request or other message from client
-	my $msg = Net::SSLeay::read&#40;$ssl&#41;;
-	if &#40;$msg eq &#39;end&#39;&#41;
+	my $msg = Net::SSLeay::ssl_read_all&#40;$ssl&#41;;
+	if &#40;defined $msg and $msg eq &#39;end&#39;&#41;
 	{
-	    Net::SSLeay::write&#40;$ssl, &#39;end&#39;&#41;;
+	    Net::SSLeay::ssl_write_all&#40;$ssl, &#39;end&#39;&#41;;
 	    exit &#40;0&#41;;
 	}
     }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;17&nbsp;07:23:31&nbsp;2018</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne Čt 16.srp.2018 05:04:53, github@trace.city-fan.org napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Aug 15 11:24:15 2018, ppisar wrote:
<div class="message-stanza open">&gt; &gt; Though there are still other IO-Socket-SSL-1.85 tests that fail or
&gt; &gt; hang &#40;e.g. t/sni.t&#41;. Still needs more work.
</div>&gt; 
&gt; As it stands, this patch set appears to break IO::Socket::SSL&#39;s
&gt; t/nonblock.t tests 13 and 26 &#40;[client] multiple write attempts&#41; on
&gt; older OpenSSL versions, e.g. on Fedora 28 &#40;OpenSSL 1.1.0h&#41;:
&gt; 
</div>That&#39;s because the test uses Net::SSLeay::write_partial&#40;&#41; and expects non-blocking behavior. The fix is the same as in the previous reverting patch, to revert the SSL_ERROR_WANT_READ/SSL_ERROR_WANT_WRITE retry in write_partial&#40;&#41;.

Attached patch does that and documents it.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net-SSLeay-1.85-Move-SSL_ERROR_WANT_READ-SSL_ERROR_WANT_WRITE-retry-from_write_partial.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 122c80853a9bd66f21699fc79a689b3028d00d3b Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= &lt;ppisar@redhat.com&gt;
Date: Fri, 17 Aug 2018 13:08:44 +0200
Subject: [PATCH] Move SSL_ERROR_WANT_READ/SSL_ERROR_WANT_WRITE retry from
 write_partial&#40;&#41;
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Original OpenSSL 1.1.1 fix broke IO-Socket-SSL-2.058&#39;s t/nonblock.t test
because it tests non-blocking socket operations and expects to see
SSL_ERROR_WANT_WRITE errors and to handle them byt itself.

This patch purifies Net::SSLeay::write_partial&#40;&#41; to behave exactly as
underlying OpenSSL SSL_write&#40;&#41; function. The retry is already
presented in Net::SSLeay::ssl_write_all&#40;&#41;.

All applications should implement the retry themsleves or use
ssl_*_all&#40;&#41; instead.

Signed-off-by: Petr PÃ­saÅ &lt;ppisar@redhat.com&gt;
---
 SSLeay.xs          | 16 ++--------------
 lib/Net/SSLeay.pod |  3 ++-
 2 files changed, 4 insertions&#40;+&#41;, 15 deletions&#40;-&#41;

diff --git a/SSLeay.xs b/SSLeay.xs
index 7cb6eab..fc7677f 100644
--- a/SSLeay.xs
+++ b/SSLeay.xs
@@ -2089,20 +2089,8 @@ SSL_write_partial&#40;s,from,count,buf&#41;
      if &#40;len &lt; 0&#41; {
        croak&#40;&#34;from beyound end of buffer&#34;&#41;;
        RETVAL = -1;
-     } else {
-	     int ret;
-	     int err;
-
-	     do {
-		     ret = SSL_write &#40;s, &#38;&#40;buf[from]&#41;, &#40;count&lt;=len&#41;?count:len&#41;;
-		     if &#40;ret &gt; 0&#41;
-			     break;
-		     err = SSL_get_error&#40;s, ret&#41;;
-		     if &#40;err != SSL_ERROR_WANT_READ &#38;&#38; err != SSL_ERROR_WANT_WRITE&#41;
-			     break;
-	     } while &#40;1&#41;;
-	     RETVAL = ret;
-     }
+     } else
+       RETVAL = SSL_write &#40;s, &#38;&#40;buf[from]&#41;, &#40;count&lt;=len&#41;?count:len&#41;;
      OUTPUT:
      RETVAL
 
diff --git a/lib/Net/SSLeay.pod b/lib/Net/SSLeay.pod
index bca7be4..8b5f738 100644
--- a/lib/Net/SSLeay.pod
+++ b/lib/Net/SSLeay.pod
@@ -4819,7 +4819,8 @@ Check openssl doc L&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/ssl/SSL_write.html">http://www.openssl.org/docs/ssl/SSL_write.html</a></span>|<span class="clickylink"><a target="new" rel="nofollow" href="http://www.op">http://www.op</a></span>
 
 B&lt;NOTE:&gt; Does not exactly correspond to any low level API function
 
-Writes a fragment of data in $data from the buffer $data into the specified $ssl connection.
+Writes a fragment of data in $data from the buffer $data into the specified
+$ssl connection. This is a non-blocking function like L&lt;Net::SSLeay::write&#40;&#41;&gt;.
 
  my $rv = Net::SSLeay::write_partial&#40;$ssl, $from, $count, $data&#41;;
  # $ssl - value corresponding to openssl&#39;s SSL structure
-- 
2.14.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;17&nbsp;08:15:17&nbsp;2018</span>
    <span class="description">ppisar [...] redhat.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m playing with IO-Socket-SSL on top of this patched Net-SSLeay and after some tweaks all IO-Socket-SSL tests passes except three of them:

t/npn.t  -- NPN does not work for unknown reason
t/session_ticket.t -- TLSv1.3 tickets needs to use SSL_CTX_sess_set_new_cb&#40;&#41; that is not yet provided by Net-SSLeay.
t/sni_verify.t -- server dies with SIGPIPE because tickets send to closes TCP socket, trivial to fix with a proper SSL_shutdown in t/sni_verify.t.

I opened a ticket for IO-Socket-SSL &#40;CPAN RT#126899&#41;.

I think we should add SSL_CTX_sess_set_new_cb&#40;&#41; wrapper into Net-SSLeay.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;17&nbsp;08:16:46&nbsp;2018</span>
    <span class="description">ppisar [...] redhat.com -  Dependency by ticket #126899 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;17&nbsp;10:16:23&nbsp;2018</span>
    <span class="description">RADIATOR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On pe 17.elokuu 2018 08:15:17, ppisar wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m playing with IO-Socket-SSL on top of this patched Net-SSLeay and
&gt; after some tweaks all IO-Socket-SSL tests passes except three of them:
&gt; 
&gt; t/npn.t  -- NPN does not work for unknown reason
&gt; t/session_ticket.t -- TLSv1.3 tickets needs to use
&gt; SSL_CTX_sess_set_new_cb&#40;&#41; that is not yet provided by Net-SSLeay.
&gt; t/sni_verify.t -- server dies with SIGPIPE because tickets send to
&gt; closes TCP socket, trivial to fix with a proper SSL_shutdown in
&gt; t/sni_verify.t.
&gt; 
&gt; I opened a ticket for IO-Socket-SSL &#40;CPAN RT#126899&#41;.
&gt; 
&gt; I think we should add SSL_CTX_sess_set_new_cb&#40;&#41; wrapper into Net-
&gt; SSLeay.
</div>
Ok, sounds good. I guess that in addition to new_cb&#40;&#41; the two others callbacks, remove_cb&#40;&#41; and get_cb&#40;&#41; should be added too for completeness sake.

-- 
Heikki
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;17&nbsp;10:24:42&nbsp;2018</span>
    <span class="description">github [...] trace.city-fan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Aug 17 07:23:31 2018, ppisar wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dne Čt 16.srp.2018 05:04:53, github@trace.city-fan.org napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; On Wed Aug 15 11:24:15 2018, ppisar wrote:
<div class="message-stanza open">&gt; &gt; &gt; Though there are still other IO-Socket-SSL-1.85 tests that fail or
&gt; &gt; &gt; hang &#40;e.g. t/sni.t&#41;. Still needs more work.
</div>&gt; &gt;
&gt; &gt; As it stands, this patch set appears to break IO::Socket::SSL&#39;s
&gt; &gt; t/nonblock.t tests 13 and 26 &#40;[client] multiple write attempts&#41; on
&gt; &gt; older OpenSSL versions, e.g. on Fedora 28 &#40;OpenSSL 1.1.0h&#41;:
&gt; &gt;
</div>&gt; That&#39;s because the test uses Net::SSLeay::write_partial&#40;&#41; and expects
&gt; non-blocking behavior. The fix is the same as in the previous
&gt; reverting patch, to revert the
&gt; SSL_ERROR_WANT_READ/SSL_ERROR_WANT_WRITE retry in write_partial&#40;&#41;.
&gt; 
&gt; Attached patch does that and documents it.
</div>
Much better, thanks.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;23&nbsp;16:29:51&nbsp;2018</span>
    <span class="description">dam [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am trying to patch the Debian package of Net-SSLeay and I can&#39;t get the tests to succeed.

I tried:
 1. Net-SSLeay-combo-2018-08-16.patch plus Net-SSLeay-combo-2018-08-16.patch
 2. all five patches from fedora&#39;s perl-Net-SSLeay-1.85-7.fc30.src.rpm

and still:

Test Summary Report
-------------------
t/local/07_sslecho.t                 &#40;Wstat: 11 Tests: 52 Failed: 14&#41;
  Failed tests:  3, 10-11, 17-18, 24-25, 31-32, 38-39, 45-46
                52
  Non-zero wait status: 11
  Parse errors: Bad plan.  You planned 79 tests but ran 52.
t/local/08_pipe.t                    &#40;Wstat: 512 Tests: 11 Failed: 3&#41;
  Failed tests:  4, 9-10
  Non-zero exit status: 2
t/local/09_ctx_new.t                 &#40;Wstat: 512 Tests: 40 Failed: 2&#41;
  Failed tests:  26, 28
  Non-zero exit status: 2
t/local/36_verify.t                  &#40;Wstat: 2048 Tests: 79 Failed: 8&#41;
  Failed tests:  32-33, 41, 53-55, 68, 77
  Non-zero exit status: 8
t/local/64_ticket_sharing.t          &#40;Wstat: 65280 Tests: 0 Failed: 0&#41;
  Non-zero exit status: 255
  Parse errors: Bad plan.  You planned 15 tests but ran 0.
Files=32, Tests=2933,  4 wallclock secs &#40; 0.25 usr  0.06 sys +  2.95 cusr  0.38 csys =  3.64 CPU&#41;
Result: FAIL
Failed 5/32 test programs. 27/2933 subtests failed.

What am I doing wrong?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;23&nbsp;16:31:40&nbsp;2018</span>
    <span class="description">dam [...] cpan.org -  Cc DAM added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;24&nbsp;04:28:45&nbsp;2018</span>
    <span class="description">github [...] trace.city-fan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Aug 23 16:29:51 2018, DAM wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I am trying to patch the Debian package of Net-SSLeay and I can&#39;t get
&gt; the tests to succeed.
&gt; 
&gt; I tried:
&gt;  1. Net-SSLeay-combo-2018-08-16.patch plus Net-SSLeay-combo-2018-08-
&gt; 16.patch
&gt;  2. all five patches from fedora&#39;s perl-Net-SSLeay-1.85-7.fc30.src.rpm
&gt; 
&gt; and still:
&gt; 
&gt; Test Summary Report
&gt; -------------------
&gt; t/local/07_sslecho.t                 &#40;Wstat: 11 Tests: 52 Failed: 14&#41;
&gt;   Failed tests:  3, 10-11, 17-18, 24-25, 31-32, 38-39, 45-46
&gt;                 52
&gt;   Non-zero wait status: 11
&gt;   Parse errors: Bad plan.  You planned 79 tests but ran 52.
&gt; t/local/08_pipe.t                    &#40;Wstat: 512 Tests: 11 Failed: 3&#41;
&gt;   Failed tests:  4, 9-10
&gt;   Non-zero exit status: 2
&gt; t/local/09_ctx_new.t                 &#40;Wstat: 512 Tests: 40 Failed: 2&#41;
&gt;   Failed tests:  26, 28
&gt;   Non-zero exit status: 2
&gt; t/local/36_verify.t                  &#40;Wstat: 2048 Tests: 79 Failed: 8&#41;
&gt;   Failed tests:  32-33, 41, 53-55, 68, 77
&gt;   Non-zero exit status: 8
&gt; t/local/64_ticket_sharing.t          &#40;Wstat: 65280 Tests: 0 Failed: 0&#41;
&gt;   Non-zero exit status: 255
&gt;   Parse errors: Bad plan.  You planned 15 tests but ran 0.
&gt; Files=32, Tests=2933,  4 wallclock secs &#40; 0.25 usr  0.06 sys +  2.95
&gt; cusr  0.38 csys =  3.64 CPU&#41;
&gt; Result: FAIL
&gt; Failed 5/32 test programs. 27/2933 subtests failed.
&gt; 
&gt; What am I doing wrong?
</div>
You may need to patch openssl too:
<span class="clickylink"><a target="new" rel="nofollow" href="https://bugzilla.redhat.com/show_bug.cgi?id=1614884">https://bugzilla.redhat.com/show_bug.cgi?id=1614884</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="https://bugzilla.redhat.com/show_bug.cgi?id=1615098">https://bugzilla.redhat.com/show_bug.cgi?id=1615098</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;24&nbsp;10:05:55&nbsp;2018</span>
    <span class="description">RADIATOR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On pe 17.elokuu 2018 10:16:23, RADIATOR wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Ok, sounds good. I guess that in addition to new_cb&#40;&#41; the two others
&gt; callbacks, remove_cb&#40;&#41; and get_cb&#40;&#41; should be added too for
&gt; completeness sake.
</div>
Github issue now exists to track this:
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/radiator-software/p5-net-ssleay/issues/38">https://github.com/radiator-software/p5-net-ssleay/issues/38</a></span>

-- 
Heikki
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;24&nbsp;18:25:26&nbsp;2018</span>
    <span class="description">gregoa [...] cpan.org -  Cc GREGOA added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;04&nbsp;12:11:11&nbsp;2018</span>
    <span class="description">RADIATOR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On pe 24.elokuu 2018 10:05:55, RADIATOR wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Github issue now exists to track this:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/radiator-software/p5-net-ssleay/issues/38">https://github.com/radiator-software/p5-net-ssleay/issues/38</a></span>
</div>
SSL_CTX_set_num_tickets and other changes were merged separately
to github master. What is remaining from the patches posted here
are changes to Net::SSLeay:read&#40;&#41;, related convenience function and tests.

For these, a pull request now exists in github. This pull request
also enables OpenSSL 1.1.1-pre9 with Travis CI.

<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/radiator-software/p5-net-ssleay/pull/56">https://github.com/radiator-software/p5-net-ssleay/pull/56</a></span>

Please see if the above pull request still looks valid. I&#39;d say
the changes to Net::SSLeay::read&#40;&#41; and convenience are the
main changes.

Thanks,

-- 
Heikki Vatiainen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;05&nbsp;05:40:53&nbsp;2018</span>
    <span class="description">RADIATOR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue 04.Sep 2018 12:11:11, RADIATOR wrote:
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; For these, a pull request now exists in github. This pull request
&gt; also enables OpenSSL 1.1.1-pre9 with Travis CI.
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/radiator-software/p5-net-ssleay/pull/56">https://github.com/radiator-software/p5-net-ssleay/pull/56</a></span>
</div>
This was just merged to master. In case more work related to
this needs to be done, please create another RT ticket or github issue.

-- 
Heikki
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;05&nbsp;05:41:04&nbsp;2018</span>
    <span class="description">RADIATOR [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;27&nbsp;14:17:44&nbsp;2018</span>
    <span class="description">SREZIC [...] cpan.org -  Cc SREZIC added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;16&nbsp;11:32:26&nbsp;2018</span>
    <span class="description">chrisn [...] cpan.org -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;16&nbsp;11:32:27&nbsp;2018</span>
    <span class="description">chrisn [...] cpan.org -  Fixed in 1.86_06 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
