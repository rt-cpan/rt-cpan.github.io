<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #79704 for Template-Tiny: 2 feature requests</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #79704 for Template-Tiny: 2 feature requests</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Template-Tiny/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Template-Tiny/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Template-Tiny/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Template-Tiny/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Template-Tiny">Template-Tiny CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">79704</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Template-Tiny/Active/">Template-Tiny</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
DAMS [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-230668-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-230669-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;17&nbsp;17:19:15&nbsp;2012</span>
    <span class="description">DAMS [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

In Dancer2, instead of using our own crappy default simple Template engine, we decided to use 
your Template::Tiny. So far so good.

However, we are missing 2 features :
- be able to change the start / end tag &#40;for isntance use &lt;% instead of [%
- if the expression is a CodeRef, it should be evaluated.

Now, I have a patch for these two features. I have checked out the svn repo listed on metacpan, 
and built the patches against it. Is it good enough or is there any other repo I should use ? Also, 
I couldn&#39;t se any tests in the source. Is there an other tarball / source repo that has some tests 
for T::Tiny ?

Anyway attached is the patch. It implements the 2 features above. Surely you might want to 
refactor it, but you get the idea.

Are you open to have these features in T::Tiny? if yes, a quick release would mean we can rely 
on it for the upcoming Dancer2 release. If not, please let me know, so I can work around that or 
use an other simple Template engine in Dancer2.

Note that the implementation is not optimized, it may trigger too many dereferences and hash 
lookup for you.

Thanks,
dams
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch_template_tiny.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: lib/Template/Tiny.pm
===================================================================
--- lib/Template/Tiny.pm	&#40;revision 15538&#41;
+++ lib/Template/Tiny.pm	&#40;working copy&#41;
@@ -10,26 +10,46 @@
 # Evaluatable expression
 my $EXPR = qr/ [a-z_][\w.]* /xs;
 
-# Opening [% tag including whitespace chomping rules
-my $LEFT = qr/
+# Condition set
+my $CONDITION = qr/
+	\[\%\s
+		&#40; &#40;[IUF]&#41;\d+ &#41; \s+
+		&#40;?:
+			&#40;[a-z]\w*&#41; \s+ IN \s+
+		&#41;?
+		&#40; $EXPR &#41;
+	\s\%\]
+	&#40; .*? &#41;
 	&#40;?:
-		&#40;?: &#40;?:^|\n&#41; [ \t]* &#41;? \[\%\-
+		\[\%\s \1 \s\%\]
+		&#40; .+? &#41;
+	&#41;?
+	\[\%\s \1 \s\%\]
+/xs;
+
+sub new {
+	my $self = bless { start_tag =&gt; &#39;[%&#39;,
+                       end_tag =&gt; &#39;%]&#39;, @_[1..$#_] }, $_[0];
+# Opening tag including whitespace chomping rules
+my $LEFT = $self-&gt;{LEFT} = qr/
+	&#40;?:
+		&#40;?: &#40;?:^|\n&#41; [ \t]* &#41;? \Q$self-&gt;{start_tag}\E\-
 		|
-		\[\% \+?
+		\Q$self-&gt;{start_tag}\E \+?
 	&#41; \s*
 /xs;
 
 # Closing %] tag including whitespace chomping rules
-my $RIGHT  = qr/
+my $RIGHT = $self-&gt;{RIGHT}  = qr/
 	\s* &#40;?:
-		\+? \%\]
+		\+? \Q$self-&gt;{end_tag}\E
 		|
-		\-\%\] &#40;?: [ \t]* \n &#41;?
+		\-\Q$self-&gt;{end_tag}\E &#40;?: [ \t]* \n &#41;?
 	&#41;
 /xs;
 
 # Preparsing run for nesting tags
-my $PREPARSE = qr/
+$self-&gt;{PREPARSE} = qr/
 	$LEFT &#40; IF | UNLESS | FOREACH &#41; \s+
 		&#40;
 			&#40;?: \S+ \s+ IN \s+ &#41;?
@@ -50,26 +70,7 @@
 	&#41;?
 	$LEFT END $RIGHT
 /xs;
-
-# Condition set
-my $CONDITION = qr/
-	\[\%\s
-		&#40; &#40;[IUF]&#41;\d+ &#41; \s+
-		&#40;?:
-			&#40;[a-z]\w*&#41; \s+ IN \s+
-		&#41;?
-		&#40; $EXPR &#41;
-	\s\%\]
-	&#40; .*? &#41;
-	&#40;?:
-		\[\%\s \1 \s\%\]
-		&#40; .+? &#41;
-	&#41;?
-	\[\%\s \1 \s\%\]
-/xs;
-
-sub new {
-	bless { @_[1..$#_] }, $_[0];
+$self;
 }
 
 # Copy and modify
@@ -120,7 +121,7 @@
 	# Preprocess to establish unique matching tag sets
 	my $id = 0;
 	1 while $$copy =~ s/
-		$PREPARSE
+		$self-&gt;{PREPARSE}
 	/
 		my $tag = substr&#40;$1, 0, 1&#41; . ++$id;
 		&#34;\[\% $tag $2 \%\]$3\[\% $tag \%\]&#34;
@@ -148,7 +149,7 @@
 
 	# Resolve expressions
 	$text =~ s/
-		$LEFT &#40; $EXPR &#41; $RIGHT
+		$self-&gt;{LEFT} &#40; $EXPR &#41; $self-&gt;{RIGHT}
 	/
 		eval {
 			$self-&gt;_expression&#40;$stash, $1&#41;
@@ -199,6 +200,9 @@
 			return &#39;&#39;;
 		}
 	}
+    # If the last expression is a CodeRef, execute it
+    ref&#40;$cursor&#41; eq &#39;CODE&#39;
+      and $cursor = $cursor-&gt;&#40;&#41;;
 	return $cursor;
 }
 
@@ -242,8 +246,17 @@
 
 =head2 SUPPORTED USAGE
 
-Only the default C&lt;[% %]&gt; tag style is supported.
+By default, the C&lt;[% %]&gt; tag style is used. You can change the start tag and
+end tag by specifying them at object creation :
 
+  my $template = Template::Tiny-&gt;new&#40;
+      start_tag =&gt; &#39;&lt;%&#39;,
+      end_tag =&gt; &#39;%&gt;,
+  &#41;;
+
+In the rest of the documentation, C&lt;[% %]&gt; will be used, but it can be of
+course your specified start / end tags.
+
 Both the C&lt;[%+ +%]&gt; style explicit whitespace and the C&lt;[%- -%]&gt; style
 explicit chomp B&lt;are&gt; support, although the C&lt;[%+ +%]&gt; version is unneeded
 in practice as B&lt;Template::Tiny&gt; does not support default-enabled C&lt;PRE_CHOMP&gt;
@@ -255,6 +268,8 @@
 objects are supported. &#34;VMethods&#34; such as [% array.length %] are B&lt;not&gt;
 supported at this time.
 
+If the resulting expression is a CodeRef, it&#39;ll be evaluated.
+
 C&lt;IF&gt;, C&lt;ELSE&gt; and C&lt;UNLESS&gt; conditional blocks B&lt;are&gt; supported, but only with
 simple C&lt;[% foo.bar.baz %]&gt; conditions.
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;17&nbsp;17:22:49&nbsp;2012</span>
    <span class="description">DAMS [...] cpan.org -  Subject changed from &#40;no value&#41; to &#39;2 feature requests&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
