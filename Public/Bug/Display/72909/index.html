<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #72909 for CGI-Application: persistence issues</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #72909 for CGI-Application: persistence issues</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/CGI-Application/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/CGI-Application/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/CGI-Application/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/CGI-Application/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/CGI-Application">CGI-Application CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">72909</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/CGI-Application/Active/">CGI-Application</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">MARKSTOS [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
FANY [...] cpan.org

<br />
bitcard [...] mfedv.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-5414-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
4.50    </td>
  </tr>
  <tr id="CF-5415-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;02&nbsp;18:06:49&nbsp;2011</span>
    <span class="description">bitcard [...] mfedv.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> persistence issues</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

the documentation does not say much about object persistence &#40;as opposed
to just perl interpreter persistence&#41; in persistent environments &#40;e.g.
FastCGI, CGI::Application::Server&#41;.

* Feature Request: Documentation should cover persistence.

It would be nice if there was a small howto regarding CGI::Application
object persistence.
  - should it be done at all?
  - what cleanup is an application supposed to do?
  - are plugins supposed to work in persistent environments?


* Bug Report &#40;maybe&#41;: CGI::Application does not cleanup per-request data

I stumbled across 2 issues that I believe should be handled &#40;cleaned up&#41;
by CGI::Application itself &#40;if persistence is to be supported at all&#41;:
  - header settings      &#40;$self-&gt;{__HEADER_PROPS}&#41;
      =&gt; redirect loop
  - prerun_mode settings &#40;$self-&gt;{__PRERUN_MODE}&#41;
      =&gt; locked in given runmode after first use

&#40;see also
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.mail-archive.com/cgiapp@lists.erlbaum.net/msg08997.html&#41;">http://www.mail-archive.com/cgiapp@lists.erlbaum.net/msg08997.html&#41;</a></span>

I am not sure if this classifies as a bug, since the documentation does
not say if persistence is to be used or not.

See also <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=72906">https://rt.cpan.org/Ticket/Display.html?id=72906</a></span> about
CGI::Application::Server

Regards
Matthias
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;28&nbsp;05:06:43&nbsp;2012</span>
    <span class="description">FANY [...] cpan.org -  Requestor FANY added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;28&nbsp;05:24:14&nbsp;2012</span>
    <span class="description">FANY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dear Mark,

I think it would be great if CGI::Application would clean up things like
prerun_mode and headers after each request with regard to persistent
environments like CGI::Application::FastCGI.

What do you think?  If you share this opinion, I could try to write
appropriate patches for CGI::Application, and I would also submit some
for CGI::Application::Plugin::Authentication.  If not, I can
alternatively amend the documentation, as Matthias already suggested,
and maybe should think about an addition for CGI::Application::FastCGI.

As a start, a patch for cleaning up the prerun mode after each request
is attached.

Kind regards,
Martin

PS: Ticket #46258 is still on my TODO list. ☺
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> prerun.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/lib/CGI/Application.pm b/lib/CGI/Application.pm
index f715b4e..3ec2d3d 100644
--- a/lib/CGI/Application.pm
+++ b/lib/CGI/Application.pm
@@ -212,6 +212,7 @@ sub run {
 
 	# clean up operations
 	$self-&gt;call_hook&#40;&#39;teardown&#39;&#41;;
+	$self-&gt;{__PRERUN_MODE} = &#39;&#39; if length $prerun_mode;
 
 	return $return_value;
 }
diff --git a/t/prerun.t b/t/prerun.t
index 115c4b1..25b9b7e 100644
--- a/t/prerun.t
+++ b/t/prerun.t
@@ -1,4 +1,4 @@
-use Test::More tests =&gt; 10;
+use Test::More tests =&gt; 13;
 
 # Need CGI.pm for tests
 use CGI;
@@ -44,6 +44,13 @@ $ENV{CGI_APP_RETURN_ONLY} = 1;
 
 	# get_current_runmode&#40;&#41; working?
 	is&#40;$ta_obj-&gt;get_current_runmode&#40;&#41;, &#39;new_prerun_mode_test&#39;&#41;;
+
+	my $rm = &#39;prerun_test&#39;;
+	$ta_obj-&gt;query&#40; CGI-&gt;new&#40;&#34;rm=$rm&#34;&#41; &#41;;
+	$output = $ta_obj-&gt;run;
+	like&#40; $output, qr!^Content-Type: text/html\b! &#41;;
+	like&#40; $output, qr/Hello World: \Q$rm\E OK\b/ &#41;;
+	is&#40; $ta_obj-&gt;get_current_runmode, $rm &#41;;
 }
 
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;28&nbsp;05:24:16&nbsp;2012</span>
    <span class="description">FANY [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;15&nbsp;09:49:16&nbsp;2012</span>
    <span class="description">FANY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> cgiapp [...] lists.erlbaum.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I wrote on May 28th:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think it would be great if CGI::Application would clean up things
&gt; like prerun_mode and headers after each request with regard to
&gt; persistent environments like CGI::Application::FastCGI.
</div>
Second thought: In order not to risk breaking any existing code – maybe
someone with a persistent environment sets -&gt;header_props in
-&gt;cgiapp_init and relies on them being sticky – maybe it would be
preferable not to change the default behaviour of CGI::Application, but
to provide a -&gt;reset or -&gt;cleanup method which would do the job.

Any opinions on that?

I am planning to have a look at which things exactly should probably be
reset between requests and provide a patch for that sometime soon.

fany
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;15&nbsp;09:49:39&nbsp;2012</span>
    <span class="description">cgiapp-owner [...] lists.erlbaum.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #72909] persistence issues </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 15 Jun 2012 09:49:19 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-cgi-application [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> cgiapp-owner [...] lists.erlbaum.net</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">You are not allowed to post to this mailing list, and your message has
been automatically rejected.  If you think that your messages are
being rejected in error, contact the mailing list owner at
cgiapp-owner@lists.erlbaum.net.
</div></div>
<div class="messageattachments">
<div class="message-stanza plain-text-white-space">
</div><table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> cgiapp [...] lists.erlbaum.net</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #72909] persistence issues </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 15 Jun 2012 09:49:17 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;FANY via RT&#34; &lt;bug-CGI-Application [...] rt.cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=72909">https://rt.cpan.org/Ticket/Display.html?id=72909</a></span> &gt;

I wrote on May 28th:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think it would be great if CGI::Application would clean up things
&gt; like prerun_mode and headers after each request with regard to
&gt; persistent environments like CGI::Application::FastCGI.
</div>
Second thought: In order not to risk breaking any existing code – maybe
someone with a persistent environment sets -&gt;header_props in
-&gt;cgiapp_init and relies on them being sticky – maybe it would be
preferable not to change the default behaviour of CGI::Application, but
to provide a -&gt;reset or -&gt;cleanup method which would do the job.

Any opinions on that?

I am planning to have a look at which things exactly should probably be
reset between requests and provide a patch for that sometime soon.

fany
</div></div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;25&nbsp;12:19:39&nbsp;2013</span>
    <span class="description">MARKSTOS [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;25&nbsp;12:25:14&nbsp;2013</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">CGI::Application works fine in persistent environments.  A number of users deploy it with mod_perl-- I use it with mod_perl every day. 

People also use it in FastCGI as well. 

The CGI::Application::FastCGI approach is broken though, as noted in the one review left for it:

<span class="clickylink"><a target="new" rel="nofollow" href="http://cpanratings.perl.org/dist/CGI-Application-FastCGI">http://cpanratings.perl.org/dist/CGI-Application-FastCGI</a></span>

That review points to this wiki page, which documents a solution that I think should work &#40;although I don&#39;t use FastCGI&#41;:

 <span class="clickylink"><a target="new" rel="nofollow" href="http://www.cgi-app.org/index.cgi?FastCGI">http://www.cgi-app.org/index.cgi?FastCGI</a></span>

As people have been using both FastCGI and mod_perl for years, I don&#39;t think patches should be necessary.

CGI::Application is designed to have a new object created on each request.  

The environment is pesistent in that classes and modules stay loaded in memory, but the CGI::Application object itself is not intended to persist.

If you want something to persistent, I suggest storing it in a class/global variable instead of the object. Some plugins take that approach. 

   Mark
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
