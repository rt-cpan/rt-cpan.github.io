<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #125792 for HTML-Tree: Deep recursion failures in $tree-&gt;delete</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #125792 for HTML-Tree: Deep recursion failures in $tree-&gt;delete</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/HTML-Tree/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/HTML-Tree/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/HTML-Tree/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/HTML-Tree/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/HTML-Tree">HTML-Tree CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">125792</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/HTML-Tree/Active/">HTML-Tree</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
tlhackque [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-16146-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-16147-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;08&nbsp;11:35:20&nbsp;2018</span>
    <span class="description">tlhackque [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Deep recursion failures in $tree-&gt;delete</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 8 Jul 2018 11:27:30 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-HTML-Tree [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Timothe Litt &lt;tlhackque [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Deep recursion failures in $tree-&gt;delete</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-HTML-Tree [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Timothe Litt &lt;tlhackque [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Symptom:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">bug&gt; perl treebug.pl
</div>Deep recursion on subroutine &#34;HTML::Element::delete&#34; at
C:/Perl64/lib/HTML/Element.pm line 567.
Deep recursion on subroutine &#34;HTML::Element::delete_content&#34; at
C:/Perl64/lib/HTML/Element.pm line 580.

I have no control over the HTML, and am processing thousands of files.
The failure is reproducible with a given file, but can be very sensitive
to the environment.

Diagnosis:

I have reduced one failing case to a small html file, shown below.  It
reproduces the
failure 100% of the time.

If you delete one &lt;A&gt;, the failure disappears.

If you run perl -d &#38; simply hit c&lt;cr&gt; - the failure disappears.

As best I can tell, this is due to malformed HTML, which was originally
generated
in 1999, by MS Word 97 and widely distributed by another major software
vendor.
It is not an artificial construct.

There are no closing tags on &lt;A&gt; elements. &#40;!&#41;  This produces an extreme
right-leaning tree, and delete attempts to delete it using recursion, at
some point
hitting the Perl sanity limit.

Malformed or not, if HTML::Tree can create a structure, it shouldn&#39;t
have trouble
deleting it.

Options:

It seems to me that there are several choices:

- Limit the depth of structures that HTML::Tree will build.  This would
make some
  HTML unparsable.

- Convert the deletion algorithm to an iterative one.  Something like:
walk iteratively
  to a leaf node, save the parent link  delete the leaf. Then repeat for
the parent link
  until you reach the top.  This keeps the function, but would reduce
the stack usage
  to reasonable levels for all inputs.

- Make delete&#40;&#41; into a NoOp.  Since you state that it&#39;s not necessary
due to the use of
  weak references, this may be the best option.

For now, the workaround seems to be not calling delete&#40;&#41;.  However, when a
long-running process is involved, it is reassuring to call delete &#34;just
in case&#34; a
circular reference was missed in the weakening.

I want to emphasize that the apparently &#34;trivial&#34; test case below is the
result of an
effort to understand these failures in real-world documents.  This is
not a contrived
issue.  &#40;I can supply a sample off-line if desired.&#41;

Below find:

- A test program

- The smallest test case that produces the problem

- Version information.

Here is the test program:

use warnings;
use strict;
use HTML::Treebuilder;
use Data::Dumper; $Data::Dumper::Sortkeys=1;
my $file = &#39;treebug.raw.html&#39;;
$file = &#39;treebug.html&#39;;
my $dump = 0;
my $data;
{
    open&#40; my $fh, &#39;&lt;&#39;, $file&#41; or die $!;
    local $/;
    $data = &lt;$fh&gt;;
    close $fh;
}
    die&#40; &#34;no data&#34; &#41; unless&#40; $data &#41;;

    my $tree = HTML::TreeBuilder-&gt;new;
    $tree-&gt;parse_content&#40; $data &#41;;
if&#40; $dump &#41; {
open my $fh, &#39;&gt;&#39;, &#39;treebug.dump&#39; or die $!;
print $fh Dumper&#40; $tree &#41;;
close $fh;
}
    $tree-&gt;delete;
exit;

And here is the test file &#40;105 lines&#41;:

&lt;HTML&gt;
&lt;BODY&gt;
&lt;TABLE&gt;
&lt;TR&gt;&lt;TD&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;A&gt;
&lt;/TD&gt;
&lt;/TR&gt;
&lt;/TABLE&gt;
&lt;/BODY&gt;
&lt;/HTML&gt;

HTML::Element version:

x $HTML::Element::VERSION
0  5.07

And Perl version:

perl -V
Summary of my perl5 &#40;revision 5 version 26 subversion 1&#41; configuration:

  Platform:
    osname=MSWin32
    osvers=6.1
    archname=MSWin32-x64-multi-thread
    uname=&#39;&#39;
    config_args=&#39;undef&#39;
    hint=recommended
    useposix=true
    d_sigaction=undef
    useithreads=define
    usemultiplicity=define
    use64bitint=define
    use64bitall=undef
    uselongdouble=undef
    usemymalloc=n
    default_inc_excludes_dot=define
    bincompat5005=undef
  Compiler:
    cc=&#39;C:\Perl64\site\bin\gcc.exe&#39;
    ccflags =&#39; -s -O2 -DWIN32 -DWIN64 -DCONSERVATIVE
-DPERL_TEXTMODE_SCRIPTS -DUSE_SITECUSTOMIZE -DPERL_IMPLICIT_CONTEXT
-DPERL_IMPLICIT_SYS -fwrapv -fno-strict-aliasing -mms-bitfields&#39;
    optimize=&#39;-s -O2&#39;
    cppflags=&#39;-DWIN32&#39;
    ccversion=&#39;&#39;
    gccversion=&#39;4.6.3&#39;
    gccosandvers=&#39;&#39;
    intsize=4
    longsize=4
    ptrsize=8
    doublesize=8
    byteorder=12345678
    doublekind=3
    d_longlong=define
    longlongsize=8
    d_longdbl=define
    longdblsize=16
    longdblkind=3
    ivtype=&#39;long long&#39;
    ivsize=8
    nvtype=&#39;double&#39;
    nvsize=8
    Off_t=&#39;long long&#39;
    lseeksize=8
    alignbytes=8
    prototype=define
  Linker and Libraries:
    ld=&#39;C:\Perl64\site\bin\g++.exe&#39;
    ldflags =&#39;-s -static-libgcc -static-libstdc++ -L&#34;C:\Perl64\lib\CORE&#34;
-L&#34;C:\MinGW\x86_64-w64-mingw32\lib&#34;&#39;
    libpth=C:\MinGW\x86_64-w64-mingw32\lib
    libs=-lmoldname -lkernel32 -luser32 -lgdi32 -lwinspool -lcomdlg32
-ladvapi32 -lshell32 -lole32 -loleaut32 -lnetapi32 -luuid -lws2_32 -lmpr
-lwinmm -lversion -lodbc32 -lodbccp32 -lcomctl32
    perllibs=-lmoldname -lkernel32 -luser32 -lgdi32 -lwinspool
-lcomdlg32 -ladvapi32 -lshell32 -lole32 -loleaut32 -lnetapi32 -luuid
-lws2_32 -lmpr -lwinmm -lversion -lodbc32 -lodbccp32 -lcomctl32
    libc=
    so=dll
    useshrplib=true
    libperl=libperl526.a
    gnulibc_version=&#39;&#39;
  Dynamic Linking:
    dlsrc=dl_win32.xs
    dlext=dll
    d_dlsymun=undef
    ccdlflags=&#39; &#39;
    cccdlflags=&#39; &#39;
    lddlflags=&#39;-mdll -s -static-libgcc -static-libstdc++
-L&#34;C:\Perl64\lib\CORE&#34; -L&#34;C:\MinGW\x86_64-w64-mingw32\lib&#34;&#39;


Characteristics of this binary &#40;from libperl&#41;:
  Compile-time options:
    HAS_TIMES
    HAVE_INTERP_INTERN
    MULTIPLICITY
    PERLIO_LAYERS
    PERL_COPY_ON_WRITE
    PERL_DONT_CREATE_GVSV
    PERL_IMPLICIT_CONTEXT
    PERL_IMPLICIT_SYS
    PERL_MALLOC_WRAP
    PERL_OP_PARENT
    PERL_PRESERVE_IVUV
    USE_64_BIT_INT
    USE_ITHREADS
    USE_LARGE_FILES
    USE_LOCALE
    USE_LOCALE_COLLATE
    USE_LOCALE_CTYPE
    USE_LOCALE_NUMERIC
    USE_LOCALE_TIME
    USE_PERLIO
    USE_PERL_ATOF
    USE_SITECUSTOMIZE
  Locally applied patches:
    ActivePerl Build 2601 [404865]
  Built under MSWin32
  Compiled at Dec 11 2017 12:23:25
  @INC:
    C:/Perl64/site/lib
    C:/Perl64/lib
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
