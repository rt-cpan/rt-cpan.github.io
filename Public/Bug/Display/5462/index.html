<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #5462 for MIME-tools: MIME::Words::encode_mimewords strips spaces</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #5462 for MIME-tools: MIME::Words::encode_mimewords strips spaces</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/MIME-tools/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/MIME-tools/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/MIME-tools/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/MIME-tools/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/MIME-tools">MIME-tools CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">5462</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/MIME-tools/Active/">MIME-tools</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">dfs+pause [...] roaringpenguin.com
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jonas [...] paranormal.se

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-21368-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
5.411a    </td>
  </tr>
  <tr id="CF-21369-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;26&nbsp;08:18:16&nbsp;2004</span>
    <span class="description">jonas [...] paranormal.se -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> MIME::Words::encode_mimewords strips spaces</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">MIME::Words::encode_mimewords removes the spaces between words in the cases there two words in a row is mime encoded.

I&#39;m currently working around this problem by doing:

sub encode_mimewords
{
    use MIME::Words;
    my $string = MIME::Words::encode_mimewords&#40;$_[0]&#41;;
    $string =~ s/\?= =\?ISO-8859-1\?Q\?/?= =?ISO-8859-1?Q?_/g;
    return $string;
}
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;05&nbsp;20:34:36&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> christian.jaeger-rtcpanorg [...] ethlife.ethz.ch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[JONAS - Thu Feb 26 08:18:16 2004]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; MIME::Words::encode_mimewords removes the spaces between words in the
&gt;    cases there two words in a row is mime encoded.
</div>..
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;     $string =~ s/\?= =\?ISO-8859-1\?Q\?/?= =?ISO-8859-1?Q?_/g;
</div>
Hm, I&#39;ve seen too that two mime encoded words &#40;two encoded tokens, only
separated by a space like in ...?= =?...&#41; would be viewed without the
space when read in Eudora. But then I&#39;ve noticed that squirrelmail
displays that with a space. So I then concluded that it was a bug in
Eudora. I&#39;ve not read the specs, so can&#39;t decide what&#39;s correct, but
just wanted to let you know about the differing client behaviour.

Cheers
Christian
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;12&nbsp;04:55:09&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Olivier Salaun [...] cru.fr</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Mozilla &#40;1.6&#41; interprets encoded subjects the same way.

RFC 1522 seem to indicate that spaces between encoded-words are ignored :
   ftp://ftp.cru.fr/pub/reseau/RFCs/rfc1522.txt, chapter 5
      ... an encoded-word that appears in a header field defined as
**text** MUST be separated from any adjacent encoded-word or **text** by
linear-white-space.

Therefore encoding a string like &#34;word1 word2&#34;, should look like
&#34;=?charset?Q?encoded_word1_?= =?charset?Q?encoded_word2?=

Note the &#39;_&#39; at the end of the encoded_word1 is needed to preserve the
white-space between words.

[guest - Thu Aug  5 20:34:36 2004]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hm, I&#39;ve seen too that two mime encoded words &#40;two encoded tokens,
&gt;    only
&gt; separated by a space like in ...?= =?...&#41; would be viewed without the
&gt; space when read in Eudora. But then I&#39;ve noticed that squirrelmail
&gt; displays that with a space. So I then concluded that it was a bug in
&gt; Eudora. I&#39;ve not read the specs, so can&#39;t decide what&#39;s correct, but
&gt; just wanted to let you know about the differing client behaviour.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;28&nbsp;14:29:49&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Alexey Mahotkin &lt;alexm [...] hsys.msk.ru&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[JONAS - Thu Feb 26 08:18:16 2004]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; MIME::Words::encode_mimewords removes the spaces between words in the
&gt; cases there two words in a row is mime encoded.
</div>
Jonas,

please try the attached patch.  Thank you.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I&#39;m currently working around this problem by doing:
&gt; 
&gt; sub encode_mimewords
&gt; {
&gt;     use MIME::Words;
&gt;     my $string = MIME::Words::encode_mimewords&#40;$_[0]&#41;;
&gt;     $string =~ s/\?= =\?ISO-8859-1\?Q\?/?= =?ISO-8859-1?Q?_/g;
&gt;     return $string;
&gt; }
</div></div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">? Makefile
? blib
? encode_mimewords.patch
? pm_to_blib
? testout
Index: ChangeLog
===================================================================
RCS file: /home/cvs/src/perl-MIME-tools/ChangeLog,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -u -r1.1.1.1 -r1.2
--- ChangeLog	2004/10/28 17:12:16	1.1.1.1
+++ ChangeLog	2004/10/28 18:05:22	1.2
@@ -1,3 +1,7 @@
+2004-10-28  Alexey Mahotkin &lt;alexm:eternal-eval.com&gt;
+
+        * Made encode_mimewords fully compliant to RFC1522
+
 2004-10-27  David F. Skoll  &lt;dfs@roaringpenguin.com&gt;
 
 	* VERSION 5.415 RELEASED
Index: lib/MIME/Words.pm
===================================================================
RCS file: /home/cvs/src/perl-MIME-tools/lib/MIME/Words.pm,v
retrieving revision 1.1.1.1
retrieving revision 1.4
diff -u -r1.1.1.1 -r1.4
--- lib/MIME/Words.pm	2004/10/28 17:12:16	1.1.1.1
+++ lib/MIME/Words.pm	2004/10/28 18:05:22	1.4
@@ -267,7 +267,7 @@
 
 I&lt;Function.&gt;
 Given a RAW string, try to find and encode all &#34;unsafe&#34; sequences 
-of characters:
+of characters, according to RFC1522:
 
     ### Encode a string with some unsafe &#34;words&#34;:
     $encoded = encode_mimewords&#40;&#34;Me and \xABFran\xE7ois\xBB&#34;&#41;;
@@ -292,13 +292,6 @@
 
 =back
 
-B&lt;Warning:&gt; this is a quick-and-dirty solution, intended for character
-sets which overlap ASCII.  B&lt;It does not comply with the RFC-1522
-rules regarding the use of encoded words in message headers&gt;.
-You may want to roll your own variant,
-using C&lt;encoded_mimeword&#40;&#41;&gt;, for your application.
-I&lt;Thanks to Jan Kasprzak for reminding me about this problem.&gt;
-
 =cut
 
 sub encode_mimewords {
@@ -306,17 +299,60 @@
     my $charset  = $params{Charset} || &#39;ISO-8859-1&#39;;
     my $encoding = lc&#40;$params{Encoding} || &#39;q&#39;&#41;;
 
-    ### Encode any &#34;words&#34; with unsafe characters.
-    ###    We limit such words to 18 characters, to guarantee that the 
-    ###    worst-case encoding give us no more than 54 + ~10 &lt; 75 characters
-    my $word;
-    $rawstr =~ s{&#40;[a-zA-Z0-9\x7F-\xFF]{1,18}&#41;}{     ### get next &#34;word&#34;
-	$word = $1;
-	&#40;&#40;$word !~ /[$NONPRINT]/o&#41; 
-	 ? $word                                          ### no unsafe chars
-	 : encode_mimeword&#40;$word, $encoding, $charset&#41;&#41;;  ### has unsafe chars
-    }xeg;
-    $rawstr;
+    my $safe_chars = &#34;-+*/=_!A-Za-z0-9&#34;;
+    my $re = &#34;[$safe_chars]&#34;;
+    my $nre = &#34;[^$safe_chars]&#34;;
+
+    my $result = &#34;&#34;;
+    my $current = $rawstr;
+
+    while &#40;$current ne &#34;&#34;&#41; {
+      if &#40;$current =~ s/^&#40;&#40;[$safe_chars]|\s&#41;+&#41;//&#41; {
+	# safe chars &#40;w/spaces&#41; are handled as-is
+	$result .= $1;
+	next;
+      } elsif &#40;$current =~ s/^&#40;&#40;[^$safe_chars]|\s&#41;+&#41;//&#41; {
+	# unsafe chars &#40;w/spaces&#41; are encoded
+	my $unsafe_chars = $1;
+      CHUNK75:
+	while &#40;$unsafe_chars ne &#34;&#34;&#41; {
+
+	  my $full_len = length&#40;$unsafe_chars&#41;;
+	  my $len = 1;
+	  my $prev_encoded = &#34;&#34;;
+
+	  while &#40;$len &lt;= $full_len&#41; {
+	    # we try to encode next beginning of unsafe string
+	    my $possible = substr $unsafe_chars, 0, $len;
+	    my $encoded = encode_mimeword&#40;$possible, $encoding, $charset&#41;;
+
+	    if &#40;length&#40;$encoded&#41; &lt; 75&#41; {
+	      # if it could be encoded in specified maximum length, try
+	      # bigger beginning...
+	      $prev_encoded = $encoded;
+	    } else {
+	      #
+	      # ...otherwise, add encoded chunk which still fits, and
+	      # restart with rest of unsafe string
+	      $result .= $prev_encoded;
+	      $prev_encoded = &#34;&#34;;
+	      substr $unsafe_chars, 0, $len - 1, &#34;&#34;;
+	      next CHUNK75;
+	    }
+
+	    # if we have reached the end of the string, add final
+	    # encoded chunk
+	    if &#40;$len == $full_len&#41; {
+	      $result .= $encoded;
+	      last CHUNK75;
+	    }
+
+	    $len++;
+	  }
+	}
+      }
+    }
+    return $result;
 }
 
 1;
@@ -331,10 +367,11 @@
 MIME::Base64 and MIME::QuotedPrint.
 
 
-=head1 AUTHOR
+=head1 AUTHORS
 
 Eryq &#40;F&lt;eryq@zeegee.com&gt;&#41;, ZeeGee Software Inc &#40;F&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.zeegee.com">http://www.zeegee.com</a></span>&gt;&#41;.
 David F. Skoll &#40;dfs@roaringpenguin.com&#41; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.roaringpenguin.com">http://www.roaringpenguin.com</a></span>
+Alexey Mahotkin &#40;alexm:eternal-eval.com&#41; <span class="clickylink"><a target="new" rel="nofollow" href="http://eternal-eval.com/">http://eternal-eval.com/</a></span>
 
 All rights reserved.  This program is free software; you can redistribute 
 it and/or modify it under the same terms as Perl itself.
Index: t/Words.t
===================================================================
RCS file: /home/cvs/src/perl-MIME-tools/t/Words.t,v
retrieving revision 1.1.1.1
retrieving revision 1.4
diff -u -r1.1.1.1 -r1.4
--- t/Words.t	2004/10/28 17:12:16	1.1.1.1
+++ t/Words.t	2004/10/28 18:08:52	1.4
@@ -4,7 +4,7 @@
 use ExtUtils::TBone;
 
 use MIME::QuotedPrint qw&#40;decode_qp&#41;;
-use MIME::Words qw&#40;decode_mimewords&#41;;
+use MIME::Words qw&#40;decode_mimewords encode_mimewords&#41;;
 
 #------------------------------------------------------------
 # BEGIN
@@ -12,8 +12,22 @@
 
 # Create checker:
 my $T = typical ExtUtils::TBone;
-$T-&gt;begin&#40;10&#41;;
 
+# we test each non-empty line in subjects.txt
+open WORDS, &#34;&lt;testin/subjects.txt&#34; or die &#34;open: $!&#34;;
+my $subjects_count = 0;
+while &#40;my $line = &lt;WORDS&gt;&#41; {
+  next if &#40;$line =~ /^\s*$/&#41;;
+  $subjects_count++;
+}
+close WORDS;
+
+
+# for each line we do 4 tests:
+#   whether each line correctly encodes/decodes, twice for each encoding
+#   whethere encoded chunks are smaller than 75 bytes
+$T-&gt;begin&#40;10 + $subjects_count * 4&#41;;
+
 {
     local&#40;$/&#41; = &#39;&#39;;
     open WORDS, &#34;&lt;testin/words.txt&#34; or die &#34;open: $!&#34;;
@@ -36,6 +50,47 @@
     }
     close WORDS;
 }    
+
+{
+  open WORDS, &#34;&lt;testin/subjects.txt&#34; or die &#34;open: $!&#34;;
+  while &#40;my $line = &lt;WORDS&gt;&#41; {
+    chomp $line;
+    next if &#40;$line =~ /^\s*$/&#41;;
+
+    foreach my $encoding &#40;qw&#40;q b&#41;&#41; {
+      my $encoded = encode_mimewords&#40;$line,
+				     Encoding =&gt; $encoding,
+				    &#41;;
+      my $decoded = decode_mimewords&#40;$encoded,
+				     Encoding =&gt; $encoding,
+				    &#41;;
+      if &#40;$line eq $decoded&#41; {
+	# warn &#34;ok: $line\nencoded: $encoded\ndecoded: $decoded\n&#34;;
+	$T-&gt;ok&#40; 1 &#41;;
+      } else {
+
+	warn &#34;in: $line\nencoded: $encoded\ndecoded: $decoded\n&#34;;
+
+	$T-&gt;ok&#40; 0 &#41;;
+      }
+
+      my $failed_token = &#34;&#34;;
+      while &#40;$encoded =~ /&#40;=\?[^\?]+\?[bq]\?[^\?]+\?=&#41;/ig&#41; {
+	if &#40;length&#40;$1&#41; &gt; 75&#41; {
+          $failed_token = $1;
+        }
+      }
+      if &#40;$failed_token ne &#34;&#34;&#41; {
+        warn &#34;failed_token: &#39;$failed_token&#39;&#34;;
+        $T-&gt;ok&#40;0&#41;;
+      } else {
+        $T-&gt;ok&#40;1&#41;;
+      }
+    }
+  }
+
+  close WORDS;
+}
 
 # Done!
 $T-&gt;end;
Index: testin/subjects.txt
===================================================================
RCS file: subjects.txt
diff -N subjects.txt
--- /dev/null	Wed May  6 00:32:27 1998
+++ /tmp/cvsfOgeLU	Thu Oct 28 22:08:59 2004
@@ -0,0 +1,19 @@
+Á
+ÁÂ
+ÁÂ×
+ÁÂ×Ç
+ÁÂ×ÇÄ
+ÍÁÍÁ ÍÙÌÁ ÒÁÍÕ
+
+a
+ab
+abc
+abcd
+hello world
+
+hello ÒÕÓÓËÉÊ
+hello ÒÕÓÓËÉÊ hello
+
+ÒÕÓÓËÉÊ a ÒÕÓÓËÉÊ b ÒÕÓÓËÉÊ c ÒÕÓÓËÉÊ d ÒÕÓÓËÉÊ e ÒÕÓÓËÉÊ
+ËÁÖÄÙÊ ÏÈÏÔÎÉË ÖÅÌÁÅÔ ÚÎÁÔØ, ÇÄÅ ÓÉÄÉÔ ÆÁÚÁÎ ÓßÅÛØ ÅÝ£ ÜÔÉÈ ÍÑÇËÉÈ ÆÒÁÎÃÕÚÓËÉÊ ÂÕÌÏÞÅË, ÄÁ ×ÙÐÅÊ ÞÁÀ
+
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;28&nbsp;14:30:01&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Alexey Mahotkin &lt;alexm [...] hsys.msk.ru&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[JONAS - Thu Feb 26 08:18:16 2004]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; MIME::Words::encode_mimewords removes the spaces between words in the
&gt; cases there two words in a row is mime encoded.
</div>
Jonas,

please try the attached patch.  Thank you.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I&#39;m currently working around this problem by doing:
&gt; 
&gt; sub encode_mimewords
&gt; {
&gt;     use MIME::Words;
&gt;     my $string = MIME::Words::encode_mimewords&#40;$_[0]&#41;;
&gt;     $string =~ s/\?= =\?ISO-8859-1\?Q\?/?= =?ISO-8859-1?Q?_/g;
&gt;     return $string;
&gt; }
</div></div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">? Makefile
? blib
? encode_mimewords.patch
? pm_to_blib
? testout
Index: ChangeLog
===================================================================
RCS file: /home/cvs/src/perl-MIME-tools/ChangeLog,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -u -r1.1.1.1 -r1.2
--- ChangeLog	2004/10/28 17:12:16	1.1.1.1
+++ ChangeLog	2004/10/28 18:05:22	1.2
@@ -1,3 +1,7 @@
+2004-10-28  Alexey Mahotkin &lt;alexm:eternal-eval.com&gt;
+
+        * Made encode_mimewords fully compliant to RFC1522
+
 2004-10-27  David F. Skoll  &lt;dfs@roaringpenguin.com&gt;
 
 	* VERSION 5.415 RELEASED
Index: lib/MIME/Words.pm
===================================================================
RCS file: /home/cvs/src/perl-MIME-tools/lib/MIME/Words.pm,v
retrieving revision 1.1.1.1
retrieving revision 1.4
diff -u -r1.1.1.1 -r1.4
--- lib/MIME/Words.pm	2004/10/28 17:12:16	1.1.1.1
+++ lib/MIME/Words.pm	2004/10/28 18:05:22	1.4
@@ -267,7 +267,7 @@
 
 I&lt;Function.&gt;
 Given a RAW string, try to find and encode all &#34;unsafe&#34; sequences 
-of characters:
+of characters, according to RFC1522:
 
     ### Encode a string with some unsafe &#34;words&#34;:
     $encoded = encode_mimewords&#40;&#34;Me and \xABFran\xE7ois\xBB&#34;&#41;;
@@ -292,13 +292,6 @@
 
 =back
 
-B&lt;Warning:&gt; this is a quick-and-dirty solution, intended for character
-sets which overlap ASCII.  B&lt;It does not comply with the RFC-1522
-rules regarding the use of encoded words in message headers&gt;.
-You may want to roll your own variant,
-using C&lt;encoded_mimeword&#40;&#41;&gt;, for your application.
-I&lt;Thanks to Jan Kasprzak for reminding me about this problem.&gt;
-
 =cut
 
 sub encode_mimewords {
@@ -306,17 +299,60 @@
     my $charset  = $params{Charset} || &#39;ISO-8859-1&#39;;
     my $encoding = lc&#40;$params{Encoding} || &#39;q&#39;&#41;;
 
-    ### Encode any &#34;words&#34; with unsafe characters.
-    ###    We limit such words to 18 characters, to guarantee that the 
-    ###    worst-case encoding give us no more than 54 + ~10 &lt; 75 characters
-    my $word;
-    $rawstr =~ s{&#40;[a-zA-Z0-9\x7F-\xFF]{1,18}&#41;}{     ### get next &#34;word&#34;
-	$word = $1;
-	&#40;&#40;$word !~ /[$NONPRINT]/o&#41; 
-	 ? $word                                          ### no unsafe chars
-	 : encode_mimeword&#40;$word, $encoding, $charset&#41;&#41;;  ### has unsafe chars
-    }xeg;
-    $rawstr;
+    my $safe_chars = &#34;-+*/=_!A-Za-z0-9&#34;;
+    my $re = &#34;[$safe_chars]&#34;;
+    my $nre = &#34;[^$safe_chars]&#34;;
+
+    my $result = &#34;&#34;;
+    my $current = $rawstr;
+
+    while &#40;$current ne &#34;&#34;&#41; {
+      if &#40;$current =~ s/^&#40;&#40;[$safe_chars]|\s&#41;+&#41;//&#41; {
+	# safe chars &#40;w/spaces&#41; are handled as-is
+	$result .= $1;
+	next;
+      } elsif &#40;$current =~ s/^&#40;&#40;[^$safe_chars]|\s&#41;+&#41;//&#41; {
+	# unsafe chars &#40;w/spaces&#41; are encoded
+	my $unsafe_chars = $1;
+      CHUNK75:
+	while &#40;$unsafe_chars ne &#34;&#34;&#41; {
+
+	  my $full_len = length&#40;$unsafe_chars&#41;;
+	  my $len = 1;
+	  my $prev_encoded = &#34;&#34;;
+
+	  while &#40;$len &lt;= $full_len&#41; {
+	    # we try to encode next beginning of unsafe string
+	    my $possible = substr $unsafe_chars, 0, $len;
+	    my $encoded = encode_mimeword&#40;$possible, $encoding, $charset&#41;;
+
+	    if &#40;length&#40;$encoded&#41; &lt; 75&#41; {
+	      # if it could be encoded in specified maximum length, try
+	      # bigger beginning...
+	      $prev_encoded = $encoded;
+	    } else {
+	      #
+	      # ...otherwise, add encoded chunk which still fits, and
+	      # restart with rest of unsafe string
+	      $result .= $prev_encoded;
+	      $prev_encoded = &#34;&#34;;
+	      substr $unsafe_chars, 0, $len - 1, &#34;&#34;;
+	      next CHUNK75;
+	    }
+
+	    # if we have reached the end of the string, add final
+	    # encoded chunk
+	    if &#40;$len == $full_len&#41; {
+	      $result .= $encoded;
+	      last CHUNK75;
+	    }
+
+	    $len++;
+	  }
+	}
+      }
+    }
+    return $result;
 }
 
 1;
@@ -331,10 +367,11 @@
 MIME::Base64 and MIME::QuotedPrint.
 
 
-=head1 AUTHOR
+=head1 AUTHORS
 
 Eryq &#40;F&lt;eryq@zeegee.com&gt;&#41;, ZeeGee Software Inc &#40;F&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.zeegee.com">http://www.zeegee.com</a></span>&gt;&#41;.
 David F. Skoll &#40;dfs@roaringpenguin.com&#41; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.roaringpenguin.com">http://www.roaringpenguin.com</a></span>
+Alexey Mahotkin &#40;alexm:eternal-eval.com&#41; <span class="clickylink"><a target="new" rel="nofollow" href="http://eternal-eval.com/">http://eternal-eval.com/</a></span>
 
 All rights reserved.  This program is free software; you can redistribute 
 it and/or modify it under the same terms as Perl itself.
Index: t/Words.t
===================================================================
RCS file: /home/cvs/src/perl-MIME-tools/t/Words.t,v
retrieving revision 1.1.1.1
retrieving revision 1.4
diff -u -r1.1.1.1 -r1.4
--- t/Words.t	2004/10/28 17:12:16	1.1.1.1
+++ t/Words.t	2004/10/28 18:08:52	1.4
@@ -4,7 +4,7 @@
 use ExtUtils::TBone;
 
 use MIME::QuotedPrint qw&#40;decode_qp&#41;;
-use MIME::Words qw&#40;decode_mimewords&#41;;
+use MIME::Words qw&#40;decode_mimewords encode_mimewords&#41;;
 
 #------------------------------------------------------------
 # BEGIN
@@ -12,8 +12,22 @@
 
 # Create checker:
 my $T = typical ExtUtils::TBone;
-$T-&gt;begin&#40;10&#41;;
 
+# we test each non-empty line in subjects.txt
+open WORDS, &#34;&lt;testin/subjects.txt&#34; or die &#34;open: $!&#34;;
+my $subjects_count = 0;
+while &#40;my $line = &lt;WORDS&gt;&#41; {
+  next if &#40;$line =~ /^\s*$/&#41;;
+  $subjects_count++;
+}
+close WORDS;
+
+
+# for each line we do 4 tests:
+#   whether each line correctly encodes/decodes, twice for each encoding
+#   whethere encoded chunks are smaller than 75 bytes
+$T-&gt;begin&#40;10 + $subjects_count * 4&#41;;
+
 {
     local&#40;$/&#41; = &#39;&#39;;
     open WORDS, &#34;&lt;testin/words.txt&#34; or die &#34;open: $!&#34;;
@@ -36,6 +50,47 @@
     }
     close WORDS;
 }    
+
+{
+  open WORDS, &#34;&lt;testin/subjects.txt&#34; or die &#34;open: $!&#34;;
+  while &#40;my $line = &lt;WORDS&gt;&#41; {
+    chomp $line;
+    next if &#40;$line =~ /^\s*$/&#41;;
+
+    foreach my $encoding &#40;qw&#40;q b&#41;&#41; {
+      my $encoded = encode_mimewords&#40;$line,
+				     Encoding =&gt; $encoding,
+				    &#41;;
+      my $decoded = decode_mimewords&#40;$encoded,
+				     Encoding =&gt; $encoding,
+				    &#41;;
+      if &#40;$line eq $decoded&#41; {
+	# warn &#34;ok: $line\nencoded: $encoded\ndecoded: $decoded\n&#34;;
+	$T-&gt;ok&#40; 1 &#41;;
+      } else {
+
+	warn &#34;in: $line\nencoded: $encoded\ndecoded: $decoded\n&#34;;
+
+	$T-&gt;ok&#40; 0 &#41;;
+      }
+
+      my $failed_token = &#34;&#34;;
+      while &#40;$encoded =~ /&#40;=\?[^\?]+\?[bq]\?[^\?]+\?=&#41;/ig&#41; {
+	if &#40;length&#40;$1&#41; &gt; 75&#41; {
+          $failed_token = $1;
+        }
+      }
+      if &#40;$failed_token ne &#34;&#34;&#41; {
+        warn &#34;failed_token: &#39;$failed_token&#39;&#34;;
+        $T-&gt;ok&#40;0&#41;;
+      } else {
+        $T-&gt;ok&#40;1&#41;;
+      }
+    }
+  }
+
+  close WORDS;
+}
 
 # Done!
 $T-&gt;end;
Index: testin/subjects.txt
===================================================================
RCS file: subjects.txt
diff -N subjects.txt
--- /dev/null	Wed May  6 00:32:27 1998
+++ /tmp/cvsfOgeLU	Thu Oct 28 22:08:59 2004
@@ -0,0 +1,19 @@
+Á
+ÁÂ
+ÁÂ×
+ÁÂ×Ç
+ÁÂ×ÇÄ
+ÍÁÍÁ ÍÙÌÁ ÒÁÍÕ
+
+a
+ab
+abc
+abcd
+hello world
+
+hello ÒÕÓÓËÉÊ
+hello ÒÕÓÓËÉÊ hello
+
+ÒÕÓÓËÉÊ a ÒÕÓÓËÉÊ b ÒÕÓÓËÉÊ c ÒÕÓÓËÉÊ d ÒÕÓÓËÉÊ e ÒÕÓÓËÉÊ
+ËÁÖÄÙÊ ÏÈÏÔÎÉË ÖÅÌÁÅÔ ÚÎÁÔØ, ÇÄÅ ÓÉÄÉÔ ÆÁÚÁÎ ÓßÅÛØ ÅÝ£ ÜÔÉÈ ÍÑÇËÉÈ ÆÒÁÎÃÕÚÓËÉÊ ÂÕÌÏÞÅË, ÄÁ ×ÙÐÅÊ ÞÁÀ
+
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;27&nbsp;04:18:53&nbsp;2006</span>
    <span class="description">os [...] cru.fr -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> os [...] cru.fr</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">We are using MIME-tools and MIME::Words in Sympa software
&#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.sympa.org">http://www.sympa.org</a></span>&#41;. We were also reported these problem with spaces
stripped because Sympa needs to decode and then re-encode Subject mail
header fields. This process leads to spaces removed. Here is a short
script that demonstrates the problem :

#!/usr/bin/perl

use MIME::Words qw&#40;:all&#41;;
$s1 = &#39;hé hé&#39;;
$s2 = encode_mimewords&#40;$s1, &#40;&#39;Encode&#39; =&gt; &#39;Q&#39;, &#39;Charset&#39; =&gt; &#39;iso-8859-1&#39;&#41;&#41;;
$s3 = decode_mimewords&#40;$s2&#41;;
printf &#34;S1: %s\nS2: %s\nS3: %s\n&#34;, $s1, $s2, $s3;

## here is the output :
S1: hé hé
/S2: =?ISO-8859-1?Q?h=E9?= =?ISO-8859-1?Q?h=E9?=
S3: héhé


We look forward to get a patch for this problem.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;27&nbsp;04:18:54&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;23&nbsp;11:16:27&nbsp;2006</span>
    <span class="description">octopus [...] nospam.verplant.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

we stumbled over this bug today, too. I&#39;ve prepared a patch for this
problem myself, because I impulsive enough to not look into rt.cpan.org
prior to solving this problem on my own. The attached patch also fixes
the problem of quoted-printable-encoded strings still containing spaces,
which is invalid according to RFC1521 and RFC2047.

Since this problem appears to be quite old and the fix is simple, I&#39;d
apprechiate it if you could pick a solution and apply it. Thank you :&#41;

Regards,
-octo
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -pur a/lib/MIME/Words.pm b/lib/MIME/Words.pm
--- a/lib/MIME/Words.pm	2006-03-17 22:03:23.000000000 +0100
+++ b/lib/MIME/Words.pm	2006-11-23 16:28:21.000000000 +0100
@@ -117,7 +117,8 @@ sub _decode_Q {
 #     almost, but not exactly, quoted-printable.  :-P
 sub _encode_Q {
     my $str = shift;
-    $str =~ s{&#40;[_\?\=$NONPRINT]&#41;}{sprintf&#40;&#34;=%02X&#34;, ord&#40;$1&#41;&#41;}eog;
+    $str =~ s{&#40;[_\?\=\s$NONPRINT]&#41;}{sprintf&#40;&#34;=%02X&#34;, ord&#40;$1&#41;&#41;}eog;
+    $str =~ s/=20/_/g;
     $str;
 }
 
@@ -306,17 +307,41 @@ sub encode_mimewords {
     my $charset  = $params{Charset} || &#39;ISO-8859-1&#39;;
     my $encoding = lc&#40;$params{Encoding} || &#39;q&#39;&#41;;
 
-    ### Encode any &#34;words&#34; with unsafe characters.
-    ###    We limit such words to 18 characters, to guarantee that the 
-    ###    worst-case encoding give us no more than 54 + ~10 &lt; 75 characters
-    my $word;
-    $rawstr =~ s{&#40;[a-zA-Z0-9\x7F-\xFF]{1,18}&#41;}{     ### get next &#34;word&#34;
-	$word = $1;
-	&#40;&#40;$word !~ /[$NONPRINT]/o&#41; 
-	 ? $word                                          ### no unsafe chars
-	 : encode_mimeword&#40;$word, $encoding, $charset&#41;&#41;;  ### has unsafe chars
-    }xeg;
-    $rawstr;
+    my $return = &#39;&#39;;
+
+    while &#40;$rawstr =~ m!
+	    ^&#40;[^$NONPRINT]*\s+&#41;?        # Words that don&#39;t need quoting
+	    &#40;
+	      \S*[$NONPRINT]\S*         # Word that needs quoting
+	      &#40;?:\s+\S*[$NONPRINT]\S*&#41;* # More words that need quoting
+	    &#41;
+	    &#40;.*&#41;$                       # Rest of the string, to get around using $&#39;.
+	    !x&#41; # look, no /g modifier!
+    {
+	    my $match = $2;
+
+	    $return .= $1;
+	    $rawstr = $3;
+
+	    while &#40;$match&#41;
+	    {
+		    my $i = length &#40;$match&#41;;
+		    $i = 68 if &#40;$i &gt; 68&#41;;
+
+		    # While there is no limit to the length of a multiple-line
+		    # header field, each line of a header field that contains
+		    # one or more &#39;encoded-word&#39;s is limited to 76 characters.
+		    #   -- RFC2047
+		    while &#40;length &#40;encode_mimeword &#40;substr &#40;$match, 0, $i&#41;&#41;&#41; &gt; 74&#41;
+		    {
+			    $i--;
+		    }
+		    $return .= encode_mimeword &#40;substr &#40;$match, 0, $i&#41;&#41;;
+		    $match = substr &#40;$match, $i&#41;;
+		    if &#40;$match&#41; { $return .= &#39; &#39;; }
+	    }
+    }
+    return &#40;$return&#41;;
 }
 
 1;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;10&nbsp;18:46:36&nbsp;2007</span>
    <span class="description">me+bitcard [...] bogen.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> martini [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I also got this problem! :-&#40;&#40;&#40;

Anyway, there is a other 2 line fix for that:

<span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.otrs.org/show_bug.cgi?id=1428#c4">http://bugs.otrs.org/show_bug.cgi?id=1428#c4</a></span>


Please fix it in further releases!!!

Thx,

 -Martin
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;10&nbsp;19:04:35&nbsp;2007</span>
    <span class="description">me+bitcard [...] bogen.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> martini [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Just the patch for the Words.pm:
-----------------------------------------------------
-----------------------------------------------------
--- Words.pm    Fri Aug 10 12:29:35 2007
+++ Words.pm    Fri Aug 10 13:45:57 2007
@@ -117,7 +117,7 @@
 #     almost, but not exactly, quoted-printable.  :-P
 sub _encode_Q {
     my $str = shift;
-    $str =~ s{&#40;[_\?\=$NONPRINT]&#41;}{sprintf&#40;&#34;=%02X&#34;, ord&#40;$1&#41;&#41;}eog;
+    $str =~ s{&#40;[ _\?\=$NONPRINT]&#41;}{sprintf&#40;&#34;=%02X&#34;, ord&#40;$1&#41;&#41;}eog;
     $str;
 }

@@ -310,7 +310,7 @@
     ###    We limit such words to 18 characters, to guarantee that the
     ###    worst-case encoding give us no more than 54 + ~10 &lt; 75
characters
     my $word;
-    $rawstr =~ s{&#40;[a-zA-Z0-9\x7F-\xFF]{1,18}&#41;}{     ### get next &#34;word&#34;
+    $rawstr =~ s{&#40;[a-zA-Z0-9\x7F-\xFF]+\s*&#41;}{     ### get next &#34;word&#34;
        $word = $1;
        &#40;&#40;$word !~ /[$NONPRINT]/o&#41;
         ? $word                                          ### no unsafe
chars

On Mon Dec 10 18:46:36 2007, martini2 wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; I also got this problem! :-&#40;&#40;&#40;
&gt; 
&gt; Anyway, there is a other 2 line fix for that:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.otrs.org/show_bug.cgi?id=1428#c4">http://bugs.otrs.org/show_bug.cgi?id=1428#c4</a></span>
&gt; 
&gt; 
&gt; Please fix it in further releases!!!
&gt; 
&gt; Thx,
&gt; 
&gt;  -Martin
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;11&nbsp;10:17:02&nbsp;2007</span>
    <span class="description">dmo [...] dmo.ca -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #5462] MIME::Words::encode_mimewords strips spaces</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 11 Dec 2007 10:16:21 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Martin Edenhofer via RT &lt;bug-MIME-tools [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Dave O&#39;Neill&#34; &lt;dmo [...] dmo.ca&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, Dec 10, 2007 at 06:46:38PM -0500, Martin Edenhofer via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Please fix it in further releases!!!
&gt; 
</div>
Thanks for the patch.  It will appear in the next release.

Dave
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;07&nbsp;11:09:34&nbsp;2008</span>
    <span class="description">dmo+pause [...] dmo.ca -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;18&nbsp;16:45:15&nbsp;2008</span>
    <span class="description">dmo+pause [...] dmo.ca -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Patch is in 5.426
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;18&nbsp;16:45:17&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;18&nbsp;16:45:18&nbsp;2008</span>
    <span class="description">dmo+pause [...] dmo.ca -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;02&nbsp;09:00:10&nbsp;2008</span>
    <span class="description">me+bitcard [...] bogen.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> me+bitcard [...] bogen.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Mar 18 16:45:15 2008, DONEILL wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Patch is in 5.426
</div>
JFI, Patch is not in v5.427. :&#40;

By applying this patch to v5.427 it&#39;s working fine again.

Just create an utf8 mail by using MIME::Tools with subject 

&#34;это специальныйсабжект для теста системы тикетов&#34;

 -=&gt; The generated subject is broken an not readably.

See also <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.otrs.org/show_bug.cgi?id=3121">http://bugs.otrs.org/show_bug.cgi?id=3121</a></span> for more information.

Feel free for further questions.

 -Martin
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;02&nbsp;09:00:15&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;15&nbsp;13:39:43&nbsp;2008</span>
    <span class="description">dmo+pause [...] dmo.ca -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Can you provide a short testcase that triggers the problem you&#39;re seeing?

Cheers,
Dave
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;28&nbsp;13:29:16&nbsp;2010</span>
    <span class="description">dmo+pause [...] dmo.ca -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Appears to have been fixed long ago.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;28&nbsp;13:29:19&nbsp;2010</span>
    <span class="description">dmo+pause [...] dmo.ca -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;29&nbsp;10:10:47&nbsp;2013</span>
    <span class="description">mg.pub [...] gmx.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mg.pub [...] gmx.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Mi 28. Apr 2010, 13:29:16, DONEILL schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Appears to have been fixed long ago.
</div>
This bug is still open. Here is a small snippet to reproduce the problem:

use MIME::Words;
use MIME::WordDecoder;
use Encode;

my $String = &#34;Служба поддержки&#34;;
my $Encoded = MIME::Words::encode_mimewords&#40;Encode::encode&#40;&#39;utf-8&#39;, $String,&#41;, Charset 
=&gt; &#39;utf-8&#39;&#41;;
my $Decoded = MIME::WordDecoder::mime_to_perl_string&#40;$Encoded&#41;;
print &#34;$String, $Encoded, $Decoded, &#34; . &#40;$String eq $Decoded ? &#39;equal&#39; : &#39;not equal&#39;&#41; . &#34;\n&#34;; 

With the current version 5.503 this will print:
Служба поддержки, =?UTF-8?Q?
=D0=A1=D0=BB=D1=83=D0=B6=D0=B1=D0=B0=20=D0=BF=D0=BE=D0?= =?UTF-8?Q?
=B4=D0=B4=D0=B5=D1=80=D0=B6=D0=BA=D0=B8?=, Служба по\xD0\xB4держки, not 
equal

We worked around this problem as follows:

sub encode_mimewords {
    my &#40;$rawstr, %params&#41; = @_;
    my $charset  = $params{Charset} || &#39;ISO-8859-1&#39;;
    my $encoding = lc&#40;$params{Encoding} || &#39;q&#39;&#41;;

    ### Encode any &#34;words&#34; with unsafe characters.
    ###    We limit such words to 18 characters, to guarantee that the
    ###    worst-case encoding give us no more than 54 + ~10 &lt; 75 characters
    my $word;
    local $1;

# ---
# OTRS
# ---
# 2008-08-02 added patch/workaround for bug in MIME::Words &#40;v5.428, maybe
# also higner&#41;
# see also: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Public/Bug/Display.html?id=5462">http://rt.cpan.org/Public/Bug/Display.html?id=5462</a></span>
#           <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.otrs.org/show_bug.cgi?id=3121">http://bugs.otrs.org/show_bug.cgi?id=3121</a></span>
#    $rawstr =~ s{&#40;[a-zA-Z0-9\x7F-\xFF]+\s*&#41;}{     ### get next &#34;word&#34;
# ---
    $rawstr =~ s{&#40;[ a-zA-Z0-9\x7F-\xFF]{1,18}&#41;}{     ### get next &#34;word&#34;

    $word = $1;
    &#40;&#40;$word !~ /&#40;?:[$NONPRINT]&#41;|&#40;?:^\s+$&#41;/o&#41;
     ? $word                                          ### no unsafe chars
     : encode_mimeword&#40;$word, $encoding, $charset&#41;&#41;;  ### has unsafe chars
    }xeg;
    $rawstr =~ s/\?==\?/?= =?/g;
    $rawstr;
}
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;29&nbsp;10:10:49&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;29&nbsp;10:12:44&nbsp;2013</span>
    <span class="description">mg.pub [...] gmx.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mg.pub [...] gmx.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&#40;Activate the line in the commented part instead of the original line, and it works fine.&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;30&nbsp;15:23:48&nbsp;2013</span>
    <span class="description">dfs [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #5462] MIME::Words::encode_mimewords strips spaces</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 30 Jan 2013 15:23:36 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MIME-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David F. Skoll&#34; &lt;dfs [...] roaringpenguin.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, 29 Jan 2013 10:12:44 -0500
&#34; via RT&#34; &lt;bug-MIME-tools@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#40;Activate the line in the commented part instead of the original
&gt; line, and it works fine.&#41;
</div>
Thanks.  I have applied your patch and it will be in the next release
of MIME::tools.

Regards,

David.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;30&nbsp;16:07:09&nbsp;2013</span>
    <span class="description">dfs+pause [...] roaringpenguin.com -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;30&nbsp;16:07:26&nbsp;2013</span>
    <span class="description">dfs+pause [...] roaringpenguin.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I&#39;ve uploaded MIME-tools 5.504 to CPAN.  It should appear soon in
the module index, and it fixes this bug.

Regards,

David.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;30&nbsp;16:07:28&nbsp;2013</span>
    <span class="description">dfs+pause [...] roaringpenguin.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
