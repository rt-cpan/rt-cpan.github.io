<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #30733 for Mail-IMAPClient: Mail-IMAPClient-2.2.9 and broken connections</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #30733 for Mail-IMAPClient: Mail-IMAPClient-2.2.9 and broken connections</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Mail-IMAPClient/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Mail-IMAPClient/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Mail-IMAPClient/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Mail-IMAPClient/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-IMAPClient">Mail-IMAPClient CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">30733</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Mail-IMAPClient/Active/">Mail-IMAPClient</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bernd [...] firmix.at

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-19960-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-19961-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;14&nbsp;12:10:49&nbsp;2007</span>
    <span class="description">bernd [...] firmix.at -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Mail-IMAPClient-2.2.9 and broken connections</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 14 Nov 2007 17:23:10 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-IMAPClient [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Bernd Petrovitsch &lt;bernd [...] firmix.at&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi!

We are using Mail-IMAPClient-2.2.9 on a Debian/Sarge on x86_64
hardware. We use it against Cyrus-Imapd-2.2.13 where user
mailboxes are stored.
Every user has a &#34;spam&#34; folder there and a janitor
job removes every night old enough spam mails and sends
the user a overview of the remaining.

What happens as seen from the outside?

Once in a while the janitor job busy loops on broken
IMAP connections and stracing the process gives
----  snip  ----
write&#40;12, &#34;5378 SELECT user/91070z2/Spam\r\n&#34;, 31&#41; = -1 EPIPE &#40;Broken pipe&#41;
--- SIGPIPE &#40;Broken pipe&#41; @ 0 &#40;0&#41; ---
write&#40;12, &#34;5378 SELECT user/91070z2/Spam\r\n&#34;, 31&#41; = -1 EPIPE &#40;Broken pipe&#41;
--- SIGPIPE &#40;Broken pipe&#41; @ 0 &#40;0&#41; ---
write&#40;12, &#34;5378 SELECT user/91070z2/Spam\r\n&#34;, 31&#41; = -1 EPIPE &#40;Broken pipe&#41;
--- SIGPIPE &#40;Broken pipe&#41; @ 0 &#40;0&#41; ---
write&#40;12, &#34;5378 SELECT user/91070z2/Spam\r\n&#34;, 31&#41; = -1 EPIPE &#40;Broken pipe&#41;
--- SIGPIPE &#40;Broken pipe&#41; @ 0 &#40;0&#41; ---
----  snip  ----
&#40;and fast of course!&#41;.

We have &#40;for various reasons and routinely&#41; SIGPIPE ignored &#40;as the
strace above also  tells&#41;.
And AFAICS we check for errors on every possibility in our application
code. Following into the Mail-IMAPClient module, I come to the &#34;sub
_send_line&#34; at line 1372 and find some strange &#40;IMHO of course&#41; code on
line 1458:
----  snip  ----
1458    until &#40;$total &gt;= length&#40;$string&#41;&#41; {
1459            my $ret = 0;
1460            $!=0;
1461            $ret =  syswrite&#40;       
1462                                    $self-&gt;Socket, 
1463                                    $string, 
1464                                    length&#40;$string&#41;-$total, 
1465                                    $total
1466                                    &#41;;
1467            $ret||=0;
1468            if &#40;$! == &#38;EAGAIN &#41; {
1469                    if &#40;    $self-&gt;{Maxtemperrors} !~ /^unlimited/i
1470                            and $temperrs++ &gt; &#40;$self-&gt;{Maxtemperrors}||10&#41; 
1471                    &#41; {
1472                            $self-&gt;LastError&#40;&#34;Persistent &#39;${!}&#39; errors\n&#34;&#41;;
1473                            $self-&gt;_debug&#40;&#34;Persistent &#39;${!}&#39; errors\n&#34;&#41;
1474                            return undef;
1475                    }
1476                    $optimize = 1;
1477            } else {
1478                    # avoid infinite loops on syswrite error
1479                    return undef unless&#40;defined $ret&#41;;       
1480            }
----  snip  ----
What happens more in detail here?
- syswrite&#40;&#41; is called and returns &#34;undef&#34; &#40;stored in $ret&#41; and sets $!.
- line 1467: &#39;$ret = 0&#39;
- $! is &#38;EPIPE so we take the &#34;else&#34; branch.
- But here we are not returning because $ret is defined - it has
   0 in there.

What is IMHO strange?
- The &#34;unless&#40;defined $ret&#41;&#34; seems wrong to me since $ret will always
   be defined there - either by the return value of syswrite&#40;&#41; - but
   then we shouldn&#39;t get there anyways - and otherwise through line
   1467.

Are we the first ones which ignore SIGPIPE to stumble over that?
Did I overlook something?

Alas, testing and tracing is not really or easily possible since the
system and application in question has around 23.000 mailboxes ATM and
is the central mail server of a medium sized Austrian ISP &#40;medium sized
for Austrian circumstances&#41;.

The short term work-around is to enable SIGPIPE at that end so that the
process vanishes &#40;and can be consequently restarted&#41;.

        Bernd
-- 
Firmix Software GmbH                   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.firmix.at/">http://www.firmix.at/</a></span>
mobil: +43 664 4416156                 fax: +43 1 7890849-55
          Embedded Linux Development and Services
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;14&nbsp;16:49:59&nbsp;2007</span>
    <span class="description">solutions [...] overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #30733] Mail-IMAPClient-2.2.9 and broken connections</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 14 Nov 2007 22:48:53 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Bernd Petrovitsch via RT &lt;bug-Mail-IMAPClient [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;solutions [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Bernd Petrovitsch via RT &#40;bug-Mail-IMAPClient@rt.cpan.org&#41; [071114 17:10]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Wed Nov 14 12:10:49 2007: Request 30733 was acted upon.
&gt; Transaction: Ticket created by bernd@firmix.at
&gt;        Queue: Mail-IMAPClient
&gt;      Subject: Mail-IMAPClient-2.2.9 and broken connections
</div>
After four years without maintenance, I took over and hope to
get a new release out.  See search.cpan.org for 2.99_06.  There
are zillions of bugfixes &#40;and newly created bug&#41;  There will be
no bugfix release based on the 2.2.9 code.

So: be warned for the new release: it&#39;s a big change!  Requires
more extensive testing than usual.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Once in a while the janitor job busy loops on broken
&gt; IMAP connections and stracing the process gives
&gt; ----  snip  ----
&gt; write&#40;12, &#34;5378 SELECT user/91070z2/Spam\r\n&#34;, 31&#41; = -1 EPIPE &#40;Broken pipe&#41;
&gt; --- SIGPIPE &#40;Broken pipe&#41; @ 0 &#40;0&#41; ---
&gt; 
&gt; We have &#40;for various reasons and routinely&#41; SIGPIPE ignored &#40;as the
&gt; strace above also  tells&#41;.
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; What happens more in detail here?
&gt; - syswrite&#40;&#41; is called and returns &#34;undef&#34; &#40;stored in $ret&#41; and sets $!.
</div>
The loop is left, writing stops.  No nice recovery.  In this case, we
could attempt a reconnect, calling connect&#40;&#41;-&gt;login&#40;&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; - But here we are not returning because $ret is defined - it has
&gt;    0 in there.
</div>
True, that was a bug.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Are we the first ones which ignore SIGPIPE to stumble over that?
&gt; Did I overlook something?
</div>
Probably that people found many more important bugs ;-&#40;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Alas, testing and tracing is not really or easily possible since the
&gt; system and application in question has around 23.000 mailboxes ATM and
&gt; is the central mail server of a medium sized Austrian ISP &#40;medium sized
&gt; for Austrian circumstances&#41;.
</div>
Then... create a smaller test-set.  That&#39;s what other people do.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The short term work-around is to enable SIGPIPE at that end so that the
&gt; process vanishes &#40;and can be consequently restarted&#41;.
</div>
yes:   die $! if $!==EPIPE;
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;14&nbsp;16:50:00&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;16&nbsp;06:51:48&nbsp;2007</span>
    <span class="description">bernd [...] firmix.at -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> DJKERNEN__NO_SOLICITING__ [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #30733] Mail-IMAPClient-2.2.9 and broken connections</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 16 Nov 2007 12:50:07 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-IMAPClient [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Bernd Petrovitsch &lt;bernd [...] firmix.at&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mit, 2007-11-14 at 16:50 -0500, Mark Overmeer via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=30733">http://rt.cpan.org/Ticket/Display.html?id=30733</a></span> &gt;
&gt; 
&gt; * Bernd Petrovitsch via RT &#40;bug-Mail-IMAPClient@rt.cpan.org&#41; [071114 17:10]:
<div class="message-stanza open">&gt; &gt; Wed Nov 14 12:10:49 2007: Request 30733 was acted upon.
&gt; &gt; Transaction: Ticket created by bernd@firmix.at
&gt; &gt;        Queue: Mail-IMAPClient
&gt; &gt;      Subject: Mail-IMAPClient-2.2.9 and broken connections
</div>&gt; 
&gt; After four years without maintenance, I took over and hope to
</div>
Ah, I didn&#39;t know that.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; get a new release out.  See search.cpan.org for 2.99_06.  There
&gt; are zillions of bugfixes &#40;and newly created bug&#41;  There will be
&gt; no bugfix release based on the 2.2.9 code.
</div>
There is 2.99_07 now there.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So: be warned for the new release: it&#39;s a big change!  Requires
&gt; more extensive testing than usual.
</div>

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Once in a while the janitor job busy loops on broken
&gt; &gt; IMAP connections and stracing the process gives
&gt; &gt; ----  snip  ----
&gt; &gt; write&#40;12, &#34;5378 SELECT user/91070z2/Spam\r\n&#34;, 31&#41; = -1 EPIPE &#40;Broken pipe&#41;
&gt; &gt; --- SIGPIPE &#40;Broken pipe&#41; @ 0 &#40;0&#41; ---
&gt; &gt; 
&gt; &gt; We have &#40;for various reasons and routinely&#41; SIGPIPE ignored &#40;as the
&gt; &gt; strace above also  tells&#41;.
</div>&gt; 
<div class="message-stanza open">&gt; &gt; What happens more in detail here?
&gt; &gt; - syswrite&#40;&#41; is called and returns &#34;undef&#34; &#40;stored in $ret&#41; and sets $!.
</div>&gt; 
&gt; The loop is left, writing stops.  No nice recovery.  In this case, we
&gt; could attempt a reconnect, calling connect&#40;&#41;-&gt;login&#40;&#41;
</div>
Yes, if it&#39;s cleanly possible to recover from that error.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; - But here we are not returning because $ret is defined - it has
&gt; &gt;    0 in there.
</div>&gt; 
&gt; True, that was a bug.
&gt; 
<div class="message-stanza open">&gt; &gt; Are we the first ones which ignore SIGPIPE to stumble over that?
&gt; &gt; Did I overlook something?
</div>&gt; 
&gt; Probably that people found many more important bugs ;-&#40;
&gt;
<div class="message-stanza open">&gt; &gt; Alas, testing and tracing is not really or easily possible since the
&gt; &gt; system and application in question has around 23.000 mailboxes ATM and
&gt; &gt; is the central mail server of a medium sized Austrian ISP &#40;medium sized
&gt; &gt; for Austrian circumstances&#41;.
</div>&gt; 
&gt; Then... create a smaller test-set.  That&#39;s what other people do.
</div>
We have actually have there a shadow cluster &#40;in Vmware instances&#41; for
testing functional changes. But it doesn&#39;t have the load &#40;by far!&#41; of
the real cluster. It never happened there AFAIK.
I can easily create a test situation of the above described bug. But I
don&#39;t know if that is really the bug from real life.

        Bernd
-- 
Firmix Software GmbH                   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.firmix.at/">http://www.firmix.at/</a></span>
mobil: +43 664 4416156                 fax: +43 1 7890849-55
          Embedded Linux Development and Services
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;16&nbsp;07:56:42&nbsp;2007</span>
    <span class="description">solutions [...] overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #30733] Mail-IMAPClient-2.2.9 and broken connections</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 16 Nov 2007 13:55:42 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Bernd Petrovitsch via RT &lt;bug-Mail-IMAPClient [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;solutions [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Bernd Petrovitsch via RT &#40;bug-Mail-IMAPClient@rt.cpan.org&#41; [071116 11:51]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; The loop is left, writing stops.  No nice recovery.  In this case, we
<div class="message-stanza open">&gt; &gt; &gt; Alas, testing and tracing is not really or easily possible since the
&gt; &gt; &gt; system and application in question has around 23.000 mailboxes ATM and
&gt; &gt; &gt; is the central mail server of a medium sized Austrian ISP &#40;medium sized
&gt; &gt; &gt; for Austrian circumstances&#41;.
</div>&gt; &gt; 
&gt; &gt; Then... create a smaller test-set.  That&#39;s what other people do.
</div>&gt; 
&gt; We have actually have there a shadow cluster &#40;in Vmware instances&#41; for
&gt; testing functional changes. But it doesn&#39;t have the load &#40;by far!&#41; of
&gt; the real cluster. It never happened there AFAIK.
&gt; I can easily create a test situation of the above described bug. But I
&gt; don&#39;t know if that is really the bug from real life.
</div>
You can just kill server-side clients at random interfalls.  That
should trigger your EPIPEs. Any chance you will do that, or should
I close this ticket?
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;16&nbsp;09:59:55&nbsp;2007</span>
    <span class="description">bernd [...] firmix.at -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> DJKERNEN__NO_SOLICITING__ [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #30733] Mail-IMAPClient-2.2.9 and broken connections</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 16 Nov 2007 15:35:14 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-IMAPClient [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Bernd Petrovitsch &lt;bernd [...] firmix.at&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fre, 2007-11-16 at 07:56 -0500, Mark Overmeer via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=30733">http://rt.cpan.org/Ticket/Display.html?id=30733</a></span> &gt;
&gt; 
&gt; * Bernd Petrovitsch via RT &#40;bug-Mail-IMAPClient@rt.cpan.org&#41; [071116 11:51]:
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; The loop is left, writing stops.  No nice recovery.  In this case, we
<div class="message-stanza open">&gt; &gt; &gt; &gt; Alas, testing and tracing is not really or easily possible since the
&gt; &gt; &gt; &gt; system and application in question has around 23.000 mailboxes ATM and
&gt; &gt; &gt; &gt; is the central mail server of a medium sized Austrian ISP &#40;medium sized
&gt; &gt; &gt; &gt; for Austrian circumstances&#41;.
</div>&gt; &gt; &gt; 
&gt; &gt; &gt; Then... create a smaller test-set.  That&#39;s what other people do.
</div>&gt; &gt; 
&gt; &gt; We have actually have there a shadow cluster &#40;in Vmware instances&#41; for
&gt; &gt; testing functional changes. But it doesn&#39;t have the load &#40;by far!&#41; of
&gt; &gt; the real cluster. It never happened there AFAIK.
&gt; &gt; I can easily create a test situation of the above described bug. But I
&gt; &gt; don&#39;t know if that is really the bug from real life.
</div>&gt; 
&gt; You can just kill server-side clients at random interfalls.  That
&gt; should trigger your EPIPEs. Any chance you will do that, or should
&gt; I close this ticket?
</div>
Close it as it looks like it&#39;s fixed in 2.99_07.
If I actually do it, I can write you an email anways;-&#41;

        Bernd
-- 
Firmix Software GmbH                   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.firmix.at/">http://www.firmix.at/</a></span>
mobil: +43 664 4416156                 fax: +43 1 7890849-55
          Embedded Linux Development and Services
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;21&nbsp;17:01:06&nbsp;2007</span>
    <span class="description">MARKOV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">closed, fixed in 2.99
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;21&nbsp;17:01:09&nbsp;2007</span>
    <span class="description">MARKOV [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
