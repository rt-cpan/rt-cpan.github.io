<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #112298 for Syntax-Feature-Try: Tests fail with perl 5.23.8</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #112298 for Syntax-Feature-Try: Tests fail with perl 5.23.8</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Syntax-Feature-Try/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Syntax-Feature-Try/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Syntax-Feature-Try/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Syntax-Feature-Try/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Syntax-Feature-Try">Syntax-Feature-Try CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">112298</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Syntax-Feature-Try/Active/">Syntax-Feature-Try</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">tomas.zemres [...] gmail.com
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
SREZIC [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-249042-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.003    </td>
  </tr>
  <tr id="CF-249043-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.005    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;22&nbsp;16:13:37&nbsp;2016</span>
    <span class="description">SREZIC [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Tests fail with perl 5.23.8</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">With perl 5.23.8 I see the following test problems:

#   Failed test &#39;finally is called in right order&#39;
#   at t/finally.t line 111.
#     Structures begin differing at:
#          $got-&gt;[7] = Does not exist
#     $expected-&gt;[7] = &#39;after&#39;
# Looks like you failed 1 test of 9.
t/finally.t ....................... 

#   Failed test &#39;nested try/catch is working&#39;
#   at t/nested.t line 33.
#     Structures begin differing at:
#          $got-&gt;[5] = Does not exist
#     $expected-&gt;[5] = &#39;done&#39;
# Looks like you failed 1 test of 3.
t/nested.t ........................ 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;09:45:19&nbsp;2016</span>
    <span class="description">tomas.zemres [...] gmail.com -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;25&nbsp;09:45:58&nbsp;2016</span>
    <span class="description">tomas.zemres [...] gmail.com -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;26&nbsp;17:14:07&nbsp;2016</span>
    <span class="description">davem [...] iabyn.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> davem [...] iabyn.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Feb 22 16:13:37 2016, SREZIC wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; With perl 5.23.8 I see the following test problems:
</div>[...]

This is because starting with perl-5.23.8, call_sv&#40;G_VOID&#41; does what
it&#39;s documented to do, and returns no args on the stack &#40;formerly
it would leave whatever the last statement put on the stack there&#41;.

This rather messes with the IS_END_OF_BLOCK&#40;&#41; mechanism in run_block&#40;&#41;
for determining whether the block successfully ran to completion.

For example this:

    use syntax &#39;try&#39;;

    sub f {
        print &#34;f called\n&#34;;
        try {     1; }
        finally { 1; }
        print &#34;OK, end of f&#40;&#41; seen\n&#34;;
    };

    f&#40;&#41;;
    $x = f&#40;&#41;;

outputs, in 5.23.8:

    f called
    f called
    OK, end of f&#40;&#41; seen

This is because the try block is called in the same context that f&#40;&#41; is
called in, so when f&#40;&#41; is called in void context, no guard SV is left on
the stack. Incidentally this context selection seems wrong to me: the Try
docs don&#39;t seem to indicate what context the try/catch/finally blocks are
called in, but using the context that the enclosing sub is called in seems
just wrong.

Anyway regardless of what context the blocks should be called in, since its
probably legitimate to call them in void context, the IS_END_OF_BLOCK&#40;&#41;
trick isn&#39;t going to work any more. Perhaps instead Try should append a
couple of ops that do the equivalent of $Syntax::Feature::Try::_GUARD_++,
say, which can be tested for afterwards???
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;26&nbsp;17:16:14&nbsp;2016</span>
    <span class="description">davem [...] iabyn.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> davem [...] iabyn.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">PS - I could&#39;nt build Try with a debugging perl. The little attached patch fixes that.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Syntax-Feature-Try-OP_RETURN-is-a-list-not-un-op.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 79d51d925e6a27764123a8e6693cd52220814613 Mon Sep 17 00:00:00 2001
From: David Mitchell &lt;davem@iabyn.com&gt;
Date: Fri, 26 Feb 2016 17:50:05 +0000
Subject: [PATCH] Syntax-Feature-Try: OP_RETURN is a list, not un op

So call op_convert_list&#40;&#41; rather than newUNOP&#40;&#41;.
On debugging perls, newUNOP&#40;&#41; would trigger an assertion failure.
---
 Syntax-Feature-Try-1.003/src/try-catch-op.c | 3 ++-
 1 file changed, 2 insertions&#40;+&#41;, 1 deletion&#40;-&#41;

diff --git a/Syntax-Feature-Try-1.003/src/try-catch-op.c b/Syntax-Feature-Try-1.003/src/try-catch-op.c
index a3be8fc..156a3be 100644
--- a/Syntax-Feature-Try-1.003/src/try-catch-op.c
+++ b/Syntax-Feature-Try-1.003/src/try-catch-op.c
@@ -54,7 +54,8 @@ static OP *my_build_statement_optree&#40;pTHX_
     args_op = op_append_elem&#40;OP_LIST, args_op, finally_block_op&#41;;
 
     call_op = call_sub_op&#40;&#34;_statement&#34;, args_op&#41;;
-    return_op = newUNOP&#40;OP_RETURN, 0, call_sub_op&#40;&#34;_get_return_value&#34;, NULL&#41;&#41;;
+    return_op = op_convert_list&#40;OP_RETURN, 0,
+                    call_sub_op&#40;&#34;_get_return_value&#34;, NULL&#41;&#41;;
 
     return newCONDOP&#40;0, call_op, return_op, NULL&#41;;
 }
-- 
2.4.3

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;27&nbsp;06:27:01&nbsp;2016</span>
    <span class="description">SREZIC [...] cpan.org -  Reference by perl ticket #127616 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;29&nbsp;05:41:20&nbsp;2016</span>
    <span class="description">tomas.zemres [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you for advice, I fix it when I will have free time for it.

Tomas

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This is because starting with perl-5.23.8, call_sv&#40;G_VOID&#41; does what
&gt; it&#39;s documented to do, and returns no args on the stack &#40;formerly
&gt; it would leave whatever the last statement put on the stack there&#41;.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;04&nbsp;13:55:54&nbsp;2016</span>
    <span class="description">SREZIC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> davem [...] iabyn.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2016-02-29 05:41:20, tnt wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thank you for advice, I fix it when I will have free time for it.
&gt; 
&gt; Tomas
&gt; 
<div class="message-stanza open">&gt; &gt; This is because starting with perl-5.23.8, call_sv&#40;G_VOID&#41; does what
&gt; &gt; it&#39;s documented to do, and returns no args on the stack &#40;formerly
&gt; &gt; it would leave whatever the last statement put on the stack there&#41;.
</div></div>

Probably the patch needs an #ifdef ... 1.004 is broken for perl &lt; 5.22.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;08&nbsp;01:49:43&nbsp;2016</span>
    <span class="description">tomas.zemres [...] gmail.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;08&nbsp;01:49:44&nbsp;2016</span>
    <span class="description">tomas.zemres [...] gmail.com -  Fixed in 1.005 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
