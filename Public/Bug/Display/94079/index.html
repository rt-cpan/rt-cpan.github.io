<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #94079 for Gearman-XS: Gearman::XS::Client leaks previous callbacks if they are re-set</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #94079 for Gearman-XS: Gearman::XS::Client leaks previous callbacks if they are re-set</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Gearman-XS/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Gearman-XS/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Gearman-XS/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Gearman-XS/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Gearman-XS">Gearman-XS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">94079</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Gearman-XS/Active/">Gearman-XS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
nick [...] ccl4.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-227554-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-227555-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;21&nbsp;07:38:57&nbsp;2014</span>
    <span class="description">nick [...] ccl4.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Gearman::XS::Client leaks previous callbacks if they are re-set</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The Gearman::XS::Client object doesn&#39;t handle references to client callbacks
correctly. All is well if code only assigns each callback once. However, if
code takes a client and assigns any callback a second time, the previous
closure is leaked. The last callback assigned is correctly freed on object
destruction, which means that there is no leak if callbacks are assigned at
most once.

I suspect that this has gone unnoticed because most users don&#39;t re-assign
callbacks. I guess they either create a client, set it up with callbacks, and
use it repeatedly, or they create a client, set up custom callbacks, use it
once, then release the client. In both scenarios all memory is correctly freed.

The code is here is somewhat quirky, in that it creates a client once that is
re-used, but for each use sets up a new callback. Hence the callbacks leak.
What makes it really noticeable is that the assigned callback closes over a
large &#40;temporary&#41; data structure. Well, it&#39;s meant to be temporary... :-&#40;


Attached patch fixes this bug. I&#39;m happy to assign copyright on the new test
to Data Differential, hence the copyright notice I put in it.

Thanks for the module. It&#39;s useful.

Nicholas Clark
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> callbackleak.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">commit a5c9e59440b3dfa0d5faeedf20fa1b8512a3f7ec
Author: Nicholas Clark &lt;nick@ccl4.org&gt;
Date:   Fri Mar 21 11:36:43 2014 +0100

    When setting a callback the second time, don&#39;t leak any previous callback.

diff --git a/Client.xs b/Client.xs
index 1bb893f..8475900 100644
--- a/Client.xs
+++ b/Client.xs
@@ -566,6 +566,8 @@ set_created_fn&#40;self, fn&#41;
     gearman_xs_client *self
     SV * fn
   CODE:
+    /* Release any previous callback. Safe because sv_free&#40;&#41; handles NULL&#41;. */
+    sv_free&#40;self-&gt;created_fn&#41;;
     self-&gt;created_fn= newSVsv&#40;fn&#41;;
     gearman_client_set_created_fn&#40;self-&gt;client, _perl_task_created_fn&#41;;
 
@@ -574,6 +576,7 @@ set_data_fn&#40;self, fn&#41;
     gearman_xs_client *self
     SV * fn
   CODE:
+    sv_free&#40;self-&gt;data_fn&#41;;
     self-&gt;data_fn= newSVsv&#40;fn&#41;;
     gearman_client_set_data_fn&#40;self-&gt;client, _perl_task_data_fn&#41;;
 
@@ -582,6 +585,7 @@ set_complete_fn&#40;self, fn&#41;
     gearman_xs_client *self
     SV * fn
   CODE:
+    sv_free&#40;self-&gt;complete_fn&#41;;
     self-&gt;complete_fn= newSVsv&#40;fn&#41;;
     gearman_client_set_complete_fn&#40;self-&gt;client, _perl_task_complete_fn&#41;;
 
@@ -590,6 +594,7 @@ set_fail_fn&#40;self, fn&#41;
     gearman_xs_client *self
     SV * fn
   CODE:
+    sv_free&#40;self-&gt;fail_fn&#41;;
     self-&gt;fail_fn= newSVsv&#40;fn&#41;;
     gearman_client_set_fail_fn&#40;self-&gt;client, _perl_task_fail_fn&#41;;
 
@@ -598,6 +603,7 @@ set_status_fn&#40;self, fn&#41;
     gearman_xs_client *self
     SV * fn
   CODE:
+    sv_free&#40;self-&gt;status_fn&#41;;
     self-&gt;status_fn= newSVsv&#40;fn&#41;;
     gearman_client_set_status_fn&#40;self-&gt;client, _perl_task_status_fn&#41;;
 
@@ -606,6 +612,7 @@ set_warning_fn&#40;self, fn&#41;
     gearman_xs_client *self
     SV * fn
   CODE:
+    sv_free&#40;self-&gt;warning_fn&#41;;
     self-&gt;warning_fn= newSVsv&#40;fn&#41;;
     gearman_client_set_warning_fn&#40;self-&gt;client, _perl_task_warning_fn&#41;;
 
diff --git a/MANIFEST b/MANIFEST
index da39fcf..170b85c 100644
--- a/MANIFEST
+++ b/MANIFEST
@@ -28,6 +28,7 @@ t/04-live.t
 t/05-live-worker.t
 t/06_live-worker-timeout.t
 t/80-memleak.t
+t/81-callbackleak.t
 t/99-perlcritic.t
 t/lib/TestLib.pm
 t/perlcriticrc
diff --git a/t/81-callbackleak.t b/t/81-callbackleak.t
new file mode 100644
index 0000000..84b7d32
--- /dev/null
+++ b/t/81-callbackleak.t
@@ -0,0 +1,93 @@
+# Gearman Perl front end
+# Copyright &#40;C&#41; 2014 Data Differential, <span class="clickylink"><a target="new" rel="nofollow" href="http://datadifferential.com/">http://datadifferential.com/</a></span>
+# All rights reserved.
+#
+# This library is free software; you can redistribute it and/or modify
+# it under the same terms as Perl itself, either Perl version 5.8.9 or,
+# at your option, any later version of Perl 5 you may have available.
+
+use strict;
+use warnings;
+
+use Test::More;
+use Gearman::XS::Client;
+
+our $count = 0;
+{
+    package Counter;
+
+    sub new {
+	++$count;
+	bless [], shift;
+    }
+
+    sub DESTROY {
+	--$count;
+    }
+}
+
+sub gen_callback {
+    my $counter = Counter-&gt;new&#40;&#41;;
+    return sub {
+	$counter;
+    }
+}
+
+# Simple test:
+my $client = Gearman::XS::Client-&gt;new&#40;&#41;;
+isa_ok&#40;$client, &#39;Gearman::XS::Client&#39;&#41;;
+
+is&#40;$count, 0, &#39;At the start we have no objects&#39;&#41;;
+
+$client-&gt;set_created_fn&#40;gen_callback&#40;&#41;&#41;;
+
+is&#40;$count, 1, &#39;One callback&#39;&#41;;
+
+undef $client;
+
+is&#40;$count, 0, &#39;No callbacks&#39;&#41;;
+
+# Repeat test:
+$client = Gearman::XS::Client-&gt;new&#40;&#41;;
+
+$client-&gt;set_created_fn&#40;gen_callback&#40;&#41;&#41;;
+
+is&#40;$count, 1, &#39;One callback&#39;&#41;;
+
+$client-&gt;set_created_fn&#40;gen_callback&#40;&#41;&#41;;
+
+is&#40;$count, 1, &#39;Still one callback&#39;&#41;;
+
+$client-&gt;set_created_fn&#40;gen_callback&#40;&#41;&#41;;
+
+is&#40;$count, 1, &#39;Still one callback&#39;&#41;;
+
+undef $client;
+
+is&#40;$count, 0, &#39;No callbacks&#39;&#41;;
+
+# All the callbacks:
+my @callbacks = qw&#40;created data complete fail status warning&#41;;
+my %setters = map {$_ , &#34;set_${_}_fn&#34;} @callbacks;
+my $all = scalar @callbacks;
+$client = Gearman::XS::Client-&gt;new&#40;&#41;;
+
+foreach my $setter &#40;values %setters&#41; {
+    $client-&gt;$setter&#40;gen_callback&#40;&#41;&#41;;
+}
+
+is&#40;$count, $all, &#34;All $all callbacks&#34;&#41;;
+
+while &#40;my &#40;$callback, $setter&#41; = each %setters&#41; {
+    $client-&gt;$setter&#40;gen_callback&#40;&#41;&#41;;
+    is&#40;$count, $all, &#34;Still $all callbacks after setting $callback again&#34;&#41;;
+
+    $client-&gt;$setter&#40;gen_callback&#40;&#41;&#41;;
+    is&#40;$count, $all, &#34;Still $all callbacks after setting $callback again&#34;&#41;;
+}
+
+undef $client;
+
+is&#40;$count, 0, &#39;No callbacks&#39;&#41;;
+
+done_testing&#40;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
