<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #76893 for ORLite: New feature: PRAGMA foreign_keys = ON</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #76893 for ORLite: New feature: PRAGMA foreign_keys = ON</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/ORLite/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/ORLite/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/ORLite/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/ORLite/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/ORLite">ORLite CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">76893</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/ORLite/Active/">ORLite</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
PSCUST [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-222150-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.96    </td>
  </tr>
  <tr id="CF-222151-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;30&nbsp;06:10:35&nbsp;2012</span>
    <span class="description">PSCUST [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> New feature: PRAGMA foreign_keys = ON</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">SQLite has started supporting enforcing of foreign key constraints since 
3.6.19, but this enforcement is disabled by default in order not to 
break legacy code. To enforce referential integrity of foreign key 
constraints, the pragma foreign_keys has to be enabled at the start of 
each new connection.

The attached patch adds a new foreign_keys option. When this option is 
true, the SQL statement &#34;PRAGMA foreign_keys = ON&#34; is run immediately 
after starting each new connection.

I&#39;ve also added a new test script to test the new option and described 
the option in the POD.

Please be free to include the patch verbatin or modified in a next 
release of ORLite.

Thanks.

Best regards,
Paulo Custodio
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> xx_foreign_keys_on.sql</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> ORLite-1.96-fk_patch.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -c -w -r ORLite-1.96/lib/ORLite.pm ORLite-1.96-fk/lib/ORLite.pm
*** ORLite-1.96/lib/ORLite.pm	Mon Feb 27 01:50:26 2012
--- ORLite-1.96-fk/lib/ORLite.pm	Mon Apr 30 10:53:20 2012
***************
*** 56,61 ****
--- 56,62 ----
          tables     =&gt; 1,
          views      =&gt; 0,
          unicode    =&gt; 0,
+         foreign_keys =&gt; 0,
      &#41;;
      if &#40; defined Params::Util::_STRING&#40;$_[1]&#41; &#41; {
          # Support the short form &#34;use ORLite &#39;db.sqlite&#39;&#34;
***************
*** 161,166 ****
--- 162,170 ----
      my $readonly   = $params{readonly} ? &#34;\n\t\tReadOnly =&gt; 1,&#34; : &#39;&#39;;
      my $unicode    = $params{unicode} ? &#34;\n\t\tsqlite_unicode =&gt; 1,&#34; : &#39;&#39;;
      my $version    = $unicode ? &#39;5.008005&#39; : &#39;5.006&#39;;
+     my $pragma_foreign_keys = 
+                     $params{foreign_keys} ?
+                     &#39;$dbh-&gt;do&#40;&#34;PRAGMA foreign_keys = ON&#34;&#41;;&#39; : &#39;&#39;;
  
      # Generate the support package code
      my $code = &lt;&lt;&#34;END_PERL&#34;;
***************
*** 185,194 ****
  }
  
  sub connect {
! 	DBI-&gt;connect&#40; \$_[0]-&gt;dsn, undef, undef, {
  		PrintError =&gt; 0,
  		RaiseError =&gt; 1,$readonly$unicode
  	} &#41;;
  }
  
  sub connected {
--- 189,200 ----
  }
  
  sub connect {
!     my \$dbh = DBI-&gt;connect&#40; \$_[0]-&gt;dsn, undef, undef, {
          PrintError =&gt; 0,
          RaiseError =&gt; 1,$readonly$unicode
      } &#41;;
+     $pragma_foreign_keys
+     return \$dbh;
  }
  
  sub connected {
***************
*** 894,899 ****
--- 900,906 ----
        tables       =&gt; [ &#39;table1&#39;, &#39;table2&#39; ],
        cleanup      =&gt; &#39;VACUUM&#39;,
        prune        =&gt; 1,
+       foreign_keys =&gt; 1,
    };
  
  =head1 DESCRIPTION
***************
*** 1171,1176 ****
--- 1178,1194 ----
  At the moment, it just enables the C&lt;sqlite_unicode&gt; option while
  connecting to your database. There&#39;ll be more in the future.
  
+ =head2 foreign_keys
+ 
+ SQLite has started supporting enforcing of foreign key constraints since 3.6.19, 
+ but this enforcement is disabled by default in order not to break legacy code.
+ 
+ To enforce referential integrity of foreign key constraints, 
+ the pragma foreign_keys has to be enabled at the start of each new connection.
+ 
+ When this option is true, the SQL statement &#34;PRAGMA foreign_keys = ON&#34; is
+ run immediately after starting each new connection.
+ 
  =head1 ROOT PACKAGE METHODS
  
  All ORLite root packages receive an identical set of methods for
Only in ORLite-1.96-fk/t: xx_foreign_keys_on.sql
Only in ORLite-1.96-fk/t: xx_foreign_keys_on.t
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> xx_foreign_keys_on.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

# Tests relating to foreign keys.

BEGIN {
	$|  = 1;
	$^W = 1;
}

use Test::More tests =&gt; 27;
use File::Spec::Functions &#39;:ALL&#39;;
use t::lib::Test;


#####################################################################
# Set up for testing

# Connect
my $file = test_db&#40;&#41;;
my $dbh  = create_ok&#40;
	file    =&gt; catfile&#40;qw{ t xx_foreign_keys_on.sql }&#41;,
	connect =&gt; [ &#34;dbi:SQLite:$file&#34; ],
&#41;;

# Create the test package

#####################################################################
# PRAGMA foreign_keys = ON;

eval &lt;&lt;&#34;END_PERL&#34;; die $@ if $@;
package Foo::Bar;

use strict;
use ORLite {
	file			=&gt; &#39;$file&#39;,
	foreign_keys	=&gt; 1,
};

1;
END_PERL


#####################################################################
# Run the tests

my @album = Foo::Bar::Album-&gt;select;
is&#40; scalar&#40;@album&#41;, 1, &#39;Got one album object&#39; &#41;;
isa_ok&#40; $album[0], &#39;Foo::Bar::Album&#39; &#41;;
is&#40; $album[0]-&gt;album_id, 1, &#39;Got album.album_id&#39; &#41;;
is&#40; $album[0]-&gt;name, &#39;Album 1&#39;, &#39;Got album.name&#39; &#41;;

my @track = Foo::Bar::Track-&gt;select;
is&#40; scalar&#40;@track&#41;, 1, &#39;Got one track object&#39; &#41;;
isa_ok&#40; $track[0], &#39;Foo::Bar::Track&#39; &#41;;
is&#40; $track[0]-&gt;track_id, 1, &#39;Got track.track_id&#39; &#41;;
is&#40; $track[0]-&gt;name, &#39;Track 1&#39;, &#39;Got track.name&#39; &#41;;
isa_ok&#40; $track[0]-&gt;album, &#39;Foo::Bar::Album&#39; &#41;;
is&#40; $track[0]-&gt;album-&gt;album_id, 1, &#39;Got track.album&#39; &#41;;

# insert must fail
eval {
	Foo::Bar::Track-&gt;create&#40;
		name	=&gt; &#39;Track 2&#39;,
		album	=&gt; 2,
	&#41;;
};
like&#40; $@, qr/foreign key constraint failed/, &#39;insert with fk violation failed&#39; &#41;;

@track = Foo::Bar::Track-&gt;select;
is&#40; scalar&#40;@track&#41;, 1, &#39;Got one track object&#39; &#41;;

#####################################################################
# PRAGMA foreign_keys = OFF;

eval &lt;&lt;&#34;END_PERL&#34;; die $@ if $@;
package Foo::Bar2;

use strict;
use ORLite {
	file			=&gt; &#39;$file&#39;,
};

1;
END_PERL


#####################################################################
# Run the tests

@album = Foo::Bar2::Album-&gt;select;
is&#40; scalar&#40;@album&#41;, 1, &#39;Got one album object&#39; &#41;;
isa_ok&#40; $album[0], &#39;Foo::Bar2::Album&#39; &#41;;
is&#40; $album[0]-&gt;album_id, 1, &#39;Got album.album_id&#39; &#41;;
is&#40; $album[0]-&gt;name, &#39;Album 1&#39;, &#39;Got album.name&#39; &#41;;

@track = Foo::Bar2::Track-&gt;select;
is&#40; scalar&#40;@track&#41;, 1, &#39;Got one track object&#39; &#41;;
isa_ok&#40; $track[0], &#39;Foo::Bar2::Track&#39; &#41;;
is&#40; $track[0]-&gt;track_id, 1, &#39;Got track.track_id&#39; &#41;;
is&#40; $track[0]-&gt;name, &#39;Track 1&#39;, &#39;Got track.name&#39; &#41;;
isa_ok&#40; $track[0]-&gt;album, &#39;Foo::Bar2::Album&#39; &#41;;
is&#40; $track[0]-&gt;album-&gt;album_id, 1, &#39;Got track.album&#39; &#41;;

# insert succeeds
my $track = Foo::Bar2::Track-&gt;create&#40;
	name	=&gt; &#39;Track 2&#39;,
	album	=&gt; 2,
&#41;;
isa_ok&#40; $track, &#39;Foo::Bar2::Track&#39; &#41;;
is&#40; $track-&gt;name, &#39;Track 2&#39;, &#39;Got track.name&#39; &#41;;
is&#40; $track-&gt;album, undef, &#39;no linked album&#39; &#41;;

@track = Foo::Bar2::Track-&gt;select;
is&#40; scalar&#40;@track&#41;, 2, &#39;Got two track objects&#39; &#41;;
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
