<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #99705 for DBI: Enhancement: Provide a post-exec callback for statements / provide automatically locked hashrefs</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #99705 for DBI: Enhancement: Provide a post-exec callback for statements / provide automatically locked hashrefs</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBI/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBI/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBI/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBI/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBI">DBI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">99705</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBI/Active/">DBI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
corion [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-10328-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10329-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;21&nbsp;15:18:38&nbsp;2014</span>
    <span class="description">corion [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Enhancement: Provide a post-exec callback for statements /
 provide automatically locked hashrefs</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Tim &#40;and all&#41;,

this ticket is an enhancement wish for DBI.

The proposal is to have the option of returning locked hashrefs &#40;Hash::Util::lock_ref_keys&#41; from -&gt;fetchall_arrayref&#40;{}&#41; and -&gt;selectall_arrayref&#40;..., {Slice =&gt; {}}&#41; .

The feature already exists as the attached module DBIx::LockedResults, but the module is icky for one reason:

The module employs the Callbacks feature of DBI to work its magic, but the callbacks don&#39;t have a way to run the original code and get at the results of the original code. So the callbacks get disabled, the original code is recursively called, and then the results are munged.

A better way would be to have a callback that runs after a statement method like -&gt;fetchall_arrayref has finished and that can post-process the results of the statement method.

The best way would be to have the LockKeys =&gt; 1 option available to -&gt;fetchall_arrayref and -&gt;selectall_arrayref directly, because then I wouldn&#39;t have to write any code at all.

-max 
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 01-lock.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!perl -w
use strict;
use Test::More;
use DBIx::LockedResults;

my $dbh= eval {
    DBIx::LockedResults-&gt;connect&#40;
        &#39;dbi:SQLite:dbname=:memory:&#39;,
        undef,
        undef,
        { RaiseError =&gt; 1, PrintError =&gt; 0 },
    &#41;;
};
if&#40;! $dbh &#41; {
    plan skip_all =&gt; &#34;SQLite not available? $@&#34;;
    exit;
};
plan tests =&gt; 9;

$dbh-&gt;do&#40;&lt;&lt;SQL&#41;;
    create table myTable &#40; myText varchar&#40;32&#41;, myId integer not null &#41;;
SQL
$dbh-&gt;do&#40;&lt;&lt;SQL&#41;;
    insert into myTable &#40;myText,myid&#41; values &#40;&#39;use Perl;&#39;,1&#41;;
SQL
$dbh-&gt;do&#40;&lt;&lt;SQL&#41;;
    insert into myTable &#40;myText,myid&#41; values &#40;&#39;Foo&#39;,2&#41;;
SQL
$dbh-&gt;do&#40;&lt;&lt;SQL&#41;;
    insert into myTable &#40;myText,myid&#41; values &#40;&#39;Bar&#39;,3&#41;;
SQL

my $res= $dbh-&gt;selectall_arrayref&#40;&lt;&lt;SQL, { Slice =&gt; {}}, &#39;%Perl%&#39;&#41;;
    select myId, myText
    from mytable
    where mytext like ?
SQL

is 0+@$res, 1, &#39;We get the expected number of rows&#39;;
is ref $res-&gt;[0], &#39;HASH&#39;, &#39;We asked for a hash, we get a hash&#39;;
is ref $res-&gt;[0], &#39;HASH&#39;, &#39;We asked for a hash, we get a hash&#39;;

my $val;
my $lives= eval {
    $val= $res-&gt;[0]-&gt;{myText};
    1
};
is $val, &#39;use Perl;&#39;;

undef $val;
ok $lives, &#34;We can access &#39;myText&#39;&#34;
    or diag $@;

   $lives= eval {
    $val= $res-&gt;[0]-&gt;{yourtext};
    diag &#34;Live?!&#34;;
    1
};
is $val, undef;
ok !$lives, &#34;We can&#39;t access &#39;yourtext&#39;&#34;;

undef $val;
   $lives= eval {
    $val= $res-&gt;[0]-&gt;{mytext};
    1
};
is $val, undef;
ok !$lives, &#34;We can&#39;t access &#39;mytext&#39;&#34;;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> LockedResults.pm</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">package DBIx::LockedResults;
use strict;
use DBI;
use Hash::Util &#39;lock_keys&#39;;

sub connect {
    my&#40; $class, $dsn, $user, $pass, $options &#41;= @_;
    $options ||= {};
    $options-&gt;{ Callbacks }= {
        selectall_arrayref =&gt; \&#38;selectall_arrayref,
        ChildCallbacks =&gt; {
            fetchall_arrayref =&gt; \&#38;fetchall_arrayref,
        },
    };
    DBI-&gt;connect&#40; $dsn, $user, $pass, $options &#41;;
}

sub protect_hashrefs {
    warn &#34;Locking in effect&#34;;
    lock_keys&#40; %$_ &#41;
        for @{ $_[0] };
}

sub fetchall_arrayref {
    my&#40;$sth, $options, @placeholders &#41;= @_;
    my $name= $_;
    local $sth-&gt;{Callbacks}-&gt;{$name}; # prevent recursion
    my $res= $sth-&gt;fetchall_arrayref&#40; $options, @placeholders &#41;;
    if&#40; $options and $options-&gt;{Slice} and &#39;HASH&#39; eq ref $options-&gt;{Slice}&#41; {
        protect_hashrefs&#40; $res &#41;;
    };
    $res
}

sub selectall_arrayref {
    my&#40;$dbh, $sql, $options, @placeholders &#41;= @_;
    my $name= $_;
    local $dbh-&gt;{Callbacks}-&gt;{$name}; # prevent recursion
    my $res= $dbh-&gt;selectall_arrayref&#40; $sql, $options, @placeholders &#41;;
    if&#40; $options and $options-&gt;{Slice} and &#39;HASH&#39; eq ref $options-&gt;{Slice}&#41; {
        protect_hashrefs&#40; $res &#41;;
    };
    $res
}


1;</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
