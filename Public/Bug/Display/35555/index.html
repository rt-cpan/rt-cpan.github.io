<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #35555 for CAM-PDF: patch to improve node traversal</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #35555 for CAM-PDF: patch to improve node traversal</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=CAM-PDF">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=CAM-PDF">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=CAM-PDF">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=CAM-PDF">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/CAM-PDF">CAM-PDF CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">35555</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=CAM-PDF">CAM-PDF</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
rt.cpan.org [...] darkart.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-4996-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-4997-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




patch-lib-CAM-PDF.pm<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/456219/224299/patch-lib-CAM-PDF.pm">
Wed Apr 30 17:36:27 2008 (3.7k) by rt.cpan.org [...] darkart.com
</a>
</font></li>
</ul>


traverse.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/456596/224517/traverse.patch">
Thu May 01 21:40:34 2008 (1.6k) by chris [...] chrisdolan.net
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=35555">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-456219" href="/Public/Bug/Display.html?id=35555#txn-456219">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;30&nbsp;17:36:27&nbsp;2008</span>
    <span class="description">rt.cpan.org [...] darkart.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch to improve node traversal</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 30 Apr 2008 21:36:00 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CAM-PDF [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Hall &lt;rt.cpan.org [...] darkart.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/456219/224298/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/224298">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 95b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello-
        Attached is a patch against 1.13 which improved PDF node
traversal for us.


                -eric
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/456219/224299/patch-lib-CAM-PDF.pm">Download patch-lib-CAM-PDF.pm</a><br />
<span class="downloadcontenttype">text/x-perl 3.7k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-456254" href="/Public/Bug/Display.html?id=35555#txn-456254">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;30&nbsp;21:02:59&nbsp;2008</span>
    <span class="description">chris [...] chrisdolan.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #35555] patch to improve node traversal </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 30 Apr 2008 20:00:51 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> RT &lt;bug-CAM-PDF [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Chris Dolan &lt;chris [...] chrisdolan.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/456254/224310/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/224310">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 5.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Eric,

There are several problems with this patch as written.  I&#39;ve included  
criticisms below, which I intend constructively.  Clearly you&#39;ve put  
some work into this, but I cannot accept it as is.

Furthermore, it would help if you explained your patch more  
thoroughly.  In particular, you say that the patch improved  
traversal, but you don&#39;t say whether it improves performance or  
correctness.  Is there a problem with the existing traverse routine?

Chris

On Apr 30, 2008, at 4:36 PM, Eric Hall via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; Wed Apr 30 17:36:27 2008: Request 35555 was acted upon.
&gt; Transaction: Ticket created by rt.cpan.org@darkart.com
&gt;        Queue: CAM-PDF
&gt;      Subject: patch to improve node traversal
&gt;    Broken in: &#40;no value&#41;
&gt;     Severity: &#40;no value&#41;
&gt;        Owner: Nobody
&gt;   Requestors: rt.cpan.org@darkart.com
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=35555">http://rt.cpan.org/Ticket/Display.html?id=35555</a></span> &gt;
&gt;
&gt;
&gt; Hello-
&gt;       Attached is a patch against 1.13 which improved PDF node
&gt; traversal for us.
&gt;
&gt;
&gt;               -eric
&gt;
&gt;
&gt;
&gt; --- lib/CAM/PDF.pm.orig       2007-11-28 21:42:46.000000000 -0800
&gt; +++ lib/CAM/PDF.pm    2008-03-27 20:06:54.000000000 -0700
&gt; @@ -566,6 +566,9 @@
&gt;              $CAM::PDF::errstr = &#34;Could not decipher xref row:\n&#34; .  
&gt; $self-&gt;trimstr&#40;$row&#41;;
&gt;              return;
&gt;           }
&gt; +             if &#40;&#40;0 == $1&#41; &#38;&#38; &#40;0 == $2&#41;&#41; {
&gt; +                     next;
&gt; +             }
&gt;           if &#40;$type eq &#39;n&#39;&#41;
&gt;           {
&gt;              $index-&gt;{$objnum} = $indexnum;
</div>

This addition is dead code.  The case of a zero indexnum is already  
handled in the conditional above this.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; @@ -3785,6 +3788,7 @@
&gt;     my $otherdoc = shift;
&gt;     my $otherkey = shift;
&gt;     my $follow = shift;
&gt; +   my %traversedNodes = &#40;&#41;;
&gt;
&gt;     # careful! &#39;undef&#39; means something different from &#39;0&#39; here!
&gt;     if &#40;!defined $follow&#41;
&gt; @@ -3838,10 +3842,10 @@
&gt;           my $newkey = $self-&gt;appendObject&#40;$otherdoc, $oldrefkey, 0&#41;;
&gt;           $newrefkeys{$oldrefkey} = $newkey;
&gt;        }
&gt; -      $self-&gt;changeRefKeys&#40;$objnode, \%newrefkeys&#41;;
&gt; +      $self-&gt;changeRefKeys&#40;$objnode, \%newrefkeys, \%traversedNodes&#41;;
&gt;        for my $newkey &#40;values %newrefkeys&#41;
&gt;        {
&gt; -         $self-&gt;changeRefKeys&#40;$self-&gt;dereference&#40;$newkey&#41;, \% 
&gt; newrefkeys&#41;;
&gt; +         $self-&gt;changeRefKeys&#40;$self-&gt;dereference&#40;$newkey&#41;, \% 
&gt; newrefkeys, \%traversedNodes&#41;;
&gt;        }
&gt;     }
&gt;     return &#40;%newrefkeys&#41;;
</div>
Is the point of this to remember what you saw across calls to  
changeRefKeys?  If yes, than I can see where this would probably be a  
performance boost.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; @@ -5040,7 +5044,7 @@
&gt;     if &#40;$stream&#41;
&gt;     {
&gt;        $stream = $self-&gt;{crypt}-&gt;encrypt&#40;$self, $stream, $objnode-&gt; 
&gt; {objnum}, $objnode-&gt;{gennum}&#41;;
&gt; -      $str .= &#34;\nstream\n&#34; . $stream . &#39;endstream&#39;;
&gt; +      $str .= &#34;\nstream\n&#34; . $stream . &#39;\nendstream&#39;;
&gt;     }
&gt;     return &#34;obj\n$str\nendobj\n&#34;;
&gt;  }
</div>

This is wrong.  &#39;\n&#39; is equivalent to &#39;n&#39; and I really don&#39;t think  
you want to append an &#39;n&#39; to each stream!


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; @@ -5072,6 +5076,7 @@
&gt;     my $objnode = shift;
&gt;     my $func = shift;
&gt;     my $funcdata = shift;
&gt; +   my $funcResult = undef;
&gt;
&gt;     my $traversed = {};
&gt;     my @stack = &#40;$objnode&#41;;
&gt; @@ -5080,7 +5085,8 @@
&gt;     while &#40;$i &lt; @stack&#41;
&gt;     {
&gt;        my $objnode = $stack[$i++];
&gt; -      $self-&gt;$func&#40;$objnode, $funcdata&#41;;
&gt; +      $funcResult = undef;
&gt; +      $funcResult = $self-&gt;$func&#40;$objnode, $funcdata&#41;;
&gt;
&gt;        my $type = $objnode-&gt;{type};
&gt;        my $val = $objnode-&gt;{value};
</div>
The above change does nothing.  You aren&#39;t even using the value you  
store in $funcResult.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; @@ -5108,6 +5114,62 @@
&gt;     return;
&gt;  }
&gt;
&gt; +sub recurseTraverse {
&gt; +     my &#40;$self, $deref, $objnode, $traversedRef, $func, $funcdata,  
&gt; $objnum&#41; = @_;
&gt; +     
&gt; +     my $type;
&gt; +     my $val;
&gt; +     my @nodes = &#40;&#41;;
&gt; +     my $node = undef;
&gt; +     my $newObjNum = undef;
&gt; +     
&gt; +     if &#40;&#40;!defined&#40;$objnode&#41;&#41; || &#40;! ref $objnode &#41;&#41; {
&gt; +             return;
&gt; +     }
&gt; +     
&gt; +     if &#40;defined&#40;$objnum&#41;&#41; {
&gt; +             $newObjNum = $objnum;
&gt; +     }
&gt; +
&gt; +     $type = $objnode-&gt;{type};
&gt; +     $val = $objnode-&gt;{value};
&gt; +     
&gt; +     if &#40;exists $objnode-&gt;{objnum}&#41; {
&gt; +             $newObjNum = $objnode-&gt;{objnum};
&gt; +     }
&gt; +     
&gt; +     if &#40;&#40;defined&#40;$newObjNum&#41;&#41; &#38;&#38;
&gt; +         &#40;exists &#40;$traversedRef-&gt;{$newObjNum}&#41;&#41;&#41; {
&gt; +             return;
&gt; +     } else {
&gt; +             $self-&gt;$func&#40;$objnode, $funcdata&#41;;
&gt; +     }
&gt; +     
&gt; +     if &#40;$type eq &#39;dictionary&#39;&#41; {
&gt; +             push &#40;@nodes, values %{$val}&#41;;
&gt; +     } elsif &#40;$type eq &#39;array&#39;&#41; {
&gt; +             push &#40;@nodes, @{$val}&#41;;
&gt; +     } elsif &#40;$type eq &#39;object&#39;&#41; {
&gt; +             push &#40;@nodes, $val&#41;;
&gt; +     } elsif &#40;$type eq &#39;reference&#39;&#41; {
&gt; +             if &#40;$deref&#41; {
&gt; +                     push &#40;@nodes, $self-&gt;dereference&#40;$val&#41;&#41;;
&gt; +             } else {
&gt; +                     return;
&gt; +             }
&gt; +     }
&gt; +
&gt; +     for $node &#40;@nodes&#41; {
&gt; +             recurseTraverse&#40;$self, $deref, $node, $traversedRef, $func,  
&gt; $funcdata, $newObjNum&#41;;
&gt; +     }
&gt; +     
&gt; +     if &#40;&#40;$type eq &#39;object&#39;&#41;&#41; {
&gt; +             $traversedRef-&gt;{$newObjNum} = 1;
&gt; +     }
&gt; +
&gt; +     return;
&gt; +}
&gt; +
&gt;  # decodeObject and decodeAll differ from each other like this:
&gt;  #
&gt;  #  decodeObject JUST decodes a single stream directly below the  
&gt; object
</div>

You neglected to document recurseTraverse, so I&#39;m having some trouble  
understanding the point of this method.  It looks like a slower  
version of my traverse&#40;&#41; method, which deliberately uses an explicit  
stack instead of the program stack for a big performance boost.  I  
don&#39;t understand why you check for under or scalar $objnode.  Those  
cases should not even be possible, I believe.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; @@ -5538,10 +5600,11 @@
&gt;     my $self = shift;
&gt;     my $objnode = shift;
&gt;     my $newrefkeys = shift;
&gt; +   my $traversedRef = shift;
&gt;
&gt;     my $follow = shift || 0;   # almost always false
&gt;
&gt; -   $self-&gt;traverse&#40;$follow, $objnode, \&#38;_changeRefKeysCB,  
&gt; $newrefkeys&#41;;
&gt; +   $self-&gt;recurseTraverse&#40;$follow, $objnode, $traversedRef,  
&gt; \&#38;_changeRefKeysCB, $newrefkeys, 0&#41;;
&gt;     return;
&gt;  }
&gt;
</div>


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; @@ -5558,9 +5621,10 @@
&gt;        if &#40;exists $newrefkeys-&gt;{$objnode-&gt;{value}}&#41;
&gt;        {
&gt;           $objnode-&gt;{value} = $newrefkeys-&gt;{$objnode-&gt;{value}};
&gt; +         return 1;
&gt;        }
&gt;     }
&gt; -   return;
&gt; +   return 0;
&gt;  }
&gt;
&gt;  =item $doc-&gt;abbrevInlineImage&#40;$object&#41;
</div>
The return value of this function is never used.  Why is it returning  
1 or 0?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-456255" href="/Public/Bug/Display.html?id=35555#txn-456255">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;30&nbsp;21:03:01&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-456260" href="/Public/Bug/Display.html?id=35555#txn-456260">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;30&nbsp;21:15:15&nbsp;2008</span>
    <span class="description">rt.cpan.org [...] darkart.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #35555] patch to improve node traversal</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 1 May 2008 01:14:59 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Chris Dolan via RT &lt;bug-CAM-PDF [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Hall &lt;rt.cpan.org [...] darkart.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/456260/224315/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/224315">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Apr 30, 2008 at 09:03:01PM -0400, Chris Dolan via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=35555">http://rt.cpan.org/Ticket/Display.html?id=35555</a></span> &gt;
&gt; 
&gt; Hi Eric,
&gt; 
&gt; There are several problems with this patch as written.  I&#39;ve included  
&gt; criticisms below, which I intend constructively.  Clearly you&#39;ve put  
&gt; some work into this, but I cannot accept it as is.
</div>
        Sure, it was done by one of the people who works for me,
and &#40;unfortunately after I sent it out&#41; he did express that he
wanted to fix it up.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Furthermore, it would help if you explained your patch more  
&gt; thoroughly.  In particular, you say that the patch improved  
&gt; traversal, but you don&#39;t say whether it improves performance or  
&gt; correctness.  Is there a problem with the existing traverse routine?
</div>
        Yes, there was/is a problem, which I&#39;ll have to ask
what the particulars were as I&#39;m not remembering right now.
Sorry, I should have gotten that info before sending it &#40;I wanted
to send it out to you while I was working on integrating it
with our stuff today, lest I forget&#41;.

        I&#39;ll forward your comments and we&#39;ll get back to you.
I have one right off, about the &#39;\n&#39; added around each stream,
that adds a newline, not a &#39;n&#39;.


                -eric
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-456266" href="/Public/Bug/Display.html?id=35555#txn-456266">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;30&nbsp;22:05:10&nbsp;2008</span>
    <span class="description">chris [...] chrisdolan.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #35555] patch to improve node traversal</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 30 Apr 2008 21:04:54 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CAM-PDF [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Chris Dolan &lt;chris [...] chrisdolan.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/456266/224320/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/224320">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 496b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the update.

On Apr 30, 2008, at 8:15 PM, Eric Hall via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have one right off, about the &#39;\n&#39; added around each stream,
&gt; that adds a newline, not a &#39;n&#39;.
</div>
Sorry to disagree, but you&#39;re mistaken.  The code we&#39;re discussing  
used single quotes and newlines don&#39;t interpolate in single quotes.   
Furthermore, \n is different on Windows vs. Unix.  Streams have  
particularly finicky syntax, so sticking a \n in there would only  
work in the most lenient PDF parsers.

Chris
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-456567" href="/Public/Bug/Display.html?id=35555#txn-456567">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;01&nbsp;15:29:48&nbsp;2008</span>
    <span class="description">rt.cpan.org [...] darkart.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #35555] patch to improve node traversal</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 1 May 2008 19:29:22 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Chris Dolan via RT &lt;bug-CAM-PDF [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Hall &lt;rt.cpan.org [...] darkart.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/456567/224495/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/224495">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Apr 30, 2008 at 10:05:13PM -0400, Chris Dolan via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=35555">http://rt.cpan.org/Ticket/Display.html?id=35555</a></span> &gt;
&gt; 
&gt; Thanks for the update.
&gt; 
&gt; On Apr 30, 2008, at 8:15 PM, Eric Hall via RT wrote:
<div class="message-stanza open">&gt; &gt; I have one right off, about the &#39;\n&#39; added around each stream,
&gt; &gt; that adds a newline, not a &#39;n&#39;.
</div>&gt; 
&gt; Sorry to disagree, but you&#39;re mistaken.  The code we&#39;re discussing  
&gt; used single quotes and newlines don&#39;t interpolate in single quotes.   
&gt; Furthermore, \n is different on Windows vs. Unix.  Streams have  
&gt; particularly finicky syntax, so sticking a \n in there would only  
&gt; work in the most lenient PDF parsers.
&gt; 
</div>
Chris-
        Yes, inside of the single quotes it will be left as \n,
however empirical testing reveals that it is interpolated elsewhere
as we get a newline in the final output.  As well, every PDF we&#39;ve
looked at &#40;generated from many different systems&#41; uses 0x0a for newlines,
and the PDF references I&#39;ve read indicate that both CR, LF, and
CRLF are all considered as EOL markers.  As well, the references
indicate that the PDF data should be

        ...consumed directly, without translation between native
        character sets, end-of-line representations, or 
        other conventions used on various platforms.

        &#40;PDFReference 1.3, ISBN 0-201-61588-6&#41;

Worded slightly differently in the PDF 1.7 reference:

        Such a file is not portable to environments that
        impose reserved character codes, maximum line lengths,
        end-of-line conventions, or other restrictions.  

&#40;both are in section 3.1&#41;

        It doesn&#39;t seem that the EOL marker is required in
all places, but the &#39;Lexical Conventions&#39; indicate that
the EOL marker before tokens is the recommended way to format
the PDF file.


                -eric
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-456569" href="/Public/Bug/Display.html?id=35555#txn-456569">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;01&nbsp;15:35:57&nbsp;2008</span>
    <span class="description">rt.cpan.org [...] darkart.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #35555] patch to improve node traversal</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 1 May 2008 19:35:32 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Chris Dolan via RT &lt;bug-CAM-PDF [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Hall &lt;rt.cpan.org [...] darkart.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/456569/224497/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/224497">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 9.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Apr 30, 2008 at 09:03:01PM -0400, Chris Dolan via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=35555">http://rt.cpan.org/Ticket/Display.html?id=35555</a></span> &gt;
&gt; 
&gt; Hi Eric,
&gt; 
&gt; There are several problems with this patch as written.  I&#39;ve included  
&gt; criticisms below, which I intend constructively.  Clearly you&#39;ve put  
&gt; some work into this, but I cannot accept it as is.
&gt; 
&gt; Furthermore, it would help if you explained your patch more  
&gt; thoroughly.  In particular, you say that the patch improved  
&gt; traversal, but you don&#39;t say whether it improves performance or  
&gt; correctness.  Is there a problem with the existing traverse routine?
</div>
        Comments from the actual developer in-line below, wrapped in
&lt;dev&gt; &lt;/dev&gt; tags.

        For the &#39;dead&#39; and/or &#39;useless&#39; code segments, those are
entirely my fault, I should have made sure we had a good/final patch
to send upstream before doing so, sorry for that.


        -eric


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Chris
&gt; 
&gt; On Apr 30, 2008, at 4:36 PM, Eric Hall via RT wrote:
<div class="message-stanza open">&gt; &gt;
&gt; &gt; Wed Apr 30 17:36:27 2008: Request 35555 was acted upon.
&gt; &gt; Transaction: Ticket created by rt.cpan.org@darkart.com
&gt; &gt;        Queue: CAM-PDF
&gt; &gt;      Subject: patch to improve node traversal
&gt; &gt;    Broken in: &#40;no value&#41;
&gt; &gt;     Severity: &#40;no value&#41;
&gt; &gt;        Owner: Nobody
&gt; &gt;   Requestors: rt.cpan.org@darkart.com
&gt; &gt;       Status: new
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=35555">http://rt.cpan.org/Ticket/Display.html?id=35555</a></span> &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; Hello-
&gt; &gt;     Attached is a patch against 1.13 which improved PDF node
&gt; &gt; traversal for us.
&gt; &gt;
&gt; &gt;
&gt; &gt;             -eric
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; --- lib/CAM/PDF.pm.orig     2007-11-28 21:42:46.000000000 -0800
&gt; &gt; +++ lib/CAM/PDF.pm  2008-03-27 20:06:54.000000000 -0700
&gt; &gt; @@ -566,6 +566,9 @@
&gt; &gt;              $CAM::PDF::errstr = &#34;Could not decipher xref row:\n&#34; .  
&gt; &gt; $self-&gt;trimstr&#40;$row&#41;;
&gt; &gt;              return;
&gt; &gt;           }
&gt; &gt; +           if &#40;&#40;0 == $1&#41; &#38;&#38; &#40;0 == $2&#41;&#41; {
&gt; &gt; +                   next;
&gt; &gt; +           }
&gt; &gt;           if &#40;$type eq &#39;n&#39;&#41;
&gt; &gt;           {
&gt; &gt;              $index-&gt;{$objnum} = $indexnum;
</div>&gt; 
&gt; 
&gt; This addition is dead code.  The case of a zero indexnum is already  
&gt; handled in the conditional above this.
</div>
&lt;dev&gt;
That&#39;s something that changed between 1.07 and 1.12...so it is dead code now.  In v1.07 it certainly was NOT dead code.  However, I don&#39;t believe we should quit the function when we find a zero index number...we just need to skip that row.  Killing the whole process for that doesn&#39;t seem necessary for an otherwise completely parseable PDF.
&lt;/dev&gt;


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 
<div class="message-stanza open">&gt; &gt; @@ -3785,6 +3788,7 @@
&gt; &gt;     my $otherdoc = shift;
&gt; &gt;     my $otherkey = shift;
&gt; &gt;     my $follow = shift;
&gt; &gt; +   my %traversedNodes = &#40;&#41;;
&gt; &gt;
&gt; &gt;     # careful! &#39;undef&#39; means something different from &#39;0&#39; here!
&gt; &gt;     if &#40;!defined $follow&#41;
&gt; &gt; @@ -3838,10 +3842,10 @@
&gt; &gt;           my $newkey = $self-&gt;appendObject&#40;$otherdoc, $oldrefkey, 0&#41;;
&gt; &gt;           $newrefkeys{$oldrefkey} = $newkey;
&gt; &gt;        }
&gt; &gt; -      $self-&gt;changeRefKeys&#40;$objnode, \%newrefkeys&#41;;
&gt; &gt; +      $self-&gt;changeRefKeys&#40;$objnode, \%newrefkeys, \%traversedNodes&#41;;
&gt; &gt;        for my $newkey &#40;values %newrefkeys&#41;
&gt; &gt;        {
&gt; &gt; -         $self-&gt;changeRefKeys&#40;$self-&gt;dereference&#40;$newkey&#41;, \% 
&gt; &gt; newrefkeys&#41;;
&gt; &gt; +         $self-&gt;changeRefKeys&#40;$self-&gt;dereference&#40;$newkey&#41;, \% 
&gt; &gt; newrefkeys, \%traversedNodes&#41;;
&gt; &gt;        }
&gt; &gt;     }
&gt; &gt;     return &#40;%newrefkeys&#41;;
</div>&gt; 
&gt; Is the point of this to remember what you saw across calls to  
&gt; changeRefKeys?  If yes, than I can see where this would probably be a  
&gt; performance boost.
</div>
&lt;dev&gt;
Of all the changes in the patch this one is the most vital.  When appending PDF files you need to renumber all the indices, and if you descend into the hierarchy without keeping track of where you&#39;ve been, you&#39;ll end up with misnumbered indices and your resultant PDF is corrupt.  &#34;traverse&#34; does keeps track of traversedRefs, but the way it&#39;s called the vital traversal data is lost every time the function exits, so nodes are getting traversed multiple times.   This was not meant as a performance boost but rather making it work correctly, however it does prevent multiple traversal of nodes which is a perf gain.

To roll that into traverse, just pass a reference to %traversed in rather than defining it in the function.
&lt;/dev&gt;


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt; &gt; @@ -5040,7 +5044,7 @@
&gt; &gt;     if &#40;$stream&#41;
&gt; &gt;     {
&gt; &gt;        $stream = $self-&gt;{crypt}-&gt;encrypt&#40;$self, $stream, $objnode-&gt; 
&gt; &gt; {objnum}, $objnode-&gt;{gennum}&#41;;
&gt; &gt; -      $str .= &#34;\nstream\n&#34; . $stream . &#39;endstream&#39;;
&gt; &gt; +      $str .= &#34;\nstream\n&#34; . $stream . &#39;\nendstream&#39;;
&gt; &gt;     }
&gt; &gt;     return &#34;obj\n$str\nendobj\n&#34;;
&gt; &gt;  }
</div>&gt; 
&gt; 
&gt; This is wrong.  &#39;\n&#39; is equivalent to &#39;n&#39; and I really don&#39;t think  
&gt; you want to append an &#39;n&#39; to each stream!
</div>
&lt;dev&gt;
Two comments:
1&#41; that&#39;s correct...the single quoted \n will come through as a literal string \n.  However, it does work, and I believe that&#39;s because in other places the $stream that gets returned ends up embedding inside of double quoted strings so it gets turned into a newline there.

2&#41; in every PDF I&#39;ve ever opened, there is a newline between the end of the stream and the &#34;endstream&#34; marker, so I do think that there needs to be a newline there.  The single quotes should be changed to double quotes.
&lt;/dev&gt;


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 
<div class="message-stanza open">&gt; &gt; @@ -5072,6 +5076,7 @@
&gt; &gt;     my $objnode = shift;
&gt; &gt;     my $func = shift;
&gt; &gt;     my $funcdata = shift;
&gt; &gt; +   my $funcResult = undef;
&gt; &gt;
&gt; &gt;     my $traversed = {};
&gt; &gt;     my @stack = &#40;$objnode&#41;;
&gt; &gt; @@ -5080,7 +5085,8 @@
&gt; &gt;     while &#40;$i &lt; @stack&#41;
&gt; &gt;     {
&gt; &gt;        my $objnode = $stack[$i++];
&gt; &gt; -      $self-&gt;$func&#40;$objnode, $funcdata&#41;;
&gt; &gt; +      $funcResult = undef;
&gt; &gt; +      $funcResult = $self-&gt;$func&#40;$objnode, $funcdata&#41;;
&gt; &gt;
&gt; &gt;        my $type = $objnode-&gt;{type};
&gt; &gt;        my $val = $objnode-&gt;{value};
</div>&gt; 
&gt; The above change does nothing.  You aren&#39;t even using the value you  
&gt; store in $funcResult.
</div>
&lt;dev&gt;
Yeah, that&#39;s a bad merge.  There was code that used funcResult, but it was commented out and therefore didn&#39;t show up in the diff.  Before writing recurseTraverse I was trying to get traverse to work.
&lt;/dev&gt;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt; &gt; @@ -5108,6 +5114,62 @@
&gt; &gt;     return;
&gt; &gt;  }
&gt; &gt;
&gt; &gt; +sub recurseTraverse {
&gt; &gt; +   my &#40;$self, $deref, $objnode, $traversedRef, $func, $funcdata,  
&gt; &gt; $objnum&#41; = @_;
&gt; &gt; +   
&gt; &gt; +   my $type;
&gt; &gt; +   my $val;
&gt; &gt; +   my @nodes = &#40;&#41;;
&gt; &gt; +   my $node = undef;
&gt; &gt; +   my $newObjNum = undef;
&gt; &gt; +   
&gt; &gt; +   if &#40;&#40;!defined&#40;$objnode&#41;&#41; || &#40;! ref $objnode &#41;&#41; {
&gt; &gt; +           return;
&gt; &gt; +   }
&gt; &gt; +   
&gt; &gt; +   if &#40;defined&#40;$objnum&#41;&#41; {
&gt; &gt; +           $newObjNum = $objnum;
&gt; &gt; +   }
&gt; &gt; +
&gt; &gt; +   $type = $objnode-&gt;{type};
&gt; &gt; +   $val = $objnode-&gt;{value};
&gt; &gt; +   
&gt; &gt; +   if &#40;exists $objnode-&gt;{objnum}&#41; {
&gt; &gt; +           $newObjNum = $objnode-&gt;{objnum};
&gt; &gt; +   }
&gt; &gt; +   
&gt; &gt; +   if &#40;&#40;defined&#40;$newObjNum&#41;&#41; &#38;&#38;
&gt; &gt; +       &#40;exists &#40;$traversedRef-&gt;{$newObjNum}&#41;&#41;&#41; {
&gt; &gt; +           return;
&gt; &gt; +   } else {
&gt; &gt; +           $self-&gt;$func&#40;$objnode, $funcdata&#41;;
&gt; &gt; +   }
&gt; &gt; +   
&gt; &gt; +   if &#40;$type eq &#39;dictionary&#39;&#41; {
&gt; &gt; +           push &#40;@nodes, values %{$val}&#41;;
&gt; &gt; +   } elsif &#40;$type eq &#39;array&#39;&#41; {
&gt; &gt; +           push &#40;@nodes, @{$val}&#41;;
&gt; &gt; +   } elsif &#40;$type eq &#39;object&#39;&#41; {
&gt; &gt; +           push &#40;@nodes, $val&#41;;
&gt; &gt; +   } elsif &#40;$type eq &#39;reference&#39;&#41; {
&gt; &gt; +           if &#40;$deref&#41; {
&gt; &gt; +                   push &#40;@nodes, $self-&gt;dereference&#40;$val&#41;&#41;;
&gt; &gt; +           } else {
&gt; &gt; +                   return;
&gt; &gt; +           }
&gt; &gt; +   }
&gt; &gt; +
&gt; &gt; +   for $node &#40;@nodes&#41; {
&gt; &gt; +           recurseTraverse&#40;$self, $deref, $node, $traversedRef, $func,  
&gt; &gt; $funcdata, $newObjNum&#41;;
&gt; &gt; +   }
&gt; &gt; +   
&gt; &gt; +   if &#40;&#40;$type eq &#39;object&#39;&#41;&#41; {
&gt; &gt; +           $traversedRef-&gt;{$newObjNum} = 1;
&gt; &gt; +   }
&gt; &gt; +
&gt; &gt; +   return;
&gt; &gt; +}
&gt; &gt; +
&gt; &gt;  # decodeObject and decodeAll differ from each other like this:
&gt; &gt;  #
&gt; &gt;  #  decodeObject JUST decodes a single stream directly below the  
&gt; &gt; object
</div>&gt; 
&gt; 
&gt; You neglected to document recurseTraverse, so I&#39;m having some trouble  
&gt; understanding the point of this method.  It looks like a slower  
&gt; version of my traverse&#40;&#41; method, which deliberately uses an explicit  
&gt; stack instead of the program stack for a big performance boost.  I  
&gt; don&#39;t understand why you check for under or scalar $objnode.  Those  
&gt; cases should not even be possible, I believe.
</div>
&lt;dev&gt;
I didn&#39;t get a chance to document it...I didn&#39;t know this was being submitted to CPAN. :&#41;  The story is that I was having trouble with traverse hitting nodes multiple times, and the whole stack thing was a bit confusing.   I wrote a recursive traversal just for sanity&#39;s sake so I could easily see the hierarchy being traversed.

After I figured out that the main issue was just that the traversedRef was getting reset, I didn&#39;t get a chance to go back and make the change to the traverse function and test it.

It may be slower, but it doesn&#39;t seem to make that much difference; I&#39;ve used it to stitch together 30 parts of a PDF and it performed fine.
&lt;/dev&gt;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 
<div class="message-stanza open">&gt; &gt; @@ -5538,10 +5600,11 @@
&gt; &gt;     my $self = shift;
&gt; &gt;     my $objnode = shift;
&gt; &gt;     my $newrefkeys = shift;
&gt; &gt; +   my $traversedRef = shift;
&gt; &gt;
&gt; &gt;     my $follow = shift || 0;   # almost always false
&gt; &gt;
&gt; &gt; -   $self-&gt;traverse&#40;$follow, $objnode, \&#38;_changeRefKeysCB,  
&gt; &gt; $newrefkeys&#41;;
&gt; &gt; +   $self-&gt;recurseTraverse&#40;$follow, $objnode, $traversedRef,  
&gt; &gt; \&#38;_changeRefKeysCB, $newrefkeys, 0&#41;;
&gt; &gt;     return;
&gt; &gt;  }
&gt; &gt;
</div>&gt; 
&gt; 
&gt; 
<div class="message-stanza open">&gt; &gt;
&gt; &gt; @@ -5558,9 +5621,10 @@
&gt; &gt;        if &#40;exists $newrefkeys-&gt;{$objnode-&gt;{value}}&#41;
&gt; &gt;        {
&gt; &gt;           $objnode-&gt;{value} = $newrefkeys-&gt;{$objnode-&gt;{value}};
&gt; &gt; +         return 1;
&gt; &gt;        }
&gt; &gt;     }
&gt; &gt; -   return;
&gt; &gt; +   return 0;
&gt; &gt;  }
&gt; &gt;
&gt; &gt;  =item $doc-&gt;abbrevInlineImage&#40;$object&#41;
</div>&gt; 
&gt; The return value of this function is never used.  Why is it returning  
&gt; 1 or 0?
&gt; 
</div>
&lt;dev&gt;
This change goes with the other unused change above:

+      $funcResult = $self-&gt;$func&#40;$objnode, $funcdata&#41;;

It&#39;s also an unnecessary merge.  You&#39;re right, it does nothing.
&lt;/dev&gt;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-456596" href="/Public/Bug/Display.html?id=35555#txn-456596">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;01&nbsp;21:40:34&nbsp;2008</span>
    <span class="description">chris [...] chrisdolan.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #35555] patch to improve node traversal</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 1 May 2008 20:40:05 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CAM-PDF [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Chris Dolan &lt;chris [...] chrisdolan.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/456596/224516/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/224516">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 498b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Eric,

Thanks for the detailed response, &lt;dev&gt;!  The explanation makes  
sense, but I&#39;m surprised I never encountered the bug before.  I  
rewrote the patch to be much less intrusive, and attached it to this  
message.  I haven&#39;t tested it except to ensure that the CAM::PDF unit  
tests still pass.  Could you please try it against 1.13 and see if it  
solves your problems?  Even better, I would be THRILLED if you were  
to write a simple test case that exposed the bug in 1.13.

Thanks,
Chris
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/456596/224517/traverse.patch">Download traverse.patch</a><br />
<span class="downloadcontenttype">text/x-diff 1.6k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/456596/224518/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/224518">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 9.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">

On May 1, 2008, at 2:35 PM, Eric Hall via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt;        Queue: CAM-PDF
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=35555">http://rt.cpan.org/Ticket/Display.html?id=35555</a></span> &gt;
&gt;
&gt; On Wed, Apr 30, 2008 at 09:03:01PM -0400, Chris Dolan via RT wrote:
<div class="message-stanza open">&gt;&gt;
&gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=35555">http://rt.cpan.org/Ticket/Display.html?id=35555</a></span> &gt;
&gt;&gt;
&gt;&gt; Hi Eric,
&gt;&gt;
&gt;&gt; There are several problems with this patch as written.  I&#39;ve included
&gt;&gt; criticisms below, which I intend constructively.  Clearly you&#39;ve put
&gt;&gt; some work into this, but I cannot accept it as is.
&gt;&gt;
&gt;&gt; Furthermore, it would help if you explained your patch more
&gt;&gt; thoroughly.  In particular, you say that the patch improved
&gt;&gt; traversal, but you don&#39;t say whether it improves performance or
&gt;&gt; correctness.  Is there a problem with the existing traverse routine?
</div>&gt;
&gt;       Comments from the actual developer in-line below, wrapped in
&gt; &lt;dev&gt; &lt;/dev&gt; tags.
&gt;
&gt;       For the &#39;dead&#39; and/or &#39;useless&#39; code segments, those are
&gt; entirely my fault, I should have made sure we had a good/final patch
&gt; to send upstream before doing so, sorry for that.
&gt;
&gt;
&gt;       -eric
&gt;
&gt;
<div class="message-stanza open">&gt;&gt;
&gt;&gt; Chris
&gt;&gt;
&gt;&gt; On Apr 30, 2008, at 4:36 PM, Eric Hall via RT wrote:
<div class="message-stanza open">&gt;&gt;&gt;
&gt;&gt;&gt; Wed Apr 30 17:36:27 2008: Request 35555 was acted upon.
&gt;&gt;&gt; Transaction: Ticket created by rt.cpan.org@darkart.com
&gt;&gt;&gt;        Queue: CAM-PDF
&gt;&gt;&gt;      Subject: patch to improve node traversal
&gt;&gt;&gt;    Broken in: &#40;no value&#41;
&gt;&gt;&gt;     Severity: &#40;no value&#41;
&gt;&gt;&gt;        Owner: Nobody
&gt;&gt;&gt;   Requestors: rt.cpan.org@darkart.com
&gt;&gt;&gt;       Status: new
&gt;&gt;&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=35555">http://rt.cpan.org/Ticket/Display.html?id=35555</a></span> &gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; Hello-
&gt;&gt;&gt;     Attached is a patch against 1.13 which improved PDF node
&gt;&gt;&gt; traversal for us.
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;             -eric
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt;
&gt;&gt;&gt; --- lib/CAM/PDF.pm.orig     2007-11-28 21:42:46.000000000 -0800
&gt;&gt;&gt; +++ lib/CAM/PDF.pm  2008-03-27 20:06:54.000000000 -0700
&gt;&gt;&gt; @@ -566,6 +566,9 @@
&gt;&gt;&gt;              $CAM::PDF::errstr = &#34;Could not decipher xref row:\n&#34; .
&gt;&gt;&gt; $self-&gt;trimstr&#40;$row&#41;;
&gt;&gt;&gt;              return;
&gt;&gt;&gt;           }
&gt;&gt;&gt; +           if &#40;&#40;0 == $1&#41; &#38;&#38; &#40;0 == $2&#41;&#41; {
&gt;&gt;&gt; +                   next;
&gt;&gt;&gt; +           }
&gt;&gt;&gt;           if &#40;$type eq &#39;n&#39;&#41;
&gt;&gt;&gt;           {
&gt;&gt;&gt;              $index-&gt;{$objnum} = $indexnum;
</div>&gt;&gt;
&gt;&gt;
&gt;&gt; This addition is dead code.  The case of a zero indexnum is already
&gt;&gt; handled in the conditional above this.
</div>&gt;
&gt; &lt;dev&gt;
&gt; That&#39;s something that changed between 1.07 and 1.12...so it is dead  
&gt; code now.  In v1.07 it certainly was NOT dead code.  However, I  
&gt; don&#39;t believe we should quit the function when we find a zero index  
&gt; number...we just need to skip that row.  Killing the whole process  
&gt; for that doesn&#39;t seem necessary for an otherwise completely  
&gt; parseable PDF.
&gt; &lt;/dev&gt;
&gt;
&gt;
<div class="message-stanza open">&gt;&gt;
&gt;&gt;
<div class="message-stanza open">&gt;&gt;&gt; @@ -3785,6 +3788,7 @@
&gt;&gt;&gt;     my $otherdoc = shift;
&gt;&gt;&gt;     my $otherkey = shift;
&gt;&gt;&gt;     my $follow = shift;
&gt;&gt;&gt; +   my %traversedNodes = &#40;&#41;;
&gt;&gt;&gt;
&gt;&gt;&gt;     # careful! &#39;undef&#39; means something different from &#39;0&#39; here!
&gt;&gt;&gt;     if &#40;!defined $follow&#41;
&gt;&gt;&gt; @@ -3838,10 +3842,10 @@
&gt;&gt;&gt;           my $newkey = $self-&gt;appendObject&#40;$otherdoc, $oldrefkey,  
&gt;&gt;&gt; 0&#41;;
&gt;&gt;&gt;           $newrefkeys{$oldrefkey} = $newkey;
&gt;&gt;&gt;        }
&gt;&gt;&gt; -      $self-&gt;changeRefKeys&#40;$objnode, \%newrefkeys&#41;;
&gt;&gt;&gt; +      $self-&gt;changeRefKeys&#40;$objnode, \%newrefkeys, \% 
&gt;&gt;&gt; traversedNodes&#41;;
&gt;&gt;&gt;        for my $newkey &#40;values %newrefkeys&#41;
&gt;&gt;&gt;        {
&gt;&gt;&gt; -         $self-&gt;changeRefKeys&#40;$self-&gt;dereference&#40;$newkey&#41;, \%
&gt;&gt;&gt; newrefkeys&#41;;
&gt;&gt;&gt; +         $self-&gt;changeRefKeys&#40;$self-&gt;dereference&#40;$newkey&#41;, \%
&gt;&gt;&gt; newrefkeys, \%traversedNodes&#41;;
&gt;&gt;&gt;        }
&gt;&gt;&gt;     }
&gt;&gt;&gt;     return &#40;%newrefkeys&#41;;
</div>&gt;&gt;
&gt;&gt; Is the point of this to remember what you saw across calls to
&gt;&gt; changeRefKeys?  If yes, than I can see where this would probably be a
&gt;&gt; performance boost.
</div>&gt;
&gt; &lt;dev&gt;
&gt; Of all the changes in the patch this one is the most vital.  When  
&gt; appending PDF files you need to renumber all the indices, and if  
&gt; you descend into the hierarchy without keeping track of where  
&gt; you&#39;ve been, you&#39;ll end up with misnumbered indices and your  
&gt; resultant PDF is corrupt.  &#34;traverse&#34; does keeps track of  
&gt; traversedRefs, but the way it&#39;s called the vital traversal data is  
&gt; lost every time the function exits, so nodes are getting traversed  
&gt; multiple times.   This was not meant as a performance boost but  
&gt; rather making it work correctly, however it does prevent multiple  
&gt; traversal of nodes which is a perf gain.
&gt;
&gt; To roll that into traverse, just pass a reference to %traversed in  
&gt; rather than defining it in the function.
&gt; &lt;/dev&gt;
&gt;
&gt;
<div class="message-stanza open">&gt;&gt;
<div class="message-stanza open">&gt;&gt;&gt; @@ -5040,7 +5044,7 @@
&gt;&gt;&gt;     if &#40;$stream&#41;
&gt;&gt;&gt;     {
&gt;&gt;&gt;        $stream = $self-&gt;{crypt}-&gt;encrypt&#40;$self, $stream, $objnode-&gt;
&gt;&gt;&gt; {objnum}, $objnode-&gt;{gennum}&#41;;
&gt;&gt;&gt; -      $str .= &#34;\nstream\n&#34; . $stream . &#39;endstream&#39;;
&gt;&gt;&gt; +      $str .= &#34;\nstream\n&#34; . $stream . &#39;\nendstream&#39;;
&gt;&gt;&gt;     }
&gt;&gt;&gt;     return &#34;obj\n$str\nendobj\n&#34;;
&gt;&gt;&gt;  }
</div>&gt;&gt;
&gt;&gt;
&gt;&gt; This is wrong.  &#39;\n&#39; is equivalent to &#39;n&#39; and I really don&#39;t think
&gt;&gt; you want to append an &#39;n&#39; to each stream!
</div>&gt;
&gt; &lt;dev&gt;
&gt; Two comments:
&gt; 1&#41; that&#39;s correct...the single quoted \n will come through as a  
&gt; literal string \n.  However, it does work, and I believe that&#39;s  
&gt; because in other places the $stream that gets returned ends up  
&gt; embedding inside of double quoted strings so it gets turned into a  
&gt; newline there.
&gt;
&gt; 2&#41; in every PDF I&#39;ve ever opened, there is a newline between the  
&gt; end of the stream and the &#34;endstream&#34; marker, so I do think that  
&gt; there needs to be a newline there.  The single quotes should be  
&gt; changed to double quotes.
&gt; &lt;/dev&gt;
&gt;
&gt;
<div class="message-stanza open">&gt;&gt;
&gt;&gt;
<div class="message-stanza open">&gt;&gt;&gt; @@ -5072,6 +5076,7 @@
&gt;&gt;&gt;     my $objnode = shift;
&gt;&gt;&gt;     my $func = shift;
&gt;&gt;&gt;     my $funcdata = shift;
&gt;&gt;&gt; +   my $funcResult = undef;
&gt;&gt;&gt;
&gt;&gt;&gt;     my $traversed = {};
&gt;&gt;&gt;     my @stack = &#40;$objnode&#41;;
&gt;&gt;&gt; @@ -5080,7 +5085,8 @@
&gt;&gt;&gt;     while &#40;$i &lt; @stack&#41;
&gt;&gt;&gt;     {
&gt;&gt;&gt;        my $objnode = $stack[$i++];
&gt;&gt;&gt; -      $self-&gt;$func&#40;$objnode, $funcdata&#41;;
&gt;&gt;&gt; +      $funcResult = undef;
&gt;&gt;&gt; +      $funcResult = $self-&gt;$func&#40;$objnode, $funcdata&#41;;
&gt;&gt;&gt;
&gt;&gt;&gt;        my $type = $objnode-&gt;{type};
&gt;&gt;&gt;        my $val = $objnode-&gt;{value};
</div>&gt;&gt;
&gt;&gt; The above change does nothing.  You aren&#39;t even using the value you
&gt;&gt; store in $funcResult.
</div>&gt;
&gt; &lt;dev&gt;
&gt; Yeah, that&#39;s a bad merge.  There was code that used funcResult, but  
&gt; it was commented out and therefore didn&#39;t show up in the diff.   
&gt; Before writing recurseTraverse I was trying to get traverse to work.
&gt; &lt;/dev&gt;
&gt;
<div class="message-stanza open">&gt;&gt;
<div class="message-stanza open">&gt;&gt;&gt; @@ -5108,6 +5114,62 @@
&gt;&gt;&gt;     return;
&gt;&gt;&gt;  }
&gt;&gt;&gt;
&gt;&gt;&gt; +sub recurseTraverse {
&gt;&gt;&gt; +   my &#40;$self, $deref, $objnode, $traversedRef, $func, $funcdata,
&gt;&gt;&gt; $objnum&#41; = @_;
&gt;&gt;&gt; +   
&gt;&gt;&gt; +   my $type;
&gt;&gt;&gt; +   my $val;
&gt;&gt;&gt; +   my @nodes = &#40;&#41;;
&gt;&gt;&gt; +   my $node = undef;
&gt;&gt;&gt; +   my $newObjNum = undef;
&gt;&gt;&gt; +   
&gt;&gt;&gt; +   if &#40;&#40;!defined&#40;$objnode&#41;&#41; || &#40;! ref $objnode &#41;&#41; {
&gt;&gt;&gt; +           return;
&gt;&gt;&gt; +   }
&gt;&gt;&gt; +   
&gt;&gt;&gt; +   if &#40;defined&#40;$objnum&#41;&#41; {
&gt;&gt;&gt; +           $newObjNum = $objnum;
&gt;&gt;&gt; +   }
&gt;&gt;&gt; +
&gt;&gt;&gt; +   $type = $objnode-&gt;{type};
&gt;&gt;&gt; +   $val = $objnode-&gt;{value};
&gt;&gt;&gt; +   
&gt;&gt;&gt; +   if &#40;exists $objnode-&gt;{objnum}&#41; {
&gt;&gt;&gt; +           $newObjNum = $objnode-&gt;{objnum};
&gt;&gt;&gt; +   }
&gt;&gt;&gt; +   
&gt;&gt;&gt; +   if &#40;&#40;defined&#40;$newObjNum&#41;&#41; &#38;&#38;
&gt;&gt;&gt; +       &#40;exists &#40;$traversedRef-&gt;{$newObjNum}&#41;&#41;&#41; {
&gt;&gt;&gt; +           return;
&gt;&gt;&gt; +   } else {
&gt;&gt;&gt; +           $self-&gt;$func&#40;$objnode, $funcdata&#41;;
&gt;&gt;&gt; +   }
&gt;&gt;&gt; +   
&gt;&gt;&gt; +   if &#40;$type eq &#39;dictionary&#39;&#41; {
&gt;&gt;&gt; +           push &#40;@nodes, values %{$val}&#41;;
&gt;&gt;&gt; +   } elsif &#40;$type eq &#39;array&#39;&#41; {
&gt;&gt;&gt; +           push &#40;@nodes, @{$val}&#41;;
&gt;&gt;&gt; +   } elsif &#40;$type eq &#39;object&#39;&#41; {
&gt;&gt;&gt; +           push &#40;@nodes, $val&#41;;
&gt;&gt;&gt; +   } elsif &#40;$type eq &#39;reference&#39;&#41; {
&gt;&gt;&gt; +           if &#40;$deref&#41; {
&gt;&gt;&gt; +                   push &#40;@nodes, $self-&gt;dereference&#40;$val&#41;&#41;;
&gt;&gt;&gt; +           } else {
&gt;&gt;&gt; +                   return;
&gt;&gt;&gt; +           }
&gt;&gt;&gt; +   }
&gt;&gt;&gt; +
&gt;&gt;&gt; +   for $node &#40;@nodes&#41; {
&gt;&gt;&gt; +           recurseTraverse&#40;$self, $deref, $node, $traversedRef, $func,
&gt;&gt;&gt; $funcdata, $newObjNum&#41;;
&gt;&gt;&gt; +   }
&gt;&gt;&gt; +   
&gt;&gt;&gt; +   if &#40;&#40;$type eq &#39;object&#39;&#41;&#41; {
&gt;&gt;&gt; +           $traversedRef-&gt;{$newObjNum} = 1;
&gt;&gt;&gt; +   }
&gt;&gt;&gt; +
&gt;&gt;&gt; +   return;
&gt;&gt;&gt; +}
&gt;&gt;&gt; +
&gt;&gt;&gt;  # decodeObject and decodeAll differ from each other like this:
&gt;&gt;&gt;  #
&gt;&gt;&gt;  #  decodeObject JUST decodes a single stream directly below the
&gt;&gt;&gt; object
</div>&gt;&gt;
&gt;&gt;
&gt;&gt; You neglected to document recurseTraverse, so I&#39;m having some trouble
&gt;&gt; understanding the point of this method.  It looks like a slower
&gt;&gt; version of my traverse&#40;&#41; method, which deliberately uses an explicit
&gt;&gt; stack instead of the program stack for a big performance boost.  I
&gt;&gt; don&#39;t understand why you check for under or scalar $objnode.  Those
&gt;&gt; cases should not even be possible, I believe.
</div>&gt;
&gt; &lt;dev&gt;
&gt; I didn&#39;t get a chance to document it...I didn&#39;t know this was being  
&gt; submitted to CPAN. :&#41;  The story is that I was having trouble with  
&gt; traverse hitting nodes multiple times, and the whole stack thing  
&gt; was a bit confusing.   I wrote a recursive traversal just for  
&gt; sanity&#39;s sake so I could easily see the hierarchy being traversed.
&gt;
&gt; After I figured out that the main issue was just that the  
&gt; traversedRef was getting reset, I didn&#39;t get a chance to go back  
&gt; and make the change to the traverse function and test it.
&gt;
&gt; It may be slower, but it doesn&#39;t seem to make that much difference;  
&gt; I&#39;ve used it to stitch together 30 parts of a PDF and it performed  
&gt; fine.
&gt; &lt;/dev&gt;
&gt;
<div class="message-stanza open">&gt;&gt;
&gt;&gt;
<div class="message-stanza open">&gt;&gt;&gt; @@ -5538,10 +5600,11 @@
&gt;&gt;&gt;     my $self = shift;
&gt;&gt;&gt;     my $objnode = shift;
&gt;&gt;&gt;     my $newrefkeys = shift;
&gt;&gt;&gt; +   my $traversedRef = shift;
&gt;&gt;&gt;
&gt;&gt;&gt;     my $follow = shift || 0;   # almost always false
&gt;&gt;&gt;
&gt;&gt;&gt; -   $self-&gt;traverse&#40;$follow, $objnode, \&#38;_changeRefKeysCB,
&gt;&gt;&gt; $newrefkeys&#41;;
&gt;&gt;&gt; +   $self-&gt;recurseTraverse&#40;$follow, $objnode, $traversedRef,
&gt;&gt;&gt; \&#38;_changeRefKeysCB, $newrefkeys, 0&#41;;
&gt;&gt;&gt;     return;
&gt;&gt;&gt;  }
&gt;&gt;&gt;
</div>&gt;&gt;
&gt;&gt;
&gt;&gt;
<div class="message-stanza open">&gt;&gt;&gt;
&gt;&gt;&gt; @@ -5558,9 +5621,10 @@
&gt;&gt;&gt;        if &#40;exists $newrefkeys-&gt;{$objnode-&gt;{value}}&#41;
&gt;&gt;&gt;        {
&gt;&gt;&gt;           $objnode-&gt;{value} = $newrefkeys-&gt;{$objnode-&gt;{value}};
&gt;&gt;&gt; +         return 1;
&gt;&gt;&gt;        }
&gt;&gt;&gt;     }
&gt;&gt;&gt; -   return;
&gt;&gt;&gt; +   return 0;
&gt;&gt;&gt;  }
&gt;&gt;&gt;
&gt;&gt;&gt;  =item $doc-&gt;abbrevInlineImage&#40;$object&#41;
</div>&gt;&gt;
&gt;&gt; The return value of this function is never used.  Why is it returning
&gt;&gt; 1 or 0?
&gt;&gt;
</div>&gt;
&gt; &lt;dev&gt;
&gt; This change goes with the other unused change above:
&gt;
&gt; +      $funcResult = $self-&gt;$func&#40;$objnode, $funcdata&#41;;
&gt;
&gt; It&#39;s also an unnecessary merge.  You&#39;re right, it does nothing.
&gt; &lt;/dev&gt;
&gt;
&gt;
&gt;
</div></div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-491571" href="/Public/Bug/Display.html?id=35555#txn-491571">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;31&nbsp;04:12:43&nbsp;2008</span>
    <span class="description">chris+rt [...] chrisdolan.net -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.528574</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
