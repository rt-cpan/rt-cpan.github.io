<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #110009 for Catalyst-Runtime: Args&#40;0&#41; regression with ActionRole::MatchRequestAccepts</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #110009 for Catalyst-Runtime: Args&#40;0&#41; regression with ActionRole::MatchRequestAccepts</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Catalyst-Runtime/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Catalyst-Runtime/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Catalyst-Runtime/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Catalyst-Runtime/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Catalyst-Runtime">Catalyst-Runtime CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">110009</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Catalyst-Runtime/Active/">Catalyst-Runtime</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
tsibley [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-40040-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
5.90085</li>
<li>
5.90089_001</li>
<li>
5.90089_002</li>
<li>
5.90089_003</li>
<li>
5.90089_004</li>
<li>
5.90090</li>
<li>
5.90091</li>
<li>
5.90092</li>
<li>
5.90093</li>
<li>
5.90094</li>
<li>
5.90095</li>
<li>
5.90096</li>
<li>
5.90097</li>
<li>
5.90100</li>
<li>
5.90101</li>
<li>
5.90102</li>
<li>
5.90103</li>
</ul>
    </td>
  </tr>
  <tr id="CF-40041-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;01&nbsp;16:55:32&nbsp;2015</span>
    <span class="description">tsibley [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Args&#40;0&#41; regression with ActionRole::MatchRequestAccepts</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">When using ActionRole::MatchRequestAccepts, the fallback action takes precedence over any actions with Accept&#40;&#41; if it has Args&#40;0&#41; instead of Args.  The tests for ActionRole::MatchRequestAccepts don&#39;t catch this because they specify Args for the fallback, not Args&#40;0&#41;.  I noticed this behaviour in an internal work app.

The problem may be best demonstrated by the attached example test case, which fails from 09914a4 onward.  5.90084 is the last known good release, and bisect confirmed this.  Note that the test case will pass if you change not_accepted&#39;s Args&#40;0&#41; to Args.

I think Catalyst is probably to blame here rather than ActionRole::MatchRequestAccepts, but let me know if I&#39;m wrong and should report this regression over there instead.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> args0-match-request-accepts.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use warnings;
use strict;
use Test::More;

plan skip_all =&gt; &#39;Requires Catalyst::ActionRole::MatchRequestAccepts&#39;
    unless eval { require Catalyst::ActionRole::MatchRequestAccepts };

{
  package MyApp::Controller::Root;
  $INC{&#39;MyApp/Controller/Root.pm&#39;} = __FILE__;

  use Moose;
  use MooseX::MethodAttributes;

  BEGIN { extends &#39;Catalyst::Controller&#39; };

  sub root : Chained&#40;&#39;/&#39;&#41; PathPrefix CaptureArgs&#40;0&#41; {}

    sub text_plain : Chained&#40;&#39;root&#39;&#41; PathPart&#40;&#39;&#39;&#41; Does&#40;MatchRequestAccepts&#41; Accept&#40;&#39;text/plain&#39;&#41; Args&#40;0&#41; {
      my &#40;$self, $ctx&#41; = @_;
      $ctx-&gt;response-&gt;body&#40;&#39;text_plain&#39;&#41;;
    }

    sub json : Chained&#40;&#39;root&#39;&#41; PathPart&#40;&#39;&#39;&#41; Does&#40;MatchRequestAccepts&#41; Accept&#40;&#39;application/json&#39;&#41; Args&#40;0&#41; {
      my &#40;$self, $ctx&#41; = @_;
      $ctx-&gt;response-&gt;body&#40;&#39;json&#39;&#41;;
    }

    sub not_accepted : Chained&#40;&#39;root&#39;&#41; PathPart&#40;&#39;&#39;&#41; Args&#40;0&#41; {
      my &#40;$self, $ctx&#41; = @_;
      $ctx-&gt;response-&gt;body&#40;&#39;error_not_accepted&#39;&#41;;
    }

  MyApp::Controller::Root-&gt;config&#40;namespace=&gt;&#39;&#39;&#41;;

  package MyApp;
  use Catalyst;
  MyApp-&gt;setup;
}

use Catalyst::Test &#39;MyApp&#39;;
use HTTP::Request::Common qw/GET/;

is request&#40;GET &#39;/&#39;&#41;-&gt;content, &#39;error_not_accepted&#39;;
is request&#40;GET &#39;/&#39;, &#39;Accept&#39; =&gt; &#39;text/plain&#39;&#41;-&gt;content, &#39;text_plain&#39;;
is request&#40;GET &#39;/&#39;, &#39;Accept&#39; =&gt; &#39;application/json&#39;&#41;-&gt;content, &#39;json&#39;;

done_testing;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;01&nbsp;16:59:09&nbsp;2015</span>
    <span class="description">tsibley [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The first bad commit is:

commit 09914a47700308f8588e65eb4a29d378c192aee8
Author: John Napiorkowski &lt;jjn1056@yahoo.com&gt;
Date:   Wed Mar 25 10:09:53 2015 -0500

    do not change the best_action when args&#40;0&#41; if current best_action is also args&#40;0&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;01&nbsp;19:29:03&nbsp;2015</span>
    <span class="description">jjn1056 [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #110009] Args&#40;0&#41; regression with ActionRole::MatchRequestAccepts</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 2 Dec 2015 00:28:47 +0000 &#40;UTC&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Catalyst-Runtime [...] rt.cpan.org&#34; &lt;bug-Catalyst-Runtime [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> John Napiorkowski &lt;jjn1056 [...] yahoo.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This was a change in Catalyst around version 5.9008x where we normalized the priority of actions when several actions could match as in the example you&#39;ve given.  Previously sometimes Catalyst would start checking actions defined first, other times last.  In particular the case Args&#40;0&#41; was acting differently from all other types of action definitions.  We changed this to always start matching the last action, so that is breaking your example. 
See Catalyst::RouteMatching  for more on this change.
|   |
|   |   |   |   |   |
| Catalyst::RouteMatchingHow Catalyst maps an incoming URL to actions in controllers. |
|  |
| View on metacpan.org | Preview by Yahoo |
|  |
|   |


If you have code that relied on the old behavior and change change the action order, there is a global catalyst configuration option to re-enable the legacy behavior, see &#34;use_chained_args_0_special_case&#34; in the core Catalyst docs under configuration:
<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/Catalyst#CONFIGURATION">https://metacpan.org/pod/Catalyst#CONFIGURATION</a></span>

&#34;Args&#34; or &#34;Args&#40;&#41;&#34; is always going to be a special low priority match, since its defined to be a catchall and since it matches a lot we force the dispatcher to match it last, otherwise it would always gobble up the requests.  That&#39;s why using Args instead of Arg&#40;0&#41; also seems to fix your test case.  Think of Args as similar to Args&#40;~&#41;.  I know people sometimes things Args and Args&#40;0&#41; are the same, but they are totally different.  Probably this is a bug in the interface engineering choices made early on that cause confusing today :&#41;
This action role probably needs a documentation patch to bring it up to modern times.  
Thanks!
jnap

 


    On Tuesday, December 1, 2015 3:59 PM, Thomas Sibley via RT &lt;bug-Catalyst-Runtime@rt.cpan.org&gt; wrote:
 

       Queue: Catalyst-Runtime
 Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=110009">https://rt.cpan.org/Ticket/Display.html?id=110009</a></span> &gt;

The first bad commit is:

commit 09914a47700308f8588e65eb4a29d378c192aee8
Author: John Napiorkowski &lt;jjn1056@yahoo.com&gt;
Date:  Wed Mar 25 10:09:53 2015 -0500

    do not change the best_action when args&#40;0&#41; if current best_action is also args&#40;0&#41;


  
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;01&nbsp;19:29:05&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;01&nbsp;23:43:22&nbsp;2015</span>
    <span class="description">tsibley [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #110009] Args&#40;0&#41; regression with ActionRole::MatchRequestAccepts</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 01 Dec 2015 20:42:43 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Catalyst-Runtime [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Thomas Sibley &lt;tsibley [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 12/01/2015 04:29 PM, jjn1056@yahoo.com via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This was a change in Catalyst around version 5.9008x where we
&gt; normalized the priority of actions when several actions could match
&gt; as in the example you&#39;ve given.  Previously sometimes Catalyst would
&gt; start checking actions defined first, other times last.  In
&gt; particular the case Args&#40;0&#41; was acting differently from all other
&gt; types of action definitions.  We changed this to always start
&gt; matching the last action, so that is breaking your example.
</div>
Ah, I see.  Given this, it seems like on &gt;=5.90085, I can move my
fallback to be defined first to fix the problem.  This works because
when the other actions with an Accept&#40;&#41; match, they&#39;ll be after the
fallback and the last one &#40;of two, in my case&#41; will be chosen.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If you have code that relied on the old behavior and change change 
&gt; the action order, there is a global catalyst configuration option to 
&gt; re-enable the legacy behavior, see &#34;use_chained_args_0_special_case&#34; 
&gt; in the core Catalyst docs under configuration: 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/Catalyst#CONFIGURATION">https://metacpan.org/pod/Catalyst#CONFIGURATION</a></span>
</div>
Thanks for the pointer. I can change it, so I&#39;d rather future-proof the
code than set a compat option.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#34;Args&#34; or &#34;Args&#40;&#41;&#34; is always going to be a special low priority 
&gt; match, since its defined to be a catchall and since it matches a lot 
&gt; we force the dispatcher to match it last, otherwise it would always 
&gt; gobble up the requests.  That&#39;s why using Args instead of Arg&#40;0&#41;
&gt; also seems to fix your test case.  Think of Args as similar to
&gt; Args&#40;~&#41;.  I know people sometimes things Args and Args&#40;0&#41; are the
&gt; same, but they are totally different.
</div>
Yep, I&#39;m well aware that Args and Args&#40;0&#41; are very different.  The thing
is, I don&#39;t want my MatchRequestAccepts fallback to match Args.  I want
it to match Args&#40;0&#41;, like all the other actions for that endpoint.
Unlike in the test example, my real fallback isn&#39;t some error response,
it&#39;s a response with a default content type.  I&#39;m not keen on permitting
random trailing args to get a successful response even if they&#39;re
unlikely to interfere with other actions.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This action role probably needs a documentation patch to bring it up
&gt; to modern times.
</div>
What would that doc patch look like?  Is it as simple as moving the
fallback to be defined first?

BTW, while I have your attention, any chance of this getting merged?
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=107786">https://rt.cpan.org/Ticket/Display.html?id=107786</a></span>  :-&#41;
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
