<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #61744 for Apache2-Controller: Cookie caching bug</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #61744 for Apache2-Controller: Cookie caching bug</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Apache2-Controller">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Apache2-Controller">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Apache2-Controller">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Apache2-Controller">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Apache2-Controller">Apache2-Controller CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">61744</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Apache2-Controller">Apache2-Controller</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">MARKLE [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
arkadius.litwinczuk [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
scott [...] hnsc.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-222752-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
1.000.000</li>
<li>
1.000.001</li>
<li>
1.000.010</li>
<li>
1.000.011</li>
<li>
1.000.100</li>
<li>
v1.0.101</li>
<li>
v1.0.110</li>
<li>
v1.0.110+b</li>
<li>
v1.0.110+c</li>
<li>
v1.0.110+d</li>
</ul>
    </td>
  </tr>
  <tr id="CF-222753-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




Apache2-Controller-v1.0.111+beta1.tar.gz<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/902518/468155/Apache2-Controller-v1.0.111%2Bbeta1.tar.gz">
Thu Feb 24 03:42:00 2011 (95.8k) by MARKLE [...] cpan.org
</a>
</font></li>
</ul>


session.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/914478/474356/session.t">
Fri Mar 25 16:22:46 2011 (3.9k) by MARKLE [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=61744">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-837519" href="/Public/Bug/Display.html?id=61744#txn-837519">#</a>      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;29&nbsp;04:20:41&nbsp;2010</span>
    <span class="description">arkadius.litwinczuk [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Coockie caching bug</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/837519/433880/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/433880">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 484b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, 

we use A2C for a application, and I noted a strange behavior. The IE
under some of our win 7 Builds seem to send expired cookies to the
server in some cases.
We use file as storage for the Session data, and it looks to me that a
expired cookie results in a Internal Server Error of the Apache. 
In my eyes this is not really a A2C bug but it would be great to fix it
so a new session is started, in this case and not an Internal Server
Error occurs. 

Kind Regards,

Arkadius 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-837794" href="/Public/Bug/Display.html?id=61744#txn-837794">#</a>      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;29&nbsp;13:13:57&nbsp;2010</span>
    <span class="description">MARKLE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/837794/434019/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/434019">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 336b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Wow, someone uses it for a real live application?  I&#39;m so stoked. 
You&#39;ve made my day.

I don&#39;t have any Windows instance that I can use to test this.  If you
can duplicate the problem, can you init Log::Log4perl in apache startup
and look at the debugging log?  See the startup settings in t/conf for
how to do this.

Thanks!  --mark--
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-837796" href="/Public/Bug/Display.html?id=61744#txn-837796">#</a>      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;29&nbsp;13:14:00&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-839102" href="/Public/Bug/Display.html?id=61744#txn-839102">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;04&nbsp;06:58:12&nbsp;2010</span>
    <span class="description">arkadius.litwinczuk [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> arkadius.litwinczuk [...] gmail.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/839102/434569/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/434569">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 793b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Mark, 

sorry can&#39;t get you the logfiles but i know the problem by now :&#41;. Take
a look  at <span class="clickylink"><a target="new" rel="nofollow" href="http://comments.gmane.org/gmane.comp.apache.apreq/4477">http://comments.gmane.org/gmane.comp.apache.apreq/4477</a></span> . 

The fix should look like this:
my $cookies;
eval { $cookies = Apache2::Cookie-&gt;fetch&#40;$r&#41; }
if &#40;$ &lt;at&gt; &#41; {
    $cookies = $ &lt;at&gt; -&gt;jar;
    $cookies-&gt;cookie_class&#40;&#39;Apache2::Cookie&#39;&#41;;
}

apperently apreq or rather Apache2::Cookie generates a cookie header
that contains &#34;1;&#34; and this causes a Apache2::Cookie parser error. The
eval above should at least fix the internal server error problem. 

And yeah it&#39;s a real life application, that might end up in a Opensource
project. Right now this is all internal =&#41; but i can&#39;t tell you what I
use it for. Still it&#39;s light waight and was my choice for this project
:&#41;.   

Kind regards,

Arkadius 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-839354" href="/Public/Bug/Display.html?id=61744#txn-839354">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;04&nbsp;18:46:51&nbsp;2010</span>
    <span class="description">MARKLE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/839354/434707/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/434707">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
$&lt;at&gt; s/b $@ i.e. $EVAL_ERROR ... that is incredibly strange that
Apache2::Cookie would be putting itself into $@ in the event of an error....

On Mon Oct 04 06:58:12 2010, rad1us wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; apperently apreq or rather Apache2::Cookie generates a cookie header
&gt; that contains &#34;1;&#34; and this causes a Apache2::Cookie parser error. The
&gt; eval above should at least fix the internal server error problem. 
</div>
From <span class="clickylink"><a target="new" rel="nofollow" href="http://comments.gmane.org/gmane.comp.apache.apreq/4477">http://comments.gmane.org/gmane.comp.apache.apreq/4477</a></span> :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Apreq doesn&#39;t generate cookies that would create a &#34;1&#34; in
&gt; the client&#39;s Cookie header.  It&#39;s some other application that
&gt; did that, but you can tell apreq to ignore the 1 by using eval:
</div>
I&#39;m hesitant to slap in a workaround for a buggy client, if that&#39;s the
reason it doesn&#39;t work.  

I&#39;d like to figure out what the actual problem is and fix that, if it is
a problem in A2C.

I&#39;m going to have a hard time debugging this without knowing the details
of the internal server error.  When you get that error, what gets
reported in the error log?  A2C should log at least part of the
exception via Apache2::Log::log_reason&#40;&#41;.

Are you sure you can&#39;t install Log::Log4perl and at least get me the A2C
exception and stack trace?

Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-864786" href="/Public/Bug/Display.html?id=61744#txn-864786">#</a>      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;06&nbsp;07:42:08&nbsp;2010</span>
    <span class="description">arkadius.litwinczuk [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> arkadius.litwinczuk [...] gmail.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/864786/447769/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/447769">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Mark, 

now I finally do have some details for you. The Problem is coused by a
invalid cookie, a single sign on system is bugged and writes a empty
cookie with only a &#39;;&#39; if there is not login at the time. libapreq2
correctly throws a parsing error &#34;TOKEN NOT PRESENT&#34; in the Apache
error.log when the invalid cookie is recieved, cousing then an internal
server error. 

So it is not really a problem with a2c but it could be prevented with an
eval for the cookie parsing, there is no need for an internal Server
error, only the cookie is invalid and should be droped. 

Would be very cool if you could patch this :&#41;.

Kind regards from Germany, 

 - Arkadius


Am Mo 04. Okt 2010, 18:46:51, MARKLE schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; $&lt;at&gt; s/b $@ i.e. $EVAL_ERROR ... that is incredibly strange that
&gt; Apache2::Cookie would be putting itself into $@ in the event of an
</div>error....
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; On Mon Oct 04 06:58:12 2010, rad1us wrote:
<div class="message-stanza open">&gt; &gt; apperently apreq or rather Apache2::Cookie generates a cookie header
&gt; &gt; that contains &#34;1;&#34; and this causes a Apache2::Cookie parser error. The
&gt; &gt; eval above should at least fix the internal server error problem. 
</div>&gt; 
&gt; From <span class="clickylink"><a target="new" rel="nofollow" href="http://comments.gmane.org/gmane.comp.apache.apreq/4477">http://comments.gmane.org/gmane.comp.apache.apreq/4477</a></span> :
<div class="message-stanza open">&gt; &gt; Apreq doesn&#39;t generate cookies that would create a &#34;1&#34; in
&gt; &gt; the client&#39;s Cookie header.  It&#39;s some other application that
&gt; &gt; did that, but you can tell apreq to ignore the 1 by using eval:
</div>&gt; 
&gt; I&#39;m hesitant to slap in a workaround for a buggy client, if that&#39;s the
&gt; reason it doesn&#39;t work.  
&gt; 
&gt; I&#39;d like to figure out what the actual problem is and fix that, if it is
&gt; a problem in A2C.
&gt; 
&gt; I&#39;m going to have a hard time debugging this without knowing the details
&gt; of the internal server error.  When you get that error, what gets
&gt; reported in the error log?  A2C should log at least part of the
&gt; exception via Apache2::Log::log_reason&#40;&#41;.
&gt; 
&gt; Are you sure you can&#39;t install Log::Log4perl and at least get me the A2C
&gt; exception and stack trace?
&gt; 
&gt; Mark
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-867429" href="/Public/Bug/Display.html?id=61744#txn-867429">#</a>      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;11&nbsp;10:56:58&nbsp;2010</span>
    <span class="description">MARKLE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/867429/449194/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/449194">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 120b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Yargh, I haven&#39;t had time to finish the OpenID redirect layer, but I&#39;ll
disable that and release a bugfix version today.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-872067" href="/Public/Bug/Display.html?id=61744#txn-872067">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;21&nbsp;18:58:50&nbsp;2010</span>
    <span class="description">MARKLE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/872067/451625/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/451625">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 801b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Yargh, I haven&#39;t had time to figure out the OpenID redirect layer yet,
&gt; but this has stalled too long.  I&#39;ll disable that module and release a
&gt; bugfix version today.
</div>
Today meaning 10 days later....

I think the solution I am uploading now will work, but I do not have a
test for it.  I also put in some Log::Log4perl statements to dump more
details about the error.  I was conservative and only skip errors when
the code is NOTOKEN.

It would be nice to have a test script that issues a request with a bad
cookie line... unfortunately Apache::Test uses LWP::UserAgent and I&#39;m
not sure how to trick HTTP::Cookies into sending a malformed cookie. 
Maybe setting the header in the $ua just before the request.  I am going
to go ahead and release 1.0.101, please let me know if it works. 

--mark--
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-872121" href="/Public/Bug/Display.html?id=61744#txn-872121">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;21&nbsp;19:40:15&nbsp;2010</span>
    <span class="description">MARKLE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/872121/451636/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/451636">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 302b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Someone on apreq-dev mentioned that this is usually a buggy app, not a
browser, that sends a bogus cookie, and that sometimes it is a good idea
to know this is happening.  I decided I would release another version
1.000.110 that does the cookie eval ONLY if new directive
A2C_Skip_Bogus_Cookies IS set.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-872317" href="/Public/Bug/Display.html?id=61744#txn-872317">#</a>      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;22&nbsp;10:02:22&nbsp;2010</span>
    <span class="description">arkadius.litwinczuk [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> arkadius.litwinczuk [...] gmail.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/872317/451741/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/451741">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 609b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, 

yeah it is a buggy app, RSA clear trust to be exact, but I can#t get a test script sorry. I&#39;ll be able 
to test it in January, thank you very much and I let you know how it goes :&#41;. 

Kind regards and merry christmas already! :&#41; 

- Arkadius

Am Di 21. Dez 2010, 19:40:15, MARKLE schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Someone on apreq-dev mentioned that this is usually a buggy app, not a
&gt; browser, that sends a bogus cookie, and that sometimes it is a good idea
&gt; to know this is happening.  I decided I would release another version
&gt; 1.000.110 that does the cookie eval ONLY if new directive
&gt; A2C_Skip_Bogus_Cookies IS set.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-902488" href="/Public/Bug/Display.html?id=61744#txn-902488">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;24&nbsp;01:40:06&nbsp;2011</span>
    <span class="description">MARKLE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Cookie caching bug</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/902488/468141/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/468141">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">From: Scott Hardin &lt;...&gt;
Cc: Arkadius Litwinczuk &lt;...&gt;
Subject: Bogus cookies and uncaught exceptions

Hi Mark,

regarding the new A2C_Skip_Bogus_Cookies option you added, I&#39;ve stumbled
across the problem that
the one eval isn&#39;t enough when dealing with these bogus cookies. I&#39;ve
added a couple more that I
need for my situation to work properly. Attached is a patch file of the
changes I made.

With best regards,

Scott



From: Scott T. Hardin &lt;...&gt;
Date: Wed, 23 Feb 2011 10:39:47 +0100
Subject: [PATCH] added more evals for bad cookies

The initial eval for bad cookies wasn&#39;t enough because there
are a couple of other spots that throw exceptions when bad
cookies were received.
---
 lib/Apache2/Controller/Methods.pm        |    3 ++-
 lib/Apache2/Controller/Session/Cookie.pm |    6 ++++--
 2 files changed, 6 insertions&#40;+&#41;, 3 deletions&#40;-&#41;

diff --git a/lib/Apache2/Controller/Methods.pm
b/lib/Apache2/Controller/Methods.pm
index 5746fb2..6fe0a8b 100644
--- a/lib/Apache2/Controller/Methods.pm
+++ b/lib/Apache2/Controller/Methods.pm
@@ -202,7 +202,8 @@ sub _cookie_jar_debug_sub {
     my $r = $self-&gt;{r};
     my $cookie = $r-&gt;headers_in-&gt;{Cookie};
     $cookie = $cookie ? qq{$cookie} : &#39;[no raw cookie string]&#39;;
-    my @cookie_names = map qq{$_}, $jar-&gt;cookies;
+    my @cookie_names;
+    eval { @cookie_names = map qq{$_}, $jar-&gt;cookies; };
     return sub {
         &#34;raw cookie header: $cookie\n&#34;
         .&#34;cookie names in jar:\n&#34;
diff --git a/lib/Apache2/Controller/Session/Cookie.pm
b/lib/Apache2/Controller/Session/Cookie.pm
index 7cfafe7..98583dc 100644
--- a/lib/Apache2/Controller/Session/Cookie.pm
+++ b/lib/Apache2/Controller/Session/Cookie.pm
@@ -83,7 +83,8 @@ sub get_session_id {
     my $jar = $self-&gt;get_cookie_jar&#40;&#41;;

     DEBUG &#34;looking for cookie name &#39;$cookie_name&#39;&#34;;
-    my $cookie = $jar-&gt;cookies&#40;$cookie_name&#41;;
+    my $cookie;
+    eval { $cookie = $jar-&gt;cookies&#40;$cookie_name&#41;; };

     DEBUG $cookie ? &#34;found cookie!&#34; : &#34;did not find cookie.&#34;;

@@ -97,7 +98,8 @@ sub get_session_id {
     }&#41; };

     # if the session_id does not pass signature, return nothing
-    my $valid_sig = $self-&gt;signature&#40;$sid&#41;;
+    my $valid_sig;
+    eval { $valid_sig = $self-&gt;signature&#40;$sid&#41;; };

     if &#40;$valid_sig ne $sig&#41; {
         WARN &#34;signature validation failed&#34;;
-- 
1.7.3
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-902492" href="/Public/Bug/Display.html?id=61744#txn-902492">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;24&nbsp;01:41:01&nbsp;2011</span>
    <span class="description">MARKLE [...] cpan.org -  Cc scott@hnsc.de added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-902493" href="/Public/Bug/Display.html?id=61744#txn-902493">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;24&nbsp;01:41:13&nbsp;2011</span>
    <span class="description">MARKLE [...] cpan.org -  Given to MARKLE</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-902494" href="/Public/Bug/Display.html?id=61744#txn-902494">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;24&nbsp;01:42:36&nbsp;2011</span>
    <span class="description">MARKLE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Cookie caching bug</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/902494/468143/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/468143">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 41b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you!  I will release a fix shortly.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-902496" href="/Public/Bug/Display.html?id=61744#txn-902496">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;24&nbsp;01:43:08&nbsp;2011</span>
    <span class="description">MARKLE [...] cpan.org -  Severity Wishlist changed to Normal</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-902497" href="/Public/Bug/Display.html?id=61744#txn-902497">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;24&nbsp;01:43:08&nbsp;2011</span>
    <span class="description">MARKLE [...] cpan.org -  Broken in 1.000.001 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-902498" href="/Public/Bug/Display.html?id=61744#txn-902498">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;24&nbsp;01:43:08&nbsp;2011</span>
    <span class="description">MARKLE [...] cpan.org -  Broken in 1.000.010 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-902499" href="/Public/Bug/Display.html?id=61744#txn-902499">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;24&nbsp;01:43:08&nbsp;2011</span>
    <span class="description">MARKLE [...] cpan.org -  Broken in 1.000.011 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-902500" href="/Public/Bug/Display.html?id=61744#txn-902500">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;24&nbsp;01:43:08&nbsp;2011</span>
    <span class="description">MARKLE [...] cpan.org -  Broken in 1.000.100 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-902501" href="/Public/Bug/Display.html?id=61744#txn-902501">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;24&nbsp;01:43:08&nbsp;2011</span>
    <span class="description">MARKLE [...] cpan.org -  Broken in v1.0.101 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-902502" href="/Public/Bug/Display.html?id=61744#txn-902502">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;24&nbsp;01:43:08&nbsp;2011</span>
    <span class="description">MARKLE [...] cpan.org -  Broken in v1.0.110 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-902503" href="/Public/Bug/Display.html?id=61744#txn-902503">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;24&nbsp;01:43:08&nbsp;2011</span>
    <span class="description">MARKLE [...] cpan.org -  Broken in v1.0.110+b added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-902504" href="/Public/Bug/Display.html?id=61744#txn-902504">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;24&nbsp;01:43:08&nbsp;2011</span>
    <span class="description">MARKLE [...] cpan.org -  Broken in v1.0.110+c added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-902505" href="/Public/Bug/Display.html?id=61744#txn-902505">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;24&nbsp;01:43:08&nbsp;2011</span>
    <span class="description">MARKLE [...] cpan.org -  Broken in v1.0.110+d added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-902506" href="/Public/Bug/Display.html?id=61744#txn-902506">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;24&nbsp;01:48:40&nbsp;2011</span>
    <span class="description">MARKLE [...] cpan.org -  Subject changed from &#39;Coockie caching bug&#39; to &#39;Cookie caching bug&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-902518" href="/Public/Bug/Display.html?id=61744#txn-902518">#</a>      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;24&nbsp;03:42:00&nbsp;2011</span>
    <span class="description">MARKLE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/902518/468154/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/468154">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 208b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Does this attached source archive work for you?  I refactored a few
things.  I should really write a test for this condition, when client
sends a bogus cookie header, with the directive set and not.  --mark--
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Apache2-Controller-v1.0.111+beta1.tar.gz</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/902518/468155/Apache2-Controller-v1.0.111%2Bbeta1.tar.gz">Download Apache2-Controller-v1.0.111+beta1.tar.gz</a><br />
<span class="downloadcontenttype">application/x-gzip 95.8k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-911348" href="/Public/Bug/Display.html?id=61744#txn-911348">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;17&nbsp;14:05:57&nbsp;2011</span>
    <span class="description">MARKLE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/911348/472774/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/472774">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 179b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Duh... I think I see how I can test this.  I just have to create a
cookie jar object that I plug in for LWP, then set the bogus value.  I
should be able to get to it this weekend.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-914478" href="/Public/Bug/Display.html?id=61744#txn-914478">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;25&nbsp;16:22:46&nbsp;2011</span>
    <span class="description">MARKLE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/914478/474355/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/474355">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 115b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hrmm, I can&#39;t reproduce this in 1.0.100 - doesn&#39;t it seem like this test
script should reproduce the bug?  --mark--
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> session.t</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/914478/474356/session.t">Download session.t</a><br />
<span class="downloadcontenttype">text/x-perl 3.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
use strict;
use warnings FATAL =&gt; &#39;all&#39;;

use Apache::Test;
use Apache::TestUtil;
use Apache::TestRequest qw&#40; GET_BODY GET_STR GET_HEAD &#41;;
use FindBin;

use Apache2::Const -compile =&gt; qw&#40;
    HTTP_OK
&#41;;

use lib &#34;$FindBin::Bin/lib&#34;;
use Apache2::Controller::Test::Funk qw&#40; diag &#41;;
use YAML::Syck;
use URI::Escape;

my $cookie_name = &#39;testapp_sessid&#39;;
my $cookie_path = &#39;/session&#39;;

my @CHARS = &#40;&#39;A&#39;..&#39;Z&#39;, &#39;a&#39;..&#39;z&#39;, 0 .. 9&#41;;
my %TD = &#40;
    foo     =&gt; {
        boz     =&gt; [qw&#40; noz schnoz &#41;]
    },
    bar     =&gt; &#39;biz&#39;,
    floobie =&gt; join&#40;&#39;&#39;, map $CHARS[int&#40;rand @CHARS&#41;], 1 .. 50&#41;,
&#41;;
my $testdata_dump = Dump&#40;\%TD&#41;;

use HTTP::Cookies;
my $jar = HTTP::Cookies-&gt;new&#40;&#41;;

plan tests =&gt; 12, need_lwp;
my $ua = Apache::TestRequest::user_agent&#40;
    cookie_jar              =&gt; $jar, 
    requests_redirectable   =&gt; 0,
&#41;;
Apache::TestRequest::lwp_debug&#40;2&#41;;

use TestApp::Session::Controller;

my $url = &#34;/session&#34;;

my $get = &#34;$url/set?data=&#34;.uri_escape&#40;$testdata_dump&#41;;
my $response = GET_BODY $get;

ok t_cmp&#40;$response, &#34;Set session data.\n&#34;, &#34;Set data.&#34;&#41;;

$response = GET_BODY &#34;$url/read&#34;;
my $session = Load&#40;$response&#41;;
my $response_testdata = $session-&gt;{testdata};

ok t_cmp&#40;Dump&#40;$response_testdata&#41;, $testdata_dump, &#34;Read data.&#34;&#41;;

# what about a redirect?  if i save something in a controller
# that returns redirect, does it actually get saved?
my $redirect = GET_HEAD &#34;$url/redirect&#34;;
ok t_cmp&#40;$redirect, qr{ ^ \# Location: \s+ \Q$url\E/read }mxs, &#39;Redirect ok&#39;&#41;;

my $redirect_set_data = GET_BODY &#34;$url/read&#34;;
$session = Load&#40;$redirect_set_data&#41;;
$response_testdata = Dump&#40;$session-&gt;{testdata}&#41;;

ok t_cmp&#40;$response_testdata, $testdata_dump, 
    &#34;Read data after redirect - did not save.&#34;&#41;;

my $error = GET_HEAD &#34;$url/server_error&#34;;
ok t_cmp&#40;$error, qr{ ^ \# Title: \s+ 500 \s+ Internal \s+ Server \s+ Error }mxs,
    &#39;error page ok&#39; &#41;;

# check to make sure the forced-save flag works
my $redirect_force_save = GET_HEAD &#34;$url/redirect_force_save&#34;;
ok t_cmp&#40;$redirect, qr{ ^ \# Location: \s+ \Q$url\E/read }mxs, 
    &#39;Redirect &#40;force save&#41; ok&#39;&#41;;

$TD{redirect_data} = &#39;redirect data test&#39;;
$testdata_dump = Dump&#40;\%TD&#41;;

my $redirect_forced_data = GET_BODY &#34;$url/read&#34;;
$session = Load&#40;$redirect_forced_data&#41;;
$response_testdata = Dump&#40;$session-&gt;{testdata}&#41;;

ok t_cmp&#40;$response_testdata, $testdata_dump, 
    &#34;Read data after redirect with forced save - saved data.&#34;&#41;;

diag&#40;&#34;HORTA: jar is &#39;$jar&#39;:\n&#34;.Dump&#40;$jar&#41;.$jar-&gt;as_string&#41;;

my $error_data_set = GET_BODY &#34;$url/read&#34;;
$session = Load&#40;$error_data_set&#41;;
$response_testdata = Dump&#40;$session-&gt;{testdata}&#41;;
#diag&#40;$response_testdata&#41;;


ok t_cmp&#40;$response_testdata, $testdata_dump, &#34;Read data after error unchanged.&#34;&#41;;

my $old_sess_id = q{};
$jar-&gt;scan&#40;sub { 
    diag&#40;&#34;lame:\n&#34;.Dump&#40;\@_&#41;&#41;;
    $old_sess_id ||= $_[2];
}&#41;; # See HTTP::Cookie

diag&#40;&#34;session id was &#39;$old_sess_id&#39;&#34;&#41;;
diag&#40;&#34;set raw cookie val to 1 in headers_out &#40;invalid cookie freeze/thaw bug&#41;&#34;&#41;;
my &#40;$cookie_domain&#41; = keys %{$jar-&gt;{COOKIES}}; # &#40;&#39;highlander.therecanbeonly1.com&#39;&#41;
diag&#40;&#34;cookie domain is &#39;$cookie_domain&#39;&#34;&#41;;

my $full_url = Apache::TestRequest::module2url&#40;&#39;&#39;, { path =&gt; &#34;$url/read&#34; }&#41;;
diag&#40;&#34;full_url: &#39;$full_url&#39;&#34;&#41;;

$response = $ua-&gt;get&#40;$full_url&#41;;
ok t_cmp&#40;$response-&gt;code, Apache2::Const::HTTP_OK, &#39;2xcheck response is HTTP_OK&#39;&#41;;

my $doublecheck_sess_id = q{};
$jar-&gt;scan&#40;sub { $doublecheck_sess_id ||= $_[2] }&#41;;
diag&#40;&#39;double-check&#39;&#41;;
ok t_cmp&#40;$old_sess_id, $doublecheck_sess_id,
    &#39;double-check sess id is the same across requests&#39;,
&#41;;

diag&#40;&#34;SPOCK: &#39;$ua&#39;&#34;&#41;;
$jar-&gt;clear&#40;&#41;;
diag&#40;&#34;KIRK: &#34;.Dump&#40;$jar&#41;&#41;;

$response = $ua-&gt;get&#40;$full_url, &#39;Set-Cookie3&#39; =&gt; qq{1; path=&#34;$cookie_path&#34;; domain=$cookie_domain; discard; version=0}&#41;;

diag&#40;&#34;response code:\n&#34;.$response-&gt;code&#41;;

diag&#40;&#34;as_string:\n&#34;.$response-&gt;as_string&#41;;

diag&#40;&#34;UHURA: &#34;.Dump&#40;$jar&#41;&#41;;

my $new_sess_id = q{};
$jar-&gt;scan&#40;sub { $new_sess_id ||= $_[2] }&#41;;

ok t_cmp&#40;$response-&gt;code, Apache2::Const::HTTP_OK, 
    &#39;response after bad cookie is HTTP_OK&#39;,
&#41;;

ok !t_cmp&#40;$new_sess_id, $old_sess_id, &#39;new sess id is different after bad cookie&#39;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-920461" href="/Public/Bug/Display.html?id=61744#txn-920461">#</a>      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;07&nbsp;23:11:04&nbsp;2011</span>
    <span class="description">MARKLE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/920461/477562/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/477562">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 143b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Should be fixed in 1.0.111 uploading now.  Not sure the test actually
covers the case in question.  If you have any trouble please let me know.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-920463" href="/Public/Bug/Display.html?id=61744#txn-920463">#</a>      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;07&nbsp;23:11:05&nbsp;2011</span>
    <span class="description">MARKLE [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.885875</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
