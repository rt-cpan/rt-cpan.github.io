<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #73998 for Devel-Size: t/globs.t fails under bleadperl 5.15.6</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #73998 for Devel-Size: t/globs.t fails under bleadperl 5.15.6</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Devel-Size/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Devel-Size/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Devel-Size/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Devel-Size/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Devel-Size">Devel-Size CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">73998</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Devel-Size/Active/">Devel-Size</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
d.thomas [...] its.uq.edu.au

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-11198-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-11199-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;14&nbsp;18:31:45&nbsp;2012</span>
    <span class="description">d.thomas [...] its.uq.edu.au -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> t/globs.t fails under bleadperl 5.15.6</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Devel-Size-0.77, perl-5.15.6, RHEL6
this is first time I tried building under any 5.15.x


root@minneola# make test
PERL_DL_NONLAZY=1 /opt/perl/uq.is.perl.rhel6-5.15.6-20120115/bin/perl5.15.6 &#34;-
MExtUtils::Command::MM&#34; &#34;-e&#34; &#34;test_harness&#40;0, &#39;blib/lib&#39;, &#39;blib/arch&#39;&#41;&#34; t/*.t
t/basic.t ..... ok     
t/code.t ...... ok     
t/globs.t ..... 1/44 
#   Failed test &#39;CV grew by expected amount for SCALAR&#39;
#   at t/globs.t line 132.
#          got: &#39;56626&#39;
#     expected: &#39;56586&#39;
# Looks like you failed 1 test of 44.
t/globs.t ..... Dubious, test returned 1 &#40;wstat 256, 0x100&#41;
Failed 1/44 subtests 
t/magic.t ..... ok     
t/pod.t ....... ok   
t/pod_cov.t ... ok   
t/pvbm.t ...... ok   
t/recurse.t ... ok     
t/warnings.t .. skipped: no Test::PerlRun found
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;09&nbsp;18:08:07&nbsp;2012</span>
    <span class="description">RURBAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have a patch for that but I do not fully understand why suddenly with 
5.15.6 the CV shared 5 pointers less. Nick should now and adjust it.

-- 
Reini Urban
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Devel-Size-0.77.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -bu Devel-Size-0.77/CHANGES~ Devel-Size-0.77/CHANGES
--- Devel-Size-0.77/CHANGES~	2012-02-09 15:28:04.968333400 -0600
+++ Devel-Size-0.77/CHANGES	2012-02-09 16:28:22.979078901 -0600
@@ -1,5 +1,8 @@
 Revision history for Perl extension Devel::Size.
 
+0.78 2012-02-09 rurban
+ * 5.15.6 CV shares now 5 pointers with GvGP &#40;? rurban thinks so&#41;. [CPAN #73998]
+
 0.77 2011-05-16 nicholas
  [no changes]
 
diff -bu Devel-Size-0.77/t/globs.t~ Devel-Size-0.77/t/globs.t
--- Devel-Size-0.77/t/globs.t~	2012-02-09 15:28:04.972333362 -0600
+++ Devel-Size-0.77/t/globs.t	2012-02-09 16:24:57.552966767 -0600
@@ -129,6 +129,8 @@
 	cmp_ok&#40;$gv_now_total_size, &#39;&gt;&#39;, $gv_was_total_size,
 	       &#34;GV total size grew for $type&#34;&#41;;
     } else {
+        #diag &#34;$cv_now_size, $cv_was_size, $new_thing_size&#34; if $type eq &#39;SCALAR&#39;;
+	$cv_now_size -= $Config{ptrsize}*5 if $type eq &#39;SCALAR&#39; and $] &gt; 5.015006;
 	is&#40;$cv_now_size, $cv_was_size + $new_thing_size,
 	   &#34;CV grew by expected amount for $type&#34;&#41;
 	    	    unless $Config{useithreads};
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;09&nbsp;18:08:08&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;09&nbsp;18:20:16&nbsp;2012</span>
    <span class="description">d.thomas [...] its.uq.edu.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73998] t/globs.t fails under bleadperl 5.15.6 </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 9 Feb 2012 23:20:03 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;&lt;bug-Devel-Size [...] rt.cpan.org&gt;&#34; &lt;bug-Devel-Size [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Danny Thomas &lt;d.thomas [...] its.uq.edu.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On 10/02/2012, at 9:08 AM, Reini Urban via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have a patch for that but I do not fully understand why suddenly with 
&gt; 5.15.6 the CV shared 5 pointers less. Nick should now and adjust it.
</div>so it looks like an issue with the test which is reassuring
rather than something more fundamental.

BTW I only started building against bleadperl with 5.15.5
so it might have been there earlier.

Along with other updates including YAML, I think there&#39;s
very few of modules I built with still having a problem.

thanks
Danny
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;09&nbsp;18:53:29&nbsp;2012</span>
    <span class="description">RURBAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Feb 09 18:08:07 2012, RURBAN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have a patch for that but I do not fully understand why suddenly with 
&gt; 5.15.6 the CV shared 5 pointers less. Nick should now and adjust it.
</div>

Nope, this version failed on 32bit use64bitint. And the explanation is 
now a bit weirder.

Revised patch attached
-- 
Reini Urban
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Devel-Size-0.77.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">difforig Devel-Size-0.77

diff -u  Devel-Size-0.77/CHANGES.orig
--- Devel-Size-0.77/CHANGES.orig	2012-02-09 17:35:47.988927215 -0600
+++ Devel-Size-0.77/CHANGES	2012-02-09 17:36:45.224378224 -0600
@@ -1,5 +1,8 @@
 Revision history for Perl extension Devel::Size.
 
+0.78 2012-02-09 16:27:55 rurban
+ * 5.15.6 CV shares now 4 IV and a pointer with GvGP [CPAN #73998] &#40;? rurban thinks so&#41;
+
 0.77 2011-05-16 nicholas
  [no changes]
 
diff -u  Devel-Size-0.77/t/globs.t.orig
--- Devel-Size-0.77/t/globs.t.orig	2012-02-09 17:35:21.901177419 -0600
+++ Devel-Size-0.77/t/globs.t	2012-02-09 17:23:57.803732742 -0600
@@ -129,9 +129,15 @@
 	cmp_ok&#40;$gv_now_total_size, &#39;&gt;&#39;, $gv_was_total_size,
 	       &#34;GV total size grew for $type&#34;&#41;;
     } else {
-	is&#40;$cv_now_size, $cv_was_size + $new_thing_size,
-	   &#34;CV grew by expected amount for $type&#34;&#41;
-	    	    unless $Config{useithreads};
+        unless &#40;$Config{useithreads}&#41; {
+            diag &#34;$cv_now_size, $cv_was_size, $new_thing_size&#34; if $type eq &#39;SCALAR&#39;;
+	    if &#40;$type eq &#39;SCALAR&#39; and $] &gt; 5.015006&#41; {
+	      $cv_now_size -= $Config{ptrsize}*5 ;
+	      $cv_now_size -= 4 if $Config{ptrsize} == 4 and $Config{ivsize} == 8;
+	    }
+	    is&#40;$cv_now_size, $cv_was_size + $new_thing_size,
+	       &#34;CV grew by expected amount for $type&#34;&#41;
+        }
 	is&#40;$io_now_size, $io_was_size + $new_thing_size,
 	   &#34;IO total_size grew by expected amount for $type&#34;&#41;;
 	is&#40;$gv_now_size, $gv_was_size + $new_thing_size,
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;10&nbsp;12:03:24&nbsp;2012</span>
    <span class="description">nwc10+please+use+perlbug+for+perl+queries [...] colon.colondot.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Feb 09 18:53:29 2012, RURBAN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Feb 09 18:08:07 2012, RURBAN wrote:
<div class="message-stanza open">&gt; &gt; I have a patch for that but I do not fully understand why suddenly with 
&gt; &gt; 5.15.6 the CV shared 5 pointers less. Nick should now and adjust it.
</div>&gt; 
&gt; 
&gt; Nope, this version failed on 32bit use64bitint. And the explanation is 
&gt; now a bit weirder.
&gt; 
&gt; Revised patch attached
</div>
Thanks for trying to nail it. I had a long look, and the explanation
seems to be much much stranger than this.

If one changes the order of these three in globs.t:

gv_grew&#40;&#39;glipp&#39;, &#39;zok&#39;, &#39;no strict &#34;vars&#34;; $zok = undef; 1&#39;, &#39;SCALAR&#39;&#41;;
gv_grew&#40;&#39;bang&#39;, &#39;boff&#39;, &#39;no strict &#34;vars&#34;; @boff = &#40;&#41;; 1&#39;, &#39;ARRAY&#39;&#41;;
gv_grew&#40;&#39;clange&#39;, &#39;sock&#39;, &#39;no strict &#34;vars&#34;; %sock = &#40;&#41;; 1&#39;, &#39;HASH&#39;&#41;;

then it&#39;s always the *first* one that fails.

I bisected the blead commit that caused the failure using this shell
script to unpack Devel::Size into the perl tree before building perl:

#!/bin/sh
git clean -dxf

# If you get &#39;./makedepend: 1: Syntax error: Unterminated quoted
# string&#39; when bisecting versions of perl older than 5.9.5 this hack
# will work around the bug in makedepend.SH which was fixed in
# version 96a8704c. Make sure to comment out &#39;git checkout makedepend.SH&#39;
# below too.
git show blead:makedepend.SH &gt; makedepend.SH

&#40;cd ext &#38;&#38; tar xfz
/Volumes/Nonsense/cpan/authors/id/N/NW/NWCLARK/Devel-Size-0.77.tar.gz &#38;&#38;
mv Devel-Size-0.77 Devel-Size&#41;

# If you can use ccache, add -Dcc=ccache\ gcc -Dld=gcc to the Configure line
# if Encode is not needed for the test, you can speed up the bisect by
# excluding it from the runs with -Dnoextensions=Encode
./Configure -Dusedevel -Dcc=ccache\ gcc -Dld=gcc -Dnoextensions=Encode -de
test -f config.sh || exit 125
# Correct makefile for newer GNU gcc
perl -ni -we &#39;print unless /&lt;&#40;?:built-in|command&#41;/&#39; makefile x2p/makefile
# if you just need miniperl, replace test_prep with miniperl
make -j3 test_prep
[ -x ./perl ] || exit 125
./perl -Ilib ext/Devel-Size/t/globs.t
ret=$?
[ $ret -gt 127 ] &#38;&#38; ret=127
# git checkout makedepend.SH
git clean -dxf
exit $ret


Turns out that it&#39;s this commit

<span class="clickylink"><a target="new" rel="nofollow" href="http://perl5.git.perl.org/perl.git/commit/b50b20584a1bbc1a">http://perl5.git.perl.org/perl.git/commit/b50b20584a1bbc1a</a></span>

author  Father Chrysostomos &lt;sprout@cpan.org&gt;   
Wed, 7 Dec 2011 02:12:14 +0000 &#40;18:12 -0800&#41;

Implement new ‘use 5.xxx&#39; plan

• Version declarations now unload all features before loading the
  specified feature bundle.
• Explicit use/no strict overrides any implicit strict-loading done by
  version declarations, whether before or after use of strict.pm.
• ‘use 5.01’ or earlier disables any implicitly-enabled strictures.


which really wasn&#39;t what I expected.

After a fair amount of grovelling with gdb, the extra 40 bytes turns
out to be sizeof&#40;struct xpvhv_aux&#41;, added by line 766:

        st-&gt;total_size += sizeof&#40;struct xpvhv_aux&#41;;

After a lot more head scratching, this is because that commit changes
things so that use strict; will assign to %^H. Before:

$ /Users/nick/Sandpit/snap-v5.15.5-305*/bin/perl5.15.5 -le &#39;use strict;
BEGIN {print foreach keys %^H}&#39;

After:

$ /Users/nick/Sandpit/snap-v5.15.5-306*/bin/perl5.15.5 -le &#39;use strict;
BEGIN {print foreach keys %^H}&#39;
strict/subs
strict/refs
strict/vars


This in turn matters, because the eval in gv_grew&#40;&#41; in globs.t:

    eval $code or die &#34;For $type, can&#39;t execute q{$code}: $@&#34;;


a: now has a private copy of %^H in the optree
b: now copies that at runtime onto the stack for the eval

and to copy a hash requires a hash iterator, so the *first* time the
hash is copied its size is increased to hold the iterator. Which
happens after this line:

    my $cv_was_size = size&#40;do {no strict &#39;refs&#39;; \&#38;$sub}&#41;;


This makes a difference because the total size of anything that can
reach \&#38;gv_grew will include this extra size. In this case, this means
that if the code for generate_glob&#40;&#41; is within gv_grew&#40;&#41; [as it used
to be], then the generated subroutine&#39;s CvOUTSIDE points to an anon
sub whose CvOUTSIDE points to gv_grew&#40;&#41;. Which means that the
generated subroutine gets &#34;bigger&#34; simply as a side effect of the eval
executing.

The solution is to put the eval that creates the subroutine into a
different scope, so that its outside pointer chain doesn&#39;t include
gv_grew&#40;&#41;. Hence it&#39;s now broken out into generate_glob


I was about to roll up a dev release with a changed t/globs.t, but
I&#39;ve found that I&#39;m getting an assertion failure from t/magic.t in
5.8.0-5.8.2, which I&#39;m going to see if I can fix too.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> globs.t.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/t/globs.t b/t/globs.t
index ae32309..11c0441 100644
--- a/t/globs.t
+++ b/t/globs.t
@@ -74,12 +74,35 @@ $SIG{__WARN__} = sub {
        - $shared_gvname, &#39;GV copies point back to the real GV&#39;&#41;;
 }
 
-sub gv_grew {
-    my &#40;$sub, $glob, $code, $type&#41; = @_;
+# As of blead commit b50b20584a1bbc1a, Implement new &#39;use 5.xxx&#39; plan,
+# use strict; will write to %^H. In turn, this causes the eval $code below
+# to have compile with a pp_hintseval with a private copy of %^H in the
+# optree. In turn, this private value is copied on op execution and put on
+# the stack. The act of copying requires a hash iterator, and the *first*
+# time the op is encountered its private HV doesn&#39;t have space for one, so
+# it&#39;s expanded to hold one. Which happens after $cv_was_size is assigned to.
+# Which matters, because it means that the total size of anything that can
+# reach \&#38;gv_grew will include this extra size. In this case, this means that
+# if the code for generate_glob&#40;&#41; is within gv_grew&#40;&#41; [as it used to be],
+# then the generated subroutine&#39;s CvOUTSIDE points to an anon sub whose
+# CvOUTSIDE points to gv_grew&#40;&#41;. Which means that the generated subroutine
+# gets &#34;bigger&#34; simply as a side effect of the eval executing.
+
+# The solution is to put the eval that creates the subroutine into a different
+# scope, so that its outside pointer chain doesn&#39;t include gv_grew&#40;&#41;. Hence
+# it&#39;s now broken out into generate_glob&#40;&#41;:
+
+sub generate_glob {
+    my &#40;$sub, $glob&#41; = @_;
     # unthreaded, this gives us a way of getting to sv_size&#40;&#41; from one of the
     # other *_size&#40;&#41; functions, with a GV that has nothing allocated from its
     # GP:
     eval &#34;sub $sub { *$glob }; 1&#34; or die $@;
+}
+
+sub gv_grew {
+    my &#40;$sub, $glob, $code, $type&#41; = @_;
+    generate_glob&#40;$sub, $glob&#41;;
     # Assigning to IoFMT_GV&#40;&#41; also provides this, threaded and unthreaded:
     $~ = $glob;
     
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;10&nbsp;15:08:01&nbsp;2012</span>
    <span class="description">nwc10+please+use+perlbug+for+perl+queries [...] colon.colondot.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Jan 14 18:31:45 2012, d.thomas@its.uq.edu.au wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Devel-Size-0.77, perl-5.15.6, RHEL6
&gt; this is first time I tried building under any 5.15.x
&gt; 
&gt; 
&gt; root@minneola# make test
&gt; PERL_DL_NONLAZY=1 /opt/perl/uq.is.perl.rhel6-5.15.6-
&gt; 20120115/bin/perl5.15.6 &#34;-
&gt; MExtUtils::Command::MM&#34; &#34;-e&#34; &#34;test_harness&#40;0, &#39;blib/lib&#39;,
&gt; &#39;blib/arch&#39;&#41;&#34; t/*.t
&gt; t/basic.t ..... ok
&gt; t/code.t ...... ok
&gt; t/globs.t ..... 1/44
&gt; #   Failed test &#39;CV grew by expected amount for SCALAR&#39;
&gt; #   at t/globs.t line 132.
&gt; #          got: &#39;56626&#39;
&gt; #     expected: &#39;56586&#39;
&gt; # Looks like you failed 1 test of 44.
&gt; t/globs.t ..... Dubious, test returned 1 &#40;wstat 256, 0x100&#41;
&gt; Failed 1/44 subtests
</div>
Thanks for the report. I&#39;ve just uploaded a dev release, 0.77_50, which
I think should fix this.

Nicholas Clark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;19&nbsp;01:38:52&nbsp;2012</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Feb 10 15:08:01 2012, NWCLARK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sat Jan 14 18:31:45 2012, d.thomas@its.uq.edu.au wrote:
<div class="message-stanza open">&gt; &gt; Devel-Size-0.77, perl-5.15.6, RHEL6
&gt; &gt; this is first time I tried building under any 5.15.x
&gt; &gt; 
&gt; &gt; 
&gt; &gt; root@minneola# make test
&gt; &gt; PERL_DL_NONLAZY=1 /opt/perl/uq.is.perl.rhel6-5.15.6-
&gt; &gt; 20120115/bin/perl5.15.6 &#34;-
&gt; &gt; MExtUtils::Command::MM&#34; &#34;-e&#34; &#34;test_harness&#40;0, &#39;blib/lib&#39;,
&gt; &gt; &#39;blib/arch&#39;&#41;&#34; t/*.t
&gt; &gt; t/basic.t ..... ok
&gt; &gt; t/code.t ...... ok
&gt; &gt; t/globs.t ..... 1/44
&gt; &gt; #   Failed test &#39;CV grew by expected amount for SCALAR&#39;
&gt; &gt; #   at t/globs.t line 132.
&gt; &gt; #          got: &#39;56626&#39;
&gt; &gt; #     expected: &#39;56586&#39;
&gt; &gt; # Looks like you failed 1 test of 44.
&gt; &gt; t/globs.t ..... Dubious, test returned 1 &#40;wstat 256, 0x100&#41;
&gt; &gt; Failed 1/44 subtests
</div>&gt; 
&gt; Thanks for the report. I&#39;ve just uploaded a dev release, 0.77_50, which
&gt; I think should fix this.
</div>
 * t/globs.t was failing on 5.15.6 and later due to side effects of a change
   to strict.pm [CPAN #73998]

Tests pass for me now, probably because the strict hints were moved from %^H to $^H, for 
Safe&#40;ty&#41;’s sake.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;19&nbsp;01:39:14&nbsp;2012</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Apr 19 01:38:52 2012, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Feb 10 15:08:01 2012, NWCLARK wrote:
<div class="message-stanza open">&gt; &gt; On Sat Jan 14 18:31:45 2012, d.thomas@its.uq.edu.au wrote:
<div class="message-stanza open">&gt; &gt; &gt; Devel-Size-0.77, perl-5.15.6, RHEL6
&gt; &gt; &gt; this is first time I tried building under any 5.15.x
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; root@minneola# make test
&gt; &gt; &gt; PERL_DL_NONLAZY=1 /opt/perl/uq.is.perl.rhel6-5.15.6-
&gt; &gt; &gt; 20120115/bin/perl5.15.6 &#34;-
&gt; &gt; &gt; MExtUtils::Command::MM&#34; &#34;-e&#34; &#34;test_harness&#40;0, &#39;blib/lib&#39;,
&gt; &gt; &gt; &#39;blib/arch&#39;&#41;&#34; t/*.t
&gt; &gt; &gt; t/basic.t ..... ok
&gt; &gt; &gt; t/code.t ...... ok
&gt; &gt; &gt; t/globs.t ..... 1/44
&gt; &gt; &gt; #   Failed test &#39;CV grew by expected amount for SCALAR&#39;
&gt; &gt; &gt; #   at t/globs.t line 132.
&gt; &gt; &gt; #          got: &#39;56626&#39;
&gt; &gt; &gt; #     expected: &#39;56586&#39;
&gt; &gt; &gt; # Looks like you failed 1 test of 44.
&gt; &gt; &gt; t/globs.t ..... Dubious, test returned 1 &#40;wstat 256, 0x100&#41;
&gt; &gt; &gt; Failed 1/44 subtests
</div>&gt; &gt;
&gt; &gt; Thanks for the report. I&#39;ve just uploaded a dev release, 0.77_50,
</div>&gt; which
<div class="message-stanza open">&gt; &gt; I think should fix this.
</div>&gt; 
&gt;  * t/globs.t was failing on 5.15.6 and later due to side effects of a
&gt; change
&gt;    to strict.pm [CPAN #73998]
&gt; 
&gt; Tests pass for me now,
</div>
I meant with 0.77 and perl 5.15.9.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; probably because the strict hints were moved
&gt; from %^H to $^H, for
&gt; Safe&#40;ty&#41;’s sake.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;15&nbsp;16:15:11&nbsp;2012</span>
    <span class="description">TIMB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Test results look good so I&#39;m closing this.
Great work.
Tim [just being a janitor]
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;15&nbsp;16:15:12&nbsp;2012</span>
    <span class="description">TIMB [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
