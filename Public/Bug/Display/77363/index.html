<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #77363 for XML-Writer: ENCODING is misleading, xmlDecl&#40;&#41; needs its own new&#40;&#41; setter</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #77363 for XML-Writer: ENCODING is misleading, xmlDecl&#40;&#41; needs its own new&#40;&#41; setter</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=XML-Writer">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=XML-Writer">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=XML-Writer">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=XML-Writer">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-Writer">XML-Writer CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">77363</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=XML-Writer">XML-Writer</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dmuey [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-37702-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.615    </td>
  </tr>
  <tr id="CF-37703-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=77363">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1082418" href="/Public/Bug/Display.html?id=77363#txn-1082418">#</a>      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;22&nbsp;12:30:48&nbsp;2012</span>
    <span class="description">dmuey [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> ENCODING is misleading, xmlDecl&#40;&#41; needs its own new&#40;&#41; setter</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1082418/568760/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/568760">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Regarding these two realities:

 1. An ENCODING of &#39;utf-8&#39; double encodes utf-8 data &#40;see “see double encoding” below for details&#41;.
 2. xmlDecl&#40;&#41; can only be set via ENCODING or by argument.

It should be clearer that you only need ENCODING when you want your data massaged when written to an OUTPUT that is a file handle. &#40;i.e. when 
being written to a scalar there is no IOLayer involved so its not double encoded&#41;.

It&#39;d be nice to be able to set the default encoding for xmlDecl&#40;&#41; in new&#40;&#41; without corrupting the data.

Suggestion:

If &#39;IOLYAER&#39; was passed:
    a. Treat its value like ENCODING is currently treated as far as binmode goes
    b. use ENCODING for xmlDecl only.
or 
  add an option for new&#40;&#41; that sets the default for xmlDecl&#40;&#41; but does not touch OUTPUT”s IO::Layer &#40;would need to check for conflict, e.g. one is ascci 
and the other is utf-8&#41;
or
  add an option to new&#40;&#41; to not binmode&#40;&#41; the handle even if ENCODING was passed &#40;no conflict resolution&#41;.

Current workarounds:

a. do not pass ENCODING to new&#40;&#41; &#38;&#38; call xmlDecl&#40;&#41; w/ an argument of &#34;utf-8&#34;.
b. pass ENCODING so it is set for xmlDecl&#40;&#41; &#38;&#38; call “binmode $output;” after new&#40;&#41; so the handle itself is set back to the :raw iolayer.

[ -- “see double encoding” -- ]

1, Taking the example from the synopsis, adding an xmlDecl&#40;&#41; call, and adding some utf8 bytes to the characters&#40;&#41; call &#40;i.e. curly quotes&#41;l

 my $writer = XML::Writer-&gt;new&#40;OUTPUT =&gt; $output&#41;;
 $writer-&gt;xmlDecl&#40;&#41;; 
 …
 $writer-&gt;characters&#40;&#34;Hello, “world”!&#34;&#41;;

correctly results in:

 &lt;?xml version=&#34;1.0&#34;?&gt;
 &lt;greeting class=&#34;simple&#34;&gt;Hello, “world”!&lt;/greeting&gt;

2. adding ENCODING=&gt;&#34;utf-8&#34; to new&#40;&#41; makes xmlDecl&#40;&#41; work as expected but garbles the quotes:

 &lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;
 &lt;greeting class=&#34;simple&#34;&gt;Hello, âworldâ!&lt;/greeting&gt;

3. not having encoding but calling xmlDecl w/ &#34;UTF-8&#34; works as expected:

 &lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
 &lt;greeting class=&#34;simple&#34;&gt;Hello, “world”!&lt;/greeting&gt;

4. having ENCODING=&gt;&#34;utf-8&#34;, &#39;binmode $output;&#39; right after new&#40;&#41;, and a call to xmlDecl w/ no arg has the same expected and correct result as #3:

 &lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;
 &lt;greeting class=&#34;simple&#34;&gt;Hello, “world”!&lt;/greeting&gt;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1082710" href="/Public/Bug/Display.html?id=77363#txn-1082710">#</a>      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;23&nbsp;08:57:06&nbsp;2012</span>
    <span class="description">joe [...] kafsemo.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1082710/568911/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/568911">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 747b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue May 22 12:30:48 2012, DMUEY wrote:
...
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  1. An ENCODING of &#39;utf-8&#39; double encodes utf-8 data &#40;see “see double
&gt; encoding” below for details&#41;.
</div>...
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2. adding ENCODING=&gt;&#34;utf-8&#34; to new&#40;&#41; makes xmlDecl&#40;&#41; work as expected
&gt; but garbles the quotes:
</div>
Thanks for reporting this. Getting character encoding right is one of
the aims of XML::Writer.

XML/examples/writing-unicode.pl is an example in the distribution that
works for me - it declares utf-8 and outputs a stream with Unicode
characters correctly encoded as utf-8 &#40;i.e., the left quotation mark is
encoded as the three-byte sequence $&#39;\xE2\x80\x9C&#39;&#41;.

Does this work in your environment? If not, I&#39;d have to know more about
your environment - Perl version, character encoding, etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1082713" href="/Public/Bug/Display.html?id=77363#txn-1082713">#</a>      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;23&nbsp;08:57:08&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1082714" href="/Public/Bug/Display.html?id=77363#txn-1082714">#</a>      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;23&nbsp;09:11:24&nbsp;2012</span>
    <span class="description">dmuey [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1082714/568914/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/568914">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed May 23 08:57:06 2012, JOSEPHW wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue May 22 12:30:48 2012, DMUEY wrote:
&gt; ...
<div class="message-stanza open">&gt; &gt;  1. An ENCODING of &#39;utf-8&#39; double encodes utf-8 data &#40;see “see double
&gt; &gt; encoding” below for details&#41;.
</div>&gt; ...
<div class="message-stanza open">&gt; &gt; 2. adding ENCODING=&gt;&#34;utf-8&#34; to new&#40;&#41; makes xmlDecl&#40;&#41; work as expected
&gt; &gt; but garbles the quotes:
</div>&gt; 
&gt; Thanks for reporting this. Getting character encoding right is one of
&gt; the aims of XML::Writer.
&gt; 
&gt; XML/examples/writing-unicode.pl is an example in the distribution that
&gt; works for me - it declares utf-8 and outputs a stream with Unicode
&gt; characters correctly encoded as utf-8 &#40;i.e., the left quotation mark is
&gt; encoded as the three-byte sequence $&#39;\xE2\x80\x9C&#39;&#41;.
&gt; 
&gt; Does this work in your environment? If not, I&#39;d have to know more about
&gt; your environment - Perl version, character encoding, etc.
</div>
That does highlight the problem: that example starts w/ Unicode strings &#40;AKA codepoints, wide chars, etc&#41; *not* utf-8 bytes strings:

  my $unicodeString = &#34;\x{201C}This\x{201D} is a test - \$ \x{00A3} \x{20AC}&#34;;

Change that to a utf-8 bytes string and it will be double encoded w/ ENCODING =&gt; utf-8.

It should only set the IO Layer if the data contains Unicode strings that need to be re-encoded as utf-8, again, this report if about having utf-8 strings to begin with:

  my $utf8_bytes_string = &#34;“This” is a test - \$ £ €&#34;;
  my $utf8_bytes_string = &#34;\xE2\x80\x9CThis\xE2\x80\x9D is a test - \$ \xC2\xA3 \xE2\x82\xAC&#34;;

HTH!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1082744" href="/Public/Bug/Display.html?id=77363#txn-1082744">#</a>      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;23&nbsp;10:15:51&nbsp;2012</span>
    <span class="description">joe [...] kafsemo.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1082744/568928/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/568928">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 871b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed May 23 09:11:24 2012, DMUEY wrote:
...
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; That does highlight the problem: that example starts w/ Unicode
&gt; strings &#40;AKA codepoints, wide chars, etc&#41; *not* utf-8 bytes strings:
</div>
Yes; the API is intended to be in terms of Unicode strings. This seemed
like the best way to encourage correct encoding of the output.
Otherwise, byte strings with other encodings could pass into output with
an inappropriate utf-8 declaration.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It should only set the IO Layer if the data contains Unicode strings
&gt; that need to be re-encoded as utf-8, again, this report if about
&gt; having utf-8 strings to begin with:
&gt; 
&gt;   my $utf8_bytes_string = &#34;“This” is a test - \$ £ €&#34;;
&gt;   my $utf8_bytes_string = &#34;\xE2\x80\x9CThis\xE2\x80\x9D is a test - \$
&gt; \xC2\xA3 \xE2\x82\xAC&#34;;
</div>
Is the overhead of utf8::decode acceptable? Otherwise your first
workaround looks like what I&#39;d do.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1082751" href="/Public/Bug/Display.html?id=77363#txn-1082751">#</a>      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;23&nbsp;11:16:19&nbsp;2012</span>
    <span class="description">webmaster [...] simplemood.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> dmuey [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #77363] ENCODING is misleading, xmlDecl&#40;&#41; needs its own new&#40;&#41; setter </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 23 May 2012 10:16:09 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Writer [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dan Muey &lt;webmaster [...] simplemood.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1082751/568935/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/568935">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On May 23, 2012, at 9:15 AM, Joseph Walton via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=77363">https://rt.cpan.org/Ticket/Display.html?id=77363</a></span> &gt;
&gt; 
&gt; On Wed May 23 09:11:24 2012, DMUEY wrote:
&gt; ...
<div class="message-stanza open">&gt;&gt; That does highlight the problem: that example starts w/ Unicode
&gt;&gt; strings &#40;AKA codepoints, wide chars, etc&#41; *not* utf-8 bytes strings:
</div>&gt; 
&gt; Yes; the API is intended to be in terms of Unicode strings. This seemed
&gt; like the best way to encourage correct encoding of the output.
</div>
Sure, the POD needs to say that though &#40;or maybe I missed it until I figured it out&#41;. ENCODING made me think I was telling it what my data was not what I wanted it turned into. We avoid Unicode strings for the confusion it causes and just do simple utf-8 bytes all the time everywhere &#40;no warnings, no decode/encode, no io layers, etc etc&#41;, fiddling w/ the Unicode version in a small scope if we need character symantics like the number of characters.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Otherwise, byte strings with other encodings could pass into output with
&gt; an inappropriate utf-8 declaration.
&gt; 
<div class="message-stanza open">&gt;&gt; It should only set the IO Layer if the data contains Unicode strings
&gt;&gt; that need to be re-encoded as utf-8, again, this report if about
&gt;&gt; having utf-8 strings to begin with:
&gt;&gt; 
&gt;&gt;  my $utf8_bytes_string = &#34;“This” is a test - \$ £ €&#34;;
&gt;&gt;  my $utf8_bytes_string = &#34;\xE2\x80\x9CThis\xE2\x80\x9D is a test - \$
&gt;&gt; \xC2\xA3 \xE2\x82\xAC&#34;;
</div>&gt; 
&gt; Is the overhead of utf8::decode acceptable?
</div>
utf8 pragma is problematic, I&#39;d say to avoid that at all costs :&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Otherwise your first
&gt; workaround looks like what I&#39;d do.
</div>

I&#39;d say simply:

 a. make the ENCODING POD very clear that it is only when the data coming in are Unicode strings.
 b. If we can just have something like
   DATA_ENCODING =&gt; &#34;utf-8&#34; in new&#40;&#41; that is used for xmlDecl&#40;&#41; and does not do anything w/ the IO Layer

then I&#39;d simply use &#39;DATA_ENCODING&#39; instead of &#39;ENCODING&#39; &#40;if both are given I&#39;d say fail since they are mutually ambiguous&#41;

or:

ENCODING_IN =&gt; &#34;utf-8&#34;

ENCODING_OUT =&gt; &#34;utf-8&#34;

then only re-encode &#40;i.e. the IO-Layer&#41; if they are different.

something like that that doesn&#39;t break existing code using Unicode strings but allows for utf-8 bytes to be utf-8 bytes.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1084781" href="/Public/Bug/Display.html?id=77363#txn-1084781">#</a>      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;29&nbsp;10:20:47&nbsp;2012</span>
    <span class="description">joe [...] kafsemo.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1084781/570083/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/570083">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed May 23 11:16:19 2012, webmaster@simplemood.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Is the overhead of utf8::decode acceptable?
</div>&gt; utf8 pragma is problematic, I&#39;d say to avoid that at all costs :&#41;
</div>
Okay., although it&#39;s worth noting that utf8::decode is available without
using the utf8 pragma.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;d say simply:
&gt; 
&gt;  a. make the ENCODING POD very clear that it is only when the data
&gt;    coming in are Unicode strings.
</div>
I&#39;ve modified the POD to:

ENCODING
A character encoding to use for the output; currently this must
be one of &#39;utf-8&#39; or &#39;us-ascii&#39;.  If present, it will be used
for the underlying character encoding and as the default in the
XML declaration.  All character data should be passed as
Unicode strings when an encoding is set.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  b. If we can just have something like
&gt;    DATA_ENCODING =&gt; &#34;utf-8&#34; in new&#40;&#41; that is used for xmlDecl&#40;&#41; and
&gt;    does not do anything w/ the IO Layer
</div>
It seems like the use of that property would be to set the
default for a later call to xmlDecl; I&#39;m not convinced of the value of a
new configuration parameter with potentially confusing semantics
when you can pass the same string to &#39;xmlDecl&#39; directly.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1084784" href="/Public/Bug/Display.html?id=77363#txn-1084784">#</a>      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;29&nbsp;10:49:19&nbsp;2012</span>
    <span class="description">dmuey [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1084784/570086/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/570086">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; Is the overhead of utf8::decode acceptable?
</div>&gt; &gt; utf8 pragma is problematic, I&#39;d say to avoid that at all costs :&#41;
</div>&gt; 
&gt; Okay., although it&#39;s worth noting that utf8::decode is available without
&gt; using the utf8 pragma.
</div>
Right, I was also referring to the functions associated with it. Also, we don’t want to fiddle w/ Unicode strings so 
decoding bytes string into unicode strings is way to much work only to change it back &#40;via IO layer&#41; with m ore 
work.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I&#39;d say simply:
&gt; &gt; 
&gt; &gt;  a. make the ENCODING POD very clear that it is only when the data
&gt; &gt;    coming in are Unicode strings.
</div>&gt; 
&gt; I&#39;ve modified the POD to:
&gt; 
&gt; ENCODING
&gt; A character encoding to use for the output; currently this must
&gt; be one of &#39;utf-8&#39; or &#39;us-ascii&#39;.  If present, it will be used
&gt; for the underlying character encoding and as the default in the
&gt; XML declaration.  All character data should be passed as
&gt; Unicode strings when an encoding is set.
</div>
Great!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt;  b. If we can just have something like
&gt; &gt;    DATA_ENCODING =&gt; &#34;utf-8&#34; in new&#40;&#41; that is used for xmlDecl&#40;&#41; and
&gt; &gt;    does not do anything w/ the IO Layer
</div>&gt; 
&gt; It seems like the use of that property would be to set the
&gt; default for a later call to xmlDecl; I&#39;m not convinced of the value of a
&gt; new configuration parameter with potentially confusing semantics
&gt; when you can pass the same string to &#39;xmlDecl&#39; directly.
</div>
Then how about:

NO_IOLAYER =&gt; 1, so ENCODING works like it does w/ xmlDecl&#40;&#41; but does not mangle the data when its already 
utf-8?

anything to not mangle the data and not have to maintain arguments to xmlDecl&#40;&#41; calls.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1086464" href="/Public/Bug/Display.html?id=77363#txn-1086464">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;03&nbsp;07:07:47&nbsp;2012</span>
    <span class="description">joe [...] kafsemo.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1086464/571049/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/571049">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue May 29 10:49:19 2012, DMUEY wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I&#39;m not convinced of the value of a
&gt; &gt; new configuration parameter with potentially confusing semantics
&gt; &gt; when you can pass the same string to &#39;xmlDecl&#39; directly.
</div>&gt; 
&gt; Then how about:
&gt; 
&gt; NO_IOLAYER =&gt; 1, so ENCODING works like it does w/ xmlDecl&#40;&#41; but does
&gt; not mangle the data when its already
&gt; utf-8?
&gt; 
&gt; anything to not mangle the data and not have to maintain arguments to
&gt; xmlDecl&#40;&#41; calls.
</div>
Okay, I think I see where you&#39;re coming from: you&#39;re not happy with the
performance overhead of encoding/decoding Unicode when you know it&#39;s
redundant and you don&#39;t trust Perl&#39;s Unicode layer to do the right thing.

I&#39;m sympathetic, but I don&#39;t think I want to encourage that style with
users who may not have as much understanding of the implications.

The overhead of re-specifying &#39;utf-8&#39; doesn&#39;t seem like too much
maintenance, but you could also try a custom subclass of XML::Writer
where you can override xmlDecl to use &#39;utf-8&#39; as the default.

Sorry I couldn&#39;t be more help on this one, and thanks for helping to
improve the documentation.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1086467" href="/Public/Bug/Display.html?id=77363#txn-1086467">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;03&nbsp;07:07:49&nbsp;2012</span>
    <span class="description">joe [...] kafsemo.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.575605</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
