<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #26465 for Authen-Simple: Controlling cache from Apache config file; hashing data in cache</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #26465 for Authen-Simple: Controlling cache from Apache config file; hashing data in cache</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Authen-Simple/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Authen-Simple/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Authen-Simple/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Authen-Simple/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Authen-Simple">Authen-Simple CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">26465</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Authen-Simple/Active/">Authen-Simple</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
GIFF [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-3262-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-3263-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;18&nbsp;00:04:23&nbsp;2007</span>
    <span class="description">GIFF [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Controlling cache from Apache config file; hashing data in cache</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Two wishlist issues here, but I have a patch for both, so I&#39;ll do it as
one bug.

First, because the cache parameter to objects which inherit from
Authen::Simple::Adapter is a cache object, it&#39;s impossible to configure
it from the Apache config file.  One solution is to allow the name of
the cache class to be put in the config file, and when the object is
constructed an object of that class will be created.  The attached patch
implements this, with the name &#34;cacheclass&#34;.  If the class name is
followed by whitespace, the rest of the setting is taken as a
whitespace-seperated list of arguments for the class&#39;s constructor.

Second, if the authentication information is sensitive, it is less than
ideal to store it in a plaintext cache which is readable by the Web
server process.  It&#39;s straightforward to hash the information before
caching it.  The patch also adds a &#34;cachehash&#34; option, which is the name
of a digester which will be passed to Digest-&gt;new.  If it is set,
username/password pairs will be hashed before they are stored in the
cache, and before they are looked for in the cache.

For example, here&#39;s what I have in my httpd.conf:

    PerlModule Authen::Simple::MyHTTP
    PerlSetVar AuthenSimpleMyHTTP_cachehash &#34;SHA-256&#34;
    PerlSetVar AuthenSimpleMyHTTP_cacheclass &#34;Cache::FastMmap share_file
/home/www/data/cache/KxAuth.cache&#34;

BTW, the code was very straightforward, extremely easy to modify, and a
delight to work with.  Thanks!
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> authen-simple-adapter-sg.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Adapter.pm~	2006-01-13 15:19:55.000000000 -0500
+++ Adapter.pm	2007-04-17 23:21:13.000000000 -0400
@@ -8,10 +8,12 @@
 use Authen::Simple::Password qw[];
 use Carp                     qw[];
 use Params::Validate         qw[];
+use Digest;
 
 __PACKAGE__-&gt;mk_classdata&#40; _options =&gt; { } &#41;;
-__PACKAGE__-&gt;mk_accessors&#40; qw[ cache callback log ] &#41;;
+__PACKAGE__-&gt;mk_accessors&#40; qw[ cache cachehash callback log cacheclass ] &#41;;
 
+our $cacheclass_loaded;
 sub new {
     my $proto  = shift;
     my $class  = ref&#40;$proto&#41; || $proto;
@@ -32,6 +34,17 @@
         $self-&gt;$method&#40;$value&#41;;
     }
 
+    if &#40;!$self-&gt;cache &#38;&#38; $self-&gt;cacheclass&#41; {
+      my&#40;$cacheclass,@cacheargs&#41;=split&#40;&#39; &#39;,$self-&gt;cacheclass&#41;;
+      if &#40;!$cacheclass_loaded&#41; {
+	eval &#34;use $cacheclass;&#34;;
+	if &#40;$@&#41; {
+	  die &#34;Error including &#39;@{[$self-&gt;cacheclass]}&#39;: $@&#34;;
+	}
+      }
+      $self-&gt;cache&#40;$cacheclass-&gt;new&#40;@cacheargs&#41;&#41;;
+    }
+    
     return $self;
 }
 
@@ -69,9 +82,19 @@
         }
     }
 
+    my $hash_upw;
+    if &#40;$self-&gt;cachehash&#41; {
+      my $hasher = Digest-&gt;new&#40;$self-&gt;cachehash&#41;
+	or die &#34;Couldn&#39;t get hasher &#39;@{[$self-&gt;cachehash]}&#39;&#34;;
+      $hasher-&gt;add&#40;&#34;$username:$password&#34;&#41;;
+      $hash_upw = $hasher-&gt;b64digest;
+    } else {
+      $hash_upw=&#34;$username:$password&#34;;
+    }
+    
     if &#40; $self-&gt;cache &#41; {
 
-        $status = $self-&gt;cache-&gt;get&#40;&#34;$username:$password&#34;&#41;;
+        $status = $self-&gt;cache-&gt;get&#40;$hash_upw&#41;;
 
         if &#40; defined $status &#41; {
 
@@ -86,7 +109,7 @@
 
     if &#40; $self-&gt;cache &#38;&#38; $status &#41; {
 
-        $self-&gt;cache-&gt;set&#40; &#34;$username:$password&#34; =&gt; $status &#41;;
+        $self-&gt;cache-&gt;set&#40; $hash_upw =&gt; $status &#41;;
         
         $self-&gt;log-&gt;debug&#40; qq/Caching successful authentication status &#39;$status&#39; for user &#39;$username&#39;./ &#41;
           if $self-&gt;log;
@@ -134,6 +157,16 @@
             optional =&gt; 1
         };
 
+	$options-&gt;{cachehash} ||= {
+ 	   type     =&gt; Params::Validate::SCALAR,
+	   optional =&gt; 1
+	};
+
+	$options-&gt;{cacheclass} ||= {
+ 	   type     =&gt; Params::Validate::SCALAR,
+	   optional =&gt; 1
+	};
+
         $class-&gt;_options&#40;$options&#41;;
     }
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;18&nbsp;01:48:06&nbsp;2007</span>
    <span class="description">GIFF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here is a better patch.  It allows more flexibility in calling the
constructor, caches cache objects &#40;otherwise if they are created from
within Apache, they are re-created every time&#41;, and provides documentation.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Adapter.pm~	2006-01-13 15:19:55.000000000 -0500
+++ Adapter.pm	2007-04-18 01:20:55.000000000 -0400
@@ -8,9 +8,10 @@
 use Authen::Simple::Password qw[];
 use Carp                     qw[];
 use Params::Validate         qw[];
+use Digest;
 
 __PACKAGE__-&gt;mk_classdata&#40; _options =&gt; { } &#41;;
-__PACKAGE__-&gt;mk_accessors&#40; qw[ cache callback log ] &#41;;
+__PACKAGE__-&gt;mk_accessors&#40; qw[ cache cachehash callback log cacheclass ] &#41;;
 
 sub new {
     my $proto  = shift;
@@ -25,6 +26,9 @@
     return $class-&gt;SUPER::new-&gt;init&#40;$params&#41;;
 }
 
+our %cacheclass_loaded;
+our %cache_cache;
+
 sub init {
     my &#40; $self, $params &#41; = @_;
 
@@ -32,6 +36,33 @@
         $self-&gt;$method&#40;$value&#41;;
     }
 
+    if &#40;!$self-&gt;cache &#38;&#38; $self-&gt;cacheclass&#41; {
+      if &#40;$cache_cache{$self-&gt;cacheclass}&#41; {
+	$self-&gt;cache&#40;$cache_cache{$self-&gt;cacheclass}&#41;;
+      } else {
+	my&#40;$class,$args&#41;=split&#40;&#39; &#39;,$self-&gt;cacheclass,2&#41;;
+	if &#40;!$cacheclass_loaded{$class}&#41; {
+	  eval &#34;use $class;&#34;;
+	  if &#40;$@&#41; {
+	    die &#34;Error including &#39;@{[$self-&gt;cacheclass]}&#39;: $@&#34;;
+	  }
+	}
+	if &#40;$args =~ /^\s*&#40;\w*&#41;\s*\&#40;&#40;.*&#41;\&#41;\s*$/&#41;
+	{
+	  if &#40;$1 eq &#39;&#39;&#41; { $args = &#34;new$args&#34;; }
+	  my $dothis = &#34;\$self-&gt;cache&#40;$class-&gt;$args&#41;;&#34;;
+	  eval $dothis;
+	  if &#40;$@&#41; {
+	    die &#34;Error executing &#39;$dothis&#39;: $@&#34;;
+	  }
+	}
+	else
+	{
+	  $self-&gt;cache&#40;$class-&gt;new&#40;split&#40;&#39; &#39;,$args&#41;&#41;&#41;;
+	}
+	$cache_cache{$self-&gt;cacheclass}=$self-&gt;cache;
+      }
+    }
     return $self;
 }
 
@@ -69,9 +100,19 @@
         }
     }
 
+    my $hash_upw;
+    if &#40;$self-&gt;cachehash&#41; {
+      my $hasher = Digest-&gt;new&#40;$self-&gt;cachehash&#41;
+	or die &#34;Couldn&#39;t get hasher &#39;@{[$self-&gt;cachehash]}&#39;&#34;;
+      $hasher-&gt;add&#40;&#34;$username:$password&#34;&#41;;
+      $hash_upw = $hasher-&gt;b64digest;
+    } else {
+      $hash_upw=&#34;$username:$password&#34;;
+    }
+    
     if &#40; $self-&gt;cache &#41; {
 
-        $status = $self-&gt;cache-&gt;get&#40;&#34;$username:$password&#34;&#41;;
+        $status = $self-&gt;cache-&gt;get&#40;$hash_upw&#41;;
 
         if &#40; defined $status &#41; {
 
@@ -86,7 +127,7 @@
 
     if &#40; $self-&gt;cache &#38;&#38; $status &#41; {
 
-        $self-&gt;cache-&gt;set&#40; &#34;$username:$password&#34; =&gt; $status &#41;;
+        $self-&gt;cache-&gt;set&#40; $hash_upw =&gt; $status &#41;;
         
         $self-&gt;log-&gt;debug&#40; qq/Caching successful authentication status &#39;$status&#39; for user &#39;$username&#39;./ &#41;
           if $self-&gt;log;
@@ -134,6 +175,16 @@
             optional =&gt; 1
         };
 
+	$options-&gt;{cachehash} ||= {
+ 	   type     =&gt; Params::Validate::SCALAR,
+	   optional =&gt; 1
+	};
+
+	$options-&gt;{cacheclass} ||= {
+ 	   type     =&gt; Params::Validate::SCALAR,
+	   optional =&gt; 1
+	};
+
         $class-&gt;_options&#40;$options&#41;;
     }
 
@@ -203,6 +254,34 @@
 
     cache =&gt; Cache::FastMmap-&gt;new
 
+=item * cacheclass &#40; $ &#41;
+
+String describing the class that should be used to construct a cache.
+
+If the class name is alone, the object will be created by calling its
+constructor C&lt;new&gt;.  If it is followed by a space but no opening
+parentheses, the remainder of the string will be treated as a
+space-seperated list of arguments to be passed to the constructor
+C&lt;new&gt;.  If it is followed by a space, an optional constructor name,
+then a parenthesized string, the object will be created by calling the
+named constructor, or C&lt;new&gt; if no constructor is named, and
+processing the remainder of the string as arguments to the constructor
+with C&lt;eval&gt;.
+
+Mostly all of this allows you to create an agent from your httpd.conf
+file.  All of these will create a Cache::FastMmap cache:
+
+    PerlSetVar AuthenSimpleMyHTTP_cacheclass &#34;Cache::FastMmap new&#40;share_file =&gt; &#39;/tmp/cache&#39;&#41;&#34;
+    PerlSetVar AuthenSimpleMyHTTP_cacheclass &#34;Cache::FastMmap &#40;share_file =&gt; &#39;/tmp/cache&#39;&#41;&#34;
+    PerlSetVar AuthenSimpleMyHTTP_cacheclass &#34;Cache::FastMmap share_file /tmp/cache&#34;
+
+=item * cachehash &#40; $ &#41;
+
+The name of a class that will be used to create a one-way hash of the
+username and password, to avoid storing them in the cache in
+plaintext.  The class name will be passed to L&lt;Digest|Digest&gt;-&gt;new to
+create a new digester object.
+
 =item * callback &#40; \&#38; &#41;
 
 A subref that gets called with two scalar references, username and password.
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;18&nbsp;01:48:13&nbsp;2007</span>
    <span class="description">GIFF [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
