<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #81982 for Net-SFTP-Foreign: bug in NET::SFTP::Foreign disconnect method</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #81982 for Net-SFTP-Foreign: bug in NET::SFTP::Foreign disconnect method</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-SFTP-Foreign/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-SFTP-Foreign/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-SFTP-Foreign/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-SFTP-Foreign/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-SFTP-Foreign">Net-SFTP-Foreign CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">81982</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-SFTP-Foreign/Active/">Net-SFTP-Foreign</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bcovel [...] sorteogames.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-23164-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-23165-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;14&nbsp;13:41:31&nbsp;2012</span>
    <span class="description">bcovel [...] sorteogames.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> bug in NET::SFTP::Foreign disconnect method</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 14 Dec 2012 18:41:21 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Net-SFTP-Foreign [...] rt.cpan.org&#34; &lt;bug-Net-SFTP-Foreign [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Borden Covel &lt;bcovel [...] sorteogames.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am using NET::SFTP::Foreign in a Windows service. We use plink and are running on Windows Server 2003 R2 / Standard Edition / SP2.

When the service tries to reset the connection by destroying the NET::SFTP::Foreign object the disconnect method in Foreign.pm tries to kill the child plink process. This code has not been working. In order to make it work all I had to do was to break one statement up into two. The code was :

   if &#40;$windows&#41; {
      kill KILL =&gt; $pid
         and waitpid&#40;$pid, 0&#41;;
   }

And was changed to:

   if &#40;$windows&#41;
   {
      $debug and $debug &#38; 4 and _debug&#40;&#34;ready to kill $pid.&#34;&#41;;
      my $cnt = kill KILL =&gt; $pid;
      $debug and $debug &#38; 4 and _debug &#40; &#34;$cnt process&#40;s&#41; killed.&#34; &#41;;
      if &#40; $cnt &#41;
      {
         my $p = waitpid&#40;$pid, 0&#41;;
         $debug and $debug &#38; 4 and _debug&#40;&#34;waitpid returned $p.&#34;&#41;;
      }
   }

Borden Covel
Consultant to Sorteo Games
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;14&nbsp;14:13:01&nbsp;2012</span>
    <span class="description">salva [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">El Vie Dic 14 13:41:31 2012, bcovel@sorteogames.com escribió:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I am using NET::SFTP::Foreign in a Windows service. We use plink and
&gt;    are running on Windows Server 2003 R2 / Standard Edition / SP2.
&gt; 
&gt; When the service tries to reset the connection by destroying the
&gt;    NET::SFTP::Foreign object the disconnect method in Foreign.pm tries
&gt;    to kill the child plink process. This code has not been working. In
&gt;    order to make it work all I had to do was to break one statement up
&gt;    into two. The code was :
&gt; 
&gt;    if &#40;$windows&#41; {
&gt;       kill KILL =&gt; $pid
&gt;          and waitpid&#40;$pid, 0&#41;;
&gt;    }
&gt; 
&gt; And was changed to:
&gt; 
&gt;    if &#40;$windows&#41;
&gt;    {
&gt;       $debug and $debug &#38; 4 and _debug&#40;&#34;ready to kill $pid.&#34;&#41;;
&gt;       my $cnt = kill KILL =&gt; $pid;
&gt;       $debug and $debug &#38; 4 and _debug &#40; &#34;$cnt process&#40;s&#41; killed.&#34; &#41;;
&gt;       if &#40; $cnt &#41;
&gt;       {
&gt;          my $p = waitpid&#40;$pid, 0&#41;;
&gt;          $debug and $debug &#38; 4 and _debug&#40;&#34;waitpid returned $p.&#34;&#41;;
&gt;       }
&gt;    }
&gt; 
&gt; Borden Covel
&gt; Consultant to Sorteo Games
</div>
Hi,

Both pieces of code are equivalent, the only possible explanation for
your version working is some race condition going on under the hood. In
that case, breaking the code in two sentences will only make the problem
less likely to happen.

Does your solution work with debugging dissabled?

In any case, have you considering using the Net::SSH2 backend
&#40;Net::SFTP::Foreign::Backend::Net_SSH2 in CPAN&#41; instead of plink?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;14&nbsp;14:13:02&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;14&nbsp;15:47:07&nbsp;2012</span>
    <span class="description">bcovel [...] sorteogames.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #81982] bug in NET::SFTP::Foreign disconnect method</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 14 Dec 2012 20:46:51 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Net-SFTP-Foreign [...] rt.cpan.org&#34; &lt;bug-Net-SFTP-Foreign [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Borden Covel &lt;bcovel [...] sorteogames.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Salvador -

Thank you so much for your amazingly quick response.

I would concur with your thoughts about a race condition, so perhaps there is an underlying Perl issue. However, I&#39;ve been running the new code without debugging enabled in my test environment &#40;it resets my SFTP connection every 15 minutes&#41; for the past few hours and it has been working without error.

The code I am working on is a couple of years old. We&#39;ve had intermittent connection problems from the beginning but only just recently were able to pin it down to fact that the plink process was not being killed correctly. The orphaned plink processes continue to have an open connection to the SFTP server and after a while the SFTP server refuses to accept any more connections.

I have not tried NET_SSH2. I am not in a position to be able to make drastic changes at this time but am hoping to be able to move my code to Linux sometime in future and will look at it then. I also noticed that it is listed as experimental. How stable it is?

Thanks,
Borden

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Salvador Fandino Garcia via RT [mailto:bug-Net-SFTP-Foreign@rt.cpan.org] 
Sent: Friday, December 14, 2012 11:13 AM
To: Borden Covel
Subject: [rt.cpan.org #81982] bug in NET::SFTP::Foreign disconnect method

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=81982">https://rt.cpan.org/Ticket/Display.html?id=81982</a></span> &gt;

El Vie Dic 14 13:41:31 2012, bcovel@sorteogames.com escribió:
<div class="message-stanza open">&gt; I am using NET::SFTP::Foreign in a Windows service. We use plink and
&gt;    are running on Windows Server 2003 R2 / Standard Edition / SP2.
&gt; 
&gt; When the service tries to reset the connection by destroying the
&gt;    NET::SFTP::Foreign object the disconnect method in Foreign.pm tries
&gt;    to kill the child plink process. This code has not been working. In
&gt;    order to make it work all I had to do was to break one statement up
&gt;    into two. The code was :
&gt; 
&gt;    if &#40;$windows&#41; {
&gt;       kill KILL =&gt; $pid
&gt;          and waitpid&#40;$pid, 0&#41;;
&gt;    }
&gt; 
&gt; And was changed to:
&gt; 
&gt;    if &#40;$windows&#41;
&gt;    {
&gt;       $debug and $debug &#38; 4 and _debug&#40;&#34;ready to kill $pid.&#34;&#41;;
&gt;       my $cnt = kill KILL =&gt; $pid;
&gt;       $debug and $debug &#38; 4 and _debug &#40; &#34;$cnt process&#40;s&#41; killed.&#34; &#41;;
&gt;       if &#40; $cnt &#41;
&gt;       {
&gt;          my $p = waitpid&#40;$pid, 0&#41;;
&gt;          $debug and $debug &#38; 4 and _debug&#40;&#34;waitpid returned $p.&#34;&#41;;
&gt;       }
&gt;    }
&gt; 
&gt; Borden Covel
&gt; Consultant to Sorteo Games
</div>
Hi,

Both pieces of code are equivalent, the only possible explanation for your version working is some race condition going on under the hood. In that case, breaking the code in two sentences will only make the problem less likely to happen.

Does your solution work with debugging dissabled?

In any case, have you considering using the Net::SSH2 backend
&#40;Net::SFTP::Foreign::Backend::Net_SSH2 in CPAN&#41; instead of plink?

-----
No virus found in this message.
Checked by AVG - www.avg.com
Version: 2013.0.2805 / Virus Database: 2634/5953 - Release Date: 12/12/12
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;04&nbsp;09:27:23&nbsp;2014</span>
    <span class="description">salva [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">More information is required to determine the root of the problem and fix it.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;04&nbsp;09:27:23&nbsp;2014</span>
    <span class="description">salva [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
