<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #50104 for CHI: race condition in CHI::Driver::File::remove&#40;&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #50104 for CHI: race condition in CHI::Driver::File::remove&#40;&#41;</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=CHI">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=CHI">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=CHI">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=CHI">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/CHI">CHI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">50104</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=CHI">CHI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">JSWARTZ [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bluefeet [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-220348-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-220349-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=50104">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-670372" href="/Public/Bug/Display.html?id=50104#txn-670372">#</a>      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;29&nbsp;13:15:38&nbsp;2009</span>
    <span class="description">bluefeet [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> race condition in CHI::Driver::File::remove&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 29 Sep 2009 10:15:09 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CHI [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Aran Deltac &lt;bluefeet [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/670372/344597/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/344597">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 641b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This code in CHI::Driver::File:

sub remove {
    my &#40; $self, $key &#41; = @_;

    my $file = $self-&gt;path_to_key&#40;$key&#41; or return undef;
    unlink&#40;$file&#41;;
    die &#34;could not unlink &#39;$file&#39;&#34; if -f $file;
}

There is a race condition here, which we just ran in to in production,
where between the unlink and the check to see if the file exists,
another process added the file back in.  Things like this should be
done in an atomic fashion.  Consider using autodie or checking the
return value of unlink, as in:

    if &#40;unlink&#40;$file&#41; != 1&#41; { die &#34;could not unlink &#39;$file&#39;&#34;; }

There may be a similar issue in clear&#40;&#41;, but its hard to tell.

Aran
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-673801" href="/Public/Bug/Display.html?id=50104#txn-673801">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;07&nbsp;17:52:16&nbsp;2009</span>
    <span class="description">JSWARTZ [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-673802" href="/Public/Bug/Display.html?id=50104#txn-673802">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;07&nbsp;17:52:33&nbsp;2009</span>
    <span class="description">JSWARTZ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/673802/346490/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/346490">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 776b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Yup, good point. Will fix. Thanks.

On Tue Sep 29 13:15:38 2009, bluefeet@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This code in CHI::Driver::File:
&gt; 
&gt; sub remove {
&gt;     my &#40; $self, $key &#41; = @_;
&gt; 
&gt;     my $file = $self-&gt;path_to_key&#40;$key&#41; or return undef;
&gt;     unlink&#40;$file&#41;;
&gt;     die &#34;could not unlink &#39;$file&#39;&#34; if -f $file;
&gt; }
&gt; 
&gt; There is a race condition here, which we just ran in to in production,
&gt; where between the unlink and the check to see if the file exists,
&gt; another process added the file back in.  Things like this should be
&gt; done in an atomic fashion.  Consider using autodie or checking the
&gt; return value of unlink, as in:
&gt; 
&gt;     if &#40;unlink&#40;$file&#41; != 1&#41; { die &#34;could not unlink &#39;$file&#39;&#34;; }
&gt; 
&gt; There may be a similar issue in clear&#40;&#41;, but its hard to tell.
&gt; 
&gt; Aran
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-673803" href="/Public/Bug/Display.html?id=50104#txn-673803">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;07&nbsp;17:52:34&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-673806" href="/Public/Bug/Display.html?id=50104#txn-673806">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;07&nbsp;18:23:19&nbsp;2009</span>
    <span class="description">bluefeet [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #50104] race condition in CHI::Driver::File::remove&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 7 Oct 2009 15:22:57 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CHI [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Aran Deltac &lt;bluefeet [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/673806/346493/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/346493">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Jonathan - turns out my fix actually wasn&#39;t correct.  We went to
production with it and had an even worse time with race conditions as two
processes could both believe that the cache file exists, and both attempt to
unlink them at the same time.  The first one in will be all good, the second
one will error.  We ended up removing all verification of whether unlink
worked or not, like this:
sub remove {
    my &#40; $self, $key &#41; = @_;
    my $file = $self-&gt;path_to_key&#40;$key&#41; or return undef;
    unlink&#40;$file&#41;;
}

I&#39;m having a hard time coming up with a better solution.  It works for us,
and I&#39;m betting it should be the final solution to this issue.

Thanks,

Aran

On Wed, Oct 7, 2009 at 2:52 PM, Jonathan Swartz via RT
&lt;bug-CHI@rt.cpan.org&gt;wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=50104">https://rt.cpan.org/Ticket/Display.html?id=50104</a></span> &gt;
&gt;
&gt; Yup, good point. Will fix. Thanks.
&gt;
&gt; On Tue Sep 29 13:15:38 2009, bluefeet@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; This code in CHI::Driver::File:
&gt; &gt;
&gt; &gt; sub remove {
&gt; &gt;     my &#40; $self, $key &#41; = @_;
&gt; &gt;
&gt; &gt;     my $file = $self-&gt;path_to_key&#40;$key&#41; or return undef;
&gt; &gt;     unlink&#40;$file&#41;;
&gt; &gt;     die &#34;could not unlink &#39;$file&#39;&#34; if -f $file;
&gt; &gt; }
&gt; &gt;
&gt; &gt; There is a race condition here, which we just ran in to in production,
&gt; &gt; where between the unlink and the check to see if the file exists,
&gt; &gt; another process added the file back in.  Things like this should be
&gt; &gt; done in an atomic fashion.  Consider using autodie or checking the
&gt; &gt; return value of unlink, as in:
&gt; &gt;
&gt; &gt;     if &#40;unlink&#40;$file&#41; != 1&#41; { die &#34;could not unlink &#39;$file&#39;&#34;; }
&gt; &gt;
&gt; &gt; There may be a similar issue in clear&#40;&#41;, but its hard to tell.
&gt; &gt;
&gt; &gt; Aran
</div>&gt;
&gt;
&gt;
&gt;
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/673806/346494/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/346494">with headers</a>
<br />
<span class="downloadcontenttype">text/html 2.2k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-673831" href="/Public/Bug/Display.html?id=50104#txn-673831">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;07&nbsp;19:04:24&nbsp;2009</span>
    <span class="description">swartz [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #50104] race condition in CHI::Driver::File::remove&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 7 Oct 2009 16:04:00 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CHI [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jonathan Swartz &lt;swartz [...] pobox.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/673831/346508/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/346508">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hm. It is a shame not to verify whether the remove worked. Since  
remove is used to expire caches, you&#39;d definitely want to know if that  
failed and left invalid cache entries around.

What about getting a cheap signature of the file &#40;e.g. from stat&#40;&#41;&#41;  
and after removing, making sure that either &#40;1&#41; the file doesn&#39;t  
exist, or &#40;2&#41; it exists with a different signature? Or is this just  
open to other race conditions?

On Oct 7, 2009, at 3:23 PM, Aran Deltac via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       Queue: CHI
&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=50104">http://rt.cpan.org/Ticket/Display.html?id=50104</a></span> &gt;
&gt;
&gt; Hi Jonathan - turns out my fix actually wasn&#39;t correct.  We went to
&gt; production with it and had an even worse time with race conditions  
&gt; as two
&gt; processes could both believe that the cache file exists, and both  
&gt; attempt to
&gt; unlink them at the same time.  The first one in will be all good,  
&gt; the second
&gt; one will error.  We ended up removing all verification of whether  
&gt; unlink
&gt; worked or not, like this:
&gt; sub remove {
&gt;    my &#40; $self, $key &#41; = @_;
&gt;    my $file = $self-&gt;path_to_key&#40;$key&#41; or return undef;
&gt;    unlink&#40;$file&#41;;
&gt; }
&gt;
&gt; I&#39;m having a hard time coming up with a better solution.  It works  
&gt; for us,
&gt; and I&#39;m betting it should be the final solution to this issue.
&gt;
&gt; Thanks,
&gt;
&gt; Aran
&gt;
&gt; On Wed, Oct 7, 2009 at 2:52 PM, Jonathan Swartz via RT
&gt; &lt;bug-CHI@rt.cpan.org&gt;wrote:
&gt;
<div class="message-stanza open">&gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=50104">https://rt.cpan.org/Ticket/Display.html?id=50104</a></span> &gt;
&gt;&gt;
&gt;&gt; Yup, good point. Will fix. Thanks.
&gt;&gt;
&gt;&gt; On Tue Sep 29 13:15:38 2009, bluefeet@gmail.com wrote:
<div class="message-stanza open">&gt;&gt;&gt; This code in CHI::Driver::File:
&gt;&gt;&gt;
&gt;&gt;&gt; sub remove {
&gt;&gt;&gt;    my &#40; $self, $key &#41; = @_;
&gt;&gt;&gt;
&gt;&gt;&gt;    my $file = $self-&gt;path_to_key&#40;$key&#41; or return undef;
&gt;&gt;&gt;    unlink&#40;$file&#41;;
&gt;&gt;&gt;    die &#34;could not unlink &#39;$file&#39;&#34; if -f $file;
&gt;&gt;&gt; }
&gt;&gt;&gt;
&gt;&gt;&gt; There is a race condition here, which we just ran in to in  
&gt;&gt;&gt; production,
&gt;&gt;&gt; where between the unlink and the check to see if the file exists,
&gt;&gt;&gt; another process added the file back in.  Things like this should be
&gt;&gt;&gt; done in an atomic fashion.  Consider using autodie or checking the
&gt;&gt;&gt; return value of unlink, as in:
&gt;&gt;&gt;
&gt;&gt;&gt;    if &#40;unlink&#40;$file&#41; != 1&#41; { die &#34;could not unlink &#39;$file&#39;&#34;; }
&gt;&gt;&gt;
&gt;&gt;&gt; There may be a similar issue in clear&#40;&#41;, but its hard to tell.
&gt;&gt;&gt;
&gt;&gt;&gt; Aran
</div>&gt;&gt;
&gt;&gt;
&gt;&gt;
&gt;&gt;
</div>&gt;
&gt; Hi Jonathan - turns out my fix actually wasn&#39;t correct.  We went to  
&gt; production with it and had an even worse time with race conditions  
&gt; as two processes could both believe that the cache file exists, and  
&gt; both attempt to unlink them at the same time.  The first one in will  
&gt; be all good, the second one will error.  We ended up removing all  
&gt; verification of whether unlink worked or not, like this:
&gt;
&gt; sub remove {
&gt;     my &#40; $self, $key &#41; = @_;
&gt;     my $file = $self-&gt;path_to_key&#40;$key&#41; or return undef;
&gt;     unlink&#40;$file&#41;;
&gt; }
&gt;
&gt; I&#39;m having a hard time coming up with a better solution.  It works  
&gt; for us, and I&#39;m betting it should be the final solution to this issue.
&gt;
&gt; Thanks,
&gt;
&gt; Aran
&gt;
&gt; On Wed, Oct 7, 2009 at 2:52 PM, Jonathan Swartz via RT &lt;bug-CHI@rt.cpan.org 
<div class="message-stanza open">&gt; &gt; wrote:
</div>&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=50104">https://rt.cpan.org/Ticket/Display.html?id=50104</a></span> &gt;
&gt;
&gt; Yup, good point. Will fix. Thanks.
&gt;
&gt; On Tue Sep 29 13:15:38 2009, bluefeet@gmail.com wrote:
<div class="message-stanza open">&gt; &gt; This code in CHI::Driver::File:
&gt; &gt;
&gt; &gt; sub remove {
&gt; &gt;     my &#40; $self, $key &#41; = @_;
&gt; &gt;
&gt; &gt;     my $file = $self-&gt;path_to_key&#40;$key&#41; or return undef;
&gt; &gt;     unlink&#40;$file&#41;;
&gt; &gt;     die &#34;could not unlink &#39;$file&#39;&#34; if -f $file;
&gt; &gt; }
&gt; &gt;
&gt; &gt; There is a race condition here, which we just ran in to in  
</div>&gt; production,
<div class="message-stanza open">&gt; &gt; where between the unlink and the check to see if the file exists,
&gt; &gt; another process added the file back in.  Things like this should be
&gt; &gt; done in an atomic fashion.  Consider using autodie or checking the
&gt; &gt; return value of unlink, as in:
&gt; &gt;
&gt; &gt;     if &#40;unlink&#40;$file&#41; != 1&#41; { die &#34;could not unlink &#39;$file&#39;&#34;; }
&gt; &gt;
&gt; &gt; There may be a similar issue in clear&#40;&#41;, but its hard to tell.
&gt; &gt;
&gt; &gt; Aran
</div>&gt;
&gt;
&gt;
&gt;
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/673831/346509/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/346509">with headers</a>
<br />
<span class="downloadcontenttype">text/html 7k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-796777" href="/Public/Bug/Display.html?id=50104#txn-796777">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;25&nbsp;09:08:35&nbsp;2010</span>
    <span class="description">JSWARTZ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/796777/413109/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/413109">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 15b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed in 0.34.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-796779" href="/Public/Bug/Display.html?id=50104#txn-796779">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;25&nbsp;09:08:35&nbsp;2010</span>
    <span class="description">JSWARTZ [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.434315</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
