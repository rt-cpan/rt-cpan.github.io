<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #103063 for Catalyst-Runtime: Query parsing broken for non-UTF-8 sites since 5.90083</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #103063 for Catalyst-Runtime: Query parsing broken for non-UTF-8 sites since 5.90083</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Catalyst-Runtime/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Catalyst-Runtime/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Catalyst-Runtime/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Catalyst-Runtime/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Catalyst-Runtime">Catalyst-Runtime CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">103063</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Catalyst-Runtime/Active/">Catalyst-Runtime</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
victor [...] vsespb.ru

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-40040-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
5.90083    </td>
  </tr>
  <tr id="CF-40041-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;24&nbsp;06:56:19&nbsp;2015</span>
    <span class="description">victor [...] vsespb.ru -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Query parsing broken for non-UTF-8 sites since 5.90083</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello.

Here is the diff:

<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-Runtime-5.90083/&#38;source=JJNAPIORK/Catalyst-Runtime-5.90082/">https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-Runtime-5.90083/&#38;source=JJNAPIORK/Catalyst-Runtime-5.90082/</a></span>

There is the line:

===
map { defined $_ ? decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; : $_ }
===

It decodes data to Unicode string and assumes that it&#39;s in UTF-8, it ignores &#34;encoding&#34; option &#40;even encoding =&gt; undef&#41;.

Before 5.90083 logic was the same:

===
map { decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; }
===

However, there was 
===
-    if&#40;my $query_obj = $env-&gt;{&#39;plack.request.query&#39;}&#41; {
-         $c-&gt;request-&gt;query_parameters&#40;
-           $c-&gt;request-&gt;_use_hash_multivalue ?
-              $query_obj-&gt;clone :
-              $query_obj-&gt;as_hashref_mixed&#41;;
-         return;
-    }
-
===
before decoding.

So, our site didn&#39;t reach this decoding, since $env-&gt;{&#39;plack.request.query&#39;} was true.

Use case:

Site runs under encoding =&gt; undef &#40;previously without encoding at all&#41;.
Web page encoding is WINDOWS-1251, so  all incoming data, including query string is WINDOWS-1251 as well.

Example of URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://example.com/test?domains=%E4%EE%EC%E5%ED">http://example.com/test?domains=%E4%EE%EC%E5%ED</a></span>

%E4%EE%EC%E5%ED is Russian word in WINDOWS-1251 encoding.

So in 5.90082 octets are passed as-is to the application. After 5.90083 - it&#39;s decoded to Unicode string consists of not-a-characters.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;24&nbsp;09:53:29&nbsp;2015</span>
    <span class="description">jjnapiork [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Any change you can share with me an entire request response cycle, including HTTP headers?  I need to see what I can do to properly detect this.  thanks!


On Tue Mar 24 06:56:19 2015, vsespb wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hello.
&gt; 
&gt; Here is the diff:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-Runtime-">https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-Runtime-</a></span>
&gt; 5.90083/&#38;source=JJNAPIORK/Catalyst-Runtime-5.90082/
&gt; 
&gt; There is the line:
&gt; 
&gt; ===
&gt; map { defined $_ ? decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; : $_ }
&gt; ===
&gt; 
&gt; It decodes data to Unicode string and assumes that it&#39;s in UTF-8, it
&gt; ignores &#34;encoding&#34; option &#40;even encoding =&gt; undef&#41;.
&gt; 
&gt; Before 5.90083 logic was the same:
&gt; 
&gt; ===
&gt; map { decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; }
&gt; ===
&gt; 
&gt; However, there was
&gt; ===
&gt; -    if&#40;my $query_obj = $env-&gt;{&#39;plack.request.query&#39;}&#41; {
&gt; -         $c-&gt;request-&gt;query_parameters&#40;
&gt; -           $c-&gt;request-&gt;_use_hash_multivalue ?
&gt; -              $query_obj-&gt;clone :
&gt; -              $query_obj-&gt;as_hashref_mixed&#41;;
&gt; -         return;
&gt; -    }
&gt; -
&gt; ===
&gt; before decoding.
&gt; 
&gt; So, our site didn&#39;t reach this decoding, since $env-
<div class="message-stanza open">&gt; &gt;{&#39;plack.request.query&#39;} was true.
</div>&gt; 
&gt; Use case:
&gt; 
&gt; Site runs under encoding =&gt; undef &#40;previously without encoding at
&gt; all&#41;.
&gt; Web page encoding is WINDOWS-1251, so  all incoming data, including
&gt; query string is WINDOWS-1251 as well.
&gt; 
&gt; Example of URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://example.com/test?domains=%E4%EE%EC%E5%ED">http://example.com/test?domains=%E4%EE%EC%E5%ED</a></span>
&gt; 
&gt; %E4%EE%EC%E5%ED is Russian word in WINDOWS-1251 encoding.
&gt; 
&gt; So in 5.90082 octets are passed as-is to the application. After
&gt; 5.90083 - it&#39;s decoded to Unicode string consists of not-a-characters.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;24&nbsp;09:53:31&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;24&nbsp;09:59:39&nbsp;2015</span>
    <span class="description">jjnapiork [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hey

one thing I wonder exactly what you think this should do?  I was taking the assumption that people would what Catalyst to convert the encoded chacters to local unicode wide characters but maybe that is not an ideal assumption?

talk to me about the use case and what you&#39;d ideally see here  

On Tue Mar 24 06:56:19 2015, vsespb wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hello.
&gt; 
&gt; Here is the diff:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-Runtime-">https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-Runtime-</a></span>
&gt; 5.90083/&#38;source=JJNAPIORK/Catalyst-Runtime-5.90082/
&gt; 
&gt; There is the line:
&gt; 
&gt; ===
&gt; map { defined $_ ? decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; : $_ }
&gt; ===
&gt; 
&gt; It decodes data to Unicode string and assumes that it&#39;s in UTF-8, it
&gt; ignores &#34;encoding&#34; option &#40;even encoding =&gt; undef&#41;.
&gt; 
&gt; Before 5.90083 logic was the same:
&gt; 
&gt; ===
&gt; map { decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; }
&gt; ===
&gt; 
&gt; However, there was
&gt; ===
&gt; -    if&#40;my $query_obj = $env-&gt;{&#39;plack.request.query&#39;}&#41; {
&gt; -         $c-&gt;request-&gt;query_parameters&#40;
&gt; -           $c-&gt;request-&gt;_use_hash_multivalue ?
&gt; -              $query_obj-&gt;clone :
&gt; -              $query_obj-&gt;as_hashref_mixed&#41;;
&gt; -         return;
&gt; -    }
&gt; -
&gt; ===
&gt; before decoding.
&gt; 
&gt; So, our site didn&#39;t reach this decoding, since $env-
<div class="message-stanza open">&gt; &gt;{&#39;plack.request.query&#39;} was true.
</div>&gt; 
&gt; Use case:
&gt; 
&gt; Site runs under encoding =&gt; undef &#40;previously without encoding at
&gt; all&#41;.
&gt; Web page encoding is WINDOWS-1251, so  all incoming data, including
&gt; query string is WINDOWS-1251 as well.
&gt; 
&gt; Example of URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://example.com/test?domains=%E4%EE%EC%E5%ED">http://example.com/test?domains=%E4%EE%EC%E5%ED</a></span>
&gt; 
&gt; %E4%EE%EC%E5%ED is Russian word in WINDOWS-1251 encoding.
&gt; 
&gt; So in 5.90082 octets are passed as-is to the application. After
&gt; 5.90083 - it&#39;s decoded to Unicode string consists of not-a-characters.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;24&nbsp;12:28:37&nbsp;2015</span>
    <span class="description">victor [...] vsespb.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Request/Response:
========
GET /misc/mytest?domains=%E4%EE%EC%E5%ED HTTP/1.1
Host: www1.reg.ru
User-Agent: Mozilla/5.0 &#40;X11; Ubuntu; Linux x86_64; rv:36.0&#41; Gecko/20100101 Firefox/36.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Cookie: [CUT]
Connection: keep-alive
Cache-Control: max-age=0

HTTP/1.1 200 OK
Server: nginx
Date: Tue, 24 Mar 2015 16:19:45 GMT
Content-Type: text/html; charset=WINDOWS-1251
Transfer-Encoding: chunked
Connection: keep-alive
Content-Language: ru
Set-Cookie: [CUT]
X-Catalyst: 5.90083
x-ua-compatible: IE=edge,chrome=IE8
Content-Encoding: gzip
========

Action code:
========
sub mytest : Local Args&#40;0&#41; {
    my &#40;$self, $c, $r, $p&#41; = getcontvars_noses @_;
    $c-&gt;res-&gt;content_type&#40; &#34;text/plain&#34; &#41;;
    $c-&gt;res-&gt;body&#40;  $p-&gt;{domains} &#41;;
}
========

Console:
========
[error] Caught exception in engine &#34;Wide character in syswrite at /usr/local/share/perl/5.14.2/Starman/Server.pm line 547.&#34;
========


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; one thing I wonder exactly what you think this should do? 
</div>
Well, with encoding=&gt;undef it should do nothing with charsets. i.e. return octets as is. i.e
probably $self-&gt;unescape_uri&#40;$_&#41; instead of decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41;


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I was taking the assumption that people would what Catalyst to convert the encoded chacters to local unicode wide characters but maybe that is not an ideal assumption?
</div>
Yes, right. With encoding NOT undef, Catalyst should convert binary data to perl strings &#40;unicode wide characters&#41;.
But when encoding IS undef, it should pass binary data as-is. It&#39;s exactly what it does with output data.
So with encoding undef input processing should be consistent with output processing.

We work with textual data in WINDOWS-1251 currently. That&#39;s pre-unicode approach. We&#39;re migrating to unicode,
but we&#39;re just not there yet.



On Tue Mar 24 16:59:39 2015, JJNAPIORK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hey
&gt; 
&gt; one thing I wonder exactly what you think this should do?  I was
&gt; taking the assumption that people would what Catalyst to convert the
&gt; encoded chacters to local unicode wide characters but maybe that is
&gt; not an ideal assumption?
&gt; 
&gt; talk to me about the use case and what you&#39;d ideally see here
&gt; 
&gt; On Tue Mar 24 06:56:19 2015, vsespb wrote:
<div class="message-stanza open">&gt; &gt; Hello.
&gt; &gt;
&gt; &gt; Here is the diff:
&gt; &gt;
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-Runtime-">https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-Runtime-</a></span>
&gt; &gt; 5.90083/&#38;source=JJNAPIORK/Catalyst-Runtime-5.90082/
&gt; &gt;
&gt; &gt; There is the line:
&gt; &gt;
&gt; &gt; ===
&gt; &gt; map { defined $_ ? decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; : $_ }
&gt; &gt; ===
&gt; &gt;
&gt; &gt; It decodes data to Unicode string and assumes that it&#39;s in UTF-8, it
&gt; &gt; ignores &#34;encoding&#34; option &#40;even encoding =&gt; undef&#41;.
&gt; &gt;
&gt; &gt; Before 5.90083 logic was the same:
&gt; &gt;
&gt; &gt; ===
&gt; &gt; map { decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; }
&gt; &gt; ===
&gt; &gt;
&gt; &gt; However, there was
&gt; &gt; ===
&gt; &gt; -    if&#40;my $query_obj = $env-&gt;{&#39;plack.request.query&#39;}&#41; {
&gt; &gt; -         $c-&gt;request-&gt;query_parameters&#40;
&gt; &gt; -           $c-&gt;request-&gt;_use_hash_multivalue ?
&gt; &gt; -              $query_obj-&gt;clone :
&gt; &gt; -              $query_obj-&gt;as_hashref_mixed&#41;;
&gt; &gt; -         return;
&gt; &gt; -    }
&gt; &gt; -
&gt; &gt; ===
&gt; &gt; before decoding.
&gt; &gt;
&gt; &gt; So, our site didn&#39;t reach this decoding, since $env-
<div class="message-stanza open">&gt; &gt; &gt; {&#39;plack.request.query&#39;} was true.
</div>&gt; &gt;
&gt; &gt; Use case:
&gt; &gt;
&gt; &gt; Site runs under encoding =&gt; undef &#40;previously without encoding at
&gt; &gt; all&#41;.
&gt; &gt; Web page encoding is WINDOWS-1251, so  all incoming data, including
&gt; &gt; query string is WINDOWS-1251 as well.
&gt; &gt;
&gt; &gt; Example of URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://example.com/test?domains=%E4%EE%EC%E5%ED">http://example.com/test?domains=%E4%EE%EC%E5%ED</a></span>
&gt; &gt;
&gt; &gt; %E4%EE%EC%E5%ED is Russian word in WINDOWS-1251 encoding.
&gt; &gt;
&gt; &gt; So in 5.90082 octets are passed as-is to the application. After
&gt; &gt; 5.90083 - it&#39;s decoded to Unicode string consists of not-a-
&gt; &gt; characters.
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;24&nbsp;12:38:22&nbsp;2015</span>
    <span class="description">jjnapiork [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry one more question.  How are the links generated?  Do you have web pages that are windows charset encoded?  Did you use $c-&gt;uri_for or did you have links &#39;hard coded&#39;, or manually created?  Last are you doing the windows encoding for web pages &#40;I assume that is what you are doing&#41; via setting $c-&gt;encoding or similar or did you have to hack catalyst to make it work the way you needed ?


On Tue Mar 24 12:28:37 2015, vsespb wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Request/Response:
&gt; ========
&gt; GET /misc/mytest?domains=%E4%EE%EC%E5%ED HTTP/1.1
&gt; Host: www1.reg.ru
&gt; User-Agent: Mozilla/5.0 &#40;X11; Ubuntu; Linux x86_64; rv:36.0&#41;
&gt; Gecko/20100101 Firefox/36.0
&gt; Accept:
&gt; text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
&gt; Accept-Language: en-US,en;q=0.5
&gt; Accept-Encoding: gzip, deflate
&gt; Cookie: [CUT]
&gt; Connection: keep-alive
&gt; Cache-Control: max-age=0
&gt; 
&gt; HTTP/1.1 200 OK
&gt; Server: nginx
&gt; Date: Tue, 24 Mar 2015 16:19:45 GMT
&gt; Content-Type: text/html; charset=WINDOWS-1251
&gt; Transfer-Encoding: chunked
&gt; Connection: keep-alive
&gt; Content-Language: ru
&gt; Set-Cookie: [CUT]
&gt; X-Catalyst: 5.90083
&gt; x-ua-compatible: IE=edge,chrome=IE8
&gt; Content-Encoding: gzip
&gt; ========
&gt; 
&gt; Action code:
&gt; ========
&gt; sub mytest : Local Args&#40;0&#41; {
&gt;     my &#40;$self, $c, $r, $p&#41; = getcontvars_noses @_;
&gt;     $c-&gt;res-&gt;content_type&#40; &#34;text/plain&#34; &#41;;
&gt;     $c-&gt;res-&gt;body&#40;  $p-&gt;{domains} &#41;;
&gt; }
&gt; ========
&gt; 
&gt; Console:
&gt; ========
&gt; [error] Caught exception in engine &#34;Wide character in syswrite at
&gt; /usr/local/share/perl/5.14.2/Starman/Server.pm line 547.&#34;
&gt; ========
&gt; 
&gt; 
<div class="message-stanza open">&gt; &gt; one thing I wonder exactly what you think this should do?
</div>&gt; 
&gt; Well, with encoding=&gt;undef it should do nothing with charsets. i.e.
&gt; return octets as is. i.e
&gt; probably $self-&gt;unescape_uri&#40;$_&#41; instead of decode_utf8&#40;$self-
<div class="message-stanza open">&gt; &gt;unescape_uri&#40;$_&#41;&#41;
</div>&gt; 
&gt; 
<div class="message-stanza open">&gt; &gt; I was taking the assumption that people would what Catalyst to
&gt; &gt; convert the encoded chacters to local unicode wide characters but
&gt; &gt; maybe that is not an ideal assumption?
</div>&gt; 
&gt; Yes, right. With encoding NOT undef, Catalyst should convert binary
&gt; data to perl strings &#40;unicode wide characters&#41;.
&gt; But when encoding IS undef, it should pass binary data as-is. It&#39;s
&gt; exactly what it does with output data.
&gt; So with encoding undef input processing should be consistent with
&gt; output processing.
&gt; 
&gt; We work with textual data in WINDOWS-1251 currently. That&#39;s pre-
&gt; unicode approach. We&#39;re migrating to unicode,
&gt; but we&#39;re just not there yet.
&gt; 
&gt; 
&gt; 
&gt; On Tue Mar 24 16:59:39 2015, JJNAPIORK wrote:
<div class="message-stanza open">&gt; &gt; Hey
&gt; &gt;
&gt; &gt; one thing I wonder exactly what you think this should do?  I was
&gt; &gt; taking the assumption that people would what Catalyst to convert the
&gt; &gt; encoded chacters to local unicode wide characters but maybe that is
&gt; &gt; not an ideal assumption?
&gt; &gt;
&gt; &gt; talk to me about the use case and what you&#39;d ideally see here
&gt; &gt;
&gt; &gt; On Tue Mar 24 06:56:19 2015, vsespb wrote:
<div class="message-stanza open">&gt; &gt; &gt; Hello.
&gt; &gt; &gt;
&gt; &gt; &gt; Here is the diff:
&gt; &gt; &gt;
&gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-Runtime-">https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-Runtime-</a></span>
&gt; &gt; &gt; 5.90083/&#38;source=JJNAPIORK/Catalyst-Runtime-5.90082/
&gt; &gt; &gt;
&gt; &gt; &gt; There is the line:
&gt; &gt; &gt;
&gt; &gt; &gt; ===
&gt; &gt; &gt; map { defined $_ ? decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; : $_ }
&gt; &gt; &gt; ===
&gt; &gt; &gt;
&gt; &gt; &gt; It decodes data to Unicode string and assumes that it&#39;s in UTF-8,
&gt; &gt; &gt; it
&gt; &gt; &gt; ignores &#34;encoding&#34; option &#40;even encoding =&gt; undef&#41;.
&gt; &gt; &gt;
&gt; &gt; &gt; Before 5.90083 logic was the same:
&gt; &gt; &gt;
&gt; &gt; &gt; ===
&gt; &gt; &gt; map { decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; }
&gt; &gt; &gt; ===
&gt; &gt; &gt;
&gt; &gt; &gt; However, there was
&gt; &gt; &gt; ===
&gt; &gt; &gt; -    if&#40;my $query_obj = $env-&gt;{&#39;plack.request.query&#39;}&#41; {
&gt; &gt; &gt; -         $c-&gt;request-&gt;query_parameters&#40;
&gt; &gt; &gt; -           $c-&gt;request-&gt;_use_hash_multivalue ?
&gt; &gt; &gt; -              $query_obj-&gt;clone :
&gt; &gt; &gt; -              $query_obj-&gt;as_hashref_mixed&#41;;
&gt; &gt; &gt; -         return;
&gt; &gt; &gt; -    }
&gt; &gt; &gt; -
&gt; &gt; &gt; ===
&gt; &gt; &gt; before decoding.
&gt; &gt; &gt;
&gt; &gt; &gt; So, our site didn&#39;t reach this decoding, since $env-
<div class="message-stanza open">&gt; &gt; &gt; &gt; {&#39;plack.request.query&#39;} was true.
</div>&gt; &gt; &gt;
&gt; &gt; &gt; Use case:
&gt; &gt; &gt;
&gt; &gt; &gt; Site runs under encoding =&gt; undef &#40;previously without encoding at
&gt; &gt; &gt; all&#41;.
&gt; &gt; &gt; Web page encoding is WINDOWS-1251, so  all incoming data, including
&gt; &gt; &gt; query string is WINDOWS-1251 as well.
&gt; &gt; &gt;
&gt; &gt; &gt; Example of URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://example.com/test?domains=%E4%EE%EC%E5%ED">http://example.com/test?domains=%E4%EE%EC%E5%ED</a></span>
&gt; &gt; &gt;
&gt; &gt; &gt; %E4%EE%EC%E5%ED is Russian word in WINDOWS-1251 encoding.
&gt; &gt; &gt;
&gt; &gt; &gt; So in 5.90082 octets are passed as-is to the application. After
&gt; &gt; &gt; 5.90083 - it&#39;s decoded to Unicode string consists of not-a-
&gt; &gt; &gt; characters.
</div></div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;24&nbsp;12:47:01&nbsp;2015</span>
    <span class="description">victor [...] vsespb.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Yes, all webpages are in windows-1251 charset.
All our template toolkit templates are in windows-1251 charset on disk.
All perl source code is in windows-1251 &#40;thus string constants are windows-1251&#41;

Links with query strings are created usually using URI module.

docs from URI module:
===
The escaping &#40;percent encoding&#41; of chars in the 128 .. 255 range passed to the URI constructor or when setting URI parts using the accessor methods depend on the state of the internal UTF8 flag &#40;see utf8::is_utf8&#41; of the string passed. If the UTF8 flag is set the UTF-8 encoded version of the character is percent encoded. If the UTF8 flag isn&#39;t set the Latin-1 version &#40;byte&#41; of the character is percent encoded. This basically exposes the internal encoding of Perl strings.
===

i.e. it will escape strings without perl UTF-8 flag as byte percent encoding. this works for us.

No, we dont use $c-&gt;encoding. We just set encoding to undef.

On Tue Mar 24 19:38:22 2015, JJNAPIORK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sorry one more question.  How are the links generated?  Do you have
&gt; web pages that are windows charset encoded?  Did you use $c-&gt;uri_for
&gt; or did you have links &#39;hard coded&#39;, or manually created?  Last are you
&gt; doing the windows encoding for web pages &#40;I assume that is what you
&gt; are doing&#41; via setting $c-&gt;encoding or similar or did you have to hack
&gt; catalyst to make it work the way you needed ?
&gt; 
&gt; 
&gt; On Tue Mar 24 12:28:37 2015, vsespb wrote:
<div class="message-stanza open">&gt; &gt; Request/Response:
&gt; &gt; ========
&gt; &gt; GET /misc/mytest?domains=%E4%EE%EC%E5%ED HTTP/1.1
&gt; &gt; Host: www1.reg.ru
&gt; &gt; User-Agent: Mozilla/5.0 &#40;X11; Ubuntu; Linux x86_64; rv:36.0&#41;
&gt; &gt; Gecko/20100101 Firefox/36.0
&gt; &gt; Accept:
&gt; &gt; text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
&gt; &gt; Accept-Language: en-US,en;q=0.5
&gt; &gt; Accept-Encoding: gzip, deflate
&gt; &gt; Cookie: [CUT]
&gt; &gt; Connection: keep-alive
&gt; &gt; Cache-Control: max-age=0
&gt; &gt;
&gt; &gt; HTTP/1.1 200 OK
&gt; &gt; Server: nginx
&gt; &gt; Date: Tue, 24 Mar 2015 16:19:45 GMT
&gt; &gt; Content-Type: text/html; charset=WINDOWS-1251
&gt; &gt; Transfer-Encoding: chunked
&gt; &gt; Connection: keep-alive
&gt; &gt; Content-Language: ru
&gt; &gt; Set-Cookie: [CUT]
&gt; &gt; X-Catalyst: 5.90083
&gt; &gt; x-ua-compatible: IE=edge,chrome=IE8
&gt; &gt; Content-Encoding: gzip
&gt; &gt; ========
&gt; &gt;
&gt; &gt; Action code:
&gt; &gt; ========
&gt; &gt; sub mytest : Local Args&#40;0&#41; {
&gt; &gt;     my &#40;$self, $c, $r, $p&#41; = getcontvars_noses @_;
&gt; &gt;     $c-&gt;res-&gt;content_type&#40; &#34;text/plain&#34; &#41;;
&gt; &gt;     $c-&gt;res-&gt;body&#40;  $p-&gt;{domains} &#41;;
&gt; &gt; }
&gt; &gt; ========
&gt; &gt;
&gt; &gt; Console:
&gt; &gt; ========
&gt; &gt; [error] Caught exception in engine &#34;Wide character in syswrite at
&gt; &gt; /usr/local/share/perl/5.14.2/Starman/Server.pm line 547.&#34;
&gt; &gt; ========
&gt; &gt;
&gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; one thing I wonder exactly what you think this should do?
</div>&gt; &gt;
&gt; &gt; Well, with encoding=&gt;undef it should do nothing with charsets. i.e.
&gt; &gt; return octets as is. i.e
&gt; &gt; probably $self-&gt;unescape_uri&#40;$_&#41; instead of decode_utf8&#40;$self-
<div class="message-stanza open">&gt; &gt; &gt; unescape_uri&#40;$_&#41;&#41;
</div>&gt; &gt;
&gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; I was taking the assumption that people would what Catalyst to
&gt; &gt; &gt; convert the encoded chacters to local unicode wide characters but
&gt; &gt; &gt; maybe that is not an ideal assumption?
</div>&gt; &gt;
&gt; &gt; Yes, right. With encoding NOT undef, Catalyst should convert binary
&gt; &gt; data to perl strings &#40;unicode wide characters&#41;.
&gt; &gt; But when encoding IS undef, it should pass binary data as-is. It&#39;s
&gt; &gt; exactly what it does with output data.
&gt; &gt; So with encoding undef input processing should be consistent with
&gt; &gt; output processing.
&gt; &gt;
&gt; &gt; We work with textual data in WINDOWS-1251 currently. That&#39;s pre-
&gt; &gt; unicode approach. We&#39;re migrating to unicode,
&gt; &gt; but we&#39;re just not there yet.
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; On Tue Mar 24 16:59:39 2015, JJNAPIORK wrote:
<div class="message-stanza open">&gt; &gt; &gt; Hey
&gt; &gt; &gt;
&gt; &gt; &gt; one thing I wonder exactly what you think this should do?  I was
&gt; &gt; &gt; taking the assumption that people would what Catalyst to convert
&gt; &gt; &gt; the
&gt; &gt; &gt; encoded chacters to local unicode wide characters but maybe that is
&gt; &gt; &gt; not an ideal assumption?
&gt; &gt; &gt;
&gt; &gt; &gt; talk to me about the use case and what you&#39;d ideally see here
&gt; &gt; &gt;
&gt; &gt; &gt; On Tue Mar 24 06:56:19 2015, vsespb wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; Hello.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Here is the diff:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-Runtime-">https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-Runtime-</a></span>
&gt; &gt; &gt; &gt; 5.90083/&#38;source=JJNAPIORK/Catalyst-Runtime-5.90082/
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; There is the line:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; map { defined $_ ? decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; : $_ }
&gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; It decodes data to Unicode string and assumes that it&#39;s in UTF-8,
&gt; &gt; &gt; &gt; it
&gt; &gt; &gt; &gt; ignores &#34;encoding&#34; option &#40;even encoding =&gt; undef&#41;.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Before 5.90083 logic was the same:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; map { decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; }
&gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; However, there was
&gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; -    if&#40;my $query_obj = $env-&gt;{&#39;plack.request.query&#39;}&#41; {
&gt; &gt; &gt; &gt; -         $c-&gt;request-&gt;query_parameters&#40;
&gt; &gt; &gt; &gt; -           $c-&gt;request-&gt;_use_hash_multivalue ?
&gt; &gt; &gt; &gt; -              $query_obj-&gt;clone :
&gt; &gt; &gt; &gt; -              $query_obj-&gt;as_hashref_mixed&#41;;
&gt; &gt; &gt; &gt; -         return;
&gt; &gt; &gt; &gt; -    }
&gt; &gt; &gt; &gt; -
&gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; before decoding.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; So, our site didn&#39;t reach this decoding, since $env-
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; {&#39;plack.request.query&#39;} was true.
</div>&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Use case:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Site runs under encoding =&gt; undef &#40;previously without encoding at
&gt; &gt; &gt; &gt; all&#41;.
&gt; &gt; &gt; &gt; Web page encoding is WINDOWS-1251, so  all incoming data,
&gt; &gt; &gt; &gt; including
&gt; &gt; &gt; &gt; query string is WINDOWS-1251 as well.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Example of URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://example.com/test?domains=%E4%EE%EC%E5%ED">http://example.com/test?domains=%E4%EE%EC%E5%ED</a></span>
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; %E4%EE%EC%E5%ED is Russian word in WINDOWS-1251 encoding.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; So in 5.90082 octets are passed as-is to the application. After
&gt; &gt; &gt; &gt; 5.90083 - it&#39;s decoded to Unicode string consists of not-a-
&gt; &gt; &gt; &gt; characters.
</div></div></div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;24&nbsp;14:04:05&nbsp;2015</span>
    <span class="description">jjnapiork [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ok so I think we can add a configurattion setting like &#39;url-decode-from-encoding&#39; which would instead of defaulting to utf-8 it would use whatever you set to encoding.  that way you can disable until you have time to change your code to match.  how does that sound?

anywhere else you&#39;d need this?

john
On Tue Mar 24 12:47:01 2015, vsespb wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Yes, all webpages are in windows-1251 charset.
&gt; All our template toolkit templates are in windows-1251 charset on
&gt; disk.
&gt; All perl source code is in windows-1251 &#40;thus string constants are
&gt; windows-1251&#41;
&gt; 
&gt; Links with query strings are created usually using URI module.
&gt; 
&gt; docs from URI module:
&gt; ===
&gt; The escaping &#40;percent encoding&#41; of chars in the 128 .. 255 range
&gt; passed to the URI constructor or when setting URI parts using the
&gt; accessor methods depend on the state of the internal UTF8 flag &#40;see
&gt; utf8::is_utf8&#41; of the string passed. If the UTF8 flag is set the UTF-8
&gt; encoded version of the character is percent encoded. If the UTF8 flag
&gt; isn&#39;t set the Latin-1 version &#40;byte&#41; of the character is percent
&gt; encoded. This basically exposes the internal encoding of Perl strings.
&gt; ===
&gt; 
&gt; i.e. it will escape strings without perl UTF-8 flag as byte percent
&gt; encoding. this works for us.
&gt; 
&gt; No, we dont use $c-&gt;encoding. We just set encoding to undef.
&gt; 
&gt; On Tue Mar 24 19:38:22 2015, JJNAPIORK wrote:
<div class="message-stanza open">&gt; &gt; Sorry one more question.  How are the links generated?  Do you have
&gt; &gt; web pages that are windows charset encoded?  Did you use $c-&gt;uri_for
&gt; &gt; or did you have links &#39;hard coded&#39;, or manually created?  Last are
&gt; &gt; you
&gt; &gt; doing the windows encoding for web pages &#40;I assume that is what you
&gt; &gt; are doing&#41; via setting $c-&gt;encoding or similar or did you have to
&gt; &gt; hack
&gt; &gt; catalyst to make it work the way you needed ?
&gt; &gt;
&gt; &gt;
&gt; &gt; On Tue Mar 24 12:28:37 2015, vsespb wrote:
<div class="message-stanza open">&gt; &gt; &gt; Request/Response:
&gt; &gt; &gt; ========
&gt; &gt; &gt; GET /misc/mytest?domains=%E4%EE%EC%E5%ED HTTP/1.1
&gt; &gt; &gt; Host: www1.reg.ru
&gt; &gt; &gt; User-Agent: Mozilla/5.0 &#40;X11; Ubuntu; Linux x86_64; rv:36.0&#41;
&gt; &gt; &gt; Gecko/20100101 Firefox/36.0
&gt; &gt; &gt; Accept:
&gt; &gt; &gt; text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
&gt; &gt; &gt; Accept-Language: en-US,en;q=0.5
&gt; &gt; &gt; Accept-Encoding: gzip, deflate
&gt; &gt; &gt; Cookie: [CUT]
&gt; &gt; &gt; Connection: keep-alive
&gt; &gt; &gt; Cache-Control: max-age=0
&gt; &gt; &gt;
&gt; &gt; &gt; HTTP/1.1 200 OK
&gt; &gt; &gt; Server: nginx
&gt; &gt; &gt; Date: Tue, 24 Mar 2015 16:19:45 GMT
&gt; &gt; &gt; Content-Type: text/html; charset=WINDOWS-1251
&gt; &gt; &gt; Transfer-Encoding: chunked
&gt; &gt; &gt; Connection: keep-alive
&gt; &gt; &gt; Content-Language: ru
&gt; &gt; &gt; Set-Cookie: [CUT]
&gt; &gt; &gt; X-Catalyst: 5.90083
&gt; &gt; &gt; x-ua-compatible: IE=edge,chrome=IE8
&gt; &gt; &gt; Content-Encoding: gzip
&gt; &gt; &gt; ========
&gt; &gt; &gt;
&gt; &gt; &gt; Action code:
&gt; &gt; &gt; ========
&gt; &gt; &gt; sub mytest : Local Args&#40;0&#41; {
&gt; &gt; &gt;     my &#40;$self, $c, $r, $p&#41; = getcontvars_noses @_;
&gt; &gt; &gt;     $c-&gt;res-&gt;content_type&#40; &#34;text/plain&#34; &#41;;
&gt; &gt; &gt;     $c-&gt;res-&gt;body&#40;  $p-&gt;{domains} &#41;;
&gt; &gt; &gt; }
&gt; &gt; &gt; ========
&gt; &gt; &gt;
&gt; &gt; &gt; Console:
&gt; &gt; &gt; ========
&gt; &gt; &gt; [error] Caught exception in engine &#34;Wide character in syswrite at
&gt; &gt; &gt; /usr/local/share/perl/5.14.2/Starman/Server.pm line 547.&#34;
&gt; &gt; &gt; ========
&gt; &gt; &gt;
&gt; &gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; &gt; one thing I wonder exactly what you think this should do?
</div>&gt; &gt; &gt;
&gt; &gt; &gt; Well, with encoding=&gt;undef it should do nothing with charsets. i.e.
&gt; &gt; &gt; return octets as is. i.e
&gt; &gt; &gt; probably $self-&gt;unescape_uri&#40;$_&#41; instead of decode_utf8&#40;$self-
<div class="message-stanza open">&gt; &gt; &gt; &gt; unescape_uri&#40;$_&#41;&#41;
</div>&gt; &gt; &gt;
&gt; &gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; &gt; I was taking the assumption that people would what Catalyst to
&gt; &gt; &gt; &gt; convert the encoded chacters to local unicode wide characters but
&gt; &gt; &gt; &gt; maybe that is not an ideal assumption?
</div>&gt; &gt; &gt;
&gt; &gt; &gt; Yes, right. With encoding NOT undef, Catalyst should convert binary
&gt; &gt; &gt; data to perl strings &#40;unicode wide characters&#41;.
&gt; &gt; &gt; But when encoding IS undef, it should pass binary data as-is. It&#39;s
&gt; &gt; &gt; exactly what it does with output data.
&gt; &gt; &gt; So with encoding undef input processing should be consistent with
&gt; &gt; &gt; output processing.
&gt; &gt; &gt;
&gt; &gt; &gt; We work with textual data in WINDOWS-1251 currently. That&#39;s pre-
&gt; &gt; &gt; unicode approach. We&#39;re migrating to unicode,
&gt; &gt; &gt; but we&#39;re just not there yet.
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; On Tue Mar 24 16:59:39 2015, JJNAPIORK wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; Hey
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; one thing I wonder exactly what you think this should do?  I was
&gt; &gt; &gt; &gt; taking the assumption that people would what Catalyst to convert
&gt; &gt; &gt; &gt; the
&gt; &gt; &gt; &gt; encoded chacters to local unicode wide characters but maybe that
&gt; &gt; &gt; &gt; is
&gt; &gt; &gt; &gt; not an ideal assumption?
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; talk to me about the use case and what you&#39;d ideally see here
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; On Tue Mar 24 06:56:19 2015, vsespb wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; Hello.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Here is the diff:
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-">https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-</a></span>
&gt; &gt; &gt; &gt; &gt; Runtime-
&gt; &gt; &gt; &gt; &gt; 5.90083/&#38;source=JJNAPIORK/Catalyst-Runtime-5.90082/
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; There is the line:
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; map { defined $_ ? decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; : $_ }
&gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; It decodes data to Unicode string and assumes that it&#39;s in UTF-
&gt; &gt; &gt; &gt; &gt; 8,
&gt; &gt; &gt; &gt; &gt; it
&gt; &gt; &gt; &gt; &gt; ignores &#34;encoding&#34; option &#40;even encoding =&gt; undef&#41;.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Before 5.90083 logic was the same:
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; map { decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; }
&gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; However, there was
&gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; -    if&#40;my $query_obj = $env-&gt;{&#39;plack.request.query&#39;}&#41; {
&gt; &gt; &gt; &gt; &gt; -         $c-&gt;request-&gt;query_parameters&#40;
&gt; &gt; &gt; &gt; &gt; -           $c-&gt;request-&gt;_use_hash_multivalue ?
&gt; &gt; &gt; &gt; &gt; -              $query_obj-&gt;clone :
&gt; &gt; &gt; &gt; &gt; -              $query_obj-&gt;as_hashref_mixed&#41;;
&gt; &gt; &gt; &gt; &gt; -         return;
&gt; &gt; &gt; &gt; &gt; -    }
&gt; &gt; &gt; &gt; &gt; -
&gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; before decoding.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; So, our site didn&#39;t reach this decoding, since $env-
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; {&#39;plack.request.query&#39;} was true.
</div>&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Use case:
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Site runs under encoding =&gt; undef &#40;previously without encoding
&gt; &gt; &gt; &gt; &gt; at
&gt; &gt; &gt; &gt; &gt; all&#41;.
&gt; &gt; &gt; &gt; &gt; Web page encoding is WINDOWS-1251, so  all incoming data,
&gt; &gt; &gt; &gt; &gt; including
&gt; &gt; &gt; &gt; &gt; query string is WINDOWS-1251 as well.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Example of URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://example.com/test?domains=%E4%EE%EC%E5%ED">http://example.com/test?domains=%E4%EE%EC%E5%ED</a></span>
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; %E4%EE%EC%E5%ED is Russian word in WINDOWS-1251 encoding.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; So in 5.90082 octets are passed as-is to the application. After
&gt; &gt; &gt; &gt; &gt; 5.90083 - it&#39;s decoded to Unicode string consists of not-a-
&gt; &gt; &gt; &gt; &gt; characters.
</div></div></div></div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;24&nbsp;14:16:06&nbsp;2015</span>
    <span class="description">victor [...] vsespb.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">IF there will be a setting url-decode-from-encoding=undef, which _disables_ any decoding, this would work.

I.e. url-decode-from-encoding=windows-1251 will decode windows-1251 to Perl Character Strings &#40;unicode&#41;. This would not work.
Need option url-decode-from-encoding=undef to skip any decoding.

However I am not sure why there is a need in another option. There is already &#34;encoding&#34; option. For our case it&#39;s encoding=&gt;undef.

Is there a case when one would use encoding=&gt;undef, but url-decode-from-encoding not undef &#40;or url-decode-from-encoding=utf8, like now&#41;?
I don&#39;t think so! With encoding=&gt;undef one outputs binary data, this makes sense when one works not in modern Perl Unicode model, but
works with binary strings in single byte encodings &#40;like windows-1251; any single-byte encoding, except latin-1, as latin-1 is compatible with perl Unicode&#41;.
And, if we work with such data, we won&#39;t need input in Perl Character Strings &#40;unicode&#41;!


On Tue Mar 24 21:04:05 2015, JJNAPIORK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Ok so I think we can add a configurattion setting like &#39;url-decode-
&gt; from-encoding&#39; which would instead of defaulting to utf-8 it would use
&gt; whatever you set to encoding.  that way you can disable until you have
&gt; time to change your code to match.  how does that sound?
&gt; 
&gt; anywhere else you&#39;d need this?
&gt; 
&gt; john
&gt; On Tue Mar 24 12:47:01 2015, vsespb wrote:
<div class="message-stanza open">&gt; &gt; Yes, all webpages are in windows-1251 charset.
&gt; &gt; All our template toolkit templates are in windows-1251 charset on
&gt; &gt; disk.
&gt; &gt; All perl source code is in windows-1251 &#40;thus string constants are
&gt; &gt; windows-1251&#41;
&gt; &gt;
&gt; &gt; Links with query strings are created usually using URI module.
&gt; &gt;
&gt; &gt; docs from URI module:
&gt; &gt; ===
&gt; &gt; The escaping &#40;percent encoding&#41; of chars in the 128 .. 255 range
&gt; &gt; passed to the URI constructor or when setting URI parts using the
&gt; &gt; accessor methods depend on the state of the internal UTF8 flag &#40;see
&gt; &gt; utf8::is_utf8&#41; of the string passed. If the UTF8 flag is set the UTF-
&gt; &gt; 8
&gt; &gt; encoded version of the character is percent encoded. If the UTF8 flag
&gt; &gt; isn&#39;t set the Latin-1 version &#40;byte&#41; of the character is percent
&gt; &gt; encoded. This basically exposes the internal encoding of Perl
&gt; &gt; strings.
&gt; &gt; ===
&gt; &gt;
&gt; &gt; i.e. it will escape strings without perl UTF-8 flag as byte percent
&gt; &gt; encoding. this works for us.
&gt; &gt;
&gt; &gt; No, we dont use $c-&gt;encoding. We just set encoding to undef.
&gt; &gt;
&gt; &gt; On Tue Mar 24 19:38:22 2015, JJNAPIORK wrote:
<div class="message-stanza open">&gt; &gt; &gt; Sorry one more question.  How are the links generated?  Do you have
&gt; &gt; &gt; web pages that are windows charset encoded?  Did you use $c-
<div class="message-stanza open">&gt; &gt; &gt; &gt;uri_for
</div>&gt; &gt; &gt; or did you have links &#39;hard coded&#39;, or manually created?  Last are
&gt; &gt; &gt; you
&gt; &gt; &gt; doing the windows encoding for web pages &#40;I assume that is what you
&gt; &gt; &gt; are doing&#41; via setting $c-&gt;encoding or similar or did you have to
&gt; &gt; &gt; hack
&gt; &gt; &gt; catalyst to make it work the way you needed ?
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; On Tue Mar 24 12:28:37 2015, vsespb wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; Request/Response:
&gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt; GET /misc/mytest?domains=%E4%EE%EC%E5%ED HTTP/1.1
&gt; &gt; &gt; &gt; Host: www1.reg.ru
&gt; &gt; &gt; &gt; User-Agent: Mozilla/5.0 &#40;X11; Ubuntu; Linux x86_64; rv:36.0&#41;
&gt; &gt; &gt; &gt; Gecko/20100101 Firefox/36.0
&gt; &gt; &gt; &gt; Accept:
&gt; &gt; &gt; &gt; text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
&gt; &gt; &gt; &gt; Accept-Language: en-US,en;q=0.5
&gt; &gt; &gt; &gt; Accept-Encoding: gzip, deflate
&gt; &gt; &gt; &gt; Cookie: [CUT]
&gt; &gt; &gt; &gt; Connection: keep-alive
&gt; &gt; &gt; &gt; Cache-Control: max-age=0
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; HTTP/1.1 200 OK
&gt; &gt; &gt; &gt; Server: nginx
&gt; &gt; &gt; &gt; Date: Tue, 24 Mar 2015 16:19:45 GMT
&gt; &gt; &gt; &gt; Content-Type: text/html; charset=WINDOWS-1251
&gt; &gt; &gt; &gt; Transfer-Encoding: chunked
&gt; &gt; &gt; &gt; Connection: keep-alive
&gt; &gt; &gt; &gt; Content-Language: ru
&gt; &gt; &gt; &gt; Set-Cookie: [CUT]
&gt; &gt; &gt; &gt; X-Catalyst: 5.90083
&gt; &gt; &gt; &gt; x-ua-compatible: IE=edge,chrome=IE8
&gt; &gt; &gt; &gt; Content-Encoding: gzip
&gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Action code:
&gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt; sub mytest : Local Args&#40;0&#41; {
&gt; &gt; &gt; &gt;     my &#40;$self, $c, $r, $p&#41; = getcontvars_noses @_;
&gt; &gt; &gt; &gt;     $c-&gt;res-&gt;content_type&#40; &#34;text/plain&#34; &#41;;
&gt; &gt; &gt; &gt;     $c-&gt;res-&gt;body&#40;  $p-&gt;{domains} &#41;;
&gt; &gt; &gt; &gt; }
&gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Console:
&gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt; [error] Caught exception in engine &#34;Wide character in syswrite at
&gt; &gt; &gt; &gt; /usr/local/share/perl/5.14.2/Starman/Server.pm line 547.&#34;
&gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; one thing I wonder exactly what you think this should do?
</div>&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Well, with encoding=&gt;undef it should do nothing with charsets.
&gt; &gt; &gt; &gt; i.e.
&gt; &gt; &gt; &gt; return octets as is. i.e
&gt; &gt; &gt; &gt; probably $self-&gt;unescape_uri&#40;$_&#41; instead of decode_utf8&#40;$self-
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; unescape_uri&#40;$_&#41;&#41;
</div>&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; I was taking the assumption that people would what Catalyst to
&gt; &gt; &gt; &gt; &gt; convert the encoded chacters to local unicode wide characters
&gt; &gt; &gt; &gt; &gt; but
&gt; &gt; &gt; &gt; &gt; maybe that is not an ideal assumption?
</div>&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Yes, right. With encoding NOT undef, Catalyst should convert
&gt; &gt; &gt; &gt; binary
&gt; &gt; &gt; &gt; data to perl strings &#40;unicode wide characters&#41;.
&gt; &gt; &gt; &gt; But when encoding IS undef, it should pass binary data as-is.
&gt; &gt; &gt; &gt; It&#39;s
&gt; &gt; &gt; &gt; exactly what it does with output data.
&gt; &gt; &gt; &gt; So with encoding undef input processing should be consistent with
&gt; &gt; &gt; &gt; output processing.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; We work with textual data in WINDOWS-1251 currently. That&#39;s pre-
&gt; &gt; &gt; &gt; unicode approach. We&#39;re migrating to unicode,
&gt; &gt; &gt; &gt; but we&#39;re just not there yet.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; On Tue Mar 24 16:59:39 2015, JJNAPIORK wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; Hey
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; one thing I wonder exactly what you think this should do?  I
&gt; &gt; &gt; &gt; &gt; was
&gt; &gt; &gt; &gt; &gt; taking the assumption that people would what Catalyst to
&gt; &gt; &gt; &gt; &gt; convert
&gt; &gt; &gt; &gt; &gt; the
&gt; &gt; &gt; &gt; &gt; encoded chacters to local unicode wide characters but maybe
&gt; &gt; &gt; &gt; &gt; that
&gt; &gt; &gt; &gt; &gt; is
&gt; &gt; &gt; &gt; &gt; not an ideal assumption?
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; talk to me about the use case and what you&#39;d ideally see here
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; On Tue Mar 24 06:56:19 2015, vsespb wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; Hello.
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Here is the diff:
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-">https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-</a></span>
&gt; &gt; &gt; &gt; &gt; &gt; Runtime-
&gt; &gt; &gt; &gt; &gt; &gt; 5.90083/&#38;source=JJNAPIORK/Catalyst-Runtime-5.90082/
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; There is the line:
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt; map { defined $_ ? decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; : $_
&gt; &gt; &gt; &gt; &gt; &gt; }
&gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; It decodes data to Unicode string and assumes that it&#39;s in
&gt; &gt; &gt; &gt; &gt; &gt; UTF-
&gt; &gt; &gt; &gt; &gt; &gt; 8,
&gt; &gt; &gt; &gt; &gt; &gt; it
&gt; &gt; &gt; &gt; &gt; &gt; ignores &#34;encoding&#34; option &#40;even encoding =&gt; undef&#41;.
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Before 5.90083 logic was the same:
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt; map { decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; }
&gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; However, there was
&gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt; -    if&#40;my $query_obj = $env-&gt;{&#39;plack.request.query&#39;}&#41; {
&gt; &gt; &gt; &gt; &gt; &gt; -         $c-&gt;request-&gt;query_parameters&#40;
&gt; &gt; &gt; &gt; &gt; &gt; -           $c-&gt;request-&gt;_use_hash_multivalue ?
&gt; &gt; &gt; &gt; &gt; &gt; -              $query_obj-&gt;clone :
&gt; &gt; &gt; &gt; &gt; &gt; -              $query_obj-&gt;as_hashref_mixed&#41;;
&gt; &gt; &gt; &gt; &gt; &gt; -         return;
&gt; &gt; &gt; &gt; &gt; &gt; -    }
&gt; &gt; &gt; &gt; &gt; &gt; -
&gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt; before decoding.
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; So, our site didn&#39;t reach this decoding, since $env-
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; {&#39;plack.request.query&#39;} was true.
</div>&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Use case:
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Site runs under encoding =&gt; undef &#40;previously without
&gt; &gt; &gt; &gt; &gt; &gt; encoding
&gt; &gt; &gt; &gt; &gt; &gt; at
&gt; &gt; &gt; &gt; &gt; &gt; all&#41;.
&gt; &gt; &gt; &gt; &gt; &gt; Web page encoding is WINDOWS-1251, so  all incoming data,
&gt; &gt; &gt; &gt; &gt; &gt; including
&gt; &gt; &gt; &gt; &gt; &gt; query string is WINDOWS-1251 as well.
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Example of URL:
&gt; &gt; &gt; &gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://example.com/test?domains=%E4%EE%EC%E5%ED">http://example.com/test?domains=%E4%EE%EC%E5%ED</a></span>
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; %E4%EE%EC%E5%ED is Russian word in WINDOWS-1251 encoding.
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; So in 5.90082 octets are passed as-is to the application.
&gt; &gt; &gt; &gt; &gt; &gt; After
&gt; &gt; &gt; &gt; &gt; &gt; 5.90083 - it&#39;s decoded to Unicode string consists of not-a-
&gt; &gt; &gt; &gt; &gt; &gt; characters.
</div></div></div></div></div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;24&nbsp;14:31:01&nbsp;2015</span>
    <span class="description">jjnapiork [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Just to be clear, does it sound like adding a new $app configuration like &#34;decode_URI_query_from_encoding_value&#39; &#40;or similar&#41; which would decode the URL query based on whatever you set $app-&gt;encoding to &#40;or nothing if that is undef&#41; would fix this for you?  Would this be a good solution until someday &#40;if ever&#41; you are able to change your code as to be UTF-8 top to bottom?

jnap

On Tue Mar 24 14:04:05 2015, JJNAPIORK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Ok so I think we can add a configurattion setting like &#39;url-decode-
&gt; from-encoding&#39; which would instead of defaulting to utf-8 it would use
&gt; whatever you set to encoding.  that way you can disable until you have
&gt; time to change your code to match.  how does that sound?
&gt; 
&gt; anywhere else you&#39;d need this?
&gt; 
&gt; john
&gt; On Tue Mar 24 12:47:01 2015, vsespb wrote:
<div class="message-stanza open">&gt; &gt; Yes, all webpages are in windows-1251 charset.
&gt; &gt; All our template toolkit templates are in windows-1251 charset on
&gt; &gt; disk.
&gt; &gt; All perl source code is in windows-1251 &#40;thus string constants are
&gt; &gt; windows-1251&#41;
&gt; &gt;
&gt; &gt; Links with query strings are created usually using URI module.
&gt; &gt;
&gt; &gt; docs from URI module:
&gt; &gt; ===
&gt; &gt; The escaping &#40;percent encoding&#41; of chars in the 128 .. 255 range
&gt; &gt; passed to the URI constructor or when setting URI parts using the
&gt; &gt; accessor methods depend on the state of the internal UTF8 flag &#40;see
&gt; &gt; utf8::is_utf8&#41; of the string passed. If the UTF8 flag is set the UTF-
&gt; &gt; 8
&gt; &gt; encoded version of the character is percent encoded. If the UTF8 flag
&gt; &gt; isn&#39;t set the Latin-1 version &#40;byte&#41; of the character is percent
&gt; &gt; encoded. This basically exposes the internal encoding of Perl
&gt; &gt; strings.
&gt; &gt; ===
&gt; &gt;
&gt; &gt; i.e. it will escape strings without perl UTF-8 flag as byte percent
&gt; &gt; encoding. this works for us.
&gt; &gt;
&gt; &gt; No, we dont use $c-&gt;encoding. We just set encoding to undef.
&gt; &gt;
&gt; &gt; On Tue Mar 24 19:38:22 2015, JJNAPIORK wrote:
<div class="message-stanza open">&gt; &gt; &gt; Sorry one more question.  How are the links generated?  Do you have
&gt; &gt; &gt; web pages that are windows charset encoded?  Did you use $c-
<div class="message-stanza open">&gt; &gt; &gt; &gt;uri_for
</div>&gt; &gt; &gt; or did you have links &#39;hard coded&#39;, or manually created?  Last are
&gt; &gt; &gt; you
&gt; &gt; &gt; doing the windows encoding for web pages &#40;I assume that is what you
&gt; &gt; &gt; are doing&#41; via setting $c-&gt;encoding or similar or did you have to
&gt; &gt; &gt; hack
&gt; &gt; &gt; catalyst to make it work the way you needed ?
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; On Tue Mar 24 12:28:37 2015, vsespb wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; Request/Response:
&gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt; GET /misc/mytest?domains=%E4%EE%EC%E5%ED HTTP/1.1
&gt; &gt; &gt; &gt; Host: www1.reg.ru
&gt; &gt; &gt; &gt; User-Agent: Mozilla/5.0 &#40;X11; Ubuntu; Linux x86_64; rv:36.0&#41;
&gt; &gt; &gt; &gt; Gecko/20100101 Firefox/36.0
&gt; &gt; &gt; &gt; Accept:
&gt; &gt; &gt; &gt; text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
&gt; &gt; &gt; &gt; Accept-Language: en-US,en;q=0.5
&gt; &gt; &gt; &gt; Accept-Encoding: gzip, deflate
&gt; &gt; &gt; &gt; Cookie: [CUT]
&gt; &gt; &gt; &gt; Connection: keep-alive
&gt; &gt; &gt; &gt; Cache-Control: max-age=0
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; HTTP/1.1 200 OK
&gt; &gt; &gt; &gt; Server: nginx
&gt; &gt; &gt; &gt; Date: Tue, 24 Mar 2015 16:19:45 GMT
&gt; &gt; &gt; &gt; Content-Type: text/html; charset=WINDOWS-1251
&gt; &gt; &gt; &gt; Transfer-Encoding: chunked
&gt; &gt; &gt; &gt; Connection: keep-alive
&gt; &gt; &gt; &gt; Content-Language: ru
&gt; &gt; &gt; &gt; Set-Cookie: [CUT]
&gt; &gt; &gt; &gt; X-Catalyst: 5.90083
&gt; &gt; &gt; &gt; x-ua-compatible: IE=edge,chrome=IE8
&gt; &gt; &gt; &gt; Content-Encoding: gzip
&gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Action code:
&gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt; sub mytest : Local Args&#40;0&#41; {
&gt; &gt; &gt; &gt;     my &#40;$self, $c, $r, $p&#41; = getcontvars_noses @_;
&gt; &gt; &gt; &gt;     $c-&gt;res-&gt;content_type&#40; &#34;text/plain&#34; &#41;;
&gt; &gt; &gt; &gt;     $c-&gt;res-&gt;body&#40;  $p-&gt;{domains} &#41;;
&gt; &gt; &gt; &gt; }
&gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Console:
&gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt; [error] Caught exception in engine &#34;Wide character in syswrite at
&gt; &gt; &gt; &gt; /usr/local/share/perl/5.14.2/Starman/Server.pm line 547.&#34;
&gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; one thing I wonder exactly what you think this should do?
</div>&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Well, with encoding=&gt;undef it should do nothing with charsets.
&gt; &gt; &gt; &gt; i.e.
&gt; &gt; &gt; &gt; return octets as is. i.e
&gt; &gt; &gt; &gt; probably $self-&gt;unescape_uri&#40;$_&#41; instead of decode_utf8&#40;$self-
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; unescape_uri&#40;$_&#41;&#41;
</div>&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; I was taking the assumption that people would what Catalyst to
&gt; &gt; &gt; &gt; &gt; convert the encoded chacters to local unicode wide characters
&gt; &gt; &gt; &gt; &gt; but
&gt; &gt; &gt; &gt; &gt; maybe that is not an ideal assumption?
</div>&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Yes, right. With encoding NOT undef, Catalyst should convert
&gt; &gt; &gt; &gt; binary
&gt; &gt; &gt; &gt; data to perl strings &#40;unicode wide characters&#41;.
&gt; &gt; &gt; &gt; But when encoding IS undef, it should pass binary data as-is.
&gt; &gt; &gt; &gt; It&#39;s
&gt; &gt; &gt; &gt; exactly what it does with output data.
&gt; &gt; &gt; &gt; So with encoding undef input processing should be consistent with
&gt; &gt; &gt; &gt; output processing.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; We work with textual data in WINDOWS-1251 currently. That&#39;s pre-
&gt; &gt; &gt; &gt; unicode approach. We&#39;re migrating to unicode,
&gt; &gt; &gt; &gt; but we&#39;re just not there yet.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; On Tue Mar 24 16:59:39 2015, JJNAPIORK wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; Hey
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; one thing I wonder exactly what you think this should do?  I
&gt; &gt; &gt; &gt; &gt; was
&gt; &gt; &gt; &gt; &gt; taking the assumption that people would what Catalyst to
&gt; &gt; &gt; &gt; &gt; convert
&gt; &gt; &gt; &gt; &gt; the
&gt; &gt; &gt; &gt; &gt; encoded chacters to local unicode wide characters but maybe
&gt; &gt; &gt; &gt; &gt; that
&gt; &gt; &gt; &gt; &gt; is
&gt; &gt; &gt; &gt; &gt; not an ideal assumption?
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; talk to me about the use case and what you&#39;d ideally see here
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; On Tue Mar 24 06:56:19 2015, vsespb wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; Hello.
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Here is the diff:
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-">https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-</a></span>
&gt; &gt; &gt; &gt; &gt; &gt; Runtime-
&gt; &gt; &gt; &gt; &gt; &gt; 5.90083/&#38;source=JJNAPIORK/Catalyst-Runtime-5.90082/
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; There is the line:
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt; map { defined $_ ? decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; : $_
&gt; &gt; &gt; &gt; &gt; &gt; }
&gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; It decodes data to Unicode string and assumes that it&#39;s in
&gt; &gt; &gt; &gt; &gt; &gt; UTF-
&gt; &gt; &gt; &gt; &gt; &gt; 8,
&gt; &gt; &gt; &gt; &gt; &gt; it
&gt; &gt; &gt; &gt; &gt; &gt; ignores &#34;encoding&#34; option &#40;even encoding =&gt; undef&#41;.
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Before 5.90083 logic was the same:
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt; map { decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; }
&gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; However, there was
&gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt; -    if&#40;my $query_obj = $env-&gt;{&#39;plack.request.query&#39;}&#41; {
&gt; &gt; &gt; &gt; &gt; &gt; -         $c-&gt;request-&gt;query_parameters&#40;
&gt; &gt; &gt; &gt; &gt; &gt; -           $c-&gt;request-&gt;_use_hash_multivalue ?
&gt; &gt; &gt; &gt; &gt; &gt; -              $query_obj-&gt;clone :
&gt; &gt; &gt; &gt; &gt; &gt; -              $query_obj-&gt;as_hashref_mixed&#41;;
&gt; &gt; &gt; &gt; &gt; &gt; -         return;
&gt; &gt; &gt; &gt; &gt; &gt; -    }
&gt; &gt; &gt; &gt; &gt; &gt; -
&gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt; before decoding.
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; So, our site didn&#39;t reach this decoding, since $env-
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; {&#39;plack.request.query&#39;} was true.
</div>&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Use case:
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Site runs under encoding =&gt; undef &#40;previously without
&gt; &gt; &gt; &gt; &gt; &gt; encoding
&gt; &gt; &gt; &gt; &gt; &gt; at
&gt; &gt; &gt; &gt; &gt; &gt; all&#41;.
&gt; &gt; &gt; &gt; &gt; &gt; Web page encoding is WINDOWS-1251, so  all incoming data,
&gt; &gt; &gt; &gt; &gt; &gt; including
&gt; &gt; &gt; &gt; &gt; &gt; query string is WINDOWS-1251 as well.
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Example of URL:
&gt; &gt; &gt; &gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://example.com/test?domains=%E4%EE%EC%E5%ED">http://example.com/test?domains=%E4%EE%EC%E5%ED</a></span>
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; %E4%EE%EC%E5%ED is Russian word in WINDOWS-1251 encoding.
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; So in 5.90082 octets are passed as-is to the application.
&gt; &gt; &gt; &gt; &gt; &gt; After
&gt; &gt; &gt; &gt; &gt; &gt; 5.90083 - it&#39;s decoded to Unicode string consists of not-a-
&gt; &gt; &gt; &gt; &gt; &gt; characters.
</div></div></div></div></div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;24&nbsp;14:37:58&nbsp;2015</span>
    <span class="description">victor [...] vsespb.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; does it sound like adding a new $app configuration like &#34;decode_URI_query_from_encoding_value&#39; &#40;or similar&#41; which would decode the URL query based on whatever you set $app-&gt;encoding to &#40;or nothing if that is undef&#41; 
</div>
yes! &#40;and when encoding==undef, no decoding happens&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Would this be a good solution until someday &#40;if ever&#41; you are able to change your code as to be UTF-8 top to bottom?
</div>
yes!



On Tue Mar 24 21:31:01 2015, JJNAPIORK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Just to be clear, does it sound like adding a new $app configuration
&gt; like &#34;decode_URI_query_from_encoding_value&#39; &#40;or similar&#41; which would
&gt; decode the URL query based on whatever you set $app-&gt;encoding to &#40;or
&gt; nothing if that is undef&#41; would fix this for you?  Would this be a
&gt; good solution until someday &#40;if ever&#41; you are able to change your code
&gt; as to be UTF-8 top to bottom?
&gt; 
&gt; jnap
&gt; 
&gt; On Tue Mar 24 14:04:05 2015, JJNAPIORK wrote:
<div class="message-stanza open">&gt; &gt; Ok so I think we can add a configurattion setting like &#39;url-decode-
&gt; &gt; from-encoding&#39; which would instead of defaulting to utf-8 it would
&gt; &gt; use
&gt; &gt; whatever you set to encoding.  that way you can disable until you
&gt; &gt; have
&gt; &gt; time to change your code to match.  how does that sound?
&gt; &gt;
&gt; &gt; anywhere else you&#39;d need this?
&gt; &gt;
&gt; &gt; john
&gt; &gt; On Tue Mar 24 12:47:01 2015, vsespb wrote:
<div class="message-stanza open">&gt; &gt; &gt; Yes, all webpages are in windows-1251 charset.
&gt; &gt; &gt; All our template toolkit templates are in windows-1251 charset on
&gt; &gt; &gt; disk.
&gt; &gt; &gt; All perl source code is in windows-1251 &#40;thus string constants are
&gt; &gt; &gt; windows-1251&#41;
&gt; &gt; &gt;
&gt; &gt; &gt; Links with query strings are created usually using URI module.
&gt; &gt; &gt;
&gt; &gt; &gt; docs from URI module:
&gt; &gt; &gt; ===
&gt; &gt; &gt; The escaping &#40;percent encoding&#41; of chars in the 128 .. 255 range
&gt; &gt; &gt; passed to the URI constructor or when setting URI parts using the
&gt; &gt; &gt; accessor methods depend on the state of the internal UTF8 flag &#40;see
&gt; &gt; &gt; utf8::is_utf8&#41; of the string passed. If the UTF8 flag is set the
&gt; &gt; &gt; UTF-
&gt; &gt; &gt; 8
&gt; &gt; &gt; encoded version of the character is percent encoded. If the UTF8
&gt; &gt; &gt; flag
&gt; &gt; &gt; isn&#39;t set the Latin-1 version &#40;byte&#41; of the character is percent
&gt; &gt; &gt; encoded. This basically exposes the internal encoding of Perl
&gt; &gt; &gt; strings.
&gt; &gt; &gt; ===
&gt; &gt; &gt;
&gt; &gt; &gt; i.e. it will escape strings without perl UTF-8 flag as byte percent
&gt; &gt; &gt; encoding. this works for us.
&gt; &gt; &gt;
&gt; &gt; &gt; No, we dont use $c-&gt;encoding. We just set encoding to undef.
&gt; &gt; &gt;
&gt; &gt; &gt; On Tue Mar 24 19:38:22 2015, JJNAPIORK wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; Sorry one more question.  How are the links generated?  Do you
&gt; &gt; &gt; &gt; have
&gt; &gt; &gt; &gt; web pages that are windows charset encoded?  Did you use $c-
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; uri_for
</div>&gt; &gt; &gt; &gt; or did you have links &#39;hard coded&#39;, or manually created?  Last
&gt; &gt; &gt; &gt; are
&gt; &gt; &gt; &gt; you
&gt; &gt; &gt; &gt; doing the windows encoding for web pages &#40;I assume that is what
&gt; &gt; &gt; &gt; you
&gt; &gt; &gt; &gt; are doing&#41; via setting $c-&gt;encoding or similar or did you have to
&gt; &gt; &gt; &gt; hack
&gt; &gt; &gt; &gt; catalyst to make it work the way you needed ?
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; On Tue Mar 24 12:28:37 2015, vsespb wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; Request/Response:
&gt; &gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt; &gt; GET /misc/mytest?domains=%E4%EE%EC%E5%ED HTTP/1.1
&gt; &gt; &gt; &gt; &gt; Host: www1.reg.ru
&gt; &gt; &gt; &gt; &gt; User-Agent: Mozilla/5.0 &#40;X11; Ubuntu; Linux x86_64; rv:36.0&#41;
&gt; &gt; &gt; &gt; &gt; Gecko/20100101 Firefox/36.0
&gt; &gt; &gt; &gt; &gt; Accept:
&gt; &gt; &gt; &gt; &gt; text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
&gt; &gt; &gt; &gt; &gt; Accept-Language: en-US,en;q=0.5
&gt; &gt; &gt; &gt; &gt; Accept-Encoding: gzip, deflate
&gt; &gt; &gt; &gt; &gt; Cookie: [CUT]
&gt; &gt; &gt; &gt; &gt; Connection: keep-alive
&gt; &gt; &gt; &gt; &gt; Cache-Control: max-age=0
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; HTTP/1.1 200 OK
&gt; &gt; &gt; &gt; &gt; Server: nginx
&gt; &gt; &gt; &gt; &gt; Date: Tue, 24 Mar 2015 16:19:45 GMT
&gt; &gt; &gt; &gt; &gt; Content-Type: text/html; charset=WINDOWS-1251
&gt; &gt; &gt; &gt; &gt; Transfer-Encoding: chunked
&gt; &gt; &gt; &gt; &gt; Connection: keep-alive
&gt; &gt; &gt; &gt; &gt; Content-Language: ru
&gt; &gt; &gt; &gt; &gt; Set-Cookie: [CUT]
&gt; &gt; &gt; &gt; &gt; X-Catalyst: 5.90083
&gt; &gt; &gt; &gt; &gt; x-ua-compatible: IE=edge,chrome=IE8
&gt; &gt; &gt; &gt; &gt; Content-Encoding: gzip
&gt; &gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Action code:
&gt; &gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt; &gt; sub mytest : Local Args&#40;0&#41; {
&gt; &gt; &gt; &gt; &gt;     my &#40;$self, $c, $r, $p&#41; = getcontvars_noses @_;
&gt; &gt; &gt; &gt; &gt;     $c-&gt;res-&gt;content_type&#40; &#34;text/plain&#34; &#41;;
&gt; &gt; &gt; &gt; &gt;     $c-&gt;res-&gt;body&#40;  $p-&gt;{domains} &#41;;
&gt; &gt; &gt; &gt; &gt; }
&gt; &gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Console:
&gt; &gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt; &gt; [error] Caught exception in engine &#34;Wide character in syswrite
&gt; &gt; &gt; &gt; &gt; at
&gt; &gt; &gt; &gt; &gt; /usr/local/share/perl/5.14.2/Starman/Server.pm line 547.&#34;
&gt; &gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; one thing I wonder exactly what you think this should do?
</div>&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Well, with encoding=&gt;undef it should do nothing with charsets.
&gt; &gt; &gt; &gt; &gt; i.e.
&gt; &gt; &gt; &gt; &gt; return octets as is. i.e
&gt; &gt; &gt; &gt; &gt; probably $self-&gt;unescape_uri&#40;$_&#41; instead of decode_utf8&#40;$self-
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; unescape_uri&#40;$_&#41;&#41;
</div>&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; I was taking the assumption that people would what Catalyst
&gt; &gt; &gt; &gt; &gt; &gt; to
&gt; &gt; &gt; &gt; &gt; &gt; convert the encoded chacters to local unicode wide characters
&gt; &gt; &gt; &gt; &gt; &gt; but
&gt; &gt; &gt; &gt; &gt; &gt; maybe that is not an ideal assumption?
</div>&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Yes, right. With encoding NOT undef, Catalyst should convert
&gt; &gt; &gt; &gt; &gt; binary
&gt; &gt; &gt; &gt; &gt; data to perl strings &#40;unicode wide characters&#41;.
&gt; &gt; &gt; &gt; &gt; But when encoding IS undef, it should pass binary data as-is.
&gt; &gt; &gt; &gt; &gt; It&#39;s
&gt; &gt; &gt; &gt; &gt; exactly what it does with output data.
&gt; &gt; &gt; &gt; &gt; So with encoding undef input processing should be consistent
&gt; &gt; &gt; &gt; &gt; with
&gt; &gt; &gt; &gt; &gt; output processing.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; We work with textual data in WINDOWS-1251 currently. That&#39;s
&gt; &gt; &gt; &gt; &gt; pre-
&gt; &gt; &gt; &gt; &gt; unicode approach. We&#39;re migrating to unicode,
&gt; &gt; &gt; &gt; &gt; but we&#39;re just not there yet.
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; On Tue Mar 24 16:59:39 2015, JJNAPIORK wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; Hey
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; one thing I wonder exactly what you think this should do?  I
&gt; &gt; &gt; &gt; &gt; &gt; was
&gt; &gt; &gt; &gt; &gt; &gt; taking the assumption that people would what Catalyst to
&gt; &gt; &gt; &gt; &gt; &gt; convert
&gt; &gt; &gt; &gt; &gt; &gt; the
&gt; &gt; &gt; &gt; &gt; &gt; encoded chacters to local unicode wide characters but maybe
&gt; &gt; &gt; &gt; &gt; &gt; that
&gt; &gt; &gt; &gt; &gt; &gt; is
&gt; &gt; &gt; &gt; &gt; &gt; not an ideal assumption?
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; talk to me about the use case and what you&#39;d ideally see here
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; On Tue Mar 24 06:56:19 2015, vsespb wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; Hello.
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; Here is the diff:
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-">https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-</a></span>
&gt; &gt; &gt; &gt; &gt; &gt; &gt; Runtime-
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 5.90083/&#38;source=JJNAPIORK/Catalyst-Runtime-5.90082/
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; There is the line:
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt; &gt; map { defined $_ ? decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; :
&gt; &gt; &gt; &gt; &gt; &gt; &gt; $_
&gt; &gt; &gt; &gt; &gt; &gt; &gt; }
&gt; &gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; It decodes data to Unicode string and assumes that it&#39;s in
&gt; &gt; &gt; &gt; &gt; &gt; &gt; UTF-
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 8,
&gt; &gt; &gt; &gt; &gt; &gt; &gt; it
&gt; &gt; &gt; &gt; &gt; &gt; &gt; ignores &#34;encoding&#34; option &#40;even encoding =&gt; undef&#41;.
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; Before 5.90083 logic was the same:
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt; &gt; map { decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; }
&gt; &gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; However, there was
&gt; &gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt; &gt; -    if&#40;my $query_obj = $env-&gt;{&#39;plack.request.query&#39;}&#41; {
&gt; &gt; &gt; &gt; &gt; &gt; &gt; -         $c-&gt;request-&gt;query_parameters&#40;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; -           $c-&gt;request-&gt;_use_hash_multivalue ?
&gt; &gt; &gt; &gt; &gt; &gt; &gt; -              $query_obj-&gt;clone :
&gt; &gt; &gt; &gt; &gt; &gt; &gt; -              $query_obj-&gt;as_hashref_mixed&#41;;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; -         return;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; -    }
&gt; &gt; &gt; &gt; &gt; &gt; &gt; -
&gt; &gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt; &gt; before decoding.
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; So, our site didn&#39;t reach this decoding, since $env-
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; {&#39;plack.request.query&#39;} was true.
</div>&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; Use case:
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; Site runs under encoding =&gt; undef &#40;previously without
&gt; &gt; &gt; &gt; &gt; &gt; &gt; encoding
&gt; &gt; &gt; &gt; &gt; &gt; &gt; at
&gt; &gt; &gt; &gt; &gt; &gt; &gt; all&#41;.
&gt; &gt; &gt; &gt; &gt; &gt; &gt; Web page encoding is WINDOWS-1251, so  all incoming data,
&gt; &gt; &gt; &gt; &gt; &gt; &gt; including
&gt; &gt; &gt; &gt; &gt; &gt; &gt; query string is WINDOWS-1251 as well.
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; Example of URL:
&gt; &gt; &gt; &gt; &gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://example.com/test?domains=%E4%EE%EC%E5%ED">http://example.com/test?domains=%E4%EE%EC%E5%ED</a></span>
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; %E4%EE%EC%E5%ED is Russian word in WINDOWS-1251 encoding.
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; So in 5.90082 octets are passed as-is to the application.
&gt; &gt; &gt; &gt; &gt; &gt; &gt; After
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 5.90083 - it&#39;s decoded to Unicode string consists of not-a-
&gt; &gt; &gt; &gt; &gt; &gt; &gt; characters.
</div></div></div></div></div></div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;25&nbsp;15:00:30&nbsp;2015</span>
    <span class="description">jjnapiork [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">There is a new Catalyst on CPAN

<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/release/JJNAPIORK/Catalyst-Runtime-5.90085">https://metacpan.org/release/JJNAPIORK/Catalyst-Runtime-5.90085</a></span>

Please check that out, and see if any of the three backcompat options described in the upgrading pod and elsewhere do what you need.  If so please mark this ticket resolved and let me know that as well. -jnap

On Tue Mar 24 14:37:58 2015, vsespb wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; does it sound like adding a new $app configuration like
&gt; &gt; &#34;decode_URI_query_from_encoding_value&#39; &#40;or similar&#41; which would
&gt; &gt; decode the URL query based on whatever you set $app-&gt;encoding to &#40;or
&gt; &gt; nothing if that is undef&#41;
</div>&gt; 
&gt; yes! &#40;and when encoding==undef, no decoding happens&#41;
&gt; 
<div class="message-stanza open">&gt; &gt; Would this be a good solution until someday &#40;if ever&#41; you are able to
&gt; &gt; change your code as to be UTF-8 top to bottom?
</div>&gt; 
&gt; yes!
&gt; 
&gt; 
&gt; 
&gt; On Tue Mar 24 21:31:01 2015, JJNAPIORK wrote:
<div class="message-stanza open">&gt; &gt; Just to be clear, does it sound like adding a new $app configuration
&gt; &gt; like &#34;decode_URI_query_from_encoding_value&#39; &#40;or similar&#41; which would
&gt; &gt; decode the URL query based on whatever you set $app-&gt;encoding to &#40;or
&gt; &gt; nothing if that is undef&#41; would fix this for you?  Would this be a
&gt; &gt; good solution until someday &#40;if ever&#41; you are able to change your
&gt; &gt; code
&gt; &gt; as to be UTF-8 top to bottom?
&gt; &gt;
&gt; &gt; jnap
&gt; &gt;
&gt; &gt; On Tue Mar 24 14:04:05 2015, JJNAPIORK wrote:
<div class="message-stanza open">&gt; &gt; &gt; Ok so I think we can add a configurattion setting like &#39;url-decode-
&gt; &gt; &gt; from-encoding&#39; which would instead of defaulting to utf-8 it would
&gt; &gt; &gt; use
&gt; &gt; &gt; whatever you set to encoding.  that way you can disable until you
&gt; &gt; &gt; have
&gt; &gt; &gt; time to change your code to match.  how does that sound?
&gt; &gt; &gt;
&gt; &gt; &gt; anywhere else you&#39;d need this?
&gt; &gt; &gt;
&gt; &gt; &gt; john
&gt; &gt; &gt; On Tue Mar 24 12:47:01 2015, vsespb wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; Yes, all webpages are in windows-1251 charset.
&gt; &gt; &gt; &gt; All our template toolkit templates are in windows-1251 charset on
&gt; &gt; &gt; &gt; disk.
&gt; &gt; &gt; &gt; All perl source code is in windows-1251 &#40;thus string constants
&gt; &gt; &gt; &gt; are
&gt; &gt; &gt; &gt; windows-1251&#41;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Links with query strings are created usually using URI module.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; docs from URI module:
&gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; The escaping &#40;percent encoding&#41; of chars in the 128 .. 255 range
&gt; &gt; &gt; &gt; passed to the URI constructor or when setting URI parts using the
&gt; &gt; &gt; &gt; accessor methods depend on the state of the internal UTF8 flag
&gt; &gt; &gt; &gt; &#40;see
&gt; &gt; &gt; &gt; utf8::is_utf8&#41; of the string passed. If the UTF8 flag is set the
&gt; &gt; &gt; &gt; UTF-
&gt; &gt; &gt; &gt; 8
&gt; &gt; &gt; &gt; encoded version of the character is percent encoded. If the UTF8
&gt; &gt; &gt; &gt; flag
&gt; &gt; &gt; &gt; isn&#39;t set the Latin-1 version &#40;byte&#41; of the character is percent
&gt; &gt; &gt; &gt; encoded. This basically exposes the internal encoding of Perl
&gt; &gt; &gt; &gt; strings.
&gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; i.e. it will escape strings without perl UTF-8 flag as byte
&gt; &gt; &gt; &gt; percent
&gt; &gt; &gt; &gt; encoding. this works for us.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; No, we dont use $c-&gt;encoding. We just set encoding to undef.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; On Tue Mar 24 19:38:22 2015, JJNAPIORK wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; Sorry one more question.  How are the links generated?  Do you
&gt; &gt; &gt; &gt; &gt; have
&gt; &gt; &gt; &gt; &gt; web pages that are windows charset encoded?  Did you use $c-
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; uri_for
</div>&gt; &gt; &gt; &gt; &gt; or did you have links &#39;hard coded&#39;, or manually created?  Last
&gt; &gt; &gt; &gt; &gt; are
&gt; &gt; &gt; &gt; &gt; you
&gt; &gt; &gt; &gt; &gt; doing the windows encoding for web pages &#40;I assume that is what
&gt; &gt; &gt; &gt; &gt; you
&gt; &gt; &gt; &gt; &gt; are doing&#41; via setting $c-&gt;encoding or similar or did you have
&gt; &gt; &gt; &gt; &gt; to
&gt; &gt; &gt; &gt; &gt; hack
&gt; &gt; &gt; &gt; &gt; catalyst to make it work the way you needed ?
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; On Tue Mar 24 12:28:37 2015, vsespb wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; Request/Response:
&gt; &gt; &gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt; &gt; &gt; GET /misc/mytest?domains=%E4%EE%EC%E5%ED HTTP/1.1
&gt; &gt; &gt; &gt; &gt; &gt; Host: www1.reg.ru
&gt; &gt; &gt; &gt; &gt; &gt; User-Agent: Mozilla/5.0 &#40;X11; Ubuntu; Linux x86_64; rv:36.0&#41;
&gt; &gt; &gt; &gt; &gt; &gt; Gecko/20100101 Firefox/36.0
&gt; &gt; &gt; &gt; &gt; &gt; Accept:
&gt; &gt; &gt; &gt; &gt; &gt; text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
&gt; &gt; &gt; &gt; &gt; &gt; Accept-Language: en-US,en;q=0.5
&gt; &gt; &gt; &gt; &gt; &gt; Accept-Encoding: gzip, deflate
&gt; &gt; &gt; &gt; &gt; &gt; Cookie: [CUT]
&gt; &gt; &gt; &gt; &gt; &gt; Connection: keep-alive
&gt; &gt; &gt; &gt; &gt; &gt; Cache-Control: max-age=0
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; HTTP/1.1 200 OK
&gt; &gt; &gt; &gt; &gt; &gt; Server: nginx
&gt; &gt; &gt; &gt; &gt; &gt; Date: Tue, 24 Mar 2015 16:19:45 GMT
&gt; &gt; &gt; &gt; &gt; &gt; Content-Type: text/html; charset=WINDOWS-1251
&gt; &gt; &gt; &gt; &gt; &gt; Transfer-Encoding: chunked
&gt; &gt; &gt; &gt; &gt; &gt; Connection: keep-alive
&gt; &gt; &gt; &gt; &gt; &gt; Content-Language: ru
&gt; &gt; &gt; &gt; &gt; &gt; Set-Cookie: [CUT]
&gt; &gt; &gt; &gt; &gt; &gt; X-Catalyst: 5.90083
&gt; &gt; &gt; &gt; &gt; &gt; x-ua-compatible: IE=edge,chrome=IE8
&gt; &gt; &gt; &gt; &gt; &gt; Content-Encoding: gzip
&gt; &gt; &gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Action code:
&gt; &gt; &gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt; &gt; &gt; sub mytest : Local Args&#40;0&#41; {
&gt; &gt; &gt; &gt; &gt; &gt;     my &#40;$self, $c, $r, $p&#41; = getcontvars_noses @_;
&gt; &gt; &gt; &gt; &gt; &gt;     $c-&gt;res-&gt;content_type&#40; &#34;text/plain&#34; &#41;;
&gt; &gt; &gt; &gt; &gt; &gt;     $c-&gt;res-&gt;body&#40;  $p-&gt;{domains} &#41;;
&gt; &gt; &gt; &gt; &gt; &gt; }
&gt; &gt; &gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Console:
&gt; &gt; &gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt; &gt; &gt; [error] Caught exception in engine &#34;Wide character in
&gt; &gt; &gt; &gt; &gt; &gt; syswrite
&gt; &gt; &gt; &gt; &gt; &gt; at
&gt; &gt; &gt; &gt; &gt; &gt; /usr/local/share/perl/5.14.2/Starman/Server.pm line 547.&#34;
&gt; &gt; &gt; &gt; &gt; &gt; ========
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; one thing I wonder exactly what you think this should do?
</div>&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Well, with encoding=&gt;undef it should do nothing with
&gt; &gt; &gt; &gt; &gt; &gt; charsets.
&gt; &gt; &gt; &gt; &gt; &gt; i.e.
&gt; &gt; &gt; &gt; &gt; &gt; return octets as is. i.e
&gt; &gt; &gt; &gt; &gt; &gt; probably $self-&gt;unescape_uri&#40;$_&#41; instead of
&gt; &gt; &gt; &gt; &gt; &gt; decode_utf8&#40;$self-
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; unescape_uri&#40;$_&#41;&#41;
</div>&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; I was taking the assumption that people would what Catalyst
&gt; &gt; &gt; &gt; &gt; &gt; &gt; to
&gt; &gt; &gt; &gt; &gt; &gt; &gt; convert the encoded chacters to local unicode wide
&gt; &gt; &gt; &gt; &gt; &gt; &gt; characters
&gt; &gt; &gt; &gt; &gt; &gt; &gt; but
&gt; &gt; &gt; &gt; &gt; &gt; &gt; maybe that is not an ideal assumption?
</div>&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; Yes, right. With encoding NOT undef, Catalyst should convert
&gt; &gt; &gt; &gt; &gt; &gt; binary
&gt; &gt; &gt; &gt; &gt; &gt; data to perl strings &#40;unicode wide characters&#41;.
&gt; &gt; &gt; &gt; &gt; &gt; But when encoding IS undef, it should pass binary data as-is.
&gt; &gt; &gt; &gt; &gt; &gt; It&#39;s
&gt; &gt; &gt; &gt; &gt; &gt; exactly what it does with output data.
&gt; &gt; &gt; &gt; &gt; &gt; So with encoding undef input processing should be consistent
&gt; &gt; &gt; &gt; &gt; &gt; with
&gt; &gt; &gt; &gt; &gt; &gt; output processing.
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; We work with textual data in WINDOWS-1251 currently. That&#39;s
&gt; &gt; &gt; &gt; &gt; &gt; pre-
&gt; &gt; &gt; &gt; &gt; &gt; unicode approach. We&#39;re migrating to unicode,
&gt; &gt; &gt; &gt; &gt; &gt; but we&#39;re just not there yet.
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; On Tue Mar 24 16:59:39 2015, JJNAPIORK wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; Hey
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; one thing I wonder exactly what you think this should do?
&gt; &gt; &gt; &gt; &gt; &gt; &gt; I
&gt; &gt; &gt; &gt; &gt; &gt; &gt; was
&gt; &gt; &gt; &gt; &gt; &gt; &gt; taking the assumption that people would what Catalyst to
&gt; &gt; &gt; &gt; &gt; &gt; &gt; convert
&gt; &gt; &gt; &gt; &gt; &gt; &gt; the
&gt; &gt; &gt; &gt; &gt; &gt; &gt; encoded chacters to local unicode wide characters but maybe
&gt; &gt; &gt; &gt; &gt; &gt; &gt; that
&gt; &gt; &gt; &gt; &gt; &gt; &gt; is
&gt; &gt; &gt; &gt; &gt; &gt; &gt; not an ideal assumption?
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; talk to me about the use case and what you&#39;d ideally see
&gt; &gt; &gt; &gt; &gt; &gt; &gt; here
&gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; On Tue Mar 24 06:56:19 2015, vsespb wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; Hello.
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; Here is the diff:
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-">https://metacpan.org/diff/file?target=JJNAPIORK/Catalyst-</a></span>
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; Runtime-
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; 5.90083/&#38;source=JJNAPIORK/Catalyst-Runtime-5.90082/
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; There is the line:
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; map { defined $_ ? decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; :
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; $_
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; }
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; It decodes data to Unicode string and assumes that it&#39;s
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; in
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; UTF-
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; 8,
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; it
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; ignores &#34;encoding&#34; option &#40;even encoding =&gt; undef&#41;.
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; Before 5.90083 logic was the same:
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; map { decode_utf8&#40;$self-&gt;unescape_uri&#40;$_&#41;&#41; }
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; However, there was
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; -    if&#40;my $query_obj = $env-&gt;{&#39;plack.request.query&#39;}&#41; {
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; -         $c-&gt;request-&gt;query_parameters&#40;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; -           $c-&gt;request-&gt;_use_hash_multivalue ?
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; -              $query_obj-&gt;clone :
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; -              $query_obj-&gt;as_hashref_mixed&#41;;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; -         return;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; -    }
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; -
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; ===
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; before decoding.
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; So, our site didn&#39;t reach this decoding, since $env-
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; {&#39;plack.request.query&#39;} was true.
</div>&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; Use case:
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; Site runs under encoding =&gt; undef &#40;previously without
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; encoding
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; at
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; all&#41;.
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; Web page encoding is WINDOWS-1251, so  all incoming data,
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; including
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; query string is WINDOWS-1251 as well.
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; Example of URL:
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://example.com/test?domains=%E4%EE%EC%E5%ED">http://example.com/test?domains=%E4%EE%EC%E5%ED</a></span>
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; %E4%EE%EC%E5%ED is Russian word in WINDOWS-1251 encoding.
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; So in 5.90082 octets are passed as-is to the application.
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; After
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; 5.90083 - it&#39;s decoded to Unicode string consists of not-
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; a-
&gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; characters.
</div></div></div></div></div></div></div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;26&nbsp;04:26:38&nbsp;2015</span>
    <span class="description">victor [...] vsespb.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you! do_not_decode_query resolved the issue.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;26&nbsp;04:26:47&nbsp;2015</span>
    <span class="description">victor [...] vsespb.ru -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
