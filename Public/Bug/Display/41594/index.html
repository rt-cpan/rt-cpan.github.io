<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #41594 for XML-Twig: Segmentation fault at the very end of a script</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #41594 for XML-Twig: Segmentation fault at the very end of a script</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/XML-Twig/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/XML-Twig/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/XML-Twig/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/XML-Twig/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-Twig">XML-Twig CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">41594</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/XML-Twig/Active/">XML-Twig</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
henridamien.laurent [...] biblibre.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-37682-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-37683-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;10&nbsp;11:04:06&nbsp;2008</span>
    <span class="description">henridamien.laurent [...] biblibre.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Segmentation fault at the very end of a script</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 10 Dec 2008 16:48:29 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;henridamien.laurent&#34; &lt;henridamien.laurent [...] biblibre.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi
I am working on different Linux machines, XML::Twig is quite impressive, but
I happen to have a seg fault problem with a script of mine :
It occurs at the very end of the script, so process is OK, but it still
is quite uncomfortable.
And I would like to find out why it is so.
XML file is quite big : 12Mo
But I think it should be OK.
is there something I should know ? Some thing I should do to provide you
with enough information ?

#!/usr/bin/perl
use XML::Twig;
use XML::Twig::XPath;
use Data::Dumper;
use Getopt::Long;
use utf8;
use strict;
# buffers for holding text

my %concepthash;
my %mthash;
my %BT;
my %NT;
my &#40;$filename,$force&#41;;
GetOptions&#40;
    &#39;file:s&#39;    =&gt; \$filename,
    &#39;f&#39; =&gt; \$force,
&#41;;

# initialize parser with handlers for node processing
my $twig = new XML::Twig::XPath&#40; TwigHandlers =&gt; {
                             &#34;/th/langue/record&#34;    =&gt; \&#38;concepthash,
                             &#34;/th/langue/mt&#34;    =&gt; \&#38;mthash,
                                          }&#41;;

# parse, handling nodes on the way

$twig-&gt;parsefile&#40; $filename &#41;;
my %mtdiff;
my @nodeset = $twig-&gt;get_xpath&#40;&#39;/th/langue[@lang-id=&#34;fre&#34;]/record&#39;&#41;;
my &#40;%modelem, %createelem, %newelem, %unmodifiedelem&#41;;

CONCEPT :foreach my $elem &#40;@nodeset&#41; {
# Construction de l&#39;enregistrement candidat
  my $id= $elem-&gt;att&#40; &#39;id&#39; &#41;;
#process process process ..... 
#uses hashes
}
my %BT;
my %NT;
# initialize parser with handlers for node processing

my @nodeset = $twig-&gt;get_xpath&#40;&#39;/th/langue[@lang-id!=&#34;fre&#34;]/record&#39;&#41;;
foreach my $elem &#40;@nodeset&#41;{
  my $id= $elem-&gt;att&#40; &#39;id&#39; &#41;;
# Process Process Process
#uses hashes
}

$twig-&gt;dispose;

# handle a concept element to build the concepts hash.
sub concepthash {
  my&#40; $tree, $elem &#41; = @_;
# Process Process Process
#creates a concept hash
}

sub mthash {
  my&#40; $tree, $elem &#41; = @_;
# Process Process Process
#creates an mt hash
}


-- 
Henri-Damien LAURENT
BibLibre SARL
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.biblibre.com">http://www.biblibre.com</a></span>
Expert en Logiciels Libres pour l&#39;info-doc
tel : +33 4 67 65 75 50
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;10&nbsp;11:34:58&nbsp;2008</span>
    <span class="description">xmltwig [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #41594] Segmentation fault at the very end of a script</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 10 Dec 2008 17:34:01 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mirod &lt;xmltwig [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">A few things you could try:

- not call dispose, it shouldn&#39;t be needed
- try not using XML::Twig::XPath, I believe the XPath expression you use is
   supported by the native XPath-lite engine

Which versions of perl and of XML::Twig are you using?

Note that in quite a few cases dying is much faster than exiting the program
properly &#40;you don&#39;t spend time freeing lots of small bits of memory in an
orderly fashion... just to free all of the process space as soon as you&#39;re done&#41;.

Thanks

-- 
mirod
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;10&nbsp;11:35:01&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;10&nbsp;11:51:20&nbsp;2008</span>
    <span class="description">henridamien.laurent [...] biblibre.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #41594] Segmentation fault at the very end of a script</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 10 Dec 2008 17:50:18 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;henridamien.laurent&#34; &lt;henridamien.laurent [...] biblibre.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">xmltwig@gmail.com via RT a écrit :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=41594">http://rt.cpan.org/Ticket/Display.html?id=41594</a></span> &gt;
&gt;
&gt; A few things you could try:
&gt;
&gt; - not call dispose, it shouldn&#39;t be needed
&gt; - try not using XML::Twig::XPath, I believe the XPath expression you use is
&gt;    supported by the native XPath-lite engine
&gt;
&gt; Which versions of perl and of XML::Twig are you using?
&gt;
&gt; Note that in quite a few cases dying is much faster than exiting the program
&gt; properly &#40;you don&#39;t spend time freeing lots of small bits of memory in an
&gt; orderly fashion... just to free all of the process space as soon as you&#39;re done&#41;.
&gt;
&gt; Thanks
&gt;
&gt;   
</div>XML::Twig version is 3.32
Perl version is 5.10 but it occured with 5.8.8.
I used dispose to get rid of this seg fault, without success.

Can XML::Twig::XPath be the source of the problem ?


-- 
Henri-Damien LAURENT
BibLibre SARL
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.biblibre.com">http://www.biblibre.com</a></span>
Expert en Logiciels Libres pour l&#39;info-doc
tel : +33 4 67 65 75 50
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;10&nbsp;12:55:00&nbsp;2008</span>
    <span class="description">xmltwig [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #41594] Segmentation fault at the very end of a script</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 10 Dec 2008 18:53:11 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mirod &lt;xmltwig [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">henridamien.laurent via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; XML::Twig version is 3.32
&gt; Perl version is 5.10 but it occured with 5.8.8.
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I used dispose to get rid of this seg fault, without success.
</div>
I kinda suspected that ;--&#40;


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Can XML::Twig::XPath be the source of the problem ?
</div>
I don&#39;t know, I am just trying to narrow down the problem.

OK, could you send me a &#40;small!&#41; file that shows the problem, that would help.

Thanks.

-- 
mirod
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;16&nbsp;12:18:09&nbsp;2009</span>
    <span class="description">henridamien [...] koha-fr.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #41594] Segmentation fault at the very end of a script</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 16 Jan 2009 18:17:08 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> LAURENT Henri-Damien &lt;henridamien [...] koha-fr.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Data file is quite big.
But otherwise : process as such :
see int_test.pl
I sent data along.
launch perl int_test.pl data.xml
Is there something I can doo about this segmentation fault problem ?
It does not even process all the file data.xml.bz2 as I supposed.
Thanks for you quick answer.
-- 
Henri-Damien LAURENT
 
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
use XML::Twig;
use XML::Twig::XPath;
# use Unicode::String qw&#40;utf8 latin1&#41;;
use MARC::Record;
use Data::Dumper;
use Date::Manip;
use Getopt::Long;
use utf8;
use strict;
# buffers for holding text

my %concepthash;
my %mthash;
my %BT;
my %NT;
my &#40;$filename,$force&#41;;
GetOptions&#40;
    &#39;file:s&#39;    =&gt; \$filename,
    &#39;f&#39; =&gt; \$force,
&#41;;

# initialize parser with handlers for node processing
my $twig = new XML::Twig::XPath&#40; TwigHandlers =&gt; { 
                             &#34;/thesaurusMultilingue/langue/thesaurus/concept&#34;    =&gt; \&#38;concepthash,
                             &#34;/thesaurusMultilingue/langue/thesaurus/microthesaurus&#34;    =&gt; \&#38;mthash,
                                          }&#41;;

# parse, handling nodes on the way

$twig-&gt;parsefile&#40; $filename &#41;;
# use Data::Dumper; warn &#34;base : &#34;.$dbh-&gt;{Name};

#Construction du hachage de concept.
#Il faut le faire AVANT de proceder a la reconnaissance des relations.
my %mtdiff;
my @nodeset = $twig-&gt;get_xpath&#40;&#39;/thesaurusMultilingue/langue[@lang-id=&#34;fre&#34;]/thesaurus/concept&#39;&#41;;
my &#40;%modelem, %createelem, %newelem, %unmodifiedelem&#41;;

CONCEPT :foreach my $elem &#40;@nodeset&#41; {
  my $id= $elem-&gt;att&#40; &#39;id&#39; &#41;;
  my $create = $elem-&gt;trimmed_field&#40; &#39;dateCreation&#39; &#41;;
  my $modify = $elem-&gt;trimmed_field&#40; &#39;dateModification&#39; &#41;;
  $create =~s/-//g;
  $modify =~s/-//g;
  my $form= $elem-&gt;trimmed_field&#40; &#39;term&#39; &#41;;
  my $note = $elem-&gt;trimmed_field&#40; &#39;noteApplication&#39; &#41;;
  #search for an existing record in thesaurus
  
 my @relations = $elem-&gt;descendants&#40;&#39;relation&#39;&#41;;
  my $nok;
  my %tagfields=&#40;
    &#34;UF&#34;=&gt;&#39;450&#39;,
    &#34;RT&#34;=&gt;&#39;550&#39;,
    &#34;BT&#34;=&gt;&#39;550&#39;,
    &#34;NT&#34;=&gt;&#39;550&#39;,
  &#41;;
  my %relations=&#40;
    &#34;BT&#34;=&gt;&#34;g&#34;,
    &#34;NT&#34;=&gt;&#34;h&#34;,
  &#41;;
  my @fields;
  foreach my $relation &#40;@relations&#41;{
    if &#40;$relation-&gt;att&#40;&#39;type&#39;&#41;=~/MT/&#41;{
	     $concepthash{$id}-&gt;{&#39;MT&#39;} = $relation-&gt;att&#40;&#39;ref&#39;&#41;;
    } elsif &#40;$relation-&gt;att&#40;&#39;type&#39;&#41; =~/UF|RT|BT|NT/&#41;{
       push @fields,&#40;$tagfields{$relation-&gt;att&#40;&#39;type&#39;&#41;},
	      &#34;2&#34;=&gt;&#34;&#34;.$mthash{$concepthash{$relation-&gt;att&#40; &#39;ref&#39; &#41;}-&gt;{&#39;MT&#39;}}-&gt;{&#39;fre&#39;},
		  &#34;3&#34;=&gt;$relation-&gt;att&#40; &#39;ref&#39; &#41;, 
		  &#34;a&#34;=&gt;$concepthash{$relation-&gt;att&#40; &#39;ref&#39; &#41;}-&gt;{&#39;fre&#39;}&#41;;
    } elsif &#40;$relation-&gt;att&#40;&#39;type&#39;&#41; =~ /USE/&#41;{
	 	next CONCEPT;
    } 
  }
################################### Fin Construction record autoritï¿½
     # Ajouter l&#39;arbre ici 
      my $trees=GetParents&#40;$id&#41;;
      my $hierarchies;
      $hierarchies=join &#40;&#39;;&#39;,map{join&#40;&#39;,&#39;,@{$_}&#41;} @$trees&#41;;
      
      $modelem{&#34;$id&#34;}=$form;
	
      my $hierarchies;
      $hierarchies=join &#40;&#39;;&#39;,map{join&#40;&#39;,&#39;,@$_&#41;} @$trees&#41;;
      print &#34;$id:$hierarchies&#34;, join&#40;&#34;\n\t&#34;,@fields&#41;,&#34;\n\n&#34;;
}
sub GetParents{
    my &#40;$id&#41;= @_;
    if &#40;defined $concepthash{$id}-&gt;{&#39;parents&#39;}&#41;{
        my @parents=map{my $ancestors=GetParents&#40;$_&#41;; map{[@{$_},$id]} @$ancestors} keys %{$concepthash{$id}-&gt;{&#39;parents&#39;}};
        return \@parents;
    } else {
        return [[$id]];
    }
}
# handle a concept element to build the concepts hash.
sub concepthash {
  my&#40; $tree, $elem &#41; = @_;
#   utf8::decode&#40;$elem-&gt;trimmed_field&#40; &#39;term&#39; &#41;&#41;;
  $concepthash{$elem-&gt;att&#40; &#39;id&#39; &#41;}-&gt;{$elem-&gt;parent&#40;&#39;langue&#39;&#41;-&gt;att&#40; &#39;lang-id&#39; &#41;}=$elem-&gt;trimmed_field&#40; &#39;term&#39; &#41;;
  if &#40;$elem-&gt;first_descendant&#40;&#39;relation[@type=&#34;MT&#34;]&#39;&#41;&#41;{
    $concepthash{$elem-&gt;att&#40; &#39;id&#39; &#41;}-&gt;{&#39;MT&#39;} = $elem-&gt;first_descendant&#40;&#39;relation[@type=&#34;MT&#34;]&#39;&#41;-&gt;att&#40;&#39;ref&#39;&#41; ;
  } else {
    warn $elem-&gt;att&#40; &#39;id&#39; &#41;.&#34; Pas de microthÃ©saurus attachÃ©&#34;;
  }
  map { $concepthash{$elem-&gt;att&#40; &#39;id&#39; &#41;}-&gt;{&#39;parents&#39;}-&gt;{$_-&gt;att&#40;&#39;ref&#39;&#41;}=1} $elem-&gt;descendants&#40;&#39;relation[@type=&#34;BT&#34;]&#39;&#41; if &#40;$elem-&gt;descendants&#40;&#39;relation[@type=&#34;BT&#34;]&#39;&#41;&#41;;
}

sub mthash {
  my&#40; $tree, $elem &#41; = @_;
#   utf8::decode&#40;$elem-&gt;trimmed_field&#40; &#39;mt-name&#39; &#41;&#41;;
  $mthash{$elem-&gt;att&#40; &#39;mt-id&#39; &#41;}-&gt;{$elem-&gt;parent&#40;&#39;langue&#39;&#41;-&gt;att&#40; &#39;lang-id&#39; &#41;}=$elem-&gt;trimmed_field&#40; &#39;mt-name&#39; &#41;;
}

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;17&nbsp;04:52:13&nbsp;2009</span>
    <span class="description">xmltwig [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #41594] Segmentation fault at the very end of a script</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 17 Jan 2009 10:51:58 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mirod &lt;xmltwig [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">LAURENT Henri-Damien via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: XML-Twig
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=41594">http://rt.cpan.org/Ticket/Display.html?id=41594</a></span> &gt;
&gt; 
&gt; Data file is quite big.
&gt; But otherwise : process as such :
&gt; see int_test.pl
&gt; I sent data along.
&gt; launch perl int_test.pl data.xml
&gt; Is there something I can doo about this segmentation fault problem ?
&gt; It does not even process all the file data.xml.bz2 as I supposed.
&gt; Thanks for you quick answer.
</div>
Well, the data is just too big. A simple test like perl -MXML::Twig 
-e&#39;XML::Twig-&gt;new-&gt;parsefile&#40; &#34;data.xml&#34;&#41;;&#39; would have shown it &#40;and saved me 
some time, as I assumed you had tested that, and sent me the simplest test that 
generated the error&#41;.

Do you need to load the entire tree in memory, or could you purge it, maybe 
after each concept, I can&#39;t tell from a quick look at your code?

-- 
mirod
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;19&nbsp;04:21:27&nbsp;2009</span>
    <span class="description">henridamien.laurent [...] biblibre.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #41594] Segmentation fault at the very end of a script</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 19 Jan 2009 10:21:03 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> LAURENT Henri-Damien &lt;henridamien.laurent [...] biblibre.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">xmltwig@gmail.com via RT a écrit :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=41594">http://rt.cpan.org/Ticket/Display.html?id=41594</a></span> &gt;
&gt;
&gt; LAURENT Henri-Damien via RT wrote:
&gt;   
<div class="message-stanza open">&gt;&gt;        Queue: XML-Twig
&gt;&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=41594">http://rt.cpan.org/Ticket/Display.html?id=41594</a></span> &gt;
&gt;&gt;
&gt;&gt; Data file is quite big.
&gt;&gt; But otherwise : process as such :
&gt;&gt; see int_test.pl
&gt;&gt; I sent data along.
&gt;&gt; launch perl int_test.pl data.xml
&gt;&gt; Is there something I can doo about this segmentation fault problem ?
&gt;&gt; It does not even process all the file data.xml.bz2 as I supposed.
&gt;&gt; Thanks for you quick answer.
&gt;&gt;     
</div>&gt;
&gt; Well, the data is just too big. A simple test like perl -MXML::Twig 
&gt; -e&#39;XML::Twig-&gt;new-&gt;parsefile&#40; &#34;data.xml&#34;&#41;;&#39; would have shown it &#40;and saved me 
&gt; some time, as I assumed you had tested that, and sent me the simplest test that 
&gt; generated the error&#41;.
&gt;   
</div>MMM... Sorry for not failing to test this.
I just couldnot imagine it was failing parsing the file, since it partly 
achieved the job.
And I believed XML::Twig was designed to process big files.
It seems that XML::LibXML can parse this file.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Do you need to load the entire tree in memory, or could you purge it, maybe 
&gt; after each concept, I can&#39;t tell from a quick look at your code?
&gt;   
</div>In my opinion, if that file was big for a mail, it is not so big for 
process.
I have to first read the whole file to find relations between nodes and 
to determine the type of node.
The problem is that for each node, I need elements from related nodes 
and those nodes can be further in the data file, so not processed yet.
If I found a solution to do this, would there be a simple way to adapt 
my code so that after memory is freed after each concept ?*
-- 
Henri-Damien LAURENT
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;23&nbsp;10:13:13&nbsp;2011</span>
    <span class="description">MIROD [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
