<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #70952 for AnyEvent-Twitter-Stream: no_decode_json argument breaks Twitter Stream</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #70952 for AnyEvent-Twitter-Stream: no_decode_json argument breaks Twitter Stream</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=AnyEvent-Twitter-Stream">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=AnyEvent-Twitter-Stream">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=AnyEvent-Twitter-Stream">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=AnyEvent-Twitter-Stream">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/miyagawa/AnyEvent-Twitter-Stream/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/AnyEvent-Twitter-Stream">AnyEvent-Twitter-Stream CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">70952</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=AnyEvent-Twitter-Stream">AnyEvent-Twitter-Stream</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
info [...] luxdevelopment.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-228432-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.21    </td>
  </tr>
  <tr id="CF-228433-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




example.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/977342/508743/example.pl">
Wed Sep 14 01:09:52 2011 (1.5k) by info [...] luxdevelopment.net
</a>
</font></li>
</ul>


Stream.pm<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/977342/508742/Stream.pm">
Wed Sep 14 01:09:52 2011 (10.6k) by info [...] luxdevelopment.net
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=70952">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-977342" href="/Public/Bug/Display.html?id=70952#txn-977342">#</a>      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;14&nbsp;01:09:52&nbsp;2011</span>
    <span class="description">info [...] luxdevelopment.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> no_decode_json argument breaks Twitter Stream</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/977342/508741/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/508741">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1018b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">our application is distributing tweets to other servers for processing. 
We ran into the problem that when we use the argument no_decode_json the 
AnyEvent-Twitter-Stream package stopped working.The algorythm to detect 
which method will be called needs to be decoded JSON. 

The following error was provided &#34;Thread 1 terminated abnormally: Can&#39;t 
use string &#40;&#34;{&#34;id_str&#34;:&#34;113821408630546432&#34;,&#34;&#34;&#41; as a HASH ref while 
&#34;strict refs&#34; in use at 
/usr/local/share/perl/5.10.1/AnyEvent/Twitter/Stream.pm line 125.&#34;

In the attachment you can find our suggestion to solve this problem. We 
modified lines 48, 126, 127, 128.

With this patch you will give developers the change to make there own 
algorithm for handling tweet events. And for distributed clients like 
ours we can pass along undecoded JSON and decode it on another server.

I also extended the examples you provided at 
<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~miyagawa/AnyEvent-Twitter-Stream-">http://search.cpan.org/~miyagawa/AnyEvent-Twitter-Stream-</a></span>
0.21/lib/AnyEvent/Twitter/Stream.pm the extra example can be found in 
example.pl
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Stream.pm</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/977342/508742/Stream.pm">Download Stream.pm</a><br />
<span class="downloadcontenttype">text/x-perl 10.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">package AnyEvent::Twitter::Stream;

use strict;
use 5.008_001;
our $VERSION = &#39;0.21&#39;;

use AnyEvent;
use AnyEvent::HTTP;
use AnyEvent::Util;
use MIME::Base64;
use URI;
use URI::Escape;
use Carp;

our $STREAMING_SERVER  = &#39;stream.twitter.com&#39;;
our $USERSTREAM_SERVER = &#39;userstream.twitter.com&#39;;
our $PROTOCOL          = $ENV{&#39;ANYEVENT_TWITTER_STREAM_SSL&#39;} ? &#39;https&#39; : &#39;http&#39;;
our $US_PROTOCOL       = &#39;https&#39;; # for testing

my %methods = &#40;
    firehose   =&gt; [],
    links      =&gt; [],
    retweet    =&gt; [],
    sample     =&gt; [],
    userstream =&gt; [ qw&#40;replies&#41; ],
    filter     =&gt; [ qw&#40;track follow locations&#41; ],
&#41;;

sub new {
    my $class = shift;
    my %args  = @_;

    my $username        = delete $args{username};
    my $password        = delete $args{password};
    my $consumer_key    = delete $args{consumer_key};
    my $consumer_secret = delete $args{consumer_secret};
    my $token           = delete $args{token};
    my $token_secret    = delete $args{token_secret};
    my $method          = delete $args{method};
    my $on_connect      = delete $args{on_connect} || sub { };
    my $on_tweet        = delete $args{on_tweet};
    my $on_error        = delete $args{on_error} || sub { die @_ };
    my $on_eof          = delete $args{on_eof} || sub { };
    my $on_keepalive    = delete $args{on_keepalive} || sub { };
    my $on_delete       = delete $args{on_delete};
    my $on_friends      = delete $args{on_friends};
    my $on_event        = delete $args{on_event};
    my $on_json         = delete $args{on_json}; #Add on_json callback
    my $timeout         = delete $args{timeout};

    my $decode_json;
    unless &#40;delete $args{no_decode_json}&#41; {
        require JSON;
        $decode_json = 1;
    }

    unless &#40;$methods{$method}&#41; {
        $on_error-&gt;&#40;&#34;Method $method not available.&#34;&#41;;
        return;
    }

    my %post_args;
    for my $param &#40; @{ $methods{$method} } &#41; {
        next if $method eq &#39;userstream&#39; &#38;&#38; $param eq &#39;replies&#39;;
        if &#40; exists $args{$param} &#41; {
            $post_args{$param} = delete $args{$param};
        }
    }

    my $uri;
    if &#40;$method eq &#39;userstream&#39;&#41; {
        $uri = URI-&gt;new&#40;&#34;$US_PROTOCOL://$USERSTREAM_SERVER/2/user.json&#34;&#41;;
    }else{
        $uri = URI-&gt;new&#40;&#34;$PROTOCOL://$STREAMING_SERVER/1/statuses/$method.json&#34;&#41;;
    }

    $uri-&gt;query_form&#40;%args&#41;;

    my $request_method = &#39;GET&#39;;
    my $request_body;
    if &#40;$method eq &#39;filter&#39; || $method eq &#39;userstream&#39;&#41; {
        $request_method = &#39;POST&#39;;
        $request_body = join &#39;&#38;&#39;, map &#34;$_=&#34; . URI::Escape::uri_escape&#40;$post_args{$_}&#41;, keys %post_args;
    }

    my $auth;
    if &#40;$consumer_key&#41; {
        eval {require Net::OAuth;};
        die $@ if $@;

        my $request = Net::OAuth-&gt;request&#40;&#39;protected resource&#39;&#41;-&gt;new&#40;
            version          =&gt; &#39;1.0&#39;,
            consumer_key     =&gt; $consumer_key,
            consumer_secret  =&gt; $consumer_secret,
            token            =&gt; $token,
            token_secret     =&gt; $token_secret,
            request_method   =&gt; $request_method,
            signature_method =&gt; &#39;HMAC-SHA1&#39;,
            timestamp        =&gt; time,
            nonce            =&gt; MIME::Base64::encode&#40; time . $$ . rand &#41;,
            request_url      =&gt; $uri,
            extra_params     =&gt; \%post_args,
        &#41;;
        $request-&gt;sign;
        $auth = $request-&gt;to_authorization_header;
    }else{
        $auth = &#34;Basic &#34;.MIME::Base64::encode&#40;&#34;$username:$password&#34;, &#39;&#39;&#41;;
    }

    my $self = bless {}, $class;

    {
        Scalar::Util::weaken&#40;my $self = $self&#41;;

        my $set_timeout = $timeout
            ? sub { $self-&gt;{timeout} = AE::timer&#40;$timeout, 0, sub { $on_error-&gt;&#40;&#39;timeout&#39;&#41; }&#41; }
            : sub {};

        my $on_json_message = sub {
            my &#40;$json&#41; = @_;

            # Twitter stream returns &#34;\x0a\x0d\x0a&#34; if there&#39;s no matched tweets in ~30s.
            $set_timeout-&gt;&#40;&#41;;
            if &#40;$json !~ /^\s*$/&#41; {
                my $tweet = $decode_json ? JSON::decode_json&#40;$json&#41; : $json;
		if &#40;$on_json&#41; {
                    $on_json-&gt;&#40;$tweet&#41;; #on_json will be called if set.
                }elsif &#40;$on_delete &#38;&#38; $tweet-&gt;{delete} &#38;&#38; $tweet-&gt;{delete}-&gt;{status}&#41; {
                    $on_delete-&gt;&#40;$tweet-&gt;{delete}-&gt;{status}-&gt;{id}, $tweet-&gt;{delete}-&gt;{status}-&gt;{user_id}&#41;;
                }elsif&#40;$on_friends &#38;&#38; $tweet-&gt;{friends}&#41; {
                    $on_friends-&gt;&#40;$tweet-&gt;{friends}&#41;;
                }elsif&#40;$on_event &#38;&#38; $tweet-&gt;{event}&#41; {
                    $on_event-&gt;&#40;$tweet&#41;;
                }else{
                    $on_tweet-&gt;&#40;$tweet&#41;;
                }
            }
            else {
                $on_keepalive-&gt;&#40;&#41;;
            }
        };

        $set_timeout-&gt;&#40;&#41;;

        $self-&gt;{connection_guard} = http_request&#40;$request_method, $uri,
            headers =&gt; {
                Accept =&gt; &#39;*/*&#39;,
                Authorization =&gt; $auth,
                &#40;$request_method eq &#39;POST&#39;
                    ? &#40;&#39;Content-Type&#39; =&gt; &#39;application/x-www-form-urlencoded&#39;&#41;
                    : &#40;&#41;
                &#41;,
            },
            body =&gt; $request_body,
            on_header =&gt; sub {
                my&#40;$headers&#41; = @_;
                if &#40;$headers-&gt;{Status} ne &#39;200&#39;&#41; {
                    $on_error-&gt;&#40;&#34;$headers-&gt;{Status}: $headers-&gt;{Reason}&#34;&#41;;
                    return;
                }
                return 1;
            },
            want_body_handle =&gt; 1, # for some reason on_body =&gt; sub {} doesn&#39;t work :/
            sub {
                my &#40;$handle, $headers&#41; = @_;

                return unless $handle;

                my $chunk_reader = sub {
                    my &#40;$handle, $line&#41; = @_;

                    $line =~ /^&#40;[0-9a-fA-F]+&#41;/ or die &#39;bad chunk &#40;incorrect length&#41;&#39;;
                    my $len = hex $1;

                    $handle-&gt;push_read&#40;chunk =&gt; $len, sub {
                        my &#40;$handle, $chunk&#41; = @_;

                        $handle-&gt;push_read&#40;line =&gt; sub {
                            length $_[1] and die &#39;bad chunk &#40;missing last empty line&#41;&#39;;
                        }&#41;;

                        $on_json_message-&gt;&#40;$chunk&#41;;
                    }&#41;;
                };
                my $line_reader = sub {
                    my &#40;$handle, $line&#41; = @_;

                    $on_json_message-&gt;&#40;$line&#41;;
                };

                $handle-&gt;on_error&#40;sub {
                    undef $handle;
                    $on_error-&gt;&#40;$_[2]&#41;;
                }&#41;;
                $handle-&gt;on_eof&#40;sub {
                    undef $handle;
                    $on_eof-&gt;&#40;@_&#41;;
                }&#41;;

                if &#40;&#40;$headers-&gt;{&#39;transfer-encoding&#39;} || &#39;&#39;&#41; =~ /\bchunked\b/i&#41; {
                    $handle-&gt;on_read&#40;sub {
                        my &#40;$handle&#41; = @_;
                        $handle-&gt;push_read&#40;line =&gt; $chunk_reader&#41;;
                    }&#41;;
                } else {
                    $handle-&gt;on_read&#40;sub {
                        my &#40;$handle&#41; = @_;
                        $handle-&gt;push_read&#40;line =&gt; $line_reader&#41;;
                    }&#41;;
                }

                $self-&gt;{guard} = AnyEvent::Util::guard {
                    $handle-&gt;destroy if $handle;
                };

                $on_connect-&gt;&#40;&#41;;
            }
        &#41;;
    }

    return $self;
}

1;
__END__

=encoding utf-8

=for stopwords
API AnyEvent

=for test_synopsis
my&#40;$user, $password, @following_ids, $consumer_key, $consumer_secret, $token, $token_secret&#41;;

=head1 NAME

AnyEvent::Twitter::Stream - Receive Twitter streaming API in an event loop

=head1 SYNOPSIS

  use AnyEvent::Twitter::Stream;

  # receive updates from @following_ids
  my $listener = AnyEvent::Twitter::Stream-&gt;new&#40;
      username =&gt; $user,
      password =&gt; $password,
      method   =&gt; &#34;filter&#34;,  # &#34;firehose&#34; for everything, &#34;sample&#34; for sample timeline
      follow   =&gt; join&#40;&#34;,&#34;, @following_ids&#41;,
      on_tweet =&gt; sub {
          my $tweet = shift;
          warn &#34;$tweet-&gt;{user}{screen_name}: $tweet-&gt;{text}\n&#34;;
      },
      on_keepalive =&gt; sub {
          warn &#34;ping\n&#34;;
      },
      on_delete =&gt; sub {
          my &#40;$tweet_id, $user_id&#41; = @_; # callback executed when twitter send a delete notification
          ...
      },
      timeout =&gt; 45,
  &#41;;

  # track keywords
  my $guard = AnyEvent::Twitter::Stream-&gt;new&#40;
      username =&gt; $user,
      password =&gt; $password,
      method   =&gt; &#34;filter&#34;,
      track    =&gt; &#34;Perl,Test,Music&#34;,
      on_tweet =&gt; sub { },
  &#41;;

  # to use OAuth authentication
  my $listener = AnyEvent::Twitter::Stream-&gt;new&#40;
      consumer_key    =&gt; $consumer_key,
      consumer_secret =&gt; $consumer_secret,
      token           =&gt; $token,
      token_secret    =&gt; $token_secret,
      method          =&gt; &#34;filter&#34;,
      track           =&gt; &#34;...&#34;,
      on_tweet        =&gt; sub { ... },
  &#41;;

=head1 DESCRIPTION

AnyEvent::Twitter::Stream is an AnyEvent user to receive Twitter streaming
API, available at L&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://dev.twitter.com/pages/streaming_api">http://dev.twitter.com/pages/streaming_api</a></span>&gt; and
L&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://dev.twitter.com/pages/user_streams">http://dev.twitter.com/pages/user_streams</a></span>&gt;.

See L&lt;eg/track.pl&gt; for more client code example.

=head1 METHODS

=head2 my $streamer = AnyEvent::Twitter::Stream-&gt;new&#40;%args&#41;;

=over 4

=item B&lt;username&gt; B&lt;password&gt;

These arguments are used for basic authentication.

=item B&lt;consumer_key&gt; B&lt;consumer_secret&gt; B&lt;token&gt; B&lt;token_secret&gt;

If you want to use the OAuth authentication mechanism, you need to set use arguments

=item B&lt;consumer_key&gt; B&lt;consumer_secret&gt; B&lt;token&gt; B&lt;token_secret&gt;

If you want to use the OAuth authentication mechanism, you need to set these arguments

=item B&lt;method&gt;

The name of the method you want to use on the stream. Currently, anyone of :

=over 2

=item B&lt;firehose&gt;

=item B&lt;links&gt;

=item B&lt;retweet&gt;

=item B&lt;sample&gt;

=item B&lt;userstream&gt;

To use this method, you need to use the OAuth mechanism.

=item B&lt;filter&gt;

With this method you can specify what you want to filter amongst B&lt;track&gt;, B&lt;follow&gt; and B&lt;locations&gt;.

=back

=item B&lt;timeout&gt;

Set the timeout value.

=item B&lt;on_connect&gt;

Callback to execute when a stream is connected.

=item B&lt;on_tweet&gt;

Callback to execute when a new tweet is received.

=item B&lt;on_error&gt;

=item B&lt;on_eof&gt;

=item B&lt;on_keepalive&gt;

=item B&lt;on_delete&gt;

Callback to execute when the stream send a delete notification.

=item B&lt;on_friends&gt;

B&lt;Only with the usertream method&gt;. Callback to execute when the stream send a list of friends.

=item B&lt;on_event&gt;

B&lt;Only with the userstream method&gt;. Callback to execute when the stream send an event notification &#40;follow, ...&#41;.

=head1 NOTES

To use the B&lt;userstream&gt; method, Twitter recommend using the HTTPS protocol. For this, you need to set the B&lt;ANYEVENT_TWITTER_STREAM_SSL&gt; environment variable, and install the L&lt;Net::SSLeay&gt; module.

=head1 AUTHOR

Tatsuhiko Miyagawa E&lt;lt&gt;miyagawa@bulknews.netE&lt;gt&gt;

=head1 LICENSE

This library is free software; you can redistribute it and/or modify
it under the same terms as Perl itself.

=head1 SEE ALSO

L&lt;AnyEvent::Twitter&gt;, L&lt;Net::Twitter::Stream&gt;

=cut
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> example.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/977342/508743/example.pl">Download example.pl</a><br />
<span class="downloadcontenttype">text/x-perl 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">use AnyEvent::Twitter::Stream;

  # receive updates from @following_ids
  my $listener = AnyEvent::Twitter::Stream-&gt;new&#40;
      username =&gt; $user,
      password =&gt; $password,
      method   =&gt; &#34;filter&#34;,  # &#34;firehose&#34; for everything, &#34;sample&#34; for sample timeline
      follow   =&gt; join&#40;&#34;,&#34;, @following_ids&#41;,
      on_tweet =&gt; sub {
          my $tweet = shift;
          warn &#34;$tweet-&gt;{user}{screen_name}: $tweet-&gt;{text}\n&#34;;
      },
      on_keepalive =&gt; sub {
          warn &#34;ping\n&#34;;
      },
      on_delete =&gt; sub {
          my &#40;$tweet_id, $user_id&#41; = @_; # callback executed when twitter send a delete notification
          ...
      },
      timeout =&gt; 45,
  &#41;;

  # track keywords
  my $guard = AnyEvent::Twitter::Stream-&gt;new&#40;
      username =&gt; $user,
      password =&gt; $password,
      method   =&gt; &#34;filter&#34;,
      track    =&gt; &#34;Perl,Test,Music&#34;,
      on_tweet =&gt; sub { },
  &#41;;

  # to use OAuth authentication
  my $listener = AnyEvent::Twitter::Stream-&gt;new&#40;
      consumer_key    =&gt; $consumer_key,
      consumer_secret =&gt; $consumer_secret,
      token           =&gt; $token,
      token_secret    =&gt; $token_secret,
      method          =&gt; &#34;filter&#34;,
      track           =&gt; &#34;...&#34;,
      on_tweet        =&gt; sub { ... },
  &#41;;
  
  # to use RAW JSON
  my $listener = AnyEvent::Twitter::Stream-&gt;new&#40;
      consumer_key    =&gt; $consumer_key,
      consumer_secret =&gt; $consumer_secret,
      token           =&gt; $token,
      token_secret    =&gt; $token_secret,
      method          =&gt; &#34;filter&#34;,
      track           =&gt; &#34;...&#34;,
      no_decode_json =&gt; 1,
      on_json =&gt; sub {
		 my $json = shift;
		 ...
      },
  &#41;;</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-978838" href="/Public/Bug/Display.html?id=70952#txn-978838">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;18&nbsp;15:58:22&nbsp;2011</span>
    <span class="description">miyagawa [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #70952] no_decode_json argument breaks Twitter Stream</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 18 Sep 2011 12:57:51 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-AnyEvent-Twitter-Stream [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tatsuhiko Miyagawa &lt;miyagawa [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/978838/509526/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/509526">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Could you open a pull request on
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/miyagawa/AnyEvent-Twitter-Stream">https://github.com/miyagawa/AnyEvent-Twitter-Stream</a></span> ?

On Tue, Sep 13, 2011 at 10:09 PM, RenÃ© Lux via RT
&lt;bug-AnyEvent-Twitter-Stream@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Wed Sep 14 01:09:52 2011: Request 70952 was acted upon.
&gt; Transaction: Ticket created by renelux
&gt; Â  Â  Â  Queue: AnyEvent-Twitter-Stream
&gt; Â  Â  Subject: no_decode_json argument breaks Twitter Stream
&gt; Â  Broken in: 0.21
&gt; Â  Â Severity: Important
&gt; Â  Â  Â  Owner: Nobody
&gt; Â Requestors: info@luxdevelopment.net
&gt; Â  Â  Â Status: new
&gt; Â Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=70952">https://rt.cpan.org/Ticket/Display.html?id=70952</a></span> &gt;
&gt;
&gt;
&gt; our application is distributing tweets to other servers for processing.
&gt; We ran into the problem that when we use the argument no_decode_json the
&gt; AnyEvent-Twitter-Stream package stopped working.The algorythm to detect
&gt; which method will be called needs to be decoded JSON.
&gt;
&gt; The following error was provided &#34;Thread 1 terminated abnormally: Can&#39;t
&gt; use string &#40;&#34;{&#34;id_str&#34;:&#34;113821408630546432&#34;,&#34;&#34;&#41; as a HASH ref while
&gt; &#34;strict refs&#34; in use at
&gt; /usr/local/share/perl/5.10.1/AnyEvent/Twitter/Stream.pm line 125.&#34;
&gt;
&gt; In the attachment you can find our suggestion to solve this problem. We
&gt; modified lines 48, 126, 127, 128.
&gt;
&gt; With this patch you will give developers the change to make there own
&gt; algorithm for handling tweet events. And for distributed clients like
&gt; ours we can pass along undecoded JSON and decode it on another server.
&gt;
&gt; I also extended the examples you provided at
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~miyagawa/AnyEvent-Twitter-Stream-">http://search.cpan.org/~miyagawa/AnyEvent-Twitter-Stream-</a></span>
&gt; 0.21/lib/AnyEvent/Twitter/Stream.pm the extra example can be found in
&gt; example.pl
&gt;
</div>


-- 
Tatsuhiko Miyagawa
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-978841" href="/Public/Bug/Display.html?id=70952#txn-978841">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;18&nbsp;15:58:23&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-980107" href="/Public/Bug/Display.html?id=70952#txn-980107">#</a>      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;21&nbsp;22:43:51&nbsp;2011</span>
    <span class="description">info [...] luxdevelopment.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> info [...] luxdevelopment.net</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/980107/510256/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/510256">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have send you a pull request on GitHub, I didn&#39;t have time to modify the test script yet.

On Sun Sep 18 15:58:22 2011, miyagawa@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Could you open a pull request on
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/miyagawa/AnyEvent-Twitter-Stream">https://github.com/miyagawa/AnyEvent-Twitter-Stream</a></span> ?
&gt; 
&gt; On Tue, Sep 13, 2011 at 10:09 PM, RenÃ© Lux via RT
&gt; &lt;bug-AnyEvent-Twitter-Stream@rt.cpan.org&gt; wrote:
<div class="message-stanza open">&gt; &gt; Wed Sep 14 01:09:52 2011: Request 70952 was acted upon.
&gt; &gt; Transaction: Ticket created by renelux
&gt; &gt; Â  Â  Â  Queue: AnyEvent-Twitter-Stream
&gt; &gt; Â  Â  Subject: no_decode_json argument breaks Twitter Stream
&gt; &gt; Â  Broken in: 0.21
&gt; &gt; Â  Â Severity: Important
&gt; &gt; Â  Â  Â  Owner: Nobody
&gt; &gt; Â Requestors: info@luxdevelopment.net
&gt; &gt; Â  Â  Â Status: new
&gt; &gt; Â Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=70952">https://rt.cpan.org/Ticket/Display.html?id=70952</a></span> &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; our application is distributing tweets to other servers for processing.
&gt; &gt; We ran into the problem that when we use the argument no_decode_json the
&gt; &gt; AnyEvent-Twitter-Stream package stopped working.The algorythm to detect
&gt; &gt; which method will be called needs to be decoded JSON.
&gt; &gt;
&gt; &gt; The following error was provided &#34;Thread 1 terminated abnormally: Can&#39;t
&gt; &gt; use string &#40;&#34;{&#34;id_str&#34;:&#34;113821408630546432&#34;,&#34;&#34;&#41; as a HASH ref while
&gt; &gt; &#34;strict refs&#34; in use at
&gt; &gt; /usr/local/share/perl/5.10.1/AnyEvent/Twitter/Stream.pm line 125.&#34;
&gt; &gt;
&gt; &gt; In the attachment you can find our suggestion to solve this problem. We
&gt; &gt; modified lines 48, 126, 127, 128.
&gt; &gt;
&gt; &gt; With this patch you will give developers the change to make there own
&gt; &gt; algorithm for handling tweet events. And for distributed clients like
&gt; &gt; ours we can pass along undecoded JSON and decode it on another server.
&gt; &gt;
&gt; &gt; I also extended the examples you provided at
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~miyagawa/AnyEvent-Twitter-Stream-">http://search.cpan.org/~miyagawa/AnyEvent-Twitter-Stream-</a></span>
&gt; &gt; 0.21/lib/AnyEvent/Twitter/Stream.pm the extra example can be found in
&gt; &gt; example.pl
&gt; &gt;
</div>&gt; 
&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.334345</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
