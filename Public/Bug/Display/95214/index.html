<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #95214 for DBD-Pg: DBD::Pg 3.x BYTEA issues with UTF-8 encoded database</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #95214 for DBD-Pg: DBD::Pg 3.x BYTEA issues with UTF-8 encoded database</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-Pg/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-Pg/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-Pg/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-Pg/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-Pg">DBD-Pg CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">95214</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-Pg/Active/">DBD-Pg</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">greg [...] turnstep.com
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
michael.graziano [...] premierheart.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-10200-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10201-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
3.3.0    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;30&nbsp;12:49:07&nbsp;2014</span>
    <span class="description">michael.graziano [...] premierheart.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> DBD::Pg 3.x BYTEA issues with UTF-8 encoded database</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 30 Apr 2014 12:48:51 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Pg [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Michael Graziano &lt;michael.graziano [...] premierheart.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">We’ve encountered a regression in DBD::Pg 3.0 which I believe is related to the new unicode handling - bytea strings being passed to the database are being mangled when inserting into a utf-8 encoded database.

The affected perl code worked on both SQL_ASCII and utf-8 encoded databases under the 2.19.3 DBD::Pg driver. 
Under the 3.x driver the bytea data is corrupted when we insert into a utf-8 encoded database &#40;the inserted data is longer than the contents being inserted&#41;, but the code continues to work normally on a SQL_ASCII encoded database.

The affected code &#40;extract&#41; is:

####### BEGIN EXCERPT #######
# Generate File1 
$file1_contents = pack &#40; &#34;a13a4a2a17a14a13a17a16a2LSaaaaaaa20a12aaa94Sa11LS”,
        $fn, $a, $s, $n, 0, $h, $cid,
        &#34;0000000&#34;, &#34;N&#34;, $date, $hid,
        &#34;&#34;, &#34;&#34;, &#34;&#34;, &#34;&#34;, &#34;&#34;, &#34;&#34;,
        &#34;&#34;, &#34;&#34;, &#34;&#34;, &#34;&#34;, &#34;NNNNNNNNNN&#34;, 0, &#34;&#34;,
        &#38;UnixDate&#40;$db, “%s&#34;&#41;, 0x6E
        &#41;;


# Generate File2 from File1 and raw data
## raw_data is from sysread&#40;&#41;
$file2_contents = pack&#40; “a256a32776”, $file1_contents, $raw_data &#41;; 


$stmt = $db-&gt;prepare&#40;“INSERT INTO $table &#40; field1, field2&#41; VALUES &#40; ?, ? &#41; “ &#41;;
if &#40;! defined&#40;$stmt&#41; &#41; {
        show_error&#40; &#34;Unable to prepare INSERT $table : $DBI::errstr&#34; &#41;;
        $db-&gt;disconnect&#40;&#41;;
        exit -3;
}

$stmt-&gt;bind_param&#40; 1, $file1_contents, { pg_type =&gt; DBD::Pg::PG_BYTEA } &#41;;
$stmt-&gt;bind_param&#40; 2, $file2_contents, { pg_type =&gt; DBD::Pg::PG_BYTEA } &#41;;

if &#40;! $stmt-&gt;execute&#40;&#41; &#41; {
        show_error&#40; &#34;Unable to INSERT $table : $DBI::errstr&#34; &#41;;
        $stmt-&gt;finish;
        $db-&gt;disconnect&#40;&#41;;
        exit -4;
}
$stmt-&gt;finish;
######## END EXCERPT ########

It appears this is still the correct way to handle bytea inserts and should “Just Work”, so I’m raising this as a bug - if we’re screwing up something obvious please let me know. &#40;Unfortunately recoding to SQL_ASCII is absolutely not an option for us - in-database encoding enforcement is needed.&#41;



OS Information:
FreeBSD dbi01.dev.premierheart.com 9.1-RELEASE-p11 FreeBSD 9.1-RELEASE-p11 #2 r264302: Wed Apr  9 16:36:12 EDT 2014 root@SYSBUILDER.dev.premierheart.com:/usr/obj/usr/src/sys/ph-amd64  amd64

Database Information:
PostgreSQL 9.3.1

Perl Information:
This is perl 5, version 18, subversion 2 &#40;v5.18.2&#41; built for amd64-freebsd-thread-multi

Tested broken on:
DBD::Pg 3.0.0 ; DBD::Pg 3.1.1
Using DBI 1.631
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;30&nbsp;14:13:59&nbsp;2014</span>
    <span class="description">greg [...] turnstep.com -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;30&nbsp;14:29:27&nbsp;2014</span>
    <span class="description">greg [...] turnstep.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">That *should* work, sorry to hear it is not. Can you make the test case a little more self-contained so I can duplicate it &#40;e.g. I don&#39;t know what $fn, $a, $s, $n, 0, $h, $cid&#41; are set to. A slightly modified version worked for me, so ideally I would use the exact same data and table. Also, what error are you seeing / how do you know it&#39;s the wrong length?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;30&nbsp;14:29:28&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;30&nbsp;14:55:40&nbsp;2014</span>
    <span class="description">michael.graziano [...] premierheart.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95214] DBD::Pg 3.x BYTEA issues with UTF-8 encoded database</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 30 Apr 2014 14:55:23 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Pg [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Michael Graziano &lt;michael.graziano [...] premierheart.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On Apr 30, 2014, at 2:29 PM, Greg Sabino Mullane via RT &lt;bug-DBD-Pg@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95214">https://rt.cpan.org/Ticket/Display.html?id=95214</a></span> &gt;
&gt; 
&gt; That *should* work, sorry to hear it is not. Can you make the test case a little more self-contained so I can duplicate it &#40;e.g. I don&#39;t know what $fn, $a, $s, $n, 0, $h, $cid&#41; are set to. A slightly modified version worked for me, so ideally I would use the exact same data and table. Also, what error are you seeing / how do you know it&#39;s the wrong length?
</div>
I should be able to gimmick up a more friendly test case pretty easily - We initially went down a rabbit hole of “Uh, did perl break pack&#40;&#41;?” so I’ve got half the test case already written and just need to tack on some live data  and a test table &#40;if I can’t get to it today I’ll bang on it tonight and should have something externally reproducible tomorrow&#41;.

What we’re seeing in terms of corruption is definitely strange — we’re not seeing any errors on insert, but when we retrieve “file2” from the DB it’s coming back several bytes longer than it “should be” based on the pack&#40;&#41; format &#40;the thing that consumes this data is some grotty legacy code that among its sins uses file length to verify correct format, so it sees the file is oversized and bails&#41;.

I’ve managed to rule out problems with the retrieval script &#40;ruby&#41; because data inserted with the 2.19 driver comes out OK so my current suspect is some strangeness in Perl’s internal utf-8 handling that’s bleeding over onto the bytea data &#40;since we’re not doing anything special for utf-8 mode in our script my understanding is the 2.x driver would have just claimed ignorance and assumed the DB would sort it out&#41;.
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;30&nbsp;16:01:04&nbsp;2014</span>
    <span class="description">michael.graziano [...] premierheart.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95214] DBD::Pg 3.x BYTEA issues with UTF-8 encoded database</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 30 Apr 2014 16:00:42 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Pg [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Michael Graziano &lt;michael.graziano [...] premierheart.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Quicker than I thought — reproducibly broken test script and testing database.

I tracked the issue in a little deeper: It seems to have to do with having the UTF-8 bit set on strings that came out of the database which we then wind up pack&#40;&#41;ing and re-inserting in the bytea fields. &#40;Perl seems to be tagging the resulting packed values as utf-8 strings — which makes sense to Perl, but not to Postgres in this context since we’re expecting to send it “raw binary &#40;bytea&#41; data” and perl is passing it along as “cooked UTF-8 string”&#41;.
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">

On Apr 30, 2014, at 2:55 PM, Michael Graziano &lt;michael.graziano@premierheart.com&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; On Apr 30, 2014, at 2:29 PM, Greg Sabino Mullane via RT &lt;bug-DBD-Pg@rt.cpan.org&gt; wrote:
&gt; 
<div class="message-stanza open">&gt;&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95214">https://rt.cpan.org/Ticket/Display.html?id=95214</a></span> &gt;
&gt;&gt; 
&gt;&gt; That *should* work, sorry to hear it is not. Can you make the test case a little more self-contained so I can duplicate it &#40;e.g. I don&#39;t know what $fn, $a, $s, $n, 0, $h, $cid&#41; are set to. A slightly modified version worked for me, so ideally I would use the exact same data and table. Also, what error are you seeing / how do you know it&#39;s the wrong length?
</div>&gt; 
&gt; I should be able to gimmick up a more friendly test case pretty easily - We initially went down a rabbit hole of “Uh, did perl break pack&#40;&#41;?” so I’ve got half the test case already written and just need to tack on some live data  and a test table &#40;if I can’t get to it today I’ll bang on it tonight and should have something externally reproducible tomorrow&#41;.
&gt; 
&gt; What we’re seeing in terms of corruption is definitely strange — we’re not seeing any errors on insert, but when we retrieve “file2” from the DB it’s coming back several bytes longer than it “should be” based on the pack&#40;&#41; format &#40;the thing that consumes this data is some grotty legacy code that among its sins uses file length to verify correct format, so it sees the file is oversized and bails&#41;.
&gt; 
&gt; I’ve managed to rule out problems with the retrieval script &#40;ruby&#41; because data inserted with the 2.19 driver comes out OK so my current suspect is some strangeness in Perl’s internal utf-8 handling that’s bleeding over onto the bytea data &#40;since we’re not doing anything special for utf-8 mode in our script my understanding is the 2.x driver would have just claimed ignorance and assumed the DB would sort it out&#41;.
&gt; 
</div></div></div>
</div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;02&nbsp;19:29:30&nbsp;2014</span>
    <span class="description">greg [...] turnstep.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">DBD::Pg should definitely not be marking bytea fields as UTF-8. It&#39;s quite possible it is when it ought not to be. Unfortunately, I&#39;m not sure what your test script is supposed to demonstrate. The only output is:

File1 Size: 257
File2 Size: 33032
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;05&nbsp;15:39:49&nbsp;2014</span>
    <span class="description">michael.graziano [...] premierheart.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #95214] DBD::Pg 3.x BYTEA issues with UTF-8 encoded database</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 5 May 2014 15:39:22 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Pg [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Michael Graziano &lt;michael.graziano [...] premierheart.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Oops - left out an important bit that I was doing manually &#40;getting the inserted sizes from the database&#41; - Updated version which pulls the data lengths &#40;octet_size&#40;&#41;&#41; from Postgres attached. 

Note also that there are two blocks for setting $pname &#40;the string that seems to cause the misbehavior&#41;:
The default operating mode &#40;lines 24-29&#41; gets this value out of the database &#40;utf-8 encoded&#41;, so it results in a UTF-8 string that seems to upset things - you should get different sizes out of the database, similar to:

File1 Size: 257 ; DB Size: 262
File2 Size: 33032 ; DB Size: 41034


If you comment out that block and uncomment line 35 &#40;setting the value to an ASCII string&#41;, the code behaves as expected &#40;File sizes and DB sizes match&#41;.
&#40;The script also behaves as expected if the database is created with SQL_ASCII encoding instead of UTF-8 - presumably because the $pname string isn’t getting tagged as utf-8 in that case&#41;.


-MG
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">


On May 2, 2014, at 7:29 PM, Greg Sabino Mullane via RT &lt;bug-DBD-Pg@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=95214">https://rt.cpan.org/Ticket/Display.html?id=95214</a></span> &gt;
&gt; 
&gt; DBD::Pg should definitely not be marking bytea fields as UTF-8. It&#39;s quite possible it is when it ought not to be. Unfortunately, I&#39;m not sure what your test script is supposed to demonstrate. The only output is:
&gt; 
&gt; File1 Size: 257
&gt; File2 Size: 33032
&gt; 
&gt; 
</div></div></div>
</div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;08&nbsp;11:27:36&nbsp;2014</span>
    <span class="description">greg [...] turnstep.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think I&#39;ve whittled this down to a better test case. I suspect the problem lies in comparing len&#40;$string&#41; with octet_length&#40;string&#41;. The former is character based, the latter is byte based. Try this:

use Data::Peek;
$pname = &#34;ABC&#34;;
utf8::upgrade&#40;$pname&#41;;
$file1_contents = pack&#40;&#34;aS&#34;, ## unsigned short
  $pname, 65535&#41;;
...
print DPeek&#40;$file1_contents&#41;; print &#34;\n&#34;;
print &#34;File1 Size: $len ; DB Size: $res[0]\n&#34;;

This should be the same as your test case: ultimately it&#39;s the first string being UTF-8 plus the unsigned short packing that creates a string that is different. The output:
PV&#40;&#34;A\303\277\303\277&#34;\0&#41; [UTF8 &#34;A\x{ff}\x{ff}&#34;]
File1 Size: 3 ; DB Size: 5

So both are correct: this is a three character string, but it has five bytes.

If I&#39;m understanding something wrong, please let me know; see if you can verify that the test case above still represents the problem you are seeing.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;27&nbsp;10:29:20&nbsp;2014</span>
    <span class="description">ilmari+cpan [...] ilmari.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2014-05-08 16:27:36, TURNSTEP wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think I&#39;ve whittled this down to a better test case. I suspect the
&gt; problem lies in comparing len&#40;$string&#41; with octet_length&#40;string&#41;. The
&gt; former is character based, the latter is byte based. Try this:
</div>
length&#40;&#41; in perl and octet_length&#40;&#41; in Postgres should be the same, since in Postgres they are the same for bytea, and in perl the code points are the only thing that matters semantically.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; use Data::Peek;
&gt; $pname = &#34;ABC&#34;;
&gt; utf8::upgrade&#40;$pname&#41;;
&gt; $file1_contents = pack&#40;&#34;aS&#34;, ## unsigned short
&gt;   $pname, 65535&#41;;
&gt; ...
&gt; print DPeek&#40;$file1_contents&#41;; print &#34;\n&#34;;
&gt; print &#34;File1 Size: $len ; DB Size: $res[0]\n&#34;;
&gt; 
&gt; This should be the same as your test case: ultimately it&#39;s the first
&gt; string being UTF-8 plus the unsigned short packing that creates a
&gt; string that is different. The output:
&gt; PV&#40;&#34;A\303\277\303\277&#34;\0&#41; [UTF8 &#34;A\x{ff}\x{ff}&#34;]
&gt; File1 Size: 3 ; DB Size: 5
&gt; 
&gt; So both are correct: this is a three character string, but it has five
&gt; bytes.
&gt; 
&gt; If I&#39;m understanding something wrong, please let me know; see if you
&gt; can verify that the test case above still represents the problem you
&gt; are seeing.
</div>
The problem is that DBD:Pg 3.[0-2] is sending the internal representation of the upgraded string &#40;&#34;A\303\277\303\277&#34;&#41; to Pg, not the code points it represents &#40;&#34;A\x{ff}\x{ff}&#34;&#41;.

This is fixed in git master, by making sure values bound as BYTEA are properly downgraded: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/bucardo/dbdpg/commit/1212e3e47339dd4cf21d83f6ef71dbd9e6be3364">https://github.com/bucardo/dbdpg/commit/1212e3e47339dd4cf21d83f6ef71dbd9e6be3364</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;28&nbsp;06:45:32&nbsp;2014</span>
    <span class="description">greg [...] turnstep.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This is fixed in git master, by making sure values bound as BYTEA are
&gt; properly downgraded:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/bucardo/dbdpg/commit/1212e3e47339dd4cf21d83f6ef71dbd9e6be3364">https://github.com/bucardo/dbdpg/commit/1212e3e47339dd4cf21d83f6ef71dbd9e6be3364</a></span>
</div>

Thanks, marking as patched.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;28&nbsp;06:45:35&nbsp;2014</span>
    <span class="description">greg [...] turnstep.com -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;26&nbsp;10:28:16&nbsp;2014</span>
    <span class="description">greg [...] turnstep.com -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;26&nbsp;10:28:16&nbsp;2014</span>
    <span class="description">greg [...] turnstep.com -  Severity Critical added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;26&nbsp;10:28:17&nbsp;2014</span>
    <span class="description">greg [...] turnstep.com -  Fixed in 3.3.0 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
