<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #92332 for CGI: Nasty race condition in tempory file handling</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #92332 for CGI: Nasty race condition in tempory file handling</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=CGI">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=CGI">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=CGI">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=CGI">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/leejo/CGI.pm/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/CGI">CGI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">92332</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=CGI">CGI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
killing [...] multiplay.co.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-230860-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-230861-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=92332">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1315460" href="/Public/Bug/Display.html?id=92332#txn-1315460">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;21&nbsp;08:00:38&nbsp;2014</span>
    <span class="description">killing [...] multiplay.co.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Nasty race condition in tempory file handling</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 21 Jan 2014 13:00:19 -0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-CGI [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Steven Hartland&#34; &lt;killing [...] multiplay.co.uk&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1315460/697329/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/697329">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The following code has nasty race condition which can cause
problems with multiple simultaneous file uploads.

# choose a relatively unpredictable tmpfile sequence number
my $seqno = unpack&#40;&#34;%16C*&#34;,join&#40;&#39;&#39;,localtime,grep {defined $_} values %ENV&#41;&#41;;
for &#40;my $cnt=10;$cnt&gt;0;$cnt--&#41; {
    next unless $tmpfile = CGITempFile-&gt;new&#40;$seqno&#41;;
    $tmp = $tmpfile-&gt;as_string;
    last if defined&#40;$filehandle = Fh-&gt;new&#40;$filename,$tmp,$PRIVATE_TEMPFILES&#41;&#41;;
    $seqno += int rand&#40;100&#41;;
}

Here CGITempFile creates a file based on checks for which it
believes is a valid new and unique temporary filename.

Fh then tries to create said file but can fail if the file
already exists e.g. when two uploads are executing at the
same time.

If a Fh does fail detect a conflict another iteration of
the loop occurs to look for a new name. At this point the
previous loop iterations CGITempFile goes out of scope
which triggers its DESTORY which unlinks the file this
process never opened.

Due to this unlink a third process can then allocate the
same filename as process #1. Now if process #1 does anything
with the filename it can access via $cgi-&gt;tmpFileName it
will access the file created by #3 which is not the intention.

Ideally CGITempFile should be responsible for the creation
of the file, so the details it returns &#40;which should include
a filehandle&#41; are guaranteed to work.

Alternatively an additional method could be added to CGITempFile
to prevent it deleting the file so the following something
like the following code &#40;untested&#41; could be used.

for &#40;my $cnt=10;$cnt&gt;0;$cnt--&#41; {
    next unless $tmpfile = CGITempFile-&gt;new&#40;$seqno&#41;;
    $tmp = $tmpfile-&gt;as_string;
    last if defined&#40;$filehandle = Fh-&gt;new&#40;$filename,$tmp,$PRIVATE_TEMPFILES&#41;&#41;;
    # Tell CGITempFile that the filename is invalid so it
    # should not perform an unlink on delete
    $tmpfile-&gt;unused&#40;&#41;; 
    $seqno += int rand&#40;100&#41;;
}

sub unused {
    my &#40;$self&#41; = @_
    $$self = &#39;&#39;;
}

sub DESTROY {
    my&#40;$self&#41; = @_;
    return if &#40;$$safe eq &#39;&#39;&#41;;   # filename wasn&#39;t unused
    $$self =~ m!^&#40;[a-zA-Z0-9_ \&#39;\&#34;:/.\$\\~-]+&#41;$! || return;
    my $safe = $1;             # untaint operation
    unlink $safe;              # get rid of the file
}

Finally it may be a good idea to update $seqno to generate
more random values as the current method virtually always
results in clashes for multiple simultaneous processes.
The following produces a pretty random number:
my $seqno = &#40;localtime&#40;&#41;&#41;[0] . $$;

    Regards
    Steve

================================================
This e.mail is private and confidential between Multiplay &#40;UK&#41; Ltd. and the person or entity to whom it is addressed. In the event of misdirection, the recipient is prohibited from using, copying, printing or otherwise disseminating it or any information contained in it. 

In the event of misdirection, illegible or incomplete transmission please telephone +44 845 868 1337
or return the E.mail to postmaster@multiplay.co.uk.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1366339" href="/Public/Bug/Display.html?id=92332#txn-1366339">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;22&nbsp;08:21:16&nbsp;2014</span>
    <span class="description">LEEJO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1366339/725549/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/725549">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 241b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This issue has been copied to: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/leejo/CGI.pm/issues/131">https://github.com/leejo/CGI.pm/issues/131</a></span> please take all future correspondence there.
This ticket will remain open but please do not reply here.
This ticket will be closed when the github issue is dealt with.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1366340" href="/Public/Bug/Display.html?id=92332#txn-1366340">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;22&nbsp;08:21:16&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1416025" href="/Public/Bug/Display.html?id=92332#txn-1416025">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;28&nbsp;15:54:31&nbsp;2014</span>
    <span class="description">LEEJO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1416025/751723/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/751723">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">commit 1aa4cb0262103d7d0f657099bb54a557ce1b237b
Author: Lee Johnson &lt;lee@givengain.ch&gt;
Date:   Sun Sep 28 20:46:46 2014 +0100

    resolve #125, #131 - refactor temp file handling

    the CGITempFile and Fh packages are gone and have been replaced by
    CGI::File::Temp, which is a compatibility wrapper around the File::Temp
    package. File::Temp behaves as a filehandle, and isa IO::Handle and
    isa IO::Seekable so behaves as we want it to

    bump version to 4.04_02 for cpantesters dev release testing

    Squashed commit of the following:

    commit 3af477dacef09d7d01086a6fb3984471e6892c9e
    Author: Lee Johnson &lt;lee@givengain.ch&gt;
    Date:   Sun Sep 28 20:45:32 2014 +0100

        temp files done

    commit 982fc37665a8754d09e7f5952bc04a736ebcfc26
    Author: Lee Johnson &lt;lee@givengain.ch&gt;
    Date:   Thu Sep 25 10:55:33 2014 +0100

        WIP - refactor CGITempFile and Fh to File::Temp

 Changes           |   8 ++--
 MANIFEST          |   1 -
 Makefile.PL       |  19 ++++-----
 lib/CGI.pm        | 328 ++++++++++++++++++++++++++++++++++-------------------------------------------------------------------------------------------------------------------------
 lib/CGI/Carp.pm   |   2 +-
 lib/CGI/Cookie.pm |   2 +-
 lib/CGI/Pretty.pm |   2 +-
 lib/CGI/Push.pm   |   2 +-
 lib/CGI/Util.pm   |   2 +-
 t/rt-31107.t      |  12 +++++-
 t/tmpdir.t        |  51 ------------------------
 t/upload.t        |   2 +-
 12 files changed, 103 insertions&#40;+&#41;, 328 deletions&#40;-&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1416028" href="/Public/Bug/Display.html?id=92332#txn-1416028">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;28&nbsp;15:54:32&nbsp;2014</span>
    <span class="description">LEEJO [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.270492</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
