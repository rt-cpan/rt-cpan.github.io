<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #103545 for future: Design thoughts on -&gt;catch method</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #103545 for future: Design thoughts on -&gt;catch method</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=future">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=future">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=future">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=future">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/future">future CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">103545</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=future">future</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
leonerd-cpan [...] leonerd.org.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-13900-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-13901-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




rt103545-a1.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1521161/811322/rt103545-a1.patch">
Tue Jul 28 14:42:59 2015 (6.9k) by leonerd-cpan [...] leonerd.org.uk
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=103545">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1484976" href="/Public/Bug/Display.html?id=103545#txn-1484976">#</a>      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;14&nbsp;13:58:29&nbsp;2015</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Design thoughts on -&gt;catch method</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1484976/791093/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/791093">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">A lot of uses of -&gt;else or -&gt;else_with_f turn out to be looking for specific kinds of failure. E.g. a common case is looking for HTTP failures:

  -&gt;else_with_f&#40; sub {
    my &#40; $f, undef, $name, $response &#41; = @_;
    return $f unless defined $name and $name eq &#34;http&#34;;
    ### maybe inspect $response here
    ...
  }&#41;

It would be nice in this case to be able to notate that boilerplate using

  -&gt;catch&#40; http =&gt; sub {
    my &#40; $message, $name, $response &#41; = @_;
    ...
  }&#41;

If &#39;catch&#39; were to take a KV list instead of a single name/code pair, we could easily handle the &#34;atomic&#34; test of multiple failures without each getting in the way of the others, using

  -&gt;catch&#40;
    resolve =&gt; sub { die &#34;Cannot resolve that hostname&#34; },
    connect =&gt; sub { die &#34;Cannot connect to the host&#34; },
    ssl     =&gt; sub { die &#34;Failed to negotiate SSL&#34; },
    http    =&gt; sub { die &#34;Cannot talk HTTP&#34; },
    ...
  &#41;

A few unresolved design questions come up here though:

 * How to notate failures without type names - e.g. the ones generated by internal perl 
   failures &#40;e.g. method call on undef, strictness violations, etc...&#41;

 * How to &#39;catch&#39; a done?

The latter feature would be useful for handling &#34;I expect this to fail&#34; cases, where we want to turn certain specific kinds of failure into success, and success into a failure. For example, if we decide to &#34;catch&#34; non-failure using some special notation, then we could do

  -&gt;catch&#40;
    &#39;:done&#39; =&gt; sub { die &#34;Expected HTTP 403 failure&#34; },
     http   =&gt; sub { $_[2]-&gt;code == 403 and return Future-&gt;done;
                     Future-&gt;fail&#40; @_ &#41; },
  &#41;

Here, if the preceding Future fails with an &#34;http&#34; type of failure, and the response code was 403, then the sequenced Future will succeed; if the preceding one either succeeds or fails in some other way, then the sequenced one fails.

Having such a notation as &#39;:done&#39; would suggest we might want to make it an error to Future-&gt;fail with a name field whose name starts with :. Moreover, it might make sense to suggest that the name field of any failure ought to match &#34;sensible&#34; identifier rules.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1486586" href="/Public/Bug/Display.html?id=103545#txn-1486586">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;15&nbsp;06:23:29&nbsp;2015</span>
    <span class="description">DAKKAR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1486586/791810/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/791810">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">In addition to simple strings &#40;to be C&lt;eq&gt;-matched against C&lt;&lt;
&#40;$f-&gt;failure&#41;[0] &gt;&gt;&#41;, we could allow L&lt;Smart::Match&gt;-like objects
&#40;blessed refs overloading C&lt;~~&gt;&#41; and C&lt;Type::Tiny&gt;-like objects &#40;I&#39;m
not sure what the protocol is, here&#41;.

C&lt;&#39;:done&#39;&gt; still needs to be a bit special, since we&#39;d not be matching
the result of C&lt;failure&gt;; we can just use a unique ref blessed into a
special package &#40;e.g. C&lt;&lt;sub MATCH_DONE { state $x = bless do {\&#40;my
$a&#41;},&#39;Future::Catch::Special::Done&#39;; $x }&gt;&gt;&#41;.

Also, as tom suggested on IRC, we can allow regexes, and arrayrefs
&#40;&#34;match any of the elements&#34;&#41;.

Half-assed implementation:

  sub catch {
    my $f = shift;

    my @cases;
    while &#40;my &#40;$case,$action&#41; = splice @_,0,2&#41; {
      push @cases, [_convert_matcher&#40;$case&#41;, $action];
    }

    return $f-&gt;followed_by&#40;sub {
      my $g = shift;
      for my $case &#40;@cases&#41; {
        my &#40;$matcher,$action&#41; = @_;
        if &#40;$matcher-&gt;&#40;$g&#41;&#41; {
          return $action-&gt;&#40;$g&#41;;
        }
      }
      return $g;
    }&#41;;
  }

  sub _convert_matcher {
    my $case = shift;
    if &#40;_is_smart_match&#40;$case&#41;&#41; {
      return sub { $_[0]-&gt;is_failed &#38;&#38; &#40;$_[0]-&gt;failure&#41;[0] ~~ $case }
    }
    elsif &#40;_is_type_constraint&#40;$case&#41;&#41; {
      return sub { $_[0]-&gt;is_failed &#38;&#38; $case-&gt;check&#40;$_[0]-&gt;failure&#41;[0]&#41; }
    }
    elsif &#40;_is_special_done_value&#40;$case&#41;&#41; {
      return sub { $_[0]-&gt;is_done }
    }
    elsif &#40;ref&#40;$case&#41; eq &#39;Regexp&#39;&#41; {
      return sub { $_[0]-&gt;is_failed &#38;&#38; &#40;$_[0]-&gt;failure&#41;[0] =~ $case }
    }
    elsif &#40;ref&#40;$case&#41; eq &#39;ARRAY&#39;&#41; {
      my @subcases = map {_convert_matcher&#40;$_&#41;} @$case;
      return sub { my &#40;$f&#41;=@_; any { $_-&gt;&#40;$f&#41; } @subcases };
    }
    else {
      die &#34;wtf?&#34;
    }
  }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1486587" href="/Public/Bug/Display.html?id=103545#txn-1486587">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;15&nbsp;06:23:29&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1487446" href="/Public/Bug/Display.html?id=103545#txn-1487446">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;17&nbsp;13:24:00&nbsp;2015</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1487446/792154/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/792154">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 571b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Further discussions lead to the idea of:

  -&gt;catch&#40; @kvlist, $fallback &#41;

to simply be a wrapper around a more generic idea of

  -&gt;then&#40; $on_success, @kvlist, $on_other_failure &#41;

At which point we don&#39;t need the special &#34;DONE&#34; handler match.

As to the kvlist: for now a simple string-equality match on the failure name, and the lack of statement about duplicates/ordering constraints, should let the implementation be quite flexible &#40;for performance&#41;, while leaving the design space open for other ideas of better match abilities at some later point.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1521161" href="/Public/Bug/Display.html?id=103545#txn-1521161">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;28&nbsp;14:42:59&nbsp;2015</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1521161/811321/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/811321">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 815b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Apr 17 13:24:00 2015, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Further discussions lead to the idea of:
&gt; 
&gt; -&gt;catch&#40; @kvlist, $fallback &#41;
&gt; 
&gt; to simply be a wrapper around a more generic idea of
&gt; 
&gt; -&gt;then&#40; $on_success, @kvlist, $on_other_failure &#41;
&gt; 
&gt; At which point we don&#39;t need the special &#34;DONE&#34; handler match.
&gt; 
&gt; As to the kvlist: for now a simple string-equality match on the
&gt; failure name, and the lack of statement about duplicates/ordering
&gt; constraints, should let the implementation be quite flexible &#40;for
&gt; performance&#41;, while leaving the design space open for other ideas of
&gt; better match abilities at some later point.
</div>
An initial patch that implements it this far, and also points at this RT ticket for further consideration/discussion.

I think this looks good enough to ship as a first cut.

-- 

Paul Evans
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rt103545-a1.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1521161/811322/rt103545-a1.patch">Download rt103545-a1.patch</a><br />
<span class="downloadcontenttype">text/x-diff 6.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">=== modified file &#39;lib/Future.pm&#39;
--- lib/Future.pm	2015-07-28 15:28:42 +0000
+++ lib/Future.pm	2015-07-28 18:38:51 +0000
@@ -76,6 +76,31 @@
 See also L&lt;Future::Utils&gt; which contains useful loop-constructing functions,
 to run a future-returning function repeatedly in a loop.
 
+=head2 FAILURE CATEGORIES
+
+While not directly required by C&lt;Future&gt; or its related modules, a growing
+convention of C&lt;Future&gt;-using code is to encode extra semantics in the
+arguments given to the C&lt;fail&gt; method, to represent different kinds of
+failure.
+
+The convention is that after the initial message string as the first required
+argument &#40;intended for display to humans&#41;, the second argument is a short
+lowercase string that relates in some way to the kind of failure that
+occurred. Following this is a list of details about that kind of failure,
+whose exact arrangement or structure are determined by the failure category.
+For example, L&lt;IO::Async&gt; and L&lt;Net::Async::HTTP&gt; use this convention to
+indicate at what stage a given HTTP request has failed:
+
+   -&gt;fail&#40; $message, http =&gt; ... &#41;  # an HTTP-level error during protocol
+   -&gt;fail&#40; $message, connect =&gt; ... &#41;  # a TCP-level failure to connect a
+                                       # socket
+   -&gt;fail&#40; $message, resolve =&gt; ... &#41;  # a resolver &#40;likely DNS&#41; failure
+                                       # to resolve a hostname
+
+By following this convention, a module remains consistent with other
+C&lt;Future&gt;-based modules, and makes it easy for program logic to gracefully
+handle and manage failures by use of the C&lt;catch&gt; method.
+
 =head2 SUBCLASSING
 
 This class easily supports being subclassed to provide extra behavior, such as
@@ -1079,9 +1104,11 @@
 sub then
 {
    my $self = shift;
-   my &#40; $done_code, $fail_code &#41; = @_;
+   my $done_code = shift;
+   my $fail_code = &#40; @_ % 2 &#41; ? pop : undef;
+   my @catch_list = @_;
 
-   if&#40; $done_code and !$fail_code &#41; {
+   if&#40; $done_code and !@catch_list and !$fail_code &#41; {
       return $self-&gt;_sequence&#40; $done_code, CB_SEQ_ONDONE|CB_RESULT &#41;;
    }
 
@@ -1091,6 +1118,7 @@
       Carp::croak &#34;Expected \$fail_code to be callable in -&gt;then&#34;;
 
    # Complex
+   my %catch_handlers = @catch_list;
    return $self-&gt;_sequence&#40; sub {
       my $self = shift;
       if&#40; !$self-&gt;{failure} &#41; {
@@ -1098,6 +1126,10 @@
          return $done_code-&gt;&#40; $self-&gt;get &#41;;
       }
       else {
+         my $name = $self-&gt;{failure}[1];
+         if&#40; defined $name and $catch_handlers{$name} &#41; {
+            return $catch_handlers{$name}-&gt;&#40; $self-&gt;failure &#41;;
+         }
          return $self unless $fail_code;
          return $fail_code-&gt;&#40; $self-&gt;failure &#41;;
       }
@@ -1112,6 +1144,59 @@
    return $self-&gt;_sequence&#40; $fail_code, CB_SEQ_ONFAIL|CB_RESULT &#41;;
 }
 
+=head2 catch
+
+   $future = $f1-&gt;catch&#40;
+      name =&gt; \&#38;code,
+      name =&gt; \&#38;code, ...
+   &#41;
+
+Returns a new sequencing C&lt;Future&gt; that behaves like an C&lt;else&gt; call which
+dispatches to a choice of several alternative handling functions depending on
+the kind of failure that occurred. If C&lt;$f1&gt; fails with a category name &#40;i.e.
+the second argument to the C&lt;fail&gt; call&#41; which exactly matches one of the
+string names given, then the corresponding code is invoked, being passed the
+same arguments as a plain C&lt;else&gt; call would take, and is expected to return a
+C&lt;Future&gt; in the same way.
+
+ $f2 = $code-&gt;&#40; $exception, $name, @other_details &#41;
+
+If C&lt;$f1&gt; does not fail, fails without a category name at all, or fails with a
+category name that does not match any given to the C&lt;catch&gt; method, then the
+returned sequence future immediately completes with the same result, and no
+block of code is invoked.
+
+If passed an odd-sized list, the final argument gives a function to invoke on
+failure if no other handler matches.
+
+   $future = $f1-&gt;catch&#40;
+      name =&gt; \&#38;code, ...
+      \&#38;fail_code,
+   &#41;
+
+This feature is currently still a work-in-progress. It currently can only cope
+with category names that are literal strings, which are all distinct. A later
+version may define other kinds of match &#40;e.g. regexp&#41;, may specify some sort
+of ordering on the arguments, or any of several other semantic extensions. For
+more detail on the ongoing design, see
+L&lt;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=103545">https://rt.cpan.org/Ticket/Display.html?id=103545</a></span>&gt;.
+
+=head2 then I&lt;&#40;multiple arguments&#41;&gt;
+
+   $future = $f1-&gt;then&#40; \&#38;done_code, @catch_list, \&#38;fail_code &#41;
+
+The C&lt;then&gt; method can be passed an even-sized list inbetween the
+C&lt;$done_code&gt; and the C&lt;$fail_code&gt;, with the same meaning as the C&lt;catch&gt;
+method.
+
+=cut
+
+sub catch
+{
+   my $self = shift;
+   return $self-&gt;then&#40; undef, @_ &#41;;
+}
+
 =head2 transform
 
    $future = $f1-&gt;transform&#40; %args &#41;

=== added file &#39;t/07catch.t&#39;
--- t/07catch.t	1970-01-01 00:00:00 +0000
+++ t/07catch.t	2015-07-28 18:40:43 +0000
@@ -0,0 +1,94 @@
+#!/usr/bin/perl
+
+use strict;
+use warnings;
+
+use Test::More;
+use Test::Refcount;
+
+use Future;
+
+# catch success
+{
+   my $f1 = Future-&gt;new;
+
+   my $fseq = $f1-&gt;catch&#40;
+      test =&gt; sub { die &#34;catch of successful Future should not be invoked&#34; },
+   &#41;;
+
+   ok&#40; defined $fseq, &#39;$fseq defined&#39; &#41;;
+   isa_ok&#40; $fseq, &#34;Future&#34;, &#39;$fseq&#39; &#41;;
+
+   is_oneref&#40; $fseq, &#39;$fseq has refcount 1 initially&#39; &#41;;
+
+   $f1-&gt;done&#40; results =&gt; &#34;here&#34; &#41;;
+
+   is_deeply&#40; [ $fseq-&gt;get ], [ results =&gt; &#34;here&#34; ], &#39;$fseq succeeds when $f1 succeeds&#39; &#41;;
+
+   undef $f1;
+   is_oneref&#40; $fseq, &#39;$fseq has refcount 1 before EOF&#39; &#41;;
+}
+
+# catch matching failure
+{
+   my $f1 = Future-&gt;new;
+
+   my $f2;
+   my $fseq = $f1-&gt;catch&#40;
+      test =&gt; sub {
+         is&#40; $_[0], &#34;f1 failure\n&#34;, &#39;catch block passed result of $f1&#39; &#41;;
+         return $f2 = Future-&gt;done;
+      },
+   &#41;;
+
+   ok&#40; defined $fseq, &#39;$fseq defined&#39; &#41;;
+   isa_ok&#40; $fseq, &#34;Future&#34;, &#39;$fseq&#39; &#41;;
+
+   is_oneref&#40; $fseq, &#39;$fseq has refcount 1 initially&#39; &#41;;
+
+   $f1-&gt;fail&#40; &#34;f1 failure\n&#34;, test =&gt; &#41;;
+
+   undef $f1;
+   is_oneref&#40; $fseq, &#39;$fseq has refcount 1 after $f1 fail and dropped&#39; &#41;;
+
+   ok&#40; defined $f2, &#39;$f2 now defined after $f1 fails&#39; &#41;;
+
+   ok&#40; $fseq-&gt;is_ready, &#39;$fseq is done after $f2 done&#39; &#41;;
+}
+
+# catch non-matching failure
+{
+   my $f1 = Future-&gt;new;
+
+   my $fseq = $f1-&gt;catch&#40;
+      test =&gt; sub { die &#34;catch of non-matching Failure should not be invoked&#34; },
+   &#41;;
+
+   $f1-&gt;fail&#40; &#34;f1 failure\n&#34;, different =&gt; &#41;;
+
+   ok&#40; $fseq-&gt;is_ready, &#39;$fseq is done after $f1 fail&#39; &#41;;
+   is&#40; scalar $fseq-&gt;failure, &#34;f1 failure\n&#34;, &#39;$fseq failure&#39; &#41;;
+}
+
+# catch default handler
+{
+   my $fseq = Future-&gt;fail&#40; &#34;failure&#34;, other =&gt; &#41;
+      -&gt;catch&#40;
+         test =&gt; sub { die &#34;&#39;test&#39; catch should not match&#34; },
+         sub { Future-&gt;done&#40; default =&gt; &#34;handler&#34; &#41; },
+      &#41;;
+
+   is_deeply&#40; [ $fseq-&gt;get ], [ default =&gt; &#34;handler&#34; ],
+      &#39;-&gt;catch accepts a default handler&#39; &#41;;
+}
+
+# catch via &#39;then&#39;
+{
+   is&#40; scalar &#40; Future-&gt;fail&#40; &#34;message&#34;, test =&gt; &#41;
+            -&gt;then&#40; sub { die &#34;then &#38;done should not be invoked&#34; },
+               test =&gt; sub { Future-&gt;done&#40; 1234 &#41; },
+               sub { die &#34;then &#38;fail should not be invoked&#34; } &#41;-&gt;get &#41;,
+      1234, &#39;catch semantics via -&gt;then&#39; &#41;;
+}
+
+done_testing;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1521333" href="/Public/Bug/Display.html?id=103545#txn-1521333">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;29&nbsp;07:53:04&nbsp;2015</span>
    <span class="description">jnareb [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jakub Narębski &lt;jnareb [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1521333/811429/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/811429">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 206b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Some &#40;if not all&#41; JavaScript libraries implementing promises also implement .catch&#40;function&#40;err&#41; { ... }&#41;, which I found via

<span class="clickylink"><a target="new" rel="nofollow" href="http://eddywashere.com/blog/switching-out-callbacks-with-promises-in-mongoose/">http://eddywashere.com/blog/switching-out-callbacks-with-promises-in-mongoose/</a></span>
 
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.404803</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
