<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #41457 for TAP-Formatter-HTML: Various Fixes &#40;XHTML, inline_js&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #41457 for TAP-Formatter-HTML: Various Fixes &#40;XHTML, inline_js&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/TAP-Formatter-HTML/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/TAP-Formatter-HTML/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/TAP-Formatter-HTML/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/TAP-Formatter-HTML/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/TAP-Formatter-HTML">TAP-Formatter-HTML CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">41457</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/TAP-Formatter-HTML/Active/">TAP-Formatter-HTML</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">steve [...] purkis.ca
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
hemingway [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-222224-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.08    </td>
  </tr>
  <tr id="CF-222225-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;05&nbsp;06:02:07&nbsp;2008</span>
    <span class="description">hemingway [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The attached patch resolves various issues:
 * it adds a force_inline_js function akin to the existing
force_inline_css function
 * it adds a strict DOCTYPE to the resulting html
 * under XHTML, id attributes are not allowed to be empty.  Those on the
&lt;tr class=&#34;test-run&#34; were empty.  resolved by commenting out the
attribute. This didn&#39;t seem to cause any issues &#40;all the tests pass&#41;.
 * Under TT, [% IF test.parse_errors %] tests true if parse_errors is an
empty array.  This has been replaced by [% IF tests.parse_errors.size &gt; 0 %]
 * fixed various other XHTML violations &#40;either by adding missing
elements or by adding non-breaking spaces&#41;
 * also fixed the s/incline_js/inline_js/ bug
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> TAP-Formatter-HTML-0.06.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ur TAP-Formatter-HTML-0.06-before/lib/TAP/Formatter/HTML/default_report.tt2 TAP-Formatter-HTML-0.06-after/lib/TAP/Formatter/HTML/default_report.tt2
--- TAP-Formatter-HTML-0.06-before/lib/TAP/Formatter/HTML/default_report.tt2	2008-08-26 15:58:14.000000000 +0100
+++ TAP-Formatter-HTML-0.06-after/lib/TAP/Formatter/HTML/default_report.tt2	2008-12-05 10:49:55.000000000 +0000
@@ -1,3 +1,5 @@
+&lt;!DOCTYPE html PUBLIC &#34;-//W3C//DTD XHTML 1.0 Strict//EN&#34; &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd</a></span>&#34;&gt;
+
 [%#
 TAP-Formatter-HTML: TT2 Template
 Copyright &#40;c&#41; 2008 Steve Purkis.  All rights reserved.
@@ -40,10 +42,12 @@
 		&lt;/div&gt;
 
 		&lt;div id=&#34;menu&#34;&gt;
+          &lt;ul&gt;
 			&lt;li&gt;
 				&lt;span id=&#34;show-all&#34;&gt;&lt;a href=&#34;#&#34; title=&#34;show all tests&#34;&gt;show all&lt;/a&gt;&lt;/span&gt;
 		    &lt;span id=&#34;show-failed&#34;&gt;&lt;a href=&#34;#&#34; title=&#34;show failed tests only&#34;&gt;show failed&lt;/a&gt;&lt;/span&gt;
 			&lt;/li&gt;
+          &lt;/ul&gt;
 		&lt;/div&gt;
 
 		&lt;div id=&#34;detail&#34;&gt;
@@ -60,7 +64,7 @@
 					[%- FOREACH test IN report.tests %]
 					&lt;tr class=&#34;test-run [% test.test_status -%]
 										 [%- IF test.severity %][% &#39; severity-&#39; _ test.severity %][% END -%]
-										 [%- IF test.todo_passed %] todo-passed[% END %]&#34; id=&#34;[% test.html_id %]&#34;&gt;
+										 [%- IF test.todo_passed %] todo-passed[% END %]&#34;&gt;&lt;!-- id=&#34;[% test.html_id %]&#34;&gt;--&gt;
 						&lt;td class=&#34;file c&#34;&gt;
 							&lt;a class=&#34;file&#34; href=&#34;#&#34; title=&#34;Test [% IF test.has_problems %]failed![% ELSE %]ok.[% END %]
 [% IF test.num_parse_errors %]	[% test.num_parse_errors %] parse error&#40;s&#41;!
@@ -84,7 +88,7 @@
 							[%- SET max_tests = test.tests_run IF test.tests_run AND test.tests_run &gt; max_tests %]
 							&lt;table class=&#34;TS&#34;&gt;[%# TS=Test Summary. Note: use a table to caulculate widths automatically %]
 								&lt;tr&gt;
-									[%- IF test.tests_run AND test.tests_run &gt; 0 -%]
+									[% IF test.tests_run AND test.tests_run &gt; 0 -%]
 										[%- SET current_test = 0 -%]
 									  [%- FOREACH result IN test.results -%]
 									  [%- IF result.is_test %]
@@ -107,7 +111,7 @@
 								&lt;/tr&gt;
 							&lt;/table&gt;
 							&lt;div class=&#34;test-detail&#34;&gt;
-								[%- IF test.parse_errors %]
+								[%- IF test.parse_errors.size &gt; 0 %]
 								&lt;ul class=&#34;parse-errors&#34;&gt;
 									[%- FOREACH e IN test.parse_errors %]
 									&lt;li&gt;Parse error: [% e %]&lt;/li&gt;
@@ -118,7 +122,7 @@
 									[%- FOREACH result IN test.results %]
 									&lt;li [% IF result.is_test %]id=&#34;[% result.html_id %]&#34; [% END -%]class=&#34;[% result.css_type -%]
 														 [%- IF result.is_test %][% &#39; &#39; _ result.short_test_status -%][%- END -%]
-														 [%- IF result.is_unplanned %] unp[% END -%]&#34;&gt;[% result.raw | html -%]
+														 [%- IF result.is_unplanned %] unp[% END -%]&#34;&gt;[% result.raw | html -%]&#38;nbsp;
 										[%- IF result.is_unplanned %]&lt;em&gt; &#40;unplanned!&#41;&lt;/em&gt;[% END -%]
 										[%- IF result.todo_passed %]&lt;em&gt; &#40;unexpectedly succeeded!&#41;&lt;/em&gt;[% END %]&lt;/li&gt;
 									[%- END -%]
diff -ur TAP-Formatter-HTML-0.06-before/lib/TAP/Formatter/HTML.pm TAP-Formatter-HTML-0.06-after/lib/TAP/Formatter/HTML.pm
--- TAP-Formatter-HTML-0.06-before/lib/TAP/Formatter/HTML.pm	2008-08-26 15:58:14.000000000 +0100
+++ TAP-Formatter-HTML-0.06-after/lib/TAP/Formatter/HTML.pm	2008-12-05 10:49:40.000000000 +0000
@@ -30,7 +30,8 @@
  # you can use your own customized templates too:
  $fmt-&gt;template&#40;&#39;custom.tt2&#39;&#41;
      -&gt;template_processor&#40; Template-&gt;new &#41;
-     -&gt;force_inline_css&#40;0&#41;;
+     -&gt;force_inline_css&#40;0&#41;
+     -&gt;force_inline_js&#40;0&#41;;
 
 =cut
 
@@ -53,7 +54,7 @@
 use base qw&#40; TAP::Base &#41;;
 use accessors qw&#40; verbosity stdout escape_output tests session_class sessions
 		  template_processor template html html_id_iterator minify
-		  css_uris js_uris inline_css inline_js abs_file_paths force_inline_css &#41;;
+		  css_uris js_uris inline_css inline_js abs_file_paths force_inline_css force_inline_js &#41;;
 
 use constant default_session_class =&gt; &#39;TAP::Formatter::HTML::Session&#39;;
 use constant default_template      =&gt; &#39;TAP/Formatter/HTML/default_report.tt2&#39;;
@@ -98,6 +99,7 @@
          -&gt;abs_file_paths&#40; 1 &#41;
          -&gt;abs_file_paths&#40; 1 &#41;
          -&gt;force_inline_css&#40; 1 &#41;
+         -&gt;force_inline_js&#40; 1 &#41;
          -&gt;session_class&#40; $self-&gt;default_session_class &#41;
          -&gt;template_processor&#40; $self-&gt;default_template_processor &#41;
          -&gt;template&#40; $self-&gt;default_template &#41;
@@ -198,12 +200,13 @@
 
     $self-&gt;check_uris;
     $self-&gt;slurp_css if $self-&gt;force_inline_css;
+    $self-&gt;slurp_js if $self-&gt;force_inline_js;
 
     my $params = {
 		  report =&gt; $r,
 		  js_uris  =&gt; $self-&gt;js_uris,
 		  css_uris =&gt; $self-&gt;css_uris,
-		  incline_js  =&gt; $self-&gt;inline_js,
+		  inline_js  =&gt; $self-&gt;inline_js,
 		  inline_css =&gt; $self-&gt;inline_css,
 		  formatter =&gt; { class =&gt; ref&#40; $self &#41;,
 				 version =&gt; $self-&gt;VERSION },
@@ -364,6 +367,34 @@
     $self-&gt;inline_css&#40; $inline_css &#41;;
 }
 
+sub slurp_js {
+    my &#40;$self&#41; = shift;
+    $self-&gt;info&#40;&#34;slurping js files inline&#34;&#41;;
+
+    my $inline_js = $self-&gt;inline_js || &#39;&#39;;
+    foreach my $uri &#40;@{ $self-&gt;js_uris }&#41; {
+	my $scheme = $uri-&gt;scheme;
+	if &#40;$scheme &#38;&#38; $scheme eq &#39;file&#39;&#41; {
+	    my $path = $uri-&gt;path;
+	    if &#40;-e $path&#41; {
+		if &#40;open my $fh, $path&#41; {
+		    local $/ = undef;
+		    $inline_js .= &lt;$fh&gt;;
+		} else {
+		    $self-&gt;log&#40;&#34;Warning: couldn&#39;t open $path: $!&#34;&#41;;
+		}
+	    } else {
+		$self-&gt;log&#40;&#34;Warning: couldn&#39;t read $path: file does not exist!&#34;&#41;;
+	    }
+	} else {
+	    $self-&gt;log&#40;&#34;Warning: can&#39;t include $uri inline: not a file uri&#34;&#41;;
+	}
+    }
+
+    $self-&gt;inline_js&#40; $inline_js &#41;;
+}
+
+
 sub log {
     my $self = shift;
     push @_, &#34;\n&#34; unless grep {/\n/} @_;
@@ -583,6 +614,13 @@
 sending the output around - that way you don&#39;t have to send a CSS file too.
 Defaults to I&lt;1&gt;.
 
+=head3 force_inline_js&#40; [ $boolean ] &#41;
+
+If set, the formatter will attempt to slurp in any I&lt;file&gt; javascript URI&#39;s listed in
+L&lt;/js_uris&gt;, and append them to L&lt;/inline_js&gt;.  This is handy if you&#39;ll be
+sending the output around - that way you don&#39;t have to send javascript files too.
+Defaults to I&lt;1&gt;.
+
 =head2 $html = $fmt-&gt;summary&#40; $aggregator &#41;
 
 C&lt;summary&gt; produces a summary report after all tests are run.  C&lt;$aggregator&gt;
@@ -597,7 +635,7 @@
   report      =&gt; %test_report
   js_uris     =&gt; @js_uris
   css_uris    =&gt; @js_uris
-  incline_js  =&gt; $inline_js
+  inline_js  =&gt; $inline_js
   inline_css  =&gt; $inline_css
   formatter   =&gt; %formatter_info
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;05&nbsp;06:10:12&nbsp;2008</span>
    <span class="description">hemingway [...] cpan.org -  Subject changed from &#40;no value&#41; to &#39;Various Fixes &#40;XHTML, inline_js&#41;&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;02&nbsp;18:08:11&nbsp;2009</span>
    <span class="description">steve [...] purkis.ca -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for this report &#38; fixes.
I&#39;ll hopefully get this in for 0.08; unfortunately I didn&#39;t get the report until now :-/
The inline_js fix is in for 0.07 though.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;02&nbsp;18:08:12&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;02&nbsp;17:15:08&nbsp;2009</span>
    <span class="description">steve [...] purkis.ca -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Neil,

I&#39;ve not managed to get most of your fixes in, unfortunately.  As it stands, 0.08 was waiting one 
the back-burner for several months :-/.  I figured it was best to release the fixes so far.

I&#39;d like to get these in to 0.09 though.  If you&#39;re available to help, I can put the source on github 
and give you a commit bit.

Cheers,
-Steve
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;21&nbsp;02:24:49&nbsp;2009</span>
    <span class="description">panu.ervamaa [...] frantic.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve applied the same &#40;still missing&#41; patches to the 0.08:

- includes also the patch from issue #49621
- small changes to the top-left corner menu &#40;default_report.css&#41; to
render it corretly with Firefox 3 &#40;Linux&#41;
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ur TAP-Formatter-HTML-0.08-before/lib/TAP/Formatter/HTML/default_report.css TAP-Formatter-HTML-0.08-after/lib/TAP/Formatter/HTML/default_report.css
--- TAP-Formatter-HTML-0.08-before/lib/TAP/Formatter/HTML/default_report.css	2009-09-02 23:48:21.000000000 +0300
+++ TAP-Formatter-HTML-0.08-after/lib/TAP/Formatter/HTML/default_report.css	2009-10-21 08:48:54.000000000 +0300
@@ -13,13 +13,16 @@
 	left: 8px;
 	top: 8px;
 	padding: 2px;
-	width: 100px;
-	height: 26px;
 	font-size: small;
 	background-color: #eeffcc;
 	opacity: 0.5;
 }
 
+#menu ul {
+        margin: 0px;
+        padding: 5px;
+}
+
 #menu li {
 	text-decoration: none;
 	list-style: none;
Only in TAP-Formatter-HTML-0.08-after/lib/TAP/Formatter/HTML: default_report.css~
diff -ur TAP-Formatter-HTML-0.08-before/lib/TAP/Formatter/HTML/default_report.js TAP-Formatter-HTML-0.08-after/lib/TAP/Formatter/HTML/default_report.js
--- TAP-Formatter-HTML-0.08-before/lib/TAP/Formatter/HTML/default_report.js	2009-09-02 23:48:21.000000000 +0300
+++ TAP-Formatter-HTML-0.08-after/lib/TAP/Formatter/HTML/default_report.js	2009-10-21 09:02:26.000000000 +0300
@@ -32,7 +32,7 @@
 
 		// highlight a particular test?
 		var testId = $&#40;this&#41;.attr&#40;&#34;href&#34;&#41;;
-		if &#40;!testId&#41; {
+		if &#40;testId&#41; {
 		    var $testElem = $detail.find&#40;testId&#41;;
 		    $testElem.show&#40;&#41;.scrollTo&#40;1000&#41;;
 		    var bgColor = $testElem.css&#40;&#34;background-color&#34;&#41;;
diff -ur TAP-Formatter-HTML-0.08-before/lib/TAP/Formatter/HTML/default_report.tt2 TAP-Formatter-HTML-0.08-after/lib/TAP/Formatter/HTML/default_report.tt2
--- TAP-Formatter-HTML-0.08-before/lib/TAP/Formatter/HTML/default_report.tt2	2009-09-02 23:48:21.000000000 +0300
+++ TAP-Formatter-HTML-0.08-after/lib/TAP/Formatter/HTML/default_report.tt2	2009-10-20 15:24:31.000000000 +0300
@@ -1,3 +1,5 @@
+&lt;!DOCTYPE html PUBLIC &#34;-//W3C//DTD XHTML 1.0 Strict//EN&#34; &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd</a></span>&#34;&gt;
+
 [%#
 TAP-Formatter-HTML: TT2 Template
 Copyright &#40;c&#41; 2008 Steve Purkis.  All rights reserved.
@@ -40,10 +42,12 @@
 		&lt;/div&gt;
 
 		&lt;div id=&#34;menu&#34;&gt;
+          &lt;ul&gt;
 			&lt;li&gt;
 				&lt;span id=&#34;show-all&#34;&gt;&lt;a href=&#34;#&#34; title=&#34;show all tests&#34;&gt;show all&lt;/a&gt;&lt;/span&gt;
 		    &lt;span id=&#34;show-failed&#34;&gt;&lt;a href=&#34;#&#34; title=&#34;show failed tests only&#34;&gt;show failed&lt;/a&gt;&lt;/span&gt;
 			&lt;/li&gt;
+          &lt;/ul&gt;
 		&lt;/div&gt;
 
 		&lt;div id=&#34;detail&#34;&gt;
@@ -60,7 +64,7 @@
 					[%- FOREACH test IN report.tests %]
 					&lt;tr class=&#34;test-run [% test.test_status -%]
 										 [%- IF test.severity %][% &#39; severity-&#39; _ test.severity %][% END -%]
-										 [%- IF test.todo_passed %] todo-passed[% END %]&#34; id=&#34;[% test.html_id %]&#34;&gt;
+										 [%- IF test.todo_passed %] todo-passed[% END %]&#34;&gt;&lt;!-- id=&#34;[% test.html_id %]&#34;&gt;--&gt;
 						&lt;td class=&#34;file c&#34;&gt;
 							&lt;a class=&#34;file&#34; href=&#34;#&#34; title=&#34;Test [% IF test.has_problems %]failed![% ELSE %]ok.[% END %]
 [% IF test.num_parse_errors %]	[% test.num_parse_errors %] parse error&#40;s&#41;!
@@ -84,7 +88,7 @@
 							[%- SET max_tests = test.tests_run IF test.tests_run AND test.tests_run &gt; max_tests %]
 							&lt;table class=&#34;TS&#34;&gt;[%# TS=Test Summary. Note: use a table to caulculate widths automatically %]
 								&lt;tr&gt;
-									[%- IF test.tests_run AND test.tests_run &gt; 0 -%]
+									[% IF test.tests_run AND test.tests_run &gt; 0 -%]
 										[%- SET current_test = 0 -%]
 									  [%- FOREACH result IN test.results -%]
 									  [%- IF result.is_test %]
@@ -107,7 +111,7 @@
 								&lt;/tr&gt;
 							&lt;/table&gt;
 							&lt;div class=&#34;test-detail&#34;&gt;
-								[%- IF test.parse_errors %]
+								[%- IF test.parse_errors.size &gt; 0 %]
 								&lt;ul class=&#34;parse-errors&#34;&gt;
 									[%- FOREACH e IN test.parse_errors %]
 									&lt;li&gt;Parse error: [% e %]&lt;/li&gt;
@@ -118,7 +122,7 @@
 									[%- FOREACH result IN test.results %]
 									&lt;li [% IF result.is_test %]id=&#34;[% result.html_id %]&#34; [% END -%]class=&#34;[% result.css_type -%]
 														 [%- IF result.is_test %][% &#39; &#39; _ result.short_test_status -%][%- END -%]
-														 [%- IF result.is_unplanned %] unp[% END -%]&#34;&gt;[% result.raw | html -%]
+														 [%- IF result.is_unplanned %] unp[% END -%]&#34;&gt;[% result.raw | html -%]&#38;nbsp;
 										[%- IF result.is_unplanned %]&lt;em&gt; &#40;unplanned!&#41;&lt;/em&gt;[% END -%]
 										[%- IF result.todo_passed %]&lt;em&gt; &#40;unexpectedly succeeded!&#41;&lt;/em&gt;[% END %]&lt;/li&gt;
 									[%- END -%]
diff -ur TAP-Formatter-HTML-0.08-before/lib/TAP/Formatter/HTML.pm TAP-Formatter-HTML-0.08-after/lib/TAP/Formatter/HTML.pm
--- TAP-Formatter-HTML-0.08-before/lib/TAP/Formatter/HTML.pm	2009-09-02 23:48:21.000000000 +0300
+++ TAP-Formatter-HTML-0.08-after/lib/TAP/Formatter/HTML.pm	2009-10-20 15:40:43.000000000 +0300
@@ -37,7 +37,8 @@
  # you can use your own customized templates too:
  $fmt-&gt;template&#40;&#39;custom.tt2&#39;&#41;
      -&gt;template_processor&#40; Template-&gt;new &#41;
-     -&gt;force_inline_css&#40;0&#41;;
+     -&gt;force_inline_css&#40;0&#41;
+     -&gt;force_inline_js&#40;0&#41;;
 
 =cut
 
@@ -62,7 +63,7 @@
 use base qw&#40; TAP::Base &#41;;
 use accessors qw&#40; verbosity stdout output_fh escape_output tests session_class sessions
 		  template_processor template html html_id_iterator minify
-		  css_uris js_uris inline_css inline_js abs_file_paths force_inline_css &#41;;
+		  css_uris js_uris inline_css inline_js abs_file_paths force_inline_css force_inline_js &#41;;
 
 use constant default_session_class =&gt; &#39;TAP::Formatter::HTML::Session&#39;;
 use constant default_template      =&gt; &#39;TAP/Formatter/HTML/default_report.tt2&#39;;
@@ -113,6 +114,7 @@
          -&gt;abs_file_paths&#40; 1 &#41;
          -&gt;abs_file_paths&#40; 1 &#41;
          -&gt;force_inline_css&#40; 1 &#41;
+         -&gt;force_inline_js&#40; 1 &#41;
          -&gt;session_class&#40; $self-&gt;default_session_class &#41;
          -&gt;template_processor&#40; $self-&gt;default_template_processor &#41;
          -&gt;template&#40; $self-&gt;default_template &#41;
@@ -146,6 +148,11 @@
     if &#40;defined&#40; $force &#41;&#41; {
 	$self-&gt;force_inline_css&#40; $force &#41;;
     }
+    
+    $force = $ENV{TAP_FORMATTER_HTML_FORCE_INLINE_JS};
+    if &#40;defined&#40; $force &#41;&#41; {
+	$self-&gt;force_inline_js&#40; $force &#41;;
+    }
 
     if &#40;my $uris = $ENV{TAP_FORMATTER_HTML_CSS_URIS}&#41; {
 	my $list = [ split&#40; &#39;:&#39;, $uris &#41; ];
@@ -259,6 +266,7 @@
 
     $self-&gt;check_uris;
     $self-&gt;slurp_css if $self-&gt;force_inline_css;
+    $self-&gt;slurp_js if $self-&gt;force_inline_js;
 
     my $params = {
 		  report =&gt; $r,
@@ -434,6 +442,34 @@
     $self-&gt;inline_css&#40; $inline_css &#41;;
 }
 
+sub slurp_js {
+    my &#40;$self&#41; = shift;
+    $self-&gt;info&#40;&#34;slurping js files inline&#34;&#41;;
+
+    my $inline_js = $self-&gt;inline_js || &#39;&#39;;
+    foreach my $uri &#40;@{ $self-&gt;js_uris }&#41; {
+	my $scheme = $uri-&gt;scheme;
+	if &#40;$scheme &#38;&#38; $scheme eq &#39;file&#39;&#41; {
+	    my $path = $uri-&gt;path;
+	    if &#40;-e $path&#41; {
+		if &#40;open my $fh, $path&#41; {
+		    local $/ = undef;
+		    $inline_js .= &lt;$fh&gt;;
+		} else {
+		    $self-&gt;log&#40;&#34;Warning: couldn&#39;t open $path: $!&#34;&#41;;
+		}
+	    } else {
+		$self-&gt;log&#40;&#34;Warning: couldn&#39;t read $path: file does not exist!&#34;&#41;;
+	    }
+	} else {
+	    $self-&gt;log&#40;&#34;Warning: can&#39;t include $uri inline: not a file uri&#34;&#41;;
+	}
+    }
+
+    $self-&gt;inline_js&#40; $inline_js &#41;;
+}
+
+
 sub log {
     my $self = shift;
     push @_, &#34;\n&#34; unless grep {/\n/} @_;
@@ -729,6 +765,16 @@
 You can set this with the C&lt;TAP_FORMATTER_HTML_FORCE_INLINE_CSS=0|1&gt; environment
 variable.
 
+=head3 force_inline_js&#40; [ $boolean ] &#41;
+
+If set, the formatter will attempt to slurp in any I&lt;file&gt; javascript URI&#39;s listed in
+L&lt;/js_uris&gt;, and append them to L&lt;/inline_js&gt;.  This is handy if you&#39;ll be
+sending the output around - that way you don&#39;t have to send javascript files too.
+Defaults to I&lt;1&gt;.
+
+You can set this with the C&lt;TAP_FORMATTER_HTML_FORCE_INLINE_JS=0|1&gt; environment
+variable.
+
 =head2 API METHODS
 
 =head3 summary
@@ -763,6 +809,7 @@
 
   TAP_FORMATTER_HTML_OUTFILE=/path/to/file
   TAP_FORMATTER_HTML_FORCE_INLINE_CSS=0|1
+  TAP_FORMATTER_HTML_FORCE_INLINE_JS=0|1
   TAP_FORMATTER_HTML_CSS_URIS=/path/to.css:/another/path.css
   TAP_FORMATTER_HTML_JS_URIS=/path/to.js:/another/path.js
   TAP_FORMATTER_HTML_TEMPLATE=/path/to.tt
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;21&nbsp;04:46:52&nbsp;2009</span>
    <span class="description">panu.ervamaa [...] frantic.com -  Broken in 0.08 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;21&nbsp;04:46:52&nbsp;2009</span>
    <span class="description">panu.ervamaa [...] frantic.com -  Broken in 0.06 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;06&nbsp;17:06:53&nbsp;2009</span>
    <span class="description">steve [...] purkis.ca -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">A quick update - I&#39;ve tried applying this patch and found a few problems:

1. tests break: t/selenium_basic.t &#38; t/04_really_quiet.t
2. having jquery as inline js doesn&#39;t work in firefox 3 on my mac, you get weird behaviour like 
divs rolling back up right after they&#39;ve rolled down.

I&#39;ll investigate when I&#39;ve got some more time.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;20&nbsp;15:54:47&nbsp;2010</span>
    <span class="description">steve [...] purkis.ca -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;20&nbsp;15:57:16&nbsp;2010</span>
    <span class="description">steve [...] purkis.ca -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Dec 06 17:06:53 2009, SPURKIS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; A quick update - I&#39;ve tried applying this patch and found a few
&gt; problems:
&gt; 
&gt; 1. tests break: t/selenium_basic.t &#38; t/04_really_quiet.t
&gt; 2. having jquery as inline js doesn&#39;t work in firefox 3 on my mac, you
&gt; get weird behaviour like
&gt; divs rolling back up right after they&#39;ve rolled down.
&gt; 
&gt; I&#39;ll investigate when I&#39;ve got some more time.
</div>
I&#39;ve applied this patch and hacked about to get things working.  This will be fixed in the next 
release which I&#39;m just working on it now.  Should be on CPAN later this week.

Note that force_inline_js will be off by default, as slurping in jquery causes errors.  

Thanks again,
-Steve
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;21&nbsp;07:53:06&nbsp;2010</span>
    <span class="description">steve [...] purkis.ca -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">fixed in 0.09.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;21&nbsp;07:53:08&nbsp;2010</span>
    <span class="description">steve [...] purkis.ca -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
