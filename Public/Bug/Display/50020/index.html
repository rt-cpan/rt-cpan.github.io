<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #50020 for Win32-Daemon: Incompatibility with fork&#40;&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #50020 for Win32-Daemon: Incompatibility with fork&#40;&#41;</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Win32-Daemon">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Win32-Daemon">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Win32-Daemon">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Win32-Daemon">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Win32-Daemon">Win32-Daemon CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">50020</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Win32-Daemon">Win32-Daemon</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dolmen [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
dave [...] roth.net

<br />
jand [...] ActiveState.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-35482-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-35483-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
20100921    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




Daemon.pm<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/694099/357750/Daemon.pm">
Fri Nov 20 11:55:20 2009 (38.7k) by dolmen [...] cpan.org
</a>
</font></li>
</ul>


fork-bug.inf<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/668899/343667/fork-bug.inf">
Fri Sep 25 12:14:53 2009 (2.8k) by dolmen [...] cpan.org
</a>
</font></li>
</ul>


fork-bug.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/668899/343670/fork-bug.pl">
Fri Sep 25 12:14:53 2009 (1.7k) by dolmen [...] cpan.org
</a>
</font></li>
</ul>


PerlService.inf<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/668863/343634/PerlService.inf">
Fri Sep 25 11:19:10 2009 (2.8k) by dolmen [...] cpan.org
</a>
</font></li>
</ul>


test-PCDW.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/668863/343631/test-PCDW.pl">
Fri Sep 25 11:19:10 2009 (1.1k) by dolmen [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=50020">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-668863" href="/Public/Bug/Display.html?id=50020#txn-668863">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;25&nbsp;11:19:10&nbsp;2009</span>
    <span class="description">dolmen [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Incompatibility with fork&#40;&#41;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/668863/343628/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/343628">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 959b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">If the service uses &#39;fork&#40;&#41;&#39; to start a child process &#40;implemented as a
thread on Win32&#41;, when the child process ends the service change state
to SERVICE_STOP_PENDING and shutdown.

The consequence is that we can not implement a cron-like service.




I&#39;m attaching a test case:
- PerlService.inf is the script to install the service &#40;right click,
&#34;Install&#34; from the Windows Explorer&#41; and uninstall &#40;use the Control
Panel to uninstall &#34;Perl service demo&#34;&#41;.
- test-PCDW.pl: the daemon

Here is the output:
Fri Sep 25 17:05:55 2009 Begin
Fri Sep 25 17:05:56 2009 2
Fri Sep 25 17:05:57 2009 4
Fri Sep 25 17:05:58 2009 4
Fri Sep 25 17:05:59 2009 4
Fri Sep 25 17:06:00 2009 4
Child start
Fri Sep 25 17:06:01 2009 4
Fri Sep 25 17:06:02 2009 4
Fri Sep 25 17:06:03 2009 4
Fri Sep 25 17:06:04 2009 4
Fri Sep 25 17:06:05 2009 4
Child end
Fri Sep 25 17:06:06 2009 3
Fri Sep 25 17:06:07 2009 1
Fri Sep 25 17:06:07 2009 End


-- 
Olivier Mengué - <span class="clickylink"><a target="new" rel="nofollow" href="http://o.mengue.free.fr/">http://o.mengue.free.fr/</a></span>
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test-PCDW.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/668863/343631/test-PCDW.pl">Download test-PCDW.pl</a><br />
<span class="downloadcontenttype">text/x-perl 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
use utf8;   # vim:set sts=4 sw=4 et:
use strict;
use warnings;

use POE qw&#40;Component::Daemon::Win32&#41;;


my $log_file = @ARGV ? $ARGV[0] : &#34;$0.log&#34;;

open&#40;my $log, &#39;&gt;:utf8&#39;, $log_file&#41;;
select&#40; &#40;select&#40;$log&#41;, $| = 1 &#41;[0] &#41;; # Autoflush
close&#40;STDOUT&#41;;
close&#40;STDERR&#41;;
*STDOUT = *STDERR = $log;

my $count = 0;

sub service_state
{
    my &#40;$state, $message&#41; = @_[ARG0, ARG1];

    print scalar localtime&#40;&#41;, &#39; &#39;, $state, &#34;\n&#34;;

    # service start pending
    if &#40;$state == SERVICE_START_PENDING&#41; {
      # do some sort of initialization here
    }
    if &#40;$state == SERVICE_RUNNING&#41; {
        $count++;
        if &#40;$count == 4&#41; {
            my $pid = fork&#40;&#41;;
            unless &#40;$pid&#41; {
                print &#34;Child start\n&#34;;
                sleep 5;
                print &#34;Child end\n&#34;;
                exit 0;
            }
        }
    }
    $poe_kernel-&gt;yield &#40;&#39;next_state&#39;&#41;;
}


print scalar localtime&#40;&#41;, &#34; Begin\n&#34;;

POE::Component::Daemon::Win32-&gt;spawn&#40;
    Alias =&gt; &#39;svc&#39;,
    Callback =&gt; \&#38;service_state,
    PollInterval =&gt; 1,
&#41;;

POE::Kernel-&gt;run;
print scalar localtime&#40;&#41;, &#34; End\n&#34;;
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> PerlService.inf</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/668863/343634/PerlService.inf">Download PerlService.inf</a><br />
<span class="downloadcontenttype">application/octet-stream 2.8k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-668866" href="/Public/Bug/Display.html?id=50020#txn-668866">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;25&nbsp;11:22:55&nbsp;2009</span>
    <span class="description">dolmen [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/668866/343637/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/343637">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 175b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The problem may be in the Win32::Daemon implementation

Also, POE::Wheel::Run::Win32 uses fork&#40;&#41; internally, so it is affected.

-- 
Olivier Mengué - <span class="clickylink"><a target="new" rel="nofollow" href="http://o.mengue.free.fr/">http://o.mengue.free.fr/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-668868" href="/Public/Bug/Display.html?id=50020#txn-668868">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;25&nbsp;11:22:56&nbsp;2009</span>
    <span class="description">dolmen [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-668899" href="/Public/Bug/Display.html?id=50020#txn-668899">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;25&nbsp;12:14:53&nbsp;2009</span>
    <span class="description">dolmen [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Win32::Daemon incompatible with fork&#40;&#41;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/668899/343664/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/343664">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 680b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Le Ven. Sep. 25 11:22:55 2009, DOLMEN a écrit :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The problem may be in the Win32::Daemon implementation
</div>
I have been able to reproduce the bug with the bare Win32::Daemon
20080324 on ActivePerl 5.10 Build 1003.

Test case is attached.

Here is the output:
Fri Sep 25 18:11:01 2009 0
Fri Sep 25 18:11:02 2009 2
Fri Sep 25 18:11:02 2009 4
Fri Sep 25 18:11:03 2009 4
Fri Sep 25 18:11:04 2009 4
Fri Sep 25 18:11:05 2009 4
Fri Sep 25 18:11:05 2009 4
Child start
Fri Sep 25 18:11:06 2009 4
Fri Sep 25 18:11:07 2009 4
Fri Sep 25 18:11:08 2009 4
Fri Sep 25 18:11:09 2009 4
Child end
Fri Sep 25 18:11:10 2009 4
Fri Sep 25 18:11:11 2009 3


-- 
Olivier Mengué - <span class="clickylink"><a target="new" rel="nofollow" href="http://o.mengue.free.fr/">http://o.mengue.free.fr/</a></span>
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/668899/343667/fork-bug.inf">Download fork-bug.inf</a><br />
<span class="downloadcontenttype">application/octet-stream 2.8k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/668899/343670/fork-bug.pl">Download fork-bug.pl</a><br />
<span class="downloadcontenttype">text/x-perl 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">use vars qw&#40; $VERSION &#41;;
use Win32::Daemon;


my $log_file = @ARGV ? $ARGV[0] : &#34;$0.log&#34;;

open&#40;my $log, &#39;&gt;&#39;, $log_file&#41;;
select&#40; &#40;select&#40;$log&#41;, $| = 1 &#41;[0] &#41;; # Autoflush
close&#40;STDOUT&#41;;
close&#40;STDERR&#41;;
*STDOUT = *STDERR = $log;

my $count = 0;

# Start the service...
Win32::Daemon::StartService&#40;&#41; or die &#34;StartService failure!&#34;;

my $PrevState = SERVICE_STARTING;
while&#40; SERVICE_STOPPED != &#40; $State = Win32::Daemon::State&#40;&#41; &#41; &#41;
{
    print scalar localtime&#40;&#41;, &#39; &#39;, $State, &#34;\n&#34;;
    if&#40; SERVICE_START_PENDING == $State &#41; {
        # Initialization code
        Win32::Daemon::State&#40; SERVICE_RUNNING &#41;;
        $PrevState = SERVICE_RUNNING;
    } elsif&#40; SERVICE_PAUSE_PENDING == $State &#41; {
        # &#34;Pausing...&#34;;
        Win32::Daemon::State&#40; SERVICE_PAUSED &#41;;
        $PrevState = SERVICE_PAUSED;
	next;
    } elsif&#40; SERVICE_CONTINUE_PENDING == $State &#41; {
        # &#34;Resuming...&#34;;
        Win32::Daemon::State&#40; SERVICE_RUNNING &#41;;
        $PrevState = SERVICE_RUNNING;
	next;
    } elsif&#40; SERVICE_STOP_PENDING == $State &#41; {
        # &#34;Stopping...&#34;;
        Win32::Daemon::State&#40; SERVICE_STOPPED &#41;;
        $PrevState = SERVICE_STOPPED;
	next;
    } elsif&#40; SERVICE_RUNNING == $State &#41; {
        # The service is running as normal...
        $PrevState = SERVICE_RUNNING;

        $count++;
        if &#40;$count == 4&#41; {
            my $pid = fork&#40;&#41;;
            unless &#40;$pid&#41; {
                print &#34;Child start\n&#34;;
                sleep 5;
                print &#34;Child end\n&#34;;
                exit 0;
            }
        } else {
	    sleep&#40;1&#41;;
	}
    } else {
        # We have some unknown state...
        # reset it back to what we last knew the state to be...
        Win32::Daemon::State&#40; $PrevState &#41;;
	sleep&#40; 1 &#41;;
    }
}

Win32::Daemon::StopService&#40;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-694091" href="/Public/Bug/Display.html?id=50020#txn-694091">#</a>      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;20&nbsp;11:39:04&nbsp;2009</span>
    <span class="description">dolmen [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/694091/357738/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/357738">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 155b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The problem lies probably in the END {} block of Daemon.pm: this END {}
block is run in the child process and so sends the state change to the
main thread.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-694099" href="/Public/Bug/Display.html?id=50020#txn-694099">#</a>      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;20&nbsp;11:55:20&nbsp;2009</span>
    <span class="description">dolmen [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/694099/357747/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/357747">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 111b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here is my own patched version of Daemon.pm that fixes the bug.

-- 
Olivier Mengué - <span class="clickylink"><a target="new" rel="nofollow" href="http://o.mengue.free.fr/">http://o.mengue.free.fr/</a></span>
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/694099/357750/Daemon.pm">Download Daemon.pm</a><br />
<span class="downloadcontenttype">text/x-perl 38.7k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-694101" href="/Public/Bug/Display.html?id=50020#txn-694101">#</a>      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;20&nbsp;11:59:01&nbsp;2009</span>
    <span class="description">dolmen [...] cpan.org -  Cc dave@roth.net added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-694102" href="/Public/Bug/Display.html?id=50020#txn-694102">#</a>      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;20&nbsp;11:59:01&nbsp;2009</span>
    <span class="description">dolmen [...] cpan.org -  Cc jand@ActiveState.com added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-742784" href="/Public/Bug/Display.html?id=50020#txn-742784">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;04&nbsp;18:44:28&nbsp;2010</span>
    <span class="description">goneri [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/742784/384008/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/384008">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 805b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

This change in Olivier patch is enough to create an endless look with my
Strawberry Perl:
-bootstrap $Package;^M
+bootstrap&#40;__PACKAGE__&#41;;^M

AFAIR I understand, instead of reading the &#34;Win32::Daemon&#34; string,
bootstrap&#40;&#41; try to access Win32::Daemon namespace and so, call Daemon.pm
and call again bootstrap&#40;&#41;.


Regarding this change:
-    Win32::Daemon::StopService&#40;&#41;;^M
+    # Stop the service only if we are in the main thread &#40;not in a
forked process&#41;^M
+    Win32::Daemon::StopService&#40;&#41; if $$ &gt; 0;^M

perlvar says:
       $$      The process number of the Perl running this script.  You
should consider this variable read-only, although it will be altered
across fork&#40;&#41; calls.  &#40;Mnemonic: same as shells.&#41;

I don&#39;t understand why $$ should be 0 in the sub-process.

Regards

    Gonéri Le Bouder
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-742795" href="/Public/Bug/Display.html?id=50020#txn-742795">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;04&nbsp;19:01:46&nbsp;2010</span>
    <span class="description">jand [...] ActiveState.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &lt;dave [...] roth.net&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #50020] Incompatibility with fork&#40;&#41; </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 4 Mar 2010 15:59:51 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-POE-Component-Daemon-Win32 [...] rt.cpan.org&gt;, &lt;dolmen [...] cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Jan Dubois&#34; &lt;jand [...] activestate.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/742795/384016/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/384016">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, 04 Mar 2010, Gonéri LE BOUDER via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=50020">https://rt.cpan.org/Ticket/Display.html?id=50020</a></span> &gt;
&gt; 
&gt; This change in Olivier patch is enough to create an endless look with my
&gt; Strawberry Perl:
&gt; -bootstrap $Package;
&gt; +bootstrap&#40;__PACKAGE__&#41;;
&gt; 
&gt; AFAIR I understand, instead of reading the &#34;Win32::Daemon&#34; string,
&gt; bootstrap&#40;&#41; try to access Win32::Daemon namespace and so, call Daemon.pm
&gt; and call again bootstrap&#40;&#41;.
</div>
That change should not make any difference; __PACKAGE__ should just be
expanded to &#34;Win32::Daemon&#34; at compile time.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Regarding this change:
&gt; -    Win32::Daemon::StopService&#40;&#41;;^M
&gt; +    # Stop the service only if we are in the main thread &#40;not in a
&gt; forked process&#41;^M
&gt; +    Win32::Daemon::StopService&#40;&#41; if $$ &gt; 0;^M
&gt; 
&gt; perlvar says:
&gt;        $$      The process number of the Perl running this script.  You
&gt; should consider this variable read-only, although it will be altered
&gt; across fork&#40;&#41; calls.  &#40;Mnemonic: same as shells.&#41;
&gt; 
&gt; I don&#39;t understand why $$ should be 0 in the sub-process.
</div>
$$ will be less than 0 in the child-process &#40;which is just a pseudo-process
simulated by a thread on Windows&#41;.  This is only true for Perl on Windows,
but Win32::Daemon only works on Windows anyways, so that is not an issue.

Cheers,
-Jan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-745104" href="/Public/Bug/Display.html?id=50020#txn-745104">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;09&nbsp;21:29:50&nbsp;2010</span>
    <span class="description">dolmen [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> libwin32 [...] perl.org, jand [...] activestate.com, dave [...] roth.net</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/745104/385261/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/385261">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The better place for this discussion is the libwin32 mailing list.

Jan, as it seems you now have reviewed this patch, could you commit it
to the libwin32 repository?

Le Jeu 04 Mar 2010 19:01:46, jand@ActiveState.com a écrit :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu, 04 Mar 2010, Gonéri LE BOUDER via RT wrote:
<div class="message-stanza open">&gt; &gt; 
&gt; &gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=50020">https://rt.cpan.org/Ticket/Display.html?id=50020</a></span> &gt;
&gt; &gt; 
&gt; &gt; This change in Olivier patch is enough to create an endless look with my
&gt; &gt; Strawberry Perl:
&gt; &gt; -bootstrap $Package;
&gt; &gt; +bootstrap&#40;__PACKAGE__&#41;;
&gt; &gt; 
&gt; &gt; AFAIR I understand, instead of reading the &#34;Win32::Daemon&#34; string,
&gt; &gt; bootstrap&#40;&#41; try to access Win32::Daemon namespace and so, call Daemon.pm
&gt; &gt; and call again bootstrap&#40;&#41;.
</div>&gt; 
&gt; That change should not make any difference; __PACKAGE__ should just be
&gt; expanded to &#34;Win32::Daemon&#34; at compile time.
&gt; 
<div class="message-stanza open">&gt; &gt; Regarding this change:
&gt; &gt; -    Win32::Daemon::StopService&#40;&#41;;^M
&gt; &gt; +    # Stop the service only if we are in the main thread &#40;not in a
&gt; &gt; forked process&#41;^M
&gt; &gt; +    Win32::Daemon::StopService&#40;&#41; if $$ &gt; 0;^M
&gt; &gt; 
&gt; &gt; perlvar says:
&gt; &gt;        $$      The process number of the Perl running this script.  You
&gt; &gt; should consider this variable read-only, although it will be altered
&gt; &gt; across fork&#40;&#41; calls.  &#40;Mnemonic: same as shells.&#41;
&gt; &gt; 
&gt; &gt; I don&#39;t understand why $$ should be 0 in the sub-process.
</div>&gt; 
&gt; $$ will be less than 0 in the child-process &#40;which is just a
</div>pseudo-process
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; simulated by a thread on Windows&#41;.  This is only true for Perl on Windows,
&gt; but Win32::Daemon only works on Windows anyways, so that is not an issue.
&gt; 
&gt; Cheers,
&gt; -Jan
&gt; 
</div>
-- 
Olivier Mengué - <span class="clickylink"><a target="new" rel="nofollow" href="http://o.mengue.free.fr/">http://o.mengue.free.fr/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-834912" href="/Public/Bug/Display.html?id=50020#txn-834912">#</a>      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;22&nbsp;09:39:06&nbsp;2010</span>
    <span class="description">dolmen [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> libwin32 [...] perl.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/834912/432490/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/432490">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 219b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">My patch has been committed in r488:
<span class="clickylink"><a target="new" rel="nofollow" href="http://code.google.com/p/libwin32/source/detail?r=488">http://code.google.com/p/libwin32/source/detail?r=488</a></span>

It has been released in Win32-Daemon-20100921.

-- 
Olivier Mengué - <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~dolmen/">http://search.cpan.org/~dolmen/</a></span> <span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/dolmen/">http://github.com/dolmen/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-834916" href="/Public/Bug/Display.html?id=50020#txn-834916">#</a>      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;22&nbsp;09:39:10&nbsp;2010</span>
    <span class="description">dolmen [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-837543" href="/Public/Bug/Display.html?id=50020#txn-837543">#</a>      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;29&nbsp;05:49:10&nbsp;2010</span>
    <span class="description">dolmen [...] cpan.org -  Queue changed from POE-Component-Daemon-Win32 to Win32-Daemon</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-837544" href="/Public/Bug/Display.html?id=50020#txn-837544">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;29&nbsp;05:49:23&nbsp;2010</span>
    <span class="description">dolmen [...] cpan.org -  Fixed in 20100921 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.748105</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
