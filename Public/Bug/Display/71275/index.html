<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #71275 for DateTime: local_rdn_values at leap seconds</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #71275 for DateTime: local_rdn_values at leap seconds</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DateTime/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DateTime/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DateTime/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DateTime/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/houseabsolute/DateTime.pm/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/DateTime">DateTime CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">71275</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DateTime/Active/">DateTime</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
zefram [...] fysh.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-9734-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-9735-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;27&nbsp;09:01:33&nbsp;2011</span>
    <span class="description">zefram [...] fysh.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> local_rdn_values at leap seconds</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 27 Sep 2011 14:01:18 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DateTime [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&#40;This is what I really wanted to investigate that led to me discovering
the preceding two bugs about timezones and leap seconds.&#41;

For a time at a leap second, the local_rd_values that DateTime supplies
are problematic: they&#39;re generated inconsistently, and in the general
case result in ambiguity.  For reference, here&#39;s what the related
utc_rd_values does:

$ perl -MDateTime -lwe &#39;$dt=DateTime-&gt;new&#40;year=&gt;2008,month=&gt;12,day=&gt;31,hour=&gt;23,minute=&gt;59,second=&gt;60, time_zone=&gt;&#34;UTC&#34;&#41;; print $dt; print join&#34;,&#34;,$dt-&gt;utc_rd_values&#39;                                    
2008-12-31T23:59:60
733407,86400,0

It returns a seconds-of-day value of 86400, which of course can&#39;t occur in
a normal day.  This uniquely identifies the leap second, and puts it in
its proper numerical place relative to all the other seconds of the day.
But that can only work when the leap second occurs right at the end of the
day, which it does in UTC but in the general case doesn&#39;t in a timezone.

Suppose we have a timezone offset of an hour:

$ perl -MDateTime -lwe &#39;$dt=DateTime-&gt;new&#40;year=&gt;2008,month=&gt;12,day=&gt;31,hour=&gt;23,minute=&gt;59,second=&gt;60, time_zone=&gt;&#34;UTC&#34;&#41;; $dt-&gt;set_time_zone&#40;&#34;+01:00&#34;&#41;; print $dt; print join&#34;,&#34;,$dt-&gt;local_rd_values&#39;                            
2009-01-01T00:59:60
733408,3600,0
$ perl -MDateTime -lwe &#39;$dt=DateTime-&gt;new&#40;year=&gt;2009,month=&gt;1,day=&gt;1,hour=&gt;0,minute=&gt;0,second=&gt;0, time_zone=&gt;&#34;UTC&#34;&#41;; $dt-&gt;set_time_zone&#40;&#34;+01:00&#34;&#41;; print $dt; print join&#34;,&#34;,$dt-&gt;local_rd_values&#39; 
2009-01-01T01:00:00
733408,3600,0

Stringification shows the correct broken-down time of 00:59:60.
The local_rd_values show the correct day, and 3600 seconds into that day,
which is understandable since the preceding second &#40;00:59:59&#41; was actually
3559 seconds into the day.  However, 3600 is the same seconds-of-day
value that one would normally expect for the time 01:00:00, and indeed
the following second does show the same seconds-of-day value despite
being a different time.  So the local_rd_values result is ambiguous.

It&#39;s also calculated inconsistently.  For a timezone offset of zero I
can get two different results, depending on whether the timezone is_utc:

$ perl -MDateTime -lwe &#39;$dt=DateTime-&gt;new&#40;year=&gt;2008,month=&gt;12,day=&gt;31,hour=&gt;23,minute=&gt;59,second=&gt;60, time_zone=&gt;&#34;UTC&#34;&#41;; $dt-&gt;set_time_zone&#40;&#34;UTC&#34;&#41;; print $dt; print join&#34;,&#34;,$dt-&gt;local_rd_values&#39;
2008-12-31T23:59:60
733407,86400,0
$ perl -MDateTime::TimeZone::SystemV -MDateTime -lwe &#39;$dt=DateTime-&gt;new&#40;year=&gt;2008,month=&gt;12,day=&gt;31,hour=&gt;23,minute=&gt;59,second=&gt;60, time_zone=&gt;&#34;UTC&#34;&#41;; $dt-&gt;set_time_zone&#40;DateTime::TimeZone::SystemV-&gt;new&#40;&#34;UTC0&#34;&#41;&#41;; print $dt; print join&#34;,&#34;,$dt-&gt;local_rd_values&#39;
2009-01-01T23:59:60
733408,0,0

For the is_utc zone, local_rd_values returns the correct day and the same
distinctive &#40;but irregular&#41; seconds-since-day value as utc_rd_values.
For the non-is_utc zone, which otherwise behaves identically,
local_rd_values returns &#40;as for the non-zero offsets&#41; a regular-looking
seconds-of-day value that appears to identify the second following the
leap second.  In this case that also involves showing the wrong day.
The Europe/London zone, which is not generally equivalent to UTC but
happens to have a zero offset at that time, also produces what looks
like the first second of the next day.

DateTime doesn&#39;t document what utc_rd_values and local_rd_values are
meant to do around a leap second.  It does say they&#39;re meant for other
modules to be able to extract the time represented by the object.  To have
local_rd_values return an apparently-regular value for the leap second,
ambiguous with the following second, defeats this purpose, because its
value doesn&#39;t fully identify the local time represented by the object.
Since providing seconds-of-day = 86400 only works at the very end of
the day, that&#39;s not a solution either.  For local_rd_values to be fully
useful, it&#39;s going to need some other behaviour.

For the purposes of timezones, in the modern era timezones are all
UTC-compatible by virtue of using only offsets of integral minutes, so
usually the number of seconds into the minute doesn&#39;t matter.  Timezones
therefore usually want to treat a leap second like the preceding second
&#40;xx:xx:59&#41;.  It would be convenient if leap seconds were indicated by
having seconds-of-day the same as it was for the preceding second and
letting the nanoseconds-of-second value exceed 10^9.  This trick has
been proposed for struct timeval/timespec in some situations, and it
doesn&#39;t run into 32-bit trouble.

-zefram
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;12&nbsp;12:49:38&nbsp;2016</span>
    <span class="description">DROLSKY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ticket migrated to GitHub as <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/houseabsolute/DateTime.pm/issues/20">https://github.com/houseabsolute/DateTime.pm/issues/20</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;12&nbsp;12:49:38&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;12&nbsp;12:49:44&nbsp;2016</span>
    <span class="description">DROLSKY [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
