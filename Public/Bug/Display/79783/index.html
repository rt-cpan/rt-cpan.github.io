<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #79783 for Moose: Method delegation - ask forgiveness, not permission</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #79783 for Moose: Method delegation - ask forgiveness, not permission</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Moose">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Moose">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Moose">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Moose">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Moose">Moose CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">79783</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Moose">Moose</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
perl [...] toby.ink

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-38786-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
2.0603</li>
<li>
2.0604</li>
</ul>
    </td>
  </tr>
  <tr id="CF-38787-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




moose-delegation.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1122320/590453/moose-delegation.pl">
Sat Sep 22 18:08:50 2012 (631b) by perl [...] toby.ink
</a>
</font></li>
</ul>


Moose-filehandle-delegation-tobyink-20121009.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1127144/592989/Moose-filehandle-delegation-tobyink-20121009.diff">
Mon Oct 08 20:42:19 2012 (2.8k) by perl [...] toby.ink
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=79783">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1122108" href="/Public/Bug/Display.html?id=79783#txn-1122108">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;21&nbsp;10:03:03&nbsp;2012</span>
    <span class="description">perl [...] toby.ink -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Method delegation - ask forgiveness, not permission</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1122108/590334/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/590334">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 807b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">```
{
  package Thingy;
  has fh =&gt; &#40;is =&gt; &#39;ro&#39;, handles =&gt; [qw&#40;getline&#41;]&#41;;
}

use IO::Handle;
open my $fh, &#39;&lt;&#39;, &#39;some-file.txt&#39;;
my $thingy = Thingy-&gt;new&#40;fh =&gt; $fh&#41;;

print $thingy-&gt;fh-&gt;getline;   # works
print $thingy-&gt;getline;       # bails
```

The reason the delegated method fails is because 
Moose::Meta::Method::Delegation::_initialize_body checks that the proxy 
&#40;i.e. the file handle in this case&#41; is blessed before calling the 
method &#40;and it&#39;s not&#41;.

Yes, there are workarounds, but workarounds suck by definition.

A better solution would be to not check whether the proxy is blessed 
and just go ahead and call the delegated method. This could be done in 
an eval block if you wish to avoid the default Perl method-not-found 
error and supply a Moosey one instead.

Also related is RT #46614.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1122118" href="/Public/Bug/Display.html?id=79783#txn-1122118">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;21&nbsp;10:05:49&nbsp;2012</span>
    <span class="description">doy [...] tozt.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #79783] Method delegation - ask forgiveness, not permission</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 21 Sep 2012 09:05:27 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Toby Inkster via RT &lt;bug-Moose [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jesse Luehrs &lt;doy [...] tozt.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1122118/590340/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/590340">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Sep 21, 2012 at 10:03:04AM -0400, Toby Inkster via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Fri Sep 21 10:03:03 2012: Request 79783 was acted upon.
&gt; Transaction: Ticket created by TOBYINK
&gt;        Queue: Moose
&gt;      Subject: Method delegation - ask forgiveness, not permission
&gt;    Broken in: 2.0603, 2.0604
&gt;     Severity: Normal
&gt;        Owner: Nobody
&gt;   Requestors: mail@tobyinkster.co.uk
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=79783">https://rt.cpan.org/Ticket/Display.html?id=79783</a></span> &gt;
&gt; 
&gt; 
&gt; ```
&gt; {
&gt;   package Thingy;
&gt;   has fh =&gt; &#40;is =&gt; &#39;ro&#39;, handles =&gt; [qw&#40;getline&#41;]&#41;;
&gt; }
&gt; 
&gt; use IO::Handle;
&gt; open my $fh, &#39;&lt;&#39;, &#39;some-file.txt&#39;;
&gt; my $thingy = Thingy-&gt;new&#40;fh =&gt; $fh&#41;;
&gt; 
&gt; print $thingy-&gt;fh-&gt;getline;   # works
&gt; print $thingy-&gt;getline;       # bails
&gt; ```
&gt; 
&gt; The reason the delegated method fails is because 
&gt; Moose::Meta::Method::Delegation::_initialize_body checks that the proxy 
&gt; &#40;i.e. the file handle in this case&#41; is blessed before calling the 
&gt; method &#40;and it&#39;s not&#41;.
&gt; 
&gt; Yes, there are workarounds, but workarounds suck by definition.
&gt; 
&gt; A better solution would be to not check whether the proxy is blessed 
&gt; and just go ahead and call the delegated method. This could be done in 
&gt; an eval block if you wish to avoid the default Perl method-not-found 
&gt; error and supply a Moosey one instead.
&gt; 
&gt; Also related is RT #46614.
</div>
The check is there so that we get an error at compile time instead of
runtime, which is important. The check should just be expanded to also
accept filehandles.

-doy
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1122121" href="/Public/Bug/Display.html?id=79783#txn-1122121">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;21&nbsp;10:05:51&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1122128" href="/Public/Bug/Display.html?id=79783#txn-1122128">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;21&nbsp;10:46:13&nbsp;2012</span>
    <span class="description">autarch [...] urth.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #79783] Method delegation - ask forgiveness, not permission</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 21 Sep 2012 09:45:59 -0500 &#40;CDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jesse Luehrs via RT &lt;bug-Moose [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dave Rolsky &lt;autarch [...] urth.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1122128/590346/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/590346">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 663b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, 21 Sep 2012, Jesse Luehrs via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The check is there so that we get an error at compile time instead of 
&gt; runtime, which is important. The check should just be expanded to also 
&gt; accept filehandles.
</div>
I don&#39;t see how this happens at compile time. The body of the delegated 
accessor doesn&#39;t get executed until it&#39;s first called.

I think the reason we&#39;re checking is to provide a nice error.


-dave

/*============================================================
<span class="clickylink"><a target="new" rel="nofollow" href="http://VegGuide.org">http://VegGuide.org</a></span>               <span class="clickylink"><a target="new" rel="nofollow" href="http://blog.urth.org">http://blog.urth.org</a></span>
Your guide to all that&#39;s veg      House Absolute&#40;ly Pointless&#41;
============================================================*/
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1122320" href="/Public/Bug/Display.html?id=79783#txn-1122320">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;22&nbsp;18:08:49&nbsp;2012</span>
    <span class="description">perl [...] toby.ink -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1122320/590452/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/590452">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 185b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The attached test case illustrates that the check is done at run-time, 
when the delegated method is called; and that Moose&#39;s nice error messages 
are only issued in certain situations.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> moose-delegation.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1122320/590453/moose-delegation.pl">Download moose-delegation.pl</a><br />
<span class="downloadcontenttype">text/x-perl 631b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">use Test::More;
use Test::Exception;

{
	package Local::Class;
	use Moose;
	has attr =&gt; &#40;
		is      =&gt; &#39;rw&#39;,
		isa     =&gt; &#39;Any&#39;,
		handles =&gt; {
			delegated =&gt; &#39;method&#39;,
		},
	&#41;;
	sub method {
		return &#39;ok&#39;;
	}
}

my $obj = Local::Class-&gt;new&#40;&#41;;  # nice error
throws_ok { $obj-&gt;delegated } qr{the value of attr is not defined};

$obj-&gt;attr&#40;42&#41;; # not nice error; just the Perl default
throws_ok { $obj-&gt;delegated } qr{without a package or object reference};

$obj-&gt;attr&#40;[]&#41;; # nice error
throws_ok { $obj-&gt;delegated } qr{is not an object};

$obj-&gt;attr&#40; Local::Class-&gt;new &#41;; # no error
lives_ok { $obj-&gt;delegated };

done_testing&#40;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1126429" href="/Public/Bug/Display.html?id=79783#txn-1126429">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;05&nbsp;11:52:09&nbsp;2012</span>
    <span class="description">perl [...] toby.ink -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1126429/592595/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/592595">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 450b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2012-09-21T15:03:03+01:00, TOBYINK wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; A better solution would be to not check whether the proxy is blessed 
&gt; and just go ahead and call the delegated method. This could be done in 
&gt; an eval block if you wish to avoid the default Perl method-not-found 
&gt; error and supply a Moosey one instead.
</div>
Actually, the eval block solution is a non-starter as it catches too many 
errors - e.g. exceptions deliberately thrown by the delegated method.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1126431" href="/Public/Bug/Display.html?id=79783#txn-1126431">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;05&nbsp;11:58:43&nbsp;2012</span>
    <span class="description">perl [...] toby.ink -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1126431/592597/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/592597">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 236b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Maybe, in &#34;_initialize_body&#34; replace this:

    if &#40;$error&#41;

with this:

    if &#40;$error and not eval { $proxy-&gt;can&#40;$method_to_call&#41; }&#41;

There are edge cases it doesn&#39;t cover, but it should be an improvement 
over the current situations.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1127144" href="/Public/Bug/Display.html?id=79783#txn-1127144">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;08&nbsp;20:42:18&nbsp;2012</span>
    <span class="description">perl [...] toby.ink -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> doy [...] tozt.net</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1127144/592988/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/592988">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 58b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">OK, patch attached which allows delegation to filehandles.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Moose-filehandle-delegation-tobyink-20121009.diff</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1127144/592989/Moose-filehandle-delegation-tobyink-20121009.diff">Download Moose-filehandle-delegation-tobyink-20121009.diff</a><br />
<span class="downloadcontenttype">text/x-diff 2.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/lib/Moose/Meta/Method/Delegation.pm b/lib/Moose/Meta/Method/Delegation.pm
index 32436d6..e8cbb2e 100644
--- a/lib/Moose/Meta/Method/Delegation.pm
+++ b/lib/Moose/Meta/Method/Delegation.pm
@@ -90,17 +90,44 @@ sub _initialize_body {
             : ref&#40;$proxy&#41; &#38;&#38; !blessed&#40;$proxy&#41; ? qq{ is not an object &#40;got &#39;$proxy&#39;&#41;}
             : undef;
 
+        unshift @_, @{ $self-&gt;curried_arguments };
+
         if &#40;$error&#41; {
-            $self-&gt;throw_error&#40;
-                &#34;Cannot delegate $handle_name to $method_to_call because &#34;
-                    . &#34;the value of &#34;
-                    . $self-&gt;associated_attribute-&gt;name
-                    . $error,
-                method_name =&gt; $method_to_call,
-                object      =&gt; $instance
-            &#41;;
+            local $@;
+            my @return;
+            if &#40;wantarray&#41; {
+                @return = eval { $proxy-&gt;$method_to_call&#40;@_&#41; };
+            }
+            elsif &#40;defined wantarray&#41; {
+                push @return, scalar eval { $proxy-&gt;$method_to_call&#40;@_&#41; };
+            }
+            else {
+                eval { $proxy-&gt;$method_to_call&#40;@_&#41;; 1 };
+            }
+
+            if &#40;not $@&#41; {
+                return @return;
+            }
+
+            # These errors we don&#39;t want to catch and rethrow. We want
+            # to substitute a more Moose-specific error message.
+            my $r1 = qr{^Can&#39;t locate object method &#34;$method_to_call&#34; via package};
+            my $r2 = qr{^Can&#39;t call method &#34;$method_to_call&#34; on &#40;unblessed reference|an undefined value&#41;};
+
+            if &#40;$@ =~ $r1 or $@ =~ $r2&#41; {
+                $self-&gt;throw_error&#40;
+                    &#34;Cannot delegate $handle_name to $method_to_call because &#34;
+                        . &#34;the value of &#34;
+                        . $self-&gt;associated_attribute-&gt;name
+                        . $error,
+                    method_name =&gt; $method_to_call,
+                    object      =&gt; $instance
+                &#41;;
+            }
+
+            die $@;
         }
-        unshift @_, @{ $self-&gt;curried_arguments };
+
         $proxy-&gt;$method_to_call&#40;@_&#41;;
     };
 }
diff --git a/t/attributes/attribute_delegation.t b/t/attributes/attribute_delegation.t
index 733542c..2a557b4 100644
--- a/t/attributes/attribute_delegation.t
+++ b/t/attributes/attribute_delegation.t
@@ -482,4 +482,20 @@ is&#40;$car-&gt;stop, &#39;Engine::stop&#39;, &#39;... got the right value from -&gt;stop&#39;&#41;;
     &#41;;
 }
 
+{
+    use IO::Handle;
+    
+    {
+         package Local::Delegation::Test;
+         use Moose;
+         has attr =&gt; &#40;is =&gt; &#39;ro&#39;, handles =&gt; [qw/ print /]&#41;;
+    }
+    
+    my $d;
+    open my $fh, &#39;&gt;&#39;, \$d;
+    Local::Delegation::Test-&gt;new&#40;attr =&gt; $fh&#41;-&gt;attr-&gt;print&#40;&#34;1&#34;&#41;;
+    Local::Delegation::Test-&gt;new&#40;attr =&gt; $fh&#41;-&gt;print&#40;&#34;2&#34;&#41;;
+    is&#40;$d, &#34;12&#34;, &#34;can delegate to non-blessed references&#34;&#41;;
+}
+
 done_testing;
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.514447</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
