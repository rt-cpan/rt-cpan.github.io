<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #46357 for Mail-GPG: Mail::GPG blocks in perform_multiplexed_gpg_io at eof&#40;$stderr_fh&#41; check</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #46357 for Mail-GPG: Mail::GPG blocks in perform_multiplexed_gpg_io at eof&#40;$stderr_fh&#41; check</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Mail-GPG/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Mail-GPG/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Mail-GPG/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Mail-GPG/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-GPG">Mail-GPG CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">46357</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Mail-GPG/Active/">Mail-GPG</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
hcmav6c02 [...] sneakemail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-19952-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-19953-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;25&nbsp;13:36:02&nbsp;2009</span>
    <span class="description">hcmav6c02 [...] sneakemail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Mail::GPG blocks in perform_multiplexed_gpg_io at eof&#40;$stderr_fh&#41; check</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> 25 May 2009 17:35:33 -0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-GPG [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> hcmav6c02 [...] sneakemail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Perl version is 5.10.0 and this is on NetBSD 4.0.  Module version is latest:

  # $Id: GPG.pm,v 1.23 2006/11/18 08:49:05 joern Exp $
  $VERSION = &#34;1.0.6&#34;; 

Mail::GPG is blocking in the above function and I have included a debugged version of the function below &#40;which includes the output I experience when the stall happens&#41;.

Note that also in another run of the code, I get a stall in the very first outer iteration.  The results don&#39;t seem to be consistent.  Is it possible that the tests in the return statement are overkill?  Is there a logic possible that would cause a stall?  What would cause eof&#40;&#41; itself to block?  It seems that eof&#40;&#41; isn&#39;t called twice on the same filehandle.

  inner iteration 811
  inner iteration 812
  exited inner
  alpha
  beta
  charlie
  delta
  binary 0, 1
  [stalls here -- before printing &#34;binary 1&#34;]
  [also note the debugged code in another run stalls at the same point but at the second master &#40;outer&#41; iteration]

Practically speaking, this means that Mail::GPG is at present unusable to me.  I would be happy to provide further details to debug.

I hope this information will be helpful.

What I see on the host is that the &#34;gpg&#34; process continues to be &#34;running&#34; &#40;although it&#39;s not using any CPU&#41;.  When I replaced &#34;gpg&#34; with a script that does something like ``real-gpg &#34;$@&#34; &gt; file; exec cat file&#39;&#39;, then the cat process itself just hangs around there too.
There seems to be a logic error &#40;perhaps overkill&#41; in the checking of the return condition.  The data is processed fine, it seems, since there are several hundred successful iterations of the loop above it.  But the clues I get on the tail output suggest that gpg has done what it needs to do, and perhaps shouldn&#39;t need to go through another outer iteration.
Maybe in the earlier iteration, when $status_fh has been found to be undef, then that alone could mean that there can be no more practical processing that can take place. 

sub perform_multiplexed_gpg_io {
    my $self = shift;
    my %par  = @_;
    my  &#40;$data_fh, $data_canonify, $stdin_fh, $stderr_fh&#41; =
    @par{&#39;data_fh&#39;,&#39;data_canonify&#39;,&#39;stdin_fh&#39;,&#39;stderr_fh&#39;};
    my  &#40;$stdout_fh, $status_fh, $stderr_sref, $stdout_sref&#41; =
    @par{&#39;stdout_fh&#39;,&#39;status_fh&#39;,&#39;stderr_sref&#39;,&#39;stdout_sref&#39;};
    my  &#40;$status_sref&#41; =
    $par{&#39;status_sref&#39;};

print STDERR &#34;one\n&#34;;
    #-- perl &lt; 5.6 compatibility: seek&#40;&#41; and read&#40;&#41; work
    #-- on native GLOB filehandle only, so dertmine type
    #-- of filehandle here
    my $data_fh_glob = ref $data_fh eq &#39;GLOB&#39;;

    #-- rewind the data filehandle
    if &#40;$data_fh_glob&#41; {
        seek $data_fh, 0, 0;
    }
    else {
        $data_fh-&gt;seek&#40; 0, 0 &#41;;
    }

print STDERR &#34;two\n&#34;;
    #-- create IO::Select objects for all
    #-- filehandles in question
    my $stdin  = IO::Select-&gt;new&#40;$stdin_fh&#41;;
    my $stderr = IO::Select-&gt;new&#40;$stderr_fh&#41;;
    my $stdout = IO::Select-&gt;new&#40;$stdout_fh&#41;;
    my $status = $status_fh ? IO::Select-&gt;new&#40;$status_fh&#41; : undef;

    my $buffer;
print STDERR &#34;just before while loop\n&#34;;
my $myiter =0 ;
    while &#40;1&#41; {

$myiter++;print STDERR &#34;iteration $myiter\n&#34;;
my $myiter2=0;
        #-- as long we has data try to write
        #-- it into gpg
        while &#40; $data_fh &#38;&#38; $stdin-&gt;can_write&#40;0.1&#41; &#41; {
$myiter2++;print STDERR &#34;inner iteration $myiter2\n&#34;;
            if &#40; $data_fh_glob
                ? read $data_fh,
                $buffer, 1024
                : $data_fh-&gt;read&#40; $buffer, 1024 &#41; &#41; {

                #-- ok, got a block of data
                if &#40;$data_canonify&#41; {

                    #-- canonify it if requested
                    $buffer =~ s/\x0A/\x0D\x0A/g;
                    $buffer =~ s/\x0D\x0D\x0A/\x0D\x0A/g;
                }

                #-- feed it into gpg
                print $stdin_fh $buffer;
            }
            else {

                #-- no data read, close gpg&#39;s stdin
                #-- and set the data filehandle to false
                close $stdin_fh;
                $data_fh = 0;
            }
        }
print STDERR &#34;exited inner\n&#34;;

print STDERR &#34;alpha\n&#34;;
        #-- probably we can read from gpg&#39;s stdout
        while &#40; $stdout-&gt;can_read&#40;0.1&#41; &#41; {
            last if eof&#40;$stdout_fh&#41;;
            $$stdout_sref .= &lt;$stdout_fh&gt;;
        }

print STDERR &#34;beta\n&#34;;
        #-- probably we can read from gpg&#39;s stderr
        while &#40; $stderr-&gt;can_read&#40;0.1&#41; &#41; {
            last if eof&#40;$stderr_fh&#41;;
            $$stderr_sref .= &lt;$stderr_fh&gt;;
        }
print STDERR &#34;charlie\n&#34;;

        #-- probably we can read from gpg&#39;s status
        if &#40;$status&#41; {
            while &#40; $status-&gt;can_read&#40;0.1&#41; &#41; {
                last if eof&#40;$status_fh&#41;;
                $$status_sref .= &lt;$status_fh&gt;;
            }
        }

print STDERR &#34;delta\n&#34;;
        #-- we&#39;re finished if no more data left
        #-- and both gpg&#39;s stdout and stderr
        #-- are at eof.   
print STDERR &#34;binary 0, &#34;, !$data_fh, &#34;\n&#34;;
print STDERR &#34;binary 1, &#34;, eof&#40;$stderr_fh&#41;, &#34;\n&#34;;
print STDERR &#34;binary 2, &#34;, eof&#40;$stdout_fh&#41;, &#34;\n&#34;;
print STDERR &#34;binary 3, &#34;, !$status_fh, &#34;\n&#34;;
if &#40;$status_fh&#41; {
  print STDERR &#34;binary 4, &#34;, eof&#40;$status_fh&#41;, &#34;\n&#34;;
} else {
  print STDERR &#34;binary 4 - check skipped due to undeflike quality of status_fh.\n&#34;;
}

        return
            if !$data_fh
            &#38;&#38; eof&#40;$stderr_fh&#41; 
            &#38;&#38; eof&#40;$stdout_fh&#41;
            &#38;&#38; &#40; !$status_fh || eof&#40;$status_fh&#41; &#41;;
print STDERR &#34;echo\n&#34;;
    }

#....
#exited inner  
#alpha
#beta
#charlie
#delta
#binary 0, 1
#binary 1,
#binary 2,
#binary 3, 1
#binary 4 - check skipped due to undeflike quality of status_fh.
#echo
#iteration 2
#exited inner
#alpha
#beta
#charlie
#delta
#binary 0, 1
#[stalls here]

    1;
}
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;25&nbsp;14:30:17&nbsp;2009</span>
    <span class="description">hcmav6c02 [...] sneakemail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #46357] AutoReply: Mail::GPG blocks in perform_multiplexed_gpg_io at eof&#40;$stderr_fh&#41; check</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> 25 May 2009 18:29:18 -0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Mail-GPG [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> hcmav6c02 [...] sneakemail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">It&#39;s also stalling at:

                #-- feed it into gpg
                print $stdin_fh $buffer;

unless I perform the workaround of creating a fake-gpg wrapper script
that firstly buffers the input completely, writes it to a file, performs
real-gpg on that file and outputs it to a new one, and then finally does
&#34;exec cat -u ${OUTPUTFILE}&#34;:

#!/bin/ksh
# fake-gpg

if echo &#34;$@&#34; | grep -q -- --sign
then
  if echo &#34;$@&#34; | grep -q -- --encrypt
  then
    INPUTFILE=&#34;/tmp/output.$RANDOM.$RANDOM&#34;
    OUTPUTFILE=&#34;/tmp/output.$RANDOM.$RANDOM.out&#34;
    /bin/cat -u &gt; &#34;${INPUTFILE}&#34;
    sync
    gpg-real &#34;$@&#34; &lt; &#34;${INPUTFILE}&#34; &gt; &#34;${OUTPUTFILE}&#34;
    sync
    exec /bin/cat -u &#34;${OUTPUTFILE}&#34;
  fi
fi

exec gpg-real &#34;$@&#34;

When I set gpg_call to the real GnuPG executable, then it stalls at the
print line that I mentioned, above.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
