<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #83766 for DBD-Oracle: zombie processes with ora_connect_with_default_signals = [&#39;CHILD&#39;]</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #83766 for DBD-Oracle: zombie processes with ora_connect_with_default_signals = [&#39;CHILD&#39;]</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-Oracle/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-Oracle/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-Oracle/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-Oracle/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/pythian/DBD-Oracle/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-Oracle">DBD-Oracle CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">83766</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">deleted</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-Oracle/Active/">DBD-Oracle</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bohica [...] ntlworld.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
mahdi_sbeih [...] hotmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10192-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10193-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;05&nbsp;05:41:07&nbsp;2013</span>
    <span class="description">bohica [...] ntlworld.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> mahdi_sbeih [...] hotmail.com</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> zombie processes with ora_connect_with_default_signals = [&#39;CHILD&#39;]</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Originally reported by Mahdi Sbeih via email to Tim. The docx attachment
is original and the HTML version I converted in open office so they may
not be the same.

   Dear Tim,

   Sorry for sending this email directly to you, but I am not an active
member in Perl lists and forums and
   maybe you can direct this email to whom is responsible for the
development of Perl DBD::Oracle module.

   I found a bug related to the ora_connect_with_default_signals feature.

   On our system RHEL5 Oracle11gR2, we had to use this feature on the
child signal in order to avoid the
   &#34;-1&#34; return from the system call
   ora_connect_with_default_signals =&gt; [&#39;CHLD&#39;]

   This caused a sever bug, if the Perl script is running in the
background and doesn&#39;t exit, every time it
   connects to the oracle database server it will create a zombie
process, and this will later crash the
   machine itself since it will consume all the processes on the machine.

   Anyway, attached in an internal document that explains the problem
with examples. I thought I should
   share this with the world 

   Mahdi
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> system_signals_oracle_probelm.html</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> system_signals_oracle_probelm.docx</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;05&nbsp;06:25:20&nbsp;2013</span>
    <span class="description">mahdi_sbeih [...] hotmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #83766] zombie processes with ora_connect_with_default_signals = [&#39;CHILD&#39;]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 5 Mar 2013 03:25:03 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-DBD-Oracle [...] rt.cpan.org&#34; &lt;bug-dbd-oracle [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mahdi Sbeih &lt;mahdi_sbeih [...] hotmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here is the exact versions of the platform and database versions

Linux 2.6.18-164.el5 #1 SMP Tue Aug 18 15:51:48 EDT 2009 x86_64 x86_64 x86_64 GNU/Linux
Oracle Database 11g Enterprise Edition Release 11.2.0.1.0 - 64bit Production


Subject: [rt.cpan.org #83766] zombie processes with ora_connect_with_default_signals = [&#39;CHILD&#39;]
From: bug-DBD-Oracle@rt.cpan.org
CC: mahdi_sbeih@hotmail.com
Date: Tue, 5 Mar 2013 05:41:09 -0500

&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=83766">https://rt.cpan.org/Ticket/Display.html?id=83766</a></span> &gt;
 
Originally reported by Mahdi Sbeih via email to Tim. The docx attachment
is original and the HTML version I converted in open office so they may
not be the same.
 
   Dear Tim,
 
   Sorry for sending this email directly to you, but I am not an active
member in Perl lists and forums and
   maybe you can direct this email to whom is responsible for the
development of Perl DBD::Oracle module.
 
   I found a bug related to the ora_connect_with_default_signals feature.
 
   On our system RHEL5 Oracle11gR2, we had to use this feature on the
child signal in order to avoid the
   &#34;-1&#34; return from the system call
   ora_connect_with_default_signals =&gt; [&#39;CHLD&#39;]
 
   This caused a sever bug, if the Perl script is running in the
background and doesn&#39;t exit, every time it
   connects to the oracle database server it will create a zombie
process, and this will later crash the
   machine itself since it will consume all the processes on the machine.
 
   Anyway, attached in an internal document that explains the problem
with examples. I thought I should
   share this with the world 
 
   Mahdi
 


--Forwarded Message Attachment--




        
        
        
        
        
        
        
        
        
        
        
        
        
        
        


Problem




The problem occurs
when the following are true:

        Application that connects to
        Oracle database server
        Application and the database
        server are on the same machine, i.e. the database server is local
        and the connection is utilized using ORACLE_SID.
        Application uses the “system”
        command to execute external command such as dP reader or any other
        tool and the application MUST check on the system return code for
        success or failure.
        Platform is RHEL5
        and Oracle 11g similar to our local Romania server.
        Although we are not 100% sure that this is the only combination. 
        

If all of the above
are true, the return of the system command will always be “-1”
despite the result of the command weather it is success or failure.
This will prevent the application from deciding how to proceed and in
most cases the application will consider the outcome as failure all
the time. 

Without going into
the detailed technical information, I will provide a couple of links
that will describe these technical details. Bottom line, this is a
problem in how Oracle client deals with signals when an application
connects to a local database server, it seems Oracle client messes
the signals and causes the system command to always return -1.
The problem can
happen in any of our applications that connect to local database
server and use the system command such as dP readers, DpLoad,
DpCreateDb.pl…etc. This is the general case of dP software in
general. So this bug in Oracle is critical.




Example




Here is a simple
Perl script that illustrates the problem
#!/usr/bin/env
perl_db
use
DBI;
my
%attr = &#40;
 
       PrintError =&gt; 0,
 
       RaiseError =&gt; 1,
 
       AutoCommit =&gt; 0
 
      &#41;;
my&#40;$db_handle&#41;
= DBI-&gt;connect&#40;&#34;dbi:Oracle:&#34;,&#34;dbname&#34;,&#34;pwd&#34;,\%attr&#41;;
my&#40;$sys_ret&#41;
= system&#40;&#34;date&#34;&#41;;
print&#40;&#34;System
return value should be 0 and we get &lt;$sys_ret&gt;\n&#34;&#41;;




The
output of executing the above simple script will be something like
this:
Wed
Feb 27 06:40:03 PST 2013
System
return value should be 0 and we get &lt;-1&gt;
Current Fix and the Zombie Processes




This has been
noticed few years ago and the same exact solution was implemented in
Perl scripts and in dP tools such as dbascii. The solution was to
alter the CHLD signal for such applications. For example in Perl
DBD::Oracle they introduced an attribute to the connect method
called:
ora_connect_with_default_signals,
when using this attribute we can avoid this problem, more details
about this attribute can be found in:
<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~pythian/DBD-Oracle-1.56/lib/DBD/Oracle.pm#ora_connect_with_default_signals">http://search.cpan.org/~pythian/DBD-Oracle-1.56/lib/DBD/Oracle.pm#ora_connect_with_default_signals</a></span>
In C applications
such as dbascii, the following code was added after connecting to
Oracle:
signal&#40;SIGCLD,
NULL&#41;;
In Perl application,
the below has been added to the connection attributes:
ora_connect_with_default_signals
=&gt; [&#39;CHLD&#39;]




The problem with
this solution was discovered by a customer when using the “-log_db”
option with DpLoad and a platform similar to Romania local server.
When using the DpLoad option –log_db and this fix, every time
DpLoad initiates a connection to the database server, it will also
create a zombie process that remains on the system. This means that
in production, a server might run out processes in hours if not
minutes depending on process limit on the machine. 

The zombie problem
occurs for sure in all other application as mentioned above but it
only became critical in DpLoad because DpLoad in production runs in
the background and doesn’t exit while other application like
DpCreateDb.pl and dbascii will exit after finishing and the zombie
processes will be minimal and they will be removed once the
application exits.
Here is an example
for replicate the zombie processes, run this script from a terminal
and from another terminal run the “top” command. At the top of
the “top” command there is a zombie filed for the total number of
zombie processes on the system:
#!/usr/bin/env
perl_db
use
DBI;
my&#40;$db_handle&#41;;
my&#40;$turn&#41;;
my&#40;@turns&#41;
= &#40;1,2,3,4,5,6,7,8,9,10&#41;;
my
%attr = &#40;
 
       PrintError =&gt; 0,
 
       RaiseError =&gt; 1,
 
       AutoCommit =&gt; 0,
 
       ora_connect_with_default_signals
=&gt; [&#39;CHLD&#39;]
 
      &#41;;
foreach
$turn &#40;@turns&#41; {
 
  ## connecting
 
  $db_handle =
DBI-&gt;connect&#40;&#34;dbi:Oracle:&#34;,&#34;dbanme&#34;,&#34;pwd&#34;,\%attr&#41;;
 
  ## disconnecting
 
  $db_handle-&gt;disconnect&#40;&#41;;
}
print&#40;&#34;Sleeping
for 15 seconds, from another terminal run top command and see how
number of zombie processes increase.....\n&#34;&#41;;
sleep&#40;15&#41;;
my&#40;$sys_ret&#41;
= system&#40;&#34;date&#34;&#41;;
print&#40;&#34;System
return value should be 0 and we get &lt;$sys_ret&gt;\n&#34;&#41;;




In the above
example, the system returns 0 which is correct but the script creates
10 zombie processes that don’t get removed unless the above script
finishes execution or killed.
Technical
information:
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.nntp.perl.org/group/perl.dbi.dev/2012/02/msg6837.html">http://www.nntp.perl.org/group/perl.dbi.dev/2012/02/msg6837.html</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.nntp.perl.org/group/perl.dbi.users/2009/06/msg34023.html">http://www.nntp.perl.org/group/perl.dbi.users/2009/06/msg34023.html</a></span>




Suggested Fixes




In all the below
suggested fixes, we can safely remove the previous fix since it is
not recommended to play with default signals.

        Stop using local connections
        when the client application and database server are on the same
        machine, instead use EZCONNECT. This requires update Perl scripts,
        dP readers and tools that relies on ORACLE_SID to connect to the
        local database server. In general it looks like the EZCONNECT method
        is best way to connect since you only need to enable it and once it
        is enabled, you can connect to any server. 
        
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.orafaq.com/wiki/EZCONNECT">http://www.orafaq.com/wiki/EZCONNECT</a></span>
        Setting the environment
        variable TWO_TASK to the oracle SID value, if this variable exists
        it will  trigger oracle to connect to the server as if it is remote
        which will fix the problem, but make sure that ORACLE_SID is not
        used inside the script or application.
        There is a parameter that we
        can set on the engine level, this parameter is BEQUEATH_DETACH and
        by default is set to no, so if we add this variable to the file
        sqlnet.ora like this:
BEQUEATH_DETACH = YES
Here is a
        technical description about this
        option:
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.nntp.perl.org/group/perl.dbi.users/2009/06/msg34023.html">http://www.nntp.perl.org/group/perl.dbi.users/2009/06/msg34023.html</a></span>



        

Recommendation 

 

My recommendation is
to go with fix number 3, since it requires minimal changes and has
very minimal side effects – we don’t care about them, see link
below -. And by using this option we can safely revert the previous
fix from our Perl scripts and dP executables.  Moving forward we can
consider using the first fix. 

To get the customer
going ASAP, we can fix DpLoad by removing the previous fix and asking
the customer to add the following line to his sqlnet.ora
file:
BEQUEATH_DETACH = YES
Also we will have to
ask documentation to add this note in the release notes of 9.3.
Also we need to
create a new defect to revert the previous fix from all other tools.
If the customer
can’t wait at all, he can live with fix number 2 until we are done.



                                          
</div></div>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;05&nbsp;06:25:22&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;22&nbsp;14:24:43&nbsp;2019</span>
    <span class="description">bohica [...] ntlworld.com -  Ticket deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
