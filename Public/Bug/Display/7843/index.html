<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #7843 for WWW-Mechanize: WWW::Mechanize security: uses default value of file inputs</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #7843 for WWW-Mechanize: WWW::Mechanize security: uses default value of file inputs</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/WWW-Mechanize/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/WWW-Mechanize/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/WWW-Mechanize/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/WWW-Mechanize/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/libwww-perl/WWW-Mechanize/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/WWW-Mechanize">WWW-Mechanize CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">7843</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/WWW-Mechanize/Active/">WWW-Mechanize</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">MARKSTOS [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
adelton [...] fi.muni.cz

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-36214-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-36215-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;01&nbsp;13:31:15&nbsp;2004</span>
    <span class="description">adelton [...] fi.muni.cz -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 1 Oct 2004 18:37:03 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Honza Pazdziora &lt;adelton [...] fi.muni.cz&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-WWW-Mechanize [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> libwww [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> WWW::Mechanize security: uses default value of file inputs</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Hello,

I started using WWW::Mechanize to retrieve some data from server
which is not under my control. Suddenly, error

        Can&#39;t open file $sou: No such file or directory at /usr/lib/perl5/site_perl/5.8.1/HTML/Form.pm line 525

appeared. Whoa. I never told it in my script to work with $sou? Or
&#39;$sou&#39;. Where did it come from?

After digging through the sources, I figured out that

        &lt;input type=&#34;file&#34; name=&#34;soubor&#34; value=&#34;$sou&#34; vsize=&#34;60&#34;&gt;

really is in the source HTML and HTML::Form passes it to
WWW::Mechanize. And since I never intented to touch this value, the
default is used and WWW::Mechanize happily tries to upload the file. 

I consider this to be a major security hole -- what if the authors
of the HTML page used path to user&#39;s id_dsa file?

The HTML 4 spec says in section 17.4.1

        file
            Creates a file select control. User agents may use the
            value of the value attribute as the initial file name.

Since user agents _may_ use this value but are not required to,
and since with WWW::Mechanize there is no interactive control of
the values used, I believe it is crutial that the default value is
not used for the file inputs. Even the visual user agents &#40;Mozilla,
etc.&#41; clear the file inputs, since it is too easy to script automatic
upload with JS.

Please consider the following patch:

--- WWW/Mechanize.pm.orig       2004-10-01 18:06:39.000000000 +0200
+++ WWW/Mechanize.pm    2004-10-01 18:09:26.000000000 +0200
@@ -1387,6 +1387,15 @@
 sub _parse_html {
     my $self = shift;
     $self-&gt;{forms} = [ HTML::Form-&gt;parse&#40;$self-&gt;content, $self-&gt;base&#41;
];
+    if &#40;@{ $self-&gt;{forms} }&#41; {
+        for my $form &#40;@{ $self-&gt;{forms} }&#41; {
+            for my $input &#40;$form-&gt;inputs&#41; {
+                 if &#40;$input-&gt;type eq &#39;file&#39;&#41; {
+                     $input-&gt;value&#40; undef &#41;;
+                 }
+            }
+       }
+    }
     $self-&gt;{form}  = $self-&gt;{forms}-&gt;[0];
     $self-&gt;_extract_links&#40;&#41;;
 }

which removes all file values from all forms, preventing accidental
upload of files.

Alternatively, HTML::Form could do this for us. But there may be
some situations when you might want to see the value that came in the
HTML, so I could not argue strongly for removal of this value already
in HTML::Form. But it could be done on line 128 of HTML::Form 1.44.
I&#39;m Cc&#39;ing libwww@perl.org to gather views -- maybe for file inputs
a separate method like default_value could be used to get the original
value, while value would return undef.

Or maybe there are situations when WWW::Mechanize could retain the
default value. Then the patch suggested could be wrapped with a check
for some option that would keep the file input values intact.
Nonetheless, the default behaviour should be to remove the values.

I&#39;d appreciate your comment about this issue,

-- 
------------------------------------------------------------------------
 Honza Pazdziora | adelton@fi.muni.cz | <span class="clickylink"><a target="new" rel="nofollow" href="http://www.fi.muni.cz/~adelton/">http://www.fi.muni.cz/~adelton/</a></span>
 .project: Perl, mod_perl, DBI, Oracle, large Web systems, XML/XSL, ...
                Only self-confident people can be simple.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;17&nbsp;10:03:05&nbsp;2004</span>
    <span class="description">MARKSTOS [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;17&nbsp;10:03:05&nbsp;2004</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[adelton@fi.muni.cz - Fri Oct  1 13:31:15 2004]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; 
&gt; Since user agents _may_ use this value but are not required to,
&gt; and since with WWW::Mechanize there is no interactive control of
&gt; the values used, I believe it is crutial that the default value is
&gt; not used for the file inputs. Even the visual user agents &#40;Mozilla,
&gt; etc.&#41; clear the file inputs, since it is too easy to script automatic
&gt; upload with JS.
</div>
You are write about this. Some UA&#39;s don&#39;t allow you to set a default value. 

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Please consider the following patch:
&gt; 
&gt; --- WWW/Mechanize.pm.orig       2004-10-01 18:06:39.000000000 +0200
&gt; +++ WWW/Mechanize.pm    2004-10-01 18:09:26.000000000 +0200
&gt; @@ -1387,6 +1387,15 @@
&gt;  sub _parse_html {
&gt;      my $self = shift;
&gt;      $self-&gt;{forms} = [ HTML::Form-&gt;parse&#40;$self-&gt;content, $self-&gt;base&#41;
&gt; ];
&gt; +    if &#40;@{ $self-&gt;{forms} }&#41; {
&gt; +        for my $form &#40;@{ $self-&gt;{forms} }&#41; {
&gt; +            for my $input &#40;$form-&gt;inputs&#41; {
&gt; +                 if &#40;$input-&gt;type eq &#39;file&#39;&#41; {
&gt; +                     $input-&gt;value&#40; undef &#41;;
&gt; +                 }
&gt; +            }
&gt; +       }
&gt; +    }
&gt;      $self-&gt;{form}  = $self-&gt;{forms}-&gt;[0];
&gt;      $self-&gt;_extract_links&#40;&#41;;
&gt;  }
&gt; 
&gt; which removes all file values from all forms [when the HTML is loaded, not
&gt; submitted], preventing accidental upload of files.
</div>
I&#39;m fine with this patch. Would you also be willing to write a
Test::More test
script, which confirms that this works? There are examples in &#34;t/&#34;
directory of
the distribution. 

You could also patch the docs to mention that we do this, and patch the
Changes
file to give yourself credit for all your work. :&#41; As you can see from
the RT
bug queue, the bug reports for Mech are piling up, and we need all the help 
we can get.

Thanks!

        Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;17&nbsp;10:03:18&nbsp;2004</span>
    <span class="description">MARKSTOS [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;18&nbsp;10:08:50&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> adelton [...] fi.muni.cz</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I&#39;m fine with this patch. Would you also be willing to write a
&gt; Test::More test
&gt; script, which confirms that this works? There are examples in &#34;t/&#34;
&gt; directory of
&gt; the distribution.
</div>
I&#39;m attaching a patch against WWW::Mechanize 1.04.

I was sbout to test the result of the upload in the log-server and
check that no file was uploaded, but it seems to do
CGI-&gt;new&#40;$r-&gt;uri-&gt;query&#41; so it&#39;s not able to process POST requests.
Therefore I only test the value of the file upload field and the
created request in &#40;a new test file&#41; t/upload.t and the fact that
the value of the upload field is empty string in t/local/tick.t.

The t/upload.t might need to take possibly different boundaries into
account but code in HTTP::Request::Common seems to suggest that
the value of xYzZY is sufficiently stable.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; You could also patch the docs to mention that we do this, and patch
&gt;    the
&gt; Changes
&gt; file to give yourself credit for all your work. :&#41; As you can see from
</div>
Included in the patch.

Yours,

Jan Pazdziora
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -Nru WWW-Mechanize-1.04-orig/Changes WWW-Mechanize-1.04/Changes
--- WWW-Mechanize-1.04-orig/Changes	2004-09-16 06:28:03.000000000 +0200
+++ WWW-Mechanize-1.04/Changes	2004-10-18 15:37:51.000000000 +0200
@@ -1,6 +1,10 @@
 # $Id: Changes,v 1.137 2004/09/16 04:20:07 petdance Exp $
 Revision history for Perl extension WWW::Mechanize
 
+	[FIXES]
+	* Upload &lt;input type=&#34;file&#34; ... &gt; does not use the default
+	  value to prevent attacks, patch by Jan Pazdziora &#40;RT ##7843&#41;.
+
 1.04    Wed Sep 15 23:27:53 CDT 2004
 
         [ENHANCEMENTS]
diff -Nru WWW-Mechanize-1.04-orig/lib/WWW/Mechanize.pm WWW-Mechanize-1.04/lib/WWW/Mechanize.pm
--- WWW-Mechanize-1.04-orig/lib/WWW/Mechanize.pm	2004-09-16 06:23:35.000000000 +0200
+++ WWW-Mechanize-1.04/lib/WWW/Mechanize.pm	2004-10-18 15:51:46.000000000 +0200
@@ -534,6 +534,10 @@
 The option I&lt;$number&gt; parameter is used to distinguish between two fields
 with the same name.  The fields are numbered from 1.
 
+If the field is of type file &#40;file upload field&#41;, the value is always
+cleared to prevent remote sites from downloading your local files.
+To upload a file, specify its file name explicitly.
+
 =cut
 
 sub value {
@@ -1387,6 +1391,15 @@
 sub _parse_html {
     my $self = shift;
     $self-&gt;{forms} = [ HTML::Form-&gt;parse&#40;$self-&gt;content, $self-&gt;base&#41; ];
+    if &#40;@{ $self-&gt;{forms} }&#41; {
+        for my $form &#40;@{ $self-&gt;{forms} }&#41; {
+            for my $input &#40;$form-&gt;inputs&#41; {
+                 if &#40;$input-&gt;type eq &#39;file&#39;&#41; {
+                     $input-&gt;value&#40; undef &#41;;
+                 }
+            }
+       }
+    }
     $self-&gt;{form}  = $self-&gt;{forms}-&gt;[0];
     $self-&gt;_extract_links&#40;&#41;;
 }
diff -Nru WWW-Mechanize-1.04-orig/MANIFEST WWW-Mechanize-1.04/MANIFEST
--- WWW-Mechanize-1.04-orig/MANIFEST	2004-09-16 04:29:46.000000000 +0200
+++ WWW-Mechanize-1.04/MANIFEST	2004-10-18 15:42:40.000000000 +0200
@@ -42,6 +42,8 @@
 t/taint.t
 t/tick.html
 t/tick.t
+t/upload.html
+t/upload.t
 t/warnings.t
 t/warn.t
 
diff -Nru WWW-Mechanize-1.04-orig/t/local/log-server WWW-Mechanize-1.04/t/local/log-server
--- WWW-Mechanize-1.04-orig/t/local/log-server	2004-05-02 05:03:13.000000000 +0200
+++ WWW-Mechanize-1.04/t/local/log-server	2004-10-18 15:35:18.000000000 +0200
@@ -100,6 +100,7 @@
     &lt;input type=&#34;checkbox&#34; name=&#34;cat&#34; value=&#34;cat_foo&#34; %s /&gt;
     &lt;input type=&#34;checkbox&#34; name=&#34;cat&#34; value=&#34;cat_bar&#34; %s /&gt;
     &lt;input type=&#34;checkbox&#34; name=&#34;cat&#34; value=&#34;cat_baz&#34; %s /&gt;
+    &lt;input type=&#34;file&#34; name=&#34;upload&#34; value=&#34;README&#34; /&gt;
   &lt;/form&gt;
 &lt;/p&gt;
 &lt;/body&gt;
diff -Nru WWW-Mechanize-1.04-orig/t/local/submit.t WWW-Mechanize-1.04/t/local/submit.t
--- WWW-Mechanize-1.04-orig/t/local/submit.t	2004-05-02 05:03:13.000000000 +0200
+++ WWW-Mechanize-1.04/t/local/submit.t	2004-10-18 15:36:10.000000000 +0200
@@ -1,7 +1,7 @@
 use warnings;
 use strict;
 use lib &#39;t/local&#39;;
-use Test::More tests =&gt; 13;
+use Test::More tests =&gt; 15;
 use LocalServer;
 
 BEGIN { delete @ENV{ qw&#40; http_proxy HTTP_PROXY &#41; }; }
@@ -22,6 +22,8 @@
 ok&#40; $response-&gt;is_success, &#39;Got local page&#39; &#41; or die &#34;Can&#39;t even fetch local page&#34;;
 ok&#40; $mech-&gt;is_html &#41;;
 
+is&#40; $mech-&gt;value&#40;&#39;upload&#39;&#41;, &#39;&#39;, &#34;Hopefully no upload happens&#34;&#41;;
+
 $mech-&gt;field&#40;query =&gt; &#34;foo&#34;&#41;; # Filled the &#34;q&#34; field
 
 $response = $mech-&gt;submit;
@@ -31,6 +33,8 @@
 
 like&#40;$mech-&gt;content, qr/\bfoo\b/i, &#34;Found &#39;Foo&#39;&#34;&#41;;
 
+is&#40; $mech-&gt;value&#40;&#39;upload&#39;&#41;, &#39;&#39;, &#34;Hopefully no upload happens&#34;&#41;;
+
 SKIP: {
     eval &#34;use Test::Memory::Cycle&#34;;
     skip &#34;Test::Memory::Cycle not installed&#34;, 1 if $@;
diff -Nru WWW-Mechanize-1.04-orig/t/upload.html WWW-Mechanize-1.04/t/upload.html
--- WWW-Mechanize-1.04-orig/t/upload.html	1970-01-01 01:00:00.000000000 +0100
+++ WWW-Mechanize-1.04/t/upload.html	2004-10-18 15:43:27.000000000 +0200
@@ -0,0 +1,10 @@
+&lt;html&gt;
+&lt;body&gt;
+
+&lt;form action=&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/">http://localhost/</a></span>&#34; method=&#34;post&#34; enctype=&#34;multipart/form-data&#34;&gt;
+
+&lt;input type=&#34;file&#34; name=&#34;upload&#34; value=&#34;MANIFEST&#34; /&gt;
+&lt;input type=&#34;Submit&#34; name=&#34;submit&#34; value=&#34;Submit&#34; label=&#34;Sumbit&#34; /&gt;
+&lt;/form&gt;
+&lt;/body&gt;
+
diff -Nru WWW-Mechanize-1.04-orig/t/upload.t WWW-Mechanize-1.04/t/upload.t
--- WWW-Mechanize-1.04-orig/t/upload.t	1970-01-01 01:00:00.000000000 +0100
+++ WWW-Mechanize-1.04/t/upload.t	2004-10-18 16:05:00.000000000 +0200
@@ -0,0 +1,38 @@
+#!perl -T
+
+use strict;
+use Test::More tests =&gt; 6;
+use URI::file;
+
+use_ok&#40; &#39;WWW::Mechanize&#39; &#41;;
+
+my $mech = WWW::Mechanize-&gt;new&#40; cookie_jar =&gt; undef &#41;;
+isa_ok&#40; $mech, &#34;WWW::Mechanize&#34; &#41;;
+
+my $uri = URI::file-&gt;new_abs&#40; &#34;t/upload.html&#34; &#41;-&gt;as_string;
+$mech-&gt;get&#40; $uri &#41;;
+is&#40; ref $mech-&gt;uri, &#34;&#34;, &#34;URI shouldn&#39;t be an object&#34; &#41;;
+ok&#40; $mech-&gt;success, $uri &#41;;
+
+my $form = $mech-&gt;form_number&#40;1&#41;;
+my $reqstring = $form-&gt;click-&gt;as_string;
+$reqstring =~ s/\r//g;
+
+my $wanted = &lt;&lt;&#39;EOT&#39;;
+POST <span class="clickylink"><a target="new" rel="nofollow" href="http://localhost/">http://localhost/</a></span>
+Content-Length: 77
+Content-Type: multipart/form-data; boundary=xYzZY
+
+--xYzZY
+Content-Disposition: form-data; name=&#34;submit&#34;
+
+Submit
+--xYzZY--
+EOT
+
+is&#40; $reqstring, $wanted, &#34;Proper posting&#34; &#41;;
+
+$mech-&gt;field&#40;&#39;upload&#39;, &#39;MANIFEST&#39;&#41;;
+$reqstring = $form-&gt;click-&gt;as_string;
+like&#40; $reqstring, qr/Cookbook/, &#39;The uploaded file should be in the request&#39;&#41;;
+
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;18&nbsp;20:20:33&nbsp;2004</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Mon Oct 18 10:08:50 2004]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt;
&gt; &gt; I&#39;m fine with this patch. Would you also be willing to write a
&gt; &gt; Test::More test
&gt; &gt; script, which confirms that this works? There are examples in &#34;t/&#34;
&gt; &gt; directory of
&gt; &gt; the distribution.
</div>&gt; 
&gt; I&#39;m attaching a patch against WWW::Mechanize 1.04.
</div>
This has applied, committed to CVS, and will appear in the next release
of Mech.

Thanks for the high quaity patch Jan. Could you tempt to stick around
and work on some of the other issues in the Mech RT issue tracking
system. :&#41; 

I could ask Andy about arranging CVS &#39;commit&#39; access for you if you were
interested in contributing some on an ongoing basis. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;18&nbsp;20:20:38&nbsp;2004</span>
    <span class="description">MARKSTOS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
