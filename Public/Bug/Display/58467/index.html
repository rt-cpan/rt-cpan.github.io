<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #58467 for MIME-Types: Reading from DATA isn&#39;t working with mod_perl</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #58467 for MIME-Types: Reading from DATA isn&#39;t working with mod_perl</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/MIME-Types/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/MIME-Types/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/MIME-Types/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/MIME-Types/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/MIME-Types">MIME-Types CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">58467</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/MIME-Types/Active/">MIME-Types</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
steve [...] deefs.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-21376-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.29    </td>
  </tr>
  <tr id="CF-21377-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;16&nbsp;18:20:18&nbsp;2010</span>
    <span class="description">steve [...] deefs.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Reading from DATA isn&#39;t working with mod_perl</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Using Apache2 &#40;prefork&#41;, MIME::Types 1.27 works properly, but version
1.29 isn&#39;t consistently loading the entire list of MIME types.  When I
have several children loading the module and doing lookups more or less
simultaneously, some of the children only get part of the list.

It should be possible to reproduce this by putting the following code in
a module that gets read as part of every request:

my $class = MIME::Types-&gt;new&#40;&#41;;
my $mime = $class-&gt;mimeTypeOf&#40;$some_filename_here&#41;;
my $type;
if &#40;defined $mime&#41; {
    $type = $mime-&gt;type&#40;&#41;;
    print STDERR &#34;Found $type &#40;&#34; . scalar&#40;$class-&gt;types&#40;&#41;&#41; . &#34; total&#41;\n&#34;;
}
else {
    print STDERR &#34;Not Found &#40;&#34; . scalar&#40;$class-&gt;types&#40;&#41;&#41; . &#34; total&#41;\n&#34;;
}

When I try it, I&#39;m getting a list of 727 types some of the time, but not
always.  Other times, it&#39;s only returning between 250 and 500 types.

The attached patch file reverts just the change from
$mime_type_definitions to __DATA__, which fixes the problem.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> mime-types.bug.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Types.pm.orig	2010-06-16 17:35:57.871783255 -0400
+++ Types.pm.new	2010-06-16 17:39:18.315780873 -0400
@@ -17,6 +17,8 @@
 my %list;
 sub new&#40;@&#41; { &#40;bless {}, shift&#41;-&gt;init&#40; {@_} &#41; }
 
+my $mime_type_definitions;  # see bottom file
+
 sub init&#40;$&#41;
 {   my &#40;$self, $args&#41; = @_;
 
@@ -24,7 +26,7 @@
     {   local $_;
         local $/  = &#34;\n&#34;;
 
-        while&#40;&lt;DATA&gt;&#41;
+        foreach &#40;split /^/, $mime_type_definitions&#41;
         {   chomp;
             next if !length $_ or substr&#40;$_, 0, 1&#41; eq &#39;#&#39;;
 
@@ -194,14 +196,12 @@
 CROAK
 }
 
-1;
-
 #-------------------------------------------
 # Internet media type registry is at
 # <span class="clickylink"><a target="new" rel="nofollow" href="http://www.iana.org/assignments/media-types/">http://www.iana.org/assignments/media-types/</a></span>
 # Another list can be found at: <span class="clickylink"><a target="new" rel="nofollow" href="http://ftyps.com">http://ftyps.com</a></span>
 
-__DATA__
+$mime_type_definitions = &lt;&lt;__MIMETYPES__;
 application/activemessage
 application/andrew-inset;ez
 application/annodex;anx
@@ -1200,3 +1200,7 @@
 
 # IE6 bug
 image/pjpeg;;base64
+
+__MIMETYPES__
+
+1;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;16&nbsp;18:24:31&nbsp;2010</span>
    <span class="description">steve [...] deefs.net -  Requestor SSIMMS added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people DelWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;16&nbsp;18:24:36&nbsp;2010</span>
    <span class="description">steve [...] deefs.net -  Requestor steve@deefs.net deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;16&nbsp;18:36:50&nbsp;2010</span>
    <span class="description">solutions [...] overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #58467] Reading from DATA isn&#39;t working with mod_perl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 17 Jun 2010 00:36:36 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Steve Simms via RT &lt;bug-MIME-Types [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;solutions [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Steve Simms via RT &#40;bug-MIME-Types@rt.cpan.org&#41; [100616 22:20]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Wed Jun 16 18:20:18 2010: Request 58467 was acted upon.
&gt; Transaction: Ticket created by SSIMMS
&gt;        Queue: MIME-Types
&gt;      Subject: Reading from DATA isn&#39;t working with mod_perl
&gt;    Broken in: 1.29
&gt; 
&gt; Using Apache2 &#40;prefork&#41;, MIME::Types 1.27 works properly, but version
&gt; 1.29 isn&#39;t consistently loading the entire list of MIME types.  When I
&gt; have several children loading the module and doing lookups more or less
&gt; simultaneously, some of the children only get part of the list.
</div>
It is unhealthy to read the whole list in each child: better read it
before the fork.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;16&nbsp;18:36:51&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;16&nbsp;21:17:54&nbsp;2010</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jun 16 18:36:50 2010, solutions@overmeer.net wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It is unhealthy to read the whole list in each child: better read it
&gt; before the fork.
</div>
That works, thanks.  It&#39;s definitely a &#34;gotcha&#34; though.

Another solution that seems to work is to add the following to
MIME/Types.pm:

__PACKAGE__-&gt;init&#40;&#41;;

It may just be playing with the timing, but it&#39;s working consistently on
my server, without needing to add Perl code to the Apache config.

Would it be possible to add that to the distribution, and/or could this
issue be noted in the documentation?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;17&nbsp;03:21:56&nbsp;2010</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #58467] Reading from DATA isn&#39;t working with mod_perl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 17 Jun 2010 09:21:43 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Steve Simms via RT &lt;bug-MIME-Types [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Steve Simms via RT &#40;bug-MIME-Types@rt.cpan.org&#41; [100617 01:17]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: MIME-Types
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=58467">https://rt.cpan.org/Ticket/Display.html?id=58467</a></span> &gt;
&gt; 
&gt; On Wed Jun 16 18:36:50 2010, solutions@overmeer.net wrote:
<div class="message-stanza open">&gt; &gt; It is unhealthy to read the whole list in each child: better read it
&gt; &gt; before the fork.
</div>&gt; 
&gt; That works, thanks.  It&#39;s definitely a &#34;gotcha&#34; though.
</div>
It&#39;s a gotcha from mod_perl, not from my module. Many modules with
will show initiation problems when run under mod_perl.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Another solution that seems to work is to add the following to
&gt; MIME/Types.pm:
&gt; __PACKAGE__-&gt;init&#40;&#41;;
</div>
Well, the &lt;DATA&gt; list is only read once; only with the first call to
MIME::Types-&gt;new.  new&#40;&#41; calls init&#40;&#41;, in some OO fashion.

    my $mimetypes = MIME::Types-&gt;new;
is by far the best way to do it.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Would it be possible to add that to the distribution, and/or could this
&gt; issue be noted in the documentation?
</div>
Where this problem is 100% caused by &#40;mis&#41;behavior of mod_perl, nearly
any other Perl module could add such a warning. All mod_perl books
have a chapter on these issues.  &#40;Creating your own webservers in 
pure perl, f.i. HTTP::Daemon, is very simple&#41;
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;02&nbsp;05:14:45&nbsp;2010</span>
    <span class="description">MARKOV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">not a Mime::Types problem
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;02&nbsp;05:14:46&nbsp;2010</span>
    <span class="description">MARKOV [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;25&nbsp;13:39:34&nbsp;2010</span>
    <span class="description">tlhackque [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> tlhackque [...] yahoo.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jul 02 05:14:45 2010, MARKOV wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; not a Mime::Types problem
</div>
Having just been bitten by this, I respectfully disagree.  

Yes, MOD_PERL does impose some restrictions - but being compatible 
would make MIME::Types more useful.  MOD_PERL is a widely-used 
accelerator for web applications, and can produce 100x performance 
increases for such applications.  I don&#39;t think that MIME::Types should 
be a barrier to its use.

The problem is that on each request, MIME::Types tries to read from 
DATA to rebuild the index - but after the first request serviced by a 
given httpd process, DATA is at EOF.  Of course, this means that no 
types are defined.

Ideally, one would make the indicies persist - which I thought ought to 
be as simple as changing the my&#39;s to our&#39;s.  I&#39;m missing something, 
because that didn&#39;t work.  &#40;My second day with MOD_PERL, so I&#39;m no 
expert.&#41;

As a workaround, I extracted the __DATA__ section to 
MIME::Types.pm.data &#38; made the following changes, which do allow it to 
function.  A permanent solution - preferably a better one from a 
MOD_PERL expert -- would be appreciated.

But even this patch allows my application to run at mod_perl speeds.  

--- /usr/lib/perl5/site_perl/5.8.8/MIME/Types.pm~       2010-06-03 
06:00:43.000000000 -0400
+++ /usr/lib/perl5/site_perl/5.8.8/MIME/Types.pm        2010-08-25 
12:48:40.000000000 -0400
@@ -22,11 +22,17 @@

     unless&#40;keys %list&#41;   # already read
     {   local $_;
         local $/  = &#34;\n&#34;;

-        while&#40;&lt;DATA&gt;&#41;
+       # MOD_PERL doesn&#39;t support &lt;DATA&gt;; copy it out to a .data file.
+       # In particular, it won&#39;t re-seek it to the right place for 
each request.
+       # Install should extract it to a .data file.
+
+       my $f = __FILE__ . &#39;.data&#39;;
+       open&#40; my $fh, &#39;&lt;&#39;, $f &#41; or die &#34;Can&#39;t open data file $f: $!&#34;;
+       while&#40; &lt;$fh&gt; &#41;
         {   chomp;
             next if !length $_ or substr&#40;$_, 0, 1&#41; eq &#39;#&#39;;

             my $os = s/^&#40;\w+&#41;\:// ? qr/$1/i : undef;
             my &#40;$type, $extensions, $encoding&#41; = split /\;/;
@@ -40,11 +46,11 @@
               , extensions =&gt; $extent
               , encoding   =&gt; $encoding
               , system     =&gt; $os
               &#41;;
         }
-        close DATA;
+       close $fh;
     }

     $self;
 }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;25&nbsp;13:39:36&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;25&nbsp;15:33:18&nbsp;2010</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #58467] Reading from DATA isn&#39;t working with mod_perl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 25 Aug 2010 21:33:04 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> via RT &lt;bug-MIME-Types [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">*  via RT &#40;bug-MIME-Types@rt.cpan.org&#41; [100825 17:39]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: MIME-Types
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=58467">https://rt.cpan.org/Ticket/Display.html?id=58467</a></span> &gt;
&gt; 
&gt; On Fri Jul 02 05:14:45 2010, MARKOV wrote:
<div class="message-stanza open">&gt; &gt; not a Mime::Types problem
</div>&gt; 
&gt; Having just been bitten by this, I respectfully disagree.  
&gt; ...
&gt; The problem is that on each request, MIME::Types tries to read from 
&gt; DATA to rebuild the index - but after the first request serviced by a 
&gt; given httpd process, DATA is at EOF.  Of course, this means that no 
&gt; types are defined.
</div>
I know. Modperl does reuse a thread for multiple requests. To do
so, it cleans out the variables but does not restore file-handles.
That&#39;s a very nasty hack.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Ideally, one would make the indicies persist - which I thought ought to 
&gt; be as simple as changing the my&#39;s to our&#39;s.  I&#39;m missing something, 
&gt; because that didn&#39;t work.  &#40;My second day with MOD_PERL, so I&#39;m no 
&gt; expert.&#41;
</div>
If you load MIME::Types before mod-perl/apache starts forking
clients, then all clients will see the table and you do not need
tricks. If I remember well, you should call MIME::Types once within
a BEGIN block or some mod_perl init scripts... that will be much
faster as well, because table processing only works once.

If you use mod_perl, you will suffer the consequences. Each module
you use will need different things to get them to work under mod_perl.
Writing a pure perl webserver without mod_perl of apache is very simple.
That&#39;s what I usually do. F.i. based on HTTP::Daemon.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;20&nbsp;09:11:46&nbsp;2010</span>
    <span class="description">mendoza [...] pvv.ntnu.no -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed 25. aug. 2010 15:33:18, Mark@Overmeer.net wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; *  via RT &#40;bug-MIME-Types@rt.cpan.org&#41; [100825 17:39]:
<div class="message-stanza open">&gt; &gt;        Queue: MIME-Types
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=58467">https://rt.cpan.org/Ticket/Display.html?id=58467</a></span> &gt;
&gt; &gt; 
&gt; &gt; On Fri Jul 02 05:14:45 2010, MARKOV wrote:
<div class="message-stanza open">&gt; &gt; &gt; not a Mime::Types problem
</div>&gt; &gt; 
&gt; &gt; Having just been bitten by this, I respectfully disagree.  
&gt; &gt; ...
&gt; &gt; The problem is that on each request, MIME::Types tries to read from 
&gt; &gt; DATA to rebuild the index - but after the first request serviced by 
</div></div>a 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; given httpd process, DATA is at EOF.  Of course, this means that no 
&gt; &gt; types are defined.
</div>&gt; 
&gt; I know. Modperl does reuse a thread for multiple requests. To do
&gt; so, it cleans out the variables but does not restore file-handles.
&gt; That&#39;s a very nasty hack.
&gt; 
<div class="message-stanza open">&gt; &gt; Ideally, one would make the indicies persist - which I thought 
</div></div>ought to 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; be as simple as changing the my&#39;s to our&#39;s.  I&#39;m missing something, 
&gt; &gt; because that didn&#39;t work.  &#40;My second day with MOD_PERL, so I&#39;m no 
&gt; &gt; expert.&#41;
</div>&gt; 
&gt; If you load MIME::Types before mod-perl/apache starts forking
&gt; clients, then all clients will see the table and you do not need
&gt; tricks. If I remember well, you should call MIME::Types once within
&gt; a BEGIN block or some mod_perl init scripts... that will be much
&gt; faster as well, because table processing only works once.
&gt; 
&gt; If you use mod_perl, you will suffer the consequences. Each module
&gt; you use will need different things to get them to work under mod_perl.
&gt; Writing a pure perl webserver without mod_perl of apache is very 
</div>simple.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; That&#39;s what I usually do. F.i. based on HTTP::Daemon.
</div>

+1 to fixing this for mod_perl, &#40;and no, haven&#39;t really encountered 
similar problems with modern modules&#41;. 

Shouldn&#39;t the list of mimetypes be put in a constant at &#34;compile&#34;-time 
anyway, or are there some really good points in favour of reading it at 
instantiation?

Anyway, we solved it by having this in startup.pl:

BEGIN {
  use MIME::Types;
  my $mimetypes = MIME::Types-&gt;new&#40;&#41;;
}

Thanks for your module, nonetheless! :-&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;21&nbsp;06:38:32&nbsp;2010</span>
    <span class="description">solutions [...] overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #58467] Reading from DATA isn&#39;t working with mod_perl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 21 Oct 2010 12:38:17 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Nicolas Mendoza via RT &lt;bug-MIME-Types [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;solutions [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Nicolas Mendoza via RT &#40;bug-MIME-Types@rt.cpan.org&#41; [101020 15:12]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: MIME-Types
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=58467">https://rt.cpan.org/Ticket/Display.html?id=58467</a></span> &gt;
&gt; 
&gt; +1 to fixing this for mod_perl,
</div>
Fix mod_perl: don&#39;t try to fix the modules which are not broken.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#40;and no, haven&#39;t really encountered similar problems with modern modules&#41;. 
</div>
You&#39;re lucky

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Anyway, we solved it by having this in startup.pl:
&gt; BEGIN {
&gt;   use MIME::Types;
&gt;   my $mimetypes = MIME::Types-&gt;new&#40;&#41;;
&gt; }
</div>
Next version of the module will contain this in the documentation:

  =section MIME::Types and mod_perl

  This module uses a DATA handle to read all the types at first
  instantiation. That doesn&#39;t work well with the module abuse by mod_perl,
  which reuses compiled Perl instances by simply clearing the variables.

  When you use this module with mod_perl, add this to C&lt;startup.pl&gt;

   use MIME::Types;
   BEGIN { MIME::Types-&gt;new&#40;&#41; }

  Now, the type definitions will get parsed before the processes are
  spawned.

In older versions, the whole table was in a single scalar. The table has
recently exploded in size. Perl contains multiple copies of scalars,
for instance to be able to produce in-context error messages. So, the
whole table was copied at least three times. With the DATA section,
only the processed version is kept in memory.

-- 
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;16&nbsp;03:21:24&nbsp;2010</span>
    <span class="description">MARKOV [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">not a bug. Typical mod_perl usage problem
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;16&nbsp;03:21:25&nbsp;2010</span>
    <span class="description">MARKOV [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;09&nbsp;19:27:16&nbsp;2011</span>
    <span class="description">DAMI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Le Jeu 21 Oct 2010 06:38:32, solutions@overmeer.net a écrit :
[...]
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Next version of the module will contain this in the documentation:
&gt;
</div>
Please do include something in the doc as you promised.

We just encountered the same problem in our project and wasted some 
time understanding what was wrong. You may dislike mod_perl, but 
nevertheless there are quite a lot of mod_perl users, so if you can 
make their life better, that&#39;s worth it, isn&#39;t it ?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;09&nbsp;19:27:17&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;16&nbsp;07:10:13&nbsp;2011</span>
    <span class="description">demerphq [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> demerphq [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Nov 16 03:21:24 2010, MARKOV wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; not a bug. Typical mod_perl usage problem
</div>
I don&#39;t agree.  Earlier versions of MIME::Types did not have these problems.

Upgrading to use this code breaks things.

Therefor the code DOES have a bug, in that it assumes that things work a
specific way always when they don&#39;t work that way always.

Revert the code which moves this data to the DATA block, or check if
DATA is *closed* when reading the DATA handle and this stops happening.

Yes, you are right, the BEST solution is to use the workaround and
ensure that the module is loaded pre-fork, but you could easily A&#41; add
check to see if you running under mod-perl, and then a&#41; warn if the data
section is reloaded, and b&#41; ensure that the code works properly, even if
it is efficient. However that means forcing all your mod-perl users to
change their code, when in fact this is triggered by you changing
MIME::Types. That isn&#39;t right.

cheers,
Yves
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;16&nbsp;07:24:06&nbsp;2011</span>
    <span class="description">solutions [...] overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #58467] Reading from DATA isn&#39;t working with mod_perl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 16 May 2011 13:23:46 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> demerphq via RT &lt;bug-MIME-Types [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;solutions [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* demerphq via RT &#40;bug-MIME-Types@rt.cpan.org&#41; [110516 11:10]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: MIME-Types
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=58467">https://rt.cpan.org/Ticket/Display.html?id=58467</a></span> &gt;
&gt; 
&gt; On Tue Nov 16 03:21:24 2010, MARKOV wrote:
<div class="message-stanza open">&gt; &gt; not a bug. Typical mod_perl usage problem
</div>&gt; 
&gt; I don&#39;t agree.  Earlier versions of MIME::Types did not have these problems.
&gt; Upgrading to use this code breaks things.
</div>
True that the previous version worked differently. On the other hand, I
did not change the interface of the module. What you experience is a
nasty consequence of using mod-perl.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Yes, you are right, the BEST solution is to use the workaround and
&gt; ensure that the module is loaded pre-fork, but you could easily A&#41; add
&gt; check to see if you running under mod-perl, and then a&#41; warn if the data
&gt; section is reloaded, and
</div>
I do agree: we should have &#40;A&#41; and &#40;a&#41;. 
Actually, &#40;a&#41; is already supported: you can instantiate as many
Mime::Types objects as you want, the table is only read once.

You may be able to contribute code for &#40;A&#41;. Creating Mime::Type
objects before the fork is far more efficient than later.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; b&#41; ensure that the code works properly, even if it is efficient.
</div>
The code is working properly: it works according to the manual-page.
mod_perl is perl+nasty_tricks.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; However that means forcing all your mod-perl users to
&gt; change their code, when in fact this is triggered by you changing
&gt; MIME::Types. That isn&#39;t right.
</div>
Other people complained that the list of MIME::Types grew that large
that it consumed too much memory and start-up time. Not everyone is
using mod-perl; there are people who run other kinds of applications.
Really!
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;27&nbsp;10:57:41&nbsp;2011</span>
    <span class="description">demerphq [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> demerphq [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon May 16 07:24:06 2011, solutions@overmeer.net wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; * demerphq via RT &#40;bug-MIME-Types@rt.cpan.org&#41; [110516 11:10]:
<div class="message-stanza open">&gt; &gt;        Queue: MIME-Types
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=58467">https://rt.cpan.org/Ticket/Display.html?id=58467</a></span> &gt;
&gt; &gt;
&gt; &gt; On Tue Nov 16 03:21:24 2010, MARKOV wrote:
<div class="message-stanza open">&gt; &gt; &gt; not a bug. Typical mod_perl usage problem
</div>&gt; &gt;
&gt; &gt; I don&#39;t agree.  Earlier versions of MIME::Types did not have these
</div>&gt; problems.
<div class="message-stanza open">&gt; &gt; Upgrading to use this code breaks things.
</div>&gt; 
&gt; True that the previous version worked differently. On the other hand,
&gt; I
&gt; did not change the interface of the module. What you experience is a
&gt; nasty consequence of using mod-perl.
</div>
Combined with a change to the code. :-&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Yes, you are right, the BEST solution is to use the workaround and
&gt; &gt; ensure that the module is loaded pre-fork, but you could easily A&#41;
</div>&gt; add
<div class="message-stanza open">&gt; &gt; check to see if you running under mod-perl, and then a&#41; warn if the
</div>&gt; data
<div class="message-stanza open">&gt; &gt; section is reloaded, and
</div>&gt; 
&gt; I do agree: we should have &#40;A&#41; and &#40;a&#41;.
&gt; Actually, &#40;a&#41; is already supported: you can instantiate as many
&gt; Mime::Types objects as you want, the table is only read once.
&gt; 
&gt; You may be able to contribute code for &#40;A&#41;. Creating Mime::Type
&gt; objects before the fork is far more efficient than later.
</div>
If you want a patch I can arrange that no problem.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; b&#41; ensure that the code works properly, even if it is efficient.
</div>&gt; 
&gt; The code is working properly: it works according to the manual-page.
&gt; mod_perl is perl+nasty_tricks.
</div>
I don&#39;t think this is relevant. mod_perl is part of the perl universe,
and if the only that changes in a system is this module and things start
breaking then I think it is fair to hold the module to account.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; However that means forcing all your mod-perl users to
&gt; &gt; change their code, when in fact this is triggered by you changing
&gt; &gt; MIME::Types. That isn&#39;t right.
</div>&gt; 
&gt; Other people complained that the list of MIME::Types grew that large
&gt; that it consumed too much memory and start-up time. Not everyone is
&gt; using mod-perl; there are people who run other kinds of applications.
&gt; Really!
</div>
This doesn&#39;t make sense. You are saying that breaking your mod_perl user
base is an acceptable tradeoff for reducing memory footprint. Forcing
all your mod_perl users to change their code so that other users can
have a reduced memory footprint does not seem like a very neighborly
solution. Why are they more important than us? Why is reduced memory
footprint more important than broken systems?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;14&nbsp;11:14:50&nbsp;2011</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #58467] Reading from DATA isn&#39;t working with mod_perl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 14 Jun 2011 17:14:35 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> demerphq via RT &lt;bug-MIME-Types [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* demerphq via RT &#40;bug-MIME-Types@rt.cpan.org&#41; [110527 14:57]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: MIME-Types
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=58467">https://rt.cpan.org/Ticket/Display.html?id=58467</a></span> &gt;
&gt; 
&gt; On Mon May 16 07:24:06 2011, solutions@overmeer.net wrote:
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; What you experience is a nasty consequence of using mod-perl.
</div>&gt; Combined with a change to the code. :-&#41;
</div>
There is no release without change of code.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt;&gt;&gt; Yes, you are right, the BEST solution is to use the workaround and
&gt;&gt;&gt; ensure that the module is loaded pre-fork, but you could easily A&#41;
&gt;&gt;&gt; add check to see if you running under mod-perl
</div>&gt;&gt; You may be able to contribute code for &#40;A&#41;. Creating Mime::Type
&gt;&gt; objects before the fork is far more efficient than later.
</div></div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If you want a patch I can arrange that no problem.
</div>
Yes please.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;17&nbsp;10:44:50&nbsp;2011</span>
    <span class="description">hdp [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon May 16 07:24:06 2011, solutions@overmeer.net wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; mod_perl is perl+nasty_tricks.
</div>
mod_perl is, in this regard, working exactly like any other preforking
server.  Its &#34;nasty tricks&#34; are a red herring; they exist but have
nothing to do with this problem.  In particular, the stuff mod_perl does
with clearing symbol tables &#40;or whatever&#41; is irrelevant -- you can
reproduce the problem with a one-liner:

perl -e &#39;use MIME::Types; for &#40;1..10&#41; { fork || last; wait } warn &#34;$$: &#34;
. MIME::Types::by_suffix&#40;&#34;rtf&#34;&#41;-&gt;[0]&#39;
809: text/rtf at -e line 1.
810:  at -e line 1.
811:  at -e line 1.
812:  at -e line 1.
813:  at -e line 1.
814:  at -e line 1.
815:  at -e line 1.
816:  at -e line 1.
818:  at -e line 1.
819:  at -e line 1.
808:  at -e line 1.

This bug bit me in a fastcgi daemon, where I followed the incredibly
common practice of loading modules in the parent process that may not be
used until after forking.

Nothing in the documentation indicates that this incredibly common
practice won&#39;t work with MIME::Types, so I find your insistence that
it&#39;s &#34;100% caused by &#40;mis&#41;behavior of mod_perl&#34; a little hard to swallow.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;18&nbsp;17:34:00&nbsp;2011</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #58467] Reading from DATA isn&#39;t working with mod_perl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 18 Aug 2011 23:33:45 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Hans Dieter Pearcey via RT &lt;bug-MIME-Types [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Hans Dieter Pearcey via RT &#40;bug-MIME-Types@rt.cpan.org&#41; [110817 14:45]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: MIME-Types
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=58467">https://rt.cpan.org/Ticket/Display.html?id=58467</a></span> &gt;
&gt; 
&gt; mod_perl is, in this regard, working exactly like any other preforking
&gt; server.  Its &#34;nasty tricks&#34; are a red herring; they exist but have
&gt; nothing to do with this problem.
</div>
Multiprocessing is not supported by Perl, although you may use fork&#40;&#41; if
you understand what you are doing.  One of the things is that it always
causes problems with programs using DATA handles, END, DESTROY, %SIG,
AUTOLOAD, etc.

On the other hand, adding a simple seek to the code will make it work
for people who use fork or mod_perl without reading the man-pages,
although slow because each process parses the huge table again.

Just released as 1.32
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;25&nbsp;08:57:20&nbsp;2012</span>
    <span class="description">MARKOV [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
