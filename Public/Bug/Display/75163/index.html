<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #75163 for DBD-Oracle: bug with BFILEs and ora_auto_lob=&gt;0 in DBD::Oracle?</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #75163 for DBD-Oracle: bug with BFILEs and ora_auto_lob=&gt;0 in DBD::Oracle?</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-Oracle/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-Oracle/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-Oracle/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-Oracle/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/pythian/DBD-Oracle/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-Oracle">DBD-Oracle CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">75163</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-Oracle/Active/">DBD-Oracle</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
norbert.debes [...] oradbpro.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10192-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10193-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.43_00    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;20&nbsp;10:55:08&nbsp;2012</span>
    <span class="description">norbert.debes [...] oradbpro.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> bug with BFILEs and ora_auto_lob=&gt;0 in DBD::Oracle?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 20 Feb 2012 16:54:39 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Oracle [...] rt.cpan.org, timb [...] cpan.org, yanick [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Norbert Debes &lt;norbert.debes [...] oradbpro.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Tim, Yannick,

I&#39;d like to report this issue on the otherwise excellent Perl DBI and 
DBD::Oracle.

It seems that BFILEs don&#39;t work with ora_auto_lob =&gt; 0 in DBD::Oracle.

The problem appears to be that BFILEs need to be *explicitly opened*. 
There is also a separate constant in OCI for BFILEs which I guess would 
be worth adding to DBD::Oracle. This constant does not seem to be 
available in DBD::Oracle. Page 2-10 in 11.2 OCI manual has this table:
Table 2--2 Descriptor Types
Description C Datatype OCI Type Constant
snapshot descriptor OCISnapshot OCI_DTYPE_SNAP
result set descriptor OCIResult OCI_DTYPE_RSET
*LOB datatype locator OCILobLocator OCI_DTYPE_LOB
BFILE datatype locator OCILobLocator OCI_DTYPE_FILE*



Here&#39;s what happens when I run the attached program/testcase:
E:\home\ndebes\it\perl&gt;perl bfiledmp.pl
DBI version 1.616 DBD version 1.30
File size 181120 bytes
BFILE LOB locator: OCILobLocatorPtr=SCALAR&#40;0x95377c&#41;; ora_lob_is_init: 1
BFILE LOB locator: OCILobLocatorPtr=SCALAR&#40;0x95377c&#41;; ora_lob_is_init: 1
DBD::Oracle::db ora_lob_read failed: ORA-22289: cannot perform FILEREAD 
operation on an unopened file or LOB &#40;DBD ERROR: OCILobRead&#41; at 
bfiledmp.pl line 401.
ora_lob_read returned 0 bytes

I&#39;m trying to read the alert log over Oracle Net and TCP/IP as part of 
some monitoring routine. Since the alert log is appended to I want to 
read only the additional lines. That&#39;s not possible with ora_auto_lob =&gt; 
1 which places the entire file&#39;s contents into a variable value.
On 2/20/2012 13:51, Cornel Albert wrote:
  If you have a running Oracle instance, create a directory like this:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">SQL&gt; col bdump new_value bdump
SQL&gt; select value as bdump from v$parameter where 
</div>name=&#39;background_dump_dest&#39;;

BDUMP
--------------------------------------------------------------------------------
C:\software\oracle\diag\rdbms\eleven2\eleven2\trace

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">SQL&gt; create or replace directory BACKGROUND_DUMP_DEST as &#39;&#38;bdump&#39;;
</div>old   1: create or replace directory BACKGROUND_DUMP_DEST as &#39;&#38;bdump&#39;
new   1: create or replace directory BACKGROUND_DUMP_DEST as 
&#39;C:\software\oracle\diag\rdbms\eleven2\eleven2\trace&#39;

Directory created.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">SQL&gt; select * from dba_directories where 
</div>directory_name=&#39;BACKGROUND_DUMP_DEST&#39;;

OWNER                          DIRECTORY_NAME
------------------------------ ------------------------------
DIRECTORY_PATH
--------------------------------------------------------------------------------
SYS                            BACKGROUND_DUMP_DEST
C:\software\oracle\diag\rdbms\eleven2\eleven2\trace


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">SQL&gt; $dir 
</div>C:\software\oracle\diag\rdbms\eleven2\eleven2\trace\alert_eleven2.log
C:\\software\\oracle\\diag\\rdbms\\eleven2\\eleven2\\trace\\alert_eleven2.log

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">SQL&gt; $ls -l 
</div>C:\software\oracle\diag\rdbms\eleven2\eleven2\trace\alert_eleven2.log
-rw-r--r-- 1 ndebes None 181276 Feb 20 16:43 
C:\software\oracle\diag\rdbms\eleven2\eleven2\trace\alert_eleven2.log

Now you can read alert_&lt;ORACLE_SID&gt;.log over Oracle Net as a BFILE.

Testcase attached.

/Here&#39;s a little tidbit: while Oracle failed to document the new SYSASM 
feature in the Oracle® Call Interface Programmer&#39;s Guide 11g Release 2 
&#40;11.2&#41; E10646-04 October 2009 you&#39;ve already documented it and 
DBD::Oracle supports it. Good job!/


-- 
Mit freundlichen Grüßen/Kind regards

Norbert Debes

Hinweis: Kontaktdaten s. angehängte vcard/Note: contact information in attached vcard
</div></div>

<div class="messagebody">
</div>
</div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;01&nbsp;16:06:05&nbsp;2012</span>
    <span class="description">champoux [...] pythian.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Norbert,

Thanks for the report and the example script. I have a favor to ask you:
could you try to take the example and reduce it to the minimal code
required to show the bug? I&#39;m hoping that a little bit of its 400+ lines
of code are not necessary to illustrate the issue. :-&#41;

Joy,
`/anick
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;01&nbsp;16:06:06&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;02&nbsp;04:43:58&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Feb 20 10:55:08 2012, norbert.debes@oradbpro.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Tim, Yannick,
&gt; 
&gt; I&#39;d like to report this issue on the otherwise excellent Perl DBI and
&gt; DBD::Oracle.
&gt; 
&gt; It seems that BFILEs don&#39;t work with ora_auto_lob =&gt; 0 in DBD::Oracle.
&gt; 
</div>&lt;snipped&gt;

When I follow your instructions and change your code for my system and 
run it without any arguments I get:

DBI version 1.618 DBD version 1.38
File size 13515393 bytes
BFILE LOB locator: OCILobLocatorPtr=SCALAR&#40;0x9bef200&#41;; ora_lob_is_init: 
1
BFILE LOB locator: OCILobLocatorPtr=SCALAR&#40;0x9bef200&#41;; ora_lob_is_init: 
1
DBD::Oracle::db ora_lob_read failed: ORA-22289: cannot perform FILEREAD 
operation on an unopened file or LOB &#40;DBD ERROR: OCILobRead&#41; at 
rt75163.pl line 402.
ora_lob_read returned 0 bytes

Is that what you expect to happen before I try and look into this?

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;02&nbsp;05:38:56&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Feb 20 10:55:08 2012, norbert.debes@oradbpro.com wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; There is also a separate constant in OCI for BFILEs which I guess
&gt; would
&gt; be worth adding to DBD::Oracle. This constant does not seem to be
&gt; available in DBD::Oracle. Page 2-10 in 11.2 OCI manual has this table:
&gt; Table 2--2 Descriptor Types
&gt; Description C Datatype OCI Type Constant
&gt; snapshot descriptor OCISnapshot OCI_DTYPE_SNAP
&gt; result set descriptor OCIResult OCI_DTYPE_RSET
&gt; *LOB datatype locator OCILobLocator OCI_DTYPE_LOB
&gt; BFILE datatype locator OCILobLocator OCI_DTYPE_FILE*
</div>
Interestingly DBD::Oracle does define ORA_BFILE in Oracle.h like this:

#define ORA_BFILE                       114

but never exports it. It is easy to export it but I&#39;m not sure on the 
value as a grep for 114 and OCI_DTYPE_FILE in the instant client headers 
returns:

ocidfn.h:#define SQLT_BFILEE 114    
oci.h:#define OCI_DTYPE_FILE 56        

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;02&nbsp;08:08:37&nbsp;2012</span>
    <span class="description">norbert.debes [...] oradbpro.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75163] bug with BFILEs and ora_auto_lob=&gt;0 in DBD::Oracle?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 02 Mar 2012 14:08:16 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Oracle [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Norbert Debes &lt;norbert.debes [...] oradbpro.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Martin,

yes, that&#39;s the same error I had. Thanks for reproducing it. The Oracle 
DBMS requires that the BFILE be opened explicitly, hence the error:

ORA-22289: cannot perform FILEREAD operation on an unopened file or LOB

It sounds like the DBD::Oracle code does not realize that it is dealing 
with a BFILE Lob locator and does not explicitly open the BFILE behind 
the scenes.
I tried opening the BFILE using dbms_lob.open, but then I get a 
different error that suggests the BFILE Lob locator is not passed 
correctly to DBMS_LOB.

It seems to me that the BFILE does get opened behind the scenes with 
ora_auto_lob =&gt; 1, but with ora_auto_lob =&gt; 0 it does. Maybe you can 
veriry my theory.

The goal is to read files on the database server piece by piece &#40;hence 
ora_auto_lob =&gt; 0&#41; over an Oracle Net connection.

I suppose the goal is clear. I&#39;d he happy to discuss with you over the 
phone or Skype if you think that would help.

Mit freundlichen Grüßen/Kind regards

Norbert Debes

Hinweis: Kontaktdaten s. angehängte vcard/Note: contact information in attached vcard


On 3/2/2012 10:43, Martin J Evans via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75163">https://rt.cpan.org/Ticket/Display.html?id=75163</a></span>&gt;
&gt;
&gt; On Mon Feb 20 10:55:08 2012, norbert.debes@oradbpro.com wrote:
<div class="message-stanza open">&gt;&gt; Hi Tim, Yannick,
&gt;&gt;
&gt;&gt; I&#39;d like to report this issue on the otherwise excellent Perl DBI and
&gt;&gt; DBD::Oracle.
&gt;&gt;
&gt;&gt; It seems that BFILEs don&#39;t work with ora_auto_lob =&gt;  0 in DBD::Oracle.
&gt;&gt;
</div>&gt; &lt;snipped&gt;
&gt;
&gt; When I follow your instructions and change your code for my system and
&gt; run it without any arguments I get:
&gt;
&gt; DBI version 1.618 DBD version 1.38
&gt; File size 13515393 bytes
&gt; BFILE LOB locator: OCILobLocatorPtr=SCALAR&#40;0x9bef200&#41;; ora_lob_is_init:
&gt; 1
&gt; BFILE LOB locator: OCILobLocatorPtr=SCALAR&#40;0x9bef200&#41;; ora_lob_is_init:
&gt; 1
&gt; DBD::Oracle::db ora_lob_read failed: ORA-22289: cannot perform FILEREAD
&gt; operation on an unopened file or LOB &#40;DBD ERROR: OCILobRead&#41; at
&gt; rt75163.pl line 402.
&gt; ora_lob_read returned 0 bytes
&gt;
&gt; Is that what you expect to happen before I try and look into this?
&gt;
&gt; Martin
</div></div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;02&nbsp;08:10:59&nbsp;2012</span>
    <span class="description">norbert.debes [...] oradbpro.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75163] bug with BFILEs and ora_auto_lob=&gt;0 in DBD::Oracle?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 02 Mar 2012 14:10:29 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Oracle [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Norbert Debes &lt;norbert.debes [...] oradbpro.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">yep, interesting

Mit freundlichen Grüßen/Kind regards

Norbert Debes

Hinweis: Kontaktdaten s. angehängte vcard/Note: contact information in attached vcard


On 3/2/2012 11:38, Martin J Evans via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75163">https://rt.cpan.org/Ticket/Display.html?id=75163</a></span>&gt;
&gt;
&gt; On Mon Feb 20 10:55:08 2012, norbert.debes@oradbpro.com wrote:
&gt;
<div class="message-stanza open">&gt;&gt; There is also a separate constant in OCI for BFILEs which I guess
&gt;&gt; would
&gt;&gt; be worth adding to DBD::Oracle. This constant does not seem to be
&gt;&gt; available in DBD::Oracle. Page 2-10 in 11.2 OCI manual has this table:
&gt;&gt; Table 2--2 Descriptor Types
&gt;&gt; Description C Datatype OCI Type Constant
&gt;&gt; snapshot descriptor OCISnapshot OCI_DTYPE_SNAP
&gt;&gt; result set descriptor OCIResult OCI_DTYPE_RSET
&gt;&gt; *LOB datatype locator OCILobLocator OCI_DTYPE_LOB
&gt;&gt; BFILE datatype locator OCILobLocator OCI_DTYPE_FILE*
</div>&gt; Interestingly DBD::Oracle does define ORA_BFILE in Oracle.h like this:
&gt;
&gt; #define ORA_BFILE                     114
&gt;
&gt; but never exports it. It is easy to export it but I&#39;m not sure on the
&gt; value as a grep for 114 and OCI_DTYPE_FILE in the instant client headers
&gt; returns:
&gt;
&gt; ocidfn.h:#define SQLT_BFILEE 114
&gt; oci.h:#define OCI_DTYPE_FILE 56
&gt;
&gt; Martin
</div></div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;02&nbsp;13:02:21&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Mar 02 08:08:37 2012, norbert.debes@oradbpro.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Martin,
&gt; 
&gt; yes, that&#39;s the same error I had. Thanks for reproducing it. The
&gt; Oracle
&gt; DBMS requires that the BFILE be opened explicitly, hence the error:
&gt; 
&gt; ORA-22289: cannot perform FILEREAD operation on an unopened file or
&gt; LOB
&gt; 
&gt; It sounds like the DBD::Oracle code does not realize that it is
&gt; dealing
&gt; with a BFILE Lob locator and does not explicitly open the BFILE behind
&gt; the scenes.
&gt; I tried opening the BFILE using dbms_lob.open, but then I get a
&gt; different error that suggests the BFILE Lob locator is not passed
&gt; correctly to DBMS_LOB.
&gt; 
&gt; It seems to me that the BFILE does get opened behind the scenes with
&gt; ora_auto_lob =&gt; 1, but with ora_auto_lob =&gt; 0 it does. Maybe you can
&gt; veriry my theory.
</div>
I presume you mean with ora_auto_lob = 0 it does NOT.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The goal is to read files on the database server piece by piece &#40;hence
&gt; ora_auto_lob =&gt; 0&#41; over an Oracle Net connection.
&gt; 
&gt; I suppose the goal is clear. I&#39;d he happy to discuss with you over the
&gt; phone or Skype if you think that would help.
</div>
I need to look at the code and try and figure it out - I don&#39;t use
BFILEs and I did not write the original code. I&#39;m also pushed for time
right now. You can find me on irc.perl.org channel #dbi as mje most days
and some evenings.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;03&nbsp;04:25:27&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Mar 02 13:02:21 2012, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I need to look at the code and try and figure it out - I don&#39;t use
&gt; BFILEs and I did not write the original code. I&#39;m also pushed for time
&gt; right now. You can find me on irc.perl.org channel #dbi as mje most days
&gt; and some evenings.
&gt; 
&gt; Martin
</div>
You are correct. The code is not calling OCILobFileOpen and
OCILobFileClose when ora_auto_lobs = 0. I&#39;ll try and find some time to
fix it.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;03&nbsp;05:53:20&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Mar 03 04:25:27 2012, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Mar 02 13:02:21 2012, MJEVANS wrote:
<div class="message-stanza open">&gt; &gt; I need to look at the code and try and figure it out - I don&#39;t use
&gt; &gt; BFILEs and I did not write the original code. I&#39;m also pushed for time
&gt; &gt; right now. You can find me on irc.perl.org channel #dbi as mje most days
&gt; &gt; and some evenings.
&gt; &gt; 
&gt; &gt; Martin
</div>&gt; 
&gt; You are correct. The code is not calling OCILobFileOpen and
&gt; OCILobFileClose when ora_auto_lobs = 0. I&#39;ll try and find some time to
&gt; fix it.
&gt; 
&gt; Martin
</div>
The problem is the code which reads a lob is in Oracle.xs and is only
passed the connection handle and the lob locator. I don&#39;t know how to
tell the passed lob locator is a BFILE &#40;any ideas?&#41;. I could try calling
OCILobFileIsOpen but I don&#39;t know what would happen if it was not a
BFILE locator.

Then there is the problem of when to close it - OCILobFileClose, as the
caller may not read all the lob but there must be some clean up code
somewhere for locators.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;03&nbsp;06:12:24&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Mar 03 05:53:20 2012, MJEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sat Mar 03 04:25:27 2012, MJEVANS wrote:
<div class="message-stanza open">&gt; &gt; On Fri Mar 02 13:02:21 2012, MJEVANS wrote:
<div class="message-stanza open">&gt; &gt; &gt; I need to look at the code and try and figure it out - I don&#39;t use
&gt; &gt; &gt; BFILEs and I did not write the original code. I&#39;m also pushed for time
&gt; &gt; &gt; right now. You can find me on irc.perl.org channel #dbi as mje
</div></div></div>most days
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; and some evenings.
&gt; &gt; &gt; 
&gt; &gt; &gt; Martin
</div>&gt; &gt; 
&gt; &gt; You are correct. The code is not calling OCILobFileOpen and
&gt; &gt; OCILobFileClose when ora_auto_lobs = 0. I&#39;ll try and find some time to
&gt; &gt; fix it.
&gt; &gt; 
&gt; &gt; Martin
</div>&gt; 
&gt; The problem is the code which reads a lob is in Oracle.xs and is only
&gt; passed the connection handle and the lob locator. I don&#39;t know how to
&gt; tell the passed lob locator is a BFILE &#40;any ideas?&#41;. I could try calling
&gt; OCILobFileIsOpen but I don&#39;t know what would happen if it was not a
&gt; BFILE locator.
&gt; 
&gt; Then there is the problem of when to close it - OCILobFileClose, as the
&gt; caller may not read all the lob but there must be some clean up code
&gt; somewhere for locators.
&gt; 
&gt; Martin
</div>
This patch makes it work but is far from complete as:

1. it does not trace the call to OCILobFileIsOpen
2. it does not close the bfile at all so probably leaks something

It is a diff from the subversion trunk.

Index: Oracle.xs
===================================================================
--- Oracle.xs   &#40;revision 15190&#41;
+++ Oracle.xs   &#40;working copy&#41;
@@ -560,6 +560,20 @@
        dest_sv = &#38;PL_sv_undef;
                return;
        }
+    {
+        boolean is_open;
+        
+        status = OCILobFileIsOpen&#40;imp_dbh-&gt;svchp, imp_dbh-&gt;errhp,
locator, &#38;is_open&#41;;
+        if &#40;status == OCI_SUCCESS &#38;&#38; !is_open&#41; {
+            OCILobFileOpen_log_stat&#40;imp_dbh-&gt;svchp, imp_dbh-&gt;errhp,
locator,
+                                    &#40;ub1&#41;OCI_FILE_READONLY, status&#41;;
+            if &#40;status != OCI_SUCCESS&#41; {
+                oci_error&#40;dbh, imp_dbh-&gt;errhp, status, &#34;OCILobFileOpen&#34;&#41;;
+                dest_sv = &#38;PL_sv_undef;
+            }
+        }
+    }
+    
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;03&nbsp;06:46:46&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here is a more complete patch - just missing tracing now.

Seems to work and seems to still pass all the existing tests.

The diff is against subversion trunk and has some other things in I&#39;m
working on too.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> x.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: oci8.c
===================================================================
--- oci8.c	&#40;revision 15202&#41;
+++ oci8.c	&#40;working copy&#41;
@@ -4651,7 +4651,7 @@
 
 	for&#40;i=0; i &lt; lr-&gt;num_fields; ++i&#41; {
 		imp_fbh_t *fbh = &#38;lr-&gt;fbh_ary[i];
-		ora_free_fbh_contents&#40;fbh&#41;;
+		ora_free_fbh_contents&#40;sth, fbh&#41;;
 	}
 	sv_free&#40;lr-&gt;fbh_ary_sv&#41;;
 	Safefree&#40;imp_sth-&gt;lob_refetch&#41;;
Index: lib/DBD/Oracle.pm
===================================================================
--- lib/DBD/Oracle.pm	&#40;revision 15202&#41;
+++ lib/DBD/Oracle.pm	&#40;working copy&#41;
@@ -29,7 +29,7 @@
       ora_types =&gt; [ qw&#40;
 	    ORA_VARCHAR2 ORA_STRING ORA_NUMBER ORA_LONG ORA_ROWID ORA_DATE
 	    ORA_RAW ORA_LONGRAW ORA_CHAR ORA_CHARZ ORA_MLSLABEL ORA_XMLTYPE
-	    ORA_CLOB ORA_BLOB ORA_RSET ORA_VARCHAR2_TABLE ORA_NUMBER_TABLE
+	    ORA_CLOB ORA_BLOB ORA_BFILE ORA_RSET ORA_VARCHAR2_TABLE ORA_NUMBER_TABLE
 	    SQLT_INT SQLT_FLT ORA_OCI SQLT_CHR SQLT_BIN
 	&#41; ],
         ora_session_modes =&gt; [ qw&#40; ORA_SYSDBA ORA_SYSOPER ORA_SYSASM&#41; ],
@@ -1201,7 +1201,7 @@
   ORA_VARCHAR2 ORA_STRING ORA_NUMBER ORA_LONG ORA_ROWID ORA_DATE ORA_RAW
   ORA_LONGRAW ORA_CHAR ORA_CHARZ ORA_MLSLABEL ORA_XMLTYPE ORA_CLOB ORA_BLOB
   ORA_RSET ORA_VARCHAR2_TABLE ORA_NUMBER_TABLE SQLT_INT SQLT_FLT ORA_OCI
-  SQLT_CHR SQLT_BIN
+  SQLT_CHR SQLT_BIN ORA_BFILE
 
 =item SQLCS_IMPLICIT
 
Index: dbdimp.c
===================================================================
--- dbdimp.c	&#40;revision 15202&#41;
+++ dbdimp.c	&#40;working copy&#41;
@@ -3197,7 +3197,7 @@
 		if &#40;SvPVX&#40;sv&#41;&#41; {
 			SvCUR_set&#40;sv, phs-&gt;alen&#41;;
 			*SvEND&#40;sv&#41; = &#39;\0&#39;;
-			SvPOK_only_UTF8&#40;sv&#41;;
+            SvPOK_only_UTF8&#40;sv&#41;;
             if &#40;CSFORM_IMPLIES_UTF8&#40;SQLCS_IMPLICIT&#41;&#41; {
 #ifdef sv_utf8_decode
                 sv_utf8_decode&#40;sv&#41;;
@@ -3205,6 +3205,13 @@
                 SvUTF8_on&#40;sv&#41;;
 #endif
             }
+            if &#40;CSFORM_IMPLIES_UTF8&#40;SQLCS_IMPLICIT&#41;&#41; {
+#ifdef sv_utf8_decode
+                sv_utf8_decode&#40;sv&#41;;
+#else
+                SvUTF8_on&#40;sv&#41;;
+#endif
+            }
 		}
 		else {	/* shouldn&#39;t happen */
 			debug = 2;
@@ -3977,16 +3984,34 @@
 
 
 void
-ora_free_fbh_contents&#40;imp_fbh_t *fbh&#41;
+ora_free_fbh_contents&#40;SV *sth, imp_fbh_t *fbh&#41;
 {
 	dTHX;
+    D_imp_sth&#40;sth&#41;;
+    D_imp_dbh_from_sth;
+
 	if &#40;fbh-&gt;fb_ary&#41;
 	fb_ary_free&#40;fbh-&gt;fb_ary&#41;;
 	sv_free&#40;fbh-&gt;name_sv&#41;;
-	if &#40;fbh-&gt;desc_h&#41;
-	OCIDescriptorFree_log&#40;fbh-&gt;desc_h, fbh-&gt;desc_t&#41;;
-	if &#40;fbh-&gt;obj&#41;
+	if &#40;fbh-&gt;desc_h&#41; {
+        boolean is_open;
+        sword status;
+        
+        status = OCILobFileIsOpen&#40;imp_dbh-&gt;svchp, imp_dbh-&gt;errhp, fbh-&gt;desc_h, &#38;is_open&#41;;
+        if &#40;status == OCI_SUCCESS &#38;&#38; is_open&#41; {
+            OCILobFileClose_log_stat&#40;imp_sth-&gt;svchp, imp_sth-&gt;errhp,
+                                     fbh-&gt;desc_h, status&#41;;
+        }
+        
+
+        OCIDescriptorFree_log&#40;fbh-&gt;desc_h, fbh-&gt;desc_t&#41;;
+    }
+    
+	if &#40;fbh-&gt;obj&#41; {
+		if &#40;fbh-&gt;obj-&gt;obj_value&#41; 
+			OCIObjectFree&#40;fbh-&gt;imp_sth-&gt;envhp, fbh-&gt;imp_sth-&gt;errhp, fbh-&gt;obj-&gt;obj_value, &#40;ub2&#41;0&#41;;
 		Safefree&#40;fbh-&gt;obj&#41;;
+	}
 
 }
 
@@ -4092,7 +4117,7 @@
 	imp_sth-&gt;eod_errno = 1403;
 	for&#40;i=0; i &lt; fields; ++i&#41; {
 		imp_fbh_t *fbh = &#38;imp_sth-&gt;fbh[i];
-		ora_free_fbh_contents&#40;fbh&#41;;
+		ora_free_fbh_contents&#40;sth, fbh&#41;;
 	}
 	Safefree&#40;imp_sth-&gt;fbh&#41;;
 	if &#40;imp_sth-&gt;fbh_cbuf&#41;
Index: dbdimp.h
===================================================================
--- dbdimp.h	&#40;revision 15202&#41;
+++ dbdimp.h	&#40;working copy&#41;
@@ -321,7 +321,7 @@
 void dbd_init_oci _&#40;&#40;dbistate_t *dbistate&#41;&#41;;
 void dbd_preparse _&#40;&#40;imp_sth_t *imp_sth, char *statement&#41;&#41;;
 void dbd_fbh_dump&#40;imp_fbh_t *fbh, int i, int aidx&#41;;
-void ora_free_fbh_contents _&#40;&#40;imp_fbh_t *fbh&#41;&#41;;
+void ora_free_fbh_contents _&#40;&#40;SV *sth, imp_fbh_t *fbh&#41;&#41;;
 void ora_free_templob _&#40;&#40;SV *sth, imp_sth_t *imp_sth, OCILobLocator *lobloc&#41;&#41;;
 int ora_dbtype_is_long _&#40;&#40;int dbtype&#41;&#41;;
 fb_ary_t *fb_ary_alloc _&#40;&#40;ub4 bufl, int size&#41;&#41;;
Index: Oracle.xs
===================================================================
--- Oracle.xs	&#40;revision 15202&#41;
+++ Oracle.xs	&#40;working copy&#41;
@@ -24,6 +24,7 @@
 	ORA_XMLTYPE	 = ORA_XMLTYPE
 	ORA_CLOB	 = ORA_CLOB
 	ORA_BLOB	 = ORA_BLOB
+    ORA_BFILE    = ORA_BFILE
 	ORA_RSET	 = ORA_RSET
 	ORA_VARCHAR2_TABLE	= ORA_VARCHAR2_TABLE
 	ORA_NUMBER_TABLE	= ORA_NUMBER_TABLE
@@ -560,6 +561,20 @@
 	dest_sv = &#38;PL_sv_undef;
 		return;
 	}
+    {
+        boolean is_open;
+        
+        status = OCILobFileIsOpen&#40;imp_dbh-&gt;svchp, imp_dbh-&gt;errhp, locator, &#38;is_open&#41;;
+        if &#40;status == OCI_SUCCESS &#38;&#38; !is_open&#41; {
+            OCILobFileOpen_log_stat&#40;imp_dbh-&gt;svchp, imp_dbh-&gt;errhp, locator,
+                                    &#40;ub1&#41;OCI_FILE_READONLY, status&#41;;
+            if &#40;status != OCI_SUCCESS&#41; {
+                oci_error&#40;dbh, imp_dbh-&gt;errhp, status, &#34;OCILobFileOpen&#34;&#41;;
+                dest_sv = &#38;PL_sv_undef;
+            }
+        }
+    }
+    
 	OCILobRead_log_stat&#40;imp_dbh-&gt;svchp, imp_dbh-&gt;errhp, locator,
 		&#38;amtp, &#40;ub4&#41;offset, /* offset starts at 1 */
 		bufp, &#40;ub4&#41;bufp_len,
Index: t/31lob.t
===================================================================
--- t/31lob.t	&#40;revision 15202&#41;
+++ t/31lob.t	&#40;working copy&#41;
@@ -8,8 +8,8 @@
 unshift @INC ,&#39;t&#39;;
 require &#39;nchar_test_lib.pl&#39;;
 
-plan skip_all =&gt; &#34;see RT#69350&#34;
-    if ORA_OCI&#40;&#41; =~ /^11\.2\./;
+#plan skip_all =&gt; &#34;see RT#69350&#34;
+#    if ORA_OCI&#40;&#41; =~ /^11\.2\./;
 
 my $dbh;
 $| = 1;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;03&nbsp;16:28:56&nbsp;2012</span>
    <span class="description">norbert.debes [...] oradbpro.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75163] bug with BFILEs and ora_auto_lob=&gt;0 in DBD::Oracle?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 03 Mar 2012 21:42:13 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Oracle [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Norbert Debes &lt;norbert.debes [...] oradbpro.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Martin,

thank you very much for working on this issue.
How about adding functions oralobopen und oralobclose? In my view it 
would be ok to have to call these explicitly when working with BFILEs.
You&#39;re right, something will be leaking. This week I ran some PL/SQL 
code that opened BFILEs but did not close them. It hit an error rather 
quickly. I just took some minutes to reproduce the error - so here it is:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">SQL&gt; declare
</div>     v_bfile bfile;
begin
     select bfilename&#40;&#39;ADR_TRACE&#39;, &#39;alert_ELEVEN2.log&#39;&#41; into v_bfile 
from dual;
     dbms_lob.open&#40;v_bfile, dbms_lob.file_readonly&#41;;
end;
/

declare
*
ERROR at line 1:
ORA-22290: operation would exceed the maximum number of opened files or LOBs
ORA-06512: at &#34;SYS.DBMS_LOB&#34;, line 1014
ORA-06512: at line 5

It depends on this parameter:
session_max_open_files               integer     10

I suppose the only way to fix it properly is to implement two new 
functions oralobopen und oralobclose &#40;whatever their names may be&#41;.

Or alternatively, to make a Perl variable that represents a BFILE lob 
locator work with PL/SQL such that an anonymous PL/SQL block can be used 
to open and close a BFILE lob like this:

begin
     dbms_lob.open&#40;:bfile_loc, dbms_lob.file_readonly&#41;;
end;

begin
     dbms_lob.close&#40;:bfile_loc&#41;;
end;

These PL/SQL blocks would need to be prepared, and exeuted with 
set_param_inout, since the parameter FILE_LOC is an IN/OUT parameter.

I tried that but it failed. It was on another system and I don&#39;t have 
the error here.

Mit freundlichen Grüßen/Kind regards

Norbert Debes

Hinweis: Kontaktdaten s. angehängte vcard/Note: contact information in attached vcard


On 3/3/2012 12:46, Martin J Evans via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75163">https://rt.cpan.org/Ticket/Display.html?id=75163</a></span>&gt;
&gt;
&gt; Here is a more complete patch - just missing tracing now.
&gt;
&gt; Seems to work and seems to still pass all the existing tests.
&gt;
&gt; The diff is against subversion trunk and has some other things in I&#39;m
&gt; working on too.
&gt;
&gt; Martin
</div></div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;04&nbsp;04:14:46&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Mar 03 16:28:56 2012, norbert.debes@oradbpro.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Martin,
&gt; 
&gt; thank you very much for working on this issue.
&gt; How about adding functions oralobopen und oralobclose? In my view it
&gt; would be ok to have to call these explicitly when working with BFILEs.
&gt; You&#39;re right, something will be leaking.
</div>
The version in the patch should not leak as the file is closed when the
sth goes out of scope so it should avoid having to add 2 new functions.
The only bit I&#39;m not sure about is the way it determines the locator is
a bfile descriptor. I couldn&#39;t find any way of determining this other
than calling OCILobFileIsOpen which I guess &#40;but did not test&#41; will
return an error for blob/clob descriptors &#40;the error is ignored&#41;. So the
only slight drawback with this code is that for blob/clobs there is an
extra call over what happened before &#40;which I doubt makes that much
difference when retrieving the lob will be the biggest/longest operation.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This week I ran some PL/SQL
&gt; code that opened BFILEs but did not close them. It hit an error rather
&gt; quickly. I just took some minutes to reproduce the error - so here it
&gt; is:
<div class="message-stanza open">&gt; SQL&gt; declare
</div>&gt;      v_bfile bfile;
&gt; begin
&gt;      select bfilename&#40;&#39;ADR_TRACE&#39;, &#39;alert_ELEVEN2.log&#39;&#41; into v_bfile
&gt; from dual;
&gt;      dbms_lob.open&#40;v_bfile, dbms_lob.file_readonly&#41;;
&gt; end;
&gt; /
&gt; 
&gt; declare
&gt; *
&gt; ERROR at line 1:
&gt; ORA-22290: operation would exceed the maximum number of opened files
&gt; or LOBs
&gt; ORA-06512: at &#34;SYS.DBMS_LOB&#34;, line 1014
&gt; ORA-06512: at line 5
&gt; 
&gt; It depends on this parameter:
&gt; session_max_open_files               integer     10
</div>
Yeah, we could do with a test adding to the DBD::Oracle test suite for
this. I&#39;m not sure whether the select in your example is generally
available without the other commands you provided to define the file. If
you can think of a way of writing a test for bfiles which does not
require changing someone&#39;s database I&#39;d like to hear about it.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I suppose the only way to fix it properly is to implement two new
&gt; functions oralobopen und oralobclose &#40;whatever their names may be&#41;.
</div>
We could do that but it is more work and I&#39;m pushed for time. I only got
a chance to look at this over the weekend as I am away from home and
looking after my mother in law.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Or alternatively, to make a Perl variable that represents a BFILE lob
&gt; locator work with PL/SQL such that an anonymous PL/SQL block can be
&gt; used
&gt; to open and close a BFILE lob like this:
&gt; 
&gt; begin
&gt;      dbms_lob.open&#40;:bfile_loc, dbms_lob.file_readonly&#41;;
&gt; end;
&gt; 
&gt; begin
&gt;      dbms_lob.close&#40;:bfile_loc&#41;;
&gt; end;
&gt; 
&gt; These PL/SQL blocks would need to be prepared, and exeuted with
&gt; set_param_inout, since the parameter FILE_LOC is an IN/OUT parameter.
&gt; 
&gt; I tried that but it failed. It was on another system and I don&#39;t have
&gt; the error here.
&gt; 
</div>
Try the patch I posted and maybe I&#39;ll have time to refine it or perhaps
Yanick could pick it up.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;05&nbsp;14:04:47&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Please don&#39;t take this as pestering but if you could try the patch and
find it works I could commit it. If for some reason you cannot apply the
patch I can supply a tar.gz of DBD::Oracle with the patch applied.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;05&nbsp;14:42:09&nbsp;2012</span>
    <span class="description">norbert.debes [...] oradbpro.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75163] bug with BFILEs and ora_auto_lob=&gt;0 in DBD::Oracle?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 05 Mar 2012 20:41:53 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Oracle [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Norbert Debes &lt;norbert.debes [...] oradbpro.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Martin,

sorry, I wanted to reply to you earlier. Well you know the problem is, 
this is an assignment for one of the biggest insurance companies in 
Germany &#40;I guess at least one of the biggest&#41; and as far as I can tell 
they have never built Perl on Windows or AIX. They&#39;re using ActiveState 
on Windows &#40;from 2008!!!&#41; and probably some distro that came from IBM on 
AIX &#40;5.8.8 on AIX, no DBD::Oracle&#41;. I&#39;ve been using the Perl distro that 
comes with Oracle 11.2 since it includes DBD::Oracle. That is 5.10.0.

I can&#39;t compile and roll out Perl and I&#39;ve never done it &#40;neither on Win 
nor on AIX&#41;.

So at this time I can&#39;t try the patch.

Meanwhile I&#39;ve resorted to using an anonymous PL/SQL block which opens 
and closes the BFILE for each 4000 bytes that the code reads. This 
finally works and is fast enough.

But of course I&#39;m looking forward to trying the patch once it makes its 
way into ActiveState Perl or into what Oracle distributes with the DBMS.

Thanks for your help, sorry if I&#39;ve disappointed you.

Mit freundlichen Grüßen/Kind regards

Norbert Debes

Hinweis: Kontaktdaten s. angehängte vcard/Note: contact information in attached vcard


On 3/5/2012 20:04, Martin J Evans via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75163">https://rt.cpan.org/Ticket/Display.html?id=75163</a></span>&gt;
&gt;
&gt; Please don&#39;t take this as pestering but if you could try the patch and
&gt; find it works I could commit it. If for some reason you cannot apply the
&gt; patch I can supply a tar.gz of DBD::Oracle with the patch applied.
&gt;
&gt; Martin
</div></div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;06&nbsp;04:09:09&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Mar 05 14:42:09 2012, norbert.debes@oradbpro.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Martin,
&gt; 
&gt; sorry, I wanted to reply to you earlier. Well you know the problem is,
&gt; this is an assignment for one of the biggest insurance companies in
&gt; Germany &#40;I guess at least one of the biggest&#41; and as far as I can tell
&gt; they have never built Perl on Windows or AIX. They&#39;re using
&gt; ActiveState
&gt; on Windows &#40;from 2008!!!&#41; and probably some distro that came from IBM
&gt; on
&gt; AIX &#40;5.8.8 on AIX, no DBD::Oracle&#41;. I&#39;ve been using the Perl distro
&gt; that
&gt; comes with Oracle 11.2 since it includes DBD::Oracle. That is 5.10.0.
&gt; 
&gt; I can&#39;t compile and roll out Perl and I&#39;ve never done it &#40;neither on
&gt; Win
&gt; nor on AIX&#41;.
&gt; 
&gt; So at this time I can&#39;t try the patch.
</div>
ok, that&#39;s fine but...

Not sure about ActiveState from 2008 but you can usually download the 
MinGW package and that lets you compile stuff. My motes from 
README.windows in DBD::ODBC say:

4. If you are manually attempting to build DBD::ODBC for use with
   ActiveState Perl &#40;ActivePerl&#41; don&#39;t. You can use cpan like this:

   cpan M/MJ/MJEVANS/DBD-ODBC-1.23_4.tar.gz

   If you don&#39;t have Microsoft VC on your PATH, then this will
   download and install MinGW for you &#40;inside the Perl tree&#41; and use
   that instead.

   This should work for the latest builds of all major Perl versions,
   5.8.9.827, 5.10.1.1007 and 5.12.0.1200.  On older versions you may
   need to install MinGW with PPM &#34;by-hand&#34; first:

   ppm install MinGW
   cpan M/MJ/MJEVANS/DBD-ODBC-1.23_4.tar.gz

   On ActivePerl 5.8.8 and earlier you will have to download, install
   and configure MinGW and dmake manually though, so you may not want
   to bother...

However, I&#39;m not sure if your &#34;can&#39;t compile&#34; is really a not allowed to 
or just you believe you have no way to.

It is a great shame people in your position are restricted in this way.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Meanwhile I&#39;ve resorted to using an anonymous PL/SQL block which opens
&gt; and closes the BFILE for each 4000 bytes that the code reads. This
&gt; finally works and is fast enough.
&gt; 
&gt; But of course I&#39;m looking forward to trying the patch once it makes
&gt; its
&gt; way into ActiveState Perl or into what Oracle distributes with the
&gt; DBMS.
&gt; 
&gt; Thanks for your help, sorry if I&#39;ve disappointed you.
</div>
No, I understand. I cannot decide whether the patch as is which will 
DWIM is best or to add the open/close methods because I&#39;m not sure about 
the impact of calling OCILobFileIsOpen on non bfile lobs. I&#39;ll see what 
other people think. I&#39;ll have to add a developer test only as I&#39;ve found 
no way of doing bfile reads without first changing the database in some 
way &#40;which we cannot do on other peoples machines&#41;  - that is a shame.

Martin
-- 
Martin J. Evans
Wetherby, UK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;06&nbsp;05:28:19&nbsp;2012</span>
    <span class="description">norbert.debes [...] oradbpro.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75163] bug with BFILEs and ora_auto_lob=&gt;0 in DBD::Oracle?</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 06 Mar 2012 11:27:59 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-Oracle [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Norbert Debes &lt;norbert.debes [...] oradbpro.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Martin,

what I can do is verify my assumption that they never built Perl 
themselves.

I don&#39;t believe the additional open call for an internal LOB will 
noticeably hurt a significant number of Perl programs.

To find out if a locator refers to a BFILE you could also use 
OCILobFileExists&#40;&#41; which would also cause an error on internal LOBs

Returns TRUE if the BFILE exists on the server; FALSE if it does not.
Comments
Checks to see if the BFILE exists on the server&#39;s file system.*It is an 
error to call this
function for an internal LOB.*

Automated tests for BFILE:
most databases these days do have some rows in the view ALL_DIRECTORIES, 
e.g. data pump works with directories and so does OCM &#40;Oracle 
Configuration Manager&#41;.

But you would need a username and password and know at least ORACLE_SID 
and ORACLE_HOME and the user would need read privilege on the directory 
and then you would need to place a file into the directory to be able to 
access it as a BFILE or find out whether there are any files readable to 
the user that owns the processes of the Oracle DBMS instance. This is 
probably too much for an automated test.

Mit freundlichen Grüßen/Kind regards

Norbert Debes

Hinweis: Kontaktdaten s. angehängte vcard/Note: contact information in attached vcard


On 3/6/2012 10:09, Martin J Evans via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75163">https://rt.cpan.org/Ticket/Display.html?id=75163</a></span>&gt;
&gt;
&gt; On Mon Mar 05 14:42:09 2012, norbert.debes@oradbpro.com wrote:
<div class="message-stanza open">&gt;&gt; Hi Martin,
&gt;&gt;
&gt;&gt; sorry, I wanted to reply to you earlier. Well you know the problem is,
&gt;&gt; this is an assignment for one of the biggest insurance companies in
&gt;&gt; Germany &#40;I guess at least one of the biggest&#41; and as far as I can tell
&gt;&gt; they have never built Perl on Windows or AIX. They&#39;re using
&gt;&gt; ActiveState
&gt;&gt; on Windows &#40;from 2008!!!&#41; and probably some distro that came from IBM
&gt;&gt; on
&gt;&gt; AIX &#40;5.8.8 on AIX, no DBD::Oracle&#41;. I&#39;ve been using the Perl distro
&gt;&gt; that
&gt;&gt; comes with Oracle 11.2 since it includes DBD::Oracle. That is 5.10.0.
&gt;&gt;
&gt;&gt; I can&#39;t compile and roll out Perl and I&#39;ve never done it &#40;neither on
&gt;&gt; Win
&gt;&gt; nor on AIX&#41;.
&gt;&gt;
&gt;&gt; So at this time I can&#39;t try the patch.
</div>&gt; ok, that&#39;s fine but...
&gt;
&gt; Not sure about ActiveState from 2008 but you can usually download the
&gt; MinGW package and that lets you compile stuff. My motes from
&gt; README.windows in DBD::ODBC say:
&gt;
&gt; 4. If you are manually attempting to build DBD::ODBC for use with
&gt;     ActiveState Perl &#40;ActivePerl&#41; don&#39;t. You can use cpan like this:
&gt;
&gt;     cpan M/MJ/MJEVANS/DBD-ODBC-1.23_4.tar.gz
&gt;
&gt;     If you don&#39;t have Microsoft VC on your PATH, then this will
&gt;     download and install MinGW for you &#40;inside the Perl tree&#41; and use
&gt;     that instead.
&gt;
&gt;     This should work for the latest builds of all major Perl versions,
&gt;     5.8.9.827, 5.10.1.1007 and 5.12.0.1200.  On older versions you may
&gt;     need to install MinGW with PPM &#34;by-hand&#34; first:
&gt;
&gt;     ppm install MinGW
&gt;     cpan M/MJ/MJEVANS/DBD-ODBC-1.23_4.tar.gz
&gt;
&gt;     On ActivePerl 5.8.8 and earlier you will have to download, install
&gt;     and configure MinGW and dmake manually though, so you may not want
&gt;     to bother...
&gt;
&gt; However, I&#39;m not sure if your &#34;can&#39;t compile&#34; is really a not allowed to
&gt; or just you believe you have no way to.
&gt;
&gt; It is a great shame people in your position are restricted in this way.
&gt;
<div class="message-stanza open">&gt;&gt; Meanwhile I&#39;ve resorted to using an anonymous PL/SQL block which opens
&gt;&gt; and closes the BFILE for each 4000 bytes that the code reads. This
&gt;&gt; finally works and is fast enough.
&gt;&gt;
&gt;&gt; But of course I&#39;m looking forward to trying the patch once it makes
&gt;&gt; its
&gt;&gt; way into ActiveState Perl or into what Oracle distributes with the
&gt;&gt; DBMS.
&gt;&gt;
&gt;&gt; Thanks for your help, sorry if I&#39;ve disappointed you.
</div>&gt; No, I understand. I cannot decide whether the patch as is which will
&gt; DWIM is best or to add the open/close methods because I&#39;m not sure about
&gt; the impact of calling OCILobFileIsOpen on non bfile lobs. I&#39;ll see what
&gt; other people think. I&#39;ll have to add a developer test only as I&#39;ve found
&gt; no way of doing bfile reads without first changing the database in some
&gt; way &#40;which we cannot do on other peoples machines&#41;  - that is a shame.
&gt;
&gt; Martin
</div></div></div>

<div class="messagebody">
</div>
</div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;22&nbsp;06:20:57&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;22&nbsp;06:20:57&nbsp;2012</span>
    <span class="description">bohica [...] ntlworld.com -  Fixed in 1.43_00 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
