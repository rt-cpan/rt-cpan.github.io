<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #66596 for DBI: Apparent memory leaks in connect&#40;&#41; and prepare&#40;&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #66596 for DBI: Apparent memory leaks in connect&#40;&#41; and prepare&#40;&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBI/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBI/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBI/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBI/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBI">DBI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">66596</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBI/Active/">DBI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mg.pub [...] gmx.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-10328-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
1.607</li>
<li>
1.609</li>
<li>
1.616</li>
</ul>
    </td>
  </tr>
  <tr id="CF-10329-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;14&nbsp;06:41:39&nbsp;2011</span>
    <span class="description">mg.pub [...] gmx.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Apparent memory leaks in connect&#40;&#41; and prepare&#40;&#41;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">While trying to hunt down memory leak problems in OTRS &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://otrs.org">http://otrs.org</a></span>&#41;, I stumbled over apparent memory 
leaks in the DBI module. 

Please find attached a small test script to reproduce this problem. On my system, this produces the following 
output:

###

Checking leaks in DBI-&gt;connect&#40;&#41; by performing 10000 calls to connect&#40;&#41; and disconnect&#40;&#41;
The following symbol table differences were found:
  ARRAY changed from 636 to 10727
  CODE changed from 465 to 525
  GLOB changed from 779 to 1033
  HASH changed from 306 to 438
  REF changed from 306 to 463
  REF-HASH changed from 184 to 327
  SCALAR changed from 5911 to 8496


Checking leaks in DBI-&gt;prepare&#40;&#41; by performing 10000 calls to prepare&#40;&#41;
The following symbol table differences were found:
  ARRAY changed from 10731 to 20732

###

This test was performed on:
DBI 1.616
This is perl, v5.10.0 built for darwin-thread-multi-2level
&#40;with 2 registered patches, see perl -V for more detail&#41;
Darwin otrs-mg.fritz.box 10.6.0 Darwin Kernel Version 10.6.0: Wed Nov 10 18:13:17 PST 2010; root:xnu-
1504.9.26~3/RELEASE_I386 i386

So the outcome would be that for _every_ connect&#40;&#41; and prepare&#40;&#41; call, DBI causes leaked memory &#40;additional 
symbol table entries&#41;. I tested this on MacOS with both DBD::mysql and DBD::Pg.
If I am right, this is problematic, because long-running processes using DBI will consume constantly more 
memory.

On another linux system, the result is less problematic, but still shows leaks in connect&#40;&#41;:

###

Checking leaks in DBI-&gt;connect&#40;&#41; by performing 10000 calls to connect&#40;&#41; and disconnect&#40;&#41;
The following symbol table differences were found:
  ARRAY changed from 696 to 792
  CODE changed from 479 to 539
  GLOB changed from 754 to 990
  HASH changed from 286 to 426
  REF changed from 259 to 416
  REF-HASH changed from 133 to 276
  SCALAR changed from 6415 to 9023


Checking leaks in DBI-&gt;prepare&#40;&#41; by performing 10000 calls to prepare&#40;&#41;
The following symbol table differences were found:

###

This test was performed on:
DBI 1.609 &#40;similar results with 1.616 on this system&#41;
This is perl 5, version 12, subversion 1 &#40;v5.12.1&#41; built for i586-linux-thread-multi
Linux ub-opensuse113 2.6.34.7-0.7-default #1 SMP 2010-12-13 11:13:53 +0100 i686 i686 i386 GNU/Linux

The attached test script is quite straightforward. You need a mysql database to connect to, change the 
connection settings as appropriate, and install Devel::Gladiator. Note that tests during the installation of this 
module may fail, but it still works well on my test systems.

Please let me know if I can provide further information about this problem, don&#39;t hesitate to contact me at mg 
dot pub at gmx dot net.

I would be very happy to hear about this issue, if you can confirm and also possibly fix it.

With best regards, 
Martin Gruner
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dbi_leaks.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w

use strict;
use warnings;

use Devel::Gladiator &#40;&#41;;
use DBI &#40;&#41;;

=head1 SYNOPSIS

Helper script to check for leaks in DBI.

It seems that the DBI module in its latest version &#40;1.616&#41; suffers from memory leaks.
This script intends to show that connect&#40;&#41; and prepare&#40;&#41; increase the amount of variables
in the symbol table with every call. This would mean that long-running processes grow constantly.

How is this achieved? We use the module Devel::Gladiator &#40;on installation, some tests were failing
on my platform MacOS, but it seems to work well!&#41; for this purpose. It takes a &#39;snapsnot&#39; of the
symbol table before and after running the tests. Then these are compared and differences highlighted.

=cut

# You may have to adapt this to an existing database on your system.
# It can be empty, without tables.
my $DSN = &#39;DBI:mysql:database=otrs31_dev;host=localhost;&#39;;
my $DB = &#39;otrs31_dev&#39;;
my $PW = &#39;otrs31_dev&#39;;

my $ConnectCount = 10_000;
print &#34;Checking leaks in DBI-&gt;connect&#40;&#41; by performing $ConnectCount calls to connect&#40;&#41; and disconnect&#40;&#41;\n&#34;;

# take snapshot of symbol table before tests
my $OldSymbolTable = Devel::Gladiator::arena_ref_counts&#40;&#41;;

for &#40;1 .. $ConnectCount&#41; {
    my $DBH = DBI-&gt;connect&#40;
        $DSN,
        $DB,
        $PW,
        {
            mysql_auto_reconnect =&gt; 0,
        },
    &#41;;

    $DBH-&gt;disconnect&#40;&#41;;
}

print &#34;The following symbol table differences were found:\n&#34;;

# take snapshot of symbol table after tests
my $NewSymbolTable = Devel::Gladiator::arena_ref_counts&#40;&#41;;

for my $Key &#40;sort keys %{$NewSymbolTable}&#41; {
    if &#40;$NewSymbolTable-&gt;{$Key} &gt; &#40;&#40;$OldSymbolTable-&gt;{$Key} || 0&#41; + 50&#41; &#41; {
        warn &#34;  $Key changed from $OldSymbolTable-&gt;{$Key} to $NewSymbolTable-&gt;{$Key}\n&#34;;
    }
}

my $PrepareCount = 10_000;

print &#34;\n\nChecking leaks in DBI-&gt;prepare&#40;&#41; by performing $PrepareCount calls to prepare&#40;&#41;\n&#34;;

my $DBH = DBI-&gt;connect&#40;
    $DSN,
    $DB,
    $PW,
    {
        mysql_auto_reconnect =&gt; 0,
    },
&#41;;

# take snapshot of symbol table before tests
$OldSymbolTable = Devel::Gladiator::arena_ref_counts&#40;&#41;;

for &#40;1 .. $PrepareCount&#41; {
    my $STH = $DBH-&gt;prepare&#40;&#39;SELECT 1 LIMIT 1&#39;&#41;;

    # optional: these calls do not change the leak result
    $STH-&gt;execute&#40;&#41;;
    $STH-&gt;fetchall_arrayref&#40;&#41;;
    $STH-&gt;finish&#40;&#41;;

}

$DBH-&gt;disconnect&#40;&#41;;

print &#34;The following symbol table differences were found:\n&#34;;

# take snapshot of symbol table after tests
$NewSymbolTable = Devel::Gladiator::arena_ref_counts&#40;&#41;;

for my $Key &#40;sort keys %{$NewSymbolTable}&#41; {
    if &#40;$NewSymbolTable-&gt;{$Key} &gt; &#40;&#40;$OldSymbolTable-&gt;{$Key} || 0&#41; + 50&#41; &#41; {
        warn &#34;  $Key changed from $OldSymbolTable-&gt;{$Key} to $NewSymbolTable-&gt;{$Key}\n&#34;;
    }
}

# DEBUG: print out entire information
#warn Devel::Gladiator::arena_table&#40;&#41;; # prints counts keyed by class</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;14&nbsp;05:06:00&nbsp;2011</span>
    <span class="description">TIMB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Does it leak with different drivers, like DBD::SQLite and DBD::CSV?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;14&nbsp;05:06:01&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;02&nbsp;11:12:29&nbsp;2012</span>
    <span class="description">TIMB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">These leaks are only &#39;apparent&#39;. Life is more complex than it may appear. Most of the &#39;leak&#39; will 
be from loading the DBD::mysql driver on the first connect.

My checks show no leak and, since no one else has reported a leak - which they do quickly when 
there actually is one - I&#39;m going to assume that all is well and close this ticket.

Thanks for the report.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;02&nbsp;11:12:30&nbsp;2012</span>
    <span class="description">TIMB [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
