<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #107528 for Digest-MD5: Unable to restore context on &#34;even&#34; numbers</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #107528 for Digest-MD5: Unable to restore context on &#34;even&#34; numbers</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Digest-MD5/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Digest-MD5/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Digest-MD5/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Digest-MD5/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Digest-MD5">Digest-MD5 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">107528</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Digest-MD5/Active/">Digest-MD5</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
andrew [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-11512-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-11513-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;03&nbsp;20:53:45&nbsp;2015</span>
    <span class="description">andrew [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Unable to restore context on &#34;even&#34; numbers</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 3 Oct 2015 17:53:18 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Digest-MD5 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Andrew Fresh &lt;andrew [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I was looking at the new feature to save and restore context and
couldn&#39;t get it to work reliably.  Attached is a test that reproduces
what I was seeing, and the output that I see failing.

I am not actually planning to use the feature, just updating the OpenBSD
patch that replaces the guts with our own MD5 implementation.  This new
feature is making me look a lot more deeply at it.
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/afresh1/OpenBSD-perl/blob/master/patches/GOOD/use_our_MD5.patch">https://github.com/afresh1/OpenBSD-perl/blob/master/patches/GOOD/use_our_MD5.patch</a></span>

This is stock perl built with plenv, without any patches.
$ perl -v                    

This is perl 5, version 22, subversion 0 &#40;v5.22.0&#41; built for OpenBSD.amd64-openbsd

Copyright 1987-2015, Larry Wall

Perl may be copied only under the terms of either the Artistic License or the
GNU General Public License, which may be found in the Perl 5 source kit.

Complete documentation for Perl, including FAQ lists, should be found on
this system using &#34;man perl&#34; or &#34;perldoc perl&#34;.  If you have access to the
Internet, point your browser at <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perl.org/">http://www.perl.org/</a></span>, the Perl Home Page.

$ prove context.t                                                 
context.t .. 1/? 
#   Failed test &#39;64 saved context&#39;
#   at context.t line 34.
#          got: &#39;7ec34ef5239493ac5691b0332ddeb5f5&#39;
#     expected: &#39;e510683b3f5ffe4093d021808bc6ff70&#39;

#   Failed test &#39;128 saved context&#39;
#   at context.t line 34.
#          got: &#39;eebed3a8b0902a31bef75702ce0658f3&#39;
#     expected: &#39;81109eec5aa1a284fb5327b10e9c16b9&#39;

#   Failed test &#39;1024 saved context&#39;
#   at context.t line 34.
#          got: &#39;e4b3d870eedc254fde025cae4bbe66a3&#39;
#     expected: &#39;b7ea2d21ad2ef3e28085d30247603e0b&#39;

#   Failed test &#39;2048 saved context&#39;
#   at context.t line 34.
#          got: &#39;2cd034df0b74c92cb64ccfa6751bedcd&#39;
#     expected: &#39;21a199c53f422a380e20b162fb6ebe9c&#39;
# Looks like you failed 4 tests of 31.
context.t .. Dubious, test returned 4 &#40;wstat 1024, 0x400&#41;
Failed 4/31 subtests 

Test Summary Report
-------------------
context.t &#40;Wstat: 1024 Tests: 31 Failed: 4&#41;
  Failed tests:  21, 24, 27, 30
  Non-zero exit status: 4
Files=1, Tests=31,  0 wallclock secs &#40; 0.02 usr  0.01 sys +  0.03 cusr  0.01 csys =  0.07 CPU&#41;
Result: FAIL
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
use strict;
use warnings;

use Test::More;
use Digest::MD5;

foreach my $string &#40; map { &#39;a&#39; x $_ }
    1..17,
    31..33,
    64..65,
    127..129,
    1023..1025,
    2047..2049,
&#41; {
    my $expect = do {
        my $ctx = Digest::MD5-&gt;new;
        $ctx-&gt;add&#40;$string&#41;;
        $ctx-&gt;add&#40;$string&#41;;
        $ctx-&gt;hexdigest;
    };

    my $got = do {
        my $ctx1 = Digest::MD5-&gt;new;
        $ctx1-&gt;add&#40;$string&#41;;

        my $ctx2 = Digest::MD5-&gt;new;
        $ctx2-&gt;context&#40; $ctx1-&gt;context &#41;;

        $ctx2-&gt;add&#40;$string&#41;;
        $ctx2-&gt;hexdigest;
    };

    is $got, $expect, length&#40;$string&#41; . &#34; saved context&#34;;
}

done_testing;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;04&nbsp;16:13:27&nbsp;2015</span>
    <span class="description">andrew [...] afresh1.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #107528] Problem is in multiples of 64</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 4 Oct 2015 13:13:03 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Bugs in Digest-MD5 via RT &lt;bug-Digest-MD5 [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Andrew Fresh &lt;andrew [...] afresh1.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Realized that it&#39;s actually every 64 characters that it fails, so 192,
and whatnot.  This is on a 64bit version of perl, but I haven&#39;t had a
chance to try it on a 32bit version.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;04&nbsp;16:13:28&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;01&nbsp;01:44:59&nbsp;2016</span>
    <span class="description">ozcoder [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ozcoder [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Oct 04 16:13:27 2015, andrew@afresh1.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Realized that it&#39;s actually every 64 characters that it fails, so 192,
&gt; and whatnot.  This is on a 64bit version of perl, but I haven&#39;t had a
&gt; chance to try it on a 32bit version.
</div>
I don&#39;t think that will ever work the way you want. The doc says &#34;returns a 3-element list: number of blocks processed, a 16-byte
internal state buffer, then up to 63 bytes of unprocessed data.&#34;, so you are missing the data from longer than 63 character strings.

Gordon
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;12&nbsp;16:17:54&nbsp;2016</span>
    <span class="description">andrew [...] afresh1.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #107528] Unable to restore context on &#34;even&#34; numbers</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 12 Mar 2016 14:17:36 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Digest-MD5 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Andrew Fresh &lt;andrew [...] afresh1.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, Feb 01, 2016 at 01:45:00AM -0500, ozcoder@gmail.com via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I don&#39;t think that will ever work the way you want. The doc says &#34;returns a 3-element list: number of blocks processed, a 16-byte
&gt; internal state buffer, then up to 63 bytes of unprocessed data.&#34;, so you are missing the data from longer than 63 character strings.
</div>
I read it that the third element will be at most the 63 bytes that
haven&#39;t yet been processed.

I think the bug is when we hit the point where we should have processed
all the data, instead of returning nothing, it returns garbage, far more
than the 63 bytes max you would expect.  

I made the included test pass by setting the third element of the
context returned by $ctx1-&gt;context and $ctx2-&gt;context to an empty string
instead of what is returned if the length of either of the third
elements ends up greater than 63.  It will fail again if you comment out
the two lines that set $context?[2] = &#39;&#39;.

Whatever the case and solution, the modified test &#40;attached&#41; passes
&#40;most of the time&#41; for me.  It crashes from time to time still, but that
could be another issue.
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
use strict;
use warnings;

use Test::More;
use Digest::MD5;

foreach my $length &#40;
    1..17,
    31..33,
    64..65,
    127..129,
    191..193,
    1023..1025,
    2047..2049,
&#41; {
    my $string =  &#39;a&#39; x $length;

    my $expect = do {
        my $ctx = Digest::MD5-&gt;new;
        $ctx-&gt;add&#40;$string&#41;;
        $ctx-&gt;add&#40;$string&#41;;
        $ctx-&gt;add&#40;$string&#41;;
        $ctx-&gt;hexdigest;
    };

    my $got = do {
        my $ctx1 = Digest::MD5-&gt;new;
        $ctx1-&gt;add&#40;$string&#41;;

        my @context1 = $ctx1-&gt;context;
        my $reset = length&#40;$context1[2]&#41; &gt; 63;
        $context1[2] = &#39;&#39; if $reset;

        my $ctx2 = Digest::MD5-&gt;new;
        $ctx2-&gt;context&#40; @context1 &#41;;
        $ctx2-&gt;add&#40;$string&#41;;

        my @context2 = $ctx2-&gt;context;
        $context2[2] = &#39;&#39; if $reset or length&#40;$context2[2]&#41; &gt; 63;

        my $ctx3 = Digest::MD5-&gt;new;
        $ctx3-&gt;context&#40; @context2 &#41;;
        $ctx3-&gt;add&#40;$string&#41;;

        $ctx3-&gt;hexdigest;
    };

    is $got, $expect, &#34;[$length] saved context&#34;;
}

done_testing;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;25&nbsp;17:08:04&nbsp;2017</span>
    <span class="description">andrew [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Unsure if it it just went unnoticed due to location, but I did submit a patch in a pull-request on github:

<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/gisle/digest-md5/pull/12">https://github.com/gisle/digest-md5/pull/12</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;05&nbsp;10:44:23&nbsp;2020</span>
    <span class="description">TODDR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ticket migrated to github as <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/Dual-Life/digest-md5/issues/2">https://github.com/Dual-Life/digest-md5/issues/2</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;05&nbsp;10:44:24&nbsp;2020</span>
    <span class="description">TODDR [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
