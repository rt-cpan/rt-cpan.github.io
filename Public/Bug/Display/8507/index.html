<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #8507 for Algorithm-Diff: Interleaved identical lines cause significant slowdown</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #8507 for Algorithm-Diff: Interleaved identical lines cause significant slowdown</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Algorithm-Diff/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Algorithm-Diff/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Algorithm-Diff/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Algorithm-Diff/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Algorithm-Diff">Algorithm-Diff CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">8507</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Algorithm-Diff/Active/">Algorithm-Diff</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
edoverton [...] nyc.rr.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-844-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
1.15</li>
<li>
1.1901</li>
</ul>
    </td>
  </tr>
  <tr id="CF-845-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;17&nbsp;15:41:29&nbsp;2004</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Interleaved identical lines cause significant slowdown</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Short description:

Algorithm::Diff::diff&#40;&#41; runs quickly on something like:

   1 2 3 4 5 6 7 8 9 0
   1 X 3 4 5 6 7 8 9 X

It runs much slower when identical entries are interleaved:

   a 2 a 4 a 6 a 8 a 0
   a X a 4 a 6 a 8 a X

Roughly speaking, it appears that diffs against the first type of comparison slow down proportional to the size of the compared arrays.  Diffs against the second type of comparison appear to slow down proportional to the square of the size of the compared arrays.

I see this performance hit with both 1.15 and 1.1901, and I see it on all hosts I&#39;ve tried &#40;HP/UX, linux, Windows&#41;.  For comparison, /bin/diff handles the interleaved identical entries without any slowdown.  I originally encountered this issue when running diffs against large html files &#40;where numerous identical lines are common for items such as tables&#41;.

Judging by Devel::Dprof, the difference is in the number of calls to _replaceNextLargerWith.  I&#39;m assuming the issue is that the optimization &#40;&#34;optimization: most of the time this will be true&#34;&#41; is not true most of the time for the interleaved array comparison.

Here&#39;s the testcase program:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">--- snip here ---
#!/usr/local/bin/perl

use lib &#39;Algorithm-Diff-1.1901/lib/&#39;;

use warnings;
use strict;

use Benchmark qw&#40;cmpthese&#41;;
use Algorithm::Diff qw&#40;diff&#41;;

my $count = @ARGV ? shift : 500;
$count = 10 if $count &lt; 10;
if &#40;$count % 2&#41; {
   $count++;
}

print &lt;&lt; &#34;EO_MESSAGE&#34;;
Algorithm::Diff version is $Algorithm::Diff::VERSION.
Array size is $count.
EO_MESSAGE

my @plain_left  = &#40;1 .. $count&#41;;
my @plain_right = @plain_left;
$plain_right[1] = $plain_right[-1] = &#39;8888888888&#39;;

my @leaved_left  = map { $_ % 2 ? &#39;SAME&#39; : $_ } @plain_left;
my @leaved_right = map { $_ % 2 ? &#39;SAME&#39; : $_ } @plain_right;

my $run_count = @ARGV ? shift : 10;

cmpthese&#40;
     $run_count
   , {
         &#39;Plain&#39;  =&gt; sub { diff&#40;\@plain_left,  \@plain_right&#41; }
       , &#39;Leaved&#39; =&gt; sub { diff&#40;\@leaved_left, \@leaved_right&#41; }
     }
&#41;;

<div class="message-stanza open">--- snip here ---

Here are results for runs on linux &#40;similar results appear on the other hosts&#41;.  Here, the perl version is 5.6.1.

rhlgn003[9]$ diffem 100 200
Algorithm::Diff version is 1.1901.
Array size is 100.
Benchmark: timing 200 iterations of Leaved, Plain...
    Leaved:  4 wallclock secs &#40; 4.13 usr +  0.00 sys =  4.13 CPU&#41; @ 48.43/s &#40;n=200&#41;
     Plain:  1 wallclock secs &#40; 0.55 usr +  0.00 sys =  0.55 CPU&#41; @ 363.64/s &#40;n=200&#41;
         Rate Leaved  Plain
Leaved 48.4/s     --   -87%
Plain   364/s   651%     --
rhlgn003[10]$ diffem 200 200
Algorithm::Diff version is 1.1901.
Array size is 200.
Benchmark: timing 200 iterations of Leaved, Plain...
    Leaved: 17 wallclock secs &#40;16.79 usr +  0.00 sys = 16.79 CPU&#41; @ 11.91/s &#40;n=200&#41;
     Plain:  1 wallclock secs &#40; 1.09 usr +  0.00 sys =  1.09 CPU&#41; @ 183.49/s &#40;n=200&#41;
         Rate Leaved  Plain
Leaved 11.9/s     --   -94%
Plain   183/s  1440%     --
rhlgn003[11]$ diffem 400 200
Algorithm::Diff version is 1.1901.
Array size is 400.
Benchmark: timing 200 iterations of Leaved, Plain...
    Leaved: 70 wallclock secs &#40;70.28 usr +  0.00 sys = 70.28 CPU&#41; @  2.85/s &#40;n=200&#41;
     Plain:  3 wallclock secs &#40; 2.19 usr +  0.00 sys =  2.19 CPU&#41; @ 91.32/s &#40;n=200&#41;
         Rate Leaved  Plain
Leaved 2.85/s     --   -97%
Plain  91.3/s  3109%     --
rhlgn003[12]$
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;18&nbsp;09:49:21&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">After some further investigation, it seems I&#39;ve simply hit a situation 
for worst case behavior in the Hunt-McIlroy algorithm.

   <span class="clickylink"><a target="new" rel="nofollow" href="http://c2.com/cgi/wiki?DiffAlgorithm">http://c2.com/cgi/wiki?DiffAlgorithm</a></span>

I assume there is a way to optimize around this situation, though, 
since /bin/diff fields this sort of difference very quickly.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;23&nbsp;13:25:09&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Long story short, I&#39;m working on a new LCS implementation based on the
one detailed in &#34;An O&#40;NP&#41; Sequence Comparison Algorithm&#34; by Wu, Myers,
Manber, and Miller.  The gnu diff implementation is based on the
algorithm in &#34;An O&#40;ND&#41; Difference Algorithm and Its Variations&#34; by
Myers, and the O&#40;NP&#41; algorithm is an improvement on the O&#40;ND&#41; one.

I&#39;ll submit a patch for Algorithm::Diff when I&#39;m finished.

Ed
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
