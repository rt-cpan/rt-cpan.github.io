<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #32356 for libwww-perl: Wrong use of sysread - EAGAIN and EINTR not handled on Unix systems</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #32356 for libwww-perl: Wrong use of sysread - EAGAIN and EINTR not handled on Unix systems</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/libwww-perl/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/libwww-perl/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/libwww-perl/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/libwww-perl/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/libwww-perl">libwww-perl CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">32356</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/libwww-perl/Active/">libwww-perl</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
alexander.berger [...] finnova.ch

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-18330-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
5.805</li>
<li>
5.806</li>
<li>
5.807</li>
<li>
5.808</li>
</ul>
    </td>
  </tr>
  <tr id="CF-18331-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;16&nbsp;10:20:00&nbsp;2008</span>
    <span class="description">alexander.berger [...] finnova.ch -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Wrong use of sysread - EAGAIN and EINTR not handled on Unix systems</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">LWP makes heavy use of sysread &#40;Unix read&#41; while reading the HTTP
response from the corresponding socket. 
When sysread &#34;fails&#34; &#40;it returns undef&#41; this does not necessarily mean
that there was an error. This is 
because sysread might fail reading from a non blocking file descriptor
&#40;socket&#41;, which has no data available 
yet but is still valid &#40;and open&#41;. The reason for the failure is
available using perl&#39;s $! variable.

In order to avoid errors, LWP should check for the reason of a sysread
failure &#40;using $!&#41; and retry reading 
if the failure was due to on of the errors EAGAIN or EINTR &#40;Unix error
codes returned by read&#41;.

The current version of LWP will close the connection to the server after
sysread failed, without checking for 
the reason. Therefore the response is never received and an error is
signaled to the user agent, even though the 
repsonse could have been received if sysread was used correctly.

This misbehavior of LWP might have to do with the fact that on Unix
calls to select or poll can signal 
that a file descriptor &#40;socket&#41; is ready for reading while there
actually is no data available on that 
file descriptor in that very moment. Therefore any call to  read
&#40;sysread&#41; and select on such a descriptor 
should handle EAGAIN. And to make things even more stable EINTR &#40;call
was Interrupted e.g. by a signal&#41; 
should also be handled the same way.

So in case of the http/https schema the problem is located in the file
LWP/Protocol/http.pm in the 
package LWP::Protocol::http::SocketMethods and the subroutines involved
are: sysread and can_read.

Here is a non portable &#40;Unix/POSIX only&#41; example solution to this Problem:


...
package LWP::Protocol::http::SocketMethods;
use Errno qw&#40;EINTR EAGAIN&#41;;

# This is in fact a blocking read which will die with the message 
# &#39;read timeout&#39; when the so_socket_timout expired. So the name 
# sysread is misleading but this is because of the design of LWP
# therefore just remember this is a very special sysread.
sub sysread {
    my $self = shift;
                my $timeout = ${*$self}{io_socket_timeout};
    my $stime = time if $timeout;
    # This loop exists only to support error recovery upon system call
    # failure caused by EAGAIN and EINTR. It will be left when either 
    # the timeout expired, a not recoverable error occured or sysread
    # succeeded without any failure.
    while &#40; ! $timeout || $timeout &gt; 0 &#41; {
      # wait for socket to become ready
      # on read timeout this call will die &#40;see can_read below&#41;.
      my $ready = $self-&gt;can_read&#40;$timeout&#41;;
      # In case of an error act like the real sysread an return undef,
      # details about the error are available in $!.
      return undef if ! defined $ready;
      # If socket is not ready &#40;there is no data available yet&#41; then
      # we just continue an try sysread.
      $! = 0;
      my $bytesRead = sysread&#40;$self, $_[0], $_[1], $_[2] || 0&#41;;
      if &#40; ! defined $bytesRead &#38;&#38; &#40; $! == EAGAIN || $! == EINTR&#41; &#41; {
        $timeout = $timeout - &#40;time - $stime&#41; if $timeout;
      } else {
        return $bytesRead;
      }
    }
    die &#34;read timeout&#34;;
}


sub can_read {
    my&#40;$self, $timeout&#41; = @_;
    my $nfound = 0;
    # This loop exists only to support error recovery upon system call
    # failure caused by EAGAIN and EINTR. It will be left when either 
    # the timeout expired, a not recoverable error occured or select
    # succeeded without any failure.
    while &#40; ! $timeout || $timeout &gt; 0 &#41; {
      my $fbits = &#39;&#39;;
      vec&#40;$fbits, fileno&#40;$self&#41;, 1&#41; = 1;
      $! = 0;
      my $stime = time if $timeout;
      $nfound = select&#40;$fbits, undef, undef, $timeout&#41;;
      if &#40; ! defined $nfound &#38;&#38; &#40; $! == EAGAIN || $! == EINTR&#41; &#41; {
        # If select failed because of EAGAIN or EINTR we restart the
        # call. If a timeout is set then we first have to adjust it.
        $timeout = $timeout - &#40;time - $stime&#41; if $timeout;
      } elsif &#40; ! defined $nfound &#41; {
        # any other failure &#40;error code&#41; is signaled to the caller by
        # returning undef. The caller can then inspect $! for details
        # about the failure.
        return undef; 
      } else {
        return $nfound &gt; 0;
      }
    }
    # If wo got to this far then the read timeout expired and we have
    # to signal this to the caller using an exception &#40;die&#41;.
    die&#40;&#39;read timeout&#39;&#41;;
}
...
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;11&nbsp;07:25:52&nbsp;2008</span>
    <span class="description">GAAS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve now applied a patch to my sources that test for these errors.  It
will appear in LWP-5.811.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;11&nbsp;07:25:53&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;11&nbsp;07:25:54&nbsp;2008</span>
    <span class="description">GAAS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;11&nbsp;07:31:05&nbsp;2008</span>
    <span class="description">GAAS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The patch I&#39;ve applied is
<span class="clickylink"><a target="new" rel="nofollow" href="http://gitorious.org/projects/libwww-perl/repos/mainline/commits/438845c6a2193bf8fe5a2fd307a3fcec0e7aefbc">http://gitorious.org/projects/libwww-perl/repos/mainline/commits/438845c6a2193bf8fe5a2fd307a3fcec0e7aefbc</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;11&nbsp;07:31:06&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;11&nbsp;07:31:07&nbsp;2008</span>
    <span class="description">GAAS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;17&nbsp;05:31:42&nbsp;2009</span>
    <span class="description">yari.marchetti [...] staff.dada.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">i found out an issue to the patch applied. This is a snippet of code of
the can_read function:

  SELECT:
    {
        my $before;
        $before = time if $timeout;
        my $nfound = select&#40;$fbits, undef, undef, $timeout&#41;;
        unless &#40;defined $nfound&#41; {
            if &#40;$!{EINTR} || $!{EAGAIN}&#41; {
                # don&#39;t really think EAGAIN can happen here
                if &#40;$timeout&#41; {
                    $timeout -= time - $before;
                    $timeout = 0 if $timeout &lt; 0;
                }
                redo SELECT;
            }
            die &#34;select failed: $!&#34;;
        }
        return $nfound &gt; 0;
    }

the check of definedness of the $nfound var is not always correct
because, in the case i experienced, the &#39;select&#39; was being interrupted
&#40;EINTR&#41; and it was returning a -1, so this case was being treated as a
request timeout.

The solution is quite simple, just change the check for definedness to 
check for the value as well:

-        unless &#40;defined $nfound&#41; {
+        if &#40;not defined $nfound || $nfound &lt; 0&#41; {
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;17&nbsp;05:31:43&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;17&nbsp;15:10:56&nbsp;2009</span>
    <span class="description">GAAS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Reading the documentation for select once more and taking a look at the sources there does 
not appear any case where select returns undef, so these now only tests for $nfound &lt; 0:

<span class="clickylink"><a target="new" rel="nofollow" href="http://gitorious.org/libwww-">http://gitorious.org/libwww-</a></span>
perl/mainline/commit/1c9ba0091b405c1be68a1b71f7e49da18df635d3
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;17&nbsp;15:11:07&nbsp;2009</span>
    <span class="description">GAAS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
