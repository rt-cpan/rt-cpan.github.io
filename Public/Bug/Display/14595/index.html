<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #14595 for DBD-SQLite: BLOB cannot handle NUL &#40;\x00&#41; characters</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #14595 for DBD-SQLite: BLOB cannot handle NUL &#40;\x00&#41; characters</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-SQLite/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-SQLite">DBD-SQLite CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">14595</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-SQLite/Active/">DBD-SQLite</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jose_mico [...] hotmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-10248-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.08    </td>
  </tr>
  <tr id="CF-10249-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;14&nbsp;18:20:18&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> BLOB cannot handle NUL &#40;\x00&#41; characters</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">SQLite documentation says that BLOB&#39;s can contain NUL characters, but data is truncated at first ocurrence of NUL. The problem seems to be in the retrieval function, as data can be found into database file.

Maybe this is a bug of SQLite itself &#40;standalone program sqlite3 exibits the same behaviour&#41;, see discussion at: 

<span class="clickylink"><a target="new" rel="nofollow" href="http://www.perlmonks.org/?node_id=491622">http://www.perlmonks.org/?node_id=491622</a></span>

- - - - - -

# The following code outputs just &#34;ABC&#34;:

use DBI;
my $dbh = DBI-&gt;connect&#40;&#39;DBI:SQLite:dbname=test_blob.db&#39;, &#39;&#39;, &#39;&#39;&#41;;
$dbh-&gt;do&#40;&#39;CREATE TABLE test_blob&#40; Bindata BLOB &#41;&#39;&#41;;

my $bindata = &#34;ABC&#34; . &#34;\x00&#34; . &#34;DEF&#34;;

my $sth1 = $dbh-&gt;prepare&#40;&#39;INSERT INTO test_blob VALUES&#40;?&#41;&#39; &#41;;
$sth1-&gt;execute&#40;$bindata&#41;;

my $sth2 = $dbh-&gt;prepare&#40;&#39;SELECT Bindata FROM test_blob&#39;&#41;;
$sth2-&gt;execute&#40;&#41;;

my $row = $sth2-&gt;fetch&#40;&#41;;
my $fetched_data = $row-&gt;[0];
$sth2-&gt;finish&#40;&#41;;
$dbh-&gt;disconnect;

print $fetched_data;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;22&nbsp;13:49:20&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m having the same problem with the latest version of SQLite3 and Perl
on Debian Unstable.

ii  libdbd-sqlite3-perl                1.09-1                     Perl
DBI driver with a self-contained RDBMS
ii  libsqlite3-0                       3.2.5-1                    SQLite
3 shared library

It&#39;s a serious problem that makes BLOBs essentially useless.


[guest - Wed Sep 14 18:20:18 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; SQLite documentation says that BLOB&#39;s can contain NUL characters, but
&gt; data is truncated at first ocurrence of NUL. The problem seems to be
&gt; in the retrieval function, as data can be found into database file.
&gt; 
&gt; Maybe this is a bug of SQLite itself &#40;standalone program sqlite3
&gt; exibits the same behaviour&#41;, see discussion at:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perlmonks.org/?node_id=491622">http://www.perlmonks.org/?node_id=491622</a></span>
&gt; 
&gt; - - - - - -
&gt; 
&gt; # The following code outputs just &#34;ABC&#34;:
&gt; 
&gt; use DBI;
&gt; my $dbh = DBI-&gt;connect&#40;&#39;DBI:SQLite:dbname=test_blob.db&#39;, &#39;&#39;, &#39;&#39;&#41;;
&gt; $dbh-&gt;do&#40;&#39;CREATE TABLE test_blob&#40; Bindata BLOB &#41;&#39;&#41;;
&gt; 
&gt; my $bindata = &#34;ABC&#34; . &#34;\x00&#34; . &#34;DEF&#34;;
&gt; 
&gt; my $sth1 = $dbh-&gt;prepare&#40;&#39;INSERT INTO test_blob VALUES&#40;?&#41;&#39; &#41;;
&gt; $sth1-&gt;execute&#40;$bindata&#41;;
&gt; 
&gt; my $sth2 = $dbh-&gt;prepare&#40;&#39;SELECT Bindata FROM test_blob&#39;&#41;;
&gt; $sth2-&gt;execute&#40;&#41;;
&gt; 
&gt; my $row = $sth2-&gt;fetch&#40;&#41;;
&gt; my $fetched_data = $row-&gt;[0];
&gt; $sth2-&gt;finish&#40;&#41;;
&gt; $dbh-&gt;disconnect;
&gt; 
&gt; print $fetched_data;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;10&nbsp;22:04:11&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> nate [...] verse.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[Nathan Kurz - Wed Sep 14 18:20:18 2005]:

I&#39;ve looked a little deeper into this, and am pretty sure that it is a
bug in DBD::Sqlite.  The problem is that all text is being stored using
&#39;sqlite3_bind_text&#39;, despite some code in dbdimp.c that appears to
expect otherwise.  I&#39;m not sure if this is a bug or just a partial
implementation.  

In any case, I have a workaround patch but I don&#39;t understand the
internals well enough to know if it is a good idea.  Basically, it uses
memchr&#40;&#41; to scan the bound variable to see if it contains any NUL&#39;s.  If
it does, sqlite3_bind_blob&#40;&#41; is used; otherwise the current default of
sqlite3_bind_text&#40;&#41; remains.  

It&#39;s quite possible that there is a more elegant way of doing this using
the TYPE attribute, but I didn&#39;t manage to make that work.  Patch attached.
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- dbdimp.c.orig	2005-11-10 19:27:55.000000000 -0700
+++ dbdimp.c	2005-11-10 19:27:32.000000000 -0700
@@ -356,11 +356,17 @@
             STRLEN len;
             char * data = SvPV&#40;value, len&#41;;
             retval = sqlite3_bind_blob&#40;imp_sth-&gt;stmt, i+1, data, len, SQLITE_TRANSIENT&#41;;
-        }
+        } 
         else {
             STRLEN len;
             char * data = SvPV&#40;value, len&#41;;
-            retval = sqlite3_bind_text&#40;imp_sth-&gt;stmt, i+1, data, len, SQLITE_TRANSIENT&#41;;
+	    if &#40;memchr&#40;data, 0, len&#41;&#41; {
+		sqlite_trace&#40;4, &#34;binding NUL containing data as a blob&#34;&#41;;
+		retval = sqlite3_bind_blob&#40;imp_sth-&gt;stmt, i+1, data, len, SQLITE_TRANSIENT&#41;;
+	    }
+	    else {
+		retval = sqlite3_bind_text&#40;imp_sth-&gt;stmt, i+1, data, len, SQLITE_TRANSIENT&#41;;
+	    }
         }
         
         if &#40;value&#41; {
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;11&nbsp;16:17:46&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> workaround with bind_param&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jose_mico [...] hotmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">A known workaround is to use bind_param&#40;&#41; to force data type as
SQL_BLOB. For example:

my $sth1 = $dbh-&gt;prepare&#40;&#39;INSERT INTO test_blob VALUES&#40;?&#41;&#39; &#41;;
$sth1-&gt;bind_param&#40;1, $bindata, SQL_BLOB &#41;;
$sth1-&gt;execute&#40;&#41;;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;05&nbsp;06:56:40&nbsp;2005</span>
    <span class="description">msergeant [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
