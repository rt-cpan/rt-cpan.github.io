<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #34609 for POE-Component-Client-FTP: Event not emitted after list error</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #34609 for POE-Component-Client-FTP: Event not emitted after list error</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/POE-Component-Client-FTP/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/POE-Component-Client-FTP/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/POE-Component-Client-FTP/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/POE-Component-Client-FTP/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/POE-Component-Client-FTP">POE-Component-Client-FTP CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">34609</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/POE-Component-Client-FTP/Active/">POE-Component-Client-FTP</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jpalmer [...] linz.govt.nz

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-26408-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.18    </td>
  </tr>
  <tr id="CF-26409-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;02&nbsp;02:08:47&nbsp;2008</span>
    <span class="description">jpalmer [...] linz.govt.nz -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Event not emitted after list error</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I&#39;ve setup a POCO FTP client i.e

    my $ftp = POE::Component::Client::FTP-&gt;spawn&#40;
        Alias      =&gt; &#39;ftp_alias&#39;,
        RemoteAddr =&gt; $host,
        RemotePort =&gt; $port,
        Username   =&gt; $user,
        Password   =&gt; $password,
        Events     =&gt; [qw&#40; connected connect_error authenticated login_error
                           quit quit_error type type_error cd cd_error
ls_data
                           ls_done ls_error get_data get_done get_error &#41;],
    &#41;;


Everything seems to work ok to most ftp sites until I get a dir list
error. My parent session is expecting either a ls_data ls_done ls_error
to be called, but after the list error the ls_error is not emitted.

Here&#39;s the last few lines of my debug log:

5 -&gt; ls_data &#40;from C:/Perl/site/lib/POE/Component/Client/FTP.pm at 986&#41;
5 -&gt; ls_data &#40;from C:/Perl/site/lib/POE/Component/Client/FTP.pm at 986&#41;
5 -&gt; ls_data &#40;from C:/Perl/site/lib/POE/Component/Client/FTP.pm at 986&#41;
5 -&gt; ls_data &#40;from C:/Perl/site/lib/POE/Component/Client/FTP.pm at 986&#41;
5 -&gt; ls_data &#40;from C:/Perl/site/lib/POE/Component/Client/FTP.pm at 986&#41;
5 -&gt; ls_data &#40;from C:/Perl/site/lib/POE/Component/Client/FTP.pm at 986&#41;
5 -&gt; ls_data &#40;from C:/Perl/site/lib/POE/Component/Client/FTP.pm at 986&#41;
-&gt; default_complex::cmd_input at
C:/Perl/site/lib/POE/Component/Client/FTP.pm line 968.
&lt;&lt;&lt; 227 Entering Passive Mode &#40;69,44,86,87,213,212&#41;
-&gt; default_complex::data_error at
C:/Perl/site/lib/POE/Component/Client/FTP.pm line 968.
error: complex_list: read at
C:/Perl/site/lib/POE/Component/Client/FTP.pm line 913.


Thanks,
Jeremy
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;17&nbsp;21:23:58&nbsp;2008</span>
    <span class="description">jpalmer [...] linz.govt.nz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jpalmer [...] linz.govt.nz</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ok here is a patch that ensures that the order of command events is
handled correctly. 

What was currently happening with certain FTP servers was the success
transfer command event was being processed before the actual data
connection had finished. In the current version of FTP 0.18 this caused
the &#39;ready&#39; state to be declared too early.

This attached patch now ensures that the success transfer command event
is queued if the data connection is not complete. The queued command
event is then dispatched once the data connection has closed.

This resolves the issue I was seeing in this bug.

Cheers,
Jeremy
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- FTP.pm.org	Wed Mar 19 01:21:07 2008
+++ FTP.pm	Fri Apr 18 13:13:49 2008
@@ -294,8 +294,7 @@
 
   delete $heap-&gt;{cmd_rw_wheel};
   delete $heap-&gt;{cmd_sock_wheel};
-  delete $heap-&gt;{data_rw_wheel};
-  delete $heap-&gt;{data_sock_wheel};
+  clean_up_complex_cmd&#40;&#41;;
 
   $poe_kernel-&gt;alias_remove&#40; $heap-&gt;{alias} &#41;;
   return;
@@ -309,8 +308,7 @@
 
   my $coderef;
 
-  $input =~ s/^&#40;\d\d\d&#41;&#40;.?&#41;//o;
-  my &#40;$code, $more&#41; = &#40;$1, $2&#41;;
+  my &#40;$code, $major, $more&#41; = parse_cmd_string&#40;$input&#41;;
 
   $input =~ s/^ // if defined $more &#38;&#38; $more eq &#34;-&#34;;
 
@@ -320,8 +318,6 @@
 
   $heap-&gt;{ftp_message} =~ s/\s+$//;
 
-  my $major = substr&#40;$code, 0, 1&#41;;
-
   if &#40;$major == 1&#41; {
     # 1yz   Positive Preliminary reply
 
@@ -470,8 +466,7 @@
   elsif &#40;$heap-&gt;{data_suicidal}&#41; {
     warn &#34;killing suicidal socket&#34; . $heap-&gt;{data_rw_wheel}-&gt;get_driver_out_octets&#40;&#41; if DEBUG;
 
-    delete $heap-&gt;{data_sock_wheel};
-    delete $heap-&gt;{data_rw_wheel};
+    clean_up_complex_cmd&#40;&#41;;
     $heap-&gt;{data_suicidal} = 0;
 
     send_event&#40;&#34;put_closed&#34;,
@@ -489,8 +484,7 @@
   send_event&#40; &#34;put_error&#34;, $error,
 	      $heap-&gt;{complex_stack}-&gt;{command}-&gt;[1] &#41;;
 
-  delete $heap-&gt;{data_sock_wheel};
-  delete $heap-&gt;{data_rw_wheel};
+  clean_up_complex_cmd&#40;&#41;;
   goto_state&#40;&#34;ready&#34;&#41;;
   return;
 }
@@ -808,8 +802,6 @@
     command&#40;$heap-&gt;{complex_stack}-&gt;{command}&#41;;
   }
   else {
-    send_event&#40; $heap-&gt;{complex_stack}-&gt;{command}-&gt;[0] . &#34;_done&#34;,
-                $heap-&gt;{complex_stack}-&gt;{command}-&gt;[1] &#41;;
     goto_state&#40;&#34;ready&#34;&#41;;
   }
   return;
@@ -826,9 +818,7 @@
 	      $status, $line,
 	      $heap-&gt;{complex_stack}-&gt;{command}-&gt;[1] &#41;;
 
-  delete $heap-&gt;{data_sock_wheel};
-  delete $heap-&gt;{data_rw_wheel};
-
+  clean_up_complex_cmd&#40;&#41;;
   goto_state&#40;&#34;ready&#34;&#41;;
   return;
 }
@@ -891,8 +881,7 @@
   send_event&#40; $heap-&gt;{complex_stack}-&gt;{command}-&gt;[0] . &#34;_error&#34;, $error,
 	      $heap-&gt;{complex_stack}-&gt;{command}-&gt;[1] &#41;;
 
-  delete $heap-&gt;{data_sock_wheel};
-  delete $heap-&gt;{data_rw_wheel};
+  clean_up_complex_cmd&#40;&#41;;
   goto_state&#40;&#34;ready&#34;&#41;;
   return;
 }
@@ -911,9 +900,11 @@
 sub handler_complex_list_error {
   my &#40;$kernel, $heap, $input&#41; = @_[KERNEL, HEAP, ARG0];
   warn &#34;error: complex_list: $input&#34; if DEBUG;
+  send_event&#40; $heap-&gt;{complex_stack}-&gt;{command}-&gt;[0] . &#34;_done&#34;,
+	      $heap-&gt;{complex_stack}-&gt;{command}-&gt;[1] &#41;;
 
-  delete $heap-&gt;{data_sock_wheel};
-  delete $heap-&gt;{data_rw_wheel};
+  clean_up_complex_cmd&#40;&#41;;
+  dequeue_complex_cmd&#40;&#41;;
   return;
 }
 
@@ -958,8 +949,15 @@
 # if active session knows how to handle this event, dispatch it to them
 # if not, enqueue the event
 sub dispatch {
-  my &#40;$kernel, $heap, $state&#41; = @_[KERNEL, HEAP, STATE];
+  my &#40;$kernel, $heap, $state, $input&#41; = @_[KERNEL, HEAP, STATE, ARG0];
 
+  if &#40;$state eq &#39;cmd_input&#39; &#38;&#38; defined $heap-&gt;{data_rw_wheel} &#41; {
+      my &#40;$code, $major, $msg&#41; = parse_cmd_string&#40;$input&#41;;
+      if &#40; $major == 2 &#41; {
+        enqueue_complex_cmd&#40;@_&#41;;
+        return;
+      }
+  }
   my $coderef = &#40; $state_map-&gt;{ $heap-&gt;{state} }-&gt;{$state} ||
 		  $state_map-&gt;{global}-&gt;{$state} ||
 		  \&#38;enqueue_event &#41;;
@@ -1058,6 +1056,38 @@
     command&#40;&#34;PORT &#34; . join &#34;,&#34;, @addr, @port&#41;;
   }
   return;
+}
+
+sub parse_cmd_string {
+  my $string = shift;
+  $string =~ s/^&#40;\d\d\d&#41;&#40;.?&#41;//o;
+  my &#40;$code, $more&#41; = &#40;$1, $2&#41;;
+  my $major = substr&#40;$code, 0, 1&#41;;
+  return &#40;$code, $major, $more&#41;;
+}
+
+sub clean_up_complex_cmd {
+  my $heap = $poe_kernel-&gt;get_active_session&#40;&#41;-&gt;get_heap&#40;&#41;;
+  delete $heap-&gt;{data_sock_wheel};
+  delete $heap-&gt;{data_rw_wheel};
+  $heap-&gt;{complex_stack} = {};
+}
+
+sub enqueue_complex_cmd {
+  my $heap = $poe_kernel-&gt;get_active_session&#40;&#41;-&gt;get_heap&#40;&#41;;
+  warn &#34;enqueue_complex_cmd $_[STATE]&#34; if DEBUG;
+  $heap-&gt;{pending_complex_cmd} = \@_;
+}
+
+sub dequeue_complex_cmd {
+  my $heap = $poe_kernel-&gt;get_active_session&#40;&#41;-&gt;get_heap&#40;&#41;;
+  return unless $heap-&gt;{pending_complex_cmd};
+
+  my $state = $heap-&gt;{pending_complex_cmd}-&gt;[STATE];
+  warn &#34;dequeue_complex_cmd $state&#34; if DEBUG;
+  my @event = @{ $heap-&gt;{pending_complex_cmd} };
+  $heap-&gt;{pending_complex_cmd} = undef;
+  dispatch&#40; @event &#41;;
 }
 
 1;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;17&nbsp;22:22:32&nbsp;2008</span>
    <span class="description">jpalmer [...] linz.govt.nz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jpalmer [...] linz.govt.nz</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here&#39;s a new version of the patch the corrects a small uninitialized
value in concatenation error.

Cheers,
Jeremy
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- FTP.pm.org	Wed Mar 19 01:21:07 2008
+++ FTP.pm	Fri Apr 18 14:16:45 2008
@@ -294,8 +294,7 @@
 
   delete $heap-&gt;{cmd_rw_wheel};
   delete $heap-&gt;{cmd_sock_wheel};
-  delete $heap-&gt;{data_rw_wheel};
-  delete $heap-&gt;{data_sock_wheel};
+  clean_up_complex_cmd&#40;&#41;;
 
   $poe_kernel-&gt;alias_remove&#40; $heap-&gt;{alias} &#41;;
   return;
@@ -309,8 +308,7 @@
 
   my $coderef;
 
-  $input =~ s/^&#40;\d\d\d&#41;&#40;.?&#41;//o;
-  my &#40;$code, $more&#41; = &#40;$1, $2&#41;;
+  my &#40;$code, $more&#41; = parse_cmd_string&#40;$input&#41;;
 
   $input =~ s/^ // if defined $more &#38;&#38; $more eq &#34;-&#34;;
 
@@ -470,8 +468,7 @@
   elsif &#40;$heap-&gt;{data_suicidal}&#41; {
     warn &#34;killing suicidal socket&#34; . $heap-&gt;{data_rw_wheel}-&gt;get_driver_out_octets&#40;&#41; if DEBUG;
 
-    delete $heap-&gt;{data_sock_wheel};
-    delete $heap-&gt;{data_rw_wheel};
+    clean_up_complex_cmd&#40;&#41;;
     $heap-&gt;{data_suicidal} = 0;
 
     send_event&#40;&#34;put_closed&#34;,
@@ -489,8 +486,7 @@
   send_event&#40; &#34;put_error&#34;, $error,
 	      $heap-&gt;{complex_stack}-&gt;{command}-&gt;[1] &#41;;
 
-  delete $heap-&gt;{data_sock_wheel};
-  delete $heap-&gt;{data_rw_wheel};
+  clean_up_complex_cmd&#40;&#41;;
   goto_state&#40;&#34;ready&#34;&#41;;
   return;
 }
@@ -808,8 +804,6 @@
     command&#40;$heap-&gt;{complex_stack}-&gt;{command}&#41;;
   }
   else {
-    send_event&#40; $heap-&gt;{complex_stack}-&gt;{command}-&gt;[0] . &#34;_done&#34;,
-                $heap-&gt;{complex_stack}-&gt;{command}-&gt;[1] &#41;;
     goto_state&#40;&#34;ready&#34;&#41;;
   }
   return;
@@ -826,9 +820,7 @@
 	      $status, $line,
 	      $heap-&gt;{complex_stack}-&gt;{command}-&gt;[1] &#41;;
 
-  delete $heap-&gt;{data_sock_wheel};
-  delete $heap-&gt;{data_rw_wheel};
-
+  clean_up_complex_cmd&#40;&#41;;
   goto_state&#40;&#34;ready&#34;&#41;;
   return;
 }
@@ -891,8 +883,7 @@
   send_event&#40; $heap-&gt;{complex_stack}-&gt;{command}-&gt;[0] . &#34;_error&#34;, $error,
 	      $heap-&gt;{complex_stack}-&gt;{command}-&gt;[1] &#41;;
 
-  delete $heap-&gt;{data_sock_wheel};
-  delete $heap-&gt;{data_rw_wheel};
+  clean_up_complex_cmd&#40;&#41;;
   goto_state&#40;&#34;ready&#34;&#41;;
   return;
 }
@@ -911,9 +902,11 @@
 sub handler_complex_list_error {
   my &#40;$kernel, $heap, $input&#41; = @_[KERNEL, HEAP, ARG0];
   warn &#34;error: complex_list: $input&#34; if DEBUG;
+  send_event&#40; $heap-&gt;{complex_stack}-&gt;{command}-&gt;[0] . &#34;_done&#34;,
+	      $heap-&gt;{complex_stack}-&gt;{command}-&gt;[1] &#41;;
 
-  delete $heap-&gt;{data_sock_wheel};
-  delete $heap-&gt;{data_rw_wheel};
+  clean_up_complex_cmd&#40;&#41;;
+  dequeue_complex_cmd&#40;&#41;;
   return;
 }
 
@@ -958,8 +951,15 @@
 # if active session knows how to handle this event, dispatch it to them
 # if not, enqueue the event
 sub dispatch {
-  my &#40;$kernel, $heap, $state&#41; = @_[KERNEL, HEAP, STATE];
+  my &#40;$kernel, $heap, $state, $input&#41; = @_[KERNEL, HEAP, STATE, ARG0];
 
+  if &#40;$state eq &#39;cmd_input&#39; &#38;&#38; defined $heap-&gt;{data_rw_wheel} &#41; {
+      my &#40;$code, $msg&#41; = parse_cmd_string&#40;$input&#41;;
+      if &#40; substr&#40;$code, 0, 1&#41; == 2 &#41; {
+        enqueue_complex_cmd&#40;@_&#41;;
+        return;
+      }
+  }
   my $coderef = &#40; $state_map-&gt;{ $heap-&gt;{state} }-&gt;{$state} ||
 		  $state_map-&gt;{global}-&gt;{$state} ||
 		  \&#38;enqueue_event &#41;;
@@ -1058,6 +1058,37 @@
     command&#40;&#34;PORT &#34; . join &#34;,&#34;, @addr, @port&#41;;
   }
   return;
+}
+
+sub parse_cmd_string {
+  my $string = shift;
+  $string =~ s/^&#40;\d\d\d&#41;&#40;.?&#41;//o;
+  my &#40;$code, $more&#41; = &#40;$1, $2&#41;;
+  return &#40;$code, $more&#41;;
+}
+
+sub clean_up_complex_cmd {
+  my $heap = $poe_kernel-&gt;get_active_session&#40;&#41;-&gt;get_heap&#40;&#41;;
+  delete $heap-&gt;{data_sock_wheel};
+  delete $heap-&gt;{data_rw_wheel};
+  $heap-&gt;{complex_stack} = {};
+}
+
+sub enqueue_complex_cmd {
+  my $heap = $poe_kernel-&gt;get_active_session&#40;&#41;-&gt;get_heap&#40;&#41;;
+  warn &#34;enqueue_complex_cmd $_[STATE]&#34; if DEBUG;
+  $heap-&gt;{pending_complex_cmd} = \@_;
+}
+
+sub dequeue_complex_cmd {
+  my $heap = $poe_kernel-&gt;get_active_session&#40;&#41;-&gt;get_heap&#40;&#41;;
+  return unless $heap-&gt;{pending_complex_cmd};
+
+  my $state = $heap-&gt;{pending_complex_cmd}-&gt;[STATE];
+  warn &#34;dequeue_complex_cmd $state&#34; if DEBUG;
+  my @event = @{ $heap-&gt;{pending_complex_cmd} };
+  $heap-&gt;{pending_complex_cmd} = undef;
+  dispatch&#40; @event &#41;;
 }
 
 1;
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
