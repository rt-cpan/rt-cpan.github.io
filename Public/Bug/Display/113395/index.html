<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #113395 for Moose: How to produce proper error msg when Type coercion fails due to user-defined constraint</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #113395 for Moose: How to produce proper error msg when Type coercion fails due to user-defined constraint</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Moose/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Moose/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Moose/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Moose/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Moose">Moose CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">113395</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Moose/Active/">Moose</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jim.avera [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-38786-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-38787-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;28&nbsp;01:40:51&nbsp;2016</span>
    <span class="description">jim.avera [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> How to produce proper error msg when Type coercion fails due to user-defined constraint</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 27 Mar 2016 22:40:40 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-moose [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jim Avera &lt;jim.avera [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

I&#39;m trying to write something which will make Moose classes &#34;just work&#34; when
used by programs which happen to have &#34;use bigint&#34; or similar in scope.  
Classes
defined using Moose do not work by default, if attributes use type Int 
or Num,
because ordinary literal numbers like 42 in the calling program are 
compiled into
Math::BigInt &#40;or BigFloat or BigRat&#41; when &#34;use big*&#34; is in effect.

The goal is to auto-convert Math::Big* values so they can be passed for 
Int or Num
attributes, and issue a comprehensible error message if the value can 
not be
converted without loss of information.

I tried creating a subtype with a &#34;where&#34; clause which checks that the 
value is
convertible, and then define a coercion from that subtype to Int.
However it appears that the subtype is simply _ignored_ if the &#34;where&#34; 
clause
fails, rather than causing an error using the subtype&#39;s message {...} .
The result is that if the value it too large, a generic &#34;wrong type&#34; 
error occurs
which is confusing.

I tried doing the range check inside the &#34;via&#34; code of the coerce, and 
die&#39;ing if the test failed.
This made my error message appear, but without any context, i.e.,
without indicating where in the program the error occurred or which 
attribute had the bad value.

==&gt; So: Is there a way for a *coerce* to throw an error which will be 
displayed with context information, or alternatively, to _force_ a 
coerce to execute a subtype cast such that if the &#34;where&#34; condition
of the subtype fails, then the &#34;message&#34; from the subtype is displayed?

use Moose::Util::TypeConstraints;

subtype &#39;CoercableBigInt&#39;, as &#39;Math::BigInt&#39;,
         where { use bigint; abs&#40;$_&#41; &lt; 0x7fffffff },
         message { &#34;$_ is too large to coerce to Int&#34; }   # this message 
does NOT appear
         ;
coerce &#39;Int&#39;, from &#39;CoercableBigInt&#39;, via { $_-&gt;numify&#40;&#41; };

package MyClass;
use Moose;
has &#39;i&#39; =&gt; &#40;is =&gt; &#39;rw&#39;, isa =&gt; &#39;Int&#39;, coerce =&gt; 1&#41;;

package main;

use bigint;

# this works, as expected
my $obj = MyClass-&gt;new&#40;i =&gt; 42&#41;;

# This produces a confusing generic &#34;wrong type&#34; error, not the
# message in the message{...} block of the CoercableBigInt subtype
my $obj2 = MyClass-&gt;new&#40;i =&gt; 42*1000000*1000000&#41;;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;28&nbsp;13:24:48&nbsp;2016</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2016-03-27 22:40:51, jim.avera@gmail.com wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ==&gt; So: Is there a way for a *coerce* to throw an error which will be 
&gt; displayed with context information, or alternatively, to _force_ a 
&gt; coerce to execute a subtype cast such that if the &#34;where&#34; condition
&gt; of the subtype fails, then the &#34;message&#34; from the subtype is displayed?
</div>
You can invoke the interfaces of the type constraint directly, and capture the
message that way -- see the documentation in Moose::Meta::TypeConstraint.

my $type = Moose::Util::type_constraints::find_type_constraint&#40;&#39;MyType&#39;&#41;;
my $error_message = $type-&gt;validate&#40;$value&#41;;

I&#39;m marking this ticket as rejected because it&#39;s not really a bug.  If you
have questions, feel free to follow up on the moose mailing list
&#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://lists.perl.org/list/moose.html&#41;">http://lists.perl.org/list/moose.html&#41;</a></span>; you can also find someone during most
North American and European waking hours on irc &#40;irc.perl.org #moose&#41;.

good luck!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;28&nbsp;13:24:49&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;28&nbsp;13:25:00&nbsp;2016</span>
    <span class="description">ether [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;28&nbsp;14:00:02&nbsp;2016</span>
    <span class="description">jim.avera [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jim.avera [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Mar 28 13:24:48 2016, ETHER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; You can invoke the interfaces of the type constraint directly, and
&gt; capture the message that way -- see the documentation in
&gt; Moose::Meta::TypeConstraint.
</div>
Hi, Could you say a few bits more about that?  Where exactly should such code go -- in the &#39;where&#39; clause of the subtype or the &#39;via&#39; clause of the coerce?   And note that I don&#39;t want to capture the error message, I want to PROVIDE the error message &#40;and have it print with context info&#41;.

I would have thought that the message {...} clause in the subtype definition would have DWIM, but it is not being used for some reason.  Which I thought might be a bug...

Thanks.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;28&nbsp;15:33:46&nbsp;2016</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2016-03-28 11:00:02, jim.avera@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Mar 28 13:24:48 2016, ETHER wrote:
<div class="message-stanza open">&gt; &gt; You can invoke the interfaces of the type constraint directly, and
&gt; &gt; capture the message that way -- see the documentation in
&gt; &gt; Moose::Meta::TypeConstraint.
</div>&gt; 
&gt; Hi, Could you say a few bits more about that?  Where exactly should
&gt; such code go -- in the &#39;where&#39; clause of the subtype or the &#39;via&#39;
&gt; clause of the coerce?   And note that I don&#39;t want to capture the
&gt; error message, I want to PROVIDE the error message &#40;and have it print
&gt; with context info&#41;.
&gt; 
&gt; I would have thought that the message {...} clause in the subtype
&gt; definition would have DWIM, but it is not being used for some reason.
&gt; Which I thought might be a bug...
</div>
It&#39;s not a bug.  You were correct here:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; However it appears that the subtype is simply _ignored_ if the &#34;where&#34; clause fails...
</div>
CoercableBigInt isn&#39;t a *sub*type of int - it&#39;s a supertype.  Type checks are done in order from type-&gt;subtype &#40;parent-&gt;child&#41;, so if the type constraint fails the parent &#40;Int&#41;, it doesn&#39;t check the subtypes.

You&#39;ll have to define your bigint type independently of Int.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;28&nbsp;18:42:02&nbsp;2016</span>
    <span class="description">jim.avera [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #113395] How to produce proper error msg when Type coercion fails due to user-defined constraint</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 28 Mar 2016 15:41:52 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Moose [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jim Avera &lt;jim.avera [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 03/28/2016 12:33 PM, Karen Etheridge via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; CoercableBigInt isn&#39;t a *sub*type of int - it&#39;s a supertype.  Type checks are done in order from type-&gt;subtype &#40;parent-&gt;child&#41;, so if the type constraint fails the parent &#40;Int&#41;, it doesn&#39;t check the subtypes.
&gt;
&gt; You&#39;ll have to define your bigint type independently of Int.
</div>
Ok, thanks.  Then it looks to be impossible to use innocent Moose classes in
applications which &#34;use bignum&#34; etc.

&#40;if I understand you correctly, every Moose class used by the app would 
have to be modified to use custom types instead of &#39;Int&#39; and &#39;Num&#39;&#41;

-Jim
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;28&nbsp;20:41:19&nbsp;2016</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2016-03-28 15:42:02, jim.avera@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 03/28/2016 12:33 PM, Karen Etheridge via RT wrote:
<div class="message-stanza open">&gt; &gt; CoercableBigInt isn&#39;t a *sub*type of int - it&#39;s a supertype.  Type
&gt; &gt; checks are done in order from type-&gt;subtype &#40;parent-&gt;child&#41;, so if
&gt; &gt; the type constraint fails the parent &#40;Int&#41;, it doesn&#39;t check the
&gt; &gt; subtypes.
&gt; &gt;
&gt; &gt; You&#39;ll have to define your bigint type independently of Int.
</div>&gt; 
&gt; Ok, thanks.  Then it looks to be impossible to use innocent Moose
&gt; classes in
&gt; applications which &#34;use bignum&#34; etc.
&gt; 
&gt; &#40;if I understand you correctly, every Moose class used by the app
&gt; would
&gt; have to be modified to use custom types instead of &#39;Int&#39; and &#39;Num&#39;&#41;
</div>
The alternative is to totally redefine the Int and Num types so they can be bigints. This is doable, as the type definitions are straightforward, in Moose::Util::TypeConstraints::Builtins -- but will affect everything else in the same runtime instance &#40;and probably break things like MooseX::Storage unless it was also adjusted&#41;, so must be done with great care.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
