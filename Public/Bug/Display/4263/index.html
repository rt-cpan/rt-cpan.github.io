<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #4263 for XML-LibXML: using XML parser inside a callback did not work</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #4263 for XML-LibXML: using XML parser inside a callback did not work</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/XML-LibXML/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-LibXML">XML-LibXML CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">4263</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/XML-LibXML/Active/">XML-LibXML</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bzm [...] 2bz.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-37350-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.56    </td>
  </tr>
  <tr id="CF-37351-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;01&nbsp;11:04:24&nbsp;2003</span>
    <span class="description">BORISZ [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> using XML parser inside a callback did not work</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

whenever I try to use or create a parser inside a callback function like match_callback, open_callback, close_callback or read_callback I get everything from segfault&#39;s to &#39;Attempt to free unreferenced scalar&#39;.

Attached is a testcase the example/cb_example.pl with only one more line inside open_uri.

  Additional line:
    my $p = XML::LibXML-&gt;new-&gt;parse_string&#40;q{&lt;?xml version=&#34;1.0&#34;?&gt;&lt;xml&gt;&lt;/xml&gt;}&#41;;

I have tried it with 

  XML-LibXML 1.56
  XML-LibXML from CVS
  libxml2-2.5.[6,8,11]
  perl 5.8.1

--
Boris
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use XML::LibXML;
use IO::File;

# first instanciate the parser
my $parser = XML::LibXML-&gt;new&#40;&#41;;

# initialize the callbacks
$parser-&gt;match_callback&#40; \&#38;match_uri &#41;;
$parser-&gt;read_callback&#40; \&#38;read_uri &#41;;
$parser-&gt;open_callback&#40; \&#38;open_uri &#41;;
$parser-&gt;close_callback&#40; \&#38;close_uri &#41;;

# include XIncludes on the fly
$parser-&gt;expand_xinclude&#40; 1 &#41;;

# parse the file &#34;text.xml&#34; in the current directory
$dom = $parser-&gt;parse_file&#40;&#34;test.xml&#34;&#41;;


print $dom-&gt;toString&#40;&#41; , &#34;\n&#34;;

# the callbacks follow
# these callbacks are used for both the original parse AND the XInclude
sub match_uri {
    my $uri = shift;
    return $uri !~ /:\/\// ? 1 : 0; # we handle only files
}

sub open_uri {
    my $uri = shift;
    my $handler = new IO::File;
    if &#40; not $handler-&gt;open&#40; &#34;&lt;$uri&#34; &#41; &#41;{
        $handler = 0;
    }

    my $p = XML::LibXML-&gt;new-&gt;parse_string&#40;q{&lt;?xml version=&#34;1.0&#34;?&gt;&lt;xml&gt;&lt;/xml&gt;}&#41;;

    return $handler;
}

sub read_uri {
    my $handler = shift;
    my $length  = shift;
    my $buffer = undef;
     if &#40; $handler &#41; {
        $handler-&gt;read&#40; $buffer, $length &#41;;
    }
    return $buffer;
}

sub close_uri {
   my $handler = shift;
    if &#40; $handler &#41; {
        $handler-&gt;close&#40;&#41;;
    }
    return 1;
}

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;01&nbsp;13:00:01&nbsp;2004</span>
    <span class="description">phish [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;07&nbsp;06:31:18&nbsp;2004</span>
    <span class="description">phish [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> xml-libxml [...] axkit.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[BORISZ - Sat Nov  1 11:04:24 2003]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; whenever I try to use or create a parser inside a callback function
&gt; like match_callback, open_callback, close_callback or read_callback I
&gt; get everything from segfault&#39;s to &#39;Attempt to free unreferenced
&gt; scalar&#39;.
</div>
the segfault disapears with 1.57.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Attached is a testcase the example/cb_example.pl with only one more
&gt; line inside open_uri.
</div>
However, the &#34;bug&#34; itself still remains. 

The sollution is: don&#39;t call a parser from within a callback!

The reason for this is: XML::LibXML will override the existing parser
callbacks &#40;which are globally stored in libxml2&#41;. The effect is, that
the main parser will not get any data at all while the nested parser
succeeds.

I am not shure if adding multithreading code to XML::LibXML can solve
this particular problem.

christian
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;07&nbsp;06:31:19&nbsp;2004</span>
    <span class="description">phish [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;29&nbsp;15:41:07&nbsp;2009</span>
    <span class="description">daniel.frett [...] ccci.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [patch] using XML parser inside a callback did not work</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza">On Sun Mar 07 06:31:18 2004, PHISH wrote: <br>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [BORISZ - Sat Nov  1 11:04:24 2003]: <br>

&gt;  <br>
<div class="message-stanza open">&gt; &gt; Hi, <br>

&gt; &gt;  <br>

&gt; &gt; whenever I try to use or create a parser inside a callback function <br>

&gt; &gt; like match_callback, open_callback, close_callback or read_callback I <br>

&gt; &gt; get everything from segfault's to 'Attempt to free unreferenced <br>

&gt; &gt; scalar'. <br>
</div>&gt;  <br>

&gt; the segfault disapears with 1.57. <br>

&gt;  <br>
<div class="message-stanza open">&gt; &gt; Attached is a testcase the example/cb_example.pl with only one more <br>

&gt; &gt; line inside open_uri. <br>
</div>&gt;  <br>

&gt; However, the &quot;bug&quot; itself still remains.  <br>

&gt;  <br>

&gt; The sollution is: don't call a parser from within a callback! <br>

&gt;  <br>

&gt; The reason for this is: XML::LibXML will override the existing parser <br>

&gt; callbacks (which are globally stored in libxml2). The effect is, that <br>

&gt; the main parser will not get any data at all while the nested parser <br>

&gt; succeeds. <br>

&gt;  <br>

&gt; I am not shure if adding multithreading code to XML::LibXML can solve <br>

&gt; this particular problem. <br>

&gt;  <br>

&gt; christian <br>

&gt;  <br>
</div><br>

I was able to get a nested parser instance working correctly by changing how init_callbacks and cleanup_callbacks worked. instead of always calling lib_init_callbacks and lib_cleanup_callbacks when starting and finishing a parsing process, a $_NB_NESTED_DEPTH global is used to track if parsing is being started within another parsing instance and the lib_init_callbacks/lib_cleanup_callbacks is only called for the outermost parser.<br>

<br>

here is a git branch I setup that addresses this issue:<br>

<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/frett/perl-libxml/commits/NestedParsing">http://github.com/frett/perl-libxml/commits/NestedParsing</a></span><br>

<br>

attached are 2 separate patches.<br>

The first patch (libxml-01.patch) allows xml to be parsed correctly from within an input callback, but does not completely support sharing an InputCallback object between the outer and inner parsers .<br>

The second patch (libxml-02.patch) includes patch 1 and additionally allows the InputCallback object to be shared between the outer and inner parsers, but changes how legacy local parser callbacks are handled and could potentially break user's code if the user happens to be using legacy local callbacks and subclasses XML::LibXML::InputCallback and overrides the init_callbacks method (I highly doubt anyone has done this).<br>

<br>

the second patch also fixes the underlying issue behind RT#51086<br>

<br>

-Daniel Frett<br>
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> libxml-01.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/LibXML.pm b/LibXML.pm
index 864647f..b71f05d 100644
--- a/LibXML.pm
+++ b/LibXML.pm
@@ -2075,12 +2075,14 @@ sub CLONE_SKIP { 1 }
 #-------------------------------------------------------------------------#
 package XML::LibXML::InputCallback;
 
-use vars qw&#40;$_CUR_CB @_GLOBAL_CALLBACKS @_CB_STACK&#41;;
+use vars qw&#40;$_CUR_CB @_GLOBAL_CALLBACKS @_CB_STACK $_CB_NESTED_DEPTH @_CB_NESTED_STACK&#41;;
 
 BEGIN {
   $_CUR_CB = undef;
   @_GLOBAL_CALLBACKS = &#40;&#41;;
   @_CB_STACK = &#40;&#41;;
+  $_CB_NESTED_DEPTH = 0;
+  @_CB_NESTED_STACK = &#40;&#41;;
 }
 
 sub CLONE_SKIP {
@@ -2203,9 +2205,20 @@ sub unregister_callbacks {
 sub init_callbacks {
     my $self = shift;
 
+    #initialize the libxml2 callbacks unless this is a nested callback
+    $self-&gt;lib_init_callbacks&#40;&#41; unless&#40;$_CB_NESTED_DEPTH&#41;;
+
+    #store the callbacks for any outer executing parser instance
+    $_CB_NESTED_DEPTH++;
+    push @_CB_NESTED_STACK, [
+      $_CUR_CB,
+      [@_CB_STACK],
+      [@_GLOBAL_CALLBACKS],
+    ];
+
+    #initialize the callback variables for the current parser
     $_CUR_CB           = undef;
     @_CB_STACK         = &#40;&#41;;
-
     @_GLOBAL_CALLBACKS = @{ $self-&gt;{_CALLBACKS} };
     
     if &#40; defined $XML::LibXML::match_cb and 
@@ -2217,19 +2230,21 @@ sub init_callbacks {
                                   $XML::LibXML::read_cb,
                                   $XML::LibXML::close_cb];
     }
-
-    $self-&gt;lib_init_callbacks&#40;&#41;;
 }
 
 # reset libxml2&#39;s callbacks
 sub cleanup_callbacks {
     my $self = shift;
-    
-    $_CUR_CB           = undef;
-    @_GLOBAL_CALLBACKS = &#40;&#41;;
-    @_CB_STACK         = &#40;&#41;;
 
-    $self-&gt;lib_cleanup_callbacks&#40;&#41;;
+    #restore the callbacks for the outer parser instance
+    $_CB_NESTED_DEPTH--;
+    my $saved          = pop @_CB_NESTED_STACK;
+    $_CUR_CB           = $saved-&gt;[0];
+    @_CB_STACK         = &#40;@{$saved-&gt;[1]}&#41;;
+    @_GLOBAL_CALLBACKS = &#40;@{$saved-&gt;[2]}&#41;;
+
+    #clean up the libxml2 callbacks unless there are still outer parsing instances
+    $self-&gt;lib_cleanup_callbacks&#40;&#41; unless&#40;$_CB_NESTED_DEPTH&#41;;
 }
 
 $XML::LibXML::__loaded=1;
diff --git a/t/28new_callbacks_multiple.t b/t/28new_callbacks_multiple.t
index 02c24fc..a24b7e5 100644
--- a/t/28new_callbacks_multiple.t
+++ b/t/28new_callbacks_multiple.t
@@ -1,6 +1,6 @@
 # $Id$
 use Test;
-BEGIN { plan tests =&gt; 50 }
+BEGIN { plan tests =&gt; 55 }
 END { ok&#40;0&#41; unless $loaded }
 use XML::LibXML;
 use IO::File;
@@ -15,7 +15,8 @@ ok&#40;1&#41;;
 &lt;x xmlns:xinclude=&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/2001/XInclude">http://www.w3.org/2001/XInclude</a></span>&#34;&gt;
 &lt;xml&gt;test
 &lt;xinclude:include href=&#34;/example/test2.xml&#34;/&gt;
-&lt;xinclude:include href=&#34;/libxml/test2.xml&#34;/&gt;&lt;/xml&gt;
+&lt;xinclude:include href=&#34;/libxml/test2.xml&#34;/&gt;
+&lt;xinclude:include href=&#34;/xmldom/test2.xml&#34;/&gt;&lt;/xml&gt;
 &lt;/x&gt;
 EOF
 
@@ -28,6 +29,9 @@ EOF
         $icb-&gt;register_callbacks&#40; [ \&#38;match_hash, \&#38;open_hash, 
                                     \&#38;read_hash, \&#38;close_hash ] &#41;;
 
+        $icb-&gt;register_callbacks&#40; [ \&#38;match_xml, \&#38;open_xml,
+                                    \&#38;read_xml, \&#38;close_xml ] &#41;;
+
 
         my $parser = XML::LibXML-&gt;new&#40;&#41;;
         $parser-&gt;expand_xinclude&#40;1&#41;;
@@ -35,7 +39,7 @@ EOF
         my $doc = $parser-&gt;parse_string&#40;$string&#41;;
 
         ok&#40;$doc&#41;;
-        ok&#40;$doc-&gt;string_value&#40;&#41;, &#34;\ntest\n..\nbar..\n&#34;&#41;;
+        ok&#40;$doc-&gt;string_value&#40;&#41;, &#34;\ntest\n..\nbar..\nbarbar\n&#34;&#41;;
 }
 
 {
@@ -173,3 +177,40 @@ sub match_hash2 {
                 return 1;
         }
 }
+
+# --------------------------------------------------------------------- #
+# callback set 4 &#40;perl xml reader&#41;
+# --------------------------------------------------------------------- #
+sub match_xml {
+        my $uri = shift;
+        if &#40; $uri =~ /^\/xmldom\// &#41;{
+                ok&#40;1&#41;;
+                return 1;
+        }
+}
+
+sub open_xml {
+        my $uri = shift;
+        my $dom = XML::LibXML-&gt;new-&gt;parse_string&#40;q{&lt;?xml version=&#34;1.0&#34;?&gt;&lt;foo&gt;&lt;tmp/&gt;barbar&lt;/foo&gt;}&#41;;
+        ok&#40;$dom&#41;;
+
+        return $dom;
+}
+
+sub read_xml {
+        my $dom   = shift;
+        my $buflen = shift;
+
+        my $tmp = $dom-&gt;documentElement-&gt;findnodes&#40;&#39;tmp&#39;&#41;-&gt;shift;
+        my $rv = $tmp ? $dom-&gt;toString : &#34;&#34;;
+        $tmp-&gt;unbindNode if&#40;$tmp&#41;;
+
+        ok&#40;1&#41;;
+        return $rv;
+}
+
+sub close_xml {
+        my $dom   = shift;
+        undef $dom;
+        ok&#40;1&#41;;
+}
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> libxml-02.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/LibXML.pm b/LibXML.pm
index 864647f..c552c24 100644
--- a/LibXML.pm
+++ b/LibXML.pm
@@ -724,22 +724,12 @@ sub _init_callbacks {
         $icb = $self-&gt;{XML_LIBXML_CALLBACK_STACK};
     }
 
-    my $mcb = $self-&gt;match_callback&#40;&#41;;
-    my $ocb = $self-&gt;open_callback&#40;&#41;;
-    my $rcb = $self-&gt;read_callback&#40;&#41;;
-    my $ccb = $self-&gt;close_callback&#40;&#41;;
-
-    if &#40; defined $mcb and defined $ocb and defined $rcb and defined $ccb &#41; {
-        $icb-&gt;register_callbacks&#40; [$mcb, $ocb, $rcb, $ccb] &#41;;
-    }
-    $icb-&gt;init_callbacks&#40;&#41;;
+    $icb-&gt;init_callbacks&#40;$self&#41;;
 }
 
 sub _cleanup_callbacks {
     my $self = shift;
     $self-&gt;{XML_LIBXML_CALLBACK_STACK}-&gt;cleanup_callbacks&#40;&#41;;
-    my $mcb = $self-&gt;match_callback&#40;&#41;;
-    $self-&gt;{XML_LIBXML_CALLBACK_STACK}-&gt;unregister_callbacks&#40; [$mcb] &#41;;
 }
 
 sub __read {
@@ -2075,12 +2065,14 @@ sub CLONE_SKIP { 1 }
 #-------------------------------------------------------------------------#
 package XML::LibXML::InputCallback;
 
-use vars qw&#40;$_CUR_CB @_GLOBAL_CALLBACKS @_CB_STACK&#41;;
+use vars qw&#40;$_CUR_CB @_GLOBAL_CALLBACKS @_CB_STACK $_CB_NESTED_DEPTH @_CB_NESTED_STACK&#41;;
 
 BEGIN {
   $_CUR_CB = undef;
   @_GLOBAL_CALLBACKS = &#40;&#41;;
   @_CB_STACK = &#40;&#41;;
+  $_CB_NESTED_DEPTH = 0;
+  @_CB_NESTED_STACK = &#40;&#41;;
 }
 
 sub CLONE_SKIP {
@@ -2202,12 +2194,36 @@ sub unregister_callbacks {
 # make libxml2 use the callbacks 
 sub init_callbacks {
     my $self = shift;
+    my $parser = shift;
+
+    #initialize the libxml2 callbacks unless this is a nested callback
+    $self-&gt;lib_init_callbacks&#40;&#41; unless&#40;$_CB_NESTED_DEPTH&#41;;
+
+    #store the callbacks for any outer executing parser instance
+    $_CB_NESTED_DEPTH++;
+    push @_CB_NESTED_STACK, [
+      $_CUR_CB,
+      [@_CB_STACK],
+      [@_GLOBAL_CALLBACKS],
+    ];
 
+    #initialize the callback variables for the current parser
     $_CUR_CB           = undef;
     @_CB_STACK         = &#40;&#41;;
-
     @_GLOBAL_CALLBACKS = @{ $self-&gt;{_CALLBACKS} };
     
+    #attach parser specific callbacks
+    if&#40;$parser&#41; {
+        my $mcb = $parser-&gt;match_callback&#40;&#41;;
+        my $ocb = $parser-&gt;open_callback&#40;&#41;;
+        my $rcb = $parser-&gt;read_callback&#40;&#41;;
+        my $ccb = $parser-&gt;close_callback&#40;&#41;;
+        if &#40; defined $mcb and defined $ocb and defined $rcb and defined $ccb &#41; {
+            unshift @_GLOBAL_CALLBACKS, [$mcb, $ocb, $rcb, $ccb];
+        }
+    }
+
+    #attach global callbacks
     if &#40; defined $XML::LibXML::match_cb and 
          defined $XML::LibXML::open_cb  and 
          defined $XML::LibXML::read_cb  and 
@@ -2217,19 +2233,21 @@ sub init_callbacks {
                                   $XML::LibXML::read_cb,
                                   $XML::LibXML::close_cb];
     }
-
-    $self-&gt;lib_init_callbacks&#40;&#41;;
 }
 
 # reset libxml2&#39;s callbacks
 sub cleanup_callbacks {
     my $self = shift;
-    
-    $_CUR_CB           = undef;
-    @_GLOBAL_CALLBACKS = &#40;&#41;;
-    @_CB_STACK         = &#40;&#41;;
 
-    $self-&gt;lib_cleanup_callbacks&#40;&#41;;
+    #restore the callbacks for the outer parser instance
+    $_CB_NESTED_DEPTH--;
+    my $saved          = pop @_CB_NESTED_STACK;
+    $_CUR_CB           = $saved-&gt;[0];
+    @_CB_STACK         = &#40;@{$saved-&gt;[1]}&#41;;
+    @_GLOBAL_CALLBACKS = &#40;@{$saved-&gt;[2]}&#41;;
+
+    #clean up the libxml2 callbacks unless there are still outer parsing instances
+    $self-&gt;lib_cleanup_callbacks&#40;&#41; unless&#40;$_CB_NESTED_DEPTH&#41;;
 }
 
 $XML::LibXML::__loaded=1;
diff --git a/docs/libxml.dbk b/docs/libxml.dbk
index ec6df23..f52f06e 100644
--- a/docs/libxml.dbk
+++ b/docs/libxml.dbk
@@ -5547,10 +5547,10 @@ $parser-&#38;gt;parse_file&#40; $some_xml_file &#41;;&lt;/programlisting&gt;
                     &lt;/varlistentry&gt;
 
                     &lt;varlistentry&gt;
-                        &lt;term&gt;init_callbacks&#40;&#41;&lt;/term&gt;
+                        &lt;term&gt;init_callbacks&#40; $parser &#41;&lt;/term&gt;
 
                         &lt;listitem&gt;
-                            &lt;para&gt;Initializes the callback system before a parsing process.&lt;/para&gt;
+                            &lt;para&gt;Initializes the callback system for the provided parser before starting a parsing process.&lt;/para&gt;
                         &lt;/listitem&gt;
                     &lt;/varlistentry&gt;
 
diff --git a/t/28new_callbacks_multiple.t b/t/28new_callbacks_multiple.t
index 02c24fc..dd119c5 100644
--- a/t/28new_callbacks_multiple.t
+++ b/t/28new_callbacks_multiple.t
@@ -1,6 +1,6 @@
 # $Id$
 use Test;
-BEGIN { plan tests =&gt; 50 }
+BEGIN { plan tests =&gt; 77 }
 END { ok&#40;0&#41; unless $loaded }
 use XML::LibXML;
 use IO::File;
@@ -15,7 +15,8 @@ ok&#40;1&#41;;
 &lt;x xmlns:xinclude=&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/2001/XInclude">http://www.w3.org/2001/XInclude</a></span>&#34;&gt;
 &lt;xml&gt;test
 &lt;xinclude:include href=&#34;/example/test2.xml&#34;/&gt;
-&lt;xinclude:include href=&#34;/libxml/test2.xml&#34;/&gt;&lt;/xml&gt;
+&lt;xinclude:include href=&#34;/libxml/test2.xml&#34;/&gt;
+&lt;xinclude:include href=&#34;/xmldom/test2.xml&#34;/&gt;&lt;/xml&gt;
 &lt;/x&gt;
 EOF
 
@@ -28,6 +29,9 @@ EOF
         $icb-&gt;register_callbacks&#40; [ \&#38;match_hash, \&#38;open_hash, 
                                     \&#38;read_hash, \&#38;close_hash ] &#41;;
 
+        $icb-&gt;register_callbacks&#40; [ \&#38;match_xml, \&#38;open_xml,
+                                    \&#38;read_xml, \&#38;close_xml ] &#41;;
+
 
         my $parser = XML::LibXML-&gt;new&#40;&#41;;
         $parser-&gt;expand_xinclude&#40;1&#41;;
@@ -35,7 +39,7 @@ EOF
         my $doc = $parser-&gt;parse_string&#40;$string&#41;;
 
         ok&#40;$doc&#41;;
-        ok&#40;$doc-&gt;string_value&#40;&#41;, &#34;\ntest\n..\nbar..\n&#34;&#41;;
+        ok&#40;$doc-&gt;string_value&#40;&#41;, &#34;\ntest\n..\nbar..\nbarbar\n&#34;&#41;;
 }
 
 {
@@ -73,6 +77,58 @@ EOF
         ok&#40;$doc-&gt;string_value&#40;&#41;, &#34;\ntest\n..\n\n         \n   \n&#34;&#41;;
 }
 
+{
+        my $string = &lt;&lt;EOF;
+&lt;x xmlns:xinclude=&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/2001/XInclude">http://www.w3.org/2001/XInclude</a></span>&#34;&gt;
+&lt;xml&gt;test
+&lt;xinclude:include href=&#34;/example/test2.xml&#34;/&gt;
+&lt;xinclude:include href=&#34;/xmldom/test2.xml&#34;/&gt;&lt;/xml&gt;
+&lt;/x&gt;
+EOF
+        my $string2 = &lt;&lt;EOF;
+&lt;x xmlns:xinclude=&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/2001/XInclude">http://www.w3.org/2001/XInclude</a></span>&#34;&gt;
+&lt;tmp/&gt;&lt;xml&gt;foo..&lt;xinclude:include href=&#34;/example/test2.xml&#34;/&gt;bar&lt;/xml&gt;
+&lt;/x&gt;
+EOF
+
+
+        my $icb = XML::LibXML::InputCallback-&gt;new&#40;&#41;;
+        ok&#40;$icb&#41;;
+
+        my $open_xml2 = sub {
+                my $uri = shift;
+                my $parser = XML::LibXML-&gt;new;
+                $parser-&gt;expand_xinclude&#40;1&#41;;
+                $parser-&gt;input_callbacks&#40;$icb&#41;;
+
+                my $dom = $parser-&gt;parse_string&#40;$string2&#41;;
+                ok&#40;$dom&#41;;
+        
+                return $dom;
+        };
+
+        $icb-&gt;register_callbacks&#40; [ \&#38;match_xml, $open_xml2,
+                                    \&#38;read_xml, \&#38;close_xml ] &#41;;
+
+        $icb-&gt;register_callbacks&#40; [ \&#38;match_hash2, \&#38;open_hash,
+                                    \&#38;read_hash, \&#38;close_hash ] &#41;;
+
+        my $parser = XML::LibXML-&gt;new&#40;&#41;;
+        $parser-&gt;expand_xinclude&#40;1&#41;;
+
+        $parser-&gt;match_callback&#40; \&#38;match_file &#41;;
+        $parser-&gt;open_callback&#40; \&#38;open_file &#41;;
+        $parser-&gt;read_callback&#40; \&#38;read_file &#41;;
+        $parser-&gt;close_callback&#40; \&#38;close_file &#41;;
+
+        $parser-&gt;input_callbacks&#40;$icb&#41;;
+
+        my $doc = $parser-&gt;parse_string&#40;$string&#41;;
+
+        ok&#40;$doc&#41;;
+        ok&#40;$doc-&gt;string_value&#40;&#41;, &#34;\ntest\n..\n\nfoo..bar..bar\n\n&#34;&#41;;
+}
+
 
 # --------------------------------------------------------------------- #
 # CALLBACKS
@@ -173,3 +229,40 @@ sub match_hash2 {
                 return 1;
         }
 }
+
+# --------------------------------------------------------------------- #
+# callback set 4 &#40;perl xml reader&#41;
+# --------------------------------------------------------------------- #
+sub match_xml {
+        my $uri = shift;
+        if &#40; $uri =~ /^\/xmldom\// &#41;{
+                ok&#40;1&#41;;
+                return 1;
+        }
+}
+
+sub open_xml {
+        my $uri = shift;
+        my $dom = XML::LibXML-&gt;new-&gt;parse_string&#40;q{&lt;?xml version=&#34;1.0&#34;?&gt;&lt;foo&gt;&lt;tmp/&gt;barbar&lt;/foo&gt;}&#41;;
+        ok&#40;$dom&#41;;
+
+        return $dom;
+}
+
+sub read_xml {
+        my $dom   = shift;
+        my $buflen = shift;
+
+        my $tmp = $dom-&gt;documentElement-&gt;findnodes&#40;&#39;tmp&#39;&#41;-&gt;shift;
+        my $rv = $tmp ? $dom-&gt;toString : &#34;&#34;;
+        $tmp-&gt;unbindNode if&#40;$tmp&#41;;
+
+        ok&#40;1&#41;;
+        return $rv;
+}
+
+sub close_xml {
+        my $dom   = shift;
+        undef $dom;
+        ok&#40;1&#41;;
+}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;29&nbsp;15:41:12&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;19&nbsp;05:29:57&nbsp;2011</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Dec 29 15:41:07 2009, dfrett wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sun Mar 07 06:31:18 2004, PHISH wrote:
<div class="message-stanza open">&gt; &gt; [BORISZ - Sat Nov 1 11:04:24 2003]:
&gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; Hi,
&gt; &gt; &gt;
&gt; &gt; &gt; whenever I try to use or create a parser inside a callback
</div></div>&gt; function
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; like match_callback, open_callback, close_callback or
</div></div>&gt; read_callback I
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; get everything from segfault&#39;s to &#39;Attempt to free unreferenced
&gt; &gt; &gt; scalar&#39;.
</div>&gt; &gt;
&gt; &gt; the segfault disapears with 1.57.
&gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; Attached is a testcase the example/cb_example.pl with only one
</div></div>&gt; more
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; line inside open_uri.
</div>&gt; &gt;
&gt; &gt; However, the &#34;bug&#34; itself still remains.
&gt; &gt;
&gt; &gt; The sollution is: don&#39;t call a parser from within a callback!
&gt; &gt;
&gt; &gt; The reason for this is: XML::LibXML will override the existing
</div>&gt; parser
<div class="message-stanza open">&gt; &gt; callbacks &#40;which are globally stored in libxml2&#41;. The effect is,
</div>&gt; that
<div class="message-stanza open">&gt; &gt; the main parser will not get any data at all while the nested parser
&gt; &gt; succeeds.
&gt; &gt;
&gt; &gt; I am not shure if adding multithreading code to XML::LibXML can
</div>&gt; solve
<div class="message-stanza open">&gt; &gt; this particular problem.
&gt; &gt;
&gt; &gt; christian
&gt; &gt;
</div>&gt; 
&gt; I was able to get a nested parser instance working correctly by
&gt; changing how
&gt; init_callbacks and cleanup_callbacks worked. instead of always calling
&gt; lib_init_callbacks and lib_cleanup_callbacks when starting and
&gt; finishing a
&gt; parsing process, a $_NB_NESTED_DEPTH global is used to track if
&gt; parsing is
&gt; being started within another parsing instance and the
&gt; lib_init_callbacks/lib_cleanup_callbacks is only called for the
&gt; outermost
&gt; parser.
&gt; 
&gt; here is a git branch I setup that addresses this issue:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/frett/perl-libxml/commits/NestedParsing">http://github.com/frett/perl-libxml/commits/NestedParsing</a></span>
&gt; 
&gt; attached are 2 separate patches.
&gt; The first patch &#40;libxml-01.patch&#41; allows xml to be parsed correctly
&gt; from within
&gt; an input callback, but does not completely support sharing an
&gt; InputCallback
&gt; object between the outer and inner parsers .
&gt; The second patch &#40;libxml-02.patch&#41; includes patch 1 and additionally
&gt; allows the
&gt; InputCallback object to be shared between the outer and inner parsers,
&gt; but
&gt; changes how legacy local parser callbacks are handled and could
&gt; potentially
&gt; break user&#39;s code if the user happens to be using legacy local
&gt; callbacks and
&gt; subclasses XML::LibXML::InputCallback and overrides the init_callbacks
&gt; method
&gt; &#40;I highly doubt anyone has done this&#41;.
&gt; 
&gt; the second patch also fixes the underlying issue behind RT#51086
&gt; 
</div>
Can you give new patches to the repository at:

<span class="clickylink"><a target="new" rel="nofollow" href="https://bitbucket.org/shlomif/perl-xml-libxml">https://bitbucket.org/shlomif/perl-xml-libxml</a></span> 

Regards,

-- Shlomi Fish

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; -Daniel Frett
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;19&nbsp;10:12:25&nbsp;2011</span>
    <span class="description">daniel.frett [...] ccci.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> daniel.frett [...] ccci.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Jun 19 05:29:57 2011, SHLOMIF wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Can you give new patches to the repository at:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://bitbucket.org/shlomif/perl-xml-libxml">https://bitbucket.org/shlomif/perl-xml-libxml</a></span> 
&gt; 
&gt; Regards,
&gt; 
&gt; -- Shlomi Fish
</div>
yeah, thanks for taking over maintenance of this module.

-Daniel Frett
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;09&nbsp;12:42:43&nbsp;2011</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi all,

I&#39;m resolving this bug because the patches were applied. If there is
more to do, please open a new report or reply to this bug to reopen it
&#40;with an explanation and a patch.&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;09&nbsp;12:42:44&nbsp;2011</span>
    <span class="description">SHLOMIF [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
