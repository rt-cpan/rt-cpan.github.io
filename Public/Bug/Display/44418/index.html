<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #44418 for XML-LibXML: Perl internal representation and output encoding</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #44418 for XML-LibXML: Perl internal representation and output encoding</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=XML-LibXML">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=XML-LibXML">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=XML-LibXML">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=XML-LibXML">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-LibXML">XML-LibXML CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">44418</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=XML-LibXML">XML-LibXML</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
MARKOV [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-37350-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.69    </td>
  </tr>
  <tr id="CF-37351-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




umlauts<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/580632/293310/umlauts">
Thu Mar 19 05:46:39 2009 (284b) by MARKOV [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=44418">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-580632" href="/Public/Bug/Display.html?id=44418#txn-580632">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;19&nbsp;05:46:39&nbsp;2009</span>
    <span class="description">MARKOV [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Perl internal representation and output encoding</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/580632/293307/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/293307">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry to bother you again, with a question you have answered hundreds of
times before, but each time slightly different.

On the output side of $doc-&gt;toString, we have a byte-stream.  On the
Perl side we have strings in &#34;Perl internal representation&#34;, which can
be either &#40;something close to&#41; latin1 or &#40;something close to&#41; utf-8.  As
user, you expect it to DWIM: the differences should be invisible.

But, when I run the attached script &#40;the string contains three
characters in latin1... may get mutilated during transport&#41;, then I see
that they are not represented by utf-8 bytes in the output... still
latin1.  This breaks the parser on the other side.

Of course, I can utf8::upgrade all the data fields myself.  On dozens of
spots.  And all other XML::LibXML users can do the same.  But this does
not DWIM, is more error prone, more work and probably slower than
calling the upgrade within XML::LibXML.

I was under the impression that this did work correctly some time ago,
but in my current setting it fails: Perl5.10, libxml2.7.3, XML::LibXML 1.69.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> umlauts</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/580632/293310/umlauts">Download umlauts</a><br />
<span class="downloadcontenttype">application/octet-stream 284b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-580643" href="/Public/Bug/Display.html?id=44418#txn-580643">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;19&nbsp;06:33:10&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/580643/293316/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/293316">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne čt 19.bře.2009 05:46:39, MARKOV napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sorry to bother you again, with a question you have answered 
</div>hundreds of
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; times before, but each time slightly different.
</div>
not again:-&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On the output side of $doc-&gt;toString, we have a byte-stream.  On the
&gt; Perl side we have strings in &#34;Perl internal representation&#34;, which 
</div>can
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; be either &#40;something close to&#41; latin1 or &#40;something close to&#41; utf-8. 
</div>
Not exactly true. The strings in &#34;Perl internal representation&#34; are 
either &#40;something close to&#41; UTF-8 &#40;UTF8 flagged&#41;, yes, or octet 
streams in unknown encoding &#40;!&#41;. 

That Perl &#40;to make the western world happy&#41; deliberately chooses to 
assume latin-1 when it must convert an unknown octet stream to UTF-8 
is a completely different matter.

&#40;Not that we could do anything about it, but much better solution 
would have been to always warn or even die if a non-ascii octet from a 
octet stream is to be upgraded to a character&#41;.

 As
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; user, you expect it to DWIM: the differences should be invisible.
&gt; 
&gt; But, when I run the attached script &#40;the string contains three
&gt; characters in latin1... may get mutilated during transport&#41;, then I 
</div>see
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; that they are not represented by utf-8 bytes in the output... still
&gt; latin1.  This breaks the parser on the other side.
&gt; 
&gt; Of course, I can utf8::upgrade all the data fields myself.  On 
</div>dozens of
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; spots. 
</div>
This is not true, you just have add one simple line to your code:

use encoding &#39;iso-8859-1&#39;;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; And all other XML::LibXML users can do the same.  
</div>
yes, in similar case they should, in fact, do the above!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; But this does
&gt; not DWIM,
</div>
DWIM always depends on how you look at it and there is never a perfect 
compromise between DWIM and consistency of behavior; the latter is for 
me more critical.

The problem is not in the toString output, but on the imput. 
XML::LibXML&#39;s APIs take scalars. If they are strings &#40;UTF8 flagged&#41; 
there should be no problem. If they are bytes &#40;no UTF8 flag&#41;, 
XML::LibXML assumes they are row octet sequences in the encoding of 
the XML document. This behavior is what makes inconsistent with how 
Perl treats unknown octet streams. But I&#39;m afraid it is too late to 
change it unless we want to make even more harm.

HTH,
-- Petr
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-580644" href="/Public/Bug/Display.html?id=44418#txn-580644">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;19&nbsp;06:33:11&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-580647" href="/Public/Bug/Display.html?id=44418#txn-580647">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;19&nbsp;06:33:11&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-580653" href="/Public/Bug/Display.html?id=44418#txn-580653">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;19&nbsp;06:57:47&nbsp;2009</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #44418] Perl internal representation and output encoding</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 19 Mar 2009 11:57:21 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Petr Pajas via RT &lt;bug-XML-LibXML [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/580653/293323/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/293323">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Thank you for responding so fast.

* Petr Pajas via RT &#40;bug-XML-LibXML@rt.cpan.org&#41; [090319 10:33]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; On the output side of $doc-&gt;toString, we have a byte-stream.  On the
&gt; &gt; Perl side we have strings in &#34;Perl internal representation&#34;, which 
</div>&gt; can
<div class="message-stanza open">&gt; &gt; be either &#40;something close to&#41; latin1 or &#40;something close to&#41; utf-8. 
</div>&gt; 
&gt; Not exactly true. The strings in &#34;Perl internal representation&#34; are 
&gt; either &#40;something close to&#41; UTF-8 &#40;UTF8 flagged&#41;, yes, or octet 
&gt; streams in unknown encoding &#40;!&#41;. 
</div>
There has been a lot of discussion about the subject recently &#40;also
on YAPCs etc&#41;... and perlunicode confirm my stand:

  If strings operating under byte semantics and strings with Unicode
  character data are concatenated, the new string will be created by
  decoding the byte strings as ISO 8859-1 &#40;Latin-1&#41;, even if the old
  Unicode string used EBCDIC.  This translation is done without regard
  to the system&#39;s native 8-bit encoding.

In case where Unicode and non-unicode string representations are
mixed &#40;in our case&#41;, the non-unicode strings are interpreted as latin1.
It is not ASCII!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This is not true, you just have add one simple line to your code:
&gt; use encoding &#39;iso-8859-1&#39;;
</div>
Yes, this helps.  Should be the default.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; But this does
&gt; &gt; not DWIM,
</div>&gt; 
&gt; DWIM always depends on how you look at it and there is never a perfect 
&gt; compromise between DWIM and consistency of behavior; the latter is for 
&gt; me more critical.
</div>
Correct behavior is the most important, I fully agree.  The correct
behavior is &#34;latin1&#34; default for byte encoding.  Seems to me as a
simple change.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-580654" href="/Public/Bug/Display.html?id=44418#txn-580654">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;19&nbsp;06:57:47&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;rejected&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-580664" href="/Public/Bug/Display.html?id=44418#txn-580664">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;19&nbsp;07:38:17&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/580664/293333/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/293333">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne čt 19.bře.2009 06:57:47, Mark@Overmeer.net napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Thank you for responding so fast.
&gt; 
&gt; * Petr Pajas via RT &#40;bug-XML-LibXML@rt.cpan.org&#41; [090319 10:33]:
<div class="message-stanza open">&gt; &gt; &gt; On the output side of $doc-&gt;toString, we have a byte-stream.  On 
</div></div>the
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; &gt; Perl side we have strings in &#34;Perl internal representation&#34;, 
</div></div>which 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; can
<div class="message-stanza open">&gt; &gt; &gt; be either &#40;something close to&#41; latin1 or &#40;something close to&#41; 
</div></div></div>utf-8. 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; 
&gt; &gt; Not exactly true. The strings in &#34;Perl internal representation&#34; 
</div></div>are 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; either &#40;something close to&#41; UTF-8 &#40;UTF8 flagged&#41;, yes, or octet 
&gt; &gt; streams in unknown encoding &#40;!&#41;. 
</div>&gt; 
&gt; There has been a lot of discussion about the subject recently &#40;also
&gt; on YAPCs etc&#41;... and perlunicode confirm my stand:
&gt; 
&gt;   If strings operating under byte semantics and strings with Unicode
&gt;   character data are concatenated, the new string will be created by
&gt;   decoding the byte strings as ISO 8859-1 &#40;Latin-1&#41;, even if the old
&gt;   Unicode string used EBCDIC.  This translation is done without 
</div>regard
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;   to the system&#39;s native 8-bit encoding.
</div>
Yes, you edited out the part of my response where I was basically 
ranting about the same. Sure I never said the default is or should be 
native  8bit encoding.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In case where Unicode and non-unicode string representations are
&gt; mixed &#40;in our case&#41;, the non-unicode strings are interpreted as 
</div>latin1.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It is not ASCII!
</div>
nobody said it was otherwise.

I said that in this respect XML::LibXML has chosen &#40;long time before I 
took over its maintenance&#41; to assume all non-unicode string to be a 
byte stream in the ENCODING OF THE DOCUMENT. Not latin-1, not an 
encoding enforce by locale, not ascii. Maybe it was not a good 
decision, but once the decision was made, there is no going back.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; This is not true, you just have add one simple line to your code:
&gt; &gt; use encoding &#39;iso-8859-1&#39;;
</div>&gt; 
&gt; Yes, this helps.  Should be the default.
&gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; But this does
&gt; &gt; &gt; not DWIM,
</div>&gt; &gt; 
&gt; &gt; DWIM always depends on how you look at it and there is never a 
</div></div>perfect 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; compromise between DWIM and consistency of behavior; the latter is 
</div></div>for 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; me more critical.
</div>&gt; 
&gt; Correct behavior is the most important, I fully agree.  The correct
&gt; behavior is &#34;latin1&#34; default for byte encoding.  Seems to me as a
&gt; simple change.
</div>
I agree the change is *possible*,  yes it is *simple*, it would 
probably indeed make XML::LibXML behave more like other Perl 
interfaces, that&#39;s all true. But that&#39;s a dream about another world.

The change would completely BREAK EXISTING CODE that uses XML::LibXML 
the way it behaves today! 

Even if you convinced  me that the behavior you suggest would make 100 
times better user experience, I&#39;m not taking the responsibility for 
breaking existing code, that&#39;s it.

So all I can do is to be terribly sorry for you to have to do what the 
rest of the world where local alphabet is not covered by latin-1 has 
to do anyway. Perl chose to made from latin-1 a special exception. Ok, 
XML::LibXML did not &#40;it chose to favor the native encoding of the 
document instead&#41;, and it is too *late* to take those decisions back 
now.

Hopefully you&#39;ll understand my point of view,
-- Petr
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-580667" href="/Public/Bug/Display.html?id=44418#txn-580667">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;19&nbsp;07:38:18&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-580694" href="/Public/Bug/Display.html?id=44418#txn-580694">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;19&nbsp;08:57:25&nbsp;2009</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #44418] Perl internal representation and output encoding</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 19 Mar 2009 13:57:07 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Petr Pajas via RT &lt;bug-XML-LibXML [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/580694/293348/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/293348">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Petr Pajas via RT &#40;bug-XML-LibXML@rt.cpan.org&#41; [090319 11:38]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Yes, you edited out the part of my response where I was basically 
&gt; ranting about the same. Sure I never said the default is or should be 
&gt; native  8bit encoding.
</div>
You said:
   That Perl &#40;to make the western world happy&#41; deliberately chooses to
   assume latin-1 when it must convert an unknown octet stream to UTF-8
   is a completely different matter
So, here you agree that Perl choose for Latin-1 as default.  This is
an official definition.

Actually, Perl has three kinds of strings:
  . bytes
  . latin1
  . utf-8
You cannot distiguish between the first two in the Perl internals, which
is a pity.  Juerd suggested last year a BLOB tie to the first... but that
is not in for 5.12 &#40;yet&#41;

So, I think your formulation is not exactly to the point.  If you use a
scalar &#40;not flagged as UTF8&#41; in a string operation, than the sequence of
bytes has to be interpreted as latin1.  If you use the same scalar value
for other things &#40;like IO&#41; than Perl does not know what the meaning of
the content is: either raw bytes or latin1 text.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I said that in this respect XML::LibXML has chosen &#40;long time before I 
&gt; took over its maintenance&#41; to assume all non-unicode string to be a 
&gt; byte stream in the ENCODING OF THE DOCUMENT. Not latin-1, not an 
&gt; encoding enforce by locale, not ascii. Maybe it was not a good 
&gt; decision, but once the decision was made, there is no going back.
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The change would completely BREAK EXISTING CODE that uses XML::LibXML 
&gt; the way it behaves today! 
</div>
I do agree that we should never break existing code, and I think you are
a fantastic maintainer of the module.  Honestly.

Does changing to the correct default break existing code?
As demonstrated in my example, the output of XML::LibXML is broken when
encoding is not provided.  So: in real life, that code should not exist
&#40;and if it exists, it is a sleeping disaster to happen&#41;.

Can you give me an example of an application which now works correctly,
but will stop working when we set the default?  &#40;Sorry for consuming
your time&#41;
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-580695" href="/Public/Bug/Display.html?id=44418#txn-580695">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;19&nbsp;08:57:25&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;rejected&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-580710" href="/Public/Bug/Display.html?id=44418#txn-580710">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;19&nbsp;09:28:43&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/580710/293357/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/293357">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne čt 19.bře.2009 08:57:25, Mark@Overmeer.net napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Does changing to the correct default break existing code?
</div>
You still keep claiming that latin1 is the correct default. But is 
passing a string to an API really necessary a string operation that 
should cause the auto-conversion from latin1? And is it really so if 
the documentation of the API claims otherwise? It explicitly says:

&#34;DOM methods also accept binary strings in the original encoding of 
the document to which the node belongs &#34;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; As demonstrated in my example, the output of XML::LibXML is broken 
</div>when
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; encoding is not provided.  So: in real life, that code should not 
</div>exist
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#40;and if it exists, it is a sleeping disaster to happen&#41;.
</div>
I agree, we should do sanity checks, i.e. verify that the data passed 
to the functions are in the correct encoding. In this we trust the 
user &#40;as we do in some other things, e.g. the correct use of 
namespaces, element names, etc.&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Can you give me an example of an application which now works 
</div>correctly,
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; but will stop working when we set the default?  &#40;Sorry for consuming
&gt; your time&#41;
</div>
Any application whose default encoding is not necessarily latin1 and 
that does no &#39;use utf8&#39;, &#39;:utf8&#39;, Encode or utf8::upgrade/downgrade, 
but simply reads data, processes them, puts the results to a DOM. This 
is typical for scripts that predate perl-5.6.1. There are many of them 
still in use on many obscure platforms &#40;I&#39;m still sometimes asked for 
support from the admins that upgrade XML::LibXML on those servers&#41;.

Here is a practical example: you have a base of text paragraphs in 
latin-2 encoding. You open it, read the data &#40;the script does not set 
any I/O layers&#41;, create a iso-8859-2 encoded document and populate it 
with the data. You can do DOM transformations or apply XSLT and 
$doc-&gt;toString to print the result to a file. 

For latin-2 you can substitute any encoding that libxml2 supports.

-- Petr
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-580713" href="/Public/Bug/Display.html?id=44418#txn-580713">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;19&nbsp;09:28:45&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-580719" href="/Public/Bug/Display.html?id=44418#txn-580719">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;19&nbsp;10:55:05&nbsp;2009</span>
    <span class="description">webmaster [...] nlnet.nl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #44418] Perl internal representation and output encoding</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 19 Mar 2009 15:54:39 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Petr Pajas via RT &lt;bug-XML-LibXML [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> NLnet webmaster &lt;webmaster [...] nlnet.nl&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/580719/293364/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/293364">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Petr Pajas via RT &#40;bug-XML-LibXML@rt.cpan.org&#41; [090319 13:28]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; You still keep claiming that latin1 is the correct default. But is 
&gt; passing a string to an API really necessary a string operation that 
&gt; should cause the auto-conversion from latin1? And is it really so if 
&gt; the documentation of the API claims otherwise? It explicitly says:
</div>
Well, that is a point of view.  In my opinion, XML is a textual
interface.  So yes, I do see all fields passed into an XML library
as strings, also the numbers.  For a classical RPC interface, it
would be different.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#34;DOM methods also accept binary strings in the original encoding of 
&gt; the document to which the node belongs &#34;
</div>
The problem only appears when you are constructing a document, which
means that it will need to be made fit for a document.  There is no
problem in the reader.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Can you give me an example of an application which now works correctly,
&gt; &gt; but will stop working when we set the default?  &#40;Sorry for consuming
&gt; &gt; your time&#41;
</div>&gt; 
&gt; Any application whose default encoding is not necessarily latin1 and 
&gt; that does no &#39;use utf8&#39;, &#39;:utf8&#39;, Encode or utf8::upgrade/downgrade, 
&gt; but simply reads data, processes them, puts the results to a DOM. This 
&gt; is typical for scripts that predate perl-5.6.1. There are many of them 
&gt; still in use on many obscure platforms &#40;I&#39;m still sometimes asked for 
&gt; support from the admins that upgrade XML::LibXML on those servers&#41;.
</div>
But I do not see how they would suffer from a correct default.
For instance a none utf8-aware application is passing bytes to the
XML::LibXML library, which outputs it again as UTF-8 can break on any
print-statement in its code.  Any application which does not handle pure
ASCII will break eventually.  On the other hand, no application which
handles pure ASCII will have a problem with the latin1 default.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Here is a practical example: you have a base of text paragraphs in 
&gt; latin-2 encoding. You open it, read the data &#40;the script does not set 
&gt; any I/O layers&#41;, create a iso-8859-2 encoded document and populate it 
&gt; with the data. You can do DOM transformations or apply XSLT and 
&gt; $doc-&gt;toString to print the result to a file. 
&gt; For latin-2 you can substitute any encoding that libxml2 supports.
</div>
Ouch, this is very bad practice in a unicode world.  And XML is a
unicode World.  You do provide an explicit conversion at the output
side of the script &#40;::Document-&gt;new&#40;&#39;1.0&#39;, &#39;latin2&#39;&#41;&#41; but neglecting the
incoming side.  Yaiks!  And later, in the next generation of the code,
people understand that all encodings besides UTF-8 are deprecated for
XML... they change it... and everything falls apart.

Trying to find a solution which works around the above code.
To avoid extensive bughut by people &#40;even those very common to utf8 in
Perl, like me&#41;.  Would it be possible to
  , produce a warning &#40;when warnings are enabled&#41; when people create
    documents in non-utf8 encoding, and where the encoding is not
    explicitly set.  And default to latin1 in all utf8 output cases.
-- 
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-580720" href="/Public/Bug/Display.html?id=44418#txn-580720">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;19&nbsp;10:55:05&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;rejected&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-580757" href="/Public/Bug/Display.html?id=44418#txn-580757">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;19&nbsp;12:06:58&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/580757/293388/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/293388">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne čt 19.bře.2009 10:55:05, webmaster@nlnet.nl napsal&#40;a&#41;:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; But I do not see how they would suffer from a correct default.
&gt; For instance a none utf8-aware application is passing bytes to the
&gt; XML::LibXML library, which outputs it again as UTF-8 can break on 
</div>any
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; print-statement in its code.  
</div>
Not really. This kind of XML::LibXML applications that predate any 
unicode-aware perl were aware of the fact that the strings returned by 
XML::LibXML were utf-8 encoded &#40;on old versions of Perl they did not 
carry the UTF-8 flag&#41;, so the first thing the application did was 
applying XML::LibXML&#39;s old &#34;decodeFromUTF8&#34; to convert back to the 
document&#39;s encoding &#40;which was fixed&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Any application which does not handle pure
&gt; ASCII will break eventually.  On the other hand, no application 
</div>which
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; handles pure ASCII will have a problem with the latin1 default.
&gt; 
<div class="message-stanza open">&gt; &gt; Here is a practical example: you have a base of text paragraphs in 
&gt; &gt; latin-2 encoding. You open it, read the data &#40;the script does not 
</div></div>set 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; any I/O layers&#41;, create a iso-8859-2 encoded document and populate 
</div></div>it 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; with the data. You can do DOM transformations or apply XSLT and 
&gt; &gt; $doc-&gt;toString to print the result to a file. 
&gt; &gt; For latin-2 you can substitute any encoding that libxml2 supports.
</div>&gt; 
&gt; Ouch, this is very bad practice in a unicode world. 
</div>
Perl was not a unicode world back then and if you ever worked for a 
larger company you would know how things are done behind the scenes. 
That&#39;s scary sometimes!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; And XML is a
&gt; unicode World.  You do provide an explicit conversion at the output
&gt; side of the script &#40;::Document-&gt;new&#40;&#39;1.0&#39;, &#39;latin2&#39;&#41;&#41; but neglecting 
</div>the
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; incoming side.
</div>
The incomming encoding is fixed, you know it apriori. You don&#39;t 
necessarily have to think of an application used by public, but of an 
in-door solution within a CGI script or something like that. Also, 
prior to perl 5.6.1 there was nothing like I/O layers. 

Also, the aforementioned scenario works for UTF-8 documents too. You 
read the input data in UTF-8, but the old way, as UTF-8 byte streams, 
as such you pass them to XML::LibXML to populate a DOM. The only 
problem can arise when you do a print on something returned from the 
DOM, since you attempt to print characters when operating in byte 
semantics.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  Yaiks!  And later, in the next generation of the code,
&gt; people understand that all encodings besides UTF-8 are deprecated 
</div>for
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; XML... they change it... and everything falls apart.
</div>
yes, except that they will never do; they do not develop the code 
anymore, they just want to make sure that it works &#40;with the latest = 
safest libxml2&#41;.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Trying to find a solution which works around the above code.
</div>
ok...

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; To avoid extensive bughut by people &#40;even those very common to utf8 
</div>in
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Perl, like me&#41;.  Would it be possible to
&gt;   , produce a warning &#40;when warnings are enabled&#41; when people create
&gt;     documents in non-utf8 encoding, and where the encoding is not
&gt;     explicitly set.
</div>
now I&#39;m lost. You really want XML::LibXML to issue a warning whenever 
somebody does createDocument&#40;&#39;1.0&#39;,&#39;iso-8895-2&#39;&#41;? Or just if the 
document&#39;s encoding is utf-8 but the user passes non-utf8-flagged 
data?

The latter would seem reasonable, I&#39;m for warnings. But I&#39;m still not 
sure about the latin1 conversion even in this case. Note my above 
remark that latin2 can be replaced by UTF-8 in my previous example, so 
even this would be a change in behavior; result would be like in 
Encode::decode&#40;&#39;latin-1&#39;,$utf8_encoded_string&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; And default to latin1 in all utf8 output cases.
</div>
What does all utf8 output cases mean here?

-- Petr
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-580992" href="/Public/Bug/Display.html?id=44418#txn-580992">#</a>      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;20&nbsp;06:30:54&nbsp;2009</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #44418] Perl internal representation and output encoding</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 20 Mar 2009 11:30:38 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Petr Pajas via RT &lt;bug-XML-LibXML [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/580992/293516/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/293516">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Petr Pajas via RT &#40;bug-XML-LibXML@rt.cpan.org&#41; [090319 16:06]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Not really. This kind of XML::LibXML applications that predate any 
&gt; unicode-aware perl were aware of the fact that the strings returned by 
&gt; XML::LibXML were utf-8 encoded...
</div>
On some moment, people must realize that the World goes on, and
they have to get their unicode correctly.  You can help them forward.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; To avoid extensive bughut by people &#40;even those very common to utf8 
&gt; &gt; in Perl, like me&#41;.  Would it be possible to
&gt; &gt;   , produce a warning &#40;when warnings are enabled&#41; when people create
&gt; &gt;     documents in non-utf8 encoding, and where the encoding is not
&gt; &gt;     explicitly set.
</div>&gt; 
&gt; now I&#39;m lost. You really want XML::LibXML to issue a warning whenever 
&gt; somebody does createDocument&#40;&#39;1.0&#39;,&#39;iso-8895-2&#39;&#41;? Or just if the 
&gt; document&#39;s encoding is utf-8 but the user passes non-utf8-flagged 
&gt; data?
</div>
When &#34;createDocument&#40;&#39;1.0&#39;,&#39;iso-8895-2&#39;&#41;&#34; but without
&#34;use encoding &#39;iso-8895-2&#39;&#34;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The latter would seem reasonable, I&#39;m for warnings. But I&#39;m still not 
&gt; sure about the latin1 conversion even in this case. Note my above 
&gt; remark that latin2 can be replaced by UTF-8 in my previous example, so 
&gt; even this would be a change in behavior; result would be like in 
&gt; Encode::decode&#40;&#39;latin-1&#39;,$utf8_encoded_string&#41;.
</div>
Hum... even worse.

Well, now I have two ideas:
  1. createDocument&#40;&#39;1.0&#39;,  xxx&#41; but without &#34;use encoding &#39;yyy&#39;&#34;
     enforce &#40;via warning&#41; the use of &#34;use encoding&#34; in all programs
     which use XML::LibXML
  2. jump version to 2.00, removing all cruft made for Perl&#39;s pre-
     unicode era &#40;require Perl 5.8.4 - april 2004&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; And default to latin1 in all utf8 output cases.
</div>&gt; What does all utf8 output cases mean here?
</div>
I ment: in all cases where the output is in utf-8
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
drs Mark A.C.J. Overmeer                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-668796" href="/Public/Bug/Display.html?id=44418#txn-668796">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;25&nbsp;09:09:54&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/668796/343581/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/343581">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 137b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m postponing this issue for now - please do not reopen this bug unless
there is something entirely new to say about the topic.

-- Petr
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-668799" href="/Public/Bug/Display.html?id=44418#txn-668799">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;25&nbsp;09:09:57&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-668912" href="/Public/Bug/Display.html?id=44418#txn-668912">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;25&nbsp;14:36:46&nbsp;2009</span>
    <span class="description">phish [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/668912/343685/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/343685">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 5.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Sep 25 09:09:54 2009, PAJAS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m postponing this issue for now - please do not reopen this bug unless
&gt; there is something entirely new to say about the topic.
&gt; 
&gt; -- Petr
</div>
There are some considerations to be taken into account here.

For some &#40;cloudy&#41; reason Perl did not made the shift to UFT8 for
internal character representation. 

However, the XML standard makes a strong statement about UTF8. UTF8 is
in fact the default encoding for XML documents and also a must for the
internal string representation of DOMs. libxml2 complies to these
standards. This means that we always get UTF8 from the library&#39;s DOM
functions or we get errors if people decide to do nasty things outside. 

In the following, I try to clarify the decision we took during the early
development of XML::LibXML. 

The XML standard also defines how to specify if a document is in a
different encoding. This is when an specific encoding is provided in the
XML declaration. However, this is ONLY for XML documents and has
absolutely no meaning for the data in DOM trees. In DOM trees by
definition all data is UTF8 encoded and there are absolutely no
exceptions. Additionally, DOM trees provide information in which
encoding the output should be provided if the entire tree is serialized
&#40;but not fragments or sub-trees&#41;. 

Now with perl things are nasty and there were looooooooooooong
discussions about encoding and utf8 handling within perl &#40;besides huge
troubles in making things work correctly&#41;. 

AFAIK the only character encoding that all perl version &gt; 5.6 can
actually identify is UTF8. All other character encodings including
latin-1 &#40;which has been outdated for almost a decade, btw.&#41; are
indistinguishable for the perl internals. 

The problem with DWIM is that people dump all kind of octet streams and
hope that they will work as strings with the correct encoding. Even with
&#34;use encoding&#34; this problem is not solved. Just take the example: lets
take a XML document that is _explicitly_ encoded in ISO-8859-6 and perl
_assuming_ everything is ISO-8859-2 unless it is marked as UTF8, because
some trainee developer decided that latin-2 is a good thing. So if one
dumps a string from the DOM in the XML&#39;s native encoding &#40;that is
ISO-8859-6&#41; and then adds it back to the DOM, what kind of information
would people assume to show up? The DWIM metaphor will automatically say
the original string &#40;in ISO-8859-6&#41; and NOT in the wrong and almost
entirely incompatible ISO-8859-2 encoded version.

The problem with perl&#39;s &#34;use encoding&#34; is that it allows people to tell
what perl should _assume_ a string is encoded in, even if most parts of
the additional logic _know_ that it is not &#40;in the example XML::LibXML
knows that everything internal is UTF8 and the external representation
is ISO-8859-6&#41;.

Because UTF8 is THE STANDARD encoding for XML and DOM, we decided &#40;after
long discussions on the perl-xml list and in the related IRC channels&#41;
that in case of doubt we should always opt for what we KNOW while
running the code and not for what a programmer might have ASSUMED at the
time of writing it. The reason for this decision was that programmers
are almost always wrong in predicting encoding related aspects of their
code. Unfortunately, the perl development seems to judge assumptions
higher than knowledge &#40;if the earlier statements are correct, and there
I have doubts&#41;. 

At that time we also decided that the correct behaviour for using
XML::LibXML would be, that all DOM functions expect and return UTF8
strings by default. All non-UTF8 octet streams are assumed to be the
result of some IO operation and are in the same encoding as the
document. If a programmer wants to insert some nasty encoding that is
not UTF8 then it has to be upgraded to UTF8 first, unless the encoding
is the same as the encoding of the document. The last bit we decided for
the DWIM reasons given in the example. In order to meet these
requirements, XML::LibXML already came with proper utf8 encoding
functions before perl had a working &#34;use encoding&#34; feature.

If a programmer decides not to &#34;use encoding utf8&#34; when working with XML
and DOM data structures than - given to the related standards - we have
good reasons to expect that the programmer actually MEANS that the
consistency of the data is irrelevant and that the result of an
operation can be random. 

In this sense the correct usage of XML::LibXML has to follow 5 simple rules

1. ALWAYS use encoding UTF8  
2. disable perl&#39;s auto upgrading of strings during all IO operations and
leave the tricky bits to libxml2.
3. assure that no arbitrary octet streams get near the DOM.
4. upgrade all strings that should get into the DOM to UTF8 
5. never try to extract the XML-document&#39;s original encoding from the
DOM unless while serializing the entire DOM. 

Usually this means for a programmer is happy with &#34;use encoding utf8&#34;
and mostly ignoring the external XML representation of the DOM.

The correctness of this decision is related to the XML related
specifications. There might be conflicts with other views or discussions
related to other parts of perl development.

Most importantly is that during the early development we tried to make
the XML usage as straight forward as possible for the perl developers. 

I hope this comment clarifies the reasoning behind XML::LibXML&#39;s current
string encoding approach. 

If encoding issues are increasingly getting into the way of developers,
the standard conform and thus correct solution would be to enforce only
UTF8 encoded strings as parameters for DOM functions. My gut feelings
tell me that how emotional the encoding discussion might get, no one
would like to see the correct behaviour implemented. Instead, I propose
as a fix to add some bit and pieces of this comment to the documentation
and make the reasoning explicit to developers. Maybe some examples of
possible pitfalls related to the perl internals can spice such a
documentation up.

Christian
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-668913" href="/Public/Bug/Display.html?id=44418#txn-668913">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;25&nbsp;14:36:47&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-668942" href="/Public/Bug/Display.html?id=44418#txn-668942">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;25&nbsp;14:37:46&nbsp;2009</span>
    <span class="description">phish [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-668964" href="/Public/Bug/Display.html?id=44418#txn-668964">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;25&nbsp;15:43:51&nbsp;2009</span>
    <span class="description">solutions [...] overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #44418] Perl internal representation and output encoding</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 25 Sep 2009 21:43:19 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Christian Glahn via RT &lt;bug-XML-LibXML [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;solutions [...] overmeer.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/668964/343726/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/343726">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 6.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Christian,

Thanks for all the good work you did on this module!

* Christian Glahn via RT &#40;bug-XML-LibXML@rt.cpan.org&#41; [090925 18:36]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; For some &#40;cloudy&#41; reason Perl did not made the shift to UFT8 for
&gt; internal character representation. 
</div>
The reason is simply: performance. Character processing, for instance
in regular expressions, is much much slower when the string is UTF8.
And... they could make it to work having two kinds of strings so there
was no need to move over to UTF8.

Actually, there should have been three kinds of strings: a different
type which handles binary data.  Perl6 solves this nicely, having a
character encoding label to each row of bytes. At any string operation,
it will unify the types it finds, hopefully giving better performance.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; AFAIK the only character encoding that all perl version &gt; 5.6 can
&gt; actually identify is UTF8. All other character encodings including
&gt; latin-1 &#40;which has been outdated for almost a decade, btw.&#41; are
&gt; indistinguishable for the perl internals. 
</div>
No, the official statement for Perl is: you have utf8-like &#40;not realy
utf-8&#41; strings and Latin-1 strings. The discussion I had with Petr is
that XML::LibXML decided for: you have utf-8 strings and strings
which are in an undefined encoding. That differs from Perl&#39;s current
specification.

From &#34;man perlunicode&#34;:

  By default, there is a fundamental asymmetry in Perl&#39;s Unicode
  model: implicit upgrading from byte strings to Unicode strings
  assumes that they were encoded in ISO 8859-1 &#40;Latin-1&#41;, but Unicode
  strings are downgraded with UTF-8 encoding.  This happens because
  the first 256 codepoints in Unicode happens to agree with Latin-1.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The problem with DWIM is that people dump all kind of octet streams and
&gt; hope that they will work as strings with the correct encoding. Even with
&gt; &#34;use encoding&#34; this problem is not solved. Just take the example: lets
&gt; take a XML document that is _explicitly_ encoded in ISO-8859-6 and perl
&gt; _assuming_ everything is ISO-8859-2 unless it is marked as UTF8, because
&gt; some trainee developer decided that latin-2 is a good thing. So if one
&gt; dumps a string from the DOM in the XML&#39;s native encoding &#40;that is
&gt; ISO-8859-6&#41; and then adds it back to the DOM, what kind of information
&gt; would people assume to show up? The DWIM metaphor will automatically say
&gt; the original string &#40;in ISO-8859-6&#41; and NOT in the wrong and almost
&gt; entirely incompatible ISO-8859-2 encoded version.
</div>
Well, no. If you follow Perl&#39;s current guidelines, you will need to
explicitly express the character encoding on all input and output of
a program if any utf-8 handling is done.  Either with the global &#34;use
encoding&#34;, setting a default, and/or which each open&#40;&#41; and database
access. So, above example does not hold: as long as XML::LibXML returns
the data in Latin1 or UTF-8 to the Perl program, the user&#39;s application
will force it into the correct encoding when displaying on the screen
or writing it to file. Inside the perl program, the encoding does not
matter at all &#40;except for reasons of performance&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The problem with perl&#39;s &#34;use encoding&#34; is that it allows people to tell
&gt; what perl should _assume_ a string is encoded in, even if most parts of
&gt; the additional logic _know_ that it is not &#40;in the example XML::LibXML
&gt; knows that everything internal is UTF8 and the external representation
&gt; is ISO-8859-6&#41;.
</div>
  use encoding &#34;iso-8859-6&#34;;
  open F, &#34;&lt;$f&#34;;

is an alternative for

  open F, &#34;&lt;:encoding&#40;iso-8859-6&#41;&#34;, $f;

including the character-set in which to interpret STDIN, STDOUT and
STDERR, and all other files which are read or written..  It tells Perl&#39;s
IO layers a default.

You also need to use :encoding&#40;utf-8&#41; on read and write, because
Perls internal utf8 &#40;without dash&#41; is not strict: could produce
undefined characters, does not understand markers etc.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Because UTF8 is THE STANDARD encoding for XML and DOM, we decided &#40;after
&gt; long discussions on the perl-xml list and in the related IRC channels&#41;
&gt; that in case of doubt we should always opt for what we KNOW while
&gt; running the code and not for what a programmer might have ASSUMED at the
&gt; time of writing it.
</div>
Perl expliciet defines Latin1, but programmers may not know that and
assume the wrong thing. The problem is now: XML::LibXML did not punish
these users while developing their code, therefore changing this may
break some people&#39;s existing code &#40;while helping new developers&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 1. ALWAYS use encoding UTF8  
</div>
This is totally incorrect.  This sets the STDIN/STDOUT/STDERR and other
file defaults to utf8.  But that is a system setting.  &#40;If I interpret
this point as   &#34;use encoding &#39;utf-8&#39;;&#34;&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2. disable perl&#39;s auto upgrading of strings during all IO operations and
&gt; leave the tricky bits to libxml2.
</div>
...which does it in a Perl incompatible way.  It will break all other
corners of your application, like database access, which actually do
interface correctly in this respect.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 3. assure that no arbitrary octet streams get near the DOM.
</div>
byte streams: a pitty that BLOB is not a core construct
   See <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~juerd/BLOB-1.01">http://search.cpan.org/~juerd/BLOB-1.01</a></span>
Character streams: are Latin1, no problem to put them in the DOM.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 4. upgrade all strings that should get into the DOM to UTF8 
</div>
Gladly, XML::LibXML does that for me.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 5. never try to extract the XML-document&#39;s original encoding from the
&gt; DOM unless while serializing the entire DOM. 
</div>
Extracting is into Perl, and as long as the text stays there, you do not
have a visible encoding.  Only when you write it out into a file later.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The correctness of this decision is related to the XML related
&gt; specifications. There might be conflicts with other views or discussions
&gt; related to other parts of perl development.
</div>
I disagree fully.  Both Perl and XML are very well defined about
how to handle encodings.  Only XML::LibXML has chosen not to follow
a small part of Perl&#39;s official specs &#40;which do have changed over time,
but the last change unicode change was a long time ago!&#41;

When users of Perl programs put &#34;use encoding &#39;iso-8859-1&#39;;&#34; explicitly
in their programs, then XML::LibXML works as Perl prescribes.  And all
other explicit encoding statements work correctly as well. Only when
you do not state the encoding explicitly the problem becomes clear.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-668965" href="/Public/Bug/Display.html?id=44418#txn-668965">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;25&nbsp;15:43:51&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-669201" href="/Public/Bug/Display.html?id=44418#txn-669201">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;26&nbsp;06:49:34&nbsp;2009</span>
    <span class="description">phish [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/669201/343880/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/343880">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 11.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Mark,

On Fri Sep 25 15:43:51 2009, solutions@overmeer.net wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Christian,
&gt; 
&gt; Thanks for all the good work you did on this module!
&gt; 
&gt; * Christian Glahn via RT &#40;bug-XML-LibXML@rt.cpan.org&#41; [090925 18:36]:
<div class="message-stanza open">&gt; &gt; For some &#40;cloudy&#41; reason Perl did not made the shift to UFT8 for
&gt; &gt; internal character representation. 
</div>&gt; 
&gt; The reason is simply: performance. Character processing, for instance
&gt; in regular expressions, is much much slower when the string is UTF8.
&gt; And... they could make it to work having two kinds of strings so there
&gt; was no need to move over to UTF8.
</div>
IMHO performance is a very very poor excuse for limiting character
processing to mainly the North American language zone. But this is not a
discussion we should have here.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Actually, there should have been three kinds of strings: a different
&gt; type which handles binary data.  Perl6 solves this nicely, having a
&gt; character encoding label to each row of bytes. At any string operation,
&gt; it will unify the types it finds, hopefully giving better performance.
</div>
Well, we all know that perl5 suffers from backward compatibility when it
comes to encodings. 

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; AFAIK the only character encoding that all perl version &gt; 5.6 can
&gt; &gt; actually identify is UTF8. All other character encodings including
&gt; &gt; latin-1 &#40;which has been outdated for almost a decade, btw.&#41; are
&gt; &gt; indistinguishable for the perl internals. 
</div>&gt; 
&gt; No, the official statement for Perl is: you have utf8-like &#40;not realy
&gt; utf-8&#41; strings and Latin-1 strings. The discussion I had with Petr is
&gt; that XML::LibXML decided for: you have utf-8 strings and strings
&gt; which are in an undefined encoding. That differs from Perl&#39;s current
&gt; specification.
&gt; 
&gt; From &#34;man perlunicode&#34;:
&gt; 
&gt;   By default, there is a fundamental asymmetry in Perl&#39;s Unicode
&gt;   model: implicit upgrading from byte strings to Unicode strings
&gt;   assumes that they were encoded in ISO 8859-1 &#40;Latin-1&#41;, but Unicode
&gt;   strings are downgraded with UTF-8 encoding.  This happens because
&gt;   the first 256 codepoints in Unicode happens to agree with Latin-1.
</div>
Exactly here lies the problem where the XML specs and libxml2 follows a
very different approach than perl.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; The problem with DWIM is that people dump all kind of octet streams and
&gt; &gt; hope that they will work as strings with the correct encoding. Even with
&gt; &gt; &#34;use encoding&#34; this problem is not solved. Just take the example: lets
&gt; &gt; take a XML document that is _explicitly_ encoded in ISO-8859-6 and perl
&gt; &gt; _assuming_ everything is ISO-8859-2 unless it is marked as UTF8, because
&gt; &gt; some trainee developer decided that latin-2 is a good thing. So if one
&gt; &gt; dumps a string from the DOM in the XML&#39;s native encoding &#40;that is
&gt; &gt; ISO-8859-6&#41; and then adds it back to the DOM, what kind of information
&gt; &gt; would people assume to show up? The DWIM metaphor will automatically say
&gt; &gt; the original string &#40;in ISO-8859-6&#41; and NOT in the wrong and almost
&gt; &gt; entirely incompatible ISO-8859-2 encoded version.
</div>&gt; 
&gt; Well, no. If you follow Perl&#39;s current guidelines, you will need to
&gt; explicitly express the character encoding on all input and output of
&gt; a program if any utf-8 handling is done.  Either with the global &#34;use
&gt; encoding&#34;, setting a default, and/or which each open&#40;&#41; and database
&gt; access. So, above example does not hold: as long as XML::LibXML returns
&gt; the data in Latin1 or UTF-8 to the Perl program, the user&#39;s application
&gt; will force it into the correct encoding when displaying on the screen
&gt; or writing it to file. Inside the perl program, the encoding does not
&gt; matter at all &#40;except for reasons of performance&#41;
</div>
Just remind yourself, that with XML you cannot know the encoding of a
stream in advance. The encoding is defined for each document separately
in the XML declaration and only this declaration is informing a system
about the REAL encoding of an XML document. libxml2 even goes further
and does some encoding analysis of the data if the encoding is not
defined before it assumes that the data is really in UTF8. 

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; The problem with perl&#39;s &#34;use encoding&#34; is that it allows people to tell
&gt; &gt; what perl should _assume_ a string is encoded in, even if most parts of
&gt; &gt; the additional logic _know_ that it is not &#40;in the example XML::LibXML
&gt; &gt; knows that everything internal is UTF8 and the external representation
&gt; &gt; is ISO-8859-6&#41;.
</div>&gt; 
&gt;   use encoding &#34;iso-8859-6&#34;;
&gt;   open F, &#34;&lt;$f&#34;;
&gt; 
&gt; is an alternative for
&gt; 
&gt;   open F, &#34;&lt;:encoding&#40;iso-8859-6&#41;&#34;, $f;
&gt; 
&gt; including the character-set in which to interpret STDIN, STDOUT and
&gt; STDERR, and all other files which are read or written..  It tells Perl&#39;s
&gt; IO layers a default.
&gt; 
&gt; You also need to use :encoding&#40;utf-8&#41; on read and write, because
&gt; Perls internal utf8 &#40;without dash&#41; is not strict: could produce
&gt; undefined characters, does not understand markers etc.
</div>
The problem with XML aware code is that you don&#39;t now what format you
will end up in the real world. The same code may load XML documents in
UTF8, other UTF dialects and in all kinds of ISO-8859-* family. You
simply cannot know what encoding is used with a particular XML document,
unless you actually go an read it. Thus, hard-wiring the encoding into
the IO layer is the wrong solution and may break your code. 

The actual problem is not so much the output but the input. However,
even with the output you may end up with problem if the actual encoding
of an XML document is not honoured. 
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Because UTF8 is THE STANDARD encoding for XML and DOM, we decided &#40;after
&gt; &gt; long discussions on the perl-xml list and in the related IRC channels&#41;
&gt; &gt; that in case of doubt we should always opt for what we KNOW while
&gt; &gt; running the code and not for what a programmer might have ASSUMED at the
&gt; &gt; time of writing it.
</div>&gt; 
&gt; Perl expliciet defines Latin1, but programmers may not know that and
&gt; assume the wrong thing. The problem is now: XML::LibXML did not punish
&gt; these users while developing their code, therefore changing this may
&gt; break some people&#39;s existing code &#40;while helping new developers&#41;
</div>
The problem is again KNOWING vs. ASSUMING. Why should someone get
punished just because the system assumes that something is wrong? 

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; 1. ALWAYS use encoding UTF8  
</div>&gt; 
&gt; This is totally incorrect.  This sets the STDIN/STDOUT/STDERR and other
&gt; file defaults to utf8.  But that is a system setting.  &#40;If I interpret
&gt; this point as   &#34;use encoding &#39;utf-8&#39;;&#34;&#41;
</div>
Sorry, but you completely misunderstand the problem.

For the internal string representation you should FORCE all IO of perl
into UTF8 mode. I don&#39;t know if this keeps perl from doing character
downgrading, but it should. This *should* tell perl that the programmer
prefers correct character handling over performance. 

The programmer should force the attention that with XML data you should
use actually UTF8 for all internal operations. 

This has nothing to do with system settings, but with the fact that you
actually don&#39;t know the encoding of an XML document until you actually
read it.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt; &gt; 2. disable perl&#39;s auto upgrading of strings during all IO operations and
&gt; &gt; leave the tricky bits to libxml2.
</div>&gt; 
&gt; ...which does it in a Perl incompatible way.  It will break all other
&gt; corners of your application, like database access, which actually do
&gt; interface correctly in this respect.
</div>
OK, you are mixing topics here - maybe you are also missing the
differences between the different parts of a system. 

Different to many other systems - particularly databases - XML does not
data from a preconfigurable environment. It is a standardized approach
to deal with the messy data that are around for all kinds of nationalist
reasons. 

Perl 5 lives the utopia that you can predict you IO - and it lives in
the utopia that you can boil everything down to the northern-American
lifestyle in one way or the other.

XML::LibXML tried to bridge these cultural difference &#40;that is between
Perl and XML, not between northern America and the rest of the world&#41;.
In that sense, you statement of correctness refers to the unwillingness
to understand that you cannot predict a messy environment in the same
ways as you can predict an organized environment. 

As soon you use not UTF8 as the default encoding in your entire
organized environment and you use XML also for input rather than only
for output purposes, you have to let go of your idea &#34;correct
behaviour&#34;. However, if you stick with UTF8, XML::LibXML actively
supports you to remove the encoding related issues from messy input. 

For some reason I am not confronted with breaking applications, although
I work in completely messy environments using XML::LibXML. Therefore, I
assume that if something breaks at other corners of your system it is
related to the design of an application, and not to incompatible ways of
handling data. 

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; 3. assure that no arbitrary octet streams get near the DOM.
</div>&gt; 
&gt; byte streams: a pitty that BLOB is not a core construct
&gt;    See <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~juerd/BLOB-1.01">http://search.cpan.org/~juerd/BLOB-1.01</a></span>
&gt; Character streams: are Latin1, no problem to put them in the DOM.
</div>
Yes, but you have to assure that your character stream is not actually a
downgraded or recoded version of something else. So, in that sense,
latin-1 is also an arbitrary octet stream. Please note that here we
differ in terminology. With latin-1 you HOPE that you got the correct
data, with UTF8 you KNOW that you have the correct data &#40;unless you do
something completely stupid such as downgrading a UTF8 string to latin1
and then promoting it back to UTF8&#41;.  

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; 4. upgrade all strings that should get into the DOM to UTF8 
</div>&gt; 
&gt; Gladly, XML::LibXML does that for me.
</div>
Then what is your problem?!?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; 5. never try to extract the XML-document&#39;s original encoding from the
&gt; &gt; DOM unless while serializing the entire DOM. 
</div>&gt; 
&gt; Extracting is into Perl, and as long as the text stays there, you do not
&gt; have a visible encoding.  Only when you write it out into a file later.
</div>
I mean that you should not force XML::LibXML to return the original
encoding instead of UTF8 characters. The default is UTF8, so this should
be usually transparent to developers. UTF8 data should be handled
correctly by perl&#39;s IO layer even if no explicit encoding is given.

For all other encodings, you should strip the document&#39;s encoding first
and make it explicit. The problem is that this is nothing for what
XML::LibXML can be blamed. 

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; The correctness of this decision is related to the XML related
&gt; &gt; specifications. There might be conflicts with other views or discussions
&gt; &gt; related to other parts of perl development.
</div>&gt; 
&gt; I disagree fully.  Both Perl and XML are very well defined about
&gt; how to handle encodings.  Only XML::LibXML has chosen not to follow
&gt; a small part of Perl&#39;s official specs &#40;which do have changed over time,
&gt; but the last change unicode change was a long time ago!&#41;
&gt; 
&gt; When users of Perl programs put &#34;use encoding &#39;iso-8859-1&#39;;&#34; explicitly
&gt; in their programs, then XML::LibXML works as Perl prescribes.  And all
&gt; other explicit encoding statements work correctly as well. Only when
&gt; you do not state the encoding explicitly the problem becomes clear.
</div>
Again, you complain that the world is not ideal and that XML has been
designed for a world that is not ideal. This includes that you cannot
&#40;how hard you might wish or try&#41; predict the unpredictable. 

The only correct way of reading external data into XML::LibXML is to
pass it untouched by perl to the library. If you let perl touch the data
first, you choose to be on your own.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-669204" href="/Public/Bug/Display.html?id=44418#txn-669204">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;26&nbsp;06:49:36&nbsp;2009</span>
    <span class="description">phish [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-669212" href="/Public/Bug/Display.html?id=44418#txn-669212">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;26&nbsp;08:07:08&nbsp;2009</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #44418] Perl internal representation and output encoding</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 26 Sep 2009 14:06:47 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Christian Glahn via RT &lt;bug-XML-LibXML [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/669212/343889/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/343889">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 6.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Christian Glahn via RT &#40;bug-XML-LibXML@rt.cpan.org&#41; [090926 10:49]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=44418">https://rt.cpan.org/Ticket/Display.html?id=44418</a></span> &gt;
</div>
This discussion is getting nowhere.
You define &#34;latin-1&#34; as a ill-defined encoding, and want to force
everyone into using &#34;utf-8&#34;, where that is not required at all to
make it work.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Well, we all know that perl5 suffers from backward compatibility
&gt; when it comes to encodings. 
</div>
No. Give me an example.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; From &#34;man perlunicode&#34;:
&gt; &gt;   By default, there is a fundamental asymmetry in Perl&#39;s Unicode
&gt; &gt;   model: implicit upgrading from byte strings to Unicode strings
&gt; &gt;   assumes that they were encoded in ISO 8859-1 &#40;Latin-1&#41;, but Unicode
&gt; &gt;   strings are downgraded with UTF-8 encoding.  This happens because
&gt; &gt;   the first 256 codepoints in Unicode happens to agree with Latin-1.
</div>&gt; 
&gt; Exactly here lies the problem where the XML specs and libxml2 follows a
&gt; very different approach than perl.
</div>
You wrote a layer to connect libXML2 with Perl.  There is a difference
in approach, which your layer can solve 100%.  But it does not. Where
everyone else &#40;like DBI&#41; does understand that Perl&#39;s internal string
representation is either Latin-1 or utf8 &#40;no-dash&#41;, XML::LibXML takes
it as &#34;undefined&#34; or &#34;utf8&#34; &#40;with dash?&#41;  My bug-report asks you to
fix this.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Just remind yourself, that with XML you cannot know the encoding of a
&gt; stream in advance. The encoding is defined for each document separately
&gt; in the XML declaration and only this declaration is informing a system
&gt; about the REAL encoding of an XML document.
</div>
I know

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; libxml2 even goes further
&gt; and does some encoding analysis of the data if the encoding is not
&gt; defined before it assumes that the data is really in UTF8. 
</div>
Wow, that&#39;s a security risk.  Can this be disabled?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The problem with XML aware code is that you don&#39;t now what format you
&gt; will end up in the real world. The same code may load XML documents in
&gt; UTF8, other UTF dialects and in all kinds of ISO-8859-* family. You
&gt; simply cannot know what encoding is used with a particular XML document,
&gt; unless you actually go an read it. Thus, hard-wiring the encoding into
&gt; the IO layer is the wrong solution and may break your code. 
</div>
The ancient idea of ASCII is still too much entangled with UNIX. There
are problems everywhere. For instance with the syslog&#40;&#41; interface,
where applications have to write strings in the encoding of the
root user who opens the log-files... Or with pipes between programs.
It would be smart if everyone uses the samen encoding. Sure.
   But the OS is not there. So the second best is, that the applications 
know what encoding data is in.  It&#39;s a very poor alternative, but that
is what Perl as &#34;last resort&#34; took. It&#39;s unconvenient but fits into
current OSes.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Perl expliciet defines Latin1, but programmers may not know that and
&gt; &gt; assume the wrong thing. The problem is now: XML::LibXML did not punish
&gt; &gt; these users while developing their code, therefore changing this may
&gt; &gt; break some people&#39;s existing code &#40;while helping new developers&#41;
</div>&gt; 
&gt; The problem is again KNOWING vs. ASSUMING. Why should someone get
&gt; punished just because the system assumes that something is wrong? 
</div>
If people do not use a programming language as it was designed, then
they are wrong and should KNOW better.  If they can ASSUME that all
their code is always correct, then we would never have bugs.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; For the internal string representation you should FORCE all IO of perl
&gt; into UTF8 mode. I don&#39;t know if this keeps perl from doing character
&gt; downgrading, but it should. This *should* tell perl that the programmer
&gt; prefers correct character handling over performance. 
</div>
Latin-1 character handling IS NOT INCORRECT.  It is perfect, only
limited to a certain sub-set of world-wide available character.
Please show me an example where Perl&#39;s character handling is not
correct.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; ...which does it in a Perl incompatible way.  It will break all other
&gt; &gt; corners of your application, like database access, which actually do
&gt; &gt; interface correctly in this respect.
</div>&gt; 
&gt; OK, you are mixing topics here - maybe you are also missing the
&gt; differences between the different parts of a system. 
</div>
This is an insult.  Please check on the background of the people 
you are discussing with before writing these things.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Perl 5 lives the utopia that you can predict you IO - and it lives in
&gt; the utopia that you can boil everything down to the northern-American
&gt; lifestyle in one way or the other.
</div>
Give an example. This statement is untrue.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; With latin-1 you HOPE that you got the correct data
</div>
Why?  It is latin-1 data, so it is correct data.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; with UTF8 you KNOW that you have the correct data
</div>
Yes, it is utf-8, so it is correct data.

What&#39;s the difference?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; 4. upgrade all strings that should get into the DOM to UTF8 
</div>&gt; &gt; Gladly, XML::LibXML does that for me.
</div>&gt; Then what is your problem?!?
</div>
That it does not use the default for non-utf8 strings.  I &#40;and users
of my module&#41; have to explicitly set &#34;use encoding &#39;iso-8859-1&#39;&#34; to
their programs to have XML::LibXML behave correctly.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Again, you complain that the world is not ideal and that XML has been
&gt; designed for a world that is not ideal. This includes that you cannot
&gt; &#40;how hard you might wish or try&#41; predict the unpredictable. 
</div>
Also Perl did *exclude* any attempts to &#34;auto-dect&#34;/predict the
environment.  It has very good ways for programmers to tell it which
character-encodings are used, because the environment usually doesn&#39;t
&#40;except databases these days... or, if you are lucky some environment
variables&#41;.  The approach is: I support everything, but if you do
things incorrectly you have to live with my defaults.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The only correct way of reading external data into XML::LibXML is to
&gt; pass it untouched by perl to the library. If you let perl touch the data
&gt; first, you choose to be on your own.
</div>
Pass it from where???  This idea only works if you can pass text
directly from file into an XML document.  If any &#40;even simple&#41;
processing by Perl is involved &#40;like regexes&#41;, then Perl will
interpret it as latin1, whether you like it or not.

Any chance to meet you on a Perl meeting to discuss this with a group
of people?  Do you visit the Vienna PM meetings?  I know people from
that group which can really well explain the current implementation.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-669213" href="/Public/Bug/Display.html?id=44418#txn-669213">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;26&nbsp;08:07:09&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-669223" href="/Public/Bug/Display.html?id=44418#txn-669223">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;26&nbsp;09:06:44&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/669223/343898/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/343898">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 877b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne so 26.zář.2009 08:07:08, Mark@Overmeer.net napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; This discussion is getting nowhere.
</div>
Indeed. Let me sum up: 

1. Data passed to XML::LibXML DOM functions that are not utf8 strings
are assumed to be in the encoding of the document. This is a documented
behavior.

2. The current maintainers do not consider this to be a bug, because it
was their intention that XML::LibXML behaved this way.

3. The behavior will remain as it is, at least as long as XML::LibXML is
actively maintained by me.

4. We maintain this library as a service to the community. You are free
to be of an opinion that we are providing ill service because we
implemented things as we did, go and compete &#40;in fact, since we are
talking Perl, creating a wrapper module which changes the behavior of
XML::LibXML just in this respect is very easy&#41;.

Thanks for the discussion, anyway.

-- Petr
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-669226" href="/Public/Bug/Display.html?id=44418#txn-669226">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;26&nbsp;09:06:46&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-669233" href="/Public/Bug/Display.html?id=44418#txn-669233">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;26&nbsp;09:19:50&nbsp;2009</span>
    <span class="description">solutions [...] overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #44418] Perl internal representation and output encoding</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 26 Sep 2009 15:19:31 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Petr Pajas via RT &lt;bug-XML-LibXML [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;solutions [...] overmeer.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/669233/343906/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/343906">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Petr Pajas via RT &#40;bug-XML-LibXML@rt.cpan.org&#41; [090926 13:06]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=44418">https://rt.cpan.org/Ticket/Display.html?id=44418</a></span> &gt;
&gt; Dne so 26.zář.2009 08:07:08, Mark@Overmeer.net napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; 
&gt; &gt; This discussion is getting nowhere.
</div>&gt; 
&gt; Indeed. Let me sum up: 
&gt; 
&gt; 1. Data passed to XML::LibXML DOM functions that are not utf8 strings
&gt; are assumed to be in the encoding of the document. This is a documented
&gt; behavior.
&gt; 
&gt; 2. The current maintainers do not consider this to be a bug, because it
&gt; was their intention that XML::LibXML behaved this way.
&gt; 
&gt; 3. The behavior will remain as it is, at least as long as XML::LibXML is
&gt; actively maintained by me.
</div>
All three of these were clear when you closed the ticket. &#40;I did not
reopen the debate&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 4. We maintain this library as a service to the community. You are free
&gt; to be of an opinion that we are providing ill service because we
&gt; implemented things as we did, go and compete &#40;in fact, since we are
&gt; talking Perl, creating a wrapper module which changes the behavior of
&gt; XML::LibXML just in this respect is very easy&#41;.
</div>
It is by far the best XML module for Perl. It is very well maintained
as well.

The subject of the whole discussion was that &#40;1&#41; conflicts with Perl.
It seems based on false ideas about how Perl defines charsets.

My intension is now to add something like this to my XML::Compile
modules:

   unless user used &#34;use encoding &#39;...&#39;&#34;,
       run &#34;use encoding &#39;latin1&#39;&#34;

That will probably avoid some bug-reports that I receive.  Now, I need
to find a way to implement above check, preferrably in pure perl.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-669234" href="/Public/Bug/Display.html?id=44418#txn-669234">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;26&nbsp;09:19:51&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;rejected&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-669327" href="/Public/Bug/Display.html?id=44418#txn-669327">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;26&nbsp;16:38:30&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/669327/343955/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/343955">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne so 26.zář.2009 09:19:50, solutions@overmeer.net napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; * Petr Pajas via RT &#40;bug-XML-LibXML@rt.cpan.org&#41; [090926 13:06]:
<div class="message-stanza open">&gt; &gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=44418">https://rt.cpan.org/Ticket/Display.html?id=44418</a></span> &gt;
&gt; &gt; Dne so 26.zář.2009 08:07:08, Mark@Overmeer.net napsal&#40;a&#41;:
<div class="message-stanza open">&gt; &gt; &gt; 
&gt; &gt; &gt; This discussion is getting nowhere.
</div>&gt; &gt; 
&gt; &gt; Indeed. Let me sum up: 
&gt; &gt; 
&gt; &gt; 1. Data passed to XML::LibXML DOM functions that are not utf8 
</div></div>strings
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; are assumed to be in the encoding of the document. This is a 
</div></div>documented
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; behavior.
&gt; &gt; 
&gt; &gt; 2. The current maintainers do not consider this to be a bug, 
</div></div>because it
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; was their intention that XML::LibXML behaved this way.
&gt; &gt; 
&gt; &gt; 3. The behavior will remain as it is, at least as long as XML::LibXML 
</div></div>is
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; actively maintained by me.
</div>&gt; 
&gt; All three of these were clear when you closed the ticket. &#40;I did not
&gt; reopen the debate&#41;
</div>
ok.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; 4. We maintain this library as a service to the community. You are 
</div></div>free
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; to be of an opinion that we are providing ill service because we
&gt; &gt; implemented things as we did, go and compete &#40;in fact, since we 
</div></div>are
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; talking Perl, creating a wrapper module which changes the behavior 
</div></div>of
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; XML::LibXML just in this respect is very easy&#41;.
</div>&gt; 
&gt; It is by far the best XML module for Perl. It is very well maintained
&gt; as well.
&gt; 
&gt; The subject of the whole discussion was that &#40;1&#41; conflicts with Perl.
</div>
not technically, the current API as it behaves shouldn&#39;t lead to errors if 
properly used.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It seems based on false ideas about how Perl defines charsets.
</div>
not really, no. It was based on the assumtions we made about how 
people are going to use the API.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; My intension is now to add something like this to my XML::Compile
&gt; modules:
&gt; 
&gt;    unless user used &#34;use encoding &#39;...&#39;&#34;,
&gt;        run &#34;use encoding &#39;latin1&#39;&#34;
</div>
What about upgrading the scalars you pass to XML::LibXML?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; That will probably avoid some bug-reports that I receive.  Now, I need
&gt; to find a way to implement above check, preferrably in pure perl.
</div>
Please don&#39;t go that way! When people didn&#39;t do &#39;use encoding&#39;, they 
most likely didn&#39;t want to.

Just make sure all strings become utf8 before you pass them down to 
our APIs, that&#39;s all. Shouldn&#39;t be much overhead either.

Best, 
-- Petr
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-669330" href="/Public/Bug/Display.html?id=44418#txn-669330">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;26&nbsp;16:38:31&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-669334" href="/Public/Bug/Display.html?id=44418#txn-669334">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;26&nbsp;17:51:57&nbsp;2009</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #44418] Perl internal representation and output encoding</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 26 Sep 2009 23:51:37 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Petr Pajas via RT &lt;bug-XML-LibXML [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/669334/343964/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/343964">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Petr Pajas via RT &#40;bug-XML-LibXML@rt.cpan.org&#41; [090926 20:38]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; The subject of the whole discussion was that &#40;1&#41; conflicts with Perl.
</div>&gt; not technically, the current API as it behaves shouldn&#39;t lead to
&gt; errors if properly used.
</div>
&#34;when properly used&#34;.  In the simple case, where text is read from a file
and directly translated into XML::LibXML nodes, there is no problem to use
it properly.  In any more complex case, where Perl does need to do some
&#40;minor&#41; processing on the strings &#40;like sorting or regexps&#41; the concept of
&#34;undefined encoding&#34; conflicts with Perl&#39;s idea about the encoding.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; It seems based on false ideas about how Perl defines charsets.
</div>&gt; not really, no. It was based on the assumtions we made about how 
&gt; people are going to use the API.
</div>
Your library integrates with Perl, not with peoples assumptions. How do
you know what people&#39;s assumptions are? Probably the assumption is that
it DWIMs, which means: does behave as expected. For instance, that it
intergrates wrt unicode the same way as DBI does. And all other unicode
capable interface modules.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt;    unless user used &#34;use encoding &#39;...&#39;&#34;,
&gt; &gt;        run &#34;use encoding &#39;latin1&#39;&#34;
</div>&gt; 
&gt; What about upgrading the scalars you pass to XML::LibXML?
</div>
Still, the user has to specify the character-set where the strings are in
before my abstract library can upgrade it into utf-8.  Perl&#39;s concept is
that this task is done only at the extrance and exit points of the script
*only*: where data enters and leaves the program. It is very simple to
change your programming API to follow this model. I agree that it is
not always easy on the &#34;read/write to external resource&#34; side.

I have the experience with Mail::Box, where character-sets within mbox
files change with each message part. And even within one MIME header
field. This is a valid message header field:

  Subject: =?ISO-8859-1?B?SWYgeW91IGNhbiByZWFkIHRoaXMgeW8=?=
    =?ISO-8859-2?B?dSB1bmRlcnN0YW5kIHRoZSBleGFtcGxlLg==?=

Of course, the default MailBox behavior is to return the decoded
utf-8 string to the user.  I understand what kind of complications
you encounter.  But they are all solvable in the few basic rules Perl
has set-up. This should be the way your output works, for any kind
of encoding of the XML document &#40;also for utf-8 output!&#41;:

  use Encoding;
  my $enc = find_encoding&#40;$doc-&gt;encoding&#41; or die;
  open OUT, &#39;&gt;:raw&#39;, &#39;file.xml&#39;;
  print OUT &#34;&lt;$tag&gt;&#34;, $enc-&gt;encode&#40;$data&#41;, &#34;&lt;/$tag&gt;\n&#34;;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; That will probably avoid some bug-reports that I receive.  Now, I need
&gt; &gt; to find a way to implement above check, preferrably in pure perl.
</div>&gt; 
&gt; Please don&#39;t go that way! When people didn&#39;t do &#39;use encoding&#39;, they 
&gt; most likely didn&#39;t want to.
</div>
Most people are not used to work explicitly with utf8. It normally
just DWIMs. But in this case, they need some help to make it DWIM
more. I want XML::Compile to follow Perl&#39;s rules some way or the other,
not XML::LibXML &#34;we know better&#34; rules. Sorry.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Just make sure all strings become utf8 before you pass them down to 
&gt; our APIs, that&#39;s all. Shouldn&#39;t be much overhead either.
</div>
I create elements and attributes on many many spots in the program... I
would need to add the upgrade on dozens of places.  It&#39;s a pity when I
need work-around to get libraries to work smoothly.

An other option may be to die&#40;&#41; when people create XML with an encoding
!= UTF8 and do not specify the same character-set explictly in a &#34;use
encoding&#34;. Have to sleep over this, to figure-out whether this catches
most case I came across. At least, I have added a detailed explanation
in the FAQ.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-669335" href="/Public/Bug/Display.html?id=44418#txn-669335">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;26&nbsp;17:51:58&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;rejected&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-669338" href="/Public/Bug/Display.html?id=44418#txn-669338">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;26&nbsp;19:05:11&nbsp;2009</span>
    <span class="description">phish [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/669338/343967/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/343967">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Mark,

I scanned your XML::Compile module and the problem seems to have a
simple solution. 

Actually, you explicitly force yourself &#40;and your users&#41; into UTF8 only
mode. Thus, the problem is in your code.

If you would create iso-8859-1 documents rather than utf8 documents your
problems would go away. 

You can always change the encoding of the documents to UTF8 at any point. 

Alternatively, you can pass the document element for output rather than
the iso-8859-1 declared document itself. In this case you get perfectly
standard compliant XML documents in UTF8 but have no problems with
adding latin-1 strings along the way.

The XML::LibXML::SAX handlers do something similar like your module, but
have never created any real problems when it came to tree building &#40;at
least not encoding related AFAIK&#41;.

Cheers
Christian

On Sat Sep 26 17:51:57 2009, Mark@Overmeer.net wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; * Petr Pajas via RT &#40;bug-XML-LibXML@rt.cpan.org&#41; [090926 20:38]:
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; The subject of the whole discussion was that &#40;1&#41; conflicts with Perl.
</div>&gt; &gt; not technically, the current API as it behaves shouldn&#39;t lead to
&gt; &gt; errors if properly used.
</div>&gt; 
&gt; &#34;when properly used&#34;.  In the simple case, where text is read from a file
&gt; and directly translated into XML::LibXML nodes, there is no problem to use
&gt; it properly.  In any more complex case, where Perl does need to do some
&gt; &#40;minor&#41; processing on the strings &#40;like sorting or regexps&#41; the concept of
&gt; &#34;undefined encoding&#34; conflicts with Perl&#39;s idea about the encoding.
&gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; It seems based on false ideas about how Perl defines charsets.
</div>&gt; &gt; not really, no. It was based on the assumtions we made about how 
&gt; &gt; people are going to use the API.
</div>&gt; 
&gt; Your library integrates with Perl, not with peoples assumptions. How do
&gt; you know what people&#39;s assumptions are? Probably the assumption is that
&gt; it DWIMs, which means: does behave as expected. For instance, that it
&gt; intergrates wrt unicode the same way as DBI does. And all other unicode
&gt; capable interface modules.
&gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt;    unless user used &#34;use encoding &#39;...&#39;&#34;,
&gt; &gt; &gt;        run &#34;use encoding &#39;latin1&#39;&#34;
</div>&gt; &gt; 
&gt; &gt; What about upgrading the scalars you pass to XML::LibXML?
</div>&gt; 
&gt; Still, the user has to specify the character-set where the strings are in
&gt; before my abstract library can upgrade it into utf-8.  Perl&#39;s concept is
&gt; that this task is done only at the extrance and exit points of the script
&gt; *only*: where data enters and leaves the program. It is very simple to
&gt; change your programming API to follow this model. I agree that it is
&gt; not always easy on the &#34;read/write to external resource&#34; side.
&gt; 
&gt; I have the experience with Mail::Box, where character-sets within mbox
&gt; files change with each message part. And even within one MIME header
&gt; field. This is a valid message header field:
&gt; 
&gt;   Subject: =?ISO-8859-1?B?SWYgeW91IGNhbiByZWFkIHRoaXMgeW8=?=
&gt;     =?ISO-8859-2?B?dSB1bmRlcnN0YW5kIHRoZSBleGFtcGxlLg==?=
&gt; 
&gt; Of course, the default MailBox behavior is to return the decoded
&gt; utf-8 string to the user.  I understand what kind of complications
&gt; you encounter.  But they are all solvable in the few basic rules Perl
&gt; has set-up. This should be the way your output works, for any kind
&gt; of encoding of the XML document &#40;also for utf-8 output!&#41;:
&gt; 
&gt;   use Encoding;
&gt;   my $enc = find_encoding&#40;$doc-&gt;encoding&#41; or die;
&gt;   open OUT, &#39;&gt;:raw&#39;, &#39;file.xml&#39;;
&gt;   print OUT &#34;&lt;$tag&gt;&#34;, $enc-&gt;encode&#40;$data&#41;, &#34;&lt;/$tag&gt;\n&#34;;
&gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; That will probably avoid some bug-reports that I receive.  Now, I need
&gt; &gt; &gt; to find a way to implement above check, preferrably in pure perl.
</div>&gt; &gt; 
&gt; &gt; Please don&#39;t go that way! When people didn&#39;t do &#39;use encoding&#39;, they 
&gt; &gt; most likely didn&#39;t want to.
</div>&gt; 
&gt; Most people are not used to work explicitly with utf8. It normally
&gt; just DWIMs. But in this case, they need some help to make it DWIM
&gt; more. I want XML::Compile to follow Perl&#39;s rules some way or the other,
&gt; not XML::LibXML &#34;we know better&#34; rules. Sorry.
&gt; 
<div class="message-stanza open">&gt; &gt; Just make sure all strings become utf8 before you pass them down to 
&gt; &gt; our APIs, that&#39;s all. Shouldn&#39;t be much overhead either.
</div>&gt; 
&gt; I create elements and attributes on many many spots in the program... I
&gt; would need to add the upgrade on dozens of places.  It&#39;s a pity when I
&gt; need work-around to get libraries to work smoothly.
&gt; 
&gt; An other option may be to die&#40;&#41; when people create XML with an encoding
&gt; != UTF8 and do not specify the same character-set explictly in a &#34;use
&gt; encoding&#34;. Have to sleep over this, to figure-out whether this catches
&gt; most case I came across. At least, I have added a detailed explanation
&gt; in the FAQ.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-669341" href="/Public/Bug/Display.html?id=44418#txn-669341">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;26&nbsp;19:05:26&nbsp;2009</span>
    <span class="description">phish [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-669374" href="/Public/Bug/Display.html?id=44418#txn-669374">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;27&nbsp;02:55:52&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/669374/343976/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/343976">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; What about upgrading the scalars you pass to XML::LibXML?
</div>&gt; 
&gt; Still, the user has to specify the character-set where the strings are in
&gt; before my abstract library can upgrade it into utf-8.
</div>
Oh really? I thought it wil just DWIM.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Perl&#39;s concept is
&gt; that this task is done only at the extrance and exit points of the script
&gt; *only*: where data enters and leaves the program.
</div>
If you do it, e.g. via setting an :encoding&#40;&#41; or :utf8 IO layer, the
strings are already upgraded.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;...  But they are all solvable in the few basic rules Perl
&gt; has set-up. This should be the way your output works, for any kind
&gt; of encoding of the XML document &#40;also for utf-8 output!&#41;:
&gt; 
&gt;   use Encoding;
&gt;   my $enc = find_encoding&#40;$doc-&gt;encoding&#41; or die;
&gt;   open OUT, &#39;&gt;:raw&#39;, &#39;file.xml&#39;;
&gt;   print OUT &#34;&lt;$tag&gt;&#34;, $enc-&gt;encode&#40;$data&#41;, &#34;&lt;/$tag&gt;\n&#34;;
</div>
The current implementation assumes that you do this:

open OUT, &#39;&gt;:raw&#39;, &#39;file.xml&#39;;
$doc-&gt;toFH&#40;\*OUT&#41;;

or

open OUT, &#39;&gt;:raw&#39;, &#39;file.xml&#39;;
print OUT $doc-&gt;toString&#40;&#41;;

Nothing that counterintuitive about that!

You only need to encode if you are dumping a non-document node, e.g.

$doc-&gt;documentElement-&gt;toString

in which case you get a utf8 string and you encode it to whatever
encoding you like.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; That will probably avoid some bug-reports that I receive.  Now, I need
&gt; &gt; &gt; to find a way to implement above check, preferrably in pure perl.
</div>&gt; &gt; 
&gt; &gt; Please don&#39;t go that way! When people didn&#39;t do &#39;use encoding&#39;, they 
&gt; &gt; most likely didn&#39;t want to.
</div>&gt; 
&gt; Most people are not used to work explicitly with utf8. It normally
&gt; just DWIMs. But in this case, they need some help to make it DWIM
&gt; more. I want XML::Compile to follow Perl&#39;s rules some way or the other,
&gt; not XML::LibXML &#34;we know better&#34; rules. Sorry.
</div>
Our &#34;we know better&#34; decision has no side-effects. It only concerns the
entry points to our APIs, we don&#39;t enforce any semantics on other parts
of the user&#39;s code.
Enforcing &#39;use encoding&#39; on somebody elses literals whose purpose you
have no knowledge about is an &#34;I know better&#34; approach on your side. Of
course, this is your module, you make the decisions. 

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Just make sure all strings become utf8 before you pass them down to 
&gt; &gt; our APIs, that&#39;s all. Shouldn&#39;t be much overhead either.
</div>&gt; 
&gt; I create elements and attributes on many many spots in the program... I
&gt; would need to add the upgrade on dozens of places.  It&#39;s a pity when I
&gt; need work-around to get libraries to work smoothly.
</div>
How many different XML::LibXML methods do you use for this? A bet no
more than five or ten. Just wrap those and call your wrappers. Might
come handy in the future.
 
Or follow Christians suggestion.

-- Petr
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-669375" href="/Public/Bug/Display.html?id=44418#txn-669375">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;27&nbsp;02:55:53&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;rejected&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-669410" href="/Public/Bug/Display.html?id=44418#txn-669410">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;27&nbsp;08:59:18&nbsp;2009</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #44418] Perl internal representation and output encoding</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 27 Sep 2009 14:58:44 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Christian Glahn via RT &lt;bug-XML-LibXML [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/669410/343997/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/343997">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Christian Glahn via RT &#40;bug-XML-LibXML@rt.cpan.org&#41; [090926 23:05]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=44418">https://rt.cpan.org/Ticket/Display.html?id=44418</a></span> &gt;
&gt; 
&gt; Actually, you explicitly force yourself &#40;and your users&#41; into UTF8 only
&gt; mode. Thus, the problem is in your code.
</div>
Certainly not. Utf-8 is set as default, but I know people who use other
encodings. &#40;They cannot help it: large international commercial spec&#41;
XML::Compile only helps people in constructing &#40;parts&#41; of their XML. It
understands Schema&#39;s but does not have anything to do with the XML text
or encodings. Works perfectly... except for the problem under discussion.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If you would create iso-8859-1 documents rather than utf8 documents your
&gt; problems would go away. 
</div>
Why? Sometimes users of my module do have real utf-data, so why should
they create latin-1 documents? I do not understand this at all: how
should this help the implementation of a general purpose module? Maybe
you should give me an example.

In my arguments, I have asked you for a few more examples for statements
you make, but you seem to ignore these. Remarks about &#34;latin1 is not
well-defined&#34; and such. I don&#39;t like it when arguments get ignored: they
should get weighted.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Alternatively, you can pass the document element for output rather than
&gt; the iso-8859-1 declared document itself. In this case you get perfectly
&gt; standard compliant XML documents in UTF8 but have no problems with
&gt; adding latin-1 strings along the way.
</div>
This is what I already do. The user will usually only output full
doc-trees. This is not an issue at all.

Petr had a good summary of the actual subject. Perl defines byte-strings
as &#34;latin1&#34; and XML::LibXML as &#34;undefined&#34;. And your think to serve
people better with this difference. I don&#39;t think that&#39;s true, and will
find a way to help my users around it.

Let&#39;s close this ticket &#40;for a while&#41;
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-669471" href="/Public/Bug/Display.html?id=44418#txn-669471">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;27&nbsp;11:53:30&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/669471/344032/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/344032">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dne ne 27.zář.2009 08:59:18, Mark@Overmeer.net napsal&#40;a&#41;:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; * Christian Glahn via RT &#40;bug-XML-LibXML@rt.cpan.org&#41; [090926 23:05]:
<div class="message-stanza open">&gt; &gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=44418">https://rt.cpan.org/Ticket/Display.html?id=44418</a></span> &gt;
&gt; &gt; 
&gt; &gt; Actually, you explicitly force yourself &#40;and your users&#41; into UTF8 only
&gt; &gt; mode. Thus, the problem is in your code.
</div>&gt; 
&gt; Certainly not. Utf-8 is set as default, but I know people who use other
&gt; encodings. &#40;They cannot help it: large international commercial spec&#41;
&gt; XML::Compile only helps people in constructing &#40;parts&#41; of their XML. It
&gt; understands Schema&#39;s but does not have anything to do with the XML text
&gt; or encodings. Works perfectly... except for the problem under discussion.
&gt; 
<div class="message-stanza open">&gt; &gt; If you would create iso-8859-1 documents rather than utf8 documents your
&gt; &gt; problems would go away. 
</div>&gt; 
&gt; Why? Sometimes users of my module do have real utf-data, so why should
&gt; they create latin-1 documents? I do not understand this at all: how
&gt; should this help the implementation of a general purpose module?
</div>
Seems you misunderstand Christian&#39;s point:

If you create a DOM Document with iso-8859-1 encoding and then perform
DOM operations on this document, XML::LibXML will behave almost the way
you want it to behave by default, because it will:

- internally represent everything in UTF-8
- insert utf8 strings as they are
- assume all other strings are latin1 and decode them

Only when you serialize the document you set the encoding to whatever
your user wanted.

Does it make sense, now?


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Maybe
&gt; you should give me an example
</div>
Sure: your user wants to create a XML document encoded in iso-8859-6
&#40;farsi&#41;. You create the document node with encoding iso-8859-1.
Internally, everything is UTF-8 in libxml2. Two things can occur: the
user passes utf8 strings, which are inserted into the document tree
without reencoding, or passes a non-utf8 strings, which are upgraded to
utf8 using equivalent of decode&#40;&#39;latin1&#39;,$string&#41;, which is how Perl
would behave in this situation elsewhere.

Then the user asks to serialize the document. You use
$doc-&gt;setEncoding&#40;&#39;iso-8859-6&#39;&#41; and then either $doc-&gt;toString,
$doc-&gt;toFH or whatever. The user gets the document in farsi, as requested.

Makes sense?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Let&#39;s close this ticket &#40;for a while&#41;
</div>
I keep doing that:-&#41;

-- Petr
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-669474" href="/Public/Bug/Display.html?id=44418#txn-669474">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;27&nbsp;11:53:32&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-669553" href="/Public/Bug/Display.html?id=44418#txn-669553">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;27&nbsp;16:33:29&nbsp;2009</span>
    <span class="description">Mark [...] Overmeer.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #44418] Perl internal representation and output encoding</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 27 Sep 2009 22:33:10 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Petr Pajas via RT &lt;bug-XML-LibXML [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Overmeer &lt;mark [...] overmeer.net&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/669553/344079/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/344079">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">* Petr Pajas via RT &#40;bug-XML-LibXML@rt.cpan.org&#41; [090927 15:53]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Seems you misunderstand Christian&#39;s point:
&gt; 
&gt; If you create a DOM Document with iso-8859-1 encoding and then perform
&gt; DOM operations on this document, XML::LibXML will behave almost the way
&gt; you want it to behave by default, because it will:
&gt; 
&gt; - internally represent everything in UTF-8
&gt; - insert utf8 strings as they are
&gt; - assume all other strings are latin1 and decode them
&gt; 
&gt; Only when you serialize the document you set the encoding to whatever
&gt; your user wanted.
&gt; 
&gt; Does it make sense, now?
</div>
This seems like an excellent solution, now I understand it... however...
in my API, people create the Document themselves: it is not produced in
my library.

A ready XML::LibXML::Document is to be passed as argument to &#34;my&#34; writers,
because people may be working on various different XML documents at
a time, using the same schema&#39;s but different encodings and data.
Things like document compression and IO are fully outside my scope:
the user has control over the document.

Seriously, it&#39;s a pity that this work-around would require a major API
change.  It, however, may be the best solution to describe in the FAQ.
Thanks for taking the time to make me understand this trick.
-- 
Regards,
               MarkOv

------------------------------------------------------------------------
       Mark Overmeer MSc                                MARKOV Solutions
       Mark@Overmeer.net                          solutions@overmeer.net
<span class="clickylink"><a target="new" rel="nofollow" href="http://Mark.Overmeer.net">http://Mark.Overmeer.net</a></span>                   <span class="clickylink"><a target="new" rel="nofollow" href="http://solutions.overmeer.net">http://solutions.overmeer.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-669554" href="/Public/Bug/Display.html?id=44418#txn-669554">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;27&nbsp;16:33:29&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;rejected&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-670705" href="/Public/Bug/Display.html?id=44418#txn-670705">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;30&nbsp;09:37:50&nbsp;2009</span>
    <span class="description">pajas [...] matfyz.cz -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 1.116796</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
