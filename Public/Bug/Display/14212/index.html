<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #14212 for HTML-Parser: HTML::TreeBuilder generates text nodes in a strange encoding</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #14212 for HTML-Parser: HTML::TreeBuilder generates text nodes in a strange encoding</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/HTML-Parser/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/HTML-Parser/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/HTML-Parser/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/HTML-Parser/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/HTML-Parser">HTML-Parser CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">14212</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/HTML-Parser/Active/">HTML-Parser</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dma_k [...] mail.ru

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-15862-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-15863-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;17&nbsp;10:31:39&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> HTML::TreeBuilder generates text nodes in a strange encoding</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am using perl-HTML-Tree-3.18. I have met the following problem:
When I use HTML::TreeBuilder to parse a tree, that contains the text like
&#34;Geb&#38;uuml;hr vor Ort von &#38;euro; 30,- pro Woche&#34; &#40;without quotes&#41;, I will get the string in the strange encoding: &#38;uuml; will be encoded as one char, &#38;euro; will be encoded as two chars. I think, that is incorrect. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;17&nbsp;10:42:14&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dma_k [...] mail.ru</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">In the above post the string should be read as:
&#34;Geb&#38;amp;uuml;hr vor Ort von &#38;amp;euro; 30,- pro Woche&#34;
Tree builder seems to decode the string entities via HTML::Entities. Is
it possible to extend the tree builder with an option, that allows to
skip encoding the HTML entities into chars? The only way out seems to
call encode again, but that is not pretty.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;08&nbsp;15:32:13&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dma_k [...] mail.ru</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The problem seems to be solved, when upgraded form Perl v5.8.3 to v5.8.6.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;06&nbsp;14:37:33&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> john</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The Debian stable folk have 5.8.4, and this bug is affecting their programs.

How could they go around this problem? I&#39;m looking at the source code
and I&#39;m tempted to comment out the HTML::Entities::encode line... but
would that then create other problems?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;11&nbsp;18:13:43&nbsp;2006</span>
    <span class="description">PETEK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Can&#39;t reproduce with 3.18 and up. Please resubmit with a test case if
you are still having this issue.

As an aside, I have added this case as a test in HTML-Tree 3.22, which
will be released as part of the Chicago Hackathon this weekend.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;11&nbsp;18:13:43&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;11&nbsp;18:13:44&nbsp;2006</span>
    <span class="description">PETEK [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;13&nbsp;04:50:27&nbsp;2006</span>
    <span class="description">dma_k [...] mail.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dma_k [...] mail.ru</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello! Thanks that you&#39;ve paid attention to the &#40;possible&#41; problem.

Finally, as I said above, some of perl installations work, some -- not,
and I&#39;ve come to the conclusion, it&#39;s a core Perl bug with unicode
chars. What version of Perl do you use for testing?

Can you please, define more precisely the return value for
&#34;HTML::Entity-&gt;as_text&#40;&#41;&#34;? Should it return the UTF-8 text? Localized
text? While investigating the problem, I&#39;ve read
<span class="clickylink"><a target="new" rel="nofollow" href="http://jerakeen.org/files/2005/perl-utf8.slides.pdf">http://jerakeen.org/files/2005/perl-utf8.slides.pdf</a></span> -- it has a very
nice chart. Consider for reading!

Actually, I&#39;ve found this problem, while implemnting the HTML parser,
that stores the data to the MySQL DB, and this data is supposed to be
displayed as HTML again. So, in my case I used the following flow:

my $html_root = HTML::TreeBuilder-&gt;new_from_content&#40;$contents&#41;;

foreach &#40;$html_root-&gt;guts&#40;&#41;&#41;
{
  ...
  $dbh-&gt;prepare&#40;&#34;insert into my_table &#40;id, contents&#41; values &#40;$id,
?&#41;&#34;&#41;-&gt;execute&#40;HTML::Entities::encode_entities&#40;$_-&gt;as_trimmed_text&#40;&#41;&#41;&#41;;
}

so I used the &#34;reverse&#34; convertion for chars. Unfortunately, I still
don;t have any working example to store Unicode strings into MySQL 4.0.x
from Perl to be read later correctly from Java :&#40; but that&#39;s out of the
scope of the problem, being discussed.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;13&nbsp;04:50:28&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;13&nbsp;11:29:30&nbsp;2006</span>
    <span class="description">PETEK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> PETEK [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Nov 13 04:50:27 2006, dma_k@mail.ru wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Finally, as I said above, some of perl installations work, some -- not,
&gt; and I&#39;ve come to the conclusion, it&#39;s a core Perl bug with unicode
&gt; chars. What version of Perl do you use for testing?
</div>
I use Apple&#39;s Perl &#40;5.8.6 on OSX&#41;, Debian sarge&#39;s Perl &#40;5.8.4&#41;, and a
custom Perl &#40;5.8.2&#41; for release testing.  I do have a 5.6 install
sitting around, and t/body.t fails on unicode escape tests.  &#40;I should
skip those on that platform.&#41;
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Can you please, define more precisely the return value for
&gt; &#34;HTML::Entity-&gt;as_text&#40;&#41;&#34;? Should it return the UTF-8 text? Localized
&gt; text?
</div>
It returns the text exactly as it&#39;s contained in each HTML::Element &#40;not
HTML::Entity&#41; and children.  If that&#39;s UTF-8, Unicode, ISO-8859-1, or
whatever, that&#39;s been decided by HTML::Parser.  HTML::Element is just
the middleman, doing simple concatenation.

If you could give a test case that shows the broken behavior on your
platform, I would appreciate it.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;13&nbsp;11:29:47&nbsp;2006</span>
    <span class="description">PETEK [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;23&nbsp;18:19:09&nbsp;2009</span>
    <span class="description">STOCKS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m not sure if this module is still being actively maintained but I am 
experiencing the same issues on perl 5.10. I don&#39;t know if the issue is 
with HTML::Element or an underlying module.

Here is a test case which fails on Fedora 9 platform:
==============================
#!/usr/bin/perl

use HTML::Element;
use Test::More tests =&gt; 2;

my $test_string = &#39;This is a test 漢語&#39;;

like&#40; $test_string, qr/漢語/xms, &#39;Found chinese chars input string&#39; &#41;;

my $h = HTML::Element-&gt;new&#40; &#39;p&#39; &#41;;
$h-&gt;push_content&#40;&#39;This is a test 漢語&#39;&#41;;

like&#40; $h-&gt;as_HTML, qr/漢語/xms, &#39;Found chinese chars in html output&#39; &#41;;
========================

Running this on Fedora 9 produces the following output:

1..2
ok 1 - Found chinese chars input string
not ok 2 - Found chinese chars in html output
#   Failed test &#39;Found chinese chars in html output&#39;
#   at ./test2.pl line 13.
#                   &#39;&lt;p&gt;This is a test 
&#38;aelig;&#38;frac14;&#38;cent;&#38;egrave;&#38;ordf;&#38;#158;
# &#39;
#     doesn&#39;t match &#39;&#40;?msx-i:漢語&#41;&#39;
# Looks like you failed 1 test of 2.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;23&nbsp;18:19:10&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;23&nbsp;18:28:17&nbsp;2009</span>
    <span class="description">STOCKS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry, not sure if I was experiencing the same issue as described above, 
but it seemed the same. Just realized that passing empty string to 
as_HTML solves this issue. Updated test case, which passes:

===================================
#!/usr/bin/perl

use HTML::Element;
use Test::More tests =&gt; 2;

my $test_string = &#39;This is a test 漢語&#39;;

like&#40; $test_string, qr/漢語/xms, &#39;Found chinese chars input string&#39; &#41;;

my $h = HTML::Element-&gt;new&#40; &#39;p&#39; &#41;;
$h-&gt;push_content&#40;&#39;This is a test 漢語&#39;&#41;;

like&#40; $h-&gt;as_HTML&#40; &#39;&#39; &#41;, qr/漢語/xms, &#39;Found chinese chars in html 
output&#39; &#41;;
===================================
1..2
ok 1 - Found chinese chars input string
ok 2 - Found chinese chars in html output
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;24&nbsp;05:38:26&nbsp;2009</span>
    <span class="description">dma_k [...] mail.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> dma_k [...] mail.ru</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Using as_HTML&#40;&#39;&#39;&#41; is funny, because in this case you tell HTML::Element
not to encode entities at all &#40;the default should be &#39;&lt;&gt;&#38;&#39;&#41;.
Why do you expect that as_HTML&#40;&#41; should return a non-HTML-encoded string
back? I would use as_text&#40;&#41; for this case. Or you mean that as_HTML&#40;&#41;
basically does incorrect HTML-encoding for Chinese characters? Try plain
with first argument, seems to be a bug but of the different nature.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;24&nbsp;00:17:21&nbsp;2010</span>
    <span class="description">Jeff.Fearn [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is a bug in HTML::Entities, line 479 is encoding the Chinese
characters. Adding the following debug code to HTML/Entities.pm reveals
this:

print&#40;STDERR &#34;1: ref = $$ref\n&#34;&#41;;
        $$ref =~ s/&#40;[^\n\r\t !\#\$%\&#40;-;=?-~]&#41;/$char2entity{$1} ||
num_entity&#40;$1&#41;/ge;
print&#40;STDERR &#34;2: ref = $$ref\n&#34;&#41;;

1: ref = This is a test 漢語
2: ref = This is a test &#38;aelig;&#38;frac14;&#38;cent;&#38;egrave;&#38;ordf;&#38;#158;

Cheers, Jeff.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;24&nbsp;00:18:28&nbsp;2010</span>
    <span class="description">Jeff.Fearn [...] gmail.com -  Queue changed from HTML-Tree to HTML-Parser</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;09&nbsp;09:16:30&nbsp;2010</span>
    <span class="description">GAAS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> PETEK [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From you example I can&#39;t tell if the string you passed to HTML::Entities::encode&#40;&#41; was a Unicode 
string or the decoded UTF-8 bytes.

Please try the attached test program.  It prints:

# encode-test.pl:4: &#34;This is a test \x{6F22}\x{8A9E}&#34;
# encode-test.pl:5: &#34;This is a test &#38;#x6F22;&#38;#x8A9E;&#34;

for me, so it seems correct.  If I comment out the &#39;use utf8;&#39; line then the output becomes:

# encode-test.pl:4: &#34;This is a test \xE6\xBC\xA2\xE8\xAA\x9E&#34;
# encode-test.pl:5: &#34;This is a test &#38;aelig;&#38;frac14;&#38;cent;&#38;egrave;&#38;ordf;&#38;#158;&#34;

It you get different results, please tell me what version of perl and HTML::Parser you are using.  
If you get the result above then I don&#39;t consider this a bug.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;09&nbsp;09:17:49&nbsp;2010</span>
    <span class="description">GAAS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jul 09 09:16:30 2010, GAAS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Please try the attached test program.  It prints:
</div>
Of course, I forgot to attach the file :-&#40;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> encode-test.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#use utf8;
use Data::Dump;
use HTML::Entities;
ddx $text = &#34;This is a test æ¼¢èª&#34;;
ddx $enc = HTML::Entities::encode&#40;$text&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;24&nbsp;14:36:31&nbsp;2020</span>
    <span class="description">olaf [...] wundersolutions.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ticket migrated to github as <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/libwww-perl/HTML-Parser/issues/10">https://github.com/libwww-perl/HTML-Parser/issues/10</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;24&nbsp;14:36:32&nbsp;2020</span>
    <span class="description">olaf [...] wundersolutions.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
