<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #6560 for DBD-Oracle: BLOB/CLOB memory leak patch</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #6560 for DBD-Oracle: BLOB/CLOB memory leak patch</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=DBD-Oracle">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=DBD-Oracle">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=DBD-Oracle">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=DBD-Oracle">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/pythian/DBD-Oracle/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-Oracle">DBD-Oracle CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">6560</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=DBD-Oracle">DBD-Oracle</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bai [...] dreamarts.co.jp

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-10192-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.15    </td>
  </tr>
  <tr id="CF-10193-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




DBD-Oracle-1.15-lob.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/105408/19701/DBD-Oracle-1.15-lob.patch">
Wed Jun 09 00:42:17 2004 (6.9k) by 
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=6560">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-105408" href="/Public/Bug/Display.html?id=6560#txn-105408">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;09&nbsp;00:42:17&nbsp;2004</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> BLOB/CLOB memory leak patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/105408/19700/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/19700">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Package: DBD-Oracle-1.15
Environment: perl-5.6.0, i386-linux 2.4.7-2.24ml, Oracle-8.1.7

Description:
  When using Oracle BLOB from within mod_perl, we found the size of httpd process increasing. If you changes BLOB to LONGRAW, there will be no memory increasing. Our module using DBI-1.41 and DBD-Oracle-1.15, and just &#34;simple LOB&#34; were used.

Reproduce Steps:
1&#41; Create a table on Oracle:
 CREATE TABLE lob &#40;id INTEGER PRIMARY KEY, object_data BLOB&#41;
2&#41; Using following trivial snippet to insert binary as BLOB for 1000 times:

sub insert&#40;$$$&#41;
{
   my &#40;$dbh, $id, $object&#41; = @_;
   my $sql = &#34;INSERT INTO lob&#40;id, object_data&#41; VALUES &#40;?, ?&#41;&#34;;
   my $sth = $dbh-&gt;prepare&#40;$sql&#41;;
   $sth-&gt;bind_param&#40;1, $id&#41;;
   $sth-&gt;bind_param&#40;2, $object, {ora_type =&gt; ORA_BLOB}&#41;;
   my $rv = $sth-&gt;execute&#40;&#41;;
   $sth-&gt;finish&#40;&#41;;
}
A binary file about 2KB was used in our test.

3&#41; You can observe at a &#34;top&#34; console that the memory usage increasing at about 4096 bytes per insert call.

Patch:
  It spent 2 days to dig it, all leaks are in oci8.c, inside function init_lob_refetch&#40;&#41; and ora_free_lob_refetch&#40;&#41;, leaks happened in XSUB and OCI calls. By the experiences on XSUB and OCI, it is possible for me to contribute a &#34;LOB leak&#34; patch. The patch has been tested on both &#34;simple LOB&#34; and &#34;Using Locator&#34; pattern, both &#34;INSERT&#34; and &#34;UPDATE&#34; operations.
  For &#34;Using Locator&#34; INSERT/UPDATE test examples, just see author Tim Bunce&#39;s detailed document: <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~timb/DBD-Oracle-1.15/Oracle.pm">http://search.cpan.org/~timb/DBD-Oracle-1.15/Oracle.pm</a></span>, section &#34;Handling LOBs&#34;.

Dongqiang Bai
2004-06-09
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/105408/19701/DBD-Oracle-1.15-lob.patch">Download DBD-Oracle-1.15-lob.patch</a><br />
<span class="downloadcontenttype">text/x-diff 6.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -Naur DBD-Oracle-1.15/oci8.c DBD-Oracle-1.15-patch/oci8.c
--- DBD-Oracle-1.15/oci8.c	Sat Jan 10 09:00:34 2004
+++ DBD-Oracle-1.15-patch/oci8.c	Wed Jun  9 10:25:41 2004
@@ -1491,7 +1491,7 @@
 		    ++src;
 		*len = src - start;
 		if &#40;copy&#41; {
-		    p = alloc_via_sv&#40;*len, 0, 1&#41;;
+		    p = &#40;char *&#41;malloc&#40;&#40;*len&#41; + 1&#41;;
 		    strncpy&#40;p, start, *len&#41;;
 		    p[*len] = &#39;\0&#39;;
 		    return p;
@@ -1581,6 +1581,7 @@
       strcpy&#40;new_tablename, syn_schema&#41;;
       strcat&#40;new_tablename, &#34;.&#34;&#41;;
       strcat&#40;new_tablename, syn_name&#41;;
+      free&#40;tablename&#41;;
       tablename=new_tablename;
       if &#40;DBIS-&gt;debug &gt;= 3&#41;
 	PerlIO_printf&#40;DBILOGFP, &#34;       lob refetch synonym, schema=%s, name=%s, new tablename=%s\n&#34;, syn_schema, syn_name, tablename&#41;;
@@ -1595,6 +1596,8 @@
 	    &#40;ub1&#41;OCI_OTYPE_NAME, &#40;ub1&#41;1, &#40;ub1&#41;OCI_PTYPE_VIEW, dschp, status&#41;;
       if &#40;status != OCI_SUCCESS&#41; {
 	OCIHandleFree_log_stat&#40;dschp, OCI_HTYPE_DESCRIBE, status&#41;;
+	if &#40;tablename != new_tablename&#41;
+	  free&#40;tablename&#41;;
 	return oci_error&#40;sth, errhp, status, &#34;OCIDescribeAny&#40;view&#41;/LOB refetch&#34;&#41;;
       }
     } 
@@ -1611,6 +1614,8 @@
     }
     if &#40;status != OCI_SUCCESS&#41; {
 	OCIHandleFree_log_stat&#40;dschp, OCI_HTYPE_DESCRIBE, status&#41;;
+	if &#40;tablename != new_tablename&#41;
+	  free&#40;tablename&#41;;
 	return oci_error&#40;sth, errhp, status, &#34;OCIDescribeAny/OCIAttrGet/LOB refetch&#34;&#41;;
     }
     if &#40;DBIS-&gt;debug &gt;= 3&#41;
@@ -1627,35 +1632,47 @@
 	    break;
         OCIAttrGet_log_stat&#40;colhd, OCI_DTYPE_PARAM, &#38;col_dbtype, 0,
                             OCI_ATTR_DATA_TYPE, errhp, status&#41;;
-        if &#40;status&#41;
-                break;
+        if &#40;status&#41; {
+	    OCIDescriptorFree&#40;colhd, OCI_DTYPE_PARAM&#41;;
+	    break;
+        }
         OCIAttrGet_log_stat&#40;colhd, OCI_DTYPE_PARAM, &#38;col_name, &#38;col_name_len,
               OCI_ATTR_NAME, errhp, status&#41;;
-        if &#40;status&#41;
-                break;
+        if &#40;status&#41; {
+	    OCIDescriptorFree&#40;colhd, OCI_DTYPE_PARAM&#41;;
+	    break;
+        }
 	if &#40;DBIS-&gt;debug &gt;= 3&#41;
 	    PerlIO_printf&#40;DBILOGFP, &#34;       lob refetch table col %d: &#39;%.*s&#39; otype %d\n&#34;,
 		&#40;int&#41;i, &#40;int&#41;col_name_len,col_name, col_dbtype&#41;;
-	if &#40;col_dbtype != SQLT_CLOB &#38;&#38; col_dbtype != SQLT_BLOB&#41;
+	if &#40;col_dbtype != SQLT_CLOB &#38;&#38; col_dbtype != SQLT_BLOB&#41; {
+	    OCIDescriptorFree&#40;colhd, OCI_DTYPE_PARAM&#41;;
 	    continue;
+	}
 	if &#40;!lob_cols_hv&#41;
 	    lob_cols_hv = newHV&#40;&#41;;
 	sv = newSViv&#40;col_dbtype&#41;;
-	&#40;void&#41;sv_setpvn&#40;sv, col_name, col_name_len&#41;;
+/*	&#40;void&#41;sv_setpvn&#40;sv, col_name, col_name_len&#41;;
 #ifdef UTF8_SUPPORT
 	DBD_SET_UTF8&#40;sv&#41;;
 #endif
-	&#40;void&#41;SvIOK_on&#40;sv&#41;;   /* what a wonderful hack! */
+	&#40;void&#41;SvIOK_on&#40;sv&#41;;*/   /* what a wonderful hack! */
 	hv_store&#40;lob_cols_hv, col_name,col_name_len, sv,0&#41;;
+	OCIDescriptorFree&#40;colhd, OCI_DTYPE_PARAM&#41;;
     }
+    OCIHandleFree&#40;dschp, OCI_HTYPE_DESCRIBE&#41;;
     if &#40;status != OCI_SUCCESS&#41; {
-	OCIHandleFree_log_stat&#40;dschp, OCI_HTYPE_DESCRIBE, status&#41;;
+	if &#40;tablename != new_tablename&#41;
+	  free&#40;tablename&#41;;
 	return oci_error&#40;sth, errhp, status,
 		    &#34;OCIDescribeAny/OCIParamGet/OCIAttrGet/LOB refetch&#34;&#41;;
     }
-    if &#40;!lob_cols_hv&#41;
+    if &#40;!lob_cols_hv&#41; {
+	if &#40;tablename != new_tablename&#41;
+	  free&#40;tablename&#41;;
 	return oci_error&#40;sth, errhp, OCI_ERROR,
 		    &#34;LOB refetch failed, no lobs in table&#34;&#41;;
+    }
 
     /*	our bind params are in %imp_sth-&gt;all_params_hv
 	our table cols are in %lob_cols_hv
@@ -1694,8 +1711,9 @@
 	    else {			/* got a type match - check it&#39;s safe	*/
 		SV *sv_other;
 		char *p_other;
+		I32 i_other;
 		/* would any other lob field match this type? */
-		while&#40; &#40;sv_other = hv_iternextsv&#40;lob_cols_hv, &#38;p_other, &#38;i&#41;&#41; != NULL &#41; {
+		while&#40; &#40;sv_other = hv_iternextsv&#40;lob_cols_hv, &#38;p_other, &#38;i_other&#41;&#41; != NULL &#41; {
 		    if &#40;phs-&gt;ftype != SvIV&#40;sv_other&#41;&#41;
 			continue;
 		    if &#40;DBIS-&gt;debug &gt;= 3&#41;
@@ -1703,6 +1721,10 @@
 			&#34;       both %s and %s have type %d - ambiguous\n&#34;,
 				neatsvpv&#40;sv,0&#41;, neatsvpv&#40;sv_other,0&#41;, &#40;int&#41;SvIV&#40;sv_other&#41;&#41;;
 		    Safefree&#40;lr&#41;;
+		    sv_free&#40;&#40;SV*&#41;lob_cols_hv&#41;;
+		    sv_free&#40;sql_select&#41;;
+		    if &#40;tablename != new_tablename&#41;
+			free&#40;tablename&#41;;
 		    return oci_error&#40;sth, errhp, OCI_ERROR,
 			&#34;Need bind_param&#40;..., { ora_field=&gt;... }&#41; attribute to identify table LOB field names&#34;&#41;;
 		}
@@ -1716,7 +1738,7 @@
 		&#34;       lob refetch %s param: otype %d, matched field &#39;%s&#39; %s&#40;%s&#41;\n&#34;,
 		    phs-&gt;name, phs-&gt;ftype, p,
 		    &#40;phs-&gt;ora_field&#41; ? &#34;by name &#34; : &#34;by type &#34;, sql_field&#41;;
-	    hv_delete&#40;lob_cols_hv, p, i, 0&#41;;
+	    hv_delete&#40;lob_cols_hv, p, i, G_DISCARD&#41;;
 	    fbh = &#38;lr-&gt;fbh_ary[lr-&gt;num_fields++];
 	    fbh-&gt;name   = phs-&gt;name;
 	    fbh-&gt;ftype  = phs-&gt;ftype;
@@ -1734,8 +1756,12 @@
 		    phs-&gt;name, phs-&gt;ftype&#41;;
 	}
     }
+    sv_free&#40;&#40;SV*&#41;lob_cols_hv&#41;;
     if &#40;unmatched_params&#41; {
         Safefree&#40;lr&#41;;
+        sv_free&#40;sql_select&#41;;
+        if &#40;tablename != new_tablename&#41;
+	    free&#40;tablename&#41;;
 	return oci_error&#40;sth, errhp, OCI_ERROR,
 	    &#34;Can&#39;t match some parameters to LOB fields in the table, check type and name&#34;&#41;;
     }
@@ -1746,6 +1772,8 @@
     if &#40;DBIS-&gt;debug &gt;= 3&#41;
 	PerlIO_printf&#40;DBILOGFP,
 	    &#34;       lob refetch sql: %s\n&#34;, SvPVX&#40;sql_select&#41;&#41;;
+    if &#40;tablename != new_tablename&#41;
+	free&#40;tablename&#41;;
     lr-&gt;sql_select = sql_select;
 
     lr-&gt;stmthp = NULL;
@@ -1759,15 +1787,24 @@
     OCIStmtPrepare_log_stat&#40;lr-&gt;stmthp, errhp,
 		&#40;text*&#41;SvPVX&#40;sql_select&#41;, SvCUR&#40;sql_select&#41;, OCI_NTV_SYNTAX,
 		OCI_DEFAULT, status&#41;;
-    if &#40;status != OCI_SUCCESS&#41;
+    if &#40;status != OCI_SUCCESS&#41; {
+        OCIHandleFree&#40;lr-&gt;stmthp, OCI_HTYPE_STMT&#41;;
+        sv_free&#40;lr-&gt;sql_select&#41;;
+        Safefree&#40;lr&#41;;
 	return oci_error&#40;sth, errhp, status, &#34;OCIStmtPrepare/LOB refetch&#34;&#41;;
+    }
 
     /* bind the rowid input */
     OCIDescriptorAlloc_ok&#40;imp_sth-&gt;envhp, &#38;lr-&gt;rowid, OCI_DTYPE_ROWID&#41;;
     OCIBindByName_log_stat&#40;lr-&gt;stmthp, &#38;lr-&gt;bindhp, errhp, &#40;text*&#41;&#34;:rid&#34;, 4,
            &#38;lr-&gt;rowid, sizeof&#40;OCIRowid*&#41;, SQLT_RDD, 0,0,0,0,0, OCI_DEFAULT, status&#41;;
-    if &#40;status != OCI_SUCCESS&#41;
+    if &#40;status != OCI_SUCCESS&#41; {
+        OCIDescriptorFree&#40;lr-&gt;rowid, OCI_DTYPE_ROWID&#41;;
+        OCIHandleFree&#40;lr-&gt;stmthp, OCI_HTYPE_STMT&#41;;
+        sv_free&#40;lr-&gt;sql_select&#41;;
+        Safefree&#40;lr&#41;;
 	return oci_error&#40;sth, errhp, status, &#34;OCIBindByPos/LOB refetch&#34;&#41;;
+    }
 
     /* define the output fields */
     for&#40;i=0; i &lt; lr-&gt;num_fields; ++i&#41; {
@@ -1788,8 +1825,15 @@
 	OCIDefineByPos_log_stat&#40;lr-&gt;stmthp, &#38;defnp, errhp, &#40;ub4&#41;i+1,
 		&#38;fbh-&gt;desc_h, -1, &#40;ub2&#41;fbh-&gt;ftype,
 		fbh-&gt;fb_ary-&gt;aindp, 0, fbh-&gt;fb_ary-&gt;arcode, OCI_DEFAULT, status&#41;;
-	if &#40;status != OCI_SUCCESS&#41;
+	if &#40;status != OCI_SUCCESS&#41; {
+	    OCIDescriptorFree&#40;lr-&gt;rowid, OCI_DTYPE_ROWID&#41;;
+	    OCIHandleFree&#40;lr-&gt;stmthp, OCI_HTYPE_STMT&#41;;
+	    sv_free&#40;lr-&gt;sql_select&#41;;
+	    Safefree&#40;lr&#41;;
+	    fb_ary_free&#40;fbh-&gt;fb_ary&#41;;
+	    fbh-&gt;fb_ary = NULL;
 	    return oci_error&#40;sth, errhp, status, &#34;OCIDefineByPos/LOB refetch&#34;&#41;;
+	}
     }
 
     imp_sth-&gt;lob_refetch = lr;	/* structure copy */
@@ -1884,6 +1928,8 @@
     }
     sv_free&#40;lr-&gt;sql_select&#41;;
     sv_free&#40;lr-&gt;fbh_ary_sv&#41;;
+    if &#40;lr-&gt;rowid&#41;
+	OCIDescriptorFree&#40;lr-&gt;rowid, OCI_DTYPE_ROWID&#41;;
     Safefree&#40;imp_sth-&gt;lob_refetch&#41;;
     imp_sth-&gt;lob_refetch = NULL;
 }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-105409" href="/Public/Bug/Display.html?id=6560#txn-105409">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;13&nbsp;16:45:42&nbsp;2004</span>
    <span class="description">TIMB [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-105410" href="/Public/Bug/Display.html?id=6560#txn-105410">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;13&nbsp;16:45:42&nbsp;2004</span>
    <span class="description">TIMB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/105410/20670/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/20670">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 98b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m applying it &#40;in modified form&#41; for DBD::Oracle 1.16.
Please retest when it&#39;s released.
Thanks!
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.288219</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
