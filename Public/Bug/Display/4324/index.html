<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #4324 for Data-Structure-Util: has_circular_ref is fooled by combination of weak and strong references</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #4324 for Data-Structure-Util: has_circular_ref is fooled by combination of weak and strong references</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Data-Structure-Util/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Data-Structure-Util/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Data-Structure-Util/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Data-Structure-Util/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Data-Structure-Util">Data-Structure-Util CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">4324</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Data-Structure-Util/Active/">Data-Structure-Util</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
autarch [...] urth.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-9344-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.04    </td>
  </tr>
  <tr id="CF-9345-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;07&nbsp;10:46:48&nbsp;2003</span>
    <span class="description">DROLSKY [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> has_circular_ref is fooled by combination of weak and strong
    references</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The has_circular_ref&#40;&#41; function can be fooled by the following combination of weak and strong references:

  my $obj = { key1 =&gt; {} };
  $obj-&gt;{key2}{key3} = $obj-&gt;{key1}; # strong ref
  weaken $obj-&gt;{key1};

Apparently it sees the weak reference of key1 first, and never catches the strong references nested more deeply in the data structure.

I&#39;m not sure how to work around this.

I&#39;ve attached a version of 02circular.t which includes a test for this, and also cleans up testing for the existence of Scalar::Util::weaken&#40;&#41;.

On a semi-related note, this function would be much more useful if it could indicate exactly where the circular refs occur, as oppoosed to simply saying they exist.
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use strict;
use warnings;
use blib;
use Data::Structure::Util qw&#40;has_utf8 utf8_off utf8_on unbless get_blessed has_circular_ref&#41;; 
use Data::Dumper;


our $WEAKEN;
BEGIN {
  eval q{ use Scalar::Util qw&#40;weaken isweak&#41; };
  if &#40;$@&#41; {
    eval q{ use Test::Simple tests =&gt; 13 };
  }
  else {
    eval q{ use Test::Simple tests =&gt; 17 };
    $WEAKEN = 1 if defined &#38;Scalar::Util::weaken;
  }
}

ok&#40;1,&#34;we loaded fine...&#34;&#41;;

my $obj = bless {
                  key1 =&gt; [1, 2, 3, bless {} =&gt; &#39;Tagada&#39;],
                  key2 =&gt; undef,
                  key3 =&gt; {
                            key31 =&gt; {},
                            key32 =&gt; bless { bla =&gt; [] } =&gt; &#39;Tagada&#39;,
                          },
                  key5 =&gt; bless [] =&gt; &#39;Ponie&#39;,
                } =&gt; &#39;Scoobidoo&#39;;
$obj-&gt;{key4} = \$obj;
$obj-&gt;{key3}-&gt;{key33} = $obj-&gt;{key3}-&gt;{key31};

my $thing = { var1 =&gt; {} };
$thing-&gt;{var2} = [ $thing-&gt;{var1}-&gt;{hello } ];
$thing-&gt;{var1}-&gt;{hello} = $thing-&gt;{var2};

my $obj2 = { key1 =&gt; [ sub { [] } ] };
$obj2-&gt;{key2} = $obj2-&gt;{key1};

my $obj3;
$obj3 = \$obj3;

my $obj4 = { key1 =&gt; $obj3 };

our @V1 = &#40;1, 2, sub {} &#41;;
my $obj5 = {
             key1 =&gt; undef,
             key2 =&gt; sub {},
             key3 =&gt; \@V1,
             key4 =&gt; $obj2,
             key5 =&gt; {
                       key51 =&gt; sub {},
                       key52 =&gt; \*STDERR,
                       key53 =&gt; [0, \&#34;hello&#34;],
                     },
           };
$obj5-&gt;{key5}-&gt;{key53}-&gt;[2] = $obj5-&gt;{key5};
$obj5-&gt;{key5}-&gt;{key54} = $obj5-&gt;{key5}-&gt;{key53}-&gt;[2];
$obj5-&gt;{key6} = $obj5-&gt;{key5}-&gt;{key53}-&gt;[2];
$obj5-&gt;{key5}-&gt;{key55} = $obj5-&gt;{key5}-&gt;{key53}-&gt;[2];

my $obj6 = { key1 =&gt; undef };
$obj = $obj6;
my $V2 = [1, undef, \5, sub {} ];
foreach &#40;1 .. 50&#41; {
  $obj-&gt;{key2} = {};
  $obj-&gt;{key1} = $V2;
  $obj = $obj-&gt;{key2};
}
$obj-&gt;{key3} = \$obj6;

ok&#40;! has_circular_ref&#40;$thing&#41;, &#34;Not a circular ref&#34;&#41;;

my $ref = has_circular_ref&#40;$obj&#41;;
ok&#40;$ref, &#34;Got a circular reference&#34;&#41;;
ok&#40;$ref == $obj, &#34;reference is correct&#34;&#41;;

ok&#40;! has_circular_ref&#40;$obj2&#41;, &#34;No circular reference&#34;&#41;;
ok&#40;has_circular_ref&#40;$obj3&#41;, &#34;Got a circular reference&#34;&#41;;
ok&#40;has_circular_ref&#40;$obj4&#41;, &#34;Got a circular reference&#34;&#41;;
ok&#40;has_circular_ref&#40;$obj5&#41;, &#34;Got a circular reference&#34;&#41;;
ok&#40;has_circular_ref&#40;$obj6&#41;, &#34;Got a circular reference&#34;&#41;;
ok&#40;$obj6 == has_circular_ref&#40;$obj6&#41;, &#34;Match reference&#34;&#41;;


ok&#40;! has_circular_ref&#40;&#41;, &#34;No circular reference&#34;&#41;;
ok&#40;! has_circular_ref&#40; [] &#41;, &#34;No circular reference&#34;&#41;;
ok&#40;has_circular_ref&#40; [ \\\\\\\\\\\\\\\\\\\\\\\\\\\\\$ref ] &#41;, &#34;Has circular reference&#34;&#41;;


if &#40;$WEAKEN&#41; {
  my $obj7 =  { key1 =&gt; {} };
  $obj7-&gt;{key1}-&gt;{key11} = $obj7-&gt;{key1};
  ok&#40;has_circular_ref&#40;$obj7&#41;, &#34;Got a circular reference&#34;&#41;;
  weaken&#40;$obj7-&gt;{key1}-&gt;{key11}&#41;;
  ok&#40;isweak&#40;$obj7-&gt;{key1}-&gt;{key11}&#41;, &#34;has weaken reference&#34;&#41;;
  ok&#40;! has_circular_ref&#40;$obj7&#41;, &#34;No more circular reference&#34;&#41;;

  my $obj8 = { key1 =&gt; {} };
  $obj8-&gt;{key2}{key3} = $obj8-&gt;{key1};
  weaken $obj8-&gt;{key1};
  ok&#40;has_circular_ref&#40;$obj8&#41;&#41;;
}
else {
  warn &#34;Scalar::Util XS version not installed, some tests skipped\n&#34;;
}

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;08&nbsp;14:00:11&nbsp;2003</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the feedback.

This a dump of the structure you suggest:

$VAR1 = {
          &#39;key2&#39; =&gt; {
                      &#39;key3&#39; =&gt; {}
                    },
          &#39;key1&#39; =&gt; $VAR1-&gt;{&#39;key2&#39;}{&#39;key3&#39;}
        };


I don&#39;t see any circular reference in it.

has_circular_ref&#40;&#41; does return a reference to an element of the circular
reference. So you can dump it and see what data it concerns. Ususally,
this is enough to guess where the circular ref lies.

Next version, I will also add a method circular_off&#40;&#41; which attempts to
weaken any reference cause of a circular reference. The result should be
a structure without any strong circular reference.

Have I replied properly?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;30&nbsp;09:56:11&nbsp;2003</span>
    <span class="description">pdenis [...] gmail.com -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
