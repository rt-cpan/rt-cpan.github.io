<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #99334 for DBIx-Class: DBIx::Class::InflateColumn::Datetime bug with SQL Server</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #99334 for DBIx-Class: DBIx::Class::InflateColumn::Datetime bug with SQL Server</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBIx-Class/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBIx-Class">DBIx-Class CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">99334</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBIx-Class/Active/">DBIx-Class</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
matthew [...] jenika.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10410-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10411-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;06&nbsp;17:18:34&nbsp;2014</span>
    <span class="description">matthew [...] jenika.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> DBIx::Class::InflateColumn::Datetime bug with SQL Server</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 6 Oct 2014 14:18:23 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Matthew McGillis &lt;matthew [...] jenika.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The following table definition works fine for mysql:

package Test::DB::Result::TestTable;

__PACKAGE__-&gt;load_components&#40;qw/Core InflateColumn::DateTime/&#41;;
__PACKAGE__-&gt;table&#40;&#39;testtable&#39;&#41;;

__PACKAGE__-&gt;add_columns&#40;&#39;id&#39;,&#39;attribute&#39;&#41;;
__PACKAGE__-&gt;add_column&#40;&#39;date&#39;=&gt;{data_type =&gt; &#39;date&#39;}&#41;;
__PACKAGE__-&gt;set_primary_key&#40;&#39;date&#39;,&#39;id&#39;&#41;;

The date stored in the database is %Y-%m-%d

However when I try to use the same table with SQL Server I get the following error:

DBIx::Class::InflateColumn::DateTime::_flate_or_fallback&#40;&#41;: Error while inflating &#39;2014-05-23&#39; for date on Test::DB::Result::TestTable=HASH&#40;0x2c281b8&#41;: Your datetime does not match your pattern. at .../share/perl5/DBIx/Class/Storage/DBI/MSSQL.pm line 204 at ....

When I look in MSSQL.pm it seems to only support:

my $datetime_format      = &#39;%Y-%m-%d %H:%M:%S.%3N&#39;; # %F %T
my $smalldatetime_format = &#39;%Y-%m-%d %H:%M:%S&#39;;

The version of DBIx::Class I&#39;m using is 0.082801.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;06&nbsp;17:21:45&nbsp;2014</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #99334] DBIx::Class::InflateColumn::Datetime bug with SQL Server</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 06 Oct 2014 23:21:24 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Rabbitson &lt;ribasushi [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 10/06/2014 11:18 PM, Matthew McGillis via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Mon Oct 06 17:18:34 2014: Request 99334 was acted upon.
&gt; Transaction: Ticket created by matthew@jenika.com
&gt;         Queue: DBIx-Class
&gt;       Subject: DBIx::Class::InflateColumn::Datetime bug with SQL Server
&gt;     Broken in: &#40;no value&#41;
&gt;      Severity: &#40;no value&#41;
&gt;         Owner: Nobody
&gt;    Requestors: matthew@jenika.com
&gt;        Status: new
&gt;   Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=99334">https://rt.cpan.org/Ticket/Display.html?id=99334</a></span> &gt;
&gt;
&gt;
&gt; The following table definition works fine for mysql:
&gt;
&gt; package Test::DB::Result::TestTable;
&gt;
&gt; __PACKAGE__-&gt;load_components&#40;qw/Core InflateColumn::DateTime/&#41;;
</div>^^ these two are reversed. Because Core contains all the &#34;database 
interaction&#34; logic, the IC::DT part has no chance to fire.

Please try with
__PACKAGE__-&gt;load_components&#40;qw/InflateColumn::DateTime Core/&#41;;
and let me know if your problem goes away.

On a side note - one or two versions down the road this will be a 
compile time exception as to protect the innocent.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;06&nbsp;17:21:47&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;06&nbsp;17:28:41&nbsp;2014</span>
    <span class="description">matthew [...] jenika.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #99334] DBIx::Class::InflateColumn::Datetime bug with SQL Server</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 6 Oct 2014 14:28:33 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Matthew McGillis &lt;matthew [...] jenika.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Please try with
&gt; __PACKAGE__-&gt;load_components&#40;qw/InflateColumn::DateTime Core/&#41;;
&gt; and let me know if your problem goes away.
</div>
Changing the order of the load_components had no impact on the error message. Still get the same error message.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;06&nbsp;17:45:19&nbsp;2014</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #99334] DBIx::Class::InflateColumn::Datetime bug with SQL Server</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 06 Oct 2014 23:44:59 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Rabbitson &lt;ribasushi [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 10/06/2014 11:28 PM, Matthew McGillis via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         Queue: DBIx-Class
&gt;   Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=99334">https://rt.cpan.org/Ticket/Display.html?id=99334</a></span> &gt;
&gt;
<div class="message-stanza open">&gt;&gt; Please try with
&gt;&gt; __PACKAGE__-&gt;load_components&#40;qw/InflateColumn::DateTime Core/&#41;;
&gt;&gt; and let me know if your problem goes away.
</div>&gt; Changing the order of the load_components had no impact on the error message. Still get the same error message.
</div>My apologies I didn&#39;t read your message to the end after seeing the 
initial error.

Indeed the current formatter does not seem to support bare YMD &#40;there is 
no format/parse_date methods registered in the file you already looked 
at&#41;. Could you please submit a patch adding the correct pieces?

Normally I would ask you to add a test as well, but in this case the 
MSSQL tests are so convoluted that I rather shuffle them around a bit 
when I receive your code patch which works for you in production.

Thanks in advance!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;06&nbsp;18:36:32&nbsp;2014</span>
    <span class="description">matthew [...] jenika.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #99334] DBIx::Class::InflateColumn::Datetime bug with SQL Server</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 6 Oct 2014 15:36:19 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Matthew McGillis &lt;matthew [...] jenika.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Well I don&#39;t have a patch and this is dev code that I&#39;m working on.

Having said that I tried a simple test of just replacing:

#my $datetime_format      = &#39;%Y-%m-%d %H:%M:%S.%3N&#39;; # %F %T
my $datetime_format      = &#39;%Y-%m-%d&#39;;

Not at all what you want in the big picture but just to see if it resolves things for me.

The above change then produces other warnings/errors &#40;that I never see in mysql&#41; like:

DBIx::Class::Storage::DBI::_gen_sql_bind&#40;&#41;: DateTime objects passed to search&#40;&#41; are not supported properly &#40;InflateColumn::DateTime formats and settings are not respected.&#41; See &#34;Formatting DateTime objects in queries&#34; in DBIx::Class::Manual::Cookbook. To disable this warning for good set $ENV{DBIC_DT_SEARCH_OK} to true at ....

and then

DBIx::Class::Storage::DBI::Cursor::next&#40;&#41;: DBI Exception: DBD::ODBC::st fetch failed: [FreeTDS][SQL Server]Data truncated &#40;SQL-01004&#41; [for Statement &#34;SELECT me.id, me.attribute, me.date FROM testtable me WHERE &#40; &#40; date = ? AND me.id = ? &#41; &#41;&#34; with ParamValues: 1=&#39;2014-05-23T00:00:00&#39;, 2=&#39;11&#39;] at ...

Not sure why things work so nicely and transparently with mysql and not SQL Server. I could fix the above using the information in the Cookbook but I&#39;m not inclined to add wrappers in all my code that has to then also take into account which DB it is using. The beauty of InflateColumn::Datetime with mysql is it just works I never had to worry about the Datetime objects passed to its searches.

Just my guess but some place on the mysql side we have more flexible date/time processors so it is accepting more values.

On mysql I have never gotten the above object warning so I&#39;m also not clear what is resolving that item transparently for mysql either.

If I work through the code to come up with a patch I will let you know but not sure it is a priority I may just change the schema to use datetime values and if that makes everything happy be done with it, although it would not be what is desired just one of those work arounds for now. I have a feeling this won&#39;t actually fix everything given the above warnings/errors.

But, I will pass along any modification if make any.

On Oct 6, 2014, at 2:45 PM, Peter Rabbitson via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=99334">https://rt.cpan.org/Ticket/Display.html?id=99334</a></span> &gt;
&gt; 
&gt; On 10/06/2014 11:28 PM, Matthew McGillis via RT wrote:
<div class="message-stanza open">&gt;&gt;        Queue: DBIx-Class
&gt;&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=99334">https://rt.cpan.org/Ticket/Display.html?id=99334</a></span> &gt;
&gt;&gt; 
<div class="message-stanza open">&gt;&gt;&gt; Please try with
&gt;&gt;&gt; __PACKAGE__-&gt;load_components&#40;qw/InflateColumn::DateTime Core/&#41;;
&gt;&gt;&gt; and let me know if your problem goes away.
</div>&gt;&gt; Changing the order of the load_components had no impact on the error message. Still get the same error message.
</div>&gt; My apologies I didn&#39;t read your message to the end after seeing the 
&gt; initial error.
&gt; 
&gt; Indeed the current formatter does not seem to support bare YMD &#40;there is 
&gt; no format/parse_date methods registered in the file you already looked 
&gt; at&#41;. Could you please submit a patch adding the correct pieces?
&gt; 
&gt; Normally I would ask you to add a test as well, but in this case the 
&gt; MSSQL tests are so convoluted that I rather shuffle them around a bit 
&gt; when I receive your code patch which works for you in production.
&gt; 
&gt; Thanks in advance!
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;06&nbsp;20:45:55&nbsp;2014</span>
    <span class="description">matthew [...] jenika.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #99334] DBIx::Class::InflateColumn::Datetime bug with SQL Server</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 6 Oct 2014 17:45:44 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Matthew McGillis &lt;matthew [...] jenika.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Did some more digging.

This is what I found that is so far working for me in the DBIx::Class code.

1&#41; To fix the error about date format not supported

Comment out this in: DBIx::Class::Storage::DBI::MSSQL

#__PACKAGE__-&gt;datetime_parser_type &#40;
#  &#39;DBIx::Class::Storage::DBI::MSSQL::DateTime::Format&#39;
#&#41;;

The DBIx::Class::Storage::DBI::MSSQL::DateTime::Format doesn&#39;t appear to really be different from the default other than it is dummer.


2 To fix the warning message about DateTime object usage in searches.

Note: I have never seen this because I&#39;m usually not using the current DBIx:Class code the version of code I&#39;m generally using does not generate this warning.

The DBIx::Class 0.082801 code has:

  if &#40;
    ! $ENV{DBIC_DT_SEARCH_OK}
      and
    $op eq &#39;select&#39;
      and
    first {
      length ref $_-&gt;[1]
        and
      blessed&#40;$_-&gt;[1]&#41;
        and
      $_-&gt;[1]-&gt;isa&#40;&#39;DateTime&#39;&#41;
    } @$bind
  &#41; {
    carp_unique &#39;DateTime objects passed to search&#40;&#41; are not supported &#39;
      . &#39;properly &#40;InflateColumn::DateTime formats and settings are not &#39;
      . &#39;respected.&#41; See &#34;Formatting DateTime objects in queries&#34; in &#39;
      . &#39;DBIx::Class::Manual::Cookbook. To disable this warning for good &#39;
      . &#39;set $ENV{DBIC_DT_SEARCH_OK} to true&#39;
  }

I added this just before the above as a quick fix for better transparent support of DateTime objects in queries I expect someone familiar with the code can do a much better job of this but this seems to work for me &#40;working out a generic api for any InflateColumn seems to me like it would make since&#41;:

  $bind = [ map {
              if &#40;ref&#40;$_-&gt;[1]&#41; eq &#39;DateTime&#39;&#41; {
                if &#40;exists&#40;$_-&gt;[0]{sqlt_datatype}&#41;&#41; {
                  if &#40;$_-&gt;[0]{sqlt_datatype} eq &#39;date&#39;&#41; {
                    $_-&gt;[1]=$self-&gt;datetime_parser-&gt;format_date&#40;$_-&gt;[1]&#41;;
                  } elsif &#40;$_-&gt;[0]{sqlt_datatype} eq &#39;datetime&#39;&#41; {
                    $_-&gt;[1]=$self-&gt;datetime_parser-&gt;format_datetime&#40;$_-&gt;[1]&#41;;
                  }
                  # add other formats if we support them ?time? maybe.
                }
              }
              $_;
                } @$bind];
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;07&nbsp;03:19:49&nbsp;2014</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #99334] DBIx::Class::InflateColumn::Datetime bug with SQL Server</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 07 Oct 2014 09:19:29 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Rabbitson &lt;ribasushi [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 10/07/2014 02:45 AM, Matthew McGillis via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         Queue: DBIx-Class
&gt;   Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=99334">https://rt.cpan.org/Ticket/Display.html?id=99334</a></span> &gt;
&gt;
&gt; Did some more digging.
&gt;
&gt; This is what I found that is so far working for me in the DBIx::Class code.
&gt;
&gt; 1&#41; To fix the error about date format not supported
&gt;
&gt; Comment out this in: DBIx::Class::Storage::DBI::MSSQL
&gt;
&gt; #__PACKAGE__-&gt;datetime_parser_type &#40;
&gt; #  &#39;DBIx::Class::Storage::DBI::MSSQL::DateTime::Format&#39;
&gt; #&#41;;
&gt;
&gt; The DBIx::Class::Storage::DBI::MSSQL::DateTime::Format doesn&#39;t appear to really be different from the default other than it is dummer.
</div>
This is incorrect. The default formatter has no concept of microseconds 
- if you tried to execute the test suite with the above change you&#39;d 
have noticed that t/inflate/datetime_mssql.t started failing. The proper 
fix is to add a sub format_date { ... } and sub parse_date { ... }with 
the appropriate code in them.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; 2 To fix the warning message about DateTime object usage in searches.
&gt;
&gt; Note: I have never seen this because I&#39;m usually not using the current DBIx:Class code the version of code I&#39;m generally using does not generate this warning.
&gt;
&gt; The DBIx::Class 0.082801 code has:
&gt;
&gt;    if &#40;
&gt;      ! $ENV{DBIC_DT_SEARCH_OK}
&gt;        and
&gt;      $op eq &#39;select&#39;
&gt;        and
&gt;      first {
&gt;        length ref $_-&gt;[1]
&gt;          and
&gt;        blessed&#40;$_-&gt;[1]&#41;
&gt;          and
&gt;        $_-&gt;[1]-&gt;isa&#40;&#39;DateTime&#39;&#41;
&gt;      } @$bind
&gt;    &#41; {
&gt;      carp_unique &#39;DateTime objects passed to search&#40;&#41; are not supported &#39;
&gt;        . &#39;properly &#40;InflateColumn::DateTime formats and settings are not &#39;
&gt;        . &#39;respected.&#41; See &#34;Formatting DateTime objects in queries&#34; in &#39;
&gt;        . &#39;DBIx::Class::Manual::Cookbook. To disable this warning for good &#39;
&gt;        . &#39;set $ENV{DBIC_DT_SEARCH_OK} to true&#39;
&gt;    }
&gt;
&gt; I added this just before the above as a quick fix for better transparent support of DateTime objects in queries I expect someone familiar with the code can do a much better job of this but this seems to work for me &#40;working out a generic api for any InflateColumn seems to me like it would make since&#41;:
&gt;
&gt;    $bind = [ map {
&gt;                if &#40;ref&#40;$_-&gt;[1]&#41; eq &#39;DateTime&#39;&#41; {
&gt;                  if &#40;exists&#40;$_-&gt;[0]{sqlt_datatype}&#41;&#41; {
&gt;                    if &#40;$_-&gt;[0]{sqlt_datatype} eq &#39;date&#39;&#41; {
&gt;                      $_-&gt;[1]=$self-&gt;datetime_parser-&gt;format_date&#40;$_-&gt;[1]&#41;;
&gt;                    } elsif &#40;$_-&gt;[0]{sqlt_datatype} eq &#39;datetime&#39;&#41; {
&gt;                      $_-&gt;[1]=$self-&gt;datetime_parser-&gt;format_datetime&#40;$_-&gt;[1]&#41;;
&gt;                    }
&gt;                    # add other formats if we support them ?time? maybe.
&gt;                  }
&gt;                }
&gt;                $_;
&gt;                  } @$bind];
&gt;
</div>
Let&#39;s step back and think about this. There is a rather verbose warning 
in place, in one of the more widely used modules on CPAN. If there 
indeed was a way to solve the problem *completely*, a solution &#40;no 
matter how contrived&#41; would have been put in place instead of this warning.

The reason your proposal is not acceptable is that any column_info 
metadata that drives how exactly the given times are interpreted are not 
consulted. So now everyone who used the &#39;timezone&#39; option of IC::DT is 
going to start getting incorrect values shoved into the database.

The fundamental problem stems from the entire InflateColumn 
infrastructure being misdesigned in a way that makes it not suitable for 
use in a search&#40;&#41; context. In fact this is the oldest open bug in the 
queue: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=43075">https://rt.cpan.org/Ticket/Display.html?id=43075</a></span>. The real answer 
&#40;which is currently blocked by lack of tuits&#41; is to add an InflateColumn 
replacement, and use it for row-data-independent inflators &#40;like DT 
inflation&#41; instead. At the rate of current dev this feature is unlikely 
to come in before next spring.

Note that I am giving you the above verbose explanation not as an 
&#34;intimidation tool&#34;, but simply as a better reason why the second part 
of your report is not acceptable for mainlining. For the time being the 
only official way to use DT in search&#40;&#41;es remains the one described 
here: 
<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/release/RIBASUSHI/DBIx-Class-0.082801/lib/DBIx/Class/Manual/Cookbook.pod#Formatting-DateTime-objects-in-queries">https://metacpan.org/pod/release/RIBASUSHI/DBIx-Class-0.082801/lib/DBIx/Class/Manual/Cookbook.pod#Formatting-DateTime-objects-in-queries</a></span>

Your original issue of lacking a &#34;date&#34; inflator/deflator is however 
indeed fixable. Or as you noted earlier - switching the datatype to 
&#34;datetime&#34; is a quick workaround for this &#40;I will still fix the date 
situation when I get to it, likely next maj, release in a months or so&#41;.

Cheers and thanks for looking into this ;&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;07&nbsp;12:30:46&nbsp;2014</span>
    <span class="description">matthew [...] jenika.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #99334] DBIx::Class::InflateColumn::Datetime bug with SQL Server</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 7 Oct 2014 09:30:33 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Matthew McGillis &lt;matthew [...] jenika.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This is incorrect. The default formatter has no concept of microseconds 
&gt; - if you tried to execute the test suite with the above change you&#39;d 
&gt; have noticed that t/inflate/datetime_mssql.t started failing. The proper 
&gt; fix is to add a sub format_date { ... } and sub parse_date { ... }with 
&gt; the appropriate code in them.
</div>
What I would suggest then is simply copy and paste the DateTime::Format::MySQL information into the definition of DBIx::Class::Storage::DBI::MSSQL::DateTime::Format and adjust its DateTime::Format::Builder to include the missing time format.

That way your DBIx::Class::Storage::DBI::MSSQL::DateTIme::Format will be a little smarter than DateTime::Format::MySQL.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The real answer 
&gt; &#40;which is currently blocked by lack of tuits&#41; is to add an InflateColumn 
&gt; replacement, and use it for row-data-independent inflators &#40;like DT 
&gt; inflation&#41; instead.
</div>
Agree the InflateColumn needs rework to  support all this.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;28&nbsp;12:14:00&nbsp;2018</span>
    <span class="description">ribasushi [...] leporine.io -  Dependency by ticket #124247 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
