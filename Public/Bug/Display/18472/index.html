<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #18472 for PAR-Packer: &#34;parl foo.par script.pl ...&#34; uses a cache area that doesn&#39;t depend on foo.par</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #18472 for PAR-Packer: &#34;parl foo.par script.pl ...&#34; uses a cache area that doesn&#39;t depend on foo.par</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/PAR-Packer/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/PAR-Packer/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/PAR-Packer/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/PAR-Packer/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/PAR-Packer">PAR-Packer CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">18472</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/PAR-Packer/Active/">PAR-Packer</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">smueller [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
RSCHUPP [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-41710-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.975</li>
<li>
0.982</li>
<li>
0.991</li>
</ul>
    </td>
  </tr>
  <tr id="CF-41711-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;31&nbsp;07:34:29&nbsp;2006</span>
    <span class="description">RSCHUPP [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> &#34;parl foo.par script.pl ...&#34; uses a cache area that doesn&#39;t
 depend on foo.par</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Originally posted to the PAR mailing list
&#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.nntp.perl.org/group/perl.par/2293&#41;">http://www.nntp.perl.org/group/perl.par/2293&#41;</a></span>:

  From: Linn White

  I have a .par file stored on a network drive.  All the computers running
  the par file are using the parl.exe executable.  The files are cached on
  their pc and everything is working as it should.  However, I have numerous
  additional files packed into the par.  When I make changes to these files,
  recompile the par and place it on the network drive, other user cannot see
  the updated files, because the old files are being pulled from their local
  cache.  Changes made to my scripts though are reflected.  How do I make
  sure the additional files replace the existing chache files?

Further post show that the application reads its data as actual
files from the caching area &#40;i.e. below $ENV{PAR_TEMP}&#41; &#40;as opposed 
to using Archive::Zip methods to read directly from the par archive&#41;.
Now you would expect that the name of the cache area would be based
on some checksum of the par archive and hence would get stale
when the par is updated. But that&#39;s not in the case. In fact, every
par &#34;executed&#34; via parl gets the same cache area, because its
name is based on the checksum of the parl executable itself.

It&#39;s not clear that this is a bug, since the caching behaviour
of &#34;parl foo.par ...&#34; isn&#39;t specified anywhere. If you view
&#34;parl foo.par ...&#34; as an abbreviation for &#34;perl -MPAR=foo.par ...&#34;
you wouldn&#39;t expect that any cache whatsoever would be involved.
In this light the use of parl as described above could be considered
abuse. On the hand, you could view &#34;parl foo.par ...&#34; as being
functionally equivalent to &#34;pp -o foo.exe foo.par&#34;, followed
by &#34;foo.exe ...&#34;. Here a cache area is expected and it is definitely
dependent on some checksum of foo.exe.

I don&#39;t see an easy fix, here&#39;s what&#39;s happening:

&#34;parl foo.par script.pl&#34;

First par_mktmpdir &#40;C function in myldr/mktmpdir.c&#41; is called.
It determines progname=.../parl, then uses the checksum of
that file to construct the name $ENV{PAR_TEMP} and creates the
directory if necessary. Then the Perl code in script/par.pl is run.
It sets $progname=&#34;.../parl&#34;, detects that it is a PAR packed executable
and extracts some files from the executable into $ENV{PAR_TEMP}.
Next the code from package main in script/par.pl runs. By this time
$progname has changed to &#34;foo.par&#34;, but $ENV{PAR_TEMP} is already 
defined, so the checksum of foo.par doesn&#39;t matter. 
PAR-&gt;import is called and extracts the PAR archive into $ENV{PAR_TEMP}.
Finally &#40;with foo.par in @INC&#41; script.pl is called via &#39;do &#34;script.pl&#34;&#39;.

&#34;foo.exe ...&#34;

foo.exe is essentially the parl executable with foo.par piggy-backed.
It goes thru the same motions as above, but $progname is always
&#34;foo.exe&#34;, hence the checksum &#40;and $ENV{PAR_TEMP}&#41; is based on foo.exe.

Cheers, Roderich
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;15&nbsp;10:26:39&nbsp;2006</span>
    <span class="description">smueller [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> par [...] perl.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Roderich,

thank you for the RT ticket.

I have discussed the issue with Audrey and she thinks the cleanest
solution would be to have parl sha1 any .par file it runs to find the
correct cache. Another albeit non-preferred solution is to have parl not
use caches at all.

Still to be implemented. Takes welcome :&#41;

Steffen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;15&nbsp;10:26:41&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;15&nbsp;10:26:44&nbsp;2006</span>
    <span class="description">smueller [...] cpan.org -  Given to SMUELLER</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;18&nbsp;03:52:43&nbsp;2006</span>
    <span class="description">RSCHUPP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Still to be implemented. Takes welcome :&#41;
</div>
Thanks for the clarification. The tricky thing for
&#34;parl foo.par ...&#34; is that you have to

&#40;1&#41; unpack parl.exe itself into the cache area first
    &#40;otherwise parl would loose its feature to act as a standalone
    loader, i.e. you don&#39;t have to have PAR, Archive::Zip etc
    installed, even perl isn&#39;t needed&#41;
&#40;2&#41; unpack foo.par into the cache area

but using a cache area name based on &#40;2&#41;...

Cheers, Rodrich
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;18&nbsp;04:52:54&nbsp;2006</span>
    <span class="description">smueller [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> smueller [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Di. 18. Apr. 2006, 03:52:43, RSCHUPP wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Still to be implemented. Takes welcome :&#41;
</div></div>[sic], Takers. :&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks for the clarification. The tricky thing for
&gt; &#34;parl foo.par ...&#34; is that you have to
&gt; 
&gt; &#40;1&#41; unpack parl.exe itself into the cache area first
&gt;     &#40;otherwise parl would loose its feature to act as a standalone
&gt;     loader, i.e. you don&#39;t have to have PAR, Archive::Zip etc
&gt;     installed, even perl isn&#39;t needed&#41;
&gt; &#40;2&#41; unpack foo.par into the cache area
&gt; 
&gt; but using a cache area name based on &#40;2&#41;...
</div>
Well, I had a look at the horrifying* C code. If you look at
myldr/mktmpdir.c around lines 133 - 137. That code determines the parl
&#40;or pp-ed&#41; executable file. That file is then sha1&#39;d to get the name for
the cache area. Now, when using parl instead of a pp-ed executable,
there will be the name of the par archive to use with parl somewhere in
argv[]. If we could modify lines 133-137 to determine the name &#40;or
rather: path&#41; of the par archive, we could directly sha1 that. The
problem I see is that one would need to

a&#41; reliably determine that parl is being used and not a pp-ed archive.
b&#41; reliably determine which argument represents the path to the par archive.

As for a&#41; Of course, it would be a moderately bad idea to assume that
only the parl loader &#40;and no pp-ed archive whatsoever&#41; is named
/^parl&#40;?:\.exe|\.bin&#41;$/i. But I cannot think of a better way to do it. 

As for b&#41; I know there&#39;s various getopt libraries for C. I also found
out some time that they vary from *nix to *nix and from *nix to win32, too.

Ideas?

* That&#39;s a property I attribute to all C code.

Steffen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;18&nbsp;10:40:07&nbsp;2006</span>
    <span class="description">RSCHUPP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Well, I had a look at the horrifying* C code. If you look at
</div>
Well, some of the Perl code is also horrifying :&#41; In fact,
large portions of the C code are duplicated in Perl in scripts/par.pl.
The latter is somehow mogrified into parl.exe. I really can&#39;t
tell whether the Perl or the C version of the code is called
when you invoke parl.exe &#40;maybe both?&#41;.
You can&#39;t even explore par.pl by running it under the debugger
because everything takes place inside a BEGIN block.

Cheers, Roderich
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;15&nbsp;09:31:06&nbsp;2007</span>
    <span class="description">smueller [...] cpan.org -  Queue changed from PAR to PAR-Packer</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;15&nbsp;09:31:07&nbsp;2007</span>
    <span class="description">smueller [...] cpan.org -  Broken in 0.92 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;15&nbsp;09:31:35&nbsp;2007</span>
    <span class="description">smueller [...] cpan.org -  Broken in 0.975 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;24&nbsp;03:07:54&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Broken in 0.982 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;24&nbsp;03:07:54&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Broken in 0.991 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;24&nbsp;03:28:03&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ho ho ho.
I just spent ages debugging /usr/bin/parl to arrive at this exact 
conclusion and came to CPAN to report it..

I attach a dirty patch that resolves it, but potentially breaks god-
knows-what-else.

Works for me..
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/myldr/mktmpdir.c b/myldr/mktmpdir.c
index e15cc8b..6796a98 100644
--- a/myldr/mktmpdir.c
+++ b/myldr/mktmpdir.c
@@ -160,6 +160,14 @@ char *par_mktmpdir &#40; char **argv &#41; {
     if &#40;progname == NULL&#41;
         progname = argv[0];
 
+    /* If running like /usr/bin/parl foo.par myscript.pl then argv[0] equals
+     * parl, and we don&#39;t want to base our checksum on that! Skip ahead one
+     * argument instead..
+     */
+    if &#40;strstr&#40;progname, &#34;parl&#34;&#41; &#38;&#38; strstr&#40;argv[1], &#34;.par&#34;&#41;&#41; {
+        progname = argv[1];
+    }
+
     if &#40; !par_env_clean&#40;&#41; &#38;&#38; &#40;f = open&#40; progname, O_RDONLY | OPEN_O_BINARY &#41;&#41;&#41; {
         lseek&#40;f, -18, 2&#41;;
         read&#40;f, buf, 6&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;24&nbsp;09:34:23&nbsp;2009</span>
    <span class="description">RSCHUPP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Sep 24 03:28:03 2009, TJC wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I attach a dirty patch that resolves it, 
</div>
Thanks for the patch, but...

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; but potentially breaks god-knows-what-else.
</div>
...for starters, it breaks the test suite &#40;and I think that can&#39;t
be fixed&#41;. Sorry, if a solution would be that easy, we would have
put it in a long time ago. I think that any solution should
not meddle with the C code, but rather be implemented in par.pl.
But par.pl also suffers from doing dual duty: being called
from parl proper as well as from each pp-archive &#40;second stage
of bootstrapping&#41;. 

Cheers, Roderich
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;24&nbsp;22:00:39&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Sep 24 09:34:23 2009, RSCHUPP wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Sep 24 03:28:03 2009, TJC wrote:
&gt; ...for starters, it breaks the test suite &#40;and I think that can&#39;t
&gt; be fixed&#41;. Sorry, if a solution would be that easy, we would have
&gt; put it in a long time ago. I think that any solution should
&gt; not meddle with the C code, but rather be implemented in par.pl.
&gt; But par.pl also suffers from doing dual duty: being called
&gt; from parl proper as well as from each pp-archive &#40;second stage
&gt; of bootstrapping&#41;. 
</div>
Which bit of the test suite fails for you?

I have it passing here with my patch.. Although it was notable that I
had to do a &#34;make realclean&#34; and also remove the old system libraries first:
/usr/share/perl5/PAR/StrippedPARL/Dynamic.pm
/usr/share/perl5/PAR/StrippedPARL/Static.pm


I agree the code isn&#39;t great, but it is a major bug that&#39;s been around
for three and a half years, and it breaks parl badly. Any fix is better
than no fix.

If you let me know what is failing for you, I can try and resolve that.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;30&nbsp;04:25:33&nbsp;2009</span>
    <span class="description">RSCHUPP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Sep 24 22:00:39 2009, TJC wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Which bit of the test suite fails for you?
&gt; I have it passing here with my patch.. Although it was notable that I
&gt; had to do a &#34;make realclean&#34; and also remove the old system libraries
</div>first:

Me bad, I should have known better. Now the test suite also
passes for me and the behaviour seems as expected
for the case of &#34;parl foo.par bar.pl&#34;. &#40;The only irritation
was that cache directory used in this case was indeed different
from the cache name &#34;burned&#34; into parl. But I expected it
to be the SHA1 checksum of foo.par and it wasn&#39;t. Different bug.&#41;
 
I tightened your check for &#34;am I invoked as &#39;parl foo.par ...&#39;?&#34;
a bit &#40;just paranoid&#41;, the only thing really necessary is
to check that argv[1] is not NULL before passing it into a string
function. 

Can you check whether the attached patch works for you?
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ubr PAR-Packer/myldr/Makefile.PL PAR-Packer-0.992_04/myldr/Makefile.PL
--- a/myldr/Makefile.PL	2009-09-23 12:52:47.618181500 +0200
+++ b/myldr/Makefile.PL	2009-09-28 13:24:45.000000000 +0200
@@ -212,7 +212,7 @@
 PERL=$perl
 LD=$ld
 CC=$cc
-CFLAGS=$cflags
+CFLAGS=$cflags -DPARL_EXE=\\&#34;parl$exe\\&#34;
 LDFLAGS=$Config{ldflags}
 PERL_LDFLAGS=$ldflags
 STATIC_LDFLAGS=$static_ldflags
diff -ubr PAR-Packer/myldr/mktmpdir.c PAR-Packer-0.992_04/myldr/mktmpdir.c
--- a/myldr/mktmpdir.c	2009-09-28 12:29:14.134471200 +0200
+++ b/myldr/mktmpdir.c	2009-09-30 09:57:07.188241200 +0200
@@ -160,6 +160,29 @@
     if &#40;progname == NULL&#41;
         progname = argv[0];
 
+    /* If invoked as &#34;/usr/bin/parl foo.par myscript.pl&#34; then progname should
+     * be &#34;.../parl&#34;, and we don&#39;t want to base our checksum on that, but
+     * rather on &#34;foo.par&#34;.
+     */
+    {
+#ifdef WIN32
+#define STREQ&#40;a,b&#41; &#40;strcasecmp&#40;a,b&#41; == 0&#41;
+#else
+#define STREQ&#40;a,b&#41; &#40;strcmp&#40;a,b&#41; == 0&#41;
+#endif
+	int prog_len = strlen&#40;progname&#41;;
+	int parl_len = strlen&#40;PARL_EXE&#41;;
+
+	if &#40;prog_len &gt;= parl_len
+	    &#38;&#38; STREQ&#40;progname + prog_len - parl_len, PARL_EXE&#41;
+	    &#38;&#38; &#40;prog_len == parl_len || progname[prog_len - parl_len - 1] == dir_sep[0]&#41;
+	    &#38;&#38; argv[1]
+	    &#38;&#38; strlen&#40;argv[1]&#41; &gt;= 4
+	    &#38;&#38; STREQ&#40;argv[1] + strlen&#40;argv[1]&#41; - 4, &#34;.par&#34;&#41;&#41;
+		progname = argv[1];
+#undef STREQ
+    }
+
     if &#40; !par_env_clean&#40;&#41; &#38;&#38; &#40;f = open&#40; progname, O_RDONLY | OPEN_O_BINARY &#41;&#41;&#41; {
         lseek&#40;f, -18, 2&#41;;
         read&#40;f, buf, 6&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;01&nbsp;03:25:11&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Sep 30 04:25:33 2009, RSCHUPP wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I tightened your check for &#34;am I invoked as &#39;parl foo.par ...&#39;?&#34;
&gt; a bit &#40;just paranoid&#41;, the only thing really necessary is
&gt; to check that argv[1] is not NULL before passing it into a string
&gt; function. 
&gt; 
&gt; Can you check whether the attached patch works for you?
</div>
The attached patch does still work for me. Thanks for improving it. The
changes all look sensible.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;13&nbsp;00:29:06&nbsp;2009</span>
    <span class="description">TJC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Any chance of this fix going through yet?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;13&nbsp;03:23:07&nbsp;2009</span>
    <span class="description">RSCHUPP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Above patch checked into SVN.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;13&nbsp;03:23:08&nbsp;2009</span>
    <span class="description">RSCHUPP [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
