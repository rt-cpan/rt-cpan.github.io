<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #124061 for Archive-Ar: Clobbering deliberately zero&#39;d timestamps, etc. and deterministic archives</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #124061 for Archive-Ar: Clobbering deliberately zero&#39;d timestamps, etc. and deterministic archives</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Archive-Ar/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Archive-Ar/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Archive-Ar/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Archive-Ar/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Archive-Ar">Archive-Ar CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">124061</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Archive-Ar/Active/">Archive-Ar</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
PHILIPP [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-2492-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-2493-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;11&nbsp;17:48:38&nbsp;2018</span>
    <span class="description">PHILIPP [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Clobbering deliberately zero&#39;d timestamps, etc. and deterministic archives</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 11 Jan 2018 15:44:32 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Archive-Ar [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Philip Prindeville &lt;philipp [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi.

I had a been trying to use Archive::Ar to fake the behavior of “ar D” on really old binutils toolchains which didn’t support it &#40;basically, ‘ar D’ tells ‘ar’ to build “deterministic” archives by setting the uid, guid, and date all to the empty string, and the mode to ‘644’&#41;.  Per the ar&#40;1&#41; man page:

       D   Operate in deterministic mode.  When adding files and the archive
           index use zero for UIDs, GIDs, timestamps, and use consistent file
           modes for all files.  When this option is used, if ar is used with
           identical options and identical input files, multiple runs will
           create identical output files regardless of the input files&#39;
           owners, groups, file modes, or modification times.

I tried to write a trivial program to run through a library and fix it up, but turns out I wasn’t able to, mostly because of this one line:

   224          $params-&gt;{date} ||= timelocal&#40;localtime&#40;&#41;&#41;;


which I fixed by changing it to:

   224          $params-&gt;{date} = timelocal&#40;localtime&#40;&#41;&#41; unless &#40;exists $params-&gt;{date}&#41;;

so that’s my suggested fix.

Some opportunistic comments/suggestions/improvements:

The mangling of the filename and overwriting what’s in the hash:

   217          &#40;undef, undef, $filename&#41; = File::Spec-&gt;splitpath&#40;$filename&#41;;
   218          
   219          $params-&gt;{name} = $filename;


seems like overkill.  Especially since the ar spec requires that the filename be a basename only with slash appended to it, e.g. “myfile.o/“.  If you pass this in, splitpath&#40;&#41; will return “” as the filename.  Safer to do:

   217          &#40;undef, undef, $params-&gt;{name}&#41; = File::Spec-&gt;splitpath&#40;$filename&#41;
   218                  unless &#40;exists $params-&gt;{name}&#41;;

or otherwise:

   217          &#40;undef, undef, $filename&#41; = File::Spec-&gt;splitpath&#40;$filename&#41;;
   218          
   219          $params-&gt;{name} = $filename . ‘/‘;

per the Wiki article on AR: <span class="clickylink"><a target="new" rel="nofollow" href="https://en.wikipedia.org/wiki/Ar_&#40;Unix&#41;">https://en.wikipedia.org/wiki/Ar_&#40;Unix&#41;</a></span>

    System V ar uses a &#39;/&#39; character &#40;0x2F&#41; to mark the end of the filename; this allows for the use of spaces without the use of an extended filename.

Not sure about this line:

   226          $params-&gt;{mode} ||= &#34;100644”;

as “644” is the canonical value in binutils/bfd/archive.c.  I think “100644” is a Debian-ism.

And the pod here:

   560  =item * C&lt;add_data&#40;I&lt;&#34;filename&#34;&gt;, I&lt;$filedata&gt;&#41;&gt;
   561  
   562  Takes an filename and a set of data to represent it. Unlike C&lt;add_files&gt;, C&lt;add_data&gt;
   563  is a virtual add, and does not require data on disk to be present. The
   564  data is a hash that looks like:


is incorrect, as it omits the 2nd argument, $data:

   205  sub add_data
   206  {
   207          my&#40;$this, $filename, $data, $params&#41; = @_;


and as a general comment, it’s an arbitrary restriction that you can’t add_data&#40;&#41; over an existing file.  Sometimes you want to rewrite a file in place, preserving its order in the archive… otherwise you have to remove it AND ALL THE FILES WHICH FOLLOW IT and add then back in the original order.  That’s a little tedious.

Looking at:

   390          if&#40;exists&#40;$this-&gt;{_filehash}-&gt;{$file-&gt;{name}}&#41;&#41;
   391          {
   392                  $this-&gt;_dowarn&#40;&#34;Can&#39;t _addFile because virtual file already exists with that name in the archive&#34;&#41;;
   393                  return;
   394          }
   395  
   396          push @{$this-&gt;{_files}}, $file-&gt;{name};


it’s not clear to me why this can’t just be:

   390          push @{$this-&gt;{_files}}, $file-&gt;{name} unless &#40;exists&#40;$this-&gt;{_filehash}-&gt;{$file-&gt;{name}}&#41;&#41;;

instead.

Attaching diffs for the patched version I’m using.
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;17&nbsp;01:36:27&nbsp;2018</span>
    <span class="description">jbazik [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for your patch and the careful description of your suggested changes.  I agree with all your points.  One question: your line numbers do not match the current release.  Is your patch against version 2.02?

John
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;17&nbsp;01:36:28&nbsp;2018</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;17&nbsp;18:55:15&nbsp;2018</span>
    <span class="description">PHILIPP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Feb 17 01:36:27 2018, JBAZIK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks for your patch and the careful description of your suggested
&gt; changes.  I agree with all your points.  One question: your line
&gt; numbers do not match the current release.  Is your patch against
&gt; version 2.02?
&gt; 
&gt; John
</div>

No, it was against 1.12 because I was working on an old distro &#40;CentOS 6.8 if I remember&#41;.

I&#39;ll rework and retest the patch.

Thanks
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;17&nbsp;20:53:59&nbsp;2018</span>
    <span class="description">PHILIPP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jan 11 17:48:38 2018, PHILIPP wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The mangling of the filename and overwriting what’s in the hash:
&gt; 
&gt; 217          &#40;undef, undef, $filename&#41; = File::Spec-
<div class="message-stanza open">&gt; &gt;splitpath&#40;$filename&#41;;
</div>&gt;           218
&gt; 219          $params-&gt;{name} = $filename;
&gt; 
&gt; 
&gt; seems like overkill.  Especially since the ar spec requires that the
&gt; filename be a basename only with slash appended to it, e.g.
&gt; “myfile.o/“.  If you pass this in, splitpath&#40;&#41; will return “” as the
&gt; filename.  Safer to do:
&gt; 
&gt; 217          &#40;undef, undef, $params-&gt;{name}&#41; = File::Spec-
<div class="message-stanza open">&gt; &gt;splitpath&#40;$filename&#41;
</div>&gt; 218                  unless &#40;exists $params-&gt;{name}&#41;;
&gt; 
&gt; or otherwise:
&gt; 
&gt; 217          &#40;undef, undef, $filename&#41; = File::Spec-
<div class="message-stanza open">&gt; &gt;splitpath&#40;$filename&#41;;
</div>&gt;           218
&gt; 219          $params-&gt;{name} = $filename . ‘/‘;
&gt; 
&gt; per the Wiki article on AR: <span class="clickylink"><a target="new" rel="nofollow" href="https://en.wikipedia.org/wiki/Ar_&#40;Unix&#41;">https://en.wikipedia.org/wiki/Ar_&#40;Unix&#41;</a></span>
&gt; 
&gt; System V ar uses a &#39;/&#39; character &#40;0x2F&#41; to mark the end of the
&gt; filename; this allows for the use of spaces without the use of an
&gt; extended filename.
</div>
Actually, doing the right thing in all cases turns out to be non-trivial.  There are certain Gnu/Linux toolchains that don&#39;t follow the System V standard of taking the basename of the file and appending slash.

Let me think about how to best handle this.  Guessing the correct name when adding files is hard, but not mangling the names of an existing archive should be trivial.

If we do a:

$attr = $ar-&gt;get_contents&#40;$file&#41;;

and then edit the contents, and put it back as:

$bytes = $ar-&gt;add_data&#40;$file, $attr-&gt;{data}, $attr&#41;;

then the name we&#39;re given &#40;either $file or $attr-&gt;{name}&#41; should be considered &#34;canonical&#34; and not get modified in any way.

Similarly Debian uses &#34;100644&#34; for the modes, but most other systems use &#34;644&#34; instead.

I&#39;ll need to think about adding tests to infer the correct values in all cases.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
