<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #67639 for Math-Pari: [PATCH] stdout clobbered with newlines</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #67639 for Math-Pari: [PATCH] stdout clobbered with newlines</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Math-Pari/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Math-Pari/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Math-Pari/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Math-Pari/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Math-Pari">Math-Pari CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">67639</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Math-Pari/Active/">Math-Pari</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mhasch-cpanbugs [...] cozap.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-20832-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.01080604    </td>
  </tr>
  <tr id="CF-20833-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;20&nbsp;18:47:54&nbsp;2011</span>
    <span class="description">hasch-cpan [...] cozap.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] stdout clobbered with newlines</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I observed this problem with Math-Pari-2.01080604 and pari-2.3.5.
Math-Pari-2.01080604 worked fine with pari-2.1.7.

When Math::Pari passes a PARI error on as a Perl exception, a newline
strays to stdout from inside PARI.  This might be owed to some error
handling &#34;improvement&#34; intended for GP only, and thus a PARI bug, but
Math::Pari could cope with it by not exposing stdout to PARI output at
all.  This kind of encapsulation could also mitigate similar bugs in the
future.

My patch gives PARI a black hole to talk to while its output is not
wanted, and reestablishes this setting after PARI has dropped output
redirection as a part of its error recovery routine.

Test case:
 
  perl -MMath::Pari -e &#39;$x=PARI&#40;0&#41;;$y=eval{$x/$x}||eval{$x**-1}&#39;

This should print nothing but prints two empty lines on affected platforms.

-Martin
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> clean_stdout.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ru Math-Pari-2.01080604.orig/Pari.xs Math-Pari-2.01080604/Pari.xs
--- Math-Pari-2.01080604.orig/Pari.xs	2010-03-03 22:53:32.000000000 +0100
+++ Math-Pari-2.01080604/Pari.xs	2011-04-20 23:52:35.000000000 +0200
@@ -719,6 +719,24 @@
     /* EMPTY */
 }
 
+static void
+null_putc&#40;char c&#41;
+{
+}
+
+static void
+null_puts&#40;PUTS_CONST char* p&#41;
+{
+}
+
+static void
+null_flush&#40;void&#41;
+{
+}
+
+static PariOUT nullOut={null_putc, null_puts, null_flush, NULL};
+
+
 /*  Support error messages of the form &#40;calling PARI&#40;&#39;O&#40;det2&#40;$mat&#41;&#41;&#39;&#41;&#41;:
 PARI:   ***   obsolete function: O&#40;det2&#40;$mat&#41;&#41;
                                    ^----------- */
@@ -748,6 +766,7 @@
   STRLEN l;
   char *s = SvPV&#40;errSv,l&#41;;
   char *nl = memchr&#40;s,&#39;\n&#39;,l&#41;;
+  pariOut = &#38;nullOut;
 
   sv_setpv&#40;workErrsv,&#34;&#34;&#41;;
   sv_2mortal&#40;errSv&#41;;
@@ -3761,6 +3780,7 @@
 #endif  /* PARI_VERSION_EXP &gt;= 2003000 */
    PariStack = &#40;SV *&#41; GENfirstOnStack;
    workErrsv = newSVpv&#40;&#34;&#34;,0&#41;;
+   pariOut = &#38;nullOut;
    pariErr = &#38;perlErr;
    foreignHandler = &#40;void*&#41;&#38;callPerlFunction;
    foreignAutoload = &#38;autoloadPerlFunction;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;21&nbsp;16:06:52&nbsp;2011</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #67639] [PATCH] stdout clobbered with newlines</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 21 Apr 2011 13:06:40 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Martin Becker via RT &lt;bug-Math-Pari [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Apr 20, 2011 at 06:47:55PM -0400, Martin Becker via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Wed Apr 20 18:47:54 2011: Request 67639 was acted upon.
&gt; Transaction: Ticket created by MHASCH
&gt;        Queue: Math-Pari
&gt;      Subject: [PATCH] stdout clobbered with newlines
&gt;    Broken in: 2.01080604
&gt;     Severity: Important
&gt;        Owner: Nobody
&gt;   Requestors: mhasch-cpanbugs@cozap.com
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=67639">https://rt.cpan.org/Ticket/Display.html?id=67639</a></span> &gt;
&gt; 
&gt; 
&gt; I observed this problem with Math-Pari-2.01080604 and pari-2.3.5.
&gt; Math-Pari-2.01080604 worked fine with pari-2.1.7.
&gt; 
&gt; When Math::Pari passes a PARI error on as a Perl exception, a newline
&gt; strays to stdout from inside PARI.  This might be owed to some error
&gt; handling &#34;improvement&#34; intended for GP only, and thus a PARI bug, but
&gt; Math::Pari could cope with it by not exposing stdout to PARI output at
&gt; all.  This kind of encapsulation could also mitigate similar bugs in the
&gt; future.
&gt; 
&gt; My patch gives PARI a black hole to talk to while its output is not
&gt; wanted, and reestablishes this setting after PARI has dropped output
&gt; redirection as a part of its error recovery routine.
</div>
My idea is that bugs in GP/PARI should be fixed on GP/PARI level &#40;and,
possibly, passed to end-users via ./patches directory and the
corresponding logic in BuildPARI.pm&#41;.

Some unrelated notes on the patches you appended:

  apparently, you did not use -p flag to diff, so it is not clear
  which functions are changed.

  it looks like you edit pariOut, but never set it back...

Yours,
Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;21&nbsp;16:06:53&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;27&nbsp;18:48:47&nbsp;2011</span>
    <span class="description">mhasch-cpanbugs [...] cozap.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #67639] [PATCH] stdout clobbered with newlines</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 28 Apr 2011 00:48:32 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Ilya Zakharevich via RT &lt;bug-Math-Pari [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Martin Becker &lt;mhasch-cpanbugs [...] cozap.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, Apr 21, 2011 at 04:06:53PM -0400, Ilya Zakharevich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=67639">https://rt.cpan.org/Ticket/Display.html?id=67639</a></span> &gt;
&gt; 
&gt; On Wed, Apr 20, 2011 at 06:47:55PM -0400, Martin Becker via RT wrote:
<div class="message-stanza open">&gt; &gt; Wed Apr 20 18:47:54 2011: Request 67639 was acted upon.
&gt; &gt; Transaction: Ticket created by MHASCH
&gt; &gt;        Queue: Math-Pari
&gt; &gt;      Subject: [PATCH] stdout clobbered with newlines
&gt; &gt;    Broken in: 2.01080604
&gt; &gt;     Severity: Important
&gt; &gt;        Owner: Nobody
&gt; &gt;   Requestors: mhasch-cpanbugs@cozap.com
&gt; &gt;       Status: new
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=67639">https://rt.cpan.org/Ticket/Display.html?id=67639</a></span> &gt;
&gt; &gt; 
&gt; &gt; 
&gt; &gt; I observed this problem with Math-Pari-2.01080604 and pari-2.3.5.
&gt; &gt; Math-Pari-2.01080604 worked fine with pari-2.1.7.
&gt; &gt; 
&gt; &gt; When Math::Pari passes a PARI error on as a Perl exception, a newline
&gt; &gt; strays to stdout from inside PARI.  This might be owed to some error
&gt; &gt; handling &#34;improvement&#34; intended for GP only, and thus a PARI bug, but
&gt; &gt; Math::Pari could cope with it by not exposing stdout to PARI output at
&gt; &gt; all.  This kind of encapsulation could also mitigate similar bugs in the
&gt; &gt; future.
&gt; &gt; 
&gt; &gt; My patch gives PARI a black hole to talk to while its output is not
&gt; &gt; wanted, and reestablishes this setting after PARI has dropped output
&gt; &gt; redirection as a part of its error recovery routine.
</div>&gt; 
&gt; My idea is that bugs in GP/PARI should be fixed on GP/PARI level &#40;and,
&gt; possibly, passed to end-users via ./patches directory and the
&gt; corresponding logic in BuildPARI.pm&#41;.
</div>
I agree.  If you know the bug is a GP/PARI bug, that&#39;s the way to go.
I am, however, not absolutely sure whether this is the case here.
We may be seeing a somewhat obscure API change that has not yet been
addressed in Math::Pari.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Some unrelated notes on the patches you appended:
&gt; 
&gt;   apparently, you did not use -p flag to diff, so it is not clear
&gt;   which functions are changed.
</div>
Oops.  I have attached a patch with function names now.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;   it looks like you edit pariOut, but never set it back...
</div>
Yes, that is the idea.  The released code sets pariOut temporarily
every time it needs it.  At start and in between, pariOut is connected
to stdout.  But under control of perl we do not want PARI to use stdout.
My patch therefore initializes pariOut differently.  As PARI resets
pariOut each time it has to recover from an error, the patch also takes
care to set pariOut anew when errors are about to be reported.

An advantage of ignoring output over eliminating it at its origin is
that the former does not interfere with other applications &#40;like GP&#41;
that might actually have a use for it.

But I&#39;ll be happy with any solution.

-Martin
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;28&nbsp;02:39:07&nbsp;2011</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #67639] [PATCH] stdout clobbered with newlines</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 27 Apr 2011 23:38:57 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;mhasch-cpanbugs [...] cozap.com via RT&#34; &lt;bug-Math-Pari [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Apr 27, 2011 at 06:48:48PM -0400, mhasch-cpanbugs@cozap.com via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt;   it looks like you edit pariOut, but never set it back...
</div></div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Yes, that is the idea.
</div>
Again, from my point of view: then this is not a good idea.  Too much
dependence on how GP/PARI works NOW.

Ilya
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;28&nbsp;14:27:14&nbsp;2011</span>
    <span class="description">mhasch-cpanbugs [...] cozap.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> pari-dev [...] list.cr.yp.to</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #67639] [PATCH] stdout clobbered with newlines</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 28 Apr 2011 20:27:02 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Ilya Zakharevich via RT &lt;bug-Math-Pari [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Martin Becker &lt;mhasch-cpanbugs [...] cozap.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, Apr 28, 2011 at 02:39:08AM -0400, Ilya Zakharevich via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=67639">https://rt.cpan.org/Ticket/Display.html?id=67639</a></span> &gt;
&gt; 
&gt; On Wed, Apr 27, 2011 at 06:48:48PM -0400, mhasch-cpanbugs@cozap.com via RT wrote:
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt;   it looks like you edit pariOut, but never set it back...
</div></div>&gt; 
<div class="message-stanza open">&gt; &gt; Yes, that is the idea.
</div>&gt; 
&gt; Again, from my point of view: then this is not a good idea.  Too much
&gt; dependence on how GP/PARI works NOW.
</div>
I can see your point, and I believe now that the issue is actually a
GP/PARI bug.

From what I can make out in the code, the function pari_last_was_newline&#40;&#41;
is intended to tell whether the output stream currently is at the
beginning of a line.  On normal output, its state is updated to true
each time a newline is printed, otherwise false.  One mistake is that
the state is initially false, but should be true.  Before anything has
been printed, we are of course at the beginning of a line.

A second mistake is that functions like pari_warn and pari_err, while
temporarily using pariOut to format diagnostic messages, do not capture
and restore that state, but leave it wherever their non-stdout output has
taken it.  To fix this, save and restore operations for last_was_newline
could be added to the code wherever pariOut is saved and restored, like
it is done in GENtostr0&#40;&#41;.  But that would be somewhat clumsy and hard
to enforce.  It would be easier if the &#34;incomplete line&#34; state was bound
to each PariOUT handle rather than a global variable.

Then again the whole concept of notification handlers having to care
for what is going on on another output channel seems inelegant at best.
I would prefer to locate the decision to print additional newlines closer
to the code actually printing them, like in the flush&#40;&#41; component of a
PariOUT handle.

To summarize, I think the issue calls for some refactoring in GP/PARI
rather than a simple amendment.  I would like to leave that to its regular
developers.  Unfortunately, the problem seems to have been around for
some time now &#40;since version 2.2.11, released 2005, guessing from the
changes files&#41; and it can be a show-stopper for Math::Pari applications
needing to leave stdout alone.

Cc-ed to the pari-dev mailing list.  Can somebody help?
&#40;The discussion so far can be seen at the URL mentioned above.&#41;

-Martin
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;28&nbsp;16:03:23&nbsp;2011</span>
    <span class="description">nospam-abuse [...] ilyaz.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #67639] [PATCH] stdout clobbered with newlines</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 28 Apr 2011 13:03:12 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;mhasch-cpanbugs [...] cozap.com via RT&#34; &lt;bug-Math-Pari [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Ilya Zakharevich &lt;nospam-abuse [...] ilyaz.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, Apr 28, 2011 at 02:27:14PM -0400, mhasch-cpanbugs@cozap.com via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; From what I can make out in the code, the function pari_last_was_newline&#40;&#41;
&gt; is intended to tell whether the output stream currently is at the
&gt; beginning of a line.  On normal output, its state is updated to true
&gt; each time a newline is printed, otherwise false.  One mistake is that
&gt; the state is initially false, but should be true.  Before anything has
&gt; been printed, we are of course at the beginning of a line.
&gt; 
&gt; A second mistake is that functions like pari_warn and pari_err, while
&gt; temporarily using pariOut to format diagnostic messages, do not capture
&gt; and restore that state, but leave it wherever their non-stdout output has
&gt; taken it.  To fix this, save and restore operations for last_was_newline
&gt; could be added to the code wherever pariOut is saved and restored, like
&gt; it is done in GENtostr0&#40;&#41;.  But that would be somewhat clumsy and hard
&gt; to enforce.  It would be easier if the &#34;incomplete line&#34; state was bound
&gt; to each PariOUT handle rather than a global variable.
&gt; 
&gt; Then again the whole concept of notification handlers having to care
&gt; for what is going on on another output channel seems inelegant at best.
&gt; I would prefer to locate the decision to print additional newlines closer
&gt; to the code actually printing them, like in the flush&#40;&#41; component of a
&gt; PariOUT handle.
</div>
Very interesting!  Thanks for analysing this!

Basing on the usage scenarios I have in mind: As a temporary fix,
saving/restoring looks quite fine: I would think that most of the time
there is at most one global reset of pariOut &#40;e.g., to a GUI window&#41;
and many very short-lived temporary ones &#40;to catch certain things to
strings etc.&#41;.  The global reset would happen before any output is
done.

Do people use significantly different scenarios?

Ilya
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
