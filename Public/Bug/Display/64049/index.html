<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #64049 for MIDI-Perl: Error on close</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #64049 for MIDI-Perl: Error on close</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/MIDI-Perl/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/MIDI-Perl/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/MIDI-Perl/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/MIDI-Perl/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/MIDI-Perl">MIDI-Perl CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">64049</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">stalled</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/MIDI-Perl/Active/">MIDI-Perl</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">CONKLIN [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
njh [...] bandsman.co.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-21284-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.82    </td>
  </tr>
  <tr id="CF-21285-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;19&nbsp;07:01:48&nbsp;2010</span>
    <span class="description">njh [...] bandsman.co.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Error on close</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">MIDI::Opus often fails with this:

error while closing filehandle for /tmp/C_lEGzBDaq.midi: &#34;Bad file
descriptor&#34;

This is the type of use:

                        unlink&#40;&#39;/tmp/xxx.mp3&#39;&#41;;
} elsif&#40;$url =~ /\.midi?$/i&#41; { 
        my $tmp = File::Temp-&gt;new&#40;UNLINK =&gt; 1, SUFFIX =&gt; &#39;.midi&#39;&#41;;
        open&#40;my $midi, &#39;&gt;&#39;, $tmp&#41;;
        # Extract all text fields from the MIDI file and spider them
                
        # print &#34;MIDI $url\n&#34;;
        print $midi $$contentref;
                        
        close $midi;
                        
        my $opus = MIDI::Opus-&gt;new&#40;{&#39;from_file&#39; =&gt; $tmp,
                &#39;no_parse&#39; =&gt; 0}&#41;;
                        
        foreach my $track &#40;$opus-&gt;tracks&#41; {
                foreach my $event &#40;$track-&gt;events&#41; {
                        my $type = @$event[0];
                        if&#40;$type =~ /&#40;text|name&#41;/&#41; {
                                my $text = @$event[2];
                                                
                                foreach &#40;split&#40;/\W/, $text&#41;&#41; {
                                        my $word = prepareWord&#40;$_&#41;;
                                                        
                                        unless&#40;ignoreWord&#40;$word&#41;&#41; {
                                                # unless&#40;$matches{$word}&#41; {
                                                        # print &#34;MIDI:
found word &#39;$word&#39;\n&#34;;
                                                        $matches{$word} = 1;
                                                # }
                                        }
                                }
                        }
                }
        }
        $matches{&#39;midi&#39;} = 1;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;19&nbsp;08:09:43&nbsp;2010</span>
    <span class="description">CONKLIN [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;23&nbsp;05:11:16&nbsp;2010</span>
    <span class="description">njh [...] bandsman.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> njh [...] bandsman.co.uk</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On 23/12/10 09:58, conklin@cpan.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; Hello,
&gt;
&gt; I do not have enough information to find or address the bug you report.
&gt;
<div class="message-stanza open">&gt;&gt; MIDI::Opus often fails with this:
&gt;&gt;
&gt;&gt; error while closing filehandle for /tmp/C_lEGzBDaq.midi: &#34;Bad file
&gt;&gt; descriptor&#34;
</div>&gt;
&gt; at what line of your attached code does this happen?  &#40;also see
</div>question below&#41;.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
<div class="message-stanza open">&gt;&gt; This is the type of use:
&gt;&gt;
&gt;&gt;                        unlink&#40;&#39;/tmp/xxx.mp3&#39;&#41;;
&gt;&gt; } elsif&#40;$url =~ /\.midi?$/i&#41; {
&gt;&gt;        my $tmp = File::Temp-&gt;new&#40;UNLINK =&gt; 1, SUFFIX =&gt; &#39;.midi&#39;&#41;;
&gt;&gt;        open&#40;my $midi, &#39;&gt;&#39;, $tmp&#41;;
&gt;&gt;        # Extract all text fields from the MIDI file and spider them
&gt;&gt;
&gt;&gt;        # print &#34;MIDI $url\n&#34;;
&gt;&gt;        print $midi $$contentref;
&gt;&gt;
&gt;&gt;        close $midi;
</div>&gt;
&gt; is the line above where the error is happening?  if so, it is not an
</div>error with MIDI::Opus
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; or, presumably you&#39;ve left out code above that populates the file
</div>$tmp, as the Opus-&gt;new below shouldn&#39;t be passed an empty midi file...?

The code &#34;print $midi $$contentref&#34; populates the file.  It is not empty.

It fails in this line:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
<div class="message-stanza open">&gt;&gt;        my $opus = MIDI::Opus-&gt;new&#40;{&#39;from_file&#39; =&gt; $tmp,
&gt;&gt;                &#39;no_parse&#39; =&gt; 0}&#41;;
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;24&nbsp;05:43:11&nbsp;2010</span>
    <span class="description">CONKLIN [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;29&nbsp;16:58:24&nbsp;2010</span>
    <span class="description">CONKLIN [...] cpan.org -  Ticket deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;29&nbsp;16:58:27&nbsp;2010</span>
    <span class="description">CONKLIN [...] cpan.org -  Status changed from &#39;deleted&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;29&nbsp;17:02:56&nbsp;2010</span>
    <span class="description">CONKLIN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It fails in this line:
<div class="message-stanza open">&gt;&gt;
<div class="message-stanza open">&gt;&gt;&gt;        my $opus = MIDI::Opus-&gt;new&#40;{&#39;from_file&#39; =&gt; $tmp,
&gt;&gt;&gt;                &#39;no_parse&#39; =&gt; 0}&#41;;
</div></div></div>
I am unable to replicate your bug.  I isolated part of your code and
read myself into $$contentref the contents of a test midi file &#40;line
with &#34;***&#34;&#41;, and the code below runs &#40;does not fail in the Opus-&gt;new&#41;,
and also dumps the expected contents.  Can you try this?:

my $tmp = File::Temp-&gt;new&#40;UNLINK =&gt; 1, SUFFIX =&gt; &#39;.midi&#39;&#41;;
open&#40;my $midi, &#39;&gt;&#39;, $tmp&#41;;
# Extract all text fields from the MIDI file and spider them
# print &#34;MIDI $url\n&#34;;
$contentref = &#34;somevar&#34;; open&#40;X,&#34;x.mid&#34;&#41;; binmode&#40;X&#41;;
read&#40;X,$$contentref,10000&#41;; close&#40;X&#41;; # ***
print $midi $$contentref;
close $midi;
my $opus = MIDI::Opus-&gt;new&#40;{&#39;from_file&#39; =&gt; $tmp, &#39;no_parse&#39; =&gt; 0}&#41;;
$opus-&gt;dump&#40;{dump_tracks=&gt;1}&#41;;

But the code above should also produce an error in that case.  Therefore
the fix of this bug is stalled until the error can be reproduced.

Actually, from reading the File::Temp docs I suspect the problem is some
interaction with File::Temp which in addition to a filename also opens
and returns a filehandle &#40;therefore your handling of return values from
the File::Temp-&gt;new&#40;&#41; is not accurate&#41;.  Can you &#40;in your own code&#41; try
to replace the File::Temp-&gt;new&#40;...&#41; line by

        my $tmp = File::Temp-&gt;tmpnam&#40;&#41;;

Does your code still die?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;29&nbsp;17:02:57&nbsp;2010</span>
    <span class="description">CONKLIN [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
