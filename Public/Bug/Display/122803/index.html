<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #122803 for Tie-DB_File-SplitHash: Ensure that tempdirs created during testing are removed in  Perl 5.28</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #122803 for Tie-DB_File-SplitHash: Ensure that tempdirs created during testing are removed in  Perl 5.28</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Tie-DB_File-SplitHash/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Tie-DB_File-SplitHash/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Tie-DB_File-SplitHash/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Tie-DB_File-SplitHash/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Tie-DB_File-SplitHash">Tie-DB_File-SplitHash CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">122803</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Tie-DB_File-SplitHash/Active/">Tie-DB_File-SplitHash</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jkeenan [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-32866-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-32867-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;14&nbsp;16:33:26&nbsp;2017</span>
    <span class="description">jkeenan [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Ensure that tempdirs created during testing are removed in  Perl 5.28</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">File::Temp::tempdir&#40;&#41; internally calls File::Path::rmtree&#40;&#41; to implement the &#39;CLEANUP =&gt; 1&#39; option.  A security vulnernability was discovered in rmtree&#40;&#41; in early 2017.  This vulnerability has been addressed in File::Path versions 2.14 and later; a thus patched version of File::Path will appear in Perl-5.28 to be released in spring 2018.

The security correction changes the functionality of rmtree&#40;&#41; when not called with a true value as its third positional argument:

#####
    rmtree&#40;$my_tempdir, 0, 0&#41;;
#####

As of File::Path 2.14, this syntax will no longer remove directories for which the user lacks both &#39;read&#39; and &#39;execute&#39; permissions.  For example, any directory whose numerical permissions are octal 0000 or 0200 will no longer be deleted.

Within test_permissions&#40;&#41;, there are two blocks each of which contains a mkdir&#40;&#41; call with 0000 permisssions.  In the absence of application of this patch, test_permissions&#40;&#41; will continue to return a true value, but the 0000 directories will not be deleted and the person running the test will be shown warnings that some directories have not been deleted.

For the two blocks within test_permissions&#40;&#41;, the patch avoids File::Temp::tempdir&#39;s internal call to File::Path::rmtree and substitutes manual creation of a temporary directory for each block via File::Spec-&gt;tmpdir&#40;&#41;.  &#40;Unlike File::Temp, File::Spec has no dependency on File::Path::rmtree&#40;&#41;.&#41;  After the existing checks on the tie are run, the patch restores read/write/execute permissions to the temporary directory.  This in turn allows the use of File::Path::rmtree&#40;$dir, 0, 1&#41; -- note the true value for the true parameter -- to ensure removal of the temporary directories and the elimination of potentially confusing warnings.

The above should guarantee that this distribution&#39;s tests will run warnings-free in perl-5.27.3 and later, i.e., with File::Path version 2.14 or later.

Within test_permissions&#40;&#41; there are other test blocks not affected by the above considerations.  In those blocks the patch changes:

#####
     my $filename = tempdir&#40; DIR =&gt; test_directory&#40;&#41;, CLEANUP =&gt; 1 &#41;;
#####

to:

#####
     my $filename = tempdir&#40; CLEANUP =&gt; 1 &#41;;
#####

In File::Temp&#39;s documentation, the &#39;DIR =&gt; $somedirectory&#39; syntax is documented as pertinent to the syntax of tempfile&#40;&#41;; it is not pertinent to the syntax of tempdir&#40;&#41;.  The previous code had the probably unintended effect of creating an extra level of temporary directories.

The patch also provide descriptions for each test.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Ensure-that-tempdirs-created-during-testing-are-remo.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 96480030e06260fa0b6364a179f7e9c06e1c60ad Mon Sep 17 00:00:00 2001
From: James E Keenan &lt;jkeenan@cpan.org&gt;
Date: Mon, 14 Aug 2017 16:19:57 -0400
Subject: [PATCH] Ensure that tempdirs created during testing are removed in
 Perl 5.28.

File::Temp::tempdir&#40;&#41; internally calls File::Path::rmtree&#40;&#41; to implement the
&#39;CLEANUP =&gt; 1&#39; option.  A security vulnernability was discovered in rmtree&#40;&#41;
in early 2017.  This vulnerability has been addressed in File::Path versions
2.14 and later; a thus patched version of File::Path will appear in Perl-5.28
to be released in spring 2018.

The security correction changes the functionality of rmtree&#40;&#41; when not called
with a true value as its third positional argument:

    rmtree&#40;$my_tempdir, 0, 0&#41;;

As of File::Path 2.14, this syntax will no longer remove directories for which
the user lacks both &#39;read&#39; and &#39;execute&#39; permissions.  For example, any
directory whose numerical permissions are octal 0000 or 0200 will no longer be
deleted.

Within test_permissions&#40;&#41;, there are two blocks each of which contains a
mkdir&#40;&#41; call with 0000 permisssions.  In the absence of application of this
patch, test_permissions&#40;&#41; will continue to return a true value, but the 0000
directories will not be deleted and the person running the test will be shown
warnings that some directories have not been deleted.

For the two blocks within test_permissions&#40;&#41;, the patch avoids
File::Temp::tempdir&#39;s internal call to File::Path::rmtree and substitutes
manual creation of a temporary directory for each block via
File::Spec-&gt;tmpdir&#40;&#41;.  &#40;Unlike File::Temp, File::Spec has no dependency on
File::Path::rmtree&#40;&#41;.&#41;  After the existing checks on the tie are run, the
patch restores read/write/execute permissions to the temporary directory.
This in turn allows the use of File::Path::rmtree&#40;$dir, 0, 1&#41; -- note the true
value for the true parameter -- to ensure removal of the temporary directories
and the elimination of potentially confusing warnings.

The above should guarantee that this distribution&#39;s tests will run
warnings-free in perl-5.27.3 and later, i.e., with File::Path version 2.14 or
later.

Within test_permissions&#40;&#41; there are other test blocks not affected by the
above considerations.  In those blocks the patch changes:

     my $filename = tempdir&#40; DIR =&gt; test_directory&#40;&#41;, CLEANUP =&gt; 1 &#41;;

to:

     my $filename = tempdir&#40; CLEANUP =&gt; 1 &#41;;

In File::Temp&#39;s documentation, the &#39;DIR =&gt; $somedirectory&#39; syntax is
documented as pertinent to the syntax of tempfile&#40;&#41;; it is not pertinent to
the syntax of tempdir&#40;&#41;.  The previous code had the probably unintended effect
of creating an extra level of temporary directories.

The patch also provide descriptions for each test.
---
 t/01_Tie-DB_File-SplitHash.t | 41 ++++++++++++++++++++++++++++++-----------
 1 file changed, 30 insertions&#40;+&#41;, 11 deletions&#40;-&#41;

diff --git a/t/01_Tie-DB_File-SplitHash.t b/t/01_Tie-DB_File-SplitHash.t
index b5da057..574759d 100644
--- a/t/01_Tie-DB_File-SplitHash.t
+++ b/t/01_Tie-DB_File-SplitHash.t
@@ -10,6 +10,8 @@ use Tie::DB_File::SplitHash;
 #########################
 # change &#39;tests =&gt; 9&#39; to &#39;tests =&gt; last_test_to_print&#39;;
 
+use File::Spec;
+use File::Path qw&#40; rmtree &#41;;
 eval {
     require File::Temp;
     File::Temp-&gt;import&#40;&#39;tempdir&#39;&#41;;
@@ -39,19 +41,19 @@ my $TESTDIR = tempdir&#40;CLEANUP =&gt; 1&#41;;
 
 #########
 # Test 1
-ok &#40;test_tie&#40;&#41;&#41;;
+ok &#40;test_tie&#40;&#41;, &#34;test_tie&#40;&#41; returned true value&#34;&#41;;
 
 #########
 # Test 2
-ok &#40;test_tied_hash&#40;&#41;&#41;;
+ok &#40;test_tied_hash&#40;&#41;, &#34;test_tied_hash&#40;&#41; returned true value&#34;&#41;;
 
 #########
 # Test 3
-ok &#40;test_obj_hash&#40;&#41;&#41;;
+ok &#40;test_obj_hash&#40;&#41;, &#34;test_obj_hash&#40;&#41; returned true value&#34;&#41;;
 
 #########
 # Test 4
-ok &#40;test_permissions&#40;&#41;&#41;;
+ok &#40;test_permissions&#40;&#41;, &#34;test_permissions&#40;&#41; returned true value&#34;&#41;;
 
 exit;
 
@@ -68,7 +70,7 @@ sub test_directory {
 sub test_permissions {
  
     {
-        my $filename = tempdir&#40; DIR =&gt; test_directory&#40;&#41;, CLEANUP =&gt; 1 &#41;;
+        my $filename = tempdir&#40; CLEANUP =&gt; 1 &#41;;
         my $multi_n = 4;
         my $flags   = &#38;O_RDWR&#40;&#41; | &#38;O_CREAT&#40;&#41;;
         my $mode    = 0666;
@@ -87,15 +89,21 @@ sub test_permissions {
         }
     }
 
+    my $seed = 0;
     {
-        my $filename = tempdir&#40; DIR =&gt; test_directory&#40;&#41;, CLEANUP =&gt; 1 &#41;;
+        my $tdir = File::Spec-&gt;catdir&#40;
+            File::Spec-&gt;tmpdir&#40;&#41;,
+            $$ . sprintf&#40;&#34;%02s&#34; =&gt; ++$seed&#41;,
+        &#41;;
+        mkdir&#40;$tdir, 0700&#41; || return &#34;could not create tmpdir $tdir&#34;;
         my $multi_n = 4;
         my $flags   = &#38;O_RDWR&#40;&#41; | &#38;O_CREAT&#40;&#41;;
         my $mode    = 0666;
         my %hash;
     
+        my $extra_dir;
         my $result = eval {
-            my $extra_dir = File::Spec-&gt;catdir&#40;$filename,&#39;extra&#39;&#41;;
+            $extra_dir = File::Spec-&gt;catdir&#40;$tdir,&#39;extra&#39;&#41;;
             mkdir&#40;$extra_dir, 0000&#41; || return &#34;could not create scratch directory $extra_dir: $!&#34;;
             my $final_dir = File::Spec-&gt;catdir&#40;$extra_dir,&#39;subdir&#39;&#41;;
             my $db = tie %hash, &#39;Tie::DB_File::SplitHash&#39;, $final_dir, $flags, $mode, $DB_HASH, $multi_n;
@@ -108,17 +116,25 @@ sub test_permissions {
             diag&#40;&#34;did not detect failure to tie database due to directory permissions&#34;&#41;;
             return 0;
         }
+        chmod 0700, $extra_dir;
+        File::Path::rmtree&#40;$tdir, 0, 1&#41;;
+        &#40;! -d $tdir&#41; or warn &#34;Directory $tdir not removed&#34;;
     }
 
     {
-        my $filename = tempdir&#40; DIR =&gt; test_directory&#40;&#41;, CLEANUP =&gt; 1 &#41;;
+        my $tdir = File::Spec-&gt;catdir&#40;
+            File::Spec-&gt;tmpdir&#40;&#41;,
+            $$ . sprintf&#40;&#34;%02s&#34; =&gt; ++$seed&#41;,
+        &#41;;
+        mkdir&#40;$tdir, 0700&#41; || return &#34;could not create tmpdir $tdir&#34;;
         my $multi_n = 4;
         my $flags   = &#38;O_RDWR&#40;&#41; | &#38;O_CREAT&#40;&#41;;
         my $mode    = 0666;
         my %hash;
     
+        my $extra_dir;
         my $result = eval {
-            my $extra_dir = File::Spec-&gt;catdir&#40;$filename,&#39;extra&#39;&#41;;
+            $extra_dir = File::Spec-&gt;catdir&#40;$tdir,&#39;extra&#39;&#41;;
             unless &#40;mkdir&#40;$extra_dir, 0000&#41;&#41; {
                 diag&#40;&#34;failed to make test directory $extra_dir&#34;&#41;;
                 die;
@@ -133,10 +149,13 @@ sub test_permissions {
             diag&#40;&#34;did not detect failure to tie database in forbidden directory&#34;&#41;;
             return 0;
         }
+        chmod 0700, $extra_dir;
+        File::Path::rmtree&#40;$tdir, 0, 1&#41;;
+        &#40;! -d $tdir&#41; or warn &#34;Directory $tdir not removed&#34;;
     }
 
     {
-        my $filename = tempdir&#40; DIR =&gt; test_directory&#40;&#41;, CLEANUP =&gt; 1 &#41;;
+        my $filename = tempdir&#40; CLEANUP =&gt; 1 &#41;;
         my $multi_n = 4;
         my $flags   = &#38;O_RDWR&#40;&#41; | &#38;O_CREAT&#40;&#41;;
         my $mode    = 0666;
@@ -153,7 +172,7 @@ sub test_permissions {
     }
 
     {
-        my $filename = tempdir&#40; DIR =&gt; test_directory&#40;&#41;, CLEANUP =&gt; 1 &#41;;
+        my $filename = tempdir&#40; CLEANUP =&gt; 1 &#41;;
         my $multi_n = 4;
         my $flags   = &#38;O_RDWR&#40;&#41; | &#38;O_CREAT&#40;&#41;;
         my $mode    = 0666;
-- 
2.7.4

</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
