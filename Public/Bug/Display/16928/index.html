<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #16928 for SQL-Statement: Fetchrow_hashref doesn&#39;t work when you are selecting multiple agregates on the same value.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #16928 for SQL-Statement: Fetchrow_hashref doesn&#39;t work when you are selecting multiple agregates on the same value.</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/SQL-Statement/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/SQL-Statement/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/SQL-Statement/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/SQL-Statement/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/SQL-Statement">SQL-Statement CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">16928</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/SQL-Statement/Active/">SQL-Statement</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Dan [...] DWright.Org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-29588-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.14    </td>
  </tr>
  <tr id="CF-29589-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;05&nbsp;15:19:24&nbsp;2006</span>
    <span class="description">Dan [...] DWright.Org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Fetchrow_hashref doesn&#39;t work when you are selecting multiple
 agregates on the same value.</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached is an updated 06build.t file for SQL::Statement,  it demonstrates a problem with using fetchrow_hashref to get values from a query that uses aggregate functions.

It turns out that if you select multiple aggregates from one value, for example:

   max&#40;foo&#41; as m, avg&#40;foo&#41; as a, sum&#40;foo&#41; as s

... and then attempt to get the results using fetchrow hashref, only the last value will exist in the hash.  Additionally, the key for the value in the hash will be whatever the first value should have been.   For the example above, we would get

  { &#39;m&#39;  =&gt;  &#40;the sum of &#39;foo&#39;&#41;  }
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w
$|=1;
use strict;
use Test::More;
use lib  qw&#40; ../lib &#41;;
use vars qw&#40;$DEBUG&#41;;
eval { require DBI; require DBD::File; };
if &#40;$@&#41; {
        plan skip_all =&gt; &#34;No DBI or DBD::File available&#34;;
}
else {
    plan tests =&gt; 7;
}
use SQL::Statement; printf &#34;SQL::Statement v.%s\n&#34;, $SQL::Statement::VERSION;
my $dbh=DBI-&gt;connect&#40;&#39;dbi:File&#40;RaiseError=1&#41;:&#39;&#41;;
$dbh-&gt;do&#40;$_&#41; for &lt;DATA&gt;;

my $sth=$dbh-&gt;prepare&#40;&#34;
    SELECT SUM&#40;sales&#41;, MAX&#40;sales&#41; FROM biz
&#34;&#41;;
ok&#40;&#39;2700~1000^&#39; eq query2str&#40;$sth&#41;,&#39;AGGREGATE FUNCTIONS WITHOUT GROUP BY&#39;&#41;;

$sth=$dbh-&gt;prepare&#40;&#34;
    SELECT region,SUM&#40;sales&#41;, MAX&#40;sales&#41; FROM biz GROUP BY region
&#34;&#41;;
ok&#40;&#39;West~2000~1000^East~700~700^&#39; eq query2str&#40;$sth&#41;,&#39;GROUP BY one column&#39;&#41;;

$sth=$dbh-&gt;prepare&#40;&#34;
    SELECT region,store,SUM&#40;sales&#41;, MAX&#40;sales&#41; FROM biz GROUP BY region,store
&#34;&#41;;
ok&#40;&#39;West~Los Angeles~1500~1000^West~San Diego~500~500^East~Boston~700~700^&#39;
 eq query2str&#40;$sth&#41;,&#39;GROUP BY several columns&#39;&#41;;

$sth=$dbh-&gt;prepare&#40;&#34;
    SELECT region,store,SUM&#40;sales&#41; as s, MAX&#40;sales&#41; as m FROM biz GROUP BY region,store
&#34;&#41;;
$sth-&gt;execute;
my $data = $sth-&gt;fetchrow_hashref&#40;&#41;;
use Data::Dumper;
diag Dumper&#40;$data&#41;;
is&#40; $data-&gt;{region}, &#39;West&#39; &#41;;
is&#40; $data-&gt;{store}, &#39;Los Angeles&#39; &#41;;
is&#40; $data-&gt;{s}, 1500 &#41;;
is&#40; $data-&gt;{m}, 1000 &#41;;

sub query2str {
    my&#40;$sth&#41;=@_;
    $sth-&gt;execute;
    my $str=&#39;&#39;;
    while &#40;my $r=$sth-&gt;fetch&#41; {
        $str .= sprintf &#34;%s^&#34;,join&#40;&#39;~&#39;,map { defined $_ ? $_ : &#39;undef&#39; } @$r&#41;;
    }
    return $str unless $DEBUG;
    printf &#34;%s\n&#34;,join&#39;,&#39;,@{$sth-&gt;{NAME}};
    print &#34;&lt;$str&gt;\n&#34;;
    return $str;
}
__END__
CREATE TEMP TABLE biz &#40;region TEXT, store TEXT, sales INTEGER&#41;
INSERT INTO biz VALUES &#40;&#39;West&#39;,&#39;Los Angeles&#39;,1000 &#41;
INSERT INTO biz VALUES &#40;&#39;West&#39;,&#39;San Diego&#39;  ,500  &#41;
INSERT INTO biz VALUES &#40;&#39;West&#39;,&#39;Los Angeles&#39;,500  &#41;
INSERT INTO biz VALUES &#40;&#39;East&#39;,&#39;Boston&#39;     ,700  &#41;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;05&nbsp;19:46:23&nbsp;2006</span>
    <span class="description">Dan [...] DWright.Org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I believe the problem is that hashes are being used to store information
about the column aliases and column objects.  The problem with this is
that hashes must have unique keys, however, none of the metadata about
the columns are necessarily unique.   That is to say, it is perfectly
valid to select the same column twice:

  SELECT a, a from foo;

Or, to select multiple columns using the same alias:

  SELECT a as bar, b as bar from foo;

Or, to perform multiple set functions on the same colum:

  SELECT sum&#40;a&#41; as s, min&#40;a&#41; as mn, max&#40;a&#41; as mx, avg&#40;a&#41; as avg from foo;

I believe the solution is to stop saying &#34;bar is an alias for a&#34;, and
start saying &#34;bar is an alias for column 0&#34;.   In other words, either
start keying the hashes with the numeric id for their column, or start
storing aliases in an array.   My suggestion is to put them in an array,
since this would make it easier for expanding table.* columns later on.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;04&nbsp;14:48:21&nbsp;2009</span>
    <span class="description">REHSACK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is impressive but seems to me more a bug of DBD::File than of
SQL::Statement. Without featuring multiple selects in one statement, 2
functions shouldn&#39;t be computed correctly &#40;which would be a bug&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;04&nbsp;14:48:21&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;04&nbsp;14:48:22&nbsp;2009</span>
    <span class="description">REHSACK [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
