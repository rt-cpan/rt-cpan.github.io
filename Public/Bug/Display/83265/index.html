<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #83265 for CGI: url&#40;&#41; incorrectly detects beginning of query string by decoding request_uri</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #83265 for CGI: url&#40;&#41; incorrectly detects beginning of query string by decoding request_uri</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/CGI/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/CGI/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/CGI/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/CGI/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/leejo/CGI.pm/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/CGI">CGI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">83265</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/CGI/Active/">CGI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">MARKSTOS [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
rrt [...] sc3d.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-230860-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
3.63    </td>
  </tr>
  <tr id="CF-230861-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;11&nbsp;10:29:41&nbsp;2013</span>
    <span class="description">rrt [...] sc3d.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> url&#40;&#41; incorrectly unescapes request_uri</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">My CGI script gets a request such as:

GET /~rrt/Software/DarkGlass/Why%20DarkGlass%3F HTTP/1.1

Note the &#34;%3F&#34; at the end of the URL: it&#39;s an escaped question mark.

My script then asks for the URL using &#34;url&#40;&#41;&#34;, and gets:

&#34;Software/DarkGlass/Why DarkGlass&#34;

The question mark has been stripped off, because after unescaping in the
line:

    my $request_uri =  unescape&#40;$self-&gt;request_uri&#41; || &#39;&#39;;

the code then strips the query off:

    my $uri         =  $rewrite &#38;&#38; $request_uri ? $request_uri :
$script_name;
    $uri            =~ s/\?.*$//s;                                #
remove query string

But this is wrong: if a query string is passed, it uses an unescaped
question mark. The &#34;unescape&#34; routine is itself undocumented, being part
of CGI::Util which is for internal use only. I&#39;m not an expert, so I
don&#39;t know if some unescaping should be being done, but it seems that at
the very least, question marks should not be unescaped at that point.
However, since the question mark denoting a query string should be a
literal question mark character in the original request URI, it seems to
be that it should be safe to remove the query string before unescaping
the URI.

The code in question has not been changed since the start of CGI.pm&#39;s
git history, so I can&#39;t find any relevant commit logs.

If I&#39;m correct, I&#39;m still not exactly sure what a minimum patch would
be, as while the obvious thing to do would be to move the call of
unescape to after the stripping of the query string, that would mean
applying unescape to the value of $script_name in some circumstances,
which might be OK, or might not, I don&#39;t know. But I guess $script_name
shouldn&#39;t contain a query string, so in fact, stripping the query string
should only be needed in the case that $uri is set to $request_uri, so
it should be possible to rewrite the relevant lines from:

    my $request_uri =  unescape&#40;$self-&gt;request_uri&#41; || &#39;&#39;;
    my $query_str   =  $self-&gt;query_string;

    my $rewrite_in_use = $request_uri &#38;&#38; $request_uri !~ /^\Q$script_name/;

    my $uri         =  $rewrite &#38;&#38; $request_uri ? $request_uri :
$script_name;
    $uri            =~ s/\?.*$//s;                                #
remove query string

to:

    my $request_uri =  $self-&gt;request_uri || &#39;&#39;;
    my $query_str   =  $self-&gt;query_string;

    $request_uri            =~ s/\?.*$//s;                             #
remove query string
    $request_uri = unescape&#40;$request_uri&#41;;
    my $rewrite_in_use = $request_uri &#38;&#38; $request_uri !~ /^\Q$script_name/;

    my $uri         =  $rewrite &#38;&#38; $request_uri ? $request_uri:
$script_name;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;11&nbsp;10:42:12&nbsp;2013</span>
    <span class="description">mark [...] summersault.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #83265] url&#40;&#41; incorrectly unescapes request_uri</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 11 Feb 2013 10:41:47 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Stosberg &lt;mark [...] summersault.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; My CGI script gets a request such as:
&gt; 
&gt; GET /~rrt/Software/DarkGlass/Why%20DarkGlass%3F HTTP/1.1
&gt; 
&gt; Note the &#34;%3F&#34; at the end of the URL: it&#39;s an escaped question mark.
&gt; 
&gt; My script then asks for the URL using &#34;url&#40;&#41;&#34;, and gets:
&gt; 
&gt; &#34;Software/DarkGlass/Why DarkGlass&#34;
&gt; 
&gt; The question mark has been stripped off
</div>
In this article, I describe a number of Perl solutions for handling URI
escaping and unescaping:

<span class="clickylink"><a target="new" rel="nofollow" href="http://mark.stosberg.com/blog/2010/12/percent-encoding-uris-in-perl.html">http://mark.stosberg.com/blog/2010/12/percent-encoding-uris-in-perl.html</a></span>

Why not run your sample URI through a few of them and see how their fare
in handling encoded question marks?

I think that would help clarify the standard and common behaviors.

   Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;11&nbsp;10:42:14&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;11&nbsp;10:49:12&nbsp;2013</span>
    <span class="description">rrt [...] sc3d.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rrt [...] sc3d.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Feb 11 10:42:12 2013, mark@summersault.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; My CGI script gets a request such as:
&gt; &gt; 
&gt; &gt; GET /~rrt/Software/DarkGlass/Why%20DarkGlass%3F HTTP/1.1
&gt; &gt; 
&gt; &gt; Note the &#34;%3F&#34; at the end of the URL: it&#39;s an escaped question mark.
&gt; &gt; 
&gt; &gt; My script then asks for the URL using &#34;url&#40;&#41;&#34;, and gets:
&gt; &gt; 
&gt; &gt; &#34;Software/DarkGlass/Why DarkGlass&#34;
&gt; &gt; 
&gt; &gt; The question mark has been stripped off
</div>&gt; 
&gt; In this article, I describe a number of Perl solutions for handling URI
&gt; escaping and unescaping:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://mark.stosberg.com/blog/2010/12/percent-encoding-uris-in-perl.html">http://mark.stosberg.com/blog/2010/12/percent-encoding-uris-in-perl.html</a></span>
&gt; 
&gt; Why not run your sample URI through a few of them and see how their fare
&gt; in handling encoded question marks?
&gt; 
&gt; I think that would help clarify the standard and common behaviors.
</div>
Possibly I wasn&#39;t clear: I don&#39;t have a problem with the way unescape
works, it&#39;s just being applied too early.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;11&nbsp;14:34:17&nbsp;2013</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Please provide a new failing automated test for the test suite which 
showcases the problem. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;11&nbsp;14:45:17&nbsp;2013</span>
    <span class="description">rrt [...] sc3d.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rrt [...] sc3d.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Feb 11 14:34:17 2013, MARKSTOS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Please provide a new failing automated test for the test suite which 
&gt; showcases the problem. 
</div>
Before I do that, I&#39;d like to be confident I&#39;ve understood the problem,
since I&#39;m no expert at this stuff. As it happens, I think the problem
and the fix may be simpler than I previously thought: I don&#39;t think that
url&#40;&#41; should call unescape at all. The routine reads a URI from either
the $self-&gt;request_url or the $script_name; it then returns a URL. So,
what is it doing unescaping at all?

If you agree with my analysis, then the fix is simply to remove the call
to &#34;unescape&#34;, and a failing test should be easy to write.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;11&nbsp;15:45:08&nbsp;2013</span>
    <span class="description">mark [...] summersault.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #83265] url&#40;&#41; incorrectly unescapes request_uri</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 11 Feb 2013 15:44:41 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Stosberg &lt;mark [...] summersault.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Before I do that, I&#39;d like to be confident I&#39;ve understood the problem,
&gt; since I&#39;m no expert at this stuff. As it happens, I think the problem
&gt; and the fix may be simpler than I previously thought: I don&#39;t think that
&gt; url&#40;&#41; should call unescape at all. The routine reads a URI from either
&gt; the $self-&gt;request_url or the $script_name; it then returns a URL. So,
&gt; what is it doing unescaping at all?
</div>
The authority on the issue would be the relevant RFCs for the CGI and
HTTP protocols. I linked to the relevant resources through the article I
liked above.

My recollection at the moment is that that is correct for the request to
be URI-unescaped as it comes it. If it was wrong to apply unescaping
here, I think a few more people would have noticed in the 10+ years
CGI.pm has been in use. I think it&#39;s far more likely that there&#39;s an
edge case with handling encoded question marks in URIs.

The other way to increase your confidence is to apply the test you
develop against the other modules I reference in the article above. If
all other solutions but CGI.pm produce the same result, you can be
certain there&#39;s a bug in CGI.pm.

   Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;11&nbsp;16:25:03&nbsp;2013</span>
    <span class="description">rrt [...] sc3d.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rrt [...] sc3d.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Feb 11 15:45:08 2013, mark@summersault.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 
&gt; The authority on the issue would be the relevant RFCs for the CGI and
&gt; HTTP protocols. I linked to the relevant resources through the article I
&gt; liked above.
</div>
As far as I can tell, that article only links to RFCs that define URLs
and URIs, not the RFCs for CGI and HTTP. I looked at RFC3875, the
definition of CGI 1.1:

<span class="clickylink"><a target="new" rel="nofollow" href="http://www.ietf.org/rfc/rfc3875">http://www.ietf.org/rfc/rfc3875</a></span>

It says: In all cases, the string is first processed with regard to any
reserved characters present, and then the resulting data can be
URL-decoded by replacing &#34;%&#34; escape sequences by their character values.

This suggests that at least the first part of my interpretation is
correct, namely, the URL should not be unescaped until after the query
string has been removed.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If it was wrong to apply unescaping
&gt; here, I think a few more people would have noticed in the 10+ years
&gt; CGI.pm has been in use.
</div>
I&#39;m not so sure. First, the url&#40;&#41; function/method to which I refer is
not itself strictly covered by any spec: it&#39;s a consumer of the CGI
interface, it doesn&#39;t implement it. Therefore, what it does is largely
up to you. Secondly, I&#39;ve had a FIXME sitting in my code for some years
mentioning that &#39;+&#39; characters seem to be incorrectly unescaped, and
wondering whether it&#39;s a bug in CGI.pm, but I never got around to
investigating further until now.

However, the url&#40;&#41; method does claim to return a URL, and at present it
seems it doesn&#39;t really do this, as it really returns a URL-decoded
string. RFC 3986 &#40;pointed to by your artice&#41; says: &#34;When a URI is
dereferenced, the components and subcomponents significant to the
scheme-specific dereferencing process &#40;if any&#41; must be parsed and
separated before the percent-encoded octets within those components can
be safely decoded, as otherwise the data may be mistaken for component
delimiters.&#34;

That seems to say pretty much the same as the CGI RFC, i.e. CGI.pm
shouldn&#39;t unescape before taking the URL apart. It goes on to say:

&#34;The only exception is for percent-encoded octets corresponding to
characters in the unreserved set, which can be decoded at any time.&#34;

But the unescape function also decodes characters in the reserved set,
so it can&#39;t be used when it is.

Finally, supporting my assertion that the URL method should not
percent-decode at all, RFC3986 says:

&#34;Once produced, a URI is always in its percent-encoded form.&#34;

Since the url&#40;&#41; method/function returns a URL/URI, it shouldn&#39;t
percent-decode it. &#40;BTW, I agree with your assertion that it&#39;s best to
use the terms &#34;percent-decode&#34; and &#34;percent-encode&#34;, and I&#39;ll try to use
them and them alone in future!&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The other way to increase your confidence is to apply the test you
&gt; develop against the other modules I reference in the article above. If
&gt; all other solutions but CGI.pm produce the same result, you can be
&gt; certain there&#39;s a bug in CGI.pm.
</div>
I&#39;m sorry, I don&#39;t really understand this suggestion. As far as I can
tell, the &#34;other modules&#34; you refer to are escaping/unescaping modules.
I am suggesting that the URL should not be unescaped: i.e. I would not
call any of those modules. I don&#39;t see how not using a different module
from the one I&#39;m currently not using would change things.

Apologies if I&#39;m being dense here!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;11&nbsp;16:35:44&nbsp;2013</span>
    <span class="description">mark [...] summersault.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #83265] url&#40;&#41; incorrectly unescapes request_uri</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 11 Feb 2013 16:35:15 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-cgi [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mark Stosberg &lt;mark [...] summersault.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for your help, and the detailed follow-up research and 
references. I&#39;ll take look.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;15&nbsp;08:45:07&nbsp;2013</span>
    <span class="description">MARKSTOS [...] cpan.org -  Subject changed from &#39;url&#40;&#41; incorrectly unescapes request_uri&#39; to &#39;url&#40;&#41; incorrectly detects beginning of query string by decoding request_uri&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Take odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;15&nbsp;09:11:18&nbsp;2013</span>
    <span class="description">MARKSTOS [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;15&nbsp;10:00:30&nbsp;2013</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I looked into this further. 

I found that REQUEST_URI is not actually defined in the CGI 
specification. However, it was returned by Apache. I suppose the spec 
for the expected contents of it is &#34;whatever Apache provides&#34;.

Here&#39;s some actual responses from Apache 2.2 when given URLs:

Base case. Nothing interesting here:
-----------------------------------

  Browser URL: /file?a=b

 &#39;QUERY_STRING&#39; =&gt; &#39;a=b&#39;,
 &#39;SCRIPT_URL&#39; =&gt; &#39;/file&#39;,
 &#39;SCRIPT_URI&#39; =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://example.com/file&#39;">http://example.com/file&#39;</a></span>,
 &#39;REQUEST_URI&#39; =&gt; &#39;/file?a=b&#39;,

Including query string after unencoded &#39;?&#39;
-------------------------------------------
This case looked suspicious because of &#39;&#38;&#39; appended to the query string,
which led me to the third cas.

  Browser URL: /file%3F?a=b

  &#39;QUERY_STRING&#39; =&gt; &#39;&#38;a=b&#39;,
  &#39;SCRIPT_URL&#39; =&gt; &#39;/file?&#39;,
  &#39;SCRIPT_URI&#39; =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://example.com/file?&#39;">http://example.com/file?&#39;</a></span>,
  &#39;REQUEST_URI&#39; =&gt; &#39;/file%3F?a=b&#39;,

Query String elements after encoded and unencoded &#39;?&#39;
----------------------------------------------------
Whoa. Apache is behaving inconsistently here. According to
&#39;QUERY_STRING&#39;, the query string starts the encoded question mark,
but according to the SCRIPT_URL and SCRIPT_URI, it starts only
after the unencoded question mark.

   Browser URL: /file%3Fa=b?c=d
  
   &#39;QUERY_STRING&#39; =&gt; &#39;a=b&#38;c=d&#39;,
   &#39;SCRIPT_URL&#39; =&gt; &#39;/file?a=b&#39;,
   &#39;SCRIPT_URI&#39; =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.mark.net.adoptapet.com/file?a=b&#39;">http://www.mark.net.adoptapet.com/file?a=b&#39;</a></span>,
   &#39;REQUEST_URI&#39; =&gt; &#39;/file%3Fa=b?c=d&#39;,

I&#39;ll discuss this inconsistenncy with Apache developers.

    Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;15&nbsp;10:04:37&nbsp;2013</span>
    <span class="description">rrt [...] sc3d.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rrt [...] sc3d.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Feb 15 10:00:30 2013, MARKSTOS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I looked into this further. 
</div>
Thanks very much for looking into this. Good luck with the Apache devs!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;15&nbsp;12:34:31&nbsp;2013</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here&#39;s my post to the Apache developers list:

<span class="clickylink"><a target="new" rel="nofollow" href="https://mail-archives.apache.org/mod_mbox/httpd-">https://mail-archives.apache.org/mod_mbox/httpd-</a></span>
dev/201302.mbox/%3Ckflkpv%24qnr%241%40ger.gmane.org%3E
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;20&nbsp;14:29:01&nbsp;2013</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Feb 15 12:34:31 2013, MARKSTOS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Here&#39;s my post to the Apache developers list:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://mail-archives.apache.org/mod_mbox/httpd-">https://mail-archives.apache.org/mod_mbox/httpd-</a></span>
&gt; dev/201302.mbox/%3Ckflkpv%24qnr%241%40ger.gmane.org%3E
</div>
The Apache devs clarified that there was a bug with my RewriteRule. I should have added a [B] flag. 

However, CGI.pm has a related bug, in that it decodes the 
REQUEST_URI before looking for the query string, so it will return wrong results when url&#40;&#41; is called for a case like this, even when Rewrite is properly configured. 

It appears that was your original conclusion, and I see you&#39;ve provided a proposed patch for it. Could you prepare some automated tests for it as well, and see if fixing this breaks anything else in the test suite?

   Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;20&nbsp;18:53:18&nbsp;2013</span>
    <span class="description">rrt [...] sc3d.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #83265] url&#40;&#41; incorrectly detects beginning of query string by decoding request_uri</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 20 Aug 2013 23:52:51 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-CGI [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Reuben Thomas &lt;rrt [...] sc3d.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 20 August 2013 19:29, Mark Stosberg via RT &lt;bug-CGI@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The Apache devs clarified that there was a bug with my RewriteRule. I
&gt; should have added a [B] flag.
&gt;
&gt; However, CGI.pm has a related bug, in that it decodes the
&gt; REQUEST_URI before looking for the query string, so it will return wrong
&gt; results when url&#40;&#41; is called for a case like this, even when Rewrite is
&gt; properly configured.
&gt;
&gt; It appears that was your original conclusion, and I see you&#39;ve provided a
&gt; proposed patch for it. Could you prepare some automated tests for it as
&gt; well, and see if fixing this breaks anything else in the test suite?
&gt;
</div>
Thanks very much for following this up. Looking back at the bug history, I
see I proposed two patches: one which moved the call to &#34;unescape&#34;, and one
which removed the call altogether &#40;and it was the second one I ended up
considering correct&#41;. Could you please confirm which behaviour you think is
the right one, and why?

-- 
<span class="clickylink"><a target="new" rel="nofollow" href="http://rrt.sc3d.org">http://rrt.sc3d.org</a></span>
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;22&nbsp;08:17:39&nbsp;2014</span>
    <span class="description">LEEJO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This issue has been copied to: <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/leejo/CGI.pm/issues/112">https://github.com/leejo/CGI.pm/issues/112</a></span> please take all future correspondence there.
This ticket will remain open but please do not reply here.
This ticket will be closed when the github issue is dealt with.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;20&nbsp;11:08:34&nbsp;2014</span>
    <span class="description">LEEJO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">commit b4c99a9036d50c1894ae9e2920a387abd85f790f
Author: Lee Johnson &lt;lee@givengain.ch&gt;
Date:   Sat Sep 20 16:07:00 2014 +0100

    resolve #112 [rt.cpan.org #83265] - strip query string first

    before calling unescape otherwise we incorrectly remove any previously
    encoded ? chars in the URI

 Changes    | 3 +++
 lib/CGI.pm | 8 ++++----
 2 files changed, 7 insertions&#40;+&#41;, 4 deletions&#40;-&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;20&nbsp;11:08:35&nbsp;2014</span>
    <span class="description">LEEJO [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
