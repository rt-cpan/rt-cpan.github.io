<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #48562 for Net-LDAP-Class: Possible bug or just user error with contacts in groups</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #48562 for Net-LDAP-Class: Possible bug or just user error with contacts in groups</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-LDAP-Class/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-LDAP-Class/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-LDAP-Class/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-LDAP-Class/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-LDAP-Class">Net-LDAP-Class CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">48562</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-LDAP-Class/Active/">Net-LDAP-Class</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
PJNEWMAN [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-222882-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.18    </td>
  </tr>
  <tr id="CF-222883-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;09&nbsp;14:03:46&nbsp;2009</span>
    <span class="description">PJNEWMAN [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Possible bug or just user error with contacts in groups</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I don&#39;t know if this is user error on my part due to not understanding 
enough about AD or your classes, a bug/foible due to the potentially 
odd way we use AD or something else.

Anyway I&#39;m trying to recursively find all users in a group and any of 
its subgroups and I hit a few issues with it failing when calling 
fetch_secondary_users with a &#34;can&#39;t find user&#34; message, after a bit of 
checking of AD, this always seems to occur when there is a contact, as 
opposed to a proper user in the group, and its always the contact 
referred to in the error message.

Changing line 141 in Net/LDAP/Class/Group/AD.pm from
        if &#40;$user&#41; {
to
        if &#40;defined&#40;$user&#41;&#41; {

Has cured my issue, although doing a straight print of the $user or 
$user-&gt;sAMAccountName throws an error about it being undefined, which 
makes sense I think, they won&#39;t have an account name if they are only a 
contact rather than a full user.

If this is in fact operating as expected, can you suggest a way for me 
to list all secondary users and just catch these croaks and carry on.

On a related note, and this one is undoubtedly more due to me abusing 
your class and not knowing an easy way to distinguish a user from a 
group, but if I try and do a fetch_primary_users or &#40;by inclusion&#41; a 
users on a user instead of a group, it throws an error about &#34;Use of 
uninitialized value in concatenation &#40;.&#41; or string at 
Net/LDAP/Class/Group/AD.pm line 105, &lt;DATA&gt; line 408.&#34;. I was able to 
fix that by changing line 105-110 in Net/LDAP/Class/Group/AD.pm from
                my @users = $user_class-&gt;find&#40;
                                scope   =&gt; &#39;sub&#39;,
                                filter  =&gt; &#34;&#40;primaryGroupID=$pgt&#41;&#34;,
                                ldap    =&gt; $self-&gt;ldap,
                                base_dn =&gt; $self-&gt;base_dn,
                &#41;;
to the rather hacky
                my @users = undef;
                if &#40;defined&#40;$pgt&#41;&#41; {
                        my @users      = $user_class-&gt;find&#40;
                                        scope   =&gt; &#39;sub&#39;,
                                        filter  
=&gt; &#34;&#40;primaryGroupID=$pgt&#41;&#34;,
                                        ldap    =&gt; $self-&gt;ldap,
                                        base_dn =&gt; $self-&gt;base_dn,
                        &#41;;
                }

Although its just occurred to me that some testing of the existence of 
sAMAccountName or similar may help to differentiate users from groups 
and contacts.

Thanks,

PN
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;10&nbsp;23:01:34&nbsp;2009</span>
    <span class="description">peter [...] peknet.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #48562] Possible bug or just user error with contacts in groups</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 10 Aug 2009 22:01:12 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-LDAP-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Karman &lt;peter [...] peknet.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Peter Newman via RT wrote on 8/9/09 1:03 PM:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sun Aug 09 14:03:46 2009: Request 48562 was acted upon.
&gt; Transaction: Ticket created by PJNEWMAN
&gt;        Queue: Net-LDAP-Class
&gt;      Subject: Possible bug or just user error with contacts in groups
&gt;    Broken in: 0.18
&gt;     Severity: Normal
&gt;        Owner: Nobody
&gt;   Requestors: PJNEWMAN@cpan.org
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=48562">https://rt.cpan.org/Ticket/Display.html?id=48562</a></span> &gt;
&gt; 
&gt; 
&gt; Hi,
&gt; 
&gt; I don&#39;t know if this is user error on my part due to not understanding 
&gt; enough about AD or your classes, a bug/foible due to the potentially 
&gt; odd way we use AD or something else.
</div>
Looks like a combination of both. :&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Anyway I&#39;m trying to recursively find all users in a group and any of 
&gt; its subgroups and I hit a few issues with it failing when calling 
&gt; fetch_secondary_users with a &#34;can&#39;t find user&#34; message, after a bit of 
&gt; checking of AD, this always seems to occur when there is a contact, as 
&gt; opposed to a proper user in the group, and its always the contact 
&gt; referred to in the error message.
</div>
I don&#39;t use AD myself, or at least, when I have been an AD user it has been as a
non-admin, so I&#39;m unfamiliar with the &#34;contact&#34; category. However:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Changing line 141 in Net/LDAP/Class/Group/AD.pm from
&gt;         if &#40;$user&#41; {
&gt; to
&gt;         if &#40;defined&#40;$user&#41;&#41; {
&gt; 
</div>
seems like a reasonable change. I&#39;ve committed that to svn and it&#39;ll be in the
next &#40;0.19&#41; cpan release.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Has cured my issue, although doing a straight print of the $user or 
&gt; $user-&gt;sAMAccountName throws an error about it being undefined, which 
&gt; makes sense I think, they won&#39;t have an account name if they are only a 
&gt; contact rather than a full user.
&gt; 
&gt; If this is in fact operating as expected, can you suggest a way for me 
&gt; to list all secondary users and just catch these croaks and carry on.
</div>
have you tried the standard eval approach?

 eval {
    print $user;
 };
 if &#40;$@&#41; {
    # handle the error
 }


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; On a related note, and this one is undoubtedly more due to me abusing 
&gt; your class and not knowing an easy way to distinguish a user from a 
&gt; group, but if I try and do a fetch_primary_users or &#40;by inclusion&#41; a 
&gt; users on a user instead of a group, it throws an error about &#34;Use of 
&gt; uninitialized value in concatenation &#40;.&#41; or string at 
&gt; Net/LDAP/Class/Group/AD.pm line 105, &lt;DATA&gt; line 408.&#34;. I was able to 
&gt; fix that by changing line 105-110 in Net/LDAP/Class/Group/AD.pm from
&gt;               my @users = $user_class-&gt;find&#40;
&gt;                               scope   =&gt; &#39;sub&#39;,
&gt;                               filter  =&gt; &#34;&#40;primaryGroupID=$pgt&#41;&#34;,
&gt;                               ldap    =&gt; $self-&gt;ldap,
&gt;                               base_dn =&gt; $self-&gt;base_dn,
&gt;               &#41;;
&gt; to the rather hacky
&gt;               my @users = undef;
&gt;               if &#40;defined&#40;$pgt&#41;&#41; {
&gt;                       my @users      = $user_class-&gt;find&#40;
&gt;                                       scope   =&gt; &#39;sub&#39;,
&gt;                                       filter  
&gt; =&gt; &#34;&#40;primaryGroupID=$pgt&#41;&#34;,
&gt;                                       ldap    =&gt; $self-&gt;ldap,
&gt;                                       base_dn =&gt; $self-&gt;base_dn,
&gt;                       &#41;;
&gt;               }
&gt; 
&gt; Although its just occurred to me that some testing of the existence of 
&gt; sAMAccountName or similar may help to differentiate users from groups 
&gt; and contacts.
</div>
if &#40; ! $user-&gt;isa&#40;&#39;Net::LDAP::Class::User&#39;&#41; &#41; {
  die &#34;I thought it was a user, but it wasn&#39;t!&#34;;
}

Does that help?

I just convenience functions in the base Net::LDAP::Class like this:

 sub isa_user {
    return shift-&gt;isa&#40;&#39;Net::LDAP::Class::User&#39;&#41;;
 }

That&#39;ll be in 0.19 too.

I can&#39;t seem to upload 0.19 to pause at the moment; when I can, I&#39;ll close this
ticket.

Thanks for the report.

-- 
Peter Karman  .  <span class="clickylink"><a target="new" rel="nofollow" href="http://peknet.com/">http://peknet.com/</a></span>  .  peter@peknet.com
gpg key: 37D2 DAA6 3A13 D415 4295  3A69 448F E556 374A 34D9
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;10&nbsp;23:01:36&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;17&nbsp;21:47:11&nbsp;2009</span>
    <span class="description">karman [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">0.19 available on CPAN.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;17&nbsp;21:47:13&nbsp;2009</span>
    <span class="description">karman [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;18&nbsp;07:49:01&nbsp;2009</span>
    <span class="description">PJNEWMAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Aug 17 21:47:11 2009, KARMAN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 0.19 available on CPAN.
</div>
Thanks for that.

The contact&#39;s are just Outlook style contacts from what I can tell, we 
just use them to send email to external addresses by adding them into 
DLists. Hence they obviously don&#39;t have an account/login name.

I think I&#39;d tried eval, but because it was croaking I didn&#39;t ever get 
the array because it died before it could return it, but I may be 
misremembering that.

Thanks for the isa tip too, that looks very promising.

A few more minor issues that get thrown if you try and request a group 
that doesn&#39;t exist, obviously a slightly silly thing to be doing, but 
it would seem nice if it just returned undef or something rather than 
throwing errors.

Adding the following or an equivalent at line 105:
                $pgt = &#34;&#34; unless &#40;defined&#40;$pgt&#41;&#41;;

Making 133 onwards:

                for my $dn &#40;@members&#41; {
                        if &#40;defined&#40;$dn&#41;&#41; {
                                my &#40;$cn&#41; = &#40; $dn =~ m/^cn=&#40;[^,]+&#41;,/i &#41;;
                                $dn =~ s/\&#40;/\\&#40;/g;
                                $dn =~ s/\&#41;/\\&#41;/g;
                                my $user = $user_class-&gt;new&#40;
                                                distinguishedName =&gt; 
$dn,
                                                ldap              =&gt; 
$self-&gt;ldap,
                                                base_dn           =&gt; 
$self-&gt;base_dn,
                                &#41;-&gt;read;
                                if &#40;defined $user&#41; {  # see 
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=48562">https://rt.cpan.org/Ticket/Display.html?id=48562</a></span>
                                                push&#40; @users, $user &#41;;
                                }
                                else {
                                                croak &#34;can&#39;t find user 
$cn &#40;$dn&#41; via LDAP&#34;;
                                }
                        }
                }

More generally, I don&#39;t know if you&#39;re aware, but LDAP/Microsoft&#39;s 
implementation, places a limit on the number of items you can return, 
so your code currently fails to retrieve any members for large groups. 
I&#39;ve got some code working using Net::LDAP::Control::Paged, but I&#39;m not 
quite sure where in Net::LDAP::Class that would need to go to even 
start thinking about writing a patch. I&#39;m guessing its NLC::read, is 
that correct?

PN
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;18&nbsp;07:49:02&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;18&nbsp;09:25:59&nbsp;2009</span>
    <span class="description">peter [...] peknet.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #48562] Possible bug or just user error with contacts in groups</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 18 Aug 2009 08:25:14 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-LDAP-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Karman &lt;peter [...] peknet.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Peter Newman via RT wrote on 08/18/2009 06:49 AM:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-LDAP-Class
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=48562">https://rt.cpan.org/Ticket/Display.html?id=48562</a></span> &gt;
&gt; 
&gt; On Mon Aug 17 21:47:11 2009, KARMAN wrote:
<div class="message-stanza open">&gt;&gt; 0.19 available on CPAN.
</div>&gt; 
&gt; Thanks for that.
&gt; 
&gt; The contact&#39;s are just Outlook style contacts from what I can tell, we 
&gt; just use them to send email to external addresses by adding them into 
&gt; DLists. Hence they obviously don&#39;t have an account/login name.
&gt; 
&gt; I think I&#39;d tried eval, but because it was croaking I didn&#39;t ever get 
&gt; the array because it died before it could return it, but I may be 
&gt; misremembering that.
&gt; 
&gt; Thanks for the isa tip too, that looks very promising.
&gt; 
&gt; A few more minor issues that get thrown if you try and request a group 
&gt; that doesn&#39;t exist, obviously a slightly silly thing to be doing, but 
&gt; it would seem nice if it just returned undef or something rather than 
&gt; throwing errors.
</div>

hm. read&#40;&#41; should return undef if not found. The code below fetches 
users that LDAP says belong to a group, which seems to not apply to what 
you&#39;re describing?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Adding the following or an equivalent at line 105:
&gt;               $pgt = &#34;&#34; unless &#40;defined&#40;$pgt&#41;&#41;;
&gt; 
&gt; Making 133 onwards:
&gt; 
&gt;               for my $dn &#40;@members&#41; {
&gt;                       if &#40;defined&#40;$dn&#41;&#41; {
&gt;                               my &#40;$cn&#41; = &#40; $dn =~ m/^cn=&#40;[^,]+&#41;,/i &#41;;
&gt;                               $dn =~ s/\&#40;/\\&#40;/g;
&gt;                               $dn =~ s/\&#41;/\\&#41;/g;
&gt;                               my $user = $user_class-&gt;new&#40;
&gt;                                               distinguishedName =&gt; 
&gt; $dn,
&gt;                                               ldap              =&gt; 
&gt; $self-&gt;ldap,
&gt;                                               base_dn           =&gt; 
&gt; $self-&gt;base_dn,
&gt;                               &#41;-&gt;read;
&gt;                               if &#40;defined $user&#41; {  # see 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=48562">https://rt.cpan.org/Ticket/Display.html?id=48562</a></span>
&gt;                                               push&#40; @users, $user &#41;;
&gt;                               }
&gt;                               else {
&gt;                                               croak &#34;can&#39;t find user 
&gt; $cn &#40;$dn&#41; via LDAP&#34;;
&gt;                               }
&gt;                       }
&gt;               }
&gt; 
&gt; More generally, I don&#39;t know if you&#39;re aware, but LDAP/Microsoft&#39;s 
&gt; implementation, places a limit on the number of items you can return, 
&gt; so your code currently fails to retrieve any members for large groups. 
&gt; I&#39;ve got some code working using Net::LDAP::Control::Paged, but I&#39;m not 
&gt; quite sure where in Net::LDAP::Class that would need to go to even 
&gt; start thinking about writing a patch. I&#39;m guessing its NLC::read, is 
&gt; that correct?
&gt; 
</div>
Yes, the act_on_all&#40;&#41; method in the base NLC class uses the 
Control::Paged feature.

Perhaps NLC should be modified to use iterators instead of arrays for 
related objects. I use something similar for Rose::DB::Object. I&#39;d like 
to not break the existing functionality though. Maybe add new methods to 
explicity ask for users_iterator&#40;&#41; or groups_iterator&#40;&#41; if you are 
expecting large numbers?

What do you think of that idea?

-- 
Peter Karman  .  <span class="clickylink"><a target="new" rel="nofollow" href="http://peknet.com/">http://peknet.com/</a></span>  .  peter@peknet.com
gpg key: 37D2 DAA6 3A13 D415 4295  3A69 448F E556 374A 34D9
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;18&nbsp;11:45:20&nbsp;2009</span>
    <span class="description">PJNEWMAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Aug 18 06:25:59 2009, peter@peknet.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; hm. read&#40;&#41; should return undef if not found. The code below fetches 
&gt; users that LDAP says belong to a group, which seems to not apply to 
</div>what 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; you&#39;re describing?
</div>
Well that explains/resolves that. I was just doing a:
my $group = MyLDAPGroup-&gt;new&#40;cn =&gt; $CN, ldap =&gt; $ldap&#41;;

and not trying or testing a read, because it doesn&#39;t seem to need one 
to work, I assume because it reads anyway if its not been read. Hence 
that function was causing me issues, anyway I&#39;ve modified my code in 
respect to that and its behaving fine now.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Yes, the act_on_all&#40;&#41; method in the base NLC class uses the 
&gt; Control::Paged feature.
&gt; 
&gt; Perhaps NLC should be modified to use iterators instead of arrays for 
&gt; related objects. I use something similar for Rose::DB::Object. I&#39;d 
</div>like 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; to not break the existing functionality though. Maybe add new methods 
</div>to 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; explicity ask for users_iterator&#40;&#41; or groups_iterator&#40;&#41; if you are 
&gt; expecting large numbers?
&gt; 
&gt; What do you think of that idea?
&gt; 
</div>
I&#39;ve got Control::Paged working on the secondary users as part of 
NLC::Group::AD, and it doesn&#39;t break existing functionality, because if 
you query a group that&#39;s too big at the moment then you don&#39;t get any 
users back, so I&#39;ve currently got the following working on my system 
&#40;currently overriding the existing sub as part of my local class&#41;:

        sub fetch_secondary_users {
                        my $self = shift;

                        $self-&gt;read;    # make sure we have latest 
ldap_entry for member

                        my @members    = $self-&gt;member;
                        my $user_class = $self-&gt;user_class;
                        my @users;
                        
                if &#40;@members == 0&#41; {
                        my $page = Net::LDAP::Control::Paged-&gt;new&#40; size 
=&gt; 1000 &#41; or die $!;

                        @args = &#40; base     =&gt; $base,
                                filter =&gt; &#34;memberOf=&#34; . $self-
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;ldap_entry-&gt;{attrs}-&gt;{distinguishedname}[0],
</div>                                control  =&gt; [ $page ],
                                attrs  =&gt; &#34;member&#34;,
                        &#41;;

                        my $cookie;
                        while&#40;1&#41; {
                                # Perform search
                                my $mesg = $self-&gt;ldap-&gt;search&#40; @args &#41;;

                                foreach my $entry &#40; $mesg-&gt;entries &#41; {
                                        push&#40;@members, $entry-&gt;get_value
&#40; &#34;distinguishedname&#34; &#41;&#41;;
                                }

                                # Only continue on LDAP_SUCCESS
                                $mesg-&gt;code and last;

                                # Get cookie from paged control
                                my&#40;$resp&#41;  = $mesg-&gt;control&#40; 
LDAP_CONTROL_PAGED &#41; or last;
                                $cookie    = $resp-&gt;cookie or last;

                                # Set cookie in paged control
                                $page-&gt;cookie&#40;$cookie&#41;;
                        }

                        if &#40;$cookie&#41; {
                                $page-&gt;cookie&#40;$cookie&#41;;
                                $page-&gt;size&#40;0&#41;;
                                $self-&gt;ldap-&gt;search&#40; @args &#41;;
                        }
                        
                }
                
                for my $dn &#40;@members&#41; {
                                my &#40;$cn&#41; = &#40; $dn =~ m/^cn=&#40;[^,]+&#41;,/i &#41;;
                                $dn =~ s/\&#40;/\\&#40;/g;
                                $dn =~ s/\&#41;/\\&#41;/g;
                                my $user = $user_class-&gt;new&#40;
                                                distinguishedName =&gt; 
$dn,
                                                ldap              =&gt; 
$self-&gt;ldap,
                                                base_dn           =&gt; 
$self-&gt;base_dn,
                                &#41;-&gt;read;
                                if &#40;defined $user&#41; {  # see 
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=48562">https://rt.cpan.org/Ticket/Display.html?id=48562</a></span>
                                                push&#40; @users, $user &#41;;
                                }
                                else {
                                                croak &#34;can&#39;t find user 
$cn &#40;$dn&#41; via LDAP&#34;;
                                }
                }
                        
                return wantarray ? @users : \@users;
        }

It does seem rather slow though, 24 seconds for 1600 odd machines in 
one group, so I wouldn&#39;t be surprised if I&#39;m getting all the data on 
the first pass and then needlessly stuffing it into the array, to keep 
simple compatibility with your existing code. Then presumably your code 
pulls all the data down again for each user/machine to actually create 
the object. I was going to try and look into this, but I&#39;m sure you 
know it far better than me! :&#41; Basically can you pass a 
Net::LDAP::Entry into something and use that as the base of a user 
class?

If you do go down the integration route, it might be worth making the 
page size option a global variable when you initialise everything and 
pass in the LDAP variable.

Regarding my isa issues, this is likely to be user error, but I&#39;m 
currently doing the following to find out if an item being returned 
back from a request for &#34;users&#34; is a user or actually a subgroup:

$objclass = undef;
                                for &#40;$user-&gt;objectClass&#41; { $objclass-&gt;
{$_} = 1;}
                        if &#40;defined&#40;$objclass-&gt;{group}&#41;&#41; {
#I&#39;m a subgroup
} else {
#I&#39;m a user or similar
}

Is there a better way to do this, I&#39;m guessing so, but I&#39;m not sure 
what it is.

Thanks again, apologies in advance for any granny/egg sucking moments 
and hope a few of my comments/lines of code are of use.

PN
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;18&nbsp;12:53:10&nbsp;2009</span>
    <span class="description">PJNEWMAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Another little one, perhaps its bad Perl on my part, but I&#39;ve changed 
the croak in NLC::Group::AD::fetch_secondary_users to a carp, from what 
I can see you can still catch that with some methods if you want, but 
we&#39;ve somehow ended up with someone&#39;s name as &#34;\,re&#34; in AD, whcih 
unsurprisingly causes issues, &#34;can&#39;t find user \&#34;, presumably because 
of some escaping and its all getting a bit confusing, anyway that&#39;s all 
fair enough, but I&#39;d still quite like, and it seems quite sensible to 
return, the rest of the users in the group and a warning, rather than 
just dieing.

Obviously this can be overwritten in my subclass, and is indeed what 
I&#39;m doing for the moment, but it seems like it might be a worthwhile 
change in general.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;18&nbsp;22:15:40&nbsp;2009</span>
    <span class="description">peter [...] peknet.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #48562] Possible bug or just user error with contacts in groups</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 18 Aug 2009 21:14:49 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-LDAP-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Karman &lt;peter [...] peknet.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Peter Newman via RT wrote on 8/18/09 10:45 AM:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-LDAP-Class
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=48562">https://rt.cpan.org/Ticket/Display.html?id=48562</a></span> &gt;
&gt; 
&gt; On Tue Aug 18 06:25:59 2009, peter@peknet.com wrote:
<div class="message-stanza open">&gt;&gt; hm. read&#40;&#41; should return undef if not found. The code below fetches 
&gt;&gt; users that LDAP says belong to a group, which seems to not apply to 
</div>&gt; what 
<div class="message-stanza open">&gt;&gt; you&#39;re describing?
</div>&gt; 
&gt; Well that explains/resolves that. I was just doing a:
&gt; my $group = MyLDAPGroup-&gt;new&#40;cn =&gt; $CN, ldap =&gt; $ldap&#41;;
&gt; 
&gt; and not trying or testing a read, because it doesn&#39;t seem to need one 
&gt; to work, I assume because it reads anyway if its not been read. Hence 
&gt; that function was causing me issues, anyway I&#39;ve modified my code in 
&gt; respect to that and its behaving fine now.
&gt; 
<div class="message-stanza open">&gt;&gt; Yes, the act_on_all&#40;&#41; method in the base NLC class uses the 
&gt;&gt; Control::Paged feature.
&gt;&gt;
&gt;&gt; Perhaps NLC should be modified to use iterators instead of arrays for 
&gt;&gt; related objects. I use something similar for Rose::DB::Object. I&#39;d 
</div>&gt; like 
<div class="message-stanza open">&gt;&gt; to not break the existing functionality though. Maybe add new methods 
</div>&gt; to 
<div class="message-stanza open">&gt;&gt; explicity ask for users_iterator&#40;&#41; or groups_iterator&#40;&#41; if you are 
&gt;&gt; expecting large numbers?
&gt;&gt;
&gt;&gt; What do you think of that idea?
&gt;&gt;
</div>&gt; 
&gt; I&#39;ve got Control::Paged working on the secondary users as part of 
&gt; NLC::Group::AD, and it doesn&#39;t break existing functionality, because if 
&gt; you query a group that&#39;s too big at the moment then you don&#39;t get any 
&gt; users back, so I&#39;ve currently got the following working on my system 
&gt; &#40;currently overriding the existing sub as part of my local class&#41;:
&gt; 
&gt;       sub fetch_secondary_users {
&gt;                       my $self = shift;
&gt; 
&gt;                       $self-&gt;read;    # make sure we have latest 
&gt; ldap_entry for member
&gt; 
&gt;                       my @members    = $self-&gt;member;
&gt;                       my $user_class = $self-&gt;user_class;
&gt;                       my @users;
&gt;                       
&gt;               if &#40;@members == 0&#41; {
&gt;                       my $page = Net::LDAP::Control::Paged-&gt;new&#40; size 
&gt; =&gt; 1000 &#41; or die $!;
&gt; 
&gt;                       @args = &#40; base     =&gt; $base,
&gt;                               filter =&gt; &#34;memberOf=&#34; . $self-
<div class="message-stanza open">&gt;&gt; ldap_entry-&gt;{attrs}-&gt;{distinguishedname}[0],
</div>&gt;                               control  =&gt; [ $page ],
&gt;                               attrs  =&gt; &#34;member&#34;,
&gt;                       &#41;;
&gt; 
&gt;                       my $cookie;
&gt;                       while&#40;1&#41; {
&gt;                               # Perform search
&gt;                               my $mesg = $self-&gt;ldap-&gt;search&#40; @args &#41;;
&gt; 
&gt;                               foreach my $entry &#40; $mesg-&gt;entries &#41; {
&gt;                                       push&#40;@members, $entry-&gt;get_value
&gt; &#40; &#34;distinguishedname&#34; &#41;&#41;;
&gt;                               }
&gt; 
&gt;                               # Only continue on LDAP_SUCCESS
&gt;                               $mesg-&gt;code and last;
&gt; 
&gt;                               # Get cookie from paged control
&gt;                               my&#40;$resp&#41;  = $mesg-&gt;control&#40; 
&gt; LDAP_CONTROL_PAGED &#41; or last;
&gt;                               $cookie    = $resp-&gt;cookie or last;
&gt; 
&gt;                               # Set cookie in paged control
&gt;                               $page-&gt;cookie&#40;$cookie&#41;;
&gt;                       }
&gt; 
&gt;                       if &#40;$cookie&#41; {
&gt;                               $page-&gt;cookie&#40;$cookie&#41;;
&gt;                               $page-&gt;size&#40;0&#41;;
&gt;                               $self-&gt;ldap-&gt;search&#40; @args &#41;;
&gt;                       }
&gt;                       
&gt;               }
&gt;               
&gt;               for my $dn &#40;@members&#41; {
&gt;                               my &#40;$cn&#41; = &#40; $dn =~ m/^cn=&#40;[^,]+&#41;,/i &#41;;
&gt;                               $dn =~ s/\&#40;/\\&#40;/g;
&gt;                               $dn =~ s/\&#41;/\\&#41;/g;
&gt;                               my $user = $user_class-&gt;new&#40;
&gt;                                               distinguishedName =&gt; 
&gt; $dn,
&gt;                                               ldap              =&gt; 
&gt; $self-&gt;ldap,
&gt;                                               base_dn           =&gt; 
&gt; $self-&gt;base_dn,
&gt;                               &#41;-&gt;read;
&gt;                               if &#40;defined $user&#41; {  # see 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=48562">https://rt.cpan.org/Ticket/Display.html?id=48562</a></span>
&gt;                                               push&#40; @users, $user &#41;;
&gt;                               }
&gt;                               else {
&gt;                                               croak &#34;can&#39;t find user 
&gt; $cn &#40;$dn&#41; via LDAP&#34;;
&gt;                               }
&gt;               }
&gt;                       
&gt;               return wantarray ? @users : \@users;
&gt;       }
&gt; 
&gt; It does seem rather slow though, 24 seconds for 1600 odd machines in 
&gt; one group, so I wouldn&#39;t be surprised if I&#39;m getting all the data on 
&gt; the first pass and then needlessly stuffing it into the array, to keep 
&gt; simple compatibility with your existing code. Then presumably your code 
&gt; pulls all the data down again for each user/machine to actually create 
&gt; the object. I was going to try and look into this, but I&#39;m sure you 
&gt; know it far better than me! :&#41; 
</div>
well, if you&#39;ve got something working for you atm, that&#39;s far better than
anything I can drum up off the top of my head. :&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Basically can you pass a 
&gt; Net::LDAP::Entry into something and use that as the base of a user 
&gt; class?
</div>
well, you can, but not sure if you really want to:

 my $user = MyClass-&gt;new&#40; ldap =&gt; $ldap, ldap_entry =&gt; $entry &#41;;

that saves a subsequent read&#40;&#41; call. That&#39;s in fact what act_on_all&#40;&#41; does. Have
a look at that code.

The idea of an iterator is that you could do:

 my $groups = $user-&gt;groups_iterator&#40;{ size =&gt; 1000 }&#41;;
 while &#40;my $group = $groups-&gt;next&#41; {
   # do something with $group
 }

and it is far more efficient for large datasets that stuffing them all in an
array at once.

I&#39;ve put that on my &#40;ever-growing&#41; todo list.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; If you do go down the integration route, it might be worth making the 
&gt; page size option a global variable when you initialise everything and 
&gt; pass in the LDAP variable.
</div>
probably not a global var, but like act_on_all&#40;&#41;, a method param with a sane
default.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Regarding my isa issues, this is likely to be user error, but I&#39;m 
&gt; currently doing the following to find out if an item being returned 
&gt; back from a request for &#34;users&#34; is a user or actually a subgroup:
&gt; 
&gt; $objclass = undef;
&gt;                               for &#40;$user-&gt;objectClass&#41; { $objclass-&gt;
&gt; {$_} = 1;}
&gt;                       if &#40;defined&#40;$objclass-&gt;{group}&#41;&#41; {
&gt; #I&#39;m a subgroup
&gt; } else {
&gt; #I&#39;m a user or similar
&gt; }
&gt; 
&gt; Is there a better way to do this, I&#39;m guessing so, but I&#39;m not sure 
&gt; what it is.
</div>
your code got a little mangled in the mail, but if you can trust your
objectClass metadata, it seems ok to me.


-- 
Peter Karman  .  <span class="clickylink"><a target="new" rel="nofollow" href="http://peknet.com/">http://peknet.com/</a></span>  .  peter@peknet.com
gpg key: 37D2 DAA6 3A13 D415 4295  3A69 448F E556 374A 34D9
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;18&nbsp;22:18:02&nbsp;2009</span>
    <span class="description">peter [...] peknet.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #48562] Possible bug or just user error with contacts in groups</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 18 Aug 2009 21:17:44 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-LDAP-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Karman &lt;peter [...] peknet.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Peter Newman via RT wrote on 8/18/09 11:53 AM:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-LDAP-Class
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=48562">https://rt.cpan.org/Ticket/Display.html?id=48562</a></span> &gt;
&gt; 
&gt; Another little one, perhaps its bad Perl on my part, but I&#39;ve changed 
&gt; the croak in NLC::Group::AD::fetch_secondary_users to a carp, from what 
&gt; I can see you can still catch that with some methods if you want, but 
&gt; we&#39;ve somehow ended up with someone&#39;s name as &#34;\,re&#34; in AD, whcih 
&gt; unsurprisingly causes issues, &#34;can&#39;t find user \&#34;, presumably because 
&gt; of some escaping and its all getting a bit confusing, anyway that&#39;s all 
&gt; fair enough, but I&#39;d still quite like, and it seems quite sensible to 
&gt; return, the rest of the users in the group and a warning, rather than 
&gt; just dieing.
&gt; 
&gt; Obviously this can be overwritten in my subclass, and is indeed what 
&gt; I&#39;m doing for the moment, but it seems like it might be a worthwhile 
&gt; change in general.
</div>
My credo for exception handling comes from something Marvin Humphrey said to me
once: &#34;catastrophic failure is a good thing.&#34;

Or, die early and often.

I view carp&#40;&#41; as a very good debugging tool, but for production code I croak if
something is amiss.  A warning to stderr can very easily turn into noise that
just gets ignored and that can hide something very wrong, either in the code or
&#40;in this case&#41; in the LDAP system itself.

If you don&#39;t want death, use eval&#40;&#41;. That&#39;s what it&#39;s there for. It&#39;s the perl
version of try/catch, which is a very useful idiom.

-- 
Peter Karman  .  <span class="clickylink"><a target="new" rel="nofollow" href="http://peknet.com/">http://peknet.com/</a></span>  .  peter@peknet.com
gpg key: 37D2 DAA6 3A13 D415 4295  3A69 448F E556 374A 34D9
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;22&nbsp;10:19:35&nbsp;2009</span>
    <span class="description">PJNEWMAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Aug 18 22:15:40 2009, peter@peknet.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; well, if you&#39;ve got something working for you atm, that&#39;s far better
&gt; than
&gt; anything I can drum up off the top of my head. :&#41;
</div>
In which case feel free to include it, and indeed I&#39;d probably almost
urge it. My reasoning being, if you currently search for a big group,
the class tells you that it has no members, which is actually incorrect.
Adding my code means you do get the correct results every time, albeit
it takes a while longer if the group needs paging.

I can see the benefits of iterators, although in my case I&#39;m generally
just doing dirty data processing, so the speed or memory implications of
loading it into an array first aren&#39;t too much of an issue. But as I
mentioned above, I&#39;d feel getting accurate results out first is a more
important bug fix than the enhancement of iterators.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Basically can you pass a
&gt; &gt; Net::LDAP::Entry into something and use that as the base of a user
&gt; &gt; class?
</div>&gt; 
&gt; well, you can, but not sure if you really want to:
&gt; 
&gt;  my $user = MyClass-&gt;new&#40; ldap =&gt; $ldap, ldap_entry =&gt; $entry &#41;;
&gt; 
&gt; that saves a subsequent read&#40;&#41; call. That&#39;s in fact what act_on_all&#40;&#41;
&gt; does. Have
&gt; a look at that code.
</div>I&#39;m guessing that because it removes the subsequent read call it should
hopefully speed it up quite a bit. Currently for my group of 1600 items,
its requesting the group twice &#40;to get the full set&#41;, then all 1600
items twice, which obviously isn&#39;t too efficient. Anyway I&#39;ll try and
give it a go and see if it makes a noticeable speedup, although given
the variable time my script seems to normally take, it may be hard to tell.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; probably not a global var, but like act_on_all&#40;&#41;, a method param with
&gt; a sane
&gt; default.
</div>
Fair point, I guess you could pass it into users or fetch_secondary_members.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; your code got a little mangled in the mail, but if you can trust your
&gt; objectClass metadata, it seems ok to me.
&gt; 
</div>It seems to be okay so far. Presumably its this data, or is it something
else, but AD somehow knows whether to give something the icon for a
group, contact, computer or user etc.

On Tue Aug 18 22:18:02 2009, peter@peknet.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I view carp&#40;&#41; as a very good debugging tool, but for production code I
&gt; croak if
&gt; something is amiss.  A warning to stderr can very easily turn into
&gt; noise that
&gt; just gets ignored and that can hide something very wrong, either in
&gt; the code or
&gt; &#40;in this case&#41; in the LDAP system itself.
&gt; 
&gt; If you don&#39;t want death, use eval&#40;&#41;. That&#39;s what it&#39;s there for. It&#39;s
&gt; the perl
&gt; version of try/catch, which is a very useful idiom.
&gt; 
</div>
My issue/concern is I&#39;m looking at using this in combination with NTLM
authentication, to grab a list of users in a group who will be
authorised, therefore I&#39;d agree that the error in LDAP is probably not a
good thing, but returning no results at all is even more awkward.

Because the croak is within the for loop, unless I&#39;m mistaken, the eval
would indeed catch the error, but I&#39;m still lacking an array of the
other users then, whereas if it carped I could catch it and either
choose to die or just carry on and print a message. I can&#39;t see a way
with the current code to catch this error and still get a list of all
the users in a group.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;22&nbsp;11:50:01&nbsp;2009</span>
    <span class="description">PJNEWMAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Aug 22 10:19:35 2009, PJNEWMAN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m guessing that because it removes the subsequent read call it should
&gt; hopefully speed it up quite a bit. Currently for my group of 1600 items,
&gt; its requesting the group twice &#40;to get the full set&#41;, then all 1600
&gt; items twice, which obviously isn&#39;t too efficient. Anyway I&#39;ll try and
&gt; give it a go and see if it makes a noticeable speedup, although given
&gt; the variable time my script seems to normally take, it may be hard to
</div>tell.

Okay, I&#39;ve just switched to loading the existing returned entry and it
seems to have speeded things up quite nicely, from 1m20-30s down to
20-40s passing the existing LDAP entry in, which I guess makes sense if
its having to do a unique query for each member, compared to the more
efficient results that are presumably returned when you do a search. New
code follows:

        sub fetch_secondary_users {
                my $self = shift;

                $self-&gt;read;    # make sure we have latest ldap_entry for member

                my @members    = $self-&gt;member;
                my $user_class = $self-&gt;user_class;
                my @users;
                
                if &#40;@members &gt; 0&#41; {
                        
                        for my $dn &#40;@members&#41; {
                                        my &#40;$cn&#41; = &#40; $dn =~ m/^cn=&#40;[^,]+&#41;,/i &#41;;
                                        $dn =~ s/\&#40;/\\&#40;/g;
                                        $dn =~ s/\&#41;/\\&#41;/g;
                                        my $user = $user_class-&gt;new&#40;
                                                        distinguishedName =&gt; $dn,
                                                        ldap              =&gt; $self-&gt;ldap,
                                                        base_dn           =&gt; $self-&gt;base_dn,
                                        &#41;-&gt;read;
                                        if &#40;defined $user&#41; {  # see
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=48562">https://rt.cpan.org/Ticket/Display.html?id=48562</a></span>
                                                        push&#40; @users, $user &#41;;
                                        }
                                        else {
                                                        carp &#34;can&#39;t find user $cn &#40;$dn&#41; via LDAP&#34;;
                                        }
                        }
                } else {
                        my $page = Net::LDAP::Control::Paged-&gt;new&#40; size =&gt; 1000 &#41; or die $!;

                        @args = &#40; base     =&gt; $base,
                                filter =&gt; &#34;memberOf=&#34; .
$self-&gt;ldap_entry-&gt;{attrs}-&gt;{distinguishedname}[0],
                                control  =&gt; [ $page ],
                                attrs  =&gt; &#34;member&#34;,
                        &#41;;

                        my $cookie;
                        while&#40;1&#41; {
                                # Perform search
                                my $mesg = $self-&gt;ldap-&gt;search&#40; @args &#41;;

                                foreach my $entry &#40; $mesg-&gt;entries &#41; {
                                        my $user = $user_class-&gt;new&#40; ldap =&gt; $self-&gt;ldap, ldap_entry =&gt;
$entry &#41;;
                                        if &#40;defined $user&#41; {  # see
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=48562">https://rt.cpan.org/Ticket/Display.html?id=48562</a></span>
                                                        push&#40; @users, $user &#41;;
                                        }
                                }

                                # Only continue on LDAP_SUCCESS
                                $mesg-&gt;code and last;

                                # Get cookie from paged control
                                my&#40;$resp&#41;  = $mesg-&gt;control&#40; LDAP_CONTROL_PAGED &#41; or last;
                                $cookie    = $resp-&gt;cookie or last;

                                # Set cookie in paged control
                                $page-&gt;cookie&#40;$cookie&#41;;
                        }

                        if &#40;$cookie&#41; {
                                $page-&gt;cookie&#40;$cookie&#41;;
                                $page-&gt;size&#40;0&#41;;
                                $self-&gt;ldap-&gt;search&#40; @args &#41;;
                        }
                }
                
                return wantarray ? @users : \@users;
        }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;23&nbsp;02:03:35&nbsp;2009</span>
    <span class="description">peter [...] peknet.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #48562] Possible bug or just user error with contacts in groups</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 23 Aug 2009 01:03:17 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-LDAP-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Karman &lt;peter [...] peknet.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Peter Newman via RT wrote on 8/22/09 9:19 AM:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-LDAP-Class
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=48562">https://rt.cpan.org/Ticket/Display.html?id=48562</a></span> &gt;
&gt; 
&gt; On Tue Aug 18 22:15:40 2009, peter@peknet.com wrote:
<div class="message-stanza open">&gt;&gt; well, if you&#39;ve got something working for you atm, that&#39;s far better
&gt;&gt; than
&gt;&gt; anything I can drum up off the top of my head. :&#41;
</div>&gt; 
&gt; In which case feel free to include it, and indeed I&#39;d probably almost
&gt; urge it. My reasoning being, if you currently search for a big group,
&gt; the class tells you that it has no members, which is actually incorrect.
&gt; Adding my code means you do get the correct results every time, albeit
&gt; it takes a while longer if the group needs paging.
&gt; 
&gt; I can see the benefits of iterators, although in my case I&#39;m generally
&gt; just doing dirty data processing, so the speed or memory implications of
&gt; loading it into an array first aren&#39;t too much of an issue. But as I
&gt; mentioned above, I&#39;d feel getting accurate results out first is a more
&gt; important bug fix than the enhancement of iterators.
</div>

The Iterator technique is going to be a better overall solution because it uses
the cleaner filter query &#40;checking for memberOf rather than trying to parse out
the dn&#41;.

I have checked a first pass at this feature into svn here:

 <span class="clickylink"><a target="new" rel="nofollow" href="https://svn.msi.umn.edu/sw/perl/Net-LDAP-Class/trunk">https://svn.msi.umn.edu/sw/perl/Net-LDAP-Class/trunk</a></span>

It implements some of your code in a more generalized way, offering
users_iterator&#40;&#41;, primary_users_iterator&#40;&#41; and secondary_users_iterator&#40;&#41;
methods on AD::Group. I still need to add similar methods for POSIX::Group and
both User classes. But you&#39;ll be able to see the technique at work right now for
your case.

Please check it out and see if it works for you. It should be pretty fast, since
it injects the ldap_entry directly just as your latest optimization does.

If you try and run the tests on the svn trunk, you&#39;ll need the latest version of
the Net::LDAP::Server::Test package, also at:

 <span class="clickylink"><a target="new" rel="nofollow" href="https://svn.msi.umn.edu/sw/perl/Net-LDAP-Server-Test/trunk">https://svn.msi.umn.edu/sw/perl/Net-LDAP-Server-Test/trunk</a></span>

which now has support for the Net::LDAP::Control::Paged feature.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; If you don&#39;t want death, use eval&#40;&#41;. That&#39;s what it&#39;s there for. It&#39;s
&gt;&gt; the perl
&gt;&gt; version of try/catch, which is a very useful idiom.
&gt;&gt;
</div>&gt; 
&gt; My issue/concern is I&#39;m looking at using this in combination with NTLM
&gt; authentication, to grab a list of users in a group who will be
&gt; authorised, therefore I&#39;d agree that the error in LDAP is probably not a
&gt; good thing, but returning no results at all is even more awkward.
&gt; 
&gt; Because the croak is within the for loop, unless I&#39;m mistaken, the eval
&gt; would indeed catch the error, but I&#39;m still lacking an array of the
&gt; other users then, whereas if it carped I could catch it and either
&gt; choose to die or just carry on and print a message. I can&#39;t see a way
&gt; with the current code to catch this error and still get a list of all
&gt; the users in a group.
</div>
I see your point here. The new Iterator technique avoids this issue altogether,
since it&#39;s not trying to reconcile possible differences between what $group
reports as its members and what LDAP reports for each of those members. The bug
really lies in the brittle-ness of trying to parse the $dn value with a regex.
The Iterator avoids that issue altogether since it uses a different attribute to
filter on.

-- 
Peter Karman  .  <span class="clickylink"><a target="new" rel="nofollow" href="http://peknet.com/">http://peknet.com/</a></span>  .  peter@peknet.com
gpg key: 37D2 DAA6 3A13 D415 4295  3A69 448F E556 374A 34D9
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;23&nbsp;13:42:36&nbsp;2009</span>
    <span class="description">PJNEWMAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Aug 23 02:03:35 2009, peter@peknet.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The Iterator technique is going to be a better overall solution
&gt; because it uses
&gt; the cleaner filter query &#40;checking for memberOf rather than trying to
&gt; parse out
&gt; the dn&#41;.
&gt; 
&gt; I have checked a first pass at this feature into svn here:
&gt; 
&gt;  <span class="clickylink"><a target="new" rel="nofollow" href="https://svn.msi.umn.edu/sw/perl/Net-LDAP-Class/trunk">https://svn.msi.umn.edu/sw/perl/Net-LDAP-Class/trunk</a></span>
&gt; 
&gt; It implements some of your code in a more generalized way, offering
&gt; users_iterator&#40;&#41;, primary_users_iterator&#40;&#41; and
&gt; secondary_users_iterator&#40;&#41;
&gt; methods on AD::Group. I still need to add similar methods for
&gt; POSIX::Group and
&gt; both User classes. But you&#39;ll be able to see the technique at work
&gt; right now for
&gt; your case.
&gt; 
&gt; Please check it out and see if it works for you. It should be pretty
&gt; fast, since
&gt; it injects the ldap_entry directly just as your latest optimization
&gt; does.
&gt; 
&gt; If you try and run the tests on the svn trunk, you&#39;ll need the latest
&gt; version of
&gt; the Net::LDAP::Server::Test package, also at:
&gt; 
&gt;  <span class="clickylink"><a target="new" rel="nofollow" href="https://svn.msi.umn.edu/sw/perl/Net-LDAP-Server-Test/trunk">https://svn.msi.umn.edu/sw/perl/Net-LDAP-Server-Test/trunk</a></span>
&gt; 
&gt; which now has support for the Net::LDAP::Control::Paged feature.
&gt; 
</div>Thanks for doing this. Unfortunately I can&#39;t get it to play ball, which 
I think I&#39;ve tracked down to line 121 in NLC::Iterator.

If I leave it as is &#34;if &#40; !$cookie &#41; {&#34; the iterator only ever returns 
undef, and hence no results, if I change it to &#34;if &#40;!defined&#40;$cookie&#41;&#41; 
{&#34; I get the results, but $self-&gt;{_exhausted} never seems to get set, 
so I just keep getting the results forever.

If it helps, I think I ran your new module through all the tests in the 
end, and I think it passed them all.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I see your point here. The new Iterator technique avoids this issue
&gt; altogether,
&gt; since it&#39;s not trying to reconcile possible differences between what
&gt; $group
&gt; reports as its members and what LDAP reports for each of those
&gt; members. The bug
&gt; really lies in the brittle-ness of trying to parse the $dn value with
&gt; a regex.
&gt; The Iterator avoids that issue altogether since it uses a different
&gt; attribute to
&gt; filter on.
&gt; 
</div>
The Iterator method sounds great in that respect, when its working.

Interestingly my new code &#40;that uses the returned LDAP entry from the 
search&#41; actually seemed to be slower when working on groups smaller 
than the 1000 limit, I haven&#39;t looked into it properly yet, but I 
wonder if its still unneccesarily processing it twice or something, or 
again it might just be the variability in our AD infrastructure.

Incidentally, its my understanding that the AD administrators can set 
the return limit, but I believe 1000 is the default/most common, rather 
than the 500 currently in your code. Although I guess that may be in 
there for performance reasons.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;24&nbsp;00:21:32&nbsp;2009</span>
    <span class="description">peter [...] peknet.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #48562] Possible bug or just user error with contacts in groups</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 23 Aug 2009 23:21:12 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-LDAP-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Karman &lt;peter [...] peknet.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Peter Newman via RT wrote on 8/23/09 12:42 PM:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks for doing this. Unfortunately I can&#39;t get it to play ball, which 
&gt; I think I&#39;ve tracked down to line 121 in NLC::Iterator.
&gt; 
&gt; If I leave it as is &#34;if &#40; !$cookie &#41; {&#34; the iterator only ever returns 
&gt; undef, and hence no results, if I change it to &#34;if &#40;!defined&#40;$cookie&#41;&#41; 
&gt; {&#34; I get the results, but $self-&gt;{_exhausted} never seems to get set, 
&gt; so I just keep getting the results forever.
&gt; 
</div>
Thanks for testing.

I&#39;ve refactored a bit to make the cookie handling a little cleaner internally.
You&#39;ll want to svn up on both NLC and NLST. See if the issue remains?

I added a DESTROY&#40;&#41; in the Iterator class to double check that is_exhausted&#40;&#41; is
true and call finish&#40;&#41; if it isn&#39;t. That check is raising the warning against my
AD server, though I&#39;m still not sure why the Iterator isn&#39;t returning all the
entries. Just an FYI in case you see that warning too.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If it helps, I think I ran your new module through all the tests in the 
&gt; end, and I think it passed them all.
&gt; 
</div>
that&#39;s good. thanks.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; I see your point here. The new Iterator technique avoids this issue
&gt;&gt; altogether,
&gt;&gt; since it&#39;s not trying to reconcile possible differences between what
&gt;&gt; $group
&gt;&gt; reports as its members and what LDAP reports for each of those
&gt;&gt; members. The bug
&gt;&gt; really lies in the brittle-ness of trying to parse the $dn value with
&gt;&gt; a regex.
&gt;&gt; The Iterator avoids that issue altogether since it uses a different
&gt;&gt; attribute to
&gt;&gt; filter on.
&gt;&gt;
</div>&gt; 
&gt; The Iterator method sounds great in that respect, when its working.
&gt; 
&gt; Interestingly my new code &#40;that uses the returned LDAP entry from the 
&gt; search&#41; actually seemed to be slower when working on groups smaller 
&gt; than the 1000 limit, I haven&#39;t looked into it properly yet, but I 
&gt; wonder if its still unneccesarily processing it twice or something, or 
&gt; again it might just be the variability in our AD infrastructure.
&gt; 
&gt; Incidentally, its my understanding that the AD administrators can set 
&gt; the return limit, but I believe 1000 is the default/most common, rather 
&gt; than the 500 currently in your code. Although I guess that may be in 
&gt; there for performance reasons.
</div>
I made it smaller than the default just for testing the feature. No reason it
couldn&#39;t be bumped up to 1000 I suppose.

-- 
Peter Karman  .  <span class="clickylink"><a target="new" rel="nofollow" href="http://peknet.com/">http://peknet.com/</a></span>  .  peter@peknet.com
gpg key: 37D2 DAA6 3A13 D415 4295  3A69 448F E556 374A 34D9
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;24&nbsp;00:59:18&nbsp;2009</span>
    <span class="description">peter [...] peknet.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #48562] Possible bug or just user error with contacts in groups</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 23 Aug 2009 23:59:01 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-LDAP-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Karman &lt;peter [...] peknet.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">peter@peknet.com via RT wrote on 8/23/09 11:21 PM:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I added a DESTROY&#40;&#41; in the Iterator class to double check that is_exhausted&#40;&#41; is
&gt; true and call finish&#40;&#41; if it isn&#39;t. That check is raising the warning against my
&gt; AD server, though I&#39;m still not sure why the Iterator isn&#39;t returning all the
&gt; entries. Just an FYI in case you see that warning too.
&gt; 
</div>
Fixed in r568:

<span class="clickylink"><a target="new" rel="nofollow" href="https://trac.msi.umn.edu/trac/sw/changeset/568">https://trac.msi.umn.edu/trac/sw/changeset/568</a></span>

-- 
Peter Karman  .  <span class="clickylink"><a target="new" rel="nofollow" href="http://peknet.com/">http://peknet.com/</a></span>  .  peter@peknet.com
gpg key: 37D2 DAA6 3A13 D415 4295  3A69 448F E556 374A 34D9
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;26&nbsp;15:41:21&nbsp;2009</span>
    <span class="description">PJNEWMAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Aug 24 00:21:32 2009, peter@peknet.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks for testing.
</div>That seems to be working fine now thanks, it actually returns more 
results than my code! Although I&#39;m not sure if that&#39;s a bug in my code 
or in the LDAP results parsing stuff you mentioned before.

I&#39;d still suggest including my code or something similar in 
get_secondary_users, or if not a warning in the documentation, given 
its currently effectively broken for large groups. Obviously I&#39;m biased 
though. :&#41;

The iterator seems to match the execution time of the other method 
anyway, again within the variations of our AD setup.

I&#39;ll just await this being rolled out into the live version then and 
I&#39;ll promise not to reopen this ticket!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;26&nbsp;23:41:04&nbsp;2009</span>
    <span class="description">peter [...] peknet.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #48562] Possible bug or just user error with contacts in groups</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 26 Aug 2009 22:40:44 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-LDAP-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Peter Karman &lt;peter [...] peknet.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Peter Newman via RT wrote on 8/26/09 2:41 PM:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-LDAP-Class
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=48562">https://rt.cpan.org/Ticket/Display.html?id=48562</a></span> &gt;
&gt; 
&gt; On Mon Aug 24 00:21:32 2009, peter@peknet.com wrote:
<div class="message-stanza open">&gt;&gt; Thanks for testing.
</div>&gt; That seems to be working fine now thanks, it actually returns more 
&gt; results than my code! Although I&#39;m not sure if that&#39;s a bug in my code 
&gt; or in the LDAP results parsing stuff you mentioned before.
</div>
thanks for testing.

interesting that it returns more results? are any of them duplicates?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I&#39;d still suggest including my code or something similar in 
&gt; get_secondary_users, or if not a warning in the documentation, given 
&gt; its currently effectively broken for large groups. Obviously I&#39;m biased 
&gt; though. :&#41;
</div>
I&#39;ve added lots of docs/warnings about using iterators instead of arrays and
when you might choose either. I also changed the fetch_secondary_users&#40;&#41; code to
just wrap around secondary_users_iterator&#40;&#41;, so your particular bug should not
manifest.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; The iterator seems to match the execution time of the other method 
&gt; anyway, again within the variations of our AD setup.
&gt; 
&gt; I&#39;ll just await this being rolled out into the live version then and 
&gt; I&#39;ll promise not to reopen this ticket!
</div>
0.21 uploaded to pause!

thanks for your persistence on this.

-- 
Peter Karman  .  <span class="clickylink"><a target="new" rel="nofollow" href="http://peknet.com/">http://peknet.com/</a></span>  .  peter@peknet.com
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;26&nbsp;23:42:00&nbsp;2009</span>
    <span class="description">karman [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">0.21 should fix these bugs.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;26&nbsp;23:42:02&nbsp;2009</span>
    <span class="description">karman [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;27&nbsp;11:52:00&nbsp;2009</span>
    <span class="description">PJNEWMAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Okay I said I wouldn&#39;t reopen it, but I wonder if my reply will 
automatically reopen it, anyway, some answers.

On Wed Aug 26 23:41:04 2009, peter@peknet.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; thanks for testing.
&gt; 
&gt; interesting that it returns more results? are any of them duplicates?
</div>Not duplicates in the bad sense, they were repeated multiple times, 
but only because of our AD tree and the fact the main group I&#39;m 
testing is a major parent of many others, although their members 
didn&#39;t appear at all before. There is one group with an ampersand, 
although others with ampersands got through fine before, although I 
note its pre 2000 name is the same as its normal name and particularly 
long, so that might be why its failing. Also one group where there is 
a user with the same name and slightly different capitalisation, 
although the pre 2000 names don&#39;t match. Anyway that&#39;s just as likely 
to be a bug in my code as the main Net::LDAP code or your old code.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve added lots of docs/warnings about using iterators instead of
&gt; arrays and
&gt; when you might choose either. I also changed the
&gt; fetch_secondary_users&#40;&#41; code to
&gt; just wrap around secondary_users_iterator&#40;&#41;, so your particular bug
&gt; should not
&gt; manifest.
</div>Excellent, that sounds like the most sensible resolution to the 
problem.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; thanks for your persistence on this.
</div>Thanks for yours, you&#39;re the one who&#39;s done all the hard work!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;27&nbsp;11:52:01&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;27&nbsp;11:55:09&nbsp;2009</span>
    <span class="description">karman [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
