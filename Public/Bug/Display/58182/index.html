<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #58182 for ExtUtils-ParseXS: [PATCH] partial portability help for dubious INCLUDE_COMMAND feature</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #58182 for ExtUtils-ParseXS: [PATCH] partial portability help for dubious INCLUDE_COMMAND feature</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/ExtUtils-ParseXS/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/ExtUtils-ParseXS/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/ExtUtils-ParseXS/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/ExtUtils-ParseXS/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="http://rt.perl.org/rt3/">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/ExtUtils-ParseXS">ExtUtils-ParseXS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">58182</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/ExtUtils-ParseXS/Active/">ExtUtils-ParseXS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cberry [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-12510-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.2205    </td>
  </tr>
  <tr id="CF-12511-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;06&nbsp;20:44:39&nbsp;2010</span>
    <span class="description">cberry [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] partial portability help for dubious INCLUDE_COMMAND feature</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">First of all, I really don&#39;t think the INCLUDE_COMMAND feature is a great idea for the 
following reasons:

1.&#41;  The command must parse under 3 different languages, one of which is always unknown.  
The three languages are XS, the C preprocessor, and whatever command shell you&#39;re running 
on, and you don&#39;t know what shell that will be when you write your XS code.  The chances of 
the average module maintainer getting all of that right all of the time seems slim.  

2.&#41;  In section 6.10.4, the C standard says, 

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">---quote---
A preprocessing directive of the form

# line digit-sequence &#34;s-char-sequenceopt&#34; new-line

sets the presumed line number similarly and changes the presumed name of the source
file to be the contents of the character string literal.

<div class="message-stanza open">---endquote---

The INCLUDE_COMMAND feature violates this because the character string literal it inserts is 
not a presumed filename but a command.  Any source-level debugger, IDE, or other tool that 
tries to use this information to load the relevant &#34;file&#34;  &#40;and some of them do&#41;, will break.  
They may break nicely and continue, or they may crash, hang, or spew confusing error 
messages.  Putting something in there that is not a filename is wrong.

3.&#41;  The feature is anti-portable because it encourages people to generate XS code with 
external commands, which are likely to be platform-specific.  If the assumption is that 
people will use Perl to generate XS code then why not base a new feature on do&#40;&#41; rather than 
running Perl as an external command?

Since I&#39;m late to the party and often unpersuasive in convincing people not to do crazy 
things, the attached patch gets the tests passing on VMS &#40;and still passing on Mac OS X&#41; 
without addressing any of the concerns above.
</div></div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Make-INCLUDE_COMMAND-semi-portable.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 430186bb3dcd0bdb46f545e30282c67bd0c15e8d Mon Sep 17 00:00:00 2001
From: Craig A. Berry &lt;craigberry@mac.com&gt;
Date: Sun, 6 Jun 2010 17:56:01 -0500
Subject: [PATCH] Make INCLUDE_COMMAND semi-portable.

At the very least, arguments to the command must be quoted on VMS
to preserve case.  The double quotes then have to be escaped to
be parseable as a string literal by the C preprocessor for the #line
directive.  The result is still dubious, as it is in no way &#34;the
presumed name of the source file&#34; as the C standard says it must
be, but this does get it passing tests.

This change also stops pasting the directory onto the command
since it&#39;s a command, not a path, and for the INCLUDE handler,
it properly assembles the path using File::Spec-&gt;catfile&#40;&#41;.
---
 lib/ExtUtils/ParseXS.pm |   17 +++++++++++++++--
 1 files changed, 15 insertions&#40;+&#41;, 2 deletions&#40;-&#41;

diff --git a/lib/ExtUtils/ParseXS.pm b/lib/ExtUtils/ParseXS.pm
index 795145c..9dc0901 100644
--- a/lib/ExtUtils/ParseXS.pm
+++ b/lib/ExtUtils/ParseXS.pm
@@ -1543,7 +1543,7 @@ sub INCLUDE_handler &#40;&#41;
 EOF
 
     $filename = $_ ;
-    $filepathname = &#34;$dir/$filename&#34;;
+    $filepathname = File::Spec-&gt;catfile&#40;$dir, $filename&#41;;
 
     # Prime the pump by reading the first
     # non-blank line
@@ -1557,12 +1557,24 @@ EOF
     $lastline_no = $. ;
   }
 
+sub QuoteArgs {
+    my $cmd = shift;
+    my @args = split /\s+/, $cmd;
+    $cmd = shift @args;
+    for &#40;@args&#41; {
+       $_ = q&#40;&#34;&#41;.$_.q&#40;&#34;&#41; if !/^\&#34;/ &#38;&#38; length&#40;$_&#41; &gt; 0;
+    }
+    return join &#40;&#39; &#39;, &#40;$cmd, @args&#41;&#41;;
+  }
+
 sub INCLUDE_COMMAND_handler &#40;&#41;
   {
     # the rest of the current line should contain a valid command
 
     TrimWhitespace&#40;$_&#41; ;
 
+    $_ = QuoteArgs&#40;$_&#41; if $^O eq &#39;VMS&#39;;
+
     death&#40;&#34;INCLUDE_COMMAND: command missing&#34;&#41;
       unless $_ ;
 
@@ -1588,7 +1600,8 @@ sub INCLUDE_COMMAND_handler &#40;&#41;
 EOF
 
     $filename = $_ ;
-    $filepathname = &#34;$dir/$filename&#34;;
+    $filepathname = $filename;
+    $filepathname =~ s/\&#34;/\\&#34;/g;
 
     # Prime the pump by reading the first
     # non-blank line
-- 
1.7.0.3

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;07&nbsp;07:23:15&nbsp;2010</span>
    <span class="description">dagolden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you.  Applied in the repository.

I think the portability concerns you raise are really with the original
INCLUDE, which special-cased using a pipe character.  The
INCLUDE_COMMAND that Steffen Mueller added is just a more explicit way
of doing what people were already doing with pipe and making it easier
to execute against $^X correctly.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;07&nbsp;07:23:16&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;07&nbsp;07:23:17&nbsp;2010</span>
    <span class="description">dagolden [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
