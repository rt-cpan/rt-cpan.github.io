<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #123562 for Text-PDF: TTFont0 generates broken CMap &#40;patch incl.&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #123562 for Text-PDF: TTFont0 generates broken CMap &#40;patch incl.&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Text-PDF/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Text-PDF/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Text-PDF/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Text-PDF/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Text-PDF">Text-PDF CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">123562</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Text-PDF/Active/">Text-PDF</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
TPLA [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-32228-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-32229-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;08&nbsp;08:26:35&nbsp;2017</span>
    <span class="description">TPLA [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> TTFont0 generates broken CMap &#40;patch incl.&#41;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">When the ToUnicode option is supplied, Text::PDF::TTFont0::new&#40;&#41; will
generate a /ToUnicode CMap object that is broken in a few ways.

This results in PDF files whose text can&#39;t be searched, copied or extracted.

Here&#39;s the broken output:

 1 stream
 2 /CIDInit /ProcSet findresource being 12 dict begin begincmap
 3 /CIDSystemInfo &lt;&lt; /Registry &#40;BXCJIM+ArialRegular+0&#41; /Ordering &#40;XYZ&#41;
 4 /Supplement 0 &gt;&gt; def
 5 /CMapName /BXCJIM+ArialRegular+0 def
 6 1 begincodespacerange &lt;0001&gt; &lt;0d57&gt; endcodespacerange
 7 &lt;0001&gt; &lt;0001&gt; &lt;0000&gt;
 8 
 9 ...
10 
11 &lt;0d57&gt; &lt;0d57&gt; &lt;20b8&gt;
12  endbfrange
13  endcmap CMapName currendict /CMap defineresource pop end endendstream

Notes:

Line 5: &#34; /CMapType 2 def&#34; missing 
Line 7: &#34;NNN beginbfrange&#34; missing
Line 13: &#34;endendstream&#34; missing newline between &#34;end&#34; and &#34;endstream&#34;

Best regards,

Thomas

--- c:/usr/local/perl5/site/lib/Text/PDF/TTFont0.pm     2017-11-08 13:11:45.729893000 +0100
+++ c:/temp/Text-PDF-0.31/lib/Text/PDF/TTFont0.pm       2016-08-04 18:49:53.000000000 +0200
@@ -109,11 +109,9 @@
         $unistr = &#39;/CIDInit /ProcSet findresource being 12 dict begin begincmap
 /CIDSystemInfo &lt;&lt; /Registry &#40;&#39; . $self-&gt;{&#39;BaseFont&#39;}-&gt;val . &#39;+0&#41; /Ordering &#40;XYZ&#41;
 /Supplement 0 &gt;&gt; def
-/CMapName /&#39; . $self-&gt;{&#39;BaseFont&#39;}-&gt;val . &#39;+0 def /CMapType 2 def
+/CMapName /&#39; . $self-&gt;{&#39;BaseFont&#39;}-&gt;val . &#39;+0 def
 1 begincodespacerange &lt;&#39;;
         $unistr .= sprintf&#40;&#34;%04x&gt; &lt;%04x&gt; endcodespacerange\n&#34;, 1, $num - 1&#41;;
-        $unistr .= $num - $i &gt; 100 ? 100 : $num - $i;
-        $unistr .= &#34; beginbfrange\n&#34;;
         for &#40;$i = 1; $i &lt; $num; $i++&#41;
         {
             if &#40;$i % 100 == 0&#41;
@@ -124,7 +122,7 @@
             }
             $unistr .= sprintf&#40;&#34;&lt;%04x&gt; &lt;%04x&gt; &lt;%04x&gt;\n&#34;, $i, $i, $rev[$i]&#41;;
         }
-        $unistr .= &#34;endbfrange\nendcmap CMapName currendict /CMap defineresource pop end end\n&#34;;
+        $unistr .= &#34;endbfrange\nendcmap CMapName currendict /CMap defineresource pop end end&#34;;
         $touni = PDFDict&#40;&#41;;
         $parent-&gt;new_obj&#40;$touni&#41;;
         $touni-&gt;{&#39; stream&#39;} = $unistr;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;08&nbsp;08:34:51&nbsp;2017</span>
    <span class="description">TPLA [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff above is wrong headed.

--- c:/temp/Text-PDF-0.31/lib/Text/PDF/TTFont0.pm       2016-08-04 18:49:53.000000000 +0200
+++ c:/usr/local/perl5/site/lib/Text/PDF/TTFont0.pm     2017-11-08 13:11:45.729893000 +0100
@@ -109,9 +109,11 @@
         $unistr = &#39;/CIDInit /ProcSet findresource being 12 dict begin begincmap
 /CIDSystemInfo &lt;&lt; /Registry &#40;&#39; . $self-&gt;{&#39;BaseFont&#39;}-&gt;val . &#39;+0&#41; /Ordering &#40;XYZ&#41;
 /Supplement 0 &gt;&gt; def
-/CMapName /&#39; . $self-&gt;{&#39;BaseFont&#39;}-&gt;val . &#39;+0 def
+/CMapName /&#39; . $self-&gt;{&#39;BaseFont&#39;}-&gt;val . &#39;+0 def /CMapType 2 def
 1 begincodespacerange &lt;&#39;;
         $unistr .= sprintf&#40;&#34;%04x&gt; &lt;%04x&gt; endcodespacerange\n&#34;, 1, $num - 1&#41;;
+        $unistr .= $num - $i &gt; 100 ? 100 : $num - $i;
+        $unistr .= &#34; beginbfrange\n&#34;;
         for &#40;$i = 1; $i &lt; $num; $i++&#41;
         {
             if &#40;$i % 100 == 0&#41;
@@ -122,7 +124,7 @@
             }
             $unistr .= sprintf&#40;&#34;&lt;%04x&gt; &lt;%04x&gt; &lt;%04x&gt;\n&#34;, $i, $i, $rev[$i]&#41;;
         }
-        $unistr .= &#34;endbfrange\nendcmap CMapName currendict /CMap defineresource pop end end&#34;;
+        $unistr .= &#34;endbfrange\nendcmap CMapName currendict /CMap defineresource pop end end\n&#34;;
         $touni = PDFDict&#40;&#41;;
         $parent-&gt;new_obj&#40;$touni&#41;;
         $touni-&gt;{&#39; stream&#39;} = $unistr;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;17&nbsp;02:23:59&nbsp;2019</span>
    <span class="description">futuramedium [...] yandex.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I came here looking to fix PDF::Reuse &#40;see <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=123564&#41;">https://rt.cpan.org/Public/Bug/Display.html?id=123564&#41;</a></span>. Apparently PDF viewers differ in how strictly they follow the spec w.r.t. text extraction, some are OK without patches, for some the above patch works. But it still is not good enough for Adobe Reader, either because of missed typo &#40;&#39;being&#39;&#41; or off-by-one errors in 1st and last ranges. Patch below fixes that, it also makes things easier by making &#34;codespacerange&#34; all-inclusive &#40;OK for Adobe - OK for everyone, see example in PDF Reference&#41;, replaces &#34;bfrange&#34; with &#34;bfchar&#34; &#40;less verbose&#41;, and skips glyph-id&#39;s for which Unicode is not defined. These should have been &#34;&lt;FFFD&gt;&#34; instead of &#34;&lt;0000&gt;&#34; to begin with, but because they would be useless they better be omitted to reduce bloat. Ideally, the &#34;ToUnicode&#34; should be created at the time font is being subset, but that fix may be in future plans.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> TTFont0.pm.diff.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Text\PDF\TTFont0.pm.old	Thu Aug  4 19:49:53 2016
+++ Text\PDF\TTFont0.pm	Wed Jul 17 08:25:04 2019
@@ -106,23 +106,29 @@
     if &#40;$opt{&#39;ToUnicode&#39;}&#41;
     {
         @rev = $font-&gt;{&#39;cmap&#39;}-&gt;read-&gt;reverse;
-        $unistr = &#39;/CIDInit /ProcSet findresource being 12 dict begin begincmap
+        my $num = grep defined, @rev;
+        $unistr = &#39;/CIDInit /ProcSet findresource begin 12 dict begin begincmap
 /CIDSystemInfo &lt;&lt; /Registry &#40;&#39; . $self-&gt;{&#39;BaseFont&#39;}-&gt;val . &#39;+0&#41; /Ordering &#40;XYZ&#41;
 /Supplement 0 &gt;&gt; def
-/CMapName /&#39; . $self-&gt;{&#39;BaseFont&#39;}-&gt;val . &#39;+0 def
-1 begincodespacerange &lt;&#39;;
-        $unistr .= sprintf&#40;&#34;%04x&gt; &lt;%04x&gt; endcodespacerange\n&#34;, 1, $num - 1&#41;;
-        for &#40;$i = 1; $i &lt; $num; $i++&#41;
+/CMapName /&#39; . $self-&gt;{&#39;BaseFont&#39;}-&gt;val . &#39;+0 def /CMapType 2 def
+1 begincodespacerange &lt;0000&gt; &lt;FFFF&gt; endcodespacerange&#39;.&#34;\n&#34;;
+        for &#40;my $i = my $j = 0; $i &lt; @rev; $i++&#41;
         {
-            if &#40;$i % 100 == 0&#41;
+            next unless defined $rev[$i];
+            my $s = $num - $j &gt; 100 ? 100 : $num - $j;
+            if &#40;$j == 0&#41; 
             {
-                $unistr .= &#34;endbfrange\n&#34;;
-                $unistr .= $num - $i &gt; 100 ? 100 : $num - $i;
-                $unistr .= &#34; beginbfrange\n&#34;;
+                $unistr .= &#34;$s beginbfchar\n&#34;;
             }
-            $unistr .= sprintf&#40;&#34;&lt;%04x&gt; &lt;%04x&gt; &lt;%04x&gt;\n&#34;, $i, $i, $rev[$i]&#41;;
+            elsif &#40;$j % 100 == 0&#41;
+            {
+                $unistr .= &#34;endbfchar\n&#34;;
+                $unistr .= &#34;$s beginbfchar\n&#34;;
+            }
+            $unistr .= sprintf&#40;&#34;&lt;%04x&gt; &lt;%04x&gt;\n&#34;, $i, $rev[$i]&#41;;
+            $j++;
         }
-        $unistr .= &#34;endbfrange\nendcmap CMapName currendict /CMap defineresource pop end end&#34;;
+        $unistr .= &#34;endbfchar\nendcmap CMapName currendict /CMap defineresource pop end end\n&#34;;
         $touni = PDFDict&#40;&#41;;
         $parent-&gt;new_obj&#40;$touni&#41;;
         $touni-&gt;{&#39; stream&#39;} = $unistr;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;17&nbsp;02:24:00&nbsp;2019</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
