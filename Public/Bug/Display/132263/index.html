<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #132263 for Object-Pad: Method calls in non-O::P parent constructor fail</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #132263 for Object-Pad: Method calls in non-O::P parent constructor fail</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Object-Pad">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Object-Pad">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Object-Pad">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Object-Pad">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Object-Pad">Object-Pad CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">132263</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Object-Pad">Object-Pad</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
TEAM [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-273988-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.17    </td>
  </tr>
  <tr id="CF-273989-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.19    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




parent-calls-method-in-new.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1891843/1014593/parent-calls-method-in-new.t">
Sun Mar 29 11:33:27 2020 (553b) by TEAM [...] cpan.org
</a>
</font></li>
</ul>


rt132263-1.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1892115/1014714/rt132263-1.patch">
Wed Apr 01 09:05:31 2020 (2.4k) by leonerd-cpan [...] leonerd.org.uk
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=132263">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1891843" href="/Public/Bug/Display.html?id=132263#txn-1891843">#</a>      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;29&nbsp;11:33:27&nbsp;2020</span>
    <span class="description">TEAM [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Method calls in non-O::P parent constructor fail</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1891843/1014592/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1014592">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 255b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">When inheriting from a plain class that has its own constructor, method calls within that constructor fail:

    Expected $self-&gt;{&#34;Object::Pad/slots&#34;} to be an ARRAY reference

because the object is not yet set up correctly.

Attaching a simple test case.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> parent-calls-method-in-new.t</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1891843/1014593/parent-calls-method-in-new.t">Download parent-calls-method-in-new.t</a><br />
<span class="downloadcontenttype">text/x-perl 553b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use warnings;

use Test::More;
use Test::Fatal;
use Object::Pad;

{ # Simple parent class that calls a method during -&gt;new
    package Example::Parent;
    sub new {
        my &#40;$class, %args&#41; = @_;
        my $self = bless \%args, $class;
        $self-&gt;example_method;
        return $self;
    }
}

{ # We would expect a working child class to have a valid object instance by the time
  # the method is called
    class Example::Child extends Example::Parent;
    method example_method { 1 }
}

new_ok&#40;&#39;Example::Child&#39;&#41;;

done_testing;


</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1892070" href="/Public/Bug/Display.html?id=132263#txn-1892070">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;31&nbsp;19:25:39&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1892070/1014691/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1014691">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Mar 29 11:33:27 2020, TEAM wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; When inheriting from a plain class that has its own constructor,
&gt; method calls within that constructor fail:
&gt; 
&gt; Expected $self-&gt;{&#34;Object::Pad/slots&#34;} to be an ARRAY reference
&gt; 
&gt; because the object is not yet set up correctly.
&gt; 
&gt; Attaching a simple test case.
</div>
In summary, I don&#39;t think this is an easy one to fix. I shall at least explain the current implementation and why the code breaks.

For this we&#39;ll need the injected constructor that Object::Pad puts into every class. That&#39;s actually implemented in XS, but in essence at 0.17 it does the following for a non-native &#34;subclass of HASH&#34; class:

  *new = sub {
    my $class = shift;
    my $self = $class-&gt;SUPER::new&#40;@_&#41;;
    $self-&gt;INITSLOTS;
    $self-&gt;BUILDALL&#40;@_&#41;;
    return $self;
  };

&#40;from 0.18 onwards it also does BUILDARGS but that&#39;s an irrelevant complication here&#41;

This means that the superclass constructor is entirely completed and returns before we call -&gt;INITSLOTS, which is the part responsible for creating the -&gt;{&#39;Object::Pad/slots&#39;} arrayref.

This is a problem here because, during the superclass constructor &#40;i.e. before we have our slots array&#41; it invokes an overridden $self-&gt; method, which hits a sub created by the `method` keyword. Early in its setup it expects to find that array, and complains because it doesn&#39;t find it.

A first thought of an attempted solution might seem to lazily create the slots array when first required. That would indeed solve this particular class, but wouldn&#39;t correctly handle a more complex example such as:

  class Example::Child extends Example::Parent;
  has $_ten = 10;
  method example_method { say &#34;Ten is $_ten&#34; }

The $self-&gt;example_method code would still be invoked and it would lazily create the slots array, but until it has had a chance to run INITSLOTS the $_ten slot would not be filled in, and we&#39;d get an uninitialised value warning instead.

Further thought reveals this isn&#39;t really an Object::Pad-specific problem. Indeed the exact same problem comes for basically the exact same reason if Example::Child were a regular &#34;naked perl OO&#34; class and we did the following:

  package Example::Child;
  use base qw&#40; Example::Parent &#41;;
  sub new {
    my $self = shift-&gt;SUPER::new&#40;@_&#41;;
    $self-&gt;{ten} = 10;
  }
  sub example_method {
    my $self = shift;
    say &#34;Ten is $self-&gt;{ten}&#34;;
  }

This would fail in the same way as $self-&gt;{ten} would be missing at that point.

It could be argued that actually, the real bug here is the expectation of a Perl OO class that calling $self-&gt; methods during its own `sub new` constructor makes sense, because the subclass constructor hasn&#39;t had a chance to run yet. This admittedly is a fairly common design in practice however.

I am reluctant to give the answer &#34;Well don&#39;t do that then&#34;, but at present I don&#39;t have any good ideas for what might be better.

Thoughts from anyone welcome?

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1892071" href="/Public/Bug/Display.html?id=132263#txn-1892071">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;31&nbsp;19:25:40&nbsp;2020</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1892115" href="/Public/Bug/Display.html?id=132263#txn-1892115">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;01&nbsp;09:05:31&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1892115/1014713/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1014713">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 829b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Discussion on #cor points out it&#39;s not actually the method call itself which is problematic, only the slot accesses within it. There&#39;s no problem, semantically, in defining what should happen in this example, because the method only returns a constant 1. Indeed, any method body that contained no slot accesses should be perfectly safe to invoke here.

As such, I have a partial fix for this issue. It won&#39;t allow any method, but it will at least allow those that don&#39;t contain slot accesses.

Further discussion suggests it might be safe to allow slot accesses even though they&#39;re not set up yet by just presenting all values as &#40;immutable&#41; undef. Forbid writing to them but at least let them read as undef; possibly with a warning about slot access to not-fully-constructed instance. Thoughts continue on that.

-- 

Paul Evans
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rt132263-1.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1892115/1014714/rt132263-1.patch">Download rt132263-1.patch</a><br />
<span class="downloadcontenttype">text/x-diff 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">=== modified file &#39;Build.PL&#39;
--- old/Build.PL	2020-03-27 22:10:11 +0000
+++ new/Build.PL	2020-04-01 13:01:17 +0000
@@ -13,6 +13,7 @@
    },
    test_requires =&gt; {
       &#39;Data::Dump&#39; =&gt; 0,
+      &#39;Test::Fatal&#39; =&gt; 0,
       &#39;Test::More&#39; =&gt; &#39;0.88&#39;, # done_testing
       &#39;Test::Refcount&#39; =&gt; 0,
    },

=== modified file &#39;lib/Object/Pad.xs&#39;
--- old/lib/Object/Pad.xs	2020-03-30 01:28:05 +0000
+++ new/lib/Object/Pad.xs	2020-04-01 13:01:17 +0000
@@ -211,9 +211,18 @@
       if&#40;SvTYPE&#40;rv&#41; != SVt_PVHV&#41;
         croak&#40;&#34;Not a HASH reference&#34;&#41;;
       SV **slotssvp = hv_fetchs&#40;&#40;HV *&#41;rv, &#34;Object::Pad/slots&#34;, 0&#41;;
-      if&#40;!slotssvp || !SvROK&#40;*slotssvp&#41; || SvTYPE&#40;SvRV&#40;*slotssvp&#41;&#41; != SVt_PVAV&#41;
-        croak&#40;&#34;Expected $self-&gt;{\&#34;Object::Pad/slots\&#34;} to be an ARRAY reference&#34;&#41;;
-      slotsav = SvRV&#40;*slotssvp&#41;;
+      /* A method invoked during a superclass constructor of a classic perl
+       * class might encounter $self without slots. For this situation we&#39;ll
+       * pretend we have an empty immutable set of slots
+       *   <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=132263">https://rt.cpan.org/Ticket/Display.html?id=132263</a></span>
+       */
+      if&#40;!slotssvp&#41;
+        slotsav = &#38;PL_sv_undef;
+      else {
+        if&#40;!SvROK&#40;*slotssvp&#41; || SvTYPE&#40;SvRV&#40;*slotssvp&#41;&#41; != SVt_PVAV&#41;
+          croak&#40;&#34;Expected $self-&gt;{\&#34;Object::Pad/slots\&#34;} to be an ARRAY reference&#34;&#41;;
+        slotsav = SvRV&#40;*slotssvp&#41;;
+      }
       break;
     }
   }
@@ -250,6 +259,9 @@
 #endif
   PADOFFSET targ = PL_op-&gt;op_targ;
 
+  if&#40;SvTYPE&#40;PAD_SV&#40;PADIX_SLOTS&#41;&#41; != SVt_PVAV&#41;
+    croak&#40;&#34;ARGH: expected ARRAY of slots at PADIX_SLOTS&#34;&#41;;
+
   AV *slotsav = &#40;AV *&#41;PAD_SV&#40;PADIX_SLOTS&#41;;
 
   if&#40;slotix &gt; av_top_index&#40;slotsav&#41;&#41;

=== modified file &#39;t/06extends-HASH.t&#39;
--- old/t/06extends-HASH.t	2019-11-20 18:22:03 +0000
+++ new/t/06extends-HASH.t	2020-04-01 13:01:17 +0000
@@ -4,6 +4,7 @@
 use warnings;
 
 use Test::More;
+use Test::Fatal;
 
 use Object::Pad;
 
@@ -50,4 +51,27 @@
       &#39;pp&#40;$obj&#41; of Object::Pad-extended foreign HASH class&#39; &#41;;
 }
 
+# Various RT132263 test cases
+{
+   package RT132263::Parent;
+   sub new {
+      my $class = shift;
+      my $self = bless {}, $class;
+      $self-&gt;example_method;
+      return $self;
+   }
+}
+
+# Test case one - no slot access in example_method
+{
+   class RT132263::Child1 extends RT132263::Parent {
+      method example_method { 1 }
+   }
+
+   my $e;
+   ok&#40; !defined&#40; $e = exception { RT132263::Child1-&gt;new } &#41;,
+      &#39;RT132263 case 1 constructs OK&#39; &#41; or
+      diag&#40; &#34;Exception was $e&#34; &#41;;
+}
+
 done_testing;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1892130" href="/Public/Bug/Display.html?id=132263#txn-1892130">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;01&nbsp;13:44:11&nbsp;2020</span>
    <span class="description">TEAM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1892130/1014725/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1014725">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2020-04-01 14:05:31, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Further discussion suggests it might be safe to allow slot accesses
&gt; even though they&#39;re not set up yet by just presenting all values as
&gt; &#40;immutable&#41; undef. Forbid writing to them but at least let them read
&gt; as undef; possibly with a warning about slot access to not-fully-
&gt; constructed instance. Thoughts continue on that.
</div>

Unfortunately that limits options for workarounds: the entire BUILD chain breaks on a trivial `sub new { bless; $self-&gt;BUILD }` pattern, because all the attempted setup within the child methods will have no write access to slots. I don&#39;t think partial slot support is going to help much in practical cases.

Hooking `bless` would be the ideal time for the -&gt;INIT_SLOTS upgrade to happen, although not sure whether that&#39;s even possible at CPAN level &#40;even if it is, bless is a hot path - this could have significant performance implications?&#41;

How would a child class work around this issue at the moment? Is there anything that could be done to make that easier?

For now, it looks like the best option is to reÃ¯mplement the logic from the parent class constructor&#40;s&#41; in `method BUILD` - we can&#39;t bless an empty hash and pass that over:

    $ perl -e&#39;use strict; use warnings; package Parent { sub new { my &#40;$class, %args&#41; = @_; my $self = bless { }, $class; $self-&gt;BUILD&#40;%args&#41;; } sub BUILD { my &#40;$self, %args&#41; = @_; $self } } use Object::Pad; class Child extends Parent { has $thing; sub new { my &#40;$class, %args&#41; = @_; my $self = bless {}, $class; $self-&gt;INITSLOTS; return $self-&gt;next::method&#40;%args&#41; } method BUILD &#40;%args&#41; { $thing = delete $args{thing}; $self } } Child-&gt;new&#39;
    Subroutine new redefined at -e line 1.
    Attempt to bless into a reference at -e line 1.

and it&#39;s too late to call -&gt;INITSLOTS at the start of the method:

    $ perl -e&#39;use strict; use warnings; package Parent { sub new { my &#40;$class, %args&#41; = @_; my $self = bless { }, $class; $self-&gt;BUILD&#40;%args&#41;; } sub BUILD { my &#40;$self, %args&#41; = @_; $self } } use Object::Pad; class Child extends Parent { has $thing; method BUILD &#40;%args&#41; { $self-&gt;INITSLOTS; $thing = delete $args{thing}; $self } } Child-&gt;new&#39;
    Expected $self-&gt;{&#34;Object::Pad/slots&#34;} to be an ARRAY reference at -e line 1.

Providing ways for parent classes to make this easier would be a good starting point, assuming that there isn&#39;t a neat solution to let existing parent classes work without needing any changes - IO::Async::Notifier in particular would really benefit from a cleaner option than the current workarounds, would be nice to avoid proliferation of code like this:

    use Object::Pad;
    {
     package Workaround::Notifier::Empty;
     use parent qw&#40;IO::Async::Notifier&#41;;
     sub new {
      my &#40;$class, %args&#41; = @_;
      bless \%args, $class
     }
    }
    class Workaround::Notifier extends Workaround::Notifier::Empty;
    method BUILD &#40;%args&#41; {
     $self-&gt;_init&#40;\%args&#41;;
     $self-&gt;configure&#40;%args&#41;;
     $self
    }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1892329" href="/Public/Bug/Display.html?id=132263#txn-1892329">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;03&nbsp;16:26:29&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1892329/1014798/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1014798">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 561b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Apr 01 13:44:11 2020, TEAM wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hooking `bless` would be the ideal time for the -&gt;INIT_SLOTS upgrade
&gt; to happen, although not sure whether that&#39;s even possible at CPAN
&gt; level &#40;even if it is, bless is a hot path - this could have
&gt; significant performance implications?&#41;
</div>
It wouldn&#39;t be possible sufficiently reliably. Options are modifications to either:
 a&#41; CORE::GLOBAL::bless, or
 b&#41; PL_ppaddr[OP_BLESS]
and both of these will only affect new code compiled afterwards; so the whole setup would be too prone to module load order.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1892331" href="/Public/Bug/Display.html?id=132263#txn-1892331">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;03&nbsp;16:31:43&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1892331/1014800/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1014800">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Further discussion on #cor comes up with a potential idea.

The trouble isn&#39;t really related to the `BUILD` methods, but more the `INITSLOTS` which is responsible for creating the -&gt;{&#39;Object::Pad/slots&#39;} ARRAYref. There&#39;s no constructor args involved in this part; it&#39;s just a matter of invoking all the partial expression optrees stored in the class data. I.e. it can be done at OP_METHSTART time.

Currently the OP_METHSTART simply throws an exception if it doesn&#39;t find the slots AV. This could easily be changed to make a call to INITSLOTS to create that, and have the proper constructor skip that step if it&#39;s already been done.

A potential downside here is that `caller`, stacktraces during exceptions, etc.. would look a bit wrong if any exceptions were thrown. A mitigating factor here is currently we only allow constant expressions to initialise slots with, so it&#39;s impossible to create one of those. As and when we ever do allow computed expressions that could peek at `caller` or throw an exception, we can just document the odd behaviour around this situation.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1892350" href="/Public/Bug/Display.html?id=132263#txn-1892350">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;03&nbsp;20:35:09&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1892350/1014802/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1014802">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 932b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Apr 03 16:31:43 2020, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Currently the OP_METHSTART simply throws an exception if it doesn&#39;t
&gt; find the slots AV. This could easily be changed to make a call to
&gt; INITSLOTS to create that, and have the proper constructor skip that
&gt; step if it&#39;s already been done.
</div>
Newly-CPAN&#39;ed version 0.19 allows the following:


use IO::Async::Loop;

use Object::Pad 0.19;

class Net::Async::Bananarama
   extends IO::Async::Notifier
{
   has $_banana;

   method configure &#40; %args &#41; {
      $_banana = delete $args{banana};
      $self-&gt;SUPER::configure&#40; %args &#41;;
   }

   method _add_to_loop &#40; $loop &#41; {
      warn &#34;Should talk to the loop about $_banana&#34;;
   }
}

my $loop = IO::Async::Loop-&gt;new;
$loop-&gt;add&#40; Net::Async::Bananarama-&gt;new&#40;
   banana =&gt; &#34;bright and yellow&#34;,
&#41; &#41;;


$ perl subclass-io-async-notifier.t 
Should talk to the loop about bright and yellow at subclass-io-async-notifier.t line 16.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1892601" href="/Public/Bug/Display.html?id=132263#txn-1892601">#</a>      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;05&nbsp;12:39:11&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1892601/1014899/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1014899">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 41b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is resolved by 0.19

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1892603" href="/Public/Bug/Display.html?id=132263#txn-1892603">#</a>      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;05&nbsp;12:39:12&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1892605" href="/Public/Bug/Display.html?id=132263#txn-1892605">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;05&nbsp;12:39:12&nbsp;2020</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Fixed in 0.19 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.37547</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
