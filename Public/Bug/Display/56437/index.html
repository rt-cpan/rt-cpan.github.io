<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #56437 for FCGI: Unicode trouble with FCGI-0.69 and higher using Mason with CGI::Fast</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #56437 for FCGI: Unicode trouble with FCGI-0.69 and higher using Mason with CGI::Fast</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/FCGI/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/FCGI/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/FCGI/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/FCGI/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/FCGI">FCGI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">56437</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/FCGI/Active/">FCGI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">bobtfish [...] bobtfish.net
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
eric_a_benson [...] yahoo.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-12604-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-12605-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;09&nbsp;14:38:31&nbsp;2010</span>
    <span class="description">eric_a_benson [...] yahoo.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Unicode trouble with FCGI-0.69 and higher using Mason with CGI::Fast</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 9 Apr 2010 11:38:16 -0700 &#40;PDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> mason-users [...] lists.sourceforge.net, bug-FCGI [...] rt.cpan.org, bug-CGI [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Benson &lt;eric_a_benson [...] yahoo.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m sending this bug report to the mason-users list as well as the bug reporting mail addresses for the CGI and FCGI Perl modules.

A change in Unicode string handling in the FCGI module between version 0.68 and 0.69 is causing problems for Mason applications deployed with FastCGI, using the CGI::Fast module. I observed this problem in my own application and discovered by searching the Internet that it had been reported previously.

The ChangeLog for FCGI shows this entry for version 0.68_01:

    o Fix UTF-8 double encoding when FCGI is passed octets by downgrading
      them into bytes correctly. Fixes RT#52400 &lt;chansen@cpan.org&gt;

This appears to be the source of the trouble. A problem report was sent to the mason-users list on March 10 as well as the Request Tracker Users list on March 15 by Vitaly Tskhovrebov:

----------------------------------------------------------------------------------------------

Hello.

I&#39;m trying to use mason with RT 3.8.7 and when I starting it with
FCGI_SOCKET_PATH=/opt/rt3/var/nginx/rt3.fcgi.socket perl /opt/rt3/bin/mason_handler.fcgi &#38;

and trying to browse to, it may return this error:
Wide character in FCGI::Stream::PRINT at /usr/lib64/perl5/site_perl/5.8.8/HTML/Mason/CGIHandler.pm line 106,  line 323.

I believe that&#39;s related to utf-8 handling, but I Can&#39;t understand how to turn on utf-8 by default at whole mason&#39;s engine.

-----------------------------------------------------------------------------------------------

He received this response on the Request Tracker Users list from Ruslan Zakirov:

-----------------------------------------------------------------------------------------------

Hello Vitaly. 

Downgrade FCGI module to version 0.68. 

-----------------------------------------------------------------------------------------------

Vitaly reported that this solved his problem and I also observed that it solved the problem in my application. However, obviously we cannot rely on an obsolete version of a Perl module forever, especially since subsequent versions of FCGI have fixes needed for upcoming Perl version 5.12. Clearly the change described in version 0.68_01 was desired to fix some application, but it seems to have broken other applications. It seems that either that change to FCGI should be modified so that Mason applications with UTF-8 work, or Mason itself should be modified, or the CGI::Fast module should be modified. Perhaps a new parameter is required to be supplied to CGI::Fast or HTML::Mason::CGIHandler to make it UTF-8 aware.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;10&nbsp;03:45:46&nbsp;2010</span>
    <span class="description">bobtfish [...] bobtfish.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> chansen [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Eric

On Fri Apr 09 14:38:31 2010, eric_a_benson@yahoo.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; A change in Unicode string handling in the FCGI module between version
&gt;    0.68 and 0.69 is causing problems for Mason applications deployed
&gt;    with FastCGI, using the CGI::Fast module. I observed this problem
&gt;    in my own application and discovered by searching the Internet that
&gt;    it had been reported previously.
&gt; 
&gt; The ChangeLog for FCGI shows this entry for version 0.68_01:
&gt; 
&gt;     o Fix UTF-8 double encoding when FCGI is passed octets by
&gt;    downgrading
&gt;       them into bytes correctly. Fixes RT#52400 &lt;chansen@cpan.org&gt;
</div>
&lt;snip&gt;

I&#39;ve copied chansen into this mail also.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m trying to use mason with RT 3.8.7 and when I starting it with
&gt; FCGI_SOCKET_PATH=/opt/rt3/var/nginx/rt3.fcgi.socket perl
&gt;    /opt/rt3/bin/mason_handler.fcgi &#38;
&gt; 
&gt; and trying to browse to, it may return this error:
&gt; Wide character in FCGI::Stream::PRINT at
&gt;    /usr/lib64/perl5/site_perl/5.8.8/HTML/Mason/CGIHandler.pm line 106,
&gt;    line 323.
&gt; 
&gt; I believe that&#39;s related to utf-8 handling, but I Can&#39;t understand how
&gt;    to turn on utf-8 by default at whole mason&#39;s engine.
</div>
&lt;snip&gt;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; He received this response on the Request Tracker Users list from
&gt;    Ruslan Zakirov:
</div>
&lt;snip&gt;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Downgrade FCGI module to version 0.68.
</div>
&lt;snip&gt;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Vitaly reported that this solved his problem and I also observed that
&gt;    it solved the problem in my application. However, obviously we
&gt;    cannot rely on an obsolete version of a Perl module forever,
&gt;    especially since subsequent versions of FCGI have fixes needed for
&gt;    upcoming Perl version 5.12. Clearly the change described in version
&gt;    0.68_01 was desired to fix some application, but it seems to have
&gt;    broken other applications. It seems that either that change to FCGI
&gt;    should be modified so that Mason applications with UTF-8 work, or
&gt;    Mason itself should be modified, or the CGI::Fast module should be
&gt;    modified. Perhaps a new parameter is required to be supplied to
&gt;    CGI::Fast or HTML::Mason::CGIHandler to make it UTF-8 aware.
</div>
I&#39;m afraid that there is no intention of changing FCGI at this point.

What was previously happening is that FCGI had no concept of perl&#39;s
UTF-8 handling whatsoever.

Therefore, if you output character data which was in the high bit range
&#40;i.e. uft8 upgraded characters&#41;, then you would silently get data
corruption... Not a good thing. :&#40;

FCGI was changed such that if perl knows how to / is able to downgrade
the character string into a byte string, then this is done &#40;giving
correct output&#41;, otherwise an error is thrown.

Whilst, unfortunately, this causes some things which used to silently
&#34;work&#34; &#40;for values of work meaning silently corrupting your data&#41; to
fail now, resulting in the issue that you&#39;re seeing, I&#39;m 100% convinced
that the behavior change is entirely correct..

I&#39;ll keep this ticket open as a reference to track the issues with
Mason/CGI::Fast, but someone would need to convince me &#40;in the form of
patches and tests&#41; to change the code...

I _would_ support and take a patch to add a
SILENTLY_CORRUPT_UNENCODED_CHARACTER_DATA_I_KNOW_WHAT_I_AM_DOING_AND_LIKE_MOJIBAKE
flag &#40;or something similar&#41;, which would optionally disable the new
behavior, if the user was prepared to specify very plainly that they
explicitly want the broken behavior.

Cheers
t0m
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;10&nbsp;03:45:49&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;10&nbsp;03:45:58&nbsp;2010</span>
    <span class="description">bobtfish [...] bobtfish.net -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;10&nbsp;03:47:21&nbsp;2010</span>
    <span class="description">bobtfish [...] bobtfish.net -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;10&nbsp;11:12:22&nbsp;2010</span>
    <span class="description">christian.hansen [...] mac.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #56437] Unicode trouble with FCGI-0.69 and higher using Mason with CGI::Fast</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 10 Apr 2010 17:11:36 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-FCGI [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Christian Hansen &lt;christian.hansen [...] mac.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
10 apr 2010 kl. 09.45 skrev Tomas Doran via RT:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=56437">https://rt.cpan.org/Ticket/Display.html?id=56437</a></span> &gt;
&gt;
&gt; Hi Eric
&gt;
&gt; On Fri Apr 09 14:38:31 2010, eric_a_benson@yahoo.com wrote:
<div class="message-stanza open">&gt;&gt; A change in Unicode string handling in the FCGI module between  
&gt;&gt; version
&gt;&gt;   0.68 and 0.69 is causing problems for Mason applications deployed
&gt;&gt;   with FastCGI, using the CGI::Fast module. I observed this problem
&gt;&gt;   in my own application and discovered by searching the Internet that
&gt;&gt;   it had been reported previously.
&gt;&gt;
&gt;&gt; The ChangeLog for FCGI shows this entry for version 0.68_01:
&gt;&gt;
&gt;&gt;    o Fix UTF-8 double encoding when FCGI is passed octets by
&gt;&gt;   downgrading
&gt;&gt;      them into bytes correctly. Fixes RT#52400 &lt;chansen@cpan.org&gt;
</div>&gt;
&gt; &lt;snip&gt;
&gt;
&gt; I&#39;ve copied chansen into this mail also.
&gt;
<div class="message-stanza open">&gt;&gt; I&#39;m trying to use mason with RT 3.8.7 and when I starting it with
&gt;&gt; FCGI_SOCKET_PATH=/opt/rt3/var/nginx/rt3.fcgi.socket perl
&gt;&gt;   /opt/rt3/bin/mason_handler.fcgi &#38;
&gt;&gt;
&gt;&gt; and trying to browse to, it may return this error:
&gt;&gt; Wide character in FCGI::Stream::PRINT at
&gt;&gt;   /usr/lib64/perl5/site_perl/5.8.8/HTML/Mason/CGIHandler.pm line 106,
&gt;&gt;   line 323.
&gt;&gt;
&gt;&gt; I believe that&#39;s related to utf-8 handling, but I Can&#39;t understand  
&gt;&gt; how
&gt;&gt;   to turn on utf-8 by default at whole mason&#39;s engine.
</div>&gt;
&gt; &lt;snip&gt;
&gt;
<div class="message-stanza open">&gt;&gt; He received this response on the Request Tracker Users list from
&gt;&gt;   Ruslan Zakirov:
</div>&gt;
&gt; &lt;snip&gt;
&gt;
<div class="message-stanza open">&gt;&gt; Downgrade FCGI module to version 0.68.
</div>&gt;
&gt; &lt;snip&gt;
&gt;
<div class="message-stanza open">&gt;&gt; Vitaly reported that this solved his problem and I also observed that
&gt;&gt;   it solved the problem in my application. However, obviously we
&gt;&gt;   cannot rely on an obsolete version of a Perl module forever,
&gt;&gt;   especially since subsequent versions of FCGI have fixes needed for
&gt;&gt;   upcoming Perl version 5.12. Clearly the change described in version
&gt;&gt;   0.68_01 was desired to fix some application, but it seems to have
&gt;&gt;   broken other applications. It seems that either that change to FCGI
&gt;&gt;   should be modified so that Mason applications with UTF-8 work, or
&gt;&gt;   Mason itself should be modified, or the CGI::Fast module should be
&gt;&gt;   modified. Perhaps a new parameter is required to be supplied to
&gt;&gt;   CGI::Fast or HTML::Mason::CGIHandler to make it UTF-8 aware.
</div>&gt;
</div>
The problem is that UTF-X may or may not be well-formed UTF-8 , it could
also be UTF-EBCDIC, but you have to understand that you are trying to  
output
Perl&#39;s internal encoding and *not* UTF-8.

Current behavior is desirable, if you wish to change this you need to  
convince
p5p as it&#39;s beyond the scope for an extension module.

&lt;snip&gt;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; I _would_ support and take a patch to add a
&gt; SILENTLY_CORRUPT_UNENCODED_CHARACTER_DATA_I_KNOW_WHAT_I_AM_DOING_AND_LIKE_MOJIBAKE
&gt; flag &#40;or something similar&#41;, which would optionally disable the new
&gt; behavior, if the user was prepared to specify very plainly that they
&gt; explicitly want the broken behavior.
</div>
No need for patch, users who prefer the previously broken behavior can  
add &#34;use bytes;&#34; which FCGI.XS respects.

--
chansen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;10&nbsp;11:12:23&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;10&nbsp;14:05:13&nbsp;2010</span>
    <span class="description">eric_a_benson [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #56437] Unicode trouble with FCGI-0.69 and higher using Mason with CGI::Fast</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 10 Apr 2010 11:04:58 -0700 &#40;PDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-FCGI [...] rt.cpan.org, mason-users [...] lists.sourceforge.net</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Benson &lt;eric_a_benson [...] yahoo.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The problem is that UTF-X may or may not be well-formed UTF-8 , it could
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; also be UTF-EBCDIC, but you have to understand that you are trying to output
&gt; Perl&#39;s internal encoding and *not* UTF-8.
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Current behavior is desirable, if you wish to change this you need to convince
&gt; p5p as it&#39;s beyond the scope for an extension module.
</div>
I understand why this is desirable, I am just trying to understand how to fix my application that previously worked, even if it only worked accidentally. I don&#39;t think there&#39;s any change available to me at the application level that will solve this. My application doesn&#39;t use FCGI directly. It creates a CGI::Fast object and passes that to HTML::Mason::CGIHandler::handle_cgi_object. As far as I can tell, neither CGI::Fast nor Mason has any special handling for Unicode. Mason just passes strings to the print method of the STDOUT stream. Most Mason applications are deployed using mod_perl. I am not using mod_perl, but I assume that those applications are current working with Unicode. What is the change required to enable Mason to work with FastCGI with Unicode strings? Do I need to re-implement or create a subclass of CGI::Fast that doesn&#39;t use FCGI directly but uses a wrapper object that does the Perl string to raw bytes conversion itself?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;11&nbsp;07:46:40&nbsp;2010</span>
    <span class="description">chansen [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> mason-users [...] lists.sourceforge.net, christian.hansen [...] mac.com,
 bug-CGI [...] rt.cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Vid Sat, 10 apr 2010 kl. 14.05.13, skrev eric_a_benson@yahoo.com:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; The problem is that UTF-X may or may not be well-formed UTF-8 , it
</div>&gt;    could
&gt; 
<div class="message-stanza open">&gt; &gt; also be UTF-EBCDIC, but you have to understand that you are trying
</div>&gt;    to output
<div class="message-stanza open">&gt; &gt; Perl&#39;s internal encoding and *not* UTF-8.
</div>&gt; 
<div class="message-stanza open">&gt; &gt; Current behavior is desirable, if you wish to change this you need
</div>&gt;    to convince
<div class="message-stanza open">&gt; &gt; p5p as it&#39;s beyond the scope for an extension module.
</div>&gt; 
&gt; I understand why this is desirable, I am just trying to understand how
&gt;    to fix my application that previously worked, even if it only
&gt;    worked accidentally. I don&#39;t think there&#39;s any change available to
&gt;    me at the application level that will solve this. My application
&gt;    doesn&#39;t use FCGI directly. It creates a CGI::Fast object and passes
&gt;    that to HTML::Mason::CGIHandler::handle_cgi_object. As far as I can
&gt;    tell, neither CGI::Fast nor Mason has any special handling for
&gt;    Unicode. Mason just passes strings to the print method of the
&gt;    STDOUT stream. Most Mason applications are deployed using mod_perl.
&gt;    I am not using mod_perl, but I assume that those applications are
&gt;    current working with Unicode. What is the change required to enable
&gt;    Mason to work with FastCGI with Unicode strings? Do I need to re-
&gt;    implement or create a subclass of CGI::Fast that doesn&#39;t use FCGI
&gt;    directly but uses a wrapper object that does the Perl string to raw
&gt;    bytes conversion itself?
&gt; 
</div>
Mason developers should consider implementing support for encodings, thats the proper place to fix it IMO.

I can think of two short term solutions:

1&#41; Monkey/Hot patch FCGI::Stream

$ cat cgi-hotpatch.pl
#!/usr/bin/perl
use strict;
use warnings;

use CGI::Fast qw[];
use FCGI      qw[];
use Encode    qw[];

my $enc = Encode::find_encoding&#40;&#39;UTF-8&#39;&#41;;
my $org = \&#38;FCGI::Stream::PRINT;
no warnings &#39;redefine&#39;;
local *FCGI::Stream::PRINT = sub {
    for &#40;my $i = 1; $i &lt; @_; $i++&#41; {
        $_[$i] = $enc-&gt;encode&#40;$_[$i], Encode::FB_CROAK|Encode::LEAVE_SRC&#41;;
    }
    goto $org;
};

while &#40;my $q = CGI::Fast-&gt;new&#41; {
    print $q-&gt;start_html,
          $q-&gt;p&#40;&#34;\x{263A}&#34;&#41;,
          $q-&gt;end_html;
}

2&#41; Implement a stream class which does the encoding. untie&#40;&#41; current STDOUT and tie&#40;&#41; it with new stream class.

$ cat cgi-tiehandle.pl
#!/usr/bin/perl
use strict;
use warnings;

{
    package MyStream;
    use Encode qw[FB_CROAK LEAVE_SRC];

    sub PRINT {
        my $self = shift;
        $_ = $self-&gt;{encoding}-&gt;encode&#40;$_, FB_CROAK|LEAVE_SRC&#41; for @_;
        return $self-&gt;{stream}-&gt;PRINT&#40;@_&#41;;
    }

    sub TIEHANDLE {
        my &#40;$class, $stream, $encoding&#41; = @_;
        return bless { stream =&gt; $stream, encoding =&gt; $encoding }, $class;
    }
}

{
    package MyFast;
    use base &#39;CGI::Fast&#39;;

    sub new {
        my $class   = shift;
        my $charset = shift;
        my $self    = $class-&gt;SUPER::new&#40;@_&#41;;
        my $stream  = tied *STDOUT;
        $self-&gt;charset&#40;$charset&#41;;
        no warnings &#39;untie&#39;;
        tie *STDOUT, &#39;MyStream&#39;, $stream, Encode::find_encoding&#40;$charset&#41;;
        return $self;
    }
}

while &#40;my $q = MyFast-&gt;new&#40;&#39;UTF-8&#39;&#41;&#41; {
    print $q-&gt;start_html,
          $q-&gt;p&#40;&#34;\x{263A}&#34;&#41;,
          $q-&gt;end_html;
}

We &#40;the FCGI developers&#41; should look into moving away from tiehandle to PerlIO for streams, this would make it easier 
for users as they can use the encoding pragma: use encoding &#39;UTF-8&#39;;


--
chansen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;11&nbsp;08:16:08&nbsp;2010</span>
    <span class="description">mason-users-owner [...] lists.sourceforge.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #56437] Unicode trouble with FCGI-0.69 and higher using Mason with CGI::Fast </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 11 Apr 2010 12:15:25 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-fcgi [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mason-users-owner [...] lists.sourceforge.net</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">You must be subscribed to post to this list. See 

    <span class="clickylink"><a target="new" rel="nofollow" href="http://www.masonhq.com/?YouMustBeSubscribedToPost">http://www.masonhq.com/?YouMustBeSubscribedToPost</a></span>
</div></div>
<div class="messageattachments">
<div class="message-stanza plain-text-white-space">
</div><table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> mason-users [...] lists.sourceforge.net, christian.hansen [...] mac.com,
	bug-CGI [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #56437] Unicode trouble with FCGI-0.69 and higher using
	Mason with CGI::Fast </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 11 Apr 2010 07:46:52 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Christian Hansen via RT&#34; &lt;bug-FCGI [...] rt.cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=56437">https://rt.cpan.org/Ticket/Display.html?id=56437</a></span> &gt;

Vid Sat, 10 apr 2010 kl. 14.05.13, skrev eric_a_benson@yahoo.com:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; The problem is that UTF-X may or may not be well-formed UTF-8 , it
</div>&gt;    could
&gt; 
<div class="message-stanza open">&gt; &gt; also be UTF-EBCDIC, but you have to understand that you are trying
</div>&gt;    to output
<div class="message-stanza open">&gt; &gt; Perl&#39;s internal encoding and *not* UTF-8.
</div>&gt; 
<div class="message-stanza open">&gt; &gt; Current behavior is desirable, if you wish to change this you need
</div>&gt;    to convince
<div class="message-stanza open">&gt; &gt; p5p as it&#39;s beyond the scope for an extension module.
</div>&gt; 
&gt; I understand why this is desirable, I am just trying to understand how
&gt;    to fix my application that previously worked, even if it only
&gt;    worked accidentally. I don&#39;t think there&#39;s any change available to
&gt;    me at the application level that will solve this. My application
&gt;    doesn&#39;t use FCGI directly. It creates a CGI::Fast object and passes
&gt;    that to HTML::Mason::CGIHandler::handle_cgi_object. As far as I can
&gt;    tell, neither CGI::Fast nor Mason has any special handling for
&gt;    Unicode. Mason just passes strings to the print method of the
&gt;    STDOUT stream. Most Mason applications are deployed using mod_perl.
&gt;    I am not using mod_perl, but I assume that those applications are
&gt;    current working with Unicode. What is the change required to enable
&gt;    Mason to work with FastCGI with Unicode strings? Do I need to re-
&gt;    implement or create a subclass of CGI::Fast that doesn&#39;t use FCGI
&gt;    directly but uses a wrapper object that does the Perl string to raw
&gt;    bytes conversion itself?
&gt; 
</div>
Mason developers should consider implementing support for encodings, thats the proper place to fix it IMO.

I can think of two short term solutions:

1&#41; Monkey/Hot patch FCGI::Stream

$ cat cgi-hotpatch.pl
#!/usr/bin/perl
use strict;
use warnings;

use CGI::Fast qw[];
use FCGI      qw[];
use Encode    qw[];

my $enc = Encode::find_encoding&#40;&#39;UTF-8&#39;&#41;;
my $org = \&#38;FCGI::Stream::PRINT;
no warnings &#39;redefine&#39;;
local *FCGI::Stream::PRINT = sub {
    for &#40;my $i = 1; $i &lt; @_; $i++&#41; {
        $_[$i] = $enc-&gt;encode&#40;$_[$i], Encode::FB_CROAK|Encode::LEAVE_SRC&#41;;
    }
    goto $org;
};

while &#40;my $q = CGI::Fast-&gt;new&#41; {
    print $q-&gt;start_html,
          $q-&gt;p&#40;&#34;\x{263A}&#34;&#41;,
          $q-&gt;end_html;
}

2&#41; Implement a stream class which does the encoding. untie&#40;&#41; current STDOUT and tie&#40;&#41; it with new stream class.

$ cat cgi-tiehandle.pl
#!/usr/bin/perl
use strict;
use warnings;

{
    package MyStream;
    use Encode qw[FB_CROAK LEAVE_SRC];

    sub PRINT {
        my $self = shift;
        $_ = $self-&gt;{encoding}-&gt;encode&#40;$_, FB_CROAK|LEAVE_SRC&#41; for @_;
        return $self-&gt;{stream}-&gt;PRINT&#40;@_&#41;;
    }

    sub TIEHANDLE {
        my &#40;$class, $stream, $encoding&#41; = @_;
        return bless { stream =&gt; $stream, encoding =&gt; $encoding }, $class;
    }
}

{
    package MyFast;
    use base &#39;CGI::Fast&#39;;

    sub new {
        my $class   = shift;
        my $charset = shift;
        my $self    = $class-&gt;SUPER::new&#40;@_&#41;;
        my $stream  = tied *STDOUT;
        $self-&gt;charset&#40;$charset&#41;;
        no warnings &#39;untie&#39;;
        tie *STDOUT, &#39;MyStream&#39;, $stream, Encode::find_encoding&#40;$charset&#41;;
        return $self;
    }
}

while &#40;my $q = MyFast-&gt;new&#40;&#39;UTF-8&#39;&#41;&#41; {
    print $q-&gt;start_html,
          $q-&gt;p&#40;&#34;\x{263A}&#34;&#41;,
          $q-&gt;end_html;
}

We &#40;the FCGI developers&#41; should look into moving away from tiehandle to PerlIO for streams, this would make it easier 
for users as they can use the encoding pragma: use encoding &#39;UTF-8&#39;;


--
chansen
</div></div>
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;15&nbsp;22:20:09&nbsp;2010</span>
    <span class="description">eric_a_benson [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #56437] Unicode trouble with FCGI-0.69 and higher using Mason with CGI::Fast</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 15 Apr 2010 19:19:48 -0700 &#40;PDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-FCGI [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Eric Benson &lt;eric_a_benson [...] yahoo.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; my $enc = Encode::find_encoding&#40;&#39;UTF-8&#39;&#41;;
</div>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; my $org = \&#38;FCGI::Stream::PRINT;
&gt; no warnings &#39;redefine&#39;;
&gt; local *FCGI::Stream::PRINT = sub {
&gt;     for &#40;my $i = 1; $i &lt; @_; $i++&#41; {
&gt;         $_[$i] = $enc-&gt;encode&#40;$_[$i], Encode::FB_CROAK|Encode::LEAVE_SRC&#41;;
&gt;     }
&gt;     goto $org;
&gt; };
</div>
Thanks for that! My app is working great again with the latest FCGI and this hot patch.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;08&nbsp;16:38:59&nbsp;2010</span>
    <span class="description">bobtfish [...] bobtfish.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m going to resolve this as there isn&#39;t anything to fix in FCGI here.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;08&nbsp;16:39:02&nbsp;2010</span>
    <span class="description">bobtfish [...] bobtfish.net -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
