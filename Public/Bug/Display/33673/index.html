<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #33673 for SQL-Translator: [PATCH] - misc Pg parser improvements</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #33673 for SQL-Translator: [PATCH] - misc Pg parser improvements</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/SQL-Translator/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/SQL-Translator/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/SQL-Translator/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/SQL-Translator/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/SQL-Translator">SQL-Translator CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">33673</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/SQL-Translator/Active/">SQL-Translator</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
DROLSKY [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-29610-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-29611-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;28&nbsp;17:07:51&nbsp;2008</span>
    <span class="description">DROLSKY [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] - misc Pg parser improvements</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The attached patch implements a few improvements to the Pg parser ...

* Handles CREATE DOMAIN and CREATE TYPE ... AS ENUM - this is done by
dynamically extending the parser to register new types. For domains, the
returned data for the type is based on the underlying pg type of the
domain. This should work for translating to other database types, at least.

* The &#34;parens_word_list&#34; rule which was being used for parsing things
like column lists in foreign keys did not allow for quoted words, so it
failed to parse relatively simple foreign key definitions.

* Constraint names were being dropped entirely because of a little
buglet in the action.

I also added tests for all of the above.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> sqlt.diff</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ru ../SQL-Translator-0.0900/lib/SQL/Translator/Parser/PostgreSQL.pm ./lib/SQL/Translator/Parser/PostgreSQL.pm
--- ../SQL-Translator-0.0900/lib/SQL/Translator/Parser/PostgreSQL.pm	2008-02-21 04:26:58.000000000 -0600
+++ ./lib/SQL/Translator/Parser/PostgreSQL.pm	2008-02-28 16:03:24.000000000 -0600
@@ -272,6 +272,25 @@
 #
 # Create anything else &#40;e.g., domain, etc.&#41;
 #
+create : CREATE DOMAIN WORD /as/i data_type column_constraint&#40;?&#41; &#39;;&#39;
+    {
+        $thisparser-&gt;{local}{types}{ $item[3] } = $item{data_type};
+
+        $thisparser-&gt;Extend&#40; &#34;pg_data_type : &#39;$item[3]&#39; { \$return = \$thisparser-&gt;{local}{types}{ $item[3] } }&#34; &#41;;
+    }
+
+create : CREATE TYPE WORD /as/i /enum/i parens_value_list &#39;;&#39;
+    {
+        $thisparser-&gt;{local}{types}{ $item[3] } = {
+            type  =&gt; &#39;enum&#39;,
+            extra =&gt; {
+                allowed =&gt; [ map { s/^\&#39;|\&#39;$//g; $_ } @{ $item{parens_value_list} } ],
+            },
+        };
+
+        $thisparser-&gt;Extend&#40; &#34;pg_data_type : &#39;$item[3]&#39; { \$return = \$thisparser-&gt;{local}{types}{ $item[3] } }&#34; &#41;;
+    }
+
 create : CREATE WORD /[^;]+/ &#39;;&#39;
     { @table_comments = &#40;&#41;; }
 
@@ -385,6 +404,7 @@
             name              =&gt; $item{&#39;field_name&#39;}, 
             data_type         =&gt; $item{&#39;data_type&#39;}{&#39;type&#39;},
             size              =&gt; $item{&#39;data_type&#39;}{&#39;size&#39;},
+            extra             =&gt; $item{&#39;data_type&#39;}{&#39;extra&#39;},
             is_nullable       =&gt; $is_nullable,
             default           =&gt; $default-&gt;{&#39;value&#39;},
             constraints       =&gt; [ @constraints ],
@@ -441,7 +461,7 @@
     /primary key/i 
         { $return = { type =&gt; &#39;primary_key&#39; } }
     |
-    /check/i &#39;&#40;&#39; /[^&#41;]+/ &#39;&#41;&#39; 
+    /check/i &#39;&#40;&#39; /[^&#41;]+/ &#39;&#41;&#39;
         { $return = { type =&gt; &#39;check&#39;, expression =&gt; $item[3] } }
     |
     /references/i table_name parens_word_list&#40;?&#41; match_type&#40;?&#41; key_action&#40;s?&#41;
@@ -605,7 +625,7 @@
 parens_value_list : &#39;&#40;&#39; VALUE&#40;s /,/&#41; &#39;&#41;&#39;
     { $item[2] }
 
-parens_word_list : &#39;&#40;&#39; WORD&#40;s /,/&#41; &#39;&#41;&#39;
+parens_word_list : &#39;&#40;&#39; name_with_opt_quotes&#40;s /,/&#41; &#39;&#41;&#39;
     { $item[2] }
 
 field_size : &#39;&#40;&#39; num_range &#39;&#41;&#39; { $item{&#39;num_range&#39;} }
@@ -624,7 +644,7 @@
         my @comments   = &#40; @{ $item[1] }, @{ $item[-1] } &#41;;
 
         $return              =  {
-            name             =&gt; $item{&#39;constraint_name&#39;}[0] || &#39;&#39;,
+            name             =&gt; $item{&#39;constraint_name&#40;?&#41;&#39;}[0] || &#39;&#39;,
             supertype        =&gt; &#39;constraint&#39;,
             type             =&gt; $type,
             fields           =&gt; $type ne &#39;check&#39; ? $fields : [],
@@ -945,6 +965,10 @@
 
 COPY : /copy/i
 
+DOMAIN : /domain/i
+
+TYPE : /type/i
+
 INTEGER : /\d+/
 
 WORD : /\w+/
Only in .: RD_TRACE
diff -ru ../SQL-Translator-0.0900/t/14postgres-parser.t ./t/14postgres-parser.t
--- ../SQL-Translator-0.0900/t/14postgres-parser.t	2008-02-21 04:26:58.000000000 -0600
+++ ./t/14postgres-parser.t	2008-02-28 15:19:26.000000000 -0600
@@ -8,7 +8,7 @@
 use Test::SQL::Translator qw&#40;maybe_plan&#41;;
 
 BEGIN {
-    maybe_plan&#40;117, &#39;SQL::Translator::Parser::PostgreSQL&#39;&#41;;
+    maybe_plan&#40;129, &#39;SQL::Translator::Parser::PostgreSQL&#39;&#41;;
     SQL::Translator::Parser::PostgreSQL-&gt;import&#40;&#39;parse&#39;&#41;;
 }
 
@@ -40,6 +40,15 @@
         check &#40;f_int between 1 and 5&#41;
     &#41;;
 
+    create domain thingy as varchar&#40;200&#41;;
+
+    create type enumed as enum &#40; &#39;a&#39;, &#39;b&#39; &#41;;
+
+    create table t_test3 &#40;
+        f_domain  thingy,
+        f_enum    enumed
+    &#41;;
+
     alter table t_test1 add f_fk2 integer;
 
     alter table only t_test1 add constraint c_u1 unique &#40;f_varchar&#41;;
@@ -47,6 +56,9 @@
     alter table t_test1 add constraint &#34;c_fk2&#34; foreign key &#40;f_fk2&#41;
     references t_test2 &#40;f_id&#41; on update no action on delete cascade;
 
+    alter table &#34;t_test1&#34; add constraint &#34;c_fk3&#34; foreign key &#40;&#34;f_fk2&#34;&#41;
+    references &#34;t_test2&#34; &#40;&#34;f_id&#34;&#41; on update no action on delete cascade;
+
     alter table t_test1 drop column f_dropped restrict;
 
     alter table t_test1 alter column f_fk2 set default &#39;FOO&#39;;
@@ -76,11 +88,12 @@
 $| = 1;
 
 my $data   = parse&#40; $t, $sql &#41;;
+
 my $schema = $t-&gt;schema;
 
 isa_ok&#40; $schema, &#39;SQL::Translator::Schema&#39;, &#39;Schema object&#39; &#41;;
 my @tables = $schema-&gt;get_tables;
-is&#40; scalar @tables, 2, &#39;Two tables&#39; &#41;;
+is&#40; scalar @tables, 3, &#39;Three tables&#39; &#41;;
 
 my $t1 = shift @tables;
 is&#40; $t1-&gt;name, &#39;t_test1&#39;, &#39;Table t_test1 exists&#39; &#41;;
@@ -190,7 +203,7 @@
 # is&#40; $fk_ref2-&gt;reference_table, &#39;t_test2&#39;, &#39;FK is to &#34;t_test2&#34; table&#39; &#41;;
 
 my @t1_constraints = $t1-&gt;get_constraints;
-is&#40; scalar @t1_constraints, 8, &#39;8 constraints on t_test1&#39; &#41;;
+is&#40; scalar @t1_constraints, 9, &#39;9 constraints on t_test1&#39; &#41;;
 
 my $c1 = $t1_constraints[0];
 is&#40; $c1-&gt;type, PRIMARY_KEY, &#39;First constraint is PK&#39; &#41;;
@@ -208,12 +221,22 @@
 
 my $c4 = $t1_constraints[6];
 is&#40; $c4-&gt;type, FOREIGN_KEY, &#39;Fourth constraint is foreign key&#39; &#41;;
+is&#40; $c4-&gt;name, &#39;c_fk2&#39;, &#39;Fourth constraint is named &#34;c_fk2&#34;&#39; &#41;;
 is&#40; join&#40;&#39;,&#39;, $c4-&gt;fields&#41;, &#39;f_fk2&#39;, &#39;Constraint is on field &#34;f_fk2&#34;&#39; &#41;;
 is&#40; $c4-&gt;reference_table, &#39;t_test2&#39;, &#39;Constraint is to table &#34;t_test2&#34;&#39; &#41;;
 is&#40; join&#40;&#39;,&#39;, $c4-&gt;reference_fields&#41;, &#39;f_id&#39;, &#39;Constraint is to field &#34;f_id&#34;&#39; &#41;;
 is&#40; $c4-&gt;on_delete, &#39;cascade&#39;, &#39;On delete: cascade&#39; &#41;;
 is&#40; $c4-&gt;on_update, &#39;no_action&#39;, &#39;On delete: no action&#39; &#41;;
 
+my $c5 = $t1_constraints[7];
+is&#40; $c5-&gt;type, FOREIGN_KEY, &#39;Fifth constraint is foreign key&#39; &#41;;
+is&#40; $c5-&gt;name, &#39;c_fk3&#39;, &#39;Fifth constraint is named &#34;c_fk3&#34;&#39; &#41;;
+is&#40; join&#40;&#39;,&#39;, $c5-&gt;fields&#41;, &#39;f_fk2&#39;, &#39;Constraint is on field &#34;f_fk2&#34;&#39; &#41;;
+is&#40; $c5-&gt;reference_table, &#39;t_test2&#39;, &#39;Constraint is to table &#34;t_test2&#34;&#39; &#41;;
+is&#40; join&#40;&#39;,&#39;, $c5-&gt;reference_fields&#41;, &#39;f_id&#39;, &#39;Constraint is to field &#34;f_id&#34;&#39; &#41;;
+is&#40; $c5-&gt;on_delete, &#39;cascade&#39;, &#39;On delete: cascade&#39; &#41;;
+is&#40; $c5-&gt;on_update, &#39;no_action&#39;, &#39;On delete: no action&#39; &#41;;
+
 my $t2 = shift @tables;
 is&#40; $t2-&gt;name, &#39;t_test2&#39;, &#39;Table t_test2 exists&#39; &#41;;
 
@@ -255,3 +278,13 @@
 
 my $t2_c3 = shift @t2_constraints;
 is&#40; $t2_c3-&gt;type, CHECK_C, &#34;Constraint is a &#39;CHECK&#39;&#34; &#41;;
+
+my $t3 = shift @tables;
+is&#40; $t3-&gt;name, &#39;t_test3&#39;, &#39;Table t_test3 exists&#39; &#41;;
+
+my @t3_fields = $t3-&gt;get_fields;
+is&#40; scalar @t3_fields, 2, &#39;2 fields in t_test3&#39; &#41;;
+
+my $t3_f1 = shift @t3_fields;
+is&#40; $t3_f1-&gt;name, &#39;f_domain&#39;, &#39;First field is &#34;f_domain&#34;&#39; &#41;;
+is&#40; $t3_f1-&gt;data_type, &#39;varchar&#39;, &#39;First field is a &#34;varchar&#34;&#39; &#41;;
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
