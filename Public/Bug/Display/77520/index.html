<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #77520 for IO-Async: Make Heap an optional dependency</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #77520 for IO-Async: Make Heap an optional dependency</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/IO-Async/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/IO-Async/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/IO-Async/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/IO-Async/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/IO-Async">IO-Async CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">77520</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/IO-Async/Active/">IO-Async</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
leonerd-cpan [...] leonerd.org.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
berle [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-42614-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.49    </td>
  </tr>
  <tr id="CF-42615-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.50    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;29&nbsp;08:21:09&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Make Heap an optional dependency</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Heap is used by Ia::Internals::TimeQueue to implement an efficient queue
of pending timer events. Without it, we could write a trivial but
slightly less efficient implementation using an array, at a reschedule
cost of O&#40;n&#41; rather than O&#40;n log n&#41;.

By providing a two implementations and detecting at load time, we can
make this an optional dependency for smaller installs, but still allow
larger systems to take advantage of more efficient timers simply by
installing it.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;29&nbsp;08:35:16&nbsp;2012</span>
    <span class="description">berle [...] cpan.org -  Cc BERLE added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;01&nbsp;04:11:43&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue May 29 08:21:09 2012, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Heap is used by Ia::Internals::TimeQueue to implement an efficient queue
&gt; of pending timer events. Without it, we could write a trivial but
&gt; slightly less efficient implementation using an array, at a reschedule
&gt; cost of O&#40;n&#41; rather than O&#40;n log n&#41;.
</div>
Now patched as attached.

Could be made possibly slightly more efficient by using a binary search
+ splice to insert the new elements, but would require benchmarking to
see if that&#39;s actually better than the simple sort.

-- 

Paul Evans
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rt77520.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">=== modified file &#39;Build.PL&#39;
--- Build.PL	2012-05-29 12:16:32 +0000
+++ Build.PL	2012-06-01 08:08:46 +0000
@@ -9,7 +9,6 @@
       &#39;Async::MergePoint&#39; =&gt; &#39;0.03&#39;,
       &#39;CPS&#39; =&gt; 0,
       &#39;Exporter&#39; =&gt; &#39;5.57&#39;,
-      &#39;Heap&#39; =&gt; &#39;0.80&#39;,
       &#39;IO::Poll&#39; =&gt; 0,
       &#39;Socket&#39; =&gt; &#39;1.95&#39;,
       &#39;Storable&#39; =&gt; 0,

=== modified file &#39;lib/IO/Async/Internals/TimeQueue.pm&#39;
--- lib/IO/Async/Internals/TimeQueue.pm	2012-05-31 11:53:22 +0000
+++ lib/IO/Async/Internals/TimeQueue.pm	2012-06-01 08:08:46 +0000
@@ -8,22 +8,27 @@
 
 use strict;
 use warnings;
-use base qw&#40; Heap::Fibonacci &#41;;
 
 use Carp;
 
-use Heap::Fibonacci;
 use Time::HiRes qw&#40; time &#41;;
 
-sub next_time
-{
-   my $self = shift;
-
-   my $top = $self-&gt;top;
-
-   return defined $top ? $top-&gt;time : undef;
+BEGIN {
+   my @methods = qw&#40; next_time _enqueue cancel _fire &#41;;
+   if&#40; eval { require Heap::Fibonacci } &#41; {
+      unshift our @ISA, &#34;Heap::Fibonacci&#34;;
+      require Heap::Elem;
+      no strict &#39;refs&#39;;
+      *$_ = \&#38;{&#34;HEAP_$_&#34;} for @methods;
+   }
+   else {
+      no strict &#39;refs&#39;;
+      *$_ = \&#38;{&#34;ARRAY_$_&#34;} for &#34;new&#34;, @methods;
+   }
 }
 
+# High-level methods
+
 sub enqueue
 {
    my $self = shift;
@@ -35,13 +40,97 @@
    defined $params{time} or croak &#34;Expected &#39;time&#39;&#34;;
    my $time = $params{time};
 
+   $self-&gt;_enqueue&#40; $time, $code &#41;;
+}
+
+sub fire
+{
+   my $self = shift;
+   my &#40; %params &#41; = @_;
+
+   my $now = exists $params{now} ? $params{now} : time;
+   $self-&gt;_fire&#40; $now &#41;;
+}
+
+# Implementation using a Perl array
+
+use constant {
+   TIME =&gt; 0,
+   CODE =&gt; 1,
+};
+
+sub ARRAY_new
+{
+   my $class = shift;
+   return bless [], $class;
+}
+
+sub ARRAY_next_time
+{
+   my $self = shift;
+   return @$self ? $self-&gt;[0]-&gt;[TIME] : undef;
+}
+
+sub ARRAY__enqueue
+{
+   my $self = shift;
+   my &#40; $time, $code &#41; = @_;
+
+   # TODO: This could be more efficient maybe using a binary search insert
+   @$self = sort { $a-&gt;[TIME] &lt;=&gt; $b-&gt;[TIME] } @$self, my $elem = [ $time, $code ];
+   return $elem;
+}
+
+sub ARRAY_cancel
+{
+   my $self = shift;
+   my &#40; $id &#41; = @_;
+
+   @$self = grep { $_ != $id } @$self;
+}
+
+sub ARRAY__fire
+{
+   my $self = shift;
+   my &#40; $now &#41; = @_;
+
+   my $count = 0;
+
+   while&#40; @$self &#41; {
+      last if&#40; $self-&gt;[0]-&gt;[TIME] &gt; $now &#41;;
+
+      my $top = shift @$self;
+
+      $top-&gt;[CODE]-&gt;&#40;&#41;;
+      $count++;
+   }
+
+   return $count;
+}
+
+# Implementation using Heap::Fibonacci
+
+sub HEAP_next_time
+{
+   my $self = shift;
+
+   my $top = $self-&gt;top;
+
+   return defined $top ? $top-&gt;time : undef;
+}
+
+sub HEAP__enqueue
+{
+   my $self = shift;
+   my &#40; $time, $code &#41; = @_;
+
    my $elem = IO::Async::Internals::TimeQueue::Elem-&gt;new&#40; $time, $code &#41;;
    $self-&gt;add&#40; $elem &#41;;
 
    return $elem;
 }
 
-sub cancel
+sub HEAP_cancel
 {
    my $self = shift;
    my &#40; $id &#41; = @_;
@@ -49,12 +138,10 @@
    $self-&gt;delete&#40; $id &#41;;
 }
 
-sub fire
+sub HEAP__fire
 {
    my $self = shift;
-   my &#40; %params &#41; = @_;
-
-   my $now = exists $params{now} ? $params{now} : time;
+   my &#40; $now &#41; = @_;
 
    my $count = 0;
 
@@ -74,7 +161,7 @@
   IO::Async::Internals::TimeQueue::Elem;
 
 use strict;
-use base qw&#40; Heap::Elem &#41;;
+our @ISA = qw&#40; Heap::Elem &#41;;
 
 sub new
 {

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;01&nbsp;04:11:44&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;new&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;20&nbsp;06:29:09&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Now released as part of 0.50

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;20&nbsp;06:29:09&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;20&nbsp;06:29:09&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;20&nbsp;06:29:18&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Fixed in 0.50 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
