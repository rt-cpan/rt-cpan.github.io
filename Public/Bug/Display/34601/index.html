<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #34601 for CGI-Application-Plugin-Session: Update to use instance &#39;name&#39; attribute of CGI::Session v4.29+</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #34601 for CGI-Application-Plugin-Session: Update to use instance &#39;name&#39; attribute of CGI::Session v4.29+</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/CGI-Application-Plugin-Session/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/CGI-Application-Plugin-Session/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/CGI-Application-Plugin-Session/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/CGI-Application-Plugin-Session/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/CGI-Application-Plugin-Session">CGI-Application-Plugin-Session CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">34601</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/CGI-Application-Plugin-Session/Active/">CGI-Application-Plugin-Session</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
lecar_red [...] yahoo.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-5514-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.03    </td>
  </tr>
  <tr id="CF-5515-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;01&nbsp;17:29:35&nbsp;2008</span>
    <span class="description">lecar_red [...] yahoo.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Update to use instance &#39;name&#39; attribute of CGI::Session v4.29+</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The current version of CAP::Session uses the class method &#39;name&#39; from
CGI::Session. In CGI::Session versions 4.29+, this is
changeable as a constructor parameter for the object instead of for the
whole class.

The attached patch and tests, change over the internal calls to using
the created instance value when possible. The patch also includes code
to try to locate the &#39;name&#39; constructor parameter for support of some
non-CGI.pm query objects.

The patches include an update for the documentation of the module.

My tests of these patches and tests work with CGI::Session 4.29_2 and 4.20.

Thanks for your time.
 
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> TestAppSessionCookieName.pm</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">package TestAppSessionCookieName;

use warnings;
use strict;

use CGI::Application;
use CGI::Application::Plugin::Session;

@TestAppSessionCookieName::ISA = qw&#40;CGI::Application&#41;;

sub cgiapp_init {
    my $self = shift;

    $self-&gt;session_config&#40;
        {   CGI_SESSION_OPTIONS =&gt;
                [ &#34;driver:File&#34;, $self-&gt;query, { Directory =&gt; &#39;t/&#39; },
				{ name =&gt; &#39;foobar&#39; }
				],
            SEND_COOKIE    =&gt; 1,
            DEFAULT_EXPIRY =&gt; &#39;+1h&#39;
        }
    &#41;;
}

sub setup { 
	my $self = shift;
	$self-&gt;start_mode&#40; &#39;test_mode&#39; &#41;;
	$self-&gt;run_modes&#40; 
		[ qw&#40; test_mode &#41; ]
	&#41;;
}

sub test_mode {
	my $self    = shift;
	my $session = $self-&gt;session;

	return &#34;session: &#34; . $session-&gt;id . &#34;\n&#34;;
}

1;

</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 13_sessioncookiename.t</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
use warnings;
use strict;

use lib qw&#40; t &#41;;
use Test::More;

$ENV{CGI_APP_RETURN_ONLY} = 1;

BEGIN {
    use_ok &#39;CGI::Application::Plugin::Session&#39;;
}

## only run tests on newer CGI:Session versions
$CGI::Session::VERSION &lt;= 4.20 ? 
	plan skip_all =&gt; &#34;Older version CGI::Session&#34; :
	plan tests =&gt; 2; 

## need for the tests
use CGI; 
use TestAppSessionCookieName;

{
	my $t1_obj = TestAppSessionCookieName-&gt;new&#40; QUERY =&gt; CGI-&gt;new &#41;;
	my $t1_out = $t1_obj-&gt;run;

	like $t1_out, qr/session:/, &#39;session in output&#39;;
	like $t1_out, qr/Set-Cookie: foobar=[a-zA-Z0-9]+/, &#39;session cookie with custom name&#39;;
}
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Session.pm.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Orig.Session.pm	2008-03-02 07:52:27.000000000 -0500
+++ Session.pm	2008-04-01 17:05:16.475469000 -0400
@@ -37,10 +37,11 @@
                         &#40;&#39;driver:File&#39;, $self-&gt;query, {Directory=&gt;File::Spec-&gt;tmpdir}&#41;;
 
 
-        # CGI::Session only works properly with CGI.pm so extract the sid manually if
-        # another module is being used
+        # CGI::Session only works properly with CGI.pm so 
+		# extract the sid manually if another module is being used
         if &#40;Scalar::Util::blessed&#40;$params[1]&#41; &#38;&#38; ! $params[1]-&gt;isa&#40;&#39;CGI&#39;&#41;&#41; {
-            my $sid = $params[1]-&gt;cookie&#40;CGI::Session-&gt;name&#41; || $params[1]-&gt;param&#40;CGI::Session-&gt;name&#41;;
+			my $name = __locate_session_name&#40; $self &#41;; ## plugin method call
+            my $sid  = $params[1]-&gt;cookie&#40;$name&#41; || $params[1]-&gt;param&#40;$name&#41;;
             $params[1] = $sid;
         }
 
@@ -62,7 +63,10 @@
         #  or if the session has an expiry set on it
         #  but don&#39;t send it if SEND_COOKIE is set to 0
         if &#40;!defined $self-&gt;{__CAP__SESSION_CONFIG}-&gt;{SEND_COOKIE} || $self-&gt;{__CAP__SESSION_CONFIG}-&gt;{SEND_COOKIE}&#41; {
-            my $cid = $self-&gt;query-&gt;cookie&#40;CGI::Session-&gt;name&#41;;
+            my $cid = $self-&gt;query-&gt;cookie&#40;
+				$self-&gt;{__CAP__SESSION_OBJ}-&gt;name
+			&#41;;
+
             if &#40;!$cid || $cid ne $self-&gt;{__CAP__SESSION_OBJ}-&gt;id || $self-&gt;{__CAP__SESSION_OBJ}-&gt;expire&#40;&#41;&#41; {
                 session_cookie&#40;$self&#41;;
             }
@@ -128,7 +132,16 @@
         my $tmp = $self-&gt;session;
     }
 
-    $options{&#39;-name&#39;}    ||= CGI::Session-&gt;name;
+	## check cookie option -name with session name
+	## if different these may cause problems/confusion
+	if &#40; exists $options{&#39;-name&#39;} and
+		 $options{&#39;-name&#39;} ne $self-&gt;session-&gt;name &#41; { 
+		warn sprintf&#40; &#34;Cookie &#39;%s&#39; and Session &#39;%s&#39; name don&#39;t match.\n&#34;, 
+			$options{&#39;-name&#39;}, $self-&gt;session-&gt;name &#41;
+	}
+
+    ## setup the values for cookie
+    $options{&#39;-name&#39;}    ||= $self-&gt;session-&gt;name;
     $options{&#39;-value&#39;}   ||= $self-&gt;session-&gt;id;
     if&#40;defined&#40;$self-&gt;session-&gt;expires&#40;&#41;&#41; &#38;&#38; !defined&#40;$options{&#39;-expires&#39;}&#41;&#41; {
         $options{&#39;-expires&#39;} = _build_exp_time&#40; $self-&gt;session-&gt;expires&#40;&#41; &#41;;
@@ -181,7 +194,8 @@
             if &#40; $self-&gt;{&#39;__CAP__SESSION_CONFIG&#39;}-&gt;{&#39;COOKIE_PARAMS&#39;} &#41; {
                 %options = &#40; %{ $self-&gt;{&#39;__CAP__SESSION_CONFIG&#39;}-&gt;{&#39;COOKIE_PARAMS&#39;} }, %options &#41;;
             }
-            $options{&#39;name&#39;} ||= CGI::Session-&gt;name;
+
+            $options{&#39;name&#39;} ||= $session-&gt;name;
             $options{&#39;value&#39;}    = &#39;&#39;;
             $options{&#39;-expires&#39;} = &#39;-1d&#39;;
             my $newcookie = $self-&gt;query-&gt;cookie&#40;%options&#41;;
@@ -195,7 +209,8 @@
             my $cookies = $headers{&#39;-cookie&#39;} || [];
             $cookies = [$cookies] unless ref $cookies eq &#39;ARRAY&#39;;
             foreach my $cookie &#40;@$cookies&#41; {
-                if &#40; ref&#40;$cookie&#41; ne &#39;CGI::Cookie&#39; || $cookie-&gt;name ne CGI::Session-&gt;name &#41; {
+                if &#40; ref&#40;$cookie&#41; ne &#39;CGI::Cookie&#39; || 
+					$cookie-&gt;name ne $session-&gt;name &#41; {
                     # keep this cookie
                     push @keep, $cookie;
                 }
@@ -241,6 +256,22 @@
     return 1;
 }
 
+## all a hack to adjust for problems with cgi::session and 
+## it not playing with non-CGI.pm objects
+sub __locate_session_name {
+	my $self = shift;
+	my $sess_opts = $self-&gt;{__CAP__SESSION_CONFIG}-&gt;{CGI_SESSION_OPTIONS}; 
+
+	## search for &#39;name&#39; cgi session option
+	if &#40; $sess_opts and $sess_opts-&gt;[4] 
+		 and ref $sess_opts-&gt;[4] eq &#39;HASH&#39; 
+		 and exists $sess_opts-&gt;[4]-&gt;{name} &#41; {
+		return $sess_opts-&gt;[4]-&gt;{name};
+	}
+
+	return CGI::Session-&gt;name;
+}
+
 1;
 __END__
 
@@ -248,7 +279,6 @@
 
 CGI::Application::Plugin::Session - Add CGI::Session support to CGI::Application
 
-
 =head1 SYNOPSIS
 
  use CGI::Application::Plugin::Session;
@@ -331,8 +361,23 @@
 you specifically override them by providing -name and/or -value parameters.
 See the L&lt;CGI::Cookie&gt; docs for the exact syntax of the parameters.
 
-NOTE:  If you change the name of the cookie by passing a -name parameter, remember to notify
-CGI::Session of the change by calling CGI::Session-&gt;name&#40;&#39;new_cookie_name&#39;&#41;.
+NOTE: If you have CGI::Session version 4.29 or newer the &#39;-name&#39; paremeter is not longer necessary. You can do the following to get both the cookie name and the internal name of the CGI::Session object to be changed:
+
+  $self-&gt;session_config&#40; 
+    CGI_SESSION_OPTIONS =&gt; [ 
+      $driver, 
+      $self-&gt;query, 
+      \%driver_options, 
+      { name =&gt; &#39;new_cookie_name&#39; } # change cookie and session name
+    ]
+  &#41;;
+
+For older version of CGI::Session, you still change the name of the cookie 
+by passing a -name parameter, remember to notify CGI::Session of the change 
+by calling CGI::Session-&gt;name&#40;&#39;new_cookie_name&#39;&#41;. 
+
+Also, if &#39;-name&#39; parameter and &#39;name&#39; of session don&#39;t match a warning will
+be emitted.
 
 =item SEND_COOKIE
 
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 12_badconfig.t</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use lib &#39;./t&#39;;
use Test::More;

BEGIN {
    eval { require Test::Exception; Test::Exception-&gt;import; };
    if &#40;$@&#41; {
        plan skip_all =&gt; &#39;These tests require Test::Exception&#39;;
    }
    else {
        plan tests =&gt; 1;
    }
}

{

    package TestAppBadConfig;
    @TestAppBadConfig::ISA = qw&#40;CGI::Application&#41;;
    use CGI::Application::Plugin::Session;
};

my $app = TestAppBadConfig-&gt;new&#40;&#41;;
$app-&gt;session_config&#40;
    CGI_SESSION_OPTIONS =&gt; [ &#34;driver:invalid_driver&#34;, $app-&gt;query ] &#41;;

dies_ok&#40; sub { $app-&gt;session },
    &#39;creation of CGI::Session object fails with a bad config&#39; &#41;;

## sub our own testing warn handler
my $warning;
$SIG{&#39;__WARN__&#39;} = sub { $warning = join &#39; &#39;, @_ };

## mismatch cookie name and session name
my $app2 = TestAppBadConfig-&gt;new&#40;&#41;;
$app2-&gt;session_config&#40;
    CGI_SESSION_OPTIONS =&gt; [
        &#34;driver:File&#34;, &#39;1111&#39;, { Directory =&gt; &#39;t/&#39; }, { name =&gt; &#39;foobar&#39; }
    ],
    COOKIE_PARAMS =&gt; { -name =&gt; &#39;monkeybeard&#39; }
&#41;;

## should generate warning
$app2-&gt;session;

ok $warning, &#34;cookie and session name don&#39;t match&#34;;
like $warning, qr/Cookie.*?Session/;

1;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;14&nbsp;11:49:49&nbsp;2013</span>
    <span class="description">frioux [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">released with 1.04
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;14&nbsp;11:49:49&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;14&nbsp;11:49:51&nbsp;2013</span>
    <span class="description">frioux [...] gmail.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
