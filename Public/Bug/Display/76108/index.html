<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #76108 for Net-FTPSSL: Reuse of SSL session for Data connection</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #76108 for Net-FTPSSL: Reuse of SSL session for Data connection</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-FTPSSL/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-FTPSSL/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-FTPSSL/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-FTPSSL/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-FTPSSL">Net-FTPSSL CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">76108</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-FTPSSL/Active/">Net-FTPSSL</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
benjamin [...] boerngen-schmidt.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-22628-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.21    </td>
  </tr>
  <tr id="CF-22629-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.29    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




FTPSSL.pm<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1511365/805852/FTPSSL.pm">
Thu Jun 25 14:04:51 2015 (153.3k) by CLEACH [...] cpan.org
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1505719/802452/FTPSSL.pm">
Mon Jun 08 17:41:55 2015 (152.7k) by CLEACH [...] cpan.org
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1504298/801641/FTPSSL.pm">
Fri Jun 05 13:27:17 2015 (152.5k) by CLEACH [...] cpan.org
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1503917/801418/FTPSSL.pm">
Thu Jun 04 19:55:00 2015 (152.2k) by CLEACH [...] cpan.org
</a>
</font></li>
</ul>


myLogfile.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1504377/801694/myLogfile.txt">
Fri Jun 05 15:31:58 2015 (8.4k) by forrestt [...] usa.net
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1504148/801561/myLogfile.txt">
Fri Jun 05 11:05:47 2015 (8.2k) by forrestt [...] usa.net
</a>
</font></li>
</ul>


sslLog.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1112723/585257/sslLog.txt">
Fri Aug 24 08:42:22 2012 (2.8k) by j.gruber [...] primacom.net
</a>
</font></li>
</ul>


sslLog.txt-with-own-context<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1112728/585264/sslLog.txt-with-own-context">
Fri Aug 24 09:16:03 2012 (3.6k) by j.gruber [...] primacom.net
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;27&nbsp;18:01:05&nbsp;2012</span>
    <span class="description">benjamin [...] boerngen-schmidt.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Reuse of SSL session for Data connection</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 28 Mar 2012 00:00:47 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-FTPSSL [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Benjamin Börngen-Schmidt &lt;benjamin [...] boerngen-schmidt.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi there,

I don&#39;t know if it is a bug or a limitation but I&#39;m not able to connect 
to a proftpd server ver. 1.3.3 until I set &#34;TLSOptions 
NoSessionReuseRequired&#34;.

Log from proftpd:
mod_tls/2.4.2[22028]: Protection set to Private
mod_tls/2.4.2[22028]: starting TLS negotiation on data connection
mod_tls/2.4.2[22028]: TLSv1/SSLv3 renegotiation accepted, using cipher 
DHE-RSA-AES256-SHA &#40;256 bits&#41;
mod_tls/2.4.2[22028]: client did not reuse SSL session, rejecting data 
connection &#40;see TLSOption NoSessionReuseRequired&#41;

Regards
Benjamin
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;29&nbsp;17:21:17&nbsp;2012</span>
    <span class="description">CLEACH [...] cpan.org -  Broken in 0.21 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;29&nbsp;17:21:17&nbsp;2012</span>
    <span class="description">CLEACH [...] cpan.org -  Severity Normal added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;29&nbsp;18:08:51&nbsp;2012</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Benjamin,

This is a known limitation I hit while I was trying to get certificates
to work at all for the data channel last year.  I was never quite sure
if I was configuring my server incorrectly or I had issues with my
client code or if it was a problem with IO::Socket::SSL or if I was just
using the wrong IO::Socket::SSL options with SSL_Client_Certificate.  So
I just gave up on it in order to get v0.18 out.  The person asking for
this feature didn&#39;t need the session reuse option.  And I haven&#39;t had
the opportunity to revisit the issue since then.

But I&#39;ll be glad to look into it again if you can return the log files
generated by my code.

And since we&#39;ll be dealing with very low level functionality on my end,
I&#39;m going to give you some extra instructions to get more detailed
client logs than I usually ask for.

use IO::Socket::SSL qw&#40;debug3&#41;;     # Turn on verbose SSL logging

open &#40;STDERR, &#34;&gt; myLogfile.txt&#34;&#41;;   # Redirect STDERR to a log file.

# Turns logging on to STDERR for Net::FTPSSL ...
my $ftps = Net::FTPSSL-&gt;new &#40;server, ..., Debug=&gt;1&#41;;

This will make sure I have all possible client side logging available.

Let me know what options you are using for the SSL_Client_Certificate
option.  Since that&#39;s more than likely part of the issue.  When I create
the data channel, I use just the SSL_reuse_ctx option, which re-uses the
context of the command channel.  So I&#39;ll have to look into what else is
needed to reuse the session.

Also please let me know what version of IO::Socket::SSL you are using. 
That will probably be critical.

I look forward to hearing back from you.

Curtis

On Tue Mar 27 18:01:05 2012, benjamin@boerngen-schmidt.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi there,
&gt; 
&gt; I don&#39;t know if it is a bug or a limitation but I&#39;m not able to connect 
&gt; to a proftpd server ver. 1.3.3 until I set &#34;TLSOptions 
&gt; NoSessionReuseRequired&#34;.
&gt; 
&gt; Log from proftpd:
&gt; mod_tls/2.4.2[22028]: Protection set to Private
&gt; mod_tls/2.4.2[22028]: starting TLS negotiation on data connection
&gt; mod_tls/2.4.2[22028]: TLSv1/SSLv3 renegotiation accepted, using cipher 
&gt; DHE-RSA-AES256-SHA &#40;256 bits&#41;
&gt; mod_tls/2.4.2[22028]: client did not reuse SSL session, rejecting data 
&gt; connection &#40;see TLSOption NoSessionReuseRequired&#41;
&gt; 
&gt; Regards
&gt; Benjamin
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;29&nbsp;18:08:52&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;24&nbsp;08:42:22&nbsp;2012</span>
    <span class="description">j.gruber [...] primacom.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> j.gruber [...] primacom.net</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Curtis,

just chiming in as I hit the wall with this bug as well. 

Attached you will find the logfile as requested. It was created as per 
your instructions. Let me know if you need more.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Let me know what options you are using for the SSL_Client_Certificate
&gt; option. 
</div>
None so far

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I use just the SSL_reuse_ctx option, which re-uses the
&gt; context of the command channel.  So I&#39;ll have to look into what else
&gt; is needed to reuse the session.
</div>
I am already using this option &#40;Session reuse didn&#39;t work before, so I 
tried to get it to work by myself&#41;:

&lt;snip&gt;

    $context = new IO::Socket::SSL::SSL_Context&#40;
                        SSL_version =&gt; &#39;tlsv1&#39;,
                        SSL_verify_mode =&gt; Net::SSLeay::VERIFY_NONE&#40;&#41;,
                        SSL_session_cache_size =&gt; 10
               &#41;;
    $handle = Net::FTPSSL-&gt;new&#40; 
                                $server,
                                Encryption =&gt; IMP_CRYPT,
                                Debug =&gt; $debugTransfer,
                                OverridePASV =&gt; $server,
                                SSL_reuse_ctx =&gt; $context,
                              &#41;;
&lt;/snip&gt;

No luck so far, I am preparing to dive into FTPSSL.pm as I type this.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Also please let me know what version of IO::Socket::SSL you are using. 
&gt; That will probably be critical.
</div>
IO::Socket::SSL Version is 1.33 &#40;Debian Squeeze System&#41;

PS: I tried all previous versions down to 0.17. They all exhibited the 
same behavior &#40;session reuse didn&#39;t work&#41;.

Best regards,
Jan
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> sslLog.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">DEBUG: .../IO/Socket/SSL.pm:1464: new ctx 43430256

Net-FTPSSL Version: 0.22

Perl: 5.010001  [5.10.1],  OS: linux

Server &#40;port&#41;: 81.210.128.101 &#40;990&#41;

Keys: &#40;OverridePASV&#41;, &#40;SSL_reuse_ctx&#41;, &#40;Debug&#41;, &#40;Encryption&#41;
Values: &#40;xx.xxx.xxx.xxx&#41;, &#40;IO::Socket::SSL::SSL_Context=HASH&#40;0x2a71258&#41;&#41;, &#40;2&#41;, &#40;I&#41;

DEBUG: .../IO/Socket/SSL.pm:1464: new ctx 45063840
DEBUG: .../IO/Socket/SSL.pm:938: start handshake
DEBUG: .../IO/Socket/SSL.pm:347: ssl handshake not started
DEBUG: .../IO/Socket/SSL.pm:378: set socket to non-blocking to enforce timeout=120
DEBUG: .../IO/Socket/SSL.pm:390: Net::SSLeay::connect -&gt; -1
DEBUG: .../IO/Socket/SSL.pm:400: ssl handshake in progress
DEBUG: .../IO/Socket/SSL.pm:410: waiting for fd to become ready: SSL wants a read first
DEBUG: .../IO/Socket/SSL.pm:430: socket ready, retrying connect
DEBUG: .../IO/Socket/SSL.pm:390: Net::SSLeay::connect -&gt; -1
DEBUG: .../IO/Socket/SSL.pm:400: ssl handshake in progress
DEBUG: .../IO/Socket/SSL.pm:410: waiting for fd to become ready: SSL wants a read first
DEBUG: .../IO/Socket/SSL.pm:430: socket ready, retrying connect
DEBUG: .../IO/Socket/SSL.pm:390: Net::SSLeay::connect -&gt; 1
DEBUG: .../IO/Socket/SSL.pm:445: ssl handshake done
&lt;&lt;&lt; 220 Welcome to xxxxxxxxxxx
&gt;&gt;&gt; USER +++++++
&lt;&lt;&lt; 331 Please specify the password.
&gt;&gt;&gt; PASS *******
&lt;&lt;&lt; 230 Login successful.
DEBUG: .../IO/Socket/SSL.pm:1500: free ctx 43430256 open=45063840 43430256
DEBUG: .../IO/Socket/SSL.pm:1508: OK free ctx 43430256
&gt;&gt;&gt; PWD
&lt;&lt;&lt; 257 &#34;/&#34;
&gt;&gt;&gt; CWD /Transmit/Content
&lt;&lt;&lt; 250 Directory successfully changed.
&gt;&gt;&gt; PBSZ 0
&lt;&lt;&lt; 200 PBSZ set to 0.
&gt;&gt;&gt; PROT P
&lt;&lt;&lt; 200 PROT now Private.
&gt;&gt;&gt; PASV
&lt;&lt;&lt; 227 Entering Passive Mode &#40;172,21,2,70,47,53&#41;.
--- Overriding PASV IP Address 172.21.2.70 with 81.210.128.101
--- Host &#40;81.210.128.101&#41;  Port &#40;12085&#41;
&gt;&gt;&gt; LIST
&lt;&lt;&lt; 150 Here comes the directory listing.
&lt;&lt;&lt; 522 SSL connection failed; session reuse required: see require_ssl_reuse option in vsftpd.conf man page
&gt;&gt;&gt; CWD /
&lt;&lt;&lt; 250 Directory successfully changed.
&gt;&gt;&gt; MKD /Transmit/Content/SILV20121000000018
&lt;&lt;&lt; 550 Create directory operation failed.
DEBUG: .../IO/Socket/SSL.pm:1500: free ctx 45063840 open=45063840
DEBUG: .../IO/Socket/SSL.pm:1508: OK free ctx 45063840


###########################################
Manual addition of cmdline output

got 0:0 bytes &#40;VM=vm_unknown&#41;.
 at blib/lib/Net/SSLeay.pm &#40;autosplit into blib/lib/auto/Net/SSLeay/debug_read.al&#41; line 1836
        Net::SSLeay::debug_read&#40;&#39;SCALAR&#40;0x2aa1960&#41;&#39;, &#39;SCALAR&#40;0x2aa1870&#41;&#39;&#41; called at blib/lib/Net/SSLeay.pm &#40;autosplit into blib/lib/auto/Net/SSLeay/ssl_read_all.al&#41; line 1854
        Net::SSLeay::ssl_read_all&#40;44269888, 10240&#41; called at /usr/lib/perl5/Net/SSLeay/Handle.pm line 128
        Net::SSLeay::Handle::READ&#40;&#39;Net::SSLeay::Handle=HASH&#40;0x2aa0c48&#41;&#39;, undef, 10240&#41; called at /usr/local/share/perl/5.10.1/Net/FTPSSL.pm line 591
        Net::FTPSSL::list&#40;&#39;Net::FTPSSL=GLOB&#40;0x29f9f30&#41;&#39;&#41; called at /usr/local/lib/site_perl/.....
&lt;snip&gt;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;24&nbsp;09:16:03&nbsp;2012</span>
    <span class="description">j.gruber [...] primacom.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> j.gruber [...] primacom.net</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Addendum:

A brief excursion into FTPSSL.pm showed that session_reuse is triggered 
only when SSL_Client_Certificate or SSL_Advanced Hashes are present in 
the constructor. Since this is not the case with my code I patched 
FTPSSL.pm at line 291 to get it to work. 

+      &#40;exists &#40;$arg-&gt;{SSL_reuse_ctx}&#41;&#41; ||

The resulting logfile is attached.

Best regards,
Jan
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> sslLog.txt-with-own-context</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1112728/585264/sslLog.txt-with-own-context">Download sslLog.txt-with-own-context</a><br />
<span class="downloadcontenttype">application/octet-stream 3.6k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;28&nbsp;13:06:00&nbsp;2012</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Jan,

Sorry to take so long to respond.

Your issue was slightly different than the original issue.  Sessions &#38;
context are different things.  Context was the easy one to solve.

Based on your comments &#38; logs, you were trying to re-use context without
using certificates.  And from your comments below that you only modified
one line of code, you could have gotten the exact same results without
modifying the code at all by doing the following in your call to new.

my %emptyHash;
my $ftps = Net::FTPSSL-&gt;new &#40;$server, 
                SSL_Client_Certificate =&gt; \%emptyHash, ...&#41;;

It&#39;s the presence of this option, whether there is anything in the hash
or not, that triggers the use of the reuse context for the data channel.

While the main purpose of SSL_Client_Certificate is to allow you to use
certificates, it&#39;s not it&#39;s only possible use.  I&#39;ll rework the POD text
for this option to make that clearer and to make sure this trick is
mentioned in future releases.

Curtis


On Fri Aug 24 09:16:03 2012, htuttle wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Addendum:
&gt; 
&gt; A brief excursion into FTPSSL.pm showed that session_reuse is triggered 
&gt; only when SSL_Client_Certificate or SSL_Advanced Hashes are present in 
&gt; the constructor. Since this is not the case with my code I patched 
&gt; FTPSSL.pm at line 291 to get it to work. 
&gt; 
&gt; +      &#40;exists &#40;$arg-&gt;{SSL_reuse_ctx}&#41;&#41; ||
&gt; 
&gt; The resulting logfile is attached.
&gt; 
&gt; Best regards,
&gt; Jan
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;30&nbsp;06:08:51&nbsp;2012</span>
    <span class="description">j.gruber [...] primacom.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> j.gruber [...] primacom.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Curtis,

On Tue Aug 28 13:06:00 2012, CLEACH wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Jan,
&gt; 
&gt; Sorry to take so long to respond.
</div>Don&#39;t worry, it&#39;s your spare time ... 

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Your issue was slightly different than the original issue.  Sessions &#38;
&gt; context are different things.  Context was the easy one to solve.
&gt; 
&gt; Based on your comments &#38; logs, you were trying to re-use context     
&gt; without using certificates.  
</div>
Maybe I have context and session reuse mixed up. I have got bitten by 
the ssl  session reuse bug &#40;I have to connect to a FTPS Server who 
requires session reuse for data channels&#41;. 

The only thing in the documentation that had the word &#34;reuse&#34; in it was 
the context thing, so I went to try it out. If that is the wrong route I 
apologize for causing confusion. What can I do to help to solve the 
session reuse problem?

I will try the failed upload from a different server with another linux 
distro to exclude the possibility of problems with the GNUTLS/OpenSSL 
libraries on Debian.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;05&nbsp;02:44:13&nbsp;2012</span>
    <span class="description">j.gruber [...] primacom.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> j.gruber [...] primacom.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The OpenSSL/GNUTLS libraries seem not to be the problem. I uploaded the 
data from the same system to the same target as previously tried with the 
&#34;lftp&#34; client and succeeded. This means that session reuse works in 
principle &#40;at least with GNUTLS&#41;. Which libraries is FTPSSL using? 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;05&nbsp;13:23:42&nbsp;2012</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Jan,

Glad to see that you were still looking into it.  My test server has
crashed and I&#39;ve had no chance lately to look into whats wrong with it.
 It&#39;s beginning to look like I&#39;ll have to reinstall everything from scratch.

Net::FTPSSL inherits from IO::Socket::SSL and I&#39;m guessing that I&#39;m
missing an option there to reuse sessions.  But I currently don&#39;t know
what those option&#40;s&#41; may be.  I have a sneaking suspicion that reuse
context isn&#39;t enough even if we add more options using
SSL_Client_Certificate.

My best guess is it&#39;s a combination of the following 3 options:
SSL_session_cache_size, SSL_session_cache or SSL_session_id_context.

If you can provide me a command trace from your successful test with the
&#34;lftp&#34; client, that might help me a lot.

Curtis


On Wed Sep 05 02:44:13 2012, htuttle wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The OpenSSL/GNUTLS libraries seem not to be the problem. I uploaded the 
&gt; data from the same system to the same target as previously tried with the 
&gt; &#34;lftp&#34; client and succeeded. This means that session reuse works in 
&gt; principle &#40;at least with GNUTLS&#41;. Which libraries is FTPSSL using? 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;20&nbsp;04:32:08&nbsp;2012</span>
    <span class="description">j.gruber [...] primacom.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> j.gruber [...] primacom.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Curtis,

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If you can provide me a command trace from your successful test with 
</div>the
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#34;lftp&#34; client, that might help me a lot.
</div>
unfortunately lftp doesn&#39;t provide a debug log/cmd trace wrt to SSL 
activities. I will continue to look for a way to provide you with the 
necessary information.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;13&nbsp;11:58:09&nbsp;2015</span>
    <span class="description">forrestt [...] usa.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #76108]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 13 May 2015 11:57:57 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-Net-FTPSSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Forrest Tiffany&#34; &lt;forrestt [...] usa.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza"><div style="font-family: verdana,arial,helvetica,sans-serif; font-size: 10pt; color: #000000;">
I know this is an old bug, but I needed to support session reuse in a project I'm working on.&nbsp; I have it working (although a bit of a kludge).&nbsp; Here is a diff of FTPSSL.pm:
<br>
<br>269a270,271
<br>&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $cache = IO::Socket::SSL::Session_Cache-&gt;new(10);
<br>&gt;
<br>282a285,286
<br>&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ssl_args{SSL_session_cache} = $cache;
<br>&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ssl_args{SSL_session_key} = 'abcd1234';
<br>657a662
<br>&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ssl_opts{SSL_session_key} = 'abcd1234';
<br>
<br>
<br> I used 'abcd1234' as the session key because I couldn't quickly figure out how to access the original host/port to give the line at #662 the original values to reuse (i.e. "$commandChannelHost:$commandChannelPort").&nbsp; This should point you in the right direction though.
<br>
<br>Forrest
<br>

<br>
</div>




</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;28&nbsp;11:29:40&nbsp;2015</span>
    <span class="description">forrestt [...] usa.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #76108]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 28 May 2015 11:29:22 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-Net-FTPSSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Forrest Tiffany&#34; &lt;forrestt [...] usa.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;28&nbsp;11:56:20&nbsp;2015</span>
    <span class="description">forrestt [...] usa.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #76108]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 28 May 2015 11:56:01 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-Net-FTPSSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Forrest Tiffany&#34; &lt;forrestt [...] usa.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt;   Hi Forrest,
 &gt;    
 &gt;   Thank you for using my module and taking the time to open a new CPAN bug
</div>report and submitting
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt;   a patch.
 &gt;    
 &gt;   I&#39;ll look into it as soon as I can. In the meantime, can you please give
</div>me a trace using your
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt;   patch so that I can follow your logs on what is happening?
 &gt;    
 &gt;   This will give me some needed information on implementing it. Including
</div>the version of my software
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt;   you are using. Also can you please let me know what version of
</div>IO::Socket::SSL you are using?
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt;   My logs don&#39;t currently tell me that.
 &gt;    
 &gt;   Try doing this in your sample program:
 &gt;    
 &gt;   use IO::Socket::SSL qw &#40;debug3&#41;: # Turns on verbose SSL loging.
 &gt;   use Net::FTPSSL;
 &gt;    
 &gt;   open &#40;STDERR, &#34;&gt; myLogfile.txt&#34;&#41;; # Redirects STDERR to this file.
 &gt;   $ftps = Net::FTPSSL-&gt;new &#40;$server, ..., Debug=&gt;1&#41;;
 &gt;   $ftps-&gt;trapWarn &#40;&#41;;
 &gt;   $ftps-&gt;login &#40;user,pwd&#41;;
 &gt;   $ftps-&gt;nlst&#40;&#41;;
 &gt;   $ftps-&gt;quit&#40;&#41;;
 &gt;    
 &gt;   The above code snippet should be enough to demonstrate your patch in
</div>action &#38; the logs should help
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt;   me out a lot.
 &gt;    
 &gt;   Thanks
 &gt;    
 &gt;   Curtis
</div>     
   
Sorry it has taken so long to get back to you.  Life gets in the way of
progress at times.  Here is the short program that I used along with the
contents of the log.  Note, Met::FTPSSL is a modified Net::FTPSSL 0.27 module
with the four lines changed as indicated in the previous post.  If there is
any other information I can provide, please let me know.  &#40;Resending in plain
text as the last post wasn&#39;t readable&#41;.
 
Forrest
 
 ---------------------- test.pl ------------------------------------
 #!/usr/bin/perl
 use lib &#34;./lib&#34;;
 use IO::Socket::SSL qw &#40;debug3&#41;;   # Turns on verbose SSL loging.
 use Met::FTPSSL;
 
 open &#40;STDERR, &#34;&gt; myLogfile.txt&#34;&#41;;  # Redirects STDERR to this file.
 my %connectionHash = &#40;
     Port                =&gt; 21,
     Encryption       =&gt; &#39;E&#39;,
     Debug                =&gt; 1,
     OverridePASV        =&gt; &#39;192.168.0.200&#39;,
     Croak                =&gt; 0,
     PreserveTimestamp    =&gt; 0,
 &#41;;
 
 %sslHash = &#40;
     SSL_cert_file    =&gt; &#39;C:\Users\ftiffany\Documents\ssl\forrest.pem&#39;,
     SSL_reuse_ctx    =&gt; &#39;&#39;,
     SSL_key_file    =&gt; &#39;C:\Users\ftiffany\Documents\ssl\forrest.key&#39;,
     SSL_ca_file        =&gt; &#39;C:\Users\ftiffany\Documents\ssl\CA.crt&#39;,
     SSL_use_cert    =&gt; 1,
 &#41;;
 $connectionHash{SSL_Client_Certificate} = \%sslHash;
 
 my $ftps = Met::FTPSSL-&gt;new&#40;
         &#39;192.168.0.200&#39;,
         %connectionHash,
     &#41;;
      
 $ftps-&gt;trapWarn &#40;&#41;;
 $ftps-&gt;login &#40;&#39;forrest&#39;, &#39;********&#39;&#41;;
 $ftps-&gt;nlst&#40;&#41;;
 $ftps-&gt;quit&#40;&#41;;
 ------------------------------------------------ End test.pl
---------------------------------
 Here are the contents of the log:
 
 
 Net-FTPSSL Version: 0.27
 
 Perl: 5.018004  [5.18.4],  OS: MSWin32
 
 Server &#40;port&#41;: 192.168.0.200 &#40;21&#41;
 
 Keys: &#40;SSL_Client_Certificate&#41;, &#40;Debug&#41;, &#40;PreserveTimestamp&#41;, &#40;OverridePASV&#41;,
&#40;Croak&#41;, &#40;Port&#41;, &#40;Encryption&#41;
 Values: &#40;HASH&#40;0x3527798&#41;&#41;, &#40;1&#41;, &#40;0&#41;, &#40;192.168.0.200&#41;, &#40;0&#41;, &#40;21&#41;, &#40;E&#41;
 
 SKT &lt;&lt;&lt; 220 &#40;vsFTPd 3.0.2&#41;
 SKT &gt;&gt;&gt; AUTH TLS
 SKT &lt;&lt;&lt; 234 Proceed with negotiation.
 DEBUG: .../IO/Socket/SSL.pm:2634: new ctx 53008208
 DEBUG: .../IO/Socket/SSL.pm:1376: start handshake
 DEBUG: .../IO/Socket/SSL.pm:573: ssl handshake not started
 DEBUG: .../IO/Socket/SSL.pm:609: not using SNI because hostname is unknown
 DEBUG: .../IO/Socket/SSL.pm:660: set socket to non-blocking to enforce
timeout=120
 DEBUG: .../IO/Socket/SSL.pm:676: Net::SSLeay::connect -&gt; -1
 DEBUG: .../IO/Socket/SSL.pm:686: ssl handshake in progress
 DEBUG: .../IO/Socket/SSL.pm:696: waiting for fd to become ready: SSL wants a
read first
 DEBUG: .../IO/Socket/SSL.pm:716: socket ready, retrying connect
 DEBUG: .../IO/Socket/SSL.pm:2490: ok=1 cert=3726976
 DEBUG: .../IO/Socket/SSL.pm:2490: ok=1 cert=58351280
 DEBUG: .../IO/Socket/SSL.pm:2490: ok=1 cert=58351104
 DEBUG: .../IO/Socket/SSL.pm:2490: ok=1 cert=58350928
 DEBUG: .../IO/Socket/SSL.pm:676: Net::SSLeay::connect -&gt; -1
 DEBUG: .../IO/Socket/SSL.pm:686: ssl handshake in progress
 DEBUG: .../IO/Socket/SSL.pm:696: waiting for fd to become ready: SSL wants a
read first
 DEBUG: .../IO/Socket/SSL.pm:716: socket ready, retrying connect
 DEBUG: .../IO/Socket/SSL.pm:676: Net::SSLeay::connect -&gt; 1
 DEBUG: .../IO/Socket/SSL.pm:731: ssl handshake done
 
 Object HASH Details ... &#40;SSL_Client_Certificate:options - E&#41;
   SSL_ca_file ==&gt; C:\Users\ftiffany\Documents\ssl\CA.crt
   SSL_cert_file ==&gt; C:\Users\ftiffany\Documents\ssl\forrest.pem
   SSL_key_file ==&gt; C:\Users\ftiffany\Documents\ssl\forrest.key
   SSL_reuse_ctx ==&gt;
   SSL_use_cert ==&gt; 1
 
 
 Object Met::FTPSSL Details ... &#40;192.168.0.200:21 - E&#41;
   Croak ==&gt; &#40;undef&#41;
   Crypt ==&gt; E
   FixGetTs ==&gt; 0
   FixPutTs ==&gt; 0
   Host ==&gt; 192.168.0.200
   OverridePASV ==&gt; 192.168.0.200
   Pret ==&gt; 0
   Timeout ==&gt; 120
   _SSL_arguments ==&gt; HASH&#40;0x36c9f50&#41;
         -- PeerAddr ===&gt; 192.168.0.200
         -- PeerPort ===&gt; 21
         -- Proto ===&gt; tcp
         -- SSL_ca_file ===&gt; C:\Users\ftiffany\Documents\ssl\CA.crt
         -- SSL_cert_file ===&gt; C:\Users\ftiffany\Documents\ssl\forrest.pem
         -- SSL_check_crl ===&gt; 0
          -- SSL_cipher_list ===&gt; ECDHE-ECDSA-AES128-GCM-SHA256
ECDHE-ECDSA-AES128-SHA256 ECDHE-ECDSA-AES256-GCM-SHA384
ECDHE-ECDSA-AES256-SHA384 ECDHE-ECDSA-AES128-SHA ECDHE-ECDSA-AES256-SHA
ECDHE-RSA-AES128-SHA256 ECDHE-RSA-AES128-SHA ECDHE-RSA-AES256-SHA
DHE-DSS-AES128-SHA256 DHE-DSS-AES128-SHA DHE-DSS-AES256-SHA256
DHE-DSS-AES256-SHA AES128-SHA256 AES128-SHA AES256-SHA256 AES256-SHA
EDH-DSS-DES-CBC3-SHA DES-CBC3-SHA RC4-SHA !EXP !LOW !eNULL !aNULL !DES !MD5
!PSK !SRP
         -- SSL_key_file ===&gt; C:\Users\ftiffany\Documents\ssl\forrest.key
         -- SSL_reuse_ctx ===&gt;
         -- SSL_server ===&gt; 0
         -- SSL_session_cache ===&gt;
IO::Socket::SSL::Session_Cache=HASH&#40;0x3acd40&#41;
             -- _head ----&gt; HASH&#40;0x36cbb98&#41;
             -- _maxsize ----&gt; 10
             -- abcd1234:1 ----&gt; HASH&#40;0x36cbb98&#41;
         -- SSL_session_key ===&gt; abcd1234
         -- SSL_use_cert ===&gt; 1
         -- SSL_verify_callback ===&gt; CODE&#40;0x36ca0e8&#41;
         -- SSL_verify_mode ===&gt; 1
         -- SSL_version ===&gt; TLSv1
   _SSL_ctx ==&gt; IO::Socket::SSL::SSL_Context=HASH&#40;0x36ca0d0&#41;
         -- context ===&gt; 53008208
         -- ocsp_mode ===&gt; 16
         -- session_cache ===&gt; IO::Socket::SSL::Session_Cache=HASH&#40;0x3acd40&#41;
             -- _head ----&gt; HASH&#40;0x36cbb98&#41;
             -- _maxsize ----&gt; 10
             -- abcd1234:1 ----&gt; HASH&#40;0x36cbb98&#41;
         -- verify_mode ===&gt; 1
         -- verify_name_ref ===&gt; SCALAR&#40;0x323f3e0&#41;  [192.168.0.200]
   _SSL_fileno ==&gt; 3
   _SSL_ioclass_upgraded ==&gt; IO::Socket::INET
   _SSL_last_err ==&gt; ARRAY&#40;0x36cbc10&#41;
   _SSL_object ==&gt; 58358768
   _SSL_opened ==&gt; 1
   buf_size ==&gt; 10240
   data_prot ==&gt; P
   dcsc_mode ==&gt; 1
   debug ==&gt; 1
   debug_extra ==&gt; 0
   io_sock_nonblocking ==&gt; 0
   io_socket_domain ==&gt; 2
   io_socket_proto ==&gt; 6
   io_socket_timeout ==&gt; 120
   io_socket_type ==&gt; 1
   last_ftp_msg ==&gt; 234 Proceed with negotiation.
   myContext ==&gt; HASH&#40;0x352d6a8&#41;
         -- SSL_ca_file ===&gt; C:\Users\ftiffany\Documents\ssl\CA.crt
         -- SSL_reuse_ctx ===&gt; IO::Socket::SSL::SSL_Context=HASH&#40;0x36ca0d0&#41;
             -- context ----&gt; 53008208
             -- ocsp_mode ----&gt; 16
             -- session_cache ----&gt;
IO::Socket::SSL::Session_Cache=HASH&#40;0x3acd40&#41;
             -- verify_mode ----&gt; 1
             -- verify_name_ref ----&gt; SCALAR&#40;0x323f3e0&#41;  [192.168.0.200]
   mySocketOpts ==&gt; HASH&#40;0x352cba8&#41;
         -- PeerAddr ===&gt; 192.168.0.200
         -- PeerPort ===&gt; 21
         -- Proto ===&gt; tcp
         -- Timeout ===&gt; 120
   trace ==&gt; 0
   type ==&gt; A
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt;&gt;&gt; USER +++++++
</div> &lt;&lt;&lt; 331 Please specify the password.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt;&gt;&gt; PASS *******
</div> &lt;&lt;&lt; 230 Login successful.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt;&gt;&gt; HELP
</div> &lt;&lt;&lt; 214-The following commands are recognized.
 &lt;&lt;&lt;  ABOR ACCT ALLO APPE CDUP CWD  DELE EPRT EPSV FEAT HELP LIST MDTM MKD
 &lt;&lt;&lt;  MODE NLST NOOP OPTS PASS PASV PORT PWD  QUIT REIN REST RETR RMD  RNFR
 &lt;&lt;&lt;  RNTO SITE SIZE SMNT STAT STOR STOU STRU SYST TYPE USER XCUP XCWD XMKD
 &lt;&lt;&lt;  XPWD XRMD
 &lt;&lt;&lt; 214 Help OK.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt;&gt;&gt; FEAT
</div> &lt;&lt;&lt; 211-Features:
 &lt;&lt;&lt;  AUTH TLS
 &lt;&lt;&lt;  EPRT
 &lt;&lt;&lt;  EPSV
 &lt;&lt;&lt;  MDTM
 &lt;&lt;&lt;  PASV
 &lt;&lt;&lt;  PBSZ
 &lt;&lt;&lt;  PROT
 &lt;&lt;&lt;  REST STREAM
 &lt;&lt;&lt;  SIZE
 &lt;&lt;&lt;  TVFS
 &lt;&lt;&lt;  UTF8
 &lt;&lt;&lt; 211 End
 &lt;&lt;+ 214 The HELP command is supported.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt;&gt;&gt; PBSZ 0
</div> &lt;&lt;&lt; 200 PBSZ set to 0.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt;&gt;&gt; PROT P
</div> &lt;&lt;&lt; 200 PROT now Private.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt;&gt;&gt; PASV
</div> &lt;&lt;&lt; 227 Entering Passive Mode &#40;192,168,0,200,233,30&#41;.
 --- Overriding PASV IP Address 192.168.0.200 with 192.168.0.200
 --- Host &#40;192.168.0.200&#41;  Port &#40;59678&#41;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt;&gt;&gt; NLST
</div> &lt;&lt;&lt; 150 Here comes the directory listing.
 DEBUG: .../IO/Socket/SSL.pm:1376: start handshake
 DEBUG: .../IO/Socket/SSL.pm:573: ssl handshake not started
 DEBUG: .../IO/Socket/SSL.pm:609: not using SNI because hostname is unknown
 DEBUG: .../IO/Socket/SSL.pm:676: Net::SSLeay::connect -&gt; 1
 DEBUG: .../IO/Socket/SSL.pm:731: ssl handshake done
 &lt;&lt;&lt; 226 Directory send OK.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt;&gt;&gt; QUIT
</div> &lt;&lt;&lt; 221 Goodbye.
 DEBUG: .../IO/Socket/SSL.pm:2667: free ctx 53008208 open=53008208
 DEBUG: .../IO/Socket/SSL.pm:2672: free ctx 53008208 callback
 DEBUG: .../IO/Socket/SSL.pm:2679: OK free ctx 53008208
 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;04&nbsp;19:55:00&nbsp;2015</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Forrest,

Attached is a beta with a variation of your patch included.  I&#39;ve also improved on the logging a bit to help me see what&#39;s going on.  My logs didn&#39;t go deep enough to follow everything.  If I see what I expect to see, I&#39;ll have a better way to assign the SSL_session_key.

Can you please rerun your test against this beta of Net::FTPSSL ??

Also when you send the logs back to me, can you please send it back as an attachment?  Sending it as text in the body of a message tends to merge things together in the final email.

When I implement a final release, I plan on adding a new option called &#34;ReuseSession=&gt;1&#34; so that this logic is conditional.  Since not everyone will need it.

Curtis

On Thu May 28 11:56:20 2015, forrestt@usa.net wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 
<div class="message-stanza open">&gt; &gt; Hi Forrest,
&gt; &gt;
&gt; &gt; Thank you for using my module and taking the time to open a new CPAN
&gt; &gt; bug
</div>&gt; report and submitting
<div class="message-stanza open">&gt; &gt; a patch.
&gt; &gt;
&gt; &gt; I&#39;ll look into it as soon as I can. In the meantime, can you please
&gt; &gt; give
</div>&gt; me a trace using your
<div class="message-stanza open">&gt; &gt; patch so that I can follow your logs on what is happening?
&gt; &gt;
&gt; &gt; This will give me some needed information on implementing it.
&gt; &gt; Including
</div>&gt; the version of my software
<div class="message-stanza open">&gt; &gt; you are using. Also can you please let me know what version of
</div>&gt; IO::Socket::SSL you are using?
<div class="message-stanza open">&gt; &gt; My logs don&#39;t currently tell me that.
&gt; &gt;
&gt; &gt; Try doing this in your sample program:
&gt; &gt;
&gt; &gt; use IO::Socket::SSL qw &#40;debug3&#41;: # Turns on verbose SSL loging.
&gt; &gt; use Net::FTPSSL;
&gt; &gt;
&gt; &gt; open &#40;STDERR, &#34;&gt; myLogfile.txt&#34;&#41;; # Redirects STDERR to this file.
&gt; &gt; $ftps = Net::FTPSSL-&gt;new &#40;$server, ..., Debug=&gt;1&#41;;
&gt; &gt; $ftps-&gt;trapWarn &#40;&#41;;
&gt; &gt; $ftps-&gt;login &#40;user,pwd&#41;;
&gt; &gt; $ftps-&gt;nlst&#40;&#41;;
&gt; &gt; $ftps-&gt;quit&#40;&#41;;
&gt; &gt;
&gt; &gt; The above code snippet should be enough to demonstrate your patch in
</div>&gt; action &#38; the logs should help
<div class="message-stanza open">&gt; &gt; me out a lot.
&gt; &gt;
&gt; &gt; Thanks
&gt; &gt;
&gt; &gt; Curtis
</div>&gt; 
&gt; 
&gt; Sorry it has taken so long to get back to you.  Life gets in the way
&gt; of
&gt; progress at times.  Here is the short program that I used along with
&gt; the
&gt; contents of the log.  Note, Met::FTPSSL is a modified Net::FTPSSL 0.27
&gt; module
&gt; with the four lines changed as indicated in the previous post.  If
&gt; there is
&gt; any other information I can provide, please let me know.  &#40;Resending
&gt; in plain
&gt; text as the last post wasn&#39;t readable&#41;.
&gt; 
&gt; Forrest
&gt; 
&gt; ---------------------- test.pl ------------------------------------
&gt; #!/usr/bin/perl
&gt; use lib &#34;./lib&#34;;
&gt; use IO::Socket::SSL qw &#40;debug3&#41;;   # Turns on verbose SSL loging.
&gt; use Met::FTPSSL;
&gt; 
&gt; open &#40;STDERR, &#34;&gt; myLogfile.txt&#34;&#41;;  # Redirects STDERR to this file.
&gt; my %connectionHash = &#40;
&gt;     Port                =&gt; 21,
&gt;     Encryption       =&gt; &#39;E&#39;,
&gt;     Debug                =&gt; 1,
&gt;     OverridePASV        =&gt; &#39;192.168.0.200&#39;,
&gt;     Croak                =&gt; 0,
&gt;     PreserveTimestamp    =&gt; 0,
&gt; &#41;;
&gt; 
&gt; %sslHash = &#40;
&gt;     SSL_cert_file    =&gt; &#39;C:\Users\ftiffany\Documents\ssl\forrest.pem&#39;,
&gt;     SSL_reuse_ctx    =&gt; &#39;&#39;,
&gt;     SSL_key_file    =&gt; &#39;C:\Users\ftiffany\Documents\ssl\forrest.key&#39;,
&gt;     SSL_ca_file        =&gt; &#39;C:\Users\ftiffany\Documents\ssl\CA.crt&#39;,
&gt;     SSL_use_cert    =&gt; 1,
&gt; &#41;;
&gt; $connectionHash{SSL_Client_Certificate} = \%sslHash;
&gt; 
&gt; my $ftps = Met::FTPSSL-&gt;new&#40;
&gt;         &#39;192.168.0.200&#39;,
&gt;         %connectionHash,
&gt;     &#41;;
&gt; 
&gt; $ftps-&gt;trapWarn &#40;&#41;;
&gt; $ftps-&gt;login &#40;&#39;forrest&#39;, &#39;********&#39;&#41;;
&gt; $ftps-&gt;nlst&#40;&#41;;
&gt; $ftps-&gt;quit&#40;&#41;;
&gt; ------------------------------------------------ End test.pl
&gt; ---------------------------------
&gt; Here are the contents of the log:
&gt; 
&gt; 
&gt; Net-FTPSSL Version: 0.27
&gt; 
&gt; Perl: 5.018004  [5.18.4],  OS: MSWin32
&gt; 
&gt; Server &#40;port&#41;: 192.168.0.200 &#40;21&#41;
&gt; 
&gt; Keys: &#40;SSL_Client_Certificate&#41;, &#40;Debug&#41;, &#40;PreserveTimestamp&#41;,
&gt; &#40;OverridePASV&#41;,
&gt; &#40;Croak&#41;, &#40;Port&#41;, &#40;Encryption&#41;
&gt; Values: &#40;HASH&#40;0x3527798&#41;&#41;, &#40;1&#41;, &#40;0&#41;, &#40;192.168.0.200&#41;, &#40;0&#41;, &#40;21&#41;, &#40;E&#41;
&gt; 
&gt; SKT &lt;&lt;&lt; 220 &#40;vsFTPd 3.0.2&#41;
&gt; SKT &gt;&gt;&gt; AUTH TLS
&gt; SKT &lt;&lt;&lt; 234 Proceed with negotiation.
&gt; DEBUG: .../IO/Socket/SSL.pm:2634: new ctx 53008208
&gt; DEBUG: .../IO/Socket/SSL.pm:1376: start handshake
&gt; DEBUG: .../IO/Socket/SSL.pm:573: ssl handshake not started
&gt; DEBUG: .../IO/Socket/SSL.pm:609: not using SNI because hostname is
&gt; unknown
&gt; DEBUG: .../IO/Socket/SSL.pm:660: set socket to non-blocking to enforce
&gt; timeout=120
&gt; DEBUG: .../IO/Socket/SSL.pm:676: Net::SSLeay::connect -&gt; -1
&gt; DEBUG: .../IO/Socket/SSL.pm:686: ssl handshake in progress
&gt; DEBUG: .../IO/Socket/SSL.pm:696: waiting for fd to become ready: SSL
&gt; wants a
&gt; read first
&gt; DEBUG: .../IO/Socket/SSL.pm:716: socket ready, retrying connect
&gt; DEBUG: .../IO/Socket/SSL.pm:2490: ok=1 cert=3726976
&gt; DEBUG: .../IO/Socket/SSL.pm:2490: ok=1 cert=58351280
&gt; DEBUG: .../IO/Socket/SSL.pm:2490: ok=1 cert=58351104
&gt; DEBUG: .../IO/Socket/SSL.pm:2490: ok=1 cert=58350928
&gt; DEBUG: .../IO/Socket/SSL.pm:676: Net::SSLeay::connect -&gt; -1
&gt; DEBUG: .../IO/Socket/SSL.pm:686: ssl handshake in progress
&gt; DEBUG: .../IO/Socket/SSL.pm:696: waiting for fd to become ready: SSL
&gt; wants a
&gt; read first
&gt; DEBUG: .../IO/Socket/SSL.pm:716: socket ready, retrying connect
&gt; DEBUG: .../IO/Socket/SSL.pm:676: Net::SSLeay::connect -&gt; 1
&gt; DEBUG: .../IO/Socket/SSL.pm:731: ssl handshake done
&gt; 
&gt; Object HASH Details ... &#40;SSL_Client_Certificate:options - E&#41;
&gt;   SSL_ca_file ==&gt; C:\Users\ftiffany\Documents\ssl\CA.crt
&gt;   SSL_cert_file ==&gt; C:\Users\ftiffany\Documents\ssl\forrest.pem
&gt;   SSL_key_file ==&gt; C:\Users\ftiffany\Documents\ssl\forrest.key
&gt;   SSL_reuse_ctx ==&gt;
&gt;   SSL_use_cert ==&gt; 1
&gt; 
&gt; 
&gt; Object Met::FTPSSL Details ... &#40;192.168.0.200:21 - E&#41;
&gt;   Croak ==&gt; &#40;undef&#41;
&gt;   Crypt ==&gt; E
&gt;   FixGetTs ==&gt; 0
&gt;   FixPutTs ==&gt; 0
&gt;   Host ==&gt; 192.168.0.200
&gt;   OverridePASV ==&gt; 192.168.0.200
&gt;   Pret ==&gt; 0
&gt;   Timeout ==&gt; 120
&gt;   _SSL_arguments ==&gt; HASH&#40;0x36c9f50&#41;
&gt;         -- PeerAddr ===&gt; 192.168.0.200
&gt;         -- PeerPort ===&gt; 21
&gt;         -- Proto ===&gt; tcp
&gt;         -- SSL_ca_file ===&gt; C:\Users\ftiffany\Documents\ssl\CA.crt
&gt;         -- SSL_cert_file ===&gt;
&gt; C:\Users\ftiffany\Documents\ssl\forrest.pem
&gt;         -- SSL_check_crl ===&gt; 0
&gt;          -- SSL_cipher_list ===&gt; ECDHE-ECDSA-AES128-GCM-SHA256
&gt; ECDHE-ECDSA-AES128-SHA256 ECDHE-ECDSA-AES256-GCM-SHA384
&gt; ECDHE-ECDSA-AES256-SHA384 ECDHE-ECDSA-AES128-SHA ECDHE-ECDSA-AES256-
&gt; SHA
&gt; ECDHE-RSA-AES128-SHA256 ECDHE-RSA-AES128-SHA ECDHE-RSA-AES256-SHA
&gt; DHE-DSS-AES128-SHA256 DHE-DSS-AES128-SHA DHE-DSS-AES256-SHA256
&gt; DHE-DSS-AES256-SHA AES128-SHA256 AES128-SHA AES256-SHA256 AES256-SHA
&gt; EDH-DSS-DES-CBC3-SHA DES-CBC3-SHA RC4-SHA !EXP !LOW !eNULL !aNULL !DES
&gt; !MD5
&gt; !PSK !SRP
&gt;         -- SSL_key_file ===&gt;
&gt; C:\Users\ftiffany\Documents\ssl\forrest.key
&gt;         -- SSL_reuse_ctx ===&gt;
&gt;         -- SSL_server ===&gt; 0
&gt;         -- SSL_session_cache ===&gt;
&gt; IO::Socket::SSL::Session_Cache=HASH&#40;0x3acd40&#41;
&gt;             -- _head ----&gt; HASH&#40;0x36cbb98&#41;
&gt;             -- _maxsize ----&gt; 10
&gt;             -- abcd1234:1 ----&gt; HASH&#40;0x36cbb98&#41;
&gt;         -- SSL_session_key ===&gt; abcd1234
&gt;         -- SSL_use_cert ===&gt; 1
&gt;         -- SSL_verify_callback ===&gt; CODE&#40;0x36ca0e8&#41;
&gt;         -- SSL_verify_mode ===&gt; 1
&gt;         -- SSL_version ===&gt; TLSv1
&gt;   _SSL_ctx ==&gt; IO::Socket::SSL::SSL_Context=HASH&#40;0x36ca0d0&#41;
&gt;         -- context ===&gt; 53008208
&gt;         -- ocsp_mode ===&gt; 16
&gt;         -- session_cache ===&gt;
&gt; IO::Socket::SSL::Session_Cache=HASH&#40;0x3acd40&#41;
&gt;             -- _head ----&gt; HASH&#40;0x36cbb98&#41;
&gt;             -- _maxsize ----&gt; 10
&gt;             -- abcd1234:1 ----&gt; HASH&#40;0x36cbb98&#41;
&gt;         -- verify_mode ===&gt; 1
&gt;         -- verify_name_ref ===&gt; SCALAR&#40;0x323f3e0&#41;  [192.168.0.200]
&gt;   _SSL_fileno ==&gt; 3
&gt;   _SSL_ioclass_upgraded ==&gt; IO::Socket::INET
&gt;   _SSL_last_err ==&gt; ARRAY&#40;0x36cbc10&#41;
&gt;   _SSL_object ==&gt; 58358768
&gt;   _SSL_opened ==&gt; 1
&gt;   buf_size ==&gt; 10240
&gt;   data_prot ==&gt; P
&gt;   dcsc_mode ==&gt; 1
&gt;   debug ==&gt; 1
&gt;   debug_extra ==&gt; 0
&gt;   io_sock_nonblocking ==&gt; 0
&gt;   io_socket_domain ==&gt; 2
&gt;   io_socket_proto ==&gt; 6
&gt;   io_socket_timeout ==&gt; 120
&gt;   io_socket_type ==&gt; 1
&gt;   last_ftp_msg ==&gt; 234 Proceed with negotiation.
&gt;   myContext ==&gt; HASH&#40;0x352d6a8&#41;
&gt;         -- SSL_ca_file ===&gt; C:\Users\ftiffany\Documents\ssl\CA.crt
&gt;         -- SSL_reuse_ctx ===&gt;
&gt; IO::Socket::SSL::SSL_Context=HASH&#40;0x36ca0d0&#41;
&gt;             -- context ----&gt; 53008208
&gt;             -- ocsp_mode ----&gt; 16
&gt;             -- session_cache ----&gt;
&gt; IO::Socket::SSL::Session_Cache=HASH&#40;0x3acd40&#41;
&gt;             -- verify_mode ----&gt; 1
&gt;             -- verify_name_ref ----&gt; SCALAR&#40;0x323f3e0&#41;
&gt; [192.168.0.200]
&gt;   mySocketOpts ==&gt; HASH&#40;0x352cba8&#41;
&gt;         -- PeerAddr ===&gt; 192.168.0.200
&gt;         -- PeerPort ===&gt; 21
&gt;         -- Proto ===&gt; tcp
&gt;         -- Timeout ===&gt; 120
&gt;   trace ==&gt; 0
&gt;   type ==&gt; A
&gt; 
<div class="message-stanza open">&gt; &gt;&gt;&gt; USER +++++++
</div>&gt; &lt;&lt;&lt; 331 Please specify the password.
<div class="message-stanza open">&gt; &gt;&gt;&gt; PASS *******
</div>&gt; &lt;&lt;&lt; 230 Login successful.
<div class="message-stanza open">&gt; &gt;&gt;&gt; HELP
</div>&gt; &lt;&lt;&lt; 214-The following commands are recognized.
&gt; &lt;&lt;&lt;  ABOR ACCT ALLO APPE CDUP CWD  DELE EPRT EPSV FEAT HELP LIST MDTM
&gt; MKD
&gt; &lt;&lt;&lt;  MODE NLST NOOP OPTS PASS PASV PORT PWD  QUIT REIN REST RETR RMD
&gt; RNFR
&gt; &lt;&lt;&lt;  RNTO SITE SIZE SMNT STAT STOR STOU STRU SYST TYPE USER XCUP XCWD
&gt; XMKD
&gt; &lt;&lt;&lt;  XPWD XRMD
&gt; &lt;&lt;&lt; 214 Help OK.
<div class="message-stanza open">&gt; &gt;&gt;&gt; FEAT
</div>&gt; &lt;&lt;&lt; 211-Features:
&gt; &lt;&lt;&lt;  AUTH TLS
&gt; &lt;&lt;&lt;  EPRT
&gt; &lt;&lt;&lt;  EPSV
&gt; &lt;&lt;&lt;  MDTM
&gt; &lt;&lt;&lt;  PASV
&gt; &lt;&lt;&lt;  PBSZ
&gt; &lt;&lt;&lt;  PROT
&gt; &lt;&lt;&lt;  REST STREAM
&gt; &lt;&lt;&lt;  SIZE
&gt; &lt;&lt;&lt;  TVFS
&gt; &lt;&lt;&lt;  UTF8
&gt; &lt;&lt;&lt; 211 End
&gt; &lt;&lt;+ 214 The HELP command is supported.
<div class="message-stanza open">&gt; &gt;&gt;&gt; PBSZ 0
</div>&gt; &lt;&lt;&lt; 200 PBSZ set to 0.
<div class="message-stanza open">&gt; &gt;&gt;&gt; PROT P
</div>&gt; &lt;&lt;&lt; 200 PROT now Private.
<div class="message-stanza open">&gt; &gt;&gt;&gt; PASV
</div>&gt; &lt;&lt;&lt; 227 Entering Passive Mode &#40;192,168,0,200,233,30&#41;.
&gt; --- Overriding PASV IP Address 192.168.0.200 with 192.168.0.200
&gt; --- Host &#40;192.168.0.200&#41;  Port &#40;59678&#41;
<div class="message-stanza open">&gt; &gt;&gt;&gt; NLST
</div>&gt; &lt;&lt;&lt; 150 Here comes the directory listing.
&gt; DEBUG: .../IO/Socket/SSL.pm:1376: start handshake
&gt; DEBUG: .../IO/Socket/SSL.pm:573: ssl handshake not started
&gt; DEBUG: .../IO/Socket/SSL.pm:609: not using SNI because hostname is
&gt; unknown
&gt; DEBUG: .../IO/Socket/SSL.pm:676: Net::SSLeay::connect -&gt; 1
&gt; DEBUG: .../IO/Socket/SSL.pm:731: ssl handshake done
&gt; &lt;&lt;&lt; 226 Directory send OK.
<div class="message-stanza open">&gt; &gt;&gt;&gt; QUIT
</div>&gt; &lt;&lt;&lt; 221 Goodbye.
&gt; DEBUG: .../IO/Socket/SSL.pm:2667: free ctx 53008208 open=53008208
&gt; DEBUG: .../IO/Socket/SSL.pm:2672: free ctx 53008208 callback
&gt; DEBUG: .../IO/Socket/SSL.pm:2679: OK free ctx 53008208
&gt; 
</div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> FTPSSL.pm</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;05&nbsp;11:05:47&nbsp;2015</span>
    <span class="description">forrestt [...] usa.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #76108]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 05 Jun 2015 11:05:22 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-Net-FTPSSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Forrest Tiffany&#34; &lt;forrestt [...] usa.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here is the output from the script.  Also, I used 10 for the cache size just
arbitrarily.  I believe it only needs to be 1 &#40;the number of connections to
cache&#41;, but I wasn&#39;t 100% sure, so I padded it to 10.  I&#39;m also pretty sure
the session key is &#34;IP:commandPort&#34; of the server you are connecting to by
default.  I would have used that when I assigned the key for the command
channel, but I couldn&#39;t find where you were storing those values and figured
what would take me hours to find you would know off the top of your head.  So,
instead of using the default key when the data channel needed a key, I set the
command channel key to &#34;abcd1234&#34; so I would know what it was when it needed
to be set for the data channel.  I&#39;d suggest you just remove the setting of
the key for the command channel and use the default key value when you set the
data channel&#39;s key.

Forrest
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Net-FTPSSL Version: 0.27_01
IO-Socket-SSL Version: 2.015

Perl: 5.018004  [5.18.4],  OS: MSWin32

Server &#40;port&#41;: 192.168.0.200 &#40;21&#41;

Keys: &#40;Encryption&#41;, &#40;OverridePASV&#41;, &#40;Croak&#41;, &#40;Debug&#41;, &#40;PreserveTimestamp&#41;, &#40;SSL_Client_Certificate&#41;, &#40;Port&#41;
Values: &#40;E&#41;, &#40;192.168.0.200&#41;, &#40;0&#41;, &#40;1&#41;, &#40;0&#41;, &#40;HASH&#40;0x3735778&#41;&#41;, &#40;21&#41;


Object HASH Details ... &#40;Before start_SSL&#40;&#41; call:initialization - E&#41;
  SSL_ca_file ==&gt; C:\Users\ftiffany\Documents\ssl\CA.crt
  SSL_cert_file ==&gt; C:\Users\ftiffany\Documents\ssl\forrest.pem
  SSL_key_file ==&gt; C:\Users\ftiffany\Documents\ssl\forrest.key
  SSL_reuse_ctx ==&gt; 
  SSL_session_cache ==&gt; IO::Socket::SSL::Session_Cache=HASH&#40;0x2dd8730&#41;
      -- _maxsize ===&gt; 10
  SSL_session_key ==&gt; abcd1234
  SSL_use_cert ==&gt; 1
  SSL_version ==&gt; TLSv1
  Timeout ==&gt; 120

&lt;&lt;&lt; 220 &#40;vsFTPd 3.0.2&#41;
&gt;&gt;&gt; AUTH TLS
&lt;&lt;&lt; 234 Proceed with negotiation.
DEBUG: .../IO/Socket/SSL.pm:2634: new ctx 52737264
DEBUG: .../IO/Socket/SSL.pm:1376: start handshake
DEBUG: .../IO/Socket/SSL.pm:573: ssl handshake not started
DEBUG: .../IO/Socket/SSL.pm:609: not using SNI because hostname is unknown
DEBUG: .../IO/Socket/SSL.pm:660: set socket to non-blocking to enforce timeout=120
DEBUG: .../IO/Socket/SSL.pm:676: Net::SSLeay::connect -&gt; -1
DEBUG: .../IO/Socket/SSL.pm:686: ssl handshake in progress
DEBUG: .../IO/Socket/SSL.pm:696: waiting for fd to become ready: SSL wants a read first
DEBUG: .../IO/Socket/SSL.pm:716: socket ready, retrying connect
DEBUG: .../IO/Socket/SSL.pm:2490: ok=1 cert=47156032
DEBUG: .../IO/Socket/SSL.pm:2490: ok=1 cert=51354800
DEBUG: .../IO/Socket/SSL.pm:2490: ok=1 cert=51354624
DEBUG: .../IO/Socket/SSL.pm:2490: ok=1 cert=51354448
DEBUG: .../IO/Socket/SSL.pm:676: Net::SSLeay::connect -&gt; -1
DEBUG: .../IO/Socket/SSL.pm:686: ssl handshake in progress
DEBUG: .../IO/Socket/SSL.pm:696: waiting for fd to become ready: SSL wants a read first
DEBUG: .../IO/Socket/SSL.pm:716: socket ready, retrying connect
DEBUG: .../IO/Socket/SSL.pm:676: Net::SSLeay::connect -&gt; 1
DEBUG: .../IO/Socket/SSL.pm:731: ssl handshake done

  *** Adding: SSL_session_key --&gt; abcd1234 ***

Object HASH Details ... &#40;SSL_Client_Certificate:options - E&#41;
  SSL_ca_file ==&gt; C:\Users\ftiffany\Documents\ssl\CA.crt
  SSL_cert_file ==&gt; C:\Users\ftiffany\Documents\ssl\forrest.pem
  SSL_key_file ==&gt; C:\Users\ftiffany\Documents\ssl\forrest.key
  SSL_reuse_ctx ==&gt; 
  SSL_use_cert ==&gt; 1


Object Met::FTPSSL Details ... &#40;192.168.0.200:21 - E&#41;
  Croak ==&gt; &#40;undef&#41;
  Crypt ==&gt; E
  FixGetTs ==&gt; 0
  FixPutTs ==&gt; 0
  Host ==&gt; 192.168.0.200
  OverridePASV ==&gt; 192.168.0.200
  Pret ==&gt; 0
  Timeout ==&gt; 120
  _SSL_arguments ==&gt; HASH&#40;0x38cf7f0&#41;
      -- PeerAddr ===&gt; 192.168.0.200
      -- PeerPort ===&gt; 21
      -- Proto ===&gt; tcp
      -- SSL_ca_file ===&gt; C:\Users\ftiffany\Documents\ssl\CA.crt
      -- SSL_cert_file ===&gt; C:\Users\ftiffany\Documents\ssl\forrest.pem
      -- SSL_check_crl ===&gt; 0
      -- SSL_cipher_list ===&gt; ECDHE-ECDSA-AES128-GCM-SHA256 ECDHE-ECDSA-AES128-SHA256 ECDHE-ECDSA-AES256-GCM-SHA384 ECDHE-ECDSA-AES256-SHA384 ECDHE-ECDSA-AES128-SHA ECDHE-ECDSA-AES256-SHA ECDHE-RSA-AES128-SHA256 ECDHE-RSA-AES128-SHA ECDHE-RSA-AES256-SHA DHE-DSS-AES128-SHA256 DHE-DSS-AES128-SHA DHE-DSS-AES256-SHA256 DHE-DSS-AES256-SHA AES128-SHA256 AES128-SHA AES256-SHA256 AES256-SHA EDH-DSS-DES-CBC3-SHA DES-CBC3-SHA RC4-SHA !EXP !LOW !eNULL !aNULL !DES !MD5 !PSK !SRP
      -- SSL_key_file ===&gt; C:\Users\ftiffany\Documents\ssl\forrest.key
      -- SSL_reuse_ctx ===&gt; 
      -- SSL_server ===&gt; 0
      -- SSL_session_cache ===&gt; IO::Socket::SSL::Session_Cache=HASH&#40;0x2dd8730&#41;
          -- _head ----&gt; HASH&#40;0x38d3db8&#41;
              -- key ++++&gt; abcd1234:1
              -- next ++++&gt; HASH&#40;0x38d3db8&#41; ... Infinite Hash Loop Detected!
              -- prev ++++&gt; HASH&#40;0x38d3db8&#41; ... Infinite Hash Loop Detected!
              -- session ++++&gt; 56757056
          -- _maxsize ----&gt; 10
          -- abcd1234:1 ----&gt; HASH&#40;0x38d3db8&#41;
              -- key ++++&gt; abcd1234:1
              -- next ++++&gt; HASH&#40;0x38d3db8&#41; ... Infinite Hash Loop Detected!
              -- prev ++++&gt; HASH&#40;0x38d3db8&#41; ... Infinite Hash Loop Detected!
              -- session ++++&gt; 56757056
      -- SSL_session_key ===&gt; abcd1234
      -- SSL_use_cert ===&gt; 1
      -- SSL_verify_callback ===&gt; CODE&#40;0x38d2368&#41;
      -- SSL_verify_mode ===&gt; 1
      -- SSL_version ===&gt; TLSv1
  _SSL_ctx ==&gt; IO::Socket::SSL::SSL_Context=HASH&#40;0x38d2350&#41;
      -- context ===&gt; 52737264
      -- ocsp_mode ===&gt; 16
      -- session_cache ===&gt; IO::Socket::SSL::Session_Cache=HASH&#40;0x2dd8730&#41;
          -- _head ----&gt; HASH&#40;0x38d3db8&#41;
              -- key ++++&gt; abcd1234:1
              -- next ++++&gt; HASH&#40;0x38d3db8&#41; ... Infinite Hash Loop Detected!
              -- prev ++++&gt; HASH&#40;0x38d3db8&#41; ... Infinite Hash Loop Detected!
              -- session ++++&gt; 56757056
          -- _maxsize ----&gt; 10
          -- abcd1234:1 ----&gt; HASH&#40;0x38d3db8&#41;
              -- key ++++&gt; abcd1234:1
              -- next ++++&gt; HASH&#40;0x38d3db8&#41; ... Infinite Hash Loop Detected!
              -- prev ++++&gt; HASH&#40;0x38d3db8&#41; ... Infinite Hash Loop Detected!
              -- session ++++&gt; 56757056
      -- verify_mode ===&gt; 1
      -- verify_name_ref ===&gt; SCALAR&#40;0x324e1a0&#41;  [192.168.0.200]
  _SSL_fileno ==&gt; 3
  _SSL_last_err ==&gt; ARRAY&#40;0x38d3e00&#41;
      [SSL wants a read first, 4]
  _SSL_object ==&gt; 59788848
  _SSL_opened ==&gt; 1
  buf_size ==&gt; 10240
  data_prot ==&gt; P
  dcsc_mode ==&gt; 1
  debug ==&gt; 1
  debug_extra ==&gt; 0
  io_sock_nonblocking ==&gt; 0
  io_socket_domain ==&gt; 2
  io_socket_proto ==&gt; 6
  io_socket_timeout ==&gt; 120
  io_socket_type ==&gt; 1
  last_ftp_msg ==&gt; 234 Proceed with negotiation.
  myContext ==&gt; HASH&#40;0x373b7d8&#41;
      -- SSL_ca_file ===&gt; C:\Users\ftiffany\Documents\ssl\CA.crt
      -- SSL_reuse_ctx ===&gt; IO::Socket::SSL::SSL_Context=HASH&#40;0x38d2350&#41;
          -- context ----&gt; 52737264
          -- ocsp_mode ----&gt; 16
          -- session_cache ----&gt; IO::Socket::SSL::Session_Cache=HASH&#40;0x2dd8730&#41;
              -- _head ++++&gt; HASH&#40;0x38d3db8&#41;
                  -- key ====&gt; abcd1234:1
                  -- next ====&gt; HASH&#40;0x38d3db8&#41; ... Infinite Hash Loop Detected!
                  -- prev ====&gt; HASH&#40;0x38d3db8&#41; ... Infinite Hash Loop Detected!
                  -- session ====&gt; 56757056
              -- _maxsize ++++&gt; 10
              -- abcd1234:1 ++++&gt; HASH&#40;0x38d3db8&#41;
                  -- key ====&gt; abcd1234:1
                  -- next ====&gt; HASH&#40;0x38d3db8&#41; ... Infinite Hash Loop Detected!
                  -- prev ====&gt; HASH&#40;0x38d3db8&#41; ... Infinite Hash Loop Detected!
                  -- session ====&gt; 56757056
          -- verify_mode ----&gt; 1
          -- verify_name_ref ----&gt; SCALAR&#40;0x324e1a0&#41;  [192.168.0.200]
      -- SSL_session_key ===&gt; abcd1234
  mySocketOpts ==&gt; HASH&#40;0x373acb0&#41;
      -- PeerAddr ===&gt; 192.168.0.200
      -- PeerPort ===&gt; 21
      -- Proto ===&gt; tcp
      -- Timeout ===&gt; 120
  trace ==&gt; 0
  type ==&gt; A

&gt;&gt;&gt; USER +++++++
&lt;&lt;&lt; 331 Please specify the password.
&gt;&gt;&gt; PASS *******
&lt;&lt;&lt; 230 Login successful.
&gt;&gt;&gt; HELP
&lt;&lt;&lt; 214-The following commands are recognized.
&lt;&lt;&lt;  ABOR ACCT ALLO APPE CDUP CWD  DELE EPRT EPSV FEAT HELP LIST MDTM MKD
&lt;&lt;&lt;  MODE NLST NOOP OPTS PASS PASV PORT PWD  QUIT REIN REST RETR RMD  RNFR
&lt;&lt;&lt;  RNTO SITE SIZE SMNT STAT STOR STOU STRU SYST TYPE USER XCUP XCWD XMKD
&lt;&lt;&lt;  XPWD XRMD
&lt;&lt;&lt; 214 Help OK.
&gt;&gt;&gt; FEAT
&lt;&lt;&lt; 211-Features:
&lt;&lt;&lt;  AUTH TLS
&lt;&lt;&lt;  EPRT
&lt;&lt;&lt;  EPSV
&lt;&lt;&lt;  MDTM
&lt;&lt;&lt;  PASV
&lt;&lt;&lt;  PBSZ
&lt;&lt;&lt;  PROT
&lt;&lt;&lt;  REST STREAM
&lt;&lt;&lt;  SIZE
&lt;&lt;&lt;  TVFS
&lt;&lt;&lt;  UTF8
&lt;&lt;&lt; 211 End
&lt;&lt;+ 214 The HELP command is supported.
&gt;&gt;&gt; PBSZ 0
&lt;&lt;&lt; 200 PBSZ set to 0.
&gt;&gt;&gt; PROT P
&lt;&lt;&lt; 200 PROT now Private.
&gt;&gt;&gt; PASV
&lt;&lt;&lt; 227 Entering Passive Mode &#40;192,168,0,200,130,156&#41;.
--- Overriding PASV IP Address 192.168.0.200 with 192.168.0.200
--- Host &#40;192.168.0.200&#41;  Port &#40;33436&#41;
&gt;&gt;&gt; NLST
&lt;&lt;&lt; 150 Here comes the directory listing.
DEBUG: .../IO/Socket/SSL.pm:1376: start handshake
DEBUG: .../IO/Socket/SSL.pm:573: ssl handshake not started
DEBUG: .../IO/Socket/SSL.pm:609: not using SNI because hostname is unknown
DEBUG: .../IO/Socket/SSL.pm:676: Net::SSLeay::connect -&gt; 1
DEBUG: .../IO/Socket/SSL.pm:731: ssl handshake done
&lt;&lt;&lt; 226 Directory send OK.
&gt;&gt;&gt; QUIT
&lt;&lt;&lt; 221 Goodbye.
DEBUG: .../IO/Socket/SSL.pm:2667: free ctx 52737264 open=52737264
DEBUG: .../IO/Socket/SSL.pm:2672: free ctx 52737264 callback
DEBUG: .../IO/Socket/SSL.pm:2679: OK free ctx 52737264
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;05&nbsp;13:27:17&nbsp;2015</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> forrestt [...] usa.net</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Forest,

I figured as much.  But since our FTPS servers are behaving slightly differently, I wanted my 1st Beta to be as close to your code as possible.

If you can test out the new beta attached to this email &#38; return the logs, I&#39;d appreciate it.

The main problem with setting the SSL_session_key is that I don&#39;t usually have the IP Address to use until after the call to start_SSL.  Usually the server name is passed to Net::FTPSSL.  Which is why I moved the setting of the key value until after that call in this 2nd beta.

If this works for you, I&#39;ll be ready to release a final v0.28 version that uses a new key to turn this functionality on.  &#40;ReuseSession =&gt; 1&#41;.  For backwards compatibility, I can&#39;t have this turned on by default.

Also why are you using the OverridePASV option?  You shouldn&#39;t need it since you are using the same value as the host.  And the PASV command is returning the correct value according to the logs.  This option was added to help you work with misconfigured servers.

Curtis

On Fri Jun 05 11:05:47 2015, forrestt@usa.net wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Here is the output from the script.  Also, I used 10 for the cache
&gt; size just
&gt; arbitrarily.  I believe it only needs to be 1 &#40;the number of
&gt; connections to
&gt; cache&#41;, but I wasn&#39;t 100% sure, so I padded it to 10.  I&#39;m also pretty
&gt; sure
&gt; the session key is &#34;IP:commandPort&#34; of the server you are connecting
&gt; to by
&gt; default.  I would have used that when I assigned the key for the
&gt; command
&gt; channel, but I couldn&#39;t find where you were storing those values and
&gt; figured
&gt; what would take me hours to find you would know off the top of your
&gt; head.  So,
&gt; instead of using the default key when the data channel needed a key, I
&gt; set the
&gt; command channel key to &#34;abcd1234&#34; so I would know what it was when it
&gt; needed
&gt; to be set for the data channel.  I&#39;d suggest you just remove the
&gt; setting of
&gt; the key for the command channel and use the default key value when you
&gt; set the
&gt; data channel&#39;s key.
&gt; 
&gt; Forrest
</div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> FTPSSL.pm</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;05&nbsp;15:31:58&nbsp;2015</span>
    <span class="description">forrestt [...] usa.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #76108]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 05 Jun 2015 15:31:38 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-Net-FTPSSL [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Forrest Tiffany&#34; &lt;forrestt [...] usa.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Here is the log.  As you can see from the log, that didn&#39;t work.

I guess I&#39;m not being clear.  You shouldn&#39;t need to set a key for the command
channel.  Here are the steps that I think need to be done:

1.  Create command channel connection with a cache object
2.  Store IP address
3.  Store Command Port
4.  Create data channel connection using &#34;IP:Command Port&#34; for SSLcache key

The reason I&#39;m using OverridePASV is because the real script I wrote &#40;the
sample from 28 May, test.pl, is a snippet of it with hard-coded values&#41;
connects to servers from thousands of different companies with new ones added
all of the time.  I don&#39;t want to have to have another parameter that the
operations staff needs to worry about to determine if PASV needs to be
overridden, so I simply set OverridePASV for the new connection.  This seemed
like the more likely scenario between it and a FTPS server behind a
load-balancer for this particular scenario.

If it turns out that this isn&#39;t the right decision, then I&#39;ll modify my code
to have that option &#40;although, IMHO it would be better to remove that option
in FTPSSL and simply ignore the returned IP value if it is a non-routeable IP
and use the origin IP under that case.

Forrest
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Net-FTPSSL Version: 0.27_02
IO-Socket-SSL Version: 2.015

Perl: 5.018004  [5.18.4],  OS: MSWin32

Server &#40;port&#41;: 192.168.0.200 &#40;21&#41;

Keys: &#40;Encryption&#41;, &#40;OverridePASV&#41;, &#40;PreserveTimestamp&#41;, &#40;Croak&#41;, &#40;Debug&#41;, &#40;SSL_Client_Certificate&#41;, &#40;Port&#41;
Values: &#40;E&#41;, &#40;192.168.0.200&#41;, &#40;0&#41;, &#40;0&#41;, &#40;1&#41;, &#40;HASH&#40;0x3605778&#41;&#41;, &#40;21&#41;


Object HASH Details ... &#40;Before start_SSL&#40;&#41; call:initialization - E&#41;
  SSL_ca_file ==&gt; C:\Users\ftiffany\Documents\ssl\CA.crt
  SSL_cert_file ==&gt; C:\Users\ftiffany\Documents\ssl\forrest.pem
  SSL_key_file ==&gt; C:\Users\ftiffany\Documents\ssl\forrest.key
  SSL_reuse_ctx ==&gt; 
  SSL_session_cache ==&gt; IO::Socket::SSL::Session_Cache=HASH&#40;0x336930&#41;
      -- _maxsize ===&gt; 4
  SSL_use_cert ==&gt; 1
  SSL_version ==&gt; TLSv1
  Timeout ==&gt; 120

&lt;&lt;&lt; 220 &#40;vsFTPd 3.0.2&#41;
&gt;&gt;&gt; AUTH TLS
&lt;&lt;&lt; 234 Proceed with negotiation.
DEBUG: .../IO/Socket/SSL.pm:2634: new ctx 51426544
DEBUG: .../IO/Socket/SSL.pm:1376: start handshake
DEBUG: .../IO/Socket/SSL.pm:573: ssl handshake not started
DEBUG: .../IO/Socket/SSL.pm:609: not using SNI because hostname is unknown
DEBUG: .../IO/Socket/SSL.pm:660: set socket to non-blocking to enforce timeout=120
DEBUG: .../IO/Socket/SSL.pm:676: Net::SSLeay::connect -&gt; -1
DEBUG: .../IO/Socket/SSL.pm:686: ssl handshake in progress
DEBUG: .../IO/Socket/SSL.pm:696: waiting for fd to become ready: SSL wants a read first
DEBUG: .../IO/Socket/SSL.pm:716: socket ready, retrying connect
DEBUG: .../IO/Socket/SSL.pm:2490: ok=1 cert=50042672
DEBUG: .../IO/Socket/SSL.pm:2490: ok=1 cert=50044256
DEBUG: .../IO/Socket/SSL.pm:2490: ok=1 cert=50044080
DEBUG: .../IO/Socket/SSL.pm:2490: ok=1 cert=50043904
DEBUG: .../IO/Socket/SSL.pm:676: Net::SSLeay::connect -&gt; -1
DEBUG: .../IO/Socket/SSL.pm:686: ssl handshake in progress
DEBUG: .../IO/Socket/SSL.pm:696: waiting for fd to become ready: SSL wants a read first
DEBUG: .../IO/Socket/SSL.pm:716: socket ready, retrying connect
DEBUG: .../IO/Socket/SSL.pm:676: Net::SSLeay::connect -&gt; 1
DEBUG: .../IO/Socket/SSL.pm:731: ssl handshake done

  *** Adding: SSL_session_key --&gt; 192.168.0.200:21 ***

Object HASH Details ... &#40;SSL_Client_Certificate:options - E&#41;
  SSL_ca_file ==&gt; C:\Users\ftiffany\Documents\ssl\CA.crt
  SSL_cert_file ==&gt; C:\Users\ftiffany\Documents\ssl\forrest.pem
  SSL_key_file ==&gt; C:\Users\ftiffany\Documents\ssl\forrest.key
  SSL_reuse_ctx ==&gt; 
  SSL_use_cert ==&gt; 1


Object Met::FTPSSL Details ... &#40;192.168.0.200:21 - E&#41;
  Croak ==&gt; &#40;undef&#41;
  Crypt ==&gt; E
  FixGetTs ==&gt; 0
  FixPutTs ==&gt; 0
  Host ==&gt; 192.168.0.200
  OverridePASV ==&gt; 192.168.0.200
  Pret ==&gt; 0
  Timeout ==&gt; 120
  _SSL_arguments ==&gt; HASH&#40;0x2c7f330&#41;
      -- PeerAddr ===&gt; 192.168.0.200
      -- PeerPort ===&gt; 21
      -- Proto ===&gt; tcp
      -- SSL_ca_file ===&gt; C:\Users\ftiffany\Documents\ssl\CA.crt
      -- SSL_cert_file ===&gt; C:\Users\ftiffany\Documents\ssl\forrest.pem
      -- SSL_check_crl ===&gt; 0
      -- SSL_cipher_list ===&gt; ECDHE-ECDSA-AES128-GCM-SHA256 ECDHE-ECDSA-AES128-SHA256 ECDHE-ECDSA-AES256-GCM-SHA384 ECDHE-ECDSA-AES256-SHA384 ECDHE-ECDSA-AES128-SHA ECDHE-ECDSA-AES256-SHA ECDHE-RSA-AES128-SHA256 ECDHE-RSA-AES128-SHA ECDHE-RSA-AES256-SHA DHE-DSS-AES128-SHA256 DHE-DSS-AES128-SHA DHE-DSS-AES256-SHA256 DHE-DSS-AES256-SHA AES128-SHA256 AES128-SHA AES256-SHA256 AES256-SHA EDH-DSS-DES-CBC3-SHA DES-CBC3-SHA RC4-SHA !EXP !LOW !eNULL !aNULL !DES !MD5 !PSK !SRP
      -- SSL_key_file ===&gt; C:\Users\ftiffany\Documents\ssl\forrest.key
      -- SSL_reuse_ctx ===&gt; 
      -- SSL_server ===&gt; 0
      -- SSL_session_cache ===&gt; IO::Socket::SSL::Session_Cache=HASH&#40;0x336930&#41;
          -- 192.168.0.200:21 ----&gt; HASH&#40;0x37a3aa8&#41;
              -- key ++++&gt; 192.168.0.200:21
              -- next ++++&gt; HASH&#40;0x37a3aa8&#41; ... Infinite Hash Loop Detected!
              -- prev ++++&gt; HASH&#40;0x37a3aa8&#41; ... Infinite Hash Loop Detected!
              -- session ++++&gt; 55511872
          -- _head ----&gt; HASH&#40;0x37a3aa8&#41;
              -- key ++++&gt; 192.168.0.200:21
              -- next ++++&gt; HASH&#40;0x37a3aa8&#41; ... Infinite Hash Loop Detected!
              -- prev ++++&gt; HASH&#40;0x37a3aa8&#41; ... Infinite Hash Loop Detected!
              -- session ++++&gt; 55511872
          -- _maxsize ----&gt; 4
      -- SSL_session_key ===&gt; 192.168.0.200:21
      -- SSL_use_cert ===&gt; 1
      -- SSL_verify_callback ===&gt; CODE&#40;0x37a2058&#41;
      -- SSL_verify_mode ===&gt; 1
      -- SSL_version ===&gt; TLSv1
  _SSL_ctx ==&gt; IO::Socket::SSL::SSL_Context=HASH&#40;0x37a2040&#41;
      -- context ===&gt; 51426544
      -- ocsp_mode ===&gt; 16
      -- session_cache ===&gt; IO::Socket::SSL::Session_Cache=HASH&#40;0x336930&#41;
          -- 192.168.0.200:21 ----&gt; HASH&#40;0x37a3aa8&#41;
              -- key ++++&gt; 192.168.0.200:21
              -- next ++++&gt; HASH&#40;0x37a3aa8&#41; ... Infinite Hash Loop Detected!
              -- prev ++++&gt; HASH&#40;0x37a3aa8&#41; ... Infinite Hash Loop Detected!
              -- session ++++&gt; 55511872
          -- _head ----&gt; HASH&#40;0x37a3aa8&#41;
              -- key ++++&gt; 192.168.0.200:21
              -- next ++++&gt; HASH&#40;0x37a3aa8&#41; ... Infinite Hash Loop Detected!
              -- prev ++++&gt; HASH&#40;0x37a3aa8&#41; ... Infinite Hash Loop Detected!
              -- session ++++&gt; 55511872
          -- _maxsize ----&gt; 4
      -- verify_mode ===&gt; 1
      -- verify_name_ref ===&gt; SCALAR&#40;0x310e1a0&#41;  [192.168.0.200]
  _SSL_fileno ==&gt; 3
  _SSL_last_err ==&gt; ARRAY&#40;0x37a3af0&#41;
      [SSL wants a read first, 4]
  _SSL_object ==&gt; 58541296
  _SSL_opened ==&gt; 1
  buf_size ==&gt; 10240
  data_prot ==&gt; P
  dcsc_mode ==&gt; 1
  debug ==&gt; 1
  debug_extra ==&gt; 0
  io_sock_nonblocking ==&gt; 0
  io_socket_domain ==&gt; 2
  io_socket_proto ==&gt; 6
  io_socket_timeout ==&gt; 120
  io_socket_type ==&gt; 1
  last_ftp_msg ==&gt; 234 Proceed with negotiation.
  myContext ==&gt; HASH&#40;0x360b8e0&#41;
      -- SSL_ca_file ===&gt; C:\Users\ftiffany\Documents\ssl\CA.crt
      -- SSL_reuse_ctx ===&gt; IO::Socket::SSL::SSL_Context=HASH&#40;0x37a2040&#41;
          -- context ----&gt; 51426544
          -- ocsp_mode ----&gt; 16
          -- session_cache ----&gt; IO::Socket::SSL::Session_Cache=HASH&#40;0x336930&#41;
              -- 192.168.0.200:21 ++++&gt; HASH&#40;0x37a3aa8&#41;
                  -- key ====&gt; 192.168.0.200:21
                  -- next ====&gt; HASH&#40;0x37a3aa8&#41; ... Infinite Hash Loop Detected!
                  -- prev ====&gt; HASH&#40;0x37a3aa8&#41; ... Infinite Hash Loop Detected!
                  -- session ====&gt; 55511872
              -- _head ++++&gt; HASH&#40;0x37a3aa8&#41;
                  -- key ====&gt; 192.168.0.200:21
                  -- next ====&gt; HASH&#40;0x37a3aa8&#41; ... Infinite Hash Loop Detected!
                  -- prev ====&gt; HASH&#40;0x37a3aa8&#41; ... Infinite Hash Loop Detected!
                  -- session ====&gt; 55511872
              -- _maxsize ++++&gt; 4
          -- verify_mode ----&gt; 1
          -- verify_name_ref ----&gt; SCALAR&#40;0x310e1a0&#41;  [192.168.0.200]
      -- SSL_session_key ===&gt; 192.168.0.200:21
  mySocketOpts ==&gt; HASH&#40;0x360acb0&#41;
      -- PeerAddr ===&gt; 192.168.0.200
      -- PeerPort ===&gt; 21
      -- Proto ===&gt; tcp
      -- Timeout ===&gt; 120
  trace ==&gt; 0
  type ==&gt; A

&gt;&gt;&gt; USER +++++++
&lt;&lt;&lt; 331 Please specify the password.
&gt;&gt;&gt; PASS *******
&lt;&lt;&lt; 230 Login successful.
&gt;&gt;&gt; HELP
&lt;&lt;&lt; 214-The following commands are recognized.
&lt;&lt;&lt;  ABOR ACCT ALLO APPE CDUP CWD  DELE EPRT EPSV FEAT HELP LIST MDTM MKD
&lt;&lt;&lt;  MODE NLST NOOP OPTS PASS PASV PORT PWD  QUIT REIN REST RETR RMD  RNFR
&lt;&lt;&lt;  RNTO SITE SIZE SMNT STAT STOR STOU STRU SYST TYPE USER XCUP XCWD XMKD
&lt;&lt;&lt;  XPWD XRMD
&lt;&lt;&lt; 214 Help OK.
&gt;&gt;&gt; FEAT
&lt;&lt;&lt; 211-Features:
&lt;&lt;&lt;  AUTH TLS
&lt;&lt;&lt;  EPRT
&lt;&lt;&lt;  EPSV
&lt;&lt;&lt;  MDTM
&lt;&lt;&lt;  PASV
&lt;&lt;&lt;  PBSZ
&lt;&lt;&lt;  PROT
&lt;&lt;&lt;  REST STREAM
&lt;&lt;&lt;  SIZE
&lt;&lt;&lt;  TVFS
&lt;&lt;&lt;  UTF8
&lt;&lt;&lt; 211 End
&lt;&lt;+ 214 The HELP command is supported.
&gt;&gt;&gt; PBSZ 0
&lt;&lt;&lt; 200 PBSZ set to 0.
&gt;&gt;&gt; PROT P
&lt;&lt;&lt; 200 PROT now Private.
&gt;&gt;&gt; PASV
&lt;&lt;&lt; 227 Entering Passive Mode &#40;192,168,0,200,92,93&#41;.
--- Overriding PASV IP Address 192.168.0.200 with 192.168.0.200
--- Host &#40;192.168.0.200&#41;  Port &#40;23645&#41;
&gt;&gt;&gt; NLST
&lt;&lt;&lt; 150 Here comes the directory listing.
DEBUG: .../IO/Socket/SSL.pm:1376: start handshake
DEBUG: .../IO/Socket/SSL.pm:573: ssl handshake not started
DEBUG: .../IO/Socket/SSL.pm:609: not using SNI because hostname is unknown
DEBUG: .../IO/Socket/SSL.pm:2490: ok=1 cert=50042672
DEBUG: .../IO/Socket/SSL.pm:2490: ok=1 cert=59392416
DEBUG: .../IO/Socket/SSL.pm:2490: ok=1 cert=59392240
DEBUG: .../IO/Socket/SSL.pm:2490: ok=1 cert=59392064
DEBUG: .../IO/Socket/SSL.pm:676: Net::SSLeay::connect -&gt; 1
DEBUG: .../IO/Socket/SSL.pm:731: ssl handshake done
&lt;&lt;&lt; 522 SSL connection failed; session reuse required: see require_ssl_reuse option in vsftpd.conf man page
&gt;&gt;&gt; QUIT
&lt;&lt;&lt; 221 Goodbye.
DEBUG: .../IO/Socket/SSL.pm:2667: free ctx 51426544 open=51426544
DEBUG: .../IO/Socket/SSL.pm:2672: free ctx 51426544 callback
DEBUG: .../IO/Socket/SSL.pm:2679: OK free ctx 51426544
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;05&nbsp;22:33:50&nbsp;2015</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> forrestt [...] usa.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Drat, I was really hoping that I didn&#39;t need to get the IP Address before the call to start_SSL.  I usually won&#39;t have it until after the call to start_SSL.  I&#39;ll have to drill down the socket object to see if I can get the IP Address from it when I&#39;m passed a server&#39;s name instead of an IP Address.  &#40;I have the port, that&#39;s a given.&#41;

From the error message, it&#39;s not recognizing the SSL_sesion_key for the data channel as going with the command channel.  See the myContext settings in the log.  I use everything in that Hash to create the data channel with.  So the SSL_session_key is already set to &lt;IP Address&gt;:&lt;port&gt; for the data channel!  So I was already doing what you suggested, except that I also set it on the command channel as well.  Which didn&#39;t seem to harm the command channel at all.

So I&#39;m thinking the SSL_session_key must be set before the call to start_SSL instead of after it.  I&#39;m betting whatever is in SSL_session_key is sent to your FTPS server during the handshake establishing the connection for the command channel.  That if it&#39;s not there, your FTPS server assumes there is no session key to reuse.  So the server doesn&#39;t recognize the key passed with the data channel as a valid session key.

And if that&#39;s the case, that explains why the original beta worked for you &#38; this one didn&#39;t.  That using &lt;IP Address&gt;:&lt;port&gt; was more a suggestion than a requirement.

I&#39;m going to get you another beta to try out soon.  Also I&#39;d like you to modify your test program to call nlst&#40;&#41; 6 times.  That&#39;s bigger than the cache will be in my next beta.  I just want to rule out that setting the cache size to 4 isn&#39;t too small for when you are requesting a lot of data from the FTPS server.

By the way, I understand your OverridePASV explanation.  And as long as you don&#39;t attempt to talk to a server using Load Balancing it should work.  Using it will break things for a load balancing server since each data request will return a different IP Address.  Hopefully hitting misconfigured FTPS servers will be fairly rare.

But a test case I use is to login in without OverridePASV &#38; try nlst&#40;&#41;.  If it fails, then create a new connection using OverridePASV.  If it works great, if not there&#39;s some other issue involved.  This way you get the best of both worlds.  But I understand if you don&#39;t want the overhead of multiple tries.

Curtis


On Fri Jun 05 15:31:58 2015, forrestt@usa.net wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Here is the log.  As you can see from the log, that didn&#39;t work.
&gt; 
&gt; I guess I&#39;m not being clear.  You shouldn&#39;t need to set a key for the
&gt; command
&gt; channel.  Here are the steps that I think need to be done:
&gt; 
&gt; 1.  Create command channel connection with a cache object
&gt; 2.  Store IP address
&gt; 3.  Store Command Port
&gt; 4.  Create data channel connection using &#34;IP:Command Port&#34; for
&gt; SSLcache key
&gt; 
&gt; The reason I&#39;m using OverridePASV is because the real script I wrote
&gt; &#40;the
&gt; sample from 28 May, test.pl, is a snippet of it with hard-coded
&gt; values&#41;
&gt; connects to servers from thousands of different companies with new
&gt; ones added
&gt; all of the time.  I don&#39;t want to have to have another parameter that
&gt; the
&gt; operations staff needs to worry about to determine if PASV needs to be
&gt; overridden, so I simply set OverridePASV for the new connection.  This
&gt; seemed
&gt; like the more likely scenario between it and a FTPS server behind a
&gt; load-balancer for this particular scenario.
&gt; 
&gt; If it turns out that this isn&#39;t the right decision, then I&#39;ll modify
&gt; my code
&gt; to have that option &#40;although, IMHO it would be better to remove that
&gt; option
&gt; in FTPSSL and simply ignore the returned IP value if it is a non-
&gt; routeable IP
&gt; and use the origin IP under that case.
&gt; 
&gt; Forrest
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;08&nbsp;17:41:55&nbsp;2015</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> forrestt [...] usa.net</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Forrest,

Here&#39;s the beta that should work.  Turns out I don&#39;t have access to the IP Address before the call to start_SSL&#40;&#41; if passed a host name instead of an IP Address.  So I&#39;m not going to jump through hoops to try to convert it to one if this beta works.  Especially if the &#40;IP Address&#41;:&#40;port} for the key seems to be more a suggestion than a requirement.

The SSL_session_key it will use is &#34;Net-FTPSSL-&#40;version&#41;-&#40;pid&#41;:&#40;port&#41;&#34;
Which will result in a fairly unique key, though I also think isn&#39;t a requirement.

I just need a few things checked out against your server to say this is it.  So could you please run your test program against this new beta again?  Any feedback would be appreciated as well.

Things to test out:
1&#41; Adding the port to the key isn&#39;t a problem
2&#41; The key isn&#39;t too long for your server.
3&#41; Run the nlst&#40;&#41; command at least 6 times.  &#40;makes sure we don&#39;t attempt to expand our session cache.&#41;

Curtis


On Fri Jun 05 22:33:50 2015, CLEACH wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Drat, I was really hoping that I didn&#39;t need to get the IP Address
&gt; before the call to start_SSL.  I usually won&#39;t have it until after the
&gt; call to start_SSL.  I&#39;ll have to drill down the socket object to see
&gt; if I can get the IP Address from it when I&#39;m passed a server&#39;s name
&gt; instead of an IP Address.  &#40;I have the port, that&#39;s a given.&#41;
&gt; 
&gt; From the error message, it&#39;s not recognizing the SSL_sesion_key for
&gt; the data channel as going with the command channel.  See the myContext
&gt; settings in the log.  I use everything in that Hash to create the data
&gt; channel with.  So the SSL_session_key is already set to &lt;IP
<div class="message-stanza open">&gt; Address&gt;:&lt;port&gt; for the data channel!  So I was already doing what you
</div>&gt; suggested, except that I also set it on the command channel as well.
&gt; Which didn&#39;t seem to harm the command channel at all.
&gt; 
&gt; So I&#39;m thinking the SSL_session_key must be set before the call to
&gt; start_SSL instead of after it.  I&#39;m betting whatever is in
&gt; SSL_session_key is sent to your FTPS server during the handshake
&gt; establishing the connection for the command channel.  That if it&#39;s not
&gt; there, your FTPS server assumes there is no session key to reuse.  So
&gt; the server doesn&#39;t recognize the key passed with the data channel as a
&gt; valid session key.
&gt; 
&gt; And if that&#39;s the case, that explains why the original beta worked for
&gt; you &#38; this one didn&#39;t.  That using &lt;IP Address&gt;:&lt;port&gt; was more a
&gt; suggestion than a requirement.
&gt; 
&gt; I&#39;m going to get you another beta to try out soon.  Also I&#39;d like you
&gt; to modify your test program to call nlst&#40;&#41; 6 times.  That&#39;s bigger
&gt; than the cache will be in my next beta.  I just want to rule out that
&gt; setting the cache size to 4 isn&#39;t too small for when you are
&gt; requesting a lot of data from the FTPS server.
&gt; 
&gt; By the way, I understand your OverridePASV explanation.  And as long
&gt; as you don&#39;t attempt to talk to a server using Load Balancing it
&gt; should work.  Using it will break things for a load balancing server
&gt; since each data request will return a different IP Address.  Hopefully
&gt; hitting misconfigured FTPS servers will be fairly rare.
&gt; 
&gt; But a test case I use is to login in without OverridePASV &#38; try
&gt; nlst&#40;&#41;.  If it fails, then create a new connection using OverridePASV.
&gt; If it works great, if not there&#39;s some other issue involved.  This way
&gt; you get the best of both worlds.  But I understand if you don&#39;t want
&gt; the overhead of multiple tries.
&gt; 
&gt; Curtis
&gt; 
&gt; 
&gt; On Fri Jun 05 15:31:58 2015, forrestt@usa.net wrote:
<div class="message-stanza open">&gt; &gt;
&gt; &gt; Here is the log.  As you can see from the log, that didn&#39;t work.
&gt; &gt;
&gt; &gt; I guess I&#39;m not being clear.  You shouldn&#39;t need to set a key for the
&gt; &gt; command
&gt; &gt; channel.  Here are the steps that I think need to be done:
&gt; &gt;
&gt; &gt; 1.  Create command channel connection with a cache object
&gt; &gt; 2.  Store IP address
&gt; &gt; 3.  Store Command Port
&gt; &gt; 4.  Create data channel connection using &#34;IP:Command Port&#34; for
&gt; &gt; SSLcache key
&gt; &gt;
&gt; &gt; The reason I&#39;m using OverridePASV is because the real script I wrote
&gt; &gt; &#40;the
&gt; &gt; sample from 28 May, test.pl, is a snippet of it with hard-coded
&gt; &gt; values&#41;
&gt; &gt; connects to servers from thousands of different companies with new
&gt; &gt; ones added
&gt; &gt; all of the time.  I don&#39;t want to have to have another parameter that
&gt; &gt; the
&gt; &gt; operations staff needs to worry about to determine if PASV needs to
&gt; &gt; be
&gt; &gt; overridden, so I simply set OverridePASV for the new connection.
&gt; &gt; This
&gt; &gt; seemed
&gt; &gt; like the more likely scenario between it and a FTPS server behind a
&gt; &gt; load-balancer for this particular scenario.
&gt; &gt;
&gt; &gt; If it turns out that this isn&#39;t the right decision, then I&#39;ll modify
&gt; &gt; my code
&gt; &gt; to have that option &#40;although, IMHO it would be better to remove that
&gt; &gt; option
&gt; &gt; in FTPSSL and simply ignore the returned IP value if it is a non-
&gt; &gt; routeable IP
&gt; &gt; and use the origin IP under that case.
&gt; &gt;
&gt; &gt; Forrest
</div></div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> FTPSSL.pm</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;25&nbsp;14:04:51&nbsp;2015</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> forrestt [...] usa.net</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Forrest,

I never heard back from you about the last beta.  So I&#39;m assuming all was OK.  Attached is my last beta before I upload it to CPAN next week in case you missed my email.  The only difference between this beta &#38; my planned release is to comment out a lot of debug statements.

If I don&#39;t hear back from you by then, I&#39;m going to assume all is OK and close these tickets.

This beta now uses option &#34;ReuseSession=&gt;1&#34; to turn things on.  It&#39;s turned off by default.  It will be the same way in the final release.

Curtis

On Mon Jun 08 17:41:55 2015, CLEACH wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Forrest,
&gt; 
&gt; Here&#39;s the beta that should work.  Turns out I don&#39;t have access to
&gt; the IP Address before the call to start_SSL&#40;&#41; if passed a host name
&gt; instead of an IP Address.  So I&#39;m not going to jump through hoops to
&gt; try to convert it to one if this beta works.  Especially if the &#40;IP
&gt; Address&#41;:&#40;port} for the key seems to be more a suggestion than a
&gt; requirement.
&gt; 
&gt; The SSL_session_key it will use is &#34;Net-FTPSSL-&#40;version&#41;-&#40;pid&#41;:&#40;port&#41;&#34;
&gt; Which will result in a fairly unique key, though I also think isn&#39;t a
&gt; requirement.
&gt; 
&gt; I just need a few things checked out against your server to say this
&gt; is it.  So could you please run your test program against this new
&gt; beta again?  Any feedback would be appreciated as well.
&gt; 
&gt; Things to test out:
&gt; 1&#41; Adding the port to the key isn&#39;t a problem
&gt; 2&#41; The key isn&#39;t too long for your server.
&gt; 3&#41; Run the nlst&#40;&#41; command at least 6 times.  &#40;makes sure we don&#39;t
&gt; attempt to expand our session cache.&#41;
&gt; 
&gt; Curtis
&gt; 
&gt; 
&gt; On Fri Jun 05 22:33:50 2015, CLEACH wrote:
<div class="message-stanza open">&gt; &gt; Drat, I was really hoping that I didn&#39;t need to get the IP Address
&gt; &gt; before the call to start_SSL.  I usually won&#39;t have it until after
&gt; &gt; the
&gt; &gt; call to start_SSL.  I&#39;ll have to drill down the socket object to see
&gt; &gt; if I can get the IP Address from it when I&#39;m passed a server&#39;s name
&gt; &gt; instead of an IP Address.  &#40;I have the port, that&#39;s a given.&#41;
&gt; &gt;
&gt; &gt; From the error message, it&#39;s not recognizing the SSL_sesion_key for
&gt; &gt; the data channel as going with the command channel.  See the
&gt; &gt; myContext
&gt; &gt; settings in the log.  I use everything in that Hash to create the
&gt; &gt; data
&gt; &gt; channel with.  So the SSL_session_key is already set to &lt;IP
<div class="message-stanza open">&gt; &gt; Address&gt; :&lt;port&gt; for the data channel!  So I was already doing what
&gt; &gt; Address&gt; you
</div>&gt; &gt; suggested, except that I also set it on the command channel as well.
&gt; &gt; Which didn&#39;t seem to harm the command channel at all.
&gt; &gt;
&gt; &gt; So I&#39;m thinking the SSL_session_key must be set before the call to
&gt; &gt; start_SSL instead of after it.  I&#39;m betting whatever is in
&gt; &gt; SSL_session_key is sent to your FTPS server during the handshake
&gt; &gt; establishing the connection for the command channel.  That if it&#39;s
&gt; &gt; not
&gt; &gt; there, your FTPS server assumes there is no session key to reuse.  So
&gt; &gt; the server doesn&#39;t recognize the key passed with the data channel as
&gt; &gt; a
&gt; &gt; valid session key.
&gt; &gt;
&gt; &gt; And if that&#39;s the case, that explains why the original beta worked
&gt; &gt; for
&gt; &gt; you &#38; this one didn&#39;t.  That using &lt;IP Address&gt;:&lt;port&gt; was more a
&gt; &gt; suggestion than a requirement.
&gt; &gt;
&gt; &gt; I&#39;m going to get you another beta to try out soon.  Also I&#39;d like you
&gt; &gt; to modify your test program to call nlst&#40;&#41; 6 times.  That&#39;s bigger
&gt; &gt; than the cache will be in my next beta.  I just want to rule out that
&gt; &gt; setting the cache size to 4 isn&#39;t too small for when you are
&gt; &gt; requesting a lot of data from the FTPS server.
&gt; &gt;
&gt; &gt; By the way, I understand your OverridePASV explanation.  And as long
&gt; &gt; as you don&#39;t attempt to talk to a server using Load Balancing it
&gt; &gt; should work.  Using it will break things for a load balancing server
&gt; &gt; since each data request will return a different IP Address.
&gt; &gt; Hopefully
&gt; &gt; hitting misconfigured FTPS servers will be fairly rare.
&gt; &gt;
&gt; &gt; But a test case I use is to login in without OverridePASV &#38; try
&gt; &gt; nlst&#40;&#41;.  If it fails, then create a new connection using
&gt; &gt; OverridePASV.
&gt; &gt; If it works great, if not there&#39;s some other issue involved.  This
&gt; &gt; way
&gt; &gt; you get the best of both worlds.  But I understand if you don&#39;t want
&gt; &gt; the overhead of multiple tries.
&gt; &gt;
&gt; &gt; Curtis
&gt; &gt;
&gt; &gt;
&gt; &gt; On Fri Jun 05 15:31:58 2015, forrestt@usa.net wrote:
<div class="message-stanza open">&gt; &gt; &gt;
&gt; &gt; &gt; Here is the log.  As you can see from the log, that didn&#39;t work.
&gt; &gt; &gt;
&gt; &gt; &gt; I guess I&#39;m not being clear.  You shouldn&#39;t need to set a key for
&gt; &gt; &gt; the
&gt; &gt; &gt; command
&gt; &gt; &gt; channel.  Here are the steps that I think need to be done:
&gt; &gt; &gt;
&gt; &gt; &gt; 1.  Create command channel connection with a cache object
&gt; &gt; &gt; 2.  Store IP address
&gt; &gt; &gt; 3.  Store Command Port
&gt; &gt; &gt; 4.  Create data channel connection using &#34;IP:Command Port&#34; for
&gt; &gt; &gt; SSLcache key
&gt; &gt; &gt;
&gt; &gt; &gt; The reason I&#39;m using OverridePASV is because the real script I
&gt; &gt; &gt; wrote
&gt; &gt; &gt; &#40;the
&gt; &gt; &gt; sample from 28 May, test.pl, is a snippet of it with hard-coded
&gt; &gt; &gt; values&#41;
&gt; &gt; &gt; connects to servers from thousands of different companies with new
&gt; &gt; &gt; ones added
&gt; &gt; &gt; all of the time.  I don&#39;t want to have to have another parameter
&gt; &gt; &gt; that
&gt; &gt; &gt; the
&gt; &gt; &gt; operations staff needs to worry about to determine if PASV needs to
&gt; &gt; &gt; be
&gt; &gt; &gt; overridden, so I simply set OverridePASV for the new connection.
&gt; &gt; &gt; This
&gt; &gt; &gt; seemed
&gt; &gt; &gt; like the more likely scenario between it and a FTPS server behind a
&gt; &gt; &gt; load-balancer for this particular scenario.
&gt; &gt; &gt;
&gt; &gt; &gt; If it turns out that this isn&#39;t the right decision, then I&#39;ll
&gt; &gt; &gt; modify
&gt; &gt; &gt; my code
&gt; &gt; &gt; to have that option &#40;although, IMHO it would be better to remove
&gt; &gt; &gt; that
&gt; &gt; &gt; option
&gt; &gt; &gt; in FTPSSL and simply ignore the returned IP value if it is a non-
&gt; &gt; &gt; routeable IP
&gt; &gt; &gt; and use the origin IP under that case.
&gt; &gt; &gt;
&gt; &gt; &gt; Forrest
</div></div></div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> FTPSSL.pm</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;06&nbsp;19:57:16&nbsp;2015</span>
    <span class="description">CLEACH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> forrestt [...] usa.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Forrest,

This is to let you know that the last beta I sent to you had a bug in it.  So if you are still interested in my fix, download v0.29 when it becomes available.  I had missed deleting a few lines of code from the 1st broken beta.

Once this release is available on CPAN, I&#39;ll be closing this ticket.  If it&#39;s still causing you issues, let me know via a new ticket &#38; I&#39;ll be glad to continue working on this until you are happy with the solution.

Curtis

On Thu Jun 25 14:04:51 2015, CLEACH wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Forrest,
&gt; 
&gt; I never heard back from you about the last beta.  So I&#39;m assuming all
&gt; was OK.  Attached is my last beta before I upload it to CPAN next week
&gt; in case you missed my email.  The only difference between this beta &#38;
&gt; my planned release is to comment out a lot of debug statements.
&gt; 
&gt; If I don&#39;t hear back from you by then, I&#39;m going to assume all is OK
&gt; and close these tickets.
&gt; 
&gt; This beta now uses option &#34;ReuseSession=&gt;1&#34; to turn things on.  It&#39;s
&gt; turned off by default.  It will be the same way in the final release.
&gt; 
&gt; Curtis
&gt; 
&gt; On Mon Jun 08 17:41:55 2015, CLEACH wrote:
<div class="message-stanza open">&gt; &gt; Hi Forrest,
&gt; &gt;
&gt; &gt; Here&#39;s the beta that should work.  Turns out I don&#39;t have access to
&gt; &gt; the IP Address before the call to start_SSL&#40;&#41; if passed a host name
&gt; &gt; instead of an IP Address.  So I&#39;m not going to jump through hoops to
&gt; &gt; try to convert it to one if this beta works.  Especially if the &#40;IP
&gt; &gt; Address&#41;:&#40;port} for the key seems to be more a suggestion than a
&gt; &gt; requirement.
&gt; &gt;
&gt; &gt; The SSL_session_key it will use is &#34;Net-FTPSSL-&#40;version&#41;-
&gt; &gt; &#40;pid&#41;:&#40;port&#41;&#34;
&gt; &gt; Which will result in a fairly unique key, though I also think isn&#39;t a
&gt; &gt; requirement.
&gt; &gt;
&gt; &gt; I just need a few things checked out against your server to say this
&gt; &gt; is it.  So could you please run your test program against this new
&gt; &gt; beta again?  Any feedback would be appreciated as well.
&gt; &gt;
&gt; &gt; Things to test out:
&gt; &gt; 1&#41; Adding the port to the key isn&#39;t a problem
&gt; &gt; 2&#41; The key isn&#39;t too long for your server.
&gt; &gt; 3&#41; Run the nlst&#40;&#41; command at least 6 times.  &#40;makes sure we don&#39;t
&gt; &gt; attempt to expand our session cache.&#41;
&gt; &gt;
&gt; &gt; Curtis
&gt; &gt;
&gt; &gt;
&gt; &gt; On Fri Jun 05 22:33:50 2015, CLEACH wrote:
<div class="message-stanza open">&gt; &gt; &gt; Drat, I was really hoping that I didn&#39;t need to get the IP Address
&gt; &gt; &gt; before the call to start_SSL.  I usually won&#39;t have it until after
&gt; &gt; &gt; the
&gt; &gt; &gt; call to start_SSL.  I&#39;ll have to drill down the socket object to
&gt; &gt; &gt; see
&gt; &gt; &gt; if I can get the IP Address from it when I&#39;m passed a server&#39;s name
&gt; &gt; &gt; instead of an IP Address.  &#40;I have the port, that&#39;s a given.&#41;
&gt; &gt; &gt;
&gt; &gt; &gt; From the error message, it&#39;s not recognizing the SSL_sesion_key for
&gt; &gt; &gt; the data channel as going with the command channel.  See the
&gt; &gt; &gt; myContext
&gt; &gt; &gt; settings in the log.  I use everything in that Hash to create the
&gt; &gt; &gt; data
&gt; &gt; &gt; channel with.  So the SSL_session_key is already set to &lt;IP
<div class="message-stanza open">&gt; &gt; &gt; Address&gt; :&lt;port&gt; for the data channel!  So I was already doing what
&gt; &gt; &gt; Address&gt; you
</div>&gt; &gt; &gt; suggested, except that I also set it on the command channel as
&gt; &gt; &gt; well.
&gt; &gt; &gt; Which didn&#39;t seem to harm the command channel at all.
&gt; &gt; &gt;
&gt; &gt; &gt; So I&#39;m thinking the SSL_session_key must be set before the call to
&gt; &gt; &gt; start_SSL instead of after it.  I&#39;m betting whatever is in
&gt; &gt; &gt; SSL_session_key is sent to your FTPS server during the handshake
&gt; &gt; &gt; establishing the connection for the command channel.  That if it&#39;s
&gt; &gt; &gt; not
&gt; &gt; &gt; there, your FTPS server assumes there is no session key to reuse.
&gt; &gt; &gt; So
&gt; &gt; &gt; the server doesn&#39;t recognize the key passed with the data channel
&gt; &gt; &gt; as
&gt; &gt; &gt; a
&gt; &gt; &gt; valid session key.
&gt; &gt; &gt;
&gt; &gt; &gt; And if that&#39;s the case, that explains why the original beta worked
&gt; &gt; &gt; for
&gt; &gt; &gt; you &#38; this one didn&#39;t.  That using &lt;IP Address&gt;:&lt;port&gt; was more a
&gt; &gt; &gt; suggestion than a requirement.
&gt; &gt; &gt;
&gt; &gt; &gt; I&#39;m going to get you another beta to try out soon.  Also I&#39;d like
&gt; &gt; &gt; you
&gt; &gt; &gt; to modify your test program to call nlst&#40;&#41; 6 times.  That&#39;s bigger
&gt; &gt; &gt; than the cache will be in my next beta.  I just want to rule out
&gt; &gt; &gt; that
&gt; &gt; &gt; setting the cache size to 4 isn&#39;t too small for when you are
&gt; &gt; &gt; requesting a lot of data from the FTPS server.
&gt; &gt; &gt;
&gt; &gt; &gt; By the way, I understand your OverridePASV explanation.  And as
&gt; &gt; &gt; long
&gt; &gt; &gt; as you don&#39;t attempt to talk to a server using Load Balancing it
&gt; &gt; &gt; should work.  Using it will break things for a load balancing
&gt; &gt; &gt; server
&gt; &gt; &gt; since each data request will return a different IP Address.
&gt; &gt; &gt; Hopefully
&gt; &gt; &gt; hitting misconfigured FTPS servers will be fairly rare.
&gt; &gt; &gt;
&gt; &gt; &gt; But a test case I use is to login in without OverridePASV &#38; try
&gt; &gt; &gt; nlst&#40;&#41;.  If it fails, then create a new connection using
&gt; &gt; &gt; OverridePASV.
&gt; &gt; &gt; If it works great, if not there&#39;s some other issue involved.  This
&gt; &gt; &gt; way
&gt; &gt; &gt; you get the best of both worlds.  But I understand if you don&#39;t
&gt; &gt; &gt; want
&gt; &gt; &gt; the overhead of multiple tries.
&gt; &gt; &gt;
&gt; &gt; &gt; Curtis
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; On Fri Jun 05 15:31:58 2015, forrestt@usa.net wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Here is the log.  As you can see from the log, that didn&#39;t work.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; I guess I&#39;m not being clear.  You shouldn&#39;t need to set a key for
&gt; &gt; &gt; &gt; the
&gt; &gt; &gt; &gt; command
&gt; &gt; &gt; &gt; channel.  Here are the steps that I think need to be done:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; 1.  Create command channel connection with a cache object
&gt; &gt; &gt; &gt; 2.  Store IP address
&gt; &gt; &gt; &gt; 3.  Store Command Port
&gt; &gt; &gt; &gt; 4.  Create data channel connection using &#34;IP:Command Port&#34; for
&gt; &gt; &gt; &gt; SSLcache key
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; The reason I&#39;m using OverridePASV is because the real script I
&gt; &gt; &gt; &gt; wrote
&gt; &gt; &gt; &gt; &#40;the
&gt; &gt; &gt; &gt; sample from 28 May, test.pl, is a snippet of it with hard-coded
&gt; &gt; &gt; &gt; values&#41;
&gt; &gt; &gt; &gt; connects to servers from thousands of different companies with
&gt; &gt; &gt; &gt; new
&gt; &gt; &gt; &gt; ones added
&gt; &gt; &gt; &gt; all of the time.  I don&#39;t want to have to have another parameter
&gt; &gt; &gt; &gt; that
&gt; &gt; &gt; &gt; the
&gt; &gt; &gt; &gt; operations staff needs to worry about to determine if PASV needs
&gt; &gt; &gt; &gt; to
&gt; &gt; &gt; &gt; be
&gt; &gt; &gt; &gt; overridden, so I simply set OverridePASV for the new connection.
&gt; &gt; &gt; &gt; This
&gt; &gt; &gt; &gt; seemed
&gt; &gt; &gt; &gt; like the more likely scenario between it and a FTPS server behind
&gt; &gt; &gt; &gt; a
&gt; &gt; &gt; &gt; load-balancer for this particular scenario.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; If it turns out that this isn&#39;t the right decision, then I&#39;ll
&gt; &gt; &gt; &gt; modify
&gt; &gt; &gt; &gt; my code
&gt; &gt; &gt; &gt; to have that option &#40;although, IMHO it would be better to remove
&gt; &gt; &gt; &gt; that
&gt; &gt; &gt; &gt; option
&gt; &gt; &gt; &gt; in FTPSSL and simply ignore the returned IP value if it is a non-
&gt; &gt; &gt; &gt; routeable IP
&gt; &gt; &gt; &gt; and use the origin IP under that case.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Forrest
</div></div></div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;09&nbsp;21:09:17&nbsp;2015</span>
    <span class="description">CLEACH [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;09&nbsp;21:09:17&nbsp;2015</span>
    <span class="description">CLEACH [...] cpan.org -  Fixed in 0.29 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
