<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #130048 for Text-CSV-Hashify: Text::CSV::Hashify feature request</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #130048 for Text-CSV-Hashify: Text::CSV::Hashify feature request</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Text-CSV-Hashify/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Text-CSV-Hashify/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Text-CSV-Hashify/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Text-CSV-Hashify/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Text-CSV-Hashify">Text-CSV-Hashify CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">130048</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Text-CSV-Hashify/Active/">Text-CSV-Hashify</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
guido [...] gvr.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-247436-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-247437-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




t.csv<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1855924/996979/t.csv">
Fri Jul 12 03:27:25 2019 (38b) by guido [...] gvr.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;11&nbsp;09:47:59&nbsp;2019</span>
    <span class="description">guido [...] gvr.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Text::CSV::Hashify feature request</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 11 Jul 2019 15:38:49 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Text-CSV-Hashify [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Guido van Rooij &lt;guido [...] gvr.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

First of all, thanks for a nice package!

I do have a request. Currently it is not possible to process a CSV
file with a Byte Order Marker &#40;BOM&#41;, at least that is how I understand
it.
In Text::CSV this is possible but only in the header method which is
not used in Text::CSV::Hashify.

So my request is to add an extra attribute to the new&#40;&#41; method
&#40;detect_bom&#41; that does nothing more than check after the first call to
getline&#40;&#41; to get the headers, if a BOM is present in the first element of
@{$header_ref}.

Does that seem a good addition? If so, I can come up with a patch.
If not: what would be your solution?

Thanks,

-Guido
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;11&nbsp;12:17:28&nbsp;2019</span>
    <span class="description">jkeenan [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jul 11 09:47:59 2019, guido@gvr.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; First of all, thanks for a nice package!
&gt; 
&gt; I do have a request. Currently it is not possible to process a CSV
&gt; file with a Byte Order Marker &#40;BOM&#41;, at least that is how I understand
&gt; it.
&gt; In Text::CSV this is possible but only in the header method which is
&gt; not used in Text::CSV::Hashify.
&gt; 
&gt; So my request is to add an extra attribute to the new&#40;&#41; method
&gt; &#40;detect_bom&#41; that does nothing more than check after the first call to
&gt; getline&#40;&#41; to get the headers, if a BOM is present in the first element of
&gt; @{$header_ref}.
&gt; 
&gt; Does that seem a good addition? If so, I can come up with a patch.
&gt; If not: what would be your solution?
&gt; 
&gt; Thanks,
&gt; 
&gt; -Guido
</div>
Would you be able to *attach* to this ticket a CSV file &#40;containing non-confidential data&#41; that begins with a BOM?  We would need something like this to write a regression test.

Thank you very much.
Jim Keenan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;11&nbsp;12:17:29&nbsp;2019</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;12&nbsp;03:27:25&nbsp;2019</span>
    <span class="description">guido [...] gvr.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #130048] Text::CSV::Hashify feature request</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 12 Jul 2019 09:27:13 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> James E Keenan via RT &lt;bug-Text-CSV-Hashify [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Guido van Rooij &lt;guido [...] gvr.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, Jul 11, 2019 at 12:17:29PM -0400, James E Keenan via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Would you be able to *attach* to this ticket a CSV file &#40;containing non-confidential data&#41; that begins with a BOM?  We would need something like this to write a regression test.
</div>
I&#39;ve attached it to this message.
The byte sequence is 0xef,0xbb,0xbf which is UTF-8 for UTF-16 U+FEFF.
When read by Text::CSV::Hashify, the first column column name is prepended with the UTF-16 sequence.

-Guido
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;16&nbsp;13:57:40&nbsp;2019</span>
    <span class="description">jkeenan [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> &#34;H.Merijn Brand&#34; &lt;h.m.brand [...] xs4all.nl&gt;, Ishigaki [...] cpan.org, makamaka [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #130048] Text::CSV::Hashify feature request</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 16 Jul 2019 13:57:27 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Text-CSV-Hashify [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> James E Keenan &lt;jkeenan [...] pobox.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 7/11/19 9:48 AM, Guido van Rooij via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thu Jul 11 09:47:59 2019: Request 130048 was acted upon.
&gt; Transaction: Ticket created by guido@gvr.org
&gt;         Queue: Text-CSV-Hashify
&gt;       Subject: Text::CSV::Hashify feature request
&gt;     Broken in: &#40;no value&#41;
&gt;      Severity: &#40;no value&#41;
&gt;         Owner: Nobody
&gt;    Requestors: guido@gvr.org
&gt;        Status: new
&gt;   Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=130048">https://rt.cpan.org/Ticket/Display.html?id=130048</a></span> &gt;
&gt; 
&gt; 
&gt; Hi,
&gt; 
&gt; First of all, thanks for a nice package!
&gt; 
&gt; I do have a request. Currently it is not possible to process a CSV
&gt; file with a Byte Order Marker &#40;BOM&#41;, at least that is how I understand
&gt; it.
&gt; In Text::CSV this is possible but only in the header method which is
&gt; not used in Text::CSV::Hashify.
&gt; 
&gt; So my request is to add an extra attribute to the new&#40;&#41; method
&gt; &#40;detect_bom&#41; that does nothing more than check after the first call to
&gt; getline&#40;&#41; to get the headers, if a BOM is present in the first element of
&gt; @{$header_ref}.
&gt; 
&gt; Does that seem a good addition? If so, I can come up with a patch.
&gt; If not: what would be your solution?
&gt; 
&gt; Thanks,
&gt; 
&gt; -Guido
&gt; 
</div>
I looked into implementing this feature today and saw that it would not 
be as straightforward as I had hoped.

When I wrote Text::CSV::Hashify several years ago, Text::CSV and 
Text::CSV_XS apparently did not have BOM-detection functionality.  So I 
never had to write tests for Text::CSV::Hashify to demonstrate the 
possibility of &#34;passing BOM-detection through&#34; to Text::CSV.

But I see now that there has been considerable new functionality added 
to those two modules which Hashify cannot yet handle.

Part of the difficulty is that, AFAICT, &#39;detect_bom&#39; is implemented as a 
key-value pair in a hash passed as the second argument to $csv-&gt;header&#40;&#41;:

#####
$csv-&gt;header&#40;$IN, { detect_bom =&gt; 1, other_attribute =&gt; 0 }&#41;;
#####

Moreover, if I read the documentation correctly, &#39;detect_bom&#39; is set to 
true by default.

Now, Text::CSV::Hashify has never used the header&#40;&#41; method internally. 
Text::CSV::Hashify::new&#40;&#41;:

* examines all its arguments;

* processes, then sets aside, those not needed for Text::CSV_XS::new&#40;&#41;;

* calls the latter new&#40;&#41;;

* then uses $csv-&gt;getline&#40;&#41; to read the first row *without immediately 
treating it as a &#34;header&#34; row*;

* does some QA on the first row;

* uses $csv-&gt;column_names&#40;&#41; to set the column names.

Text::CSV::header&#40;&#41;, which I don&#39;t use, appears to be a multi-purpose 
method.  It can override values passed to Text::CSV::new&#40;&#41; for, e.g., 
&#39;sep_char&#39; and it turns BOM-detection on unless you specifically request 
to turn it off.  So it is a method with multiple side effects, which 
makes it potentially dangerous -- or, at the very least, there is a fair 
chance that it will not DWIM.  So I actually like the fact that 
Text::CSV::Hashify currently does *not* use header&#40;&#41; -- even though 
that&#39;s what prevents BOM-detection.

I am afraid that if we include a call to $csv-&gt;header&#40;&#41; somewhere inside 
Text::CSV::Hashify::new&#40;&#41;, then attributes of the Text::CSV_XS object 
inside the Text::CSV::Hashify object would change in unforeseeable ways.

If I were implementing BOM-detection for Text::CSV, I would not have it 
turned on by default and I would have passed it to new&#40;&#41; rather than 
header&#40;&#41;.  That would have facilitated subclassing.

I am cc-ing the maintainers of Text::CSV and Text::CSV::Hashify for 
their thoughts on this.

Thank you very much.
Jim Keenan
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;16&nbsp;15:49:21&nbsp;2019</span>
    <span class="description">h.m.brand [...] xs4all.nl -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> bug-Text-CSV-Hashify [...] rt.cpan.org, Ishigaki [...] cpan.org, makamaka [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #130048] Text::CSV::Hashify feature request</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 16 Jul 2019 21:48:57 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> James E Keenan &lt;jkeenan [...] pobox.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;H.Merijn Brand&#34; &lt;h.m.brand [...] xs4all.nl&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, 16 Jul 2019 13:57:27 -0400, James E Keenan &lt;jkeenan@pobox.com&gt;
wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I am cc-ing the maintainers of Text::CSV and Text::CSV::Hashify for 
&gt; their thoughts on this.
</div>
$csv-&gt;header &#40;...&#41; is indeed a method that combines several &#34;features&#34;
into a single call, because separating them would only complicate the
tasks at hand.

In my daily work, most CSV files have a &#34;header&#34; row, which defines
the column names. This row usually has the same number of fields as
the rest of the data and &#34;most of the time&#34; &#40;TM&#41; these fields do not
have newlines. I hope no one in a sane mindset will ever try to add
a header line where the fields have embedded newlines, but we will
probably meet someone who does just to make life of others more
difficult &#40;or it is a manager who thinks that a full description of
the column makes more sense, but those people should be forbidden to
touch a keyboard.

Though Unicode permits Byte Order Marks halfway a stream, it is very
uncommon. Where one could see it is if two stream that both have a
BOM are catenated, but for each stream, a BOM has to be the first
byte sequence of the stream, which coincidentally is nice to deal
with on the first &#40;read header-&#41; line.

So dealing with BOM, which *also* has impact on the content of the
fields in the first row, together with reading this line as header
*and* &#40;auto&#41;detect the line ending and &#40;optionally&#41; field separator
makes all the sense in the world &#40;at least to me&#41;. Note that reading
the first row in UTF-16 or UTF-32 and *not* looking at the BOM, may
result in bytes running over to the next line/record invalidating it.

I hope I chose the defaults to be the most DWIM:

 • BOM detection: true
 • Set column names for hash treatment
 • Map column names to lower case

The last one is based on most of &#40;my&#41; CSV files being table-exports
or selections from databases, and ANSI tells the field names to be
case insensitive by default. This makes the use of Oracle exports on
PostgreSQL imports easier. Each of those options can be overruled
and/or abbreviated.

I personally think the -&gt;header method is now stable and unlikely to
change. *if* new options are added, those will have to be backward
compatible. Te options that are currently in, are there since the
first commit. The only thing that visibly changed is the addition of
some abbreviations, specifically &#34;munge&#34; for &#34;munge_column_names&#34;.

I *do* see your point in -&gt;header not honoring the setting of sep or
sep_char in -&gt;new, but if you know that the new call had this attr
define, you could force it to be used in -&gt;header

 my $sep = &#34;\t&#34;;
 my $csv = Text::CSV_XS-&gt;new &#40;{ sep_char =&gt; $sep }&#41;;
 my @hdr = $csh-&gt;header &#40;$fh, [ $sep ], { munge =&gt; &#34;lc&#34; }&#41;;

as now $sep is the only allowed separator to be detected, it can not
be &#40;re&#41;set to anything else.

Most of what I read in the Text::CSV::Hashify manual is relatively
easy to do in Text::CSV_XS &#40;and Text::CSV&#41;. I&#39;d use the csv function

  use Text::CSV::Hashify;
  $obj = Text::CSV::Hashify-&gt;new &#40;{
      file      =&gt; &#34;/path/to/file.csv&#34;,
      format    =&gt; &#34;hoh&#34;, # hash of hashes, which is default
      key       =&gt; &#34;id&#34;,  # needed except when format is &#39;aoh&#39;
      max_rows  =&gt; 20,    # number of records to read; defaults to all
      # ... other key-value pairs as appropriate from Text::CSV
      }&#41;;
  $hash_ref     = $obj-&gt;all;

=&gt;

  use Text::CSV_XS &#34;csv&#34;;
  $hash_ref = csv &#40;
      in       =&gt; &#34;path/to/file&#34;,
      bom      =&gt; 1, # Implies -&gt;header call for BOM detection and header
      key      =&gt; &#34;id&#34;,
      fragment =&gt; &#34;row=1-20&#34;,
      # ... other key-value pairs for Text::CSV_XS
      &#41;;

&#40;where I must add the remark that in the *current* implementation, the
combination of both key and fragment attribute will cause the key
attribute to be ignored, which I consider a bug. Please file a ticket
if you agree :&#41;

Does this all make sense?

-- 
H.Merijn Brand  <span class="clickylink"><a target="new" rel="nofollow" href="http://tux.nl">http://tux.nl</a></span>   Perl Monger  <span class="clickylink"><a target="new" rel="nofollow" href="http://amsterdam.pm.org/">http://amsterdam.pm.org/</a></span>
using perl5.00307 .. 5.29   porting perl5 on HP-UX, AIX, and openSUSE
<span class="clickylink"><a target="new" rel="nofollow" href="http://mirrors.develooper.com/hpux/">http://mirrors.develooper.com/hpux/</a></span>        <span class="clickylink"><a target="new" rel="nofollow" href="http://www.test-smoke.org/">http://www.test-smoke.org/</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://qa.perl.org">http://qa.perl.org</a></span>   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.goldmark.org/jeff/stupid-disclaimers/">http://www.goldmark.org/jeff/stupid-disclaimers/</a></span>
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1856392/997234/">Download &#40;untitled&#41;</a><br />
<span class="downloadcontenttype">application/pgp-signature 488b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;08&nbsp;07:17:46&nbsp;2019</span>
    <span class="description">guido [...] gvr.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #130048] Text::CSV::Hashify feature request</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 8 Aug 2019 13:17:20 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;h.m.brand [...] xs4all.nl via RT&#34; &lt;bug-Text-CSV-Hashify [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Guido van Rooij &lt;guido [...] gvr.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Jul 16, 2019 at 03:49:22PM -0400, h.m.brand@xs4all.nl via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=130048">https://rt.cpan.org/Ticket/Display.html?id=130048</a></span> &gt;
&gt; 
&gt; On Tue, 16 Jul 2019 13:57:27 -0400, James E Keenan &lt;jkeenan@pobox.com&gt;
&gt; wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; I am cc-ing the maintainers of Text::CSV and Text::CSV::Hashify for 
&gt; &gt; their thoughts on this.
</div>&gt; 
&gt; $csv-&gt;header &#40;...&#41; is indeed a method that combines several &#34;features&#34;
&gt; into a single call, because separating them would only complicate the
&gt; tasks at hand.
&gt; 
&gt; In my daily work, most CSV files have a &#34;header&#34; row, which defines
&gt; the column names. This row usually has the same number of fields as
&gt; the rest of the data and &#34;most of the time&#34; &#40;TM&#41; these fields do not
&gt; have newlines. I hope no one in a sane mindset will ever try to add
&gt; a header line where the fields have embedded newlines, but we will
&gt; probably meet someone who does just to make life of others more
&gt; difficult &#40;or it is a manager who thinks that a full description of
&gt; the column makes more sense, but those people should be forbidden to
&gt; touch a keyboard.
&gt; 
&gt; Though Unicode permits Byte Order Marks halfway a stream, it is very
&gt; uncommon. Where one could see it is if two stream that both have a
&gt; BOM are catenated, but for each stream, a BOM has to be the first
&gt; byte sequence of the stream, which coincidentally is nice to deal
&gt; with on the first &#40;read header-&#41; line.
&gt; 
&gt; So dealing with BOM, which *also* has impact on the content of the
&gt; fields in the first row, together with reading this line as header
&gt; *and* &#40;auto&#41;detect the line ending and &#40;optionally&#41; field separator
&gt; makes all the sense in the world &#40;at least to me&#41;. Note that reading
&gt; the first row in UTF-16 or UTF-32 and *not* looking at the BOM, may
&gt; result in bytes running over to the next line/record invalidating it.
&gt; 
&gt; I hope I chose the defaults to be the most DWIM:
&gt; 
&gt;  • BOM detection: true
&gt;  • Set column names for hash treatment
&gt;  • Map column names to lower case
&gt; 
&gt; The last one is based on most of &#40;my&#41; CSV files being table-exports
&gt; or selections from databases, and ANSI tells the field names to be
&gt; case insensitive by default. This makes the use of Oracle exports on
&gt; PostgreSQL imports easier. Each of those options can be overruled
&gt; and/or abbreviated.
&gt; 
&gt; I personally think the -&gt;header method is now stable and unlikely to
&gt; change. *if* new options are added, those will have to be backward
&gt; compatible. Te options that are currently in, are there since the
&gt; first commit. The only thing that visibly changed is the addition of
&gt; some abbreviations, specifically &#34;munge&#34; for &#34;munge_column_names&#34;.
&gt; 
&gt; I *do* see your point in -&gt;header not honoring the setting of sep or
&gt; sep_char in -&gt;new, but if you know that the new call had this attr
&gt; define, you could force it to be used in -&gt;header
&gt; 
&gt;  my $sep = &#34;\t&#34;;
&gt;  my $csv = Text::CSV_XS-&gt;new &#40;{ sep_char =&gt; $sep }&#41;;
&gt;  my @hdr = $csh-&gt;header &#40;$fh, [ $sep ], { munge =&gt; &#34;lc&#34; }&#41;;
&gt; 
&gt; as now $sep is the only allowed separator to be detected, it can not
&gt; be &#40;re&#41;set to anything else.
&gt; 
&gt; Most of what I read in the Text::CSV::Hashify manual is relatively
&gt; easy to do in Text::CSV_XS &#40;and Text::CSV&#41;. I&#39;d use the csv function
&gt; 
&gt;   use Text::CSV::Hashify;
&gt;   $obj = Text::CSV::Hashify-&gt;new &#40;{
&gt;       file      =&gt; &#34;/path/to/file.csv&#34;,
&gt;       format    =&gt; &#34;hoh&#34;, # hash of hashes, which is default
&gt;       key       =&gt; &#34;id&#34;,  # needed except when format is &#39;aoh&#39;
&gt;       max_rows  =&gt; 20,    # number of records to read; defaults to all
&gt;       # ... other key-value pairs as appropriate from Text::CSV
&gt;       }&#41;;
&gt;   $hash_ref     = $obj-&gt;all;
&gt; 
&gt; =&gt;
&gt; 
&gt;   use Text::CSV_XS &#34;csv&#34;;
&gt;   $hash_ref = csv &#40;
&gt;       in       =&gt; &#34;path/to/file&#34;,
&gt;       bom      =&gt; 1, # Implies -&gt;header call for BOM detection and header
&gt;       key      =&gt; &#34;id&#34;,
&gt;       fragment =&gt; &#34;row=1-20&#34;,
&gt;       # ... other key-value pairs for Text::CSV_XS
&gt;       &#41;;
&gt; 
&gt; &#40;where I must add the remark that in the *current* implementation, the
&gt; combination of both key and fragment attribute will cause the key
&gt; attribute to be ignored, which I consider a bug. Please file a ticket
&gt; if you agree :&#41;
&gt; 
&gt; Does this all make sense?
</div>
Hi,

Sorry for the delay &#40;holidays!&#41;.
This makes sense to me, but I cannot get it to work.

I had the following working code &#40;working when no BOM is present:

        $obj = Text::CSV::Hashify-&gt;new&#40; {
                        file    =&gt; $csv,
                        format      =&gt; &#39;aoh&#39; # array of hashes
                        } &#41;;
        return $obj-&gt;all;

and changed it to:
        return csv&#40; {
                in      =&gt; $csv,
                detect_bom      =&gt; 1,
                headers =&gt; &#34;auto&#34;
        } &#41;;

But I get the following error:
INI - the header contains an empty field at &lt;somehwere&gt;
This was triggered by the following code:
    my $ref = ref $hdrs
        ? # aoh
          do {
            my @h = $csv-&gt;column_names &#40;$hdrs&#41;;
            my %h; $h{$_}++ for @h;
            exists $h{&#34;&#34;} and croak &#40;$csv-&gt;SetDiag &#40;1012&#41;&#41;;

Here is a smaple csv that will trigger the error:
Header1,Header2,Header3
val1,,val3

I tried to see what&#39;s going on but I guess I don&#39;t really understand the code.

-Guido
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;09&nbsp;03:06:24&nbsp;2019</span>
    <span class="description">guido [...] gvr.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #130048] Text::CSV::Hashify feature request</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 9 Aug 2019 09:06:15 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;h.m.brand [...] xs4all.nl via RT&#34; &lt;bug-Text-CSV-Hashify [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Guido van Rooij &lt;guido [...] gvr.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, Aug 08, 2019 at 01:17:21PM +0200, Guido van Rooij wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I tried to see what&#39;s going on but I guess I don&#39;t really understand the code.
&gt; 
</div>
The problem seems to be the fact that when the bom_detect option is set,
the following code is executed:
        @row1 = $csv-&gt;header &#40;$fh, \%harg&#41;;
        my @hdr = $csv-&gt;column_names;
        @hdr and $hdrs ||= \@hdr;
so in this piece of code, the header is read in.

Yet in this code:
            elsif &#40;$hdrs eq &#34;auto&#34;&#41; {
                my $h = $csv-&gt;getline &#40;$fh&#41; or return;
                $hdrs = [ map {      $hdr{$_} || $_ } @$h ];
                }
anothre attempt is done to read in the headers. In this case, the getline
call actually reads in the second line of the csv file.

Note that this code:
        defined $c-&gt;{hd_d} and $harg{detect_bom}         = $c-&gt;{hd_b};
is wrong and should read
        defined $c-&gt;{hd_b} and $harg{detect_bom}         = $c-&gt;{hd_b};

-Guido
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
