<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #71651 for Data-Plist: [PATCH] Add XML Reader</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #71651 for Data-Plist: [PATCH] Add XML Reader</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Data-Plist/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Data-Plist/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Data-Plist/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Data-Plist/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Data-Plist">Data-Plist CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">71651</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Data-Plist/Active/">Data-Plist</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
lubo.rintel [...] gooddata.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-223332-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-223333-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;13&nbsp;03:04:35&nbsp;2011</span>
    <span class="description">lubo.rintel [...] gooddata.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] Add XML Reader</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">See attached file.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Add-XML-Reader.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From d0b7b62d04b1386254732e915f1684823287232c Mon Sep 17 00:00:00 2001
From: Lubomir Rintel &lt;lkundrak@v3.sk&gt;
Date: Thu, 13 Oct 2011 09:00:53 +0200
Subject: [PATCH] Add XML Reader

---
 Makefile.PL                 |    2 +
 lib/Data/Plist.pm           |    5 ++-
 lib/Data/Plist/XMLReader.pm |  126 +++++++++++++++++++++++++++++++++++++++++++
 t/xml-read.t                |   79 +++++++++++++++++++++++++++
 4 files changed, 211 insertions&#40;+&#41;, 1 deletions&#40;-&#41;
 create mode 100644 lib/Data/Plist/XMLReader.pm
 create mode 100644 t/xml-read.t

diff --git a/Makefile.PL b/Makefile.PL
index cde71bf..c5f6db1 100644
--- a/Makefile.PL
+++ b/Makefile.PL
@@ -14,5 +14,7 @@ requires&#40;&#39;Scalar::Util&#39;&#41;;
 requires&#40;&#39;UNIVERSAL::isa&#39;&#41;;
 requires&#40;&#39;UNIVERSAL::require&#39;&#41;;
 requires&#40;&#39;XML::Writer&#39;&#41;;
+requires&#40;&#39;XML::Parser&#39;&#41;;
+test_requires &#40;&#39;Test::Deep&#39;&#41;;
 
 &#38;WriteAll;
diff --git a/lib/Data/Plist.pm b/lib/Data/Plist.pm
index 3798587..3d8fc71 100644
--- a/lib/Data/Plist.pm
+++ b/lib/Data/Plist.pm
@@ -267,7 +267,8 @@ L&lt;XML::Writer&gt;
 
 =head1 BUGS AND LIMITATIONS
 
-No XML reader is included at current.
+UIDs don&#39;t seem to be sufficiently well supported by the XML
+readers and writers.
 
 Please report any bugs or feature requests to
 C&lt;bug-Data-Plist@rt.cpan.org&gt;, or through the web interface at
@@ -277,6 +278,8 @@ L&lt;<span class="clickylink"><a target="new" rel="nofollow" href="/">http://rt.cpan.org</a></span>&gt;.
 
 Alex Vandiver and Jacky Chang.
 
+XML reader support added by Lubomir Rintel &lt;lkundrak@v3.sk&gt;
+
 Based on plutil.pl, written by Pete Wilson &lt;wilsonpm@gamewood.net&gt;
 
 =head1 LICENSE
diff --git a/lib/Data/Plist/XMLReader.pm b/lib/Data/Plist/XMLReader.pm
new file mode 100644
index 0000000..a912fb2
--- /dev/null
+++ b/lib/Data/Plist/XMLReader.pm
@@ -0,0 +1,126 @@
+=head1 NAME
+
+Data::Plist::XMLReader - Creates Data::Plists from XML files
+
+=head1 SYNOPSIS
+
+ # Create new
+ my $read = Data::Plist::XMLReader-&gt;new;
+
+ # Read from a string
+ my $plist = $read-&gt;open_string&#40;$xmlstring&#41;;
+
+ # Read from a XML file
+ $plist = $read-&gt;open_fh&#40;$filename&#41;;
+
+=head1 DESCRIPTION
+
+C&lt;Data::Plist::XMLReader&gt; takes data formatted as one of
+Apple&#39;s XML property lists, either from a string or a
+filehandle and returns it as a C&lt;Data::Plist&gt;.
+
+=cut
+
+package Data::Plist::XMLReader;
+
+use strict;
+use warnings;
+
+use base qw/Data::Plist::Reader/;
+use Data::Plist;
+
+use XML::Parser;
+use MIME::Base64;
+
+=head1 METHODS
+
+=head2 walk $tree
+
+Returns data for given part of XML parse tree.
+
+=cut
+
+sub walk
+{
+    my $tree = shift;
+
+    my @retval;
+    while &#40; @$tree &#41; {
+        my $tag = shift @$tree;
+        my $kids = shift @$tree;
+
+        # Raw value
+        if &#40; $tag eq &#39;0&#39; &#41; {
+            # Skip empty
+            push @retval, $kids if $kids =~ /\S/;
+            next;
+        }
+
+        my $attrs = shift @$kids;
+
+        # Root
+        if &#40; $tag eq &#39;plist&#39; &#41; {
+            warn &#39;Unknown version&#39;
+                unless $attrs-&gt;{version} eq &#39;1.0&#39;;
+            push @retval, walk&#40;$kids&#41;;
+
+        # Primitive values
+        } elsif &#40; $tag eq &#39;null&#39; &#41; {
+            push @retval, [ null =&gt; undef ];
+        } elsif &#40; $tag eq &#39;fill&#39; &#41; {
+            push @retval, [ fill =&gt; 15 ];
+        } elsif &#40; $tag eq &#39;integer&#39; &#41; {
+            push @retval, [ integer =&gt; int walk&#40;$kids&#41; ];
+        } elsif &#40; $tag =~ /string|ustring|date|real/ &#41; {
+            push @retval, [ &#34;$tag&#34; =&gt; walk&#40;$kids&#41; ];
+
+        } elsif &#40; $tag eq &#39;data&#39; &#41; {
+            push @retval, [ data =&gt; MIME::Base64::decode_base64 &#40;walk&#40;$kids&#41;&#41; ];
+
+	# Boolean
+        } elsif &#40; $tag eq &#39;true&#39; &#41; {
+            push @retval, [ true =&gt; 1 ];
+        } elsif &#40; $tag eq &#39;false&#39; &#41; {
+            push @retval, [ false =&gt; 0 ];
+
+        # Compounds
+        } elsif &#40; $tag eq &#39;key&#39; &#41; {
+            push @retval, walk&#40;$kids&#41;;
+        } elsif &#40; $tag eq &#39;dict&#39; &#41; {
+            my %kiddies = walk&#40;$kids&#41;;
+            $kiddies{UID} = delete $kiddies{&#39;CF$UID&#39;}
+		if exists $kiddies{&#39;CF$UID&#39;};
+            push @retval, [ dict =&gt; \%kiddies ];
+        } elsif &#40; $tag eq &#39;array&#39; &#41; {
+            push @retval, [ array =&gt; [ walk&#40;$kids&#41; ] ];
+
+        # Unknown tag
+        } else {
+            push @retval, [ $tag =&gt; walk&#40;$kids&#41; ];
+        }
+    }
+
+    return shift @retval unless wantarray;
+    return @retval;
+}
+
+=head2 open_fh $filehandle
+
+Used for reading XML data from a filehandle
+C&lt;$filehandle&gt; rather than a string.
+Returns a C&lt;Data::Plist&gt; containing the top object
+of the C&lt;XML::Parser&gt; tree after it&#39;s been passed to
+L&lt;/walk&gt;.
+
+=cut
+
+sub open_fh {
+    my $self = shift;
+    $self = $self-&gt;new&#40;&#41; unless ref $self;
+
+    my&#40;$fh&#41; = @_;
+    my $tree = XML::Parser-&gt;new&#40; Style =&gt; &#39;Tree&#39; &#41;-&gt;parse&#40;$fh&#41;;
+    return Data::Plist-&gt;new&#40; data =&gt; walk&#40;$tree&#41; &#41;;
+}
+
+1;
diff --git a/t/xml-read.t b/t/xml-read.t
new file mode 100644
index 0000000..2740dc9
--- /dev/null
+++ b/t/xml-read.t
@@ -0,0 +1,79 @@
+use Test::More tests =&gt; 2;
+use Test::Deep;
+use Data::Plist::XMLReader;
+
+use strict;
+use warnings;
+
+my $xml = &lt;&lt;&#39;EOXML&#39;;
+&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
+&lt;!DOCTYPE plist PUBLIC &#34;-//Apple//DTD PLIST 1.0//EN&#34; &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.apple.com/DTDs/PropertyList-1.0.dtd">http://www.apple.com/DTDs/PropertyList-1.0.dtd</a></span>&#34;&gt;
+
+&lt;plist version=&#34;1.0&#34;&gt;
+    &lt;dict&gt;
+        &lt;key&gt;Hello&lt;/key&gt;
+        &lt;string&gt;World&lt;/string&gt;
+        &lt;key&gt;Beast&lt;/key&gt;
+        &lt;integer&gt;666&lt;/integer&gt;
+        &lt;key&gt;CF$UID&lt;/key&gt;
+        &lt;integer&gt;1&lt;/integer&gt;
+        &lt;key&gt;Beefy&lt;/key&gt;
+        &lt;bacon&gt;&lt;miracle /&gt;&lt;/bacon&gt;
+        &lt;key&gt;Stuff&lt;/key&gt;
+        &lt;array&gt;
+            &lt;ustring&gt;foo bar baz&lt;/ustring&gt;
+            &lt;real&gt;13.37&lt;/real&gt;
+            &lt;date&gt;1318489009&lt;/date&gt;
+            &lt;true /&gt;
+            &lt;false /&gt;
+            &lt;null /&gt;
+            &lt;array /&gt;
+            &lt;dict /&gt;
+            &lt;data&gt;c3R1AGZm
+&lt;/data&gt;
+            &lt;fill /&gt;
+        &lt;/array&gt;
+    &lt;/dict&gt;
+&lt;/plist&gt;
+EOXML
+
+my $reader = Data::Plist::XMLReader-&gt;new &#40;&#41;;
+my $data = $reader-&gt;open_string&#40;$xml&#41;;
+
+cmp_deeply&#40; $data-&gt;{data}, [ &#39;dict&#39; =&gt; {
+    &#39;Beefy&#39; =&gt; [ &#39;bacon&#39;, [ &#39;miracle&#39;, ] ],
+    &#39;Beast&#39; =&gt; [ &#39;integer&#39;, 666 ],
+    &#39;UID&#39; =&gt; [ &#39;integer&#39;, 1 ],
+    &#39;Hello&#39; =&gt; [ &#39;string&#39;, &#39;World&#39; ],
+    &#39;Stuff&#39; =&gt; [ &#39;array&#39;, [
+        [ &#39;ustring&#39;, &#39;foo bar baz&#39; ],
+        [ &#39;real&#39;, &#39;13.37&#39; ],
+        [ &#39;date&#39;, &#39;1318489009&#39; ],
+        [ &#39;true&#39;, 1 ],
+        [ &#39;false&#39;, 0 ],
+        [ &#39;null&#39;, undef ],
+        [ &#39;array&#39;, [] ],
+        [ &#39;dict&#39;, {} ],
+        [ &#39;data&#39;, &#34;stu\x00ff&#34; ],
+        [ &#39;fill&#39;, 15 ],
+    ]]
+}]&#41;;
+
+cmp_deeply&#40; $data-&gt;data, {
+    &#39;Beast&#39; =&gt; 666,
+    &#39;Beefy&#39; =&gt; [ &#39;miracle&#39; ],
+    &#39;UID&#39; =&gt; 1,
+    &#39;Hello&#39; =&gt; &#39;World&#39;,
+    &#39;Stuff&#39; =&gt; [
+        &#39;foo bar baz&#39;,
+        &#39;13.37&#39;,
+        isa&#40;&#39;DateTime&#39;&#41;,
+        1,
+        0,
+        undef,
+        [],
+        {},
+        &#34;stu\x00ff&#34;,
+        15
+    ],
+}&#41;;
-- 
1.7.1

</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
