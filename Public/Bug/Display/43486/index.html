<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #43486 for XML-Twig: XML::Twig keep_encoding option fails if previous XML::Twig found a special case.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #43486 for XML-Twig: XML::Twig keep_encoding option fails if previous XML::Twig found a special case.</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=XML-Twig">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=XML-Twig">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=XML-Twig">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=XML-Twig">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-Twig">XML-Twig CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">43486</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=XML-Twig">XML-Twig</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
drieux [...] wetware.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-37682-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
3.32    </td>
  </tr>
  <tr id="CF-37683-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




xml_twig_error.tar<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/568429/286777/xml_twig_error.tar">
Fri Feb 20 22:25:01 2009 (40k) by drieux [...] wetware.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=43486">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-568429" href="/Public/Bug/Display.html?id=43486#txn-568429">#</a>      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;20&nbsp;22:25:01&nbsp;2009</span>
    <span class="description">drieux [...] wetware.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> XML::Twig keep_encoding option fails if previous XML::Twig found
 a special case.</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/568429/286774/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/286774">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 969b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have attached a tarball that contains the problem_case.t, as well as
other demonstration code, and associated test_data files.

The problem arises only if one needs to use the keep_encoding option.

We need to use it for processing XML documents that can contain special
unicode characters, such as bullets, as well as XML that may have been
saved in a file format other than utf-8.

The problem occurs if an XML::Twig is constructed without the
keep_encoding set, and the twig-&gt;parse&#40;&#41; is called on content that
contains the XML element &lt;Chapter&gt;.

Subsequent XML::Twigs, which need to have the keep_encoding set will
fail to process special characters properly:

#          got: &#39;&lt;Chapter&gt;The BulletÃ¢Â€Â¢ you install:&lt;/Chapter&gt;&#39;
#     expected: &#39;&lt;Chapter&gt;The Bulletâ€¢ you install:&lt;/Chapter&gt;&#39;

I have not had time to resolve why it is the &lt;Chapter&gt; causes this
problem. But it appears to be uniq, since &lt;Chapters&gt;, &lt;chapter&gt; and
&lt;Chapte&gt; will not cause the error.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> xml_twig_error.tar</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/568429/286777/xml_twig_error.tar">Download xml_twig_error.tar</a><br />
<span class="downloadcontenttype">application/x-tar 40k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-601954" href="/Public/Bug/Display.html?id=43486#txn-601954">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;07&nbsp;09:18:23&nbsp;2009</span>
    <span class="description">MIROD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/601954/305157/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/305157">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Feb 20 22:25:01 2009, DRIEUX wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have attached a tarball that contains the problem_case.t, as well as
&gt; other demonstration code, and associated test_data files.
&gt; 
&gt; The problem arises only if one needs to use the keep_encoding option.
&gt; 
&gt; We need to use it for processing XML documents that can contain special
&gt; unicode characters, such as bullets, as well as XML that may have been
&gt; saved in a file format other than utf-8.
&gt; 
&gt; The problem occurs if an XML::Twig is constructed without the
&gt; keep_encoding set, and the twig-&gt;parse&#40;&#41; is called on content that
&gt; contains the XML element &lt;Chapter&gt;.
&gt; 
&gt; Subsequent XML::Twigs, which need to have the keep_encoding set will
&gt; fail to process special characters properly:
&gt; 
&gt; #          got: &#39;&lt;Chapter&gt;The BulletÃ¢Â€Â¢ you install:&lt;/Chapter&gt;&#39;
&gt; #     expected: &#39;&lt;Chapter&gt;The Bulletâ€¢ you install:&lt;/Chapter&gt;&#39;
&gt; 
&gt; I have not had time to resolve why it is the &lt;Chapter&gt; causes this
&gt; problem. But it appears to be uniq, since &lt;Chapters&gt;, &lt;chapter&gt; and
&gt; &lt;Chapte&gt; will not cause the error.
</div>

I am sorry I did not reply before, but for some reason I did not get the
RT notification.

I looked into it, and it looks like a tricky one. Encoding problems
often are. I&#39;ll keep looking at it, and see if I can figure something out.

__
mirod
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-601955" href="/Public/Bug/Display.html?id=43486#txn-601955">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;07&nbsp;09:18:23&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-602075" href="/Public/Bug/Display.html?id=43486#txn-602075">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;07&nbsp;13:55:41&nbsp;2009</span>
    <span class="description">MIROD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/602075/305218/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/305218">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Feb 20 22:25:01 2009, DRIEUX wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have attached a tarball that contains the problem_case.t, as well as
&gt; other demonstration code, and associated test_data files.
&gt; 
&gt; The problem arises only if one needs to use the keep_encoding option.
&gt; 
&gt; We need to use it for processing XML documents that can contain special
&gt; unicode characters, such as bullets, as well as XML that may have been
&gt; saved in a file format other than utf-8.
&gt; 
&gt; The problem occurs if an XML::Twig is constructed without the
&gt; keep_encoding set, and the twig-&gt;parse&#40;&#41; is called on content that
&gt; contains the XML element &lt;Chapter&gt;.
&gt; 
&gt; Subsequent XML::Twigs, which need to have the keep_encoding set will
&gt; fail to process special characters properly:
&gt; 
&gt; #          got: &#39;&lt;Chapter&gt;The BulletÃ¢Â€Â¢ you install:&lt;/Chapter&gt;&#39;
&gt; #     expected: &#39;&lt;Chapter&gt;The Bulletâ€¢ you install:&lt;/Chapter&gt;&#39;
&gt; 
&gt; I have not had time to resolve why it is the &lt;Chapter&gt; causes this
&gt; problem. But it appears to be uniq, since &lt;Chapters&gt;, &lt;chapter&gt; and
&gt; &lt;Chapte&gt; will not cause the error.
</div>

This is one of the weirdest bug I have ever seen. Even &lt;d&gt;&lt;e&gt;The Bulletâ€¢
you install:&lt;/e&gt;&lt;Chapter/&gt;&lt;/d&gt; causes the problem, but anything other
spelling for Chapter doesn&#39;t. 

I am a bit stumped. I have no idea why &#39;Chapter&#39; would be special and
cause the string to be treated any different than any other tag.
Especially as the problem occurs even *before* the Chapter tag is
parsed, as you can see if you add a handler to output the element
content during the parsing:
        my $twig2 = XML::Twig-&gt;new&#40;%params, twig_handlers =&gt; { _all_ =&gt;
sub { warn &#34;DUMP: &#34;, $_-&gt;gi, &#34;: &#34;, $_-&gt;sprint }}&#41;;

There are so many stars that need to be exactly aligned for this bug to
occur that I think it&#39;s either something completely obvious that I can&#39;t
see for now, or a random interaction between expat at the C level and
some perl encoding oddity, triggered by XML::Twig&#39;s clumsy attempts at
working sort of the same both in utf8 mode and natively with other
encodings.

__
mirod
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-602231" href="/Public/Bug/Display.html?id=43486#txn-602231">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;07&nbsp;19:08:23&nbsp;2009</span>
    <span class="description">drieux [...] wetware.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #43486] XML::Twig keep_encoding option fails if previous XML::Twig found a special case. </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 7 May 2009 16:07:57 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> drieux &lt;drieux [...] wetware.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/602231/305295/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/305295">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On May 7, 2009, at 10:55 AM, MIROD via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=43486">https://rt.cpan.org/Ticket/Display.html?id=43486</a></span> &gt;
</div>[..]
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This is one of the weirdest bug I have ever seen. Even &lt;d&gt;&lt;e&gt;The 
&gt; Bulletâ€¢
&gt; you install:&lt;/e&gt;&lt;Chapter/&gt;&lt;/d&gt; causes the problem, but anything other
&gt; spelling for Chapter doesn&#39;t.
&gt;
&gt; I am a bit stumped. I have no idea why &#39;Chapter&#39; would be special and
&gt; cause the string to be treated any different than any other tag.
</div>
That was the sheer madness that I ran into.

Also why I logged the bug, since, well, it is replicatable.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Especially as the problem occurs even *before* the Chapter tag is
&gt; parsed, as you can see if you add a handler to output the element
&gt; content during the parsing:
&gt;         my $twig2 = XML::Twig-&gt;new&#40;%params, twig_handlers =&gt; { _all_ =&gt;
&gt; sub { warn &#34;DUMP: &#34;, $_-&gt;gi, &#34;: &#34;, $_-&gt;sprint }}&#41;;
</div>
HUM.....


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; There are so many stars that need to be exactly aligned for this bug to
&gt; occur that I think it&#39;s either something completely obvious that I 
&gt; can&#39;t
&gt; see for now, or a random interaction between expat at the C level and
&gt; some perl encoding oddity, triggered by XML::Twig&#39;s clumsy attempts at
&gt; working sort of the same both in utf8 mode and natively with other
&gt; encodings.
</div>
that was my presumption, but at the time i was working on a &#39;single 
source document&#39; system,
that used &lt;Chapter&gt; for every chapter in a book, so I had no time then 
to do the work on it.

What I will do is see if I can get any time to go into the process and 
figure out if there is more detail there.

ciao
drieux

----
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/602231/305296/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/305296">with headers</a>
<br />
<span class="downloadcontenttype">text/enriched 1.6k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-602652" href="/Public/Bug/Display.html?id=43486#txn-602652">#</a>      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;08&nbsp;12:00:59&nbsp;2009</span>
    <span class="description">xmltwig [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #43486] XML::Twig keep_encoding option fails if previous XML::Twig found a special case.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 08 May 2009 18:00:39 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mirod &lt;xmltwig [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/602652/305491/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/305491">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">So I got a little further.

The problem doesn&#39;t happen when I replace the call to parse &#40;on a string&#41; by a 
call to parsefile, on the original file.

So I displayed the utf8&#39;edness of the strings before being parsed &#40;checked with 
Encode::is_utf8&#41;, and the result is below &#40;note that I changed Chapter to 
tChapter in the first test&#41;: the problem comes when the string want_round_trip 
contains utf8 characters and it has the utf8 flag... still weird. I don&#39;t know 
why it loses the utf8 flag in the first test, and in any case I would think that 
the test would fail when it does NOT have the flag, not when it has it.

At least it looks like if you parse from the file you don&#39;t have a problem. Do 
you find this to be the case when you do this?

# string is NOT utf8
# xml: &#39;&lt;tChapter&gt;The Bulletâ€¢ you install:&lt;/tChapter&gt;&#39;
ok 1 - roundTripSafe - xml from noHeading.xml equals sprint from twig root
# round trip: &#39;&lt;tChapter&gt;The Bulletâ€¢ you install:&lt;/tChapter&gt;&#39;
# want_round_trip string is NOT utf8
ok 2 - roundTripSafe - noHeading.xml after processing &#39;specialCase&#39;
# string is NOT utf8
# xml: &#39;&lt;d&gt;&lt;e&gt;The Bulletâ€¢ you install:&lt;/e&gt;&lt;Chapter&gt;The Bulletâ€¢ you 
install:&lt;/Chapter&gt;&lt;/d&gt;&#39;
ok 3 - roundTripSafe - xml from heading.xml equals sprint from twig root
# round trip: &#39;&lt;d&gt;&lt;e&gt;The Bulletâ€¢ you install:&lt;/e&gt;&lt;Chapter&gt;The Bulletâ€¢ you 
install:&lt;/Chapter&gt;&lt;/d&gt;&#39;
# want_round_trip string is utf8
not ok 4 - roundTripSafe - heading.xml after processing &#39;specialCase&#39;
#   Failed test &#39;roundTripSafe - heading.xml after processing &#39;specialCase&#39;&#39;
#   at problem_case.t line 124.
#          got: &#39;&lt;d&gt;&lt;e&gt;The BulletÃ¢Â¢ you install:&lt;/e&gt;&lt;Chapter&gt;The BulletÃ¢Â¢ you 
install:&lt;/Chapter&gt;&lt;/d&gt;&#39;
#     expected: &#39;&lt;d&gt;&lt;e&gt;The Bulletâ€¢ you install:&lt;/e&gt;&lt;Chapter&gt;The Bulletâ€¢ you 
install:&lt;/Chapter&gt;&lt;/d&gt;&#39;
# string is NOT utf8
# xml: &#39;&lt;foo&gt;&lt;Chapter&gt;&#38;lt;PsuedoElement&gt; start&#38;#160;finish&lt;/Chapter&gt;&lt;/foo&gt;&#39;
ok 5 - roundTripSafe - xml from compound.xml equals sprint from twig root
# round trip: &#39;&lt;foo&gt;&lt;Chapter&gt;&#38;lt;PsuedoElement&gt; start&#38;#160;finish&lt;/Chapter&gt;&lt;/foo&gt;&#39;
# want_round_trip string is utf8
ok 6 - roundTripSafe - compound.xml after processing &#39;specialCase&#39;
1..6
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-602827" href="/Public/Bug/Display.html?id=43486#txn-602827">#</a>      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;08&nbsp;18:33:31&nbsp;2009</span>
    <span class="description">drieux [...] wetware.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #43486] XML::Twig keep_encoding option fails if previous XML::Twig found a special case.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 8 May 2009 15:33:06 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> drieux &lt;drieux [...] wetware.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/602827/305580/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/305580">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On May 8, 2009, at 9:01 AM, xmltwig@gmail.com via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The problem doesn&#39;t happen when I replace the call to parse &#40;on a 
&gt; string&#41; by a
&gt; call to parsefile, on the original file.
</div>
ok, not sure about that.  So that you understand a bit more of the 
process we used,
there are Test::Class based modules that would need to create XML from 
&#39;strings&#39; with
parse&#40;&#41; because these did not need to actually have a file, so we were 
not using parsefile&#40;&#41;.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So I displayed the utf8&#39;edness of the strings before being parsed 
&gt; &#40;checked with
&gt; Encode::is_utf8&#41;, and the result is below &#40;note that I changed Chapter 
&gt; to
&gt; tChapter in the first test&#41;: the problem comes when the string 
&gt; want_round_trip
&gt; contains utf8 characters and it has the utf8 flag... still weird. I 
&gt; don&#39;t know
&gt; why it loses the utf8 flag in the first test, and in any case I would 
&gt; think that
&gt; the test would fail when it does NOT have the flag, not when it has it.
</div>
ouch.  What ever is happening there seems to be the majik that needs to 
be fixed.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; At least it looks like if you parse from the file you don&#39;t have a 
&gt; problem. Do
&gt; you find this to be the case when you do this?
</div>
I am not on the that project at this moment, but a part of the problem 
is
going to be the need to use both parse&#40;&#41; and parsefile&#40;&#41; and still have
the data round trip safe.

I can not recall what our work around was, it may have been that all 
data read from files went through parsefile&#40;&#41;.


ciao
drieux

----
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/602827/305581/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/305581">with headers</a>
<br />
<span class="downloadcontenttype">text/enriched 1.5k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.450743</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
