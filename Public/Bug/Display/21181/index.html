<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #21181 for Tcl: Tcl Segfaults on SuSE 10.1 x86_64</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #21181 for Tcl: Tcl Segfaults on SuSE 10.1 x86_64</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Tcl/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Tcl/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Tcl/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Tcl/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Tcl">Tcl CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">21181</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Tcl/Active/">Tcl</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jlange6648 [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-30776-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.89    </td>
  </tr>
  <tr id="CF-30777-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.06    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;25&nbsp;15:26:59&nbsp;2006</span>
    <span class="description">jlange6648 [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Tcl Segfaults on SuSE 10.1 x86_64</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On SuSE 10.1 x86_64, attempting to use the Tcl module causes a
segmentaion fault.

the CPAN tests work properly however.

below is some output showing the error.

****
jkl@automation:~&gt; perl -e &#39;use Tcl;&#39;
Segmentation fault


*****
automation:~/.cpan/build/Tcl-0.89 # gdb perl
GNU gdb 6.4
Copyright 2005 Free Software Foundation, Inc.
GDB is free software, covered by the GNU General Public License, and you are
welcome to change it and/or distribute copies of it under certain
conditions.
Type &#34;show copying&#34; to see the conditions.
There is absolutely no warranty for GDB.  Type &#34;show warranty&#34; for details.
This GDB was configured as &#34;x86_64-suse-linux&#34;...&#40;no debugging symbols
found&#41;
Using host libthread_db library &#34;/lib64/libthread_db.so.1&#34;.

&#40;gdb&#41; set args -e &#39;use Tcl;&#39;
&#40;gdb&#41; run
Starting program: /usr/bin/perl -e &#39;use Tcl;&#39;
&#40;no debugging symbols found&#41;
&#40;no debugging symbols found&#41;
&#40;no debugging symbols found&#41;
&#40;no debugging symbols found&#41;
&#40;no debugging symbols found&#41;
[Thread debugging using libthread_db enabled]
[New Thread 47834521734000 &#40;LWP 5612&#41;]
&#40;no debugging symbols found&#41;

Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread 47834521734000 &#40;LWP 5612&#41;]
0x00002b8157ad5b22 in boot_Tcl &#40;my_perl=0x63b010, cv=&lt;value optimized
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">out&gt;&#41; at Tcl.xs:426
</div>426             tclKit_AppInit = Tcl_Init;
&#40;gdb&#41; bt
#0  0x00002b8157ad5b22 in boot_Tcl &#40;my_perl=0x63b010, cv=&lt;value
optimized out&gt;&#41; at Tcl.xs:426
#1  0x0000000000482cf2 in Perl_pp_entersub &#40;&#41;
#2  0x000000000046515e in Perl_runops_debug &#40;&#41;
#3  0x0000000000423fff in Perl_call_sv &#40;&#41;
#4  0x00000000004244d9 in Perl_call_list &#40;&#41;
#5  0x00000000004545ac in Perl_newATTRSUB &#40;&#41;
#6  0x0000000000452af4 in Perl_utilize &#40;&#41;
#7  0x0000000000444ddd in Perl_yyparse &#40;&#41;
#8  0x00000000004225b3 in perl_free &#40;&#41;
#9  0x000000000042519d in perl_parse &#40;&#41;
#10 0x000000000041d674 in main &#40;&#41;
&#40;gdb&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;30&nbsp;12:48:31&nbsp;2006</span>
    <span class="description">VKON [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I suspect this is due to wrong *.lib files within Tcl-0.89 distribution.
&#40;I mean these -- <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/src/VKON/Tcl-0.89/tcl-core/&#41;">http://search.cpan.org/src/VKON/Tcl-0.89/tcl-core/&#41;</a></span>

Can you please try latest CVS version, which is at
<span class="clickylink"><a target="new" rel="nofollow" href="http://tcltkce.cvs.sourceforge.net/tcltkce/Tcl/">http://tcltkce.cvs.sourceforge.net/tcltkce/Tcl/</a></span>, or may be wait for 0.90
version, which will hopefully be soon...

Best regards,
Vadim.

On Fri Aug 25 15:26:59 2006, jlange6648 wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On SuSE 10.1 x86_64, attempting to use the Tcl module causes a
&gt; segmentaion fault.
&gt; 
&gt; the CPAN tests work properly however.
&gt; 
&gt; below is some output showing the error.
&gt; 
&gt; ****
&gt; jkl@automation:~&gt; perl -e &#39;use Tcl;&#39;
&gt; Segmentation fault
&gt; 
&gt; 
&gt; *****
&gt; automation:~/.cpan/build/Tcl-0.89 # gdb perl
&gt; GNU gdb 6.4
&gt; Copyright 2005 Free Software Foundation, Inc.
&gt; GDB is free software, covered by the GNU General Public License, and
</div>you are
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; welcome to change it and/or distribute copies of it under certain
&gt; conditions.
&gt; Type &#34;show copying&#34; to see the conditions.
&gt; There is absolutely no warranty for GDB.  Type &#34;show warranty&#34; for
</div>details.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This GDB was configured as &#34;x86_64-suse-linux&#34;...&#40;no debugging symbols
&gt; found&#41;
&gt; Using host libthread_db library &#34;/lib64/libthread_db.so.1&#34;.
&gt; 
&gt; &#40;gdb&#41; set args -e &#39;use Tcl;&#39;
&gt; &#40;gdb&#41; run
&gt; Starting program: /usr/bin/perl -e &#39;use Tcl;&#39;
&gt; &#40;no debugging symbols found&#41;
&gt; &#40;no debugging symbols found&#41;
&gt; &#40;no debugging symbols found&#41;
&gt; &#40;no debugging symbols found&#41;
&gt; &#40;no debugging symbols found&#41;
&gt; [Thread debugging using libthread_db enabled]
&gt; [New Thread 47834521734000 &#40;LWP 5612&#41;]
&gt; &#40;no debugging symbols found&#41;
&gt; 
&gt; Program received signal SIGSEGV, Segmentation fault.
&gt; [Switching to Thread 47834521734000 &#40;LWP 5612&#41;]
&gt; 0x00002b8157ad5b22 in boot_Tcl &#40;my_perl=0x63b010, cv=&lt;value optimized
<div class="message-stanza open">&gt; out&gt;&#41; at Tcl.xs:426
</div>&gt; 426             tclKit_AppInit = Tcl_Init;
&gt; &#40;gdb&#41; bt
&gt; #0  0x00002b8157ad5b22 in boot_Tcl &#40;my_perl=0x63b010, cv=&lt;value
&gt; optimized out&gt;&#41; at Tcl.xs:426
&gt; #1  0x0000000000482cf2 in Perl_pp_entersub &#40;&#41;
&gt; #2  0x000000000046515e in Perl_runops_debug &#40;&#41;
&gt; #3  0x0000000000423fff in Perl_call_sv &#40;&#41;
&gt; #4  0x00000000004244d9 in Perl_call_list &#40;&#41;
&gt; #5  0x00000000004545ac in Perl_newATTRSUB &#40;&#41;
&gt; #6  0x0000000000452af4 in Perl_utilize &#40;&#41;
&gt; #7  0x0000000000444ddd in Perl_yyparse &#40;&#41;
&gt; #8  0x00000000004225b3 in perl_free &#40;&#41;
&gt; #9  0x000000000042519d in perl_parse &#40;&#41;
&gt; #10 0x000000000041d674 in main &#40;&#41;
&gt; &#40;gdb&#41;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;30&nbsp;12:48:32&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;30&nbsp;14:39:19&nbsp;2006</span>
    <span class="description">jlange6648 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #21181] Tcl Segfaults on SuSE 10.1 x86_64</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 30 Aug 2006 14:39:07 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Jeff Lange&#34; &lt;jlange6648 [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">That didn&#39;t seem to make any difference.

I have found however that if PERL_DL_NONLAZY is set to 1, it will work..
which explains why &#39;make test&#39;  works.

-Jeff


On 8/30/06, via RT &lt;bug-Tcl@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt;
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=21181">http://rt.cpan.org/Ticket/Display.html?id=21181</a></span> &gt;
&gt;
&gt; I suspect this is due to wrong *.lib files within Tcl-0.89 distribution.
&gt; &#40;I mean these -- <span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/src/VKON/Tcl-0.89/tcl-core/&#41;">http://search.cpan.org/src/VKON/Tcl-0.89/tcl-core/&#41;</a></span>
&gt;
&gt; Can you please try latest CVS version, which is at
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://tcltkce.cvs.sourceforge.net/tcltkce/Tcl/">http://tcltkce.cvs.sourceforge.net/tcltkce/Tcl/</a></span>, or may be wait for 0.90
&gt; version, which will hopefully be soon...
&gt;
&gt; Best regards,
&gt; Vadim.
&gt;
&gt; On Fri Aug 25 15:26:59 2006, jlange6648 wrote:
<div class="message-stanza open">&gt; &gt; On SuSE 10.1 x86_64, attempting to use the Tcl module causes a
&gt; &gt; segmentaion fault.
&gt; &gt;
&gt; &gt; the CPAN tests work properly however.
&gt; &gt;
&gt; &gt; below is some output showing the error.
&gt; &gt;
&gt; &gt; ****
&gt; &gt; jkl@automation:~&gt; perl -e &#39;use Tcl;&#39;
&gt; &gt; Segmentation fault
&gt; &gt;
&gt; &gt;
&gt; &gt; *****
&gt; &gt; automation:~/.cpan/build/Tcl-0.89 # gdb perl
&gt; &gt; GNU gdb 6.4
&gt; &gt; Copyright 2005 Free Software Foundation, Inc.
&gt; &gt; GDB is free software, covered by the GNU General Public License, and
</div>&gt; you are
<div class="message-stanza open">&gt; &gt; welcome to change it and/or distribute copies of it under certain
&gt; &gt; conditions.
&gt; &gt; Type &#34;show copying&#34; to see the conditions.
&gt; &gt; There is absolutely no warranty for GDB.  Type &#34;show warranty&#34; for
</div>&gt; details.
<div class="message-stanza open">&gt; &gt; This GDB was configured as &#34;x86_64-suse-linux&#34;...&#40;no debugging symbols
&gt; &gt; found&#41;
&gt; &gt; Using host libthread_db library &#34;/lib64/libthread_db.so.1&#34;.
&gt; &gt;
&gt; &gt; &#40;gdb&#41; set args -e &#39;use Tcl;&#39;
&gt; &gt; &#40;gdb&#41; run
&gt; &gt; Starting program: /usr/bin/perl -e &#39;use Tcl;&#39;
&gt; &gt; &#40;no debugging symbols found&#41;
&gt; &gt; &#40;no debugging symbols found&#41;
&gt; &gt; &#40;no debugging symbols found&#41;
&gt; &gt; &#40;no debugging symbols found&#41;
&gt; &gt; &#40;no debugging symbols found&#41;
&gt; &gt; [Thread debugging using libthread_db enabled]
&gt; &gt; [New Thread 47834521734000 &#40;LWP 5612&#41;]
&gt; &gt; &#40;no debugging symbols found&#41;
&gt; &gt;
&gt; &gt; Program received signal SIGSEGV, Segmentation fault.
&gt; &gt; [Switching to Thread 47834521734000 &#40;LWP 5612&#41;]
&gt; &gt; 0x00002b8157ad5b22 in boot_Tcl &#40;my_perl=0x63b010, cv=&lt;value optimized
<div class="message-stanza open">&gt; &gt; out&gt;&#41; at Tcl.xs:426
</div>&gt; &gt; 426             tclKit_AppInit = Tcl_Init;
&gt; &gt; &#40;gdb&#41; bt
&gt; &gt; #0  0x00002b8157ad5b22 in boot_Tcl &#40;my_perl=0x63b010, cv=&lt;value
&gt; &gt; optimized out&gt;&#41; at Tcl.xs:426
&gt; &gt; #1  0x0000000000482cf2 in Perl_pp_entersub &#40;&#41;
&gt; &gt; #2  0x000000000046515e in Perl_runops_debug &#40;&#41;
&gt; &gt; #3  0x0000000000423fff in Perl_call_sv &#40;&#41;
&gt; &gt; #4  0x00000000004244d9 in Perl_call_list &#40;&#41;
&gt; &gt; #5  0x00000000004545ac in Perl_newATTRSUB &#40;&#41;
&gt; &gt; #6  0x0000000000452af4 in Perl_utilize &#40;&#41;
&gt; &gt; #7  0x0000000000444ddd in Perl_yyparse &#40;&#41;
&gt; &gt; #8  0x00000000004225b3 in perl_free &#40;&#41;
&gt; &gt; #9  0x000000000042519d in perl_parse &#40;&#41;
&gt; &gt; #10 0x000000000041d674 in main &#40;&#41;
&gt; &gt; &#40;gdb&#41;
</div>&gt;
&gt;
&gt;
&gt;
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;30&nbsp;14:48:31&nbsp;2006</span>
    <span class="description">VKON [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Aug 30 14:39:19 2006, jlange6648 wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; That didn&#39;t seem to make any difference.
&gt; 
&gt; I have found however that if PERL_DL_NONLAZY is set to 1, it will work..
&gt; which explains why &#39;make test&#39;  works.
</div>
Thanks for looking into this...

Do you reproduce this on AMD64, or on SuSE, or what configuration, in
your opinion, is problematic?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;31&nbsp;08:40:01&nbsp;2006</span>
    <span class="description">jlange6648 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #21181] Tcl Segfaults on SuSE 10.1 x86_64</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 31 Aug 2006 08:39:48 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Jeff Lange&#34; &lt;jlange6648 [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have 2 different boxes running SuSE 10.1 x86_64 on Intel processors, one a
hyperthreaded p4, and one a dual core p4.

I also just tried it on a IBM laptop running SuSE 10.1 x86  and it also
fails, so it looks like a SuSE 10.1 issue, not an x64 issue

to recap:

this works:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;PERL_DL_NONLAZY=1 perl -e &#39;use Tcl;&#39;
</div>
this dosen&#39;t:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;PERL_DL_NONLAZY=0 perl -e &#39;use Tcl;&#39;
</div>
here is the versions of the relevant packaged on my system:
perl-5.8.8-12
tcl-devel-8.4.12-14
tcl-8.4.12-14
tcllib-1.8-10
glibc-2.4-31.1
Tcl.pm from CPAN

Thanks,
 -Jeff


On 8/30/06, via RT &lt;bug-Tcl@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt;
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=21181">http://rt.cpan.org/Ticket/Display.html?id=21181</a></span> &gt;
&gt;
&gt; On Wed Aug 30 14:39:19 2006, jlange6648 wrote:
<div class="message-stanza open">&gt; &gt; That didn&#39;t seem to make any difference.
&gt; &gt;
&gt; &gt; I have found however that if PERL_DL_NONLAZY is set to 1, it will work..
&gt; &gt; which explains why &#39;make test&#39;  works.
</div>&gt;
&gt; Thanks for looking into this...
&gt;
&gt; Do you reproduce this on AMD64, or on SuSE, or what configuration, in
&gt; your opinion, is problematic?
&gt;
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;17&nbsp;14:52:25&nbsp;2006</span>
    <span class="description">vadim [...] vkonovalov.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> tcltk [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #21181] Tcl Segfaults on SuSE 10.1 x86_64</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 17 Sep 2006 06:03:50 +0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Vadim &lt;vadim [...] vkonovalov.ru&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"> via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       Queue: Tcl
&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=21181">http://rt.cpan.org/Ticket/Display.html?id=21181</a></span> &gt;
&gt;
&gt;I have 2 different boxes running SuSE 10.1 x86_64 on Intel processors, one a
&gt;hyperthreaded p4, and one a dual core p4.
&gt;
&gt;I also just tried it on a IBM laptop running SuSE 10.1 x86  and it also
&gt;fails, so it looks like a SuSE 10.1 issue, not an x64 issue
&gt;  
&gt;
</div>
for some unknown for me reasons two very similar Gentoo installation
behave differently - one gives segmentation fault but other do not,
seemingly with all the very same versions.

&#40;of course there is some difference, but I can&#39;t catch what namely isn&#39;t
good&#41;

For such a situation using &#34;--nousestubs&#34; cures the situation.

So in my current understanding &#34;stubs&#34; are not dealed properly in Tcl.xs


Sorry for not having catched the &#34;--usestubs&#34; situation.

Best regards,
Vadim.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;to recap:
&gt;
&gt;this works:
&gt;  
&gt;
<div class="message-stanza open">&gt;&gt;PERL_DL_NONLAZY=1 perl -e &#39;use Tcl;&#39;
&gt;&gt;    
&gt;&gt;
</div>&gt;
&gt;this dosen&#39;t:
&gt;  
&gt;
<div class="message-stanza open">&gt;&gt;PERL_DL_NONLAZY=0 perl -e &#39;use Tcl;&#39;
&gt;&gt;    
&gt;&gt;
</div>&gt;
&gt;here is the versions of the relevant packaged on my system:
&gt;perl-5.8.8-12
&gt;tcl-devel-8.4.12-14
&gt;tcl-8.4.12-14
&gt;tcllib-1.8-10
&gt;glibc-2.4-31.1
&gt;Tcl.pm from CPAN
&gt;  
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;17&nbsp;18:39:37&nbsp;2006</span>
    <span class="description">jeffh [...] activestate.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org,  tcltk [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #21181] Tcl Segfaults on SuSE 10.1 x86_64</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 17 Sep 2006 15:39:34 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Vadim &lt;vadim [...] vkonovalov.ru&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jeff Hobbs &lt;jeffh [...] activestate.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Vadim wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  via RT wrote:
<div class="message-stanza open">&gt;&gt;       Queue: Tcl
&gt;&gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=21181">http://rt.cpan.org/Ticket/Display.html?id=21181</a></span> &gt;
&gt;&gt;
&gt;&gt; I have 2 different boxes running SuSE 10.1 x86_64 on Intel processors, one a
&gt;&gt; hyperthreaded p4, and one a dual core p4.
&gt;&gt;
&gt;&gt; I also just tried it on a IBM laptop running SuSE 10.1 x86  and it also
&gt;&gt; fails, so it looks like a SuSE 10.1 issue, not an x64 issue
</div>&gt; 
&gt; for some unknown for me reasons two very similar Gentoo installation
&gt; behave differently - one gives segmentation fault but other do not,
&gt; seemingly with all the very same versions.
&gt; 
&gt; &#40;of course there is some difference, but I can&#39;t catch what namely isn&#39;t
&gt; good&#41;
&gt; 
&gt; For such a situation using &#34;--nousestubs&#34; cures the situation.
&gt; 
&gt; So in my current understanding &#34;stubs&#34; are not dealed properly in Tcl.xs
&gt; 
&gt; Sorry for not having catched the &#34;--usestubs&#34; situation.
</div>
If it is the use of stubs that causes the problem, it may be that the 
tcl84stub.lib files that ship with the Tcl module are not compatible. 
You could test this with &#39;file tcl84stub.lib&#39; on the one shipped with 
the Tcl module versus the ones on the machines that are obviously not 
compatible.

Jeff
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;28&nbsp;02:33:09&nbsp;2008</span>
    <span class="description">rkitover [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m also seeing this segfault problem on Debian unstable amd64, with
tcl8.4-dev version 8.4.19-2 and Tcl version 0.97

Setting PERL_DL_NONLAZY=1 makes it not segfault, as described.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;19&nbsp;13:33:46&nbsp;2009</span>
    <span class="description">josh803316 [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #21181] Tcl Segfaults on SuSE 10.1 x86_64</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 19 Aug 2009 10:33:28 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Josh803316 &lt;josh803316 [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I get a similar segfault on Fedora Core 11 x86_64

[jnisenson@jpc Perl]$ gdb perl
GNU gdb &#40;GDB&#41; Fedora &#40;6.8.50.20090302-37.fc11&#41;
Copyright &#40;C&#41; 2009 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://gnu.org/licenses/gpl.html">http://gnu.org/licenses/gpl.html</a></span>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
</div>This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type &#34;show copying&#34;
and &#34;show warranty&#34; for details.
This GDB was configured as &#34;x86_64-redhat-linux-gnu&#34;.
For bug reporting instructions, please see:
&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.gnu.org/software/gdb/bugs/">http://www.gnu.org/software/gdb/bugs/</a></span>&gt;...
Missing separate debuginfos, use: debuginfo-install
perl-5.10.0-73.fc11.x86_64
&#40;gdb&#41; use Tcl;
Undefined command: &#34;use&#34;.  Try &#34;help&#34;.
&#40;gdb&#41; set args -e &#39;use Tcl;&#39;
&#40;gdb&#41; run
Starting program: /usr/bin/perl -e &#39;use Tcl;&#39;
[Thread debugging using libthread_db enabled]

Program received signal SIGSEGV, Segmentation fault.
0x00007ffff24cde9a in NpInitialize &#40;my_perl=0x7fffffffd110, X=0x606fa8&#41; at
Tcl.xs:445
445    Tcl.xs: No such file or directory.
    in Tcl.xs


 /*
     * If we didn&#39;t find TclKit_AppInit, then this is a regular Tcl
     * installation, so invoke Tcl_Init.
     * Otherwise, we need to set the kit path to indicate we want to
     * use the dll as our base kit.
     */
    if &#40;tclKit_AppInit == NULL&#41; {
        tclKit_AppInit = Tcl_Init;                # LINE 445 in Tcl.xs
    } else {



&#40;SIDENOTE: I RAN INTO ANOTHER BUG DURING CPAN INSTALL WHICH I BELIEVE HAS
ALREADY BEEN REPORTED as bug 36167&#41;
&#40;#1 Install from command line after CPAN failure&#41;
[root@jpc Tcl-0.97-hZDODq]# make test
PERL_DL_NONLAZY=1 /usr/bin/perl &#34;-MExtUtils::Command::MM&#34; &#34;-e&#34;
&#34;test_harness&#40;0, &#39;blib/lib&#39;, &#39;blib/arch&#39;&#41;&#34; t/*.t
t/call.t ....... 1/10 Assertion &#40;&#40;svtype&#41;&#40;&#40;_svi&#41;-&gt;sv_flags &#38; 0xff&#41;&#41; &gt;=
SVt_RV failed: file &#34;Tcl.xs&#34;, line 653 at t/call.t line 38.
t/call.t ....... Dubious, test returned 88 &#40;wstat 22528, 0x5800&#41;
Failed 2/10 subtests
t/constants.t .. ok
t/createcmd.t .. ok
t/eval.t ....... ok
t/info.t ....... ok
t/result.t ..... ok
t/subclass.t ... ok
t/trace.t ...... ok
t/unicode.t .... ok
t/var.t ........ ok

Test Summary Report
-------------------
t/call.t     &#40;Wstat: 22528 Tests: 8 Failed: 0&#41;
  Non-zero exit status: 88
  Parse errors: Bad plan.  You planned 10 tests but ran 8.
Files=10, Tests=51,  0 wallclock secs &#40; 0.06 usr  0.01 sys +  0.18 cusr
0.06 csys =  0.31 CPU&#41;
Result: FAIL
Failed 1/10 test programs. 0/51 subtests failed.
make: *** [test_dynamic] Error 255

[root@jpc Tcl-0.97-hZDODq]# patch -i Tcl-rv-assertion.patch
patching file Tcl.xs
can&#39;t find file to patch at input line 16
Perhaps you should have used the -p or --strip option?
The text leading up to this was:
--------------------------
|diff -u -r Tcl-0.97.orig/t/result.t Tcl-0.97/t/result.t
|--- Tcl-0.97.orig/t/result.t    2008-09-07 09:21:59.000000000 +0900
|+++ Tcl-0.97/t/result.t    2009-08-13 12:55:53.000000000 +0900
--------------------------
File to patch: t/result.t
patching file t/result.t
[root@jpc Tcl-0.97-hZDODq]# ls
ChangeLog  Changes  Makefile.old  Makefile.PL  MANIFEST  META.yml  README
t  tclcfg.tcl  tcl-core  Tcl.pm  Tcl-rv-assertion.patch  Tcl.xs  typemap
[root@jpc Tcl-0.97-hZDODq]# perl Makefile.PL
LIBS   = -Ltcl-core/linux-x86_64 -ltclstub8.4
INC    = -Itcl-core/include
DEFINE =  -DUSE_TCL_STUBS
Checking if your kit is complete...
Looks good
Warning: -Ltcl-core/linux-x86_64 changed to
-L/root/.cpan/build/Tcl-0.97-hZDODq/tcl-core/linux-x86_64
Writing Makefile for Tcl
[root@jpc Tcl-0.97-hZDODq]# make
cp Tcl.pm blib/lib/Tcl.pm
/usr/bin/perl /usr/lib/perl5/5.10.0/ExtUtils/xsubpp  -typemap
/usr/lib/perl5/5.10.0/ExtUtils/typemap -typemap typemap  Tcl.xs &gt; Tcl.xsc &#38;&#38;
mv Tcl.xsc Tcl.c
Please specify prototyping behavior for Tcl.xs &#40;see perlxs manual&#41;
gcc -c  -Itcl-core/include -D_REENTRANT -D_GNU_SOURCE -DPERL_USE_SAFE_PUTENV
-DDEBUGGING -fno-strict-aliasing -pipe -I/usr/local/include
-D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64 -I/usr/include/gdbm -O2 -g -pipe
-Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector
--param=ssp-buffer-size=4 -m64 -mtune=generic   -DVERSION=\&#34;0.97\&#34;
-DXS_VERSION=\&#34;0.97\&#34; -fPIC
&#34;-I/usr/lib64/perl5/5.10.0/x86_64-linux-thread-multi/CORE&#34;  -DUSE_TCL_STUBS
Tcl.c
Tcl.xs: In function ‘Tcl_EvalInPerl’:
Tcl.xs:777: warning: value computed is not used
Tcl.xs: In function ‘Tcl_PerlCallWrapper’:
Tcl.xs:845: warning: value computed is not used
Tcl.c: In function ‘XS_Tcl_icall’:
Tcl.c:1557: warning: unused variable ‘sv’
Running Mkbootstrap for Tcl &#40;&#41;
chmod 644 Tcl.bs
rm -f blib/arch/auto/Tcl/Tcl.so
gcc  -shared -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions
-fstack-protector --param=ssp-buffer-size=4 -m64 -mtune=generic Tcl.o  -o
blib/arch/auto/Tcl/Tcl.so     \
       -L/root/.cpan/build/Tcl-0.97-hZDODq/tcl-core/linux-x86_64
-ltclstub8.4      \

chmod 755 blib/arch/auto/Tcl/Tcl.so
cp Tcl.bs blib/arch/auto/Tcl/Tcl.bs
chmod 644 blib/arch/auto/Tcl/Tcl.bs
Manifying blib/man3/Tcl.3pm
[root@jpc Tcl-0.97-hZDODq]# make test
PERL_DL_NONLAZY=1 /usr/bin/perl &#34;-MExtUtils::Command::MM&#34; &#34;-e&#34;
&#34;test_harness&#40;0, &#39;blib/lib&#39;, &#39;blib/arch&#39;&#41;&#34; t/*.t
t/call.t ....... ok
t/constants.t .. ok
t/createcmd.t .. ok
t/eval.t ....... ok
t/info.t ....... ok
t/result.t ..... ok
t/subclass.t ... ok
t/trace.t ...... ok
t/unicode.t .... ok
t/var.t ........ ok
All tests successful.
Files=10, Tests=55,  0 wallclock secs &#40; 0.05 usr  0.02 sys +  0.18 cusr
0.05 csys =  0.30 CPU&#41;
Result: PASS
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;23&nbsp;03:05:26&nbsp;2017</span>
    <span class="description">sjaluo [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #21181] An analysis and solution for segment fault problem</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 23 Apr 2017 15:04:55 +0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Tcl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> SJ Luo &lt;sjaluo [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

  After installation of Tcl module &#40;version 1.05&#41;, I encountered segfault
problem similar to that listed in 21181. My system is CentOS Linux 6.9
&#40;x86_64&#41; with Perl 5.10.1:

[crystal@great Tcl-1.05-SJ]$ perl -e &#39;use Tcl;&#39;
Segmentation fault &#40;core dumped&#41;

but with environment variable PERL_DL_NONLAZY set, things will go fine.

I&#39;ve spent time go through gdb assembly code struggling with it and have
got some results. It is quite difficult to debug.
In short, it is due to the symbol name confliction: There are functions
named Tcl_InitStub&#40;&#41; in both libtclstub8.4.a  and libtcl8.5.so and a wrong
one is being called.

In Tcl.xs function NpInitialize&#40;&#41;, the libtcl8.5.so is loaded via dlopen&#40;&#41;
before resolving of Tcl_InitStub&#40;&#41; address, which is done on first calling
of the function by default &#40;See 1st note below&#41;. the The linker incorrectly
resolved the symbol address to the one in libtcl8.5.so, while we expected
that in libtclstub8.4.a . That caused segmentation fault in following code.

When the PERL_DL_NONLAZY env is set to 1, the address of Tcl_InitStub&#40;&#41;
would be resolved on phase of dlopen&#40;&#34;tcl.so&#34;,RTLD_NOW&#41;, meanwhile
libtcl8.5.so was not loaded &#40;dlopen&#41; yet. Therefore the correct function
address is resolved and called.

I think it might be a bug of gcc or linker, rather than Tcl module. There
are some notes:

   - Although libtclstub8.4.a is static linked. The linker still apply
   dynamic linking calling procedure &#40;via GOT/PLT table&#41; to Tcl_InitStub&#40;&#41;.
   I don&#39;t know why it is done this way. May there is some way to make it
   actually statically link in code compilation phase. My gcc version is
   4.4.7
   - In theory, initstubs is a static function pointer, who should be
   correctly assigned on initialization of Tcl.so. However, gcc did some
   optimization on the code: gcc thought both address of Tcl_InitStub&#40;&#41; and
   initstubs do not change during program&#39;s life time, the initstubs
   variable is actually reduced after compilation. When we call to
   initstubs&#40;&#41; in source code, it just call Tcl_InitStub&#40;&#41; directly, rather
   than via the function pointer, in executable file.


I worked around this issue by adding a line in NpInitialize&#40;&#41; right after
function variable declaration section.

if&#40; initstubs == NULL &#41; initstubs = NULL;

This line forces gcc to think that initstubs might change and actually
allocate some memory space to store its value. Then initstubs is now
actually existed and correctly set on Tcl.so initialization phase.

Now Tcl module works perfectly on my system.
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;27&nbsp;11:15:41&nbsp;2018</span>
    <span class="description">sjaluo [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In short, it is due to the symbol name confliction: There are functions
&gt; named Tcl_InitStub&#40;&#41; in both libtclstub8.4.a  and libtcl8.5.so and a wrong
&gt; one is being called.
</div>
Here I attach several small Linux programs with source codes to demonstrate the failure mechanism. Just download the attached file and do:

$ make
gcc -o myperl -O3 myperl.c -ldl
gcc -c -o libtclstub.o -shared -fPIC -O3 libtclstub.c
ar rcs libtclstub.a libtclstub.o
gcc -o Tcl.so -shared -fPIC -O3 Tcl.c -L . -ltclstub -ldl
gcc -o libtcl.so -shared -fPIC -O3 libtcl.c

$ ./myperl
dlopen&#40;&#41; with RTLD_LAZY
Tcl.so is called
libtcl.so is called &#40;incorrect&#41;

$ env PERL_DL_NOLAZY=1 ./myperl
dlopen&#40;&#41; with RTLD_NOW
Tcl.so is called
libtclstub.so is called

The executable named myperl emulates the dlopen&#40;&#41; call by real perl interpreter. Tcl.so is analogous to the one compiled from Tcl.xs. libtcl.so is analogous to the one comes from tcl interpreter binary distribution and libtclstub.a is as the one comes with this CPAN Tcl module.

My system information:
Linux CentOS 5.11
gcc 4.1.2
ld 2.17.50
glibc-2.5
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Tcl-dlopen.tar.bz2</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;27&nbsp;13:20:20&nbsp;2018</span>
    <span class="description">sjaluo [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

    A patch is attached to fix this issue by declaring static variable initstub &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/VKON/Tcl-1.05/Tcl.xs#L374&#41;">https://metacpan.org/source/VKON/Tcl-1.05/Tcl.xs#L374&#41;</a></span> as volatile, which prevents compiler from optimizing out this variable. Therefore, a correct Tcl_InitStubs&#40;&#41; func could be preserved before Tcl &#40;libtcl.so&#41; dynamically loaded. I think this solution would be more legitimate.

Result of compiler explorer shows the effect of volatile variable.

    <span class="clickylink"><a target="new" rel="nofollow" href="https://godbolt.org/g/RHc7Uu">https://godbolt.org/g/RHc7Uu</a></span>
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Tcl-stub.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Tcl-1.05/Tcl.xs	2016-06-29 00:48:16.000000000 +0800
+++ Tcl-1.05-patched/Tcl.xs	2018-05-28 00:57:49.000000000 +0800
@@ -370,8 +370,10 @@
     /*
      * We want the Tcl_InitStubs func static to ourselves - before Tcl
      * is loaded dyanmically and possibly changes it.
+     * Variable initstubs have to be declared as volatile to prevent
+     * compiler optimizing it out.
      */
-    static CONST char *&#40;*initstubs&#41;&#40;Tcl_Interp *, CONST char *, int&#41;
+    static CONST char *&#40;*volatile initstubs&#41;&#40;Tcl_Interp *, CONST char *, int&#41;
 	= Tcl_InitStubs;
     char dllFilename[MAX_PATH];
     dllFilename[0] = &#39;\0&#39;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;29&nbsp;12:26:57&nbsp;2018</span>
    <span class="description">VKON [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> tcltk [...] perl.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Le Dim 27 Mai 2018 13:20:20, sjaluo@gmail.com a écrit :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; A patch is attached to fix this issue by declaring static variable
&gt; initstub &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/VKON/Tcl-1.05/Tcl.xs#L374&#41;">https://metacpan.org/source/VKON/Tcl-1.05/Tcl.xs#L374&#41;</a></span> as
&gt; volatile, which prevents compiler from optimizing out this variable.
&gt; Therefore, a correct Tcl_InitStubs&#40;&#41; func could be preserved before
&gt; Tcl &#40;libtcl.so&#41; dynamically loaded. I think this solution would be
&gt; more legitimate.
&gt; 
&gt; Result of compiler explorer shows the effect of volatile variable.
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://godbolt.org/g/RHc7Uu">https://godbolt.org/g/RHc7Uu</a></span>
</div>
TYVM!
added the fix to repositury <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/gisle/tcl.pm">https://github.com/gisle/tcl.pm</a></span>, hopefully soon to be released
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;28&nbsp;03:51:04&nbsp;2018</span>
    <span class="description">VKON [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">patch applied, please reopen if problem persists
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;28&nbsp;03:51:05&nbsp;2018</span>
    <span class="description">VKON [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;28&nbsp;03:51:05&nbsp;2018</span>
    <span class="description">VKON [...] cpan.org -  Fixed in 1.06 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
