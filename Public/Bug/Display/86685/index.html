<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #86685 for DBIx-Class: strange behavior with set_column</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #86685 for DBIx-Class: strange behavior with set_column</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBIx-Class/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBIx-Class/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBIx-Class">DBIx-Class CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">86685</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBIx-Class/Active/">DBIx-Class</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jwcarlson [...] lbl.gov

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10410-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10411-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.082801    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;03&nbsp;16:32:45&nbsp;2013</span>
    <span class="description">jwcarlson [...] lbl.gov -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Joel Martin &lt;j_martin [...] lbl.gov&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> strange behavior with set_column</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 3 Jul 2013 13:32:17 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> dbix-class [...] lists.scsys.co.uk, bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Joe Carlson &lt;jwcarlson [...] lbl.gov&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

I&#39;ve noticed strange behavior with perl 5.16/ DBIx::Class 0.08204 that I did not see with perl 5.10/DBIx::Class 0.08120

I&#39;m looking at a resultset record which involves a joined table. I&#39;m working with a local copy and setting in_storage&#40;0&#41;. If I attempt to set a value for a column in one of the joined column names, I get  a &#39;No such column&#39;, but only the second time I attempt to set it.

A snippet of code is something that joins a table &#39;feature&#39; with &#39;featureloc&#39;. &#39;fmin&#39; is a column in Featureloc

my $featureRS = $session-&gt;db-&gt;dbh-&gt;resultset&#40;&#39;Feature&#39;&#41;-&gt;search&#40;
               { &#39;me.feature_id&#39; =&gt; 13039071 },
               { join =&gt; &#39;featureloc_feature_ids&#39;,
                 &#39;+select&#39; =&gt; [&#39;featureloc_feature_ids.fmin&#39;],
                 &#39;+as&#39;     =&gt; [&#39;fmin&#39;]}&#41;;

my $feature = $featureRS-&gt;first;

my $fmin = $feature-&gt;get_column&#40;&#39;fmin&#39;&#41;;      # no problem
$feature-&gt;in_storage&#40;0&#41;;
$feature-&gt;set_column&#40;&#39;fmin&#39;=&gt;12&#41;;     # so far, so good
$feature-&gt;set_column&#40;&#39;fmin&#39;=&gt;102&#41;;   # error here.


The error occurs only if I have the second call to set_column with fmin. And in 0.082404 but not 0.08120. I believe the problem arises when the second call is attempting to see if the new value in set_column differs from the previous. I&#39;m suspicious of the call to _is_column_numeric in  _eq_column_values in DBIx::Class::Row. The code in 0.08250 looks similar to my version in this call.

Joe Carlson
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Create even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;01&nbsp;17:48:38&nbsp;2014</span>
    <span class="description">jwcarlson [...] lbl.gov - Ticket #94372:  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: Bug #86685</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 1 Apr 2014 14:48:20 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBIx-Class [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Joe Carlson &lt;jwcarlson [...] lbl.gov&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Hello,

9 months ago I reported some strange behavior with set_column. Essentially, trying to call set_column on a row in which the column to be set is a from a join and is_storage was false resulted in an error the second time set_column was called. &#40;The first call was successful.&#41; 

I&#39;ve been stumbling this some more and now I think I see what the issue is. There is a bad assumption of operator precedence in Row.pm

The code &#40;beginning at line 840 in my version&#41;

  my $dirty =
    $self-&gt;{_dirty_columns}{$column}
      ||
    $in_storage # no point tracking dirtyness on uninserted data
      ? ! $self-&gt;_eq_column_values &#40;$column, $old_value, $new_value&#41;
      : 1 
  ;

should be


  my $dirty =
    $self-&gt;{_dirty_columns}{$column}
      ||
    &#40;$in_storage # no point tracking dirtyness on uninserted data
      ? ! $self-&gt;_eq_column_values &#40;$column, $old_value, $new_value&#41;
      : 1 &#41;
  ;

If the column has already been marked dirty, there is no need to ask whether the new value differs from the old value. But that was not short stopping the evaluation of _eq_column_values. Inside _eq_column_values, there is a call to _is_column_numeric that was generating the error when calling column_info on the joined column name.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;09&nbsp;09:25:58&nbsp;2014</span>
    <span class="description">ribasushi [...] leporine.io - Ticket #94372:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Apr 01 23:48:38 2014, jwcarlson@lbl.gov wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Hello,
&gt; 
&gt; 9 months ago I reported some strange behavior with set_column.
&gt; Essentially, trying to call set_column on a row in which the column to
&gt; be set is a from a join and is_storage was false resulted in an error
&gt; the second time set_column was called. &#40;The first call was
&gt; successful.&#41;
&gt; 
&gt; I&#39;ve been stumbling this some more and now I think I see what the
&gt; issue is. There is a bad assumption of operator precedence in Row.pm
&gt; 
&gt; The code &#40;beginning at line 840 in my version&#41;
&gt; 
&gt; my $dirty =
&gt;   $self-&gt;{_dirty_columns}{$column}
&gt;     ||
&gt;   $in_storage # no point tracking dirtyness on uninserted data
&gt;     ? ! $self-&gt;_eq_column_values &#40;$column, $old_value, $new_value&#41;
&gt;      : 1
&gt; ;
&gt; 
&gt; should be
&gt; 
&gt; 
&gt; my $dirty =
&gt;   $self-&gt;{_dirty_columns}{$column}
&gt;     ||
&gt;   &#40;$in_storage # no point tracking dirtyness on uninserted data
&gt;     ? ! $self-&gt;_eq_column_values &#40;$column, $old_value, $new_value&#41;
&gt;     : 1 &#41;
&gt; ;
&gt; 
&gt; If the column has already been marked dirty, there is no need to ask
&gt; whether the new value differs from the old value. But that was not
&gt; short stopping the evaluation of _eq_column_values. Inside
&gt; _eq_column_values, there is a call to _is_column_numeric that was
&gt; generating the error when calling column_info on the joined column
&gt; name.
</div>
Thanks for the diagnosis and sorry for the delay. There is a very high chance this will finally be addressed during the hackathon this weekend.

Cheers!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;09&nbsp;09:26:00&nbsp;2014</span>
    <span class="description">The RT System itself - Ticket #94372:  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;09&nbsp;09:27:01&nbsp;2014</span>
    <span class="description">ribasushi [...] leporine.io - Ticket #94372:  Merged into ticket #86685</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;09&nbsp;09:27:01&nbsp;2014</span>
    <span class="description">ribasushi [...] leporine.io -  Merged into ticket #86685</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;27&nbsp;19:16:19&nbsp;2014</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Apr 01 23:48:38 2014, jwcarlson@lbl.gov wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve been stumbling this some more and now I think I see what the
&gt; issue is. There is a bad assumption of operator precedence in Row.pm
&gt; 
</div>
While your diagnosis is correct - this is only half of the issue. The full fix has finally been landed in <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/dbsrgits/dbix-class/commit/57e9c142d">https://github.com/dbsrgits/dbix-class/commit/57e9c142d</a></span>. Thank you for the report!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;27&nbsp;19:16:21&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;27&nbsp;19:16:22&nbsp;2014</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;09&nbsp;17:03:50&nbsp;2014</span>
    <span class="description">ribasushi [...] leporine.io -  Fixed in 0.082801 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;09&nbsp;17:03:50&nbsp;2014</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Finally fixed in DBIC 0.082801: <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/release/RIBASUSHI/DBIx-Class-0.082801#whatsnew">https://metacpan.org/release/RIBASUSHI/DBIx-Class-0.082801#whatsnew</a></span>

Cheers
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;09&nbsp;17:03:50&nbsp;2014</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
