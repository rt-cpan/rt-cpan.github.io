<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #103517 for Math-BigInt-GMP: number changes sign after new</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #103517 for Math-BigInt-GMP: number changes sign after new</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Math-BigInt-GMP/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Math-BigInt-GMP/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Math-BigInt-GMP/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Math-BigInt-GMP/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Math-BigInt-GMP">Math-BigInt-GMP CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">103517</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Math-BigInt-GMP/Active/">Math-BigInt-GMP</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
CHORNY [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
dom [...] cpan.org

<br />
gregoa [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-20512-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.38    </td>
  </tr>
  <tr id="CF-20513-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.51    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




32bit.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1572525/839638/32bit.patch">
Sat Dec 12 18:44:55 2015 (1k) by gregoa [...] cpan.org
</a>
</font></li>
</ul>


bigint-new.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1568828/837523/bigint-new.t">
Tue Dec 01 22:22:12 2015 (911b) by DANAJ [...] cpan.org
</a>
</font></li>
</ul>


signature.asc<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1573138/839982/signature.asc">
Mon Dec 14 15:52:53 2015 (949b) by gregoa [...] debian.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;14&nbsp;04:49:16&nbsp;2015</span>
    <span class="description">CHORNY [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> number changes sign after new</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use 5.012;
use warnings;

use Math::BigInt &#39;lib&#39; =&gt; &#39;GMP&#39;; #,Pari,FastCalc
my $secs = 2_148_137_600;
say &#34;\$secs =$secs&#34;;
my $secs1 = Math::BigInt-&gt;new&#40;$secs&#41;;
say &#34;\$secs1=$secs1&#34;;

$secs = 2148137600
$secs1= -214682969

latest Math::BigInt and Math::BigInt::GMP
32-bit Windows XP, 32-bit Debian 7

-- 
Alexandr Ciornii, <span class="clickylink"><a target="new" rel="nofollow" href="http://chorny.net">http://chorny.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;14&nbsp;04:53:03&nbsp;2015</span>
    <span class="description">CHORNY [...] cpan.org -  Dependency by ticket #70227 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links DeleteLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;14&nbsp;05:39:21&nbsp;2015</span>
    <span class="description">CHORNY [...] cpan.org -  Dependency by ticket #70227 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;14&nbsp;05:40:10&nbsp;2015</span>
    <span class="description">CHORNY [...] cpan.org -  Dependency by ticket #33816 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;16&nbsp;10:45:31&nbsp;2015</span>
    <span class="description">peter.john.acklam [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have compiled a 32 bit version of Perl 5.20.2 just for this bug report, but I am unable to reproduce your results. Do you get the same results if you are not specifying the library explicitly?

What output do you get from the following two commands?

perl -MMath::BigInt -wle &#39;print Math::BigInt -&gt; new&#40;2_148_137_600&#41;&#39;

perl -MMath::BigInt -wle &#39;print Math::BigInt -&gt; VERSION&#39;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;16&nbsp;10:45:31&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;16&nbsp;15:45:59&nbsp;2015</span>
    <span class="description">CHORNY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Apr 16 10:45:31 2015, pjacklam wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have compiled a 32 bit version of Perl 5.20.2 just for this bug
&gt; report, but I am unable to reproduce your results. Do you get the same
&gt; results if you are not specifying the library explicitly?
&gt; 
&gt; What output do you get from the following two commands?
&gt; 
&gt; perl -MMath::BigInt -wle &#39;print Math::BigInt -&gt; new&#40;2_148_137_600&#41;&#39;
</div>
2148137600

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; perl -MMath::BigInt -wle &#39;print Math::BigInt -&gt; VERSION&#39;
</div>
1.9993

Result is correct because GMP is not used.

$ perl -MMath::BigInt -wle &#39;print Math::BigInt-&gt;config&#40;&#41;-&gt;{lib};&#39;
Math::BigInt::Calc

-- 
Alexandr Ciornii, <span class="clickylink"><a target="new" rel="nofollow" href="http://chorny.net">http://chorny.net</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;17&nbsp;03:44:09&nbsp;2015</span>
    <span class="description">peter.john.acklam [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks. I missed the point that it *only* happens with the GMP backend. I was able to reproduce your result:

    $ /opt/perl5/cygwin_nt-6.1-wow/1.7.35/i686/bin/5.20.2/cygwin/perl -MMath::BigInt=lib,GMP -wle &#39;print Math::BigInt -&gt; new&#40;2_148_137_600&#41;&#39;
    -214682969

However, I am not sure if this really is an error. I suspect the negative output occurs because your input value is larger than 2_147_483_647, which is the largest value that can be represented by a 32 bit signed integer. See what happens when you cross this boundary:

    $ perl -MMath::BigInt=lib,GMP -wle &#39;print Math::BigInt -&gt; new&#40;2_147_483_647&#41;&#39;
    2147483647

    $ perl -MMath::BigInt=lib,GMP -wle &#39;print Math::BigInt -&gt; new&#40;2_147_483_648&#41;&#39;
    -214748364

The issue at hand is related to the following section in the documentation for Math::BigInt:

    Input values to these routines may be any string, that looks like a number
    and results in an integer, including hexadecimal and binary numbers.

    Scalars holding numbers may also be passed, but note that non-integer numbers
    may already have lost precision due to the conversion to float. Quote
    your input if you want BigInt to see all the digits:

        $x = Math::BigInt-&gt;new&#40;12345678890123456789&#41;;   # bad
        $x = Math::BigInt-&gt;new&#40;&#39;12345678901234567890&#39;&#41;; # good

The wording could be improved, but the point is that input to Math::BigInt-&gt;new&#40;&#41; should be quoted, at least when the input has a large number of digits. When quoting your input value, the output is correct:

    $ perl -Ilib -MMath::BigInt=lib,GMP -wle &#39;print Math::BigInt -&gt; new&#40;&#34;2_148_137_600&#34;&#41;&#39;
    2148137600
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;07&nbsp;18:17:47&nbsp;2015</span>
    <span class="description">DANAJ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Duplicate of 71548?

This is a real PITA bug, as it forces quoting of every input or adding a bunch of hacky code to check for things like
 - is the input a class &#40;perhaps already BigInt&#41;?  Alternately pay the penalty for stringify / unstringify.
 - is the input large enough to hit this?
 - is this the GMP backend that acts differently than every other backend?

As seen in that ticket, you can easily cause perl to die with floating point exceptions because of this.  But only with this backend.

What I&#39;m seeing is that SvUOK&#40;x&#41; returns true for large integers &#40;positive with high bit set&#41;.  Hence we&#39;re doing exactly the opposite of what we should be doing in GMP.xs.  We&#39;re taking a number Perl has told us &#34;this is a number that fits in 32-/64- bit, is positive, and has the high bit set&#34; and we intentionally reverse its sign.  This can&#39;t be right.

Arguably we should get clever with SvFLAGS to only use the string set when it is necessary.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;08&nbsp;13:32:39&nbsp;2015</span>
    <span class="description">nospam-abuse [...] bloodgate.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #103517] number changes sign after new</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 8 Jun 2015 13:32:25 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Math-BigInt-GMP [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Tels&#34; &lt;nospam-abuse [...] bloodgate.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On Sun, June 7, 2015 6:17 pm, Dana Jacobsen via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Math-BigInt-GMP
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=103517">https://rt.cpan.org/Ticket/Display.html?id=103517</a></span> &gt;
&gt;
&gt; Duplicate of 71548?
&gt;
&gt; This is a real PITA bug, as it forces quoting of every input or adding a
&gt; bunch of hacky code to check for things like
&gt;  - is the input a class &#40;perhaps already BigInt&#41;?  Alternately pay the
&gt; penalty for stringify / unstringify.
&gt;  - is the input large enough to hit this?
&gt;  - is this the GMP backend that acts differently than every other backend?
&gt;
&gt; As seen in that ticket, you can easily cause perl to die with floating
&gt; point exceptions because of this.  But only with this backend.
&gt;
&gt; What I&#39;m seeing is that SvUOK&#40;x&#41; returns true for large integers &#40;positive
&gt; with high bit set&#41;.  Hence we&#39;re doing exactly the opposite of what we
&gt; should be doing in GMP.xs.  We&#39;re taking a number Perl has told us &#34;this
&gt; is a number that fits in 32-/64- bit, is positive, and has the high bit
&gt; set&#34; and we intentionally reverse its sign.  This can&#39;t be right.
&gt;
&gt; Arguably we should get clever with SvFLAGS to only use the string set when
&gt; it is necessary.
</div>
FWIIW, I agree. Quoting the input to BigInt should not be necessary if the
input fits into an integer - the documentation &#40;even if not that clearly
worded&#41; only covers cases where the internal representation of Perl&#39;s INT
cannot hold the given value and thus the bits are lost before they reach
BigInt/BigFloat&#39;s new&#40;&#41;.

In this case the bits reach the library, but are lost in &#40;or on the way
to&#41; the backend. Which shouldn&#39;t happen or be visible to the user.

Best regards,

Tels


-- 
<span class="clickylink"><a target="new" rel="nofollow" href="http://bloodgate.com/galleries/">http://bloodgate.com/galleries/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;10&nbsp;15:07:01&nbsp;2015</span>
    <span class="description">peter.john.acklam [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I don&#39;t know XS well enough to fix this, but if someone else provides a patch, I&#39;d be happy to include it in a &#40;not too distant&#41; future release.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;01&nbsp;22:22:12&nbsp;2015</span>
    <span class="description">DANAJ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is a patch version of what I indicated in May 2013:

--- GMP.xs.old  2015-12-01 16:10:02.000000000 -0800
+++ GMP.xs      2015-12-01 19:04:39.000000000 -0800
@@ -169,7 +169,7 @@
     /* using the IV directly is a bit faster */
     if &#40;SvUOK&#40;x&#41;&#41;
       {
-      mpz_init_set_si&#40;*RETVAL, &#40;UV&#41;SvUV&#40;x&#41;&#41;;
+      mpz_init_set_ui&#40;*RETVAL, &#40;UV&#41;SvUV&#40;x&#41;&#41;;
       }
     else
       {
@@ -190,7 +190,7 @@
   CODE:
     mpz = malloc &#40;sizeof&#40;mpz_t&#41;&#41;;
     if &#40;SvUOK&#40;x&#41;&#41; {
-      mpz_init_set_si&#40;*mpz, &#40;UV&#41;SvUV&#40;x&#41;&#41;;
+      mpz_init_set_ui&#40;*mpz, &#40;UV&#41;SvUV&#40;x&#41;&#41;;
     }
     else {
       mpz_init_set_str&#40;*mpz, SvPV_nolen&#40;x&#41;, 10&#41;;

Math::BigInt&#39;s new&#40;&#41; strips the sign off the input, so anything coming to _new is unsigned.  The defect is that _new is coercing the UV into a signed long.

Regarding performance, unfortunately since Math::BigInt removes the sign by using s/// that means any signed input comes in looking like a string so goes through the slower string path.  Probably not a huge problem since most inputs are likely unsigned.

The following is a bit more efficient, as it results in many more integer inputs going through the faster path:

--- GMP.xs.old  2015-12-01 16:10:02.000000000 -0800
+++ GMP.xs      2015-12-01 19:11:28.000000000 -0800
@@ -167,9 +167,9 @@
   CODE:
     NEW_GMP_MPZ_T;
     /* using the IV directly is a bit faster */
-    if &#40;SvUOK&#40;x&#41;&#41;
+    if &#40;SvUOK&#40;x&#41; || SvIOK&#40;x&#41;&#41;
       {
-      mpz_init_set_si&#40;*RETVAL, &#40;UV&#41;SvUV&#40;x&#41;&#41;;
+      mpz_init_set_ui&#40;*RETVAL, &#40;UV&#41;SvUV&#40;x&#41;&#41;;
       }
     else
       {
@@ -189,8 +189,8 @@
     mpz_t *mpz;
   CODE:
     mpz = malloc &#40;sizeof&#40;mpz_t&#41;&#41;;
-    if &#40;SvUOK&#40;x&#41;&#41; {
-      mpz_init_set_si&#40;*mpz, &#40;UV&#41;SvUV&#40;x&#41;&#41;;
+    if &#40;SvUOK&#40;x&#41; || SvIOK&#40;x&#41;&#41; {
+      mpz_init_set_ui&#40;*mpz, &#40;UV&#41;SvUV&#40;x&#41;&#41;;
     }
     else {
       mpz_init_set_str&#40;*mpz, SvPV_nolen&#40;x&#41;, 10&#41;;

All current tests pass with this patch.  It is, of course, possible that the test suite isn&#39;t complete.

I&#39;m also attaching a test file.  When run with Calc or Pari back end, it passes all tests in both 32-bit and 64-bit Perl.  With the current GMP back end, it fails 4 tests and hangs or dies on a fifth without the patch.  This test exercises code I run every day, but have to work around by forcing all arguments to new&#40;&#41; into strings, just in case the GMP back end is being used and the input falls into the bad range.  With either patch above, this passes all tests just like the other back ends.

I don&#39;t think this test file is ready to get dropped into the test suite, but portions of it may be appropriate to add.  I think the tests for:
  -&#40;~0 &gt;&gt; 1 + 1&#41;
  ~0 &gt;&gt; 1
  ~0 &gt;&gt; 1 + 1
  ~0 - 1
  ~0
would be good to see.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> bigint-new.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/env perl
use strict;
use warnings;

use Test::More;
use Math::BigInt lib=&gt;&#34;GMP&#34;;

my $use64 = ~0 &gt; 4294967295;
my $broken64 = &#40;18446744073709550592 == ~0&#41;;
die &#34;Your 64-bit system is broken.  Upgrade from 5.6 for this test.&#34; if $broken64;

plan tests =&gt; 4*2 + 2*1 + 1 + $use64;

my $maxs = ~0 &gt;&gt; 1;
for my $n &#40;$maxs - 2, $maxs - 1, $maxs, $maxs+1&#41; {
  is&#40; Math::BigInt-&gt;new&#40;$n&#41;, $n, &#34;new $n&#34; &#41;;
  is&#40; Math::BigInt-&gt;new&#40;-$n&#41;, -$n, &#34;new -$n&#34; &#41;;
}

for my $n &#40;~0 - 1, ~0&#41; {
  is&#40; Math::BigInt-&gt;new&#40;$n&#41;, $n, &#34;new $n&#34; &#41;;
}

# bacmp makes a new variable.  This will test if it is screwing up the sign.
is&#40; Math::BigInt-&gt;new&#40;10&#41;-&gt;bacmp&#40;~0&#41;, -1, &#34;10 should be less than maxint&#34; &#41;;

if &#40;$use64&#41; {
  diag &#34;The following test may hang or cause an exception if incorrect&#34;;
  is&#40; Math::BigInt-&gt;new&#40;&#34;14&#34;&#41;-&gt;bmodpow&#40;9506577562092332135, &#34;29544731879021791655795710&#34;&#41;, &#34;19946192910281559497582964&#34;, &#34;big modpow&#34; &#41;;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;03&nbsp;14:35:59&nbsp;2015</span>
    <span class="description">peter.john.acklam [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks! I have uploaded Math-BigInt-GMP-1.46 to PAUSE based on the above fix.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;04&nbsp;08:14:57&nbsp;2015</span>
    <span class="description">peter.john.acklam [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> DANAJ [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Dec 01 22:22:12 2015, DANAJ wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This is a patch version of what I indicated in May 2013: &#40;...&#41;
</div>
Your patch causes problems when Perl is compiled with 64-bit support, but the underlying OS is 32-bit. Alas, I didn&#39;t test your patch with that configuration before I released a new version of Math-BigInt-GMP.

Here you can see the failing tests: <span class="clickylink"><a target="new" rel="nofollow" href="http://matrix.cpantesters.org/?dist=Math-BigInt-GMP%201.46">http://matrix.cpantesters.org/?dist=Math-BigInt-GMP%201.46</a></span>

And here is a case from the old test suite which fails with the latest release &#40;the one with your patch added&#41;:

$ perl -MMath::BigInt::GMP -wle &#39;$x = Math::BigInt::GMP-&gt;_new&#40;1050000000000000&#41;; print Math::BigInt::GMP::_str&#40;&#34;Math::BigInt::GMP&#34;, $x&#41;&#39;
755212288

This case worked fine without your patch. I would appreciate any suggestions about how to fix this.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;04&nbsp;13:35:34&nbsp;2015</span>
    <span class="description">DANAJ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Dec 04 08:14:57 2015, pjacklam wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Your patch causes problems when Perl is compiled with 64-bit support,
&gt; but the underlying OS is 32-bit. Alas, I didn&#39;t test your patch with
&gt; that configuration before I released a new version of Math-BigInt-GMP.
</div>
Doh!  At least it&#39;s caught by tests.

The problem stems from a few sources:

1&#41; GMP&#39;s API uses signed or unsigned long, while Perl&#39;s UV may be larger than that.  This makes blind use of the _ui and _si functions problematic.  A brief look at the rest of the .xs file seems to say this won&#39;t typically be a problem elsewhere &#40;arguments to shift amounts and non-modular power&#41;.

2&#41; SvUOK was already broken for 2^63+, we just didn&#39;t test for it.  That was this RT.

3&#41; The optimization for SvIOK made machines with smaller longs break for 2^32+.  We do test for that.  But just removing that optimization means we&#39;re still broken for #1.

So either:

    if &#40;sizeof&#40;UV&#41; &lt;= sizeof&#40;unsigned long&#41; &#38;&#38; &#40;SvUOK&#40;x&#41; || SvIOK&#40;x&#41;&#41;&#41; {
      mpz_init_set_ui&#40;*RETVAL, &#40;unsigned long&#41;SvUV&#40;x&#41;&#41;;
    }

replacing the original lines in both _new and _new_attach.  This says that we will go to strings all the time if UV is bigger.  We could do a little better but it&#39;s getting messy:

    if &#40;&#40;SvUOK&#40;x&#41; || SvIOK&#40;x&#41;&#41; &#38;&#38; &#40;sizeof&#40;UV&#41; &lt;= sizeof&#40;unsigned long&#41; || SvUV&#40;x&#41; == &#40;unsigned long&#41;SvUV&#40;x&#41;&#41;&#41; {
      mpz_init_set_ui&#40;*RETVAL, &#40;unsigned long&#41;SvUV&#40;x&#41;&#41;;
    }

which is checking that the input is the same as a UV and unsigned long.  This could be optimized to just call SvUV once, if this was the path to go down.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; And here is a case from the old test suite which fails with the latest
&gt; release &#40;the one with your patch added&#41;:
&gt; 
&gt; $ perl -MMath::BigInt::GMP -wle &#39;$x = Math::BigInt::GMP-
<div class="message-stanza open">&gt; &gt;_new&#40;1050000000000000&#41;; print
</div>&gt; Math::BigInt::GMP::_str&#40;&#34;Math::BigInt::GMP&#34;, $x&#41;&#39;
&gt; 755212288
</div>
Verified on Cygwin and Debian Athlon II, both the 4 byte longs and 8 byte UVs.  Either of the changes above fixes this.

Feel free to email me directly as well, and I&#39;d welcome input from anyone else on this.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;09&nbsp;09:57:37&nbsp;2015</span>
    <span class="description">gregoa [...] cpan.org -  Cc GREGOA added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;10&nbsp;12:30:49&nbsp;2015</span>
    <span class="description">dom [...] cpan.org -  Cc DOM added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;12&nbsp;18:44:55&nbsp;2015</span>
    <span class="description">gregoa [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve converted Dana&#39;s &#40;second&#41; suggestion into a patch now and built the package on Debian unstable in an amd64 and an i386 environment, and it builds and passes its test suite in both cases.

I&#39;m attaching the patch.

Any comments &#40;or preferrably a new release of Math-BigInt-GMP&#41; would be very welcome so that we can get this fixed.

Cheers,
gregor, Debian Perl Group
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 32bit.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Description: fix breakage on 32 bit platforms where perl is compiled with 64 bit support
Origin: CPAN RT#103517
Bug: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=103517">https://rt.cpan.org/Public/Bug/Display.html?id=103517</a></span>
Bug-Debian: <span class="clickylink"><a target="new" rel="nofollow" href="https://bugs.debian.org/807492">https://bugs.debian.org/807492</a></span>
Author: Dana A Jacobsen &lt;danaj@cpan.org&gt;
Last-Update: 2015-12-13

--- a/GMP.xs
+++ b/GMP.xs
@@ -167,9 +167,9 @@
   CODE:
     NEW_GMP_MPZ_T;
     /* using the IV directly is a bit faster */
-    if &#40;SvUOK&#40;x&#41; || SvIOK&#40;x&#41;&#41;
+    if &#40;&#40;SvUOK&#40;x&#41; || SvIOK&#40;x&#41;&#41; &#38;&#38; &#40;sizeof&#40;UV&#41; &lt;= sizeof&#40;unsigned long&#41; || SvUV&#40;x&#41; == &#40;unsigned long&#41;SvUV&#40;x&#41;&#41;&#41;
       {
-      mpz_init_set_ui&#40;*RETVAL, &#40;UV&#41;SvUV&#40;x&#41;&#41;;
+      mpz_init_set_ui&#40;*RETVAL, &#40;unsigned long&#41;SvUV&#40;x&#41;&#41;;
       }
     else
       {
@@ -189,8 +189,8 @@
     mpz_t *mpz;
   CODE:
     mpz = malloc &#40;sizeof&#40;mpz_t&#41;&#41;;
-    if &#40;SvUOK&#40;x&#41; || SvIOK&#40;x&#41;&#41; {
-      mpz_init_set_ui&#40;*mpz, &#40;UV&#41;SvUV&#40;x&#41;&#41;;
+    if &#40;&#40;SvUOK&#40;x&#41; || SvIOK&#40;x&#41;&#41; &#38;&#38; &#40;sizeof&#40;UV&#41; &lt;= sizeof&#40;unsigned long&#41; || SvUV&#40;x&#41; == &#40;unsigned long&#41;SvUV&#40;x&#41;&#41;&#41; {
+      mpz_init_set_ui&#40;*mpz, &#40;unsigned long&#41;SvUV&#40;x&#41;&#41;;
     }
     else {
       mpz_init_set_str&#40;*mpz, SvPV_nolen&#40;x&#41;, 10&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;14&nbsp;14:37:01&nbsp;2015</span>
    <span class="description">peter.john.acklam [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;14&nbsp;15:52:53&nbsp;2015</span>
    <span class="description">gregoa [...] debian.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #103517] number changes sign after new</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 14 Dec 2015 21:52:22 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Peter John Acklam via RT &lt;bug-Math-BigInt-GMP [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> gregor herrmann &lt;gregoa [...] debian.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, 14 Dec 2015 14:37:02 -0500, Peter John Acklam via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=103517">https://rt.cpan.org/Ticket/Display.html?id=103517</a></span> &gt;
&gt; I have released Math-BigInt-GMP-1.47, which seems to fix the issue in this ticket.
</div>
Thank you, uploaded to debian/unstable.

We can follow the results of our buildds at
<span class="clickylink"><a target="new" rel="nofollow" href="https://buildd.debian.org/status/package.php?p=libmath-bigint-gmp-perl">https://buildd.debian.org/status/package.php?p=libmath-bigint-gmp-perl</a></span>

Cheers,
gregor
 

-- 
 .&#39;&#39;`.  Homepage: <span class="clickylink"><a target="new" rel="nofollow" href="http://info.comodo.priv.at/">http://info.comodo.priv.at/</a></span> - OpenPGP key 0xBB3A68018649AA06
 : :&#39; : Debian GNU/Linux user, admin, and developer -  <span class="clickylink"><a target="new" rel="nofollow" href="https://www.debian.org/">https://www.debian.org/</a></span>
 `. `&#39;  Member of VIBE!AT &#38; SPI, fellow of the Free Software Foundation Europe
   `-   NP: Bruce Springsteen: Highway Patrolman
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1573138/839982/signature.asc">Download signature.asc</a><br />
<span class="downloadcontenttype">application/pgp-signature 949b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;01&nbsp;03:55:57&nbsp;2016</span>
    <span class="description">RURBAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This ticket can be closed. 1.51 contains the patch already and smokes are clear.

-- 
Reini Urban
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;01&nbsp;04:16:22&nbsp;2016</span>
    <span class="description">peter.john.acklam [...] gmail.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;01&nbsp;04:16:22&nbsp;2016</span>
    <span class="description">peter.john.acklam [...] gmail.com -  Fixed in 1.51 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
