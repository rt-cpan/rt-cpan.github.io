<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #76550 for POE-Component-Resolver: Resolver doesn&#39;t destroy</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #76550 for POE-Component-Resolver: Resolver doesn&#39;t destroy</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/POE-Component-Resolver/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/POE-Component-Resolver/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/POE-Component-Resolver/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/POE-Component-Resolver/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/POE-Component-Resolver">POE-Component-Resolver CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">76550</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/POE-Component-Resolver/Active/">POE-Component-Resolver</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
kozunov [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-236846-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.916    </td>
  </tr>
  <tr id="CF-236847-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;14&nbsp;08:33:40&nbsp;2012</span>
    <span class="description">kozunov [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Resolver doesn&#39;t destroy</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">when i use poe-component-client-http for check domain by ip, my program
doesn&#39;t exit. Because in this way we don&#39;t send request to resolver and
resolver doesn&#39;t call $kernel-&gt;delay&#40;sidecar_eject =&gt; $heap-&gt;{idle_timeout}&#41;
I solved this problem, by calling $keepalive_obj-&gt;shutdown&#40;&#41; in my program.
I will be happy if resolver could destroyed whithout explicit call shutdown
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;29&nbsp;19:29:49&nbsp;2012</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Apr 14 08:33:40 2012, sergei wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; when i use poe-component-client-http for check domain by ip, my program
&gt; doesn&#39;t exit. Because in this way we don&#39;t send request to resolver and
&gt; resolver doesn&#39;t call $kernel-&gt;delay&#40;sidecar_eject =&gt; $heap-&gt;{idle_timeout}&#41;
&gt; I solved this problem, by calling $keepalive_obj-&gt;shutdown&#40;&#41; in my program.
&gt; I will be happy if resolver could destroyed whithout explicit call shutdown
</div>
If you shutdown POE::Component::Client::HTTP, it should shutdown Resolver and KeepAlive for 
you.  Your program should exit quickly after that.

In other words, you should not need to shut down KeepAlive and Resolver explicitly.  Just 
Client::HTTP when you&#39;re done with that.

Is this good enough?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;29&nbsp;19:29:50&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;02&nbsp;05:30:43&nbsp;2012</span>
    <span class="description">kozunov [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kozunov [...] gmail.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Вск Апр 29 19:29:49 2012, RCAPUTO писал:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sat Apr 14 08:33:40 2012, sergei wrote:
<div class="message-stanza open">&gt; &gt; when i use poe-component-client-http for check domain by ip, my
</div>&gt; program
<div class="message-stanza open">&gt; &gt; doesn&#39;t exit. Because in this way we don&#39;t send request to resolver
</div>&gt; and
<div class="message-stanza open">&gt; &gt; resolver doesn&#39;t call $kernel-&gt;delay&#40;sidecar_eject =&gt; $heap-
&gt; &gt;{idle_timeout}&#41;
&gt; &gt; I solved this problem, by calling $keepalive_obj-&gt;shutdown&#40;&#41; in my
</div>&gt; program.
<div class="message-stanza open">&gt; &gt; I will be happy if resolver could destroyed whithout explicit call
</div>&gt; shutdown
&gt; 
&gt; If you shutdown POE::Component::Client::HTTP, it should shutdown
&gt; Resolver and KeepAlive for
&gt; you.  Your program should exit quickly after that.
&gt; 
&gt; In other words, you should not need to shut down KeepAlive and
&gt; Resolver explicitly.  Just
&gt; Client::HTTP when you&#39;re done with that.
&gt; 
&gt; Is this good enough?
</div>

Let&#39;s I show my problem.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> for_cpan.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w

use utf8;
use strict;
use warnings;

use Data::Dumper;
use POE 1.350;
use POE::Component::Client::HTTP 0.944;
use POE::Component::Client::Keepalive 0.270;
use HTTP::Request::Common qw&#40;GET HEAD&#41;;
use HTTP::Cookies;

$SIG{__WARN__} = sub {
    my $str = shift;
    warn scalar&#40;localtime&#41;.&#34; $str&#34;;
};



my $pool = POE::Component::Client::Keepalive-&gt;new&#40;
                                                       keep_alive   =&gt; 3,
                                                       max_open     =&gt; 2,
                                                       max_per_host =&gt; 2,
                                                       timeout      =&gt; 7,
                                                       resolver     =&gt; POE::Component::Resolver-&gt;new&#40;
                                                                                                     max_resolvers =&gt; 1,
                                                                                                     idle_timeout =&gt; 11,
                                                                                                    &#41;,
                                                      &#41;;

POE::Component::Client::HTTP-&gt;spawn&#40;
                                    Alias             =&gt; &#39;ua&#39;,
                                    FollowRedirects   =&gt; 3,
                                    Timeout           =&gt; 13,
                                    MaxSize           =&gt; 1024,
                                    Agent             =&gt; &#39;&#39;,
                                    ConnectionManager =&gt; $pool,
                                    Streaming         =&gt; 0,
                                    CookieJar         =&gt; HTTP::Cookies-&gt;new&#40;&#41;,
                                   &#41;;

foreach my $i &#40;1..2&#41; {
    POE::Session-&gt;create&#40;
                         inline_states =&gt; {
                                           _start =&gt; sub {
                                               my $header = [TE =&gt; &#39;chunked,identity&#39;, Connection =&gt; &#34;close&#34;];
                                               my $domain = &#39;127.0.0.1:36333&#39;;
                                               my $url = &#34;http://$domain/$i&#34;;
                                               my $request = HTTP::Request-&gt;new&#40; &#39;GET&#39;, $url, $header&#41;;
                                               $poe_kernel-&gt;post&#40; &#34;ua&#34; =&gt; &#34;request&#34;, &#34;response&#34;, $request, {domain=&gt;$domain, i =&gt; $i}&#41;;
                                           },
                                           _stop =&gt; sub {},
                                           response =&gt; \&#38;response,
                                          },
                        &#41;;
}

POE::Kernel-&gt;run&#40;&#41;;
warn 1;
exit;

sub response {
    my &#40;$request_packet, $response_packet&#41; = @_[ARG0, ARG1];

    my $http_request  = $request_packet-&gt;[0];
    my $tag           = $request_packet-&gt;[1];
    my $http_response = $response_packet-&gt;[0];

    warn Dumper $tag;
    warn Dumper $http_response;
}

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;05&nbsp;19:10:03&nbsp;2012</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you very much for the bug report.  I hope to release a fixed POE::Component::Resolver 
soon.

Your test program was especially helpful.  I have reduced it to only use 
POE::Component::Resolver, and I have included it as a regression test for future releases.

commit 34d54dbcb61ada8b0f97b4e145723be9dc35c542
Author: Rocco Caputo &lt;rcaputo@cpan.org&gt;
Date:   Sat May 5 19:01:15 2012 -0400

    [rt.cpan.org 76550] Avoid hang when no requests made.
    
    Fixed thanks to Sergei Kozunov&#39;s bug report and test case.  A sidecar
    process was created at startup, but no idle timeout was set.  These
    timeouts are only set when requests happen, and in an application
    where all addresses are already resolved, no timeout is set.  So the
    component lingers forever.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;05&nbsp;19:10:04&nbsp;2012</span>
    <span class="description">RCAPUTO [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
