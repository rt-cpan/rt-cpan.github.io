<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #125883 for Net-IMAP-Simple: _cmd_ok bug - not handling a case happening with Outlook365 IMAP</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #125883 for Net-IMAP-Simple: _cmd_ok bug - not handling a case happening with Outlook365 IMAP</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-IMAP-Simple/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-IMAP-Simple/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-IMAP-Simple/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-IMAP-Simple/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-IMAP-Simple">Net-IMAP-Simple CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">125883</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-IMAP-Simple/Active/">Net-IMAP-Simple</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cpan [...] parparov.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22730-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22731-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;18&nbsp;15:55:03&nbsp;2018</span>
    <span class="description">cpan [...] parparov.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> _cmd_ok bug - not handling a case happening with Outlook365 IMAP</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 18 Jul 2018 12:54:48 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-IMAP-Simple [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Roman Parparov &lt;roman [...] parparov.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi guys,

Great work, but in the version 1.2209 &#40;and as I checked, in 1.2212&#41; 
there is a problem handling out in _cmd_ok &#40;line 1182 in 1.2209&#41;:

sub _cmd_ok {
     my &#40; $self, $res &#41; = @_;
     my $id = $self-&gt;_count;

     $self-&gt;_debug&#40; caller, __LINE__, &#39;_cmd_ok&#39;, $res &#41; if $self-&gt;{debug};

     if &#40; $res =~ /^$id\s+OK/i &#41; {
         return 1;

     } elsif &#40; $res =~ /^$id\s+&#40;?:NO|BAD&#41;&#40;?:\s+&#40;.+&#41;&#41;?/i &#41; {
         $self-&gt;_seterrstr&#40; $1 || &#39;unknown error&#39; &#41;;
         return 0;

     } elsif &#40; $res =~ m/^\*\s+/ &#41; {

     }else {
         $self-&gt;_seterrstr&#40;&#34;warning unknown return string &#40;id=$id&#41;: $res&#34;&#41;;
     }

     return;
}

Unfortunately, Outlook365 IMAP implementation has been noticed to 
arbitrarily close the connection sending:
[...re/perl5/Net/IMAP/Simple.pm line 1126 in sub _process_cmd] * BYE 
Connection is closed. 13\r\n
[...re/perl5/Net/IMAP/Simple.pm line 1277 in sub _cmd_ok] * BYE 
Connection is closed. 13\r\n
which are thus unparsed and not taken care of. After that you can 
continue to pump commands into IMAP pipeline and after about a fifty 
such commands the script will die without a reason.

I don&#39;t know what the patch should be, but at least some _seterrstr 
should be called.

Thanks,
Roman.
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;10&nbsp;10:03:13&nbsp;2018</span>
    <span class="description">jettero [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hrm. I&#39;m not sure what can be done about that. I&#39;m thinking about it. Since you&#39;ve had time to think about it... have you had any ideas?

BTW, sorry for the late reply. I didn&#39;t notice this in a timely fashion.

On Wed Jul 18 15:55:03 2018, ROMM wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi guys,
&gt; 
&gt; Great work, but in the version 1.2209 &#40;and as I checked, in 1.2212&#41; 
&gt; there is a problem handling out in _cmd_ok &#40;line 1182 in 1.2209&#41;:
&gt; 
&gt; sub _cmd_ok {
&gt;      my &#40; $self, $res &#41; = @_;
&gt;      my $id = $self-&gt;_count;
&gt; 
&gt;      $self-&gt;_debug&#40; caller, __LINE__, &#39;_cmd_ok&#39;, $res &#41; if $self-&gt;{debug};
&gt; 
&gt;      if &#40; $res =~ /^$id\s+OK/i &#41; {
&gt;          return 1;
&gt; 
&gt;      } elsif &#40; $res =~ /^$id\s+&#40;?:NO|BAD&#41;&#40;?:\s+&#40;.+&#41;&#41;?/i &#41; {
&gt;          $self-&gt;_seterrstr&#40; $1 || &#39;unknown error&#39; &#41;;
&gt;          return 0;
&gt; 
&gt;      } elsif &#40; $res =~ m/^\*\s+/ &#41; {
&gt; 
&gt;      }else {
&gt;          $self-&gt;_seterrstr&#40;&#34;warning unknown return string &#40;id=$id&#41;: $res&#34;&#41;;
&gt;      }
&gt; 
&gt;      return;
&gt; }
&gt; 
&gt; Unfortunately, Outlook365 IMAP implementation has been noticed to 
&gt; arbitrarily close the connection sending:
&gt; [...re/perl5/Net/IMAP/Simple.pm line 1126 in sub _process_cmd] * BYE 
&gt; Connection is closed. 13\r\n
&gt; [...re/perl5/Net/IMAP/Simple.pm line 1277 in sub _cmd_ok] * BYE 
&gt; Connection is closed. 13\r\n
&gt; which are thus unparsed and not taken care of. After that you can 
&gt; continue to pump commands into IMAP pipeline and after about a fifty 
&gt; such commands the script will die without a reason.
&gt; 
&gt; I don&#39;t know what the patch should be, but at least some _seterrstr 
&gt; should be called.
&gt; 
&gt; Thanks,
&gt; Roman.
</div>

-- 
If riding in an airplane is flying, then riding in a boat is swimming.
116 jumps, 48.6 minutes of freefall, 92.9 freefall miles.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;10&nbsp;10:03:13&nbsp;2018</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;11&nbsp;18:51:45&nbsp;2018</span>
    <span class="description">cpan [...] parparov.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #125883] _cmd_ok bug - not handling a case happening with Outlook365 IMAP</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 11 Aug 2018 15:51:24 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-IMAP-Simple [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Roman Parparov &lt;roman [...] parparov.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Paul,

So actually I think the * BYE or * qr/.*backoff.*/i or something may 
need to be tested for.

The problem is that at least in my case &#40;I am working with MAPI, 
Office365 IMAP server&#41; the server uses this response either to inform 
that the sock has been shut down, or that the client is throttled and 
needs to back off.

What currently happens is that Net::IMAP::Simple is unaware that the 
sock it wants to print to has been shut down, tries to print something 
into it, and perl quietly&#40;!&#41; SIGPIPES and exits, not dies, but just 
exits with SIGPIPE errno.

Right now I built a wrapper of sorts &#40;sorry, I can&#39;t share more at this 
point&#41;:

readline_callback =&gt; sub {
       push&#40;@{$self-&gt;{imap_responses}}, $_[0]&#41;
       if $_[0] =~ /^&#40;\d+|\*&#41; /i;
}

sub errstr &#40;$&#41; {

         my $self = shift;

         my $errstr = $Net::IMAP::Simple::errstr
                 || $self-&gt;{imap_responses}[-1]
                 || &#39;Unknown error&#39;;
         $errstr;
}

sub handle_failure &#40;$$&#41; {

         my $self = shift;
         my $cmd  = shift;
         my $args = shift;

         $self-&gt;log_it&#40;&#34;$cmd $args failed: &#34; . $self-&gt;errstr&#41;;
         if &#40;$self-&gt;errstr =~ /backoff.* &#40;\d+&#41; millise/i&#41; {
                 my $tosleep = &#40;$1+100000&#41;*1000;
                 $self-&gt;log_it&#40;&#34;Throttling encountered, backing off&#34;&#41;;
                 my $sock = $self-&gt;{imap}-&gt;_sock&#40;&#41;;
                 $self-&gt;disconnect&#40;&#41;;
                 $sock = undef;
                 usleep $tosleep;
         }
         else {
                 sleep $self-&gt;{config}{command_failure_sleep};
         }
}

sub disconnect &#40;$&#41; {

         my $self = shift;

         if &#40;$self-&gt;{imap} &#38;&#38; $self-&gt;{imap}-&gt;_sock &#38;&#38; 
$self-&gt;{imap}-&gt;_sock-&gt;connected&#41; {
$self-&gt;{imap}-&gt;_sock-&gt;shutdown&#40;2&#41;;
                 sleep 1;
         }
}

sub get_status &#40;$&#41; {

         my $self = shift;

         $self-&gt;{imap_responses}
                 &#38;&#38; @{$self-&gt;{imap_responses}}
                 &#38;&#38; $self-&gt;{imap_responses}[-1] =~ 
/^$self-&gt;{imap}{count} OK /
}

And when I execute a command, I test:

                 if &#40;! $sock || ! $sock-&gt;connected&#41; {
                         $imap = $self-&gt;reconnect&#40;$type, $retries+1&#41;;
                         unshift&#40;@commands, &#39;login&#39;&#41; unless $command eq 
&#39;login&#39;;
                 }


Thanks for your time and effort,
R.

On 8/10/18 7:03 AM, Paul Miller via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=125883">https://rt.cpan.org/Ticket/Display.html?id=125883</a></span> &gt;
&gt;
&gt; Hrm. I&#39;m not sure what can be done about that. I&#39;m thinking about it. Since you&#39;ve had time to think about it... have you had any ideas?
&gt;
&gt; BTW, sorry for the late reply. I didn&#39;t notice this in a timely fashion.
&gt;
&gt; On Wed Jul 18 15:55:03 2018, ROMM wrote:
<div class="message-stanza open">&gt;&gt; Hi guys,
&gt;&gt;
&gt;&gt; Great work, but in the version 1.2209 &#40;and as I checked, in 1.2212&#41;
&gt;&gt; there is a problem handling out in _cmd_ok &#40;line 1182 in 1.2209&#41;:
&gt;&gt;
&gt;&gt; sub _cmd_ok {
&gt;&gt;       my &#40; $self, $res &#41; = @_;
&gt;&gt;       my $id = $self-&gt;_count;
&gt;&gt;
&gt;&gt;       $self-&gt;_debug&#40; caller, __LINE__, &#39;_cmd_ok&#39;, $res &#41; if $self-&gt;{debug};
&gt;&gt;
&gt;&gt;       if &#40; $res =~ /^$id\s+OK/i &#41; {
&gt;&gt;           return 1;
&gt;&gt;
&gt;&gt;       } elsif &#40; $res =~ /^$id\s+&#40;?:NO|BAD&#41;&#40;?:\s+&#40;.+&#41;&#41;?/i &#41; {
&gt;&gt;           $self-&gt;_seterrstr&#40; $1 || &#39;unknown error&#39; &#41;;
&gt;&gt;           return 0;
&gt;&gt;
&gt;&gt;       } elsif &#40; $res =~ m/^\*\s+/ &#41; {
&gt;&gt;
&gt;&gt;       }else {
&gt;&gt;           $self-&gt;_seterrstr&#40;&#34;warning unknown return string &#40;id=$id&#41;: $res&#34;&#41;;
&gt;&gt;       }
&gt;&gt;
&gt;&gt;       return;
&gt;&gt; }
&gt;&gt;
&gt;&gt; Unfortunately, Outlook365 IMAP implementation has been noticed to
&gt;&gt; arbitrarily close the connection sending:
&gt;&gt; [...re/perl5/Net/IMAP/Simple.pm line 1126 in sub _process_cmd] * BYE
&gt;&gt; Connection is closed. 13\r\n
&gt;&gt; [...re/perl5/Net/IMAP/Simple.pm line 1277 in sub _cmd_ok] * BYE
&gt;&gt; Connection is closed. 13\r\n
&gt;&gt; which are thus unparsed and not taken care of. After that you can
&gt;&gt; continue to pump commands into IMAP pipeline and after about a fifty
&gt;&gt; such commands the script will die without a reason.
&gt;&gt;
&gt;&gt; I don&#39;t know what the patch should be, but at least some _seterrstr
&gt;&gt; should be called.
&gt;&gt;
&gt;&gt; Thanks,
&gt;&gt; Roman.
</div>&gt;
</div></div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
