<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #8564 for DBD-SQLite: Seg Fault when accessing column name metadata $sth-{NAME}</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #8564 for DBD-SQLite: Seg Fault when accessing column name metadata $sth-{NAME}</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=DBD-SQLite">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=DBD-SQLite">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=DBD-SQLite">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=DBD-SQLite">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-SQLite">DBD-SQLite CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">8564</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=DBD-SQLite">DBD-SQLite</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Scott.Jackson [...] pnl.gov

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-10248-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.07    </td>
  </tr>
  <tr id="CF-10249-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




segFaultTest.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/116871/25343/segFaultTest.pl">
Tue Nov 30 21:12:01 2004 (940b) by 
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/116870/25166/segFaultTest.pl">
Thu Nov 25 21:45:04 2004 (813b) by 
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=8564">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-116868" href="/Public/Bug/Display.html?id=8564#txn-116868">#</a>      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;22&nbsp;13:36:07&nbsp;2004</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Seg Fault when accessing column name metadata $sth-{NAME}</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/116868/25001/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/25001">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am getting a Segmentation Fault when trying to access statement column name metadata after a sqlite query via DBD::SQLite. I am using DBD::SQLite 1.07 &#40;which uses SQLite v3.0.8&#41; and Perl 5.8.0 built for i686-linux and i386-linux-thread-multi on Red Hat Linux 7.1 and 9.0.

I am trying to use DBD::SQLite as part of an open source project that will provide job accounting data to some of the nations largest supercomputing sites. As I use the Perl DBI to access the column names &#40;$sth-&gt;{NAME}&#41; after a SQLite query, a seg fault occurs after some number of accesses to the column names. For example, if I query a table with 12 columns and ask for the column names, it may segfault after successfully giving me the first five. If I put a warn statement in a random place in the dbdimp.c code, the number of columns successfully returned may change to 10 or 0 or even work for a number of queries to die in a later query&#39;s metadata lookup.  

More specifically, here is the backtrace from a recent segfault on a dual proc i386 system:

Trying to read metadata &#40;column names&#41; via Perl DBI &#40;DBD::SQLite&#41; results in a Segmentation Fault in sqlite4ValueText.

gdb backtrace shows corrupt pVal:

0x40447c35 in sqlite3ValueText &#40;pVal=0x1d9, enc=1 &#39;\001&#39;&#41; at vdbemem.c:672
672     warn&#40;&#34;flags: %d&#34;, pVal-&gt;flags&#41;;
&#40;gdb&#41; where
#0  0x40447c35 in sqlite3ValueText &#40;pVal=0x1d9, enc=1 &#39;\001&#39;&#41; at vdbemem.c:672
#1  0x40442d20 in sqlite3_value_text &#40;pVal=0x1d9&#41; at vdbeapi.c:47
#2  0x404437ce in columnName &#40;pStmt=0x8cf8388, N=7, 
    xFunc=0x40442d00 &lt;sqlite3_value_text&gt;, useType=0&#41; at vdbeapi.c:375
#3  0x40443803 in sqlite3_column_name &#40;pStmt=0x8cf8388, N=7&#41; at vdbeapi.c:384
#4  0x404181d2 in sqlite_st_FETCH_attrib &#40;sth=0x846d740, imp_sth=0x8cde4b8, 
    keysv=0x8ceadf4&#41; at dbdimp.c:629
#5  0x40406afd in XS_DBD__SQLite__st_FETCH_attrib &#40;cv=0x8cd714c&#41;
    at SQLite.xsi:690
#6  0x403905c0 in XS_DBI_dispatch &#40;&#41;
   from /usr/local/gold/lib/perl5/i686-linux/auto/DBI/DBI.so
#7  0x080a3c13 in Perl_pp_entersub &#40;&#41;
#8  0x0809de32 in Perl_runops_standard &#40;&#41;
#9  0x0805fc90 in S_call_body &#40;&#41;
#10 0x0805f85f in Perl_call_sv &#40;&#41;
#11 0x080969be in S_magic_methpack &#40;&#41;
#12 0x08096ab8 in Perl_magic_getpack &#40;&#41;
#13 0x08094fe4 in Perl_mg_get &#40;&#41;
#14 0x080a87b0 in Perl_sv_setsv_flags &#40;&#41;
#15 0x080ac31b in Perl_sv_mortalcopy &#40;&#41;
#16 0x080a1acb in Perl_pp_helem &#40;&#41;
#17 0x0809de32 in Perl_runops_standard &#40;&#41;
#18 0x0805f3fb in S_run_body &#40;&#41;
#19 0x0805f18a in perl_run &#40;&#41;
#20 0x0805cbc3 in main &#40;&#41;
#21 0x40081306 in __libc_start_main &#40;main=0x805cb40 &lt;main&gt;, argc=4, 
    ubp_av=0xbffffb14, init=0x805bce8 &lt;_init&gt;, fini=0x80f5a70 &lt;_fini&gt;, 
    rtld_fini=0x4000d2dc &lt;_dl_fini&gt;, stack_end=0xbffffb0c&#41;
    at ../sysdeps/generic/libc-start.c:129

Running valgrind on the same code &#40;with same version of SQLite&#41; &#40;incidentally on a different system&#41; reveals that XS_DBI_dispatch is referencing a block of data that has already been freed.

==3209== Invalid read of size 4
==3209==    at 0x473DC5B2: sqlite3_column_count &#40;vdbeapi.c:289&#41;
==3209==    by 0x473DC88C: columnName &#40;vdbeapi.c:366&#41;
==3209==    by 0x473DC909: sqlite3_column_name &#40;vdbeapi.c:383&#41;
==3209==    by 0x473B26C8: sqlite_st_FETCH_attrib &#40;dbdimp.c:628&#41;
==3209==    by 0x473A129A: XS_DBD__SQLite__st_FETCH_attrib &#40;SQLite.xsi:690&#41;
==3209==    by 0x440FAEB0: XS_DBI_dispatch &#40;DBI.xs:2663&#41;
==3209==    by 0x402B04E4: Perl_pp_entersub &#40;pp_hot.c:2781&#41;
==3209==    by 0x40293C99: Perl_runops_debug &#40;dump.c:1414&#41;
==3209==    by 0x40248758: S_call_body &#40;perl.c:2069&#41;
==3209==    by 0x40248616: Perl_call_sv &#40;perl.c:1948&#41;
==3209==    by 0x40247DE5: Perl_call_method &#40;perl.c:1881&#41;
==3209==    by 0x4029C5BB: S_magic_methcall &#40;mg.c:1328&#41;
==3209==    by 0x4029C734: S_magic_methpack &#40;mg.c:1340&#41;
==3209==    by 0x4029C929: Perl_magic_getpack &#40;mg.c:1353&#41;
==3209==    by 0x4029A336: Perl_mg_get &#40;mg.c:128&#41;
==3209==    Address 0x45C58864 is 568 bytes inside a block of size 592 free&#39;d
==3209==    at 0x400296BF: free &#40;vg_replace_malloc.c:220&#41;
==3209==    by 0x473D4030: sqlite3FreeX &#40;util.c:283&#41;
==3209==    by 0x473DF158: sqlite3VdbeDelete &#40;vdbeaux.c:1411&#41;
==3209==    by 0x473DEF2E: sqlite3VdbeFinalize &#40;vdbeaux.c:1349&#41;
==3209==    by 0x473BF696: sqlite3_finalize &#40;main.c:1223&#41;
==3209==    by 0x473B202E: sqlite_st_finish &#40;dbdimp.c:523&#41;
==3209==    by 0x473B1B18: sqlite_st_fetch &#40;dbdimp.c:457&#41;
==3209==    by 0x4739B78F: dbdxst_fetchall_arrayref &#40;Driver_xst.h:97&#41;
==3209==    by 0x473A0255: XS_DBD__SQLite__st_fetchall_arrayref &#40;SQLite.xsi:618&#41;==3209==    by 0x440FAEB0: XS_DBI_dispatch &#40;DBI.xs:2663&#41;
==3209==    by 0x402B04E4: Perl_pp_entersub &#40;pp_hot.c:2781&#41;
==3209==    by 0x40293C99: Perl_runops_debug &#40;dump.c:1414&#41;
==3209==    by 0x402479AA: S_run_body &#40;perl.c:1705&#41;
==3209==    by 0x40247634: perl_run &#40;perl.c:1624&#41;
==3209==    by 0x80493A2: main &#40;in /usr/bin/perl&#41;
==3209==

Valgrind revealed numerous references to memory that had already been freed.

Thank you for any help you can give me on this!

Scott Jackson
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-116869" href="/Public/Bug/Display.html?id=8564#txn-116869">#</a>      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;22&nbsp;13:49:34&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/116869/25002/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/25002">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 819b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Mon Nov 22 13:36:07 2004]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; gdb backtrace shows corrupt pVal:
&gt; 
&gt; 0x40447c35 in sqlite3ValueText &#40;pVal=0x1d9, enc=1 &#39;\001&#39;&#41; at
&gt;    vdbemem.c:672
&gt; 672   warn&#40;&#34;flags: %d&#34;, pVal-&gt;flags&#41;;
&gt; &#40;gdb&#41; where
&gt; #0  0x40447c35 in sqlite3ValueText &#40;pVal=0x1d9, enc=1 &#39;\001&#39;&#41; at
&gt;    vdbemem.c:672
&gt; #1  0x40442d20 in sqlite3_value_text &#40;pVal=0x1d9&#41; at vdbeapi.c:47
</div>
I apologize -- I left in some warn statements used while debugging the 
error which might cause you some confusion.

The first few lines in the gdb backtrace should actually say: 
0x40447bf3 in sqlite3ValueText &#40;pVal=0x259, enc=1 &#39;\001&#39;&#41; at 
vdbemem.c:669
674       if&#40; pVal-&gt;flags&#38;MEM_Null &#41;{
&#40;gdb&#41; where
#0  0x40447bf3 in sqlite3ValueText &#40;pVal=0x259, enc=1 &#39;\001&#39;&#41; at 
vdbemem.c:669
#1  0x40442d20 in sqlite3_value_text &#40;pVal=0x259&#41; at vdbeapi.c:47

Scott
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-116870" href="/Public/Bug/Display.html?id=8564#txn-116870">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;25&nbsp;21:45:04&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> david_dick [...] iprimus.com.au</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/116870/25165/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/25165">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 224b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Scott

i&#39;ve been attempting and failing to replicate your error with the
attached perl snippet.  Could you confirm that this causes the segfault
on your system or provide a fragment that does cause the segfault?

Uru
-Dave
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/116870/25166/segFaultTest.pl">Download segFaultTest.pl</a><br />
<span class="downloadcontenttype">text/x-perl 813b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#! /usr/bin/perl

use DBI&#40;&#41;;
use warnings;
use strict;

eval {
	my $dbh = DBI-&gt;connect&#40;&#34;dbi:SQLite:dbname=temp.db&#34;, &#39;&#39; , &#39;&#39; , { RaiseError =&gt; 1 , PrintError =&gt; 1 , AutoCommit =&gt; 0 }&#41; ;
	$dbh-&gt;do&#40;&#39;CREATE TABLE test &#40;id INTEGER, b CHAR, c VARCHAR, d INTEGER, e INTEGER, f INTEGER, g INTEGER, h INTEGER, i CHAR, j CHAR, k CHAR, l CHAR&#41;&#39;&#41; ;
#	$dbh-&gt;do&#40;&#39;INSERT INTO test &#40;id, b, c, d, e, f, g, h, i, j, k, l&#41; VALUES &#40;1,2,3,4,5,6,7,8,9,10,11,12&#41;&#39;&#41; ;
	my &#40;$sth&#41; = $dbh-&gt;prepare&#40;&#39;SELECT * FROM test&#39;&#41;;
	$sth-&gt;execute&#40;&#41;;
	my &#40;$key&#41;;
	foreach $key &#40;@{$sth-&gt;{NAME}}&#41; {
		print &#34;Key:$key\n&#34;;
	}
	for&#40;my $i = 0; $i &lt; &#40;scalar @{$sth-&gt;{NAME}}&#41;; $i++&#41; {
		print &#34;Key:&#34; . $sth-&gt;{NAME}-&gt;[$i] . &#34;\n&#34;;
	}
	$sth-&gt;finish&#40;&#41;;
	$dbh-&gt;rollback&#40;&#41;;
	$dbh-&gt;disconnect&#40;&#41;;
};
if &#40;$@&#41; {
	chomp&#40;$@&#41;;
	print &#34;$@\n&#34;;
	exit&#40;1&#41;;
}
print &#34;Success\n&#34;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-116871" href="/Public/Bug/Display.html?id=8564#txn-116871">#</a>      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;30&nbsp;21:12:00&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> scottmo</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/116871/25342/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/25342">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dave, I very much appreciate the effort you made to try to reproduce
this problem!

I have been able to reproduce the segFault by making the following
modifications to your testcase.

Remove the parens from around your $sth variable declaration:

my $sth = $dbh-&gt;prepare&#40;&#39;SELECT * FROM test&#39;&#41;;

After your $sth-&gt;execute&#40;&#41;; line add the lines:

  my $data_array_ref = $sth-&gt;fetchall_arrayref&#40;&#41;;
  my $cols = $sth-&gt;{NUM_OF_FIELDS};

Running the testcase after doing this gave me my segfault. This is a
very finicky segFault, as soon as I added one other print statement, the
segFault went away &#40;it would have shown up elsewhere if I continued to
make calls in this manner&#41;.

When I saw that you apparently deliberately parenthesized the sth I
figured maybe I was using DBI wrong, but the perldocs for my version of
DBI do not show the $sth being parenthesized in the manner that you did
in your script. However, this appears to be an important component of
the segFault.

$ perl segFaultTest.pl
Key:id
Key:b
Key:c
Key:d
Key:e
Key:f
Key:g
Key:h
Key:i
Key:j
Key:k
Key:l
Key:id
Segmentation fault &#40;core dumped&#41;
$

I have attached the test case that produces a segFault. 

Thanks for your help,

Scott Jackson
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/116871/25343/segFaultTest.pl">Download segFaultTest.pl</a><br />
<span class="downloadcontenttype">text/x-perl 940b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#! /usr/bin/perl

use lib qw &#40;/usr/local/gold/lib/perl5&#41;;
use DBI&#40;&#41;;
use warnings;
use strict;

eval {
	my $dbh = DBI-&gt;connect&#40;&#34;dbi:SQLite:dbname=temp.db&#34;, &#39;&#39; , &#39;&#39; , { RaiseError =&gt; 1 , PrintError =&gt; 1 , AutoCommit =&gt; 0 }&#41; ;
	$dbh-&gt;do&#40;&#39;CREATE TABLE test &#40;id INTEGER, b CHAR, c VARCHAR, d INTEGER, e INTEGER, f INTEGER, g INTEGER, h INTEGER, i CHAR, j CHAR, k CHAR, l CHAR&#41;&#39;&#41; ;
	$dbh-&gt;do&#40;&#39;INSERT INTO test &#40;id, b, c, d, e, f, g, h, i, j, k, l&#41; VALUES &#40;1,2,3,4,5,6,7,8,9,10,11,12&#41;&#39;&#41; ;

	my $sth = $dbh-&gt;prepare&#40;&#39;SELECT * FROM test&#39;&#41;;
	$sth-&gt;execute&#40;&#41;;

  my $data_array_ref = $sth-&gt;fetchall_arrayref&#40;&#41;;
  my $cols = $sth-&gt;{NUM_OF_FIELDS};

  my &#40;$key&#41;;
	foreach $key &#40;@{$sth-&gt;{NAME}}&#41; {
		print &#34;Key:$key\n&#34;;
	}
	for&#40;my $i = 0; $i &lt; &#40;scalar @{$sth-&gt;{NAME}}&#41;; $i++&#41; {
		print &#34;Key:&#34; . $sth-&gt;{NAME}-&gt;[$i] . &#34;\n&#34;;
	}
	$sth-&gt;finish&#40;&#41;;
	$dbh-&gt;rollback&#40;&#41;;
	$dbh-&gt;disconnect&#40;&#41;;
};
if &#40;$@&#41; {
	chomp&#40;$@&#41;;
	print &#34;$@\n&#34;;
	exit&#40;1&#41;;
}
print &#34;Success\n&#34;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-116872" href="/Public/Bug/Display.html?id=8564#txn-116872">#</a>      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;08&nbsp;19:34:34&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/116872/25675/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/25675">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 297b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">G&#39;day Scott, 
I&#39;ve tried numerous times to attempt to replicate this bug with 
various versions of perl and linux.  However, I cannot get hold of Red 
Hat 7.1, so possibly this is the issue.  For the record, Red Hat 7.3 
with perl 5.6.1 and Red Hat 8.0 with perl 5.8 seem to work fine.  
Sorry. 
 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-116873" href="/Public/Bug/Display.html?id=8564#txn-116873">#</a>      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;29&nbsp;16:24:49&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> scottmo</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/116873/26970/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/26970">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dave,

Thanks again for your efforts. It is not entirely unexpected that you 
were not able to reproduce the problem since it is a highly fickle 
problem that seems to move around &#40;appear/disappear, show up in 
different places&#41; just by adding or deleting comments. In general, it 
has been very difficult to produce a small testcase that produces the 
problem reliably on other boxes, although I have been able to reproduce 
the problem on all architectures and os levels I have available with a 
bit of tweaking.

I believe I understand the problem better now. The problem only 
manifests itself when using fetchrow_arrayref &#40;not for fetchall_array, 
fetchrow_arrayref, fetchall_hashref, etc&#41;. Although this is not 
explained in the perldoc for DBI, what I have been able to gather is 
that fetchall_arrayref is unique in that after it fetches all the data, 
it automatically calls finish&#40;&#41; on the statement handle leaving it 
inactive. At this point it could be hazardous to try to use the 
statement handle to access metadata information like NUM_OF_FIELDS, or 
NAME or TYPE since the memory for these datastructures has been freed. 
This agrees with what I saw with valgrind -- any time I tried to access 
$sth-&gt;{NAME} or $sth-&gt;{TYPE} or $sth-&gt;{NUM_OF_FIELDS} after doing the 
fetchall_arrayref, valgrind warned that these were invalid references 
to memory that had already been freed!

I have seen that mysql and other databases have suffered from the same 
problem. It appears that postgresql and oracle, at least, have 
corrected the problem in their DBD code such that it does not create a 
segfault situation.

I have been able to work around the situation by grabbing the pertinent 
metadata items before calling fetchall_arrayref. It requires some extra 
array copies but is not debilitating.

  $sth = $dbh-&gt;prepare&#40;$sql&#41;;
  $sth-&gt;execute&#40;&#41;;

  my %results = &#40;&#41;;
  $results{rows} = $sth-&gt;rows;
  $results{cols} = $sth-&gt;{NUM_OF_FIELDS};
  $results{names} = [@{$sth-&gt;{NAME}}];
  $results{data} = $sth-&gt;fetchall_arrayref&#40;&#41;;

Although I may be able to agree that this is not necessarily a bug in 
your code, since you are dutifully deactivating the statement handle 
after the fetch, perhaps you might still want to make some 
modifications that will prevent a segfault situation from occurring. I 
think a user should not be able to create a segmentation fault as a 
result of routine use of the api that is perfectly in accordance with 
the documented usage.

Thanks for your efforts!

Sincerly,

Scott Jackson
Pacific Northwest National Laboratory 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-239112" href="/Public/Bug/Display.html?id=8564#txn-239112">#</a>      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;07&nbsp;19:17:01&nbsp;2006</span>
    <span class="description">msergeant [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/239112/101063/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/101063">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 77b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">added a croak&#40;&#41; when you try and do this on an inactive sth. Will be in 1.13.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-239113" href="/Public/Bug/Display.html?id=8564#txn-239113">#</a>      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;07&nbsp;19:17:01&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-239115" href="/Public/Bug/Display.html?id=8564#txn-239115">#</a>      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;07&nbsp;19:17:02&nbsp;2006</span>
    <span class="description">msergeant [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.50764</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
