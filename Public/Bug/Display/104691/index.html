<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #104691 for Proc-PID-File: patch for Windows</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #104691 for Proc-PID-File: patch for Windows</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Proc-PID-File/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Proc-PID-File/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Proc-PID-File/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Proc-PID-File/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Proc-PID-File">Proc-PID-File CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">104691</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Proc-PID-File/Active/">Proc-PID-File</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
CHORNY [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-27188-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.27    </td>
  </tr>
  <tr id="CF-27189-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;25&nbsp;13:52:31&nbsp;2015</span>
    <span class="description">CHORNY [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch for Windows</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Win32::Process is bundled in both Strawberry and ActivePerl.

-- 
Alexandr Ciornii, <span class="clickylink"><a target="new" rel="nofollow" href="http://chorny.net">http://chorny.net</a></span>
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl -w

#
#   Proc::PID::File - test suite
#   Copyright &#40;C&#41; 2001-2003 Erick Calder
#
#   This program is free software; you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation; either version 2 of the License, or
#   &#40;at your option&#41; any later version.
#
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public License
#   along with this program; if not, write to the Free Software
#   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#

use strict;
use warnings;

#   make sure this script can find the module
#   without being run by &#39;make test&#39; &#40;see --deamon switch below&#41;.

use lib &#34;blib/lib&#34;;

use Proc::PID::File;
use Test::Simple tests =&gt; 12;
use Config;
use File::Spec;
my $devnull = File::Spec-&gt;devnull;

$|++; $\ = &#34;\n&#34;;
my %args = &#40;name =&gt; &#34;test&#34;, dir =&gt; &#34;.&#34;, debug =&gt; $ENV{DEBUG} || &#34;&#34;&#41;;
my $cmd = shift || &#34;&#34;;

# - deamon -------------------------------------------------------------------

if &#40;$cmd eq &#34;--daemon&#34;&#41; {
	print &#34;-- daemon --&#34;;
	$args{verify} = 1;
    die &#34;Already running!&#34; if Proc::PID::File-&gt;running&#40;%args&#41;;
    sleep&#40;5&#41;;
	print &#34;-- deamon: exiting --&#34;;
    exit&#40;&#41;;
    }

exit&#40;&#41; if $cmd eq &#34;--short&#34;;

my $pid;
our $ProcessObj;
sub rundaemon {
	my $pipes = $args{debug} =~ /D/ ? &#34;&#34; : &#34;&gt; $devnull 2&gt;&#38;1&#34;;
	if &#40;$^O eq &#39;MSWin32&#39;&#41; {
		require Win32::Process;
		require Win32;
		$ProcessObj-&gt;Kill&#40;0&#41; if $ProcessObj;
		Win32::Process::Create&#40;$ProcessObj,
                            &#34;$^X&#34;,
                            &#34;$^X $0 --daemon $pipes&#34;,
                            0,
                            32 + 134217728, #NORMAL_PRIORITY_CLASS + CREATE_NO_WINDOW
                            &#34;.&#34;&#41; || die $^E;
	} else {
		system qq|$^X $0 --daemon $pipes &#38;|;
	}
	sleep 1;
	open my $fh, &#39;&lt;&#39;, &#34;$args{dir}/$args{name}.pid&#34; or die &#34;Error reading $args{dir}/$args{name}.pid - $!&#34;;
	my $pid=&lt;$fh&gt;;
	chomp&#40;$pid&#41;;
	}

# - thread-safety test -------------------------------------------------------

ok&#40;1, &#34;SKIPPED - simple: thread safe&#34;&#41; unless
	$] &gt;= 5.008001
	&#38;&#38; $Config{&#34;useithreads&#34;}
	&#38;&#38; eval { 
		require threads; 
		Proc::PID::File-&gt;running&#40;%args&#41;;
		threads-&gt;create&#40;sub {}&#41;-&gt;join&#40;&#41;;
		sleep&#40;2&#41;;
		ok&#40;-f &#34;test.pid&#34;, &#34;simple: thread safe&#34;&#41;;
	};

# - basic run test -----------------------------------------------------------

unlink&#40;&#34;test.pid&#34;&#41; || die $! if -e &#34;test.pid&#34;;
rundaemon&#40;&#41;;
my $rc = Proc::PID::File-&gt;running&#40;%args&#41;;
ok&#40;$rc, &#34;simple: running&#34;&#41;;

# - verification tests -------------------------------------------------------

ok&#40;1, &#34;SKIPPED - simple: verified &#40;real&#41;&#34;&#41; unless
	$^O =~ /linux|freebsd|cygwin/i
	&#38;&#38; eval {
		$rc = Proc::PID::File-&gt;running&#40;%args, verify =&gt; 1&#41;;
		ok&#40;$rc, &#34;simple: verified &#40;real&#41;&#34;&#41;;
		};

ok&#40;1, &#34;SKIPPED - simple: verified &#40;false&#41;&#34;&#41; unless
	$^O =~ /linux|freebsd|cygwin/i
	&#38;&#38; eval {
		# WARNING: the following test takes over the pidfile from
		# the daemon such that he cannot clean it up.  this is as
		# it should be since no one but us should occupy our pidfile 

		$rc = Proc::PID::File-&gt;running&#40;%args, verify =&gt; &#34;falsetest&#34;&#41;;
		ok&#40;! $rc, &#34;simple: verified &#40;false&#41;&#34;&#41;;
		};

# - single instance test -----------------------------------------------------

if &#40;$ProcessObj&#41; {
	$ProcessObj-&gt;Wait&#40;6000&#41; or $ProcessObj-&gt;Kill&#40;0&#41;;
	$ProcessObj = undef;
} else {
	sleep 1 while kill 0, $pid;
}

$rc = Proc::PID::File-&gt;running&#40;%args&#41;;
ok&#40;! $rc, &#34;simple: single instance&#34;&#41;;

# - destroy test -------------------------------------------------------------

system qq|$^X $0 --short &gt; $devnull 2&gt;&#38;1|;
ok&#40;-f &#34;test.pid&#34;, &#34;simple: destroy&#34;&#41;;

# - OO Interface tests -------------------------------------------------------

my $c1 = Proc::PID::File-&gt;new&#40;%args&#41;;
ok&#40;$c1-&gt;{path}, &#34;oo: object initialised&#34;&#41;;

$c1-&gt;touch&#40;&#41;;
ok&#40;-f $c1-&gt;{path}, &#34;oo: file touched&#34;&#41;;

ok&#40;!$c1-&gt;alive&#40;&#41;, &#34;oo: alive &#40;with current process&#41;&#34;&#41;;

unlink&#40;&#34;test.pid&#34;&#41; || die $! if -e &#34;test.pid&#34;;
rundaemon&#40;&#41;;
ok&#40;$c1-&gt;alive&#40;&#41;, &#34;oo: alive &#40;with daemon&#41;&#34;&#41;;

ok&#40;1, &#34;SKIPPED - oo: alive &#40;verified&#41;&#34;&#41; unless
	$^O =~ /linux|freebsd|cygwin/i
	&#38;&#38; eval {
		ok&#40;$c1-&gt;alive&#40;verify =&gt; 1&#41;, &#34;oo: alive &#40;verified&#41;&#34;&#41;;
		};

$c1-&gt;release&#40;&#41;;
ok&#40;! -f $c1-&gt;{path}, &#34;oo: released&#34;&#41;;

# - wait for daemon to exit --------------------------------------------------

$\ = undef;
print &#34;#waiting for daemon death\n&#34;;
if &#40;$ProcessObj&#41; {
	$ProcessObj-&gt;Wait&#40;1000&#41; or $ProcessObj-&gt;Kill&#40;0&#41;;
} else {
	sleep 1, print &#34;.&#34; while kill 0, $pid;
}
#print &#34;\ndone\n&#34;;
#exit 0;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test.pl.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- test.pl	2009-10-04 05:00:56.000000000 +0300
+++ D:\OSS\repo\win32\1\Proc-PID-File-1.27\test.pl	2015-05-25 20:49:12.703125000 +0300
@@ -30,6 +30,8 @@
 use Proc::PID::File;
 use Test::Simple tests =&gt; 12;
 use Config;
+use File::Spec;
+my $devnull = File::Spec-&gt;devnull;
 
 $|++; $\ = &#34;\n&#34;;
 my %args = &#40;name =&gt; &#34;test&#34;, dir =&gt; &#34;.&#34;, debug =&gt; $ENV{DEBUG} || &#34;&#34;&#41;;
@@ -49,11 +51,26 @@
 exit&#40;&#41; if $cmd eq &#34;--short&#34;;
 
 my $pid;
+our $ProcessObj;
 sub rundaemon {
-	my $pipes = $args{debug} =~ /D/ ? &#34;&#34; : &#34;&gt; /dev/null 2&gt;&#38;1&#34;;
+	my $pipes = $args{debug} =~ /D/ ? &#34;&#34; : &#34;&gt; $devnull 2&gt;&#38;1&#34;;
+	if &#40;$^O eq &#39;MSWin32&#39;&#41; {
+		require Win32::Process;
+		require Win32;
+		$ProcessObj-&gt;Kill&#40;0&#41; if $ProcessObj;
+		Win32::Process::Create&#40;$ProcessObj,
+                            &#34;$^X&#34;,
+                            &#34;$^X $0 --daemon $pipes&#34;,
+                            0,
+                            32 + 134217728, #NORMAL_PRIORITY_CLASS + CREATE_NO_WINDOW
+                            &#34;.&#34;&#41; || die $^E;
+	} else {
 	system qq|$^X $0 --daemon $pipes &#38;|;
+	}
 	sleep 1;
-	chomp&#40;$pid = qx|cat $args{dir}/$args{name}.pid|&#41;;
+	open my $fh, &#39;&lt;&#39;, &#34;$args{dir}/$args{name}.pid&#34; or die &#34;Error reading $args{dir}/$args{name}.pid - $!&#34;;
+	my $pid=&lt;$fh&gt;;
+	chomp&#40;$pid&#41;;
 	}
 
 # - thread-safety test -------------------------------------------------------
@@ -98,14 +115,19 @@
 
 # - single instance test -----------------------------------------------------
 
+if &#40;$ProcessObj&#41; {
+	$ProcessObj-&gt;Wait&#40;6000&#41; or $ProcessObj-&gt;Kill&#40;0&#41;;
+	$ProcessObj = undef;
+} else {
 sleep 1 while kill 0, $pid;
+}
 
 $rc = Proc::PID::File-&gt;running&#40;%args&#41;;
 ok&#40;! $rc, &#34;simple: single instance&#34;&#41;;
 
 # - destroy test -------------------------------------------------------------
 
-system qq|$^X $0 --short &gt; /dev/null 2&gt;&#38;1|;
+system qq|$^X $0 --short &gt; $devnull 2&gt;&#38;1|;
 ok&#40;-f &#34;test.pid&#34;, &#34;simple: destroy&#34;&#41;;
 
 # - OO Interface tests -------------------------------------------------------
@@ -134,7 +156,11 @@
 # - wait for daemon to exit --------------------------------------------------
 
 $\ = undef;
-print &#34;waiting for daemon death&#34;;
+print &#34;#waiting for daemon death\n&#34;;
+if &#40;$ProcessObj&#41; {
+	$ProcessObj-&gt;Wait&#40;1000&#41; or $ProcessObj-&gt;Kill&#40;0&#41;;
+} else {
 sleep 1, print &#34;.&#34; while kill 0, $pid;
-print &#34;\ndone\n&#34;;
-exit 0;
+}
+#print &#34;\ndone\n&#34;;
+#exit 0;
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
