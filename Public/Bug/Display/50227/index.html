<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #50227 for YAML-Syck: not quoting strings when data has been sorted numerically before being passed to JSON::Syck::Dump</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #50227 for YAML-Syck: not quoting strings when data has been sorted numerically before being passed to JSON::Syck::Dump</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=YAML-Syck">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=YAML-Syck">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=YAML-Syck">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=YAML-Syck">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/YAML-Syck">YAML-Syck CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">50227</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=YAML-Syck">YAML-Syck</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">TODDR [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dmuey [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-37914-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.07    </td>
  </tr>
  <tr id="CF-37915-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.10_02    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




patch.txt<br />
<ul>

</ul>


patch2.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/804730/417154/patch2.txt">
Thu Jul 15 19:32:12 2010 (2k) by TODDR [...] cpan.org
</a>
</font></li>
</ul>


patch3.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/804801/417202/patch3.txt">
Thu Jul 15 21:44:04 2010 (4.1k) by TODDR [...] cpan.org
</a>
</font></li>
</ul>


YAML-Syck.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/672708/345878/YAML-Syck.patch">
Mon Oct 05 16:17:53 2009 (2.4k) by dmuey [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=50227">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-672708" href="/Public/Bug/Display.html?id=50227#txn-672708">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;05&nbsp;16:17:53&nbsp;2009</span>
    <span class="description">dmuey [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> not quoting strings when data has been sorted numerically before
 being passed to JSON::Syck::Dump</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/672708/345875/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/345875">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Note how strings are treated, even with a string based sort:

hal9000:~ dmuey$ perl -MJSON::Syck -e &#39;print
JSON::Syck::Dump&#40;\@ARGV&#41;.&#34;\n&#34;;print JSON::Syck::Dump&#40;[sort { $a cmp $b }
@ARGV]&#41;.&#34;\n&#34;;print JSON::Syck::Dump&#40;\@ARGV&#41;.&#34;\n&#34;;&#39; 2 1 Howdy
[&#34;2&#34;,&#34;1&#34;,&#34;Howdy&#34;]
[&#34;1&#34;,&#34;2&#34;,&#34;Howdy&#34;]
[&#34;2&#34;,&#34;1&#34;,&#34;Howdy&#34;]
hal9000:~ dmuey$ 

Now compare that to when the data is passed through a numeric sort prior
to JSON-ification:

hal9000:~ dmuey$ perl -MJSON::Syck -e &#39;print
JSON::Syck::Dump&#40;\@ARGV&#41;.&#34;\n&#34;;print JSON::Syck::Dump&#40;[sort { $a &lt;=&gt; $b }
@ARGV]&#41;.&#34;\n&#34;;print JSON::Syck::Dump&#40;\@ARGV&#41;.&#34;\n&#34;;&#39; 2 1 Howdy
[&#34;2&#34;,&#34;1&#34;,&#34;Howdy&#34;]
[Howdy,1,2]
[2,1,Howdy]
hal9000:~ dmuey$ 

JSON::Syck forever treats it as an integer and does not quote it! That
results in broken JSON ...

rebuilding YAML::Syck 1.07 with the attached patch applied creates a
global that makes it quote everything.

A better solution is to probably get it to quote the value as
appropriate to what it is instead ...

Here is the output when the variable added via the patch is set to true:

hal9000:~ dmuey$ perl -MJSON::Syck -e &#39;$JSON::Syck::PreferString=1;print
JSON::Syck::Dump&#40;\@ARGV&#41;.&#34;\n&#34;;print JSON::Syck::Dump&#40;[sort { $a cmp $b }
@ARGV]&#41;.&#34;\n&#34;;print JSON::Syck::Dump&#40;\@ARGV&#41;.&#34;\n&#34;;&#39; 2 1 Howdy
[&#34;2&#34;,&#34;1&#34;,&#34;Howdy&#34;]
[&#34;1&#34;,&#34;2&#34;,&#34;Howdy&#34;]
[&#34;2&#34;,&#34;1&#34;,&#34;Howdy&#34;]
hal9000:~ dmuey$ perl -MJSON::Syck -e &#39;$JSON::Syck::PreferString=1;print
JSON::Syck::Dump&#40;\@ARGV&#41;.&#34;\n&#34;;print JSON::Syck::Dump&#40;[sort { $a &lt;=&gt; $b }
@ARGV]&#41;.&#34;\n&#34;;print JSON::Syck::Dump&#40;\@ARGV&#41;.&#34;\n&#34;;&#39; 2 1 Howdy
[&#34;2&#34;,&#34;1&#34;,&#34;Howdy&#34;]
[&#34;Howdy&#34;,&#34;1&#34;,&#34;2&#34;]
[&#34;2&#34;,&#34;1&#34;,&#34;Howdy&#34;]
hal9000:~ dmuey$ 
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> YAML-Syck.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/672708/345878/YAML-Syck.patch">Download YAML-Syck.patch</a><br />
<span class="downloadcontenttype">text/x-diff 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ruN YAML-Syck-1.07/perl_common.h YAML-Syck-1.07.fixed/perl_common.h
--- YAML-Syck-1.07/perl_common.h	2008-04-19 14:08:31.000000000 -0500
+++ YAML-Syck-1.07.fixed/perl_common.h	2009-10-05 14:33:00.000000000 -0500
@@ -36,6 +36,7 @@
     char* tag;
     char dump_code;
     bool implicit_binary;
+    bool prefer_string;
 };
 
 struct parser_xtra {
diff -ruN YAML-Syck-1.07/perl_syck.h YAML-Syck-1.07.fixed/perl_syck.h
--- YAML-Syck-1.07/perl_syck.h	2008-06-08 12:53:09.000000000 -0500
+++ YAML-Syck-1.07.fixed/perl_syck.h	2009-10-05 14:35:27.000000000 -0500
@@ -740,6 +740,7 @@
     SV*  sv                    = &#40;SV*&#41;data;
     struct emitter_xtra *bonus = &#40;struct emitter_xtra *&#41;e-&gt;bonus;
     char* tag                  = bonus-&gt;tag;
+    char prefer_string      = bonus-&gt;prefer_string;
     svtype ty                  = SvTYPE&#40;sv&#41;;
 #ifndef YAML_IS_JSON
     char dump_code             = bonus-&gt;dump_code;
@@ -860,7 +861,8 @@
         /* emit an undef &#40;typically pointed from a blesed SvRV&#41; */
         syck_emit_scalar&#40;e, OBJOF&#40;&#34;str&#34;&#41;, scalar_plain, 0, 0, 0, NULL_LITERAL, NULL_LITERAL_LENGTH&#41;;
     }
-    else if &#40;SvNIOKp&#40;sv&#41; &#38;&#38; &#40;sv_len&#40;sv&#41; != 0&#41;&#41; {
+    else if &#40; &#40;!prefer_string ||  &#40;sv_len&#40;sv&#41; == 0&#41; &#41; &#38;&#38; SvNIOKp&#40;sv&#41; &#38;&#38; &#40;sv_len&#40;sv&#41; != 0&#41; &#41; {
+        /* if prefer_string is on only emit */
         /* emit a number with a stringified version */
         syck_emit_scalar&#40;e, OBJOF&#40;&#34;str&#34;&#41;, SCALAR_NUMBER, 0, 0, 0, SvPV_nolen&#40;sv&#41;, sv_len&#40;sv&#41;&#41;;
     }
@@ -1074,6 +1076,7 @@
     SV *headless         = GvSV&#40;gv_fetchpv&#40;form&#40;&#34;%s::Headless&#34;, PACKAGE_NAME&#41;, TRUE, SVt_PV&#41;&#41;;
     SV *implicit_unicode = GvSV&#40;gv_fetchpv&#40;form&#40;&#34;%s::ImplicitUnicode&#34;, PACKAGE_NAME&#41;, TRUE, SVt_PV&#41;&#41;;
     SV *implicit_binary  = GvSV&#40;gv_fetchpv&#40;form&#40;&#34;%s::ImplicitBinary&#34;, PACKAGE_NAME&#41;, TRUE, SVt_PV&#41;&#41;;
+    SV *prefer_string    = GvSV&#40;gv_fetchpv&#40;form&#40;&#34;%s::PreferString&#34;, PACKAGE_NAME&#41;, TRUE, SVt_PV&#41;&#41;;
     SV *use_code         = GvSV&#40;gv_fetchpv&#40;form&#40;&#34;%s::UseCode&#34;, PACKAGE_NAME&#41;, TRUE, SVt_PV&#41;&#41;;
     SV *dump_code        = GvSV&#40;gv_fetchpv&#40;form&#40;&#34;%s::DumpCode&#34;, PACKAGE_NAME&#41;, TRUE, SVt_PV&#41;&#41;;
     SV *sortkeys         = GvSV&#40;gv_fetchpv&#40;form&#40;&#34;%s::SortKeys&#34;, PACKAGE_NAME&#41;, TRUE, SVt_PV&#41;&#41;;
@@ -1111,6 +1114,7 @@
     *&#40;bonus.tag&#41; = &#39;\0&#39;;
     bonus.dump_code = SvTRUE&#40;use_code&#41; || SvTRUE&#40;dump_code&#41;;
     bonus.implicit_binary = SvTRUE&#40;implicit_binary&#41;;
+    bonus.prefer_string = SvTRUE&#40;prefer_string&#41;;
     emitter-&gt;bonus = &#38;bonus;
 
     syck_emitter_handler&#40; emitter, PERL_SYCK_EMITTER_HANDLER &#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-779486" href="/Public/Bug/Display.html?id=50227#txn-779486">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;20&nbsp;07:08:04&nbsp;2010</span>
    <span class="description">avar [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/779486/403709/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/403709">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">&#40;This is a form-reply that isn&#39;t specific to your particular report&#41;

YAML::Syck has just acquired one new maintainer &#40;me&#41;, it still doesn&#39;t
have anyone that *cares* about it. But I&#39;m willing to help solve your
report &#38; release a new version with the fix if it&#39;s easy for me.

It now has a Git repository at:

    <span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/avar/YAML-Syck">http://github.com/avar/YAML-Syck</a></span>

If your report is a patch that fixes a problem, great. Please remake
the patch against Git by forking that repo and sending me a pull
request on GitHub &#40;or an update to this bug if you prefer
git-format-patch&#40;1&#41; or some other repo provider..&#41;. Make sure to
include a test for what you fixed.

If your report is some code that fails &#40;and you have a testcase for
it&#41; a patch against the test suite to demonstrate that failure would
be very useful. It&#39;s OK if the test crashes and burns, see
Test::More&#39;s docs for how to make TODO tests that fail now, but
shouldn&#39;t. Even if it segfaults perl C&lt;system $^X =&gt; qw/ -Mblib
-MYAML::Syck .../&gt; or something like that and checking the return
value will do.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-779489" href="/Public/Bug/Display.html?id=50227#txn-779489">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;20&nbsp;07:08:05&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-779490" href="/Public/Bug/Display.html?id=50227#txn-779490">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;20&nbsp;07:08:06&nbsp;2010</span>
    <span class="description">avar [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-804611" href="/Public/Bug/Display.html?id=50227#txn-804611">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;15&nbsp;15:14:53&nbsp;2010</span>
    <span class="description">TODDR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/804611/417090/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/417090">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 69b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is also on github. The specific commit to fix this is also here.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch.txt</td>
  </tr>
</table>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"></div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-804614" href="/Public/Bug/Display.html?id=50227#txn-804614">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;15&nbsp;15:14:54&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-804730" href="/Public/Bug/Display.html?id=50227#txn-804730">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;15&nbsp;19:32:12&nbsp;2010</span>
    <span class="description">TODDR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/804730/417153/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/417153">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 150b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Adding some tests revealed some problems. The patch2 now includes working tests. The 
updated check was with p5p&#39;s advice on IRC.

github is updated
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch2.txt</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/804730/417154/patch2.txt">Download patch2.txt</a><br />
<span class="downloadcontenttype">text/plain 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">commit 7b3e88cc9e42e630150ba0f9b9618a30fb7adf28
Author: Todd Rinaldo &lt;toddr@cpan.org&gt;
Date:   Thu Jul 15 14:12:00 2010 -0500

    RT 50227 - Not quoting strings when data has been sorted numerically before being passed to JSON::Syck::Dump
    
    Use the perl function looks_like_number to detect if it&#39;s a number, but only if the number isn&#39;t octal or hex since it&#39;ll convert it if you do that.

diff --git a/perl_syck.h b/perl_syck.h
index a798705..836157c 100644
--- a/perl_syck.h
+++ b/perl_syck.h
@@ -860,8 +860,8 @@ yaml_syck_emitter_handler
         /* emit an undef &#40;typically pointed from a blesed SvRV&#41; */
         syck_emit_scalar&#40;e, OBJOF&#40;&#34;str&#34;&#41;, scalar_plain, 0, 0, 0, NULL_LITERAL, NULL_LITERAL_LENGTH&#41;;
     }
-    else if &#40;SvNIOKp&#40;sv&#41; &#38;&#38; &#40;sv_len&#40;sv&#41; != 0&#41;&#41; {
-        /* emit a number with a stringified version */
+    else if &#40;looks_like_number&#40;sv&#41; &#38;&#38; &#40;sv_len&#40;sv&#41; &lt; 2 || SvPVX&#40;sv&#41;[0] != &#39;0&#39; || SvPVX&#40;sv&#41;[1] == &#39;.&#39;&#41;&#41; {
+      /* emit a number only if it looks like one and isn&#39;t octal or hex. We&#39;re treating octal/hex as strings */
         syck_emit_scalar&#40;e, OBJOF&#40;&#34;str&#34;&#41;, SCALAR_NUMBER, 0, 0, 0, SvPV_nolen&#40;sv&#41;, sv_len&#40;sv&#41;&#41;;
     }
     else if &#40;SvPOKp&#40;sv&#41;&#41; {
diff --git a/t/json-numbers.t b/t/json-numbers.t
new file mode 100644
index 0000000..582cd5c
--- /dev/null
+++ b/t/json-numbers.t
@@ -0,0 +1,19 @@
+use Test::More tests =&gt; 6;
+
+use JSON::Syck qw&#40;Dump&#41;;
+
+my @arr1 = sort {$a cmp $b} qw/1 2 54 howdy/;
+is&#40;Dump&#40;\@arr1&#41;, &#39;[1,2,54,&#34;howdy&#34;]&#39;, &#34;cmp sort doesn&#39;t coerce numbers into strings&#34;&#41;;
+
+{
+    no warnings &#34;numeric&#34;;
+    my @arr2 = sort {$a &lt;=&gt; $b} qw/1 2 54 howdy/;
+    is&#40;Dump&#40;\@arr2&#41;, &#39;[&#34;howdy&#34;,1,2,54]&#39;, &#34;Numeric sort doesn&#39;t coerce non-numeric strings into numbers&#34;&#41;;
+}
+
+my @arr54 = &#40;&#34;howdy&#34;,1,2,54&#41;;
+is&#40;Dump&#40;\@arr54&#41;, &#39;[&#34;howdy&#34;,1,2,54]&#39;, &#34;Strings are quoted. Numbers are not&#34;&#41;;
+
+is&#40;Dump&#40;&#39;042&#39;&#41;,    &#39;&#34;042&#34;&#39;, &#34;Ocatls don&#39;t get treated as numbers&#34;&#41;;
+is&#40;Dump&#40;&#39;0x42&#39;&#41;,    &#39;&#34;0x42&#34;&#39;, &#34;Hex doesn&#39;t get treated as a number&#34;&#41;;
+is&#40;Dump&#40;&#39;0.42&#39;&#41;,    &#39;0.42&#39;, &#34;Floats with leading 0 don&#39;t get excluded by octal check&#34;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-804801" href="/Public/Bug/Display.html?id=50227#txn-804801">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;15&nbsp;21:44:04&nbsp;2010</span>
    <span class="description">TODDR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/804801/417201/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/417201">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 186b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">More tests show perl will consider and convert scientific notation where it shouldn&#39;t. I had to 
take a more combined approach to fix this.

Patch 3 should do it. github is also updated.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch3.txt</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/804801/417202/patch3.txt">Download patch3.txt</a><br />
<span class="downloadcontenttype">text/plain 4.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">commit b33458fa0b17f690ab5c2c5f74ca3729a5614205
Author: Todd Rinaldo &lt;toddr@cpan.org&gt;
Date:   Thu Jul 15 14:12:00 2010 -0500

    RT 50227 - Not quoting strings when data has been sorted numerically before being passed to JSON::Syck::Dump
    
    Use the perl function looks_like_number to detect if it&#39;s a number.
    Then come behind and exclude hex/oct/scientific numbers with custom routine.
    The special numbers don&#39;t round trip properly.

diff --git a/perl_syck.h b/perl_syck.h
index a798705..48d64f7 100644
--- a/perl_syck.h
+++ b/perl_syck.h
@@ -860,8 +860,8 @@ yaml_syck_emitter_handler
         /* emit an undef &#40;typically pointed from a blesed SvRV&#41; */
         syck_emit_scalar&#40;e, OBJOF&#40;&#34;str&#34;&#41;, scalar_plain, 0, 0, 0, NULL_LITERAL, NULL_LITERAL_LENGTH&#41;;
     }
-    else if &#40;SvNIOKp&#40;sv&#41; &#38;&#38; &#40;sv_len&#40;sv&#41; != 0&#41;&#41; {
-        /* emit a number with a stringified version */
+    else if &#40;looks_like_number&#40;sv&#41; &#38;&#38; syck_is_a_number&#40;SvPV_nolen&#40;sv&#41;, sv_len&#40;sv&#41;&#41;&#41; {
+        /* emit a number only if it&#39;s [.0-9]+ and isn&#39;t octal or hex. We&#39;re treating octal/hex as strings */
         syck_emit_scalar&#40;e, OBJOF&#40;&#34;str&#34;&#41;, SCALAR_NUMBER, 0, 0, 0, SvPV_nolen&#40;sv&#41;, sv_len&#40;sv&#41;&#41;;
     }
     else if &#40;SvPOKp&#40;sv&#41;&#41; {
diff --git a/syck_.c b/syck_.c
index b5ce707..2793fb0 100644
--- a/syck_.c
+++ b/syck_.c
@@ -2,7 +2,7 @@
  * syck.c
  *
  * $Author: why $
- * $Date: 2005-01-01 10:06:25 +0800 &#40;六, 01  1 2005&#41; $
+ * $Date: 2005-01-01 10:06:25 +0800 &#40;.., 01  1 2005&#41; $
  *
  * Copyright &#40;C&#41; 2003 why the lucky stiff
  */
@@ -496,9 +496,34 @@ syck_parse&#40; SyckParser *p &#41;
 void
 syck_default_error_handler&#40; SyckParser *p, char *msg &#41;
 {
-    printf&#40; &#34;Error at [Line %d, Col %d]: %s\n&#34;, 
+    printf&#40; &#34;Error at [Line %d, Col %d]: %s\n&#34;,
         p-&gt;linect,
         p-&gt;cursor - p-&gt;lineptr,
         msg &#41;;
 }
 
+int syck_is_a_number&#40;char* str, long len&#41; {
+	int idx;
+	char seen_decimal = 0;
+	char c;
+
+	if&#40;!str&#41; return 0; /* Don&#39;t parse null strings */
+	if&#40;len &lt; 1&#41; return 0; /* empty strings can&#39;t be numbers */
+
+	/* Look for illegal characters */
+	for &#40; idx = 0; idx &lt; len; idx++ &#41; {
+		c = str[idx];
+
+		if&#40;c &gt; &#39;9&#39; || c &lt; &#39;.&#39; || c == &#39;/&#39; &#41;
+			return 0; /* Number can only have 0..9 and . */
+		if&#40;c == &#39;.&#39;&#41; {
+			if&#40;seen_decimal&#41; return 0; /* Numbers can&#39;t have 2 .&#39;s in them */
+			if&#40;idx == 0&#41; return 0; /* has to have a leading 0 at least for floats */
+			seen_decimal = 1;
+		}
+	}
+
+	if&#40;len &gt; 1 &#38;&#38; str[0] == &#39;0&#39; &#38;&#38; str[1] != &#39;.&#39;&#41; return 0; /* Trap hex/octal */
+
+	return 1;
+}
diff --git a/t/2-scalars.t b/t/2-scalars.t
index efb0741..69d797a 100644
--- a/t/2-scalars.t
+++ b/t/2-scalars.t
@@ -1,4 +1,4 @@
-use t::TestYAML tests =&gt; 81;
+use t::TestYAML tests =&gt; 88;
 
 local $SIG{__WARN__} = sub { 1 } if $Test::VERSION &lt; 1.20;
 
@@ -168,6 +168,14 @@ roundtrip&#40;&#34;\n&#34;&#41;;
 roundtrip&#40;&#34;S p a c e&#34;&#41;;
 roundtrip&#40;&#34;Space \n Around&#34;&#41;;
 
+roundtrip&#40;&#34;042&#34;&#41;;
+roundtrip&#40;&#34;0x42&#34;&#41;;
+roundtrip&#40;&#34;0.42&#34;&#41;;
+roundtrip&#40;&#34;.42&#34;&#41;;
+roundtrip&#40;&#34;1,000,000&#34;&#41;;
+roundtrip&#40;&#34;1e+6&#34;&#41;;
+roundtrip&#40;&#34;10e+6&#34;&#41;;
+
 # If implicit typing is on, quote strings corresponding to implicit boolean and null values
 $YAML::Syck::SingleQuote = 0;
 
diff --git a/t/json-numbers.t b/t/json-numbers.t
new file mode 100644
index 0000000..6d790e5
--- /dev/null
+++ b/t/json-numbers.t
@@ -0,0 +1,25 @@
+use Test::More tests =&gt; 10;
+
+use JSON::Syck qw&#40;Dump&#41;;
+
+my @arr1 = sort {$a cmp $b} qw/1 2 54 howdy/;
+is&#40;Dump&#40;\@arr1&#41;, &#39;[1,2,54,&#34;howdy&#34;]&#39;, &#34;cmp sort doesn&#39;t coerce numbers into strings&#34;&#41;;
+
+{
+    no warnings &#34;numeric&#34;;
+    my @arr2 = sort {$a &lt;=&gt; $b} qw/1 2 54 howdy/;
+    is&#40;Dump&#40;\@arr2&#41;, &#39;[&#34;howdy&#34;,1,2,54]&#39;, &#34;Numeric sort doesn&#39;t coerce non-numeric strings into numbers&#34;&#41;;
+}
+
+my @arr54 = &#40;&#34;howdy&#34;,1,2,54&#41;;
+is&#40;Dump&#40;\@arr54&#41;, &#39;[&#34;howdy&#34;,1,2,54]&#39;, &#34;Strings are quoted. Numbers are not&#34;&#41;;
+
+is&#40;Dump&#40;&#39;042&#39;&#41;,    &#39;&#34;042&#34;&#39;, &#34;Ocatls don&#39;t get treated as numbers&#34;&#41;;
+is&#40;Dump&#40;&#39;0x42&#39;&#41;,    &#39;&#34;0x42&#34;&#39;, &#34;Hex doesn&#39;t get treated as a number&#34;&#41;;
+is&#40;Dump&#40;&#39;0.42&#39;&#41;,    &#39;0.42&#39;, &#34;Floats with leading 0 don&#39;t get excluded by octal check&#34;&#41;;
+is&#40;Dump&#40;&#39;1_000_000&#39;&#41;,    &#39;&#34;1_000_000&#34;&#39;, &#34;numbers with underscores get quoted.&#34;&#41;;
+is&#40;Dump&#40;&#39;1,000,000&#39;&#41;,    &#39;&#34;1,000,000&#34;&#39;, &#34;numbers with commas get quoted.&#34;&#41;;
+is&#40;Dump&#40;&#39;1e+6&#39;&#41;,    &#39;&#34;1e+6&#34;&#39;, &#34;Scientific notation gets quoted.&#34;&#41;;
+is&#40;Dump&#40;&#39;10e+6&#39;&#41;,    &#39;&#34;10e+6&#34;&#39;, &#34;Scientific notation gets quoted.&#34;&#41;;
+
+
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-806263" href="/Public/Bug/Display.html?id=50227#txn-806263">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;19&nbsp;14:10:55&nbsp;2010</span>
    <span class="description">TODDR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/806263/418005/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/418005">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 59b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Further refinements were required. 1.10_02 pushed to pause.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-806266" href="/Public/Bug/Display.html?id=50227#txn-806266">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;19&nbsp;14:10:59&nbsp;2010</span>
    <span class="description">TODDR [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-806604" href="/Public/Bug/Display.html?id=50227#txn-806604">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;20&nbsp;00:16:11&nbsp;2010</span>
    <span class="description">TODDR [...] cpan.org -  Fixed in 1.10_02 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-806605" href="/Public/Bug/Display.html?id=50227#txn-806605">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;20&nbsp;00:16:15&nbsp;2010</span>
    <span class="description">TODDR [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.673801</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
