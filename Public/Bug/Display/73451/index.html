<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #73451 for Moose: Newval arg may be wrong in a trigger fired during _call_all_triggers.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #73451 for Moose: Newval arg may be wrong in a trigger fired during _call_all_triggers.</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Moose">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Moose">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Moose">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Moose">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Moose">Moose CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">73451</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Moose">Moose</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
TRLORENZ [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-38786-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.0200    </td>
  </tr>
  <tr id="CF-38787-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=73451">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1014403" href="/Public/Bug/Display.html?id=73451#txn-1014403">#</a>      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;22&nbsp;20:19:54&nbsp;2011</span>
    <span class="description">TRLORENZ [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Newval arg may be wrong in a trigger fired during _call_all_triggers.</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1014403/528895/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/528895">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">When a trigger is fired for an attribute during _call_all_triggers, if 
$attr-&gt;should_coerce is false, the trigger callback will receive as its 
newval arg whatever value was supplied to the constructor, even if the 
attribute value has since changed or been cleared.

This looks to me to have been a bug since at least as far back as 2.02, 
when _call_all_triggers was introduced.

=====

use Test::More;

# _SortedAttributes IS NEEDED FOR THIS TEST SO THAT TRIGGERS
# FIRE IN A PREDICTABLE ORDER DURING _call_all_triggers.
# &#40;&#34;X&#34; SORTS BEFORE &#34;Y&#34;.&#41;

BEGIN { package _SortedAttributes;

    use Moose;
        extends &#39;Moose::Meta::Class&#39;;

    around get_all_attributes =&gt; sub {

        my &#40;$orig_method, $self_aka_class&#41; = &#40;shift, shift&#41;;

        my @attributes = $self_aka_class-&gt;$orig_method&#40;@_&#41;;

        return sort&#40;{ $a-&gt;name cmp $b-&gt;name } @attributes&#41;;
    };
}

{ package MyClass;

    use Moose -metaclass =&gt; &#39;_SortedAttributes&#39;;

    our @NEWVALS;

    has X =&gt; &#40;

        is =&gt; &#39;rw&#39;,
        isa =&gt; &#39;Any&#39;,
        trigger =&gt; sub { shift-&gt;clear_Y },
    &#41;;

    has Y =&gt; &#40;

        is =&gt; &#39;rw&#39;,
        isa =&gt; &#39;Any&#39;,
        clearer =&gt; &#39;clear_Y&#39;,
        trigger =&gt; sub {

            my &#40;$self, $new, $old&#41; = &#40;shift, @_&#41;;

            push&#40;@NEWVALS,

                [defined&#40;$new&#41; ? $new : &#39;UNDEF&#39;],

                [exists&#40;$self-&gt;{Y}&#41; ? defined&#40;$self-&gt;{Y}&#41; ? $self-&gt;
{Y} : &#39;UNDEF&#39; : &#39;NOVAL&#39;],
            &#41;;
        },
    &#41;;
}

TODO: {

    local $TODO = &#39;bug demo&#39;;

    # X WILL FIRE, CLEARING Y; THEN Y WILL FIRE.

    my $obj = MyClass-&gt;new&#40;{X =&gt; &#39;X&#39;, Y =&gt; &#39;Y&#39;}&#41;;

    is_deeply&#40;$MyClass::NEWVALS[0], $MyClass::NEWVALS[1], &#39;newval arg 
equals actual current value&#39;&#41;;
}
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1039891" href="/Public/Bug/Display.html?id=73451#txn-1039891">#</a>      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;19&nbsp;18:16:53&nbsp;2012</span>
    <span class="description">DROLSKY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1039891/543045/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/543045">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Dec 22 20:19:54 2011, TRLORENZ wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; When a trigger is fired for an attribute during _call_all_triggers, if 
&gt; $attr-&gt;should_coerce is false, the trigger callback will receive as 
</div>its 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; newval arg whatever value was supplied to the constructor, even if the 
&gt; attribute value has since changed or been cleared.
&gt; 
&gt; This looks to me to have been a bug since at least as far back as 
</div>2.02, 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; when _call_all_triggers was introduced.
&gt; 
&gt; =====
&gt; 
&gt; use Test::More;
&gt; 
&gt; # _SortedAttributes IS NEEDED FOR THIS TEST SO THAT TRIGGERS
&gt; # FIRE IN A PREDICTABLE ORDER DURING _call_all_triggers.
&gt; # &#40;&#34;X&#34; SORTS BEFORE &#34;Y&#34;.&#41;
&gt; 
&gt; BEGIN { package _SortedAttributes;
&gt; 
&gt;     use Moose;
&gt;         extends &#39;Moose::Meta::Class&#39;;
&gt; 
&gt;     around get_all_attributes =&gt; sub {
&gt; 
&gt;         my &#40;$orig_method, $self_aka_class&#41; = &#40;shift, shift&#41;;
&gt; 
&gt;         my @attributes = $self_aka_class-&gt;$orig_method&#40;@_&#41;;
&gt; 
&gt;         return sort&#40;{ $a-&gt;name cmp $b-&gt;name } @attributes&#41;;
&gt;     };
&gt; }
&gt; 
&gt; { package MyClass;
&gt; 
&gt;     use Moose -metaclass =&gt; &#39;_SortedAttributes&#39;;
&gt; 
&gt;     our @NEWVALS;
&gt; 
&gt;     has X =&gt; &#40;
&gt; 
&gt;         is =&gt; &#39;rw&#39;,
&gt;         isa =&gt; &#39;Any&#39;,
&gt;         trigger =&gt; sub { shift-&gt;clear_Y },
&gt;     &#41;;
&gt; 
&gt;     has Y =&gt; &#40;
&gt; 
&gt;         is =&gt; &#39;rw&#39;,
&gt;         isa =&gt; &#39;Any&#39;,
&gt;         clearer =&gt; &#39;clear_Y&#39;,
&gt;         trigger =&gt; sub {
&gt; 
&gt;             my &#40;$self, $new, $old&#41; = &#40;shift, @_&#41;;
&gt; 
&gt;             push&#40;@NEWVALS,
&gt; 
&gt;                 [defined&#40;$new&#41; ? $new : &#39;UNDEF&#39;],
&gt; 
&gt;                 [exists&#40;$self-&gt;{Y}&#41; ? defined&#40;$self-&gt;{Y}&#41; ? $self-&gt;
&gt; {Y} : &#39;UNDEF&#39; : &#39;NOVAL&#39;],
&gt;             &#41;;
&gt;         },
&gt;     &#41;;
&gt; }
&gt; 
&gt; TODO: {
&gt; 
&gt;     local $TODO = &#39;bug demo&#39;;
&gt; 
&gt;     # X WILL FIRE, CLEARING Y; THEN Y WILL FIRE.
&gt; 
&gt;     my $obj = MyClass-&gt;new&#40;{X =&gt; &#39;X&#39;, Y =&gt; &#39;Y&#39;}&#41;;
&gt; 
&gt;     is_deeply&#40;$MyClass::NEWVALS[0], $MyClass::NEWVALS[1], &#39;newval arg 
&gt; equals actual current value&#39;&#41;;
&gt; }
</div>
I&#39;m finding this a little confusing. The bug report text talks about 
coercion, but the example code doesn&#39;t use coercion. What am I missing?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1039894" href="/Public/Bug/Display.html?id=73451#txn-1039894">#</a>      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;19&nbsp;18:16:54&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1040452" href="/Public/Bug/Display.html?id=73451#txn-1040452">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;20&nbsp;22:05:24&nbsp;2012</span>
    <span class="description">trlorenz [...] hotmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #73451] Newval arg may be wrong in a trigger fired during _call_all_triggers.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 20 Feb 2012 20:05:12 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-moose [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Todd Lorenz &lt;trlorenz [...] hotmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1040452/543329/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/543329">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
The bug only manifests when $attr-&gt;should_coerce is false &#40;which it would
be by default&#41;, and it only affects _call_all_triggers. I think it&#39;s really only a problem when a trigger clears or changes the
value of another triggered attribute during init. &#40;Which is maybe something
people shouldn&#39;t have their triggers doing, anyway... but, eh, it&#39;s bound
to happen.&#41; I didn&#39;t encounter this bug in the wild; I spotted it while writing
MooseX::OmniTrigger, going through Moose code. I&#39;ve since realized there&#39;s
another minor issue with _call_all_triggers, arising from that fact that it
avoids providing an oldval altogether: ** When a trigger is fired during _call_all_triggers for any preexisting
attribute of an object being reblessed, the trigger callback will receive
nothing &#40;an empty list&#41; for its oldval arg, even if at the start of the
rebless the attribute had a value. ** The newval bug is an easy fix. The oldval bug I think would require saving
the attribute&#39;s current value at the beginning of fixup to provide as the
oldval during _call_all_triggers, which means an additional little bit of
attribute state. &#40;In MooseX::OmniTrigger I used a fieldhash for this.&#41; Note: _inline_triggers suffers the oldval bug as well &#40;but no big deal so
long as there&#39;s no _inline_rebless&#41;. I&#39;ll gladly supply a patch if anyone can confirm these are in fact bugs &#40;by
Moose standards, I mean; I&#39;ve confirmed the behavior through testing&#41;. TRL
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt; Subject: [rt.cpan.org #73451] Newval arg may be wrong in a trigger fired during _call_all_triggers. 
&gt; From: bug-Moose@rt.cpan.org
&gt; To: TRLORENZ@cpan.org
&gt; Date: Sun, 19 Feb 2012 18:16:54 -0500
&gt; 
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73451">https://rt.cpan.org/Ticket/Display.html?id=73451</a></span> &gt;
&gt; 
&gt; On Thu Dec 22 20:19:54 2011, TRLORENZ wrote:
<div class="message-stanza open">&gt; &gt; When a trigger is fired for an attribute during _call_all_triggers, if 
&gt; &gt; $attr-&gt;should_coerce is false, the trigger callback will receive as 
</div>&gt; its 
<div class="message-stanza open">&gt; &gt; newval arg whatever value was supplied to the constructor, even if the 
&gt; &gt; attribute value has since changed or been cleared.
&gt; &gt; 
&gt; &gt; This looks to me to have been a bug since at least as far back as 
</div>&gt; 2.02, 
<div class="message-stanza open">&gt; &gt; when _call_all_triggers was introduced.
&gt; &gt; 
&gt; &gt; =====
&gt; &gt; 
&gt; &gt; use Test::More;
&gt; &gt; 
&gt; &gt; # _SortedAttributes IS NEEDED FOR THIS TEST SO THAT TRIGGERS
&gt; &gt; # FIRE IN A PREDICTABLE ORDER DURING _call_all_triggers.
&gt; &gt; # &#40;&#34;X&#34; SORTS BEFORE &#34;Y&#34;.&#41;
&gt; &gt; 
&gt; &gt; BEGIN { package _SortedAttributes;
&gt; &gt; 
&gt; &gt;     use Moose;
&gt; &gt;         extends &#39;Moose::Meta::Class&#39;;
&gt; &gt; 
&gt; &gt;     around get_all_attributes =&gt; sub {
&gt; &gt; 
&gt; &gt;         my &#40;$orig_method, $self_aka_class&#41; = &#40;shift, shift&#41;;
&gt; &gt; 
&gt; &gt;         my @attributes = $self_aka_class-&gt;$orig_method&#40;@_&#41;;
&gt; &gt; 
&gt; &gt;         return sort&#40;{ $a-&gt;name cmp $b-&gt;name } @attributes&#41;;
&gt; &gt;     };
&gt; &gt; }
&gt; &gt; 
&gt; &gt; { package MyClass;
&gt; &gt; 
&gt; &gt;     use Moose -metaclass =&gt; &#39;_SortedAttributes&#39;;
&gt; &gt; 
&gt; &gt;     our @NEWVALS;
&gt; &gt; 
&gt; &gt;     has X =&gt; &#40;
&gt; &gt; 
&gt; &gt;         is =&gt; &#39;rw&#39;,
&gt; &gt;         isa =&gt; &#39;Any&#39;,
&gt; &gt;         trigger =&gt; sub { shift-&gt;clear_Y },
&gt; &gt;     &#41;;
&gt; &gt; 
&gt; &gt;     has Y =&gt; &#40;
&gt; &gt; 
&gt; &gt;         is =&gt; &#39;rw&#39;,
&gt; &gt;         isa =&gt; &#39;Any&#39;,
&gt; &gt;         clearer =&gt; &#39;clear_Y&#39;,
&gt; &gt;         trigger =&gt; sub {
&gt; &gt; 
&gt; &gt;             my &#40;$self, $new, $old&#41; = &#40;shift, @_&#41;;
&gt; &gt; 
&gt; &gt;             push&#40;@NEWVALS,
&gt; &gt; 
&gt; &gt;                 [defined&#40;$new&#41; ? $new : &#39;UNDEF&#39;],
&gt; &gt; 
&gt; &gt;                 [exists&#40;$self-&gt;{Y}&#41; ? defined&#40;$self-&gt;{Y}&#41; ? $self-&gt;
&gt; &gt; {Y} : &#39;UNDEF&#39; : &#39;NOVAL&#39;],
&gt; &gt;             &#41;;
&gt; &gt;         },
&gt; &gt;     &#41;;
&gt; &gt; }
&gt; &gt; 
&gt; &gt; TODO: {
&gt; &gt; 
&gt; &gt;     local $TODO = &#39;bug demo&#39;;
&gt; &gt; 
&gt; &gt;     # X WILL FIRE, CLEARING Y; THEN Y WILL FIRE.
&gt; &gt; 
&gt; &gt;     my $obj = MyClass-&gt;new&#40;{X =&gt; &#39;X&#39;, Y =&gt; &#39;Y&#39;}&#41;;
&gt; &gt; 
&gt; &gt;     is_deeply&#40;$MyClass::NEWVALS[0], $MyClass::NEWVALS[1], &#39;newval arg 
&gt; &gt; equals actual current value&#39;&#41;;
&gt; &gt; }
</div>&gt; 
&gt; I&#39;m finding this a little confusing. The bug report text talks about 
&gt; coercion, but the example code doesn&#39;t use coercion. What am I missing?
&gt; 
</div>                                          
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1040452/543330/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/543330">with headers</a>
<br />
<span class="downloadcontenttype">text/html 4.9k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1040455" href="/Public/Bug/Display.html?id=73451#txn-1040455">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;20&nbsp;22:09:31&nbsp;2012</span>
    <span class="description">trlorenz [...] hotmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #73451] Newval arg may be wrong in a trigger fired during _call_all_triggers.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 20 Feb 2012 20:09:20 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-moose [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Todd Lorenz &lt;trlorenz [...] hotmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1040455/543334/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/543334">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Geez, that was originally nicely formatted. RT noob question: What am I doing wrong, here?&gt; Subject: RE: [rt.cpan.org #73451] Newval arg may be wrong in a trigger fired during _call_all_triggers.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; From: bug-Moose@rt.cpan.org
&gt; To: TRLORENZ@cpan.org
&gt; Date: Mon, 20 Feb 2012 22:05:26 -0500
&gt; 
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73451">https://rt.cpan.org/Ticket/Display.html?id=73451</a></span> &gt;
&gt; 
&gt; 
&gt; The bug only manifests when $attr-&gt;should_coerce is false &#40;which it would
&gt; be by default&#41;, and it only affects _call_all_triggers. I think it&#39;s really only a problem when a trigger clears or changes the
&gt; value of another triggered attribute during init. &#40;Which is maybe something
&gt; people shouldn&#39;t have their triggers doing, anyway... but, eh, it&#39;s bound
&gt; to happen.&#41; I didn&#39;t encounter this bug in the wild; I spotted it while writing
&gt; MooseX::OmniTrigger, going through Moose code. I&#39;ve since realized there&#39;s
&gt; another minor issue with _call_all_triggers, arising from that fact that it
&gt; avoids providing an oldval altogether: ** When a trigger is fired during _call_all_triggers for any preexisting
&gt; attribute of an object being reblessed, the trigger callback will receive
&gt; nothing &#40;an empty list&#41; for its oldval arg, even if at the start of the
&gt; rebless the attribute had a value. ** The newval bug is an easy fix. The oldval bug I think would require saving
&gt; the attribute&#39;s current value at the beginning of fixup to provide as the
&gt; oldval during _call_all_triggers, which means an additional little bit of
&gt; attribute state. &#40;In MooseX::OmniTrigger I used a fieldhash for this.&#41; Note: _inline_triggers suffers the oldval bug as well &#40;but no big deal so
&gt; long as there&#39;s no _inline_rebless&#41;. I&#39;ll gladly supply a patch if anyone can confirm these are in fact bugs &#40;by
&gt; Moose standards, I mean; I&#39;ve confirmed the behavior through testing&#41;. TRL
<div class="message-stanza open">&gt;  &gt; Subject: [rt.cpan.org #73451] Newval arg may be wrong in a trigger fired during _call_all_triggers. 
</div><div class="message-stanza open">&gt; &gt; From: bug-Moose@rt.cpan.org
&gt; &gt; To: TRLORENZ@cpan.org
&gt; &gt; Date: Sun, 19 Feb 2012 18:16:54 -0500
&gt; &gt; 
&gt; &gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73451">https://rt.cpan.org/Ticket/Display.html?id=73451</a></span> &gt;
&gt; &gt; 
&gt; &gt; On Thu Dec 22 20:19:54 2011, TRLORENZ wrote:
<div class="message-stanza open">&gt; &gt; &gt; When a trigger is fired for an attribute during _call_all_triggers, if 
&gt; &gt; &gt; $attr-&gt;should_coerce is false, the trigger callback will receive as 
</div>&gt; &gt; its 
<div class="message-stanza open">&gt; &gt; &gt; newval arg whatever value was supplied to the constructor, even if the 
&gt; &gt; &gt; attribute value has since changed or been cleared.
&gt; &gt; &gt; 
&gt; &gt; &gt; This looks to me to have been a bug since at least as far back as 
</div>&gt; &gt; 2.02, 
<div class="message-stanza open">&gt; &gt; &gt; when _call_all_triggers was introduced.
&gt; &gt; &gt; 
&gt; &gt; &gt; =====
&gt; &gt; &gt; 
&gt; &gt; &gt; use Test::More;
&gt; &gt; &gt; 
&gt; &gt; &gt; # _SortedAttributes IS NEEDED FOR THIS TEST SO THAT TRIGGERS
&gt; &gt; &gt; # FIRE IN A PREDICTABLE ORDER DURING _call_all_triggers.
&gt; &gt; &gt; # &#40;&#34;X&#34; SORTS BEFORE &#34;Y&#34;.&#41;
&gt; &gt; &gt; 
&gt; &gt; &gt; BEGIN { package _SortedAttributes;
&gt; &gt; &gt; 
&gt; &gt; &gt;     use Moose;
&gt; &gt; &gt;         extends &#39;Moose::Meta::Class&#39;;
&gt; &gt; &gt; 
&gt; &gt; &gt;     around get_all_attributes =&gt; sub {
&gt; &gt; &gt; 
&gt; &gt; &gt;         my &#40;$orig_method, $self_aka_class&#41; = &#40;shift, shift&#41;;
&gt; &gt; &gt; 
&gt; &gt; &gt;         my @attributes = $self_aka_class-&gt;$orig_method&#40;@_&#41;;
&gt; &gt; &gt; 
&gt; &gt; &gt;         return sort&#40;{ $a-&gt;name cmp $b-&gt;name } @attributes&#41;;
&gt; &gt; &gt;     };
&gt; &gt; &gt; }
&gt; &gt; &gt; 
&gt; &gt; &gt; { package MyClass;
&gt; &gt; &gt; 
&gt; &gt; &gt;     use Moose -metaclass =&gt; &#39;_SortedAttributes&#39;;
&gt; &gt; &gt; 
&gt; &gt; &gt;     our @NEWVALS;
&gt; &gt; &gt; 
&gt; &gt; &gt;     has X =&gt; &#40;
&gt; &gt; &gt; 
&gt; &gt; &gt;         is =&gt; &#39;rw&#39;,
&gt; &gt; &gt;         isa =&gt; &#39;Any&#39;,
&gt; &gt; &gt;         trigger =&gt; sub { shift-&gt;clear_Y },
&gt; &gt; &gt;     &#41;;
&gt; &gt; &gt; 
&gt; &gt; &gt;     has Y =&gt; &#40;
&gt; &gt; &gt; 
&gt; &gt; &gt;         is =&gt; &#39;rw&#39;,
&gt; &gt; &gt;         isa =&gt; &#39;Any&#39;,
&gt; &gt; &gt;         clearer =&gt; &#39;clear_Y&#39;,
&gt; &gt; &gt;         trigger =&gt; sub {
&gt; &gt; &gt; 
&gt; &gt; &gt;             my &#40;$self, $new, $old&#41; = &#40;shift, @_&#41;;
&gt; &gt; &gt; 
&gt; &gt; &gt;             push&#40;@NEWVALS,
&gt; &gt; &gt; 
&gt; &gt; &gt;                 [defined&#40;$new&#41; ? $new : &#39;UNDEF&#39;],
&gt; &gt; &gt; 
&gt; &gt; &gt;                 [exists&#40;$self-&gt;{Y}&#41; ? defined&#40;$self-&gt;{Y}&#41; ? $self-&gt;
&gt; &gt; &gt; {Y} : &#39;UNDEF&#39; : &#39;NOVAL&#39;],
&gt; &gt; &gt;             &#41;;
&gt; &gt; &gt;         },
&gt; &gt; &gt;     &#41;;
&gt; &gt; &gt; }
&gt; &gt; &gt; 
&gt; &gt; &gt; TODO: {
&gt; &gt; &gt; 
&gt; &gt; &gt;     local $TODO = &#39;bug demo&#39;;
&gt; &gt; &gt; 
&gt; &gt; &gt;     # X WILL FIRE, CLEARING Y; THEN Y WILL FIRE.
&gt; &gt; &gt; 
&gt; &gt; &gt;     my $obj = MyClass-&gt;new&#40;{X =&gt; &#39;X&#39;, Y =&gt; &#39;Y&#39;}&#41;;
&gt; &gt; &gt; 
&gt; &gt; &gt;     is_deeply&#40;$MyClass::NEWVALS[0], $MyClass::NEWVALS[1], &#39;newval arg 
&gt; &gt; &gt; equals actual current value&#39;&#41;;
&gt; &gt; &gt; }
</div>&gt; &gt; 
&gt; &gt; I&#39;m finding this a little confusing. The bug report text talks about 
&gt; &gt; coercion, but the example code doesn&#39;t use coercion. What am I missing?
&gt; &gt; 
</div>&gt;                                         
</div>                                          
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1040455/543335/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/543335">with headers</a>
<br />
<span class="downloadcontenttype">text/html 5.8k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1040465" href="/Public/Bug/Display.html?id=73451#txn-1040465">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;20&nbsp;22:48:02&nbsp;2012</span>
    <span class="description">autarch [...] urth.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #73451] Newval arg may be wrong in a trigger fired during _call_all_triggers.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 20 Feb 2012 21:47:53 -0600 &#40;CST&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> via RT &lt;bug-Moose [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dave Rolsky &lt;autarch [...] urth.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1040465/543341/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/543341">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 538b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, 20 Feb 2012,  via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Geez, that was originally nicely formatted. RT noob question: What am I doing wrong, here?
</div>
Not really sure. My experience is that it formats reasonably well when I 
use the web interface. It may not handle mail from some clients all that 
well.


-dave

/*============================================================
<span class="clickylink"><a target="new" rel="nofollow" href="http://VegGuide.org">http://VegGuide.org</a></span>               <span class="clickylink"><a target="new" rel="nofollow" href="http://blog.urth.org">http://blog.urth.org</a></span>
Your guide to all that&#39;s veg      House Absolute&#40;ly Pointless&#41;
============================================================*/
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.397614</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
