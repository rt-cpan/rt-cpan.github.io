<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #29985 for Net-SCP: PATCH: clean up OO, other fixes</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #29985 for Net-SCP: PATCH: clean up OO, other fixes</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-SCP/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-SCP/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-SCP/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-SCP/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-SCP">Net-SCP CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">29985</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-SCP/Active/">Net-SCP</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
juice [...] lerch.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-23124-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.04    </td>
  </tr>
  <tr id="CF-23125-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;14&nbsp;13:48:19&nbsp;2007</span>
    <span class="description">ivan-pause [...] 420.am -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> PATCH: clean up OO, other fixes</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m believe I made it a little more robust.  For instance, when the
remote server was down/not response/refusing connections, $? is not
set leaving you think everything succeed until you looked for the file
you requested.  Now those type of warnings/errors are stored in
warnstr&#40;&#41;.

Here&#39;s an example script of how you&#39;d look for some of those warnings:

print &#34;connecting to $host as user $user\n&#34;;
my $scp = Net::SCP-&gt;new&#40; { &#39;host&#39; =&gt; $host,
                           &#39;user&#39; =&gt; $user,
                         }
&#41;;
print &#34;attempting to get file $file\n&#34;;
unless &#40;$scp-&gt;get&#40;$file,$dest&#41;&#41; {
  print &#39;SCP failed! &#39;,$scp-&gt;errstr&#40;&#41;,&#34;\n&#34;;
  exit&#40;0&#41;;
}

unless &#40;-e $dest&#41; {
  print &#39;why no file? &#39;,$scp-&gt;warnstr&#40;&#41;,&#34;\n&#34;;
}

exit&#40;1&#41;;

===================================================================
When you do a put, that&#39;s when it would be nice to see size&#40;&#41; work
so you could run a similar test.

Some of the tests I ran included when the file did not exist on the
remote server, when the remote server was down, when the file did
not exist on the local server and when the remote server required
a password doing both put &#38; gets.  I guess I
should scripted it all up.

Here&#39;s the list of my changes and a couple of comments:

- changes all interact to interactive to match the documentation.
  now when I instantiate an object and set &#39;interactive&#39;, all
  the code recognizes it.
- within the get method, called scp&#40;&#41; with $self-&gt;scp&#40;&#41;.
  this helped with getting back error messages and also
  gave it the ability to see the &#39;interactive&#39; flag
  on the object.  this is assuming get&#40;&#41; isn&#39;t suppose
  to be used in the procedural interface.
- within the put method, called scp&#40;&#41; with $self-&gt;scp&#40;&#41;.
- added method errstr for cleaner access to that member variable.
  maybe not the best name.
- added method warnstr.  if you cannot connect to the remote
  host it does not set $!, but there is a message in ERRFH.
  maybe not the best name.
- grabbed what was in the ERRFH and saved it off.  then used it as an
  addition check at the if &#40; $? &#41; statement.  it catches warnings
  warnings like &#34;warning: Executing scp1 compatibility.&#34; when the
  overall procedure was a success.
- removed $scp as a global.
- in SYNOPSIS, it mentions a quit method that does not exist.
- Net::SCP-&gt;size&#40;&#41; doesn&#39;t work
- it would be nice to be able to get error messages back when using
  procedural interface.

I&#39;ll probably look into why size&#40;&#41; isn&#39;t working because that would
be a nice to have to verify puts.

Just so you know, I&#39;m running Linux 2.2.16, OpenSSH 2 and
Perl 5.005_03.

I hope this is helpful.

Justin
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> SCP.diff</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- /home/jbedard/downloads/docs/work/comcast/downloads/Net-SCP-0.04/SCP.pm	Thu Feb 22 02:43:17 2001
+++ SCP.pm	Wed Jun  6 18:16:05 2001
@@ -1,7 +1,7 @@
 package Net::SCP;
 
 use strict;
-use vars qw&#40;$VERSION @ISA @EXPORT_OK $scp&#41;;
+use vars qw&#40;$VERSION @ISA @EXPORT_OK&#41;;
 use Exporter;
 use Carp;
 use File::Basename;
@@ -14,8 +14,6 @@
 @EXPORT_OK = qw&#40; scp iscp &#41;;
 $VERSION = &#39;0.04&#39;;
 
-$scp = &#34;scp&#34;;
-
 =head1 NAME
 
 Net::SCP - Perl extension for secure copy protocol
@@ -68,36 +66,46 @@
 =cut
 
 sub scp {
-  my $self = ref&#40;$_[0]&#41; ? shift : {};
-  my&#40;$src, $dest, $interact&#41; = @_;
+  my $self = ref&#40;$_[0]&#41; ? shift : Net::SCP-&gt;new&#40;&#41;;
+  my&#40;$src, $dest, $interactive&#41; = @_;
+  my $scp = &#39;scp&#39;;
+  # reset in case you do a size&#40;&#41; then scp&#40;&#41; or something like that.
+  # you should check these after each call to one of these methods.
+  $self-&gt;errstr&#40;undef&#41;;
+  $self-&gt;warnstr&#40;undef&#41;;
+
   my $flags = &#39;-p&#39;;
   $flags .= &#39;r&#39; unless &#38;_islocal&#40;$src&#41; &#38;&#38; ! -d $src;
   my @cmd;
-  if &#40; &#40; defined&#40;$interact&#41; &#38;&#38; $interact &#41;
-       || &#40; defined&#40;$self-&gt;{interact}&#41; &#38;&#38; $self-&gt;{interact} &#41; &#41; {
+  if &#40; &#40; defined&#40;$interactive&#41; &#38;&#38; $interactive &#41;
+       || &#40; defined&#40;$self-&gt;{&#39;interactive&#39;}&#41; &#38;&#38; $self-&gt;{&#39;interactive&#39;} &#41; &#41; {
     @cmd = &#40; $scp, $flags, $src, $dest &#41;;
     print join&#40;&#39; &#39;, @cmd&#41;, &#34;\n&#34;;
     unless &#40; &#38;_yesno &#41; {
-      $self-&gt;{errstr} = &#34;User declined&#34;;
+      $self-&gt;errstr&#40;&#39;User declined&#39;&#41;;
       return 0;
     }
   } else {
     $flags .= &#39;qB&#39;;
     @cmd = &#40; $scp, $flags, $src, $dest &#41;;
   }
+
   my&#40;$reader, $writer, $error &#41; =
     &#40; new IO::Handle, new IO::Handle, new IO::Handle &#41;;
   $writer-&gt;autoflush&#40;1&#41;;#  $error-&gt;autoflush&#40;1&#41;;
   my $pid = open3&#40;$writer, $reader, $error, @cmd &#41;;
+  my $errstr = join&#40;&#39;&#39;,&lt;$error&gt;&#41;;
+  chomp&#40;$errstr&#41;;
+
   waitpid $pid, 0;
+
   if &#40; $? &gt;&gt; 8 &#41; {
-    my $errstr = join&#40;&#39;&#39;, &lt;$error&gt;&#41;;
-    #chomp&#40;my $errstr = &lt;$error&gt;&#41;;
-    $self-&gt;{errstr} = $errstr;
-    0;
-  } else {
-    1;
+    $self-&gt;errstr&#40;$errstr&#41;;
+    return 0;
+  } elsif &#40; $errstr &#41; {
+    $self-&gt;warnstr&#40;$errstr&#41;;
   }
+  return 1;
 }
 
 =item iscp SOURCE, DESTINATION
@@ -115,7 +123,7 @@
 sub iscp {
   if &#40; ref&#40;$_[0]&#41; &#41; {
     my $self = shift;
-    $self-&gt;{&#39;interact&#39;} = 1;
+    $self-&gt;{&#39;interactive&#39;} = 1;
     $self-&gt;scp&#40;@_&#41;;
   } else {
     scp&#40;@_, 1&#41;;
@@ -158,6 +166,7 @@
   if &#40; ref&#40;$_[0]&#41; &#41; {
     $self = shift;
   } else {
+
     $self = {
               &#39;host&#39;        =&gt; shift,
               &#39;user&#39;        =&gt; &#40; scalar&#40;@_&#41; ? shift : &#39;&#39; &#41;,
@@ -179,6 +188,33 @@
   $self-&gt;{&#39;user&#39;} = $user if $user;
 }
 
+=item errstr [MESSAGE]
+
+get/set for error messages.
+
+=cut
+
+sub errstr {
+  my&#40;$self,$err&#41; = @_;
+  $self-&gt;{&#39;errstr&#39;} = $err if $err;
+  return $self-&gt;{&#39;errstr&#39;};
+}
+
+=item warnstr [ MESSAGE ]
+
+Exactly like errstr&#40;&#41; but should be used for lower 
+level warnings like: &#34;warning: Executing scp1 compatibility.&#34;
+Also, when connections are refused, $? is never set, so you 
+can see &#34;Secure connection to localhost refused.&#34; in warnstr&#40;&#41;.
+
+=cut
+
+sub warnstr {
+  my&#40;$self,$err&#41; = @_;
+  $self-&gt;{&#39;warnstr&#39;} = $err if $err;
+  return $self-&gt;{&#39;warnstr&#39;};
+}
+
 =item cwd CWD
 
 Sets the cwd &#40;used for a subsequent get or put request without a full pathname&#41;.
@@ -203,7 +239,7 @@
   $local ||= basename&#40;$remote&#41;;
   my $source = $self-&gt;{&#39;host&#39;}. &#34;:$remote&#34;;
   $source = $self-&gt;{&#39;user&#39;}. &#39;@&#39;. $source if $self-&gt;{&#39;user&#39;};
-  scp&#40;$source,$local&#41;;
+  $self-&gt;scp&#40;$source,$local&#41;;
 }
 
 =item size FILE
@@ -220,6 +256,10 @@
 
 sub size {
   my&#40;$self, $file&#41; = @_;
+  # reset in case you do a size&#40;&#41; then scp&#40;&#41; or something like that.
+  # you should check these after each call to one of these methods.
+  $self-&gt;errstr&#40;undef&#41;;
+
   $file = $self-&gt;{&#39;cwd&#39;}. &#34;/$file&#34; if $self-&gt;{&#39;cwd&#39;} &#38;&#38; $file !~ /^\//;
   my $host = $self-&gt;{&#39;host&#39;};
   $host = $self-&gt;{&#39;user&#39;}. &#39;@&#39;. $host if $self-&gt;{&#39;user&#39;};
@@ -230,16 +270,17 @@
   my $pid =
     sshopen3&#40;$host, $writer, $reader, $error, &#39;wc&#39;, &#39;-c &#39;, shell_quote&#40;$file&#41; &#41;;
   waitpid $pid, 0;
-  if &#40; $? &gt;&gt; 8 &#41; {
-    chomp&#40;my $errstr = &lt;$error&gt;&#41;;
-    $self-&gt;{errstr} = $errstr || &#34;wc exited with status &#34;. $?&gt;&gt;8;
+  
+  chomp&#40;my $errstr = &lt;$error&gt;&#41;;
+  if &#40; $? &gt;&gt; 8 || $errstr &#41; {
+    $self-&gt;errstr&#40;$errstr || &#34;wc exited with status &#34;. $?&gt;&gt;8&#41;;
     0;
   } else {
     chomp&#40; my $size = &lt;$reader&gt; || 0 &#41;;
     if &#40; $size =~ /^\s*&#40;\d+&#41;/ &#41; {
       $1 ? $1 : &#39;0e0&#39;;
     } else {
-      $self-&gt;{errstr} = &#34;unparsable output from remote wc: $size&#34;;
+      $self-&gt;errstr&#40;&#34;unparsable output from remote wc: $size&#34;&#41;;
       0;
     }
   }
@@ -259,7 +300,7 @@
   my $dest = $self-&gt;{&#39;host&#39;}. &#34;:$remote&#34;;
   $dest = $self-&gt;{&#39;user&#39;}. &#39;@&#39;. $dest if $self-&gt;{&#39;user&#39;};
   warn &#34;scp $local $dest\n&#34;;
-  scp&#40;$local, $dest&#41;;
+  $self-&gt;scp&#40;$local, $dest&#41;;
 }
 
 =item binary
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
