<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #29772 for ORM: After find_or_new, update fails when there is a timestamp field.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #29772 for ORM: After find_or_new, update fails when there is a timestamp field.</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/ORM/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/ORM/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/ORM/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/ORM/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/ORM">ORM CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">29772</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/ORM/Active/">ORM</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
colin.fine [...] pacemicro.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-24330-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.83    </td>
  </tr>
  <tr id="CF-24331-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;04&nbsp;10:58:18&nbsp;2007</span>
    <span class="description">colin.fine [...] pace.co.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> After find_or_new, update fails when there is a timestamp field.</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">With a Database table that contains a &#39;timestamp&#39; field, if I use
find_or_new to create a new object and record, then update it, the
update fails.

&#34;ORM::Db::DBI::MySQL-&gt;ORM::Db::DBI::update_object_part&#40;&#41;: Failed to
update object with id#7 of class &#39;Test::Data&#39;, 0 rows affected, may be
object was updated elsewhere.&#34;

I think this is because the find_or_new has not realised that the
&#39;timestamp&#39; field has been automatically set in the database, so the
following update, which specifies the field as empty, does not match any
rows. 

I thought this might be a consequence of using lazy_load, but I&#39;ve tried
it with lazy_load both on and off, and it doesn&#39;t make any difference. 

The workround seems to be to call an explicit &#39;refresh&#39; after the
&#39;find_or_new&#39;, but you don&#39;t need this when there isn&#39;t a timestamp.

I suspect the fix is to exclude any timestamp fields from the match in
&#39;update&#39; unless the calling code has specifically set them; but I don&#39;t
know if this is too general and would have other repercussions. 

perl 5.8.5
Fedora Core 3
MySQL 4.1.22-standard

Attached:
ormtest.sql - defines the database
testorm.tar.gz - the cgi and pm files.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> testorm.tar.gz</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> testorm.sql</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;07&nbsp;18:45:02&nbsp;2007</span>
    <span class="description">a.v.akimov [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #29772] After find_or_new, update fails when there is a timestamp field.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 08 Oct 2007 02:44:15 +0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-ORM [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Alexey Akimov&#34; &lt;a.v.akimov [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Colin,

Thanks for the report.
As you correctly supposed the problem is that ORM does
not know the faсt that server changes proposed value
for &#39;when&#39; field.

There are 2 ways to deal with this:

1. Workaround: make ORM set values for timestamp fields.
It assumes you add following into Test/Data.pm or to Tets/ORM.pm.
In latter case you define common behaviour for &#39;when&#39; fields in
any orm-class in your hierarchy.

   sub new
   {
       my $class   = shift;
       my %arg     = @_;
       my $prop    = $arg{prop};

       if&#40; $class-&gt;_has_prop&#40; &#39;when&#39; &#41; &#38;&#38; !$prop-&gt;{when} &#41;
       {
           $prop  = {};
           %$prop = %{$arg{prop}};
           $prop-&gt;{when} = time;
       }

       $class-&gt;SUPER::new
       &#40;
           prop      =&gt; $prop,
           error     =&gt; $arg{error},
           temporary =&gt; $arg{temporary},
           suspended =&gt; $arg{suspended},
           history   =&gt; $arg{history},
       &#41;;
   }

If you need timestamp field to be updated on every update
then you can handle it similar way using _validate_prop&#40;&#41; method.

2. Fix: implement lazy_load on per field basis &#40;last line in TODO.txt&#41;
In that case it will be possible to make timestamp field
permanently &#39;lazy&#39; and never count on its value during updates.

Unfortunately since i changed my job and switched to
development using python, i don&#39;t have enought time to develop
the project alone, so i can&#39;t give you estimate on when
described fix will come to life, but if you interested
in it i am appreciate any cooperation.

On Thu, 04 Oct 2007 18:58:26 +0400, Colin Fine via RT  
&lt;bug-ORM@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; Thu Oct 04 10:58:18 2007: Request 29772 was acted upon.
&gt; Transaction: Ticket created by COLINFINE
&gt;        Queue: ORM
&gt;      Subject: After find_or_new, update fails when there is a timestamp  
&gt; field.
&gt;    Broken in: 0.83
&gt;     Severity: Normal
&gt;        Owner: Nobody
&gt;   Requestors: colin.fine@pacemicro.com
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=29772">http://rt.cpan.org/Ticket/Display.html?id=29772</a></span> &gt;
&gt;
&gt;
&gt; With a Database table that contains a &#39;timestamp&#39; field, if I use
&gt; find_or_new to create a new object and record, then update it, the
&gt; update fails.
&gt;
&gt; &#34;ORM::Db::DBI::MySQL-&gt;ORM::Db::DBI::update_object_part&#40;&#41;: Failed to
&gt; update object with id#7 of class &#39;Test::Data&#39;, 0 rows affected, may be
&gt; object was updated elsewhere.&#34;
&gt;
&gt; I think this is because the find_or_new has not realised that the
&gt; &#39;timestamp&#39; field has been automatically set in the database, so the
&gt; following update, which specifies the field as empty, does not match any
&gt; rows.
&gt;
&gt; I thought this might be a consequence of using lazy_load, but I&#39;ve tried
&gt; it with lazy_load both on and off, and it doesn&#39;t make any difference.
&gt;
&gt; The workround seems to be to call an explicit &#39;refresh&#39; after the
&gt; &#39;find_or_new&#39;, but you don&#39;t need this when there isn&#39;t a timestamp.
&gt;
&gt; I suspect the fix is to exclude any timestamp fields from the match in
&gt; &#39;update&#39; unless the calling code has specifically set them; but I don&#39;t
&gt; know if this is too general and would have other repercussions.
&gt;
&gt; perl 5.8.5
&gt; Fedora Core 3
&gt; MySQL 4.1.22-standard
&gt;
&gt; Attached:
&gt; ormtest.sql - defines the database
&gt; testorm.tar.gz - the cgi and pm files.
&gt;
&gt;
&gt;
</div>


-- 
Best regards, Alexey Akimov
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;07&nbsp;18:45:03&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;08&nbsp;09:09:17&nbsp;2007</span>
    <span class="description">colin.fine [...] pacemicro.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> RE: [rt.cpan.org #29772] After find_or_new, update fails when there is a timestamp field.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 8 Oct 2007 14:08:13 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &lt;bug-ORM [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Colin Fine&#34; &lt;colin.fine [...] pacemicro.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Алексей, 
спасибо за скорым ответом.

Я понимаю же работаете теперь на других делах. 

Я хотел использовать какая нибудь система ОРМа, но я не уверен, если 
достаточно завершена ваша система для использования в торговой компание.
Это трудно, ей использовать с незавершенной документации. Я часто зашел 
проблемы, которые я не мог понимать без осматривать код.

А если бы у меня время для сотруничания с вами, мне кажется же трудно 
понимать и сотрудничать на системе без полной документация.

Colin




<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Colin Fine
&gt; Engineering Tools Group
&gt; Pace Micro Technology plc
&gt; Bringing Technology Home
&gt; 
&gt; 
&gt; Tel:    +44 1274 538038
&gt; Fax:   +44 1274 532029
&gt; Victoria Road, Saltaire, West Yorkshire. BD18 3LF   www.pacemicro.com 
&gt; 
</div>This E-mail and any attachments hereto are strictly confidential and intended solely for the addressee. If you are not the intended addressee please notify the sender by return and delete the message. You must not disclose, forward or copy this E-mail or attachments to any third party without the prior consent of the sender.  Pace Micro Technology plc &#40;registered in England and Wales no. 1672847&#41; whose head office is based at Victoria Road, Saltaire, West Yorkshire, BD18 3LF, UK. Tel +44 &#40;0&#41; 1274 532000 Fax +44 &#40;0&#41; 1274 532010 and at <span class="clickylink"><a target="new" rel="nofollow" href="http://www.pacemicro.com">http://www.pacemicro.com</a></span>.




<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Alexey Akimov via RT [mailto:bug-ORM@rt.cpan.org]
Sent: 07 October 2007 23:45
To: Colin Fine
Subject: Re: [rt.cpan.org #29772] After find_or_new, update fails when
there is a timestamp field.



&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=29772">http://rt.cpan.org/Ticket/Display.html?id=29772</a></span> &gt;

Hi Colin,

Thanks for the report.
As you correctly supposed the problem is that ORM does
not know the faсt that server changes proposed value
for &#39;when&#39; field.

There are 2 ways to deal with this:

1. Workaround: make ORM set values for timestamp fields.
It assumes you add following into Test/Data.pm or to Tets/ORM.pm.
In latter case you define common behaviour for &#39;when&#39; fields in
any orm-class in your hierarchy.

   sub new
   {
       my $class   = shift;
       my %arg     = @_;
       my $prop    = $arg{prop};

       if&#40; $class-&gt;_has_prop&#40; &#39;when&#39; &#41; &#38;&#38; !$prop-&gt;{when} &#41;
       {
           $prop  = {};
           %$prop = %{$arg{prop}};
           $prop-&gt;{when} = time;
       }

       $class-&gt;SUPER::new
       &#40;
           prop      =&gt; $prop,
           error     =&gt; $arg{error},
           temporary =&gt; $arg{temporary},
           suspended =&gt; $arg{suspended},
           history   =&gt; $arg{history},
       &#41;;
   }

If you need timestamp field to be updated on every update
then you can handle it similar way using _validate_prop&#40;&#41; method.

2. Fix: implement lazy_load on per field basis &#40;last line in TODO.txt&#41;
In that case it will be possible to make timestamp field
permanently &#39;lazy&#39; and never count on its value during updates.

Unfortunately since i changed my job and switched to
development using python, i don&#39;t have enought time to develop
the project alone, so i can&#39;t give you estimate on when
described fix will come to life, but if you interested
in it i am appreciate any cooperation.

On Thu, 04 Oct 2007 18:58:26 +0400, Colin Fine via RT  
&lt;bug-ORM@rt.cpan.org&gt; wrote:

<div class="message-stanza open">&gt;
&gt; Thu Oct 04 10:58:18 2007: Request 29772 was acted upon.
&gt; Transaction: Ticket created by COLINFINE
&gt;        Queue: ORM
&gt;      Subject: After find_or_new, update fails when there is a timestamp  
&gt; field.
&gt;    Broken in: 0.83
&gt;     Severity: Normal
&gt;        Owner: Nobody
&gt;   Requestors: colin.fine@pacemicro.com
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=29772">http://rt.cpan.org/Ticket/Display.html?id=29772</a></span> &gt;
&gt;
&gt;
&gt; With a Database table that contains a &#39;timestamp&#39; field, if I use
&gt; find_or_new to create a new object and record, then update it, the
&gt; update fails.
&gt;
&gt; &#34;ORM::Db::DBI::MySQL-&gt;ORM::Db::DBI::update_object_part&#40;&#41;: Failed to
&gt; update object with id#7 of class &#39;Test::Data&#39;, 0 rows affected, may be
&gt; object was updated elsewhere.&#34;
&gt;
&gt; I think this is because the find_or_new has not realised that the
&gt; &#39;timestamp&#39; field has been automatically set in the database, so the
&gt; following update, which specifies the field as empty, does not match any
&gt; rows.
&gt;
&gt; I thought this might be a consequence of using lazy_load, but I&#39;ve tried
&gt; it with lazy_load both on and off, and it doesn&#39;t make any difference.
&gt;
&gt; The workround seems to be to call an explicit &#39;refresh&#39; after the
&gt; &#39;find_or_new&#39;, but you don&#39;t need this when there isn&#39;t a timestamp.
&gt;
&gt; I suspect the fix is to exclude any timestamp fields from the match in
&gt; &#39;update&#39; unless the calling code has specifically set them; but I don&#39;t
&gt; know if this is too general and would have other repercussions.
&gt;
&gt; perl 5.8.5
&gt; Fedora Core 3
&gt; MySQL 4.1.22-standard
&gt;
&gt; Attached:
&gt; ormtest.sql - defines the database
&gt; testorm.tar.gz - the cgi and pm files.
&gt;
&gt;
&gt;
</div>


-- 
Best regards, Alexey Akimov



 Click <span class="clickylink"><a target="new" rel="nofollow" href="https://www.mailcontrol.com/sr/wQw0zmjPoHdJTZGyOCrrhg==">https://www.mailcontrol.com/sr/wQw0zmjPoHdJTZGyOCrrhg==</a></span>  to report this email as spam.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;10&nbsp;18:57:15&nbsp;2007</span>
    <span class="description">a.v.akimov [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #29772] After find_or_new, update fails when there is a timestamp field.</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 11 Oct 2007 02:56:44 +0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-ORM [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Akimov Alexey&#34; &lt;a.v.akimov [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Colin,

Your Russian is very nice!

PerlORM is pretty stable, mature and it is still used in production environment
at my previous ISP job. However the major PerlORM draw back is lack of
active community e.g. compared to DBIx.

Anyway I will be grateful if you point me what is missing in the docs.
Updating the docs won&#39;t take too much of my time but might be useful
to other people.

All the best wishes to you!

On 10/8/07, Colin Fine via RT &lt;bug-ORM@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt;        Queue: ORM
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=29772">http://rt.cpan.org/Ticket/Display.html?id=29772</a></span> &gt;
&gt;
&gt; Алексей,
&gt;
&gt; спасибо за скорым ответом.
&gt;
&gt;
&gt;
&gt; Я понимаю же работаете теперь на других делах.
&gt;
&gt;
&gt;
&gt; Я хотел использовать какая нибудь система ОРМа, но я не уверен, если
&gt;
&gt; достаточно завершена ваша система для использования в торговой компание.
&gt;
&gt; Это трудно, ей использовать с незавершенной документации. Я часто зашел
&gt;
&gt; проблемы, которые я не мог понимать без осматривать код.
&gt;
&gt;
&gt;
&gt; А если бы у меня время для сотруничания с вами, мне кажется же трудно
&gt;
&gt; понимать и сотрудничать на системе без полной документация.
&gt;
&gt;
&gt;
&gt; Colin
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
<div class="message-stanza open">&gt; &gt; Colin Fine
</div>&gt;
<div class="message-stanza open">&gt; &gt; Engineering Tools Group
</div>&gt;
<div class="message-stanza open">&gt; &gt; Pace Micro Technology plc
</div>&gt;
<div class="message-stanza open">&gt; &gt; Bringing Technology Home
</div>&gt;
<div class="message-stanza open">&gt; &gt;
</div>&gt;
<div class="message-stanza open">&gt; &gt;
</div>&gt;
<div class="message-stanza open">&gt; &gt; Tel:    +44 1274 538038
</div>&gt;
<div class="message-stanza open">&gt; &gt; Fax:   +44 1274 532029
</div>&gt;
<div class="message-stanza open">&gt; &gt; Victoria Road, Saltaire, West Yorkshire. BD18 3LF   www.pacemicro.com
</div>&gt;
<div class="message-stanza open">&gt; &gt;
</div>&gt;
&gt; This E-mail and any attachments hereto are strictly confidential and intended solely for the addressee. If you are not the intended addressee please notify the sender by return and delete the message. You must not disclose, forward or copy this E-mail or attachments to any third party without the prior consent of the sender.  Pace Micro Technology plc &#40;registered in England and Wales no. 1672847&#41; whose head office is based at Victoria Road, Saltaire, West Yorkshire, BD18 3LF, UK. Tel +44 &#40;0&#41; 1274 532000 Fax +44 &#40;0&#41; 1274 532010 and at <span class="clickylink"><a target="new" rel="nofollow" href="http://www.pacemicro.com">http://www.pacemicro.com</a></span>.
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt; -----Original Message-----
&gt;
&gt; From: Alexey Akimov via RT [mailto:bug-ORM@rt.cpan.org]
&gt;
&gt; Sent: 07 October 2007 23:45
&gt;
&gt; To: Colin Fine
&gt;
&gt; Subject: Re: [rt.cpan.org #29772] After find_or_new, update fails when
&gt;
&gt; there is a timestamp field.
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=29772">http://rt.cpan.org/Ticket/Display.html?id=29772</a></span> &gt;
&gt;
&gt;
&gt;
&gt; Hi Colin,
&gt;
&gt;
&gt;
&gt; Thanks for the report.
&gt;
&gt; As you correctly supposed the problem is that ORM does
&gt;
&gt; not know the faсt that server changes proposed value
&gt;
&gt; for &#39;when&#39; field.
&gt;
&gt;
&gt;
&gt; There are 2 ways to deal with this:
&gt;
&gt;
&gt;
&gt; 1. Workaround: make ORM set values for timestamp fields.
&gt;
&gt; It assumes you add following into Test/Data.pm or to Tets/ORM.pm.
&gt;
&gt; In latter case you define common behaviour for &#39;when&#39; fields in
&gt;
&gt; any orm-class in your hierarchy.
&gt;
&gt;
&gt;
&gt;    sub new
&gt;
&gt;    {
&gt;
&gt;        my $class   = shift;
&gt;
&gt;        my %arg     = @_;
&gt;
&gt;        my $prop    = $arg{prop};
&gt;
&gt;
&gt;
&gt;        if&#40; $class-&gt;_has_prop&#40; &#39;when&#39; &#41; &#38;&#38; !$prop-&gt;{when} &#41;
&gt;
&gt;        {
&gt;
&gt;            $prop  = {};
&gt;
&gt;            %$prop = %{$arg{prop}};
&gt;
&gt;            $prop-&gt;{when} = time;
&gt;
&gt;        }
&gt;
&gt;
&gt;
&gt;        $class-&gt;SUPER::new
&gt;
&gt;        &#40;
&gt;
&gt;            prop      =&gt; $prop,
&gt;
&gt;            error     =&gt; $arg{error},
&gt;
&gt;            temporary =&gt; $arg{temporary},
&gt;
&gt;            suspended =&gt; $arg{suspended},
&gt;
&gt;            history   =&gt; $arg{history},
&gt;
&gt;        &#41;;
&gt;
&gt;    }
&gt;
&gt;
&gt;
&gt; If you need timestamp field to be updated on every update
&gt;
&gt; then you can handle it similar way using _validate_prop&#40;&#41; method.
&gt;
&gt;
&gt;
&gt; 2. Fix: implement lazy_load on per field basis &#40;last line in TODO.txt&#41;
&gt;
&gt; In that case it will be possible to make timestamp field
&gt;
&gt; permanently &#39;lazy&#39; and never count on its value during updates.
&gt;
&gt;
&gt;
&gt; Unfortunately since i changed my job and switched to
&gt;
&gt; development using python, i don&#39;t have enought time to develop
&gt;
&gt; the project alone, so i can&#39;t give you estimate on when
&gt;
&gt; described fix will come to life, but if you interested
&gt;
&gt; in it i am appreciate any cooperation.
&gt;
&gt;
&gt;
&gt; On Thu, 04 Oct 2007 18:58:26 +0400, Colin Fine via RT
&gt;
&gt; &lt;bug-ORM@rt.cpan.org&gt; wrote:
&gt;
&gt;
&gt;
<div class="message-stanza open">&gt; &gt;
</div>&gt;
<div class="message-stanza open">&gt; &gt; Thu Oct 04 10:58:18 2007: Request 29772 was acted upon.
</div>&gt;
<div class="message-stanza open">&gt; &gt; Transaction: Ticket created by COLINFINE
</div>&gt;
<div class="message-stanza open">&gt; &gt;        Queue: ORM
</div>&gt;
<div class="message-stanza open">&gt; &gt;      Subject: After find_or_new, update fails when there is a timestamp
</div>&gt;
<div class="message-stanza open">&gt; &gt; field.
</div>&gt;
<div class="message-stanza open">&gt; &gt;    Broken in: 0.83
</div>&gt;
<div class="message-stanza open">&gt; &gt;     Severity: Normal
</div>&gt;
<div class="message-stanza open">&gt; &gt;        Owner: Nobody
</div>&gt;
<div class="message-stanza open">&gt; &gt;   Requestors: colin.fine@pacemicro.com
</div>&gt;
<div class="message-stanza open">&gt; &gt;       Status: new
</div>&gt;
<div class="message-stanza open">&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=29772">http://rt.cpan.org/Ticket/Display.html?id=29772</a></span> &gt;
</div>&gt;
<div class="message-stanza open">&gt; &gt;
</div>&gt;
<div class="message-stanza open">&gt; &gt;
</div>&gt;
<div class="message-stanza open">&gt; &gt; With a Database table that contains a &#39;timestamp&#39; field, if I use
</div>&gt;
<div class="message-stanza open">&gt; &gt; find_or_new to create a new object and record, then update it, the
</div>&gt;
<div class="message-stanza open">&gt; &gt; update fails.
</div>&gt;
<div class="message-stanza open">&gt; &gt;
</div>&gt;
<div class="message-stanza open">&gt; &gt; &#34;ORM::Db::DBI::MySQL-&gt;ORM::Db::DBI::update_object_part&#40;&#41;: Failed to
</div>&gt;
<div class="message-stanza open">&gt; &gt; update object with id#7 of class &#39;Test::Data&#39;, 0 rows affected, may be
</div>&gt;
<div class="message-stanza open">&gt; &gt; object was updated elsewhere.&#34;
</div>&gt;
<div class="message-stanza open">&gt; &gt;
</div>&gt;
<div class="message-stanza open">&gt; &gt; I think this is because the find_or_new has not realised that the
</div>&gt;
<div class="message-stanza open">&gt; &gt; &#39;timestamp&#39; field has been automatically set in the database, so the
</div>&gt;
<div class="message-stanza open">&gt; &gt; following update, which specifies the field as empty, does not match any
</div>&gt;
<div class="message-stanza open">&gt; &gt; rows.
</div>&gt;
<div class="message-stanza open">&gt; &gt;
</div>&gt;
<div class="message-stanza open">&gt; &gt; I thought this might be a consequence of using lazy_load, but I&#39;ve tried
</div>&gt;
<div class="message-stanza open">&gt; &gt; it with lazy_load both on and off, and it doesn&#39;t make any difference.
</div>&gt;
<div class="message-stanza open">&gt; &gt;
</div>&gt;
<div class="message-stanza open">&gt; &gt; The workround seems to be to call an explicit &#39;refresh&#39; after the
</div>&gt;
<div class="message-stanza open">&gt; &gt; &#39;find_or_new&#39;, but you don&#39;t need this when there isn&#39;t a timestamp.
</div>&gt;
<div class="message-stanza open">&gt; &gt;
</div>&gt;
<div class="message-stanza open">&gt; &gt; I suspect the fix is to exclude any timestamp fields from the match in
</div>&gt;
<div class="message-stanza open">&gt; &gt; &#39;update&#39; unless the calling code has specifically set them; but I don&#39;t
</div>&gt;
<div class="message-stanza open">&gt; &gt; know if this is too general and would have other repercussions.
</div>&gt;
<div class="message-stanza open">&gt; &gt;
</div>&gt;
<div class="message-stanza open">&gt; &gt; perl 5.8.5
</div>&gt;
<div class="message-stanza open">&gt; &gt; Fedora Core 3
</div>&gt;
<div class="message-stanza open">&gt; &gt; MySQL 4.1.22-standard
</div>&gt;
<div class="message-stanza open">&gt; &gt;
</div>&gt;
<div class="message-stanza open">&gt; &gt; Attached:
</div>&gt;
<div class="message-stanza open">&gt; &gt; ormtest.sql - defines the database
</div>&gt;
<div class="message-stanza open">&gt; &gt; testorm.tar.gz - the cgi and pm files.
</div>&gt;
<div class="message-stanza open">&gt; &gt;
</div>&gt;
<div class="message-stanza open">&gt; &gt;
</div>&gt;
<div class="message-stanza open">&gt; &gt;
</div>&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt; --
&gt;
&gt; Best regards, Alexey Akimov
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;
&gt;  Click <span class="clickylink"><a target="new" rel="nofollow" href="https://www.mailcontrol.com/sr/wQw0zmjPoHdJTZGyOCrrhg==">https://www.mailcontrol.com/sr/wQw0zmjPoHdJTZGyOCrrhg==</a></span>  to report this email as spam.
&gt;
&gt;
</div>

-- 
Best regards, Alexey Akimov.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
