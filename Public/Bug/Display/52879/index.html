<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #52879 for Net-LibNIDS: Bug returning TCP data via Net::LibNIDS::tcp_stream::data&#40;&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #52879 for Net-LibNIDS: Bug returning TCP data via Net::LibNIDS::tcp_stream::data&#40;&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-LibNIDS/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-LibNIDS/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-LibNIDS/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-LibNIDS/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-LibNIDS">Net-LibNIDS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">52879</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">15 min

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-LibNIDS/Active/">Net-LibNIDS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">david [...] edeca.net
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dave [...] pdx.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22838-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22839-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;17&nbsp;19:04:48&nbsp;2009</span>
    <span class="description">dave [...] pdx.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Bug returning TCP data via Net::LibNIDS::tcp_stream::data&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 17 Dec 2009 16:04:26 -0800</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;bug-Net-LibNIDS [...] rt.cpan.org&#34; &lt;bug-Net-LibNIDS [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> David Giller &lt;dave [...] pdx.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">LibNIDS.xs has a bug when returning the data from a packet to the TCP callback sub.  See the libnids API.txt or API.html section 5, which states:

&#34;If nids_discard function is never called &#40;like in above sample program&#41;, buffer hlf-&gt;data contains exactly hlf-&gt;count_new bytes.&#34;

Net::LibNIDS never calls nids_discard, and uses the default behavior, so the code in LibNIDS.xs is wrong here:

*** Net-LibNIDS-0.01.orig/LibNIDS.xs    2004-06-27 04:45:00.000000000 -0700
--- Net-LibNIDS-0.01.drg/LibNIDS.xs     2009-12-17 15:33:05.000000000 -0800
***************
*** 252,258 ****
  data&#40;obj&#41;
          SV* obj
        CODE:
!         RETVAL = newSVpv&#40; obj2halfstream&#40;obj&#41;-&gt;data ,  obj2halfstream&#40;obj&#41;-&gt;count&#41;;
        OUTPUT:
          RETVAL
  
--- 253,259 ----
  data&#40;obj&#41;
          SV* obj
        CODE:
!         RETVAL = newSVpv&#40; obj2halfstream&#40;obj&#41;-&gt;data ,  obj2halfstream&#40;obj&#41;-&gt;count_new&#41;;
        OUTPUT:
          RETVAL
  

The hlf-&gt;count value is the total number of bytes received in the stream, not the number of bytes in the buffer.

Alternately, and probably more correctly in general, the API document suggests that this would be the way to do it that would be correct even if Net::LibNIDS eventually exposes access to the nids_discard&#40;&#41; function:

        RETVAL = newSVpv&#40; obj2halfstream&#40;obj&#41;-&gt;data ,  obj2halfstream&#40;obj&#41;-&gt;count - obj2halfstream&#40;obj&#41;-&gt;offset &#41;;


This is using libnids 1.20.  This is using my own much simpler patch to solve the compilation problem that &#39;edeca&#39; fixed with his patches for bug #34545, so these line numbers are relative to the unmodified Net::LibNIDS sources, but the code should not be at all hard to find.

Without this fix, LibNIDS.xs accesses uninitialized data and any TCP stream with more than one packet will be corrupted when decoded using $stream-&gt;client-&gt;data&#40;&#41; or $stream-&gt;server-&gt;data&#40;&#41;.

Development is on Debian etch, with libnids and libnet from Debian repositories.

David Giller
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;17&nbsp;19:42:20&nbsp;2009</span>
    <span class="description">david [...] edeca.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Dec 17 19:04:48 2009, dgiller wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; LibNIDS.xs has a bug when returning the data from a packet to the TCP
&gt;    callback sub.  See the libnids API.txt or API.html section 5, which
&gt;    states:
&gt; 
&gt; &#34;If nids_discard function is never called &#40;like in above sample
&gt;    program&#41;, buffer hlf-&gt;data contains exactly hlf-&gt;count_new bytes.&#34;
&gt; 
&gt; Net::LibNIDS never calls nids_discard, and uses the default behavior,
&gt;    so the code in LibNIDS.xs is wrong here:
&gt; 
&gt; *** Net-LibNIDS-0.01.orig/LibNIDS.xs  2004-06-27 04:45:00.000000000
&gt;    -0700
&gt; --- Net-LibNIDS-0.01.drg/LibNIDS.xs   2009-12-17 15:33:05.000000000
&gt;    -0800
&gt; ***************
&gt; *** 252,258 ****
&gt;   data&#40;obj&#41;
&gt;         SV* obj
&gt;       CODE:
&gt; !       RETVAL = newSVpv&#40; obj2halfstream&#40;obj&#41;-&gt;data ,
&gt;    obj2halfstream&#40;obj&#41;-&gt;count&#41;;
&gt;       OUTPUT:
&gt;         RETVAL
&gt; 
&gt; --- 253,259 ----
&gt;   data&#40;obj&#41;
&gt;         SV* obj
&gt;       CODE:
&gt; !       RETVAL = newSVpv&#40; obj2halfstream&#40;obj&#41;-&gt;data ,
&gt;    obj2halfstream&#40;obj&#41;-&gt;count_new&#41;;
&gt;       OUTPUT:
&gt;         RETVAL
&gt; 
&gt; 
&gt; The hlf-&gt;count value is the total number of bytes received in the
&gt;    stream, not the number of bytes in the buffer.
&gt; 
&gt; Alternately, and probably more correctly in general, the API document
&gt;    suggests that this would be the way to do it that would be correct
&gt;    even if Net::LibNIDS eventually exposes access to the
&gt;    nids_discard&#40;&#41; function:
&gt; 
&gt;       RETVAL = newSVpv&#40; obj2halfstream&#40;obj&#41;-&gt;data ,  obj2halfstream&#40;obj&#41;-
<div class="message-stanza open">&gt;    &gt;count - obj2halfstream&#40;obj&#41;-&gt;offset &#41;;
</div>&gt; 
&gt; 
&gt; This is using libnids 1.20.  This is using my own much simpler patch
&gt;    to solve the compilation problem that &#39;edeca&#39; fixed with his
&gt;    patches for bug #34545, so these line numbers are relative to the
&gt;    unmodified Net::LibNIDS sources, but the code should not be at all
&gt;    hard to find.
&gt; 
&gt; Without this fix, LibNIDS.xs accesses uninitialized data and any TCP
&gt;    stream with more than one packet will be corrupted when decoded
&gt;    using $stream-&gt;client-&gt;data&#40;&#41; or $stream-&gt;server-&gt;data&#40;&#41;.
&gt; 
&gt; Development is on Debian etch, with libnids and libnet from Debian
&gt;    repositories.
&gt; 
&gt; David Giller
</div>

Hi David. Thanks for this, I am pretty sure I have this same fix in my local version of 
Net::LibNIDS &#40;along with a few others&#41;.  I can&#39;t upload it just yet until the author of the 
libnids libraries uploads the version 1.21 tarball I sent him which contain a few important 
fixes. 

I will update this bug and the module with the fix as soon as possible. 

David
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;17&nbsp;19:42:21&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;28&nbsp;19:41:42&nbsp;2010</span>
    <span class="description">perl [...] modtwo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> perl [...] modtwo.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Could somebody please apply the one-line fix changing count to
count_new? This module, without the fix, can cause perl to segfault,
making the module useless.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;06&nbsp;08:14:56&nbsp;2010</span>
    <span class="description">david [...] edeca.net -  Correspondence added</span>
    <span class="time-taken">15 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> perl [...] modtwo.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jan 28 19:41:42 2010, perl@modtwo.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Could somebody please apply the one-line fix changing count to
&gt; count_new? This module, without the fix, can cause perl to segfault,
&gt; making the module useless.
</div>
I have just uploaded Net::LibNIDS v0.02 which adds only this one line fix.

My apologies that this may seem slow, but I have a large number of fixes
for this module ready to go &#40;which was going to be v0.02&#41;.  However,
they require the C API updated and my communications with the library
maintainer are slower than expected.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;06&nbsp;08:14:57&nbsp;2010</span>
    <span class="description">david [...] edeca.net -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;06&nbsp;08:14:58&nbsp;2010</span>
    <span class="description">david [...] edeca.net -  Given to edeca</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
