<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #80322 for Win32-API: &#39;make test&#39; failure - 03_Jim_Shaw.t - invalid unpack type</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #80322 for Win32-API: &#39;make test&#39; failure - 03_Jim_Shaw.t - invalid unpack type</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Win32-API/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Win32-API/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Win32-API/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Win32-API/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Win32-API">Win32-API CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">80322</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Win32-API/Active/">Win32-API</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jdhedden [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
rurban [...] x-ray.at

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-35436-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.72</li>
<li>
0.73</li>
</ul>
    </td>
  </tr>
  <tr id="CF-35437-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




03_Jim_Shaw_good_output.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1132319/595838/03_Jim_Shaw_good_output.txt">
Tue Oct 23 19:08:54 2012 (31.5k) by BULKDD [...] cpan.org
</a>
</font></li>
</ul>


GetContext.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1141183/600114/GetContext.pl">
Sat Nov 10 22:31:37 2012 (1.2k) by BULKDD [...] cpan.org
</a>
</font></li>
</ul>


JerryGetContext.out<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1141183/600115/JerryGetContext.out">
Sat Nov 10 22:31:37 2012 (1.6k) by BULKDD [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;21&nbsp;17:49:07&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> &#39;make test&#39; failure - 03_Jim_Shaw.t - invalid unpack type</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; perl -Mblib Callback/t/03_Jim_Shaw.t 
</div>1..6
ok 1 - use Win32::API;
ok 2 - use Win32::API::Callback;
ok 3 - use Win32::API::Test;
ok 4 - loaded
get_window_pids: Desktop hwnd: 65556
Invalid type &#39;-&#39; in unpack at /var/perl/cpan/build/Win32-API-
0.73/blib/lib/Win32/API/Callback.pm line 188.
# Looks like you planned 6 tests but ran 4.
# Looks like your test exited with 255 just after 4.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; perl -V
</div>Summary of my perl5 &#40;revision 5 version 16 subversion 1 patch 53802&#41; 
configuration:
  Snapshot of: 06d742c02d396d6515581002f376b55ab1972c1b
  Platform:
    osname=cygwin, osvers=1.7.16&#40;0.26253&#41;, archname=cygwin-thread-multi-
64int
    uname=&#39;cygwin_nt-5.1 med-heddenj 1.7.16&#40;0.26253&#41; 2012-07-20 22:55 
i686 cygwin &#39;
    config_args=&#39;-de -Duse64bitint -Dusethreads -Uusemymalloc -
Dinc_version_list=none -Dnoextensions=DB_File Devel/DProf GDBM_File 
IPC/SysV NDBM_File ODBM_File Sys/Syslog Text/Soundex Time/Piece attrs 
B/Debug B/Lint -A append:ccflags= -DNO_MATHOMS -A define:optimize=-Os -
pipe -funit-at-a-time -march=pentium4 -mfpmath=sse -mieee-fp -mmmx -msse 
-msse2&#39;
    hint=recommended, useposix=true, d_sigaction=define
    useithreads=define, usemultiplicity=define
    useperlio=define, d_sfio=undef, uselargefiles=define, usesocks=undef
    use64bitint=define, use64bitall=undef, uselongdouble=undef
    usemymalloc=n, bincompat5005=undef
  Compiler:
    cc=&#39;gcc&#39;, ccflags =&#39;-DPERL_USE_SAFE_PUTENV -U__STRICT_ANSI__ -
DNO_MATHOMS -fno-strict-aliasing -pipe -fstack-protector -
I/usr/local/include&#39;,
    optimize=&#39;-Os -pipe -funit-at-a-time -march=pentium4 -mfpmath=sse -
mieee-fp -mmmx -msse -msse2&#39;,
    cppflags=&#39;-DPERL_USE_SAFE_PUTENV -U__STRICT_ANSI__ -DNO_MATHOMS -
fno-strict-aliasing -pipe -fstack-protector -I/usr/local/include&#39;
    ccversion=&#39;&#39;, gccversion=&#39;4.5.3&#39;, gccosandvers=&#39;&#39;
    intsize=4, longsize=4, ptrsize=4, doublesize=8, byteorder=12345678
    d_longlong=define, longlongsize=8, d_longdbl=define, longdblsize=12
    ivtype=&#39;long long&#39;, ivsize=8, nvtype=&#39;double&#39;, nvsize=8, 
Off_t=&#39;off_t&#39;, lseeksize=8
    alignbytes=8, prototype=define
  Linker and Libraries:
    ld=&#39;g++&#39;, ldflags =&#39; -Wl,--enable-auto-import -Wl,--export-all-
symbols -Wl,--enable-auto-image-base -s -fstack-protector -
L/usr/local/lib&#39;
    libpth=/usr/local/lib /usr/lib /lib
    libs=-ldb -ldl -lcrypt
    perllibs=-ldl -lcrypt
    libc=/usr/lib/libc.a, so=dll, useshrplib=true, 
libperl=cygperl5_16_1.dll
    gnulibc_version=&#39;&#39;
  Dynamic Linking:
    dlsrc=dl_dlopen.xs, dlext=dll, d_dlsymun=undef, ccdlflags=&#39; -s&#39;
    cccdlflags=&#39; &#39;, lddlflags=&#39; --shared  -Wl,--enable-auto-import -Wl,-
-export-all-symbols -Wl,--enable-auto-image-base -s -L/usr/local/lib -
fstack-protector&#39;


Characteristics of this binary &#40;from libperl&#41;: 
  Compile-time options: HAS_TIMES MULTIPLICITY NO_MATHOMS PERLIO_LAYERS
                        PERL_DONT_CREATE_GVSV PERL_IMPLICIT_CONTEXT
                        PERL_PRESERVE_IVUV PERL_USE_SAFE_PUTENV
                        USE_64_BIT_INT USE_ITHREADS USE_LARGE_FILES
                        USE_LOCALE USE_LOCALE_COLLATE USE_LOCALE_CTYPE
                        USE_LOCALE_NUMERIC USE_PERLIO USE_PERL_ATOF
                        USE_REENTRANT_API
  Built under cygwin
  Compiled at Oct  1 2012 10:24:20
  %ENV:
    PERLIO=&#34;perlio&#34;
    CYGWIN=&#34;nodosfilewarning&#34;
  @INC:
    /usr/lib/perl5/site_perl/5.16.1/cygwin
    /usr/lib/perl5/site_perl/5.16.1
    /usr/lib/perl5/5.16.1/cygwin
    /usr/lib/perl5/5.16.1
    .

Let me know if there is more information that you need, or if I can help 
with testing.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;21&nbsp;19:26:42&nbsp;2012</span>
    <span class="description">BULKDD [...] cpan.org -  Reference to https://rt.cpan.org/Ticket/Display.html?id=80217#txn-1130807 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;21&nbsp;19:30:47&nbsp;2012</span>
    <span class="description">BULKDD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Oct 21 17:49:07 2012, JDHEDDEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; perl -Mblib Callback/t/03_Jim_Shaw.t 
</div>&gt; 1..6
&gt; ok 1 - use Win32::API;
&gt; ok 2 - use Win32::API::Callback;
&gt; ok 3 - use Win32::API::Test;
&gt; ok 4 - loaded
&gt; get_window_pids: Desktop hwnd: 65556
&gt; Invalid type &#39;-&#39; in unpack at /var/perl/cpan/build/Win32-API-
&gt; 0.73/blib/lib/Win32/API/Callback.pm line 188.
</div>...................................
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Let me know if there is more information that you need, or if I can help 
&gt; with testing.
</div>
I thought in
<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=80217#txn-1130807">https://rt.cpan.org/Ticket/Display.html?id=80217#txn-1130807</a></span> the problem
was solved. Is the fatal error only on Perl 5.16 on Cygwin 1.7 but Perl
5.16 on Cygwin 1.5 is fine? I am preparing a diagnostic release on
github to try and figure this one out.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;21&nbsp;19:30:49&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;21&nbsp;20:03:33&nbsp;2012</span>
    <span class="description">BULKDD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Oct 21 17:49:07 2012, JDHEDDEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Let me know if there is more information that you need, or if I can help 
&gt; with testing.
</div>
A commit is up for you to try at
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/bulk88/perl5-win32-api/tree/cygwin-revisit-%231">https://github.com/bulk88/perl5-win32-api/tree/cygwin-revisit-%231</a></span> . You
might want to hand trim the output of Jim Shaw test for privacy/security
reasons. Make sure you indicate where you cut the output.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;23&nbsp;08:57:29&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #80322] &#39;make test&#39; failure - 03_Jim_Shaw.t - invalid unpack type</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 23 Oct 2012 08:56:45 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Win32-API [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Jerry D. Hedden&#34; &lt;jdhedden [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun, Oct 21, 2012 at 8:03 PM, Daniel Dragan via RT
&lt;bug-Win32-API@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=80322">https://rt.cpan.org/Ticket/Display.html?id=80322</a></span> &gt;
&gt; A commit is up for you to try at
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/bulk88/perl5-win32-api/tree/cygwin-revisit-%231">https://github.com/bulk88/perl5-win32-api/tree/cygwin-revisit-%231</a></span> . You
&gt; might want to hand trim the output of Jim Shaw test for privacy/security
&gt; reasons. Make sure you indicate where you cut the output.
</div>
All tests passed for Perl 5.16.1 under Cygwin 1.5.  For Perl 5.16.1
under Cygwin 1.7, the following failure occurs:

t/03_Jim_Shaw.t ...... 1/6 $paramcount=4 $IB=16, $obj-&gt;IB=8 PTRSIZE=4 PTRLET=L
$paramcount=4 $IB=16, $obj-&gt;IB=8 PTRSIZE=4 PTRLET=L
$paramcount=4 $IB=16, $obj-&gt;IB=8 PTRSIZE=4 PTRLET=L
$paramcount=4 $IB=16, $obj-&gt;IB=8 PTRSIZE=4 PTRLET=L
$paramcount=4 $IB=16, $obj-&gt;IB=8 PTRSIZE=4 PTRLET=L
$paramcount=4 $IB=16, $obj-&gt;IB=8 PTRSIZE=4 PTRLET=L
$paramcount=4 $IB=16, $obj-&gt;IB=8 PTRSIZE=4 PTRLET=L
$paramcount=-4 $IB=16, $obj-&gt;IB=8 PTRSIZE=4 PTRLET=L
Invalid type &#39;-&#39; in unpack at
/c/_/Xfer/bulk88-perl5-win32-api-cdc5668/Callback/../blib/lib/Win32/API/Callback.pm
line 190.
# Looks like you planned 6 tests but ran 4.
# Looks like your test exited with 255 just after 4.
t/03_Jim_Shaw.t ...... Dubious, test returned 255 &#40;wstat 65280, 0xff00&#41;
Failed 2/6 subtests

More fully:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; perl -Mblib Callback/t/03_Jim_Shaw.t
</div>1..6
ok 1 - use Win32::API;
ok 2 - use Win32::API::Callback;
ok 3 - use Win32::API::Test;
ok 4 - loaded
$VAR1 = bless&#40; {
                 &#39;out&#39; =&gt; 3,
                 &#39;outtype&#39; =&gt; &#39;I&#39;,
                 &#39;cdecl&#39; =&gt; 0,
                 &#39;sub&#39; =&gt; sub { &#34;DUMMY&#34; },
                 &#39;inbytes&#39; =&gt; 8,
                 &#39;intypes&#39; =&gt; [
                                &#39;N&#39;,
                                &#39;N&#39;
                              ],
                 &#39;codeExecAlloc&#39; =&gt; bless&#40; do{\&#40;my $o = 14229136&#41;},
&#39;Win32::API::Callback::HeapBlock&#39; &#41;,
                 &#39;code&#39; =&gt; 14229136
               }, &#39;Win32::API::Callback&#39; &#41;;
get_window_pids: Desktop hwnd: 65556
$paramcount=4 $IB=16, $obj-&gt;IB=8 PTRSIZE=4 PTRLET=L
window_enumerator - hwnd=[65878], PID=[2780]
$paramcount=4 $IB=16, $obj-&gt;IB=8 PTRSIZE=4 PTRLET=L
window_enumerator - hwnd=[65880], PID=[2780]
$paramcount=4 $IB=16, $obj-&gt;IB=8 PTRSIZE=4 PTRLET=L
window_enumerator - hwnd=[65706], PID=[1620]
$paramcount=4 $IB=16, $obj-&gt;IB=8 PTRSIZE=4 PTRLET=L
window_enumerator - hwnd=[65686], PID=[1620]
$paramcount=4 $IB=16, $obj-&gt;IB=8 PTRSIZE=4 PTRLET=L
window_enumerator - hwnd=[65688], PID=[1620]
$paramcount=4 $IB=16, $obj-&gt;IB=8 PTRSIZE=4 PTRLET=L
window_enumerator - hwnd=[65704], PID=[1620]
$paramcount=4 $IB=16, $obj-&gt;IB=8 PTRSIZE=4 PTRLET=L
window_enumerator - hwnd=[65682], PID=[1620]
$paramcount=-4 $IB=16, $obj-&gt;IB=8 PTRSIZE=4 PTRLET=L
Invalid type &#39;-&#39; in unpack at
/c/_/Xfer/bulk88-perl5-win32-api-cdc5668/blib/lib/Win32/API/Callback.pm
line 190.
# Looks like you planned 6 tests but ran 4.
# Looks like your test exited with 255 just after 4.

&#40;I don&#39;t recognize anything in the above as potentially related to
privacy/security.&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;23&nbsp;19:08:54&nbsp;2012</span>
    <span class="description">BULKDD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Oct 23 08:57:29 2012, JDHEDDEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; All tests passed for Perl 5.16.1 under Cygwin 1.5.  For Perl 5.16.1
&gt; under Cygwin 1.7, the following failure occurs:
</div>....................................
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; $paramcount=4 $IB=16, $obj-&gt;IB=8 PTRSIZE=4 PTRLET=L
&gt; window_enumerator - hwnd=[65682], PID=[1620]
&gt; $paramcount=-4 $IB=16, $obj-&gt;IB=8 PTRSIZE=4 PTRLET=L
&gt; Invalid type &#39;-&#39; in unpack at
&gt; /c/_/Xfer/bulk88-perl5-win32-api-
&gt; cdc5668/blib/lib/Win32/API/Callback.pm
&gt; line 190.
&gt; # Looks like you planned 6 tests but ran 4.
&gt; # Looks like your test exited with 255 just after 4.
&gt; 
</div>
I&#39;m not sure what to do. Basic math is not working randomly &#40;????&#41;.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">__________________________________________________________
    $inbytes = $self-&gt;{inbytes};
    #first is ebp copy then ret address
    $inbytes += PTRSIZE * 2;
    my $paramcount = $inbytes / PTRSIZE ;
    warn&#40;&#34;\$paramcount=$paramcount \$IB=$inbytes, \$obj-&gt;IB=&#34;.
         $self-&gt;{inbytes}.&#34; PTRSIZE=&#34;.PTRSIZE.&#34; PTRLET=&#34;.PTRLET.&#34;\n&#34;&#41;;
<div class="message-stanza open">__________________________________________________________
$paramcount is supposed to be a positive number. Both $inbytes and
PTRSIZE are positive as printed in the warn call. Why did the result of
the operation that happened 7 times correctly suddenly become negative?

I retried the cygwin fix branch I gave you with my Cygwin Perl and I
attached what it looks like when the jim_shaw test succeeds. Towards the
end there is a dump of all/some Win32 GUI components and their names
&#40;the privacy issues I mentioned&#41;. Here is the -V of the Cyg Perl I used.

<div class="message-stanza open">_________________________________________________________
$ perl -V
Summary of my perl5 &#40;revision 5 version 14 subversion 2&#41; configuration:

  Platform:
    osname=cygwin, osvers=1.7.15&#40;0.26053&#41;,
archname=cygwin-thread-multi-64int
    uname=&#39;cygwin_nt-5.1 winxp 1.7.15&#40;0.26053&#41; 2012-05-09 10:25 i686
cygwin &#39;
<div class="message-stanza open">_________________________________________________________

Did you compile your own CygPerl 5.16 or you are using an official build
from Cygnus? I noticed your Perl has
<div class="message-stanza open">_________________________________________________________
    optimize=&#39;-Os -pipe -funit-at-a-time -march=pentium4 -mfpmath=sse -
mieee-fp -mmmx -msse -msse2&#39;,
<div class="message-stanza open">_________________________________________________________
meanwhile my CygPerl just has
<div class="message-stanza open">_________________________________________________________
    optimize=&#39;-O3&#39;,
<div class="message-stanza open">_________________________________________________________

I am running low on ideas on what is causing this. I dont think this is
a problem Win32::API, since superficially it does not look like a SEGV,
or random memory corruption which are Win32::API&#39;s typical failure
modes. Just a single bit is wrong in the IV, IF that is an IV.

If you compiled your own CygPerl, did it pass a make test when you built it?

I can only investigate what is special about your Perl build that caused
that division statement to break. My next idea is to add
Devel::Peek::Dump on $paramcount before and after the problematic
division and see if $paramcount is an IV or NV. After that try to reduce
the math division error to a test case that doesn&#39;t involve Win32::API.
I can not reproduce the Jim Shaw test failure with my Cygnus CygPerl 5.14

How do you want to proceed? 
</div></div></div></div></div></div></div></div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 03_Jim_Shaw_good_output.txt</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;23&nbsp;19:38:29&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #80322] &#39;make test&#39; failure - 03_Jim_Shaw.t - invalid unpack type</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 23 Oct 2012 19:37:49 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Win32-API [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Jerry D. Hedden&#34; &lt;jdhedden [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Did you compile your own CygPerl 5.16 or you are using an official build
&gt; from Cygnus?
</div>
Yes, I build my own perl, and have been doing so for years.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If you compiled your own CygPerl, did it pass a make test when you built it?
</div>
Yes, it passes &#39;make test&#39;.  If I have failures, I submit bug reports
or patches to p5p.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I can only investigate what is special about your Perl build that caused
&gt; that division statement to break. My next idea is to add
&gt; Devel::Peek::Dump on $paramcount before and after the problematic
&gt; division and see if $paramcount is an IV or NV. After that try to reduce
&gt; the math division error to a test case that doesn&#39;t involve Win32::API.
&gt; I can not reproduce the Jim Shaw test failure with my Cygnus CygPerl 5.14
&gt;
&gt; How do you want to proceed?
</div>
If you can code up what you want me to run, I&#39;ll do it and send back
the results.  If you want me to do it, I&#39;ll try to figure out what
you&#39;re suggesting and see if I can get it coded up myself.

For the back and forth between us, it might be best to email each
other directly and not clutter up the bug report.  We can put a
synopsis of the final outcome when we get there.  Just a suggestion.

I&#39;ll also work on building a 5.14 perl to test this as well.  &#40;I was
on a hiatus for awhile.&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;02&nbsp;10:47:21&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, Nov 2, 2012 at 10:31 AM, bulk 88 &lt;bulk88@hotmail.com&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Bug has been identified. I had a suspicion from day 1 that
&gt; might be causing something but the why is so unexplainable
&gt; so changing the C/XS/asm code was the last thing I would
&gt; try.  It has to do with a garbage &#40;since the value is
&gt; meant only as an I32/I64 in EAX/EDX&#41; float/double being
&gt; loaded into ST&#40;0&#41; x87 register. Somehow float &#40;as string&#41;
&gt; &#34;\x01\x00\x00\x00&#34; &#40;since 03_Jim_Shaw.t&#39;s
&gt; window_enumerator sub is returning I32 1&#41; has special
&gt; meaning or is it switching FPU flags &#40;how?&#41; or something.
&gt; Why only on the 8th&#39;s time? Why only on your CygPerl and
&gt; not my Cygnus build? Does Cygwin use a &#34;unix&#34; calling
&gt; convention that changes some of the volatile registers to
&gt; non vol &#40;looking at asm of mt CygPerl it looked like
&gt; normal cdecl&#41;? What is Cygwin&#39;s policy on x87 control
&gt; register? Does Cygwin unmask FPU exceptions and catch them
&gt; &#40;SEH&#41; and process them in software and resume execution? I
&gt; don&#39;t have answers to any of the above questions.
&gt;
&gt; There are 2 ways of fixing this, add more logic to the 32
&gt; bit shell code stub written in ::Callback::MakeCB to not
&gt; touch x87 if not returning a x87 val. Or figure out what
&gt; happened. This might turn into a bug report for Cygwin
&gt; runtime lib. My internet at home is still down due to the
&gt; hurricane and I am not at my other place so I can&#39;t do any
&gt; googling or research on this until I am back at the other
&gt; place that has broadband. Probably next week. If you want
&gt; to research it yourself, there should be enough info above
&gt; for you to do it. RtlCaptureContext is what I would be
&gt; using for debugging and printf dumping all 8 bytes of
&gt; CBRETVAL * retval in PerlCallback in Callback.xs every
&gt; time PerlCallback is called.
</div>
I am adding the above to the bug report for tracking
purposes.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;02&nbsp;10:48:23&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Cc rurban@x-ray.at added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;02&nbsp;17:46:15&nbsp;2012</span>
    <span class="description">rurban [...] x-ray.at -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> libwin32 [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #80322] &#39;make test&#39; failure - 03_Jim_Shaw.t - invalid unpack type</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 2 Nov 2012 16:46:01 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Win32-API [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Reini Urban &lt;rurban [...] x-ray.at&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I checked cygwin perl 5.16.2 non-threaded, fixed on obvious bug, and
the tests pass.
See <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/cosimo/perl5-win32-api/pull/6">https://github.com/cosimo/perl5-win32-api/pull/6</a></span>

Checking soon with a threaded cygwin perl.

On Fri, Nov 2, 2012 at 9:47 AM, Jerry D. Hedden via RT
&lt;bug-Win32-API@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Fri Nov 02 10:47:21 2012: Request 80322 was acted upon.
&gt; Transaction: Correspondence added by JDHEDDEN
&gt;        Queue: Win32-API
&gt;      Subject: &#39;make test&#39; failure - 03_Jim_Shaw.t - invalid unpack type
&gt;    Broken in: 0.72, 0.73
&gt;     Severity: Important
&gt;        Owner: Nobody
&gt;   Requestors: jdhedden@cpan.org
&gt;       Status: open
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=80322">https://rt.cpan.org/Ticket/Display.html?id=80322</a></span> &gt;
&gt;
&gt;
&gt; On Fri, Nov 2, 2012 at 10:31 AM, bulk 88 &lt;bulk88@hotmail.com&gt; wrote:
<div class="message-stanza open">&gt;&gt; Bug has been identified. I had a suspicion from day 1 that
&gt;&gt; might be causing something but the why is so unexplainable
&gt;&gt; so changing the C/XS/asm code was the last thing I would
&gt;&gt; try.  It has to do with a garbage &#40;since the value is
&gt;&gt; meant only as an I32/I64 in EAX/EDX&#41; float/double being
&gt;&gt; loaded into ST&#40;0&#41; x87 register. Somehow float &#40;as string&#41;
&gt;&gt; &#34;\x01\x00\x00\x00&#34; &#40;since 03_Jim_Shaw.t&#39;s
&gt;&gt; window_enumerator sub is returning I32 1&#41; has special
&gt;&gt; meaning or is it switching FPU flags &#40;how?&#41; or something.
&gt;&gt; Why only on the 8th&#39;s time? Why only on your CygPerl and
&gt;&gt; not my Cygnus build? Does Cygwin use a &#34;unix&#34; calling
&gt;&gt; convention that changes some of the volatile registers to
&gt;&gt; non vol &#40;looking at asm of mt CygPerl it looked like
&gt;&gt; normal cdecl&#41;? What is Cygwin&#39;s policy on x87 control
&gt;&gt; register? Does Cygwin unmask FPU exceptions and catch them
&gt;&gt; &#40;SEH&#41; and process them in software and resume execution? I
&gt;&gt; don&#39;t have answers to any of the above questions.
&gt;&gt;
&gt;&gt; There are 2 ways of fixing this, add more logic to the 32
&gt;&gt; bit shell code stub written in ::Callback::MakeCB to not
&gt;&gt; touch x87 if not returning a x87 val. Or figure out what
&gt;&gt; happened. This might turn into a bug report for Cygwin
&gt;&gt; runtime lib. My internet at home is still down due to the
&gt;&gt; hurricane and I am not at my other place so I can&#39;t do any
&gt;&gt; googling or research on this until I am back at the other
&gt;&gt; place that has broadband. Probably next week. If you want
&gt;&gt; to research it yourself, there should be enough info above
&gt;&gt; for you to do it. RtlCaptureContext is what I would be
&gt;&gt; using for debugging and printf dumping all 8 bytes of
&gt;&gt; CBRETVAL * retval in PerlCallback in Callback.xs every
&gt;&gt; time PerlCallback is called.
</div>&gt;
&gt; I am adding the above to the bug report for tracking
&gt; purposes.
</div>
-- 
Reini Urban
<span class="clickylink"><a target="new" rel="nofollow" href="http://cpanel.net/">http://cpanel.net/</a></span>   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perl-compiler.org/">http://www.perl-compiler.org/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;10&nbsp;22:31:36&nbsp;2012</span>
    <span class="description">BULKDD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> libwin32 [...] perl.org, rurban [...] x-ray.at</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attaching private mail for the record.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">________________________________
<div class="message-stanza open">&gt; From: jdhedden@cpan.org
&gt; Date: Tue, 6 Nov 2012 12:50:49 -0500
&gt; Subject: Re: [rt.cpan.org #80322] &#39;make test&#39; failure - 03_Jim_Shaw.t -
&gt; invalid unpack type
&gt; To: bulk88@hotmail.com
&gt; CC: rurban@x-ray.at
&gt;
&gt; Output Attached
&gt;
&gt;
&gt; On Sat, Nov 3, 2012 at 1:38 AM, bulk 88
&gt; &lt;bulk88@hotmail.com&lt;mailto:bulk88@hotmail.com&gt;&gt; wrote:
&gt;
&gt;
&gt;
&gt; ----------------------------------------
<div class="message-stanza open">&gt; &gt; From: jdhedden@cpan.org&lt;mailto:jdhedden@cpan.org&gt;
&gt; &gt; Date: Fri, 2 Nov 2012 10:44:05 -0400
&gt; &gt; Subject: Re: [rt.cpan.org&lt;<span class="clickylink"><a target="new" rel="nofollow" href="/">http://rt.cpan.org</a></span>&gt; #80322] &#39;make test&#39;
</div>&gt; failure - 03_Jim_Shaw.t - invalid unpack type
<div class="message-stanza open">&gt; &gt; To: bulk88@hotmail.com&lt;mailto:bulk88@hotmail.com&gt;
&gt; &gt; CC: rurban@x-ray.at&lt;mailto:rurban@x-ray.at&gt;
&gt; &gt;
&gt; &gt; I leave the debugging part to you, and possibly Reini and/or the
&gt; &gt; Cygwin team, as all this is Greek to me. I just had the &#40;mis&#41;fortune
&gt; &gt; of being the first to discover the issue. You may, of course, still
&gt; &gt; call upon me to perform testing and send back results if needed. Good
&gt; &gt; Luck.
</div>&gt;
&gt; Can you run this script and send back the output with CPAN Win32::API
&gt; .73 or any .73 github derivative I&#39;ve made so far?
&gt; 
</div>
Reini 

On Sat, Nov 3, 2012 at 12:38 AM, bulk 88 &lt;bulk88@hotmail.com&gt; wrote:
<div class="message-stanza open">&gt; ----------------------------------------
<div class="message-stanza open">&gt;&gt; From: jdhedden@cpan.org
&gt;&gt; Date: Fri, 2 Nov 2012 10:44:05 -0400
&gt;&gt; Subject: Re: [rt.cpan.org #80322] &#39;make test&#39; failure - 03_Jim_Shaw.t
</div></div>- invalid unpack type
<div class="message-stanza open"><div class="message-stanza open">&gt;&gt; To: bulk88@hotmail.com
&gt;&gt; CC: rurban@x-ray.at
&gt;&gt;
&gt;&gt; I leave the debugging part to you, and possibly Reini and/or the
&gt;&gt; Cygwin team, as all this is Greek to me. I just had the &#40;mis&#41;fortune
&gt;&gt; of being the first to discover the issue. You may, of course, still
&gt;&gt; call upon me to perform testing and send back results if needed. Good
&gt;&gt; Luck.
</div>&gt;
&gt; Can you run this script and send back the output with CPAN Win32::API
</div>.73 or any .73 github derivative I&#39;ve made so far?
 
Sure, but I cannot reproduce the bugs.
Only t/undef.t test 2 is failing on my cygwin non-threaded.
And I needed to fix the Callback DESTROY #if identation from
<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/cosimo/perl5-win32-api/pull/6">https://github.com/cosimo/perl5-win32-api/pull/6</a></span>
non-threaded needs to skip the t/threading_fails.t tests also.
 
non-threaded:
$ alias p
alias p=&#39;/usr/local/bin/perl5.16.2d-nt.exe&#39;
$ alias pb
alias pb=&#39;p -Iblib/arch -Iblib/lib&#39;
$ pb t/GetContext.pl
$VAR1 =
&#34;?\0\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\177\2\377\377
\0\377\377\377\377\377\377\177\377\24X\e\0\0\0pe-X#\0\377\377\210\225\&#34;\0x\227\&#34;\0\0\0\1\0\0\0&#40;\233\nax\227\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\254\201\1
\25\0\0\0\0\0\0\0\0\0\0\0\0\200\377?\0\0\0\0\374\377\377\377\34\@\0\0\0\0\0\0\0\0;\0\0\0#\0\0\0#\0\0\0_\36\32a\0\0\0\0\300\246\&#34;\0\4\0\0\0\0\0\0\0\270\245\&#34;\0\b\246\&#34;\0\373*\201|\e\0\0\0F\2\0\0\264\245\&#34;\0#\0\0\0\177\2
\0\0\0\0\0\177\377\24X\e\0\0\0pe-X#\0\0\0\200\37\0\0\377\377\0\0\210\225\&#34;\0x\227\&#34;\0\0\0\0\0\0\0\0\0\1\0\0\0&#40;\233\nax\227\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\254\201\1
\25\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\200\377?\0\0\0\0\0\0\0\0\0\0\374\377\377\377\34\@\0\0\0\0\0\0\200\251\&#34;\0_\300\16a#\0;\0\0\0#\0\200\251\&#34;\0_\300\16a#\0;\0\0\0#\0D\377\&#34;\0`\16\240_\0\0__register_frame_info\0\0\252\&#34;\0\0\0\0\0\0\0\0\0\260_&#39;a\0\0\0\0000\0&lt;\0\310\222&#39;a\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\344}\310\16\267_\315\1qG\&#34;\302A\271\315\1&gt;\340\312\16\267_\315\1&gt;\340\312\16\267_\315\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\20&#40;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\nA\202\0\0\0\0\0\0\0\0\0\0\0\0\0
\224\32a\303\0\0\0
\224\32a\343z\0a\0\0\0\0\0\0\0\0&lt;\246\&#34;\0\234\226\&#34;\0x\227\&#34;\0\1\0\0\0\1\0\0\0\0\1\0\0\270\201\2
\30\230\&#34;\0\@\225\&#34;\0q\230\na#\0;\0\0\0#\0D\377\&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;;
 
threaded:
$ alias p
alias p=&#39;perl5.16.2d&#39;
 
$VAR1 =
&#34;?\0\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\177\2\377\377
\0\377\377\377\377\377\377\0\322\26X\e\0\0\0\260t1X#\0\377\377\1\0\0\0&#40;\233\nax\227\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\254\201\1
\25\0\0\0\0\0\20&#40;\0\0\@\0\0\0\377\0\0\0\0\0\0\0\0\200\377?\0\0\0\0\374\377\377\377\34\@\0\0\0\0\0\0\0\0;\0\0\0#\0\0\0#\0\0\0[\36\32a\0\0\0\0\260\246\&#34;\0\4\0\0\0\0\0\0\0\230\245\&#34;\0\350\245\&#34;\0\373*\201|\e\0\0\0F\2\0\0\224\245\&#34;\0#\0\0\0\177\2
\0\0\0\0\0\0\322\26X\e\0\0\0\260t1X#\0\0\0\200\37\0\0\377\377\0\0\1\0\0\0&#40;\233\nax\227\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\254\201\1
\25\0\0\0\0\0\0\0\0\0\0\0\20&#40;\0\0\@\0\0\0\377\0\0\0\0\0\0\0\0\0\0\0\0\0\0\200\377?\0\0\0\0\0\0\0\0\0\0\374\377\377\377\34\@\0\0\0\0\0\0D\377\&#34;\0`\16\240_\0\0__regiD\377\&#34;\0`\16\240_\0\0__register_frame_info\0\0\252\&#34;\0\0\0\0\0\0\0\0\0\260_&#39;a\0\0\0\0000\0&lt;\0\@\223&#39;a\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\344}\310\16\267_\315\1qG\&#34;\302A\271\315\1&gt;\340\312\16\267_\315\1&gt;\340\312\16\267_\315\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\20&#40;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\nA\202\0\0\0\0\0\0\0\0\0\0\0\0\0
\224\32a\303\0\0\0
\224\32a\343z\0a\0\0\0\0\0\0\0\0&lt;\246\&#34;\0\234\226\&#34;\0x\227\&#34;\0\1\0\0\0\1\0\0\0\0\1\0\0\270\201\2
\30\230\&#34;\0\@\225\&#34;\0q\230\na#\0;\0\0\0#\0D\377\&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;;
 
$ cmp gc-non-thr.xx gc-thr.xx
gc-non-thr.xx gc-thr.xx differ: byte 107, line 1
 
-- 
Reini Urban
<span class="clickylink"><a target="new" rel="nofollow" href="http://cpanel.net/">http://cpanel.net/</a></span>   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perl-compiler.org/">http://www.perl-compiler.org/</a></span>

<div class="message-stanza open">___________________________________________________________

Basically the problem is, something is &#34;going wrong&#34; in the x87 FP or
SSE system when running &#34;denormal&#34; float FP numbers through Jerry&#39;s
cygwin. Looking at the snapshot of the FP regs will reveal what exactly
is going on, rounding mode, precision, exception masks, other things,
etc. Comparing Reini&#39;s context dump to Jerrys to mine will reveal what
is going on. The problem is, looking at those registers is sort of
undocumented, nobody does it except compiler writers. OSes don&#39;t care
about the details about those registers, aslong as they can be saved and
restored to memory for context switches. I can&#39;t find any decent C
struct definition &#40;including C bitfields of the bitfield registers&#41; of
the data on Google that the x86 FXSAVE op creates. Also the docs online
are all copied out of Intel&#39;s x86 asm manual, which unintelligibly dry
for me. I&#39;m a bit stuck right now on this bug.
</div></div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> GetContext.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use constant &#40; EXCEPTION_CONTINUE_EXECUTION =&gt; 0xffffffff &#41;;
use Win32::API qw&#40; ReadMemory &#41;;
use Win32::API::Callback;
use Data::Dumper;
$Data::Dumper::Useqq = 1;

my $AddVectoredExceptionHandler = Win32::API-&gt;new&#40;&#39;kernel32.dll&#39;, &#39;AddVectoredExceptionHandler&#39;, &#39;IK&#39;, &#39;N&#39;&#41;;
die &#34;bad AddVectoredExceptionHandler&#34; if ! $AddVectoredExceptionHandler;
my $RemoveVectoredExceptionHandler = Win32::API-&gt;new&#40;&#39;kernel32.dll&#39;, &#39;RemoveVectoredExceptionHandler&#39;, &#39;N&#39;, &#39;I&#39;&#41;;
die &#34;bad RemoveVectoredExceptionHandler&#34; if ! $RemoveVectoredExceptionHandler;
my $RaiseException = Win32::API-&gt;new&#40;&#39;kernel32.dll&#39;, &#39;RaiseException&#39;, &#39;IIIN&#39;, &#39;V&#39;&#41;;
die &#34;bad RaiseException&#34; if ! $RaiseException;
$cb = Win32::API::Callback-&gt;new&#40;sub {
    #not 64bit compliant
    my $pExceptionInfo = ReadMemory&#40;$_[0], 8&#41;;
    my &#40;$pExceptionRecord, $pContextRecord&#41; = unpack&#40;&#39;LL&#39;, $pExceptionInfo&#41;;
    my $ContextRecord = ReadMemory&#40;$pContextRecord, 716&#41;;
    print Dumper&#40;$ContextRecord&#41;;
    return EXCEPTION_CONTINUE_EXECUTION;
},
&#39;N&#39;, &#39;i&#39;&#41;;
die &#34;bad CB&#34; if ! $cb;

my $VHHnd;
die &#34;AddVectoredExceptionHandler failed&#34; if ! &#40;$VHHnd = $AddVectoredExceptionHandler-&gt;Call&#40;1, $cb&#41;&#41;;
$RaiseException-&gt;Call&#40;0,0,0,0&#41;;
die &#34;RemoveVectoredExceptionHandler failed&#34; if ! $RemoveVectoredExceptionHandler-&gt;Call&#40;$VHHnd&#41;;</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> JerryGetContext.out</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1141183/600115/JerryGetContext.out">Download JerryGetContext.out</a><br />
<span class="downloadcontenttype">application/octet-stream 1.6k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;11&nbsp;17:13:54&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> rurban [...] x-ray.at</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #80322] &#39;make test&#39; failure - 03_Jim_Shaw.t - invalid unpack type</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 11 Nov 2012 17:13:11 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Win32-API [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Jerry D. Hedden&#34; &lt;jdhedden [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">It is possible this has anything to do with the compiler flags I use:

-march=pentium4 -mfpmath=sse -mieee-fp -mmmx -msse -msse2


On Sat, Nov 10, 2012 at 10:31 PM, Daniel Dragan via RT &lt;
bug-Win32-API@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=80322">https://rt.cpan.org/Ticket/Display.html?id=80322</a></span> &gt;
&gt;
&gt; Attaching private mail for the record.
&gt;
&gt; ________________________________
<div class="message-stanza open">&gt; &gt; From: jdhedden@cpan.org
&gt; &gt; Date: Tue, 6 Nov 2012 12:50:49 -0500
&gt; &gt; Subject: Re: [rt.cpan.org #80322] &#39;make test&#39; failure - 03_Jim_Shaw.t -
&gt; &gt; invalid unpack type
&gt; &gt; To: bulk88@hotmail.com
&gt; &gt; CC: rurban@x-ray.at
&gt; &gt;
&gt; &gt; Output Attached
&gt; &gt;
&gt; &gt;
&gt; &gt; On Sat, Nov 3, 2012 at 1:38 AM, bulk 88
&gt; &gt; &lt;bulk88@hotmail.com&lt;mailto:bulk88@hotmail.com&gt;&gt; wrote:
&gt; &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; ----------------------------------------
<div class="message-stanza open">&gt; &gt; &gt; From: jdhedden@cpan.org&lt;mailto:jdhedden@cpan.org&gt;
&gt; &gt; &gt; Date: Fri, 2 Nov 2012 10:44:05 -0400
&gt; &gt; &gt; Subject: Re: [rt.cpan.org&lt;<span class="clickylink"><a target="new" rel="nofollow" href="/">http://rt.cpan.org</a></span>&gt; #80322] &#39;make test&#39;
</div>&gt; &gt; failure - 03_Jim_Shaw.t - invalid unpack type
<div class="message-stanza open">&gt; &gt; &gt; To: bulk88@hotmail.com&lt;mailto:bulk88@hotmail.com&gt;
&gt; &gt; &gt; CC: rurban@x-ray.at&lt;mailto:rurban@x-ray.at&gt;
&gt; &gt; &gt;
&gt; &gt; &gt; I leave the debugging part to you, and possibly Reini and/or the
&gt; &gt; &gt; Cygwin team, as all this is Greek to me. I just had the &#40;mis&#41;fortune
&gt; &gt; &gt; of being the first to discover the issue. You may, of course, still
&gt; &gt; &gt; call upon me to perform testing and send back results if needed. Good
&gt; &gt; &gt; Luck.
</div>&gt; &gt;
&gt; &gt; Can you run this script and send back the output with CPAN Win32::API
&gt; &gt; .73 or any .73 github derivative I&#39;ve made so far?
&gt; &gt;
</div>&gt;
&gt; Reini
&gt;
&gt; On Sat, Nov 3, 2012 at 12:38 AM, bulk 88 &lt;bulk88@hotmail.com&gt; wrote:
<div class="message-stanza open">&gt; &gt; ----------------------------------------
<div class="message-stanza open">&gt; &gt;&gt; From: jdhedden@cpan.org
&gt; &gt;&gt; Date: Fri, 2 Nov 2012 10:44:05 -0400
&gt; &gt;&gt; Subject: Re: [rt.cpan.org #80322] &#39;make test&#39; failure - 03_Jim_Shaw.t
</div></div>&gt; - invalid unpack type
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt; To: bulk88@hotmail.com
&gt; &gt;&gt; CC: rurban@x-ray.at
&gt; &gt;&gt;
&gt; &gt;&gt; I leave the debugging part to you, and possibly Reini and/or the
&gt; &gt;&gt; Cygwin team, as all this is Greek to me. I just had the &#40;mis&#41;fortune
&gt; &gt;&gt; of being the first to discover the issue. You may, of course, still
&gt; &gt;&gt; call upon me to perform testing and send back results if needed. Good
&gt; &gt;&gt; Luck.
</div>&gt; &gt;
&gt; &gt; Can you run this script and send back the output with CPAN Win32::API
</div>&gt; .73 or any .73 github derivative I&#39;ve made so far?
&gt;
&gt; Sure, but I cannot reproduce the bugs.
&gt; Only t/undef.t test 2 is failing on my cygwin non-threaded.
&gt; And I needed to fix the Callback DESTROY #if identation from
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/cosimo/perl5-win32-api/pull/6">https://github.com/cosimo/perl5-win32-api/pull/6</a></span>
&gt; non-threaded needs to skip the t/threading_fails.t tests also.
&gt;
&gt; non-threaded:
&gt; $ alias p
&gt; alias p=&#39;/usr/local/bin/perl5.16.2d-nt.exe&#39;
&gt; $ alias pb
&gt; alias pb=&#39;p -Iblib/arch -Iblib/lib&#39;
&gt; $ pb t/GetContext.pl
&gt; $VAR1 =
&gt; &#34;?\0\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\177\2\377\377
&gt;
&gt; \0\377\377\377\377\377\377\177\377\24X\e\0\0\0pe-X#\0\377\377\210\225\&#34;\0x\227\&#34;\0\0\0\1\0\0\0&#40;\233\nax\227\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\254\201\1
&gt;
&gt; \25\0\0\0\0\0\0\0\0\0\0\0\0\200\377?\0\0\0\0\374\377\377\377\34\@\0\0\0\0\0\0\0\0;\0\0\0#\0\0\0#\0\0\0_\36\32a\0\0\0\0\300\246\&#34;\0\4\0\0\0\0\0\0\0\270\245\&#34;\0\b\246\&#34;\0\373*\201|\e\0\0\0F\2\0\0\264\245\&#34;\0#\0\0\0\177\2
&gt;
&gt; \0\0\0\0\0\177\377\24X\e\0\0\0pe-X#\0\0\0\200\37\0\0\377\377\0\0\210\225\&#34;\0x\227\&#34;\0\0\0\0\0\0\0\0\0\1\0\0\0&#40;\233\nax\227\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\254\201\1
&gt;
&gt; \25\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\200\377?\0\0\0\0\0\0\0\0\0\0\374\377\377\377\34\@\0\0\0\0\0\0\200\251\&#34;\0_\300\16a#\0;\0\0\0#\0\200\251\&#34;\0_\300\16a#\0;\0\0\0#\0D\377\&#34;\0`\16\240_\0\0__register_frame_info\0\0\252\&#34;\0\0\0\0\0\0\0\0\0\260_&#39;a\0\0\0\0000\0&lt;\0\310\222&#39;a\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\344}\310\16\267_\315\1qG\&#34;\302A\271\315\1&gt;\340\312\16\267_\315\1&gt;\340\312\16\267_\315\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\20&#40;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\nA\202\0\0\0\0\0\0\0\0\0\0\0\0\0
&gt; \224\32a\303\0\0\0
&gt;
&gt; \224\32a\343z\0a\0\0\0\0\0\0\0\0&lt;\246\&#34;\0\234\226\&#34;\0x\227\&#34;\0\1\0\0\0\1\0\0\0\0\1\0\0\270\201\2
&gt;
&gt; \30\230\&#34;\0\@\225\&#34;\0q\230\na#\0;\0\0\0#\0D\377\&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;;
&gt;
&gt; threaded:
&gt; $ alias p
&gt; alias p=&#39;perl5.16.2d&#39;
&gt;
&gt; $VAR1 =
&gt; &#34;?\0\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\177\2\377\377
&gt;
&gt; \0\377\377\377\377\377\377\0\322\26X\e\0\0\0\260t1X#\0\377\377\1\0\0\0&#40;\233\nax\227\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\254\201\1
&gt;
&gt; \25\0\0\0\0\0\20&#40;\0\0\@\0\0\0\377\0\0\0\0\0\0\0\0\200\377?\0\0\0\0\374\377\377\377\34\@\0\0\0\0\0\0\0\0;\0\0\0#\0\0\0#\0\0\0[\36\32a\0\0\0\0\260\246\&#34;\0\4\0\0\0\0\0\0\0\230\245\&#34;\0\350\245\&#34;\0\373*\201|\e\0\0\0F\2\0\0\224\245\&#34;\0#\0\0\0\177\2
&gt;
&gt; \0\0\0\0\0\0\322\26X\e\0\0\0\260t1X#\0\0\0\200\37\0\0\377\377\0\0\1\0\0\0&#40;\233\nax\227\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\254\201\1
&gt;
&gt; \25\0\0\0\0\0\0\0\0\0\0\0\20&#40;\0\0\@\0\0\0\377\0\0\0\0\0\0\0\0\0\0\0\0\0\0\200\377?\0\0\0\0\0\0\0\0\0\0\374\377\377\377\34\@\0\0\0\0\0\0D\377\&#34;\0`\16\240_\0\0__regiD\377\&#34;\0`\16\240_\0\0__register_frame_info\0\0\252\&#34;\0\0\0\0\0\0\0\0\0\260_&#39;a\0\0\0\0000\0&lt;\0\@\223&#39;a\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\344}\310\16\267_\315\1qG\&#34;\302A\271\315\1&gt;\340\312\16\267_\315\1&gt;\340\312\16\267_\315\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\20&#40;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\nA\202\0\0\0\0\0\0\0\0\0\0\0\0\0
&gt; \224\32a\303\0\0\0
&gt;
&gt; \224\32a\343z\0a\0\0\0\0\0\0\0\0&lt;\246\&#34;\0\234\226\&#34;\0x\227\&#34;\0\1\0\0\0\1\0\0\0\0\1\0\0\270\201\2
&gt;
&gt; \30\230\&#34;\0\@\225\&#34;\0q\230\na#\0;\0\0\0#\0D\377\&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;;
&gt;
&gt; $ cmp gc-non-thr.xx gc-thr.xx
&gt; gc-non-thr.xx gc-thr.xx differ: byte 107, line 1
&gt;
&gt; --
&gt; Reini Urban
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://cpanel.net/">http://cpanel.net/</a></span>   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perl-compiler.org/">http://www.perl-compiler.org/</a></span>
&gt;
&gt; ___________________________________________________________
&gt;
&gt; Basically the problem is, something is &#34;going wrong&#34; in the x87 FP or
&gt; SSE system when running &#34;denormal&#34; float FP numbers through Jerry&#39;s
&gt; cygwin. Looking at the snapshot of the FP regs will reveal what exactly
&gt; is going on, rounding mode, precision, exception masks, other things,
&gt; etc. Comparing Reini&#39;s context dump to Jerrys to mine will reveal what
&gt; is going on. The problem is, looking at those registers is sort of
&gt; undocumented, nobody does it except compiler writers. OSes don&#39;t care
&gt; about the details about those registers, aslong as they can be saved and
&gt; restored to memory for context switches. I can&#39;t find any decent C
&gt; struct definition &#40;including C bitfields of the bitfield registers&#41; of
&gt; the data on Google that the x86 FXSAVE op creates. Also the docs online
&gt; are all copied out of Intel&#39;s x86 asm manual, which unintelligibly dry
&gt; for me. I&#39;m a bit stuck right now on this bug.
&gt;
</div></div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Nov&nbsp;11&nbsp;23:14:46&nbsp;2012</span>
    <span class="description">BULKDD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> libwin32 [...] perl.org, rurban [...] x-ray.at</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Nov 11 17:13:54 2012, JDHEDDEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It is possible this has anything to do with the compiler flags I use:
&gt; 
&gt; -march=pentium4 -mfpmath=sse -mieee-fp -mmmx -msse -msse2
&gt; 
</div>
Maybe it does. I compared x87 control word, x87 status word, and sse
mxcsr. No FP exceptions are allowed to fire on yours or mine &#40;so it is
not a cygwin or GCC FP exception handler, I don&#39;t think it is&#41;.
Basically everything is identical &#40;i had a inexact flag on and condition
bit C3 was on for me, yours didn&#39;t have either on, some other small
differences might exist but they weren&#39;t signifigant for me to
remember&#41;. Below is what I used to look at the data. The Reini data is
broken &#40;wrong length&#41;. Basically, the bug is, your platform fails on
division after 7 &#34;return *&#40;float *&#41;&#34;\x01\x00\x00\x00&#34;;&#34;. What OS/CPU are
you using &#40;are you using YMM registers?&#41;? A random fact, x87 has only FP
8 registers. I wonder, if the asm code that is loading the float into
the register, is &#34;corrupting&#34; the other 7 registers? I&#39;ll have to check
another day. I might also try to write a pure C/XS example with the
unusual float and a eval_pv with a division operation and see if I
trigger it that way. The opcode I used is the same Visual C used when
Visual C compiled the following
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">______________________________________________________
////the template used in the MakeCB for x86
double CALLBACK CallbackTemplateD&#40;&#41; {
    void &#40;*PerlCallback&#41;&#40;SV *, void *, unsigned __int64 *, FuncRtnCxt *&#41;
= 0xC0DE0001;
    FuncRtnCxt FuncRtnCxtVar;
    FDUNION retval;
    PerlCallback&#40;&#40;SV *&#41;0xC0DE0002, &#40;void*&#41;0xC0DE0003, &#40;unsigned __int64
*&#41;&#38;retval, &#38;FuncRtnCxtVar&#41;;
    if&#40;FuncRtnCxtVar.F_Or_D&#41;{
        return &#40;double&#41; retval.f;
    }
    else{
        return retval.d;        
    }
}
<div class="message-stanza open">_____________________________________________________

void
SC&#40;cxts1, cxts2, cxts3&#41;
    char * cxts1
    char * cxts2
    char * cxts3
PREINIT:
    struct FXSAVE
    {
    UINT16 _fcw;


    UINT16 _fsw;
    UINT8  _ftw;
    UINT8  _pad1;
    UINT16 _fop;
    UINT32 _fpuip;
    UINT16 _cs;
    UINT16 _pad2;
    UINT32 _fpudp;
    UINT16 _ds;
    UINT16 _pad3;
    UINT32 _mxcsr;
    UINT32 _mxcsrmask;
    UINT8  _st[8 * 16];
    UINT8  _xmm[8 * 16];
    UINT8  _pad4[56 * 4];
    };
    struct _CONTEXT * cxt1 = &#40;struct _CONTEXT *&#41;cxts1;
    struct _CONTEXT * cxt2 = &#40;struct _CONTEXT *&#41;cxts2;
    struct _CONTEXT * cxt3 = &#40;struct _CONTEXT *&#41;cxts3;
    PFLOATING_SAVE_AREA fp1 = &#38;cxt1-&gt;FloatSave;
    PFLOATING_SAVE_AREA fp2 = &#38;cxt2-&gt;FloatSave;
    PFLOATING_SAVE_AREA fp3 = &#38;cxt3-&gt;FloatSave;
    struct FXSAVE * fxs1 = &#38;cxt1-&gt;ExtendedRegisters;
    struct FXSAVE * fxs2 = &#38;cxt2-&gt;ExtendedRegisters;
    struct FXSAVE * fxs3 = &#38;cxt3-&gt;ExtendedRegisters;
CODE:
    DebugBreak&#40;&#41;;
    printf&#40;&#34;hw\n&#34;&#41;;
<div class="message-stanza open">________________________________________________

#Jerry
$cxt1 =
&#34;?\0\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\177\2\377\377
\0\377\377\377\377\377\377\360\234\bX\e\0]\5\270\244\&#34;\0#\0\377\377\0\0\0\0\$\272\224\250\234\372\1\0\0\0\0\0\0\0\0\0\235\377O\200\0\r\333\272\324\271h\\\253\0\274\271\224\250x\240\200f2\213\355\266T\200\31\0\4\e\0\200\300\273\224\250d\275\0h\254\375\235\355Q\240\1\@\0\0\0\0\0\0\0\240\1\@\0\0\0\0\0\0\0\0;\0\0\0#\0\0\0#\0\0\0\4\0\0\0\0\0\0\0h\252\&#34;\0\377\377\377\377\251*\201|\230\250\&#34;\0\350\250\&#34;\0\373*\201|\e\0\0\0F\2\0\0\224\250\&#34;\0#\0\0\0\177\2
\0\0\0]\5\360\234\bX\e\0\0\0\270\244\&#34;\0#\0\0\0\240\37\0\0\377\377\0\0\0\0\0\0\$\272\224\250\234\372\0\0\0\0\0\0\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\235\377O\200\0\r\333\272\324\271\0\0\0\0\0\0h\\\253\0\274\271\224\250x\240\0\0\0\0\0\0\200f2\213\355\266T\200\31\0\0\0\0\0\0\0\4\e\0\200\300\273\224\250d\275\0\0\0\0\0\0\0h\254\375\235\355Q\240\1\@\0\0\0\0\0\0\0\0\0\0\0\0\0\240\1\@\0\0\0\0\0\0X\354\$\0\0\0\0\0\0\0\0\0\0\0\0\0\260\256\n\324b\20\24\@\0\0\0\0\0\0\0\0\0\0\0\0\0\210\303\@\0\0\0\0\0\0\0\0\0\0\0\0\320\273\224\250rG\205\277\0\0\0\0\325\221\0\0\320\273\224\250\255G\205\277\30\222\301\351\$\272\224\250\35H\205\277\0\0\0\1\200\b\22\347\30\222\301\351\b\0\n\0\0\273\224\250p\241M\200x\1\346\271\0\0\2\0\0\340\375\177\@\272\224\250\1\0\0\0\0\1\0\0\20\202\2
\350\227\&#34;\0\20\225\&#34;\0001\234\na#\0;\0\0\0#\0D\377\&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\16\0\0\0\1\0\0\0\2\0\0\0\1\0\0\0\2\0\0\0\0\0\0\0\0\0\0\0&#34;;
#Reini
$cxt2 =
&#34;?\0\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\177\2\377\377\0\377\377\377\377\377\377\177\377\24X\e\0\0\0pe-X#\0\377\377\210\225\&#34;\0x\227\&#34;\0\0\0\1\0\0\0&#40;\233\nax\227\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\254\201\1\25\0\0\0\0\0\0\0\0\0\0\0\0\200\377?\0\0\0\0\374\377\377\377\34\@\0\0\0\0\0\0\0\0;\0\0\0#\0\0\0#\0\0\0_\36\32a\0\0\0\0\300\246\&#34;\0\4\0\0\0\0\0\0\0\270\245\&#34;\0\b\246\&#34;\0\373*\201|\e\0\0\0F\2\0\0\264\245\&#34;\0#\0\0\0\177\2\0\0\0\0\0\177\377\24X\e\0\0\0pe-X#\0\0\0\200\37\0\0\377\377\0\0\210\225\&#34;\0x\227\&#34;\0\0\0\0\0\0\0\0\0\1\0\0\0&#40;\233\nax\227\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\254\201\1\25\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\200\377?\0\0\0\0\0\0\0\0\0\0\374\377\377\377\34\@\0\0\0\0\0\0\200\251\&#34;\0_\300\16a#\0;\0\0\0#\0\200\251\&#34;\0_\300\16a#\0;\0\0\0#\0D\377\&#34;\0`\16\240_\0\0__register_frame_info\0\0\252\&#34;\0\0\0\0\0\0\0\0\0\260_&#39;a\0\0\0\0000\0&lt;\0\310\222&#39;a\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\344}\310\16\267_\315\1qG\&#34;\302A\271\315\1&gt;\340\312\16\267_\315\1&gt;\340\312\16\267_\315\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\20&#40;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\nA\202\0\0\0\0\0\0\0\0\0\0\0\0\0\224\32a\303\0\0\0\224\32a\343z\0a\0\0\0\0\0\0\0\0&lt;\246\&#34;\0\234\226\&#34;\0x\227\&#34;\0\1\0\0\0\1\0\0\0\0\1\0\0\270\201\2\30\230\&#34;\0\@\225\&#34;\0q\230\na#\0;\0\0\0#\0D\377\&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;;
#Daniel
$cxt3 =
&#34;?\0\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\177\2\377\377
\@\377\377\377\377\377\377\252U\5&#40;\e\0\330\5\0\0\0\0#\0\377\377\0\0\0\0\0\0\0\0\0\0\0\0\0\0\n\330\220|\21\264\27\0\0\0L\365\23\0\$\0\1\0\0\0008:\25\0a\264\0\0\3\0\0\0\0\0\0\0\0\0\0\0\0\0D\234\f\@\0\0\0\0\0\0\0\200\377?\0\0\0\0\374\377\377\377\34\@\0\0\0\0\0\0\0\0;\0\0\0#\0\0\0#\0\0\0004B4\0\0\0\0\0\313*\1&#40;\377\377\377\377\@\372\22\0\270\371\22\0\b\372\22\0\373*\201|\e\0\0\0F\2\0\0\264\371\22\0#\0\0\0\177\2
\@\0\0\330\5\252U\5&#40;\e\0\0\0\0\0\0\0#\0\0\0\240\37\0\0\377\377\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\n\330\220|\21\264\0\0\0\0\0\0\27\0\0\0L\365\23\0\$\0\0\0\0\0\0\0\1\0\0\0008:\25\0a\264\0\0\0\0\0\0\0\0\3\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0D\234\f\@\0\0\0\0\0\0\0\0\0\0\0\0\0\200\377?\0\0\0\0\0\0\0\0\0\0\374\377\377\377\34\@\0\0\0\0\0\0\0\0\0\0\0\0\20\@\0\0\0\0\0\0\0\0\325x\351&#38;1\b\24\@\0\0\0\0\0\0\0\0*\32k\177g{\204?\0\0\0\0\0\0\0\0\0\0\0\0\0\0\$\@\0\0\0\0\0\0\0\0\215\265\277\263=\n\24\@\0\0\0\0\0\0\0\0^\324\301w\265\1\0\0\t\0\0\0\237\370\23\0\1\0\0\0P\366\23\0\1\0\0\0\237\370\23\0\237\370\23\0\210\366\23\0%\20\304w\243\324\301w\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;;

$cxt2 = &#34;\x00&#34; x 716;
die &#34;bad len&#34;.length&#40;$cxt1&#41; if length&#40;$cxt1&#41; != 716;
die &#34;bad len&#34;.length&#40;$cxt2&#41; if length&#40;$cxt2&#41; != 716;
die &#34;bad len&#34;.length&#40;$cxt3&#41; if length&#40;$cxt3&#41; != 716;
Local::XS::SC&#40;$cxt1, $cxt2, $cxt3&#41;;
</div></div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;21&nbsp;15:49:36&nbsp;2016</span>
    <span class="description">BULKDD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">After having no clue how to fix this, and having some doubts if this ticket is real, I reproduced it with Win 7+VC 2013. Perhaps something in EnumChildWindows changed between Win XP and Win7 that stopped &#34;resetting&#34; the FPU, or the SSE heavy instead of x87, machine code of VC 2013 wasn&#39;t clearing the FPU state the way the older non-SSE code wouldve, or EnumChildWindows in WinXP used ebp as base pointer and in Win7 when MS compiled user32.dll, ebp was reused as GPR with only esp addressing.

Anyways, what was happening was each fld op in the shellcode callback was pushing one var onto FPU stack. Eventually the FPU stack which has 8 elements was filled. x87 Stack Fault &#40;bit 6&#41; exception bit came on at that point. After that, no further FPU math was possible. NAN was the result of every op. That resulted in this PP division op failing, after 8 calls of the W::A::C callback <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/BULKDD/Win32-API-0.82/Callback.pm#L176">https://metacpan.org/source/BULKDD/Win32-API-0.82/Callback.pm#L176</a></span> this line in PP was returning NAN even though its &#34;16/4&#34; which cant possibly be NAN. The NAN in a SVNV after going through SvUV became 0, so the callback unwound the C stack by 0 bytes instead of 8 as stdcall requires &#40;EnumChildWindows wants a stdcall func, not cdecl&#41;. Eventually EnumChildWindows poped nonvol register esi from the wrong location on C stack a couple hundred bytes away from the correct location of the saved esi register, since every call into the callback screwed up esp by 8 bytes. The corrupted esi register after EnumChildWindows returned control to W::A causing a crash in Win32::API&#39;s Call_asm.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;21&nbsp;15:49:49&nbsp;2016</span>
    <span class="description">BULKDD [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;21&nbsp;15:49:50&nbsp;2016</span>
    <span class="description">BULKDD [...] cpan.org -  Fixed in 0.84 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;21&nbsp;17:02:33&nbsp;2016</span>
    <span class="description">TONYC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jan 21 15:49:36 2016, BULKDD wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; After having no clue how to fix this, and having some doubts if this
&gt; ticket is real, I reproduced it with Win 7+VC 2013. Perhaps something
&gt; in EnumChildWindows changed between Win XP and Win7 that stopped
&gt; &#34;resetting&#34; the FPU, or the SSE heavy instead of x87, machine code of
&gt; VC 2013 wasn&#39;t clearing the FPU state the way the older non-SSE code
&gt; wouldve, or EnumChildWindows in WinXP used ebp as base pointer and in
&gt; Win7 when MS compiled user32.dll, ebp was reused as GPR with only esp
&gt; addressing.
&gt; 
&gt; Anyways, what was happening was each fld op in the shellcode callback
&gt; was pushing one var onto FPU stack. Eventually the FPU stack which has
&gt; 8 elements was filled. x87 Stack Fault &#40;bit 6&#41; exception bit came on
&gt; at that point. After that, no further FPU math was possible. NAN was
&gt; the result of every op. That resulted in this PP division op failing,
&gt; after 8 calls of the W::A::C callback
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/source/BULKDD/Win32-API-0.82/Callback.pm#L176">https://metacpan.org/source/BULKDD/Win32-API-0.82/Callback.pm#L176</a></span>
&gt; this line in PP was returning NAN even though its &#34;16/4&#34; which cant
&gt; possibly be NAN. The NAN in a SVNV after going through SvUV became 0,
&gt; so the callback unwound the C stack by 0 bytes instead of 8 as stdcall
&gt; requires &#40;EnumChildWindows wants a stdcall func, not cdecl&#41;.
&gt; Eventually EnumChildWindows poped nonvol register esi from the wrong
&gt; location on C stack a couple hundred bytes away from the correct
&gt; location of the saved esi register, since every call into the callback
&gt; screwed up esp by 8 bytes. The corrupted esi register after
&gt; EnumChildWindows returned control to W::A causing a crash in
&gt; Win32::API&#39;s Call_asm.
</div>
That sounds like a bug we had in one of the perl BBC reports last year.

A module was calling the Time::HiRes Time::NVtime entry point from C with the wrong prototype, mis-balancing the FPU stack, which resulted in a NaN in a unrelated location.

I ended up diagnosing it by adding code to the perl run loop to check the FPU stack was empty, and abort with the current location in the perl code when it wasn&#39;t.

Tony
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;21&nbsp;17:02:35&nbsp;2016</span>
    <span class="description">TONYC [...] cpan.org -  Fixed in 0.84 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;21&nbsp;20:17:53&nbsp;2016</span>
    <span class="description">BULKDD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jan 21 17:02:33 2016, TONYC wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; That sounds like a bug we had in one of the perl BBC reports last
&gt; year.
&gt; 
&gt; A module was calling the Time::HiRes Time::NVtime entry point from C
&gt; with the wrong prototype, mis-balancing the FPU stack, which resulted
&gt; in a NaN in a unrelated location.
</div>
That is what was happening to me here. NAN in unrelated location.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I ended up diagnosing it by adding code to the perl run loop to check
&gt; the FPU stack was empty, and abort with the current location in the
&gt; perl code when it wasn&#39;t.
</div>
You aren&#39;t the first to modify the run loop like that. DebugBreak&#40;&#41; is my fav function. Some bugs aren&#39;t reproducible if you run the .t manually outside of &#34;make test&#34;, or its a one liner that ran a one liner that crashed, not the root parent .t, or if you switch TAP::Harness to verbose mode since the bug is memory corruption. DebugBreak&#40;&#41; takes care of all those permutations.

My failure to diagnose it originally 3 years ago was

A. I couldn&#39;t reproduce it
B. I thought elements just fall off the end of the FPU stack, not that the FPU stops working until there is space on the FPU stack
C. calling convention docs said the FP stack/FP registers are volatile, only FPU Control Word is non-vol &#40;if you change rounding mode, you must restore it was whatever the caller had it as&#41;. I guess that is kindda false as the stack apparently must be empty according to this 2014 book <span class="clickylink"><a target="new" rel="nofollow" href="https://books.google.com/books?id=plInCgAAQBAJ&#38;lpg=PA90&#38;dq=&#38;pg=PA110#v=onepage&#38;q&#38;f=false">https://books.google.com/books?id=plInCgAAQBAJ&#38;lpg=PA90&#38;dq=&#38;pg=PA110#v=onepage&#38;q&#38;f=false</a></span> but the 2014 book doesn&#39;t outright say that that is an API contract that the FPU stack must be empty

The 2 byte fix at <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/bulk88/perl5-win32-api/commit/ad3696fc998539ca9c56adc8664f3b21ae0ac0c3#diff-f00ae59afe5413c3b9c279cd5ae6104bR307">https://github.com/bulk88/perl5-win32-api/commit/ad3696fc998539ca9c56adc8664f3b21ae0ac0c3#diff-f00ae59afe5413c3b9c279cd5ae6104bR307</a></span> just means just ST&#40;0&#41; is set now, all the other FPU registers &#40;ST&#40;1&#41; through ST&#40;7&#41;&#41; are now assumed to be non-vol and are left the way they were found &#40;probably empty&#41; upon entry to the shellcode callback.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
