<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #46285 for HTML-Template: Lazy loop variables and loop variables as boolean</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #46285 for HTML-Template: Lazy loop variables and loop variables as boolean</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/HTML-Template/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/HTML-Template/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/HTML-Template/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/HTML-Template/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/HTML-Template">HTML-Template CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">46285</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/HTML-Template/Active/">HTML-Template</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
justin [...] devuyst.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-16062-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.9    </td>
  </tr>
  <tr id="CF-16063-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;21&nbsp;13:29:10&nbsp;2009</span>
    <span class="description">justin [...] devuyst.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Lazy loop variables and loop variables as boolean</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This ticket covers two issues because the patch covers both.
This patch has been in production for a few months now with
no known issues.

1.  HTML::Template currently handles lazy evaluating of
scalar variables.  We had a need to do this for loop variables.
Because we have many many conditionals this helped reduce
our computational load by about half.

2.  Because of the way variable typing is currently done its
impossible to use a loop variable in a boolean context only.
I fixed this is the least amount of code I could come up with.
Again, since we &#40;ab&#41;use conditionals so extensively this is a
bug we ran into a fair amount of the time.  This is similar to
RT #32683.

I have tests if You would like them.  I am also willing to rework
the patch if desired.  Let me know.

Thanks,
jdv
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> template_jdv.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Template.pm.2.9     2009-05-21 13:10:38.000000000 -0400
+++ Template.pm.new     2009-05-21 13:15:13.000000000 -0400
@@ -980,6 +980,7 @@
                no_includes =&gt; 0,
                case_sensitive =&gt; 0,
                filter =&gt; [],
+               type_guess_prefix =&gt; &#39;_%c^s#z&#38;_:_&#39;,
               &#41;;
   
   # load in options supplied to new&#40;&#41;
@@ -1636,6 +1637,7 @@
         $template-&gt;{options}{die_on_bad_params} = $options-&gt;{die_on_bad_params};
         $template-&gt;{options}{case_sensitive} = $options-&gt;{case_sensitive};
         $template-&gt;{options}{parent_global_vars} = $options-&gt;{parent_global_vars};
+        $template-&gt;{options}{type_guess_prefix} = $options-&gt;{type_guess_prefix};
 
         push&#40;@pstacks, $template-&gt;{parse_stack}&#41;;
       }
@@ -2120,6 +2122,12 @@
            $top_pmap{$var} = HTML::Template::VAR-&gt;new&#40;&#41;
              if $options-&gt;{global_vars} and not exists $top_pmap{$var};
            $uc-&gt;[HTML::Template::COND::VARIABLE] = $pmap{$var};
+        if &#40; $options-&gt;{type_guess_prefix} &#38;&#38; $var !~ /^__expr/ &#41; {
+            $pmap{ $options-&gt;{type_guess_prefix} . $var }
+              = HTML::Template::VAR-&gt;new&#40;&#41;;
+            $top_pmap{ $options-&gt;{type_guess_prefix} . $var }
+              = HTML::Template::VAR-&gt;new&#40;&#41;;
+        }
          }
          if &#40;ref&#40;$pmap{$var}&#41; eq &#39;HTML::Template::VAR&#39;&#41; {
            $uc-&gt;[HTML::Template::COND::VARIABLE_TYPE] = HTML::Template::COND::VARIABLE_TYPE_VAR;
@@ -2154,7 +2162,8 @@
                                           loop_context_vars =&gt; $options-&gt;{loop_context_vars},
                                            case_sensitive =&gt; $options-&gt;{case_sensitive},
                                            force_untaint =&gt; $options-&gt;{force_untaint},
-                                           parent_global_vars =&gt; &#40;$options-&gt;{global_vars} || $options-&gt;{parent_global_vars} || 0&#41;
+                                           parent_global_vars =&gt; &#40;$options-&gt;{global_vars} || $options-&gt;{parent_global_vars} || 0&#41;,
+                       type_guess_prefix =&gt; $options-&gt;{type_guess_prefix},
                                          &#41;;
 
       } elsif &#40;$which eq &#39;TMPL_IF&#39; or $which eq &#39;TMPL_UNLESS&#39; &#41; {
@@ -2361,6 +2370,12 @@
       $top_pmap{$var} = HTML::Template::VAR-&gt;new&#40;&#41;
         if $options-&gt;{global_vars} and not exists $top_pmap{$var};
       $uc-&gt;[HTML::Template::COND::VARIABLE] = $pmap{$var};
+      if &#40; $options-&gt;{type_guess_prefix} &#38;&#38; $var !~ /^__expr/ &#41; {
+        $pmap{ $options-&gt;{type_guess_prefix} . $var }
+          = HTML::Template::VAR-&gt;new&#40;&#41;;
+        $top_pmap{ $options-&gt;{type_guess_prefix} . $var }
+          = HTML::Template::VAR-&gt;new&#40;&#41;;
+      }
     }
     if &#40;ref&#40;$pmap{$var}&#41; eq &#39;HTML::Template::VAR&#39;&#41; {
       $uc-&gt;[HTML::Template::COND::VARIABLE_TYPE] = HTML::Template::COND::VARIABLE_TYPE_VAR;
@@ -2517,6 +2532,12 @@
 
     return ${$param_map-&gt;{$param}} if 
       &#40;ref&#40;$param_map-&gt;{$param}&#41; eq &#39;HTML::Template::VAR&#39;&#41;;
+
+    my $param_set = $param_map-&gt;{$param}[HTML::Template::LOOP::PARAM_SET];
+    if &#40; ref $param_set-&gt;[ 0 ] eq &#39;CODE&#39; &#41; {
+      @{ $param_set } = @{ $param_set-&gt;[ 0 ]-&gt;&#40; $self, &#41; };
+    }
+
     return $param_map-&gt;{$param}[HTML::Template::LOOP::PARAM_SET];
   } 
 
@@ -2561,6 +2582,13 @@
     # objects that are compatible underneath.
     my $value_type = ref&#40;$value&#41;;
     if &#40;defined&#40;$value_type&#41; and length&#40;$value_type&#41; and &#40;$value_type eq &#39;ARRAY&#39; or &#40;&#40;ref&#40;$value&#41; !~ /^&#40;CODE&#41;|&#40;HASH&#41;|&#40;SCALAR&#41;$/&#41; and $value-&gt;isa&#40;&#39;ARRAY&#39;&#41;&#41;&#41;&#41; {
+
+      if &#40; $options-&gt;{type_guess_prefix} &#41; {
+        if &#40; delete $param_map-&gt;{ $options-&gt;{type_guess_prefix} . $param } &#41; {
+          $param_map-&gt;{$param} = HTML::Template::LOOP-&gt;new;
+        }
+      }
+
       &#40;ref&#40;$param_map-&gt;{$param}&#41; eq &#39;HTML::Template::LOOP&#39;&#41; or
         croak&#40;&#34;HTML::Template::param&#40;&#41; : attempt to set parameter &#39;$param&#39; with an array ref - parameter is not a TMPL_LOOP!&#34;&#41;;
       $param_map-&gt;{$param}[HTML::Template::LOOP::PARAM_SET] = [@{$value}];
@@ -2741,9 +2769,15 @@
               }
             }
           } else {
-            $x = $line-&gt;[HTML::Template::COND::JUMP_ADDRESS] if
-              &#40;defined $line-&gt;[HTML::Template::COND::VARIABLE][HTML::Template::LOOP::PARAM_SET] and
-               scalar @{$line-&gt;[HTML::Template::COND::VARIABLE][HTML::Template::LOOP::PARAM_SET]}&#41;;
+            my $param_set
+              = $line-&gt;[HTML::Template::COND::VARIABLE][HTML::Template::LOOP::PARAM_SET];
+            if &#40; defined $param_set &#41; {
+                if &#40; ref $param_set-&gt;[ 0 ] eq &#39;CODE&#39; &#41; {
+                    @{ $param_set } = @{ $param_set-&gt;[ 0 ]-&gt;&#40; $self, &#41; };
+                }
+                $x = $line-&gt;[HTML::Template::COND::JUMP_ADDRESS]
+                  if scalar @{ $param_set };
+            }
           }
         } else {
           if &#40;$line-&gt;[HTML::Template::COND::VARIABLE_TYPE] == HTML::Template::COND::VARIABLE_TYPE_VAR&#41; {
@@ -2757,9 +2791,18 @@
               $x = $line-&gt;[HTML::Template::COND::JUMP_ADDRESS];
             }
           } else {
-            $x = $line-&gt;[HTML::Template::COND::JUMP_ADDRESS] if
-              &#40;not defined $line-&gt;[HTML::Template::COND::VARIABLE][HTML::Template::LOOP::PARAM_SET] or
-               not scalar @{$line-&gt;[HTML::Template::COND::VARIABLE][HTML::Template::LOOP::PARAM_SET]}&#41;;
+            my $param_set
+              = $line-&gt;[HTML::Template::COND::VARIABLE][HTML::Template::LOOP::PARAM_SET];
+            if &#40; defined $param_set &#41; {
+                if &#40; ref $param_set-&gt;[ 0 ] eq &#39;CODE&#39; &#41; {
+                    @{ $param_set } = @{ $param_set-&gt;[ 0 ]-&gt;&#40; $self, &#41; };
+                }
+                $x = $line-&gt;[HTML::Template::COND::JUMP_ADDRESS]
+                  unless scalar @{ $param_set };
+            }
+            else {
+                $x = $line-&gt;[HTML::Template::COND::JUMP_ADDRESS];
+            }
           }
         }
       }      
@@ -3049,7 +3092,11 @@
   my $template = $self-&gt;[TEMPLATE_HASH]{$index};
   my $value_sets_array = $self-&gt;[PARAM_SET];
   return unless defined&#40;$value_sets_array&#41;;  
-  
+
+  if &#40; ref $value_sets_array-&gt;[ 0 ] eq &#39;CODE&#39; &#41; {
+    @{ $value_sets_array } = @{ $value_sets_array-&gt;[ 0 ]-&gt;&#40; $template, &#41; };
+  }
+
   my $result = &#39;&#39;;
   my $count = 0;
   my $odd = 0;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;14&nbsp;17:34:00&nbsp;2011</span>
    <span class="description">wonko [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu May 21 13:29:10 2009, justin@devuyst.com wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 1.  HTML::Template currently handles lazy evaluating of
&gt; scalar variables.  We had a need to do this for loop variables.
&gt; Because we have many many conditionals this helped reduce
&gt; our computational load by about half.
</div>
Great idea.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2.  Because of the way variable typing is currently done its
&gt; impossible to use a loop variable in a boolean context only.
&gt; I fixed this is the least amount of code I could come up with.
&gt; Again, since we &#40;ab&#41;use conditionals so extensively this is a
&gt; bug we ran into a fair amount of the time.  This is similar to
&gt; RT #32683.
</div>
As I mentioned for ticket #32683, I don&#39;t think this is a feature we&#39;ll
be adding anytime soon. And you&#39;re patch makes behavior dependent on
variable naming &#40;even if that naming pattern is configurable&#41; which is
quite a departure from any other HTML::Template feature.

If you want something to be a loop in the code but not a loop in the
template, I&#39;m not sure there&#39;s a good way to do that. And like I
mentioned in #32683 you don&#39;t actually need anything in your TMPL_LOOP
to let HTML::Template know it&#39;s actually a loop:

  &lt;tmpl_loop foo&gt;&lt;/tmpl_loop&gt;
  &lt;tmpl_if foo&gt;
    ...
  &lt;/tmpl_if&gt;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;14&nbsp;17:34:01&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;14&nbsp;17:34:46&nbsp;2011</span>
    <span class="description">wonko [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve added support for lazy tmpl_loops &#40;coderefs that return array
references&#41; and this will appear in the upcoming 2.10 version.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;14&nbsp;17:34:47&nbsp;2011</span>
    <span class="description">wonko [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
