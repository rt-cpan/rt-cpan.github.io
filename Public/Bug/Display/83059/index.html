<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #83059 for XML-Twig: Segmentation fault while parsing</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #83059 for XML-Twig: Segmentation fault while parsing</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/XML-Twig/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/XML-Twig/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/XML-Twig/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/XML-Twig/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-Twig">XML-Twig CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">83059</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/XML-Twig/Active/">XML-Twig</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
k.tchernov [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-37682-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
3.42    </td>
  </tr>
  <tr id="CF-37683-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
3.45    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;30&nbsp;18:54:25&nbsp;2013</span>
    <span class="description">k.tchernov [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Segmentation fault while parsing</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Running on a Mac OS X with perl v5.12 &#40;I believe it also crashes with perl v5.16&#41;, when I parse a 
list of XML::Twig files one after another, XML::Twig eventually segfaults.

I&#39;ve attached some sample code with sample inputs.

To reproduce the crash, run &#34;./parse.pl &lt;input dir&gt;&#34; where &lt;input dir&gt; is the directory 
containing the contents of xmls.zip

I&#39;ve also tried the sample code with XML::Parser, and that worked fine and without segfaulting.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> xmls.zip</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> parse.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#! /usr/bin/perl

use warnings;
use strict;

use XML::Twig;

my $xmlsdir = $ARGV[0];

print &#34;Reading dir $xmlsdir\n&#34;;

opendir &#40;my $dir, $xmlsdir&#41;;
while &#40;my $file = readdir&#40;$dir&#41;&#41; {
  print &#34;$file\n&#34;;
  next unless $file =~ /\.xml$/;

  my $t = XML::Twig-&gt;new&#40;&#41;;
  $t-&gt;parsefile&#40;&#34;$xmlsdir/$file&#34;&#41;;
}


</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;30&nbsp;18:56:20&nbsp;2013</span>
    <span class="description">k.tchernov [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> k.tchernov [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jan 30 18:54:25 2013, ktchernov wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Running on a Mac OS X with perl v5.12 &#40;I believe it also crashes with
&gt; perl v5.16&#41;, when I parse a
&gt; list of XML::Twig files one after another, XML::Twig eventually
&gt; segfaults.
&gt; 
&gt; I&#39;ve attached some sample code with sample inputs.
&gt; 
&gt; To reproduce the crash, run &#34;./parse.pl &lt;input dir&gt;&#34; where &lt;input dir&gt;
&gt; is the directory
&gt; containing the contents of xmls.zip
&gt; 
&gt; I&#39;ve also tried the sample code with XML::Parser, and that worked fine
&gt; and without segfaulting.
</div>

In the example code a new XML::Twig instance is created for each file. If I re-use the same 
instance &#40;ie move the initialisation to the outside of the loop and add a $t-&gt;purge at the end 
of the loop&#41;, the same problem occurs.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;31&nbsp;02:20:01&nbsp;2013</span>
    <span class="description">ANDK [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Have you tried perl 5.16? See also

<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=83037">https://rt.cpan.org/Ticket/Display.html?id=83037</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;31&nbsp;02:20:02&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;31&nbsp;18:14:12&nbsp;2013</span>
    <span class="description">k.tchernov [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> k.tchernov [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jan 31 02:20:01 2013, ANDK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Have you tried perl 5.16? See also
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=83037">https://rt.cpan.org/Ticket/Display.html?id=83037</a></span>
</div>

That ticket is talking about a large XML, these ones are not particularly large &#40;5.6MB is the 
biggest one&#41;.

I&#39;ve just tried ActivePerl 5.16 on Mac OS X and it does not crash with this example.

However, it does crash on Mac with v5.12 on and on Linux with v5.14. Perl v5.16 is not present 
in many OS distributions, is there any chance for a fix or workaround for the older perl versions?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;31&nbsp;18:15:33&nbsp;2013</span>
    <span class="description">k.tchernov [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> k.tchernov [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Also worth noting, that I came up with this sample script based on a much bigger script that 
we&#39;re using. In that script, I managed to keep it from crashing by adding a $t-&gt;purge before $t 
went out of scope, it seems to have kept it from segfaulting. Although it seems to make no 
difference in the sample script that I attached.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;01&nbsp;07:43:23&nbsp;2013</span>
    <span class="description">xmltwig [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #83059] Segmentation fault while parsing</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 01 Feb 2013 13:42:58 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> mirod &lt;xmltwig [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 02/01/2013 12:14 AM, Konstantin Tchernov via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;         Queue: XML-Twig
&gt;   Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=83059">https://rt.cpan.org/Ticket/Display.html?id=83059</a></span> &gt;
&gt;
&gt; On Thu Jan 31 02:20:01 2013, ANDK wrote:
<div class="message-stanza open">&gt;&gt; Have you tried perl 5.16? See also
&gt;&gt;
&gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=83037">https://rt.cpan.org/Ticket/Display.html?id=83037</a></span>
</div>&gt;
&gt;
&gt; That ticket is talking about a large XML, these ones are not particularly large &#40;5.6MB is the
&gt; biggest one&#41;.
&gt;
&gt; I&#39;ve just tried ActivePerl 5.16 on Mac OS X and it does not crash with this example.
&gt;
&gt; However, it does crash on Mac with v5.12 on and on Linux with v5.14. Perl v5.16 is not present
&gt; in many OS distributions, is there any chance for a fix or workaround for the older perl versions?
</div>
If it doesn&#39;t crash in 5.16 then the problem is most certainly due to a 
known bug in Scalar::Util weaken. It seems that using too many weakrefs 
causes a segfault.

There is a&#40;n undocumented&#41; way of dodging the problem, by turning off 
weak references:

XML::Twig::_set_weakrefs&#40; 0&#41;;

This may cause other problems, like running out of memory, and is really 
not kosher since that function is normally used only for testing the 
module itself. That said, it fixed the problem with your data in 5.14.2.


BTW the bug in weakrefs  is demonstrated by the code below:

#!/usr/bin/perl

use strict;
use warnings;

use Scalar::Util &#39;weaken&#39;;

# the number of iteration that causes a segmentation fault varies
# on my machine, between 19K and 24K, depending on the version of
# perl I use &#40;and it&#39;s not constant for a given version either&#41;
# starting at 5.16 the bug disappears

my $ITER= $ARGV[0] || 24000;

my $head= {};
my $tail= $head;

foreach &#40;1..$ITER&#41;
   { my $new_tail= { p =&gt; $tail };
     weaken&#40; $new_tail-&gt;{p}&#41;;
     $tail-&gt;{n}=  $new_tail;
     $tail= $new_tail;
   }

print &#34;done\n&#34;;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;05&nbsp;08:15:06&nbsp;2014</span>
    <span class="description">MIROD [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This looks like the known weakrefs Perl bug. 

It is now documented in the docs for the module.

-- 
mirod

On Fri Feb 01 07:43:23 2013, xmltwig@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 02/01/2013 12:14 AM, Konstantin Tchernov via RT wrote:
<div class="message-stanza open">&gt; &gt; Queue: XML-Twig
&gt; &gt; Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=83059">https://rt.cpan.org/Ticket/Display.html?id=83059</a></span> &gt;
&gt; &gt;
&gt; &gt; On Thu Jan 31 02:20:01 2013, ANDK wrote:
<div class="message-stanza open">&gt; &gt;&gt; Have you tried perl 5.16? See also
&gt; &gt;&gt;
&gt; &gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=83037">https://rt.cpan.org/Ticket/Display.html?id=83037</a></span>
</div>&gt; &gt;
&gt; &gt;
&gt; &gt; That ticket is talking about a large XML, these ones are not
&gt; &gt; particularly large &#40;5.6MB is the
&gt; &gt; biggest one&#41;.
&gt; &gt;
&gt; &gt; I&#39;ve just tried ActivePerl 5.16 on Mac OS X and it does not crash
&gt; &gt; with this example.
&gt; &gt;
&gt; &gt; However, it does crash on Mac with v5.12 on and on Linux with v5.14.
&gt; &gt; Perl v5.16 is not present
&gt; &gt; in many OS distributions, is there any chance for a fix or workaround
&gt; &gt; for the older perl versions?
</div>&gt; 
&gt; If it doesn&#39;t crash in 5.16 then the problem is most certainly due to
&gt; a
&gt; known bug in Scalar::Util weaken. It seems that using too many
&gt; weakrefs
&gt; causes a segfault.
&gt; 
&gt; There is a&#40;n undocumented&#41; way of dodging the problem, by turning off
&gt; weak references:
&gt; 
&gt; XML::Twig::_set_weakrefs&#40; 0&#41;;
&gt; 
&gt; This may cause other problems, like running out of memory, and is
&gt; really
&gt; not kosher since that function is normally used only for testing the
&gt; module itself. That said, it fixed the problem with your data in
&gt; 5.14.2.
&gt; 
&gt; 
&gt; BTW the bug in weakrefs  is demonstrated by the code below:
&gt; 
&gt; #!/usr/bin/perl
&gt; 
&gt; use strict;
&gt; use warnings;
&gt; 
&gt; use Scalar::Util &#39;weaken&#39;;
&gt; 
&gt; # the number of iteration that causes a segmentation fault varies
&gt; # on my machine, between 19K and 24K, depending on the version of
&gt; # perl I use &#40;and it&#39;s not constant for a given version either&#41;
&gt; # starting at 5.16 the bug disappears
&gt; 
&gt; my $ITER= $ARGV[0] || 24000;
&gt; 
&gt; my $head= {};
&gt; my $tail= $head;
&gt; 
&gt; foreach &#40;1..$ITER&#41;
&gt;    { my $new_tail= { p =&gt; $tail };
&gt;      weaken&#40; $new_tail-&gt;{p}&#41;;
&gt;      $tail-&gt;{n}=  $new_tail;
&gt;      $tail= $new_tail;
&gt;    }
&gt; 
&gt; print &#34;done\n&#34;;
</div>

-- 
__
mirod
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;05&nbsp;08:15:06&nbsp;2014</span>
    <span class="description">MIROD [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;05&nbsp;08:15:07&nbsp;2014</span>
    <span class="description">MIROD [...] cpan.org -  Fixed in 3.45 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;05&nbsp;08:15:08&nbsp;2014</span>
    <span class="description">MIROD [...] cpan.org -  Fixed in 3.42 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
